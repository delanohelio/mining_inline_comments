{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MTUzMTQ4", "number": 161, "title": "Ensures that we rely on server-specified activity retry policy if user doesn't set retry options", "bodyText": "", "createdAt": "2020-07-29T02:21:50Z", "url": "https://github.com/temporalio/sdk-java/pull/161", "merged": true, "mergeCommit": {"oid": "c65004ed068a197f0ec1666b4e34bc1362194810"}, "closed": true, "closedAt": "2020-07-29T20:01:37Z", "author": {"login": "mastermanu"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5heIwgH2gAyNDU4MTUzMTQ4OmNiZWQwZDk5OWE3NmM0ZGNmMzI4OWZkMzMwOGI2OWJkZGIwODA4NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5wfIqgFqTQ1NzgzNzIyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cbed0d999a76c4dcf3289fd3308b69bddb080848", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/cbed0d999a76c4dcf3289fd3308b69bddb080848", "committedDate": "2020-07-29T02:19:33Z", "message": "initial checkin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d92fcfb1e9b29eb0aa4789c8148a9556c12aa120", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/d92fcfb1e9b29eb0aa4789c8148a9556c12aa120", "committedDate": "2020-07-29T02:20:49Z", "message": "remove dead code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd0cacb51638e5f5c1d0b5314a79c36a85d877ac", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/cd0cacb51638e5f5c1d0b5314a79c36a85d877ac", "committedDate": "2020-07-29T03:20:01Z", "message": "cleans up tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f66b1a75c8ad610a163b91aafd5eb488245067", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/64f66b1a75c8ad610a163b91aafd5eb488245067", "committedDate": "2020-07-29T03:20:26Z", "message": "fixes formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTc2MTcx", "url": "https://github.com/temporalio/sdk-java/pull/161#pullrequestreview-457176171", "createdAt": "2020-07-29T03:52:34Z", "commit": {"oid": "64f66b1a75c8ad610a163b91aafd5eb488245067"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMzo1MjozNVrOG4nmVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMzo1MzoxMFrOG4nm3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyMjIyOA==", "bodyText": "I think we should not add any defaults to the retry options and rely on the service for these.", "url": "https://github.com/temporalio/sdk-java/pull/161#discussion_r462022228", "createdAt": "2020-07-29T03:52:35Z", "author": {"login": "mfateev"}, "path": "src/main/java/io/temporal/activity/ActivityOptions.java", "diffHunk": "@@ -173,13 +177,19 @@ public ActivityOptions build() {\n     }\n \n     public ActivityOptions validateAndBuildWithDefaults() {\n+      if (retryOptions != null) {\n+        // retryOptions being null means we will explicitly fallback to the default\n+        // activity retry behavior as specified on the server\n+        retryOptions = RetryOptions.newBuilder(retryOptions).validateBuildWithDefaults();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64f66b1a75c8ad610a163b91aafd5eb488245067"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyMjM2NQ==", "bodyText": "We should compy defaults from the service and do not rely on validateBuildWithDefaults which was intended for the SDK only validation.", "url": "https://github.com/temporalio/sdk-java/pull/161#discussion_r462022365", "createdAt": "2020-07-29T03:53:10Z", "author": {"login": "mfateev"}, "path": "src/main/java/io/temporal/internal/testservice/StateMachines.java", "diffHunk": "@@ -980,15 +975,19 @@ private static void scheduleActivityTask(\n       ScheduleActivityTaskCommandAttributes d,\n       long workflowTaskCompletedEventId) {\n     TestServiceRetryState retryState;\n-    if (d.hasRetryPolicy()) {\n-      RetryPolicy retryPolicy = d.getRetryPolicy();\n-      long expirationInterval = TimeUnit.SECONDS.toMillis(d.getScheduleToCloseTimeoutSeconds());\n-      long expirationTime = data.store.currentTimeMillis() + expirationInterval;\n-      retryState = new TestServiceRetryState(retryPolicy, expirationTime);\n+    RetryPolicy retryPolicy;\n+    if (!d.hasRetryPolicy()) {\n+      // If no activity retry policy is supplied, assume a default to mimic a standard Temporal\n+      // server\n+      retryPolicy = toRetryPolicy(RetryOptions.newBuilder().validateBuildWithDefaults()).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64f66b1a75c8ad610a163b91aafd5eb488245067"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ea5e03e52e324f219fac1f2f05f2556b36048d", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/22ea5e03e52e324f219fac1f2f05f2556b36048d", "committedDate": "2020-07-29T05:38:32Z", "message": "cleanup based on PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjIxMTUy", "url": "https://github.com/temporalio/sdk-java/pull/161#pullrequestreview-457221152", "createdAt": "2020-07-29T06:13:08Z", "commit": {"oid": "22ea5e03e52e324f219fac1f2f05f2556b36048d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjoxMzowOFrOG4p-cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjoxMzowOFrOG4p-cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA2MTE2OQ==", "bodyText": "[Nit] i can technically make this a private static variable that represents an empty array", "url": "https://github.com/temporalio/sdk-java/pull/161#discussion_r462061169", "createdAt": "2020-07-29T06:13:08Z", "author": {"login": "mastermanu"}, "path": "src/main/java/io/temporal/internal/sync/SyncWorkflowContext.java", "diffHunk": "@@ -351,12 +351,15 @@ private ExecuteActivityParameters constructExecuteActivityParameters(\n   }\n \n   static RetryPolicy.Builder toRetryPolicy(RetryOptions retryOptions) {\n+    String[] doNotRetry = retryOptions.getDoNotRetry();\n+\n     return RetryPolicy.newBuilder()\n         .setInitialIntervalInSeconds(roundUpToSeconds(retryOptions.getInitialInterval()))\n         .setMaximumIntervalInSeconds(roundUpToSeconds(retryOptions.getMaximumInterval()))\n         .setBackoffCoefficient(retryOptions.getBackoffCoefficient())\n         .setMaximumAttempts(retryOptions.getMaximumAttempts())\n-        .addAllNonRetryableErrorTypes(Arrays.asList(retryOptions.getDoNotRetry()));\n+        .addAllNonRetryableErrorTypes(\n+            Arrays.asList(doNotRetry != null ? doNotRetry : new String[0]));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22ea5e03e52e324f219fac1f2f05f2556b36048d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d8dbb867ca76f4104794c834b2e6bf4b435e1d8", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/9d8dbb867ca76f4104794c834b2e6bf4b435e1d8", "committedDate": "2020-07-29T18:42:34Z", "message": "adjusts test server retry policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db4947fbaeaf127f95c1ddf3d8f3dc35318f8959", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/db4947fbaeaf127f95c1ddf3d8f3dc35318f8959", "committedDate": "2020-07-29T18:52:27Z", "message": "fixes build break"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b73d8fcdf858d4768ff92721dfd1925fded1e6a", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/3b73d8fcdf858d4768ff92721dfd1925fded1e6a", "committedDate": "2020-07-29T19:16:26Z", "message": "matches java sdk with server"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjM3MTgx", "url": "https://github.com/temporalio/sdk-java/pull/161#pullrequestreview-457637181", "createdAt": "2020-07-29T15:27:30Z", "commit": {"oid": "22ea5e03e52e324f219fac1f2f05f2556b36048d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNToyNzozMFrOG496SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxOToyNToxOFrOG5G2Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM4Nzc4NA==", "bodyText": "I usually just not set fields on protobufs in this case.", "url": "https://github.com/temporalio/sdk-java/pull/161#discussion_r462387784", "createdAt": "2020-07-29T15:27:30Z", "author": {"login": "mfateev"}, "path": "src/main/java/io/temporal/internal/sync/SyncWorkflowContext.java", "diffHunk": "@@ -351,12 +351,15 @@ private ExecuteActivityParameters constructExecuteActivityParameters(\n   }\n \n   static RetryPolicy.Builder toRetryPolicy(RetryOptions retryOptions) {\n+    String[] doNotRetry = retryOptions.getDoNotRetry();\n+\n     return RetryPolicy.newBuilder()\n         .setInitialIntervalInSeconds(roundUpToSeconds(retryOptions.getInitialInterval()))\n         .setMaximumIntervalInSeconds(roundUpToSeconds(retryOptions.getMaximumInterval()))\n         .setBackoffCoefficient(retryOptions.getBackoffCoefficient())\n         .setMaximumAttempts(retryOptions.getMaximumAttempts())\n-        .addAllNonRetryableErrorTypes(Arrays.asList(retryOptions.getDoNotRetry()));\n+        .addAllNonRetryableErrorTypes(\n+            Arrays.asList(doNotRetry != null ? doNotRetry : new String[0]));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA2MTE2OQ=="}, "originalCommit": {"oid": "22ea5e03e52e324f219fac1f2f05f2556b36048d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM4ODYxOQ==", "bodyText": "It looks like you didn't run the build from the command line. I believe we don't have * imports anywhere in the code. In IntelliJ, there is an option to not use *. I'm not sure about other IDEs.", "url": "https://github.com/temporalio/sdk-java/pull/161#discussion_r462388619", "createdAt": "2020-07-29T15:28:41Z", "author": {"login": "mfateev"}, "path": "src/main/java/io/temporal/internal/testservice/StateMachines.java", "diffHunk": "@@ -110,14 +110,7 @@\n import io.temporal.internal.testservice.TestWorkflowStore.ActivityTask;\n import io.temporal.internal.testservice.TestWorkflowStore.TaskQueueId;\n import io.temporal.internal.testservice.TestWorkflowStore.WorkflowTask;\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.Iterator;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Optional;\n-import java.util.OptionalLong;\n-import java.util.UUID;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22ea5e03e52e324f219fac1f2f05f2556b36048d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzNDE2Mw==", "bodyText": "We already have constants for some defaults in this file. I would convert these to constants as well.", "url": "https://github.com/temporalio/sdk-java/pull/161#discussion_r462534163", "createdAt": "2020-07-29T19:25:18Z", "author": {"login": "mfateev"}, "path": "src/main/java/io/temporal/internal/testservice/StateMachines.java", "diffHunk": "@@ -1858,4 +1845,23 @@ private static void failExternalCancellation(\n             .build();\n     ctx.addEvent(event);\n   }\n+\n+  // Mimics the default activity retry policy of a standard Temporal server.\n+  static RetryPolicy ensureDefaultFieldsForActivityRetryPolicy(RetryPolicy originalPolicy) {\n+    return RetryPolicy.newBuilder()\n+        .setInitialIntervalInSeconds(\n+            originalPolicy.getInitialIntervalInSeconds() == 0\n+                ? 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db4947fbaeaf127f95c1ddf3d8f3dc35318f8959"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d102ff8436d49299b4967a99d7b9f08d1ca7801f", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/d102ff8436d49299b4967a99d7b9f08d1ca7801f", "committedDate": "2020-07-29T19:38:09Z", "message": "address CR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "359790bed5d41ed450355815489cd177a36ac3c6", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/359790bed5d41ed450355815489cd177a36ac3c6", "committedDate": "2020-07-29T19:44:52Z", "message": "moves fields to constants"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "540154964d79104d2f0f6e839da8ab599d342836", "author": {"user": {"login": "mastermanu", "name": null}}, "url": "https://github.com/temporalio/sdk-java/commit/540154964d79104d2f0f6e839da8ab599d342836", "committedDate": "2020-07-29T19:47:08Z", "message": "rename constant"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3ODM3MjI4", "url": "https://github.com/temporalio/sdk-java/pull/161#pullrequestreview-457837228", "createdAt": "2020-07-29T19:49:13Z", "commit": {"oid": "540154964d79104d2f0f6e839da8ab599d342836"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3500, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}