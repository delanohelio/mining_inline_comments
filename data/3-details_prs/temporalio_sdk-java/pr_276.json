{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5ODk1MjEz", "number": 276, "title": "Adding an option to disable activity pollers", "bodyText": "This PR addressed this feature request adding an option to worker options that allows disabling activity poller.", "createdAt": "2020-12-15T00:36:11Z", "url": "https://github.com/temporalio/sdk-java/pull/276", "merged": true, "mergeCommit": {"oid": "2457ee67564a534078515f092b177ed9fda691f2"}, "closed": true, "closedAt": "2020-12-16T01:54:57Z", "author": {"login": "vitarb"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmPR8cAH2gAyNTM5ODk1MjEzOjA4MTA5ZTI2YjU4NDQwODNhN2M3ZDkwNmJmYjZiMGQzN2EyNGI1YTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmkzsOAH2gAyNTM5ODk1MjEzOjQ0OWIyYzQ1MzM4ZTA0ZmIzYmY4ODdlYTg1Y2NhNTJiNmI0OGUzMTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "08109e26b5844083a7c7d906bfb6b0d37a24b5a2", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/08109e26b5844083a7c7d906bfb6b0d37a24b5a2", "committedDate": "2020-12-15T00:34:32Z", "message": "Adding an option to disable activity pollers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMDIxMzg0", "url": "https://github.com/temporalio/sdk-java/pull/276#pullrequestreview-552021384", "createdAt": "2020-12-15T00:49:05Z", "commit": {"oid": "08109e26b5844083a7c7d906bfb6b0d37a24b5a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDo0OTowNlrOIFzpFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDo0OTowNlrOIFzpFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1OTg5NQ==", "bodyText": "This is a pretty neat trick. Do we have any business-logic-related thing we can verify here other than there are no threads and the worker is null?", "url": "https://github.com/temporalio/sdk-java/pull/276#discussion_r542959895", "createdAt": "2020-12-15T00:49:06Z", "author": {"login": "Sushisource"}, "path": "temporal-sdk/src/test/java/io/temporal/worker/ActivityPollerDisabledTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.worker;\n+\n+import static java.util.stream.Collectors.groupingBy;\n+import static org.junit.Assert.*;\n+\n+import io.temporal.testing.TestEnvironmentOptions;\n+import io.temporal.testing.TestWorkflowEnvironment;\n+import io.temporal.workflow.WorkflowInterface;\n+import io.temporal.workflow.WorkflowMethod;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import org.junit.Test;\n+\n+public class ActivityPollerDisabledTest {\n+\n+  @WorkflowInterface\n+  public interface Workflow {\n+    @WorkflowMethod\n+    void bar();\n+  }\n+\n+  public static class WorkflowImpl implements Workflow {\n+\n+    @Override\n+    public void bar() {}\n+  }\n+\n+  @Test\n+  public void testActivityPollerDisabled() throws InterruptedException {\n+    String activityPollerThreadNamePrefix = \"Activity Poller task\";\n+    String workflowPollerThreadNamePrefix = \"Workflow Poller task\";\n+    String workflowHostLocalPollerThreadNamePrefix = \"Host Local Workflow \";\n+    int hostLocalThreadCount = 22;\n+    int workflowPollCount = 11;\n+    int activityPollCount = 18;\n+\n+    TestEnvironmentOptions options =\n+        TestEnvironmentOptions.newBuilder()\n+            .setWorkerFactoryOptions(\n+                WorkerFactoryOptions.newBuilder()\n+                    .setWorkflowHostLocalPollThreadCount(hostLocalThreadCount)\n+                    .build())\n+            .build();\n+    TestWorkflowEnvironment env = TestWorkflowEnvironment.newInstance(options);\n+    Worker worker =\n+        env.newWorker(\n+            \"tl1\",\n+            WorkerOptions.newBuilder()\n+                .setWorkflowPollThreadCount(workflowPollCount)\n+                .setActivityPollThreadCount(activityPollCount)\n+                .setActivityPollerDisabled(true)\n+                .build());\n+    // Need to register something for workers to start\n+    worker.registerWorkflowImplementationTypes(WorkflowImpl.class);\n+    env.start();\n+    Thread.sleep(1000);\n+    Map<String, Long> threads =\n+        Thread.getAllStackTraces().keySet().stream()\n+            .map((t) -> t.getName().substring(0, Math.min(20, t.getName().length())))\n+            .collect(groupingBy(Function.identity(), Collectors.counting()));\n+    assertEquals(hostLocalThreadCount, (long) threads.get(workflowHostLocalPollerThreadNamePrefix));\n+    assertEquals(workflowPollCount, (long) threads.get(workflowPollerThreadNamePrefix));\n+    assertFalse(threads.containsKey(activityPollerThreadNamePrefix));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08109e26b5844083a7c7d906bfb6b0d37a24b5a2"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzYwMzc0", "url": "https://github.com/temporalio/sdk-java/pull/276#pullrequestreview-552760374", "createdAt": "2020-12-15T18:42:47Z", "commit": {"oid": "08109e26b5844083a7c7d906bfb6b0d37a24b5a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a1fa03d4b40f5a94d9c25606730144b415acb13", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/5a1fa03d4b40f5a94d9c25606730144b415acb13", "committedDate": "2020-12-15T19:08:25Z", "message": "register activity implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d330e5d8bd23a0c93bd4a223abe794ec92be291", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/2d330e5d8bd23a0c93bd4a223abe794ec92be291", "committedDate": "2020-12-15T19:52:29Z", "message": "remove duplication in workflow and activity definitions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMDk0ODAy", "url": "https://github.com/temporalio/sdk-java/pull/276#pullrequestreview-553094802", "createdAt": "2020-12-15T23:34:18Z", "commit": {"oid": "2d330e5d8bd23a0c93bd4a223abe794ec92be291"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMzozNDoxOFrOIGkxLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMzozODo1N1rOIGk5Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc2NDc4Mw==", "bodyText": "I would change all this check to activityWorker != null which would make it more obvious.", "url": "https://github.com/temporalio/sdk-java/pull/276#discussion_r543764783", "createdAt": "2020-12-15T23:34:18Z", "author": {"login": "mfateev"}, "path": "temporal-sdk/src/main/java/io/temporal/worker/Worker.java", "diffHunk": "@@ -323,25 +327,38 @@ void start() {\n       return;\n     }\n     workflowWorker.start();\n-    activityWorker.start();\n+    if (!options.isActivityPollerDisabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d330e5d8bd23a0c93bd4a223abe794ec92be291"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc2NTg1MA==", "bodyText": "To have workflow tasks only don't call worker.registerActivity. The reason to have this option is to support only local activities by this activity worker.\nShould we rename it to something more explicit? More like setLocalActivityWorkerOnly?", "url": "https://github.com/temporalio/sdk-java/pull/276#discussion_r543765850", "createdAt": "2020-12-15T23:36:49Z", "author": {"login": "mfateev"}, "path": "temporal-sdk/src/main/java/io/temporal/worker/WorkerOptions.java", "diffHunk": "@@ -173,6 +177,17 @@ public Builder setActivityPollThreadCount(int activityPollThreadCount) {\n       return this;\n     }\n \n+    /**\n+     * If set to true disables activity poller on this worker. Can be useful if you want to handle\n+     * workflow tasks only.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d330e5d8bd23a0c93bd4a223abe794ec92be291"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc2NjgwNw==", "bodyText": "Another option is to schedule a local activity and after it completes schedule a normal activity and let it timeout with ScheduleToStart to show that no activity worker is present.", "url": "https://github.com/temporalio/sdk-java/pull/276#discussion_r543766807", "createdAt": "2020-12-15T23:38:57Z", "author": {"login": "mfateev"}, "path": "temporal-sdk/src/test/java/io/temporal/worker/ActivityPollerDisabledTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.worker;\n+\n+import static java.util.stream.Collectors.groupingBy;\n+import static org.junit.Assert.*;\n+\n+import io.temporal.testing.TestEnvironmentOptions;\n+import io.temporal.testing.TestWorkflowEnvironment;\n+import io.temporal.workflow.WorkflowInterface;\n+import io.temporal.workflow.WorkflowMethod;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import org.junit.Test;\n+\n+public class ActivityPollerDisabledTest {\n+\n+  @WorkflowInterface\n+  public interface Workflow {\n+    @WorkflowMethod\n+    void bar();\n+  }\n+\n+  public static class WorkflowImpl implements Workflow {\n+\n+    @Override\n+    public void bar() {}\n+  }\n+\n+  @Test\n+  public void testActivityPollerDisabled() throws InterruptedException {\n+    String activityPollerThreadNamePrefix = \"Activity Poller task\";\n+    String workflowPollerThreadNamePrefix = \"Workflow Poller task\";\n+    String workflowHostLocalPollerThreadNamePrefix = \"Host Local Workflow \";\n+    int hostLocalThreadCount = 22;\n+    int workflowPollCount = 11;\n+    int activityPollCount = 18;\n+\n+    TestEnvironmentOptions options =\n+        TestEnvironmentOptions.newBuilder()\n+            .setWorkerFactoryOptions(\n+                WorkerFactoryOptions.newBuilder()\n+                    .setWorkflowHostLocalPollThreadCount(hostLocalThreadCount)\n+                    .build())\n+            .build();\n+    TestWorkflowEnvironment env = TestWorkflowEnvironment.newInstance(options);\n+    Worker worker =\n+        env.newWorker(\n+            \"tl1\",\n+            WorkerOptions.newBuilder()\n+                .setWorkflowPollThreadCount(workflowPollCount)\n+                .setActivityPollThreadCount(activityPollCount)\n+                .setActivityPollerDisabled(true)\n+                .build());\n+    // Need to register something for workers to start\n+    worker.registerWorkflowImplementationTypes(WorkflowImpl.class);\n+    env.start();\n+    Thread.sleep(1000);\n+    Map<String, Long> threads =\n+        Thread.getAllStackTraces().keySet().stream()\n+            .map((t) -> t.getName().substring(0, Math.min(20, t.getName().length())))\n+            .collect(groupingBy(Function.identity(), Collectors.counting()));\n+    assertEquals(hostLocalThreadCount, (long) threads.get(workflowHostLocalPollerThreadNamePrefix));\n+    assertEquals(workflowPollCount, (long) threads.get(workflowPollerThreadNamePrefix));\n+    assertFalse(threads.containsKey(activityPollerThreadNamePrefix));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1OTg5NQ=="}, "originalCommit": {"oid": "08109e26b5844083a7c7d906bfb6b0d37a24b5a2"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e34246add4209a8ec7fd108b1ff9245a3568889", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/1e34246add4209a8ec7fd108b1ff9245a3568889", "committedDate": "2020-12-16T01:03:53Z", "message": "Addressed CR feedback:\n- renamed property\n- added couple of tests\n- replaced property checks with null checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64825a1bb1d44b7589bb5574aa60f46a37fbe110", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/64825a1bb1d44b7589bb5574aa60f46a37fbe110", "committedDate": "2020-12-16T01:07:30Z", "message": "apply formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMjU0NzM1", "url": "https://github.com/temporalio/sdk-java/pull/276#pullrequestreview-553254735", "createdAt": "2020-12-16T01:28:25Z", "commit": {"oid": "64825a1bb1d44b7589bb5574aa60f46a37fbe110"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMToyODoyNVrOIGnf8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMToyODoyNVrOIGnf8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgwOTUyMg==", "bodyText": "Would you add a comment that explains what is the meaning of this flag?", "url": "https://github.com/temporalio/sdk-java/pull/276#discussion_r543809522", "createdAt": "2020-12-16T01:28:25Z", "author": {"login": "mfateev"}, "path": "temporal-sdk/src/main/java/io/temporal/worker/WorkerOptions.java", "diffHunk": "@@ -183,8 +183,8 @@ public Builder setActivityPollThreadCount(int activityPollThreadCount) {\n      *\n      * <p>Default is false.\n      */\n-    public Builder setActivityPollerDisabled(boolean activityPollerDisabled) {\n-      this.activityPollerDisabled = activityPollerDisabled;\n+    public Builder setLocalActivityWorkerOnly(boolean localActivityWorkerOnly) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64825a1bb1d44b7589bb5574aa60f46a37fbe110"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "449b2c45338e04fb3bf887ea85cca52b6b48e319", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/449b2c45338e04fb3bf887ea85cca52b6b48e319", "committedDate": "2020-12-16T01:39:24Z", "message": "change comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3486, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}