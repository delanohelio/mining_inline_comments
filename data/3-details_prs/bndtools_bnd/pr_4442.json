{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0MzgxNDYy", "number": 4442, "title": "[build] Workspace per version defaults", "bodyText": "This patch provides the defaults for the properties\nfor a workspace. These defaults are version specific\nand the user can set a -versiondefaults <v>\ninstruction to select a specific version. This\nallows a user to upgrade to a new workspace but\nkeep the old defaults.\nThe idea is that new features are written to be\ndisabled by default. Preferably, this should\ndone with a scope model if application. That is,\nlike for example contract * . These instructions\nare scoped. By setting an appropriate default\nyou can enable these instructions.\nBy default, a workspace will read in the defaults\nof the current version. We maintain already\na current version in About. However, with the\n-versiondefaults instruction the user can pick\nan earlier version of defaults.\nThe idea is that we continue to add features but\nstrictly write them disabled. The version defaults\ncan then selectively enable them so that the majority\nof our users get the benefits.\nThe version default file will (5.3.0.bnd) will have\nthe full set of defaults and will therefore encompass\nthe previous version's defaults.\nHowever, an organization that upgrades their bnd,\nwill be able to remain at an older version feature\nwise.\nThis was mainly driven because an older workspace\nthat I had was upgraded. After the upgrade, the\nartifacts failed in the field because the maven\ndependencies were automatically added to the pom. Similar\nproblems happened with the new Java import and I\nthink I once messed up with the EE requirements based\non the Java class levels.\nThe prime advantages I see are:\n\nA more consistent feature model (disable in code,\nenable by version defaults)\nConcise documentation of the presence of new features in\nthe version default file. This can guide users to\noverride the defaults in their workspace file.\nA user choice to revert back to an older feature\nset while being able to take advantage of bug fixes\n\nThis code should work as is in the Gradle workspace\nbuild. The gradle native plugin & maven need to\nsee how they get their current defaults. Since the\ndefaults were already maintained this way, I expect\nthat this requires no change but I know little about\nthese uses of bndlib.\nSigned-off-by: Peter Kriens Peter.Kriens@aqute.biz", "createdAt": "2020-12-08T11:21:03Z", "url": "https://github.com/bndtools/bnd/pull/4442", "merged": true, "mergeCommit": {"oid": "e32d6c3cea4c0a3ef11d73bb2d362069ac6df50b"}, "closed": true, "closedAt": "2021-03-12T10:23:29Z", "author": {"login": "pkriens"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkJxDZAFqTU0NzIwMTUyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeCXgYEgBqjQ0NDk4MDY2NjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjAxNTI3", "url": "https://github.com/bndtools/bnd/pull/4442#pullrequestreview-547201527", "createdAt": "2020-12-08T12:48:45Z", "commit": {"oid": "4a184db4055c946c234e33992a9c847e9cfbe3d9"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo0ODo0NVrOIBY_xQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo1Mzo0NFrOIBZSjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMyOTAyOQ==", "bodyText": "Does this mean we also need properties files for each micro release since version can equals \"5.2.1\"? This adds complexity to fix releases.", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r538329029", "createdAt": "2020-12-08T12:48:45Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/Workspace.java", "diffHunk": "@@ -292,24 +292,52 @@ public Workspace(File workspaceDir) throws Exception {\n \t}\n \n \tpublic Workspace(File workspaceDir, String bndDir) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = WorkspaceLayout.BND;\n \t\tworkspaceDir = workspaceDir.getAbsoluteFile();\n \t\tsetBase(workspaceDir); // setBase before call to setFileSystem\n \t\taddBasicPlugin(new LoggingProgressPlugin());\n \t\tsetFileSystem(workspaceDir, bndDir);\n+\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read\n+\n+\t\tfixupVersionDefaults(this.getParent()\n+\t\t\t.getProperties());\n+\n \t\tprojects = new ProjectTracker(this);\n \t}\n \n \tprivate Workspace(WorkspaceLayout layout) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = layout;\n \t\tsetBuildDir(IO.getFile(BND_DEFAULT_WS, CNFDIR));\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read\n+\n+\t\tfixupVersionDefaults(this.getParent()\n+\t\t\t.getProperties());\n \t\tprojects = new ProjectTracker(this);\n \t}\n \n+\tprivate void fixupVersionDefaults(Properties props) throws IOException {\n+\t\tVersion current = About.CURRENT.getWithoutQualifier();\n+\t\tString version = Strings.trim(getProperty(Constants.VERSIONDEFAULTS, current.toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a184db4055c946c234e33992a9c847e9cfbe3d9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzMDA3NQ==", "bodyText": "Do you need to handle -include or ${.} processing? Or are these files just simple properties files even though they have .bnd extensions?", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r538330075", "createdAt": "2020-12-08T12:49:50Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/Workspace.java", "diffHunk": "@@ -292,24 +292,52 @@ public Workspace(File workspaceDir) throws Exception {\n \t}\n \n \tpublic Workspace(File workspaceDir, String bndDir) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = WorkspaceLayout.BND;\n \t\tworkspaceDir = workspaceDir.getAbsoluteFile();\n \t\tsetBase(workspaceDir); // setBase before call to setFileSystem\n \t\taddBasicPlugin(new LoggingProgressPlugin());\n \t\tsetFileSystem(workspaceDir, bndDir);\n+\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read\n+\n+\t\tfixupVersionDefaults(this.getParent()\n+\t\t\t.getProperties());\n+\n \t\tprojects = new ProjectTracker(this);\n \t}\n \n \tprivate Workspace(WorkspaceLayout layout) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = layout;\n \t\tsetBuildDir(IO.getFile(BND_DEFAULT_WS, CNFDIR));\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read\n+\n+\t\tfixupVersionDefaults(this.getParent()\n+\t\t\t.getProperties());\n \t\tprojects = new ProjectTracker(this);\n \t}\n \n+\tprivate void fixupVersionDefaults(Properties props) throws IOException {\n+\t\tVersion current = About.CURRENT.getWithoutQualifier();\n+\t\tString version = Strings.trim(getProperty(Constants.VERSIONDEFAULTS, current.toString()));\n+\t\tURL url = Workspace.class.getResource(version + \".bnd\");\n+\t\tif (url == null) {\n+\t\t\terror(\"%s = %s, this is not a valid released bnd version. Using current version %s\",\n+\t\t\t\tConstants.VERSIONDEFAULTS, version, current);\n+\t\t\turl = Workspace.class.getResource(current + \".bnd\");\n+\t\t\tassert url != null : \"We must have a specific defaults resource\";\n+\t\t}\n+\t\ttry (InputStream in = url.openStream()) {\n+\t\t\tprops.load(in);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a184db4055c946c234e33992a9c847e9cfbe3d9"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzMDc0MQ==", "bodyText": "Is this a new default feature for 5.3? I was not aware we are always shading conditional packages. How is that different than not shading them?", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r538330741", "createdAt": "2020-12-08T12:50:32Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/5.3.0.bnd", "diffHunk": "@@ -0,0 +1,8 @@\n+# 5.3.0 defaults\n+\n+-dsannotations          *\n+-metatypeannotations    *\n+-cdiannotations         *\n+-contract               *\n+\n+-shade                  ${-conditionalpackage}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a184db4055c946c234e33992a9c847e9cfbe3d9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzMjYyNQ==", "bodyText": "These are all in place a long time are are not new for 5.2? Since the code already assumes these defaults, I don't think we should duplicate them since it then looks like they have been set in the workspace rather than actually just defaulting.", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r538332625", "createdAt": "2020-12-08T12:52:23Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/5.2.0.bnd", "diffHunk": "@@ -0,0 +1,7 @@\n+# 5.2.0 defaults\n+\n+-dsannotations          *\n+-metatypeannotations    *\n+-cdiannotations         *\n+-contract               *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a184db4055c946c234e33992a9c847e9cfbe3d9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzMzYyMQ==", "bodyText": "Doesn't this then override any properties set in the cnf?", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r538333621", "createdAt": "2020-12-08T12:53:31Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/Workspace.java", "diffHunk": "@@ -292,24 +292,52 @@ public Workspace(File workspaceDir) throws Exception {\n \t}\n \n \tpublic Workspace(File workspaceDir, String bndDir) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = WorkspaceLayout.BND;\n \t\tworkspaceDir = workspaceDir.getAbsoluteFile();\n \t\tsetBase(workspaceDir); // setBase before call to setFileSystem\n \t\taddBasicPlugin(new LoggingProgressPlugin());\n \t\tsetFileSystem(workspaceDir, bndDir);\n+\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read\n+\n+\t\tfixupVersionDefaults(this.getParent()\n+\t\t\t.getProperties());\n+\n \t\tprojects = new ProjectTracker(this);\n \t}\n \n \tprivate Workspace(WorkspaceLayout layout) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = layout;\n \t\tsetBuildDir(IO.getFile(BND_DEFAULT_WS, CNFDIR));\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a184db4055c946c234e33992a9c847e9cfbe3d9"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzMzgzOQ==", "bodyText": "Doesn't this then override any properties set in the cnf? I guess some tests would have shown this?", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r538333839", "createdAt": "2020-12-08T12:53:44Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/Workspace.java", "diffHunk": "@@ -292,24 +292,52 @@ public Workspace(File workspaceDir) throws Exception {\n \t}\n \n \tpublic Workspace(File workspaceDir, String bndDir) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = WorkspaceLayout.BND;\n \t\tworkspaceDir = workspaceDir.getAbsoluteFile();\n \t\tsetBase(workspaceDir); // setBase before call to setFileSystem\n \t\taddBasicPlugin(new LoggingProgressPlugin());\n \t\tsetFileSystem(workspaceDir, bndDir);\n+\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a184db4055c946c234e33992a9c847e9cfbe3d9"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a184db4055c946c234e33992a9c847e9cfbe3d9", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/4a184db4055c946c234e33992a9c847e9cfbe3d9", "committedDate": "2020-12-08T11:20:13Z", "message": "[build] Workspace per version defaults\n\nThis patch provides the defaults for the properties\nfor a workspace. These defaults are version specific\nand the user can set a `-versiondefaults <v>` \ninstruction to select a specific version. This\nallows a user to upgrade to a new workspace but\nkeep the old defaults.\n\nThe idea is that new features are written to be\ndisabled by default. Preferably, this should\ndone with a scope model if application. That is,\nlike for example `contract *` . These instructions\nare _scoped_. By setting an appropriate default\nyou can enable these instructions.\n\nBy default, a workspace will read in the defaults\nof the current version. We maintain already \na current version in About. However, with the\n`-versiondefaults` instruction the user can pick\nan earlier version of defaults.\n\nThe idea is that we continue to add features but\nstrictly write them disabled. The version defaults\ncan then selectively enable them so that the majority\nof our users get the benefits. \n\nThe version default file will (5.3.0.bnd) will have\nthe full set of defaults and will therefore encompass\nthe previous version's defaults.\n\nHowever, an organization that upgrades their bnd,\nwill be able to remain at an older version feature\nwise.\n\nThis was mainly driven because an older workspace\nthat I had was upgraded. After the upgrade, the \nartifacts failed in the field because the maven\ndependencies were automatically added to the pom. Similar\nproblems happened with the new Java import and I \nthink I once messed up with the EE requirements based\non the Java class levels.\n\nThe prime advantages I see are:\n\n- A more consistent feature model (disable in code, \n  enable by version defaults)\n- Concise documentation of the presence of new features in \n  the version default file. This can guide users to\n  override the defaults in their workspace file.\n- A user choice to revert back to an older feature\n  set while being able to take advantage of bug fixes\n\nThis code should work as is in the Gradle workspace\nbuild. The gradle native plugin & maven need to \nsee how they get their current defaults. Since the\ndefaults were already maintained this way, I expect\nthat this requires no change but I know little about\nthese uses of bndlib.\n\n\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}, "afterCommit": {"oid": "75e961ff962e817519a98b4851f5ca3d1320297a", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/75e961ff962e817519a98b4851f5ca3d1320297a", "committedDate": "2020-12-08T18:30:07Z", "message": "[build] Workspace per version defaults\n\nThis patch provides the defaults for the properties\nfor a workspace. These defaults are version specific\nand the user can set a `-versiondefaults <v>` \ninstruction to select a specific version. This\nallows a user to upgrade to a new workspace but\nkeep the old defaults.\n\nThe idea is that new features are written to be\ndisabled by default. Preferably, this should\ndone with a scope model if application. That is,\nlike for example `contract *` . These instructions\nare _scoped_. By setting an appropriate default\nyou can enable these instructions.\n\nBy default, a workspace will read in the defaults\nof the current version. We maintain already \na current version in About. However, with the\n`-versiondefaults` instruction the user can pick\nan earlier version of defaults.\n\nThe idea is that we continue to add features but\nstrictly write them disabled. The version defaults\ncan then selectively enable them so that the majority\nof our users get the benefits. \n\nThe version default file will (5.3.0.bnd) will have\nthe full set of defaults and will therefore encompass\nthe previous version's defaults.\n\nHowever, an organization that upgrades their bnd,\nwill be able to remain at an older version feature\nwise.\n\nThis was mainly driven because an older workspace\nthat I had was upgraded. After the upgrade, the \nartifacts failed in the field because the maven\ndependencies were automatically added to the pom. Similar\nproblems happened with the new Java import and I \nthink I once messed up with the EE requirements based\non the Java class levels.\n\nThe prime advantages I see are:\n\n- A more consistent feature model (disable in code, \n  enable by version defaults)\n- Concise documentation of the presence of new features in \n  the version default file. This can guide users to\n  override the defaults in their workspace file.\n- A user choice to revert back to an older feature\n  set while being able to take advantage of bug fixes\n\nThis code should work as is in the Gradle workspace\nbuild. The gradle native plugin & maven need to \nsee how they get their current defaults. Since the\ndefaults were already maintained this way, I expect\nthat this requires no change but I know little about\nthese uses of bndlib.\n\n- Made versions ignore micro updates\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3Njk3NzU0", "url": "https://github.com/bndtools/bnd/pull/4442#pullrequestreview-547697754", "createdAt": "2020-12-08T22:48:53Z", "commit": {"oid": "75e961ff962e817519a98b4851f5ca3d1320297a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjo0ODo1M1rOIB5zGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjo0ODo1M1rOIB5zGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg2NjQ1OQ==", "bodyText": "The change in this constructor does not do anything useful since there is no user-managed cnf folder in which they can set -versiondefaults to some meaningful value. This includes things using standalone workspace (bndruns, maven, gradle). They can only control a bndrun file which is read after the version defaults are already set in the standalone workspace. So this proposal only works for Bnd workspace projects but it does not work for their bndruns using -standalone.", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r538866459", "createdAt": "2020-12-08T22:48:53Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/Workspace.java", "diffHunk": "@@ -292,24 +292,53 @@ public Workspace(File workspaceDir) throws Exception {\n \t}\n \n \tpublic Workspace(File workspaceDir, String bndDir) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = WorkspaceLayout.BND;\n \t\tworkspaceDir = workspaceDir.getAbsoluteFile();\n \t\tsetBase(workspaceDir); // setBase before call to setFileSystem\n \t\taddBasicPlugin(new LoggingProgressPlugin());\n \t\tsetFileSystem(workspaceDir, bndDir);\n+\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read\n+\n+\t\tfixupVersionDefaults(this.getParent()\n+\t\t\t.getProperties());\n+\n \t\tprojects = new ProjectTracker(this);\n \t}\n \n \tprivate Workspace(WorkspaceLayout layout) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75e961ff962e817519a98b4851f5ca3d1320297a"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75e961ff962e817519a98b4851f5ca3d1320297a", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/75e961ff962e817519a98b4851f5ca3d1320297a", "committedDate": "2020-12-08T18:30:07Z", "message": "[build] Workspace per version defaults\n\nThis patch provides the defaults for the properties\nfor a workspace. These defaults are version specific\nand the user can set a `-versiondefaults <v>` \ninstruction to select a specific version. This\nallows a user to upgrade to a new workspace but\nkeep the old defaults.\n\nThe idea is that new features are written to be\ndisabled by default. Preferably, this should\ndone with a scope model if application. That is,\nlike for example `contract *` . These instructions\nare _scoped_. By setting an appropriate default\nyou can enable these instructions.\n\nBy default, a workspace will read in the defaults\nof the current version. We maintain already \na current version in About. However, with the\n`-versiondefaults` instruction the user can pick\nan earlier version of defaults.\n\nThe idea is that we continue to add features but\nstrictly write them disabled. The version defaults\ncan then selectively enable them so that the majority\nof our users get the benefits. \n\nThe version default file will (5.3.0.bnd) will have\nthe full set of defaults and will therefore encompass\nthe previous version's defaults.\n\nHowever, an organization that upgrades their bnd,\nwill be able to remain at an older version feature\nwise.\n\nThis was mainly driven because an older workspace\nthat I had was upgraded. After the upgrade, the \nartifacts failed in the field because the maven\ndependencies were automatically added to the pom. Similar\nproblems happened with the new Java import and I \nthink I once messed up with the EE requirements based\non the Java class levels.\n\nThe prime advantages I see are:\n\n- A more consistent feature model (disable in code, \n  enable by version defaults)\n- Concise documentation of the presence of new features in \n  the version default file. This can guide users to\n  override the defaults in their workspace file.\n- A user choice to revert back to an older feature\n  set while being able to take advantage of bug fixes\n\nThis code should work as is in the Gradle workspace\nbuild. The gradle native plugin & maven need to \nsee how they get their current defaults. Since the\ndefaults were already maintained this way, I expect\nthat this requires no change but I know little about\nthese uses of bndlib.\n\n- Made versions ignore micro updates\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}, "afterCommit": {"oid": "52c9c2af5308ecdea72e52f84d49d0c7a65d3a32", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/52c9c2af5308ecdea72e52f84d49d0c7a65d3a32", "committedDate": "2020-12-09T10:42:39Z", "message": "[build] Workspace per version defaults\n\nThis patch provides the defaults for the properties\nfor a workspace. These defaults are version specific\nand the user can set a `-versiondefaults <v>` \ninstruction to select a specific version. This\nallows a user to upgrade to a new workspace but\nkeep the old defaults.\n\nThe idea is that new features are written to be\ndisabled by default. Preferably, this should\ndone with a scope model if application. That is,\nlike for example `contract *` . These instructions\nare _scoped_. By setting an appropriate default\nyou can enable these instructions.\n\nBy default, a workspace will read in the defaults\nof the current version. We maintain already \na current version in About. However, with the\n`-versiondefaults` instruction the user can pick\nan earlier version of defaults.\n\nThe idea is that we continue to add features but\nstrictly write them disabled. The version defaults\ncan then selectively enable them so that the majority\nof our users get the benefits. \n\nThe version default file will (5.3.0.bnd) will have\nthe full set of defaults and will therefore encompass\nthe previous version's defaults.\n\nHowever, an organization that upgrades their bnd,\nwill be able to remain at an older version feature\nwise.\n\nThis was mainly driven because an older workspace\nthat I had was upgraded. After the upgrade, the \nartifacts failed in the field because the maven\ndependencies were automatically added to the pom. Similar\nproblems happened with the new Java import and I \nthink I once messed up with the EE requirements based\non the Java class levels.\n\nThe prime advantages I see are:\n\n- A more consistent feature model (disable in code, \n  enable by version defaults)\n- Concise documentation of the presence of new features in \n  the version default file. This can guide users to\n  override the defaults in their workspace file.\n- A user choice to revert back to an older feature\n  set while being able to take advantage of bug fixes\n\nThis code should work as is in the Gradle workspace\nbuild. The gradle native plugin & maven need to \nsee how they get their current defaults. Since the\ndefaults were already maintained this way, I expect\nthat this requires no change but I know little about\nthese uses of bndlib.\n\n- Made versions ignore micro updates\n- added test cases & set version defaults for standalone \nand default case\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MjY2MDA2", "url": "https://github.com/bndtools/bnd/pull/4442#pullrequestreview-548266006", "createdAt": "2020-12-09T14:55:23Z", "commit": {"oid": "52c9c2af5308ecdea72e52f84d49d0c7a65d3a32"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNDo1NToyM1rOICYyEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNDo1OTowOFrOICY-9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM3NDA5OQ==", "bodyText": "Not sure why this needs to be in a finally since if the method throws an exception, the created workspace object is not visible to the caller who just gets thrown the exception.  I think you just need to call fixup before you return the workspace object.", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r539374099", "createdAt": "2020-12-09T14:55:23Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/Workspace.java", "diffHunk": "@@ -1207,43 +1263,46 @@ public static Workspace createStandaloneWorkspace(Processor run, URI base) throw\n \n \t\tAtomicBoolean copyAll = new AtomicBoolean(false);\n \t\tAtomicInteger counter = new AtomicInteger();\n-\t\tParameters standalone = new Parameters(run.getProperty(STANDALONE), ws);\n-\t\tstandalone.stream()\n-\t\t\t.filterKey(locationStr -> {\n-\t\t\t\tif (\"true\".equalsIgnoreCase(locationStr)) {\n-\t\t\t\t\tcopyAll.set(true);\n-\t\t\t\t\treturn false;\n-\t\t\t\t}\n-\t\t\t\treturn true;\n-\t\t\t})\n-\t\t\t.map(asBiFunction((locationStr, attrs) -> {\n-\t\t\t\tString index = String.format(\"%02d\", counter.incrementAndGet());\n-\t\t\t\tString name = attrs.get(\"name\");\n-\t\t\t\tif (name == null) {\n-\t\t\t\t\tname = \"repo\".concat(index);\n-\t\t\t\t}\n-\t\t\t\tURI resolvedLocation = URIUtil.resolve(base, locationStr);\n-\t\t\t\ttry (Formatter f = new Formatter(Locale.US)) {\n-\t\t\t\t\tf.format(STANDALONE_REPO_CLASS + \"; name='%s'; locations='%s'\", name, resolvedLocation);\n-\t\t\t\t\tattrs.stream()\n-\t\t\t\t\t\t.filterKey(k -> !k.equals(\"name\"))\n-\t\t\t\t\t\t.forEachOrdered((k, v) -> f.format(\"; %s='%s'\", k, v));\n-\t\t\t\t\treturn MapStream.entry(PLUGIN_STANDALONE.concat(index), f.toString());\n-\t\t\t\t}\n-\t\t\t}))\n-\t\t\t.forEachOrdered(ws::setProperty);\n-\n-\t\tMapStream<String, Object> runProperties = MapStream.of(run.getProperties())\n-\t\t\t.mapKey(String.class::cast);\n-\t\tif (!copyAll.get()) {\n-\t\t\trunProperties = runProperties\n-\t\t\t\t.filterKey(k -> k.equals(Constants.PLUGIN) || k.startsWith(Constants.PLUGIN + \".\"));\n-\t\t}\n-\t\tProperties wsProperties = ws.getProperties();\n-\t\trunProperties.filterKey(k -> !k.startsWith(PLUGIN_STANDALONE))\n-\t\t\t.forEachOrdered(wsProperties::put);\n+\t\ttry {\n+\t\t\tParameters standalone = new Parameters(run.getProperty(STANDALONE), ws);\n+\t\t\tstandalone.stream()\n+\t\t\t\t.filterKey(locationStr -> {\n+\t\t\t\t\tif (\"true\".equalsIgnoreCase(locationStr)) {\n+\t\t\t\t\t\tcopyAll.set(true);\n+\t\t\t\t\t\treturn false;\n+\t\t\t\t\t}\n+\t\t\t\t\treturn true;\n+\t\t\t\t})\n+\t\t\t\t.map(asBiFunction((locationStr, attrs) -> {\n+\t\t\t\t\tString index = String.format(\"%02d\", counter.incrementAndGet());\n+\t\t\t\t\tString name = attrs.get(\"name\");\n+\t\t\t\t\tif (name == null) {\n+\t\t\t\t\t\tname = \"repo\".concat(index);\n+\t\t\t\t\t}\n+\t\t\t\t\tURI resolvedLocation = URIUtil.resolve(base, locationStr);\n+\t\t\t\t\ttry (Formatter f = new Formatter(Locale.US)) {\n+\t\t\t\t\t\tf.format(STANDALONE_REPO_CLASS + \"; name='%s'; locations='%s'\", name, resolvedLocation);\n+\t\t\t\t\t\tattrs.stream()\n+\t\t\t\t\t\t\t.filterKey(k -> !k.equals(\"name\"))\n+\t\t\t\t\t\t\t.forEachOrdered((k, v) -> f.format(\"; %s='%s'\", k, v));\n+\t\t\t\t\t\treturn MapStream.entry(PLUGIN_STANDALONE.concat(index), f.toString());\n+\t\t\t\t\t}\n+\t\t\t\t}))\n+\t\t\t\t.forEachOrdered(ws::setProperty);\n+\t\t\tMapStream<String, Object> runProperties = MapStream.of(run.getProperties())\n+\t\t\t\t.mapKey(String.class::cast);\n+\t\t\tif (!copyAll.get()) {\n+\t\t\t\trunProperties = runProperties\n+\t\t\t\t\t.filterKey(k -> k.equals(Constants.PLUGIN) || k.startsWith(Constants.PLUGIN + \".\"));\n+\t\t\t}\n+\t\t\tProperties wsProperties = ws.getProperties();\n+\t\t\trunProperties.filterKey(k -> !k.startsWith(PLUGIN_STANDALONE))\n+\t\t\t\t.forEachOrdered(wsProperties::put);\n \n-\t\treturn ws;\n+\t\t\treturn ws;\n+\t\t} finally {\n+\t\t\tws.fixupVersionDefaults();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c9c2af5308ecdea72e52f84d49d0c7a65d3a32"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM3NTMxNw==", "bodyText": "but will not fix them up", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r539375317", "createdAt": "2020-12-09T14:56:43Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/Workspace.java", "diffHunk": "@@ -287,29 +287,85 @@ public static Workspace getWorkspace(File workspaceDir, String bndDir) throws Ex\n \t\t}\n \t}\n \n+\t/**\n+\t * Create a workspace on the given directory, assuming that it contains a\n+\t * cnf directory. See {@link #Workspace(File, String)}\n+\t *\n+\t * @param workspaceDir the worksapce directory\n+\t */\n \tpublic Workspace(File workspaceDir) throws Exception {\n \t\tthis(workspaceDir, CNFDIR);\n \t}\n \n+\t/**\n+\t * Create a workspace with the given directory and the bnd directory,\n+\t * normally cnf. (Though there are some use cases where this is in another\n+\t * place.) This will create a {@link WorkspaceLayout#BND} layout set the\n+\t * base to the workspaceDir, and read the properties in the `build.bnd` file\n+\t * in the bndDir sub directory.\n+\t * <p>\n+\t * This will read the version specific defaults after the properties are\n+\t * read from build.bnd in an _intermediate_ processor.\n+\t *\n+\t * @param workspaceDir the workspace directory\n+\t * @param bndDir the bnd directory with build.bnd\n+\t */\n \tpublic Workspace(File workspaceDir, String bndDir) throws Exception {\n-\t\tsuper(getDefaults());\n+\t\tsuper(new Processor(getDefaults()));\n \t\tthis.maven = new Maven(Processor.getExecutor(), this);\n \t\tthis.layout = WorkspaceLayout.BND;\n \t\tworkspaceDir = workspaceDir.getAbsoluteFile();\n \t\tsetBase(workspaceDir); // setBase before call to setFileSystem\n \t\taddBasicPlugin(new LoggingProgressPlugin());\n \t\tsetFileSystem(workspaceDir, bndDir);\n+\n+\t\t// we must process version defaults after the\n+\t\t// normal properties are read\n+\n+\t\tfixupVersionDefaults();\n+\n \t\tprojects = new ProjectTracker(this);\n \t}\n \n+\t/*\n+\t * This constructor will create an intermediate parent processor to hold the\n+\t * version defaults but will fix them up. This must be done by the caller", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c9c2af5308ecdea72e52f84d49d0c7a65d3a32"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM3NzM5OQ==", "bodyText": "Did you mean to use OSGi Version rather  than Bnd's Version?", "url": "https://github.com/bndtools/bnd/pull/4442#discussion_r539377399", "createdAt": "2020-12-09T14:59:08Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.bndlib.tests/test/test/WorkspaceTest.java", "diffHunk": "@@ -17,10 +17,14 @@\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.TestName;\n+import org.osgi.framework.Version;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c9c2af5308ecdea72e52f84d49d0c7a65d3a32"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2408eebef2bb6ebff8b250b38dc968db883d0fa6", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/2408eebef2bb6ebff8b250b38dc968db883d0fa6", "committedDate": "2021-03-12T09:09:06Z", "message": "[build] Workspace per version defaults\n\nThis patch provides the defaults for the properties\nfor a workspace. These defaults are version specific\nand the user can set a `-versiondefaults <v>` \ninstruction to select a specific version. This\nallows a user to upgrade to a new workspace but\nkeep the old defaults.\n\nThe idea is that new features are written to be\ndisabled by default. Preferably, this should\ndone with a scope model if application. That is,\nlike for example `contract *` . These instructions\nare _scoped_. By setting an appropriate default\nyou can enable these instructions.\n\nBy default, a workspace will read in the defaults\nof the current version. We maintain already \na current version in About. However, with the\n`-versiondefaults` instruction the user can pick\nan earlier version of defaults.\n\nThe idea is that we continue to add features but\nstrictly write them disabled. The version defaults\ncan then selectively enable them so that the majority\nof our users get the benefits. \n\nThe version default file will (5.3.0.bnd) will have\nthe full set of defaults and will therefore encompass\nthe previous version's defaults.\n\nHowever, an organization that upgrades their bnd,\nwill be able to remain at an older version feature\nwise.\n\nThis was mainly driven because an older workspace\nthat I had was upgraded. After the upgrade, the \nartifacts failed in the field because the maven\ndependencies were automatically added to the pom. Similar\nproblems happened with the new Java import and I \nthink I once messed up with the EE requirements based\non the Java class levels.\n\nThe prime advantages I see are:\n\n- A more consistent feature model (disable in code, \n  enable by version defaults)\n- Concise documentation of the presence of new features in \n  the version default file. This can guide users to\n  override the defaults in their workspace file.\n- A user choice to revert back to an older feature\n  set while being able to take advantage of bug fixes\n\nThis code should work as is in the Gradle workspace\nbuild. The gradle native plugin & maven need to \nsee how they get their current defaults. Since the\ndefaults were already maintained this way, I expect\nthat this requires no change but I know little about\nthese uses of bndlib.\n\n- Made versions ignore micro updates\n- added test cases & set version defaults for standalone \nand default case\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1cc872a6ac7f584818349f9fa2bb141a1b60d39d", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/1cc872a6ac7f584818349f9fa2bb141a1b60d39d", "committedDate": "2020-12-09T16:09:41Z", "message": "no good deed of commenting goes unpunished :-)\n\n---\n Signed-off-by: Peter Kriens <Peter.Kriens@aqute.biz>\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}, "afterCommit": {"oid": "eb7185b8822cb1fcbb64275abec64de0c13127c0", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/eb7185b8822cb1fcbb64275abec64de0c13127c0", "committedDate": "2021-03-12T09:09:06Z", "message": "no good deed of commenting goes unpunished :-)\n\n---\n Signed-off-by: Peter Kriens <Peter.Kriens@aqute.biz>\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc4148e838544d4112d11c19dd945e7c500ddc1d", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/fc4148e838544d4112d11c19dd945e7c500ddc1d", "committedDate": "2021-03-12T09:59:12Z", "message": "[versiondefaults] Version defaults\n\n\u2013 Fixed up comment\n\u2013 Comsetic stuff\n\u2013 Moved to 5.4\n\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb7185b8822cb1fcbb64275abec64de0c13127c0", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/eb7185b8822cb1fcbb64275abec64de0c13127c0", "committedDate": "2021-03-12T09:09:06Z", "message": "no good deed of commenting goes unpunished :-)\n\n---\n Signed-off-by: Peter Kriens <Peter.Kriens@aqute.biz>\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}, "afterCommit": {"oid": "fc4148e838544d4112d11c19dd945e7c500ddc1d", "author": {"user": {"login": "pkriens", "name": "Peter Kriens"}}, "url": "https://github.com/bndtools/bnd/commit/fc4148e838544d4112d11c19dd945e7c500ddc1d", "committedDate": "2021-03-12T09:59:12Z", "message": "[versiondefaults] Version defaults\n\n\u2013 Fixed up comment\n\u2013 Comsetic stuff\n\u2013 Moved to 5.4\n\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3138, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}