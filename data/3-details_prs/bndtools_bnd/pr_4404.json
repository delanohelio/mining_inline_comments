{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NDI5NTYy", "number": 4404, "title": "[bndtools] Gracefully handle missing cnf", "bodyText": "Without this fix, Bndtools generates an NPE during building if the cnf project is missing and continues to fail building even after the cnf project is added. This fixes #4401.\nAs a side effect, also introduces an error marker if the Bnd project is not inside the Bnd workspace. This fixes #4203.\nThis seems to work in my testing and not to break anything else, but it's hard to be sure without a decent set of regression tests. It would be good for us to smoke-test it on dev for a while before release.", "createdAt": "2020-11-10T11:42:46Z", "url": "https://github.com/bndtools/bnd/pull/4404", "merged": true, "mergeCommit": {"oid": "838bfe6d8fc88903e26678fadebfebee3881bff9"}, "closed": true, "closedAt": "2020-11-17T19:06:27Z", "author": {"login": "kriegfrj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbKx54gFqTUyNzI5NDI1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddeZw-AFqTUzMjY5ODczMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mjk0MjU5", "url": "https://github.com/bndtools/bnd/pull/4404#pullrequestreview-527294259", "createdAt": "2020-11-10T15:03:33Z", "commit": {"oid": "595170a3e19cf2cb8aa6165d578c38be544a9c9f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNTowMzozM1rOHwg1Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNTowNTo1NFrOHwg8IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMTU4Nw==", "bodyText": "You now call markers.deleteMarkers(\"*\") twice if you get an exception on Central.getProject(myProject).", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r520631587", "createdAt": "2020-11-10T15:03:33Z", "author": {"login": "bjhargrave"}, "path": "bndtools.builder/src/org/bndtools/builder/BndtoolsBuilder.java", "diffHunk": "@@ -113,15 +112,21 @@\n \t\t\t\t\t.getDynamicReferences();\n \t\t\t}\n \n-\t\t\tif (model == null) {\n-\t\t\t\ttry {\n-\t\t\t\t\tmodel = Central.getProject(myProject);\n-\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tmarkers.deleteMarkers(\"*\");\n-\t\t\t\t}\n-\t\t\t\tif (model == null)\n-\t\t\t\t\treturn noreport();\n+\t\t\tProject ourModel = null;\n+\t\t\ttry {\n+\t\t\t\tourModel = Central.getProject(myProject);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");\n \t\t\t}\n+\t\t\tif (ourModel == null) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595170a3e19cf2cb8aa6165d578c38be544a9c9f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMzM3Nw==", "bodyText": "Should this not be cnf.isOpen()?", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r520633377", "createdAt": "2020-11-10T15:05:54Z", "author": {"login": "bjhargrave"}, "path": "bndtools.builder/src/org/bndtools/builder/MarkerSupport.java", "diffHunk": "@@ -98,7 +98,7 @@ private void deleteCnfMarkersForThisProject(String markerType) throws CoreExcept\n \t\tIProject cnf = ResourcesPlugin.getWorkspace()\n \t\t\t.getRoot()\n \t\t\t.getProject(\"cnf\");\n-\t\tif (cnf != null) {\n+\t\tif (cnf != null && cnf.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595170a3e19cf2cb8aa6165d578c38be544a9c9f"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "595170a3e19cf2cb8aa6165d578c38be544a9c9f", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/595170a3e19cf2cb8aa6165d578c38be544a9c9f", "committedDate": "2020-11-10T11:36:53Z", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added.\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace.\n\nFixes #4203, #4401.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}, "afterCommit": {"oid": "08c6ac9f060d5b33edc4524e2d61b614ba1d651a", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/08c6ac9f060d5b33edc4524e2d61b614ba1d651a", "committedDate": "2020-11-11T02:07:36Z", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MTM3OTk4", "url": "https://github.com/bndtools/bnd/pull/4404#pullrequestreview-528137998", "createdAt": "2020-11-11T12:43:10Z", "commit": {"oid": "08c6ac9f060d5b33edc4524e2d61b614ba1d651a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjo0NzoyOFrOHxLuGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjo0ODoxOVrOHxLvxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMzNDI5Nw==", "bodyText": "It does seem a bit presumptuous of us (Bndtools) to remove the error markers of another builder, no? I am not sure we should do this.", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r521334297", "createdAt": "2020-11-11T12:47:28Z", "author": {"login": "bjhargrave"}, "path": "bndtools.builder/src/org/bndtools/builder/BndtoolsBuilder.java", "diffHunk": "@@ -113,16 +118,57 @@\n \t\t\t\t\t.getDynamicReferences();\n \t\t\t}\n \n-\t\t\tif (model == null) {\n-\t\t\t\ttry {\n-\t\t\t\t\tmodel = Central.getProject(myProject);\n-\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\tProject ourModel = null;\n+\t\t\ttry {\n+\t\t\t\tourModel = Central.getProject(myProject);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\t\t// If the cnf project is missing there will likely be a myriad\n+\t\t\t\t// of Java problems. These do nothing but clutter the error\n+\t\t\t\t// output and make it hard to find the real problem in the\n+\t\t\t\t// problem log.\n+\t\t\t\tmyProject.deleteMarkers(IJavaModelMarker.JAVA_MODEL_PROBLEM_MARKER, true, IResource.DEPTH_INFINITE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08c6ac9f060d5b33edc4524e2d61b614ba1d651a"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMzNDcyNA==", "bodyText": "It does seem a bit presumptuous of us (Bndtools) to remove the error markers of another builder, no? I am not sure we should do this.", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r521334724", "createdAt": "2020-11-11T12:48:19Z", "author": {"login": "bjhargrave"}, "path": "bndtools.builder/src/org/bndtools/builder/BndtoolsBuilder.java", "diffHunk": "@@ -113,16 +118,57 @@\n \t\t\t\t\t.getDynamicReferences();\n \t\t\t}\n \n-\t\t\tif (model == null) {\n-\t\t\t\ttry {\n-\t\t\t\t\tmodel = Central.getProject(myProject);\n-\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\tProject ourModel = null;\n+\t\t\ttry {\n+\t\t\t\tourModel = Central.getProject(myProject);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\t\t// If the cnf project is missing there will likely be a myriad\n+\t\t\t\t// of Java problems. These do nothing but clutter the error\n+\t\t\t\t// output and make it hard to find the real problem in the\n+\t\t\t\t// problem log.\n+\t\t\t\tmyProject.deleteMarkers(IJavaModelMarker.JAVA_MODEL_PROBLEM_MARKER, true, IResource.DEPTH_INFINITE);\n+\t\t\t\tlogger.logError(\"Exception while trying to fetch bnd project for \" + myProject.getName(), e);\n+\t\t\t\tmarkers.createMarker(null, IMarker.SEVERITY_ERROR, \"Exception while trying to fetch bnd project: \" + e,\n+\t\t\t\t\tBndtoolsConstants.MARKER_BND_PATH_PROBLEM);\n+\t\t\t\treturn noreport();\n+\t\t\t}\n+\t\t\tif (ourModel == null) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\t\t// If the cnf project is missing there will likely be a myriad\n+\t\t\t\t// of Java problems. These do nothing but clutter the error\n+\t\t\t\t// output and make it hard to find the real problem in the\n+\t\t\t\t// problem log.\n+\t\t\t\tmyProject.deleteMarkers(IJavaModelMarker.JAVA_MODEL_PROBLEM_MARKER, true, IResource.DEPTH_INFINITE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08c6ac9f060d5b33edc4524e2d61b614ba1d651a"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08c6ac9f060d5b33edc4524e2d61b614ba1d651a", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/08c6ac9f060d5b33edc4524e2d61b614ba1d651a", "committedDate": "2020-11-11T02:07:36Z", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}, "afterCommit": {"oid": "95b761cabdc5045e65d514e065602f6aaa4e392f", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/95b761cabdc5045e65d514e065602f6aaa4e392f", "committedDate": "2020-11-12T07:11:53Z", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb86a478f95a4e3d3483240cec8f9ae9eac2c60", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/4fb86a478f95a4e3d3483240cec8f9ae9eac2c60", "committedDate": "2020-11-12T07:28:07Z", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95b761cabdc5045e65d514e065602f6aaa4e392f", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/95b761cabdc5045e65d514e065602f6aaa4e392f", "committedDate": "2020-11-12T07:11:53Z", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}, "afterCommit": {"oid": "4fb86a478f95a4e3d3483240cec8f9ae9eac2c60", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/4fb86a478f95a4e3d3483240cec8f9ae9eac2c60", "committedDate": "2020-11-12T07:28:07Z", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjk4NzMw", "url": "https://github.com/bndtools/bnd/pull/4404#pullrequestreview-532698730", "createdAt": "2020-11-17T19:06:20Z", "commit": {"oid": "4fb86a478f95a4e3d3483240cec8f9ae9eac2c60"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3130, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}