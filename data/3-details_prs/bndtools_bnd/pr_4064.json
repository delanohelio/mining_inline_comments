{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MDUzMDQy", "number": 4064, "title": "bndtools: use LaunchUtils to create the bndrun used in command execut\u2026", "bodyText": "\u2026ions and support m2e\nSigned-off-by: Raymond Aug\u00e9 raymond.auge@liferay.com", "createdAt": "2020-05-17T03:04:15Z", "url": "https://github.com/bndtools/bnd/pull/4064", "merged": true, "mergeCommit": {"oid": "af816c3fb0d38c44ad053aa08673ab9b61644a1e"}, "closed": true, "closedAt": "2020-05-17T17:07:10Z", "author": {"login": "rotty3000"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciLGt6ABqjMzNDQ1MzY1Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABciRqgHgFqTQxMzE5NzU3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75135a25ef2c8ae7199c086bdd0ada59df68578c", "author": {"user": {"login": "rotty3000", "name": "Raymond Aug\u00e9"}}, "url": "https://github.com/bndtools/bnd/commit/75135a25ef2c8ae7199c086bdd0ada59df68578c", "committedDate": "2020-05-17T02:57:16Z", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>"}, "afterCommit": {"oid": "5bb60c92a0b79c458a9bb727bc8e0c67dcd47580", "author": {"user": {"login": "rotty3000", "name": "Raymond Aug\u00e9"}}, "url": "https://github.com/bndtools/bnd/commit/5bb60c92a0b79c458a9bb727bc8e0c67dcd47580", "committedDate": "2020-05-17T03:49:32Z", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTYyNjU5", "url": "https://github.com/bndtools/bnd/pull/4064#pullrequestreview-413162659", "createdAt": "2020-05-17T13:26:57Z", "commit": {"oid": "5bb60c92a0b79c458a9bb727bc8e0c67dcd47580"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxMzoyNjo1N1rOGWg8CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxMzoyNjo1N1rOGWg8CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI2MTUxMw==", "bodyText": "This seems like a perfect place for a memoizier to get lazy initialization and it will properly handle the synchronization for at-most-once initialization.", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426261513", "createdAt": "2020-05-17T13:26:57Z", "author": {"login": "bjhargrave"}, "path": "bndtools.core/src/bndtools/command/BndrunFilesParameterValues.java", "diffHunk": "@@ -33,25 +31,21 @@\n \n \t@Override\n \tpublic Map getParameterValues() {\n-\t\tWorkspace ws = Central.getWorkspaceIfPresent();\n+\t\tif (bndrunFilesMap != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bb60c92a0b79c458a9bb727bc8e0c67dcd47580"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bb60c92a0b79c458a9bb727bc8e0c67dcd47580", "author": {"user": {"login": "rotty3000", "name": "Raymond Aug\u00e9"}}, "url": "https://github.com/bndtools/bnd/commit/5bb60c92a0b79c458a9bb727bc8e0c67dcd47580", "committedDate": "2020-05-17T03:49:32Z", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>"}, "afterCommit": {"oid": "217a2befc452c8243050f75828d414d11c3bde1e", "author": {"user": {"login": "rotty3000", "name": "Raymond Aug\u00e9"}}, "url": "https://github.com/bndtools/bnd/commit/217a2befc452c8243050f75828d414d11c3bde1e", "committedDate": "2020-05-17T15:15:50Z", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTcyODc0", "url": "https://github.com/bndtools/bnd/pull/4064#pullrequestreview-413172874", "createdAt": "2020-05-17T15:24:11Z", "commit": {"oid": "217a2befc452c8243050f75828d414d11c3bde1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNToyNDoxMlrOGWhqrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNToyNDoxMlrOGWhqrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3MzQ1Mw==", "bodyText": "Perhaps you don't want to add the listener in the supplier since you will get an additional listener every time reset is called and the new memoized is initialized. Then each listener will further call reset...\nI think you just need to add the listener in the constructor.", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426273453", "createdAt": "2020-05-17T15:24:12Z", "author": {"login": "bjhargrave"}, "path": "bndtools.core/src/bndtools/command/BndrunFilesParameterValues.java", "diffHunk": "@@ -21,44 +23,40 @@\n import org.eclipse.core.runtime.CoreException;\n import org.eclipse.core.runtime.IPath;\n \n-import aQute.bnd.build.Workspace;\n-import bndtools.central.Central;\n+import aQute.lib.memoize.Memoize;\n \n public class BndrunFilesParameterValues implements IParameterValues {\n \n \tstatic final String BNDRUN_FILE = \"bnd.command.bndrunFile\";\n \n-\tprivate static Map<String, String> bndrunFilesMap;\n-\tprivate static IResourceChangeListener\tlistener\t= new InvalidateMapListener();\n+\tprivate IResourceChangeListener\t\t\t\t\tlistener\t= new InvalidateMapListener();\n+\tprivate volatile Supplier<Map<String, String>>\tbndrunFilesMap;\n+\n+\tpublic BndrunFilesParameterValues() {\n+\t\tbndrunFilesMap = reset();\n+\t}\n+\n+\tSupplier<Map<String, String>> reset() {\n+\t\treturn Memoize.referenceSupplier(() -> {\n+\t\t\tMap<String, String> map = Arrays.stream(ResourcesPlugin.getWorkspace()\n+\t\t\t\t.getRoot()\n+\t\t\t\t.getProjects())\n+\t\t\t\t.filter(IProject::isOpen)\n+\t\t\t\t.map(this::findBndrunFiles)\n+\t\t\t\t.flatMap(Collection::stream)\n+\t\t\t\t.map(IResource::getFullPath)\n+\t\t\t\t.collect(toMap(IPath::toPortableString, IPath::toPortableString));\n+\n+\t\t\tResourcesPlugin.getWorkspace()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "217a2befc452c8243050f75828d414d11c3bde1e"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "author": {"user": {"login": "rotty3000", "name": "Raymond Aug\u00e9"}}, "url": "https://github.com/bndtools/bnd/commit/a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "committedDate": "2020-05-17T15:28:09Z", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "217a2befc452c8243050f75828d414d11c3bde1e", "author": {"user": {"login": "rotty3000", "name": "Raymond Aug\u00e9"}}, "url": "https://github.com/bndtools/bnd/commit/217a2befc452c8243050f75828d414d11c3bde1e", "committedDate": "2020-05-17T15:15:50Z", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>"}, "afterCommit": {"oid": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "author": {"user": {"login": "rotty3000", "name": "Raymond Aug\u00e9"}}, "url": "https://github.com/bndtools/bnd/commit/a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "committedDate": "2020-05-17T15:28:09Z", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTczNjE5", "url": "https://github.com/bndtools/bnd/pull/4064#pullrequestreview-413173619", "createdAt": "2020-05-17T15:33:22Z", "commit": {"oid": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTk3NTc1", "url": "https://github.com/bndtools/bnd/pull/4064#pullrequestreview-413197575", "createdAt": "2020-05-17T20:50:58Z", "commit": {"oid": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QyMDo1MDo1OFrOGWjgVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QyMDo1MzoxOFrOGWjhIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzU3NA==", "bodyText": "Hey @rotty3000   Thanks for wiring this up with Maven support!\nWhy did you want to predicate this on being a bndProject.  Will that match maven projects?", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426303574", "createdAt": "2020-05-17T20:50:58Z", "author": {"login": "gamerson"}, "path": "bndtools.core/src/bndtools/command/BndResolveHandler.java", "diffHunk": "@@ -37,13 +37,13 @@ public Object execute(ExecutionEvent event) throws ExecutionException {\n \t\t\tpublic IStatus runInWorkspace(IProgressMonitor monitor) throws CoreException {\n \t\t\t\tIStatus status = Status.OK_STATUS;\n \t\t\t\ttry {\n-\t\t\t\t\tBndrun bndrun = Bndrun.createBndrun(Central.getWorkspace(), new File(bndrunFile.getLocationURI()));\n-\t\t\t\t\tProject bndProject = Central.getProject(project);\n-\t\t\t\t\tbndrun.setBase(bndProject.getBase());\n+\t\t\t\t\tBndrun bndrun = (Bndrun) LaunchUtils.createRun(bndrunFile, RunMode.LAUNCH);\n \n \t\t\t\t\tbndrun.resolve(false, true);\n \n-\t\t\t\t\tbndrunFile.refreshLocal(IResource.DEPTH_ONE, monitor);\n+\t\t\t\t\tif (Central.isBndProject(project)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzc3OQ==", "bodyText": "By changing this to non-static, every command that shared this ParameterValues map is going to recalculate.  So right now we have 2 commands but in the future we may want more.  I don't think this is a huge performance hit right now, but if we have N commands, then there will be N copies of this class and N copies of the bndrunFilesMap.  Do y'all think that will be an issue?  Maybe not since there will not be an abundance of bndfiles usually.", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426303779", "createdAt": "2020-05-17T20:53:18Z", "author": {"login": "gamerson"}, "path": "bndtools.core/src/bndtools/command/BndrunFilesParameterValues.java", "diffHunk": "@@ -21,44 +22,37 @@\n import org.eclipse.core.runtime.CoreException;\n import org.eclipse.core.runtime.IPath;\n \n-import aQute.bnd.build.Workspace;\n-import bndtools.central.Central;\n+import aQute.lib.memoize.Memoize;\n \n public class BndrunFilesParameterValues implements IParameterValues {\n \n \tstatic final String BNDRUN_FILE = \"bnd.command.bndrunFile\";\n \n-\tprivate static Map<String, String> bndrunFilesMap;\n-\tprivate static IResourceChangeListener\tlistener\t= new InvalidateMapListener();\n+\tprivate IResourceChangeListener\t\t\t\t\tlistener\t= new InvalidateMapListener();\n+\tprivate volatile Supplier<Map<String, String>>\tbndrunFilesMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3209, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}