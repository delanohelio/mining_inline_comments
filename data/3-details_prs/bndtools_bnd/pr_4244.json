{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxMjA0ODI3", "number": 4244, "title": "[junit-platform] Pluggable test listeners", "bodyText": "Find any OSGi services registered under the TestExecutionListener interface and use them as listeners for the test execution.\nFixes #3526.\nHardest thing about this was coming up with a decent regression test.\nI'm also interested in feedback from some of the OSGi hardcores about if & how biz.aQute.tester.junit-platform should handle service dynamics - what happens if a test listener disappears during the test run? Perhaps I can have an implementation of TestExecutionListener that maintains the service tracker, and getting a fresh list of services on every invocation to delegate the invocation to.", "createdAt": "2020-08-01T15:38:51Z", "url": "https://github.com/bndtools/bnd/pull/4244", "merged": true, "mergeCommit": {"oid": "15601a4dbf4f7d8678b57a8360a93eebd9ee99d6"}, "closed": true, "closedAt": "2020-08-07T12:28:47Z", "author": {"login": "kriegfrj"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6qtowgBqjM2MTIwNjYyOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8jkwnAFqTQ2MzI3MTU5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3defa54ffe1d21209d2cb8abfc06478742e08de8", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/3defa54ffe1d21209d2cb8abfc06478742e08de8", "committedDate": "2020-08-01T15:29:50Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526."}, "afterCommit": {"oid": "448fea94207b35bf3b5251a763e78761c1f6979f", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/448fea94207b35bf3b5251a763e78761c1f6979f", "committedDate": "2020-08-01T15:39:05Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxODMyMzgz", "url": "https://github.com/bndtools/bnd/pull/4244#pullrequestreview-461832383", "createdAt": "2020-08-05T16:31:49Z", "commit": {"oid": "448fea94207b35bf3b5251a763e78761c1f6979f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjozMTo1MFrOG8RfcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjozMTo1MFrOG8RfcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg1NDMyMA==", "bodyText": "This is problematic. When you close the tracker, you release the services. Which means you should no longer use the service objects. But you clearly keep using the service objects here. A bundle providing the service could use a ServiceFactory and disable the object in someway when the service is released. It is never good practice to use a service object after you release the service.\nA tracker like this should be created and opened in the bundle's activator start method and closed in the stop method.", "url": "https://github.com/bndtools/bnd/pull/4244#discussion_r465854320", "createdAt": "2020-08-05T16:31:50Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.tester.junit-platform/src/aQute/tester/junit/platform/Activator.java", "diffHunk": "@@ -209,6 +210,16 @@ public void executionSkipped(TestIdentifier testIdentifier, String reason) {\n \t\t\t\tmessage(\"\", \"TEST %s <<< SKIPPED\", testName(testIdentifier));\n \t\t\t}\n \t\t});\n+\t\tServiceTracker<TestExecutionListener, TestExecutionListener> track = new ServiceTracker<>(context,\n+\t\t\tTestExecutionListener.class, null);\n+\t\ttrack.open(true);\n+\t\tOptional.ofNullable(track.getServices())\n+\t\t\t.ifPresent(services -> Stream.of(services)\n+\t\t\t\t.map(TestExecutionListener.class::cast)\n+\t\t\t\t.forEach(listener -> {\n+\t\t\t\t\tlistenerList.add(listener);\n+\t\t\t\t}));\n+\t\ttrack.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "448fea94207b35bf3b5251a763e78761c1f6979f"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "448fea94207b35bf3b5251a763e78761c1f6979f", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/448fea94207b35bf3b5251a763e78761c1f6979f", "committedDate": "2020-08-01T15:39:05Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}, "afterCommit": {"oid": "e7dcc40c56647e502587755f1502ef7b62ead85e", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/e7dcc40c56647e502587755f1502ef7b62ead85e", "committedDate": "2020-08-06T06:39:24Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNTQxMzM4", "url": "https://github.com/bndtools/bnd/pull/4244#pullrequestreview-462541338", "createdAt": "2020-08-06T13:54:13Z", "commit": {"oid": "e7dcc40c56647e502587755f1502ef7b62ead85e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMzo1NDoxNFrOG80l7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMzo1NDoxNFrOG80l7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyOTQyMA==", "bodyText": "You do not want true here. Using true means you want to track all services including services which are not type compatible with your bundle. So you could track a TestExecutionListener service which this bundle cannot cast to TestExecutionListener.\nJust use track.open();", "url": "https://github.com/bndtools/bnd/pull/4244#discussion_r466429420", "createdAt": "2020-08-06T13:54:14Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.tester.junit-platform/src/aQute/tester/junit/platform/Activator.java", "diffHunk": "@@ -348,11 +344,21 @@ LauncherDiscoveryRequest buildRequest(List<? extends DiscoverySelector> selector\n \tlong test(LauncherDiscoveryRequest testRequest) {\n \t\ttrace(\"testing request %s\", testRequest);\n \t\ttry {\n+\t\t\tServiceTracker<TestExecutionListener, TestExecutionListener> track = new ServiceTracker<>(context,\n+\t\t\t\tTestExecutionListener.class, null);\n+\t\t\ttrack.open(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7dcc40c56647e502587755f1502ef7b62ead85e"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7dcc40c56647e502587755f1502ef7b62ead85e", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/e7dcc40c56647e502587755f1502ef7b62ead85e", "committedDate": "2020-08-06T06:39:24Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}, "afterCommit": {"oid": "533f97ed48158743788ad8679d6188790db537ba", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/533f97ed48158743788ad8679d6188790db537ba", "committedDate": "2020-08-06T15:01:33Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjE0ODk5", "url": "https://github.com/bndtools/bnd/pull/4244#pullrequestreview-462614899", "createdAt": "2020-08-06T15:11:37Z", "commit": {"oid": "533f97ed48158743788ad8679d6188790db537ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNToxMTozN1rOG839mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNToxMTozN1rOG839mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ4NDYzMw==", "bodyText": "You revert back to the bad behavior of closing the tracker before using the tracked services.", "url": "https://github.com/bndtools/bnd/pull/4244#discussion_r466484633", "createdAt": "2020-08-06T15:11:37Z", "author": {"login": "bjhargrave"}, "path": "biz.aQute.tester.junit-platform/src/aQute/tester/junit/platform/Activator.java", "diffHunk": "@@ -209,6 +210,16 @@ public void executionSkipped(TestIdentifier testIdentifier, String reason) {\n \t\t\t\tmessage(\"\", \"TEST %s <<< SKIPPED\", testName(testIdentifier));\n \t\t\t}\n \t\t});\n+\t\tServiceTracker<TestExecutionListener, TestExecutionListener> track = new ServiceTracker<>(context,\n+\t\t\tTestExecutionListener.class, null);\n+\t\ttrack.open();\n+\t\tOptional.ofNullable(track.getServices())\n+\t\t\t.ifPresent(services -> Stream.of(services)\n+\t\t\t\t.map(TestExecutionListener.class::cast)\n+\t\t\t\t.forEach(listener -> {\n+\t\t\t\t\tlistenerList.add(listener);\n+\t\t\t\t}));\n+\t\ttrack.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "533f97ed48158743788ad8679d6188790db537ba"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "533f97ed48158743788ad8679d6188790db537ba", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/533f97ed48158743788ad8679d6188790db537ba", "committedDate": "2020-08-06T15:01:33Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}, "afterCommit": {"oid": "2909034b93ed43da97005032baede4261361c859", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/2909034b93ed43da97005032baede4261361c859", "committedDate": "2020-08-06T23:56:30Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "593ef447b8d715a404af1799936e1f0d7c840fb8", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/593ef447b8d715a404af1799936e1f0d7c840fb8", "committedDate": "2020-08-07T00:37:54Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2909034b93ed43da97005032baede4261361c859", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/2909034b93ed43da97005032baede4261361c859", "committedDate": "2020-08-06T23:56:30Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}, "afterCommit": {"oid": "593ef447b8d715a404af1799936e1f0d7c840fb8", "author": {"user": {"login": "kriegfrj", "name": "Fr Jeremy Krieg"}}, "url": "https://github.com/bndtools/bnd/commit/593ef447b8d715a404af1799936e1f0d7c840fb8", "committedDate": "2020-08-07T00:37:54Z", "message": "[junit-platform] Pluggable test listeners\n\nFind any OSGi services registered under the TestExecutionListener\ninterface and use them as listeners for the test execution.\n\nFixes #3526.\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMjcxNTkz", "url": "https://github.com/bndtools/bnd/pull/4244#pullrequestreview-463271593", "createdAt": "2020-08-07T12:28:22Z", "commit": {"oid": "593ef447b8d715a404af1799936e1f0d7c840fb8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3174, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}