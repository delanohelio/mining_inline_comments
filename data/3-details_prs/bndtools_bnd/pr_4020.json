{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MjEwOTk3", "number": 4020, "title": "Better computation of maven dependencies", "bodyText": "We provide a means for maven repo types to supply maven attributes about artifacts through DownloadListeners into Containers which can then be examined by the maven dependency computation logic. pom.properties processing is the fall back for when artifacts come from non-maven repos such as the workspace repo.\nThis is done with limited API changes.", "createdAt": "2020-05-06T16:45:28Z", "url": "https://github.com/bndtools/bnd/pull/4020", "merged": true, "mergeCommit": {"oid": "4e3d2a4b136f33177632327147704f5d8f18ddab"}, "closed": true, "closedAt": "2020-05-06T17:24:38Z", "author": {"login": "bjhargrave"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceqmibgH2gAyNDE0MjEwOTk3OjE2ZWI1MWU5MjllMzZjYWMyZmQwYjkxYjNhZjRlYzc0MmZkYTA5MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcer8uDgFqTQwNjgyMjgzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16eb51e929e36cac2fd0b91b3af4ec742fda0904", "author": {"user": {"login": "bjhargrave", "name": "BJ Hargrave"}}, "url": "https://github.com/bndtools/bnd/commit/16eb51e929e36cac2fd0b91b3af4ec742fda0904", "committedDate": "2020-05-06T15:41:55Z", "message": "lib: Add split methods which take an existing Pattern\n\nSigned-off-by: BJ Hargrave <bj@bjhargrave.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e549da6b196ea7e49e3a0f79bf8eeb1635b30e6", "author": {"user": {"login": "bjhargrave", "name": "BJ Hargrave"}}, "url": "https://github.com/bndtools/bnd/commit/1e549da6b196ea7e49e3a0f79bf8eeb1635b30e6", "committedDate": "2020-05-06T15:52:18Z", "message": "maven: Avoid recompiling \":\" regex pattern\n\nSigned-off-by: BJ Hargrave <bj@bjhargrave.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24fd301b964fada4c24f52cff17addd2f6e6e9f", "author": {"user": {"login": "bjhargrave", "name": "BJ Hargrave"}}, "url": "https://github.com/bndtools/bnd/commit/f24fd301b964fada4c24f52cff17addd2f6e6e9f", "committedDate": "2020-05-06T15:53:46Z", "message": "maven: Add attributes methods to get maven data as attributes in a map\n\nSigned-off-by: BJ Hargrave <bj@bjhargrave.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "973e98b97d2b77a1da9402d3d5d0ef2f34a5a268", "author": {"user": {"login": "bjhargrave", "name": "BJ Hargrave"}}, "url": "https://github.com/bndtools/bnd/commit/973e98b97d2b77a1da9402d3d5d0ef2f34a5a268", "committedDate": "2020-05-06T16:02:22Z", "message": "download: Add support for DownloadListeners to receive attributes\n\nWhen a download is successful, the DownloadListener can be provided\nattributes about the download as well as the local File object.\n\nDownloadBlocker is updated to collect any attributes which can be\nretrieved by the party using the DownloadBlocker.\n\nSigned-off-by: BJ Hargrave <bj@bjhargrave.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55cdffc6574e330c3c3e4c7b833cfec1255bb28c", "author": {"user": {"login": "bjhargrave", "name": "BJ Hargrave"}}, "url": "https://github.com/bndtools/bnd/commit/55cdffc6574e330c3c3e4c7b833cfec1255bb28c", "committedDate": "2020-05-06T16:14:03Z", "message": "maven: MavenBndRepository and BndPomRepository provide maven attributes\n\nWhen a DownloadListener is supplied to receive a File for the requested\narchive, we now also provide attributes containing the maven archive\ninformation.\n\nSigned-off-by: BJ Hargrave <bj@bjhargrave.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a2f331dd57ed6e434bdd04277f42f492e3bfd32", "author": {"user": {"login": "bjhargrave", "name": "BJ Hargrave"}}, "url": "https://github.com/bndtools/bnd/commit/0a2f331dd57ed6e434bdd04277f42f492e3bfd32", "committedDate": "2020-05-06T16:27:44Z", "message": "pom dependencies: Prefer maven metadata from repos\n\nWe collect any attributes provided by the repo into the container\nattributes taking care not to override any attribute values already in\nthe container. Then when computing the -maven-dependencies instruction,\nwe can look for, and prefer, the maven attributes supplied by the repo.\n\nIf the jar does not come from a repo supplying maven attributes, we\nfall back to processing pom.properties as before. This will be the case\nfor projects in the workspace since the workspace repo does not supply\nmaven attributes.\n\nFixes https://github.com/bndtools/bnd/issues/4015\n\nSigned-off-by: BJ Hargrave <bj@bjhargrave.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODIyODMw", "url": "https://github.com/bndtools/bnd/pull/4020#pullrequestreview-406822830", "createdAt": "2020-05-06T17:16:03Z", "commit": {"oid": "0a2f331dd57ed6e434bdd04277f42f492e3bfd32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzoxNjowM1rOGRdMIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzoxNjowM1rOGRdMIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk1NzIxOQ==", "bodyText": "This solution is a lot better!\nHowever, could we somehow delegate this very mavenish code to not be in the build package? Maybe a plugin? At least make all this maven support go to one place?\nNice work!", "url": "https://github.com/bndtools/bnd/pull/4020#discussion_r420957219", "createdAt": "2020-05-06T17:16:03Z", "author": {"login": "pkriens"}, "path": "biz.aQute.bndlib/src/aQute/bnd/build/ProjectBuilder.java", "diffHunk": "@@ -136,36 +136,57 @@ private void addClasspath(Parameters dependencies, Container c) throws IOExcepti\n \t\tJar jar = new Jar(file);\n \t\tsuper.addClasspath(jar);\n \t\tproject.unreferencedClasspathEntries.put(jar.getName(), c);\n-\t\tif ((dependencies != null) && !Boolean.parseBoolean(c.getAttributes()\n-\t\t\t.getOrDefault(\"maven-optional\", \"false\"))) {\n-\t\t\tjar.getResources(pomPropertiesFilter)\n-\t\t\t\t.forEachOrdered(r -> {\n-\t\t\t\t\tUTF8Properties pomProperties = new UTF8Properties();\n-\t\t\t\t\ttry (InputStream in = r.openInputStream()) {\n-\t\t\t\t\t\tpomProperties.load(in);\n-\t\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\t\tlogger.debug(\"unable to read pom.properties resource {}\", r, e);\n-\t\t\t\t\t\treturn;\n-\t\t\t\t\t}\n-\t\t\t\t\tString depVersion = pomProperties.getProperty(\"version\");\n-\t\t\t\t\tString depGroupId = pomProperties.getProperty(\"groupId\");\n-\t\t\t\t\tString depArtifactId = pomProperties.getProperty(\"artifactId\");\n-\t\t\t\t\tif ((depGroupId != null) && (depArtifactId != null) && (depVersion != null)) {\n-\t\t\t\t\t\tAttrs attrs = new Attrs();\n-\t\t\t\t\t\tattrs.put(\"groupId\", depGroupId);\n-\t\t\t\t\t\tattrs.put(\"artifactId\", depArtifactId);\n-\t\t\t\t\t\tattrs.put(\"version\", depVersion);\n-\t\t\t\t\t\tattrs.put(\"scope\", c.getAttributes()\n-\t\t\t\t\t\t\t.getOrDefault(\"maven-scope\", getProperty(MAVEN_SCOPE, \"compile\")));\n-\t\t\t\t\t\tString key = new StringBuilder().append(depGroupId)\n-\t\t\t\t\t\t\t.append(':')\n-\t\t\t\t\t\t\t.append(depArtifactId)\n-\t\t\t\t\t\t\t.append(':')\n-\t\t\t\t\t\t\t.append(depVersion)\n-\t\t\t\t\t\t\t.toString();\n-\t\t\t\t\t\tdependencies.add(key, attrs);\n-\t\t\t\t\t}\n-\t\t\t\t});\n+\t\tMap<String, String> containerAttributes = c.getAttributes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a2f331dd57ed6e434bdd04277f42f492e3bfd32"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3202, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}