{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MzQyODY0", "number": 2740, "title": "Cache username in the get user flow", "bodyText": "Purpose\n\nTo get the user name here we have used userStoreManager.getUserList to get user list with a certain unique user id.\nBut this involves a very costly query operation.\nSELECT DISTINCT UM_USER.UM_USER_ID FROM UM_USER, UM_USER_ATTRIBUTE WHERE UM_USER_ATTRIBUTE.UM_USER_ID = UM_USER.UM_ID AND UM_USER_ATTRIBUTE.UM_ATTR_NAME =? AND UM_USER_ATTRIBUTE.UM_ATTR_VALUE LIKE ? AND UM_USER_ATTRIBUTE.UM_PROFILE_ID=? AND UM_USER_ATTRIBUTE.UM_TENANT_ID=? AND UM_USER.UM_TENANT_ID=?;\nHence not caching this affects heavily in performance.\nIn certain cases such as Authorization Code grant the user name already get cached before reaching the getUser() method Hence caching this will be really effective in the aspect of performance", "createdAt": "2020-08-10T08:02:04Z", "url": "https://github.com/wso2/carbon-kernel/pull/2740", "merged": true, "mergeCommit": {"oid": "9795334c9951b3f005ee32cc08497ccdaf9028c4"}, "closed": true, "closedAt": "2020-08-12T03:52:13Z", "author": {"login": "Buddhimah"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9dwmyAFqTQ2NDAzMjQ3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-IIrDAFqTQ2NTc1MjI5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDMyNDc3", "url": "https://github.com/wso2/carbon-kernel/pull/2740#pullrequestreview-464032477", "createdAt": "2020-08-10T08:15:47Z", "commit": {"oid": "130650e1998579f81d6e02b952e30d18165104e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoxNTo0OFrOG-FLcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoxNTo0OFrOG-FLcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc0OTc0NA==", "bodyText": "I guess we should be able to use the UserCoreUtil.removeDomainFromName here to get the domainFreeUserName?", "url": "https://github.com/wso2/carbon-kernel/pull/2740#discussion_r467749744", "createdAt": "2020-08-10T08:15:48Z", "author": {"login": "ashensw"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/UserUniqueIDManger.java", "diffHunk": "@@ -67,20 +68,36 @@ public User addUser(String username, String profileName, AbstractUserStoreManage\n     public User getUser(String uniqueId, AbstractUserStoreManager userStoreManager)\n             throws UserStoreException {\n \n-        String[] usernames = userStoreManager.getUserList(UserCoreClaimConstants.USER_ID_CLAIM_URI, uniqueId, null);\n+        String userName = userStoreManager.getFromUserNameCache(uniqueId);\n+        if (StringUtils.isEmpty(userName)) {\n \n-        if (usernames.length > 1) {\n-            throw new UserStoreException(\"More than one user presents with the same user unique id.\");\n-        }\n+            String[] usernames = userStoreManager.getUserList(UserCoreClaimConstants.USER_ID_CLAIM_URI, uniqueId, null);\n+\n+            if (usernames.length > 1) {\n+                throw new UserStoreException(\"More than one user presents with the same user unique id.\");\n+            }\n \n-        if (usernames.length == 0) {\n-            return null;\n+            if (usernames.length == 0) {\n+                return null;\n+            }\n+            userName = usernames[0];\n+            UserStore userStore = userStoreManager.getUserStoreWithID(uniqueId);\n+            String[] userNames = userName.split(CarbonConstants.DOMAIN_SEPARATOR);\n+            String domainFreeUserName;\n+\n+            if (userNames.length > 1) {\n+                domainFreeUserName = userNames[1];\n+            } else {\n+                domainFreeUserName = userName;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "130650e1998579f81d6e02b952e30d18165104e2"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ca55a73965f69738229c1506731613c33f06212", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/7ca55a73965f69738229c1506731613c33f06212", "committedDate": "2020-08-10T09:36:36Z", "message": "Cache the get user flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "130650e1998579f81d6e02b952e30d18165104e2", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/130650e1998579f81d6e02b952e30d18165104e2", "committedDate": "2020-08-10T07:41:28Z", "message": "Cache the get user flow"}, "afterCommit": {"oid": "7ca55a73965f69738229c1506731613c33f06212", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/7ca55a73965f69738229c1506731613c33f06212", "committedDate": "2020-08-10T09:36:36Z", "message": "Cache the get user flow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDk2NTcw", "url": "https://github.com/wso2/carbon-kernel/pull/2740#pullrequestreview-464096570", "createdAt": "2020-08-10T09:56:54Z", "commit": {"oid": "7ca55a73965f69738229c1506731613c33f06212"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTo1Njo1NFrOG-IQTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTo1Njo1NFrOG-IQTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgwMDE0Mw==", "bodyText": "Ideally this cache needs to be managed outside the user-store-manager level, as it needs to keep a reference from UUID to {tenant, user-store, user-store-local-id}", "url": "https://github.com/wso2/carbon-kernel/pull/2740#discussion_r467800143", "createdAt": "2020-08-10T09:56:54Z", "author": {"login": "ruwanta"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/UserUniqueIDManger.java", "diffHunk": "@@ -67,20 +68,29 @@ public User addUser(String username, String profileName, AbstractUserStoreManage\n     public User getUser(String uniqueId, AbstractUserStoreManager userStoreManager)\n             throws UserStoreException {\n \n-        String[] usernames = userStoreManager.getUserList(UserCoreClaimConstants.USER_ID_CLAIM_URI, uniqueId, null);\n+        String userName = userStoreManager.getFromUserNameCache(uniqueId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ca55a73965f69738229c1506731613c33f06212"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8aca551803da7eeda76a273868f7fc7deab01993", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/8aca551803da7eeda76a273868f7fc7deab01993", "committedDate": "2020-08-10T14:27:40Z", "message": "Refactor user store manager level cache"}, "afterCommit": {"oid": "39845ba3a95d94b7f411c713df685b7f5516d651", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/39845ba3a95d94b7f411c713df685b7f5516d651", "committedDate": "2020-08-10T14:30:33Z", "message": "Refactor user store manager level cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39845ba3a95d94b7f411c713df685b7f5516d651", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/39845ba3a95d94b7f411c713df685b7f5516d651", "committedDate": "2020-08-10T14:30:33Z", "message": "Refactor user store manager level cache"}, "afterCommit": {"oid": "46f379383d38b68db6288ec63ec93d755303b773", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/46f379383d38b68db6288ec63ec93d755303b773", "committedDate": "2020-08-10T14:33:26Z", "message": "Refactor user store manager level cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "213475c4ec2e9f501fab5ba60e3c8e9983302ca4", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/213475c4ec2e9f501fab5ba60e3c8e9983302ca4", "committedDate": "2020-08-10T14:37:30Z", "message": "Refactor user store manager level cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46f379383d38b68db6288ec63ec93d755303b773", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/46f379383d38b68db6288ec63ec93d755303b773", "committedDate": "2020-08-10T14:33:26Z", "message": "Refactor user store manager level cache"}, "afterCommit": {"oid": "213475c4ec2e9f501fab5ba60e3c8e9983302ca4", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/213475c4ec2e9f501fab5ba60e3c8e9983302ca4", "committedDate": "2020-08-10T14:37:30Z", "message": "Refactor user store manager level cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa4d29db3821abc2e27783bebc6b5ad91a99c7a9", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/aa4d29db3821abc2e27783bebc6b5ad91a99c7a9", "committedDate": "2020-08-10T14:57:26Z", "message": "Use already exsisting cache manager"}, "afterCommit": {"oid": "7c0557c7fc2a0910013da0178ccc4a52c11b9465", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/7c0557c7fc2a0910013da0178ccc4a52c11b9465", "committedDate": "2020-08-10T15:00:01Z", "message": "Use already exsisting cache manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c0557c7fc2a0910013da0178ccc4a52c11b9465", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/7c0557c7fc2a0910013da0178ccc4a52c11b9465", "committedDate": "2020-08-10T15:00:01Z", "message": "Use already exsisting cache manager"}, "afterCommit": {"oid": "ad82c2be7df427b9d65c033a8a1a363d05d87eb8", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/ad82c2be7df427b9d65c033a8a1a363d05d87eb8", "committedDate": "2020-08-11T04:45:21Z", "message": "Use already exsisting cache manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad82c2be7df427b9d65c033a8a1a363d05d87eb8", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/ad82c2be7df427b9d65c033a8a1a363d05d87eb8", "committedDate": "2020-08-11T04:45:21Z", "message": "Use already exsisting cache manager"}, "afterCommit": {"oid": "34180e00dd45f6a1825be6336081ac8a6be6ab6b", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/34180e00dd45f6a1825be6336081ac8a6be6ab6b", "committedDate": "2020-08-11T04:47:07Z", "message": "Use already exsisting cache manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64cb527b474f97b2b853b67891e33e8bae1b5c8", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/d64cb527b474f97b2b853b67891e33e8bae1b5c8", "committedDate": "2020-08-11T05:07:08Z", "message": "Use already exsisting cache manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34180e00dd45f6a1825be6336081ac8a6be6ab6b", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/34180e00dd45f6a1825be6336081ac8a6be6ab6b", "committedDate": "2020-08-11T04:47:07Z", "message": "Use already exsisting cache manager"}, "afterCommit": {"oid": "d64cb527b474f97b2b853b67891e33e8bae1b5c8", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/d64cb527b474f97b2b853b67891e33e8bae1b5c8", "committedDate": "2020-08-11T05:07:08Z", "message": "Use already exsisting cache manager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0Nzc2MTkx", "url": "https://github.com/wso2/carbon-kernel/pull/2740#pullrequestreview-464776191", "createdAt": "2020-08-11T06:17:28Z", "commit": {"oid": "d64cb527b474f97b2b853b67891e33e8bae1b5c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NzUyMjk0", "url": "https://github.com/wso2/carbon-kernel/pull/2740#pullrequestreview-465752294", "createdAt": "2020-08-12T09:38:06Z", "commit": {"oid": "d64cb527b474f97b2b853b67891e33e8bae1b5c8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2055, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}