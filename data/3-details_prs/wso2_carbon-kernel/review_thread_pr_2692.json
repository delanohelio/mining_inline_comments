{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNjk4NTgz", "number": 2692, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMjowNzo0OVrOD_XQtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwNjo0Nzo1OVrOFRwphQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NzY3OTg5OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/authorization/DBConstants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMjowNzo0OVrOGZ_Cqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMjowNzo0OVrOGZ_Cqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMDQ1OA==", "bodyText": "Shall we format the newly added SQL lines to follow the maximum characters per line rule (<=120)? WDYT? Please format the other places as well.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r429900458", "createdAt": "2020-05-25T12:07:49Z", "author": {"login": "ShanChathusanda93"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/authorization/DBConstants.java", "diffHunk": "@@ -73,6 +75,7 @@\n     public static final String DELETE_USER_PERMISSION_SQL = \"DELETE FROM UM_USER_PERMISSION WHERE UM_USER_NAME=? \" +\n             \"AND UM_PERMISSION_ID = (SELECT UM_ID FROM UM_PERMISSION WHERE UM_RESOURCE_ID = ? AND \" +\n             \"UM_ACTION = ? AND UM_TENANT_ID=?) AND UM_TENANT_ID=?\";\n+    public static final String DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL = \"DELETE FROM UM_USER_PERMISSION WHERE UM_TENANT_ID = ?\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c5e0844453b1976ac5f452925f6c393553c8c33"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NzY4NTg2OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMjoxMDoxNVrOGZ_GTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMToyMjoyNVrOGaJ17w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMTM5MA==", "bodyText": "Shall we add only the UserStoreException rather than the relative path? WDYT?", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r429901390", "createdAt": "2020-05-25T12:10:15Z", "author": {"login": "ShanChathusanda93"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws org.wso2.carbon.user.api.UserStoreException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c5e0844453b1976ac5f452925f6c393553c8c33"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3NzQyMw==", "bodyText": "The full path is included here as there is another UserStoreException which is inherited by this. But I think we can use that Exception here.\n+1", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r430077423", "createdAt": "2020-05-25T21:22:25Z", "author": {"login": "sumedhe"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws org.wso2.carbon.user.api.UserStoreException", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMTM5MA=="}, "originalCommit": {"oid": "7c5e0844453b1976ac5f452925f6c393553c8c33"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NzY4ODA4OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMjoxMTowNFrOGZ_Hpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMToxMjo0M1rOGaJvUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMTczNA==", "bodyText": "Is it possible to catch a specific exception here rather than catching the Exception class?", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r429901734", "createdAt": "2020-05-25T12:11:04Z", "author": {"login": "ShanChathusanda93"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,74 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws Exception {\n+\n+        try {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_CLAIM_BEHAVIOR_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_PROFILE_CONFIG_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_CLAIM_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_DIALECT_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, TenantConstants.DELETE_TENANT_SQL, tenantId);\n+\n+            conn.commit();\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c5e0844453b1976ac5f452925f6c393553c8c33"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3NTczMA==", "bodyText": "Here the SQLException is handled inside executeDeleteQuery method and it returns new Exception with the error message. So I thought to catch that Exception here. And both are private methods.\nAny suggestions to handle them in a better way?", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r430075730", "createdAt": "2020-05-25T21:12:43Z", "author": {"login": "sumedhe"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,74 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws Exception {\n+\n+        try {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_CLAIM_BEHAVIOR_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_PROFILE_CONFIG_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_CLAIM_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_DIALECT_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, TenantConstants.DELETE_TENANT_SQL, tenantId);\n+\n+            conn.commit();\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMTczNA=="}, "originalCommit": {"oid": "7c5e0844453b1976ac5f452925f6c393553c8c33"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NzY5MDkwOnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMjoxMjoxOFrOGZ_JdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMToxOTowNVrOGaJzuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMjE5Nw==", "bodyText": "Shall we throw a specific exception from here? WDYT?", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r429902197", "createdAt": "2020-05-25T12:12:18Z", "author": {"login": "ShanChathusanda93"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,74 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws Exception {\n+\n+        try {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_CLAIM_BEHAVIOR_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_PROFILE_CONFIG_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_CLAIM_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_DIALECT_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, TenantConstants.DELETE_TENANT_SQL, tenantId);\n+\n+            conn.commit();\n+        } catch (Exception e) {\n+            conn.rollback();\n+            String errorMsg = \"An error occurred while deleting um data for tenant: \" + tenantId;\n+            throw new Exception(errorMsg, e);\n+        } finally {\n+            conn.close();\n+        }\n+    }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private static void executeDeleteQuery(Connection conn, String query, int tenantId)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c5e0844453b1976ac5f452925f6c393553c8c33"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3Njg1OQ==", "bodyText": "Yes. It's better. I threw a new Exception here as I already handled the SQLException inside this function. Or we can throw the same SQLException from here too.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r430076859", "createdAt": "2020-05-25T21:19:05Z", "author": {"login": "sumedhe"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,74 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws Exception {\n+\n+        try {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_CLAIM_BEHAVIOR_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_PROFILE_CONFIG_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_CLAIM_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_DIALECT_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, TenantConstants.DELETE_TENANT_SQL, tenantId);\n+\n+            conn.commit();\n+        } catch (Exception e) {\n+            conn.rollback();\n+            String errorMsg = \"An error occurred while deleting um data for tenant: \" + tenantId;\n+            throw new Exception(errorMsg, e);\n+        } finally {\n+            conn.close();\n+        }\n+    }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private static void executeDeleteQuery(Connection conn, String query, int tenantId)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMjE5Nw=="}, "originalCommit": {"oid": "7c5e0844453b1976ac5f452925f6c393553c8c33"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NDA4MjA0OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/claim/dao/ClaimDBConstants.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyNDowNlrOGlk2CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQyMDo1MjowNFrOGmuL4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NDE1Mg==", "bodyText": "These should not be used from Identity Server. Improved claim manager functionality is moved to the carbon-identity-framework repo. Check if you have some necessary changes there as well.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442054152", "createdAt": "2020-06-18T08:24:06Z", "author": {"login": "madurangasiriwardena"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/claim/dao/ClaimDBConstants.java", "diffHunk": "@@ -27,6 +27,7 @@\n     public static final String DELETE_CLAIM_SQL = \"DELETE FROM UM_CLAIM WHERE UM_CLAIM_URI=? AND \" +\n             \"UM_DIALECT_ID=(SELECT UM_ID FROM UM_DIALECT WHERE UM_DIALECT_URI=? \" +\n             \"AND UM_TENANT_ID=?) AND UM_TENANT_ID=?\";\n+    public static final String DELETE_CLAIM_BY_TENANT_ID_SQL = \"DELETE FROM UM_CLAIM WHERE UM_TENANT_ID=?\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc1NzA5OQ==", "bodyText": "Yes. Identity server uses claim metadata service for claim management. Anyway, check whether we are adding any records to these UM tables while adding a tenant. If not, we can skip this.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442757099", "createdAt": "2020-06-19T10:18:07Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/claim/dao/ClaimDBConstants.java", "diffHunk": "@@ -27,6 +27,7 @@\n     public static final String DELETE_CLAIM_SQL = \"DELETE FROM UM_CLAIM WHERE UM_CLAIM_URI=? AND \" +\n             \"UM_DIALECT_ID=(SELECT UM_ID FROM UM_DIALECT WHERE UM_DIALECT_URI=? \" +\n             \"AND UM_TENANT_ID=?) AND UM_TENANT_ID=?\";\n+    public static final String DELETE_CLAIM_BY_TENANT_ID_SQL = \"DELETE FROM UM_CLAIM WHERE UM_TENANT_ID=?\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NDE1Mg=="}, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI1NTc3Ng==", "bodyText": "No records with UM_CLAIMS, UM_DIALECT, UM_CLAIM_BEHAVIOR, UM_PROFILE_CONFIG tables which are related to claims in tenant addition. I'm removing them.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r443255776", "createdAt": "2020-06-21T20:52:04Z", "author": {"login": "sumedhe"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/claim/dao/ClaimDBConstants.java", "diffHunk": "@@ -27,6 +27,7 @@\n     public static final String DELETE_CLAIM_SQL = \"DELETE FROM UM_CLAIM WHERE UM_CLAIM_URI=? AND \" +\n             \"UM_DIALECT_ID=(SELECT UM_ID FROM UM_DIALECT WHERE UM_DIALECT_URI=? \" +\n             \"AND UM_TENANT_ID=?) AND UM_TENANT_ID=?\";\n+    public static final String DELETE_CLAIM_BY_TENANT_ID_SQL = \"DELETE FROM UM_CLAIM WHERE UM_TENANT_ID=?\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NDE1Mg=="}, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NDA4OTY4OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyNjowNlrOGlk7FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyNjowNlrOGlk7FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NTQ0NA==", "bodyText": "I don't see any advantage of extracting this method.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442055444", "createdAt": "2020-06-18T08:26:06Z", "author": {"login": "madurangasiriwardena"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenantUMData(int tenantId) throws UserStoreException {\n+\n+        try {\n+            Connection conn = getDBConnection();\n+            deleteTenantUMData(tenantId, conn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NDA5MTE0OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyNjozMVrOGlk7-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyNjozMVrOGlk7-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NTY3NA==", "bodyText": "use try with resource to close the connection.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442055674", "createdAt": "2020-06-18T08:26:31Z", "author": {"login": "madurangasiriwardena"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,73 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws SQLException {\n+\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NDA5ODE2OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyODowOVrOGllAPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyODowOVrOGllAPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1Njc2NQ==", "bodyText": "use try with resource to close the prepared statement.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442056765", "createdAt": "2020-06-18T08:28:09Z", "author": {"login": "madurangasiriwardena"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,73 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws SQLException {\n+\n+        try {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_CLAIM_BEHAVIOR_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_PROFILE_CONFIG_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_CLAIM_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_DIALECT_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, TenantConstants.DELETE_TENANT_SQL, tenantId);\n+\n+            conn.commit();\n+        } catch (SQLException e) {\n+            conn.rollback();\n+            String errorMsg = \"An error occurred while deleting um data for tenant: \" + tenantId;\n+            throw new SQLException(errorMsg, e);\n+        } finally {\n+            conn.close();\n+        }\n+    }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private static void executeDeleteQuery(Connection conn, String query, int tenantId)  throws SQLException {\n+\n+        PreparedStatement prepStmt = null;\n+        try {\n+            prepStmt = conn.prepareStatement(query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1ODQ2MzAxOnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMDoyMTozNVrOGmP2ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNDozNjowMlrOGr9Ibg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc1ODc1Ng==", "bodyText": "What is the default behavior of executing this? Are we deleting users and roles with the tenant deletion by default or do we have to enable the config?", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442758756", "createdAt": "2020-06-19T10:21:35Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenantUMData(int tenantId) throws UserStoreException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NjE2Mg==", "bodyText": "We have to enable this in config. It supposed to call from carbon-multitenancy.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r443156162", "createdAt": "2020-06-20T20:01:59Z", "author": {"login": "sumedhe"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenantUMData(int tenantId) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc1ODc1Ng=="}, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0MzUzNA==", "bodyText": "That configuration should honor only for Users and Roles.  Other information such as PERMISSIONS, Internal roles, Internal role mappings should be deleted irrespective of that config on tenant deletion.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r448743534", "createdAt": "2020-07-02T04:36:02Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenantUMData(int tenantId) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc1ODc1Ng=="}, "originalCommit": {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MDkwMTMyOnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxOTowMjozMFrOIN9TXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMToxMjozNVrOIPWNvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwNjc4MQ==", "bodyText": "Fix formatting issues.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r551506781", "createdAt": "2021-01-04T19:02:30Z", "author": {"login": "ashensw"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1249,24 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private void executeDeleteQuery(Connection conn, String query, int tenantId)  throws SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69f3c9724053f6a161d626b22f5853498f2fd9c2"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk2MzUxNg==", "bodyText": "Fixed in #2894", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r552963516", "createdAt": "2021-01-06T21:12:35Z", "author": {"login": "sumedhe"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1249,24 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private void executeDeleteQuery(Connection conn, String query, int tenantId)  throws SQLException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwNjc4MQ=="}, "originalCommit": {"oid": "69f3c9724053f6a161d626b22f5853498f2fd9c2"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MDkwOTM0OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxOTowNTowNFrOIN9YMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMToxMjoyOFrOIPWNjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwODAxNg==", "bodyText": "Add the specific Exception type. Also, the param descriptions should start with a capital and end with a full stop. Fix all the other comments accrodingly.", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r551508016", "createdAt": "2021-01-04T19:05:04Z", "author": {"login": "ashensw"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1249,24 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69f3c9724053f6a161d626b22f5853498f2fd9c2"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk2MzQ2OQ==", "bodyText": "Fixed in #2894", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r552963469", "createdAt": "2021-01-06T21:12:28Z", "author": {"login": "sumedhe"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1249,24 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwODAxNg=="}, "originalCommit": {"oid": "69f3c9724053f6a161d626b22f5853498f2fd9c2"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0MTY3MDA2OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwNjo0NzoyNFrOIYXabg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwNjo0NzoyNFrOIYXabg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjQyMDMzNA==", "bodyText": "Current practice is either handle exception and log it with appropriate information. OR throw it.  Log and throw is discouraged as it fills up the logs unnecessarily", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r562420334", "createdAt": "2021-01-22T06:47:24Z", "author": {"login": "ruwanta"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +909,50 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws UserStoreException\n+     */\n+    @Override\n+    public void deleteTenantUMData(int tenantId) throws UserStoreException {\n+\n+        ServerConfigurationService serverConfigurationService = UserStoreMgtDSComponent.getServerConfigurationService();\n+\n+        try (Connection conn = getDBConnection()) {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            if (Boolean.parseBoolean(serverConfigurationService\n+                    .getFirstProperty(\"Tenant.DeletePrimaryUsersOnTenantDeletion\"))) {\n+                executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+                executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Tenant.DeletePrimaryUsersOnTenantDeletion flag is not enabled in carbon.xml. \" +\n+                            \"Users and Roles will not be deleted.\");\n+                }\n+            }\n+\n+            conn.commit();\n+        } catch (SQLException e) {\n+            String errorMsg = \"An error occurred while deleting um data for tenant: \" + tenantId;\n+            log.error(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69f3c9724053f6a161d626b22f5853498f2fd9c2"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0MTY3MTczOnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwNjo0Nzo1OVrOIYXbTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwNjo0Nzo1OVrOIYXbTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjQyMDU1OA==", "bodyText": "Log and throw the same exception is no longer considered best practice", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r562420558", "createdAt": "2021-01-22T06:47:59Z", "author": {"login": "ruwanta"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1249,24 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private void executeDeleteQuery(Connection conn, String query, int tenantId)  throws SQLException {\n+\n+        try (PreparedStatement prepStmt = conn.prepareStatement(query)) {\n+            prepStmt.setInt(1, tenantId);\n+            prepStmt.executeUpdate();\n+        } catch (SQLException e) {\n+            String errMsg = \"Error executing query \" + query + \" for tenant: \" + tenantId;\n+            log.error(errMsg, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69f3c9724053f6a161d626b22f5853498f2fd9c2"}, "originalPosition": 102}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2119, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}