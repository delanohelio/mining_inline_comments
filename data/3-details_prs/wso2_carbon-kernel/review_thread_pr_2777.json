{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMTc0OTgw", "number": 2777, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzowMzoyMFrOErCiUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTowNjo0MFrOErIHXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTY1Nzc4OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzowMzoyMFrOHdlRdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzozNDoyNVrOHdmQTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTQyOA==", "bodyText": "Why is this changed?", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500781428", "createdAt": "2020-10-07T07:03:20Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -961,11 +1012,11 @@ private void clearTenantCache(int tenantId) throws UserStoreException {\n         tenantCacheManager.clearCacheEntry(new TenantIdKey(tenantId));\n     }\n \n-    private void clearTenantCaches(String tenantUniqueID) throws UserStoreException {\n+    private void clearTenantCaches(Tenant tenant) throws UserStoreException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a88504cb11f661fb9485b42838b717c3644a9c0"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTU2NQ==", "bodyText": "Still uses only the tenantUniqueID? Why do we want to send the whole tenant object to clear the cache", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500781565", "createdAt": "2020-10-07T07:03:40Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -961,11 +1012,11 @@ private void clearTenantCache(int tenantId) throws UserStoreException {\n         tenantCacheManager.clearCacheEntry(new TenantIdKey(tenantId));\n     }\n \n-    private void clearTenantCaches(String tenantUniqueID) throws UserStoreException {\n+    private void clearTenantCaches(Tenant tenant) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTQyOA=="}, "originalCommit": {"oid": "4a88504cb11f661fb9485b42838b717c3644a9c0"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MzQ5MA==", "bodyText": "In deleteTenant we need tenant domain to call invalidateCacheManager. Therefore getting the tenant before clearTenantCaches will stop calling this.getTenant(tenantUniqueID) two times. Thatswhy remove this.getTenant(tenantUniqueID) from this method (clearTenantCaches) and called it inside deleteTenant(String tenantUniqueID, boolean removeFromPersistentStorage).", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500783490", "createdAt": "2020-10-07T07:07:52Z", "author": {"login": "nilasini"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -961,11 +1012,11 @@ private void clearTenantCache(int tenantId) throws UserStoreException {\n         tenantCacheManager.clearCacheEntry(new TenantIdKey(tenantId));\n     }\n \n-    private void clearTenantCaches(String tenantUniqueID) throws UserStoreException {\n+    private void clearTenantCaches(Tenant tenant) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTQyOA=="}, "originalCommit": {"oid": "4a88504cb11f661fb9485b42838b717c3644a9c0"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4NDczMA==", "bodyText": "Previously we have got the whole tenant object using this.getTenant(tenantUniqueID) inside the clearTenantCaches method since we need to get tenantId, tenant domain.", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500784730", "createdAt": "2020-10-07T07:10:22Z", "author": {"login": "nilasini"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -961,11 +1012,11 @@ private void clearTenantCache(int tenantId) throws UserStoreException {\n         tenantCacheManager.clearCacheEntry(new TenantIdKey(tenantId));\n     }\n \n-    private void clearTenantCaches(String tenantUniqueID) throws UserStoreException {\n+    private void clearTenantCaches(Tenant tenant) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTQyOA=="}, "originalCommit": {"oid": "4a88504cb11f661fb9485b42838b717c3644a9c0"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4Nzc1OA==", "bodyText": "Then you can have both clearTenantCaches(String tenantUniqueID) and clearTenantCaches(Tenant tenant).", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500787758", "createdAt": "2020-10-07T07:16:21Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -961,11 +1012,11 @@ private void clearTenantCache(int tenantId) throws UserStoreException {\n         tenantCacheManager.clearCacheEntry(new TenantIdKey(tenantId));\n     }\n \n-    private void clearTenantCaches(String tenantUniqueID) throws UserStoreException {\n+    private void clearTenantCaches(Tenant tenant) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTQyOA=="}, "originalCommit": {"oid": "4a88504cb11f661fb9485b42838b717c3644a9c0"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc5MzI3MA==", "bodyText": "Yes, we can have both. Isn't having two methods with similar functionalities will make duplicate logic? Is there any specific reason to have separate methods as clearTenantCaches(String tenantUniqueID) and clearTenantCaches(Tenant tenant) rather than having one method clearTenantCaches(Tenant tenant) and handled it as I have done currently.", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500793270", "createdAt": "2020-10-07T07:26:55Z", "author": {"login": "nilasini"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -961,11 +1012,11 @@ private void clearTenantCache(int tenantId) throws UserStoreException {\n         tenantCacheManager.clearCacheEntry(new TenantIdKey(tenantId));\n     }\n \n-    private void clearTenantCaches(String tenantUniqueID) throws UserStoreException {\n+    private void clearTenantCaches(Tenant tenant) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTQyOA=="}, "originalCommit": {"oid": "4a88504cb11f661fb9485b42838b717c3644a9c0"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc5NzUxNw==", "bodyText": "The tenantUniqueID is the key. We should be able to clear the caches using the key. Otherwise, in each place, we have to getTenant and call the clear method. We should think of code about readability as well.\nEx.\npublic void activateTenant(String tenantUniqueID) throws UserStoreException {\n        Tenant tenant = this.getTenant(tenantUniqueID);\n        clearTenantCaches(tenant);\n\npublic void activateTenant(String tenantUniqueID) throws UserStoreException {\n        clearTenantCaches(tenantUniqueID);", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500797517", "createdAt": "2020-10-07T07:34:25Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -961,11 +1012,11 @@ private void clearTenantCache(int tenantId) throws UserStoreException {\n         tenantCacheManager.clearCacheEntry(new TenantIdKey(tenantId));\n     }\n \n-    private void clearTenantCaches(String tenantUniqueID) throws UserStoreException {\n+    private void clearTenantCaches(Tenant tenant) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTQyOA=="}, "originalCommit": {"oid": "4a88504cb11f661fb9485b42838b717c3644a9c0"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTgyNzg5OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1MTo0N1rOHdm4Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODozMzowOVrOHdoc1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwNzcwMg==", "bodyText": "Java doc missing", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500807702", "createdAt": "2020-10-07T07:51:47Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -871,6 +871,55 @@ public void deleteTenant(int tenantId) throws UserStoreException {\n         }\n     }\n \n+    public void deleteTenant(String tenantUniqueID) throws UserStoreException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ee6aaeca10f2d486757c3c8249af7329d5b89f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzMzQ5NQ==", "bodyText": "Interface having the Java doc comment thatswhy didn't add it.", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500833495", "createdAt": "2020-10-07T08:33:09Z", "author": {"login": "nilasini"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -871,6 +871,55 @@ public void deleteTenant(int tenantId) throws UserStoreException {\n         }\n     }\n \n+    public void deleteTenant(String tenantUniqueID) throws UserStoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwNzcwMg=="}, "originalCommit": {"oid": "c2ee6aaeca10f2d486757c3c8249af7329d5b89f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTgzNTIzOnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1MzozOVrOHdm8sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODozNTowNFrOHdohcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwODg4Mw==", "bodyText": "What is the purpose of supporting non-persistent tenant deletion?\nWill that tenant available after a restart?", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500808883", "createdAt": "2020-10-07T07:53:39Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -871,6 +871,55 @@ public void deleteTenant(int tenantId) throws UserStoreException {\n         }\n     }\n \n+    public void deleteTenant(String tenantUniqueID) throws UserStoreException {\n+\n+        try {\n+            deleteTenant(tenantUniqueID, true);\n+        } catch (UserStoreException e) {\n+            throw new UserStoreException(e);\n+        }\n+    }\n+\n+    /**\n+     * Delete Tenant\n+     *\n+     * @param tenantUniqueID              - Tenant Id\n+     * @param removeFromPersistentStorage - Flag to decide weather delete from persistent storage\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenant(String tenantUniqueID, boolean removeFromPersistentStorage)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ee6aaeca10f2d486757c3c8249af7329d5b89f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDY3NQ==", "bodyText": "Yes only the cache will be deleted.", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500834675", "createdAt": "2020-10-07T08:35:04Z", "author": {"login": "nilasini"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -871,6 +871,55 @@ public void deleteTenant(int tenantId) throws UserStoreException {\n         }\n     }\n \n+    public void deleteTenant(String tenantUniqueID) throws UserStoreException {\n+\n+        try {\n+            deleteTenant(tenantUniqueID, true);\n+        } catch (UserStoreException e) {\n+            throw new UserStoreException(e);\n+        }\n+    }\n+\n+    /**\n+     * Delete Tenant\n+     *\n+     * @param tenantUniqueID              - Tenant Id\n+     * @param removeFromPersistentStorage - Flag to decide weather delete from persistent storage\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenant(String tenantUniqueID, boolean removeFromPersistentStorage)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwODg4Mw=="}, "originalCommit": {"oid": "c2ee6aaeca10f2d486757c3c8249af7329d5b89f"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTgzNzA0OnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NDowOFrOHdm91A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NDowOFrOHdm91A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwOTE3Mg==", "bodyText": "use try with resources", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500809172", "createdAt": "2020-10-07T07:54:08Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -871,6 +871,55 @@ public void deleteTenant(int tenantId) throws UserStoreException {\n         }\n     }\n \n+    public void deleteTenant(String tenantUniqueID) throws UserStoreException {\n+\n+        try {\n+            deleteTenant(tenantUniqueID, true);\n+        } catch (UserStoreException e) {\n+            throw new UserStoreException(e);\n+        }\n+    }\n+\n+    /**\n+     * Delete Tenant\n+     *\n+     * @param tenantUniqueID              - Tenant Id\n+     * @param removeFromPersistentStorage - Flag to decide weather delete from persistent storage\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenant(String tenantUniqueID, boolean removeFromPersistentStorage)\n+            throws UserStoreException {\n+\n+        Tenant tenant = this.getTenant(tenantUniqueID);\n+        // Remove tenant information from the cache.\n+        clearTenantCaches(tenant);\n+        if (tenant != null) {\n+            invalidateCacheManager(tenant.getDomain());\n+        }\n+        if (removeFromPersistentStorage) {\n+            Connection dbConnection = null;\n+            PreparedStatement prepStmt = null;\n+            try {\n+                dbConnection = getDBConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ee6aaeca10f2d486757c3c8249af7329d5b89f"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNjU3MTgwOnYy", "diffSide": "RIGHT", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTowNjo0MFrOHduFEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTowNjo1M1rOHduFkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyNTcxMg==", "bodyText": "Check this for clearTenantCaches as well", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500925712", "createdAt": "2020-10-07T11:06:40Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -871,6 +871,35 @@ public void deleteTenant(int tenantId) throws UserStoreException {\n         }\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    public void deleteTenant(String tenantUniqueID) throws UserStoreException {\n+\n+        Tenant tenant = this.getTenant(tenantUniqueID);\n+        // Remove tenant information from the cache.\n+        clearTenantCaches(tenant);\n+        if (tenant != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "715e329db094f1fde8e1ce34e1a039ccb0384000"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyNTg0MQ==", "bodyText": "if (tenant != null) {", "url": "https://github.com/wso2/carbon-kernel/pull/2777#discussion_r500925841", "createdAt": "2020-10-07T11:06:53Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -871,6 +871,35 @@ public void deleteTenant(int tenantId) throws UserStoreException {\n         }\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    public void deleteTenant(String tenantUniqueID) throws UserStoreException {\n+\n+        Tenant tenant = this.getTenant(tenantUniqueID);\n+        // Remove tenant information from the cache.\n+        clearTenantCaches(tenant);\n+        if (tenant != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyNTcxMg=="}, "originalCommit": {"oid": "715e329db094f1fde8e1ce34e1a039ccb0384000"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2159, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}