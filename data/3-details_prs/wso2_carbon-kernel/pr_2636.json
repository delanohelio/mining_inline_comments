{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MjIyOTk4", "number": 2636, "title": "Add symmetric encryption support for Crypto Util", "bodyText": "Purpose\nResolves wso2/product-is#7903\nGoals\n\nDescribe the solutions that this feature/fix will introduce to resolve the problems described above\n\nApproach\n\nDescribe how you are implementing the solutions. Include an animated GIF or screenshot if the change affects the UI (email documentation@wso2.com to review all UI text). Include a link to a Markdown file or Google doc if the feature write-up is too long to paste here.\n\nUser stories\n\nSummary of user stories addressed by this change>\n\nRelease note\n\nBrief description of the new feature or bug fix as it will appear in the release notes\n\nDocumentation\n\nLink(s) to product documentation that addresses the changes of this PR. If no doc impact, enter \u201cN/A\u201d plus brief explanation of why there\u2019s no doc impact\n\nTraining\n\nLink to the PR for changes to the training content in https://github.com/wso2/WSO2-Training, if applicable\n\nCertification\n\nType \u201cSent\u201d when you have provided new/updated certification questions, plus four answers for each question (correct answer highlighted in bold), based on this change. Certification questions/answers should be sent to certification@wso2.com and NOT pasted in this PR. If there is no impact on certification exams, type \u201cN/A\u201d and explain why.\n\nMarketing\n\nLink to drafts of marketing content that will describe and promote this feature, including product page changes, technical articles, blog posts, videos, etc., if applicable\n\nAutomation tests\n\nUnit tests\n\nCode coverage information\n\n\nIntegration tests\n\nDetails about the test cases and coverage\n\n\n\nSecurity checks\n\nFollowed secure coding standards in http://wso2.com/technical-reports/wso2-secure-engineering-guidelines? yes/no\nRan FindSecurityBugs plugin and verified report? yes/no\nConfirmed that this PR doesn't commit any keys, passwords, tokens, usernames, or other secrets? yes/no\n\nSamples\n\nProvide high-level details about the samples related to this feature\n\nRelated PRs\n\nList any other related PRs\n\nMigrations (if applicable)\n\nDescribe migration steps and platforms on which migration has been tested\n\nTest environment\n\nList all JDK versions, operating systems, databases, and browser/versions on which this feature/fix was tested\n\nLearning\n\nDescribe the research phase and any blog posts, patterns, libraries, or add-ons you used to solve the problem.", "createdAt": "2020-03-16T13:06:55Z", "url": "https://github.com/wso2/carbon-kernel/pull/2636", "merged": true, "mergeCommit": {"oid": "7b366c159b73f820e60f850e86aac792976027b9"}, "closed": true, "closedAt": "2020-03-20T09:01:17Z", "author": {"login": "denuwanthi"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcONoKDgH2gAyMzg5MjIyOTk4OjNjYzEyYWQ1OTVmZjc2MzI5NmUxNjg4YWIwOTNlNGIwYTQ0YzZiYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPPdx7gFqTM3Nzk0NzA3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3cc12ad595ff763296e1688ab093e4b0a44c6ba7", "author": {"user": {"login": "denuwanthi", "name": "denuwanthi"}}, "url": "https://github.com/wso2/carbon-kernel/commit/3cc12ad595ff763296e1688ab093e4b0a44c6ba7", "committedDate": "2020-03-16T12:53:39Z", "message": "Add symmetric encryption support for Crypto Util"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd122ccf51d93fecd008f25eeede82f3d414334", "author": {"user": {"login": "denuwanthi", "name": "denuwanthi"}}, "url": "https://github.com/wso2/carbon-kernel/commit/4cd122ccf51d93fecd008f25eeede82f3d414334", "committedDate": "2020-03-16T13:09:01Z", "message": "Remove additional new lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4845ed143657a426d6daa9190b963f657f72e73", "author": {"user": {"login": "denuwanthi", "name": "denuwanthi"}}, "url": "https://github.com/wso2/carbon-kernel/commit/e4845ed143657a426d6daa9190b963f657f72e73", "committedDate": "2020-03-16T13:16:58Z", "message": "Remove unnecessary lines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NDUzNjMz", "url": "https://github.com/wso2/carbon-kernel/pull/2636#pullrequestreview-375453633", "createdAt": "2020-03-16T17:54:36Z", "commit": {"oid": "e4845ed143657a426d6daa9190b963f657f72e73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNzo1NDozNlrOF2_kgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNzo1NDozNlrOF2_kgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwODk2MQ==", "bodyText": "Avoid unnecessary concatenation", "url": "https://github.com/wso2/carbon-kernel/pull/2636#discussion_r393208961", "createdAt": "2020-03-16T17:54:36Z", "author": {"login": "malithie"}, "path": "core/org.wso2.carbon.core/src/main/java/org/wso2/carbon/core/util/CryptoUtil.java", "diffHunk": "@@ -52,6 +52,10 @@\n     private static final String DEFAULT_CRYPTO_ALGORITHM = \"RSA\";\n \n     private static final String CRYPTO_API_PROVIDER_BC = \"BC\";\n+    private static final String INTERNAL_CRYPTO_PROVIDER = \"CryptoService.InternalCryptoProviderClassName\";\n+    private static final String SYMMETRIC_INTERNAL_CRYPTO_PROVIDER_CLASS_NAME =\n+            \"org.wso2.carbon.crypto.provider\" + \".SymmetricKeyInternalCryptoProvider\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4845ed143657a426d6daa9190b963f657f72e73"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NDYxNDky", "url": "https://github.com/wso2/carbon-kernel/pull/2636#pullrequestreview-375461492", "createdAt": "2020-03-16T18:00:28Z", "commit": {"oid": "e4845ed143657a426d6daa9190b963f657f72e73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxODowMDoyOFrOF2_yDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxODowMDoyOFrOF2_yDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIxMjQyOQ==", "bodyText": "Same code got refactored ?", "url": "https://github.com/wso2/carbon-kernel/pull/2636#discussion_r393212429", "createdAt": "2020-03-16T18:00:28Z", "author": {"login": "malithie"}, "path": "core/org.wso2.carbon.core/src/main/java/org/wso2/carbon/core/util/CryptoUtil.java", "diffHunk": "@@ -149,14 +153,16 @@ public RegistryService getRegistryService() {\n                     log.debug(\"Plaintext is empty. An empty array will be used as the ciphertext bytes.\");\n                 }\n                 encryptedKey = StringUtils.EMPTY.getBytes();\n-            }else{\n+            } else {\n                 encryptedKey = cryptoService.encrypt(plainTextBytes, algorithm, CRYPTO_API_PROVIDER_BC);\n             }\n \n-            if (StringUtils.isNotBlank(cipherTransformation) && returnSelfContainedCipherText) {\n+            if (StringUtils.isNotBlank(cipherTransformation) && returnSelfContainedCipherText\n+                    && !isSymmetricKeyEncryptionEnabled) {\n \n-                Certificate certificate = cryptoService.getCertificate(CryptoContext.buildEmptyContext(\n-                        MultitenantConstants.SUPER_TENANT_ID, MultitenantConstants.SUPER_TENANT_DOMAIN_NAME));\n+                Certificate certificate = cryptoService.getCertificate(CryptoContext\n+                        .buildEmptyContext(MultitenantConstants.SUPER_TENANT_ID,\n+                                MultitenantConstants.SUPER_TENANT_DOMAIN_NAME));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4845ed143657a426d6daa9190b963f657f72e73"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NDY1OTYz", "url": "https://github.com/wso2/carbon-kernel/pull/2636#pullrequestreview-375465963", "createdAt": "2020-03-16T18:06:28Z", "commit": {"oid": "e4845ed143657a426d6daa9190b963f657f72e73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxODowNjoyOFrOF3AELA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxODowNjoyOFrOF3AELA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIxNzA2OA==", "bodyText": "What if this method is utilized in 'getDefaultEncryptionAlgorithm' rather than passing an additional boolean", "url": "https://github.com/wso2/carbon-kernel/pull/2636#discussion_r393217068", "createdAt": "2020-03-16T18:06:28Z", "author": {"login": "malithie"}, "path": "core/org.wso2.carbon.core/src/main/java/org/wso2/carbon/core/util/CryptoUtil.java", "diffHunk": "@@ -441,5 +445,21 @@ private String calculateThumbprint(Certificate certificate, String digest)\n \n         return strBuffer.toString();\n     }\n+\n+    private String getDefaultEncryptionAlgorithm(boolean isSymmetricKeyEncryptionEnabled) {\n+\n+        if (isSymmetricKeyEncryptionEnabled) {\n+            return DEFAULT_SYMMETRIC_CRYPTO_ALGORITHM;\n+        } else {\n+            // Set the default crypto algorithm.\n+            return DEFAULT_CRYPTO_ALGORITHM;\n+        }\n+    }\n+\n+    private boolean isSymmetricKeyEncryptionEnabled() {\n+\n+        return SYMMETRIC_INTERNAL_CRYPTO_PROVIDER_CLASS_NAME\n+                .equals(serverConfigService.getFirstProperty(INTERNAL_CRYPTO_PROVIDER));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4845ed143657a426d6daa9190b963f657f72e73"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "004c781ec5153daf95a6906b0c8ada5191a8c889", "author": {"user": {"login": "denuwanthi", "name": "denuwanthi"}}, "url": "https://github.com/wso2/carbon-kernel/commit/004c781ec5153daf95a6906b0c8ada5191a8c889", "committedDate": "2020-03-17T04:22:30Z", "message": "Fix PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2344fd6aafaab24887fb7b351027c4630c29eb1", "author": {"user": {"login": "denuwanthi", "name": "denuwanthi"}}, "url": "https://github.com/wso2/carbon-kernel/commit/f2344fd6aafaab24887fb7b351027c4630c29eb1", "committedDate": "2020-03-17T14:03:42Z", "message": "Refactor to use CryptoService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjgyMjkw", "url": "https://github.com/wso2/carbon-kernel/pull/2636#pullrequestreview-376282290", "createdAt": "2020-03-17T18:05:46Z", "commit": {"oid": "f2344fd6aafaab24887fb7b351027c4630c29eb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxODowNTo0NlrOF3oESg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxODowNTo0NlrOF3oESg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg3MjQ1OA==", "bodyText": "Did we verify this will not have an impact on previously encrypted data for asymmetric flow", "url": "https://github.com/wso2/carbon-kernel/pull/2636#discussion_r393872458", "createdAt": "2020-03-17T18:05:46Z", "author": {"login": "malithie"}, "path": "core/org.wso2.carbon.core/src/main/java/org/wso2/carbon/core/util/CryptoUtil.java", "diffHunk": "@@ -231,20 +222,20 @@ public String encryptAndBase64Encode(byte[] plainText) throws\n                 throw new CryptoException(\"A crypto service implementation has not been registered.\");\n             }\n \n-            // Set the default crypto algorithm to be used when a cipher transformation is not found.\n-            String algorithm = DEFAULT_CRYPTO_ALGORITHM;\n+            String algorithm = null;\n \n             String cipherTransformation = System.getProperty(CIPHER_TRANSFORMATION_SYSTEM_PROPERTY);\n \n             if (cipherTransformation != null) {\n-                CipherHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n-                if (cipherHolder != null) {\n+                CipherMetaDataHolder\n+                        cipherMetaDataHolder = cipherTextToCipherMetaDataHolder(cipherTextBytes);\n+                if (cipherMetaDataHolder != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2344fd6aafaab24887fb7b351027c4630c29eb1"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2202aa4c92fe3c9407232b4e85ce608a78bc18b1", "author": {"user": {"login": "denuwanthi", "name": "denuwanthi"}}, "url": "https://github.com/wso2/carbon-kernel/commit/2202aa4c92fe3c9407232b4e85ce608a78bc18b1", "committedDate": "2020-03-18T13:24:29Z", "message": "Fix code review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3Mzg5NDY0", "url": "https://github.com/wso2/carbon-kernel/pull/2636#pullrequestreview-377389464", "createdAt": "2020-03-19T02:50:40Z", "commit": {"oid": "2202aa4c92fe3c9407232b4e85ce608a78bc18b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMjo1MDo0MFrOF4eYKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMjo1MDo0MFrOF4eYKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc2MjI4MQ==", "bodyText": "Let's deprecate CipherHolder class as well", "url": "https://github.com/wso2/carbon-kernel/pull/2636#discussion_r394762281", "createdAt": "2020-03-19T02:50:40Z", "author": {"login": "malithie"}, "path": "core/org.wso2.carbon.core/src/main/java/org/wso2/carbon/core/util/CryptoUtil.java", "diffHunk": "@@ -406,10 +398,12 @@ public boolean base64DecodeAndIsSelfContainedCipherText(String base64CipherText)\n \n     /**\n      * Function to convert cipher byte array to {@link CipherHolder}\n+     * @deprecated  use {@link #cipherTextToCipherMetaDataHolder(byte[])} instead.\n      *\n      * @param cipherText cipher text as a byte array\n      * @return if cipher text is not a cipher with meta data\n      */\n+    @Deprecated\n     public CipherHolder cipherTextToCipherHolder(byte[] cipherText) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2202aa4c92fe3c9407232b4e85ce608a78bc18b1"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99475c9adeb0b1dfb5ee8b8952b0abaedf970cfd", "author": {"user": {"login": "denuwanthi", "name": "denuwanthi"}}, "url": "https://github.com/wso2/carbon-kernel/commit/99475c9adeb0b1dfb5ee8b8952b0abaedf970cfd", "committedDate": "2020-03-19T05:15:46Z", "message": "Deperecate the CipherHolder class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bc0e213f19071ff78206e57b97b153f5acda16c", "author": {"user": {"login": "denuwanthi", "name": "denuwanthi"}}, "url": "https://github.com/wso2/carbon-kernel/commit/2bc0e213f19071ff78206e57b97b153f5acda16c", "committedDate": "2020-03-19T05:21:41Z", "message": "Refactor code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTQ2Mjkx", "url": "https://github.com/wso2/carbon-kernel/pull/2636#pullrequestreview-377946291", "createdAt": "2020-03-19T17:35:07Z", "commit": {"oid": "2bc0e213f19071ff78206e57b97b153f5acda16c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzozNTowN1rOF45RHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzozNTowN1rOF45RHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwMjg0Ng==", "bodyText": "I guess this will not apply as we will now have it in crypto service layer.\nStill keep a note and verify", "url": "https://github.com/wso2/carbon-kernel/pull/2636#discussion_r395202846", "createdAt": "2020-03-19T17:35:07Z", "author": {"login": "malithie"}, "path": "core/org.wso2.carbon.core/src/main/java/org/wso2/carbon/core/util/CipherHolder.java", "diffHunk": "@@ -24,9 +24,14 @@\n /**\n  * Holds ciphertext with related metadata.\n  *\n+ * @deprecated This is deprecated since version 4.6.1.\n+ * This is replaced with org.wso2.carbon.crypto.api.CipherMetaDataHolder.\n+ * This is deprecated due to moving self contained cipher text creation logic to crypto-service project.\n+ *\n  * IMPORTANT: this is replicated at org.wso2.carbon.user.core.config.UserStoreConfigXMLProcessor.CipherHolder,\n- *              what ever changes applied here need to update on above. This is done to avoid cyclic dependency.\n+ * what ever changes applied here need to update on above. This is done to avoid cyclic dependency.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bc0e213f19071ff78206e57b97b153f5acda16c"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTQ3MDc1", "url": "https://github.com/wso2/carbon-kernel/pull/2636#pullrequestreview-377947075", "createdAt": "2020-03-19T17:36:03Z", "commit": {"oid": "2bc0e213f19071ff78206e57b97b153f5acda16c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2091, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}