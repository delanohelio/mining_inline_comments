{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NzQxNzg3", "number": 2548, "title": "Cache resolving user ID from user name and user name from user ID", "bodyText": "Purpose\nCache the userName and userID following flows\nResolve username from userid\nResolve userId from userName\nRemove the cache entry when user get deleted.", "createdAt": "2020-01-24T09:14:26Z", "url": "https://github.com/wso2/carbon-kernel/pull/2548", "merged": true, "mergeCommit": {"oid": "ecaa83fe66583f417c4e0adc3592bf056f7f7083"}, "closed": true, "closedAt": "2020-01-28T06:42:04Z", "author": {"login": "Buddhimah"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9bXvwgFqTM0NzgyNTk3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-rij1AFqTM0OTE1NTg1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODI1OTc5", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-347825979", "createdAt": "2020-01-24T09:17:40Z", "commit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToxNzo0MFrOFhXp2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToxNzo0MFrOFhXp2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNDg3Mw==", "bodyText": "why this is in else statement? We should add to cache just after getting from DB.", "url": "https://github.com/wso2/carbon-kernel/pull/2548#discussion_r370534873", "createdAt": "2020-01-24T09:17:40Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -11702,21 +11708,36 @@ protected boolean isUserIdGeneratedByUserStore(String userName, Map<String, Stri\n      */\n     public String getUserIDFromUserName(String userName) throws UserStoreException {\n \n+        String userID;\n         UserStore userStore = getUserStore(userName);\n         if (userStore.isRecurssive()) {\n             return ((AbstractUserStoreManager) userStore.getUserStoreManager())\n                     .getUserIDFromUserName(userStore.getDomainFreeName());\n         }\n \n         if (isUniqueUserIdEnabledInUserStore(userStore)) {\n-            return doGetUserIDFromUserNameWithID(userStore.getDomainFreeName());\n+            userID = AbstractUserStoreManagerCache.getInstance().getValueFromCache(userName,\n+                    RESOLVE_USER_ID_FROM_USER_NAME_CACHE_NAME);\n+            if (StringUtils.isEmpty(userID)){\n+                return doGetUserIDFromUserNameWithID(userStore.getDomainFreeName());\n+            } else {\n+                AbstractUserStoreManagerCache.getInstance().addToCache(userName, userID,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODI2MzI0", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-347826324", "createdAt": "2020-01-24T09:18:21Z", "commit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToxODoyMlrOFhXq6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToxODoyMlrOFhXq6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNTE0NA==", "bodyText": "Why in else statement?", "url": "https://github.com/wso2/carbon-kernel/pull/2548#discussion_r370535144", "createdAt": "2020-01-24T09:18:22Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -11702,21 +11708,36 @@ protected boolean isUserIdGeneratedByUserStore(String userName, Map<String, Stri\n      */\n     public String getUserIDFromUserName(String userName) throws UserStoreException {\n \n+        String userID;\n         UserStore userStore = getUserStore(userName);\n         if (userStore.isRecurssive()) {\n             return ((AbstractUserStoreManager) userStore.getUserStoreManager())\n                     .getUserIDFromUserName(userStore.getDomainFreeName());\n         }\n \n         if (isUniqueUserIdEnabledInUserStore(userStore)) {\n-            return doGetUserIDFromUserNameWithID(userStore.getDomainFreeName());\n+            userID = AbstractUserStoreManagerCache.getInstance().getValueFromCache(userName,\n+                    RESOLVE_USER_ID_FROM_USER_NAME_CACHE_NAME);\n+            if (StringUtils.isEmpty(userID)){\n+                return doGetUserIDFromUserNameWithID(userStore.getDomainFreeName());\n+            } else {\n+                AbstractUserStoreManagerCache.getInstance().addToCache(userName, userID,\n+                        RESOLVE_USER_ID_FROM_USER_NAME_CACHE_NAME);\n+            }\n         }\n \n         Map<String, String> claims = doGetUserClaimValues(userName,\n                 new String[]{UserCoreClaimConstants.USER_ID_CLAIM_URI},\n                 userStore.getDomainName(), null);\n         if (claims != null && claims.size() == 1) {\n-            return claims.get(UserCoreClaimConstants.USER_ID_CLAIM_URI);\n+            userID = AbstractUserStoreManagerCache.getInstance().getValueFromCache(userName,\n+                    RESOLVE_USER_NAME_FROM_USER_ID_CACHE_NAME);\n+            if (StringUtils.isEmpty(userID)) {\n+                return claims.get(UserCoreClaimConstants.USER_ID_CLAIM_URI);\n+            } else {\n+                AbstractUserStoreManagerCache.getInstance().addToCache(userName, userID,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODI4NDU3", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-347828457", "createdAt": "2020-01-24T09:22:25Z", "commit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToyMjoyNVrOFhXxkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToyMjoyNVrOFhXxkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNjg1MA==", "bodyText": "why AbstractUserStoreManagerCache?", "url": "https://github.com/wso2/carbon-kernel/pull/2548#discussion_r370536850", "createdAt": "2020-01-24T09:22:25Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManagerCache.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.wso2.carbon.user.core.common;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.utils.multitenancy.MultitenantConstants;\n+\n+import javax.cache.Cache;\n+import javax.cache.CacheManager;\n+import javax.cache.Caching;\n+\n+/**\n+ * Handle Cache in Abstract User Store Manager.\n+ */\n+public class AbstractUserStoreManagerCache {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODI4NjEy", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-347828612", "createdAt": "2020-01-24T09:22:41Z", "commit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToyMjo0MlrOFhXyAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToyMjo0MlrOFhXyAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNjk2Mw==", "bodyText": "UserIdResolverCache", "url": "https://github.com/wso2/carbon-kernel/pull/2548#discussion_r370536963", "createdAt": "2020-01-24T09:22:42Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManagerCache.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.wso2.carbon.user.core.common;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.utils.multitenancy.MultitenantConstants;\n+\n+import javax.cache.Cache;\n+import javax.cache.CacheManager;\n+import javax.cache.Caching;\n+\n+/**\n+ * Handle Cache in Abstract User Store Manager.\n+ */\n+public class AbstractUserStoreManagerCache {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c952d3e331de78e54b11a1bb2d450bf215101d92", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/c952d3e331de78e54b11a1bb2d450bf215101d92", "committedDate": "2020-01-24T09:11:07Z", "message": "Cache abstract user store Manager"}, "afterCommit": {"oid": "125d601f7e90a4fa8a95f3353973262ca2d217c3", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/125d601f7e90a4fa8a95f3353973262ca2d217c3", "committedDate": "2020-01-24T11:21:15Z", "message": "Cache abstract user store Manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "125d601f7e90a4fa8a95f3353973262ca2d217c3", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/125d601f7e90a4fa8a95f3353973262ca2d217c3", "committedDate": "2020-01-24T11:21:15Z", "message": "Cache abstract user store Manager"}, "afterCommit": {"oid": "47c13350c82b77a2d27e471201ef7603bedf0542", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/47c13350c82b77a2d27e471201ef7603bedf0542", "committedDate": "2020-01-27T07:14:35Z", "message": "Cache abstract user store Manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47c13350c82b77a2d27e471201ef7603bedf0542", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/47c13350c82b77a2d27e471201ef7603bedf0542", "committedDate": "2020-01-27T07:14:35Z", "message": "Cache abstract user store Manager"}, "afterCommit": {"oid": "dfac1c74a6e9a88400aecf64cf5bd8b0507950c7", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/dfac1c74a6e9a88400aecf64cf5bd8b0507950c7", "committedDate": "2020-01-27T07:16:41Z", "message": "Cache abstract user store Manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfac1c74a6e9a88400aecf64cf5bd8b0507950c7", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/dfac1c74a6e9a88400aecf64cf5bd8b0507950c7", "committedDate": "2020-01-27T07:16:41Z", "message": "Cache abstract user store Manager"}, "afterCommit": {"oid": "282b444e659f8a5305d195cfc6e781a4603480f4", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/282b444e659f8a5305d195cfc6e781a4603480f4", "committedDate": "2020-01-27T08:43:13Z", "message": "Cache abstract user store Manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e018ed6f6567c3d119555aa3f4c15117867bbf0e", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/e018ed6f6567c3d119555aa3f4c15117867bbf0e", "committedDate": "2020-01-27T13:37:31Z", "message": "Cache abstract user store Manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "282b444e659f8a5305d195cfc6e781a4603480f4", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/282b444e659f8a5305d195cfc6e781a4603480f4", "committedDate": "2020-01-27T08:43:13Z", "message": "Cache abstract user store Manager"}, "afterCommit": {"oid": "e018ed6f6567c3d119555aa3f4c15117867bbf0e", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/e018ed6f6567c3d119555aa3f4c15117867bbf0e", "committedDate": "2020-01-27T13:37:31Z", "message": "Cache abstract user store Manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4461ae4297916a58f40d8d4c7d8ff179ce3d76de", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/4461ae4297916a58f40d8d4c7d8ff179ce3d76de", "committedDate": "2020-01-27T14:25:41Z", "message": "Return if key exsists in the cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06f431e5663b50a2709e25c18528c07a6fc4fe40", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/06f431e5663b50a2709e25c18528c07a6fc4fe40", "committedDate": "2020-01-27T14:49:53Z", "message": "Extract add to cache logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/e73cd8954d8f11a513953e086c18324ef2a2dfd2", "committedDate": "2020-01-27T15:04:08Z", "message": "Extract get from cache logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31779936b98ae3a1195ec71f8aea6663c2a9914e", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/31779936b98ae3a1195ec71f8aea6663c2a9914e", "committedDate": "2020-01-27T14:55:18Z", "message": "Extract get from cache logic"}, "afterCommit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/e73cd8954d8f11a513953e086c18324ef2a2dfd2", "committedDate": "2020-01-27T15:04:08Z", "message": "Extract get from cache logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NzMzNTI5", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-348733529", "createdAt": "2020-01-27T15:08:21Z", "commit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTE5NDQy", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-349119442", "createdAt": "2020-01-28T04:04:09Z", "commit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNDowNDowOVrOFiYtRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNDowNDowOVrOFiYtRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwMDcwOQ==", "bodyText": "Better to move doGetUserClaimValues only if the cache is empty. Otherwise, that execution is redundant.", "url": "https://github.com/wso2/carbon-kernel/pull/2548#discussion_r371600709", "createdAt": "2020-01-28T04:04:09Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -11702,21 +11709,34 @@ protected boolean isUserIdGeneratedByUserStore(String userName, Map<String, Stri\n      */\n     public String getUserIDFromUserName(String userName) throws UserStoreException {\n \n+        String userID;\n         UserStore userStore = getUserStore(userName);\n         if (userStore.isRecurssive()) {\n             return ((AbstractUserStoreManager) userStore.getUserStoreManager())\n                     .getUserIDFromUserName(userStore.getDomainFreeName());\n         }\n \n         if (isUniqueUserIdEnabledInUserStore(userStore)) {\n-            return doGetUserIDFromUserNameWithID(userStore.getDomainFreeName());\n+            userID = getFromUserIDCache(userName, userStore);\n+            if (StringUtils.isEmpty(userID)) {\n+                userID = doGetUserIDFromUserNameWithID(userName);\n+                addToUserIDCache(userID, userName, userStore);\n+            }\n+            addToUserNameCache(userID, userName, userStore);\n+            return userID;\n         }\n \n         Map<String, String> claims = doGetUserClaimValues(userName,\n                 new String[]{UserCoreClaimConstants.USER_ID_CLAIM_URI},\n                 userStore.getDomainName(), null);\n         if (claims != null && claims.size() == 1) {\n-            return claims.get(UserCoreClaimConstants.USER_ID_CLAIM_URI);\n+            userID = getFromUserIDCache(userName, userStore);\n+            if (StringUtils.isEmpty(userID)) {\n+                userID = claims.get(UserCoreClaimConstants.USER_ID_CLAIM_URI);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTE5OTIw", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-349119920", "createdAt": "2020-01-28T04:06:50Z", "commit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNDowNjo1MFrOFiYuwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNDowNjo1MFrOFiYuwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwMTA5MA==", "bodyText": "Move this inside try block and extract a private method named. startSuperTenantFlow", "url": "https://github.com/wso2/carbon-kernel/pull/2548#discussion_r371601090", "createdAt": "2020-01-28T04:06:50Z", "author": {"login": "IsuraD"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/UserIdResolverCache.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.wso2.carbon.user.core.common;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.utils.multitenancy.MultitenantConstants;\n+import org.wso2.carbon.utils.xml.StringUtils;\n+\n+import javax.cache.Cache;\n+import javax.cache.CacheManager;\n+import javax.cache.Caching;\n+\n+/**\n+ * Handle Cache in User ID resolving flow.\n+ */\n+public class UserIdResolverCache {\n+\n+    private static Log log = LogFactory.getLog(UserIdResolverCache.class);\n+    private static UserIdResolverCache userIdResolverCache = new UserIdResolverCache();\n+    private static final String USER_ID_RESOLVER_CACHE_MANAGER = \"USER_ID_RESOLVER_CACHE_MANAGER\";\n+\n+    private UserIdResolverCache() {\n+    }\n+\n+    /**\n+     * Gets a new instance of UserIdResolverCache.\n+     *\n+     * @return A new instance of UserIdResolverCache.\n+     */\n+    public synchronized static UserIdResolverCache getInstance() {\n+\n+        return userIdResolverCache;\n+    }\n+\n+    private Cache<String, String> UserIdResolverCache(String cacheName) {\n+\n+        Cache<String, String> cache;\n+        CacheManager cacheManager = Caching.getCacheManagerFactory().getCacheManager(USER_ID_RESOLVER_CACHE_MANAGER);\n+        cache = cacheManager.getCache(cacheName);\n+        return cache;\n+    }\n+\n+    /**\n+     * Add a cache entry.\n+     *\n+     * @param key       Key which cache entry is indexed.\n+     * @param entry     Actual object where cache entry is placed.\n+     * @param cacheName Name of the cache.\n+     */\n+    public void addToCache(String key, String entry, String cacheName) {\n+\n+        if (StringUtils.isEmpty(key) || StringUtils.isEmpty(entry) || StringUtils.isEmpty(cacheName)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Invalid input parameters in add to cache request. Cache key: \" + key + \" ,Cache entry: \" +\n+                        entry + \" ,Cache name: \" + cacheName);\n+            }\n+            return;\n+        }\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+        try {\n+            PrivilegedCarbonContext carbonContext = PrivilegedCarbonContext.getThreadLocalCarbonContext();\n+            carbonContext.setTenantId(MultitenantConstants.SUPER_TENANT_ID);\n+            carbonContext.setTenantDomain(MultitenantConstants.SUPER_TENANT_DOMAIN_NAME);\n+\n+            Cache<String, String> cache = UserIdResolverCache(cacheName);\n+            if (cache != null && !cache.containsKey(key)) {\n+                cache.put(key, entry);\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\n+                            cacheName + \" which is under \" + USER_ID_RESOLVER_CACHE_MANAGER + \", added the entry: \"\n+                                    + entry + \" for the key: \" + key + \" successfully\");\n+                }\n+            }\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Retrieves a cache entry.\n+     *\n+     * @param key       CacheKey.\n+     * @param cacheName Name of the cache.\n+     * @return Cached entry if the key presents, else returns null.\n+     */\n+    public String getValueFromCache(String key, String cacheName) {\n+\n+        if (StringUtils.isEmpty(key) || StringUtils.isEmpty(cacheName)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Invalid input parameters in get value from cache request. Cache key: \" + key +\n+                        \" ,Cache name: \" + cacheName);\n+            }\n+            return null;\n+        }\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            PrivilegedCarbonContext carbonContext = PrivilegedCarbonContext.getThreadLocalCarbonContext();\n+            carbonContext.setTenantId(MultitenantConstants.SUPER_TENANT_ID);\n+            carbonContext.setTenantDomain(MultitenantConstants.SUPER_TENANT_DOMAIN_NAME);\n+\n+            Cache<String, String> cache = UserIdResolverCache(cacheName);\n+            if (cache != null) {\n+                if (cache.containsKey(key)) {\n+                    String entry = cache.get(key);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(cacheName + \" which is under \" + USER_ID_RESOLVER_CACHE_MANAGER +\n+                                \", found the entry: \" + entry + \" for the key: \" + key + \" successfully.\");\n+                    }\n+                    return entry;\n+                }\n+                if (log.isDebugEnabled()) {\n+                    log.debug(cacheName + \" which is under \" + USER_ID_RESOLVER_CACHE_MANAGER +\n+                            \", doesn't contain the key: \" + key);\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + cacheName + \" which is under \"\n+                            + USER_ID_RESOLVER_CACHE_MANAGER);\n+                }\n+            }\n+            return null;\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Clears a cache entry.\n+     *\n+     * @param key       Key to clear cache.\n+     * @param cacheName Name of the cache.\n+     */\n+    public void clearCacheEntry(String key, String cacheName) {\n+\n+        if (StringUtils.isEmpty(key) || StringUtils.isEmpty(cacheName)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Invalid input parameters in clear from cache request. Cache key: \" + key +\n+                        \" ,Cache name: \" + cacheName);\n+            }\n+            return;\n+        }\n+\n+        PrivilegedCarbonContext.startTenantFlow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2"}, "originalPosition": 163}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTIyNDU1", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-349122455", "createdAt": "2020-01-28T04:20:54Z", "commit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNDoyMDo1NFrOFiY3hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNDoyMDo1NFrOFiY3hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwMzMzNQ==", "bodyText": "Extract to a private method", "url": "https://github.com/wso2/carbon-kernel/pull/2548#discussion_r371603335", "createdAt": "2020-01-28T04:20:54Z", "author": {"login": "ashensw"}, "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -3693,6 +3695,11 @@ public final void deleteUser(String userName) throws UserStoreException {\n         if (isUniqueUserIdEnabled) {\n             userID = getUserIDFromUserName(userName);\n             isUserExists = userID != null;\n+            UserIdResolverCache.getInstance()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73cd8954d8f11a513953e086c18324ef2a2dfd2"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eeeacfe6d7e4c128c72c00e71241982ad26e8e5b", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/eeeacfe6d7e4c128c72c00e71241982ad26e8e5b", "committedDate": "2020-01-28T04:59:06Z", "message": "Change super tenant flow to tenant flow"}, "afterCommit": {"oid": "bd0363d3266abed7c8f7ce5372670df1ddda7841", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/bd0363d3266abed7c8f7ce5372670df1ddda7841", "committedDate": "2020-01-28T05:11:13Z", "message": "Change super tenant flow to tenant flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd0363d3266abed7c8f7ce5372670df1ddda7841", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/bd0363d3266abed7c8f7ce5372670df1ddda7841", "committedDate": "2020-01-28T05:11:13Z", "message": "Change super tenant flow to tenant flow"}, "afterCommit": {"oid": "dc55ad7dc2543ecec424525e7c5ffdae2031ced0", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/dc55ad7dc2543ecec424525e7c5ffdae2031ced0", "committedDate": "2020-01-28T05:28:29Z", "message": "Change super tenant flow to tenant flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc55ad7dc2543ecec424525e7c5ffdae2031ced0", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/dc55ad7dc2543ecec424525e7c5ffdae2031ced0", "committedDate": "2020-01-28T05:28:29Z", "message": "Change super tenant flow to tenant flow"}, "afterCommit": {"oid": "c044ab0b4fab9fcd662239567aa0f633b32239e0", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/c044ab0b4fab9fcd662239567aa0f633b32239e0", "committedDate": "2020-01-28T05:39:35Z", "message": "Change super tenant flow to tenant flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c044ab0b4fab9fcd662239567aa0f633b32239e0", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/c044ab0b4fab9fcd662239567aa0f633b32239e0", "committedDate": "2020-01-28T05:39:35Z", "message": "Change super tenant flow to tenant flow"}, "afterCommit": {"oid": "375dcbc751ac71a544920706d0417febccb76d91", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/375dcbc751ac71a544920706d0417febccb76d91", "committedDate": "2020-01-28T05:57:46Z", "message": "Change super tenant flow to tenant flow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fc6c582866e2ac4aeb881de76c1058c85221bef", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/1fc6c582866e2ac4aeb881de76c1058c85221bef", "committedDate": "2020-01-28T06:08:06Z", "message": "Change super tenant flow to tenant flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "375dcbc751ac71a544920706d0417febccb76d91", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/375dcbc751ac71a544920706d0417febccb76d91", "committedDate": "2020-01-28T05:57:46Z", "message": "Change super tenant flow to tenant flow"}, "afterCommit": {"oid": "1fc6c582866e2ac4aeb881de76c1058c85221bef", "author": {"user": {"login": "Buddhimah", "name": "Buddhima Udaranga"}}, "url": "https://github.com/wso2/carbon-kernel/commit/1fc6c582866e2ac4aeb881de76c1058c85221bef", "committedDate": "2020-01-28T06:08:06Z", "message": "Change super tenant flow to tenant flow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTU1ODU5", "url": "https://github.com/wso2/carbon-kernel/pull/2548#pullrequestreview-349155859", "createdAt": "2020-01-28T06:41:54Z", "commit": {"oid": "1fc6c582866e2ac4aeb881de76c1058c85221bef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2117, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}