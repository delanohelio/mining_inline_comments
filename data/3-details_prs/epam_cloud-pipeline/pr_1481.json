{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5OTU1MTI5", "number": 1481, "title": "Issue #1404: implemented tests for ClusterApiService", "bodyText": "First variant of tests for the first method (with @PostFilter) in the ClusterApiService\nIssue - #1404\nSigned-off-by: Iurii_Kofanov youkofan@gmail.com", "createdAt": "2020-10-08T14:12:38Z", "url": "https://github.com/epam/cloud-pipeline/pull/1481", "merged": true, "mergeCommit": {"oid": "18a749f8e369606f5804285a4a445f42e9906598"}, "closed": true, "closedAt": "2020-10-27T14:49:45Z", "author": {"login": "YouKofan"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRqMLqABqjM4NjQzNzgzMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWpUujgBqjM5MjYwNDQ0MzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a4555af89cb0823d696da25137c1c14ba21b1d8", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/8a4555af89cb0823d696da25137c1c14ba21b1d8", "committedDate": "2020-10-08T14:09:39Z", "message": "Issue #1404: tests for the first method in the ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}, "afterCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/44f1669d54f99fd04970a8be0eabc30b328cabe1", "committedDate": "2020-10-12T02:02:14Z", "message": "Issue #1404: implemented tests for ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MzE5MTYx", "url": "https://github.com/epam/cloud-pipeline/pull/1481#pullrequestreview-508319161", "createdAt": "2020-10-14T13:01:19Z", "commit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMzowMToxOVrOHhR01Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMzozODo0OVrOHhTeCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1NzEwOQ==", "bodyText": "Could you please add access modifier?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504657109", "createdAt": "2020-10-14T13:01:19Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java", "diffHunk": "@@ -144,6 +146,12 @@\n     @MockBean\n     protected CloudRegionManager mockCloudRegionManager;\n \n+    @MockBean\n+    protected NodeDiskManager mockNodeDiskManager;\n+\n+    @MockBean\n+    UsageMonitoringManager mockUsageMonitoringManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1NzUyOA==", "bodyText": "Cleanup please", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504657528", "createdAt": "2020-10-14T13:01:54Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java", "diffHunk": "@@ -322,9 +438,9 @@ protected DataStorageManager mockDataStorageManager() {\n     }\n \n     @Bean\n-    protected FolderCrudManager mockCrudManager() {\n+    protected FolderCrudManager mockFolderCrudManager() {\n         return Mockito.mock(FolderCrudManager.class);\n-    }\n+    } /////", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 247}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1Nzg0Ng==", "bodyText": "Why we need such import?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504657846", "createdAt": "2020-10-14T13:02:20Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java", "diffHunk": "@@ -39,7 +41,11 @@\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2NDQ2MQ==", "bodyText": "Why we need UserManager real bean?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504664461", "createdAt": "2020-10-14T13:11:42Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java", "diffHunk": "@@ -39,7 +41,11 @@\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n+        \"com.epam.pipeline.security.run\",\n+        \"com.epam.pipeline.manager.security\",\n+        \"com.epam.pipeline.manager.user\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2ODA0Nw==", "bodyText": "Let's remove empty lines between fields.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504668047", "createdAt": "2020-10-14T13:16:41Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2OTU4OA==", "bodyText": "Let's create a new build method in creators package. This  method may accept id, name, owner arguments.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504669588", "createdAt": "2020-10-14T13:18:57Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;\n+\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n+\n+    @Before\n+    public void setUp() {\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n+\n+        pipelineRun.setId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER);\n+\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NTIxOQ==", "bodyText": "Let's not confuse packages: PipelineRun is not in cluster package. We need to create a new package/class for PipelineRun object creating methods.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504675219", "createdAt": "2020-10-14T13:26:37Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -86,4 +99,20 @@ public static AllowedInstanceAndPriceTypes getDefaultAllowedInstanceAndPriceType\n     public static NodeDisk getDefaultNodeDisk() {\n         return new NodeDisk(ID, TEST_STRING, LDT);\n     }\n+\n+    public static PipelineRun getPipelineRun() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NTc3Ng==", "bodyText": "The same for creators below", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504675776", "createdAt": "2020-10-14T13:27:24Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -86,4 +99,20 @@ public static AllowedInstanceAndPriceTypes getDefaultAllowedInstanceAndPriceType\n     public static NodeDisk getDefaultNodeDisk() {\n         return new NodeDisk(ID, TEST_STRING, LDT);\n     }\n+\n+    public static PipelineRun getPipelineRun() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NTIxOQ=="}, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3Njg4Mg==", "bodyText": "Let's  inline test class field initiliazations and get rid of setUp method.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504676882", "createdAt": "2020-10-14T13:28:58Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;\n+\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n+\n+    @Before\n+    public void setUp() {\n+        statsList = Collections.singletonList(monitoringStats);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NzA3Mw==", "bodyText": "Do not forget final please", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504677073", "createdAt": "2020-10-14T13:29:16Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;\n+\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n+\n+    @Before\n+    public void setUp() {\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n+\n+        pipelineRun.setId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER);\n+\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n+\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(OWNER_USER);\n+        nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n+\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n+\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+\n+        List<NodeInstance> nodes = clusterApiService.getNodes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3ODY5Mw==", "bodyText": "Could we use contains method here?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504678693", "createdAt": "2020-10-14T13:31:27Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;\n+\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n+\n+    @Before\n+    public void setUp() {\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n+\n+        pipelineRun.setId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER);\n+\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n+\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(OWNER_USER);\n+        nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n+\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n+\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3OTMwMg==", "bodyText": "Looks like this field was not initialized", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504679302", "createdAt": "2020-10-14T13:32:15Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NDA0Mg==", "bodyText": "Also, cold you please place fields autowired fields declaration?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504684042", "createdAt": "2020-10-14T13:38:49Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2ODA0Nw=="}, "originalCommit": {"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzI4MTk0", "url": "https://github.com/epam/cloud-pipeline/pull/1481#pullrequestreview-510328194", "createdAt": "2020-10-16T10:01:18Z", "commit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDowMToxOFrOHiy33g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjowNToyMVrOHi47tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0NzEzNA==", "bodyText": "Could you please add final to fields here and in other places?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506247134", "createdAt": "2020-10-16T10:01:18Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -51,6 +53,24 @@ public static NodeInstance getDefaultNodeInstance() {\n         return new NodeInstance();\n     }\n \n+    public static NodeInstance getNodeInstanceWithPermission() {\n+        NodeInstance nodeInstance = new NodeInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2MTkyNw==", "bodyText": "The private methods shell be after all public methods", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506261927", "createdAt": "2020-10-16T10:20:35Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI3NDU0NQ==", "bodyText": "Could we use here\nassertThat(resultStatsList).hasSize(1).contains(monitoringStats);\n\nAnd in other such places too.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506274545", "createdAt": "2020-10-16T10:34:48Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+       final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        final List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 342}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4NTY5Ng==", "bodyText": "It seems that we can just use basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"}", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506285696", "createdAt": "2020-10-16T10:48:52Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java", "diffHunk": "@@ -39,7 +39,10 @@\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4ODE4Ng==", "bodyText": "Could you please rename this class to ClusterCreatorUtils? This class should consist of creators for entities from cluster package.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506288186", "createdAt": "2020-10-16T10:51:53Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -23,6 +23,7 @@\n import com.epam.pipeline.entity.cluster.MasterNode;\n import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4ODkyMw==", "bodyText": "Could you move this method to ClusterCreatorUtils?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506288923", "createdAt": "2020-10-16T10:52:43Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java", "diffHunk": "@@ -55,4 +56,8 @@ public static ContextualPreferenceVO getContextualPreferenceVO() {\n                 TEST_STRING, TEST_STRING, PREFERENCE_TYPE, getCPExternalResource()\n         );\n     }\n+\n+    public static MonitoringStats getMonitoringStats() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5MTc4MA==", "bodyText": "It is absolutely not clear what is meant permission", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506291780", "createdAt": "2020-10-16T10:56:12Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+\n+public final class PipelineCreatorUtils {\n+\n+    public static PipelineRun getPipelineRunWithPermission() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5NzE2OA==", "bodyText": "Let's avoid some test case specific naming in such classes. For example, for current situation we need only one method  for this class - getPipelineRun that will return PipelineRun object and accepts all required argument: id, name, owner... You may take the ObjectCreatorUtils class as a basis.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506297168", "createdAt": "2020-10-16T11:03:13Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+\n+public final class PipelineCreatorUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5Nzk2NA==", "bodyText": "see PipelineCreatorUtils comment", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506297964", "createdAt": "2020-10-16T11:04:09Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -51,6 +53,24 @@ public static NodeInstance getDefaultNodeInstance() {\n         return new NodeInstance();\n     }\n \n+    public static NodeInstance getNodeInstanceWithPermission() {\n+        NodeInstance nodeInstance = new NodeInstance();\n+        nodeInstance.setId(ID);\n+        nodeInstance.setOwner(\"OWNER\");\n+        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithPermission());\n+        nodeInstance.setName(TEST_STRING);\n+        return nodeInstance;\n+    }\n+\n+    public static NodeInstance getNodeInstanceWithoutPermission() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5ODgzNg==", "bodyText": "Do not forget to make variables final", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506298836", "createdAt": "2020-10-16T11:05:12Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+\n+public final class PipelineCreatorUtils {\n+\n+    public static PipelineRun getPipelineRunWithPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwMTM5Nw==", "bodyText": "It seems this initialization is redundant.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506301397", "createdAt": "2020-10-16T11:08:09Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+       final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 334}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwMjIyMQ==", "bodyText": "Format code please", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506302221", "createdAt": "2020-10-16T11:09:09Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+       final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 230}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxNDY3OA==", "bodyText": "It seems for such simple and short cases we can merge these two lines:\nassertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506314678", "createdAt": "2020-10-16T11:25:00Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxNzg0NA==", "bodyText": "Maybe we shell consider creating a common for *ApiServiceTest classes method to build a single user permissions?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506317844", "createdAt": "2020-10-16T11:28:59Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMTI4Mg==", "bodyText": "Looks like this initialization is redundant", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506321282", "createdAt": "2020-10-16T11:33:33Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMjE4MQ==", "bodyText": "Could you check it for other methods too?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506332181", "createdAt": "2020-10-16T11:47:05Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMTI4Mg=="}, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNDQ0Nw==", "bodyText": "Could you check it for other methods too?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506334447", "createdAt": "2020-10-16T11:49:59Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxNDY3OA=="}, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0NjQyMw==", "bodyText": "Maybe we shell add @AclMask tests? (for merging entity permissions with parent permissions)\nP.S.: see AclAspect", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506346423", "createdAt": "2020-10-16T12:05:21Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7eb321af6111982b798187dffbf70bd809998d4"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNDY0OTk1", "url": "https://github.com/epam/cloud-pipeline/pull/1481#pullrequestreview-513464995", "createdAt": "2020-10-21T09:09:11Z", "commit": {"oid": "4a5f096dcc4809e99c88158e87803b53a477beba"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwOTowOToxMVrOHlh_cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwOTo1Njo0NlrOHlj7Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTExNjI3Mg==", "bodyText": "Could you please check if all of the changes in this class are relevant to the pull request? It seems that mocks like PipelineDao have nothing to do with acl tests.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509116272", "createdAt": "2020-10-21T09:09:11Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java", "diffHunk": "@@ -17,47 +17,79 @@\n package com.epam.pipeline.test.acl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a5f096dcc4809e99c88158e87803b53a477beba"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTExODkyNw==", "bodyText": "I'm afraid that this change can be harmful if some api method has NodeInstance class in request body. For example as part of PipelineRun class. Let's revert the change until we have implemented tests for all the controllers.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509118927", "createdAt": "2020-10-21T09:13:20Z", "author": {"login": "tcibinan"}, "path": "api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java", "diffHunk": "@@ -45,7 +45,6 @@\n public class NodeInstance extends AbstractSecuredEntity {\n \n     private UUID uid;\n-    private String name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a5f096dcc4809e99c88158e87803b53a477beba"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTExOTU5Nw==", "bodyText": "Could you please replace the field usages with CommonCreatorConstants.TEST_STRING.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509119597", "createdAt": "2020-10-21T09:14:16Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a5f096dcc4809e99c88158e87803b53a477beba"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEyMTYyNA==", "bodyText": "I suppose we can call the second one just anotherNodeInstance.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509121624", "createdAt": "2020-10-21T09:17:17Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a5f096dcc4809e99c88158e87803b53a477beba"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzNjQ2NA==", "bodyText": "Method initSingleNodeInstanceList() returns list which doesn't contain nodeInstanceWithoutPermission so this test is not testing what it should. Probably we can even get rid of methods like initSingleNodeInstanceList and always initialiaze lists like the following\nCollections.singletonList(node);\n// or\nArrays.asList(node1, node2);", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509136464", "createdAt": "2020-10-21T09:39:10Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a5f096dcc4809e99c88158e87803b53a477beba"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0MTgwOQ==", "bodyText": "Let's specify explicitly why the access is denied like shouldDenyAccessToNodeWhenPermissionIsNotGranted.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509141809", "createdAt": "2020-10-21T09:47:13Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNode() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a5f096dcc4809e99c88158e87803b53a477beba"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0Nzk5MQ==", "bodyText": "I wonder if we can extract all this duplicated mocking calls into some methods like the following:\nmockUser();\nmockStats();\nmockNodeInstance();\nmockPipelineRun();", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509147991", "createdAt": "2020-10-21T09:56:46Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        final List<MonitoringStats> returnedStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a5f096dcc4809e99c88158e87803b53a477beba"}, "originalPosition": 302}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NDIyNDk0", "url": "https://github.com/epam/cloud-pipeline/pull/1481#pullrequestreview-515422494", "createdAt": "2020-10-23T07:48:52Z", "commit": {"oid": "b783a146609e9b69f05d82d5e8487ce0bb6857d4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNzo0ODo1MlrOHnCjwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwODoxNToyOFrOHnDc4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5ODQzNA==", "bodyText": "Could you please use generic type to return List<T> rather then List<Object>. It probably is a good idea because it increases the possibility that this method will be reused.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r510698434", "createdAt": "2020-10-23T07:48:52Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java", "diffHunk": "@@ -131,4 +132,10 @@ public Sid toSid() {\n             return new GrantedAuthoritySid(authorityName);\n         }\n     }\n+\n+    protected List<Object> mutableListOf(Object... objects) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b783a146609e9b69f05d82d5e8487ce0bb6857d4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDcxMzA1Nw==", "bodyText": "Probably this mocking call makes thing even more complicated then before. For example in this case nodeInstance used for acl is not the same instance that will be used in initMocksBehavior. Also this true\\false flag is not intuitive. Just imagine that there will be another boolean parameter.\nI still think that it will be better to use separate calls for mocks which will just remove a need to write the whole\ndoReturn().when().call() chain. For example in this case we can use something like the following. It does not contain less lines then the original version. But it is not the point, isn't it? The following code is declarative as plain mockito calls but it is also much simpler. And in case f.e. pipeline run mocking mechanism will have to change in the future then we will just have to change a single method mockRun.\nmockUser(SIMPLE_USER); // Mock any user related calls that are used in the tests.\nmockNode(nodeInstance); // Mock all node instance calls that are used in the tests.\nmockRun(pipelineRun); // Mock all pipeline run calls that are used in the tests.\npublic void mockNode(final NodeInstance nodeInstance) {\n    doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n    doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n}\nWhat do you think?", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r510713057", "createdAt": "2020-10-23T08:15:28Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initMocksBehavior(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c317b5ac7100eac63135f3e14d1251234969cbf"}, "originalPosition": 221}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NjAyOTA4", "url": "https://github.com/epam/cloud-pipeline/pull/1481#pullrequestreview-516602908", "createdAt": "2020-10-26T09:36:52Z", "commit": {"oid": "01febba00d8ffb21d4f4ae621c898d2bad0cec19"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwOTozNjo1MlrOHoHbtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwOTozNjo1MlrOHoHbtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyNjg2OQ==", "bodyText": "It does look like we can just replace it with the new method mockNode. Some similar cases with terminateNode calls in different tests too. You can just add terminateNode to mockNode and everything seems to be just fine.", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r511826869", "createdAt": "2020-10-26T09:36:52Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,444 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        mockRun(pipelineRun);\n+\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockRun(pipelineRun);\n+        mockNode(nodeInstance);\n+        mockUser();\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockNode(nodeInstance);\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        mockRun(pipelineRun);\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        final List<MonitoringStats> returnedStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final List<MonitoringStats> returnedStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n+                .isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        mockUser();\n+        mockRun(pipelineRun);\n+\n+        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01febba00d8ffb21d4f4ae621c898d2bad0cec19"}, "originalPosition": 426}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01febba00d8ffb21d4f4ae621c898d2bad0cec19", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/01febba00d8ffb21d4f4ae621c898d2bad0cec19", "committedDate": "2020-10-26T08:04:38Z", "message": "Issue #1404: Fix PMD config\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}, "afterCommit": {"oid": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/bf67280253bcc69263b1123ccefaaa2c35d96a55", "committedDate": "2020-10-26T10:37:35Z", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NDAyMjUy", "url": "https://github.com/epam/cloud-pipeline/pull/1481#pullrequestreview-517402252", "createdAt": "2020-10-27T07:16:16Z", "commit": {"oid": "934aff0abe248cc5cc6798679a14122ce28c6c61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27T13:29:23Z", "message": "Issue #1404: tests for the first method in the ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27T13:32:47Z", "message": "Issue #1404: implemented tests for ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b713464980ca18071bff2affee16237e96622694", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27T13:33:41Z", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27T13:34:13Z", "message": "Issue #1404: Minor style improvements\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27T13:34:30Z", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27T13:34:30Z", "message": "Issue #1404: Refactoring initAclEntity method\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27T13:34:30Z", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27T13:34:36Z", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27T13:34:39Z", "message": "Issue #1404: Refactoring in creatorUtils classes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3237f3d382b414f66cb99688468c0695047be92", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/c3237f3d382b414f66cb99688468c0695047be92", "committedDate": "2020-10-27T13:34:39Z", "message": "Issue #1404: Added license to the PipelineCreatorUtils and other minor style fixes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27T13:34:59Z", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27T13:35:08Z", "message": "Issue #1404: Minor test fixes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27T13:35:08Z", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27T13:35:09Z", "message": "Issue #1404: Style (valid indentations) fixes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27T13:51:58Z", "message": "Issue #1404: Merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "934aff0abe248cc5cc6798679a14122ce28c6c61", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/934aff0abe248cc5cc6798679a14122ce28c6c61", "committedDate": "2020-10-26T13:53:37Z", "message": "Issue #1404: Style (valid indentations) fixes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}, "afterCommit": {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "author": {"user": {"login": "YouKofan", "name": "Iurii Kofanov"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27T13:51:58Z", "message": "Issue #1404: Merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3667, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}