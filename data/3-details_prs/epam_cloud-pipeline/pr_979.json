{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4Mjc2NDE2", "number": 979, "title": "pipe storage du implementation", "bodyText": "This PR provides implementation for issue #548\nThe following changes were added:\n\na new API method GET datastorage/path/usage that calculates datastorage usage statistics. The data is taken from elasticsearch.\nmethod for loading NFS datastorages by name or ID was fixed.\na new CLI option pipe storage du was added. If path is not specified all buckets will be listed with GET datastorage/path/usage API method call. If path was specified and it's not NFS the bucket will be listed with cloud provider directly. If path has NFS type the data will be loaded with GET datastorage/path/usage API method call\n\nThe command  pipe storage du has the following options:\n\nname - the data storage name [optional]\n-p (--relative-path) - the relative path [optional]\n-f (--format) - the size unit format [default: Mb]\n-d (--depth) - the maximum depth level [optional]\n\nUsage examples:\n\npipe storage du - lists all storages usage\n\n  Storage                 Files count     Size (Mb)  \n  storage_1                    26863          357.7  \n  storage_2                        7            0.1  \n\n\npipe storage du storage_1 - prints usage for required storage\n\n  Storage                              Files count     Size (Mb)  \n  storage_1                                  26863         357.7  \n\n\npipe storage du storage_1 -p common - prints usage for required storage and path\n\n  Storage                              Files count     Size (Mb)  \n  storage_1/common                           26863         357.7  \n\n\npipe storage du storage_1 -p common -d 1 - prints usage for required storage and path for depth level 1\n\n  Storage                              Files count     Size (Mb)  \n  storage_1/common/folder1                   26863         357.7  \n  storage_1/common/folder2                       7           0.1  \n\n\npipe storage du storage_1 -f G - prints usage for required storage with specified size format\n\n  Storage                              Files count     Size (Gb)  \n  storage_1                                  26863           2.2 \n\nNote: --depth option is not supported for NFS storages now", "createdAt": "2020-02-21T13:14:16Z", "url": "https://github.com/epam/cloud-pipeline/pull/979", "merged": true, "mergeCommit": {"oid": "885ffbf8222565f1c5f07f18dff46504f84beb5b"}, "closed": true, "closedAt": "2020-02-28T11:04:50Z", "author": {"login": "ekazachkova"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFj-6hAH2gAyMzc4Mjc2NDE2OjhkYmI2NmFiYjVlZmNjZjRiZjUwNzk5ZWI3ZWE0MjZlMmI4ZTNhZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIZB9zgH2gAyMzc4Mjc2NDE2OjZlYjJjMTg3OTU4ZmM2MDg5YjRhN2M5OTc5OWEyZWY0ZmIyN2E4YzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8dbb66abb5efccf4bf50799eb7ea426e2b8e3ae6", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/8dbb66abb5efccf4bf50799eb7ea426e2b8e3ae6", "committedDate": "2020-02-18T15:51:06Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - S3 support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d30908252d1569f4c9ffd09c3dd4a6a7445e7ca7", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/d30908252d1569f4c9ffd09c3dd4a6a7445e7ca7", "committedDate": "2020-02-20T13:10:23Z", "message": "issue #548: Implement storage usage statistics retrieval via pipe - API method for search storage usage statistics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1107f39bb2d84b9ab2d41f913d70cef181f071c", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f1107f39bb2d84b9ab2d41f913d70cef181f071c", "committedDate": "2020-02-20T13:47:08Z", "message": "issue #548: Implement storage usage statistics retrieval via pipe - fix for field that should be indexed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "886b6b0d987d7beced339b570cf4fe5cfeb00665", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/886b6b0d987d7beced339b570cf4fe5cfeb00665", "committedDate": "2020-02-21T11:01:46Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - NFS support for CLI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f4bb95352d322cbc968f30efc04f2a4ff8f1d02", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/6f4bb95352d322cbc968f30efc04f2a4ff8f1d02", "committedDate": "2020-02-21T11:21:40Z", "message": "issue #548: Implement storage usage statistics retrieval via pipe - fix for data storage loading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4d4b74cbca4e2ad4b98d40a64018cd7b7450b53", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b4d4b74cbca4e2ad4b98d40a64018cd7b7450b53", "committedDate": "2020-02-21T12:38:46Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - use method GET datastorage/path/usage for all buckets usage listing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99d719a65c497f8de661053df2a37eec3f2b522e", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/99d719a65c497f8de661053df2a37eec3f2b522e", "committedDate": "2020-02-21T13:11:24Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - temporary wrap for load usage api method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c9506c6903503a7196870df8ad6830da33f26fa", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/9c9506c6903503a7196870df8ad6830da33f26fa", "committedDate": "2020-02-21T13:13:40Z", "message": "issue #548: Implement storage usage statistics retrieval via pipe - cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b15a7ce76b3da63face98bbbf1bfc9c94c8b702", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/6b15a7ce76b3da63face98bbbf1bfc9c94c8b702", "committedDate": "2020-02-21T14:08:28Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06d73dd5e357f9bcd124b4ef1a5448cf24100ec9", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/06d73dd5e357f9bcd124b4ef1a5448cf24100ec9", "committedDate": "2020-02-21T14:26:46Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - throw unsupported exceptions for azure and gs providers for now"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNjUzNjU2", "url": "https://github.com/epam/cloud-pipeline/pull/979#pullrequestreview-362653656", "createdAt": "2020-02-21T14:10:46Z", "commit": {"oid": "9c9506c6903503a7196870df8ad6830da33f26fa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDoxMDo0NlrOFs4FaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDoyMDozNlrOFs4Y4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwMDU1Mg==", "bodyText": "It seems that method name is misleading", "url": "https://github.com/epam/cloud-pipeline/pull/979#discussion_r382600552", "createdAt": "2020-02-21T14:10:46Z", "author": {"login": "mzueva"}, "path": "pipe-cli/pipe.py", "diffHunk": "@@ -901,6 +902,16 @@ def storage_copy_item(source, destination, recursive, force, exclude, include, q\n                              exclude, include, quiet, tags, file_list, symlinks, skip_existing=skip_existing)\n \n \n+@storage.command('du')\n+@click.argument('path', required=False)\n+@click.option('-f', '--format', help='Format for size [G/M/K]',\n+              type=click.Choice(DuFormatType.possible_types()), required=False, default='M')\n+@click.option('-d', '--depth', help='Depth level', type=int, required=False)\n+@Config.validate_access_token(quiet_flag_property_name='quiet')\n+def storage_copy_item(path, format, depth):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c9506c6903503a7196870df8ad6830da33f26fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNDc1Nw==", "bodyText": "Could we extract this logic into a separate method to make it more readable?", "url": "https://github.com/epam/cloud-pipeline/pull/979#discussion_r382604757", "createdAt": "2020-02-21T14:18:59Z", "author": {"login": "mzueva"}, "path": "pipe-cli/src/utilities/storage/s3.py", "diffHunk": "@@ -411,6 +414,83 @@ def list_items(self, relative_path=None, recursive=False, page_size=StorageOpera\n         else:\n             return self.list_objects(client, prefix, operation_parameters, recursive)\n \n+    def get_summary_with_depth(self, max_depth, relative_path=None):\n+        bucket_name = self.bucket.bucket.path\n+        delimiter = S3BucketOperations.S3_PATH_SEPARATOR\n+        client = self.session.client('s3', config=S3BucketOperations.get_proxy_config())\n+        operation_parameters = {\n+            'Bucket': bucket_name\n+        }\n+        prefix = S3BucketOperations.get_prefix(delimiter, relative_path)\n+        if relative_path:\n+            operation_parameters['Prefix'] = prefix\n+            max_depth += len(prefix.split(delimiter))\n+\n+        paginator = client.get_paginator('list_objects_v2')\n+        page_iterator = paginator.paginate(**operation_parameters)\n+        result = Tree()\n+        relative_path_len = 0\n+        range_start = 1\n+        if relative_path:\n+            root_path = delimiter.join([bucket_name, relative_path])\n+            root = result.create_node(root_path, root_path, data=StorageItem())\n+            relative_path_len = len(relative_path.split(delimiter))\n+            range_start = relative_path_len + 1\n+        else:\n+            root = result.create_node(bucket_name, bucket_name, data=StorageItem())\n+\n+        for page in page_iterator:\n+            if 'Contents' in page:\n+                for file in page['Contents']:\n+                    name = self.get_file_name(file, prefix, True)\n+                    size = file['Size']\n+\n+                    tokens = name.split(delimiter)\n+                    root.data.add_item(size)\n+\n+                    if len(tokens) - relative_path_len > 1:\n+                        if relative_path:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c9506c6903503a7196870df8ad6830da33f26fa"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTUzNw==", "bodyText": "missing final", "url": "https://github.com/epam/cloud-pipeline/pull/979#discussion_r382605537", "createdAt": "2020-02-21T14:20:36Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/security/GrantPermissionManager.java", "diffHunk": "@@ -412,6 +412,15 @@ public boolean storagePermission(Long storageId, String permissionName) {\n         }\n     }\n \n+    public boolean storagePermissionByName(final String identifier, final String permissionName) {\n+        AbstractSecuredEntity storage = entityManager.loadByNameOrId(AclClass.DATA_STORAGE, identifier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c9506c6903503a7196870df8ad6830da33f26fa"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3c4898bbc01425cf975d6db5dbd06a4c416ffbc", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b3c4898bbc01425cf975d6db5dbd06a4c416ffbc", "committedDate": "2020-02-25T11:26:43Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - Azure support for CLI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28666c6a30fdd539bcc61b36f3dccbdab04eedda", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/28666c6a30fdd539bcc61b36f3dccbdab04eedda", "committedDate": "2020-02-26T13:22:00Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - GCP support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd16ce22979001170d44eea9cae6021775990f59", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/bd16ce22979001170d44eea9cae6021775990f59", "committedDate": "2020-02-26T14:24:28Z", "message": "issue #548: Implement storage usage statistics retrieval via pipe - cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MTg0ODcx", "url": "https://github.com/epam/cloud-pipeline/pull/979#pullrequestreview-365184871", "createdAt": "2020-02-26T19:37:17Z", "commit": {"oid": "b3c4898bbc01425cf975d6db5dbd06a4c416ffbc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOTozNzoxN1rOFu5WiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOTozNzoxN1rOFu5WiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxODQ3Mg==", "bodyText": "still missing final", "url": "https://github.com/epam/cloud-pipeline/pull/979#discussion_r384718472", "createdAt": "2020-02-26T19:37:17Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/security/GrantPermissionManager.java", "diffHunk": "@@ -412,6 +412,15 @@ public boolean storagePermission(Long storageId, String permissionName) {\n         }\n     }\n \n+    public boolean storagePermissionByName(final String identifier, final String permissionName) {\n+        AbstractSecuredEntity storage = entityManager.loadByNameOrId(AclClass.DATA_STORAGE, identifier);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTUzNw=="}, "originalCommit": {"oid": "9c9506c6903503a7196870df8ad6830da33f26fa"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21925474401e6381d15fb592c93fce2cc1a5c319", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/21925474401e6381d15fb592c93fce2cc1a5c319", "committedDate": "2020-02-27T09:55:15Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - split input storage path into storage name and relative path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abe5d5f489da59b01f524f80e9a4512b60832687", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/abe5d5f489da59b01f524f80e9a4512b60832687", "committedDate": "2020-02-27T10:39:42Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eb2c187958fc6089b4a7c99799a2ef4fb27a8c4", "author": {"user": {"login": "ekazachkova", "name": "Ekaterina Kazachkova"}}, "url": "https://github.com/epam/cloud-pipeline/commit/6eb2c187958fc6089b4a7c99799a2ef4fb27a8c4", "committedDate": "2020-02-27T10:47:15Z", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - fix for relative path"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3870, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}