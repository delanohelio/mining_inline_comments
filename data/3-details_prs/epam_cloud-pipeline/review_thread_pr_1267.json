{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NjQxOTk0", "number": 1267, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxNjo0OVrOEeWb2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMToxMjowNVrOEf8SCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjYwMzE0OnYy", "diffSide": "RIGHT", "path": "deploy/docker/cp-edge/sync-routes.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxNjo0OVrOHJ9ENQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzowODoxNVrOHKBM-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5OTczMw==", "bodyText": "The PipelineRunParameter object hasn't friendly_name field. So, this line may lead to KeyError.", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r480199733", "createdAt": "2020-08-31T15:16:49Z", "author": {"login": "ekazachkova"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -245,24 +246,41 @@ def search_custom_domain_cert(domain):\n         if not cert_path or not key_path:\n                 cert_path = pki_default_cert\n                 key_path = pki_default_cert_key\n-        \n+\n         print('Certificate:Key for {} will be used: {}:{}'.format(domain, cert_path, key_path))\n         return (cert_path, key_path)\n \n-# FIXME: once we'll get more than one \"system endpoint\" - a list of such endpoints shall be moved to the configuration\n-SYSTEM_ENDPOINTS={ \"CP_CAP_SPARK\": { \n-                        \"value\": \"true\", \n-                        \"endpoint\": str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_PORT\", \"8088\")), \n-                        \"endpoint_num\":  str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_ENDPOINT_ID\", \"1000\")),\n-                        \"friendly_name\": \"SparkUI\" }}\n+def read_system_endpoints():\n+        system_endpoints = {}\n+        with open(nginx_system_endpoints_config_path, 'r') as system_endpoints_file:\n+                system_endpoints_list = json.load(system_endpoints_file)\n+                for endpoint in system_endpoints_list:\n+                        system_endpoints[endpoint['name']] = {\n+                                \"value\": \"true\",\n+                                \"endpoint\": str(os.environ.get(endpoint['endpoint_env'],\n+                                                               endpoint['endpoint_default'])),\n+                                \"endpoint_num\":  str(os.environ.get(endpoint['endpoint_num_env'],\n+                                                                    endpoint['endpoint_num_default'])),\n+                                \"friendly_name\": endpoint['friendly_name']\n+                        }\n+        return system_endpoints\n+\n+SYSTEM_ENDPOINTS = read_system_endpoints()\n+\n def append_system_endpoints(tool_endpoints, run_details):\n         if not tool_endpoints:\n                 tool_endpoints = []\n         system_endpoints_params = SYSTEM_ENDPOINTS.keys()\n+        tool_endpoints_dict = {}\n+        for endpoint in tool_endpoints:\n+                endpoint_obj = json.loads(endpoint)\n+                tool_endpoints_dict[endpoint_obj['name']] = endpoint_obj['nginx']['port']\n         if run_details and \"pipelineRunParameters\" in run_details:\n                 # Get a list of endpoints from SYSTEM_ENDPOINTS which match the run's parameters (param name and a value)\n-                system_endpoints_matched = [SYSTEM_ENDPOINTS[x[\"name\"]] for x in run_details[\"pipelineRunParameters\"] \n-                                                if x[\"name\"] in system_endpoints_params \n+                system_endpoints_matched = [SYSTEM_ENDPOINTS[x[\"name\"]] for x in run_details[\"pipelineRunParameters\"]\n+                                                if x[\"name\"] in system_endpoints_params\n+                                                   and (x[\"friendly_name\"] not in tool_endpoints_dict", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f59c0342745ced734c89cbbabdb26b36afb96e"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2NzUxMw==", "bodyText": "Done, x in this and the following line is replaced with SYSTEM_ENDPOINTS[x[\"name\"]]", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r480267513", "createdAt": "2020-08-31T17:08:15Z", "author": {"login": "Wedds"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -245,24 +246,41 @@ def search_custom_domain_cert(domain):\n         if not cert_path or not key_path:\n                 cert_path = pki_default_cert\n                 key_path = pki_default_cert_key\n-        \n+\n         print('Certificate:Key for {} will be used: {}:{}'.format(domain, cert_path, key_path))\n         return (cert_path, key_path)\n \n-# FIXME: once we'll get more than one \"system endpoint\" - a list of such endpoints shall be moved to the configuration\n-SYSTEM_ENDPOINTS={ \"CP_CAP_SPARK\": { \n-                        \"value\": \"true\", \n-                        \"endpoint\": str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_PORT\", \"8088\")), \n-                        \"endpoint_num\":  str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_ENDPOINT_ID\", \"1000\")),\n-                        \"friendly_name\": \"SparkUI\" }}\n+def read_system_endpoints():\n+        system_endpoints = {}\n+        with open(nginx_system_endpoints_config_path, 'r') as system_endpoints_file:\n+                system_endpoints_list = json.load(system_endpoints_file)\n+                for endpoint in system_endpoints_list:\n+                        system_endpoints[endpoint['name']] = {\n+                                \"value\": \"true\",\n+                                \"endpoint\": str(os.environ.get(endpoint['endpoint_env'],\n+                                                               endpoint['endpoint_default'])),\n+                                \"endpoint_num\":  str(os.environ.get(endpoint['endpoint_num_env'],\n+                                                                    endpoint['endpoint_num_default'])),\n+                                \"friendly_name\": endpoint['friendly_name']\n+                        }\n+        return system_endpoints\n+\n+SYSTEM_ENDPOINTS = read_system_endpoints()\n+\n def append_system_endpoints(tool_endpoints, run_details):\n         if not tool_endpoints:\n                 tool_endpoints = []\n         system_endpoints_params = SYSTEM_ENDPOINTS.keys()\n+        tool_endpoints_dict = {}\n+        for endpoint in tool_endpoints:\n+                endpoint_obj = json.loads(endpoint)\n+                tool_endpoints_dict[endpoint_obj['name']] = endpoint_obj['nginx']['port']\n         if run_details and \"pipelineRunParameters\" in run_details:\n                 # Get a list of endpoints from SYSTEM_ENDPOINTS which match the run's parameters (param name and a value)\n-                system_endpoints_matched = [SYSTEM_ENDPOINTS[x[\"name\"]] for x in run_details[\"pipelineRunParameters\"] \n-                                                if x[\"name\"] in system_endpoints_params \n+                system_endpoints_matched = [SYSTEM_ENDPOINTS[x[\"name\"]] for x in run_details[\"pipelineRunParameters\"]\n+                                                if x[\"name\"] in system_endpoints_params\n+                                                   and (x[\"friendly_name\"] not in tool_endpoints_dict", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5OTczMw=="}, "originalCommit": {"oid": "02f59c0342745ced734c89cbbabdb26b36afb96e"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjcyNDQ2OnYy", "diffSide": "RIGHT", "path": "deploy/docker/cp-edge/sync-routes.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNTo0Mjo1NFrOHJ-K4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzowODo1OFrOHKBOZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIxNzgyNQ==", "bodyText": "May the endpoint_obj['nginx'] returns None? ( check for that case )", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r480217825", "createdAt": "2020-08-31T15:42:54Z", "author": {"login": "ekazachkova"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -245,24 +246,41 @@ def search_custom_domain_cert(domain):\n         if not cert_path or not key_path:\n                 cert_path = pki_default_cert\n                 key_path = pki_default_cert_key\n-        \n+\n         print('Certificate:Key for {} will be used: {}:{}'.format(domain, cert_path, key_path))\n         return (cert_path, key_path)\n \n-# FIXME: once we'll get more than one \"system endpoint\" - a list of such endpoints shall be moved to the configuration\n-SYSTEM_ENDPOINTS={ \"CP_CAP_SPARK\": { \n-                        \"value\": \"true\", \n-                        \"endpoint\": str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_PORT\", \"8088\")), \n-                        \"endpoint_num\":  str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_ENDPOINT_ID\", \"1000\")),\n-                        \"friendly_name\": \"SparkUI\" }}\n+def read_system_endpoints():\n+        system_endpoints = {}\n+        with open(nginx_system_endpoints_config_path, 'r') as system_endpoints_file:\n+                system_endpoints_list = json.load(system_endpoints_file)\n+                for endpoint in system_endpoints_list:\n+                        system_endpoints[endpoint['name']] = {\n+                                \"value\": \"true\",\n+                                \"endpoint\": str(os.environ.get(endpoint['endpoint_env'],\n+                                                               endpoint['endpoint_default'])),\n+                                \"endpoint_num\":  str(os.environ.get(endpoint['endpoint_num_env'],\n+                                                                    endpoint['endpoint_num_default'])),\n+                                \"friendly_name\": endpoint['friendly_name']\n+                        }\n+        return system_endpoints\n+\n+SYSTEM_ENDPOINTS = read_system_endpoints()\n+\n def append_system_endpoints(tool_endpoints, run_details):\n         if not tool_endpoints:\n                 tool_endpoints = []\n         system_endpoints_params = SYSTEM_ENDPOINTS.keys()\n+        tool_endpoints_dict = {}\n+        for endpoint in tool_endpoints:\n+                endpoint_obj = json.loads(endpoint)\n+                tool_endpoints_dict[endpoint_obj['name']] = endpoint_obj['nginx']['port']", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f59c0342745ced734c89cbbabdb26b36afb96e"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2Nzg3Ng==", "bodyText": "Done, checking if both name and nginx are presented in the endpoint_obj after conversion from JSON", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r480267876", "createdAt": "2020-08-31T17:08:58Z", "author": {"login": "Wedds"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -245,24 +246,41 @@ def search_custom_domain_cert(domain):\n         if not cert_path or not key_path:\n                 cert_path = pki_default_cert\n                 key_path = pki_default_cert_key\n-        \n+\n         print('Certificate:Key for {} will be used: {}:{}'.format(domain, cert_path, key_path))\n         return (cert_path, key_path)\n \n-# FIXME: once we'll get more than one \"system endpoint\" - a list of such endpoints shall be moved to the configuration\n-SYSTEM_ENDPOINTS={ \"CP_CAP_SPARK\": { \n-                        \"value\": \"true\", \n-                        \"endpoint\": str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_PORT\", \"8088\")), \n-                        \"endpoint_num\":  str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_ENDPOINT_ID\", \"1000\")),\n-                        \"friendly_name\": \"SparkUI\" }}\n+def read_system_endpoints():\n+        system_endpoints = {}\n+        with open(nginx_system_endpoints_config_path, 'r') as system_endpoints_file:\n+                system_endpoints_list = json.load(system_endpoints_file)\n+                for endpoint in system_endpoints_list:\n+                        system_endpoints[endpoint['name']] = {\n+                                \"value\": \"true\",\n+                                \"endpoint\": str(os.environ.get(endpoint['endpoint_env'],\n+                                                               endpoint['endpoint_default'])),\n+                                \"endpoint_num\":  str(os.environ.get(endpoint['endpoint_num_env'],\n+                                                                    endpoint['endpoint_num_default'])),\n+                                \"friendly_name\": endpoint['friendly_name']\n+                        }\n+        return system_endpoints\n+\n+SYSTEM_ENDPOINTS = read_system_endpoints()\n+\n def append_system_endpoints(tool_endpoints, run_details):\n         if not tool_endpoints:\n                 tool_endpoints = []\n         system_endpoints_params = SYSTEM_ENDPOINTS.keys()\n+        tool_endpoints_dict = {}\n+        for endpoint in tool_endpoints:\n+                endpoint_obj = json.loads(endpoint)\n+                tool_endpoints_dict[endpoint_obj['name']] = endpoint_obj['nginx']['port']", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIxNzgyNQ=="}, "originalCommit": {"oid": "02f59c0342745ced734c89cbbabdb26b36afb96e"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxOTEwODk5OnYy", "diffSide": "RIGHT", "path": "deploy/docker/cp-edge/sync-routes.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDoxOToxMFrOHMgEEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMjo0MDozMFrOHMksqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDI5MQ==", "bodyText": "Lets continue to use naming convention lower_case_with_underscores in this script", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482870291", "createdAt": "2020-09-03T10:19:10Z", "author": {"login": "ekazachkova"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0NjIxOA==", "bodyText": "Done", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482946218", "createdAt": "2020-09-03T12:40:30Z", "author": {"login": "Wedds"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDI5MQ=="}, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxOTEwOTcxOnYy", "diffSide": "RIGHT", "path": "deploy/docker/cp-edge/sync-routes.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDoxOToyMFrOHMgEfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMjo0MDozNFrOHMks6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDM5Nw==", "bodyText": "Lets continue to use naming convention lower_case_with_underscores in this script", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482870397", "createdAt": "2020-09-03T10:19:20Z", "author": {"login": "ekazachkova"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\\n+                                remove_from_tool_endpoints_if_fully_matches(system_endpoint_name,\n+                                                                            system_endpoint_port, tool_endpoints)\n+                        tool_endpoint[\"isDefault\"] = str(isDefaultEndpoint).lower()\n+                        if modified_count != 0:\n+                                tool_endpoints = modified_tool_endpoints\n+                                modified_endpoints_count += modified_count\n                         tool_endpoints.append(json.dumps(tool_endpoint))\n-        return tool_endpoints \n+        return tool_endpoints, modified_endpoints_count\n+\n+\n+def remove_from_tool_endpoints_if_fully_matches(endpoint_name, endpoint_port, tool_endpoints):\n+        tools_endpoints_wo_matches = []\n+        endpoints_modified = 0\n+        isModifiedDefault = False", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0NjI4Mg==", "bodyText": "Done", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482946282", "createdAt": "2020-09-03T12:40:34Z", "author": {"login": "Wedds"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\\n+                                remove_from_tool_endpoints_if_fully_matches(system_endpoint_name,\n+                                                                            system_endpoint_port, tool_endpoints)\n+                        tool_endpoint[\"isDefault\"] = str(isDefaultEndpoint).lower()\n+                        if modified_count != 0:\n+                                tool_endpoints = modified_tool_endpoints\n+                                modified_endpoints_count += modified_count\n                         tool_endpoints.append(json.dumps(tool_endpoint))\n-        return tool_endpoints \n+        return tool_endpoints, modified_endpoints_count\n+\n+\n+def remove_from_tool_endpoints_if_fully_matches(endpoint_name, endpoint_port, tool_endpoints):\n+        tools_endpoints_wo_matches = []\n+        endpoints_modified = 0\n+        isModifiedDefault = False", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDM5Nw=="}, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxOTExMjQxOnYy", "diffSide": "RIGHT", "path": "deploy/docker/cp-edge/sync-routes.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDoyMDowNFrOHMgGGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMjo0MDo0M1rOHMktSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDgxMA==", "bodyText": "Is it correct field name?", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482870810", "createdAt": "2020-09-03T10:20:04Z", "author": {"login": "ekazachkova"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\\n+                                remove_from_tool_endpoints_if_fully_matches(system_endpoint_name,\n+                                                                            system_endpoint_port, tool_endpoints)\n+                        tool_endpoint[\"isDefault\"] = str(isDefaultEndpoint).lower()\n+                        if modified_count != 0:\n+                                tool_endpoints = modified_tool_endpoints\n+                                modified_endpoints_count += modified_count\n                         tool_endpoints.append(json.dumps(tool_endpoint))\n-        return tool_endpoints \n+        return tool_endpoints, modified_endpoints_count\n+\n+\n+def remove_from_tool_endpoints_if_fully_matches(endpoint_name, endpoint_port, tool_endpoints):\n+        tools_endpoints_wo_matches = []", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0NjM3OQ==", "bodyText": "Renamed to more suitable non_matching_tool_endpoints", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482946379", "createdAt": "2020-09-03T12:40:43Z", "author": {"login": "Wedds"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\\n+                                remove_from_tool_endpoints_if_fully_matches(system_endpoint_name,\n+                                                                            system_endpoint_port, tool_endpoints)\n+                        tool_endpoint[\"isDefault\"] = str(isDefaultEndpoint).lower()\n+                        if modified_count != 0:\n+                                tool_endpoints = modified_tool_endpoints\n+                                modified_endpoints_count += modified_count\n                         tool_endpoints.append(json.dumps(tool_endpoint))\n-        return tool_endpoints \n+        return tool_endpoints, modified_endpoints_count\n+\n+\n+def remove_from_tool_endpoints_if_fully_matches(endpoint_name, endpoint_port, tool_endpoints):\n+        tools_endpoints_wo_matches = []", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDgxMA=="}, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxOTI2NTUxOnYy", "diffSide": "RIGHT", "path": "deploy/docker/cp-edge/sync-routes.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMTowNDo1MFrOHMhhRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMjo0Mjo0OFrOHMkyIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NDE0OQ==", "bodyText": "Should we add check 'spec' and 'containers' for existence and pod['spec']['containers'][0] for not null?", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482894149", "createdAt": "2020-09-03T11:04:50Z", "author": {"login": "ekazachkova"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -412,17 +463,35 @@ def get_service_list(pod_id, pod_run_id, pod_ip):\n         print('EDGE service port: ' + str(edge_service_port))\n         print('EDGE service ip: ' + edge_service_external_ip)\n \n-# From each pod with \"job-type=Service\"  we shall take:\n+# From each pod with a container, which has endpoints (\"job-type=Service\" or container's environment\n+# has a parameter from SYSTEM_ENDPOINTS) we shall take:\n # -- PodIP\n # -- PodID\n # -- N entries by a template\n # --- svc-port-N\n # --- svc-path-N\n-pods = Pod.objects(kube_api).filter(selector={'job-type': 'Service'})\\\n-                            .filter(field_selector={\"status.phase\": \"Running\"})\n+\n+def load_pods_for_runs_with_endpoints():\n+        pods_with_endpoints = []\n+        all_pipeline_pods = Pod.objects(kube_api).filter(selector={'type': 'pipeline'})\\\n+                                                 .filter(field_selector={\"status.phase\": \"Running\"})\n+        for pod in all_pipeline_pods.response['items']:\n+                labels = pod['metadata']['labels']\n+                if 'job-type' in labels and labels['job-type'] == 'Service':\n+                        pods_with_endpoints.append(pod)\n+                        continue\n+                pipeline_env_parameters = pod['spec']['containers'][0]['env']", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 293}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0NzYxNw==", "bodyText": "Done, perform additional checks, that response structure is as expected", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482947617", "createdAt": "2020-09-03T12:42:48Z", "author": {"login": "Wedds"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -412,17 +463,35 @@ def get_service_list(pod_id, pod_run_id, pod_ip):\n         print('EDGE service port: ' + str(edge_service_port))\n         print('EDGE service ip: ' + edge_service_external_ip)\n \n-# From each pod with \"job-type=Service\"  we shall take:\n+# From each pod with a container, which has endpoints (\"job-type=Service\" or container's environment\n+# has a parameter from SYSTEM_ENDPOINTS) we shall take:\n # -- PodIP\n # -- PodID\n # -- N entries by a template\n # --- svc-port-N\n # --- svc-path-N\n-pods = Pod.objects(kube_api).filter(selector={'job-type': 'Service'})\\\n-                            .filter(field_selector={\"status.phase\": \"Running\"})\n+\n+def load_pods_for_runs_with_endpoints():\n+        pods_with_endpoints = []\n+        all_pipeline_pods = Pod.objects(kube_api).filter(selector={'type': 'pipeline'})\\\n+                                                 .filter(field_selector={\"status.phase\": \"Running\"})\n+        for pod in all_pipeline_pods.response['items']:\n+                labels = pod['metadata']['labels']\n+                if 'job-type' in labels and labels['job-type'] == 'Service':\n+                        pods_with_endpoints.append(pod)\n+                        continue\n+                pipeline_env_parameters = pod['spec']['containers'][0]['env']", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NDE0OQ=="}, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 293}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxOTI4OTcwOnYy", "diffSide": "RIGHT", "path": "deploy/docker/cp-edge/sync-routes.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMToxMjowNVrOHMhv6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMjo0NDoxNVrOHMk1fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5Nzg5OA==", "bodyText": "According to this naming, it looks like modified_count = len(modified_tool_endpoints) but this is not true. Maybe we should make more understandable names?", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482897898", "createdAt": "2020-09-03T11:12:05Z", "author": {"login": "ekazachkova"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0ODQ3Nw==", "bodyText": "More convenient prefixes are used for those values", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482948477", "createdAt": "2020-09-03T12:44:15Z", "author": {"login": "Wedds"}, "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5Nzg5OA=="}, "originalCommit": {"oid": "644107be4154dec33719986a6560c950ee9c5cad"}, "originalPosition": 97}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 417, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}