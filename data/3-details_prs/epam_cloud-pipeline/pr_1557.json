{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NjI3NDk4", "number": 1557, "title": "Issue 1556 Introduce new AzureEAPriceListLoader", "bodyText": "Related to #1556 and provide realization of new Azure price-sheet loader", "createdAt": "2020-11-10T16:53:58Z", "url": "https://github.com/epam/cloud-pipeline/pull/1557", "merged": true, "mergeCommit": {"oid": "3b668ef7b5bff2158d167463f533f78e7ab73953"}, "closed": true, "closedAt": "2020-11-18T10:58:27Z", "author": {"login": "SilinPavel"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbMWF_gBqjM5Nzk5NTYwMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddrxAUgH2gAyNTE4NjI3NDk4OjZhNmZjMGEzZTBmNzQ2YWVhYzNkZGIyZjllODYyODhkNzE2ZDlhY2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "890da2a413dfdf17497488b2dfd8bf5fd8ce86eb", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/890da2a413dfdf17497488b2dfd8bf5fd8ce86eb", "committedDate": "2020-11-10T16:51:38Z", "message": "issue 1556 Introduce new AzureEAPriceListLoader"}, "afterCommit": {"oid": "e369e838278d5eaa6d880305782d51903764e617", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/e369e838278d5eaa6d880305782d51903764e617", "committedDate": "2020-11-10T16:55:48Z", "message": "issue 1556 Introduce new AzureEAPriceListLoader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19ade9c0fce49ae1807c71c863b5fd628be7523f", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/19ade9c0fce49ae1807c71c863b5fd628be7523f", "committedDate": "2020-11-12T15:18:16Z", "message": "issue 1556 do not filter EA prices by currency"}, "afterCommit": {"oid": "343331754a7906dacb43c9087cae5cea5e95f18c", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/343331754a7906dacb43c9087cae5cea5e95f18c", "committedDate": "2020-11-12T15:20:22Z", "message": "issue 1556 do not filter EA prices by currency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c89bce6fdb3545d7c4857d517a4fc03ec519c02", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7c89bce6fdb3545d7c4857d517a4fc03ec519c02", "committedDate": "2020-11-12T15:21:49Z", "message": "issue 1556 Introduce new AzureEAPriceListLoader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc900510d5de49b24a5debe147fc92a30e088c0", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/cdc900510d5de49b24a5debe147fc92a30e088c0", "committedDate": "2020-11-12T15:21:49Z", "message": "issue 1556 do not filter EA prices by currency"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "343331754a7906dacb43c9087cae5cea5e95f18c", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/343331754a7906dacb43c9087cae5cea5e95f18c", "committedDate": "2020-11-12T15:20:22Z", "message": "issue 1556 do not filter EA prices by currency"}, "afterCommit": {"oid": "cdc900510d5de49b24a5debe147fc92a30e088c0", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/cdc900510d5de49b24a5debe147fc92a30e088c0", "committedDate": "2020-11-12T15:21:49Z", "message": "issue 1556 do not filter EA prices by currency"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3e745d3681b5d045079ab1244e8270ed8d0ccb2", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/a3e745d3681b5d045079ab1244e8270ed8d0ccb2", "committedDate": "2020-11-13T12:01:25Z", "message": "issue #1556 add new field enterpriseAgreement to be used it AzureRegion billing"}, "afterCommit": {"oid": "838d003ae92e83323a6cc24c98df6038bf50d311", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/838d003ae92e83323a6cc24c98df6038bf50d311", "committedDate": "2020-11-13T12:35:45Z", "message": "issue #1556 add new field enterpriseAgreement to be used it AzureRegion billing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc3e6c35b035f2166ab1e300ec45e9a51711c421", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/cc3e6c35b035f2166ab1e300ec45e9a51711c421", "committedDate": "2020-11-13T14:41:16Z", "message": "issue #1556 add new field enterpriseAgreement to be used it AzureRegion billing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "838d003ae92e83323a6cc24c98df6038bf50d311", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/838d003ae92e83323a6cc24c98df6038bf50d311", "committedDate": "2020-11-13T12:35:45Z", "message": "issue #1556 add new field enterpriseAgreement to be used it AzureRegion billing"}, "afterCommit": {"oid": "cc3e6c35b035f2166ab1e300ec45e9a51711c421", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/cc3e6c35b035f2166ab1e300ec45e9a51711c421", "committedDate": "2020-11-13T14:41:16Z", "message": "issue #1556 add new field enterpriseAgreement to be used it AzureRegion billing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/997dade7e67139c3b37de6eae024bd4c6f91a0c2", "committedDate": "2020-11-16T09:25:22Z", "message": "Introduce new way to load Azure price sheet with EA API (#1556) - 'Enterprise Agreement' flag for Azure regions (GUI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMzQ3NTI3", "url": "https://github.com/epam/cloud-pipeline/pull/1557#pullrequestreview-531347527", "createdAt": "2020-11-16T14:03:52Z", "commit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNDowMzo1MlrOH0AGHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNDozMToxNFrOH0BTsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4OTU2NQ==", "bodyText": "Please, do not user star import", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524289565", "createdAt": "2020-11-16T14:03:52Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/entity/pricing/azure/AzureEAPricingMeter.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.entity.pricing.azure;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5NjQxOQ==", "bodyText": "Do we need @JsonProperty annotation if its value matches field name?", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524296419", "createdAt": "2020-11-16T14:13:57Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/entity/pricing/azure/AzureEAPricingMeter.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.entity.pricing.azure;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.*;\n+\n+import java.util.Map;\n+\n+@NoArgsConstructor\n+@Data\n+@Builder\n+@AllArgsConstructor\n+public class AzureEAPricingMeter {\n+    @JsonProperty(value = \"meterId\")\n+    private String meterId;\n+    @JsonProperty(value = \"currencyCode\")\n+    private String currencyCode;\n+    @JsonProperty(value = \"unitOfMeasure\")\n+    private String unit;\n+    @JsonProperty(value = \"unitPrice\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5NjY5MA==", "bodyText": "Missing final on args", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524296690", "createdAt": "2020-11-16T14:14:21Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/entity/pricing/azure/AzureEAPricingMeter.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.entity.pricing.azure;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.*;\n+\n+import java.util.Map;\n+\n+@NoArgsConstructor\n+@Data\n+@Builder\n+@AllArgsConstructor\n+public class AzureEAPricingMeter {\n+    @JsonProperty(value = \"meterId\")\n+    private String meterId;\n+    @JsonProperty(value = \"currencyCode\")\n+    private String currencyCode;\n+    @JsonProperty(value = \"unitOfMeasure\")\n+    private String unit;\n+    @JsonProperty(value = \"unitPrice\")\n+    private Float unitPrice;\n+\n+    private String meterCategory;\n+    private String meterSubCategory;\n+    private String meterName;\n+    private String meterRegion;\n+\n+    @JsonProperty(value = \"meterDetails\")\n+    public void unpackMeterDetails(Map<String, String> meterDetails) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5Njk5Mg==", "bodyText": "Missing final on args", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524296992", "createdAt": "2020-11-16T14:14:43Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/entity/pricing/azure/AzureEAPricingResult.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.entity.pricing.azure;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+\n+import java.util.List;\n+\n+@NoArgsConstructor\n+@AllArgsConstructor\n+@Data\n+@Builder\n+public class AzureEAPricingResult {\n+    @JsonProperty(value = \"properties\")\n+    private PricingProperties properties;\n+\n+    @Data\n+    @Builder\n+    @NoArgsConstructor\n+    public static class PricingProperties {\n+\n+        public PricingProperties(String nextLink, List<AzureEAPricingMeter> pricesheets) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5NzIyNA==", "bodyText": "Please, do not user star import", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524297224", "createdAt": "2020-11-16T14:15:00Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/cloud/azure/AbstractAzurePriceListLoader.java", "diffHunk": "@@ -0,0 +1,252 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.azure;\n+\n+\n+import com.epam.pipeline.entity.cluster.InstanceOffer;\n+import com.epam.pipeline.entity.region.AbstractCloudRegion;\n+import com.epam.pipeline.entity.region.CloudProvider;\n+import com.epam.pipeline.manager.cloud.CloudInstancePriceService;\n+import com.epam.pipeline.manager.datastorage.providers.azure.AzureHelper;\n+import com.microsoft.azure.credentials.ApplicationTokenCredentials;\n+import com.microsoft.azure.credentials.AzureTokenCredentials;\n+import com.microsoft.azure.management.Azure;\n+import com.microsoft.azure.management.compute.ComputeResourceType;\n+import com.microsoft.azure.management.compute.ResourceSkuCapabilities;\n+import com.microsoft.azure.management.compute.ResourceSkuRestrictionsReasonCode;\n+import com.microsoft.azure.management.compute.implementation.ResourceSkuInner;\n+import com.microsoft.azure.management.resources.fluentcore.arm.Region;\n+import com.microsoft.azure.management.resources.fluentcore.model.HasInner;\n+import org.apache.commons.collections4.ListUtils;\n+import org.apache.commons.collections4.MapUtils;\n+import org.apache.commons.lang.StringUtils;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5Nzk5Mw==", "bodyText": "Missing final on args", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524297993", "createdAt": "2020-11-16T14:16:07Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/cloud/azure/AbstractAzurePriceListLoader.java", "diffHunk": "@@ -0,0 +1,252 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.azure;\n+\n+\n+import com.epam.pipeline.entity.cluster.InstanceOffer;\n+import com.epam.pipeline.entity.region.AbstractCloudRegion;\n+import com.epam.pipeline.entity.region.CloudProvider;\n+import com.epam.pipeline.manager.cloud.CloudInstancePriceService;\n+import com.epam.pipeline.manager.datastorage.providers.azure.AzureHelper;\n+import com.microsoft.azure.credentials.ApplicationTokenCredentials;\n+import com.microsoft.azure.credentials.AzureTokenCredentials;\n+import com.microsoft.azure.management.Azure;\n+import com.microsoft.azure.management.compute.ComputeResourceType;\n+import com.microsoft.azure.management.compute.ResourceSkuCapabilities;\n+import com.microsoft.azure.management.compute.ResourceSkuRestrictionsReasonCode;\n+import com.microsoft.azure.management.compute.implementation.ResourceSkuInner;\n+import com.microsoft.azure.management.resources.fluentcore.arm.Region;\n+import com.microsoft.azure.management.resources.fluentcore.model.HasInner;\n+import org.apache.commons.collections4.ListUtils;\n+import org.apache.commons.collections4.MapUtils;\n+import org.apache.commons.lang.StringUtils;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static com.epam.pipeline.manager.cloud.CloudInstanceService.log;\n+\n+public abstract class AbstractAzurePriceListLoader {\n+\n+    public static final String LOCALE = \"en-US\";\n+    public static final String REGION_INFO = \"US\";\n+    public static final String WINDOWS_OS = \"Windows\";\n+    public static final String LINUX_OS = \"Linux\";\n+    public static final String V_CPU_CAPABILITY = \"vCPUs\";\n+    public static final String GPU_CAPABILITY = \"GPUs\";\n+    public static final String MEMORY_CAPABILITY = \"MemoryGB\";\n+    public static final String IS_PREMIUM_CAPABILITY = \"PremiumIO\";\n+    public static final String DISK_SIZE_CAPABILITY = \"MaxSizeGiB\";\n+    public static final String PROMO = \"Promo\";\n+    public static final String STANDARD = \"Standard\";\n+    public static final String BASIC = \"Basic\";\n+    public static final String DISK_INDICATOR = \"Disks\";\n+    public static final String VIRTUAL_MACHINES_CATEGORY = \"Virtual Machines\";\n+    public static final String DISKS_CATEGORY = \"Storage\";\n+    public static final String LOW_PRIORITY_VM_POSTFIX = \" Low Priority\";\n+    public static final String DELIMITER = \"/\";\n+    public static final String AZURE_PRICING_FILTERS =\n+            \"OfferDurableId eq '%s' and Currency eq '%s' and Locale eq '%s' and RegionInfo eq '%s'\";\n+    public static final int READ_TIMEOUT = 60;\n+    public static final int CONNECT_TIMEOUT = 60;\n+    public static final String GENERAL_PURPOSE_FAMILY = \"General purpose\";\n+    public static final String GPU_FAMILY = \"GPU instance\";\n+    public static final double DEFAULT_PRICE = 0.0;\n+    public static final String LOW_PRIORITY_CAPABLE = \"LowPriorityCapable\";\n+    public static final String TRUE = \"True\";\n+    public static final String DEFAULT_DISK_UNIT = \"1/Month\";\n+\n+    protected final String meterRegionName;\n+    protected final String azureApiUrl;\n+    protected final String authPath;\n+\n+    protected AbstractAzurePriceListLoader(String meterRegionName, String azureApiUrl, String authPath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5ODg5Ng==", "bodyText": "Missing final on args", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524298896", "createdAt": "2020-11-16T14:17:24Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/cloud/azure/AbstractAzurePriceListLoader.java", "diffHunk": "@@ -0,0 +1,252 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.azure;\n+\n+\n+import com.epam.pipeline.entity.cluster.InstanceOffer;\n+import com.epam.pipeline.entity.region.AbstractCloudRegion;\n+import com.epam.pipeline.entity.region.CloudProvider;\n+import com.epam.pipeline.manager.cloud.CloudInstancePriceService;\n+import com.epam.pipeline.manager.datastorage.providers.azure.AzureHelper;\n+import com.microsoft.azure.credentials.ApplicationTokenCredentials;\n+import com.microsoft.azure.credentials.AzureTokenCredentials;\n+import com.microsoft.azure.management.Azure;\n+import com.microsoft.azure.management.compute.ComputeResourceType;\n+import com.microsoft.azure.management.compute.ResourceSkuCapabilities;\n+import com.microsoft.azure.management.compute.ResourceSkuRestrictionsReasonCode;\n+import com.microsoft.azure.management.compute.implementation.ResourceSkuInner;\n+import com.microsoft.azure.management.resources.fluentcore.arm.Region;\n+import com.microsoft.azure.management.resources.fluentcore.model.HasInner;\n+import org.apache.commons.collections4.ListUtils;\n+import org.apache.commons.collections4.MapUtils;\n+import org.apache.commons.lang.StringUtils;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.*;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static com.epam.pipeline.manager.cloud.CloudInstanceService.log;\n+\n+public abstract class AbstractAzurePriceListLoader {\n+\n+    public static final String LOCALE = \"en-US\";\n+    public static final String REGION_INFO = \"US\";\n+    public static final String WINDOWS_OS = \"Windows\";\n+    public static final String LINUX_OS = \"Linux\";\n+    public static final String V_CPU_CAPABILITY = \"vCPUs\";\n+    public static final String GPU_CAPABILITY = \"GPUs\";\n+    public static final String MEMORY_CAPABILITY = \"MemoryGB\";\n+    public static final String IS_PREMIUM_CAPABILITY = \"PremiumIO\";\n+    public static final String DISK_SIZE_CAPABILITY = \"MaxSizeGiB\";\n+    public static final String PROMO = \"Promo\";\n+    public static final String STANDARD = \"Standard\";\n+    public static final String BASIC = \"Basic\";\n+    public static final String DISK_INDICATOR = \"Disks\";\n+    public static final String VIRTUAL_MACHINES_CATEGORY = \"Virtual Machines\";\n+    public static final String DISKS_CATEGORY = \"Storage\";\n+    public static final String LOW_PRIORITY_VM_POSTFIX = \" Low Priority\";\n+    public static final String DELIMITER = \"/\";\n+    public static final String AZURE_PRICING_FILTERS =\n+            \"OfferDurableId eq '%s' and Currency eq '%s' and Locale eq '%s' and RegionInfo eq '%s'\";\n+    public static final int READ_TIMEOUT = 60;\n+    public static final int CONNECT_TIMEOUT = 60;\n+    public static final String GENERAL_PURPOSE_FAMILY = \"General purpose\";\n+    public static final String GPU_FAMILY = \"GPU instance\";\n+    public static final double DEFAULT_PRICE = 0.0;\n+    public static final String LOW_PRIORITY_CAPABLE = \"LowPriorityCapable\";\n+    public static final String TRUE = \"True\";\n+    public static final String DEFAULT_DISK_UNIT = \"1/Month\";\n+\n+    protected final String meterRegionName;\n+    protected final String azureApiUrl;\n+    protected final String authPath;\n+\n+    protected AbstractAzurePriceListLoader(String meterRegionName, String azureApiUrl, String authPath) {\n+        this.meterRegionName = meterRegionName;\n+        this.azureApiUrl = azureApiUrl;\n+        this.authPath = authPath;\n+    }\n+\n+    public List<InstanceOffer> load(final AbstractCloudRegion region) throws IOException {\n+        final AzureTokenCredentials credentials = getAzureCredentials();\n+        final Azure client = AzureHelper.buildClient(authPath);\n+\n+        final Map<String, ResourceSkuInner> vmSkusByName = client.computeSkus()\n+                .listbyRegionAndResourceType(Region.fromName(region.getRegionCode()),\n+                        ComputeResourceType.VIRTUALMACHINES)\n+                .stream()\n+                .map(HasInner::inner)\n+                .filter(sku -> Objects.nonNull(sku.name()) && isAvailableForSubscription(sku))\n+                .collect(Collectors.toMap(ResourceSkuInner::name, Function.identity()));\n+\n+        final Map<String, ResourceSkuInner> diskSkusByName = client.computeSkus()\n+                .listByResourceType(ComputeResourceType.DISKS)\n+                .stream()\n+                .map(HasInner::inner)\n+                .filter(sku -> Objects.nonNull(sku.size()) && isAvailableForSubscription(sku))\n+                .collect(Collectors.toMap(ResourceSkuInner::size, Function.identity(), (o1, o2) -> o1));\n+\n+        return getInstanceOffers(region, credentials, client, vmSkusByName, diskSkusByName);\n+    }\n+\n+    protected abstract List<InstanceOffer> getInstanceOffers(AbstractCloudRegion region,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMwMTgyNQ==", "bodyText": "Please, do not use star import", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524301825", "createdAt": "2020-11-16T14:21:08Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/cloud/azure/AzureEAPriceListLoader.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.azure;\n+\n+import com.epam.pipeline.entity.cluster.InstanceOffer;\n+import com.epam.pipeline.entity.pricing.azure.AzureEAPricingMeter;\n+import com.epam.pipeline.entity.pricing.azure.AzureEAPricingResult;\n+import com.epam.pipeline.entity.region.AbstractCloudRegion;\n+import com.epam.pipeline.manager.cloud.CloudInstancePriceService;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.microsoft.azure.credentials.AzureTokenCredentials;\n+import com.microsoft.azure.management.Azure;\n+import com.microsoft.azure.management.compute.implementation.ResourceSkuInner;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.commons.collections.CollectionUtils;\n+import org.apache.commons.lang.StringUtils;\n+import org.springframework.util.Assert;\n+import retrofit2.Retrofit;\n+import retrofit2.converter.jackson.JacksonConverterFactory;\n+\n+import java.io.IOException;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMwMjAzNQ==", "bodyText": "Missing final on args", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524302035", "createdAt": "2020-11-16T14:21:28Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/cloud/azure/AzureEAPriceListLoader.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.azure;\n+\n+import com.epam.pipeline.entity.cluster.InstanceOffer;\n+import com.epam.pipeline.entity.pricing.azure.AzureEAPricingMeter;\n+import com.epam.pipeline.entity.pricing.azure.AzureEAPricingResult;\n+import com.epam.pipeline.entity.region.AbstractCloudRegion;\n+import com.epam.pipeline.manager.cloud.CloudInstancePriceService;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.microsoft.azure.credentials.AzureTokenCredentials;\n+import com.microsoft.azure.management.Azure;\n+import com.microsoft.azure.management.compute.implementation.ResourceSkuInner;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.commons.collections.CollectionUtils;\n+import org.apache.commons.lang.StringUtils;\n+import org.springframework.util.Assert;\n+import retrofit2.Retrofit;\n+import retrofit2.converter.jackson.JacksonConverterFactory;\n+\n+import java.io.IOException;\n+import java.util.*;\n+import java.util.concurrent.TimeUnit;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static com.epam.pipeline.manager.cloud.CloudInstancePriceService.TermType;\n+import static com.epam.pipeline.manager.cloud.azure.AzurePricingClient.executeRequest;\n+\n+@Slf4j\n+public class AzureEAPriceListLoader extends AbstractAzurePriceListLoader {\n+\n+    private static final String API_VERSION = \"2019-10-01\";\n+\n+    private final AzurePricingClient azurePricingClient;\n+\n+    public AzureEAPriceListLoader(final String authPath, String meterRegionName, final String azureApiUrl) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMwOTQyNA==", "bodyText": "It seems to me that child classes of AbstractAzurePriceListLoader have almost identical code. The main difference is in the method getPricing. Is it possible to load prices from EA and RateCard in one format (e.g. make AzureEAPricingMeter and AzurePricingMeter to implement some common interface with all required methods getMeterId, etc.)? In this case we can have a small loader classes for EA and RateCard but keep all further processing in common code.", "url": "https://github.com/epam/cloud-pipeline/pull/1557#discussion_r524309424", "createdAt": "2020-11-16T14:31:14Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/cloud/azure/AbstractAzurePriceListLoader.java", "diffHunk": "@@ -0,0 +1,252 @@\n+/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997dade7e67139c3b37de6eae024bd4c6f91a0c2"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3efa4b0e290a00eb3cac714f06632d6b6562fcdd", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/3efa4b0e290a00eb3cac714f06632d6b6562fcdd", "committedDate": "2020-11-17T09:28:57Z", "message": "issue #1556 correction on review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "507648a87996587cfb61f417ebba8ff02eb1efd9", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/507648a87996587cfb61f417ebba8ff02eb1efd9", "committedDate": "2020-11-17T09:36:26Z", "message": "issue #1556 refactor EA and RateCard loader to work with AzurePricingMeter interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b48bcd6fd8f3f7615be732d61c36b4b07b1ba56f", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b48bcd6fd8f3f7615be732d61c36b4b07b1ba56f", "committedDate": "2020-11-17T12:56:01Z", "message": "issue #1556 review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a6fc0a3e0f746aeac3ddb2f9e86288d716d9acc", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/6a6fc0a3e0f746aeac3ddb2f9e86288d716d9acc", "committedDate": "2020-11-18T10:40:29Z", "message": "issue #1556 corrections on review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3714, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}