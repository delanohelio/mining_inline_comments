{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMzA0NTM3", "number": 1660, "title": "issue #1656 fetch launch system params for the workers", "bodyText": "This PR relates to #1656 and fetch all parameters that should be pass to workers from master run", "createdAt": "2020-12-16T16:53:28Z", "url": "https://github.com/epam/cloud-pipeline/pull/1660", "merged": true, "mergeCommit": {"oid": "bd1d8c040d04c31b1642ab0c019630941abc4b3d"}, "closed": true, "closedAt": "2020-12-22T12:17:57Z", "author": {"login": "SilinPavel"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmx2CqAH2gAyNTQxMzA0NTM3OjQ3NTQ5NjI5NmE5OTc5ZDViMjU1YjhlMTVmMTUxMDg0ZWY5MjlhMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdopiYYAFqTU1NzAzNzk1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "475496296a9979d5b255b8e15f151084ef929a28", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/475496296a9979d5b255b8e15f151084ef929a28", "committedDate": "2020-12-16T16:50:44Z", "message": "issue #1656 get launch system params for the workers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b2d4870f0dec037c563d88da3f646c9a1430334", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/6b2d4870f0dec037c563d88da3f646c9a1430334", "committedDate": "2020-12-17T08:45:49Z", "message": "issue 1656 add CP_CAP_LIMIT_MOUNTS to launch.system.parameters.json"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NzA5NDYx", "url": "https://github.com/epam/cloud-pipeline/pull/1660#pullrequestreview-554709461", "createdAt": "2020-12-17T15:24:05Z", "commit": {"oid": "6b2d4870f0dec037c563d88da3f646c9a1430334"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNToyNDowNVrOIH61Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNTozNjoxOFrOIH7bIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE3NDg3NA==", "bodyText": "Could you please use ' rather than \" like in the most of the script?", "url": "https://github.com/epam/cloud-pipeline/pull/1660#discussion_r545174874", "createdAt": "2020-12-17T15:24:05Z", "author": {"login": "tcibinan"}, "path": "workflows/pipe-common/scripts/autoscale_sge.py", "diffHunk": "@@ -627,19 +627,28 @@ def _launch_additional_worker(self, instance):\n                            '--region-id %s ' \\\n                            'cluster_role worker ' \\\n                            'cluster_role_type additional ' \\\n-                           'CP_CAP_SGE false ' \\\n-                           'CP_CAP_AUTOSCALE false ' \\\n-                           'CP_CAP_AUTOSCALE_WORKERS 0 ' \\\n-                           'CP_DISABLE_RUN_ENDPOINTS true ' \\\n-                           'CP_CAP_SHARE_FS_TYPE %s ' \\\n+                           '%s' \\\n                            % (self.instance_disk, instance, self.instance_image, self.cmd_template, self.parent_run_id,\n-                              self._pipe_cli_price_type(self.price_type), self.region_id, self.shared_fs_type)\n-        if self.limit_mounts:\n-            pipe_run_command = pipe_run_command + ' CP_CAP_LIMIT_MOUNTS \"%s\"' % self.limit_mounts\n+                              self._pipe_cli_price_type(self.price_type), self.region_id, worker_launch_system_params)\n         run_id = int(self.executor.execute_to_lines(pipe_run_command)[0])\n         Logger.info('Additional worker run id is %s.' % run_id)\n         return run_id\n \n+    def fetch_worker_launch_system_params(self, parent_run):\n+        master_system_params = {param.get(\"name\"): param.get(\"resolvedValue\") for param in parent_run.get(\"pipelineRunParameters\", [])}\n+        system_launch_params_string = self.api.retrieve_preference('launch.system.parameters', default_value=\"[]\")\n+        system_launch_params = json.loads(system_launch_params_string)\n+        worker_launch_system_params = 'CP_CAP_SGE false ' \\\n+                                      'CP_CAP_AUTOSCALE false ' \\\n+                                      'CP_CAP_AUTOSCALE_WORKERS 0 ' \\\n+                                      'CP_DISABLE_RUN_ENDPOINTS true '\n+        for launch_param in system_launch_params:\n+            param_name = launch_param.get(\"name\")\n+            if launch_param.get(\"passToWorkers\", False) and param_name in master_system_params:\n+                worker_launch_system_params = worker_launch_system_params + \\\n+                                              \" {} {}\".format(param_name, master_system_params.get(param_name))\n+        return worker_launch_system_params", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b2d4870f0dec037c563d88da3f646c9a1430334"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4MDc3MQ==", "bodyText": "There is a helpful += operator for such appends.", "url": "https://github.com/epam/cloud-pipeline/pull/1660#discussion_r545180771", "createdAt": "2020-12-17T15:31:29Z", "author": {"login": "tcibinan"}, "path": "workflows/pipe-common/scripts/autoscale_sge.py", "diffHunk": "@@ -627,19 +627,28 @@ def _launch_additional_worker(self, instance):\n                            '--region-id %s ' \\\n                            'cluster_role worker ' \\\n                            'cluster_role_type additional ' \\\n-                           'CP_CAP_SGE false ' \\\n-                           'CP_CAP_AUTOSCALE false ' \\\n-                           'CP_CAP_AUTOSCALE_WORKERS 0 ' \\\n-                           'CP_DISABLE_RUN_ENDPOINTS true ' \\\n-                           'CP_CAP_SHARE_FS_TYPE %s ' \\\n+                           '%s' \\\n                            % (self.instance_disk, instance, self.instance_image, self.cmd_template, self.parent_run_id,\n-                              self._pipe_cli_price_type(self.price_type), self.region_id, self.shared_fs_type)\n-        if self.limit_mounts:\n-            pipe_run_command = pipe_run_command + ' CP_CAP_LIMIT_MOUNTS \"%s\"' % self.limit_mounts\n+                              self._pipe_cli_price_type(self.price_type), self.region_id, worker_launch_system_params)\n         run_id = int(self.executor.execute_to_lines(pipe_run_command)[0])\n         Logger.info('Additional worker run id is %s.' % run_id)\n         return run_id\n \n+    def fetch_worker_launch_system_params(self, parent_run):\n+        master_system_params = {param.get(\"name\"): param.get(\"resolvedValue\") for param in parent_run.get(\"pipelineRunParameters\", [])}\n+        system_launch_params_string = self.api.retrieve_preference('launch.system.parameters', default_value=\"[]\")\n+        system_launch_params = json.loads(system_launch_params_string)\n+        worker_launch_system_params = 'CP_CAP_SGE false ' \\\n+                                      'CP_CAP_AUTOSCALE false ' \\\n+                                      'CP_CAP_AUTOSCALE_WORKERS 0 ' \\\n+                                      'CP_DISABLE_RUN_ENDPOINTS true '\n+        for launch_param in system_launch_params:\n+            param_name = launch_param.get(\"name\")\n+            if launch_param.get(\"passToWorkers\", False) and param_name in master_system_params:\n+                worker_launch_system_params = worker_launch_system_params + \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b2d4870f0dec037c563d88da3f646c9a1430334"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4NDU0NA==", "bodyText": "It seems like a good idea to move this initialization logic to the beginning of main method. It makes the whole autoscaling launch consistent independently of changes in the system preference.", "url": "https://github.com/epam/cloud-pipeline/pull/1660#discussion_r545184544", "createdAt": "2020-12-17T15:36:18Z", "author": {"login": "tcibinan"}, "path": "workflows/pipe-common/scripts/autoscale_sge.py", "diffHunk": "@@ -617,6 +614,9 @@ def scale_up(self, resource):\n \n     def _launch_additional_worker(self, instance):\n         Logger.info('Launch additional worker.')\n+        parent_run = self.api.load_run(self.parent_run_id)\n+        worker_launch_system_params = self.fetch_worker_launch_system_params(parent_run)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b2d4870f0dec037c563d88da3f646c9a1430334"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6279634f4904a19885ed2211702c500f2ae71d9", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/e6279634f4904a19885ed2211702c500f2ae71d9", "committedDate": "2020-12-18T13:44:56Z", "message": "issue 1656 load worker args at the beginning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MTk0MTYy", "url": "https://github.com/epam/cloud-pipeline/pull/1660#pullrequestreview-556194162", "createdAt": "2020-12-21T08:07:52Z", "commit": {"oid": "e6279634f4904a19885ed2211702c500f2ae71d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MDM3OTUx", "url": "https://github.com/epam/cloud-pipeline/pull/1660#pullrequestreview-557037951", "createdAt": "2020-12-22T12:17:52Z", "commit": {"oid": "e6279634f4904a19885ed2211702c500f2ae71d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3616, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}