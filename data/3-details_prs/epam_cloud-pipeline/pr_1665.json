{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNDk3OTA4", "number": 1665, "title": "Issue #1652: VMMonitor shall handle pool nodes", "bodyText": "This PR is related to issue #1652 and enables monitor to validate nodes with non-numeric runid and existing pool_id", "createdAt": "2020-12-18T11:54:43Z", "url": "https://github.com/epam/cloud-pipeline/pull/1665", "merged": true, "mergeCommit": {"oid": "a71d92c4713f0501c9a75395df0c12417a1447cd"}, "closed": true, "closedAt": "2020-12-29T11:45:27Z", "author": {"login": "cryteq"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnWfh_AH2gAyNTQyNDk3OTA4OjA1MzEyMDliYTM4ZTk4NmJjMTc2OTQ3YTFiZTA3MTY4ZTI0YzQ0ODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq5QvsAFqTU1OTQ5NjU4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0531209ba38e986bc176947a1be07168e24c4483", "author": {"user": {"login": "cryteq", "name": "Mikhail Iniakin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/0531209ba38e986bc176947a1be07168e24c4483", "committedDate": "2020-12-18T11:32:38Z", "message": "Issue #1652: Pool entity added to common module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d30ccb6684c3dd6420676da9e47f2ce02b5550cd", "author": {"user": {"login": "cryteq", "name": "Mikhail Iniakin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/d30ccb6684c3dd6420676da9e47f2ce02b5550cd", "committedDate": "2020-12-18T11:37:10Z", "message": "Issue #1652: Pool id check added for nodes with non-numeric run id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4f96fa6f083f6e29436d9860e2a6a2a3334a224", "author": {"user": {"login": "cryteq", "name": "Mikhail Iniakin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/c4f96fa6f083f6e29436d9860e2a6a2a3334a224", "committedDate": "2020-12-18T11:38:24Z", "message": "Issue #1652: Added tests for monitor pool id check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fac095dc1ee05be0fb3b95de8f55f2e9bae035f4", "author": {"user": {"login": "cryteq", "name": "Mikhail Iniakin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/fac095dc1ee05be0fb3b95de8f55f2e9bae035f4", "committedDate": "2020-12-21T11:01:28Z", "message": "Issue #1652: pool_id label moved to properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MjM1Njc0", "url": "https://github.com/epam/cloud-pipeline/pull/1665#pullrequestreview-557235674", "createdAt": "2020-12-22T17:14:38Z", "commit": {"oid": "fac095dc1ee05be0fb3b95de8f55f2e9bae035f4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzoxNDozOFrOIKCiXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzoxNDozOFrOIKCiXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM5ODIzOQ==", "bodyText": "Pool label exists only on kubernetes nodes, so we shall check it in checkLabels method, which operates kubernetes Node instead of AWS VirtualMachine", "url": "https://github.com/epam/cloud-pipeline/pull/1665#discussion_r547398239", "createdAt": "2020-12-22T17:14:38Z", "author": {"login": "mzueva"}, "path": "vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java", "diffHunk": "@@ -102,7 +106,7 @@ private void checkVmState(final VirtualMachine vm) {\n                 checkMatchingNodes(nodes, vm);\n             } else {\n                 log.debug(\"No matching nodes were found for VM {} {}.\", vm.getInstanceId(), vm.getCloudProvider());\n-                if (!matchingRunExists(vm)) {\n+                if (!matchingRunExists(vm) && !poolIdExists(vm)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fac095dc1ee05be0fb3b95de8f55f2e9bae035f4"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67688d7804c4689aef360cd49fcd0b9d099913fd", "author": {"user": {"login": "cryteq", "name": "Mikhail Iniakin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/67688d7804c4689aef360cd49fcd0b9d099913fd", "committedDate": "2020-12-23T10:46:12Z", "message": "Issue #1652: Removed poolId check from checkVmState"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MTUwNzEw", "url": "https://github.com/epam/cloud-pipeline/pull/1665#pullrequestreview-559150710", "createdAt": "2020-12-28T13:45:00Z", "commit": {"oid": "fac095dc1ee05be0fb3b95de8f55f2e9bae035f4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMzo0NTowMVrOIL52cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMzo0NTowMVrOIL52cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM1MzA3NA==", "bodyText": "As I mentioned previously VirtualMachine  doesn't have pool label, we need to check  NodeInstance  tags instead.", "url": "https://github.com/epam/cloud-pipeline/pull/1665#discussion_r549353074", "createdAt": "2020-12-28T13:45:01Z", "author": {"login": "mzueva"}, "path": "vm-monitor/src/main/java/com/epam/pipeline/vmmonitor/service/vm/VMMonitor.java", "diffHunk": "@@ -124,6 +128,23 @@ private boolean matchingRunExists(final VirtualMachine vm) {\n         return false;\n     }\n \n+    private boolean poolIdExists(final VirtualMachine vm) {\n+        log.debug(\"Checking whether a node pool with corresponding pool id exists.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fac095dc1ee05be0fb3b95de8f55f2e9bae035f4"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c62f3734b48276f4a195c21b6446fdfa49f6b46f", "author": {"user": {"login": "cryteq", "name": "Mikhail Iniakin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/c62f3734b48276f4a195c21b6446fdfa49f6b46f", "committedDate": "2020-12-29T11:40:03Z", "message": "Issue #1652: Moved poolId label check to NodeInstance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDk2NTg1", "url": "https://github.com/epam/cloud-pipeline/pull/1665#pullrequestreview-559496585", "createdAt": "2020-12-29T11:44:56Z", "commit": {"oid": "c62f3734b48276f4a195c21b6446fdfa49f6b46f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3622, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}