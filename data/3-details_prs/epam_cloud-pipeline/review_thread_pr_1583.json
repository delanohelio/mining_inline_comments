{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MDYxNjY1", "number": 1583, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDoyMzo1OFrOE8Jwtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODoyNDo1NVrOFArqJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTA5OTQyOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/com/epam/pipeline/entity/metadata/MetadataField.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDoyMzo1OFrOH4HLCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDoyMzo1OFrOH4HLCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU5OTgxNw==", "bodyText": "Do you understand why this change resolves jackson deserialization issue? Looks like some lombok \\ jackson incompatibility. Probably we should add comment clarifying why we cannot use @AllArgsConstructor here. Additionally there seems to be no problems with NoArgsConstructor so let's use it as before.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r528599817", "createdAt": "2020-11-23T10:23:58Z", "author": {"login": "tcibinan"}, "path": "api/src/main/java/com/epam/pipeline/entity/metadata/MetadataField.java", "diffHunk": "@@ -17,21 +17,27 @@\n package com.epam.pipeline.entity.metadata;\n \n import com.fasterxml.jackson.annotation.JsonIgnore;\n-import lombok.AllArgsConstructor;\n import lombok.Getter;\n-import lombok.NoArgsConstructor;\n import lombok.Setter;\n \n @Getter\n @Setter\n-@NoArgsConstructor\n-@AllArgsConstructor\n public class MetadataField {\n     private String name;\n     @JsonIgnore\n     private String dbName;\n     private boolean predefined = false;\n \n+    public MetadataField(String name, String dbName, boolean predefined) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3fd5694de1eb9d1826bbfa1dc61a1f32735399"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTE1NjMzOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDozODozNVrOH4HtBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDozODozNVrOH4HtBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwODUxOA==", "bodyText": "Please add the proper indent", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r528608518", "createdAt": "2020-11-23T10:38:35Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "diffHunk": "@@ -0,0 +1,296 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.metadata;\n+\n+import com.epam.pipeline.controller.vo.EntityVO;\n+import com.epam.pipeline.controller.vo.MetadataVO;\n+import com.epam.pipeline.entity.metadata.MetadataEntry;\n+import com.epam.pipeline.entity.metadata.MetadataEntryWithIssuesCount;\n+import com.epam.pipeline.entity.security.acl.AclClass;\n+import com.epam.pipeline.manager.metadata.MetadataApiService;\n+import com.epam.pipeline.test.creator.CommonCreatorConstants;\n+import com.epam.pipeline.test.creator.metadata.MetadataCreatorUtils;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING_SET;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.verify;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+\n+@WebMvcTest(controllers = MetadataController.class)\n+public class MetadataControllerTest extends AbstractControllerTest {\n+\n+    private static final String METADATA_URL = SERVLET_PATH + \"/metadata\";\n+    private static final String UPDATE_KEY_URL = METADATA_URL + \"/updateKey\";\n+    private static final String UPDATE_KEYS_URL = METADATA_URL + \"/updateKeys\";\n+    private static final String UPDATE_ITEM_URL = METADATA_URL + \"/update\";\n+    private static final String LOAD_ITEMS_URL = METADATA_URL + \"/load\";\n+    private static final String KEYS_URL = METADATA_URL + \"/keys\";\n+    private static final String FIND_ENTITY_URL = METADATA_URL + \"/find\";\n+    private static final String DELETE_ITEM_URL = METADATA_URL + \"/delete\";\n+    private static final String DELETE_ITEM_KEY_URL = METADATA_URL + \"/deleteKey\";\n+    private static final String DELETE_ITEM_KEYS_URL = METADATA_URL + \"/deleteKeys\";\n+    private static final String UPLOAD_URL = METADATA_URL + \"/upload\";\n+    private static final String FOLDER_URL = METADATA_URL + \"/folder\";\n+    private static final String SEARCH_URL = METADATA_URL + \"/search\";\n+\n+    private static final String ENTITY_CLASS = \"entityClass\";\n+    private static final String ACL_CLASS = \"class\";\n+    private static final String ENTITY_NAME = \"entityName\";\n+    private static final String KEY = \"key\";\n+    private static final String VALUE = \"value\";\n+    private static final String ENTITY_ID = \"id\";\n+    private static final String MERGE_WITH_EXISTING_METADATA = \"merge\";\n+    private static final String PARENT_FOLDER_ID = \"parentFolderId\";\n+\n+    private final MetadataEntry metadataEntry = MetadataCreatorUtils.getMetadataEntry();\n+    private final MetadataVO metadataVO = MetadataCreatorUtils.getMetadataVO();\n+    private final EntityVO entityVO = MetadataCreatorUtils.getEntityVO();\n+    private final AclClass aclClass = AclClass.DATA_STORAGE;\n+    private final List<EntityVO> entityVOList = Collections.singletonList(entityVO);\n+\n+    @Autowired\n+    private MetadataApiService mockMetadataApiService;\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItemKey() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItemKey(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_KEY_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItemKey(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItemKey() {\n+        performUnauthorizedRequest(post(UPDATE_KEY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItemKeys() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItemKeys(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_KEYS_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItemKeys(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItemKeys() {\n+        performUnauthorizedRequest(post(UPDATE_KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItem() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItem(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_ITEM_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItem(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItem() {\n+        performUnauthorizedRequest(post(UPDATE_ITEM_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadMetadataItems() throws Exception {\n+        final List<MetadataEntry> metadataEntries = Collections.singletonList(metadataEntry);\n+        final String content = getObjectMapper().writeValueAsString(entityVOList);\n+        doReturn(metadataEntries).when(mockMetadataApiService).listMetadataItems(entityVOList);\n+\n+        final MvcResult mvcResult = performRequest(post(LOAD_ITEMS_URL).content(content));\n+\n+        verify(mockMetadataApiService).listMetadataItems(entityVOList);\n+        assertResponse(mvcResult, metadataEntries, MetadataCreatorUtils.METADATA_ENTRY_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadMetadataItems() {\n+        performUnauthorizedRequest(post(LOAD_ITEMS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldGetMetadataKeys() {\n+        doReturn(TEST_STRING_SET).when(mockMetadataApiService).getMetadataKeys(aclClass);\n+\n+        final MvcResult mvcResult = performRequest(get(KEYS_URL).params(multiValueMapOf(ENTITY_CLASS, aclClass)));\n+\n+        verify(mockMetadataApiService).getMetadataKeys(aclClass);\n+        assertResponse(mvcResult, TEST_STRING_SET, CommonCreatorConstants.STRING_SET_INSTANCE_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailGetMetadataKeys() {\n+        performUnauthorizedRequest(get(KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldFindMetadataEntityIdByName() {\n+        doReturn(metadataEntry).when(mockMetadataApiService).findMetadataEntityIdByName(TEST_STRING, aclClass);\n+\n+        final MvcResult mvcResult = performRequest(get(FIND_ENTITY_URL)\n+                .params(multiValueMapOf(ENTITY_NAME, TEST_STRING,\n+                                        ENTITY_CLASS, aclClass)));\n+\n+        verify(mockMetadataApiService).findMetadataEntityIdByName(TEST_STRING, aclClass);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailFindMetadataEntityIdByName() {\n+        performUnauthorizedRequest(get(FIND_ENTITY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItem() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(entityVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItem(entityVO);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_URL).content(content));\n+\n+        verify(mockMetadataApiService).deleteMetadataItem(entityVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItem() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItemKey() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(entityVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItemKey(entityVO, TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_KEY_URL).content(content)\n+                .params(multiValueMapOf(KEY, TEST_STRING)));\n+\n+        verify(mockMetadataApiService).deleteMetadataItemKey(entityVO, TEST_STRING);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItemKey() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_KEY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItemKeys() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItemKeys(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_KEYS_URL).content(content));\n+\n+        verify(mockMetadataApiService).deleteMetadataItemKeys(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItemKeys() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUploadMetadataFromFile() {\n+        doReturn(metadataEntry).when(mockMetadataApiService)\n+                .uploadMetadataFromFile(eq(new EntityVO(ID, aclClass)), any(), eq(true));\n+\n+        final MvcResult mvcResult = performRequest(post(UPLOAD_URL).content(MULTIPART_CONTENT)\n+                        .params(multiValueMapOf(ENTITY_ID, ID,\n+                                                ACL_CLASS, aclClass,\n+                                                MERGE_WITH_EXISTING_METADATA, true)),\n+                MULTIPART_CONTENT_TYPE, EXPECTED_CONTENT_TYPE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3fd5694de1eb9d1826bbfa1dc61a1f32735399"}, "originalPosition": 248}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTE4OTQwOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDo0NzoyOFrOH4IBFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDo0NzoyOFrOH4IBFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxMzY1NQ==", "bodyText": "Let's check the contents of the second argument using ArgumentCaptor. This is the only way to be sure that the multipart file was parsed correctly.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r528613655", "createdAt": "2020-11-23T10:47:28Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "diffHunk": "@@ -0,0 +1,296 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.metadata;\n+\n+import com.epam.pipeline.controller.vo.EntityVO;\n+import com.epam.pipeline.controller.vo.MetadataVO;\n+import com.epam.pipeline.entity.metadata.MetadataEntry;\n+import com.epam.pipeline.entity.metadata.MetadataEntryWithIssuesCount;\n+import com.epam.pipeline.entity.security.acl.AclClass;\n+import com.epam.pipeline.manager.metadata.MetadataApiService;\n+import com.epam.pipeline.test.creator.CommonCreatorConstants;\n+import com.epam.pipeline.test.creator.metadata.MetadataCreatorUtils;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING_SET;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.verify;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+\n+@WebMvcTest(controllers = MetadataController.class)\n+public class MetadataControllerTest extends AbstractControllerTest {\n+\n+    private static final String METADATA_URL = SERVLET_PATH + \"/metadata\";\n+    private static final String UPDATE_KEY_URL = METADATA_URL + \"/updateKey\";\n+    private static final String UPDATE_KEYS_URL = METADATA_URL + \"/updateKeys\";\n+    private static final String UPDATE_ITEM_URL = METADATA_URL + \"/update\";\n+    private static final String LOAD_ITEMS_URL = METADATA_URL + \"/load\";\n+    private static final String KEYS_URL = METADATA_URL + \"/keys\";\n+    private static final String FIND_ENTITY_URL = METADATA_URL + \"/find\";\n+    private static final String DELETE_ITEM_URL = METADATA_URL + \"/delete\";\n+    private static final String DELETE_ITEM_KEY_URL = METADATA_URL + \"/deleteKey\";\n+    private static final String DELETE_ITEM_KEYS_URL = METADATA_URL + \"/deleteKeys\";\n+    private static final String UPLOAD_URL = METADATA_URL + \"/upload\";\n+    private static final String FOLDER_URL = METADATA_URL + \"/folder\";\n+    private static final String SEARCH_URL = METADATA_URL + \"/search\";\n+\n+    private static final String ENTITY_CLASS = \"entityClass\";\n+    private static final String ACL_CLASS = \"class\";\n+    private static final String ENTITY_NAME = \"entityName\";\n+    private static final String KEY = \"key\";\n+    private static final String VALUE = \"value\";\n+    private static final String ENTITY_ID = \"id\";\n+    private static final String MERGE_WITH_EXISTING_METADATA = \"merge\";\n+    private static final String PARENT_FOLDER_ID = \"parentFolderId\";\n+\n+    private final MetadataEntry metadataEntry = MetadataCreatorUtils.getMetadataEntry();\n+    private final MetadataVO metadataVO = MetadataCreatorUtils.getMetadataVO();\n+    private final EntityVO entityVO = MetadataCreatorUtils.getEntityVO();\n+    private final AclClass aclClass = AclClass.DATA_STORAGE;\n+    private final List<EntityVO> entityVOList = Collections.singletonList(entityVO);\n+\n+    @Autowired\n+    private MetadataApiService mockMetadataApiService;\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItemKey() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItemKey(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_KEY_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItemKey(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItemKey() {\n+        performUnauthorizedRequest(post(UPDATE_KEY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItemKeys() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItemKeys(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_KEYS_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItemKeys(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItemKeys() {\n+        performUnauthorizedRequest(post(UPDATE_KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItem() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItem(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_ITEM_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItem(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItem() {\n+        performUnauthorizedRequest(post(UPDATE_ITEM_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadMetadataItems() throws Exception {\n+        final List<MetadataEntry> metadataEntries = Collections.singletonList(metadataEntry);\n+        final String content = getObjectMapper().writeValueAsString(entityVOList);\n+        doReturn(metadataEntries).when(mockMetadataApiService).listMetadataItems(entityVOList);\n+\n+        final MvcResult mvcResult = performRequest(post(LOAD_ITEMS_URL).content(content));\n+\n+        verify(mockMetadataApiService).listMetadataItems(entityVOList);\n+        assertResponse(mvcResult, metadataEntries, MetadataCreatorUtils.METADATA_ENTRY_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadMetadataItems() {\n+        performUnauthorizedRequest(post(LOAD_ITEMS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldGetMetadataKeys() {\n+        doReturn(TEST_STRING_SET).when(mockMetadataApiService).getMetadataKeys(aclClass);\n+\n+        final MvcResult mvcResult = performRequest(get(KEYS_URL).params(multiValueMapOf(ENTITY_CLASS, aclClass)));\n+\n+        verify(mockMetadataApiService).getMetadataKeys(aclClass);\n+        assertResponse(mvcResult, TEST_STRING_SET, CommonCreatorConstants.STRING_SET_INSTANCE_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailGetMetadataKeys() {\n+        performUnauthorizedRequest(get(KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldFindMetadataEntityIdByName() {\n+        doReturn(metadataEntry).when(mockMetadataApiService).findMetadataEntityIdByName(TEST_STRING, aclClass);\n+\n+        final MvcResult mvcResult = performRequest(get(FIND_ENTITY_URL)\n+                .params(multiValueMapOf(ENTITY_NAME, TEST_STRING,\n+                                        ENTITY_CLASS, aclClass)));\n+\n+        verify(mockMetadataApiService).findMetadataEntityIdByName(TEST_STRING, aclClass);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailFindMetadataEntityIdByName() {\n+        performUnauthorizedRequest(get(FIND_ENTITY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItem() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(entityVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItem(entityVO);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_URL).content(content));\n+\n+        verify(mockMetadataApiService).deleteMetadataItem(entityVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItem() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItemKey() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(entityVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItemKey(entityVO, TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_KEY_URL).content(content)\n+                .params(multiValueMapOf(KEY, TEST_STRING)));\n+\n+        verify(mockMetadataApiService).deleteMetadataItemKey(entityVO, TEST_STRING);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItemKey() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_KEY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItemKeys() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItemKeys(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_KEYS_URL).content(content));\n+\n+        verify(mockMetadataApiService).deleteMetadataItemKeys(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItemKeys() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUploadMetadataFromFile() {\n+        doReturn(metadataEntry).when(mockMetadataApiService)\n+                .uploadMetadataFromFile(eq(new EntityVO(ID, aclClass)), any(), eq(true));\n+\n+        final MvcResult mvcResult = performRequest(post(UPLOAD_URL).content(MULTIPART_CONTENT)\n+                        .params(multiValueMapOf(ENTITY_ID, ID,\n+                                                ACL_CLASS, aclClass,\n+                                                MERGE_WITH_EXISTING_METADATA, true)),\n+                MULTIPART_CONTENT_TYPE, EXPECTED_CONTENT_TYPE);\n+\n+        verify(mockMetadataApiService).uploadMetadataFromFile(any(EntityVO.class), any(), eq(true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3fd5694de1eb9d1826bbfa1dc61a1f32735399"}, "originalPosition": 250}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTIyNjA3OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataEntityControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDo1NzozOVrOH4IXCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDo1NzozOVrOH4IXCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxOTI3Mg==", "bodyText": "It would be helpful to use ArgumentCaptor here as well.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r528619272", "createdAt": "2020-11-23T10:57:39Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataEntityControllerTest.java", "diffHunk": "@@ -0,0 +1,431 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.metadata;\n+\n+import com.amazonaws.util.StringInputStream;\n+import com.epam.pipeline.controller.PagedResult;\n+import com.epam.pipeline.controller.vo.metadata.MetadataEntityVO;\n+import com.epam.pipeline.entity.metadata.FireCloudClass;\n+import com.epam.pipeline.entity.metadata.MetadataClass;\n+import com.epam.pipeline.entity.metadata.MetadataClassDescription;\n+import com.epam.pipeline.entity.metadata.MetadataEntity;\n+import com.epam.pipeline.entity.metadata.MetadataField;\n+import com.epam.pipeline.entity.metadata.MetadataFilter;\n+import com.epam.pipeline.manager.metadata.MetadataEntityApiService;\n+import com.epam.pipeline.test.creator.CommonCreatorConstants;\n+import com.epam.pipeline.test.creator.metadata.MetadataCreatorUtils;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.http.MediaType;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+import org.springframework.web.multipart.MultipartFile;\n+\n+import java.io.InputStream;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_LONG_SET;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING_MAP;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.verify;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+\n+@WebMvcTest(controllers = MetadataEntityController.class)\n+public class MetadataEntityControllerTest extends AbstractControllerTest {\n+\n+    private static final String METADATA_CLASS_URL = SERVLET_PATH + \"/metadataClass\";\n+    private static final String METADATA_CLASS_REGISTER_URL = METADATA_CLASS_URL + \"/register\";\n+    private static final String METADATA_CLASSES_LOAD_URL = METADATA_CLASS_URL + \"/loadAll\";\n+    private static final String METADATA_CLASS_DELETE_URL = METADATA_CLASS_URL + \"/%d/delete\";\n+    private static final String METADATA_CLASS_UPDATE_EXTERNAL_URL = METADATA_CLASS_URL + \"/%d/external\";\n+    private static final String METADATA_ENTITY_URL = SERVLET_PATH + \"/metadataEntity\";\n+    private static final String METADATA_ENTITY_LOAD_URL = METADATA_ENTITY_URL + \"/%d/load\";\n+    private static final String METADATA_ENTITY_LOAD_EXTERNAL_URL = METADATA_ENTITY_URL + \"/loadExternal\";\n+    private static final String METADATA_ENTITY_FILTER_URL = METADATA_ENTITY_URL + \"/filter\";\n+    private static final String METADATA_ENTITY_UPLOAD_URL = METADATA_ENTITY_URL + \"/upload\";\n+    private static final String METADATA_ENTITY_GET_KEYS_URL = METADATA_ENTITY_URL + \"/keys\";\n+    private static final String METADATA_ENTITY_GET_FIELDS_URL = METADATA_ENTITY_URL + \"/fields\";\n+    private static final String METADATA_ENTITY_DELETE_URL = METADATA_ENTITY_URL + \"/%d/delete\";\n+    private static final String METADATA_ENTITY_SAVE_URL = METADATA_ENTITY_URL + \"/save\";\n+    private static final String METADATA_ENTITY_UPDATE_KEY_URL = METADATA_ENTITY_URL + \"/updateKey\";\n+    private static final String METADATA_ENTITY_DELETE_KEY_URL = METADATA_ENTITY_URL + \"/%d/deleteKey\";\n+    private static final String METADATA_ENTITY_DELETE_LIST_URL = METADATA_ENTITY_URL + \"/deleteList\";\n+    private static final String METADATA_ENTITY_DELETE_FROM_PROJECT_URL = METADATA_ENTITY_URL + \"/deleteFromProject\";\n+    private static final String METADATA_ENTITY_ENTITIES_URL = METADATA_ENTITY_URL + \"/entities\";\n+    private static final String METADATA_ENTITY_DOWNLOAD_URL = METADATA_ENTITY_URL + \"/download\";\n+\n+    private static final String ENTITY_NAME = \"name\";\n+    private static final String EXTERNAL_CLASS_NAME = \"externalClassName\";\n+    private static final String CLASS_NAME = \"className\";\n+    private static final String FOLDER_ID = \"folderId\";\n+    private static final String STRING_ID = \"id\";\n+    private static final String PARENT_ID = \"parentId\";\n+    private static final String METADATA_CLASS = \"metadataClass\";\n+    private static final String KEY = \"key\";\n+    private static final String PROJECT_ID = \"projectId\";\n+    private static final String ENTITY_CLASS = \"entityClass\";\n+    private static final String FILE_FORMAT = \"fileFormat\";\n+\n+    private final MetadataClass metadataClass = MetadataCreatorUtils.getMetadataClass();\n+    private final MetadataEntity metadataEntity = MetadataCreatorUtils.getMetadataEntity();\n+    private final MetadataEntityVO metadataEntityVO = MetadataCreatorUtils.getMetadataEntityVO();\n+\n+    @Autowired\n+    private MetadataEntityApiService mockMetadataEntityApiService;\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldRegisterMetadataClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService).createMetadataClass(TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_CLASS_REGISTER_URL)\n+                .params(multiValueMapOf(ENTITY_NAME, TEST_STRING)));\n+\n+        verify(mockMetadataEntityApiService).createMetadataClass(TEST_STRING);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailRegisterMetadataClass() {\n+        performUnauthorizedRequest(post(METADATA_CLASS_REGISTER_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadAllMetadataClasses() {\n+        final List<MetadataClass> metadataClassList = Collections.singletonList(metadataClass);\n+        doReturn(metadataClassList).when(mockMetadataEntityApiService).loadAllMetadataClasses();\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_CLASSES_LOAD_URL));\n+\n+        verify(mockMetadataEntityApiService).loadAllMetadataClasses();\n+        assertResponse(mvcResult, metadataClassList, MetadataCreatorUtils.METADATA_CLASS_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadAllMetadataClasses() {\n+        performUnauthorizedRequest(get(METADATA_CLASSES_LOAD_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService).deleteMetadataClass(ID);\n+\n+        final MvcResult mvcResult = performRequest(delete(String.format(METADATA_CLASS_DELETE_URL, ID)));\n+\n+        verify(mockMetadataEntityApiService).deleteMetadataClass(ID);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataClass() {\n+        performUnauthorizedRequest(get(METADATA_CLASSES_LOAD_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateExternalClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService)\n+                .updateExternalClassName(ID, FireCloudClass.PARTICIPANT);\n+\n+        final MvcResult mvcResult = performRequest(post(String.format(METADATA_CLASS_UPDATE_EXTERNAL_URL, ID))\n+                .params(multiValueMapOf(EXTERNAL_CLASS_NAME, FireCloudClass.PARTICIPANT)));\n+\n+        verify(mockMetadataEntityApiService).updateExternalClassName(ID, FireCloudClass.PARTICIPANT);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateExternalClass() {\n+        performUnauthorizedRequest(post(String.format(METADATA_CLASS_UPDATE_EXTERNAL_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadMetadataEntity() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).loadMetadataEntity(ID);\n+\n+        final MvcResult mvcResult = performRequest(get(String.format(METADATA_ENTITY_LOAD_URL, ID)));\n+\n+        verify(mockMetadataEntityApiService).loadMetadataEntity(ID);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadMetadataEntity() {\n+        performUnauthorizedRequest(get(String.format(METADATA_ENTITY_LOAD_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadExternalMetadataEntity() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).loadByExternalId(TEST_STRING, TEST_STRING, ID);\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_ENTITY_LOAD_EXTERNAL_URL)\n+                .params(multiValueMapOf(STRING_ID, TEST_STRING,\n+                                        CLASS_NAME, TEST_STRING,\n+                                        FOLDER_ID, ID)));\n+\n+        verify(mockMetadataEntityApiService).loadByExternalId(TEST_STRING, TEST_STRING, ID);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadExternalMetadataEntity() {\n+        performUnauthorizedRequest(get(METADATA_ENTITY_LOAD_EXTERNAL_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldFilterMetadataEntities() throws Exception {\n+        final PagedResult<List<MetadataEntity>> pagedResult = MetadataCreatorUtils.getPagedResult();\n+        final MetadataFilter metadataFilter = MetadataCreatorUtils.getMetadataFilter();\n+        final String content = getObjectMapper().writeValueAsString(metadataFilter);\n+        doReturn(pagedResult).when(mockMetadataEntityApiService).filterMetadata(metadataFilter);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_FILTER_URL).content(content));\n+\n+        verify(mockMetadataEntityApiService).filterMetadata(metadataFilter);\n+        assertResponse(mvcResult, pagedResult, MetadataCreatorUtils.PAGED_RESULT_ENTITY_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailFilterMetadataEntities() {\n+        performUnauthorizedRequest(post(METADATA_ENTITY_FILTER_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUploadMetadataFromFile() {\n+        final List<MetadataEntity> entities = Collections.singletonList(metadataEntity);\n+        doReturn(entities).when(mockMetadataEntityApiService).uploadMetadataFromFile(eq(ID), any(MultipartFile.class));\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_UPLOAD_URL).content(MULTIPART_CONTENT)\n+                .params(multiValueMapOf(PARENT_ID, ID)), MULTIPART_CONTENT_TYPE, EXPECTED_CONTENT_TYPE);\n+\n+        verify(mockMetadataEntityApiService).uploadMetadataFromFile(eq(ID), any(MultipartFile.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3fd5694de1eb9d1826bbfa1dc61a1f32735399"}, "originalPosition": 232}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTIzMDcyOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataEntityControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDo1ODo1OFrOH4IZ1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDo1ODo1OFrOH4IZ1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxOTk5MQ==", "bodyText": "We need to create a new instance of the class here because there are no guaranties on junit tests execution order.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r528619991", "createdAt": "2020-11-23T10:58:58Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataEntityControllerTest.java", "diffHunk": "@@ -0,0 +1,431 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.metadata;\n+\n+import com.amazonaws.util.StringInputStream;\n+import com.epam.pipeline.controller.PagedResult;\n+import com.epam.pipeline.controller.vo.metadata.MetadataEntityVO;\n+import com.epam.pipeline.entity.metadata.FireCloudClass;\n+import com.epam.pipeline.entity.metadata.MetadataClass;\n+import com.epam.pipeline.entity.metadata.MetadataClassDescription;\n+import com.epam.pipeline.entity.metadata.MetadataEntity;\n+import com.epam.pipeline.entity.metadata.MetadataField;\n+import com.epam.pipeline.entity.metadata.MetadataFilter;\n+import com.epam.pipeline.manager.metadata.MetadataEntityApiService;\n+import com.epam.pipeline.test.creator.CommonCreatorConstants;\n+import com.epam.pipeline.test.creator.metadata.MetadataCreatorUtils;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.http.MediaType;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+import org.springframework.web.multipart.MultipartFile;\n+\n+import java.io.InputStream;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_LONG_SET;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING_MAP;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.verify;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+\n+@WebMvcTest(controllers = MetadataEntityController.class)\n+public class MetadataEntityControllerTest extends AbstractControllerTest {\n+\n+    private static final String METADATA_CLASS_URL = SERVLET_PATH + \"/metadataClass\";\n+    private static final String METADATA_CLASS_REGISTER_URL = METADATA_CLASS_URL + \"/register\";\n+    private static final String METADATA_CLASSES_LOAD_URL = METADATA_CLASS_URL + \"/loadAll\";\n+    private static final String METADATA_CLASS_DELETE_URL = METADATA_CLASS_URL + \"/%d/delete\";\n+    private static final String METADATA_CLASS_UPDATE_EXTERNAL_URL = METADATA_CLASS_URL + \"/%d/external\";\n+    private static final String METADATA_ENTITY_URL = SERVLET_PATH + \"/metadataEntity\";\n+    private static final String METADATA_ENTITY_LOAD_URL = METADATA_ENTITY_URL + \"/%d/load\";\n+    private static final String METADATA_ENTITY_LOAD_EXTERNAL_URL = METADATA_ENTITY_URL + \"/loadExternal\";\n+    private static final String METADATA_ENTITY_FILTER_URL = METADATA_ENTITY_URL + \"/filter\";\n+    private static final String METADATA_ENTITY_UPLOAD_URL = METADATA_ENTITY_URL + \"/upload\";\n+    private static final String METADATA_ENTITY_GET_KEYS_URL = METADATA_ENTITY_URL + \"/keys\";\n+    private static final String METADATA_ENTITY_GET_FIELDS_URL = METADATA_ENTITY_URL + \"/fields\";\n+    private static final String METADATA_ENTITY_DELETE_URL = METADATA_ENTITY_URL + \"/%d/delete\";\n+    private static final String METADATA_ENTITY_SAVE_URL = METADATA_ENTITY_URL + \"/save\";\n+    private static final String METADATA_ENTITY_UPDATE_KEY_URL = METADATA_ENTITY_URL + \"/updateKey\";\n+    private static final String METADATA_ENTITY_DELETE_KEY_URL = METADATA_ENTITY_URL + \"/%d/deleteKey\";\n+    private static final String METADATA_ENTITY_DELETE_LIST_URL = METADATA_ENTITY_URL + \"/deleteList\";\n+    private static final String METADATA_ENTITY_DELETE_FROM_PROJECT_URL = METADATA_ENTITY_URL + \"/deleteFromProject\";\n+    private static final String METADATA_ENTITY_ENTITIES_URL = METADATA_ENTITY_URL + \"/entities\";\n+    private static final String METADATA_ENTITY_DOWNLOAD_URL = METADATA_ENTITY_URL + \"/download\";\n+\n+    private static final String ENTITY_NAME = \"name\";\n+    private static final String EXTERNAL_CLASS_NAME = \"externalClassName\";\n+    private static final String CLASS_NAME = \"className\";\n+    private static final String FOLDER_ID = \"folderId\";\n+    private static final String STRING_ID = \"id\";\n+    private static final String PARENT_ID = \"parentId\";\n+    private static final String METADATA_CLASS = \"metadataClass\";\n+    private static final String KEY = \"key\";\n+    private static final String PROJECT_ID = \"projectId\";\n+    private static final String ENTITY_CLASS = \"entityClass\";\n+    private static final String FILE_FORMAT = \"fileFormat\";\n+\n+    private final MetadataClass metadataClass = MetadataCreatorUtils.getMetadataClass();\n+    private final MetadataEntity metadataEntity = MetadataCreatorUtils.getMetadataEntity();\n+    private final MetadataEntityVO metadataEntityVO = MetadataCreatorUtils.getMetadataEntityVO();\n+\n+    @Autowired\n+    private MetadataEntityApiService mockMetadataEntityApiService;\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldRegisterMetadataClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService).createMetadataClass(TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_CLASS_REGISTER_URL)\n+                .params(multiValueMapOf(ENTITY_NAME, TEST_STRING)));\n+\n+        verify(mockMetadataEntityApiService).createMetadataClass(TEST_STRING);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailRegisterMetadataClass() {\n+        performUnauthorizedRequest(post(METADATA_CLASS_REGISTER_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadAllMetadataClasses() {\n+        final List<MetadataClass> metadataClassList = Collections.singletonList(metadataClass);\n+        doReturn(metadataClassList).when(mockMetadataEntityApiService).loadAllMetadataClasses();\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_CLASSES_LOAD_URL));\n+\n+        verify(mockMetadataEntityApiService).loadAllMetadataClasses();\n+        assertResponse(mvcResult, metadataClassList, MetadataCreatorUtils.METADATA_CLASS_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadAllMetadataClasses() {\n+        performUnauthorizedRequest(get(METADATA_CLASSES_LOAD_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService).deleteMetadataClass(ID);\n+\n+        final MvcResult mvcResult = performRequest(delete(String.format(METADATA_CLASS_DELETE_URL, ID)));\n+\n+        verify(mockMetadataEntityApiService).deleteMetadataClass(ID);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataClass() {\n+        performUnauthorizedRequest(get(METADATA_CLASSES_LOAD_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateExternalClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService)\n+                .updateExternalClassName(ID, FireCloudClass.PARTICIPANT);\n+\n+        final MvcResult mvcResult = performRequest(post(String.format(METADATA_CLASS_UPDATE_EXTERNAL_URL, ID))\n+                .params(multiValueMapOf(EXTERNAL_CLASS_NAME, FireCloudClass.PARTICIPANT)));\n+\n+        verify(mockMetadataEntityApiService).updateExternalClassName(ID, FireCloudClass.PARTICIPANT);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateExternalClass() {\n+        performUnauthorizedRequest(post(String.format(METADATA_CLASS_UPDATE_EXTERNAL_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadMetadataEntity() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).loadMetadataEntity(ID);\n+\n+        final MvcResult mvcResult = performRequest(get(String.format(METADATA_ENTITY_LOAD_URL, ID)));\n+\n+        verify(mockMetadataEntityApiService).loadMetadataEntity(ID);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadMetadataEntity() {\n+        performUnauthorizedRequest(get(String.format(METADATA_ENTITY_LOAD_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadExternalMetadataEntity() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).loadByExternalId(TEST_STRING, TEST_STRING, ID);\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_ENTITY_LOAD_EXTERNAL_URL)\n+                .params(multiValueMapOf(STRING_ID, TEST_STRING,\n+                                        CLASS_NAME, TEST_STRING,\n+                                        FOLDER_ID, ID)));\n+\n+        verify(mockMetadataEntityApiService).loadByExternalId(TEST_STRING, TEST_STRING, ID);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadExternalMetadataEntity() {\n+        performUnauthorizedRequest(get(METADATA_ENTITY_LOAD_EXTERNAL_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldFilterMetadataEntities() throws Exception {\n+        final PagedResult<List<MetadataEntity>> pagedResult = MetadataCreatorUtils.getPagedResult();\n+        final MetadataFilter metadataFilter = MetadataCreatorUtils.getMetadataFilter();\n+        final String content = getObjectMapper().writeValueAsString(metadataFilter);\n+        doReturn(pagedResult).when(mockMetadataEntityApiService).filterMetadata(metadataFilter);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_FILTER_URL).content(content));\n+\n+        verify(mockMetadataEntityApiService).filterMetadata(metadataFilter);\n+        assertResponse(mvcResult, pagedResult, MetadataCreatorUtils.PAGED_RESULT_ENTITY_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailFilterMetadataEntities() {\n+        performUnauthorizedRequest(post(METADATA_ENTITY_FILTER_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUploadMetadataFromFile() {\n+        final List<MetadataEntity> entities = Collections.singletonList(metadataEntity);\n+        doReturn(entities).when(mockMetadataEntityApiService).uploadMetadataFromFile(eq(ID), any(MultipartFile.class));\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_UPLOAD_URL).content(MULTIPART_CONTENT)\n+                .params(multiValueMapOf(PARENT_ID, ID)), MULTIPART_CONTENT_TYPE, EXPECTED_CONTENT_TYPE);\n+\n+        verify(mockMetadataEntityApiService).uploadMetadataFromFile(eq(ID), any(MultipartFile.class));\n+        assertResponse(mvcResult, entities, MetadataCreatorUtils.METADATA_ENTITY_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUploadMetadataFromFile() {\n+        performUnauthorizedRequest(post(METADATA_ENTITY_UPLOAD_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldGetMetadataKeys() {\n+        final List<MetadataField> fields = Collections.singletonList(MetadataCreatorUtils.getMetadataField());\n+        doReturn(fields).when(mockMetadataEntityApiService).getMetadataKeys(ID, TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_ENTITY_GET_KEYS_URL)\n+                .params(multiValueMapOf(FOLDER_ID, ID,\n+                                        METADATA_CLASS, TEST_STRING)));\n+\n+        verify(mockMetadataEntityApiService).getMetadataKeys(ID, TEST_STRING);\n+        assertResponse(mvcResult, fields, MetadataCreatorUtils.METADATA_FIELD_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailGetMetadataKeys() {\n+        performUnauthorizedRequest(get(METADATA_ENTITY_GET_KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldGetMetadataFields() {\n+        final List<MetadataClassDescription> list =\n+                Collections.singletonList(MetadataCreatorUtils.getMetadataClassDescription());\n+        doReturn(list).when(mockMetadataEntityApiService).getMetadataFields(ID);\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_ENTITY_GET_FIELDS_URL)\n+                .params(multiValueMapOf(FOLDER_ID, ID)));\n+\n+        verify(mockMetadataEntityApiService).getMetadataFields(ID);\n+        assertResponse(mvcResult, list, MetadataCreatorUtils.CLASS_DESCRIPTION_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailGetMetadataFields() {\n+        performUnauthorizedRequest(get(METADATA_ENTITY_GET_FIELDS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataEntity() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).deleteMetadataEntity(ID);\n+\n+        final MvcResult mvcResult = performRequest(delete(String.format(METADATA_ENTITY_DELETE_URL, ID)));\n+\n+        verify(mockMetadataEntityApiService).deleteMetadataEntity(ID);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataEntity() {\n+        performUnauthorizedRequest(delete(String.format(METADATA_ENTITY_DELETE_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataEntityWithId() throws Exception {\n+        metadataEntityVO.setEntityId(ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3fd5694de1eb9d1826bbfa1dc61a1f32735399"}, "originalPosition": 298}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTI0MjI3OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataEntityControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMTowMjowNlrOH4Igtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMTowMjowNlrOH4Igtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYyMTc1MA==", "bodyText": "Can we use assertFileResponse method here?", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r528621750", "createdAt": "2020-11-23T11:02:06Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataEntityControllerTest.java", "diffHunk": "@@ -0,0 +1,431 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.metadata;\n+\n+import com.amazonaws.util.StringInputStream;\n+import com.epam.pipeline.controller.PagedResult;\n+import com.epam.pipeline.controller.vo.metadata.MetadataEntityVO;\n+import com.epam.pipeline.entity.metadata.FireCloudClass;\n+import com.epam.pipeline.entity.metadata.MetadataClass;\n+import com.epam.pipeline.entity.metadata.MetadataClassDescription;\n+import com.epam.pipeline.entity.metadata.MetadataEntity;\n+import com.epam.pipeline.entity.metadata.MetadataField;\n+import com.epam.pipeline.entity.metadata.MetadataFilter;\n+import com.epam.pipeline.manager.metadata.MetadataEntityApiService;\n+import com.epam.pipeline.test.creator.CommonCreatorConstants;\n+import com.epam.pipeline.test.creator.metadata.MetadataCreatorUtils;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.http.MediaType;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+import org.springframework.web.multipart.MultipartFile;\n+\n+import java.io.InputStream;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_LONG_SET;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING_MAP;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.verify;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+\n+@WebMvcTest(controllers = MetadataEntityController.class)\n+public class MetadataEntityControllerTest extends AbstractControllerTest {\n+\n+    private static final String METADATA_CLASS_URL = SERVLET_PATH + \"/metadataClass\";\n+    private static final String METADATA_CLASS_REGISTER_URL = METADATA_CLASS_URL + \"/register\";\n+    private static final String METADATA_CLASSES_LOAD_URL = METADATA_CLASS_URL + \"/loadAll\";\n+    private static final String METADATA_CLASS_DELETE_URL = METADATA_CLASS_URL + \"/%d/delete\";\n+    private static final String METADATA_CLASS_UPDATE_EXTERNAL_URL = METADATA_CLASS_URL + \"/%d/external\";\n+    private static final String METADATA_ENTITY_URL = SERVLET_PATH + \"/metadataEntity\";\n+    private static final String METADATA_ENTITY_LOAD_URL = METADATA_ENTITY_URL + \"/%d/load\";\n+    private static final String METADATA_ENTITY_LOAD_EXTERNAL_URL = METADATA_ENTITY_URL + \"/loadExternal\";\n+    private static final String METADATA_ENTITY_FILTER_URL = METADATA_ENTITY_URL + \"/filter\";\n+    private static final String METADATA_ENTITY_UPLOAD_URL = METADATA_ENTITY_URL + \"/upload\";\n+    private static final String METADATA_ENTITY_GET_KEYS_URL = METADATA_ENTITY_URL + \"/keys\";\n+    private static final String METADATA_ENTITY_GET_FIELDS_URL = METADATA_ENTITY_URL + \"/fields\";\n+    private static final String METADATA_ENTITY_DELETE_URL = METADATA_ENTITY_URL + \"/%d/delete\";\n+    private static final String METADATA_ENTITY_SAVE_URL = METADATA_ENTITY_URL + \"/save\";\n+    private static final String METADATA_ENTITY_UPDATE_KEY_URL = METADATA_ENTITY_URL + \"/updateKey\";\n+    private static final String METADATA_ENTITY_DELETE_KEY_URL = METADATA_ENTITY_URL + \"/%d/deleteKey\";\n+    private static final String METADATA_ENTITY_DELETE_LIST_URL = METADATA_ENTITY_URL + \"/deleteList\";\n+    private static final String METADATA_ENTITY_DELETE_FROM_PROJECT_URL = METADATA_ENTITY_URL + \"/deleteFromProject\";\n+    private static final String METADATA_ENTITY_ENTITIES_URL = METADATA_ENTITY_URL + \"/entities\";\n+    private static final String METADATA_ENTITY_DOWNLOAD_URL = METADATA_ENTITY_URL + \"/download\";\n+\n+    private static final String ENTITY_NAME = \"name\";\n+    private static final String EXTERNAL_CLASS_NAME = \"externalClassName\";\n+    private static final String CLASS_NAME = \"className\";\n+    private static final String FOLDER_ID = \"folderId\";\n+    private static final String STRING_ID = \"id\";\n+    private static final String PARENT_ID = \"parentId\";\n+    private static final String METADATA_CLASS = \"metadataClass\";\n+    private static final String KEY = \"key\";\n+    private static final String PROJECT_ID = \"projectId\";\n+    private static final String ENTITY_CLASS = \"entityClass\";\n+    private static final String FILE_FORMAT = \"fileFormat\";\n+\n+    private final MetadataClass metadataClass = MetadataCreatorUtils.getMetadataClass();\n+    private final MetadataEntity metadataEntity = MetadataCreatorUtils.getMetadataEntity();\n+    private final MetadataEntityVO metadataEntityVO = MetadataCreatorUtils.getMetadataEntityVO();\n+\n+    @Autowired\n+    private MetadataEntityApiService mockMetadataEntityApiService;\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldRegisterMetadataClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService).createMetadataClass(TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_CLASS_REGISTER_URL)\n+                .params(multiValueMapOf(ENTITY_NAME, TEST_STRING)));\n+\n+        verify(mockMetadataEntityApiService).createMetadataClass(TEST_STRING);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailRegisterMetadataClass() {\n+        performUnauthorizedRequest(post(METADATA_CLASS_REGISTER_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadAllMetadataClasses() {\n+        final List<MetadataClass> metadataClassList = Collections.singletonList(metadataClass);\n+        doReturn(metadataClassList).when(mockMetadataEntityApiService).loadAllMetadataClasses();\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_CLASSES_LOAD_URL));\n+\n+        verify(mockMetadataEntityApiService).loadAllMetadataClasses();\n+        assertResponse(mvcResult, metadataClassList, MetadataCreatorUtils.METADATA_CLASS_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadAllMetadataClasses() {\n+        performUnauthorizedRequest(get(METADATA_CLASSES_LOAD_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService).deleteMetadataClass(ID);\n+\n+        final MvcResult mvcResult = performRequest(delete(String.format(METADATA_CLASS_DELETE_URL, ID)));\n+\n+        verify(mockMetadataEntityApiService).deleteMetadataClass(ID);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataClass() {\n+        performUnauthorizedRequest(get(METADATA_CLASSES_LOAD_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateExternalClass() {\n+        doReturn(metadataClass).when(mockMetadataEntityApiService)\n+                .updateExternalClassName(ID, FireCloudClass.PARTICIPANT);\n+\n+        final MvcResult mvcResult = performRequest(post(String.format(METADATA_CLASS_UPDATE_EXTERNAL_URL, ID))\n+                .params(multiValueMapOf(EXTERNAL_CLASS_NAME, FireCloudClass.PARTICIPANT)));\n+\n+        verify(mockMetadataEntityApiService).updateExternalClassName(ID, FireCloudClass.PARTICIPANT);\n+        assertResponse(mvcResult, metadataClass, MetadataCreatorUtils.METADATA_CLASS_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateExternalClass() {\n+        performUnauthorizedRequest(post(String.format(METADATA_CLASS_UPDATE_EXTERNAL_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadMetadataEntity() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).loadMetadataEntity(ID);\n+\n+        final MvcResult mvcResult = performRequest(get(String.format(METADATA_ENTITY_LOAD_URL, ID)));\n+\n+        verify(mockMetadataEntityApiService).loadMetadataEntity(ID);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadMetadataEntity() {\n+        performUnauthorizedRequest(get(String.format(METADATA_ENTITY_LOAD_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadExternalMetadataEntity() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).loadByExternalId(TEST_STRING, TEST_STRING, ID);\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_ENTITY_LOAD_EXTERNAL_URL)\n+                .params(multiValueMapOf(STRING_ID, TEST_STRING,\n+                                        CLASS_NAME, TEST_STRING,\n+                                        FOLDER_ID, ID)));\n+\n+        verify(mockMetadataEntityApiService).loadByExternalId(TEST_STRING, TEST_STRING, ID);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadExternalMetadataEntity() {\n+        performUnauthorizedRequest(get(METADATA_ENTITY_LOAD_EXTERNAL_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldFilterMetadataEntities() throws Exception {\n+        final PagedResult<List<MetadataEntity>> pagedResult = MetadataCreatorUtils.getPagedResult();\n+        final MetadataFilter metadataFilter = MetadataCreatorUtils.getMetadataFilter();\n+        final String content = getObjectMapper().writeValueAsString(metadataFilter);\n+        doReturn(pagedResult).when(mockMetadataEntityApiService).filterMetadata(metadataFilter);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_FILTER_URL).content(content));\n+\n+        verify(mockMetadataEntityApiService).filterMetadata(metadataFilter);\n+        assertResponse(mvcResult, pagedResult, MetadataCreatorUtils.PAGED_RESULT_ENTITY_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailFilterMetadataEntities() {\n+        performUnauthorizedRequest(post(METADATA_ENTITY_FILTER_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUploadMetadataFromFile() {\n+        final List<MetadataEntity> entities = Collections.singletonList(metadataEntity);\n+        doReturn(entities).when(mockMetadataEntityApiService).uploadMetadataFromFile(eq(ID), any(MultipartFile.class));\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_UPLOAD_URL).content(MULTIPART_CONTENT)\n+                .params(multiValueMapOf(PARENT_ID, ID)), MULTIPART_CONTENT_TYPE, EXPECTED_CONTENT_TYPE);\n+\n+        verify(mockMetadataEntityApiService).uploadMetadataFromFile(eq(ID), any(MultipartFile.class));\n+        assertResponse(mvcResult, entities, MetadataCreatorUtils.METADATA_ENTITY_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUploadMetadataFromFile() {\n+        performUnauthorizedRequest(post(METADATA_ENTITY_UPLOAD_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldGetMetadataKeys() {\n+        final List<MetadataField> fields = Collections.singletonList(MetadataCreatorUtils.getMetadataField());\n+        doReturn(fields).when(mockMetadataEntityApiService).getMetadataKeys(ID, TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_ENTITY_GET_KEYS_URL)\n+                .params(multiValueMapOf(FOLDER_ID, ID,\n+                                        METADATA_CLASS, TEST_STRING)));\n+\n+        verify(mockMetadataEntityApiService).getMetadataKeys(ID, TEST_STRING);\n+        assertResponse(mvcResult, fields, MetadataCreatorUtils.METADATA_FIELD_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailGetMetadataKeys() {\n+        performUnauthorizedRequest(get(METADATA_ENTITY_GET_KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldGetMetadataFields() {\n+        final List<MetadataClassDescription> list =\n+                Collections.singletonList(MetadataCreatorUtils.getMetadataClassDescription());\n+        doReturn(list).when(mockMetadataEntityApiService).getMetadataFields(ID);\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_ENTITY_GET_FIELDS_URL)\n+                .params(multiValueMapOf(FOLDER_ID, ID)));\n+\n+        verify(mockMetadataEntityApiService).getMetadataFields(ID);\n+        assertResponse(mvcResult, list, MetadataCreatorUtils.CLASS_DESCRIPTION_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailGetMetadataFields() {\n+        performUnauthorizedRequest(get(METADATA_ENTITY_GET_FIELDS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataEntity() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).deleteMetadataEntity(ID);\n+\n+        final MvcResult mvcResult = performRequest(delete(String.format(METADATA_ENTITY_DELETE_URL, ID)));\n+\n+        verify(mockMetadataEntityApiService).deleteMetadataEntity(ID);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataEntity() {\n+        performUnauthorizedRequest(delete(String.format(METADATA_ENTITY_DELETE_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataEntityWithId() throws Exception {\n+        metadataEntityVO.setEntityId(ID);\n+        final String content = getObjectMapper().writeValueAsString(metadataEntityVO);\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).updateMetadataEntity(metadataEntityVO);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_SAVE_URL).content(content));\n+\n+        verify(mockMetadataEntityApiService).updateMetadataEntity(metadataEntityVO);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataEntityWithoutId() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataEntityVO);\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).createMetadataEntity(metadataEntityVO);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_SAVE_URL).content(content));\n+\n+        verify(mockMetadataEntityApiService).createMetadataEntity(metadataEntityVO);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataEntity() {\n+        performUnauthorizedRequest(post(METADATA_ENTITY_DELETE_URL, ID));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataEntityItemKey() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataEntityVO);\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).updateMetadataItemKey(metadataEntityVO);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_UPDATE_KEY_URL).content(content));\n+\n+        verify(mockMetadataEntityApiService).updateMetadataItemKey(metadataEntityVO);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataEntityItemKey() {\n+        performUnauthorizedRequest(post(METADATA_ENTITY_UPDATE_KEY_URL, ID));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataEntityItemKey() {\n+        doReturn(metadataEntity).when(mockMetadataEntityApiService).deleteMetadataItemKey(ID, TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(delete(String.format(METADATA_ENTITY_DELETE_KEY_URL, ID))\n+                .params(multiValueMapOf(KEY, TEST_STRING)));\n+\n+        verify(mockMetadataEntityApiService).deleteMetadataItemKey(ID, TEST_STRING);\n+        assertResponse(mvcResult, metadataEntity, MetadataCreatorUtils.METADATA_ENTITY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataEntityItemKey() {\n+        performUnauthorizedRequest(delete(String.format(METADATA_ENTITY_DELETE_KEY_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataEntities() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(TEST_LONG_SET);\n+        doReturn(TEST_LONG_SET).when(mockMetadataEntityApiService).deleteMetadataEntities(TEST_LONG_SET);\n+\n+        final MvcResult mvcResult = performRequest(delete(METADATA_ENTITY_DELETE_LIST_URL).content(content));\n+\n+        verify(mockMetadataEntityApiService).deleteMetadataEntities(TEST_LONG_SET);\n+        assertResponse(mvcResult, TEST_LONG_SET, CommonCreatorConstants.LONG_SET_INSTANCE_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataEntities() {\n+        performUnauthorizedRequest(delete(METADATA_ENTITY_DELETE_LIST_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataEntitiesFromProject() {\n+        doNothing().when(mockMetadataEntityApiService).deleteMetadataFromProject(ID, TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(delete(METADATA_ENTITY_DELETE_FROM_PROJECT_URL)\n+                .params(multiValueMapOf(PROJECT_ID, ID,\n+                                        ENTITY_CLASS, TEST_STRING)));\n+\n+        verify(mockMetadataEntityApiService).deleteMetadataFromProject(ID, TEST_STRING);\n+        assertResponse(mvcResult, null, MetadataCreatorUtils.RESULT_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataEntitiesFromProject() {\n+        performUnauthorizedRequest(delete(METADATA_ENTITY_DELETE_LIST_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadEntitiesData() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(TEST_LONG_SET);\n+        doReturn(TEST_STRING_MAP).when(mockMetadataEntityApiService).loadEntitiesData(TEST_LONG_SET);\n+\n+        final MvcResult mvcResult = performRequest(post(METADATA_ENTITY_ENTITIES_URL).content(content));\n+\n+        verify(mockMetadataEntityApiService).loadEntitiesData(TEST_LONG_SET);\n+        assertResponse(mvcResult, TEST_STRING_MAP, CommonCreatorConstants.STRING_MAP_INSTANCE_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadEntitiesData() {\n+        performUnauthorizedRequest(post(METADATA_ENTITY_ENTITIES_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDownloadEntityAsFile() throws Exception {\n+        final InputStream inputStream = new StringInputStream(TEST_STRING);\n+        doReturn(inputStream).when(mockMetadataEntityApiService).getMetadataEntityFile(ID, TEST_STRING, TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(get(METADATA_ENTITY_DOWNLOAD_URL)\n+                        .params(multiValueMapOf(FOLDER_ID, ID,\n+                                                ENTITY_CLASS, TEST_STRING,\n+                                                FILE_FORMAT, TEST_STRING)),\n+                MediaType.APPLICATION_OCTET_STREAM_VALUE);\n+\n+        verify(mockMetadataEntityApiService).getMetadataEntityFile(ID, TEST_STRING, TEST_STRING);\n+        Assert.assertEquals(TEST_STRING, mvcResult.getResponse().getContentAsString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3fd5694de1eb9d1826bbfa1dc61a1f32735399"}, "originalPosition": 424}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMDExNjcyOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDowNjoyMVrOH43heg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDowNjoyMVrOH43heg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTM5MTk5NA==", "bodyText": "I'm thinking that we should check returnedFile.getOriginalFilename() and file.getBytes() because these methods used in MetadataApiService.\nAdditionally it seems like a good idea to extract new assertion method which will accept the captor and check for the uploading file name and its content:\nassertRequestFile(captor, expectedFileName, expectedContent);", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r529391994", "createdAt": "2020-11-24T10:06:21Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "diffHunk": "@@ -0,0 +1,305 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.metadata;\n+\n+import com.epam.pipeline.controller.vo.EntityVO;\n+import com.epam.pipeline.controller.vo.MetadataVO;\n+import com.epam.pipeline.entity.metadata.MetadataEntry;\n+import com.epam.pipeline.entity.metadata.MetadataEntryWithIssuesCount;\n+import com.epam.pipeline.entity.security.acl.AclClass;\n+import com.epam.pipeline.manager.metadata.MetadataApiService;\n+import com.epam.pipeline.test.creator.CommonCreatorConstants;\n+import com.epam.pipeline.test.creator.metadata.MetadataCreatorUtils;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.http.MediaType;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+import org.springframework.web.multipart.MultipartFile;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING_SET;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.verify;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+\n+@WebMvcTest(controllers = MetadataController.class)\n+public class MetadataControllerTest extends AbstractControllerTest {\n+\n+    private static final String METADATA_URL = SERVLET_PATH + \"/metadata\";\n+    private static final String UPDATE_KEY_URL = METADATA_URL + \"/updateKey\";\n+    private static final String UPDATE_KEYS_URL = METADATA_URL + \"/updateKeys\";\n+    private static final String UPDATE_ITEM_URL = METADATA_URL + \"/update\";\n+    private static final String LOAD_ITEMS_URL = METADATA_URL + \"/load\";\n+    private static final String KEYS_URL = METADATA_URL + \"/keys\";\n+    private static final String FIND_ENTITY_URL = METADATA_URL + \"/find\";\n+    private static final String DELETE_ITEM_URL = METADATA_URL + \"/delete\";\n+    private static final String DELETE_ITEM_KEY_URL = METADATA_URL + \"/deleteKey\";\n+    private static final String DELETE_ITEM_KEYS_URL = METADATA_URL + \"/deleteKeys\";\n+    private static final String UPLOAD_URL = METADATA_URL + \"/upload\";\n+    private static final String FOLDER_URL = METADATA_URL + \"/folder\";\n+    private static final String SEARCH_URL = METADATA_URL + \"/search\";\n+\n+    private static final String ENTITY_CLASS = \"entityClass\";\n+    private static final String ACL_CLASS = \"class\";\n+    private static final String ENTITY_NAME = \"entityName\";\n+    private static final String KEY = \"key\";\n+    private static final String VALUE = \"value\";\n+    private static final String ENTITY_ID = \"id\";\n+    private static final String MERGE_WITH_EXISTING_METADATA = \"merge\";\n+    private static final String PARENT_FOLDER_ID = \"parentFolderId\";\n+\n+    private final MetadataEntry metadataEntry = MetadataCreatorUtils.getMetadataEntry();\n+    private final MetadataVO metadataVO = MetadataCreatorUtils.getMetadataVO();\n+    private final EntityVO entityVO = MetadataCreatorUtils.getEntityVO();\n+    private final AclClass aclClass = AclClass.DATA_STORAGE;\n+    private final List<EntityVO> entityVOList = Collections.singletonList(entityVO);\n+\n+    @Autowired\n+    private MetadataApiService mockMetadataApiService;\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItemKey() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItemKey(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_KEY_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItemKey(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItemKey() {\n+        performUnauthorizedRequest(post(UPDATE_KEY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItemKeys() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItemKeys(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_KEYS_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItemKeys(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItemKeys() {\n+        performUnauthorizedRequest(post(UPDATE_KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateMetadataItem() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).updateMetadataItem(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(post(UPDATE_ITEM_URL).content(content));\n+\n+        verify(mockMetadataApiService).updateMetadataItem(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailUpdateMetadataItem() {\n+        performUnauthorizedRequest(post(UPDATE_ITEM_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadMetadataItems() throws Exception {\n+        final List<MetadataEntry> metadataEntries = Collections.singletonList(metadataEntry);\n+        final String content = getObjectMapper().writeValueAsString(entityVOList);\n+        doReturn(metadataEntries).when(mockMetadataApiService).listMetadataItems(entityVOList);\n+\n+        final MvcResult mvcResult = performRequest(post(LOAD_ITEMS_URL).content(content));\n+\n+        verify(mockMetadataApiService).listMetadataItems(entityVOList);\n+        assertResponse(mvcResult, metadataEntries, MetadataCreatorUtils.METADATA_ENTRY_LIST_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailLoadMetadataItems() {\n+        performUnauthorizedRequest(post(LOAD_ITEMS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldGetMetadataKeys() {\n+        doReturn(TEST_STRING_SET).when(mockMetadataApiService).getMetadataKeys(aclClass);\n+\n+        final MvcResult mvcResult = performRequest(get(KEYS_URL).params(multiValueMapOf(ENTITY_CLASS, aclClass)));\n+\n+        verify(mockMetadataApiService).getMetadataKeys(aclClass);\n+        assertResponse(mvcResult, TEST_STRING_SET, CommonCreatorConstants.STRING_SET_INSTANCE_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailGetMetadataKeys() {\n+        performUnauthorizedRequest(get(KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldFindMetadataEntityIdByName() {\n+        doReturn(metadataEntry).when(mockMetadataApiService).findMetadataEntityIdByName(TEST_STRING, aclClass);\n+\n+        final MvcResult mvcResult = performRequest(get(FIND_ENTITY_URL)\n+                .params(multiValueMapOf(ENTITY_NAME, TEST_STRING,\n+                                        ENTITY_CLASS, aclClass)));\n+\n+        verify(mockMetadataApiService).findMetadataEntityIdByName(TEST_STRING, aclClass);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailFindMetadataEntityIdByName() {\n+        performUnauthorizedRequest(get(FIND_ENTITY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItem() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(entityVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItem(entityVO);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_URL).content(content));\n+\n+        verify(mockMetadataApiService).deleteMetadataItem(entityVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItem() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItemKey() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(entityVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItemKey(entityVO, TEST_STRING);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_KEY_URL).content(content)\n+                .params(multiValueMapOf(KEY, TEST_STRING)));\n+\n+        verify(mockMetadataApiService).deleteMetadataItemKey(entityVO, TEST_STRING);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItemKey() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_KEY_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDeleteMetadataItemKeys() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(metadataVO);\n+        doReturn(metadataEntry).when(mockMetadataApiService).deleteMetadataItemKeys(metadataVO);\n+\n+        final MvcResult mvcResult = performRequest(delete(DELETE_ITEM_KEYS_URL).content(content));\n+\n+        verify(mockMetadataApiService).deleteMetadataItemKeys(metadataVO);\n+        assertResponse(mvcResult, metadataEntry, MetadataCreatorUtils.METADATA_ENTRY_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailDeleteMetadataItemKeys() {\n+        performUnauthorizedRequest(delete(DELETE_ITEM_KEYS_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUploadMetadataFromFile() throws Exception {\n+        doReturn(metadataEntry).when(mockMetadataApiService)\n+                .uploadMetadataFromFile(eq(new EntityVO(ID, aclClass)), any(), eq(true));\n+\n+        final MvcResult mvcResult = performRequest(post(UPLOAD_URL).content(MULTIPART_CONTENT)\n+                        .params(multiValueMapOf(ENTITY_ID, ID,\n+                                                ACL_CLASS, aclClass,\n+                                                MERGE_WITH_EXISTING_METADATA, true)),\n+                                                MULTIPART_CONTENT_TYPE, EXPECTED_CONTENT_TYPE);\n+        final ArgumentCaptor<MultipartFile> multipartFileCaptor = ArgumentCaptor.forClass(MultipartFile.class);\n+\n+        verify(mockMetadataApiService).uploadMetadataFromFile(any(EntityVO.class),\n+                multipartFileCaptor.capture(), eq(true));\n+        final MultipartFile returnedFile = multipartFileCaptor.getValue();\n+        assertThat(returnedFile.getContentType()).isEqualTo(MediaType.APPLICATION_OCTET_STREAM_VALUE);\n+        assertThat(returnedFile.getOriginalFilename()).isEqualTo(\"file.txt\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46dba2d0b246d3944e294cb18a06be7caa27d803"}, "originalPosition": 259}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyOTkyMTQzOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMDoxMDo0MVrOH6Ug5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMDoxMDo0MVrOH6Ug5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkxNTU1Nw==", "bodyText": "It looks like all all these asserts can be replaced by a single call which accepts MultipartFile rather than captor.\nassertRequestFile(captor.getValue(), fileName, fileContentInBytesOrString);\nContent type will probably be the same in all the similar cases. Therefore we don't have to pass it as a parameter and just use a default value MediaType.APPLICATION_OCTET_STREAM_VALUE.\nAlso I believe there was a similar case in this or other test class in the pull request. So it would be nice to use the same  assertRequestFile in both cases.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r530915557", "createdAt": "2020-11-26T10:10:41Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "diffHunk": "@@ -255,8 +255,9 @@ public void shouldUploadMetadataFromFile() throws Exception {\n         verify(mockMetadataApiService).uploadMetadataFromFile(any(EntityVO.class),\n                 multipartFileCaptor.capture(), eq(true));\n         final MultipartFile returnedFile = multipartFileCaptor.getValue();\n-        assertThat(returnedFile.getContentType()).isEqualTo(MediaType.APPLICATION_OCTET_STREAM_VALUE);\n         assertThat(returnedFile.getOriginalFilename()).isEqualTo(\"file.txt\");\n+        assertThat(returnedFile.getBytes()).isEqualTo(\"file.txt\".getBytes());\n+        assertRequestFile(multipartFileCaptor, \"file\", MediaType.APPLICATION_OCTET_STREAM_VALUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1721ba52bab72b7178ff9e6f44e5e5fe2f6c47"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDQwNTEwOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/test/web/AbstractControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTozMjo1OVrOH7yjEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTozMjo1OVrOH7yjEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ1NjIxMA==", "bodyText": "Probably there is no need for generic type here.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r532456210", "createdAt": "2020-11-30T09:32:59Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/test/web/AbstractControllerTest.java", "diffHunk": "@@ -129,12 +129,13 @@ public void assertContent(final MvcResult mvcResult, final byte[] fileContent) {\n         assertThat(mvcResult.getResponse().getContentAsByteArray()).isEqualTo(fileContent);\n     }\n \n-    public void assertRequestFile(final ArgumentCaptor<MultipartFile> captor,\n-                                  final String expectedFileName,\n-                                  final String expectedContent) {\n-        final MultipartFile capturedValue = captor.getValue();\n-        assertThat(capturedValue.getName()).isEqualTo(expectedFileName);\n-        assertThat(capturedValue.getContentType()).isEqualTo(expectedContent);\n+    @SneakyThrows\n+    public <T> void assertRequestFile(final MultipartFile capturedValue,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09b567aca81ca5c938d96c9f9a0b0a2598612397"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDQxNzkyOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/test/web/AbstractControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTozNjoxM1rOH7yqyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTozNjoxM1rOH7yqyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ1ODE4Ng==", "bodyText": "I'm wondering if we can extract MULTIPART_CONTENT_FILE_CONTENT. MULTIPART_CONTENT_FILE_NAME and MULTIPART_CONTENT_FILE_CONTENT fields. Additionally let's replace the content of the file from file.txt to some more distinct string like content of file.txt. Once changed please check that no tests depending on MULTIPART_CONTENT are failing.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r532458186", "createdAt": "2020-11-30T09:36:13Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/test/web/AbstractControllerTest.java", "diffHunk": "@@ -59,12 +59,12 @@\n             \"multipart/form-data; boundary=--------------------------boundary\";\n     protected static final String MULTIPART_CONTENT =\n             \"----------------------------boundary\\r\\n\" +\n-                    \"Content-Disposition: form-data; name=\\\"file\\\"; filename=\\\"file.txt\\\"\\r\\n\" +\n-                    \"Content-Type:  application/octet-stream\\r\\n\" +\n-                    \"\\r\\n\" +\n-                    \"file.txt\" +\n-                    \"\\r\\n\" +\n-                    \"----------------------------boundary\";\n+            \"Content-Disposition: form-data; name=\\\"file\\\"; filename=\\\"file.txt\\\"\\r\\n\" +\n+            \"Content-Type:  application/octet-stream\\r\\n\" +\n+            \"\\r\\n\" +\n+            \"file.txt\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09b567aca81ca5c938d96c9f9a0b0a2598612397"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDQ5NzkzOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOToyOTo1MlrOH9R32g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOToyOTo1MlrOH9R32g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxODAxMA==", "bodyText": "It doesn't seem like a good idea to hardcode a file name and its content. Let's pass these parameters explicitly.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r534018010", "createdAt": "2020-12-02T09:29:52Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/controller/metadata/MetadataControllerTest.java", "diffHunk": "@@ -252,7 +252,7 @@ public void shouldUploadMetadataFromFile() throws Exception {\n \n         verify(mockMetadataApiService).uploadMetadataFromFile(any(EntityVO.class),\n                 multipartFileCaptor.capture(), eq(true));\n-        assertRequestFile(multipartFileCaptor.getValue(), \"file.txt\", \"file.txt\".getBytes());\n+        assertRequestFile(multipartFileCaptor.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73e21b5fce52c0e8ab1692bac8404b8fe0bcc48d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1NzA1NTc2OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/test/web/AbstractControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDozNTo0NFrOH-SiCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDozNTo0NFrOH-SiCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3NzM4NA==", "bodyText": "Please replace the string with MULTIPART_CONTENT_FILE_CONTENT.", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r535077384", "createdAt": "2020-12-03T10:35:44Z", "author": {"login": "tcibinan"}, "path": "api/src/test/java/com/epam/pipeline/test/web/AbstractControllerTest.java", "diffHunk": "@@ -55,11 +55,13 @@\n     protected static final String CERTIFICATE_NAME = \"ca.crt\";\n     private static final String CONTENT_DISPOSITION_HEADER = \"Content-Disposition\";\n     protected static final String EXPECTED_CONTENT_TYPE = \"application/json;charset=UTF-8\";\n+    protected static final String MULTIPART_CONTENT_FILE_NAME = \"file.txt\";\n+    protected static final byte[] MULTIPART_CONTENT_FILE_CONTENT = \"content of file.txt\".getBytes();\n     protected static final String MULTIPART_CONTENT_TYPE =\n             \"multipart/form-data; boundary=--------------------------boundary\";\n     protected static final String MULTIPART_CONTENT =\n             \"----------------------------boundary\\r\\n\" +\n-            \"Content-Disposition: form-data; name=\\\"file\\\"; filename=\\\" file.txt \\\"\\r\\n\" +\n+            \"Content-Disposition: form-data; name=\\\"file\\\"; filename=\\\" \" + MULTIPART_CONTENT_FILE_NAME + \" \\\"\\r\\n\" +\n             \"Content-Type:  application/octet-stream\\r\\n\" +\n             \"\\r\\n\" +\n             \"content of file.txt\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deb6111c6a52b5e75a4fe4edafd2311236474b7c"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MjU5NjIyOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/com/epam/pipeline/entity/metadata/MetadataField.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODoyNDo1NVrOH_F2HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODoyNDo1NVrOH_F2HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkxODEwOQ==", "bodyText": "Could you please suppress checkstyle warning for this line using SuppressWarnings annotation?", "url": "https://github.com/epam/cloud-pipeline/pull/1583#discussion_r535918109", "createdAt": "2020-12-04T08:24:55Z", "author": {"login": "tcibinan"}, "path": "api/src/main/java/com/epam/pipeline/entity/metadata/MetadataField.java", "diffHunk": "@@ -17,21 +17,28 @@\n package com.epam.pipeline.entity.metadata;\n \n import com.fasterxml.jackson.annotation.JsonIgnore;\n-import lombok.AllArgsConstructor;\n import lombok.Getter;\n import lombok.NoArgsConstructor;\n import lombok.Setter;\n \n @Getter\n @Setter\n @NoArgsConstructor\n-@AllArgsConstructor\n public class MetadataField {\n     private String name;\n     @JsonIgnore\n     private String dbName;\n     private boolean predefined = false;\n \n+    //todo: Replace with @AllArgsConstructor once lombok version 1.16.20 is used.\n+    // The current version causes JsonMappingException.\n+    // See more https://stackoverflow.com/questions/40546508/jsoncreator-could-not-find-creator-property-with-name-even-with-ignoreunknown", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0e07655d44e770934f1863194df5947bae73009"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 341, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}