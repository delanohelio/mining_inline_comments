{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzE5OTc4", "number": 1252, "title": "Issue #441 Lustre path handling improvements", "bodyText": "This PR is related to issue #441.\nIt updates the handling of Lustre paths.\nLustre allows specifying complicated (\"multi-host\") mount roots [1] [2]. As the same char ':' is used for many purposes:\n\nsplit port from a server in host specification\nsplit LNet Network Identifiers (NID) in host specification\npart of sequence splitting host from the other part of mount path (':/')\nuser input is verified against the specific regex, describing valid Lustre path.\nThe format is checking during NFSStorageProvider.mount operation, as well, and operation is being aborted if the format is invalid.\nAlso, Lustre mount fails, if path ends with a separator (even if valid), so additional operation is applied if necessary.", "createdAt": "2020-08-03T18:01:57Z", "url": "https://github.com/epam/cloud-pipeline/pull/1252", "merged": true, "mergeCommit": {"oid": "19237c90d60a81cd30925c84a5448c709abf4e86"}, "closed": true, "closedAt": "2020-08-10T10:28:44Z", "author": {"login": "Wedds"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7VAh-AH2gAyNDYyMzE5OTc4OjE2YjYwNWY4ZDk1ZGZiMWNjZWQzYTQ2M2M3OGE4MmEzODczYTA2Y2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8gefKAH2gAyNDYyMzE5OTc4OjY4ODZiYWI2Y2M4YTJiOWQ5NjY4OWRiZTNjYmRjNzU4YmMyNDBiNzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16b605f8d95dfb1cced3a463c78a82a3873a06cd", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/16b605f8d95dfb1cced3a463c78a82a3873a06cd", "committedDate": "2020-08-03T16:56:12Z", "message": "Issue #441 Add more Lustre-specific verification for mount roots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6247414f6309a1b9c2b3dd33f75ad25cc386d5fb", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/6247414f6309a1b9c2b3dd33f75ad25cc386d5fb", "committedDate": "2020-08-03T16:56:16Z", "message": "Issue #441 Change conversion to mount paths for Lustre shares"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43150fdc622e24ed108ad0fa7a14bd2ae6a076de", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/43150fdc622e24ed108ad0fa7a14bd2ae6a076de", "committedDate": "2020-08-03T17:53:28Z", "message": "Issue #441 Chop last path separator from Lustre mount paths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/190c9d5a501358101072a38f3cbab8046e1f7de4", "committedDate": "2020-08-04T07:53:00Z", "message": "Support AWS FSx for Lustre (#441) - GUI 'LUSTRE' mounts path validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjk3NzQz", "url": "https://github.com/epam/cloud-pipeline/pull/1252#pullrequestreview-460697743", "createdAt": "2020-08-04T10:41:40Z", "commit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDo0MTo0MFrOG7a71w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMToxNjo0NlrOG7b77Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2MDQ3MQ==", "bodyText": "It would be nice to extract this to a separate method since this peace of code is duplicated several times in the file.", "url": "https://github.com/epam/cloud-pipeline/pull/1252#discussion_r464960471", "createdAt": "2020-08-04T10:41:40Z", "author": {"login": "tcibinan"}, "path": "api/src/main/java/com/epam/pipeline/manager/datastorage/providers/nfs/NFSStorageProvider.java", "diffHunk": "@@ -206,8 +214,10 @@ private synchronized File mount(NFSDataStorage dataStorage) {\n \n     private synchronized void unmountNFSIfEmpty(AbstractDataStorage storage) {\n         FileShareMount fileShareMount = shareMountManager.load(storage.getFileShareMountId());\n-        File rootMount = Paths.get(rootMountPoint, normalizePath(fileShareMount.getMountRoot())).toFile();\n-\n+        final String shareMountPath = MountType.LUSTRE == fileShareMount.getMountType()\n+                                      ? normalizeLustrePath(fileShareMount.getMountRoot())\n+                                      : normalizePath(fileShareMount.getMountRoot());\n+        File rootMount = Paths.get(rootMountPoint, shareMountPath).toFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2Mjk0Nw==", "bodyText": "I suppose that If we can use final or at least effectively final variables than we should do that. Let's assign mntDir variable only once. Moreover we can extract this to a separate method.", "url": "https://github.com/epam/cloud-pipeline/pull/1252#discussion_r464962947", "createdAt": "2020-08-04T10:46:52Z", "author": {"login": "tcibinan"}, "path": "api/src/main/java/com/epam/pipeline/manager/datastorage/providers/nfs/NFSStorageProvider.java", "diffHunk": "@@ -166,7 +167,14 @@ private synchronized File mount(NFSDataStorage dataStorage) {\n         File mntDir = Paths.get(rootMountPoint, getMountDirName(dataStorage.getPath())).toFile();\n         try {\n             FileShareMount fileShareMount = shareMountManager.load(dataStorage.getFileShareMountId());\n-            File rootMount = Paths.get(rootMountPoint, normalizePath(fileShareMount.getMountRoot())).toFile();\n+            final String mountPath;\n+            if (MountType.LUSTRE == fileShareMount.getMountType()) {\n+                mntDir = Paths.get(rootMountPoint, getLustreMountDirName(dataStorage.getPath())).toFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk3Njg3Nw==", "bodyText": "I'm just wondering if it's ok that we have trailing slashes in path for only lustre mounts. If there are some formal reasons for this then ok. Otherwise it would be great to unify the behavior between different storage types.\nPlease share what you think before implementing it.", "url": "https://github.com/epam/cloud-pipeline/pull/1252#discussion_r464976877", "createdAt": "2020-08-04T11:16:46Z", "author": {"login": "tcibinan"}, "path": "workflows/pipe-common/scripts/mount_storage.py", "diffHunk": "@@ -522,6 +522,8 @@ def build_mount_command(self, params):\n                 params['path'] = '//' + params['path']\n         elif self.share_mount.mount_type == \"LUSTRE\":\n             command = command.format(protocol=\"lustre\")\n+            if params['path'].count('/') > 1 and params['path'].endswith('/'):\n+                params['path'] = params['path'][:-1]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3d8ec923133347f9d843a681bb2c8b8917d1634", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/c3d8ec923133347f9d843a681bb2c8b8917d1634", "committedDate": "2020-08-04T17:49:50Z", "message": "Issue #441 Mount path building refactoring: extract mount creation for data storage and shares"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "134efed2036cb066d588fcfa36a38d6883b85cab", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/134efed2036cb066d588fcfa36a38d6883b85cab", "committedDate": "2020-08-06T15:45:23Z", "message": "Issue #441 Extract root for NFSDataStorage using NFSHelper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1384e0109920ac99ce48a3f5c885ff361115070b", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/1384e0109920ac99ce48a3f5c885ff361115070b", "committedDate": "2020-08-06T17:38:48Z", "message": "Issue #441 Implement mount for nested directories from Lustre filesystem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "549e10c9e2be8a9b31cbf0c92caa18280861974d", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/549e10c9e2be8a9b31cbf0c92caa18280861974d", "committedDate": "2020-08-06T18:13:11Z", "message": "Issue #441 Lustre mount into runs: migrate `ro` option onto nested mount"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "158ad34f5c785d51d9bbae37a2c4c0c40a990614", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/158ad34f5c785d51d9bbae37a2c4c0c40a990614", "committedDate": "2020-08-06T18:24:55Z", "message": "Issue #441 Use `final` modifier for an arguments in public NFSHelper methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6886bab6cc8a2b9d96689dbe3cbdc758bc240b78", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/6886bab6cc8a2b9d96689dbe3cbdc758bc240b78", "committedDate": "2020-08-07T08:51:48Z", "message": "Issue #441 Configure dependencies after Lustre client installation for deb-based OS to have the correct client installation exit code"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3807, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}