{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NDY4MDIw", "number": 1114, "title": "Provide node disks API", "bodyText": "Relates to #1096.\nThe pull request brings support for node disks api. From now node disks history data can be accessed via a new API method GET /cluster/node/{name}/disks. All attached disks of all nodes are automatically registered including os, data, swap and autoscaled disks.\nAdditionally the pull request expands run price calculation capabilities. Two additional fields are added to pipeline run entity that can be used in billing reports:\n\ncomputePricePerHour which specifies only virtual machine price per hour,\ndiskPricePerHour which specifies 1GB disk price per hour.\n\nMoreover overall run pricePerHour gets updated once compute node is assigned to the run to more precisely reflect node disks cost.\nNotice that node disks API only covers runs that were created after the patch is applied.", "createdAt": "2020-05-15T09:04:11Z", "url": "https://github.com/epam/cloud-pipeline/pull/1114", "merged": true, "mergeCommit": {"oid": "fc4e655531f68c5d17f1ad434d48804827a6c507"}, "closed": true, "closedAt": "2020-05-21T14:47:04Z", "author": {"login": "tcibinan"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjLsTtgFqTQxNTUwNzQxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjezlwAFqTQxNjIwOTM4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTA3NDE4", "url": "https://github.com/epam/cloud-pipeline/pull/1114#pullrequestreview-415507418", "createdAt": "2020-05-20T16:24:32Z", "commit": {"oid": "436ad7b389701e28a76bab908fbfadfd97ec1a43"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNjoyNDozMlrOGYT2jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNjozMDozNlrOGYUFaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0NDI3MQ==", "bodyText": "Please add Transactional annotation", "url": "https://github.com/epam/cloud-pipeline/pull/1114#discussion_r428144271", "createdAt": "2020-05-20T16:24:32Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/dao/cluster/NodeDiskDao.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.epam.pipeline.dao.cluster;\n+\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.DiskRegistrationRequest;\n+import com.epam.pipeline.entity.utils.DateUtils;\n+import lombok.RequiredArgsConstructor;\n+import org.springframework.jdbc.core.RowMapper;\n+import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;\n+import org.springframework.jdbc.core.namedparam.NamedParameterJdbcDaoSupport;\n+\n+import java.sql.Timestamp;\n+import java.time.LocalDateTime;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@RequiredArgsConstructor\n+public class NodeDiskDao extends NamedParameterJdbcDaoSupport {\n+    \n+    private final String insertNodeDiskQuery;\n+    private final String loadNodeDisksByNodeIdQuery;\n+    private final String deleteNodeDisksByNodeIdQuery;\n+\n+    public List<NodeDisk> insert(final String nodeId, final List<DiskRegistrationRequest> requests) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "436ad7b389701e28a76bab908fbfadfd97ec1a43"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0ODA3NQ==", "bodyText": "You can just add @Transactional annotation to the class and all DB changes will be rolled-back.", "url": "https://github.com/epam/cloud-pipeline/pull/1114#discussion_r428148075", "createdAt": "2020-05-20T16:30:36Z", "author": {"login": "mzueva"}, "path": "api/src/test/java/com/epam/pipeline/dao/cluster/NodeDiskDaoTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package com.epam.pipeline.dao.cluster;\n+\n+import com.epam.pipeline.AbstractSpringTest;\n+import com.epam.pipeline.entity.cluster.DiskRegistrationRequest;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.utils.DateUtils;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+\n+import java.time.LocalDateTime;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public class NodeDiskDaoTest extends AbstractSpringTest {\n+    \n+    private static final String NODE_ID = \"NODE_ID\";\n+    private static final String ANOTHER_NODE_ID = \"ANOTHER_NODE_ID\";\n+    private static final String NULL_NODE_ID = null;\n+    private static final Long SIZE = 1L;\n+    private static final Long NULL_SIZE = null;\n+\n+    @Autowired\n+    private NodeDiskDao dao;\n+\n+    @After\n+    public void deleteDisksByNodeId() {\n+        dao.deleteByNodeId(NODE_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "436ad7b389701e28a76bab908fbfadfd97ec1a43"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2e8c99263d2e93eb0b06a2f51c595579b2dbce4", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/d2e8c99263d2e93eb0b06a2f51c595579b2dbce4", "committedDate": "2020-05-21T08:27:24Z", "message": "Add node disks registration API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50bb25c657e44b8dbefcef6d573214f8e13c165d", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/50bb25c657e44b8dbefcef6d573214f8e13c165d", "committedDate": "2020-05-21T08:27:25Z", "message": "Register attached disks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e089e3557370337a127d4acad3f85042e61116c0", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/e089e3557370337a127d4acad3f85042e61116c0", "committedDate": "2020-05-21T08:27:25Z", "message": "Require node write permission for disks registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64273903f6b889feaace57e9ad376b7809eaba47", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/64273903f6b889feaace57e9ad376b7809eaba47", "committedDate": "2020-05-21T08:27:26Z", "message": "Add nodes registration to all nodeup scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64e9f14d32f4d94aa9a0632f74d216b13db0e75a", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/64e9f14d32f4d94aa9a0632f74d216b13db0e75a", "committedDate": "2020-05-21T08:27:26Z", "message": "Resolve checkstyle and pmd issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11919114efe57ee2e2293bff9e51a91872529afe", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/11919114efe57ee2e2293bff9e51a91872529afe", "committedDate": "2020-05-21T08:27:27Z", "message": "Revert all changes in nodeup scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2d7aaaf86867eccdd656bcf4b9b8427a80e1d08", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f2d7aaaf86867eccdd656bcf4b9b8427a80e1d08", "committedDate": "2020-05-21T08:27:27Z", "message": "Store pipeline run compute and disks prices explicitly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac717ebabef607756f328c819fe4515c97818a74", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ac717ebabef607756f328c819fe4515c97818a74", "committedDate": "2020-05-21T08:30:06Z", "message": "Support API level disks registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e20161b3403720cad6fdb699edcb551b65dbf63", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/0e20161b3403720cad6fdb699edcb551b65dbf63", "committedDate": "2020-05-21T08:30:07Z", "message": "Repair API level disks registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac4d10fcfc9cfa39894e06a7b38e1f091dc2957c", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ac4d10fcfc9cfa39894e06a7b38e1f091dc2957c", "committedDate": "2020-05-21T08:30:07Z", "message": "Fix instance filtering in gcp vm service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "541c9c12eb9b65922f55836ac15e69ca393394d5", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/541c9c12eb9b65922f55836ac15e69ca393394d5", "committedDate": "2020-05-21T08:30:08Z", "message": "Split instance disk and node disk abstractions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2f44e51d527c4aa73f2e0742bc04b29b34e4414", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/d2f44e51d527c4aa73f2e0742bc04b29b34e4414", "committedDate": "2020-05-21T08:30:08Z", "message": "Add newest pipeline run fields to corresponding sql queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "327717452fede8ebe7d0ac7761575ba4b399a653", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/327717452fede8ebe7d0ac7761575ba4b399a653", "committedDate": "2020-05-21T08:30:08Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca17b2541e74343434faefecaa6aa5cf132b92d4", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ca17b2541e74343434faefecaa6aa5cf132b92d4", "committedDate": "2020-05-21T08:30:09Z", "message": "Revert unrequired changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ad159918be7e1c633778af6e87157eabb88dc72", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/4ad159918be7e1c633778af6e87157eabb88dc72", "committedDate": "2020-05-21T08:30:09Z", "message": "Update runs price per hour for reassigned nodes as well"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "436ad7b389701e28a76bab908fbfadfd97ec1a43", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/436ad7b389701e28a76bab908fbfadfd97ec1a43", "committedDate": "2020-05-19T15:28:51Z", "message": "Update runs price per hour for reassigned nodes as well"}, "afterCommit": {"oid": "4ad159918be7e1c633778af6e87157eabb88dc72", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/4ad159918be7e1c633778af6e87157eabb88dc72", "committedDate": "2020-05-21T08:30:09Z", "message": "Update runs price per hour for reassigned nodes as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83fa0fde77084daeca905ff7eeb986aa54eddcbd", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/83fa0fde77084daeca905ff7eeb986aa54eddcbd", "committedDate": "2020-05-21T08:47:16Z", "message": "Resolve review issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "736255968a4093f4c0778fe734915866f750f8e6", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/736255968a4093f4c0778fe734915866f750f8e6", "committedDate": "2020-05-21T09:34:28Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78cd7f1a7fef0f79b6fef80e61d2e52bfdee0760", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/78cd7f1a7fef0f79b6fef80e61d2e52bfdee0760", "committedDate": "2020-05-21T10:17:31Z", "message": "Adjust reassigned node run price only if there are registered disks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3a8486dcd2d8585b77f3f0db8f591ddf3623566", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/c3a8486dcd2d8585b77f3f0db8f591ddf3623566", "committedDate": "2020-05-21T10:54:50Z", "message": "Resolve rebase issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MjA5Mzgz", "url": "https://github.com/epam/cloud-pipeline/pull/1114#pullrequestreview-416209383", "createdAt": "2020-05-21T14:46:56Z", "commit": {"oid": "c3a8486dcd2d8585b77f3f0db8f591ddf3623566"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3834, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}