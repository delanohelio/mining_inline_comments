{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzE5OTc4", "number": 1252, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDo0MTo0MFrOEU8ayA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMToxNjo0NlrOEU9ENg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzk2ODcyOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/com/epam/pipeline/manager/datastorage/providers/nfs/NFSStorageProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDo0MTo0MFrOG7a71w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDo0MTo0MFrOG7a71w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2MDQ3MQ==", "bodyText": "It would be nice to extract this to a separate method since this peace of code is duplicated several times in the file.", "url": "https://github.com/epam/cloud-pipeline/pull/1252#discussion_r464960471", "createdAt": "2020-08-04T10:41:40Z", "author": {"login": "tcibinan"}, "path": "api/src/main/java/com/epam/pipeline/manager/datastorage/providers/nfs/NFSStorageProvider.java", "diffHunk": "@@ -206,8 +214,10 @@ private synchronized File mount(NFSDataStorage dataStorage) {\n \n     private synchronized void unmountNFSIfEmpty(AbstractDataStorage storage) {\n         FileShareMount fileShareMount = shareMountManager.load(storage.getFileShareMountId());\n-        File rootMount = Paths.get(rootMountPoint, normalizePath(fileShareMount.getMountRoot())).toFile();\n-\n+        final String shareMountPath = MountType.LUSTRE == fileShareMount.getMountType()\n+                                      ? normalizeLustrePath(fileShareMount.getMountRoot())\n+                                      : normalizePath(fileShareMount.getMountRoot());\n+        File rootMount = Paths.get(rootMountPoint, shareMountPath).toFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzk4NDgwOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/com/epam/pipeline/manager/datastorage/providers/nfs/NFSStorageProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDo0Njo1MlrOG7bFgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDo0Njo1MlrOG7bFgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2Mjk0Nw==", "bodyText": "I suppose that If we can use final or at least effectively final variables than we should do that. Let's assign mntDir variable only once. Moreover we can extract this to a separate method.", "url": "https://github.com/epam/cloud-pipeline/pull/1252#discussion_r464962947", "createdAt": "2020-08-04T10:46:52Z", "author": {"login": "tcibinan"}, "path": "api/src/main/java/com/epam/pipeline/manager/datastorage/providers/nfs/NFSStorageProvider.java", "diffHunk": "@@ -166,7 +167,14 @@ private synchronized File mount(NFSDataStorage dataStorage) {\n         File mntDir = Paths.get(rootMountPoint, getMountDirName(dataStorage.getPath())).toFile();\n         try {\n             FileShareMount fileShareMount = shareMountManager.load(dataStorage.getFileShareMountId());\n-            File rootMount = Paths.get(rootMountPoint, normalizePath(fileShareMount.getMountRoot())).toFile();\n+            final String mountPath;\n+            if (MountType.LUSTRE == fileShareMount.getMountType()) {\n+                mntDir = Paths.get(rootMountPoint, getLustreMountDirName(dataStorage.getPath())).toFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNDA3NDc4OnYy", "diffSide": "RIGHT", "path": "workflows/pipe-common/scripts/mount_storage.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMToxNjo0NlrOG7b77Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNTo1NVrOG8_SSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk3Njg3Nw==", "bodyText": "I'm just wondering if it's ok that we have trailing slashes in path for only lustre mounts. If there are some formal reasons for this then ok. Otherwise it would be great to unify the behavior between different storage types.\nPlease share what you think before implementing it.", "url": "https://github.com/epam/cloud-pipeline/pull/1252#discussion_r464976877", "createdAt": "2020-08-04T11:16:46Z", "author": {"login": "tcibinan"}, "path": "workflows/pipe-common/scripts/mount_storage.py", "diffHunk": "@@ -522,6 +522,8 @@ def build_mount_command(self, params):\n                 params['path'] = '//' + params['path']\n         elif self.share_mount.mount_type == \"LUSTRE\":\n             command = command.format(protocol=\"lustre\")\n+            if params['path'].count('/') > 1 and params['path'].endswith('/'):\n+                params['path'] = params['path'][:-1]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNDYxNw==", "bodyText": "Sorry, it was a part of a debugging routine, following commits brings more thorough Lustre support.", "url": "https://github.com/epam/cloud-pipeline/pull/1252#discussion_r466604617", "createdAt": "2020-08-06T18:25:55Z", "author": {"login": "Wedds"}, "path": "workflows/pipe-common/scripts/mount_storage.py", "diffHunk": "@@ -522,6 +522,8 @@ def build_mount_command(self, params):\n                 params['path'] = '//' + params['path']\n         elif self.share_mount.mount_type == \"LUSTRE\":\n             command = command.format(protocol=\"lustre\")\n+            if params['path'].count('/') > 1 and params['path'].endswith('/'):\n+                params['path'] = params['path'][:-1]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk3Njg3Nw=="}, "originalCommit": {"oid": "190c9d5a501358101072a38f3cbab8046e1f7de4"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 413, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}