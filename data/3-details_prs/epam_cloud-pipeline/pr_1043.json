{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwODcwNTMy", "number": 1043, "title": "Issue 989 log filter endpoint. Part 3", "bodyText": "The third part of #989.\nThis part bring new functionality to API server, now all admins can view and search system logs", "createdAt": "2020-04-08T14:03:54Z", "url": "https://github.com/epam/cloud-pipeline/pull/1043", "merged": true, "mergeCommit": {"oid": "958c0800d7b4a5a8db9f7164b300058777815326"}, "closed": true, "closedAt": "2020-04-09T12:57:31Z", "author": {"login": "SilinPavel"}, "timelineItems": {"totalCount": 38, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTo6ahgH2gAyNDAwODcwNTMyOmMxOTIyMDNmZTJlZWJhNDQ4MTZhZTE2OTc0NWZkNzI4MzZiNjNjYTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV7bQsAH2gAyNDAwODcwNTMyOmY5ZTQzM2RmYzU3ZWJjYzM1YjVlNTJmYTBiZDIzNDVhZTE0M2JlMjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c192203fe2eeba44816ae169745fd72836b63ca0", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/c192203fe2eeba44816ae169745fd72836b63ca0", "committedDate": "2020-04-02T09:30:39Z", "message": "(issue #989) Stub log filter method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b222ce821542159053667758885d1f3183e3c0c2", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b222ce821542159053667758885d1f3183e3c0c2", "committedDate": "2020-04-02T15:11:19Z", "message": "GUI settings page: System Logs component (in progress)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afe9b25a469adf37d68e4333081e828e747d8476", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/afe9b25a469adf37d68e4333081e828e747d8476", "committedDate": "2020-04-03T16:13:42Z", "message": "(issue #989) WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be8087256bc67dda0b0ad2bdf4f7537ccc44087e", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/be8087256bc67dda0b0ad2bdf4f7537ccc44087e", "committedDate": "2020-04-03T16:13:42Z", "message": "(issue #989) log filter wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787ea6e7fa4a9a7cef8d57c23623728263178b9b", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/787ea6e7fa4a9a7cef8d57c23623728263178b9b", "committedDate": "2020-04-03T22:37:08Z", "message": "(issue #989) pagination added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f35b7433cf8e2efde58027a5fef7b9d936573ca3", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f35b7433cf8e2efde58027a5fef7b9d936573ca3", "committedDate": "2020-04-03T22:47:10Z", "message": "(issue #989) error handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f021d0de28a4ea80ef4d12af3ab92b996707e52f", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f021d0de28a4ea80ef4d12af3ab92b996707e52f", "committedDate": "2020-04-06T09:36:10Z", "message": "(issue #989) refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d62875e4d5d4498cf75b530e89809d4497ede3f", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/0d62875e4d5d4498cf75b530e89809d4497ede3f", "committedDate": "2020-04-06T10:21:20Z", "message": "(issue #989) pagination assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8db1ee08adff017d6af6b50b574b1f8c820f0541", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/8db1ee08adff017d6af6b50b574b1f8c820f0541", "committedDate": "2020-04-06T10:53:03Z", "message": "(issue #989) search by user name with ignore case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddb47a93293aff344171983dac3abac5f9163292", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ddb47a93293aff344171983dac3abac5f9163292", "committedDate": "2020-04-06T11:03:26Z", "message": "(issue #989) refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2208aed1936d34d63a6b137bffae95cdbb16ab1", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b2208aed1936d34d63a6b137bffae95cdbb16ab1", "committedDate": "2020-04-06T11:20:49Z", "message": "GUI settings page: System Logs (pagination)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "259de2d0f8951b58aeb752938330d1a76dbcddd1", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/259de2d0f8951b58aeb752938330d1a76dbcddd1", "committedDate": "2020-04-06T12:13:09Z", "message": "GUI settings page: System Logs (request fix)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba0f5e45a39869efa09a98930b536b6a2f58049f", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ba0f5e45a39869efa09a98930b536b6a2f58049f", "committedDate": "2020-04-06T16:58:26Z", "message": "(issue #989) refactor, reduce max size of a search to 10000"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24cdabcd9ea0a11292a951a37a3f5979ca6ab193", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/24cdabcd9ea0a11292a951a37a3f5979ca6ab193", "committedDate": "2020-04-07T10:26:37Z", "message": "(issue #989) java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2916d78620b15950fcfdc57ae41d05c05fbdbc2", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/a2916d78620b15950fcfdc57ae41d05c05fbdbc2", "committedDate": "2020-04-07T10:40:31Z", "message": "(issue #989) Assertion of elastic settings availability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14aa0df97837f546fde4e8b8d2929bf94ff71521", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/14aa0df97837f546fde4e8b8d2929bf94ff71521", "committedDate": "2020-04-07T13:00:02Z", "message": "GUI settings page: System logs (pagination)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9abdf31cb2c02d8f96acb0d5c1f8f563819eeff6", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/9abdf31cb2c02d8f96acb0d5c1f8f563819eeff6", "committedDate": "2020-04-07T13:13:44Z", "message": "(issue #989) searchAfter approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc7006ebd28f2cdea16d5efe326f80d8c8eed75d", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/fc7006ebd28f2cdea16d5efe326f80d8c8eed75d", "committedDate": "2020-04-07T13:14:50Z", "message": "Merge remote-tracking branch 'origin/issue_989_log_filter_endpoint' into issue_989_log_filter_endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7713fe51f1c777f70c27b83f2757c14398df0099", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7713fe51f1c777f70c27b83f2757c14398df0099", "committedDate": "2020-04-07T14:31:24Z", "message": "(issue #989) searchAfter approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bdb0f4fff20eb6b2927aee2babd1c47186543cc", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/9bdb0f4fff20eb6b2927aee2babd1c47186543cc", "committedDate": "2020-04-07T14:41:58Z", "message": "Merge remote-tracking branch 'origin/issue_989_log_filter_endpoint' into issue_989_log_filter_endpoint\n\n# Conflicts:\n#\tapi/src/main/java/com/epam/pipeline/entity/log/LogPagination.java\n#\tapi/src/main/java/com/epam/pipeline/entity/log/LogPaginationRequest.java\n#\tapi/src/main/java/com/epam/pipeline/manager/log/LogManager.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f887c49de43a837e8900b0d0b66b13a9621145bf", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f887c49de43a837e8900b0d0b66b13a9621145bf", "committedDate": "2020-04-07T14:43:52Z", "message": "GUI settings page: System logs (pagination - token)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e99bacb40e0c8c264c5df3ef13e7af20557547fb", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/e99bacb40e0c8c264c5df3ef13e7af20557547fb", "committedDate": "2020-04-07T14:52:16Z", "message": "GUI settings page: System logs (pagination - token; last page fix)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74daef6ad7368a9eea49da66eb2ff5fd1a0c6732", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/74daef6ad7368a9eea49da66eb2ff5fd1a0c6732", "committedDate": "2020-04-07T15:00:04Z", "message": "GUI settings page: System logs (navigation)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee73ee6c258eec67bbc0f0364dc85b39d9b7636b", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ee73ee6c258eec67bbc0f0364dc85b39d9b7636b", "committedDate": "2020-04-07T15:02:56Z", "message": "GUI settings page: System logs (date field)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3acdf3ffb9d39a4948bf37bea65a13bc0b6d5f26", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/3acdf3ffb9d39a4948bf37bea65a13bc0b6d5f26", "committedDate": "2020-04-07T15:06:27Z", "message": "GUI settings page: System logs (filters fix)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae69241ec343610661cc631a906e67872888dd5b", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ae69241ec343610661cc631a906e67872888dd5b", "committedDate": "2020-04-08T10:05:00Z", "message": "(issue #989) fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd29d3ddb3c47451406ac61dfaf969c523f3bac8", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/bd29d3ddb3c47451406ac61dfaf969c523f3bac8", "committedDate": "2020-04-08T12:18:00Z", "message": "(issue #989) add new filter service_account"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05d8a39def710417129056a23f9a3ce9846a473c", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/05d8a39def710417129056a23f9a3ce9846a473c", "committedDate": "2020-04-08T12:48:23Z", "message": "Ability to revert changes in user profile (#1026) - done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fd1438820a335e3ba1fd75539d608107baf9d0e", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/3fd1438820a335e3ba1fd75539d608107baf9d0e", "committedDate": "2020-04-08T12:54:10Z", "message": "GUI System Logs: 'Include Service Account Events' filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1330e1d44d3d886d0f6dcc4f6f78187aaa17c720", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/1330e1d44d3d886d0f6dcc4f6f78187aaa17c720", "committedDate": "2020-04-08T13:19:00Z", "message": "(issue #989) add new api method to get filter possible values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8c9009bcbe84307e3d1d98634eb7b2b79212ca2", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/a8c9009bcbe84307e3d1d98634eb7b2b79212ca2", "committedDate": "2020-04-08T13:54:34Z", "message": "GUI System logs: filter dictionaries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTIxNDYw", "url": "https://github.com/epam/cloud-pipeline/pull/1043#pullrequestreview-390121460", "createdAt": "2020-04-08T16:08:57Z", "commit": {"oid": "a8c9009bcbe84307e3d1d98634eb7b2b79212ca2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjowODo1N1rOGC2ZgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjowOTo1MFrOGC2b-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0MTYwMQ==", "bodyText": "As far as I remember sorting by id is not recommended due to performance considerations: \"The _id field has a unique value per document but it is not recommended to use it as a tiebreaker directly\" https://www.elastic.co/guide/en/elasticsearch/reference/6.8/search-request-search-after.html.\nI think sorting by timestamp shall be enough?", "url": "https://github.com/epam/cloud-pipeline/pull/1043#discussion_r405641601", "createdAt": "2020-04-08T16:08:57Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/log/LogManager.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.log;\n+\n+import com.epam.pipeline.common.MessageConstants;\n+import com.epam.pipeline.common.MessageHelper;\n+import com.epam.pipeline.entity.log.*;\n+import com.epam.pipeline.exception.PipelineException;\n+import com.epam.pipeline.manager.utils.GlobalSearchElasticHelper;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang.BooleanUtils;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+import org.elasticsearch.action.support.IndicesOptions;\n+import org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.index.query.RangeQueryBuilder;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.aggregations.AggregationBuilders;\n+import org.elasticsearch.search.aggregations.bucket.MultiBucketsAggregation;\n+import org.elasticsearch.search.aggregations.bucket.terms.Terms;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.search.sort.SortOrder;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.Assert;\n+import org.springframework.util.CollectionUtils;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.IOException;\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.time.format.DateTimeFormatter;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+@Slf4j\n+@Service\n+@Getter\n+@Setter\n+@RequiredArgsConstructor\n+public class LogManager {\n+\n+    private static final IndicesOptions INDICES_OPTIONS = IndicesOptions.fromOptions(true,\n+            SearchRequest.DEFAULT_INDICES_OPTIONS.allowNoIndices(),\n+            SearchRequest.DEFAULT_INDICES_OPTIONS.expandWildcardsOpen(),\n+            SearchRequest.DEFAULT_INDICES_OPTIONS.expandWildcardsClosed(),\n+            SearchRequest.DEFAULT_INDICES_OPTIONS);\n+\n+    private static final String USER = \"user\";\n+    private static final String TIMESTAMP = \"@timestamp\";\n+    private static final String MESSAGE_TIMESTAMP = \"message_timestamp\";\n+    private static final String HOSTNAME = \"hostname\";\n+    private static final String SERVICE_NAME = \"service_name\";\n+    private static final String TYPE = \"type\";\n+    private static final String MESSAGE = \"message\";\n+    private static final String SEVERITY = \"level\";\n+    private static final DateTimeFormatter DATE_TIME_FORMATTER =\n+            DateTimeFormatter.ofPattern(\"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\");\n+    private static final String DEFAULT_SEVERITY = \"INFO\";\n+    public static final String ID = \"_id\";\n+    public static final String SERVICE_ACCOUNT = \"service_account\";\n+\n+    private final GlobalSearchElasticHelper elasticHelper;\n+    private final MessageHelper messageHelper;\n+\n+    @Value(\"${log.security.elastic.index.prefix}\")\n+    private String indexTemplate;\n+\n+    /**\n+     * Searches log according to specified log filter.\n+     * @param logFilter - filter for constructing elasticsearch query\n+     * @return {@link LogPagination} object with related search result and additional information\n+     * */\n+    public LogPagination filter(final LogFilter logFilter) {\n+        final LogPaginationRequest pagination = logFilter.getPagination();\n+\n+        Assert.notNull(pagination, messageHelper.getMessage(MessageConstants.ERROR_PAGINATION_IS_NOT_PROVIDED));\n+        Assert.isTrue(pagination.getPageSize() > 0,\n+                messageHelper.getMessage(MessageConstants.ERROR_INVALID_PAGE_INDEX_OR_SIZE));\n+\n+        final SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder()\n+                .query(constructQueryFilter(logFilter))\n+                .sort(MESSAGE_TIMESTAMP, SortOrder.ASC)\n+                .sort(ID, SortOrder.ASC)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8c9009bcbe84307e3d1d98634eb7b2b79212ca2"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0MjIzMw==", "bodyText": "Please, check usage of final here and below", "url": "https://github.com/epam/cloud-pipeline/pull/1043#discussion_r405642233", "createdAt": "2020-04-08T16:09:50Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/log/LogManager.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.log;\n+\n+import com.epam.pipeline.common.MessageConstants;\n+import com.epam.pipeline.common.MessageHelper;\n+import com.epam.pipeline.entity.log.*;\n+import com.epam.pipeline.exception.PipelineException;\n+import com.epam.pipeline.manager.utils.GlobalSearchElasticHelper;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang.BooleanUtils;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+import org.elasticsearch.action.support.IndicesOptions;\n+import org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.index.query.RangeQueryBuilder;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.aggregations.AggregationBuilders;\n+import org.elasticsearch.search.aggregations.bucket.MultiBucketsAggregation;\n+import org.elasticsearch.search.aggregations.bucket.terms.Terms;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.search.sort.SortOrder;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.Assert;\n+import org.springframework.util.CollectionUtils;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.IOException;\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.time.format.DateTimeFormatter;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+@Slf4j\n+@Service\n+@Getter\n+@Setter\n+@RequiredArgsConstructor\n+public class LogManager {\n+\n+    private static final IndicesOptions INDICES_OPTIONS = IndicesOptions.fromOptions(true,\n+            SearchRequest.DEFAULT_INDICES_OPTIONS.allowNoIndices(),\n+            SearchRequest.DEFAULT_INDICES_OPTIONS.expandWildcardsOpen(),\n+            SearchRequest.DEFAULT_INDICES_OPTIONS.expandWildcardsClosed(),\n+            SearchRequest.DEFAULT_INDICES_OPTIONS);\n+\n+    private static final String USER = \"user\";\n+    private static final String TIMESTAMP = \"@timestamp\";\n+    private static final String MESSAGE_TIMESTAMP = \"message_timestamp\";\n+    private static final String HOSTNAME = \"hostname\";\n+    private static final String SERVICE_NAME = \"service_name\";\n+    private static final String TYPE = \"type\";\n+    private static final String MESSAGE = \"message\";\n+    private static final String SEVERITY = \"level\";\n+    private static final DateTimeFormatter DATE_TIME_FORMATTER =\n+            DateTimeFormatter.ofPattern(\"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\");\n+    private static final String DEFAULT_SEVERITY = \"INFO\";\n+    public static final String ID = \"_id\";\n+    public static final String SERVICE_ACCOUNT = \"service_account\";\n+\n+    private final GlobalSearchElasticHelper elasticHelper;\n+    private final MessageHelper messageHelper;\n+\n+    @Value(\"${log.security.elastic.index.prefix}\")\n+    private String indexTemplate;\n+\n+    /**\n+     * Searches log according to specified log filter.\n+     * @param logFilter - filter for constructing elasticsearch query\n+     * @return {@link LogPagination} object with related search result and additional information\n+     * */\n+    public LogPagination filter(final LogFilter logFilter) {\n+        final LogPaginationRequest pagination = logFilter.getPagination();\n+\n+        Assert.notNull(pagination, messageHelper.getMessage(MessageConstants.ERROR_PAGINATION_IS_NOT_PROVIDED));\n+        Assert.isTrue(pagination.getPageSize() > 0,\n+                messageHelper.getMessage(MessageConstants.ERROR_INVALID_PAGE_INDEX_OR_SIZE));\n+\n+        final SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder()\n+                .query(constructQueryFilter(logFilter))\n+                .sort(MESSAGE_TIMESTAMP, SortOrder.ASC)\n+                .sort(ID, SortOrder.ASC)\n+                .size(pagination.getPageSize() + 1);\n+\n+        if (logFilter.getPagination().getToken() != null) {\n+            searchSourceBuilder.searchAfter(\n+                    new Object[]{\n+                            logFilter.getPagination().getToken().getMessageTimestamp().toString(),\n+                            logFilter.getPagination().getToken().getId()\n+                    }\n+            );\n+        }\n+\n+        final SearchHits hits = verifyResponse(\n+                                    executeRequest(new SearchRequest(indexTemplate)\n+                                            .source(searchSourceBuilder)\n+                                            .indicesOptions(INDICES_OPTIONS))\n+                                ).getHits();\n+\n+        final List<LogEntry> entries = Arrays.stream(hits.getHits())\n+                .map(this::mapHitToLogEntry)\n+                .collect(Collectors.toList());\n+\n+        return LogPagination.builder()\n+                .logEntries(entries.stream().limit(pagination.getPageSize()).collect(Collectors.toList()))\n+                .pageSize(pagination.getPageSize())\n+                .token(getToken(entries, pagination.getPageSize()))\n+                .totalHits(hits.totalHits)\n+                .build();\n+    }\n+\n+    private PageMarker getToken(List<LogEntry> items, int pageSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8c9009bcbe84307e3d1d98634eb7b2b79212ca2"}, "originalPosition": 138}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "056abd13bf4a039fbf4593d8fb5b9e7d760dbba3", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/056abd13bf4a039fbf4593d8fb5b9e7d760dbba3", "committedDate": "2020-04-08T16:24:00Z", "message": "(issue #989) use final where it is possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "075ede3b31ffa80968084b82a875e4c3af73acfd", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/075ede3b31ffa80968084b82a875e4c3af73acfd", "committedDate": "2020-04-08T18:29:15Z", "message": "(issue #989) elastic aggregation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68db45b5183db812b64c628be12c476758125349", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/68db45b5183db812b64c628be12c476758125349", "committedDate": "2020-04-08T22:32:39Z", "message": "(issue #989) searchAfter filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3a4db2470dcf7dee9fc1e5dfd2ea9bd43d8fa8d", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b3a4db2470dcf7dee9fc1e5dfd2ea9bd43d8fa8d", "committedDate": "2020-04-09T09:21:49Z", "message": "GUI System logs: date locale fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed194d28cdfd63f85882404c0b66f47ff08a3ede", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ed194d28cdfd63f85882404c0b66f47ff08a3ede", "committedDate": "2020-04-09T10:33:41Z", "message": "(issue #989) use event_id as second field for searchAfter instead of _id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9e433dfc57ebcc35b5e52fa0bd2345ae143be21", "author": {"user": {"login": "rodichenko", "name": "Mikhail Rodichenko"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f9e433dfc57ebcc35b5e52fa0bd2345ae143be21", "committedDate": "2020-04-09T12:12:40Z", "message": "GUI Settings page: role model"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3820, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}