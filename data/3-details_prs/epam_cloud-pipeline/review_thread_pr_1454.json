{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2MjA1Njk4", "number": 1454, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMDo1ODo1OFrOEqrIsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMToxNToyM1rOErITMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMTgyMzg0OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/billing/BillingControllerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMDo1ODo1OFrOHdA4zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMDo1ODo1OFrOHdA4zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4NTI5Mg==", "bodyText": "Expected and actual objects should not be the same. Could you please correct this in other places too?", "url": "https://github.com/epam/cloud-pipeline/pull/1454#discussion_r500185292", "createdAt": "2020-10-06T10:58:58Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/controller/billing/BillingControllerTest.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.billing;\n+\n+import com.epam.pipeline.acl.billing.BillingApiService;\n+import com.epam.pipeline.controller.ResponseResult;\n+import com.epam.pipeline.controller.Result;\n+import com.epam.pipeline.controller.vo.billing.BillingChartRequest;\n+import com.epam.pipeline.entity.billing.BillingChartInfo;\n+import com.epam.pipeline.entity.billing.BillingGrouping;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import com.epam.pipeline.util.ControllerTestUtils;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import org.assertj.core.api.Assertions;\n+import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mockito;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+\n+import java.time.LocalDate;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+@WebMvcTest(controllers = BillingController.class)\n+public class BillingControllerTest extends AbstractControllerTest {\n+\n+    private static final long COST = 7367L;\n+    private static final String BILLING_URL = SERVLET_PATH + \"/billing\";\n+    private static final String GET_BILLING_CHART_INFO_URL = BILLING_URL + \"/charts\";\n+    private static final String GET_BILLING_CHART_INFO_PAGINATED_URL = GET_BILLING_CHART_INFO_URL + \"/pagination\";\n+    private static final String GET_BILLING_CENTERS = BILLING_URL + \"/centers\";\n+    private static final String REQUEST_JSON = \"{\\\"from\\\":\\\"-999999999-01-01\\\",\" +\n+                                                \"\\\"to\\\":\\\"+999999999-12-31\\\",\" +\n+                                                \"\\\"filters\\\":{\\\"test\\\":[\\\"test\\\"]},\" +\n+                                                \"\\\"interval\\\":\\\"1d\\\",\" +\n+                                                \"\\\"grouping\\\":\\\"BILLING_CENTER\\\",\" +\n+                                                \"\\\"loadDetails\\\":true,\" +\n+                                                \"\\\"pageSize\\\":5,\" +\n+                                                \"\\\"pageNum\\\":1}\";\n+    private BillingChartRequest billingChartRequest;\n+    private List<BillingChartInfo> billingChartInfos;\n+\n+    @Autowired\n+    private BillingApiService mockBillingApiService;\n+\n+    @Before\n+    public void setUp() {\n+        final BillingChartInfo billingChartInfo = BillingChartInfo.builder()\n+                .cost(COST)\n+                .build();\n+        billingChartRequest = new BillingChartRequest(\n+                LocalDate.MIN, LocalDate.MAX, Collections.singletonMap(\"test\", Collections.singletonList(\"test\")),\n+                DateHistogramInterval.DAY, BillingGrouping.BILLING_CENTER, true, 5L, 1L\n+        );\n+\n+        billingChartInfos = Collections.singletonList(billingChartInfo);\n+    }\n+\n+    @Test\n+    public void shouldFailGetBillingChartInfoForUnauthorizedUser() throws Exception {\n+        mvc().perform(post(GET_BILLING_CHART_INFO_URL)\n+                .servletPath(SERVLET_PATH))\n+                .andExpect(status().isUnauthorized());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnBillingChartInfo() throws Exception {\n+        Mockito.doReturn(billingChartInfos).when(mockBillingApiService).getBillingChartInfo(billingChartRequest);\n+\n+        final MvcResult mvcResult = mvc().perform(post(GET_BILLING_CHART_INFO_URL)\n+                .servletPath(SERVLET_PATH)\n+                .contentType(EXPECTED_CONTENT_TYPE)\n+                .content(REQUEST_JSON))\n+                .andExpect(status().isOk())\n+                .andExpect(content().contentType(EXPECTED_CONTENT_TYPE))\n+                .andReturn();\n+\n+        Mockito.verify(mockBillingApiService).getBillingChartInfo(billingChartRequest);\n+        final ArgumentCaptor<BillingChartRequest> billingChartRequestCaptor =\n+                ArgumentCaptor.forClass(BillingChartRequest.class);\n+        Mockito.verify(mockBillingApiService).getBillingChartInfo(billingChartRequestCaptor.capture());\n+        Assertions.assertThat(billingChartRequestCaptor).isEqualTo(billingChartRequestCaptor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d8f9fed153a03614298b491a3ebc6677de7c35"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNjYwMjExOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/com/epam/pipeline/controller/billing/BillingControllerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMToxNToyM1rOHduXUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMToxNToyM1rOHduXUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMDM4NQ==", "bodyText": "To my mind capture check is unnecessary here: you have already add mock call verification with argument. Mockito#verify would be enough.", "url": "https://github.com/epam/cloud-pipeline/pull/1454#discussion_r500930385", "createdAt": "2020-10-07T11:15:23Z", "author": {"login": "ekazachkova"}, "path": "api/src/test/java/com/epam/pipeline/controller/billing/BillingControllerTest.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.billing;\n+\n+import com.epam.pipeline.acl.billing.BillingApiService;\n+import com.epam.pipeline.controller.ResponseResult;\n+import com.epam.pipeline.controller.Result;\n+import com.epam.pipeline.controller.vo.billing.BillingChartRequest;\n+import com.epam.pipeline.entity.billing.BillingChartInfo;\n+import com.epam.pipeline.entity.billing.BillingGrouping;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import com.epam.pipeline.util.ControllerTestUtils;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import org.assertj.core.api.Assertions;\n+import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mockito;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+\n+import java.time.LocalDate;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+@WebMvcTest(controllers = BillingController.class)\n+public class BillingControllerTest extends AbstractControllerTest {\n+\n+    private static final long COST = 7367L;\n+    private static final String BILLING_URL = SERVLET_PATH + \"/billing\";\n+    private static final String GET_BILLING_CHART_INFO_URL = BILLING_URL + \"/charts\";\n+    private static final String GET_BILLING_CHART_INFO_PAGINATED_URL = GET_BILLING_CHART_INFO_URL + \"/pagination\";\n+    private static final String GET_BILLING_CENTERS = BILLING_URL + \"/centers\";\n+    private static final String REQUEST_JSON = \"{\\\"from\\\":\\\"-999999999-01-01\\\",\" +\n+                                                \"\\\"to\\\":\\\"+999999999-12-31\\\",\" +\n+                                                \"\\\"filters\\\":{\\\"test\\\":[\\\"test\\\"]},\" +\n+                                                \"\\\"interval\\\":\\\"1d\\\",\" +\n+                                                \"\\\"grouping\\\":\\\"BILLING_CENTER\\\",\" +\n+                                                \"\\\"loadDetails\\\":true,\" +\n+                                                \"\\\"pageSize\\\":5,\" +\n+                                                \"\\\"pageNum\\\":1}\";\n+    private BillingChartRequest billingChartRequest;\n+    private List<BillingChartInfo> billingChartInfos;\n+\n+    @Autowired\n+    private BillingApiService mockBillingApiService;\n+\n+    @Before\n+    public void setUp() {\n+        final BillingChartInfo billingChartInfo = BillingChartInfo.builder()\n+                .cost(COST)\n+                .build();\n+        billingChartRequest = new BillingChartRequest(\n+                LocalDate.MIN, LocalDate.MAX, Collections.singletonMap(\"test\", Collections.singletonList(\"test\")),\n+                DateHistogramInterval.DAY, BillingGrouping.BILLING_CENTER, true, 5L, 1L\n+        );\n+\n+        billingChartInfos = Collections.singletonList(billingChartInfo);\n+    }\n+\n+    @Test\n+    public void shouldFailGetBillingChartInfoForUnauthorizedUser() throws Exception {\n+        mvc().perform(post(GET_BILLING_CHART_INFO_URL)\n+                .servletPath(SERVLET_PATH))\n+                .andExpect(status().isUnauthorized());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnBillingChartInfo() throws Exception {\n+        Mockito.doReturn(billingChartInfos).when(mockBillingApiService).getBillingChartInfo(billingChartRequest);\n+\n+        final MvcResult mvcResult = mvc().perform(post(GET_BILLING_CHART_INFO_URL)\n+                .servletPath(SERVLET_PATH)\n+                .contentType(EXPECTED_CONTENT_TYPE)\n+                .content(REQUEST_JSON))\n+                .andExpect(status().isOk())\n+                .andExpect(content().contentType(EXPECTED_CONTENT_TYPE))\n+                .andReturn();\n+\n+        Mockito.verify(mockBillingApiService).getBillingChartInfo(billingChartRequest);\n+        final ArgumentCaptor<BillingChartRequest> billingChartRequestCaptor =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55b1fca18238a57dbedb9a3ba39eba0f8981566b"}, "originalPosition": 104}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 254, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}