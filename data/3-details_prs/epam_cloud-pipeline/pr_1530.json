{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNDY1MDk3", "number": 1530, "title": "Issue #1526 Billing improvements", "bodyText": "This PR is related to issue #1526\nIt brings some improvements to billing service\n\nBilling properties could be configured via environment variable\nBilling initial date could be specified using sync.billing.start.date - if no last sync time is specified this value will be used\nModify AWS price-list loading: skip price rates without USD cost specified to avoid NPE", "createdAt": "2020-10-29T18:08:56Z", "url": "https://github.com/epam/cloud-pipeline/pull/1530", "merged": true, "mergeCommit": {"oid": "88353830d062cfc4e45a3d21caf9e4b6022d432b"}, "closed": true, "closedAt": "2020-10-30T12:09:29Z", "author": {"login": "Wedds"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXStImgH2gAyNTEyNDY1MDk3OmI2YjgxMzA0YjNiYmM4MmE4ZTM2OTMwYTU5NmRiZjEyOTBlYzlhZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXkg73gH2gAyNTEyNDY1MDk3OjhiZjg2Mzg5MTBmZDM5ZTk2MDQxYTgzNTU3NjAzMTJjMjZmZDU2YjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b6b81304b3bbc82a8e36930a596dbf1290ec9af1", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b6b81304b3bbc82a8e36930a596dbf1290ec9af1", "committedDate": "2020-10-29T14:05:05Z", "message": "Issue #1526 Allow to configure billing start date in billing-report-agent properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71e84cb3bf3f99bce0eba14013a0354cd7b5c9b7", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/71e84cb3bf3f99bce0eba14013a0354cd7b5c9b7", "committedDate": "2020-10-29T16:44:47Z", "message": "Issue #1526 Implement historical storage billing generation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "837a38f1c08c271f6621f768edef0326035ecb6f", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/837a38f1c08c271f6621f768edef0326035ecb6f", "committedDate": "2020-10-29T16:47:12Z", "message": "Issue #1526 Rename property to `sync.billing.initial.date`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0519117a2cbe877f86755dd335fc03528a4b7f1", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/d0519117a2cbe877f86755dd335fc03528a4b7f1", "committedDate": "2020-10-29T16:58:10Z", "message": "Issue #1526 Add configurable billing properties to deployment config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57b0b272227a5f1a14db672e96796f7920c28907", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/57b0b272227a5f1a14db672e96796f7920c28907", "committedDate": "2020-10-29T17:43:29Z", "message": "Issue #1526 Change date creation verification for storage billing, modify tests - assign creation date to storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "376b957f279a1666fce9e254999d4e1f73283b02", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/376b957f279a1666fce9e254999d4e1f73283b02", "committedDate": "2020-10-29T18:04:35Z", "message": "Issue #1526 AWS storage price loading: filter out rates without USD cost specified to avoid NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76965bc319c3d1f854bf2896547b2a1b15947561", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/76965bc319c3d1f854bf2896547b2a1b15947561", "committedDate": "2020-10-30T08:42:41Z", "message": "Issue #1526 Fix checkstyle violations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNTAzOTM4", "url": "https://github.com/epam/cloud-pipeline/pull/1530#pullrequestreview-520503938", "createdAt": "2020-10-30T09:36:26Z", "commit": {"oid": "76965bc319c3d1f854bf2896547b2a1b15947561"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwOTozNjoyNlrOHrHbwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwOTo0MToxM1rOHrHmYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3MjYxMA==", "bodyText": "Could you also add env var to configure schedule?", "url": "https://github.com/epam/cloud-pipeline/pull/1530#discussion_r514972610", "createdAt": "2020-10-30T09:36:26Z", "author": {"login": "mzueva"}, "path": "deploy/docker/cp-billing-srv/config/application.properties", "diffHunk": "@@ -31,6 +31,7 @@ sync.submit.threads=1\n sync.billing.schedule=0 0 0 ? * *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76965bc319c3d1f854bf2896547b2a1b15947561"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NTMyOQ==", "bodyText": "Could you please make this behaviour configurable, by default we create documents only for current date, and optionally for the period", "url": "https://github.com/epam/cloud-pipeline/pull/1530#discussion_r514975329", "createdAt": "2020-10-30T09:41:13Z", "author": {"login": "mzueva"}, "path": "billing-report-agent/src/main/java/com/epam/pipeline/billingreportagent/service/impl/converter/StorageToBillingRequestConverter.java", "diffHunk": "@@ -97,10 +102,13 @@ public StorageToBillingRequestConverter(final AbstractEntityMapper<StorageBillin\n                                                          final LocalDateTime syncStart) {\n         final Long storageId = storageContainer.getEntity().getId();\n         final DataStorageType storageType = storageContainer.getEntity().getType();\n-        final LocalDate reportDate = syncStart.toLocalDate().minusDays(1);\n-        final String fullIndex = indexPrefix + parseDateToString(reportDate);\n         return requestSumAggregationForStorage(storageId, storageType)\n-            .map(searchResponse -> buildRequestFromAggregation(storageContainer, syncStart, searchResponse, fullIndex))\n+            .map(searchResponse -> Stream.iterate(previousSync.plusDays(1L), date -> date.plusDays(1))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76965bc319c3d1f854bf2896547b2a1b15947561"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3c576cf5a762bd8b295759e79f00af776e8bff6", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f3c576cf5a762bd8b295759e79f00af776e8bff6", "committedDate": "2020-10-30T09:51:38Z", "message": "Issue #1526 Allow to set billing schedule via env var in deployment config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bf8638910fd39e96041a8355760312c26fd56b0", "author": {"user": {"login": "Wedds", "name": "Andrey Georgitsa"}}, "url": "https://github.com/epam/cloud-pipeline/commit/8bf8638910fd39e96041a8355760312c26fd56b0", "committedDate": "2020-10-30T10:50:03Z", "message": "Issue #1526 Make historical billing report generation for storage configurable"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3688, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}