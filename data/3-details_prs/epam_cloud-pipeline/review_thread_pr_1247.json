{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MDQ3NTgz", "number": 1247, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODowNjo0NlrOET99gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODoyMzo1OFrOEUg0mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzczNTcxOnYy", "diffSide": "RIGHT", "path": "workflows/pipe-common/shell/install_nfs_client", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODowNjo0NlrOG5_vAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODowNjo0NlrOG5_vAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2NjI0MQ==", "bodyText": "Could you please double check that these packages linux-aws lustre-client-modules-aws can be installed on non-aws deployment runs without errors.", "url": "https://github.com/epam/cloud-pipeline/pull/1247#discussion_r463466241", "createdAt": "2020-07-31T08:06:46Z", "author": {"login": "tcibinan"}, "path": "workflows/pipe-common/shell/install_nfs_client", "diffHunk": "@@ -23,11 +23,28 @@ IS_RPM_BASED=$?\n \n if [[ \"$IS_RPM_BASED\" = 0 ]]\n then\n-    CHECK_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n-    INSTALL_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils && rpm -qa | grep lustre-client\"\n+    AMAZON_FSX_PUBLIC_KEY_URL=\"https://fsx-lustre-client-repo-public-keys.s3.amazonaws.com/fsx-rpm-public-key.asc\" &&\n+    LUSTRE_CLIENT_REPO_URL=\"https://fsx-lustre-client-repo.s3.amazonaws.com/el/$(. /etc/os-release;echo $VERSION_ID)/fsx-lustre-client.repo\" &&\n+    read -r -d '' INSTALL_CMD <<- EOM\n+      yum install nfs-utils cifs-utils wget -y -q &&\n+      wget $AMAZON_FSX_PUBLIC_KEY_URL -qO /tmp/fsx-rpm-public-key.asc &&\n+      rpm --import /tmp/fsx-rpm-public-key.asc &&\n+      wget $LUSTRE_CLIENT_REPO_URL -qO /etc/yum.repos.d/aws-fsx.repo &&\n+      yum install -y -q kmod-lustre-client lustre-client &&\n+      rm -f /tmp/fsx-rpm-public-key.asc /etc/yum.repos.d/aws-fsx.repo\n+EOM\n else\n-    CHECK_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n-    INSTALL_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils && dpkg -l | grep lustre-client\"\n+    AMAZON_FSX_PUBLIC_KEY_URL=\"https://fsx-lustre-client-repo-public-keys.s3.amazonaws.com/fsx-ubuntu-public-key.asc\"\n+    LUSTRE_CLIENT_REPO_URL=\"https://fsx-lustre-client-repo.s3.amazonaws.com/$(. /etc/os-release;echo $ID $VERSION_CODENAME)\"\n+    read -r -d '' INSTALL_CMD <<- EOM\n+      apt-get install wget apt-utils -y -qq  &&\n+      wget -qO- $AMAZON_FSX_PUBLIC_KEY_URL | apt-key add - &&\n+      echo \"deb $LUSTRE_CLIENT_REPO_URL main\" > /etc/apt/sources.list.d/fsxlustreclientrepo.list && apt-get update -qq &&\n+      mkdir -p /lib/modules/$(uname -r) &&\n+      apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils linux-aws lustre-client-modules-aws -y > /dev/null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08d04536803da494d7390e21c6778c83ff2bc9c2"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5OTQxODIzOnYy", "diffSide": "RIGHT", "path": "workflows/pipe-common/shell/install_nfs_client", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODoxNDo1MlrOG6wNQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODozOTowNlrOG6w81A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI2MDQxOQ==", "bodyText": "Let's write logs to a little bit more appropriate location like /var/log/lustre_client_installation.log.", "url": "https://github.com/epam/cloud-pipeline/pull/1247#discussion_r464260419", "createdAt": "2020-08-03T08:14:52Z", "author": {"login": "tcibinan"}, "path": "workflows/pipe-common/shell/install_nfs_client", "diffHunk": "@@ -23,31 +23,86 @@ IS_RPM_BASED=$?\n \n if [[ \"$IS_RPM_BASED\" = 0 ]]\n then\n-    CHECK_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n-    INSTALL_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_NFS_SMB_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n+    INSTALL_NFS_SMB_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_LUSTRE_CMD=\"rpm -qa | grep lustre-client\"\n+    OS_VERSION_ID=$(. /etc/os-release;echo $VERSION_ID)\n+    LUSTRE_VERSION=$([ $OS_VERSION_ID -eq 6 ] && echo \"2.10.8-1\" || echo \"2.12.5-1\")\n+    LUSTRE_VERSION=\"$LUSTRE_VERSION.el$OS_VERSION_ID.x86_64\"\n+    LUSTRE_CLIENT_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/rpm/lustre-client-$LUSTRE_VERSION.rpm\"\n+    LUSTRE_KMOD_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/rpm/kmod-lustre-client-$LUSTRE_VERSION.rpm\"\n+    read -r -d '' INSTALL_LUSTRE_CMD <<- EOM\n+      yum install -y -q wget &&\n+      wget -q $LUSTRE_KMOD_URL -O kmod-lustre-client.rpm &&\n+      wget -q $LUSTRE_CLIENT_URL -O lustre-client.rpm &&\n+      yum install -y -q kmod-lustre-client.rpm lustre-client.rpm &&\n+      rm -f *lustre-client.rpm\n+EOM\n else\n-    CHECK_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n-    INSTALL_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_NFS_SMB_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n+    INSTALL_NFS_SMB_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_LUSTRE_CMD=\"dpkg -l | grep lustre-client\"\n+    LUSTRE_VERSION=$(. /etc/os-release;echo $ID-$VERSION_CODENAME)\n+    LUSTRE_CLIENT_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/deb/lustre-client-$LUSTRE_VERSION.tar.gz\"\n+    read -r -d '' INSTALL_LUSTRE_CMD <<- EOM\n+      apt-get install wget -y -qq  &&\n+      wget -q $LUSTRE_CLIENT_URL -O lustre-client.tar.gz &&\n+      mkdir lustre-client-install/ &&\n+      tar -C lustre-client-install/ -zxvf lustre-client.tar.gz &&\n+      mkdir -p /lib/modules/$(uname -r) &&\n+      dpkg -i lustre-client-install/* &&\n+      rm -rf lustre-client-install/ lustre-client.tar.gz\n+EOM\n fi\n \n-eval \"$CHECK_CMD\"\n+eval \"$CHECK_LUSTRE_CMD\"\n+IS_LUSTRE_INSTALLED=$?\n+\n+eval \"$CHECK_NFS_SMB_CMD\"\n+IS_NFS_SMB_INSTALLED=$?\n \n ######################################################\n # If NFS client is already installed - skip installation, otherwise install\n ######################################################\n-if [ $? -ne 0 ]\n+if [ $IS_NFS_SMB_INSTALLED -eq 0 ] && [ $IS_LUSTRE_INSTALLED -eq 0 ]\n then\n+    pipe_log_info \"--> NFS client is already installed\" \"$NFS_INSTALL_TASK\"\n+else\n     pipe_log_info \"--> NFS client not found, proceeding with installation\" \"$NFS_INSTALL_TASK\"\n-    pipe_log_info \"--> Installing NFS client\" \"$NFS_INSTALL_TASK\"\n-    eval \"$INSTALL_CMD\"\n-    if [ $? -ne 0 ]\n+    pipe_log_info \"--> Installing NFS clients\" \"$NFS_INSTALL_TASK\"\n+    if [ $IS_NFS_SMB_INSTALLED -ne 0 ]\n     then\n-        pipe_log_fail \"Failed to install NFS client, process will not continue with shared FS initialization\" \"$NFS_INSTALL_TASK\"\n-        exit 1\n+        pipe_log_info \"--> Installing [nfs, smb] client\" \"$NFS_INSTALL_TASK\"\n+        eval \"$INSTALL_NFS_SMB_CMD\"\n+        if [ $? -ne 0 ]\n+        then\n+            pipe_log_fail \"Failed to install NFS client [nfs, smb], process will not continue with shared FS initialization\" \"$NFS_INSTALL_TASK\"\n+            exit 1\n+        else\n+            pipe_log_info \"--> NFS client [nfs, smb] installed successfully\" \"$NFS_INSTALL_TASK\"\n+        fi\n+    else\n+        pipe_log_info \"--> NFS client [nfs, smb] installed already\" \"$NFS_INSTALL_TASK\"\n     fi\n-    pipe_log_info \"--> NFS client installed\" \"$NFS_INSTALL_TASK\"\n-else\n-    pipe_log_info \"--> NFS client is already installed\" \"$NFS_INSTALL_TASK\"\n+    if [ $IS_LUSTRE_INSTALLED -ne 0 ]\n+    then\n+        pipe_log_info \"--> Installing [lustre] client\" \"$NFS_INSTALL_TASK\"\n+        LUSTRE_INSTALLATION_LOG=\"/run/lustre_client_installation.log\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a184969495dbc847882585134c3545cdf910b570"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3MjU5Ng==", "bodyText": "Done", "url": "https://github.com/epam/cloud-pipeline/pull/1247#discussion_r464272596", "createdAt": "2020-08-03T08:39:06Z", "author": {"login": "Wedds"}, "path": "workflows/pipe-common/shell/install_nfs_client", "diffHunk": "@@ -23,31 +23,86 @@ IS_RPM_BASED=$?\n \n if [[ \"$IS_RPM_BASED\" = 0 ]]\n then\n-    CHECK_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n-    INSTALL_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_NFS_SMB_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n+    INSTALL_NFS_SMB_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_LUSTRE_CMD=\"rpm -qa | grep lustre-client\"\n+    OS_VERSION_ID=$(. /etc/os-release;echo $VERSION_ID)\n+    LUSTRE_VERSION=$([ $OS_VERSION_ID -eq 6 ] && echo \"2.10.8-1\" || echo \"2.12.5-1\")\n+    LUSTRE_VERSION=\"$LUSTRE_VERSION.el$OS_VERSION_ID.x86_64\"\n+    LUSTRE_CLIENT_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/rpm/lustre-client-$LUSTRE_VERSION.rpm\"\n+    LUSTRE_KMOD_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/rpm/kmod-lustre-client-$LUSTRE_VERSION.rpm\"\n+    read -r -d '' INSTALL_LUSTRE_CMD <<- EOM\n+      yum install -y -q wget &&\n+      wget -q $LUSTRE_KMOD_URL -O kmod-lustre-client.rpm &&\n+      wget -q $LUSTRE_CLIENT_URL -O lustre-client.rpm &&\n+      yum install -y -q kmod-lustre-client.rpm lustre-client.rpm &&\n+      rm -f *lustre-client.rpm\n+EOM\n else\n-    CHECK_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n-    INSTALL_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_NFS_SMB_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n+    INSTALL_NFS_SMB_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_LUSTRE_CMD=\"dpkg -l | grep lustre-client\"\n+    LUSTRE_VERSION=$(. /etc/os-release;echo $ID-$VERSION_CODENAME)\n+    LUSTRE_CLIENT_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/deb/lustre-client-$LUSTRE_VERSION.tar.gz\"\n+    read -r -d '' INSTALL_LUSTRE_CMD <<- EOM\n+      apt-get install wget -y -qq  &&\n+      wget -q $LUSTRE_CLIENT_URL -O lustre-client.tar.gz &&\n+      mkdir lustre-client-install/ &&\n+      tar -C lustre-client-install/ -zxvf lustre-client.tar.gz &&\n+      mkdir -p /lib/modules/$(uname -r) &&\n+      dpkg -i lustre-client-install/* &&\n+      rm -rf lustre-client-install/ lustre-client.tar.gz\n+EOM\n fi\n \n-eval \"$CHECK_CMD\"\n+eval \"$CHECK_LUSTRE_CMD\"\n+IS_LUSTRE_INSTALLED=$?\n+\n+eval \"$CHECK_NFS_SMB_CMD\"\n+IS_NFS_SMB_INSTALLED=$?\n \n ######################################################\n # If NFS client is already installed - skip installation, otherwise install\n ######################################################\n-if [ $? -ne 0 ]\n+if [ $IS_NFS_SMB_INSTALLED -eq 0 ] && [ $IS_LUSTRE_INSTALLED -eq 0 ]\n then\n+    pipe_log_info \"--> NFS client is already installed\" \"$NFS_INSTALL_TASK\"\n+else\n     pipe_log_info \"--> NFS client not found, proceeding with installation\" \"$NFS_INSTALL_TASK\"\n-    pipe_log_info \"--> Installing NFS client\" \"$NFS_INSTALL_TASK\"\n-    eval \"$INSTALL_CMD\"\n-    if [ $? -ne 0 ]\n+    pipe_log_info \"--> Installing NFS clients\" \"$NFS_INSTALL_TASK\"\n+    if [ $IS_NFS_SMB_INSTALLED -ne 0 ]\n     then\n-        pipe_log_fail \"Failed to install NFS client, process will not continue with shared FS initialization\" \"$NFS_INSTALL_TASK\"\n-        exit 1\n+        pipe_log_info \"--> Installing [nfs, smb] client\" \"$NFS_INSTALL_TASK\"\n+        eval \"$INSTALL_NFS_SMB_CMD\"\n+        if [ $? -ne 0 ]\n+        then\n+            pipe_log_fail \"Failed to install NFS client [nfs, smb], process will not continue with shared FS initialization\" \"$NFS_INSTALL_TASK\"\n+            exit 1\n+        else\n+            pipe_log_info \"--> NFS client [nfs, smb] installed successfully\" \"$NFS_INSTALL_TASK\"\n+        fi\n+    else\n+        pipe_log_info \"--> NFS client [nfs, smb] installed already\" \"$NFS_INSTALL_TASK\"\n     fi\n-    pipe_log_info \"--> NFS client installed\" \"$NFS_INSTALL_TASK\"\n-else\n-    pipe_log_info \"--> NFS client is already installed\" \"$NFS_INSTALL_TASK\"\n+    if [ $IS_LUSTRE_INSTALLED -ne 0 ]\n+    then\n+        pipe_log_info \"--> Installing [lustre] client\" \"$NFS_INSTALL_TASK\"\n+        LUSTRE_INSTALLATION_LOG=\"/run/lustre_client_installation.log\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI2MDQxOQ=="}, "originalCommit": {"oid": "a184969495dbc847882585134c3545cdf910b570"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5OTQ0NzI4OnYy", "diffSide": "RIGHT", "path": "workflows/pipe-common/shell/install_nfs_client", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODoyMzo1OFrOG6weng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODozOToxMVrOG6w8-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI2NDg2Mg==", "bodyText": "I suppose there is no need to explicitly check for lustre availability. If lustre doesn't work in container then the corresponding shares mounting will just fail anyway with more precise logs.", "url": "https://github.com/epam/cloud-pipeline/pull/1247#discussion_r464264862", "createdAt": "2020-08-03T08:23:58Z", "author": {"login": "tcibinan"}, "path": "workflows/pipe-common/shell/install_nfs_client", "diffHunk": "@@ -23,31 +23,86 @@ IS_RPM_BASED=$?\n \n if [[ \"$IS_RPM_BASED\" = 0 ]]\n then\n-    CHECK_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n-    INSTALL_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_NFS_SMB_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n+    INSTALL_NFS_SMB_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_LUSTRE_CMD=\"rpm -qa | grep lustre-client\"\n+    OS_VERSION_ID=$(. /etc/os-release;echo $VERSION_ID)\n+    LUSTRE_VERSION=$([ $OS_VERSION_ID -eq 6 ] && echo \"2.10.8-1\" || echo \"2.12.5-1\")\n+    LUSTRE_VERSION=\"$LUSTRE_VERSION.el$OS_VERSION_ID.x86_64\"\n+    LUSTRE_CLIENT_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/rpm/lustre-client-$LUSTRE_VERSION.rpm\"\n+    LUSTRE_KMOD_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/rpm/kmod-lustre-client-$LUSTRE_VERSION.rpm\"\n+    read -r -d '' INSTALL_LUSTRE_CMD <<- EOM\n+      yum install -y -q wget &&\n+      wget -q $LUSTRE_KMOD_URL -O kmod-lustre-client.rpm &&\n+      wget -q $LUSTRE_CLIENT_URL -O lustre-client.rpm &&\n+      yum install -y -q kmod-lustre-client.rpm lustre-client.rpm &&\n+      rm -f *lustre-client.rpm\n+EOM\n else\n-    CHECK_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n-    INSTALL_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_NFS_SMB_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n+    INSTALL_NFS_SMB_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_LUSTRE_CMD=\"dpkg -l | grep lustre-client\"\n+    LUSTRE_VERSION=$(. /etc/os-release;echo $ID-$VERSION_CODENAME)\n+    LUSTRE_CLIENT_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/deb/lustre-client-$LUSTRE_VERSION.tar.gz\"\n+    read -r -d '' INSTALL_LUSTRE_CMD <<- EOM\n+      apt-get install wget -y -qq  &&\n+      wget -q $LUSTRE_CLIENT_URL -O lustre-client.tar.gz &&\n+      mkdir lustre-client-install/ &&\n+      tar -C lustre-client-install/ -zxvf lustre-client.tar.gz &&\n+      mkdir -p /lib/modules/$(uname -r) &&\n+      dpkg -i lustre-client-install/* &&\n+      rm -rf lustre-client-install/ lustre-client.tar.gz\n+EOM\n fi\n \n-eval \"$CHECK_CMD\"\n+eval \"$CHECK_LUSTRE_CMD\"\n+IS_LUSTRE_INSTALLED=$?\n+\n+eval \"$CHECK_NFS_SMB_CMD\"\n+IS_NFS_SMB_INSTALLED=$?\n \n ######################################################\n # If NFS client is already installed - skip installation, otherwise install\n ######################################################\n-if [ $? -ne 0 ]\n+if [ $IS_NFS_SMB_INSTALLED -eq 0 ] && [ $IS_LUSTRE_INSTALLED -eq 0 ]\n then\n+    pipe_log_info \"--> NFS client is already installed\" \"$NFS_INSTALL_TASK\"\n+else\n     pipe_log_info \"--> NFS client not found, proceeding with installation\" \"$NFS_INSTALL_TASK\"\n-    pipe_log_info \"--> Installing NFS client\" \"$NFS_INSTALL_TASK\"\n-    eval \"$INSTALL_CMD\"\n-    if [ $? -ne 0 ]\n+    pipe_log_info \"--> Installing NFS clients\" \"$NFS_INSTALL_TASK\"\n+    if [ $IS_NFS_SMB_INSTALLED -ne 0 ]\n     then\n-        pipe_log_fail \"Failed to install NFS client, process will not continue with shared FS initialization\" \"$NFS_INSTALL_TASK\"\n-        exit 1\n+        pipe_log_info \"--> Installing [nfs, smb] client\" \"$NFS_INSTALL_TASK\"\n+        eval \"$INSTALL_NFS_SMB_CMD\"\n+        if [ $? -ne 0 ]\n+        then\n+            pipe_log_fail \"Failed to install NFS client [nfs, smb], process will not continue with shared FS initialization\" \"$NFS_INSTALL_TASK\"\n+            exit 1\n+        else\n+            pipe_log_info \"--> NFS client [nfs, smb] installed successfully\" \"$NFS_INSTALL_TASK\"\n+        fi\n+    else\n+        pipe_log_info \"--> NFS client [nfs, smb] installed already\" \"$NFS_INSTALL_TASK\"\n     fi\n-    pipe_log_info \"--> NFS client installed\" \"$NFS_INSTALL_TASK\"\n-else\n-    pipe_log_info \"--> NFS client is already installed\" \"$NFS_INSTALL_TASK\"\n+    if [ $IS_LUSTRE_INSTALLED -ne 0 ]\n+    then\n+        pipe_log_info \"--> Installing [lustre] client\" \"$NFS_INSTALL_TASK\"\n+        LUSTRE_INSTALLATION_LOG=\"/run/lustre_client_installation.log\"\n+        eval \"$INSTALL_LUSTRE_CMD\" > $LUSTRE_INSTALLATION_LOG 2>&1\n+        if [ $? -ne 0 ]\n+        then\n+            pipe_log_fail \"Errors occured during NFS client [lustre] installation, check $LUSTRE_INSTALLATION_LOG for more details\" \"$NFS_INSTALL_TASK\"\n+        else\n+            pipe_log_info \"--> NFS client packages [lustre] installed successfully\" \"$NFS_INSTALL_TASK\"\n+        fi\n+    else\n+        pipe_log_info \"--> NFS client packages [lustre] installed already\" \"$NFS_INSTALL_TASK\"\n+    fi\n+    eval \"df -t lustre\" > /dev/null 2>&1\n+    if [[ -z $(cat /proc/filesystems | grep lustre) ]]; then\n+        pipe_log_warn \"--> [lustre] filesystem is not available. \" \"$NFS_INSTALL_TASK\"\n+    fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a184969495dbc847882585134c3545cdf910b570"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3MjYzNA==", "bodyText": "Done", "url": "https://github.com/epam/cloud-pipeline/pull/1247#discussion_r464272634", "createdAt": "2020-08-03T08:39:11Z", "author": {"login": "Wedds"}, "path": "workflows/pipe-common/shell/install_nfs_client", "diffHunk": "@@ -23,31 +23,86 @@ IS_RPM_BASED=$?\n \n if [[ \"$IS_RPM_BASED\" = 0 ]]\n then\n-    CHECK_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n-    INSTALL_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_NFS_SMB_CMD=\"rpm -qa | grep nfs-utils && rpm -qa | grep cifs-utils\"\n+    INSTALL_NFS_SMB_CMD=\"yum install nfs-utils cifs-utils -y -q\"\n+    CHECK_LUSTRE_CMD=\"rpm -qa | grep lustre-client\"\n+    OS_VERSION_ID=$(. /etc/os-release;echo $VERSION_ID)\n+    LUSTRE_VERSION=$([ $OS_VERSION_ID -eq 6 ] && echo \"2.10.8-1\" || echo \"2.12.5-1\")\n+    LUSTRE_VERSION=\"$LUSTRE_VERSION.el$OS_VERSION_ID.x86_64\"\n+    LUSTRE_CLIENT_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/rpm/lustre-client-$LUSTRE_VERSION.rpm\"\n+    LUSTRE_KMOD_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/rpm/kmod-lustre-client-$LUSTRE_VERSION.rpm\"\n+    read -r -d '' INSTALL_LUSTRE_CMD <<- EOM\n+      yum install -y -q wget &&\n+      wget -q $LUSTRE_KMOD_URL -O kmod-lustre-client.rpm &&\n+      wget -q $LUSTRE_CLIENT_URL -O lustre-client.rpm &&\n+      yum install -y -q kmod-lustre-client.rpm lustre-client.rpm &&\n+      rm -f *lustre-client.rpm\n+EOM\n else\n-    CHECK_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n-    INSTALL_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_NFS_SMB_CMD=\"dpkg -l | grep nfs-common && dpkg -l | grep cifs-utils\"\n+    INSTALL_NFS_SMB_CMD='apt-get install -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" nfs-common cifs-utils -y -qq'\n+    CHECK_LUSTRE_CMD=\"dpkg -l | grep lustre-client\"\n+    LUSTRE_VERSION=$(. /etc/os-release;echo $ID-$VERSION_CODENAME)\n+    LUSTRE_CLIENT_URL=\"https://cloud-pipeline-oss-builds.s3.amazonaws.com/tools/lustre/client/deb/lustre-client-$LUSTRE_VERSION.tar.gz\"\n+    read -r -d '' INSTALL_LUSTRE_CMD <<- EOM\n+      apt-get install wget -y -qq  &&\n+      wget -q $LUSTRE_CLIENT_URL -O lustre-client.tar.gz &&\n+      mkdir lustre-client-install/ &&\n+      tar -C lustre-client-install/ -zxvf lustre-client.tar.gz &&\n+      mkdir -p /lib/modules/$(uname -r) &&\n+      dpkg -i lustre-client-install/* &&\n+      rm -rf lustre-client-install/ lustre-client.tar.gz\n+EOM\n fi\n \n-eval \"$CHECK_CMD\"\n+eval \"$CHECK_LUSTRE_CMD\"\n+IS_LUSTRE_INSTALLED=$?\n+\n+eval \"$CHECK_NFS_SMB_CMD\"\n+IS_NFS_SMB_INSTALLED=$?\n \n ######################################################\n # If NFS client is already installed - skip installation, otherwise install\n ######################################################\n-if [ $? -ne 0 ]\n+if [ $IS_NFS_SMB_INSTALLED -eq 0 ] && [ $IS_LUSTRE_INSTALLED -eq 0 ]\n then\n+    pipe_log_info \"--> NFS client is already installed\" \"$NFS_INSTALL_TASK\"\n+else\n     pipe_log_info \"--> NFS client not found, proceeding with installation\" \"$NFS_INSTALL_TASK\"\n-    pipe_log_info \"--> Installing NFS client\" \"$NFS_INSTALL_TASK\"\n-    eval \"$INSTALL_CMD\"\n-    if [ $? -ne 0 ]\n+    pipe_log_info \"--> Installing NFS clients\" \"$NFS_INSTALL_TASK\"\n+    if [ $IS_NFS_SMB_INSTALLED -ne 0 ]\n     then\n-        pipe_log_fail \"Failed to install NFS client, process will not continue with shared FS initialization\" \"$NFS_INSTALL_TASK\"\n-        exit 1\n+        pipe_log_info \"--> Installing [nfs, smb] client\" \"$NFS_INSTALL_TASK\"\n+        eval \"$INSTALL_NFS_SMB_CMD\"\n+        if [ $? -ne 0 ]\n+        then\n+            pipe_log_fail \"Failed to install NFS client [nfs, smb], process will not continue with shared FS initialization\" \"$NFS_INSTALL_TASK\"\n+            exit 1\n+        else\n+            pipe_log_info \"--> NFS client [nfs, smb] installed successfully\" \"$NFS_INSTALL_TASK\"\n+        fi\n+    else\n+        pipe_log_info \"--> NFS client [nfs, smb] installed already\" \"$NFS_INSTALL_TASK\"\n     fi\n-    pipe_log_info \"--> NFS client installed\" \"$NFS_INSTALL_TASK\"\n-else\n-    pipe_log_info \"--> NFS client is already installed\" \"$NFS_INSTALL_TASK\"\n+    if [ $IS_LUSTRE_INSTALLED -ne 0 ]\n+    then\n+        pipe_log_info \"--> Installing [lustre] client\" \"$NFS_INSTALL_TASK\"\n+        LUSTRE_INSTALLATION_LOG=\"/run/lustre_client_installation.log\"\n+        eval \"$INSTALL_LUSTRE_CMD\" > $LUSTRE_INSTALLATION_LOG 2>&1\n+        if [ $? -ne 0 ]\n+        then\n+            pipe_log_fail \"Errors occured during NFS client [lustre] installation, check $LUSTRE_INSTALLATION_LOG for more details\" \"$NFS_INSTALL_TASK\"\n+        else\n+            pipe_log_info \"--> NFS client packages [lustre] installed successfully\" \"$NFS_INSTALL_TASK\"\n+        fi\n+    else\n+        pipe_log_info \"--> NFS client packages [lustre] installed already\" \"$NFS_INSTALL_TASK\"\n+    fi\n+    eval \"df -t lustre\" > /dev/null 2>&1\n+    if [[ -z $(cat /proc/filesystems | grep lustre) ]]; then\n+        pipe_log_warn \"--> [lustre] filesystem is not available. \" \"$NFS_INSTALL_TASK\"\n+    fi", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI2NDg2Mg=="}, "originalCommit": {"oid": "a184969495dbc847882585134c3545cdf910b570"}, "originalPosition": 96}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 411, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}