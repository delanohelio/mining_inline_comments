{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjA3NDg0", "number": 1078, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyMTo1MVrOD6k5dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyNDoyMVrOD6k8Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNzQ4NTMzOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/com/epam/pipeline/manager/region/CloudRegionManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyMTo1MVrOGSfThA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyMTo1MVrOGSfThA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MDQ1Mg==", "bodyText": "This code duplicates logic in aspect, I'd suggest to move it to a separate service and use it in aspect and in onApplicationEvent  method", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422040452", "createdAt": "2020-05-08T09:21:51Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/region/CloudRegionManager.java", "diffHunk": "@@ -223,6 +238,33 @@ public AbstractCloudRegion loadOrDefault(final Long id) {\n                 .orElseGet(this::loadDefaultRegion);\n     }\n \n+    public void refreshCloudRegionCredKubeSecret() {\n+        log.debug(\"Create Kube secret with cloud region creds if it does not exist.\");\n+        if (!kubernetesManager.isSecretExist(CP_REGION_CREDS_SECRET)) {\n+            log.warn(\"Secret: \" + CP_REGION_CREDS_SECRET + \" doesn't exist!\");\n+            return;\n+        }\n+        kubernetesManager.refreshSecret(CP_REGION_CREDS_SECRET,\n+                loadAll()\n+                        .stream()\n+                        .filter(region -> region.getProvider().equals(CloudProvider.AZURE))\n+                        .map(region -> (AzureRegion) region)\n+                        .collect(\n+                                Collectors.toMap(azureRegion -> azureRegion.getId().toString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNzQ4NzQzOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/com/epam/pipeline/manager/region/CloudRegionManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyMjozOVrOGSfU1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyMjozOVrOGSfU1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MDc5MA==", "bodyText": "Maybe extract this code to some util method or class, since such conversion is used several times", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422040790", "createdAt": "2020-05-08T09:22:39Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/region/CloudRegionManager.java", "diffHunk": "@@ -223,6 +238,33 @@ public AbstractCloudRegion loadOrDefault(final Long id) {\n                 .orElseGet(this::loadDefaultRegion);\n     }\n \n+    public void refreshCloudRegionCredKubeSecret() {\n+        log.debug(\"Create Kube secret with cloud region creds if it does not exist.\");\n+        if (!kubernetesManager.isSecretExist(CP_REGION_CREDS_SECRET)) {\n+            log.warn(\"Secret: \" + CP_REGION_CREDS_SECRET + \" doesn't exist!\");\n+            return;\n+        }\n+        kubernetesManager.refreshSecret(CP_REGION_CREDS_SECRET,\n+                loadAll()\n+                        .stream()\n+                        .filter(region -> region.getProvider().equals(CloudProvider.AZURE))\n+                        .map(region -> (AzureRegion) region)\n+                        .collect(\n+                                Collectors.toMap(azureRegion -> azureRegion.getId().toString(),\n+                                        azureRegion ->  {\n+                                            final HashMap<String, String> creds = new HashMap<>();\n+                                            creds.put(STORAGE_ACCOUNT, azureRegion.getStorageAccount());\n+                                            creds.put(STORAGE_KEY, loadCredentials(azureRegion).getStorageAccountKey());\n+                                            try {\n+                                                return Base64.encodeBase64String(mapper.writeValueAsString(creds).getBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNzQ5MjYzOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/KubernetesManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyNDoyMVrOGSfX6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyNDoyMVrOGSfX6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MTU3OA==", "bodyText": "I think it is better to call methods doesSecretExist", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422041578", "createdAt": "2020-05-08T09:24:21Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/cluster/KubernetesManager.java", "diffHunk": "@@ -167,6 +199,15 @@ public String createDockerRegistrySecret(DockerRegistrySecret secret) {\n         }\n     }\n \n+    public boolean isSecretExist(final String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 436, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}