{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzOTE0MTYw", "number": 1534, "title": "Implement passwordless ssh support in pipe tunnel", "bodyText": "Relates to #1501 and depends on #1502.\nThe pull request introduces additional -s | --ssh option for pipe tunnel which once specified configures passwordless ssh connections to run instances.\nSee pipe tunnel --help output for more information:\n  Establishes tunnel connection to specified run instance port and serves it\n  as a local port.\n\n  It allows to transfer any tcp traffic from local machine to run instance\n  and works both on Linux and Windows.\n\n  Additionally it enables passwordless ssh connections if the corresponding\n  option is specified. Once specified ssh is configured both locally and\n  remotely to support passwordless connections. Passwordless ssh\n  configuration is supported only for openssh client on Linux.\n\n  Examples:\n\n  I. Example of simple tcp port tunnel connection establishing.\n\n  Establish tunnel connection from run (12345) instance port (4567) to the\n  same local port.\n\n      pipe tunnel -lp 4567 -rp 4567 12345\n\n  II. Example of ssh port tunnel connection establishing with enabled\n  passwordless ssh configuration.\n\n  First of all establish tunnel connection from run (12345) instance ssh\n  port (22) to some local port (4567).\n\n      pipe tunnel -lp 4567 -rp 22 --ssh 12345\n\n  Then connect to run instance using regular ssh client.\n\n      ssh root@pipeline-12345\n\n  Or transfer some files to and from run instance using regular scp client.\n\n      scp file.txt root@pipeline-12345:/common/workdir/file.txt\n\n  Additionally the following environment variables can be used to specify\n  the exact tunnel properties.\n\n      CP_CLI_TUNNEL_PROXY_HOST\n      CP_CLI_TUNNEL_PROXY_PORT\n      CP_CLI_TUNNEL_TARGET_HOST", "createdAt": "2020-11-02T09:13:15Z", "url": "https://github.com/epam/cloud-pipeline/pull/1534", "merged": true, "mergeCommit": {"oid": "42c0a5a787720173090c55653c5ba45b61e03f07"}, "closed": true, "closedAt": "2020-11-17T14:57:42Z", "author": {"login": "tcibinan"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYk2eVAFqTUyMTY0MTEyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdda1DRgBqjQwMDU4OTI0ODE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNjQxMTI3", "url": "https://github.com/epam/cloud-pipeline/pull/1534#pullrequestreview-521641127", "createdAt": "2020-11-02T13:47:30Z", "commit": {"oid": "1377ddf3a63a0df07200bfe003013775c033f9d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2241b32b7a75dd700962a5f74295b9feff120d9f", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/2241b32b7a75dd700962a5f74295b9feff120d9f", "committedDate": "2020-11-05T08:57:09Z", "message": "Add proper error handling and allow changing default timeout"}, "afterCommit": {"oid": "7d94123f468bcaec0c03553cf0218b1c7872029c", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7d94123f468bcaec0c03553cf0218b1c7872029c", "committedDate": "2020-11-05T12:33:11Z", "message": "Add proper error handling and allow changing default timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzgyNDEx", "url": "https://github.com/epam/cloud-pipeline/pull/1534#pullrequestreview-532382411", "createdAt": "2020-11-17T13:53:37Z", "commit": {"oid": "fbdb1d1041737a560b9c0b3fc15a69af15e83d5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzg1MjIz", "url": "https://github.com/epam/cloud-pipeline/pull/1534#pullrequestreview-532385223", "createdAt": "2020-11-17T13:56:33Z", "commit": {"oid": "fbdb1d1041737a560b9c0b3fc15a69af15e83d5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMzo1NjozNFrOH02BLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMzo1NjozNFrOH02BLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MzAzOA==", "bodyText": "If the goal is to print stack trace we can use something like traceback.print_exc() in except section", "url": "https://github.com/epam/cloud-pipeline/pull/1534#discussion_r525173038", "createdAt": "2020-11-17T13:56:34Z", "author": {"login": "mzueva"}, "path": "pipe-cli/pipe.py", "diffHunk": "@@ -1226,42 +1227,82 @@ def ssh(ctx, run_id, retries):\n @click.argument('run-id', required=True, type=int)\n @click.option('-lp', '--local-port', required=True, type=int, help='Local port to establish connection from')\n @click.option('-rp', '--remote-port', required=True, type=int, help='Remote port to establish connection to')\n+@click.option('-ct', '--connection-timeout', required=False, type=float, default=0,\n+              help='Socket connection timeout in seconds')\n+@click.option('-s', '--ssh', required=False, is_flag=True, default=False,\n+              help='Configures passwordless ssh to specified run instance. '\n+                   'Supported on Linux only.')\n+@click.option('-sp', '--ssh-path', required=False, type=str,\n+              help='Path to .ssh directory for passwordless ssh configuration')\n+@click.option('-sh', '--ssh-host', required=False, type=str,\n+              help='Host name for passwordless ssh configuration')\n+@click.option('-sk', '--ssh-keep', required=False, is_flag=True, default=False,\n+              help='Keeps passwordless ssh configuration after tunnel stopping')\n @click.option('-l', '--log-file', required=False, help='Logs file for tunnel in background mode')\n @click.option('-v', '--log-level', required=False, help='Logs level for tunnel: '\n                                                         'CRITICAL, ERROR, WARNING, INFO or DEBUG')\n-@click.option('-t', '--timeout', required=False, type=int, default=1000,\n+@click.option('-t', '--timeout', required=False, type=int, default=5 * 1000,\n               help='Time period in ms for background tunnel process health check')\n @click.option('-f', '--foreground', required=False, is_flag=True, default=False,\n               help='Establishes tunnel in foreground mode')\n @click.option('-u', '--user', required=False, callback=set_user_token, expose_value=False, help=USER_OPTION_DESCRIPTION)\n+@click.option('-r', '--retries', required=False, type=int, default=10, help=RETRIES_OPTION_DESCRIPTION)\n+@click.option('--trace', required=False, is_flag=True, default=False, help=TRACE_OPTION_DESCRIPTION)\n @Config.validate_access_token\n-def tunnel(run_id, local_port, remote_port, log_file, log_level, timeout, foreground):\n+def tunnel(run_id, local_port, remote_port, connection_timeout,\n+           ssh, ssh_path, ssh_host, ssh_keep, log_file, log_level,\n+           timeout, foreground, retries, trace):\n     \"\"\"\n     Establishes tunnel connection to specified run instance port and serves it as a local port.\n \n     It allows to transfer any tcp traffic from local machine to run instance and works both on Linux and Windows.\n \n-    For example it can be used to allow ssh connections to run instance.\n+    Additionally it enables passwordless ssh connections if the corresponding option is specified.\n+    Once specified ssh is configured both locally and remotely to support passwordless connections.\n+    Passwordless ssh configuration is supported only for openssh client on Linux.\n+\n+    Examples:\n+\n+    I. Example of simple tcp port tunnel connection establishing.\n+\n+    Establish tunnel connection from run (12345) instance port (4567) to the same local port.\n+\n+        pipe tunnel -lp 4567 -rp 4567 12345\n+\n+    II. Example of ssh port tunnel connection establishing with enabled passwordless ssh configuration.\n \n-    \\b\n     First of all establish tunnel connection from run (12345) instance ssh port (22) to some local port (4567).\n-        pipe tunnel -lp 4567 -rp 22 12345\n \n-    \\b\n-    Then connect to run instance using regular ssh client on the configured local port (4567).\n-        ssh -p 4567 root@localhost\n+        pipe tunnel -lp 4567 -rp 22 --ssh 12345\n+\n+    Then connect to run instance using regular ssh client.\n+\n+        ssh root@pipeline-12345\n+\n+    Or transfer some files to and from run instance using regular scp client.\n+\n+        scp file.txt root@pipeline-12345:/common/workdir/file.txt\n+\n+    Advanced tunnel configuration environment variables:\n \n     \\b\n-    Additionally the following environment variables can be used to specify the exact tunnel properties.\n-        CP_CLI_TUNNEL_PROXY_HOST\n-        CP_CLI_TUNNEL_PROXY_PORT\n-        CP_CLI_TUNNEL_TARGET_HOST\n+        CP_CLI_TUNNEL_PROXY_HOST - tunnel proxy host\n+        CP_CLI_TUNNEL_PROXY_PORT - tunnel proxy port\n+        CP_CLI_TUNNEL_TARGET_HOST - tunnel target host\n+        CP_CLI_TUNNEL_SERVER_ADDRESS - tunnel server address\n     \"\"\"\n-    try:\n-        create_tunnel(run_id, local_port, remote_port, log_file, log_level, timeout, foreground)\n-    except Exception as runtime_error:\n-        click.echo('Error: {}'.format(str(runtime_error)), err=True)\n-        sys.exit(1)\n+    if trace:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbdb1d1041737a560b9c0b3fc15a69af15e83d5c"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b025e3481a47f7a529ef031b9eba000e5fabaf33", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/b025e3481a47f7a529ef031b9eba000e5fabaf33", "committedDate": "2020-11-17T14:55:49Z", "message": "Add support for automatically configured passwordless ssh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "520b40d7bcbc176d08ac8187c5e98205bfce75f5", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/520b40d7bcbc176d08ac8187c5e98205bfce75f5", "committedDate": "2020-11-17T14:55:49Z", "message": "Add retries to pipe tunnel command with passwordless ssh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d777aeb3f300b7357f5e4abaaa1857f7886b47c", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7d777aeb3f300b7357f5e4abaaa1857f7886b47c", "committedDate": "2020-11-17T14:55:50Z", "message": "Add support for passwordless ssh both to root and run owner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d3045215b63e35927161772aec39fdcebe7b93", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/98d3045215b63e35927161772aec39fdcebe7b93", "committedDate": "2020-11-17T14:55:50Z", "message": "Add missing semicolon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c34ae7c1cd572c017ef9cb04d4a13c1fa5ba066c", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/c34ae7c1cd572c017ef9cb04d4a13c1fa5ba066c", "committedDate": "2020-11-17T14:55:51Z", "message": "Improve pipe tunnel docs and rearrange methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2140155a1542e798d5cf01369fd1ec99d69668b1", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/2140155a1542e798d5cf01369fd1ec99d69668b1", "committedDate": "2020-11-17T14:55:51Z", "message": "Add more examples to pipe tunnel docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "252b33b4a125cb954465a93dd88ac8d79b976e64", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/252b33b4a125cb954465a93dd88ac8d79b976e64", "committedDate": "2020-11-17T14:55:52Z", "message": "Create pseudo terminal for background tunnel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c5ad880969f53ea51967b62e11628fc3d19f4da", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/7c5ad880969f53ea51967b62e11628fc3d19f4da", "committedDate": "2020-11-17T14:55:52Z", "message": "Add support for WSL in pipe tunnel passwordless ssh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e3869c0e745cf3044a4ca9be1d59d9def79f1f4", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/8e3869c0e745cf3044a4ca9be1d59d9def79f1f4", "committedDate": "2020-11-17T14:55:52Z", "message": "Add proper error handling and allow changing default timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd127b8b03055b2f76ece9503c6b88142c1ee44b", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/cd127b8b03055b2f76ece9503c6b88142c1ee44b", "committedDate": "2020-11-17T14:55:53Z", "message": "Handle missing ssh config file case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd44db61ff24cdc90938fc730704b594ac341ff7", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/cd44db61ff24cdc90938fc730704b594ac341ff7", "committedDate": "2020-11-17T14:55:53Z", "message": "Add proper permissions for creating ssh config files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30fe50e2a208c965fd58d1ea3cbe3ead549226a0", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/30fe50e2a208c965fd58d1ea3cbe3ead549226a0", "committedDate": "2020-11-17T14:55:54Z", "message": "Use ssh default root user in case of missing preference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8044cfa3e70033988496190b55b225c6498cab26", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/8044cfa3e70033988496190b55b225c6498cab26", "committedDate": "2020-11-17T14:55:54Z", "message": "Add support for passwordless ssh host name overriding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7387ef2c6e3dd4ca4dab0c31e46bfae46d4eb11", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f7387ef2c6e3dd4ca4dab0c31e46bfae46d4eb11", "committedDate": "2020-11-17T14:55:55Z", "message": "Create ssh directory if it doesn't exist and clean up known hosts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16b173677d32feec802a37070c02756613f8e2e9", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/16b173677d32feec802a37070c02756613f8e2e9", "committedDate": "2020-11-17T14:55:55Z", "message": "Increase tunnel default timeouts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "701cbf22adc3454f0f8911fd913c686ff06929d3", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/701cbf22adc3454f0f8911fd913c686ff06929d3", "committedDate": "2020-11-17T14:55:55Z", "message": "Improve stability and logging of passwordless ssh configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "738f0fc2aca3fc86f31f01611381a303ecd981b8", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/738f0fc2aca3fc86f31f01611381a303ecd981b8", "committedDate": "2020-11-17T14:55:56Z", "message": "Use traceback module to print stacktraces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "415def57d382e010c3cedbdd95f6078611e17cd2", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/415def57d382e010c3cedbdd95f6078611e17cd2", "committedDate": "2020-11-17T14:50:11Z", "message": "Use traceback module to print stacktraces"}, "afterCommit": {"oid": "738f0fc2aca3fc86f31f01611381a303ecd981b8", "author": {"user": {"login": "tcibinan", "name": "Andrey Tsibin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/738f0fc2aca3fc86f31f01611381a303ecd981b8", "committedDate": "2020-11-17T14:55:56Z", "message": "Use traceback module to print stacktraces"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3691, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}