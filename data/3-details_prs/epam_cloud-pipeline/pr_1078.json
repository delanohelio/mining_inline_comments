{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjA3NDg0", "number": 1078, "title": "Issue 1060 SMB support for web dav", "bodyText": "This PR adds new functionality for mounting SMB share storages to webDAV Service.\nBecause of specific mount prerequisites (like azure storage creds) for mounting, not only WebDAV scripts are changed, but additional changes on deployment process are needed.\nTo be able to pass storage creds to WebDAV additional kube secret 'cp-region-creds-secret' was added. This secret is used to store all azure region credentials for datastorage accounts.\nEach time region is created, api adds storage creds for this region to this kube secret.\nWebDAV service mounts this secret as folder and can access creds file for mounting purpose.\nNOTE.\nWhile redeploy existing CP instance with this changes, please remember that you need to create  'cp-region-creds-secret' manually, (when CP instance is created from scratch it will create this secret automatically by pipectl)", "createdAt": "2020-04-28T15:52:25Z", "url": "https://github.com/epam/cloud-pipeline/pull/1078", "merged": true, "mergeCommit": {"oid": "ead037366a0445d983ef2e0fe42a4b8abc9dd3e1"}, "closed": true, "closedAt": "2020-05-13T08:46:51Z", "author": {"login": "SilinPavel"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcax-TngH2gAyNDEwMjA3NDg0OmY2OWQ0MGQ0OTg4MWRiZTRkNmY4OGE5NzFkZGQyMjI4YzhkYmZiMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg026VAFqTQxMDcxNTQ2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f69d40d49881dbe4d6f88a971ddd2228c8dbfb07", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/f69d40d49881dbe4d6f88a971ddd2228c8dbfb07", "committedDate": "2020-04-24T14:01:31Z", "message": "(issue #1060) update kube secret when create azure region to be able to pass creds to WebDav container"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15b263d3ee14f8dd704e00da79e41b5f5c130555", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/15b263d3ee14f8dd704e00da79e41b5f5c130555", "committedDate": "2020-04-27T10:29:17Z", "message": "(issue #1060) fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e23d7d3f89c8c0f40f90367ea7c7074927b0e751", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/e23d7d3f89c8c0f40f90367ea7c7074927b0e751", "committedDate": "2020-04-27T16:19:26Z", "message": "(issue #1060) patching mount sync scripts for webdav service to be able to work with SMB shares"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed787c7af0f92a40282b9d5401d4ab976001ccf1", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/ed787c7af0f92a40282b9d5401d4ab976001ccf1", "committedDate": "2020-04-28T10:21:34Z", "message": "(issue #1060) change messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/867b14bed04e4cb68738ea6244e69accb7d7d3ef", "committedDate": "2020-04-28T15:43:06Z", "message": "(issue #1060) small fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MTEzODIy", "url": "https://github.com/epam/cloud-pipeline/pull/1078#pullrequestreview-408113822", "createdAt": "2020-05-08T09:21:51Z", "commit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyMTo1MVrOGSfThA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyMjozOVrOGSfU1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MDQ1Mg==", "bodyText": "This code duplicates logic in aspect, I'd suggest to move it to a separate service and use it in aspect and in onApplicationEvent  method", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422040452", "createdAt": "2020-05-08T09:21:51Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/region/CloudRegionManager.java", "diffHunk": "@@ -223,6 +238,33 @@ public AbstractCloudRegion loadOrDefault(final Long id) {\n                 .orElseGet(this::loadDefaultRegion);\n     }\n \n+    public void refreshCloudRegionCredKubeSecret() {\n+        log.debug(\"Create Kube secret with cloud region creds if it does not exist.\");\n+        if (!kubernetesManager.isSecretExist(CP_REGION_CREDS_SECRET)) {\n+            log.warn(\"Secret: \" + CP_REGION_CREDS_SECRET + \" doesn't exist!\");\n+            return;\n+        }\n+        kubernetesManager.refreshSecret(CP_REGION_CREDS_SECRET,\n+                loadAll()\n+                        .stream()\n+                        .filter(region -> region.getProvider().equals(CloudProvider.AZURE))\n+                        .map(region -> (AzureRegion) region)\n+                        .collect(\n+                                Collectors.toMap(azureRegion -> azureRegion.getId().toString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MDc5MA==", "bodyText": "Maybe extract this code to some util method or class, since such conversion is used several times", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422040790", "createdAt": "2020-05-08T09:22:39Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/region/CloudRegionManager.java", "diffHunk": "@@ -223,6 +238,33 @@ public AbstractCloudRegion loadOrDefault(final Long id) {\n                 .orElseGet(this::loadDefaultRegion);\n     }\n \n+    public void refreshCloudRegionCredKubeSecret() {\n+        log.debug(\"Create Kube secret with cloud region creds if it does not exist.\");\n+        if (!kubernetesManager.isSecretExist(CP_REGION_CREDS_SECRET)) {\n+            log.warn(\"Secret: \" + CP_REGION_CREDS_SECRET + \" doesn't exist!\");\n+            return;\n+        }\n+        kubernetesManager.refreshSecret(CP_REGION_CREDS_SECRET,\n+                loadAll()\n+                        .stream()\n+                        .filter(region -> region.getProvider().equals(CloudProvider.AZURE))\n+                        .map(region -> (AzureRegion) region)\n+                        .collect(\n+                                Collectors.toMap(azureRegion -> azureRegion.getId().toString(),\n+                                        azureRegion ->  {\n+                                            final HashMap<String, String> creds = new HashMap<>();\n+                                            creds.put(STORAGE_ACCOUNT, azureRegion.getStorageAccount());\n+                                            creds.put(STORAGE_KEY, loadCredentials(azureRegion).getStorageAccountKey());\n+                                            try {\n+                                                return Base64.encodeBase64String(mapper.writeValueAsString(creds).getBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MTE1MDk5", "url": "https://github.com/epam/cloud-pipeline/pull/1078#pullrequestreview-408115099", "createdAt": "2020-05-08T09:24:21Z", "commit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyNDoyMVrOGSfX6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwOToyNDoyMVrOGSfX6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MTU3OA==", "bodyText": "I think it is better to call methods doesSecretExist", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422041578", "createdAt": "2020-05-08T09:24:21Z", "author": {"login": "mzueva"}, "path": "api/src/main/java/com/epam/pipeline/manager/cluster/KubernetesManager.java", "diffHunk": "@@ -167,6 +199,15 @@ public String createDockerRegistrySecret(DockerRegistrySecret secret) {\n         }\n     }\n \n+    public boolean isSecretExist(final String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb01ce61f7bcd2e78a37f675ce7a8081c9f01d78", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/bb01ce61f7bcd2e78a37f675ce7a8081c9f01d78", "committedDate": "2020-05-08T11:26:53Z", "message": "issue #1060 final keyword usage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83f032ba0455de52a6a3baf0882c8ef21e0f5167", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/83f032ba0455de52a6a3baf0882c8ef21e0f5167", "committedDate": "2020-05-08T12:28:14Z", "message": "move code that related to serialization creds to helper class"}, "afterCommit": {"oid": "89d8e21ee2d0160035c40c5ea890cca6ef9d1749", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/89d8e21ee2d0160035c40c5ea890cca6ef9d1749", "committedDate": "2020-05-08T12:28:58Z", "message": "move code that related to serialization creds to helper class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e31104307384483aec4b8375f8f9754914616c32", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/e31104307384483aec4b8375f8f9754914616c32", "committedDate": "2020-05-08T12:38:24Z", "message": "move code that related to serialization creds to helper class"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89d8e21ee2d0160035c40c5ea890cca6ef9d1749", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/89d8e21ee2d0160035c40c5ea890cca6ef9d1749", "committedDate": "2020-05-08T12:28:58Z", "message": "move code that related to serialization creds to helper class"}, "afterCommit": {"oid": "e31104307384483aec4b8375f8f9754914616c32", "author": {"user": {"login": "SilinPavel", "name": "Pavel Silin"}}, "url": "https://github.com/epam/cloud-pipeline/commit/e31104307384483aec4b8375f8f9754914616c32", "committedDate": "2020-05-08T12:38:24Z", "message": "move code that related to serialization creds to helper class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNzE1NDY1", "url": "https://github.com/epam/cloud-pipeline/pull/1078#pullrequestreview-410715465", "createdAt": "2020-05-13T08:46:42Z", "commit": {"oid": "e31104307384483aec4b8375f8f9754914616c32"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3825, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}