{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MzQxNTk4", "number": 14451, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0MDoyN1rOElHCHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0Njo0NlrOElHJlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MzQ3OTk4OnYy", "diffSide": "RIGHT", "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/ClientFeederV3.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0MDoyN1rOHUbQQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwODozNzo1MlrOHVFozA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4MDA5OA==", "bodyText": "Did you intend for this to be sendBlocking, as we discussed?", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491180098", "createdAt": "2020-09-18T20:40:27Z", "author": {"login": "jonmv"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/ClientFeederV3.java", "diffHunk": "@@ -191,30 +169,14 @@ private int getOverloadReturnCode(HttpRequest request) {\n         }\n     }\n \n-    private Result sendMessage(FeederSettings settings,\n-                               DocumentOperationMessageV3 msg,\n-                               AtomicInteger threadsAvailableForFeeding) throws InterruptedException {\n-        Result result = null;\n-        while (result == null || result.getError().getCode() == SEND_QUEUE_FULL) {\n-            msg.getMessage().pushHandler(feedReplyHandler);\n-\n-            if (settings.denyIfBusy && threadsAvailableForFeeding.get() < 1) {\n-                return sourceSession.getResource().sendMessage(msg.getMessage());\n-            } else {\n-                result = sourceSession.getResource().sendMessageBlocking(msg.getMessage());\n-            }\n-            if (result.isAccepted()) {\n-                return result;\n-            }\n-            Thread.sleep(100);\n-        }\n-        return result;\n+    private Result sendMessage(DocumentOperationMessageV3 msg) {\n+        msg.getMessage().pushHandler(feedReplyHandler);\n+        return sourceSession.getResource().sendMessage(msg.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg3NDUwOA==", "bodyText": "NVM.", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491874508", "createdAt": "2020-09-21T08:37:52Z", "author": {"login": "jonmv"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/ClientFeederV3.java", "diffHunk": "@@ -191,30 +169,14 @@ private int getOverloadReturnCode(HttpRequest request) {\n         }\n     }\n \n-    private Result sendMessage(FeederSettings settings,\n-                               DocumentOperationMessageV3 msg,\n-                               AtomicInteger threadsAvailableForFeeding) throws InterruptedException {\n-        Result result = null;\n-        while (result == null || result.getError().getCode() == SEND_QUEUE_FULL) {\n-            msg.getMessage().pushHandler(feedReplyHandler);\n-\n-            if (settings.denyIfBusy && threadsAvailableForFeeding.get() < 1) {\n-                return sourceSession.getResource().sendMessage(msg.getMessage());\n-            } else {\n-                result = sourceSession.getResource().sendMessageBlocking(msg.getMessage());\n-            }\n-            if (result.isAccepted()) {\n-                return result;\n-            }\n-            Thread.sleep(100);\n-        }\n-        return result;\n+    private Result sendMessage(DocumentOperationMessageV3 msg) {\n+        msg.getMessage().pushHandler(feedReplyHandler);\n+        return sourceSession.getResource().sendMessage(msg.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4MDA5OA=="}, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MzQ4MDk4OnYy", "diffSide": "LEFT", "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/ClientFeederV3.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0MDo0OVrOHUbQ5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0MDo0OVrOHUbQ5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4MDI2MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491180261", "createdAt": "2020-09-18T20:40:49Z", "author": {"login": "jonmv"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/ClientFeederV3.java", "diffHunk": "@@ -244,27 +205,21 @@ private void feed(FeederSettings settings,\n                 repliesFromOldMessages.add(createOperationStatus(message.get().getOperationId(),\n                                                                  result.getError().getMessage(),\n                                                                  ErrorCode.TRANSIENT_ERROR,\n-                                                                 false,\n-                                                                 message.get().getMessage()));\n+                        message.get().getMessage()));\n             } else {\n-                // should probably not happen, but everybody knows stuff that\n-                // shouldn't happen, happens all the time\n-                boolean isConditionNotMet = result.getError().getCode() == DocumentProtocol.ERROR_TEST_AND_SET_CONDITION_FAILED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 163}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MzQ5OTEwOnYy", "diffSide": "RIGHT", "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/FeedHandlerV3.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0Njo0NlrOHUbbBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjoxMjowMFrOHVM-Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4Mjg1NA==", "bodyText": "I believe this would oftentimes be true, even though there's no need to throttle. Consider a larger number than 0.", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491182854", "createdAt": "2020-09-18T20:46:46Z", "author": {"login": "jonmv"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/FeedHandlerV3.java", "diffHunk": "@@ -44,31 +43,40 @@\n     private final SessionCache sessionCache;\n     protected final ReplyHandler feedReplyHandler;\n     private final Metric metric;\n+    private final ClientFeederV3.HttpThrottlePolicy httpThrottlePolicy;\n     private final Object monitor = new Object();\n-    private final AtomicInteger threadsAvailableForFeeding;\n     private static final Logger log = Logger.getLogger(FeedHandlerV3.class.getName());\n \n-    public FeedHandlerV3(Executor executor,\n+    public FeedHandlerV3(ContainerThreadPool threadpool,\n                          Metric metric,\n                          AccessLog accessLog,\n                          DocumentmanagerConfig documentManagerConfig,\n                          SessionCache sessionCache,\n-                         ThreadpoolConfig threadpoolConfig,\n                          DocumentApiMetrics metricsHelper) {\n+        this(threadpool.executor(),\n+                () -> threadpool.queuedTasks() > 0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg3NjI4MA==", "bodyText": "@baldersheim Any input?", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491876280", "createdAt": "2020-09-21T08:40:47Z", "author": {"login": "bjorncs"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/FeedHandlerV3.java", "diffHunk": "@@ -44,31 +43,40 @@\n     private final SessionCache sessionCache;\n     protected final ReplyHandler feedReplyHandler;\n     private final Metric metric;\n+    private final ClientFeederV3.HttpThrottlePolicy httpThrottlePolicy;\n     private final Object monitor = new Object();\n-    private final AtomicInteger threadsAvailableForFeeding;\n     private static final Logger log = Logger.getLogger(FeedHandlerV3.class.getName());\n \n-    public FeedHandlerV3(Executor executor,\n+    public FeedHandlerV3(ContainerThreadPool threadpool,\n                          Metric metric,\n                          AccessLog accessLog,\n                          DocumentmanagerConfig documentManagerConfig,\n                          SessionCache sessionCache,\n-                         ThreadpoolConfig threadpoolConfig,\n                          DocumentApiMetrics metricsHelper) {\n+        this(threadpool.executor(),\n+                () -> threadpool.queuedTasks() > 0,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4Mjg1NA=="}, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg4OTUzNw==", "bodyText": "Hard to tell what is the correct value here. Perhaps queuesize/2 is a more conservative number. Might be better to start with a larger number and reduce. I guess we can  look at queue size afterwards and see how it behaves.", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491889537", "createdAt": "2020-09-21T09:03:41Z", "author": {"login": "baldersheim"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/FeedHandlerV3.java", "diffHunk": "@@ -44,31 +43,40 @@\n     private final SessionCache sessionCache;\n     protected final ReplyHandler feedReplyHandler;\n     private final Metric metric;\n+    private final ClientFeederV3.HttpThrottlePolicy httpThrottlePolicy;\n     private final Object monitor = new Object();\n-    private final AtomicInteger threadsAvailableForFeeding;\n     private static final Logger log = Logger.getLogger(FeedHandlerV3.class.getName());\n \n-    public FeedHandlerV3(Executor executor,\n+    public FeedHandlerV3(ContainerThreadPool threadpool,\n                          Metric metric,\n                          AccessLog accessLog,\n                          DocumentmanagerConfig documentManagerConfig,\n                          SessionCache sessionCache,\n-                         ThreadpoolConfig threadpoolConfig,\n                          DocumentApiMetrics metricsHelper) {\n+        this(threadpool.executor(),\n+                () -> threadpool.queuedTasks() > 0,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4Mjg1NA=="}, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk5NDYyNg==", "bodyText": "I'm not really a fan of this ad-hoc throttling. I think is better to reuse the rejection logic in the threaded request handler base class. The response code must be overridden to 429, but that should be easy to implement.", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491994626", "createdAt": "2020-09-21T12:12:00Z", "author": {"login": "bjorncs"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/FeedHandlerV3.java", "diffHunk": "@@ -44,31 +43,40 @@\n     private final SessionCache sessionCache;\n     protected final ReplyHandler feedReplyHandler;\n     private final Metric metric;\n+    private final ClientFeederV3.HttpThrottlePolicy httpThrottlePolicy;\n     private final Object monitor = new Object();\n-    private final AtomicInteger threadsAvailableForFeeding;\n     private static final Logger log = Logger.getLogger(FeedHandlerV3.class.getName());\n \n-    public FeedHandlerV3(Executor executor,\n+    public FeedHandlerV3(ContainerThreadPool threadpool,\n                          Metric metric,\n                          AccessLog accessLog,\n                          DocumentmanagerConfig documentManagerConfig,\n                          SessionCache sessionCache,\n-                         ThreadpoolConfig threadpoolConfig,\n                          DocumentApiMetrics metricsHelper) {\n+        this(threadpool.executor(),\n+                () -> threadpool.queuedTasks() > 0,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4Mjg1NA=="}, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1351, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}