{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NzQyNTIw", "number": 13846, "title": "Delete expired locks (older than 1 day)", "bodyText": "There has never been any cleanup of locks, but until we started taking\na lock per session this has not been seen as an issue, since there were\nfew of them\nAdd code to maintainer that deletes locks older than 1 day\n\nDue to the way locks are implemented and (they are removed if there is just one process that takes the lock and releases it) there are no test added for this change.  Tested in a config server cluster in CD.", "createdAt": "2020-07-09T09:38:24Z", "url": "https://github.com/vespa-engine/vespa/pull/13846", "merged": true, "mergeCommit": {"oid": "d148097870304aebd2c904a4f62cf1156f2a2422"}, "closed": true, "closedAt": "2020-07-09T11:52:01Z", "author": {"login": "hmusum"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczLt1FAH2gAyNDQ2NzQyNTIwOjhlZGY2MGNkOGQ3MDE1MDlhMjNhOTA3MTJmMWY5N2E3MTc3MWQ0YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczREJSAFqTQ0NTc0NzY3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/8edf60cd8d701509a23a90712f1f97a71771d4a5", "committedDate": "2020-07-09T09:35:14Z", "message": "Delete expired locks (older than 1 day)\n\n* There has never been any cleanup of locks, but until we started taking\n  a lock per session this has not been seen as an issue, since there were\n  few of them\n* Add code to maintainer that deletes locks older than 1 day"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDkzODcx", "url": "https://github.com/vespa-engine/vespa/pull/13846#pullrequestreview-445493871", "createdAt": "2020-07-09T10:34:55Z", "commit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDozNDo1NlrOGvLcYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDo0NzoyMVrOGvL0Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyMzc0NQ==", "bodyText": "nit: the middle part of the message could be simplified to \" locks older than \"", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452123745", "createdAt": "2020-07-09T10:34:56Z", "author": {"login": "gjoranv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java", "diffHunk": "@@ -35,5 +35,9 @@ protected void maintain() {\n             int deleted = applicationRepository.deleteExpiredRemoteSessions(expiryTime);\n             log.log(LogLevel.FINE, \"Deleted \" + deleted + \" expired remote sessions, expiry time \" + expiryTime);\n         }\n+\n+        Duration lockExpiryTime = Duration.ofDays(1);\n+        int deleted = applicationRepository.deleteExpiredLocks(lockExpiryTime);\n+        log.log(LogLevel.INFO, \"Deleted \" + deleted + \" expired locks, expiry time \" + lockExpiryTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyNDIyMQ==", "bodyText": "intended? I don't see any new usage in this PR.", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452124221", "createdAt": "2020-07-09T10:35:51Z", "author": {"login": "gjoranv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -665,7 +687,7 @@ public Lock lock(long sessionId) {\n         return curator.lock(lockPath(sessionId), Duration.ofMinutes(1)); // These locks shouldn't be held for very long.\n     }\n \n-    private Path lockPath(long sessionId) {\n+    public Path lockPath(long sessionId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyOTg2Mw==", "bodyText": "perhaps this should return an Optional instead, and empty where it now returns the current time?", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452129863", "createdAt": "2020-07-09T10:47:21Z", "author": {"login": "gjoranv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -281,6 +282,27 @@ public int deleteExpiredRemoteSessions(Clock clock, Duration expiryTime) {\n         return deleted;\n     }\n \n+    public int deleteExpiredLocks(Clock clock, Duration expiryTime) {\n+        int deleted = 0;\n+        for (var lock : curator.getChildren(locksPath)) {\n+            Path path = locksPath.append(lock);\n+            if (zooKeeperNodeCreated(path).isBefore(clock.instant().minus(expiryTime))) {\n+                log.log(Level.INFO, \"Lock  \" + path + \" has expired, deleting it\");\n+                curator.delete(path);\n+                deleted++;\n+            }\n+        }\n+        return deleted;\n+    }\n+\n+    private Instant zooKeeperNodeCreated(Path path) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ffd74ae2eabd17e49f95427addb7ed82bf11ee7", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/4ffd74ae2eabd17e49f95427addb7ed82bf11ee7", "committedDate": "2020-07-09T11:00:09Z", "message": "Minor changes after review feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzQ3Njc0", "url": "https://github.com/vespa-engine/vespa/pull/13846#pullrequestreview-445747674", "createdAt": "2020-07-09T15:49:08Z", "commit": {"oid": "4ffd74ae2eabd17e49f95427addb7ed82bf11ee7"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3534, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}