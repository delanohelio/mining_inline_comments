{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzgyNTQ2", "number": 13294, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOToxNDoyN1rOD9tbfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOTozNTo1MVrOD9t7-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MDM0MDQ3OnYy", "diffSide": "RIGHT", "path": "searchlib/src/vespa/searchlib/attribute/CMakeLists.txt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOToxNDoyN1rOGXXUAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMDo1OTo1NFrOGXbDOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1MjM4Nw==", "bodyText": "strange indent", "url": "https://github.com/vespa-engine/vespa/pull/13294#discussion_r427152387", "createdAt": "2020-05-19T09:14:27Z", "author": {"login": "havardpe"}, "path": "searchlib/src/vespa/searchlib/attribute/CMakeLists.txt", "diffHunk": "@@ -34,7 +34,7 @@ vespa_add_library(searchlib_attribute OBJECT\n     defines.cpp\n     diversity.cpp\n     dociditerator.cpp\n-    elementiterator.cpp\n+        searchcontextelementiterator.cpp", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b93babac02fbce704f2683d69fd3e6677961c59"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIxMzYyNA==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/13294#discussion_r427213624", "createdAt": "2020-05-19T10:59:54Z", "author": {"login": "baldersheim"}, "path": "searchlib/src/vespa/searchlib/attribute/CMakeLists.txt", "diffHunk": "@@ -34,7 +34,7 @@ vespa_add_library(searchlib_attribute OBJECT\n     defines.cpp\n     diversity.cpp\n     dociditerator.cpp\n-    elementiterator.cpp\n+        searchcontextelementiterator.cpp", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1MjM4Nw=="}, "originalCommit": {"oid": "0b93babac02fbce704f2683d69fd3e6677961c59"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MDM4NDIxOnYy", "diffSide": "RIGHT", "path": "searchlib/src/vespa/searchlib/attribute/searchcontextelementiterator.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOToyNTo0NVrOGXXvng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMTowODozM1rOGXbVnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1OTQ1NA==", "bodyText": "possible re-write: avoid calling find multiple times for same candidate\npossible re-write: terminate loop when attribute matching is exhausted.", "url": "https://github.com/vespa-engine/vespa/pull/13294#discussion_r427159454", "createdAt": "2020-05-19T09:25:45Z", "author": {"login": "havardpe"}, "path": "searchlib/src/vespa/searchlib/attribute/searchcontextelementiterator.cpp", "diffHunk": "@@ -0,0 +1,41 @@\n+// Copyright 2018 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"searchcontextelementiterator.h\"\n+#include <vespa/searchcommon/attribute/i_search_context.h>\n+#include <vespa/searchlib/fef/termfieldmatchdata.h>\n+\n+using search::fef::TermFieldMatchDataPosition;\n+\n+namespace search::attribute {\n+\n+void\n+SearchContextElementIterator::getElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    int32_t weight(0);\n+    for (int32_t id = _searchContext.find(docId, 0, weight); id >= 0; id = _searchContext.find(docId, id+1, weight)) {\n+        elementIds.push_back(id);\n+    }\n+}\n+void\n+SearchContextElementIterator::mergeElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    size_t toKeep(0);\n+    int32_t id(-1);\n+    int32_t weight(0);\n+    for (int32_t candidate : elementIds) {\n+        if (candidate >= id) {\n+            id = _searchContext.find(docId, candidate, weight);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b93babac02fbce704f2683d69fd3e6677961c59"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIxODMzMg==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/13294#discussion_r427218332", "createdAt": "2020-05-19T11:08:33Z", "author": {"login": "baldersheim"}, "path": "searchlib/src/vespa/searchlib/attribute/searchcontextelementiterator.cpp", "diffHunk": "@@ -0,0 +1,41 @@\n+// Copyright 2018 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"searchcontextelementiterator.h\"\n+#include <vespa/searchcommon/attribute/i_search_context.h>\n+#include <vespa/searchlib/fef/termfieldmatchdata.h>\n+\n+using search::fef::TermFieldMatchDataPosition;\n+\n+namespace search::attribute {\n+\n+void\n+SearchContextElementIterator::getElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    int32_t weight(0);\n+    for (int32_t id = _searchContext.find(docId, 0, weight); id >= 0; id = _searchContext.find(docId, id+1, weight)) {\n+        elementIds.push_back(id);\n+    }\n+}\n+void\n+SearchContextElementIterator::mergeElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    size_t toKeep(0);\n+    int32_t id(-1);\n+    int32_t weight(0);\n+    for (int32_t candidate : elementIds) {\n+        if (candidate >= id) {\n+            id = _searchContext.find(docId, candidate, weight);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1OTQ1NA=="}, "originalCommit": {"oid": "0b93babac02fbce704f2683d69fd3e6677961c59"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MDQwMjI5OnYy", "diffSide": "RIGHT", "path": "searchlib/src/vespa/searchlib/queryeval/elementiterator.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOTozMDoyM1rOGXX7KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMDo1OTo0NFrOGXbC4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE2MjQwOQ==", "bodyText": "missing newline", "url": "https://github.com/vespa-engine/vespa/pull/13294#discussion_r427162409", "createdAt": "2020-05-19T09:30:23Z", "author": {"login": "havardpe"}, "path": "searchlib/src/vespa/searchlib/queryeval/elementiterator.cpp", "diffHunk": "@@ -0,0 +1,71 @@\n+#include \"elementiterator.h\"\n+#include <vespa/searchlib/fef/termfieldmatchdata.h>\n+#include <vespa/vespalib/objects/objectvisitor.h>\n+\n+namespace search::queryeval {\n+\n+void\n+ElementIterator::visitMembers(vespalib::ObjectVisitor &visitor) const {\n+    visit(visitor, \"iterator\", _search.get());\n+}\n+\n+ElementIteratorWrapper::ElementIteratorWrapper(SearchIterator::UP search, fef::TermFieldMatchData & tfmd)\n+    : ElementIterator(std::move(search)),\n+      _tfmd(tfmd)\n+{}\n+\n+ElementIteratorWrapper::~ElementIteratorWrapper() = default;\n+\n+void\n+ElementIteratorWrapper::getElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    _search->unpack(docId);\n+    int prevId(-1);\n+    for (auto element : _tfmd) {\n+        uint32_t id(element.getElementId());\n+        if (prevId != int(id)) {\n+            elementIds.push_back(id);\n+            prevId = id;\n+        }\n+    }\n+}\n+\n+void\n+ElementIteratorWrapper::mergeElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    _search->unpack(docId);\n+    size_t toKeep(0);\n+    int32_t id(-1);\n+    auto it = _tfmd.begin();\n+    for (int32_t candidate : elementIds) {\n+        if (candidate >= id) {\n+            while ((it < _tfmd.end()) && (candidate > int(it->getElementId()))) {\n+                it++;\n+            }\n+            if (it == _tfmd.end()) break;\n+            id = it->getElementId();\n+            if (id == candidate) {\n+                elementIds[toKeep++] = candidate;\n+            }\n+        }\n+    }\n+    elementIds.resize(toKeep);\n+}\n+\n+}\n+\n+void visit(vespalib::ObjectVisitor &self, const vespalib::string &name,\n+           const search::queryeval::ElementIterator *obj)\n+{\n+    if (obj != 0) {\n+        self.openStruct(name, \"ElementIterator\");\n+        obj->visitMembers(self);\n+        self.closeStruct();\n+    } else {\n+        self.visitNull(name);\n+    }\n+}\n+\n+void visit(vespalib::ObjectVisitor &self, const vespalib::string &name,\n+           const search::queryeval::ElementIterator &obj)\n+{\n+    visit(self, name, &obj);\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b93babac02fbce704f2683d69fd3e6677961c59"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIxMzUzOQ==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/13294#discussion_r427213539", "createdAt": "2020-05-19T10:59:44Z", "author": {"login": "baldersheim"}, "path": "searchlib/src/vespa/searchlib/queryeval/elementiterator.cpp", "diffHunk": "@@ -0,0 +1,71 @@\n+#include \"elementiterator.h\"\n+#include <vespa/searchlib/fef/termfieldmatchdata.h>\n+#include <vespa/vespalib/objects/objectvisitor.h>\n+\n+namespace search::queryeval {\n+\n+void\n+ElementIterator::visitMembers(vespalib::ObjectVisitor &visitor) const {\n+    visit(visitor, \"iterator\", _search.get());\n+}\n+\n+ElementIteratorWrapper::ElementIteratorWrapper(SearchIterator::UP search, fef::TermFieldMatchData & tfmd)\n+    : ElementIterator(std::move(search)),\n+      _tfmd(tfmd)\n+{}\n+\n+ElementIteratorWrapper::~ElementIteratorWrapper() = default;\n+\n+void\n+ElementIteratorWrapper::getElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    _search->unpack(docId);\n+    int prevId(-1);\n+    for (auto element : _tfmd) {\n+        uint32_t id(element.getElementId());\n+        if (prevId != int(id)) {\n+            elementIds.push_back(id);\n+            prevId = id;\n+        }\n+    }\n+}\n+\n+void\n+ElementIteratorWrapper::mergeElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    _search->unpack(docId);\n+    size_t toKeep(0);\n+    int32_t id(-1);\n+    auto it = _tfmd.begin();\n+    for (int32_t candidate : elementIds) {\n+        if (candidate >= id) {\n+            while ((it < _tfmd.end()) && (candidate > int(it->getElementId()))) {\n+                it++;\n+            }\n+            if (it == _tfmd.end()) break;\n+            id = it->getElementId();\n+            if (id == candidate) {\n+                elementIds[toKeep++] = candidate;\n+            }\n+        }\n+    }\n+    elementIds.resize(toKeep);\n+}\n+\n+}\n+\n+void visit(vespalib::ObjectVisitor &self, const vespalib::string &name,\n+           const search::queryeval::ElementIterator *obj)\n+{\n+    if (obj != 0) {\n+        self.openStruct(name, \"ElementIterator\");\n+        obj->visitMembers(self);\n+        self.closeStruct();\n+    } else {\n+        self.visitNull(name);\n+    }\n+}\n+\n+void visit(vespalib::ObjectVisitor &self, const vespalib::string &name,\n+           const search::queryeval::ElementIterator &obj)\n+{\n+    visit(self, name, &obj);\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE2MjQwOQ=="}, "originalCommit": {"oid": "0b93babac02fbce704f2683d69fd3e6677961c59"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MDQyMzYxOnYy", "diffSide": "RIGHT", "path": "searchlib/src/vespa/searchlib/queryeval/elementiterator.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOTozNTo1MVrOGXYIbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMTowODoyNVrOGXbVUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE2NTgwNg==", "bodyText": "possible re-write: avoid seeking for the same candidate multiple times", "url": "https://github.com/vespa-engine/vespa/pull/13294#discussion_r427165806", "createdAt": "2020-05-19T09:35:51Z", "author": {"login": "havardpe"}, "path": "searchlib/src/vespa/searchlib/queryeval/elementiterator.cpp", "diffHunk": "@@ -0,0 +1,71 @@\n+#include \"elementiterator.h\"\n+#include <vespa/searchlib/fef/termfieldmatchdata.h>\n+#include <vespa/vespalib/objects/objectvisitor.h>\n+\n+namespace search::queryeval {\n+\n+void\n+ElementIterator::visitMembers(vespalib::ObjectVisitor &visitor) const {\n+    visit(visitor, \"iterator\", _search.get());\n+}\n+\n+ElementIteratorWrapper::ElementIteratorWrapper(SearchIterator::UP search, fef::TermFieldMatchData & tfmd)\n+    : ElementIterator(std::move(search)),\n+      _tfmd(tfmd)\n+{}\n+\n+ElementIteratorWrapper::~ElementIteratorWrapper() = default;\n+\n+void\n+ElementIteratorWrapper::getElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    _search->unpack(docId);\n+    int prevId(-1);\n+    for (auto element : _tfmd) {\n+        uint32_t id(element.getElementId());\n+        if (prevId != int(id)) {\n+            elementIds.push_back(id);\n+            prevId = id;\n+        }\n+    }\n+}\n+\n+void\n+ElementIteratorWrapper::mergeElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    _search->unpack(docId);\n+    size_t toKeep(0);\n+    int32_t id(-1);\n+    auto it = _tfmd.begin();\n+    for (int32_t candidate : elementIds) {\n+        if (candidate >= id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b93babac02fbce704f2683d69fd3e6677961c59"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIxODI1Ng==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/13294#discussion_r427218256", "createdAt": "2020-05-19T11:08:25Z", "author": {"login": "baldersheim"}, "path": "searchlib/src/vespa/searchlib/queryeval/elementiterator.cpp", "diffHunk": "@@ -0,0 +1,71 @@\n+#include \"elementiterator.h\"\n+#include <vespa/searchlib/fef/termfieldmatchdata.h>\n+#include <vespa/vespalib/objects/objectvisitor.h>\n+\n+namespace search::queryeval {\n+\n+void\n+ElementIterator::visitMembers(vespalib::ObjectVisitor &visitor) const {\n+    visit(visitor, \"iterator\", _search.get());\n+}\n+\n+ElementIteratorWrapper::ElementIteratorWrapper(SearchIterator::UP search, fef::TermFieldMatchData & tfmd)\n+    : ElementIterator(std::move(search)),\n+      _tfmd(tfmd)\n+{}\n+\n+ElementIteratorWrapper::~ElementIteratorWrapper() = default;\n+\n+void\n+ElementIteratorWrapper::getElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    _search->unpack(docId);\n+    int prevId(-1);\n+    for (auto element : _tfmd) {\n+        uint32_t id(element.getElementId());\n+        if (prevId != int(id)) {\n+            elementIds.push_back(id);\n+            prevId = id;\n+        }\n+    }\n+}\n+\n+void\n+ElementIteratorWrapper::mergeElementIds(uint32_t docId, std::vector<uint32_t> & elementIds) {\n+    _search->unpack(docId);\n+    size_t toKeep(0);\n+    int32_t id(-1);\n+    auto it = _tfmd.begin();\n+    for (int32_t candidate : elementIds) {\n+        if (candidate >= id) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE2NTgwNg=="}, "originalCommit": {"oid": "0b93babac02fbce704f2683d69fd3e6677961c59"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1584, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}