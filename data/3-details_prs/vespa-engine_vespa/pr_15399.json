{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MjE4Njg0", "number": 15399, "title": "Jonmv/throw during prepare with disallowed config change actions", "bodyText": "@bratseth please reivew. This will fails several system and integration tests, so let me merge when I'll be ready to watch these.\n@geirst FYI.", "createdAt": "2020-11-19T20:38:57Z", "url": "https://github.com/vespa-engine/vespa/pull/15399", "merged": true, "mergeCommit": {"oid": "baaf68ad6d329399b30f93b0a5799a6575f8e70e"}, "closed": true, "closedAt": "2020-11-20T18:09:46Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeHF1IAH2gAyNTI0MjE4Njg0OjJhMDBjYzk5YjVhMGNjOTJkMjg2NzI1YWYyMmZlNDZkMGFhMDAxNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeZxU2AFqTUzNTU2OTI3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a00cc99b5a0cc92d286725af22fe46d0aa00142", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/2a00cc99b5a0cc92d286725af22fe46d0aa00142", "committedDate": "2020-11-19T18:30:40Z", "message": "Use proper ValidationId instead of their String names in ConfigChangeAction subclasses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/11e4907006c94bdd761e8f37bc9d006ae5b7bb40", "committedDate": "2020-11-19T20:38:11Z", "message": "Model disallowable actions separately, and collect and throw these in validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MTM5NzA2", "url": "https://github.com/vespa-engine/vespa/pull/15399#pullrequestreview-535139706", "createdAt": "2020-11-20T06:14:39Z", "commit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNjoxNDozOVrOH3BJvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNjoxOToxMVrOH3BZ-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MjYwNQ==", "bodyText": "Given this usage, I think it would be simpler to just put validationId on ConfigChangeAction as an Optional.", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527452605", "createdAt": "2020-11-20T06:14:39Z", "author": {"login": "bratseth"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "diffHunk": "@@ -99,9 +105,17 @@\n                 new ContainerRestartValidator(),\n                 new NodeResourceChangeValidator()\n         };\n-        return Arrays.stream(validators)\n-                .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n-                .collect(toList());\n+        List<ConfigChangeAction> actions = Arrays.stream(validators)\n+                                                 .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n+                                                 .collect(toList());\n+        overrides.invalid(actions.stream()\n+                                 .filter(DisallowableConfigChangeAction.class::isInstance)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1NTk4NQ==", "bodyText": "Just to repeat my standard comment to your code: These stream statements that does everything are like a long sentence with lots of subsentences. It's easier to read shorter sentences, especially since it makes you name the thing they produce.", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527455985", "createdAt": "2020-11-20T06:18:21Z", "author": {"login": "bratseth"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "diffHunk": "@@ -99,9 +105,17 @@\n                 new ContainerRestartValidator(),\n                 new NodeResourceChangeValidator()\n         };\n-        return Arrays.stream(validators)\n-                .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n-                .collect(toList());\n+        List<ConfigChangeAction> actions = Arrays.stream(validators)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1Njc2MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527456761", "createdAt": "2020-11-20T06:19:11Z", "author": {"login": "bratseth"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/change/VespaRefeedAction.java", "diffHunk": "@@ -22,37 +23,36 @@\n      * the validation ids belong to the Vespa model while these names are exposed to the config server,\n      * which is model version independent.\n      */\n-    private final String name;\n-\n+    private final ValidationId validationId;\n     private final String documentType;\n     private final boolean allowed;\n \n-    private VespaRefeedAction(ClusterSpec.Id id, String name, String message, List<ServiceInfo> services, String documentType, boolean allowed) {\n+    private VespaRefeedAction(ClusterSpec.Id id, ValidationId validationId, String message, List<ServiceInfo> services, String documentType, boolean allowed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "335f9f2d38db46e94185132ad9b6a9aac0475379", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/335f9f2d38db46e94185132ad9b6a9aac0475379", "committedDate": "2020-11-20T07:22:17Z", "message": "Break long stream statement to provide intermediary name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7835ceb503084f32cb09875b1e6243bed81e463", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/b7835ceb503084f32cb09875b1e6243bed81e463", "committedDate": "2020-11-20T07:23:20Z", "message": "Update abi spec once more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28ebee04d75871c2e268bfd8375b02759ca52d4e", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/28ebee04d75871c2e268bfd8375b02759ca52d4e", "committedDate": "2020-11-20T11:42:47Z", "message": "Add Optional<ValidationId> to ConfigActionChange and use to validate actions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6f880fec472614dc77b07a25799346bdec5e6ff", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/e6f880fec472614dc77b07a25799346bdec5e6ff", "committedDate": "2020-11-20T13:10:29Z", "message": "Remove \"allowed\" from config change actions (+ wiring) \u2014\u00a0allowed if not thrown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NTY5Mjcw", "url": "https://github.com/vespa-engine/vespa/pull/15399#pullrequestreview-535569270", "createdAt": "2020-11-20T16:16:29Z", "commit": {"oid": "e6f880fec472614dc77b07a25799346bdec5e6ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1980, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}