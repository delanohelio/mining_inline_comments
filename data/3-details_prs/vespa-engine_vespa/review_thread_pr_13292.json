{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzEwNzg4", "number": 13292, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDo1Mzo1MlrOD9jKMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDo1Mzo1MlrOD9jKMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODY1Nzc5OnYy", "diffSide": "RIGHT", "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "isResolved": true, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDo1Mzo1MlrOGXHJkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoxMzowMVrOGXU14g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA==", "bodyText": "I would have thought the one create by this would suffice?", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r426887570", "createdAt": "2020-05-18T20:53:52Z", "author": {"login": "jonmv"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MzU4OQ==", "bodyText": "I think that all are created by this one.", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r426893589", "createdAt": "2020-05-18T21:07:20Z", "author": {"login": "baldersheim"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyOTA0MQ==", "bodyText": "But not by this instance? Wouldn\u2019t this also destruktivt the next gen create by DI, or isn\u2019t the registre shared?", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427029041", "createdAt": "2020-05-19T04:52:58Z", "author": {"login": "jonmv"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA1MjY3MA==", "bodyText": "Ok, the registry is owned by the handler. All good, then.", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427052670", "createdAt": "2020-05-19T06:13:35Z", "author": {"login": "jonmv"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3NzczMw==", "bodyText": "Well, after sleeping on this one I am no longer certain about the life time about this one.\nI looked at the ComponentRegistry and saw that it was freezeable and assumed it would be frozen once component graph was set up, and hence not being possible to unregister anything. But that assumption might be wrong. No tests failed due to this, but that might be due that the 60s grace period.\n@gjoranv could you have a look at this one.", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427077733", "createdAt": "2020-05-19T07:12:11Z", "author": {"login": "baldersheim"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4NjAzMQ==", "bodyText": "This will deconstruct all DocprocServices, regardless of whether they survive the next reconfig or not. The injected registry contains all of them, no matter which generation they were created in.", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427086031", "createdAt": "2020-05-19T07:28:15Z", "author": {"login": "gjoranv"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4ODExNQ==", "bodyText": "That was the the creeping feeling I had.", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427088115", "createdAt": "2020-05-19T07:32:05Z", "author": {"login": "baldersheim"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5Mjc4OQ==", "bodyText": "That was my objection yesterday, but it seems the registry is created in the constructor of this handler, not injected.", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427092789", "createdAt": "2020-05-19T07:40:41Z", "author": {"login": "jonmv"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5Mzk5NQ==", "bodyText": "The other registries are injected, but not the one used for the DocprocServicees, which are the ones with the thread pools that weren't shut down.", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427093995", "createdAt": "2020-05-19T07:42:47Z", "author": {"login": "jonmv"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExMTkwNg==", "bodyText": "Sorry, I looked at the wrong constructor. As @jonmv says, the registry is not injected. Without knowing the code in detail, it looks like all the DocprocServices are created by the handler instance. So this should be all good.", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427111906", "createdAt": "2020-05-19T08:13:01Z", "author": {"login": "gjoranv"}, "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, "originalCommit": {"oid": "e6df521e70889b677d518af45c369bad2d3048f2"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1580, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}