{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MzQ1NjU3", "number": 15149, "title": "Adding feature flasg for", "bodyText": "stor-filestor.use_async_message_handling_on_schedule\nstor-filestor.bucket_merge_chunk_size\nstor-server.content_node_bucket_db_stripe_bits\n\n@geirst and @vekterli PR", "createdAt": "2020-11-02T21:48:41Z", "url": "https://github.com/vespa-engine/vespa/pull/15149", "merged": true, "mergeCommit": {"oid": "8915af7d1e0c1d242967fc330bc6bcd3d4488661"}, "closed": true, "closedAt": "2020-11-03T11:07:51Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYrjF-AH2gAyNTE0MzQ1NjU3OjE5YWVhYjgyOGY4Mjc4OTE2NDZjYTM4NjE5YmU3ZDgwZmQ2NDZiYjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY3KiDAH2gAyNTE0MzQ1NjU3OmFkZTM5YjFiNjQ4Y2RiZjY4M2M1MTI0NTkzYTcxOTEyMjU2ZGY0YzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/19aeab828f827891646ca38619be7d80fd646bb6", "committedDate": "2020-11-02T21:35:40Z", "message": "Adding feature flasg for\n- stor-filestor.use_async_message_handling_on_schedule\n- stor-filestor.bucket_merge_chunk_size\n- stor-server.content_node_bucket_db_stripe_bits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMzE1MzU2", "url": "https://github.com/vespa-engine/vespa/pull/15149#pullrequestreview-522315356", "createdAt": "2020-11-03T09:30:46Z", "commit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwOTozMDo0N1rOHsmVvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMDoxNDo1N1rOHsoEBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUyNzU1MQ==", "bodyText": "Consider renaming Messagehandling -> MessageHandling", "url": "https://github.com/vespa-engine/vespa/pull/15149#discussion_r516527551", "createdAt": "2020-11-03T09:30:47Z", "author": {"login": "vekterli"}, "path": "config-model/src/main/java/com/yahoo/config/model/deploy/TestProperties.java", "diffHunk": "@@ -49,6 +49,9 @@\n     private Quota quota = Quota.unlimited();\n     private boolean useAccessControlTlsHandshakeClientAuth;\n     private double jettyThreadpoolSizeFactor = 0.0;\n+    private boolean useAsyncMessagehandlingOnSchedule = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUzMTc4Ng==", "bodyText": "Consider creating a separate method (e.g. alignUp2MiB) and possibly add a comment indicating why this is done", "url": "https://github.com/vespa-engine/vespa/pull/15149#discussion_r516531786", "createdAt": "2020-11-03T09:37:49Z", "author": {"login": "vekterli"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/content/storagecluster/FileStorProducer.java", "diffHunk": "@@ -56,10 +58,15 @@ private Integer getThreads(ModelElement clusterElem) {\n         }\n     }\n     public FileStorProducer(ModelContext.Properties properties, ContentCluster parent, Integer numThreads) {\n+        final int twoMB = 0x200000;\n+        final int fourK = 0x1000;\n         this.numThreads = numThreads;\n         this.cluster = parent;\n         this.reponseNumThreads = properties.defaultNumResponseThreads();\n         this.responseSequencerType = convertResponseSequencerType(properties.responseSequencerType());\n+        useAsyncMessageHandlingOnSchedule = properties.useAsyncMessageHandlingOnSchedule();\n+        mergeChunkSize = ((properties.mergeChunkSize() + (twoMB-1))/twoMB)*twoMB - fourK;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU1NDM1MA==", "bodyText": "Should this return the default 4MiB value instead?", "url": "https://github.com/vespa-engine/vespa/pull/15149#discussion_r516554350", "createdAt": "2020-11-03T10:12:45Z", "author": {"login": "vekterli"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/deploy/ModelContextImpl.java", "diffHunk": "@@ -313,6 +322,13 @@ public boolean useFastValueTensorImplementation() {\n         @Override public boolean useAccessControlTlsHandshakeClientAuth() { return useAccessControlTlsHandshakeClientAuth; }\n \n         @Override public double jettyThreadpoolSizeFactor() { return jettyThreadpoolSizeFactor; }\n+\n+        @Override public boolean useAsyncMessageHandlingOnSchedule() { return false; }\n+\n+        @Override public int contentNodeBucketDBStripeBits() { return 0; }\n+\n+        @Override\n+        public int mergeChunkSize() { return 0; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU1NTc4MQ==", "bodyText": "Also, do we need the -4KiB adjustment with today's allocation strategies? The config comment mentions this as being done to avoid hitting the next malloc size class, but I'm not sure if this is relevant now.", "url": "https://github.com/vespa-engine/vespa/pull/15149#discussion_r516555781", "createdAt": "2020-11-03T10:14:57Z", "author": {"login": "vekterli"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/content/storagecluster/FileStorProducer.java", "diffHunk": "@@ -56,10 +58,15 @@ private Integer getThreads(ModelElement clusterElem) {\n         }\n     }\n     public FileStorProducer(ModelContext.Properties properties, ContentCluster parent, Integer numThreads) {\n+        final int twoMB = 0x200000;\n+        final int fourK = 0x1000;\n         this.numThreads = numThreads;\n         this.cluster = parent;\n         this.reponseNumThreads = properties.defaultNumResponseThreads();\n         this.responseSequencerType = convertResponseSequencerType(properties.responseSequencerType());\n+        useAsyncMessageHandlingOnSchedule = properties.useAsyncMessageHandlingOnSchedule();\n+        mergeChunkSize = ((properties.mergeChunkSize() + (twoMB-1))/twoMB)*twoMB - fourK;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUzMTc4Ng=="}, "originalCommit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMzU2OTA0", "url": "https://github.com/vespa-engine/vespa/pull/15149#pullrequestreview-522356904", "createdAt": "2020-11-03T10:22:23Z", "commit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMDoyMjoyM1rOHsoVWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMDoyNTowN1rOHsocGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU2MDIxOQ==", "bodyText": "Typo: CONETNT -> CONTENT", "url": "https://github.com/vespa-engine/vespa/pull/15149#discussion_r516560219", "createdAt": "2020-11-03T10:22:23Z", "author": {"login": "geirst"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/deploy/ModelContextImpl.java", "diffHunk": "@@ -229,6 +232,12 @@ public Properties(ApplicationId applicationId,\n             this.jettyThreadpoolSizeFactor = Flags.JETTY_THREADPOOL_SCALE_FACTOR.bindTo(flagSource)\n                     .with(FetchVector.Dimension.APPLICATION_ID, applicationId.serializedForm())\n                     .value();\n+            useAsyncMessageHandlingOnSchedule = Flags.USE_ASYNC_MESSAGE_HANDLING_ON_SCHEDULE.bindTo(flagSource)\n+                    .with(FetchVector.Dimension.APPLICATION_ID, applicationId.serializedForm()).value();\n+            contentNodeBucketDBStripeBits = Flags.CONETNT_NODE_BUCKET_DB_STRIPE_BITS.bindTo(flagSource)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU2MDQzOA==", "bodyText": "Typo: CONETNT -> CONTENT", "url": "https://github.com/vespa-engine/vespa/pull/15149#discussion_r516560438", "createdAt": "2020-11-03T10:22:41Z", "author": {"login": "geirst"}, "path": "flags/src/main/java/com/yahoo/vespa/flags/Flags.java", "diffHunk": "@@ -330,6 +330,22 @@\n             \"Takes effect on next internal redeployment\",\n             APPLICATION_ID);\n \n+    public static final UnboundBooleanFlag USE_ASYNC_MESSAGE_HANDLING_ON_SCHEDULE = defineFeatureFlag(\n+            \"async-message-handling-on-schedule\", false,\n+            \"Optionally deliver async messages in own thread\",\n+            \"Takes effect at redeployment\",\n+            ZONE_ID, APPLICATION_ID);\n+    public static final UnboundIntFlag CONETNT_NODE_BUCKET_DB_STRIPE_BITS = defineIntFlag(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU2MDk3NQ==", "bodyText": "sharing -> sharding (or use striping instead?)", "url": "https://github.com/vespa-engine/vespa/pull/15149#discussion_r516560975", "createdAt": "2020-11-03T10:23:31Z", "author": {"login": "geirst"}, "path": "flags/src/main/java/com/yahoo/vespa/flags/Flags.java", "diffHunk": "@@ -330,6 +330,22 @@\n             \"Takes effect on next internal redeployment\",\n             APPLICATION_ID);\n \n+    public static final UnboundBooleanFlag USE_ASYNC_MESSAGE_HANDLING_ON_SCHEDULE = defineFeatureFlag(\n+            \"async-message-handling-on-schedule\", false,\n+            \"Optionally deliver async messages in own thread\",\n+            \"Takes effect at redeployment\",\n+            ZONE_ID, APPLICATION_ID);\n+    public static final UnboundIntFlag CONETNT_NODE_BUCKET_DB_STRIPE_BITS = defineIntFlag(\n+            \"content-node-bucket-db-stripe-bits\", 0,\n+            \"Number of bits used for sharing the bucket DB in service layer\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU2MTk0Nw==", "bodyText": "Perhaps add a comment here on why we do the extra calculation.", "url": "https://github.com/vespa-engine/vespa/pull/15149#discussion_r516561947", "createdAt": "2020-11-03T10:25:07Z", "author": {"login": "geirst"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/content/storagecluster/FileStorProducer.java", "diffHunk": "@@ -56,10 +58,15 @@ private Integer getThreads(ModelElement clusterElem) {\n         }\n     }\n     public FileStorProducer(ModelContext.Properties properties, ContentCluster parent, Integer numThreads) {\n+        final int twoMB = 0x200000;\n+        final int fourK = 0x1000;\n         this.numThreads = numThreads;\n         this.cluster = parent;\n         this.reponseNumThreads = properties.defaultNumResponseThreads();\n         this.responseSequencerType = convertResponseSequencerType(properties.responseSequencerType());\n+        useAsyncMessageHandlingOnSchedule = properties.useAsyncMessageHandlingOnSchedule();\n+        mergeChunkSize = ((properties.mergeChunkSize() + (twoMB-1))/twoMB)*twoMB - fourK;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19aeab828f827891646ca38619be7d80fd646bb6"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45e27d1829ac49c41e4baa8d23da9fc8eacb1079", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/45e27d1829ac49c41e4baa8d23da9fc8eacb1079", "committedDate": "2020-11-03T11:04:44Z", "message": "- Drop the 4k reserved area.\n- Use consistent naming."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ade39b1b648cdbf683c5124593a71912256df4c3", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/ade39b1b648cdbf683c5124593a71912256df4c3", "committedDate": "2020-11-03T11:07:42Z", "message": "Merge branch 'master' into balder/add-some-feature-flags"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2107, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}