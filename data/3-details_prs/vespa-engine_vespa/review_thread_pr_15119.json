{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMDY1MjY1", "number": 15119, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMTowNToyOVrOEz9m_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMTowNToyOVrOEz9m_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyOTIyMjM5OnYy", "diffSide": "RIGHT", "path": "eval/src/vespa/eval/eval/aggr.h", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMTowNToyOVrOHrgdaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMjowMToxNFrOHrhoMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4MjYzNQ==", "bodyText": "if you want, you can always do this, because if \"cnt\" is odd then (cnt/2) == (cnt-1)/2 and (x+x)/2 == x", "url": "https://github.com/vespa-engine/vespa/pull/15119#discussion_r515382635", "createdAt": "2020-10-30T21:05:29Z", "author": {"login": "arnej27959"}, "path": "eval/src/vespa/eval/eval/aggr.h", "diffHunk": "@@ -120,6 +121,32 @@ template <typename T> class Max {\n     constexpr T result() const { return _max; }\n };\n \n+template <typename T> class Median {\n+private:\n+    std::vector<T> _seen;\n+public:\n+    constexpr Median() : _seen() {}\n+    constexpr Median(T value) : _seen({value}) {}\n+    constexpr void sample(T value) { _seen.push_back(value); }\n+    constexpr void merge(const Median &rhs) {\n+        for (T value: rhs._seen) {\n+            _seen.push_back(value);\n+        }\n+    };\n+    constexpr T result() const {\n+        if (_seen.empty()) {\n+            return std::numeric_limits<T>::quiet_NaN();\n+        }\n+        std::vector<T> tmp = _seen;\n+        std::sort(tmp.begin(), tmp.end());\n+        size_t cnt = tmp.size();\n+        if ((cnt % 2) == 0) {\n+            return ((tmp[cnt/2] + tmp[(cnt-1)/2]) / T{2});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a912eaaa9f64cbd35cc405b26c41ff33c45e6314"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4NTM5MA==", "bodyText": "isn't std::nth_element, with an extra std::max_element or std::min_element in case of even number of elements cheaper ?", "url": "https://github.com/vespa-engine/vespa/pull/15119#discussion_r515385390", "createdAt": "2020-10-30T21:12:44Z", "author": {"login": "toregge"}, "path": "eval/src/vespa/eval/eval/aggr.h", "diffHunk": "@@ -120,6 +121,32 @@ template <typename T> class Max {\n     constexpr T result() const { return _max; }\n };\n \n+template <typename T> class Median {\n+private:\n+    std::vector<T> _seen;\n+public:\n+    constexpr Median() : _seen() {}\n+    constexpr Median(T value) : _seen({value}) {}\n+    constexpr void sample(T value) { _seen.push_back(value); }\n+    constexpr void merge(const Median &rhs) {\n+        for (T value: rhs._seen) {\n+            _seen.push_back(value);\n+        }\n+    };\n+    constexpr T result() const {\n+        if (_seen.empty()) {\n+            return std::numeric_limits<T>::quiet_NaN();\n+        }\n+        std::vector<T> tmp = _seen;\n+        std::sort(tmp.begin(), tmp.end());\n+        size_t cnt = tmp.size();\n+        if ((cnt % 2) == 0) {\n+            return ((tmp[cnt/2] + tmp[(cnt-1)/2]) / T{2});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4MjYzNQ=="}, "originalCommit": {"oid": "a912eaaa9f64cbd35cc405b26c41ff33c45e6314"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQwMTc3OA==", "bodyText": "@arnej27959 : yes, I also thought of that, but could not get myself to do it, even if the performance will be 'the same'\n@toregge : I went for simple over fast, since it will be slow no matter what. Also, I am still not friends with nth_element (we have history). More importantly, your comment reminds me that sort will not work with NaN values. Need a new sort that works with NaN, I guess... hmm", "url": "https://github.com/vespa-engine/vespa/pull/15119#discussion_r515401778", "createdAt": "2020-10-30T22:01:14Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/eval/aggr.h", "diffHunk": "@@ -120,6 +121,32 @@ template <typename T> class Max {\n     constexpr T result() const { return _max; }\n };\n \n+template <typename T> class Median {\n+private:\n+    std::vector<T> _seen;\n+public:\n+    constexpr Median() : _seen() {}\n+    constexpr Median(T value) : _seen({value}) {}\n+    constexpr void sample(T value) { _seen.push_back(value); }\n+    constexpr void merge(const Median &rhs) {\n+        for (T value: rhs._seen) {\n+            _seen.push_back(value);\n+        }\n+    };\n+    constexpr T result() const {\n+        if (_seen.empty()) {\n+            return std::numeric_limits<T>::quiet_NaN();\n+        }\n+        std::vector<T> tmp = _seen;\n+        std::sort(tmp.begin(), tmp.end());\n+        size_t cnt = tmp.size();\n+        if ((cnt % 2) == 0) {\n+            return ((tmp[cnt/2] + tmp[(cnt-1)/2]) / T{2});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4MjYzNQ=="}, "originalCommit": {"oid": "a912eaaa9f64cbd35cc405b26c41ff33c45e6314"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1072, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}