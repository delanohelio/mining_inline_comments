{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5Mjg5ODM4", "number": 12584, "title": "Arnej/better remove strategy ", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@geirst please review\n@havardpe please take a look\nnote: i know i need to add/fix unit test, mostly wanted to checkpoint my work.", "createdAt": "2020-03-16T14:51:04Z", "url": "https://github.com/vespa-engine/vespa/pull/12584", "merged": true, "mergeCommit": {"oid": "cea4eef74bf6b80d96d8c395ebe4f87152f144e7"}, "closed": true, "closedAt": "2020-03-17T13:17:04Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOPM5UgH2gAyMzg5Mjg5ODM4OmYxMjc2NTU5NjY3ZTg2Nzg3ZmFiNDJhODU2MTdmYzE2YTZhMjU1OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOeruaAFqTM3NTgyNjgwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1276559667e86787fab42a85617fc16a6a25593", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/f1276559667e86787fab42a85617fc16a6a25593", "committedDate": "2020-03-16T14:43:41Z", "message": "better remove strategy\n\n* compute pairwise distance between neighbors of a removed\n  point, and add links starting with closest pair."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84c28041c2a4abb12f0e8834220719c61761fc12", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/84c28041c2a4abb12f0e8834220719c61761fc12", "committedDate": "2020-03-16T14:43:42Z", "message": "refactor to avoid code duplication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a217c1590afc4f5a1f8ea4b9cf72eb71c7404b7", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/1a217c1590afc4f5a1f8ea4b9cf72eb71c7404b7", "committedDate": "2020-03-16T14:43:42Z", "message": "always use heuristic filtering to allow for more links to be added later"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MzAzNDc2", "url": "https://github.com/vespa-engine/vespa/pull/12584#pullrequestreview-375303476", "createdAt": "2020-03-16T15:03:54Z", "commit": {"oid": "1a217c1590afc4f5a1f8ea4b9cf72eb71c7404b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNTowMzo1NVrOF24dfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNTowMzo1NVrOF24dfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5MjQ3OQ==", "bodyText": "since you set the link array specifically, maybe you can get it specifically as well?", "url": "https://github.com/vespa-engine/vespa/pull/12584#discussion_r393092479", "createdAt": "2020-03-16T15:03:55Z", "author": {"login": "havardpe"}, "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.h", "diffHunk": "@@ -101,6 +101,11 @@ class HnswIndex : public NearestNeighborIndex {\n     LevelArrayRef get_level_array(uint32_t docid) const;\n     LinkArrayRef get_link_array(uint32_t docid, uint32_t level) const;\n     void set_link_array(uint32_t docid, uint32_t level, const LinkArrayRef& links);\n+    void add_link_to(uint32_t docid, uint32_t level, const LinkArrayRef& old_links, uint32_t new_link) {\n+        LinkArray new_links(old_links.begin(), old_links.end());\n+        new_links.push_back(new_link);\n+        set_link_array(docid, level, new_links);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a217c1590afc4f5a1f8ea4b9cf72eb71c7404b7"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cb87fd70dcffd3d9549f21988dec6ca96670548", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/1cb87fd70dcffd3d9549f21988dec6ca96670548", "committedDate": "2020-03-16T15:35:22Z", "message": "update unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1ODI2ODA3", "url": "https://github.com/vespa-engine/vespa/pull/12584#pullrequestreview-375826807", "createdAt": "2020-03-17T08:33:51Z", "commit": {"oid": "f1276559667e86787fab42a85617fc16a6a25593"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODozMzo1MVrOF3SN1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODozNzoxNlrOF3SUhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNDQ1NA==", "bodyText": "Consider using auto.", "url": "https://github.com/vespa-engine/vespa/pull/12584#discussion_r393514454", "createdAt": "2020-03-17T08:33:51Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.cpp", "diffHunk": "@@ -334,6 +346,37 @@ HnswIndex::add_document(uint32_t docid)\n     }\n }\n \n+void\n+HnswIndex::mutual_reconnect(const LinkArrayRef &cluster, uint32_t level)\n+{\n+    std::vector<PairDist> pairs;\n+    for (uint32_t i = 0; i + 1 < cluster.size(); ++i) {\n+        uint32_t n_id_1 = cluster[i];\n+        LinkArrayRef n_list_1 = get_link_array(n_id_1, level);\n+        for (uint32_t j = i + 1; j < cluster.size(); ++j) {\n+            uint32_t n_id_2 = cluster[j];\n+            if (has_link_to(n_list_1, n_id_2)) continue;\n+            pairs.emplace_back(n_id_1, n_id_2, calc_distance(n_id_1, n_id_2));\n+        }\n+    }\n+    std::sort(pairs.begin(), pairs.end());\n+    for (const PairDist & pair : pairs) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1276559667e86787fab42a85617fc16a6a25593"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNjE2Ng==", "bodyText": "Prefer multi-line with brackets instead of one-line if statements.", "url": "https://github.com/vespa-engine/vespa/pull/12584#discussion_r393516166", "createdAt": "2020-03-17T08:37:16Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.cpp", "diffHunk": "@@ -334,6 +346,37 @@ HnswIndex::add_document(uint32_t docid)\n     }\n }\n \n+void\n+HnswIndex::mutual_reconnect(const LinkArrayRef &cluster, uint32_t level)\n+{\n+    std::vector<PairDist> pairs;\n+    for (uint32_t i = 0; i + 1 < cluster.size(); ++i) {\n+        uint32_t n_id_1 = cluster[i];\n+        LinkArrayRef n_list_1 = get_link_array(n_id_1, level);\n+        for (uint32_t j = i + 1; j < cluster.size(); ++j) {\n+            uint32_t n_id_2 = cluster[j];\n+            if (has_link_to(n_list_1, n_id_2)) continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1276559667e86787fab42a85617fc16a6a25593"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2693, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}