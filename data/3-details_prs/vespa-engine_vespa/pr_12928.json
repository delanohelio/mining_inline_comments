{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzODEyNjU5", "number": 12928, "title": "Bratseth/vespa http client improvements", "bodyText": "@vekterli please review. The last commit is the one to pay attention to, the earlier ones are just cleanup.\nWe're observing uneven load on containers during feeding on some applications, and this is the only reason for it that I can see. Once we let connections pass through the routing layer I guess this becomes more likely.", "createdAt": "2020-04-15T14:57:23Z", "url": "https://github.com/vespa-engine/vespa/pull/12928", "merged": true, "mergeCommit": {"oid": "309738aceed13418af517a3c6de930bb6291f0f3"}, "closed": true, "closedAt": "2020-04-16T17:04:06Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX1bD6AH2gAyNDAzODEyNjU5OmY2YjkwZDVlNDhkZmM4OTRiYjdjNTI5OTUyMmY1Y2VhMGVjMGM2NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYJEVugH2gAyNDAzODEyNjU5OjQyYzE3ZmYwM2FlZGU4MDAyNzhjZTVmNTZhNDEyNDA1OWJmMjllN2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f6b90d5e48dfc894bb7c5299522f5cea0ec0c658", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/f6b90d5e48dfc894bb7c5299522f5cea0ec0c658", "committedDate": "2020-04-15T10:20:52Z", "message": "Nonfunctional changes only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3881d6283dc36646f958da16b948cbb2affec845", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/3881d6283dc36646f958da16b948cbb2affec845", "committedDate": "2020-04-15T14:18:06Z", "message": "The document queue is always shared"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "874968628cb824e2a8dc99e1b9148e61c09a867e", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/874968628cb824e2a8dc99e1b9148e61c09a867e", "committedDate": "2020-04-15T14:34:51Z", "message": "Nonfunctional changes only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "748fcdf0901196fb6c7339ffdaf45bd47c56c78b", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/748fcdf0901196fb6c7339ffdaf45bd47c56c78b", "committedDate": "2020-04-15T14:54:14Z", "message": "Randomize chunk size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDIxNDM1", "url": "https://github.com/vespa-engine/vespa/pull/12928#pullrequestreview-394421435", "createdAt": "2020-04-16T08:44:47Z", "commit": {"oid": "3881d6283dc36646f958da16b948cbb2affec845"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo0NDo0OFrOGGa7Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTowNjozNVrOGGbypA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM4NTc0Mg==", "bodyText": "Should this be \"(...) or null if the failure occurred before this (...)\"?", "url": "https://github.com/vespa-engine/vespa/pull/12928#discussion_r409385742", "createdAt": "2020-04-16T08:44:48Z", "author": {"login": "vekterli"}, "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/EndpointIOException.java", "diffHunk": "@@ -20,8 +20,7 @@ public EndpointIOException(Endpoint endpoint, String message, Throwable cause) {\n         this.endpoint = endpoint;\n     }\n \n-    public Endpoint getEndpoint() {\n-        return endpoint;\n-    }\n+    /** Returns the endpoint, or the failure occurred before  this was assigned to a unique endpoint */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3881d6283dc36646f958da16b948cbb2affec845"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5MjAwMA==", "bodyText": "Should probably be Level.FINEST to match log.finest() call below", "url": "https://github.com/vespa-engine/vespa/pull/12928#discussion_r409392000", "createdAt": "2020-04-16T08:54:24Z", "author": {"login": "vekterli"}, "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -184,22 +184,22 @@ public String toString() {\n                 chunkSizeBytes = doc.size();\n             }\n         } catch (InterruptedException ie) {\n-            log.fine(\"Got break signal while waiting for new documents to feed.\");\n+            log.fine(\"Got break signal while waiting for new documents to feed\");\n             return docsForSendChunk;\n         }\n         int pendingSize = 1 + resultQueue.getPendingSize();\n         // see if we can get more documents without blocking\n+\n         while (chunkSizeBytes < maxChunkSizeBytes && pendingSize < maxInFlightRequests) {\n             drainFirstDocumentsInQueueIfOld();\n-            Document d = documentQueue.poll();\n-            if (d == null) {\n-                break;\n-            }\n-            docsForSendChunk.add(d);\n-            chunkSizeBytes += d.size();\n+            Document document = documentQueue.poll();\n+            if (document == null) break;\n+            docsForSendChunk.add(document);\n+            chunkSizeBytes += document.size();\n             pendingSize++;\n         }\n-        log.finest(\"Chunk has \" + docsForSendChunk.size() + \" docs with a size \" + chunkSizeBytes + \" bytes.\");\n+        if (log.isLoggable(Level.FINE))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "874968628cb824e2a8dc99e1b9148e61c09a867e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5OTk3Mg==", "bodyText": "This import does not seem to have been used", "url": "https://github.com/vespa-engine/vespa/pull/12928#discussion_r409399972", "createdAt": "2020-04-16T09:06:35Z", "author": {"login": "vekterli"}, "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -17,7 +17,9 @@\n import java.util.Collection;\n import java.util.List;\n import java.util.Optional;\n+import java.util.Random;\n import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ThreadLocalRandom;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748fcdf0901196fb6c7339ffdaf45bd47c56c78b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42c17ff03aede800278ce5f56a4124059bf29e7b", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/42c17ff03aede800278ce5f56a4124059bf29e7b", "committedDate": "2020-04-16T09:14:09Z", "message": "Minor fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3417, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}