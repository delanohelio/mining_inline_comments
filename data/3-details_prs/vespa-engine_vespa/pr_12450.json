{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MTg0NzQ1", "number": 12450, "title": "Jvenstad/integration test deployments with new deploy path", "bodyText": "@mpolden please review.", "createdAt": "2020-03-05T10:16:44Z", "url": "https://github.com/vespa-engine/vespa/pull/12450", "merged": true, "mergeCommit": {"oid": "eaeb10e29953aff69267f634351c26993d3b06e7"}, "closed": true, "closedAt": "2020-03-05T12:06:53Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKoqXSAH2gAyMzg0MTg0NzQ1Ojg1NGFlNTBiOTc1MTBjNTVkZjBhZGE2MjMwMzhmNTA0OGE1MGFhYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKqPLbgFqTM2OTUwOTgwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "854ae50b97510c55df0ada623038f5048a50aaaf", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/854ae50b97510c55df0ada623038f5048a50aaaf", "committedDate": "2020-03-05T10:07:48Z", "message": "Remove unused TesterCloud methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21ffbf56b2d6ef21c55641d5fc41460f8a2e6d47", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/21ffbf56b2d6ef21c55641d5fc41460f8a2e6d47", "committedDate": "2020-03-05T10:07:48Z", "message": "Remove \"endpoints\" from test-config responses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/ad5f5c22b4e9a9612073eb863abf0e6441fab0ed", "committedDate": "2020-03-05T10:10:11Z", "message": "Validate CNAMEs and IP lookup after deployment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDUyOTgx", "url": "https://github.com/vespa-engine/vespa/pull/12450#pullrequestreview-369452981", "createdAt": "2020-03-05T10:27:21Z", "commit": {"oid": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMDoyNzoyMVrOFyOE6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMDozNDo1N1rOFyOVYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwMzc1NQ==", "bodyText": "s/cNames/nameService/", "url": "https://github.com/vespa-engine/vespa/pull/12450#discussion_r388203755", "createdAt": "2020-03-05T10:27:21Z", "author": {"login": "mpolden"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/stubs/MockTesterCloud.java", "diffHunk": "@@ -1,24 +1,34 @@\n // Copyright 2018 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package com.yahoo.vespa.hosted.controller.api.integration.stubs;\n \n+import com.yahoo.config.provision.HostName;\n import com.yahoo.vespa.hosted.controller.api.identifiers.DeploymentId;\n import com.yahoo.vespa.hosted.controller.api.integration.LogEntry;\n import com.yahoo.vespa.hosted.controller.api.integration.deployment.TesterCloud;\n+import com.yahoo.vespa.hosted.controller.api.integration.dns.MemoryNameService;\n+import com.yahoo.vespa.hosted.controller.api.integration.dns.NameService;\n+import com.yahoo.vespa.hosted.controller.api.integration.dns.Record;\n+import com.yahoo.vespa.hosted.controller.api.integration.dns.RecordName;\n \n import java.net.URI;\n import java.util.ArrayList;\n import java.util.List;\n+import java.util.Optional;\n import java.util.stream.Collectors;\n \n import static com.yahoo.vespa.hosted.controller.api.integration.deployment.TesterCloud.Status.NOT_STARTED;\n import static com.yahoo.vespa.hosted.controller.api.integration.deployment.TesterCloud.Status.RUNNING;\n \n public class MockTesterCloud implements TesterCloud {\n \n+    private final NameService cNames;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNjMzNA==", "bodyText": "Combine with previous condition? Or is it necessary to treat them differently?", "url": "https://github.com/vespa-engine/vespa/pull/12450#discussion_r388206334", "createdAt": "2020-03-05T10:31:55Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/InternalStepRunner.java", "diffHunk": "@@ -472,11 +471,41 @@ private boolean endpointsAvailable(ApplicationId id, ZoneId zone, DualLogger log\n             logger.log(\"Endpoints not yet ready.\");\n             return false;\n         }\n-        for (var endpoint : endpoints.get(zone).keySet())\n-            if ( ! controller.jobController().cloud().exists(endpoint)) {\n-                logger.log(INFO, \"DNS lookup yielded no IP address for '\" + endpoint + \"'.\");\n+        var policies = controller.routing().policies().get(new DeploymentId(id, zone));\n+        for (var endpoint : endpoints.get(zone)) {\n+            HostName endpointName = HostName.from(endpoint.dnsName());\n+            var ipAddress = controller.jobController().cloud().resolveHostName(endpointName);\n+            if (ipAddress.isEmpty()) {\n+                logger.log(INFO, \"DNS lookup yielded no IP address for '\" + endpointName + \"'.\");\n                 return false;\n             }\n+            if (endpoint.routingMethod() == RoutingMethod.exclusive)  {\n+                var policy = policies.get(new RoutingPolicyId(id, ClusterSpec.Id.from(endpoint.name()), zone));\n+                if (policy == null)\n+                    throw new IllegalStateException(endpoint + \" has no matching policy in \" + policies);\n+\n+                var cNameValue = controller.jobController().cloud().resolveCName(endpointName);\n+                if (cNameValue.isEmpty()) {\n+                    logger.log(INFO, \"CNAME '\" + endpointName + \"' does not yet point to anything\");\n+                    return false;\n+                }\n+                if ( ! cNameValue.get().equals(policy.canonicalName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNzk3MQ==", "bodyText": "Consider renaming to either resolveCNAME or resolveCname (I think we mostly use the latter: camel-case regardless of actual casing).", "url": "https://github.com/vespa-engine/vespa/pull/12450#discussion_r388207971", "createdAt": "2020-03-05T10:34:57Z", "author": {"login": "mpolden"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/TesterCloud.java", "diffHunk": "@@ -29,14 +32,11 @@\n     /** Returns whether the test container is ready to serve */\n     boolean testerReady(DeploymentId deploymentId);\n \n-    /** Returns whether the given URL is registered in DNS. */\n-    boolean exists(URI endpointUrl);\n+    /** Returns the IP address of the given host name, if any. */\n+    Optional<String> resolveHostName(HostName hostname);\n \n-    /**\n-     * Returns whether the given URL is registered in DNS. Always returns true,\n-     * as endpoints are not use in this case\n-     */\n-    default boolean exists(DeploymentId deploymentId) { return true; }\n+    /** Returns the host name of the given CNAME, if any. */\n+    Optional<HostName> resolveCName(HostName hostName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "057227e623d661fe6f2e6fdb9c04614b5194e008", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/057227e623d661fe6f2e6fdb9c04614b5194e008", "committedDate": "2020-03-05T11:49:52Z", "message": "Rename some things, collapse some code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTA5ODAy", "url": "https://github.com/vespa-engine/vespa/pull/12450#pullrequestreview-369509802", "createdAt": "2020-03-05T11:57:55Z", "commit": {"oid": "057227e623d661fe6f2e6fdb9c04614b5194e008"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2750, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}