{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMjA3ODEw", "number": 15087, "title": "Jonmv/reindexing data stores", "bodyText": "@bjorncs please reivew.", "createdAt": "2020-10-29T11:30:26Z", "url": "https://github.com/vespa-engine/vespa/pull/15087", "merged": true, "mergeCommit": {"oid": "fd229417d0f7bb65fa1b6c428c49dfbbe6f86edc"}, "closed": true, "closedAt": "2020-11-02T08:46:01Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXQO3sgH2gAyNTEyMjA3ODEwOjQxYTdmODEyZDAzOTMxOTRjODlhZGU3NmEzMGY0MDZmODBhN2YxOGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYgiHzgH2gAyNTEyMjA3ODEwOmZlNDMxMzExMDRhYzIyMTU4YTY1YzZlNmMwNDBlMjNhNzZkMTYxMDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41a7f812d0393194c89ade76a30f406f80a7f18f", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/41a7f812d0393194c89ade76a30f406f80a7f18f", "committedDate": "2020-10-29T11:12:13Z", "message": "Split out method to get the config generation of all services of an application"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d41673879f667dc06ea326fe14ad8f6520ff981b", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/d41673879f667dc06ea326fe14ad8f6520ff981b", "committedDate": "2020-10-29T14:47:53Z", "message": "Add data store for reindexing data"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84c4052bd8a0e0ef056f827325d2008e7cbae2d8", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/84c4052bd8a0e0ef056f827325d2008e7cbae2d8", "committedDate": "2020-10-29T14:07:31Z", "message": "Add tests"}, "afterCommit": {"oid": "d41673879f667dc06ea326fe14ad8f6520ff981b", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/d41673879f667dc06ea326fe14ad8f6520ff981b", "committedDate": "2020-10-29T14:47:53Z", "message": "Add data store for reindexing data"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDE1MzI4", "url": "https://github.com/vespa-engine/vespa/pull/15087#pullrequestreview-521415328", "createdAt": "2020-11-02T08:28:31Z", "commit": {"oid": "41a7f812d0393194c89ade76a30f406f80a7f18f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwODoyODozMVrOHr6WEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwODozNDoyOFrOHr6hdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgwNjczNg==", "bodyText": "Consider renaming to getServiceConfigGenerationsResponse", "url": "https://github.com/vespa-engine/vespa/pull/15087#discussion_r515806736", "createdAt": "2020-11-02T08:28:31Z", "author": {"login": "bjorncs"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/application/ConfigConvergenceChecker.java", "diffHunk": "@@ -70,26 +70,30 @@ public ConfigConvergenceChecker(StateApiFactory stateApiFactory) {\n         this.stateApiFactory = stateApiFactory;\n     }\n \n-    /** Check all services in given application. Returns the minimum current generation of all services */\n-    public ServiceListResponse servicesToCheck(Application application, URI requestUrl, Duration timeoutPerService) {\n-        log.log(Level.FINE, () -> \"Finding services to check config convergence for in '\" + application);\n+    /** Fetches the active config generation for all services in the given application. */\n+    public Map<ServiceInfo, Long> getServiceConfigGenerations(Application application, Duration timeoutPerService) {\n         List<ServiceInfo> servicesToCheck = new ArrayList<>();\n         application.getModel().getHosts()\n                    .forEach(host -> host.getServices().stream()\n                                         .filter(service -> serviceTypesToCheck.contains(service.getServiceType()))\n                                         .forEach(service -> getStatePort(service).ifPresent(port -> servicesToCheck.add(service))));\n \n-        Map<ServiceInfo, Long> currentGenerations = getServiceGenerations(servicesToCheck, timeoutPerService);\n+        return getServiceGenerations(servicesToCheck, timeoutPerService);\n+    }\n+\n+    /** Check all services in given application. Returns the minimum current generation of all services */\n+    public ServiceListResponse getServiceConfigGenerationsJson(Application application, URI requestUrl, Duration timeoutPerService) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41a7f812d0393194c89ade76a30f406f80a7f18f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgwOTY1Mg==", "bodyText": "What is the reason for not copying the second parameter?", "url": "https://github.com/vespa-engine/vespa/pull/15087#discussion_r515809652", "createdAt": "2020-11-02T08:34:28Z", "author": {"login": "bjorncs"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/application/ReindexingStatus.java", "diffHunk": "@@ -0,0 +1,132 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.config.server.application;\n+\n+import com.yahoo.config.model.api.Reindexing;\n+\n+import java.time.Instant;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+\n+import static java.util.stream.Collectors.toUnmodifiableMap;\n+\n+/**\n+ * Pending and ready reindexing per document type. Each document type can have either a pending or a ready reindexing.\n+ * This is immutable.\n+ *\n+ * @author jonmv\n+ */\n+public class ReindexingStatus implements Reindexing {\n+\n+    private static final ReindexingStatus empty = new ReindexingStatus(Map.of(), Map.of());\n+\n+    private final Map<String, Long> pending;\n+    private final Map<String, Status> ready;\n+\n+    ReindexingStatus(Map<String, Long> pending, Map<String, Status> ready) {\n+        this.pending = Map.copyOf(pending);\n+        this.ready = ready;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d41673879f667dc06ea326fe14ad8f6520ff981b"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe43131104ac22158a65c6e6c040e23a76d16101", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/fe43131104ac22158a65c6e6c040e23a76d16101", "committedDate": "2020-11-02T08:45:39Z", "message": "Rename method and defensively copy in constructor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2227, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}