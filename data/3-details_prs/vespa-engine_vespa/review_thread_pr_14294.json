{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5Nzc4NDY0", "number": 14294, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzozNzo1NFrOEg0Lug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzozOTo1N1rOEg0OJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyODQ0ODU4OnYy", "diffSide": "RIGHT", "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzozNzo1NFrOHNzitA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODowMDoyMVrOHN0vUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzODAwNA==", "bodyText": "If we want to we could exit, but I'm not sure it's always the best thing to do since there could be a fix to the problem rolling out simultaneously, we could be feeding to multiple clusters etc. I think in general this client wants to keep trying until timeout, for better or worse.", "url": "https://github.com/vespa-engine/vespa/pull/14294#discussion_r484238004", "createdAt": "2020-09-07T07:37:54Z", "author": {"login": "bratseth"}, "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -348,11 +347,16 @@ private ConnectionState cycle(ConnectionState connectionState) {\n                     currentConnection.handshake();\n                     successfulHandshakes.getAndIncrement();\n                 } catch (ServerResponseException ser) {\n+                    int code = ser.getResponseCode();\n+                    if (code == 401 || code == 403) {\n+                        drainDocumentQueueWhenFailingPermanently(new Exception(\"Denied access by endpoint:\" + ser.getResponseString()));\n+                        log.log(Level.SEVERE, \"Failed authentication or authorization with '\" + endpoint + \"': \" + Exceptions.toMessageString(ser));\n+                        return ConnectionState.CONNECTED; // Should ideally exit immediately, instead of doing this per X documents :/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dca8a74a0a96739912343962c5857d9e6d4f67c1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NzYxNg==", "bodyText": "Yep.", "url": "https://github.com/vespa-engine/vespa/pull/14294#discussion_r484257616", "createdAt": "2020-09-07T08:00:21Z", "author": {"login": "jonmv"}, "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -348,11 +347,16 @@ private ConnectionState cycle(ConnectionState connectionState) {\n                     currentConnection.handshake();\n                     successfulHandshakes.getAndIncrement();\n                 } catch (ServerResponseException ser) {\n+                    int code = ser.getResponseCode();\n+                    if (code == 401 || code == 403) {\n+                        drainDocumentQueueWhenFailingPermanently(new Exception(\"Denied access by endpoint:\" + ser.getResponseString()));\n+                        log.log(Level.SEVERE, \"Failed authentication or authorization with '\" + endpoint + \"': \" + Exceptions.toMessageString(ser));\n+                        return ConnectionState.CONNECTED; // Should ideally exit immediately, instead of doing this per X documents :/", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzODAwNA=="}, "originalCommit": {"oid": "dca8a74a0a96739912343962c5857d9e6d4f67c1"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyODQ1NDc2OnYy", "diffSide": "RIGHT", "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzozOTo1N1rOHNzmlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzo1OTo1N1rOHN0uEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzODk5OQ==", "bodyText": "Thanks for dissolving my math! I just wrote down the function I had in mind \ud83d\ude1d", "url": "https://github.com/vespa-engine/vespa/pull/14294#discussion_r484238999", "createdAt": "2020-09-07T07:39:57Z", "author": {"login": "bratseth"}, "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -595,12 +599,9 @@ private boolean timeToPoll(GatewayConnection connection) {\n             if (connection.lastPollTime() == null) return true;\n \n             // Exponential (2^x) dropoff:\n-            double unit = pollIntervalUS / 1000.0;\n-            double x = (  clock.millis() - connection.connectionTime().plus(connectionTimeToLive).toEpochMilli() ) / unit;\n-            double lastX = (  connection.lastPollTime().toEpochMilli() - connection.connectionTime().plus(connectionTimeToLive).toEpochMilli() ) / unit;\n-\n-            double currentDelayDoublings = Math.log(lastX)/Math.log(2);\n-            return (x - lastX) > Math.pow(2, currentDelayDoublings);\n+            double connectionEndOfLife = connection.connectionTime().plus(connectionTimeToLive).toEpochMilli();\n+            double connectionLastPolled = connection.lastPollTime().toEpochMilli();\n+            return clock.millis() - connectionEndOfLife > 2 * (connectionLastPolled - connectionEndOfLife);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dca8a74a0a96739912343962c5857d9e6d4f67c1"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NzI5OQ==", "bodyText": "\ud83d\ude1c", "url": "https://github.com/vespa-engine/vespa/pull/14294#discussion_r484257299", "createdAt": "2020-09-07T07:59:57Z", "author": {"login": "jonmv"}, "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -595,12 +599,9 @@ private boolean timeToPoll(GatewayConnection connection) {\n             if (connection.lastPollTime() == null) return true;\n \n             // Exponential (2^x) dropoff:\n-            double unit = pollIntervalUS / 1000.0;\n-            double x = (  clock.millis() - connection.connectionTime().plus(connectionTimeToLive).toEpochMilli() ) / unit;\n-            double lastX = (  connection.lastPollTime().toEpochMilli() - connection.connectionTime().plus(connectionTimeToLive).toEpochMilli() ) / unit;\n-\n-            double currentDelayDoublings = Math.log(lastX)/Math.log(2);\n-            return (x - lastX) > Math.pow(2, currentDelayDoublings);\n+            double connectionEndOfLife = connection.connectionTime().plus(connectionTimeToLive).toEpochMilli();\n+            double connectionLastPolled = connection.lastPollTime().toEpochMilli();\n+            return clock.millis() - connectionEndOfLife > 2 * (connectionLastPolled - connectionEndOfLife);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzODk5OQ=="}, "originalCommit": {"oid": "dca8a74a0a96739912343962c5857d9e6d4f67c1"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1381, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}