{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNjA4MTI4", "number": 13515, "title": "Add support for new/delete with alignment that came along in c++17 wi\u2026", "bodyText": "\u2026th gcc 9\n@vekterli PR", "createdAt": "2020-06-09T08:02:19Z", "url": "https://github.com/vespa-engine/vespa/pull/13515", "merged": true, "mergeCommit": {"oid": "08c746daf556d1ab72b6dc469c6a7e9e668720a0"}, "closed": true, "closedAt": "2020-06-10T04:57:43Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpgY0hgH2gAyNDMxNjA4MTI4OjZlZjQ0MDczM2VmODk5MjUxYmU5NDVhMWIzYzk4NWU3NmU0YTYzMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpyWlfAH2gAyNDMxNjA4MTI4OmVjODExYzE2ZTVlZGZhYmIyZWY5ZTdlOWYzZTUxNWU1MmQwYWU2YzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ef440733ef899251be945a1b3c985e76e4a6312", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/6ef440733ef899251be945a1b3c985e76e4a6312", "committedDate": "2020-06-09T08:01:03Z", "message": "Add support for new/delete with alignment that came along in c++17 with gcc 9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "994452c26a88f406fc30056b3616eee79a7da651", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/994452c26a88f406fc30056b3616eee79a7da651", "committedDate": "2020-06-09T08:56:24Z", "message": "Add comment about natural alignment in vespamalloc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTI2MTc1", "url": "https://github.com/vespa-engine/vespa/pull/13515#pullrequestreview-426926175", "createdAt": "2020-06-09T08:55:02Z", "commit": {"oid": "6ef440733ef899251be945a1b3c985e76e4a6312"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwODo1NTowMlrOGg_V3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOTowNzowM1rOGg_7kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0NTQwNA==", "bodyText": "As of C++17 you can leave out the message parameter to static_assert and it should just use the expression itself.", "url": "https://github.com/vespa-engine/vespa/pull/13515#discussion_r437245404", "createdAt": "2020-06-09T08:55:02Z", "author": {"login": "vekterli"}, "path": "vespamalloc/src/tests/test1/new_test.cpp", "diffHunk": "@@ -0,0 +1,91 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+#include <vespa/vespalib/testkit/testapp.h>\n+#include <vespa/log/log.h>\n+\n+LOG_SETUP(\"new_test\");\n+\n+void cmp(const void *a, const void *b) {\n+    EXPECT_EQUAL(a, b);\n+}\n+void cmp(const void *base, size_t offset, const void *p) {\n+    cmp((static_cast<const char *>(base) + offset), p);\n+}\n+\n+TEST(\"verify new with normal alignment\") {\n+    struct S {\n+        int a;\n+        long b;\n+        int c;\n+    };\n+    static_assert(sizeof(S) == 24, \"sizeof(S) == 16\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef440733ef899251be945a1b3c985e76e4a6312"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI1NTA1Nw==", "bodyText": "For these tests, should we additionally check the returned pointer alignment itself? The struct field alignments should be up to the compiler to get right. Might be enough to add a templated checker function that verifies  (uintptr_t(s.get()) % alignof(S)) == 0?", "url": "https://github.com/vespa-engine/vespa/pull/13515#discussion_r437255057", "createdAt": "2020-06-09T09:07:03Z", "author": {"login": "vekterli"}, "path": "vespamalloc/src/tests/test1/new_test.cpp", "diffHunk": "@@ -0,0 +1,91 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+#include <vespa/vespalib/testkit/testapp.h>\n+#include <vespa/log/log.h>\n+\n+LOG_SETUP(\"new_test\");\n+\n+void cmp(const void *a, const void *b) {\n+    EXPECT_EQUAL(a, b);\n+}\n+void cmp(const void *base, size_t offset, const void *p) {\n+    cmp((static_cast<const char *>(base) + offset), p);\n+}\n+\n+TEST(\"verify new with normal alignment\") {\n+    struct S {\n+        int a;\n+        long b;\n+        int c;\n+    };\n+    static_assert(sizeof(S) == 24, \"sizeof(S) == 16\");\n+    auto s = std::make_unique<S>();\n+    cmp(s.get(), &s->a);\n+    cmp(s.get(), 8, &s->b);\n+    cmp(s.get(), 16, &s->c);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994452c26a88f406fc30056b3616eee79a7da651"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10d787f8be2bbdf3e8c49999d256c22404bdd5e3", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/10d787f8be2bbdf3e8c49999d256c22404bdd5e3", "committedDate": "2020-06-09T09:52:00Z", "message": "Add test of alignment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3c970b449bec64d0a3f7a91a08a9237400016ef", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/b3c970b449bec64d0a3f7a91a08a9237400016ef", "committedDate": "2020-06-09T11:55:51Z", "message": "Handle alignment in vespamallocd too."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDc1NTgy", "url": "https://github.com/vespa-engine/vespa/pull/13515#pullrequestreview-427075582", "createdAt": "2020-06-09T12:14:05Z", "commit": {"oid": "b3c970b449bec64d0a3f7a91a08a9237400016ef"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjoxNDowNVrOGhGXjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjoxODowNVrOGhGgDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2MDUyNQ==", "bodyText": "Both these could be constexpr (though the compiler will do this in practice anyway)", "url": "https://github.com/vespa-engine/vespa/pull/13515#discussion_r437360525", "createdAt": "2020-06-09T12:14:05Z", "author": {"login": "vekterli"}, "path": "vespamalloc/src/vespamalloc/malloc/memblockboundscheck.h", "diffHunk": "@@ -45,6 +59,12 @@ class MemBlockBoundsCheckBaseTBase : public CommonT<5>\n     void verifyFill() const __attribute__((noinline));\n \n     void setSize(size_t sz) { static_cast<uint64_t *>(_ptr)[0] = sz; }\n+    static size_t preambleOverhead(std::align_val_t alignment) {\n+        return std::max(4*sizeof(unsigned), size_t(alignment));\n+    }\n+    static size_t preambleOverhead() {\n+        return 4*sizeof(unsigned);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c970b449bec64d0a3f7a91a08a9237400016ef"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2MTQ4NA==", "bodyText": "These could also be constexpr", "url": "https://github.com/vespa-engine/vespa/pull/13515#discussion_r437361484", "createdAt": "2020-06-09T12:15:58Z", "author": {"login": "vekterli"}, "path": "vespamalloc/src/vespamalloc/malloc/memblockboundscheck.h", "diffHunk": "@@ -121,13 +141,23 @@ class MemBlockBoundsCheckBaseT : public MemBlockBoundsCheckBaseTBase\n         }\n         return StackTraceLen;\n     }\n-    static size_t adjustSize(size_t sz)   { return sz + ((4+1)*sizeof(unsigned) + StackTraceLen*sizeof(void *)); }\n-    static size_t unAdjustSize(size_t sz) { return sz - ((4+1)*sizeof(unsigned) + StackTraceLen*sizeof(void *)); }\n+    static size_t adjustSize(size_t sz)   { return sz + overhead(); }\n+    static size_t adjustSize(size_t sz, std::align_val_t alignment)   { return sz + overhead(alignment); }\n+    static size_t unAdjustSize(size_t sz) { return sz - overhead(); }\n     static void dumpInfo(size_t level) __attribute__((noinline));\n     static size_t getMinSizeForAlignment(size_t align, size_t sz) { return sz + align; }\n     void info(FILE * os, unsigned level=0) const __attribute__((noinline));\n \n protected:\n+    static size_t postambleOverhead() {\n+        return sizeof(unsigned) + StackTraceLen*sizeof(void *);\n+    }\n+    static size_t overhead() {\n+        return preambleOverhead() + postambleOverhead();\n+    }\n+    static size_t overhead(std::align_val_t alignment) {\n+        return preambleOverhead(alignment) + postambleOverhead();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c970b449bec64d0a3f7a91a08a9237400016ef"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2MjcwMQ==", "bodyText": "Could also be return std::max(preambleOverhead(), size_t(alignment));", "url": "https://github.com/vespa-engine/vespa/pull/13515#discussion_r437362701", "createdAt": "2020-06-09T12:18:05Z", "author": {"login": "vekterli"}, "path": "vespamalloc/src/vespamalloc/malloc/memblockboundscheck.h", "diffHunk": "@@ -45,6 +59,12 @@ class MemBlockBoundsCheckBaseTBase : public CommonT<5>\n     void verifyFill() const __attribute__((noinline));\n \n     void setSize(size_t sz) { static_cast<uint64_t *>(_ptr)[0] = sz; }\n+    static size_t preambleOverhead(std::align_val_t alignment) {\n+        return std::max(4*sizeof(unsigned), size_t(alignment));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c970b449bec64d0a3f7a91a08a9237400016ef"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3b94caca5d92adc8330f22d0cb952d81cbc5dbc", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/a3b94caca5d92adc8330f22d0cb952d81cbc5dbc", "committedDate": "2020-06-09T12:24:51Z", "message": "Add ignore for test executables."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ab52f43ca7877c08b93408d7bcf8b0355c007e4", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/1ab52f43ca7877c08b93408d7bcf8b0355c007e4", "committedDate": "2020-06-09T12:41:04Z", "message": "Add some constexpr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "642a5f52a2bbdcb5f02aea4415d502af10331593", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/642a5f52a2bbdcb5f02aea4415d502af10331593", "committedDate": "2020-06-09T14:14:23Z", "message": "Store alignmnet so that tail magic is computed correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec811c16e5edfabb2ef9e7e9f3e515e52d0ae6c1", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/ec811c16e5edfabb2ef9e7e9f3e515e52d0ae6c1", "committedDate": "2020-06-10T04:56:54Z", "message": "Must check validity before setting new size and alignment."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3716, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}