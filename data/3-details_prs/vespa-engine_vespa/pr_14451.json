{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MzQxNTk4", "number": 14451, "title": "Bjorncs/feed handler cleanup", "bodyText": "@baldersheim  or @jonmv please review", "createdAt": "2020-09-18T14:10:03Z", "url": "https://github.com/vespa-engine/vespa/pull/14451", "merged": true, "mergeCommit": {"oid": "ed9ed2be991da5e0af53d81a6dbf31b78eefdb22"}, "closed": true, "closedAt": "2020-09-21T12:24:56Z", "author": {"login": "bjorncs"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKFllFgH2gAyNDg5MzQxNTk4OjU2MGMxNDRiYzcyZGI4YTMzMzU3NDJmNmM2NTlkMWQzMTJiMTIyYTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLAAOhgFqTQ5MjQyMDMwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "560c144bc72db8a3335742f6c659d1d312b122a5", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/560c144bc72db8a3335742f6c659d1d312b122a5", "committedDate": "2020-09-18T13:27:03Z", "message": "Add getter for number of queued tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65586893bb603a6c433b9c0047293ae605e654be", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/65586893bb603a6c433b9c0047293ae605e654be", "committedDate": "2020-09-18T13:58:00Z", "message": "Move tests package containing classes being tested\n\nPackage private members can now be used from tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/849c980b2470bbba975fd3e4a14f43fabdbf9cc2", "committedDate": "2020-09-18T14:03:05Z", "message": "Reimplement flow control to work correctly with new threadpool model\n\nThrottle http requests when http handler threadpool starts queuing.\nAlways use non-blocking send method on messagebus session.\nRemove handling of messagebus status code that is never returned."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzY4MTIz", "url": "https://github.com/vespa-engine/vespa/pull/14451#pullrequestreview-491768123", "createdAt": "2020-09-18T20:40:27Z", "commit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0MDoyN1rOHUbQQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0MDoyN1rOHUbQQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4MDA5OA==", "bodyText": "Did you intend for this to be sendBlocking, as we discussed?", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491180098", "createdAt": "2020-09-18T20:40:27Z", "author": {"login": "jonmv"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/ClientFeederV3.java", "diffHunk": "@@ -191,30 +169,14 @@ private int getOverloadReturnCode(HttpRequest request) {\n         }\n     }\n \n-    private Result sendMessage(FeederSettings settings,\n-                               DocumentOperationMessageV3 msg,\n-                               AtomicInteger threadsAvailableForFeeding) throws InterruptedException {\n-        Result result = null;\n-        while (result == null || result.getError().getCode() == SEND_QUEUE_FULL) {\n-            msg.getMessage().pushHandler(feedReplyHandler);\n-\n-            if (settings.denyIfBusy && threadsAvailableForFeeding.get() < 1) {\n-                return sourceSession.getResource().sendMessage(msg.getMessage());\n-            } else {\n-                result = sourceSession.getResource().sendMessageBlocking(msg.getMessage());\n-            }\n-            if (result.isAccepted()) {\n-                return result;\n-            }\n-            Thread.sleep(100);\n-        }\n-        return result;\n+    private Result sendMessage(DocumentOperationMessageV3 msg) {\n+        msg.getMessage().pushHandler(feedReplyHandler);\n+        return sourceSession.getResource().sendMessage(msg.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 127}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzY4MzE0", "url": "https://github.com/vespa-engine/vespa/pull/14451#pullrequestreview-491768314", "createdAt": "2020-09-18T20:40:49Z", "commit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0MDo0OVrOHUbQ5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDo0Njo0NlrOHUbbBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4MDI2MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491180261", "createdAt": "2020-09-18T20:40:49Z", "author": {"login": "jonmv"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/ClientFeederV3.java", "diffHunk": "@@ -244,27 +205,21 @@ private void feed(FeederSettings settings,\n                 repliesFromOldMessages.add(createOperationStatus(message.get().getOperationId(),\n                                                                  result.getError().getMessage(),\n                                                                  ErrorCode.TRANSIENT_ERROR,\n-                                                                 false,\n-                                                                 message.get().getMessage()));\n+                        message.get().getMessage()));\n             } else {\n-                // should probably not happen, but everybody knows stuff that\n-                // shouldn't happen, happens all the time\n-                boolean isConditionNotMet = result.getError().getCode() == DocumentProtocol.ERROR_TEST_AND_SET_CONDITION_FAILED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4Mjg1NA==", "bodyText": "I believe this would oftentimes be true, even though there's no need to throttle. Consider a larger number than 0.", "url": "https://github.com/vespa-engine/vespa/pull/14451#discussion_r491182854", "createdAt": "2020-09-18T20:46:46Z", "author": {"login": "jonmv"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/vespa/http/server/FeedHandlerV3.java", "diffHunk": "@@ -44,31 +43,40 @@\n     private final SessionCache sessionCache;\n     protected final ReplyHandler feedReplyHandler;\n     private final Metric metric;\n+    private final ClientFeederV3.HttpThrottlePolicy httpThrottlePolicy;\n     private final Object monitor = new Object();\n-    private final AtomicInteger threadsAvailableForFeeding;\n     private static final Logger log = Logger.getLogger(FeedHandlerV3.class.getName());\n \n-    public FeedHandlerV3(Executor executor,\n+    public FeedHandlerV3(ContainerThreadPool threadpool,\n                          Metric metric,\n                          AccessLog accessLog,\n                          DocumentmanagerConfig documentManagerConfig,\n                          SessionCache sessionCache,\n-                         ThreadpoolConfig threadpoolConfig,\n                          DocumentApiMetrics metricsHelper) {\n+        this(threadpool.executor(),\n+                () -> threadpool.queuedTasks() > 0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNDIwMzA1", "url": "https://github.com/vespa-engine/vespa/pull/14451#pullrequestreview-492420305", "createdAt": "2020-09-21T09:30:39Z", "commit": {"oid": "849c980b2470bbba975fd3e4a14f43fabdbf9cc2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4254, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}