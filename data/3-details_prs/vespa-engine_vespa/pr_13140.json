{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNjU2Njcy", "number": 13140, "title": "Require the same FileSystem provider", "bodyText": "TL;DR  Require all paths with NodeAgentContext[Impl] to use the same file system provider, and add a FileSystem fileSystem() method.\nNodeAgentContext[Impl] requires paths to have specific providers, otherwise a ProviderMismatchException will be thrown, which it often does when adding tests involving ths class.  The current API is best described by defining a few terms:\n\nLet PathDefault be a Path with a file system provider matching that of FileSystems.getDefault().provider().\nLet PathContainerStorage be a Path with the same file system provider as the context's pathToContainerStorage constructor param\nLet PathVespaHome be a Path with the same file system provider as the context's pathToVespaHome constructor param.\n\nThe context methods handling paths have these requirements:\n\nPath pathOnHostFromPathInNode(Path pathInNode) maps a PathDefault to PathContainerStorage\nPath pathInNodeFromPathOnHost(Path pathOnHost) maps a PathContainerStorage to PathDefault\nPath pathInNodeUnderVespaHome(Path relativePath) maps a PathVespaHome to PathVespaHome\nPath rewritePathInNodeForWantedDockerImage(Path path) maps a PathDefault to PathDefault, and requires PathVespaHome == PathDefault, if it is to work under all circumstances.\n\nThis PR requires all paths with NAC[I] to have the same provider, otherwise we'll detect this and throw as early as possible.", "createdAt": "2020-05-03T19:53:00Z", "url": "https://github.com/vespa-engine/vespa/pull/13140", "merged": true, "mergeCommit": {"oid": "e797ce0580baa2eded8556df5c6ca2991cf9b6f5"}, "closed": true, "closedAt": "2020-05-04T07:00:21Z", "author": {"login": "hakonhall"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdwZOggH2gAyNDEyNjU2NjcyOjJkZTQ0OTAyODJmMTIzOTg5YTJlZThmYmI3ZTVjOTI5NjhkODc2YzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcd5n6OAFqTQwNDczNDE2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2de4490282f123989a2ee8fbb7e5c92968d876c1", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/2de4490282f123989a2ee8fbb7e5c92968d876c1", "committedDate": "2020-05-03T19:52:53Z", "message": "Require the same FileSystem provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b75fc4be1d5c8a38d75740e33c681490762f102d", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/b75fc4be1d5c8a38d75740e33c681490762f102d", "committedDate": "2020-05-03T20:06:10Z", "message": "Use /home/docker/container-storage as default container storage path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44116d676bdcc87ae8fbf138181ed857db246b0e", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/44116d676bdcc87ae8fbf138181ed857db246b0e", "committedDate": "2020-05-03T20:29:33Z", "message": "Simplify paths in NodeAgentContextImpl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NzM0MTY5", "url": "https://github.com/vespa-engine/vespa/pull/13140#pullrequestreview-404734169", "createdAt": "2020-05-04T06:35:42Z", "commit": {"oid": "44116d676bdcc87ae8fbf138181ed857db246b0e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNjozNTo0MlrOGP0EMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNjozNTo0MlrOGP0EMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIzNDg2NQ==", "bodyText": "The container-storage addition means more typing in tests... :(", "url": "https://github.com/vespa-engine/vespa/pull/13140#discussion_r419234865", "createdAt": "2020-05-04T06:35:42Z", "author": {"login": "freva"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentContextImpl.java", "diffHunk": "@@ -296,8 +300,9 @@ public String getCloudNativeRegionName() {\n                             return getId().region().value();\n                         }\n                     }),\n-                    Optional.ofNullable(pathToContainerStorage).orElseGet(() -> fileSystem.getPath(\"/home/docker\")),\n-                    Optional.ofNullable(pathToVespaHome).orElseGet(() -> fileSystem.getPath(\"/opt/vespa\")),\n+                    fileSystem,\n+                    fileSystem.getPath(\"/home/docker/container-storage\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44116d676bdcc87ae8fbf138181ed857db246b0e"}, "originalPosition": 192}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3305, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}