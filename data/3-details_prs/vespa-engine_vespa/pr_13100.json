{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNjA4NDc0", "number": 13100, "title": "Support blocking lid space compaction during high remove rate", "bodyText": "@toregge and @baldersheim please review\nDuring a period with a high rate of remove operations, there is no use running lid space compaction\nas this will interfere with the remove operations, increasing latency of those.\nMoving a document as part of lid space compaction is a costly operation (similar to putting the document in the first place) and it typically uses both the index and attribute writer thread pools.", "createdAt": "2020-04-29T09:56:37Z", "url": "https://github.com/vespa-engine/vespa/pull/13100", "merged": true, "mergeCommit": {"oid": "96e5348eb4a484a7911c50925335a729ac292b3e"}, "closed": true, "closedAt": "2020-04-29T13:23:44Z", "author": {"login": "geirst"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccTq-hAH2gAyNDEwNjA4NDc0OjZkMTA4YmFjZGYzYzkyZWJiZjhhODRiNzBmZjYxOTIwMWZmMWJhNTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccYbSGgFqTQwMjY2MDAwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6d108bacdf3c92ebbf8a84b70ff619201ff1ba53", "author": {"user": {"login": "geirst", "name": "Geir Storli"}}, "url": "https://github.com/vespa-engine/vespa/commit/6d108bacdf3c92ebbf8a84b70ff619201ff1ba53", "committedDate": "2020-04-29T07:51:06Z", "message": "Improve tracking of remove batch rate used to consider to block lid space compaction.\n\nThis is also a preparation for tracking the rate of regular remove operations,\nand use this to consider to block lid space compaction."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cc0f99900706932ac98c29af66c609199387785", "author": {"user": {"login": "geirst", "name": "Geir Storli"}}, "url": "https://github.com/vespa-engine/vespa/commit/7cc0f99900706932ac98c29af66c609199387785", "committedDate": "2020-04-29T09:46:04Z", "message": "Add tracking of remove operations rate and use this to consider blocking lid space compaction.\n\nDuring a period with a high rate of remove operations, there is no use running lid space compaction\nas this will interfere with the remove operations, increasing latency of those.\nMoving a document as part of lid space compaction is a costly operation (similar to putting the document in the first place)\nand it typically uses both the index and attribute writer thread pools."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNTMzNzAy", "url": "https://github.com/vespa-engine/vespa/pull/13100#pullrequestreview-402533702", "createdAt": "2020-04-29T10:15:10Z", "commit": {"oid": "7cc0f99900706932ac98c29af66c609199387785"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMDoxNToxMFrOGN4XTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMDoxNToxMFrOGN4XTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIwODE0MQ==", "bodyText": "Consider using std::shared_ptr<documentmetastore::OperationListener>, to be consistent with forward declaration above\nand not depend on corresponding include file having been included.", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417208141", "createdAt": "2020-04-29T10:15:10Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/documentmetastore.h", "diffHunk": "@@ -71,7 +74,7 @@ class DocumentMetaStore final : public DocumentMetaStoreAttribute,\n     uint32_t            _shrinkLidSpaceBlockers;\n     const SubDbType     _subDbType;\n     bool                _trackDocumentSizes;\n-    search::LidUsageStats::TimePoint _last_remove_batch;\n+    documentmetastore::OperationListener::SP _op_listener;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cc0f99900706932ac98c29af66c609199387785"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNTM3OTEz", "url": "https://github.com/vespa-engine/vespa/pull/13100#pullrequestreview-402537913", "createdAt": "2020-04-29T10:21:54Z", "commit": {"oid": "7cc0f99900706932ac98c29af66c609199387785"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMDoyMTo1NFrOGN4kQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMDoyMTo1NFrOGN4kQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMTQ1OQ==", "bodyText": "Consider forward declaring documentmetastore::OperationListener and using std::shared_ptr here.", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417211459", "createdAt": "2020-04-29T10:21:54Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/i_document_meta_store.h", "diffHunk": "@@ -82,6 +83,8 @@ struct IDocumentMetaStore : public search::IDocumentMetaStore,\n      */\n     virtual void compactLidSpace(DocId wantedLidLimit) = 0;\n \n+    virtual void set_operation_listener(documentmetastore::OperationListener::SP op_listener) = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cc0f99900706932ac98c29af66c609199387785"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNTM4NDAz", "url": "https://github.com/vespa-engine/vespa/pull/13100#pullrequestreview-402538403", "createdAt": "2020-04-29T10:22:42Z", "commit": {"oid": "7cc0f99900706932ac98c29af66c609199387785"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMDoyMjo0MlrOGN4l0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMDoyMjo0MlrOGN4l0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMTg1Nw==", "bodyText": "This include is not needed if documentmetastore::OperationListener is forward declared later on in this file.", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417211857", "createdAt": "2020-04-29T10:22:42Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/i_document_meta_store.h", "diffHunk": "@@ -4,6 +4,7 @@\n \n #include \"lid_gid_key_comparator.h\"\n #include \"i_simple_document_meta_store.h\"\n+#include \"operation_listener.h\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cc0f99900706932ac98c29af66c609199387785"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902795d717aa6fc54f42e92cd7d06a930070383b", "author": {"user": {"login": "geirst", "name": "Geir Storli"}}, "url": "https://github.com/vespa-engine/vespa/commit/902795d717aa6fc54f42e92cd7d06a930070383b", "committedDate": "2020-04-29T12:29:37Z", "message": "Use forward declaration of OperationListener in header files."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNjM4Mjkx", "url": "https://github.com/vespa-engine/vespa/pull/13100#pullrequestreview-402638291", "createdAt": "2020-04-29T12:57:13Z", "commit": {"oid": "902795d717aa6fc54f42e92cd7d06a930070383b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNjYwMDA3", "url": "https://github.com/vespa-engine/vespa/pull/13100#pullrequestreview-402660007", "createdAt": "2020-04-29T13:23:29Z", "commit": {"oid": "902795d717aa6fc54f42e92cd7d06a930070383b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3294, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}