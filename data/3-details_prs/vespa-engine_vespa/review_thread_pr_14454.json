{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MzY5MTI4", "number": 14454, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjowMToxOVrOElB2DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo0OTowOFrOElnnsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MjYyOTg4OnYy", "diffSide": "RIGHT", "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "isResolved": false, "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjowMToxOVrOHUTGfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwODoyMjoxMFrOHVFGkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg==", "bodyText": "But that's more difficult ... doesn't this just work?", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491046526", "createdAt": "2020-09-18T16:01:19Z", "author": {"login": "bratseth"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTExNTIyOQ==", "bodyText": "@baldersheim wqs of the opinion this should go.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491115229", "createdAt": "2020-09-18T18:16:06Z", "author": {"login": "jonmv"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NzIyMg==", "bodyText": "It uses self subscription.\n1 - It means that at will change out of sync with the other components also using the same config.\n\nComponents will be out of sync in for a short time.\nIt is either very costly due to extra synchronisation. However I think it is worse, they will never agree, as there are thread visibility issues.\n2 - It leaks resources. Every heapdump I have checked where the customer has done this, it is leaking threads and other resources.\n\n3 - I think that having the config injected is a simple remediation for this mess. I thought that was the whole reason for having config injected and creating final components.\nThis is one og our bad past patterns.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491197222", "createdAt": "2020-09-18T21:23:58Z", "author": {"login": "baldersheim"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI5MDQzNw==", "bodyText": "Yes DocumentAccess is a factory for clients, if you're in a container you should have everything injected. This used to be convenient when running a client on a node which can reach config servers. It's not relevant to cloud deployments, so fine I guess.\nBtw, we should have an object you can have injected directly to make it more obvious what to do when running in a container, perhaps that could be done as part of this work.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491290437", "createdAt": "2020-09-19T06:26:40Z", "author": {"login": "bratseth"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQyNzY1MA==", "bodyText": "Yes, I thought the same thing. The document access is perhaps something we wish to create only when needed, so a factory which is always present, based on the relevant config?", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491427650", "createdAt": "2020-09-19T13:05:03Z", "author": {"login": "jonmv"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ3Mjg1OA==", "bodyText": "Yes, or preferably something like a session (or, two - one sync and one async) which is always present so we don't need to destroy it - but otoh I'm not sure if we want to create the connections if we don't need them.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491472858", "createdAt": "2020-09-19T16:54:17Z", "author": {"login": "bratseth"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY3MjU2Nw==", "bodyText": "But sync sessions are often used one per client? So rather a session factory, i.e. a document access? How about a lazy doc access, then? If one of those is always enough.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491672567", "createdAt": "2020-09-20T09:26:23Z", "author": {"login": "jonmv"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY3Mzc0Mg==", "bodyText": "A doc access is also what you need for visitor sessions.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491673742", "createdAt": "2020-09-20T09:41:24Z", "author": {"login": "jonmv"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxNjQ3Ng==", "bodyText": "Hmm, why the sync sessions are used one per thread/operation in the current document/v1, I don't know ... Seems like an error to me. So you could indeed have injectable Sync and Async-Sessions. That doesn't cover the other types of sessions, though.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491816476", "createdAt": "2020-09-21T06:31:32Z", "author": {"login": "jonmv"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgyNzczOQ==", "bodyText": "If anything, using multiple SyncSessions to handle a feed of operations breaks operation sequencing ...", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491827739", "createdAt": "2020-09-21T07:03:11Z", "author": {"login": "jonmv"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2MzA4NQ==", "bodyText": "Yes, that should work if we're ok with always having instances of these sessions.\nWhat other types of sessions?", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491863085", "createdAt": "2020-09-21T08:17:14Z", "author": {"login": "bratseth"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2NTc0Ng==", "bodyText": "VisitorSession. I guess SubscriptionSession never got an implementation. See #14461 for a suggestion of a lazy DocumentAccess provider.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491865746", "createdAt": "2020-09-21T08:22:10Z", "author": {"login": "jonmv"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, "originalCommit": {"oid": "f6f0e76416325171b4a39585d58af50133fe7372"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODgxOTA0OnYy", "diffSide": "RIGHT", "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentIdResponse.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo0OTowOFrOHVMD-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo0OTowOFrOHVMD-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3OTc2OA==", "bodyText": "Consider setting forRemoval=true. IDE/compiler gives stronger feedback if true.", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491979768", "createdAt": "2020-09-21T11:49:08Z", "author": {"login": "bjorncs"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentIdResponse.java", "diffHunk": "@@ -36,9 +35,9 @@ public DocumentIdResponse(long requestId, DocumentId documentId) {\n      * @param textMessage the message to encapsulate in the Response\n      * @param success     true if the response represents a successful call\n      */\n+    @Deprecated(since = \"7\") // TODO: Remove on Vespa 8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03824050b9de32cc7c68c5a26179cc93a70bd82c"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1357, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}