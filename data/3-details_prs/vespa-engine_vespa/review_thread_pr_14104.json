{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMTEyMDk0", "number": 14104, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMjozMjoxNFrOEZ9Kpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMjozMjoxNFrOEZ9Kpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NjUyMDA3OnYy", "diffSide": "RIGHT", "path": "python/vespa/vespa/package.py", "isResolved": false, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMjozMjoxNFrOHDFLPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDoyNDo1NFrOHESDjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA==", "bodyText": "Is it idiomatic to return a tuple with message and a handle? It seems odd, and how do you programatically see the difference between successes and failures here?\nYou should probably use self.local_port instead of directly referencing port 8080?", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r472992574", "createdAt": "2020-08-19T12:32:14Z", "author": {"login": "oyving"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1NzMyMA==", "bodyText": "Yes, you are right. The tuple seems odd. I suggest to store the deployment message as an attribute of the Vespa instance. What do you think?\n\n\nAbout the difference between successes and failures: This info needs to be extracted from the deployment message. My plan is to improve this part of the code as I experience deployment failures as I do not have a full overview of the type of errors I can face at this moment.\n\n\nI agree about self.local_port. I will make the change after we settle about the points above.", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473757320", "createdAt": "2020-08-20T08:26:40Z", "author": {"login": "thigm85"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3MjY1OA==", "bodyText": "I guess the idiomatic way would be to throw and exception on failure and return the handle on success? It can lead to a bit noisy code, but I think that's the way the Python standard libraries does it (e.g. opening a file failures). Then an error message could be encoded in the exception. Messages on success can be an attribute on the Vespa object.", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473872658", "createdAt": "2020-08-20T10:43:49Z", "author": {"login": "oyving"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg4MTcwOA==", "bodyText": "Yes, I agree. I will definitely throw an exception if a deployment failure occur. I will implement the exceptions as soon as I face a deployment failure. But I think we are agreeing that the deployment message will be included on the Vespa instance when it is returned (which will only happen if deployment goes through.)", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473881708", "createdAt": "2020-08-20T10:56:05Z", "author": {"login": "thigm85"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkwNTQ0Ng==", "bodyText": "Also, I found a way to detect when vespa deployment fails and then the code raises RunTimeError exception with the deployment message showing what went wrong.", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473905446", "createdAt": "2020-08-20T11:39:33Z", "author": {"login": "thigm85"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzOTA1OQ==", "bodyText": "Suddenly I wonder why port is a separate parameter to the constructor and not part of the URL. I'm slow to catch that :)", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473939059", "createdAt": "2020-08-20T12:41:08Z", "author": {"login": "oyving"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4MTAwNQ==", "bodyText": "Not sure why I chose that besides the fact that I guess url and port often comes as two different arguments in other libraries. I myself always wonder if port should be included or not when specifying urls. Do you suggest a change?", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r474181005", "createdAt": "2020-08-20T18:16:13Z", "author": {"login": "thigm85"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NzgwNA==", "bodyText": "But if we agree to unify url and port into one I can do so in another PR.", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r474187804", "createdAt": "2020-08-20T18:28:43Z", "author": {"login": "thigm85"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MjE3NQ==", "bodyText": "In general the URL should only omit the port number if it's the default port number for the protocol specified in the URL. But yes, let's keep that for a different PR then :)", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r474252175", "createdAt": "2020-08-20T20:24:54Z", "author": {"login": "oyving"}, "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, "originalCommit": {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1466, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}