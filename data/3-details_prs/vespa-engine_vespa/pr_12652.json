{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNjMxMDI2", "number": 12652, "title": "Bratseth/deprovision fixes", "bodyText": "@mpolden  or @freva please review", "createdAt": "2020-03-20T16:36:44Z", "url": "https://github.com/vespa-engine/vespa/pull/12652", "merged": true, "mergeCommit": {"oid": "240d24592ae0e4fb931ac170ba241787eca9d4f2"}, "closed": true, "closedAt": "2020-03-20T16:49:13Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPjKlVgH2gAyMzkxNjMxMDI2OmMyZGIyNDI5MGNlNjVhODBlMDJhZGNlYzUzYTVhYmFiZGMzOTg3ZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPjY4YAH2gAyMzkxNjMxMDI2OjRlYmQ4NDhiMWE1YWExYjE1ZGViZGIyMDliNjIzNjEyNDY0ZDQyZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c2db24290ce65a80e02adcec53a5ababdc3987ec", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/c2db24290ce65a80e02adcec53a5ababdc3987ec", "committedDate": "2020-03-20T16:33:11Z", "message": "Preserve only specific fields when reprovisioning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9355926f5faec617354279b02adcf56ae59b4f9f", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/9355926f5faec617354279b02adcf56ae59b4f9f", "committedDate": "2020-03-20T16:35:40Z", "message": "Only move *tenant* hosts to deprovisioned"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjQ0OTE2", "url": "https://github.com/vespa-engine/vespa/pull/12652#pullrequestreview-378644916", "createdAt": "2020-03-20T16:42:23Z", "commit": {"oid": "9355926f5faec617354279b02adcf56ae59b4f9f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo0MjoyM1rOF5bUpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo0MjoyM1rOF5bUpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MDgwNg==", "bodyText": "is -> it?", "url": "https://github.com/vespa-engine/vespa/pull/12652#discussion_r395760806", "createdAt": "2020-03-20T16:42:23Z", "author": {"login": "freva"}, "path": "node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java", "diffHunk": "@@ -148,32 +148,42 @@ public void delete_host_only_after_all_the_children_have_been_deleted() {\n     }\n \n     @Test\n-    public void deprovisioned_hosts_are_resurrected_on_add() {\n+    public void relevant_information_from_deprovisioned_hosts_are_merged_into_readded_host() {\n         NodeRepositoryTester tester = new NodeRepositoryTester();\n         Instant testStart = tester.nodeRepository().clock().instant();\n \n-        ((ManualClock)tester.nodeRepository().clock()).advance(Duration.ofSeconds(1));\n+        tester.clock().advance(Duration.ofSeconds(1));\n         tester.addNode(\"id1\", \"host1\", \"default\", NodeType.host);\n         tester.addNode(\"id2\", \"host2\", \"default\", NodeType.host);\n         assertFalse(tester.nodeRepository().getNode(\"host1\").get().history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n \n-        // Set host 1 properties and remove it\n+        // Set host 1 properties and deprovision it\n         Node host1 = tester.nodeRepository().getNode(\"host1\").get();\n         host1 = host1.withWantToRetire(true, Agent.system, tester.nodeRepository().clock().instant());\n         host1 = host1.with(host1.status().withWantToDeprovision(true));\n+        host1 = host1.withFirmwareVerifiedAt(tester.clock().instant());\n+        host1 = host1.with(host1.status().withIncreasedFailCount());\n+        host1 = host1.with(host1.reports().withReport(Report.basicReport(\"id\", Report.Type.HARD_FAIL, tester.clock().instant(), \"Test report\")));\n         tester.nodeRepository().write(host1, tester.nodeRepository().lock(host1));\n         tester.nodeRepository().removeRecursively(\"host1\");\n \n         // Host 1 is deprovisioned and unwanted properties are cleared\n         host1 = tester.nodeRepository().getNode(\"host1\").get();\n         assertEquals(Node.State.deprovisioned, host1.state());\n         assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n-        assertFalse(host1.status().wantToRetire());\n-        assertFalse(host1.status().wantToDeprovision());\n \n-        // Adding it again moves it from deprovisioned\n-        host1 = tester.addNode(\"id1\", \"host1\", \"default\", NodeType.host);\n-        assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n+        // Adding it again preserves some information from the deprovisioned host and removes is", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9355926f5faec617354279b02adcf56ae59b4f9f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ebd848b1a5aa1b15debdb209b623612464d42f2", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/4ebd848b1a5aa1b15debdb209b623612464d42f2", "committedDate": "2020-03-20T16:48:48Z", "message": "Correct comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2594, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}