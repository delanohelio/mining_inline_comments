{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTc5NTc2", "number": 13268, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDozNzoxM1rOD85eAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDo0Mjo0OFrOD85mrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MTgyNzIyOnYy", "diffSide": "RIGHT", "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDozNzoxM1rOGWHk6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyODowNlrOGWUWbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0NTk5NQ==", "bodyText": "consider using i", "url": "https://github.com/vespa-engine/vespa/pull/13268#discussion_r425845995", "createdAt": "2020-05-15T14:37:13Z", "author": {"login": "havardpe"}, "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "diffHunk": "@@ -253,6 +255,63 @@ Test::testThatOptimizePreservesUnpack()\n     fixup_bitvectors();\n }\n \n+void verifyOrUnpack(SearchIterator & s, const TermFieldMatchData * tfmd) {\n+    s.initFullRange();\n+    s.seek(1);\n+    for (size_t i = 0; i < 3; i++) {\n+        EXPECT_EQUAL(0u, tfmd[0].getDocId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b988b87698a745f73f17773468e5710817ef7"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTI3OA==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/13268#discussion_r426055278", "createdAt": "2020-05-15T21:28:06Z", "author": {"login": "baldersheim"}, "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "diffHunk": "@@ -253,6 +255,63 @@ Test::testThatOptimizePreservesUnpack()\n     fixup_bitvectors();\n }\n \n+void verifyOrUnpack(SearchIterator & s, const TermFieldMatchData * tfmd) {\n+    s.initFullRange();\n+    s.seek(1);\n+    for (size_t i = 0; i < 3; i++) {\n+        EXPECT_EQUAL(0u, tfmd[0].getDocId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0NTk5NQ=="}, "originalCommit": {"oid": "531b988b87698a745f73f17773468e5710817ef7"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MTgzMzkzOnYy", "diffSide": "RIGHT", "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDozODo0OFrOGWHo-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyODoxOFrOGWUWtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0NzAzMg==", "bodyText": "not fixed by fixup", "url": "https://github.com/vespa-engine/vespa/pull/13268#discussion_r425847032", "createdAt": "2020-05-15T14:38:48Z", "author": {"login": "havardpe"}, "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "diffHunk": "@@ -253,6 +255,63 @@ Test::testThatOptimizePreservesUnpack()\n     fixup_bitvectors();\n }\n \n+void verifyOrUnpack(SearchIterator & s, const TermFieldMatchData * tfmd) {\n+    s.initFullRange();\n+    s.seek(1);\n+    for (size_t i = 0; i < 3; i++) {\n+        EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    }\n+    s.unpack(1);\n+    EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    EXPECT_EQUAL(1u, tfmd[1].getDocId());\n+    EXPECT_EQUAL(0u, tfmd[2].getDocId());\n+}\n+\n+void\n+Test::testUnpackOfOr() {\n+    _bvs[0]->clearBit(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b988b87698a745f73f17773468e5710817ef7"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTM0OQ==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/13268#discussion_r426055349", "createdAt": "2020-05-15T21:28:18Z", "author": {"login": "baldersheim"}, "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "diffHunk": "@@ -253,6 +255,63 @@ Test::testThatOptimizePreservesUnpack()\n     fixup_bitvectors();\n }\n \n+void verifyOrUnpack(SearchIterator & s, const TermFieldMatchData * tfmd) {\n+    s.initFullRange();\n+    s.seek(1);\n+    for (size_t i = 0; i < 3; i++) {\n+        EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    }\n+    s.unpack(1);\n+    EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    EXPECT_EQUAL(1u, tfmd[1].getDocId());\n+    EXPECT_EQUAL(0u, tfmd[2].getDocId());\n+}\n+\n+void\n+Test::testUnpackOfOr() {\n+    _bvs[0]->clearBit(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0NzAzMg=="}, "originalCommit": {"oid": "531b988b87698a745f73f17773468e5710817ef7"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MTgzNDM5OnYy", "diffSide": "RIGHT", "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDozODo1OFrOGWHpUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyODoyOFrOGWUW8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0NzEyMA==", "bodyText": "not fixed by fixup", "url": "https://github.com/vespa-engine/vespa/pull/13268#discussion_r425847120", "createdAt": "2020-05-15T14:38:58Z", "author": {"login": "havardpe"}, "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "diffHunk": "@@ -253,6 +255,63 @@ Test::testThatOptimizePreservesUnpack()\n     fixup_bitvectors();\n }\n \n+void verifyOrUnpack(SearchIterator & s, const TermFieldMatchData * tfmd) {\n+    s.initFullRange();\n+    s.seek(1);\n+    for (size_t i = 0; i < 3; i++) {\n+        EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    }\n+    s.unpack(1);\n+    EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    EXPECT_EQUAL(1u, tfmd[1].getDocId());\n+    EXPECT_EQUAL(0u, tfmd[2].getDocId());\n+}\n+\n+void\n+Test::testUnpackOfOr() {\n+    _bvs[0]->clearBit(1);\n+    _bvs[1]->setBit(1);\n+    _bvs[2]->clearBit(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b988b87698a745f73f17773468e5710817ef7"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTQxMA==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/13268#discussion_r426055410", "createdAt": "2020-05-15T21:28:28Z", "author": {"login": "baldersheim"}, "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "diffHunk": "@@ -253,6 +255,63 @@ Test::testThatOptimizePreservesUnpack()\n     fixup_bitvectors();\n }\n \n+void verifyOrUnpack(SearchIterator & s, const TermFieldMatchData * tfmd) {\n+    s.initFullRange();\n+    s.seek(1);\n+    for (size_t i = 0; i < 3; i++) {\n+        EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    }\n+    s.unpack(1);\n+    EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    EXPECT_EQUAL(1u, tfmd[1].getDocId());\n+    EXPECT_EQUAL(0u, tfmd[2].getDocId());\n+}\n+\n+void\n+Test::testUnpackOfOr() {\n+    _bvs[0]->clearBit(1);\n+    _bvs[1]->setBit(1);\n+    _bvs[2]->clearBit(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0NzEyMA=="}, "originalCommit": {"oid": "531b988b87698a745f73f17773468e5710817ef7"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MTg0OTQxOnYy", "diffSide": "RIGHT", "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDo0Mjo0OFrOGWHzGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyODozOFrOGWUXIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0OTYyNA==", "bodyText": "consider checking for multi-bitvector optimization", "url": "https://github.com/vespa-engine/vespa/pull/13268#discussion_r425849624", "createdAt": "2020-05-15T14:42:48Z", "author": {"login": "havardpe"}, "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "diffHunk": "@@ -253,6 +255,63 @@ Test::testThatOptimizePreservesUnpack()\n     fixup_bitvectors();\n }\n \n+void verifyOrUnpack(SearchIterator & s, const TermFieldMatchData * tfmd) {\n+    s.initFullRange();\n+    s.seek(1);\n+    for (size_t i = 0; i < 3; i++) {\n+        EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    }\n+    s.unpack(1);\n+    EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    EXPECT_EQUAL(1u, tfmd[1].getDocId());\n+    EXPECT_EQUAL(0u, tfmd[2].getDocId());\n+}\n+\n+void\n+Test::testUnpackOfOr() {\n+    _bvs[0]->clearBit(1);\n+    _bvs[1]->setBit(1);\n+    _bvs[2]->clearBit(1);\n+    UnpackInfo all;\n+    all.forceAll();\n+    verifyUnpackOfOr(all);\n+\n+    UnpackInfo unpackInfo;\n+    unpackInfo.add(1);\n+    unpackInfo.add(2);\n+    verifyUnpackOfOr(unpackInfo);\n+\n+    fixup_bitvectors();\n+}\n+\n+void\n+Test::verifyUnpackOfOr(const UnpackInfo &unpackInfo)\n+{\n+    TermFieldMatchData tfmdA[3];\n+    MultiSearch::Children children;\n+    children.push_back(createIter(0, false, tfmdA[0], false).release());\n+    children.push_back(createIter(1, false, tfmdA[1], false).release());\n+    children.push_back(createIter(2, false, tfmdA[2], false).release());\n+    SearchIterator::UP s(OrSearch::create(children, false, unpackInfo));\n+    verifyOrUnpack(*s, tfmdA);\n+\n+    for (auto & tfmd : tfmdA) {\n+        tfmd.resetOnlyDocId(0);\n+    }\n+\n+    const MultiSearch * ms = dynamic_cast<const MultiSearch *>(s.get());\n+    EXPECT_TRUE(ms != nullptr);\n+    EXPECT_EQUAL(3u, ms->getChildren().size());\n+\n+    s = MultiBitVectorIteratorBase::optimize(std::move(s));\n+    s->initFullRange();\n+    ms = dynamic_cast<const MultiSearch *>(s.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b988b87698a745f73f17773468e5710817ef7"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTQ1Nw==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/13268#discussion_r426055457", "createdAt": "2020-05-15T21:28:38Z", "author": {"login": "baldersheim"}, "path": "searchlib/src/tests/queryeval/multibitvectoriterator/multibitvectoriterator_test.cpp", "diffHunk": "@@ -253,6 +255,63 @@ Test::testThatOptimizePreservesUnpack()\n     fixup_bitvectors();\n }\n \n+void verifyOrUnpack(SearchIterator & s, const TermFieldMatchData * tfmd) {\n+    s.initFullRange();\n+    s.seek(1);\n+    for (size_t i = 0; i < 3; i++) {\n+        EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    }\n+    s.unpack(1);\n+    EXPECT_EQUAL(0u, tfmd[0].getDocId());\n+    EXPECT_EQUAL(1u, tfmd[1].getDocId());\n+    EXPECT_EQUAL(0u, tfmd[2].getDocId());\n+}\n+\n+void\n+Test::testUnpackOfOr() {\n+    _bvs[0]->clearBit(1);\n+    _bvs[1]->setBit(1);\n+    _bvs[2]->clearBit(1);\n+    UnpackInfo all;\n+    all.forceAll();\n+    verifyUnpackOfOr(all);\n+\n+    UnpackInfo unpackInfo;\n+    unpackInfo.add(1);\n+    unpackInfo.add(2);\n+    verifyUnpackOfOr(unpackInfo);\n+\n+    fixup_bitvectors();\n+}\n+\n+void\n+Test::verifyUnpackOfOr(const UnpackInfo &unpackInfo)\n+{\n+    TermFieldMatchData tfmdA[3];\n+    MultiSearch::Children children;\n+    children.push_back(createIter(0, false, tfmdA[0], false).release());\n+    children.push_back(createIter(1, false, tfmdA[1], false).release());\n+    children.push_back(createIter(2, false, tfmdA[2], false).release());\n+    SearchIterator::UP s(OrSearch::create(children, false, unpackInfo));\n+    verifyOrUnpack(*s, tfmdA);\n+\n+    for (auto & tfmd : tfmdA) {\n+        tfmd.resetOnlyDocId(0);\n+    }\n+\n+    const MultiSearch * ms = dynamic_cast<const MultiSearch *>(s.get());\n+    EXPECT_TRUE(ms != nullptr);\n+    EXPECT_EQUAL(3u, ms->getChildren().size());\n+\n+    s = MultiBitVectorIteratorBase::optimize(std::move(s));\n+    s->initFullRange();\n+    ms = dynamic_cast<const MultiSearch *>(s.get());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0OTYyNA=="}, "originalCommit": {"oid": "531b988b87698a745f73f17773468e5710817ef7"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1569, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}