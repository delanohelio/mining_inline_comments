{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2OTg1MDg4", "number": 13230, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwODozMjoxNlrOD79uCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwOTowMDoxMVrOD7-Zvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MjAzNzg2OnYy", "diffSide": "RIGHT", "path": "documentapi/src/main/java/com/yahoo/documentapi/messagebus/protocol/LoadBalancer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwODozMjoxNlrOGUnFwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMDozMzo0MlrOGUrihQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2NTE1Mw==", "bodyText": "Could use cachedIndex.computeIfAbsent here instead of explicit branch (though not needing a lambda might be faster?)", "url": "https://github.com/vespa-engine/vespa/pull/13230#discussion_r424265153", "createdAt": "2020-05-13T08:32:16Z", "author": {"login": "vekterli"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/messagebus/protocol/LoadBalancer.java", "diffHunk": "@@ -54,6 +55,14 @@ public int getIndex(String nodeName) {\n             throw new IllegalArgumentException(err, e);\n         }\n     }\n+    private int getCachedIndex(String nodeName) {\n+        Integer index = cachedIndex.get(nodeName);\n+        if (index == null) {\n+            index = getIndex(nodeName);\n+            cachedIndex.put(nodeName, index);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf214d62e2eaba0b413feec0fc525142698a8fda"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzODA1Mw==", "bodyText": "Done, I think the JIT compiler will solve the performance for us.", "url": "https://github.com/vespa-engine/vespa/pull/13230#discussion_r424338053", "createdAt": "2020-05-13T10:33:42Z", "author": {"login": "baldersheim"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/messagebus/protocol/LoadBalancer.java", "diffHunk": "@@ -54,6 +55,14 @@ public int getIndex(String nodeName) {\n             throw new IllegalArgumentException(err, e);\n         }\n     }\n+    private int getCachedIndex(String nodeName) {\n+        Integer index = cachedIndex.get(nodeName);\n+        if (index == null) {\n+            index = getIndex(nodeName);\n+            cachedIndex.put(nodeName, index);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2NTE1Mw=="}, "originalCommit": {"oid": "cf214d62e2eaba0b413feec0fc525142698a8fda"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MjE0OTc1OnYy", "diffSide": "RIGHT", "path": "documentapi/src/main/java/com/yahoo/documentapi/messagebus/protocol/LoadBalancer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwOTowMDoxMVrOGUoL8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMDowMzoyMFrOGUqiwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI4MzEyMw==", "bodyText": "The returned NodeMetrics object is shared and thus may be read outside the lock whilst concurrently being updated by another thread. Is this a problem? Should we deep-copy the metrics to make sure they're internally consistent? This is not something introduced by this PR, but just a general observation.", "url": "https://github.com/vespa-engine/vespa/pull/13230#discussion_r424283123", "createdAt": "2020-05-13T09:00:11Z", "author": {"login": "vekterli"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/messagebus/protocol/LoadBalancer.java", "diffHunk": "@@ -68,24 +77,24 @@ public Node getRecipient(List<Mirror.Entry> choices) {\n \n         double weightSum = 0.0;\n         Node selectedNode = null;\n-        double position = safePosition.get();\n-        for (Mirror.Entry entry : choices) {\n-            NodeMetrics nodeMetrics = getNodeMetrics(entry);\n+        synchronized (this) {\n+            for (Mirror.Entry entry : choices) {\n+                NodeMetrics nodeMetrics = getNodeMetrics(entry);\n \n-            weightSum += nodeMetrics.weight;\n+                weightSum += nodeMetrics.weight;\n \n-            if (weightSum > position) {\n-                selectedNode = new Node(entry, nodeMetrics);\n-                break;\n+                if (weightSum > position) {\n+                    selectedNode = new Node(entry, nodeMetrics);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf214d62e2eaba0b413feec0fc525142698a8fda"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMTczMA==", "bodyText": "That was why I made it package private. I checked all other usage. That was only in tests.", "url": "https://github.com/vespa-engine/vespa/pull/13230#discussion_r424321730", "createdAt": "2020-05-13T10:03:20Z", "author": {"login": "baldersheim"}, "path": "documentapi/src/main/java/com/yahoo/documentapi/messagebus/protocol/LoadBalancer.java", "diffHunk": "@@ -68,24 +77,24 @@ public Node getRecipient(List<Mirror.Entry> choices) {\n \n         double weightSum = 0.0;\n         Node selectedNode = null;\n-        double position = safePosition.get();\n-        for (Mirror.Entry entry : choices) {\n-            NodeMetrics nodeMetrics = getNodeMetrics(entry);\n+        synchronized (this) {\n+            for (Mirror.Entry entry : choices) {\n+                NodeMetrics nodeMetrics = getNodeMetrics(entry);\n \n-            weightSum += nodeMetrics.weight;\n+                weightSum += nodeMetrics.weight;\n \n-            if (weightSum > position) {\n-                selectedNode = new Node(entry, nodeMetrics);\n-                break;\n+                if (weightSum > position) {\n+                    selectedNode = new Node(entry, nodeMetrics);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI4MzEyMw=="}, "originalCommit": {"oid": "cf214d62e2eaba0b413feec0fc525142698a8fda"}, "originalPosition": 94}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1645, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}