{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MzYzMDU0", "number": 14630, "title": "Use BigDecimal for budget inside the Quota", "bodyText": "To allow budgets below $1/hour we change the internal representation of budget\nto a decimal number.  Some interfaces that assume integers are kept to keep the\nAPI stable.\n\n\nCreated a nicer method .unlimited() instead of .empt() to better show semantics.\n\n\nAdded some serialisation tests to make sure we support integers and decimals.\n\n\nI confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-09-30T09:06:06Z", "url": "https://github.com/vespa-engine/vespa/pull/14630", "merged": true, "mergeCommit": {"oid": "58a92e118482272de89bb6b9046daaaab00f42ac"}, "closed": true, "closedAt": "2020-10-01T07:43:21Z", "author": {"login": "oyving"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN5AzZgH2gAyNDk1MzYzMDU0OjY4MTc2Mjg4NjQ5YjVlYmMzYmJmMDBhZTkzNDg3NWMxN2I5YTc1Yjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN9vgcgFqTQ5OTQ5OTE4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "68176288649b5ebc3bbf00ae934875c17b9a75b7", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/68176288649b5ebc3bbf00ae934875c17b9a75b7", "committedDate": "2020-09-30T09:03:43Z", "message": "Use BigDecimal for budget inside the Quota\n\n- To allow budgets below $1/hour we change the internal representation of budget\n  to a decimal number.  Some interfaces that assume integers are kept to keep the\n  API stable.\n\n- Created a nicer method .unlimited() instead of .empt() to better show semantics.\n\n- Added some serialisation tests to make sure we support integers and decimals."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef52f22d1a495ccd3497384d19feeebe70439378", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/ef52f22d1a495ccd3497384d19feeebe70439378", "committedDate": "2020-09-30T09:08:36Z", "message": "Merge remote-tracking branch 'origin/master' into ogronnesby/quota-decimal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MzQ1Nzk2", "url": "https://github.com/vespa-engine/vespa/pull/14630#pullrequestreview-499345796", "createdAt": "2020-09-30T11:48:57Z", "commit": {"oid": "ef52f22d1a495ccd3497384d19feeebe70439378"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMTo0ODo1N1rOHaZvDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMTo1NDo1MlrOHaZ7Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0NjY2OQ==", "bodyText": "Consider BigDecimal parameter instead of Optional. That way you avoid the initial problem where signatures with generic types cannot be overloaded. Same for the other method.", "url": "https://github.com/vespa-engine/vespa/pull/14630#discussion_r497446669", "createdAt": "2020-09-30T11:48:57Z", "author": {"login": "mpolden"}, "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "diffHunk": "@@ -14,42 +16,57 @@\n  * @author ogronnesby\n  */\n public class Quota {\n+    private static final Quota UNLIMITED = new Quota(Optional.empty(), Optional.empty());\n \n+    /** The max size of a cluster inside application */\n     private final Optional<Integer> maxClusterSize;\n \n     /** The max budget in dollars per hour */\n-    private final Optional<Integer> budget;\n+    private final Optional<BigDecimal> budget;\n \n-    public Quota(Optional<Integer> maybeClusterSize, Optional<Integer> budget) {\n-        this.maxClusterSize = maybeClusterSize;\n-        this.budget = budget;\n+    // TODO: Remove constructor once Vespa < 7.300 is gone from production\n+    public Quota(Optional<Integer> maxClusterSize, Optional<Integer> budget) {\n+        this(maxClusterSize, budget.map(BigDecimal::new), true);\n+    }\n+\n+    private Quota(Optional<Integer> maxClusterSize, Optional<BigDecimal> budget, boolean isDecimal) {\n+        this.maxClusterSize = Objects.requireNonNull(maxClusterSize);\n+        this.budget = Objects.requireNonNull(budget);\n     }\n \n     public static Quota fromSlime(Inspector inspector) {\n         var clusterSize = SlimeUtils.optionalLong(inspector.field(\"clusterSize\"));\n-        var budget = SlimeUtils.optionalLong(inspector.field(\"budget\"));\n-        return new Quota(clusterSize.map(Long::intValue), budget.map(Long::intValue));\n+        var budget = budgetFromSlime(inspector.field(\"budget\"));\n+        return new Quota(clusterSize.map(Long::intValue), budget, true);\n+    }\n+\n+    public Quota withBudget(Optional<BigDecimal> budget) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef52f22d1a495ccd3497384d19feeebe70439378"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0OTgyMw==", "bodyText": "Missing @author.", "url": "https://github.com/vespa-engine/vespa/pull/14630#discussion_r497449823", "createdAt": "2020-09-30T11:54:52Z", "author": {"login": "mpolden"}, "path": "config-model-api/src/test/java/com/yahoo/config/model/api/QuotaTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.config.model.api;\n+\n+import com.yahoo.slime.SlimeUtils;\n+import org.junit.Test;\n+\n+\n+import java.math.BigDecimal;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QuotaTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef52f22d1a495ccd3497384d19feeebe70439378"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55b24de2df59ecb1accb919deecdf818d44ff1c4", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/55b24de2df59ecb1accb919deecdf818d44ff1c4", "committedDate": "2020-09-30T13:32:38Z", "message": "Don't use optional in with* methods\n\nAlso added a serialisation/deserialiasation test for quota"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDk5MTg1", "url": "https://github.com/vespa-engine/vespa/pull/14630#pullrequestreview-499499185", "createdAt": "2020-09-30T14:34:21Z", "commit": {"oid": "55b24de2df59ecb1accb919deecdf818d44ff1c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4134, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}