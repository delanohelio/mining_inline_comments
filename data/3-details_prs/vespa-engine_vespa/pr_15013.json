{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4Mjk5OTMx", "number": 15013, "title": "Bratseth/persist metrics rebased", "bodyText": "", "createdAt": "2020-10-22T13:40:01Z", "url": "https://github.com/vespa-engine/vespa/pull/15013", "merged": true, "mergeCommit": {"oid": "24fe152948851e1f11c63e86b96a78db91343a61"}, "closed": true, "closedAt": "2020-10-23T06:19:15Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVBrF0gH2gAyNTA4Mjk5OTMxOmFhZTY4MzJjM2FhOTA1ZjA2M2E5ODkyYmE3Zjc5OWYwZTc0MDRkNWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVI18CAH2gAyNTA4Mjk5OTMxOmUxNWI3MGJlZmRlZmQ2MjJiNjY4MmFhOTNmMmQyZjUxYjM2NzU0NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aae6832c3aa905f063a9892ba7f799f0e7404d5a", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/aae6832c3aa905f063a9892ba7f799f0e7404d5a", "committedDate": "2020-10-22T13:06:37Z", "message": "Add QuestDb dependency and run basic test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd6fde6bfd38f24b6fff64f0eb81bb834f109adb", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/dd6fde6bfd38f24b6fff64f0eb81bb834f109adb", "committedDate": "2020-10-22T13:13:13Z", "message": "Store scaling events in ZooKeeper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45ec64648963241b95ba2d71dd81f9fac352acba", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/45ec64648963241b95ba2d71dd81f9fac352acba", "committedDate": "2020-10-22T13:22:32Z", "message": "Pass ApplicationTransaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4129d01a4ed3917010f1d98e002b3cab4903118", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/f4129d01a4ed3917010f1d98e002b3cab4903118", "committedDate": "2020-10-22T13:23:55Z", "message": "Write all values at once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ea86cfcc45382cffb13a39ed125683bac71840e", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/7ea86cfcc45382cffb13a39ed125683bac71840e", "committedDate": "2020-10-22T13:27:25Z", "message": "Rename some types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "430157f1157416984b8fffa904ce7066a6b7c5bf", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/430157f1157416984b8fffa904ce7066a6b7c5bf", "committedDate": "2020-10-22T13:28:11Z", "message": "Store and read all metrics together"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef5bd4b5218e8ef7ab1307629c857f2ecbe8dc67", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/ef5bd4b5218e8ef7ab1307629c857f2ecbe8dc67", "committedDate": "2020-10-22T13:28:47Z", "message": "Look up metrics just once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4731bc1fbefc4efe1d26ca183e4510b5bd6861b", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/d4731bc1fbefc4efe1d26ca183e4510b5bd6861b", "committedDate": "2020-10-22T13:29:44Z", "message": "Minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64918c40aaf2d0ec632a91b699d4cd92886e9884", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/64918c40aaf2d0ec632a91b699d4cd92886e9884", "committedDate": "2020-10-22T13:30:30Z", "message": "Minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25bceedc5e24b2e27b34536b155119c70a673ecc", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/25bceedc5e24b2e27b34536b155119c70a673ecc", "committedDate": "2020-10-22T13:30:49Z", "message": "Clean up terminology"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3013538d73fc9546f5d3eba7a3211e6b5c41f485", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/3013538d73fc9546f5d3eba7a3211e6b5c41f485", "committedDate": "2020-10-22T13:31:18Z", "message": "Remove middleman"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53e5f06cd8e545be91a7fc1e9cf0e7eacb249aae", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/53e5f06cd8e545be91a7fc1e9cf0e7eacb249aae", "committedDate": "2020-10-22T13:31:33Z", "message": "Make NodeTimeseries immutable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "081c3fb60c09797e64f317563901c3aefa35f3f0", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/081c3fb60c09797e64f317563901c3aefa35f3f0", "committedDate": "2020-10-22T13:34:50Z", "message": "Create MetricsDb interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c54905d8bf15e8e0d467ead1c4b919103055e0f", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/5c54905d8bf15e8e0d467ead1c4b919103055e0f", "committedDate": "2020-10-22T13:35:55Z", "message": "Quest MetricsDb implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52594861d88a28c4c5c8ad128c91efaca9bf31d8", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/52594861d88a28c4c5c8ad128c91efaca9bf31d8", "committedDate": "2020-10-22T13:36:23Z", "message": "Switch to Quest metrics db implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c685a819f34b56ce98f8b436eef277d88b878f1", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/1c685a819f34b56ce98f8b436eef277d88b878f1", "committedDate": "2020-10-22T13:36:37Z", "message": "Set db file system location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b1d140dd34b202ced09b35e6e441df1aa25a8a0", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/9b1d140dd34b202ced09b35e6e441df1aa25a8a0", "committedDate": "2020-10-22T13:36:54Z", "message": "Use data dir for log config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcc7c5bc6c4e7e7812ab88f804da0a44e80a4fce", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/fcc7c5bc6c4e7e7812ab88f804da0a44e80a4fce", "committedDate": "2020-10-22T13:43:44Z", "message": "Create QuestMetricsDb component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe20011cf8d5c534eadc79cb5695915fbd9849d7", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/fe20011cf8d5c534eadc79cb5695915fbd9849d7", "committedDate": "2020-10-22T13:47:27Z", "message": "Remove printlns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODU5MDQ5", "url": "https://github.com/vespa-engine/vespa/pull/15013#pullrequestreview-514859049", "createdAt": "2020-10-22T15:33:24Z", "commit": {"oid": "fe20011cf8d5c534eadc79cb5695915fbd9849d7"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTozMzoyNFrOHmnuYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjoyMzo0NVrOHmp9Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1ODc4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // TODO: Remove after November 2020", "url": "https://github.com/vespa-engine/vespa/pull/15013#discussion_r510258786", "createdAt": "2020-10-22T15:33:24Z", "author": {"login": "freva"}, "path": "config-provisioning/src/main/java/com/yahoo/config/provision/Provisioner.java", "diffHunk": "@@ -58,8 +62,13 @@\n      * @param transaction Transaction with operations to commit together with any operations done within the provisioner.\n      * @param lock        A provision lock for the relevant application. This must be held when calling this.\n      */\n+    // TODO: Remove after November 2020\n     void remove(NestedTransaction transaction, ProvisionLock lock);\n \n+    /** Transactionally remove an application under lock. */\n+    // TODO: Remove after November 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe20011cf8d5c534eadc79cb5695915fbd9849d7"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5NDIxMQ==", "bodyText": "Read this once from ZK?", "url": "https://github.com/vespa-engine/vespa/pull/15013#discussion_r510294211", "createdAt": "2020-10-22T16:22:06Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/Activator.java", "diffHunk": "@@ -53,41 +57,69 @@ public void activate(Collection<HostSpec> hosts, NestedTransaction transaction,\n      * Post condition: Nodes in reserved which are present in <code>hosts</code> are moved to active.\n      * Nodes in active which are not present in <code>hosts</code> are moved to inactive.\n      *\n-     * @param transaction Transaction with operations to commit together with any operations done within the repository.\n      * @param hosts the hosts to make the set of active nodes of this\n-     * @param lock provision lock that must be held when calling this\n+     * @param generation the application config generation that is activated\n+     * @param transaction transaction with operations to commit together with any operations done within the repository,\n+     *                    while holding the node repository lock on this application\n      */\n-    private void activateNodes(Collection<HostSpec> hosts, NestedTransaction transaction, ProvisionLock lock) {\n-        ApplicationId application = lock.application();\n+    private void activateNodes(Collection<HostSpec> hosts, long generation, ApplicationTransaction transaction) {\n+        ApplicationId application = transaction.application();\n         Set<String> hostnames = hosts.stream().map(HostSpec::hostname).collect(Collectors.toSet());\n         NodeList allNodes = nodeRepository.list();\n         NodeList applicationNodes = allNodes.owner(application);\n \n         List<Node> reserved = applicationNodes.state(Node.State.reserved).asList();\n-        List<Node> reservedToActivate = retainHostsInList(hostnames, reserved);\n-        List<Node> active = applicationNodes.state(Node.State.active).asList();\n-        List<Node> continuedActive = retainHostsInList(hostnames, active);\n-        List<Node> allActive = new ArrayList<>(continuedActive);\n-        allActive.addAll(reservedToActivate);\n-        if (!containsAll(hostnames, allActive))\n+        List<Node> reservedToActivate = updatePortsFrom(hosts, retainHostsInList(hostnames, reserved));\n+        List<Node> oldActive = applicationNodes.state(Node.State.active).asList(); // All nodes active now\n+        List<Node> continuedActive = retainHostsInList(hostnames, oldActive);\n+        List<Node> newActive = updateFrom(hosts, continuedActive); // All nodes that will be active when this is committed\n+        newActive.addAll(reservedToActivate);\n+        if ( ! containsAll(hostnames, newActive))\n             throw new IllegalArgumentException(\"Activation of \" + application + \" failed. \" +\n                                                \"Could not find all requested hosts.\" +\n                                                \"\\nRequested: \" + hosts +\n                                                \"\\nReserved: \" + toHostNames(reserved) +\n-                                               \"\\nActive: \" + toHostNames(active) +\n+                                               \"\\nActive: \" + toHostNames(oldActive) +\n                                                \"\\nThis might happen if the time from reserving host to activation takes \" +\n                                                \"longer time than reservation expiry (the hosts will then no longer be reserved)\");\n \n         validateParentHosts(application, allNodes, reservedToActivate);\n \n-        List<Node> activeToRemove = removeHostsFromList(hostnames, active);\n-        activeToRemove = activeToRemove.stream().map(Node::unretire).collect(Collectors.toList()); // only active nodes can be retired\n-        nodeRepository.deactivate(activeToRemove, transaction, lock);\n-        nodeRepository.activate(updateFrom(hosts, continuedActive), transaction); // update active with any changes\n-        nodeRepository.activate(updatePortsFrom(hosts, reservedToActivate), transaction);\n+        List<Node> activeToRemove = removeHostsFromList(hostnames, oldActive);\n+        activeToRemove = activeToRemove.stream().map(Node::unretire).collect(Collectors.toList()); // only active nodes can be retired. TODO: Move this line to deactivate\n+        nodeRepository.deactivate(activeToRemove, transaction);\n+        nodeRepository.activate(newActive, transaction.nested()); // activate also continued active to update node state\n+\n+        rememberResourceChange(transaction, generation,\n+                               NodeList.copyOf(oldActive).not().retired(),\n+                               NodeList.copyOf(newActive).not().retired());\n         unreserveParentsOf(reservedToActivate);\n     }\n \n+    private void rememberResourceChange(ApplicationTransaction transaction, long generation,\n+                                        NodeList oldNodes, NodeList newNodes) {\n+        if (nodeRepository.applications().get(transaction.application()).isEmpty()) return; // infrastructure app, hopefully\n+        Application application = nodeRepository.applications().get(transaction.application()).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe20011cf8d5c534eadc79cb5695915fbd9849d7"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5NTMwMg==", "bodyText": "Shouldn't there be a map to to group id here?", "url": "https://github.com/vespa-engine/vespa/pull/15013#discussion_r510295302", "createdAt": "2020-10-22T16:23:45Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/NodeList.java", "diffHunk": "@@ -179,6 +180,13 @@ public NodeList group(int index) {\n                                                        .findFirst());\n     }\n \n+    public ClusterResources toResources() {\n+        if (isEmpty()) return new ClusterResources(0, 0, NodeResources.unspecified());\n+        return new ClusterResources(size(),\n+                                    (int)stream().distinct().count(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe20011cf8d5c534eadc79cb5695915fbd9849d7"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5df91f8833a342d4dda193e0d7c16b82a4407d87", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/5df91f8833a342d4dda193e0d7c16b82a4407d87", "committedDate": "2020-10-22T16:53:09Z", "message": "Update config-provisioning/src/main/java/com/yahoo/config/provision/Provisioner.java\n\nCo-authored-by: Valerij Fredriksen <freva@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78aa299fce0a04444fd34ee9dd438b01e18759d0", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/78aa299fce0a04444fd34ee9dd438b01e18759d0", "committedDate": "2020-10-22T16:58:44Z", "message": "Actually count groups not nodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30850e3233a5a1999e25d86d63acf5e8083a4c69", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/30850e3233a5a1999e25d86d63acf5e8083a4c69", "committedDate": "2020-10-22T16:59:26Z", "message": "Merge branch 'bratseth/persist-metrics-rebased' of github.com:vespa-engine/vespa into bratseth/persist-metrics-rebased"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f1e7d3d32e43f2ef5c23df482e5d3d9c197ea0e", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/5f1e7d3d32e43f2ef5c23df482e5d3d9c197ea0e", "committedDate": "2020-10-22T17:05:54Z", "message": "Read application once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cd60412954bec3717d2b0306622df36ecd3d770", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/2cd60412954bec3717d2b0306622df36ecd3d770", "committedDate": "2020-10-22T17:11:37Z", "message": "Expect spaces in Pair toString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e15b70befdefd622b6682aa93f2d2f51b3675460", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/e15b70befdefd622b6682aa93f2d2f51b3675460", "committedDate": "2020-10-22T21:27:48Z", "message": "Follow API change"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2330, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}