{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MzU1NTcy", "number": 14452, "title": "Add switch field to nodes API", "bodyText": "This changes node allocation to prefer nodes on network switches distinct within\na cluster. We do this to avoid allocating multiple nodes in the same cluster on\nthe same top-of-rack switch, thereby reducing the impact of an entire rack\ndying.\nBehaviour:\n\nDeployment prefers nodes on exclusive switches.\nDeployment reuses switches instead of failing if exclusive allocation isn't\npossible.\nNode lacking switch information are exclusive by default to avoid unnecessary\nreallocation. This is currently the case for all nodes as none have switch\ninformation yet.\n\nMerge together with internal PR.\n@bratseth", "createdAt": "2020-09-18T14:32:44Z", "url": "https://github.com/vespa-engine/vespa/pull/14452", "merged": true, "mergeCommit": {"oid": "8cae83209c036e5d3bac4ef5aca05a78666c0111"}, "closed": true, "closedAt": "2020-09-22T12:26:26Z", "author": {"login": "mpolden"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKGVYqAH2gAyNDg5MzU1NTcyOjlkYjZjMDlhNjI4MjJhZTFhM2U3YjZiYWQ3MGVkMjE0ZTQ0MmMxYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLWXhEAFqTQ5MzM2NjMxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9db6c09a62822ae1a3e7b6bad70ed214e442c1c6", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/9db6c09a62822ae1a3e7b6bad70ed214e442c1c6", "committedDate": "2020-09-18T14:19:16Z", "message": "Make PrioritizableNode immutable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65d3b3c3d953e5b97785e7e0452525eb7888f74c", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/65d3b3c3d953e5b97785e7e0452525eb7888f74c", "committedDate": "2020-09-18T14:19:16Z", "message": "Rename PrioritizableNode -> NodeCandidate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cca8ef0d7b033475d2e32b211f136dbdeb8fee11", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/cca8ef0d7b033475d2e32b211f136dbdeb8fee11", "committedDate": "2020-09-18T14:19:16Z", "message": "Rename method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa4c83ad92e876dd7c4ef7898fdeb4082feefcdd", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/aa4c83ad92e876dd7c4ef7898fdeb4082feefcdd", "committedDate": "2020-09-18T14:19:16Z", "message": "Decide whether node candidate is on a exclusive switch"}, "afterCommit": {"oid": "60e0078206bc4719bed8810de01719d65496fa09", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/60e0078206bc4719bed8810de01719d65496fa09", "committedDate": "2020-09-19T13:04:33Z", "message": "Decide whether node candidate is on a exclusive switch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60e0078206bc4719bed8810de01719d65496fa09", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/60e0078206bc4719bed8810de01719d65496fa09", "committedDate": "2020-09-19T13:04:33Z", "message": "Decide whether node candidate is on a exclusive switch"}, "afterCommit": {"oid": "fc658645ea33707c9bb5a631e41dc338260fe72f", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/fc658645ea33707c9bb5a631e41dc338260fe72f", "committedDate": "2020-09-19T16:11:04Z", "message": "Decide whether node candidate is on a exclusive switch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMTgyMDU1", "url": "https://github.com/vespa-engine/vespa/pull/14452#pullrequestreview-492182055", "createdAt": "2020-09-20T08:58:21Z", "commit": {"oid": "dc5ad821dcb6a96d5a5229d76d5975edefddd841"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQwODo1ODoyMVrOHU5K1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQwODo1ODoyMVrOHU5K1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY3MDIyOQ==", "bodyText": "I think this should be after the active node preference?", "url": "https://github.com/vespa-engine/vespa/pull/14452#discussion_r491670229", "createdAt": "2020-09-20T08:58:21Z", "author": {"login": "bratseth"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeCandidate.java", "diffHunk": "@@ -57,14 +62,18 @@\n     /**\n      * Compare this candidate to another\n      *\n-     * @return negative if first priority is higher than second node\n+     * @return negative if this should be preferred over other\n      */\n     @Override\n     public int compareTo(NodeCandidate other) {\n         // First always pick nodes without violation above nodes with violations\n         if (!this.violatesSpares && other.violatesSpares) return -1;\n         if (!other.violatesSpares && this.violatesSpares) return 1;\n \n+        // Prefer node on exclusive switch", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc5ad821dcb6a96d5a5229d76d5975edefddd841"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "655690784b67f9d7e547d068d3386900df9283ac", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/655690784b67f9d7e547d068d3386900df9283ac", "committedDate": "2020-09-22T11:30:33Z", "message": "Add switch hostname to node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48b32b454f9c72029dee804ce76aa4ff66ef09a4", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/48b32b454f9c72029dee804ce76aa4ff66ef09a4", "committedDate": "2020-09-22T11:30:33Z", "message": "Add switch hostname to REST API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14c1f947b2906e8cfa38d98ec48ea44bf5fe9e22", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/14c1f947b2906e8cfa38d98ec48ea44bf5fe9e22", "committedDate": "2020-09-22T11:30:33Z", "message": "Unify node patch methods in tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc658645ea33707c9bb5a631e41dc338260fe72f", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/fc658645ea33707c9bb5a631e41dc338260fe72f", "committedDate": "2020-09-19T16:11:04Z", "message": "Decide whether node candidate is on a exclusive switch"}, "afterCommit": {"oid": "14c1f947b2906e8cfa38d98ec48ea44bf5fe9e22", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/14c1f947b2906e8cfa38d98ec48ea44bf5fe9e22", "committedDate": "2020-09-22T11:30:33Z", "message": "Unify node patch methods in tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzY2MzEw", "url": "https://github.com/vespa-engine/vespa/pull/14452#pullrequestreview-493366310", "createdAt": "2020-09-22T11:34:00Z", "commit": {"oid": "14c1f947b2906e8cfa38d98ec48ea44bf5fe9e22"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4257, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}