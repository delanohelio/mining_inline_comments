{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNDIyMTQy", "number": 12671, "title": "Arnej/configurable distance metrics", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@geirst please review\n@havardpe FYI", "createdAt": "2020-03-23T14:31:49Z", "url": "https://github.com/vespa-engine/vespa/pull/12671", "merged": true, "mergeCommit": {"oid": "364927b41f21970a92dc72db82bcce81711f87a8"}, "closed": true, "closedAt": "2020-03-24T15:20:59Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQfNavgH2gAyMzkyNDIyMTQyOmIxMzI0YWZhYTRjYjY4NDg2MmRlYmZiOTdhNDkyNzUwOTYwY2QwY2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQz_OKgH2gAyMzkyNDIyMTQyOjdkMTAyNTU0ZjM2MDYyMTIzM2QzN2I0ZmNkOTgyMmViMjU0MjUzNmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b1324afaa4cb684862debfb97a492750960cd0cf", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/b1324afaa4cb684862debfb97a492750960cd0cf", "committedDate": "2020-03-23T14:30:35Z", "message": "make HNSW distance metric configurable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dabdfd757930a7bb06035c718fce456326cf6f63", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/dabdfd757930a7bb06035c718fce456326cf6f63", "committedDate": "2020-03-23T14:30:35Z", "message": "add enum for selecting distance metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49492f5698d52b87ee0ac98cf32d991246876125", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/49492f5698d52b87ee0ac98cf32d991246876125", "committedDate": "2020-03-23T14:30:35Z", "message": "more distance functions\n\n* extend DistanceFunction API\n* add Angular metric\n* add GeoDegrees metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4867cc43efc6d92e5ff9db2924cb38280ebe7037", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/4867cc43efc6d92e5ff9db2924cb38280ebe7037", "committedDate": "2020-03-23T14:30:35Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2bef82b64c8ddd707fa58d394eb325aac1812fb", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/b2bef82b64c8ddd707fa58d394eb325aac1812fb", "committedDate": "2020-03-23T14:30:35Z", "message": "split out DistanceFunction factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc6403cca1829df74abc0707f12023fc4857ba26", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/fc6403cca1829df74abc0707f12023fc4857ba26", "committedDate": "2020-03-23T14:30:35Z", "message": "add distance metric to HnswIndexParams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9be49315bc1fe7efa35eea5a244c2ce85c03c701", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/9be49315bc1fe7efa35eea5a244c2ce85c03c701", "committedDate": "2020-03-23T14:30:35Z", "message": "extend API with distance_function access"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3967677db35ec4d9805c5a410a2a083472fb6dd1", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/3967677db35ec4d9805c5a410a2a083472fb6dd1", "committedDate": "2020-03-23T14:30:35Z", "message": "track API changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63368ac60b322be2830868bd76570184c39938ed", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/63368ac60b322be2830868bd76570184c39938ed", "committedDate": "2020-03-23T14:30:35Z", "message": "use external factory for distance function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d3fdf021dab6ab47736feea0cd439e79360acbf", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/1d3fdf021dab6ab47736feea0cd439e79360acbf", "committedDate": "2020-03-23T14:30:36Z", "message": "use distance function from index if available\n\n* convert query tensor to same cell type as attribute\n* use DistanceFunction to calculate abstract distances for NNS\n* use DistanceFunction to convert abstract distances to rawscore\n* if no index is available, use a fallback DistanceFunction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e17e57db3435ccd8d5705b3bdd062ce337ff137", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/6e17e57db3435ccd8d5705b3bdd062ce337ff137", "committedDate": "2020-03-23T14:30:36Z", "message": "check that query tensor is converted correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19c5bbc4a4babe52c0948a9c4c3bc5f6c1da7b85", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/19c5bbc4a4babe52c0948a9c4c3bc5f6c1da7b85", "committedDate": "2020-03-23T14:30:36Z", "message": "track API changes\n\n* also, NNS iterators no longer handles different cell types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45af929151818ec383951d3d8b5018f690df85df", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/45af929151818ec383951d3d8b5018f690df85df", "committedDate": "2020-03-23T14:30:36Z", "message": "simplify iterator\n\n* now distance function handles cell type, so\n  iterator does not need to be templated on that."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7d16718d08131e60badb1ab35521226f4ebed9", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/cb7d16718d08131e60badb1ab35521226f4ebed9", "committedDate": "2020-03-24T07:52:20Z", "message": "output distance in meters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDg2MTc2", "url": "https://github.com/vespa-engine/vespa/pull/12671#pullrequestreview-380086176", "createdAt": "2020-03-24T08:26:26Z", "commit": {"oid": "49492f5698d52b87ee0ac98cf32d991246876125"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODoyNjoyNlrOF6lXSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODo0OToyNFrOF6mIUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3Mzg5Ng==", "bodyText": "Would be nice with a pointer to an article / wiki that describes that math behind.", "url": "https://github.com/vespa-engine/vespa/pull/12671#discussion_r396973896", "createdAt": "2020-03-24T08:26:26Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/tensor/distance_functions.h", "diffHunk": "@@ -25,10 +26,111 @@ class SquaredEuclideanDistance : public DistanceFunction {\n         assert(sz == rhs_vector.size());\n         return _computer.squaredEuclideanDistance(&lhs_vector[0], &rhs_vector[0], sz);\n     }\n+    double to_rawscore(double distance) const override {\n+        double d = sqrt(distance);\n+        double score = 1.0 / (1.0 + d);\n+        return score;\n+    }\n+    double calc_with_limit(const vespalib::tensor::TypedCells& lhs,\n+                           const vespalib::tensor::TypedCells& rhs,\n+                           double limit) const override\n+    {\n+        auto lhs_vector = lhs.typify<FloatType>();\n+        auto rhs_vector = rhs.typify<FloatType>();\n+        double sum = 0.0;\n+        size_t sz = lhs_vector.size();\n+        assert(sz == rhs_vector.size());\n+        for (size_t i = 0; i < sz && sum <= limit; ++i) {\n+            double diff = lhs_vector[i] - rhs_vector[i];\n+            sum += diff*diff;\n+        }\n+        return sum;\n+    }\n+\n     const vespalib::hwaccelrated::IAccelrated & _computer;\n };\n \n template class SquaredEuclideanDistance<float>;\n template class SquaredEuclideanDistance<double>;\n \n+/**\n+ * Calculates angular distance between vectors with assumed norm 1.\n+ */\n+template <typename FloatType>\n+class AngularDistance : public DistanceFunction {\n+public:\n+    AngularDistance()\n+        : _computer(vespalib::hwaccelrated::IAccelrated::getAccelrator())\n+    {}\n+    double calc(const vespalib::tensor::TypedCells& lhs, const vespalib::tensor::TypedCells& rhs) const override {\n+        auto lhs_vector = lhs.typify<FloatType>();\n+        auto rhs_vector = rhs.typify<FloatType>();\n+        size_t sz = lhs_vector.size();\n+        assert(sz == rhs_vector.size());\n+        return 1.0 - _computer.dotProduct(&lhs_vector[0], &rhs_vector[0], sz);\n+    }\n+    double to_rawscore(double distance) const override {\n+        double score = 1.0 / (1.0 + distance);\n+        return score;\n+    }\n+    double calc_with_limit(const vespalib::tensor::TypedCells& lhs,\n+                           const vespalib::tensor::TypedCells& rhs,\n+                           double /*limit*/) const override\n+    {\n+        return calc(lhs, rhs);\n+    }\n+\n+    const vespalib::hwaccelrated::IAccelrated & _computer;\n+};\n+\n+template class AngularDistance<float>;\n+template class AngularDistance<double>;\n+\n+/**\n+ * Calculates great-circle distance between Latitude/Longitude pairs,\n+ * measured in degrees", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49492f5698d52b87ee0ac98cf32d991246876125"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NDI0MQ==", "bodyText": "Please add copyright.", "url": "https://github.com/vespa-engine/vespa/pull/12671#discussion_r396974241", "createdAt": "2020-03-24T08:27:07Z", "author": {"login": "geirst"}, "path": "config-model/src/test/java/com/yahoo/searchdefinition/document/HnswIndexParamsTestCase.java", "diffHunk": "@@ -0,0 +1,53 @@\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4867cc43efc6d92e5ff9db2924cb38280ebe7037"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NTM3OA==", "bodyText": "Consider adding function description.", "url": "https://github.com/vespa-engine/vespa/pull/12671#discussion_r396975378", "createdAt": "2020-03-24T08:29:08Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/tensor/distance_function_factory.h", "diffHunk": "@@ -0,0 +1,15 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"distance_function.h\"\n+#include <vespa/eval/eval/value_type.h>\n+#include <vespa/searchcommon/attribute/distance_metric.h>\n+\n+namespace search::tensor {\n+\n+DistanceFunction::UP", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2bef82b64c8ddd707fa58d394eb325aac1812fb"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3ODIwNw==", "bodyText": "Please extend AttributeManagerTest::testConfigConvert() unit test as well (searchlib/src/tests/attribute/attributemanager/attributemanager_test.cpp).", "url": "https://github.com/vespa-engine/vespa/pull/12671#discussion_r396978207", "createdAt": "2020-03-24T08:34:20Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/attribute/configconverter.cpp", "diffHunk": "@@ -74,8 +74,22 @@ ConfigConverter::convert(const AttributesConfig::Attribute & cfg)\n     predicateParams.setDensePostingListThreshold(cfg.densepostinglistthreshold);\n     retval.setPredicateParams(predicateParams);\n     if (cfg.index.hnsw.enabled) {\n+        using CfgDm = AttributesConfig::Attribute::Index::Hnsw::Distancemetric;\n+        DistanceMetric dm;\n+        switch (cfg.index.hnsw.distancemetric) {\n+        case CfgDm::EUCLIDEAN:\n+            dm = DistanceMetric::Euclidean;\n+            break;\n+        case CfgDm::ANGULAR:\n+            dm = DistanceMetric::Angular;\n+            break;\n+        case CfgDm::GEODEGREES:\n+            dm = DistanceMetric::GeoDegrees;\n+            break;\n+        }\n         retval.set_hnsw_index_params(HnswIndexParams(cfg.index.hnsw.maxlinkspernode,\n-                                                     cfg.index.hnsw.neighborstoexploreatinsert));\n+                                                     cfg.index.hnsw.neighborstoexploreatinsert,\n+                                                     dm));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6403cca1829df74abc0707f12023fc4857ba26"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4NTA4Nw==", "bodyText": "I guess the pointer should be const as well? All functions on DistanceFunction API is const, so it's better to be consistent.", "url": "https://github.com/vespa-engine/vespa/pull/12671#discussion_r396985087", "createdAt": "2020-03-24T08:47:08Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/tensor/nearest_neighbor_index.h", "diffHunk": "@@ -35,6 +36,7 @@ class NearestNeighborIndex {\n                                              vespalib::tensor::TypedCells vector,\n                                              uint32_t explore_k) const = 0;\n \n+    virtual DistanceFunction *distance_function() const = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be49315bc1fe7efa35eea5a244c2ce85c03c701"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4NjQ0OA==", "bodyText": "Consider using auto.", "url": "https://github.com/vespa-engine/vespa/pull/12671#discussion_r396986448", "createdAt": "2020-03-24T08:49:24Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/queryeval/nearest_neighbor_blueprint.cpp", "diffHunk": "@@ -6,10 +6,47 @@\n #include \"nns_index_iterator.h\"\n #include <vespa/searchlib/fef/termfieldmatchdataarray.h>\n #include <vespa/eval/tensor/dense/dense_tensor_view.h>\n+#include <vespa/eval/tensor/dense/dense_tensor.h>\n #include <vespa/searchlib/tensor/dense_tensor_attribute.h>\n+#include <vespa/searchlib/tensor/distance_function_factory.h>\n+\n+using vespalib::tensor::DenseTensorView;\n+using vespalib::tensor::DenseTensor;\n \n namespace search::queryeval {\n \n+namespace {\n+\n+template<typename LCT, typename RCT>\n+void\n+convert_cells(std::unique_ptr<DenseTensorView> &original, vespalib::eval::ValueType want_type)\n+{\n+    auto old_cells = original->cellsRef().typify<LCT>();\n+    std::vector<RCT> new_cells;\n+    new_cells.reserve(old_cells.size());\n+    for (LCT value : old_cells) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3fdf021dab6ab47736feea0cd439e79360acbf"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7038869d09bd49ac1f75a148260c73af287cea91", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/7038869d09bd49ac1f75a148260c73af287cea91", "committedDate": "2020-03-24T12:06:12Z", "message": "unit test distance functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2fa9a9059bc5570b70a687d31cbd160ed28f8cc", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/f2fa9a9059bc5570b70a687d31cbd160ed28f8cc", "committedDate": "2020-03-24T12:06:36Z", "message": "remove debug printing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ca2401c18a7f3a6860c85ac133493867847f791", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/2ca2401c18a7f3a6860c85ac133493867847f791", "committedDate": "2020-03-24T12:07:34Z", "message": "add copyright"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e725e88b10d424ff5f96ba702124033fdc86733", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/6e725e88b10d424ff5f96ba702124033fdc86733", "committedDate": "2020-03-24T12:21:13Z", "message": "add reference and refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cc83640d058ef6e905093c7eafdeffc3647dc07", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/5cc83640d058ef6e905093c7eafdeffc3647dc07", "committedDate": "2020-03-24T12:24:39Z", "message": "constify DistanceFunction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eff4e99de2506232afab12f1f984ba88958506d2", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/eff4e99de2506232afab12f1f984ba88958506d2", "committedDate": "2020-03-24T12:27:32Z", "message": "add documentation comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45c2c45102f06b5911e390306d3d0c54fff8f67a", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/45c2c45102f06b5911e390306d3d0c54fff8f67a", "committedDate": "2020-03-24T12:36:27Z", "message": "extend unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMzYzODIx", "url": "https://github.com/vespa-engine/vespa/pull/12671#pullrequestreview-380363821", "createdAt": "2020-03-24T14:28:18Z", "commit": {"oid": "7038869d09bd49ac1f75a148260c73af287cea91"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNDoyODoxOVrOF6y3ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNDoyODoyOVrOF6y35A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE5NTExNA==", "bodyText": "Please update copyright.", "url": "https://github.com/vespa-engine/vespa/pull/12671#discussion_r397195114", "createdAt": "2020-03-24T14:28:19Z", "author": {"login": "geirst"}, "path": "searchlib/src/tests/tensor/distance_functions/CMakeLists.txt", "diffHunk": "@@ -0,0 +1,9 @@\n+# Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7038869d09bd49ac1f75a148260c73af287cea91"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE5NTIzNg==", "bodyText": "Please update copyright.", "url": "https://github.com/vespa-engine/vespa/pull/12671#discussion_r397195236", "createdAt": "2020-03-24T14:28:29Z", "author": {"login": "geirst"}, "path": "searchlib/src/tests/tensor/distance_functions/distance_functions_test.cpp", "diffHunk": "@@ -0,0 +1,196 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7038869d09bd49ac1f75a148260c73af287cea91"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d102554f360621233d37b4fcd9822eb2542536e", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/7d102554f360621233d37b4fcd9822eb2542536e", "committedDate": "2020-03-24T14:43:05Z", "message": "update copyright headers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2612, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}