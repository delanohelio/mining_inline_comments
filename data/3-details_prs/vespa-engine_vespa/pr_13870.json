{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MTIzNjY4", "number": 13870, "title": "Shutdown state server and metric manager before service layer", "bodyText": "@geirst @toregge please review. I believe this is the most likely reason for a core observed during shutdown on an internal test (I could not get access to the actual core file itself).\nAvoids a very small race condition window where metric update hooks\nmay point into the service layer components even after they have\nbeen destroyed, as these are not explicitly unregistered today.\nAnother option would be to add unregistering on component destruction,\nbut that adds another race condition where an external client may\nobserve partial metric existence during this time window. By shutting\ndown the metric exporting interfaces first, we should avoid this.\nSide note: automatic metric hook unregistering should be added at some point\nanyway since they after this change cannot cause partial metric existence.", "createdAt": "2020-07-13T09:17:35Z", "url": "https://github.com/vespa-engine/vespa/pull/13870", "merged": true, "mergeCommit": {"oid": "59332ffc463715515f6e15d87834f0646e461ab9"}, "closed": true, "closedAt": "2020-07-15T08:58:04Z", "author": {"login": "vekterli"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0drb1AH2gAyNDQ4MTIzNjY4OmNjYzU5ZmI3NTk4ZWU3MTRkMDExOWU3ZThkZTM5Njk5ZTQ2NzYwM2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1GuGRgFqTQ0ODc1NzA2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/ccc59fb7598ee714d0119e7e8de39699e467603c", "committedDate": "2020-07-13T09:04:50Z", "message": "Shutdown state server and metric manager before service layer\n\nAvoids a very small race condition window where metric update hooks\nmay point into the service layer components even after they have\nbeen destroyed, as these are not explicitly unregistered today.\n\nAnother option would be to add unregistering on component destruction,\nbut that adds another race condition where an external client may\nobserve partial metric existence during this time window. By shutting\ndown the metric exporting interfaces first, we should avoid this."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MTU4Mzk4", "url": "https://github.com/vespa-engine/vespa/pull/13870#pullrequestreview-447158398", "createdAt": "2020-07-13T11:16:46Z", "commit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MTY3NDgy", "url": "https://github.com/vespa-engine/vespa/pull/13870#pullrequestreview-447167482", "createdAt": "2020-07-13T11:31:47Z", "commit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozMTo0OFrOGwkn2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozNDo0OVrOGwktog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng==", "bodyText": "We need to reset _customComponentRootToken and _customComponentBindToken first, as these have reference to a JsonHandlerRepo owned by the StateServer, and will access this when destructed.", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453584856", "createdAt": "2020-07-13T11:31:48Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/server/proton.cpp", "diffHunk": "@@ -462,6 +462,15 @@ Proton::~Proton()\n     LOG(debug, \"Explicit destructor done\");\n }\n \n+void\n+Proton::perform_pre_service_layer_shutdown_steps()\n+{\n+    _stateServer.reset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NjMzOA==", "bodyText": "In Proton::~Proton() we do _executor.sync(); before any of this. I am not sure if we need something similar here. @toregge can you comment on that?", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453586338", "createdAt": "2020-07-13T11:34:49Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/server/proton.cpp", "diffHunk": "@@ -462,6 +462,15 @@ Proton::~Proton()\n     LOG(debug, \"Explicit destructor done\");\n }\n \n+void\n+Proton::perform_pre_service_layer_shutdown_steps()\n+{\n+    _stateServer.reset();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng=="}, "originalCommit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6baa1e6579ea6b9e21e2d10eb0e25368e6b594ed", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/6baa1e6579ea6b9e21e2d10eb0e25368e6b594ed", "committedDate": "2020-07-13T12:49:29Z", "message": "Close config and reset component tokens prior to state server shutdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MjY1MzQ5", "url": "https://github.com/vespa-engine/vespa/pull/13870#pullrequestreview-447265349", "createdAt": "2020-07-13T13:46:11Z", "commit": {"oid": "6baa1e6579ea6b9e21e2d10eb0e25368e6b594ed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzU3MDYw", "url": "https://github.com/vespa-engine/vespa/pull/13870#pullrequestreview-448757060", "createdAt": "2020-07-15T08:53:51Z", "commit": {"oid": "6baa1e6579ea6b9e21e2d10eb0e25368e6b594ed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3446, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}