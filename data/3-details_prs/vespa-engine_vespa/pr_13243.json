{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3Mzk0OTc3", "number": 13243, "title": "Provision application roles  ", "bodyText": "", "createdAt": "2020-05-13T14:18:17Z", "url": "https://github.com/vespa-engine/vespa/pull/13243", "merged": true, "mergeCommit": {"oid": "0270bb41a17f9d761db44520245ef54c9af77425"}, "closed": true, "closedAt": "2020-05-18T12:15:17Z", "author": {"login": "tokle"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchITETgFqTQxMTUyODU5Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcie1mIAFqTQxMzUzNTY0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNTI4NTkz", "url": "https://github.com/vespa-engine/vespa/pull/13243#pullrequestreview-411528593", "createdAt": "2020-05-14T07:22:34Z", "commit": {"oid": "30609118ff8644aa68c443ddae8e09202abdc846"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzoyMjozNFrOGVPNJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzoyMjozNFrOGVPNJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkyMjQwNA==", "bodyText": "We should make deployment fail on failed role creation.", "url": "https://github.com/vespa-engine/vespa/pull/13243#discussion_r424922404", "createdAt": "2020-05-14T07:22:34Z", "author": {"login": "oyving"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/ApplicationController.java", "diffHunk": "@@ -328,10 +333,19 @@ public ActivateResult deploy2(JobId job, boolean deploySourceVersions) { // TODO\n                 endpointCertificateMetadata = endpointCertificateManager.getEndpointCertificateMetadata(instance, zone);\n \n                 endpoints = controller.routing().registerEndpointsInDns(application.get(), job.application().instance(), zone);\n+\n+                // Provision application roles if enabled for the zone\n+                if (provisionApplicationRoles.with(FetchVector.Dimension.ZONE_ID, zone.value()).value()) {\n+                    try {\n+                        applicationRoles = controller.serviceRegistry().applicationRoleService().createApplicationRoles(instance.id());\n+                    } catch (Exception e) {\n+                        log.log(Level.SEVERE, \"Exception creating application roles for application: \" + instance.id(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30609118ff8644aa68c443ddae8e09202abdc846"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfa23cab41d83b7c21a34d199e747fe8e5747ea3", "author": {"user": {"login": "tokle", "name": "Morten Tokle"}}, "url": "https://github.com/vespa-engine/vespa/commit/dfa23cab41d83b7c21a34d199e747fe8e5747ea3", "committedDate": "2020-05-18T08:29:28Z", "message": "Create application iam role service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efd71d02a2d65c12022b62011ace1ceca7f6ef8a", "author": {"user": {"login": "tokle", "name": "Morten Tokle"}}, "url": "https://github.com/vespa-engine/vespa/commit/efd71d02a2d65c12022b62011ace1ceca7f6ef8a", "committedDate": "2020-05-18T08:29:28Z", "message": "Provision application roles and include in cfg deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31adb5d8888abe44fba6a4b51aab1a97248b877f", "author": {"user": {"login": "tokle", "name": "Morten Tokle"}}, "url": "https://github.com/vespa-engine/vespa/commit/31adb5d8888abe44fba6a4b51aab1a97248b877f", "committedDate": "2020-05-18T09:45:51Z", "message": "Fail deployment when role creating fails"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30609118ff8644aa68c443ddae8e09202abdc846", "author": {"user": {"login": "tokle", "name": "Morten Tokle"}}, "url": "https://github.com/vespa-engine/vespa/commit/30609118ff8644aa68c443ddae8e09202abdc846", "committedDate": "2020-05-13T14:16:43Z", "message": "Provision application roles and include in cfg deployment"}, "afterCommit": {"oid": "31adb5d8888abe44fba6a4b51aab1a97248b877f", "author": {"user": {"login": "tokle", "name": "Morten Tokle"}}, "url": "https://github.com/vespa-engine/vespa/commit/31adb5d8888abe44fba6a4b51aab1a97248b877f", "committedDate": "2020-05-18T09:45:51Z", "message": "Fail deployment when role creating fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNTM1NjQy", "url": "https://github.com/vespa-engine/vespa/pull/13243#pullrequestreview-413535642", "createdAt": "2020-05-18T12:15:12Z", "commit": {"oid": "31adb5d8888abe44fba6a4b51aab1a97248b877f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3252, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}