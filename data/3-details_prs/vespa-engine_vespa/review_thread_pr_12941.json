{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MjA0NDY4", "number": 12941, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTowMDoyOFrODyaD0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTowOToxNlrODyaRBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MTgyMzU0OnYy", "diffSide": "RIGHT", "path": "node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandlerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTowMDoyOFrOGGbjcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTowMDoyOFrOGGbjcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5NjA4Mg==", "bodyText": "I'd recommend using UnixPath in the test methods to easily create parent directories and/or files you need, the before method should only create directories are guaranteed to always exist, otherwise the tests might not catch that a certain directory is not created as expected.", "url": "https://github.com/vespa-engine/vespa/pull/12941#discussion_r409396082", "createdAt": "2020-04-16T09:00:28Z", "author": {"login": "freva"}, "path": "node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandlerTest.java", "diffHunk": "@@ -206,13 +209,28 @@ public void process_single_coredump_test() throws IOException {\n         verify(coreCollector, never()).collect(any(), any());\n         verify(coredumpReporter, times(1)).reportCoredump(eq(\"id-123\"), eq(\"metadata\"));\n         assertFalse(Files.exists(coredumpDirectory));\n-        assertFolderContents(doneCoredumpsPath, \"id-123\");\n-        assertFolderContents(doneCoredumpsPath.resolve(\"id-123\"), \"metadata.json\", \"dump_bash.core.431.lz4\");\n+        assertFolderContents(doneCoredumpsPath.resolve(\"container-123\"), \"id-123\");\n+        assertFolderContents(doneCoredumpsPath.resolve(\"container-123\").resolve(\"id-123\"), \"metadata.json\", \"dump_bash.core.431.lz4\");\n+    }\n+\n+    @Test\n+    public void report_enqueued_and_processed_metrics() throws IOException {\n+        Files.createFile(crashPathInContainer.resolve(\"dump-1\"));\n+        Files.createFile(crashPathInContainer.resolve(\"dump-2\"));\n+        Files.createFile(doneCoredumpsPath.resolve(\"container-123\").resolve(\"dump-3\"));\n+\n+        coredumpHandler.updateMetrics(context, crashPathInContainer);\n+        List<DimensionMetrics> updatedMetrics = metrics.getMetricsByType(Metrics.DimensionType.PRETAGGED);\n+        assertEquals(1, updatedMetrics.size());\n+        Map<String, Number> values = updatedMetrics.get(0).getMetrics();\n+        assertEquals(2, values.get(\"coredumps.enqueued\").intValue());\n+        assertEquals(1, values.get(\"coredumps.processed\").intValue());\n     }\n \n     @Before\n     public void setup() throws IOException {\n-        Files.createDirectories(donePath);\n+        Files.createDirectories(donePath.resolve(\"container-123\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bebe88526e449bbca0514d8bdfc87390cb26db4"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MTg1MjgxOnYy", "diffSide": "RIGHT", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandler.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTowODoxMlrOGGb2pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMDo1NTo1MlrOGGf1wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwMDk5Nw==", "bodyText": "The processing directory may contain multiple files, at least the core file and metadata.json. You probably want to limit max-depth here, but then you'll be off by 1 if there is a coredump being processed right now...", "url": "https://github.com/vespa-engine/vespa/pull/12941#discussion_r409400997", "createdAt": "2020-04-16T09:08:12Z", "author": {"login": "freva"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandler.java", "diffHunk": "@@ -194,4 +204,47 @@ Path findCoredumpFileInProcessingDirectory(Path coredumpProccessingDirectory) {\n                 .orElseThrow(() -> new IllegalStateException(\n                         \"No coredump file found in processing directory \" + coredumpProccessingDirectory));\n     }\n+\n+    void updateMetrics(NodeAgentContext context, Path containerCrashPathOnHost) {\n+        Dimensions dimensions = generateDimensions(context);\n+\n+        // Unprocessed coredumps\n+        int numberOfUnprocessedCoredumps = FileFinder.files(containerCrashPathOnHost)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bebe88526e449bbca0514d8bdfc87390cb26db4"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MjMyNg==", "bodyText": "This is for number of coredumps in crash path, not the processing path. So I'll need to filter out hs_err files as well", "url": "https://github.com/vespa-engine/vespa/pull/12941#discussion_r409462326", "createdAt": "2020-04-16T10:48:45Z", "author": {"login": "olaaun"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandler.java", "diffHunk": "@@ -194,4 +204,47 @@ Path findCoredumpFileInProcessingDirectory(Path coredumpProccessingDirectory) {\n                 .orElseThrow(() -> new IllegalStateException(\n                         \"No coredump file found in processing directory \" + coredumpProccessingDirectory));\n     }\n+\n+    void updateMetrics(NodeAgentContext context, Path containerCrashPathOnHost) {\n+        Dimensions dimensions = generateDimensions(context);\n+\n+        // Unprocessed coredumps\n+        int numberOfUnprocessedCoredumps = FileFinder.files(containerCrashPathOnHost)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwMDk5Nw=="}, "originalCommit": {"oid": "8bebe88526e449bbca0514d8bdfc87390cb26db4"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2NTE3NA==", "bodyText": "processing is inside the crash path\n\n  \n    \n      vespa/node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandler.java\n    \n    \n         Line 87\n      in\n      8bebe88\n    \n    \n    \n    \n\n        \n          \n           Path containerProcessingPathOnHost = containerCrashPathOnHost.resolve(PROCESSING_DIRECTORY_NAME);", "url": "https://github.com/vespa-engine/vespa/pull/12941#discussion_r409465174", "createdAt": "2020-04-16T10:53:53Z", "author": {"login": "freva"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandler.java", "diffHunk": "@@ -194,4 +204,47 @@ Path findCoredumpFileInProcessingDirectory(Path coredumpProccessingDirectory) {\n                 .orElseThrow(() -> new IllegalStateException(\n                         \"No coredump file found in processing directory \" + coredumpProccessingDirectory));\n     }\n+\n+    void updateMetrics(NodeAgentContext context, Path containerCrashPathOnHost) {\n+        Dimensions dimensions = generateDimensions(context);\n+\n+        // Unprocessed coredumps\n+        int numberOfUnprocessedCoredumps = FileFinder.files(containerCrashPathOnHost)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwMDk5Nw=="}, "originalCommit": {"oid": "8bebe88526e449bbca0514d8bdfc87390cb26db4"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2NjMwNg==", "bodyText": "Aha \ud83d\udc4d", "url": "https://github.com/vespa-engine/vespa/pull/12941#discussion_r409466306", "createdAt": "2020-04-16T10:55:52Z", "author": {"login": "olaaun"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandler.java", "diffHunk": "@@ -194,4 +204,47 @@ Path findCoredumpFileInProcessingDirectory(Path coredumpProccessingDirectory) {\n                 .orElseThrow(() -> new IllegalStateException(\n                         \"No coredump file found in processing directory \" + coredumpProccessingDirectory));\n     }\n+\n+    void updateMetrics(NodeAgentContext context, Path containerCrashPathOnHost) {\n+        Dimensions dimensions = generateDimensions(context);\n+\n+        // Unprocessed coredumps\n+        int numberOfUnprocessedCoredumps = FileFinder.files(containerCrashPathOnHost)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwMDk5Nw=="}, "originalCommit": {"oid": "8bebe88526e449bbca0514d8bdfc87390cb26db4"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MTg1NzM0OnYy", "diffSide": "RIGHT", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTowOToxNlrOGGb5bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTowOToxNlrOGGb5bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwMTcxMA==", "bodyText": "Same problem here, should be .directories() instead of .files() and limit max-depth to 1", "url": "https://github.com/vespa-engine/vespa/pull/12941#discussion_r409401710", "createdAt": "2020-04-16T09:09:16Z", "author": {"login": "freva"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/coredump/CoredumpHandler.java", "diffHunk": "@@ -194,4 +204,47 @@ Path findCoredumpFileInProcessingDirectory(Path coredumpProccessingDirectory) {\n                 .orElseThrow(() -> new IllegalStateException(\n                         \"No coredump file found in processing directory \" + coredumpProccessingDirectory));\n     }\n+\n+    void updateMetrics(NodeAgentContext context, Path containerCrashPathOnHost) {\n+        Dimensions dimensions = generateDimensions(context);\n+\n+        // Unprocessed coredumps\n+        int numberOfUnprocessedCoredumps = FileFinder.files(containerCrashPathOnHost)\n+                .match(nameStartsWith(\".\").negate())\n+                .list().size();\n+\n+        metrics.declareGauge(Metrics.APPLICATION_NODE, \"coredumps.enqueued\", dimensions, Metrics.DimensionType.PRETAGGED).sample(numberOfUnprocessedCoredumps);\n+\n+        // Processed coredumps\n+        Path processedCoredumpsPath = doneCoredumpsPath.resolve(context.containerName().asString());\n+        int numberOfProcessedCoredumps = FileFinder.files(processedCoredumpsPath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bebe88526e449bbca0514d8bdfc87390cb26db4"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1792, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}