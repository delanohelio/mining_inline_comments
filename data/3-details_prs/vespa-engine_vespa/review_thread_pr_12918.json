{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNjcxMTAy", "number": 12918, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozMzoyMVrODyAy-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDo0MDoxOVrODyA8Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNzY4NDQxOnYy", "diffSide": "RIGHT", "path": "configdefinitions/src/vespa/dispatch.def", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozMzoyMVrOGFzsmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMTo1NDo0NlrOGF2QZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MzA2Ng==", "bodyText": "Not: It's just a single formula", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408743066", "createdAt": "2020-04-15T10:33:21Z", "author": {"login": "bratseth"}, "path": "configdefinitions/src/vespa/dispatch.def", "diffHunk": "@@ -23,6 +23,13 @@ distributionPolicy enum { ROUNDROBIN, ADAPTIVE } default=ROUNDROBIN\n ## don't use it if you don't (really) mean it.\n maxHitsPerNode int default=2147483647\n \n+## Probability for getting the correct topK documents.\n+## A value of 1.0 will ask all partitions for topK documents.\n+## Any value between <0, 1> will use a Student T fith 30 degrees freedom and compute a K value that\n+## will give you the topK documents according to this formulae.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NDk5OQ==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408784999", "createdAt": "2020-04-15T11:54:46Z", "author": {"login": "baldersheim"}, "path": "configdefinitions/src/vespa/dispatch.def", "diffHunk": "@@ -23,6 +23,13 @@ distributionPolicy enum { ROUNDROBIN, ADAPTIVE } default=ROUNDROBIN\n ## don't use it if you don't (really) mean it.\n maxHitsPerNode int default=2147483647\n \n+## Probability for getting the correct topK documents.\n+## A value of 1.0 will ask all partitions for topK documents.\n+## Any value between <0, 1> will use a Student T fith 30 degrees freedom and compute a K value that\n+## will give you the topK documents according to this formulae.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MzA2Ng=="}, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNzY5MjM2OnYy", "diffSide": "RIGHT", "path": "configdefinitions/src/vespa/dispatch.def", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozNTo0M1rOGFzxqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMTo1NDo1NFrOGF2Qpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NDM2Mg==", "bodyText": "Here perhaps we should say \"for the number of documents specified by the hits parameter\".\nIn general it's a bit strange that \"hits\" is suddenly called \"topK\" just because we optimize, but otoh it makes it easier to search for this :-)", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408744362", "createdAt": "2020-04-15T10:35:43Z", "author": {"login": "bratseth"}, "path": "configdefinitions/src/vespa/dispatch.def", "diffHunk": "@@ -23,6 +23,13 @@ distributionPolicy enum { ROUNDROBIN, ADAPTIVE } default=ROUNDROBIN\n ## don't use it if you don't (really) mean it.\n maxHitsPerNode int default=2147483647\n \n+## Probability for getting the correct topK documents.\n+## A value of 1.0 will ask all partitions for topK documents.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NTA2Mw==", "bodyText": "Improved", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408785063", "createdAt": "2020-04-15T11:54:54Z", "author": {"login": "baldersheim"}, "path": "configdefinitions/src/vespa/dispatch.def", "diffHunk": "@@ -23,6 +23,13 @@ distributionPolicy enum { ROUNDROBIN, ADAPTIVE } default=ROUNDROBIN\n ## don't use it if you don't (really) mean it.\n maxHitsPerNode int default=2147483647\n \n+## Probability for getting the correct topK documents.\n+## A value of 1.0 will ask all partitions for topK documents.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NDM2Mg=="}, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNzcwNjkxOnYy", "diffSide": "RIGHT", "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDo0MDowNlrOGFz6ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMTo0MTowM1rOGF1z4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjY1OQ==", "bodyText": "Would be better to move this into the estimator I think. (And then also move it to the top level as a package-visible class).", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408746659", "createdAt": "2020-04-15T10:40:06Z", "author": {"login": "bratseth"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -76,6 +96,9 @@ public SearchCluster(String clusterId, DispatchConfig dispatchConfig, int contai\n         for (Node node : nodes)\n             nodesByHostBuilder.put(node.hostname(), node);\n         this.nodesByHost = nodesByHostBuilder.build();\n+        hitEstimator = ((0.0 < dispatchConfig.topKProbability()) && (dispatchConfig.topKProbability() < 1.0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NzY5Nw==", "bodyText": "Agree, done.", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408777697", "createdAt": "2020-04-15T11:41:03Z", "author": {"login": "baldersheim"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -76,6 +96,9 @@ public SearchCluster(String clusterId, DispatchConfig dispatchConfig, int contai\n         for (Node node : nodes)\n             nodesByHostBuilder.put(node.hostname(), node);\n         this.nodesByHost = nodesByHostBuilder.build();\n+        hitEstimator = ((0.0 < dispatchConfig.topKProbability()) && (dispatchConfig.topKProbability() < 1.0))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjY1OQ=="}, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNzcwODA2OnYy", "diffSide": "RIGHT", "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDo0MDoxOVrOGFz7SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMzo0NToxOFrOGF6bWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA==", "bodyText": "Same, why not move this into the estimator.", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408746824", "createdAt": "2020-04-15T10:40:19Z", "author": {"login": "bratseth"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -240,6 +263,12 @@ private void setInRotationOnlyIf(boolean inRotation) {\n             vipStatus.removeFromRotation(clusterId);\n     }\n \n+    public int estimateHitsToFetch(int wantedHits, int numPartitions) {\n+        return ((hitEstimator == null) || (numPartitions <= 1))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NzcxMA==", "bodyText": "Might be quite useful to control this by query? How much you care can depend on use case ...", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408747710", "createdAt": "2020-04-15T10:41:51Z", "author": {"login": "bratseth"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -240,6 +263,12 @@ private void setInRotationOnlyIf(boolean inRotation) {\n             vipStatus.removeFromRotation(clusterId);\n     }\n \n+    public int estimateHitsToFetch(int wantedHits, int numPartitions) {\n+        return ((hitEstimator == null) || (numPartitions <= 1))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA=="}, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NTMzNw==", "bodyText": "Moved.\nWill add query too.", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408785337", "createdAt": "2020-04-15T11:55:23Z", "author": {"login": "baldersheim"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -240,6 +263,12 @@ private void setInRotationOnlyIf(boolean inRotation) {\n             vipStatus.removeFromRotation(clusterId);\n     }\n \n+    public int estimateHitsToFetch(int wantedHits, int numPartitions) {\n+        return ((hitEstimator == null) || (numPartitions <= 1))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA=="}, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg1MzMzNg==", "bodyText": "Now I have added query side control. dispatch.top-k-probability.\nCan '-' be used in query without requiring any escaping ?\nI used that to have it identical with services.xml.", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408853336", "createdAt": "2020-04-15T13:45:18Z", "author": {"login": "baldersheim"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -240,6 +263,12 @@ private void setInRotationOnlyIf(boolean inRotation) {\n             vipStatus.removeFromRotation(clusterId);\n     }\n \n+    public int estimateHitsToFetch(int wantedHits, int numPartitions) {\n+        return ((hitEstimator == null) || (numPartitions <= 1))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA=="}, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1783, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}