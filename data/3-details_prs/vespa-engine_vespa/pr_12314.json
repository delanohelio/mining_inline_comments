{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NzI4NzE3", "number": 12314, "title": "Define completeness of SuperModel and DuperModel", "bodyText": "In order for Orchestrator to remove application data from ZooKeeper, it must\nknow which applications do NOT exist. Since the duper model starts with 0\napplications, always, the only way of knowing what applications do not exist is\nfor the bootstrap code to notify the super model/duper model when bootstrap is\ncomplete. There are 2 sources of applications that must signal completeness:\n\nThe super model, once all applications have been redeployed in\nConfigServerBootstrap.\nThe infrastructure application, in the InfrastructureProvisioner the first\ntime it runs.", "createdAt": "2020-02-23T17:14:48Z", "url": "https://github.com/vespa-engine/vespa/pull/12314", "merged": true, "mergeCommit": {"oid": "db57f1d7bbfa1d715666bb43de91889879d0f391"}, "closed": true, "closedAt": "2020-02-24T10:10:00Z", "author": {"login": "hakonhall"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHMIiIAH2gAyMzc4NzI4NzE3Ojk4ODEzMTc5MmE5YmYwY2QyMjA3MjYyMmVjM2ZmZDJkNjJlZmE2MmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHaSkdAFqTM2MzI1OTU2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "988131792a9bf0cd22072622ec3ffd2d62efa62d", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/988131792a9bf0cd22072622ec3ffd2d62efa62d", "committedDate": "2020-02-23T17:11:44Z", "message": "Define completeness of SuperModel and DuperModel\n\nIn order for Orchestrator to remove application data from ZooKeeper, it must\nknow which applications do NOT exist. Since the duper model starts with 0\napplications, always, the only way of knowing what applications do not exist is\nfor the bootstrap code to notify the super model/duper model when bootstrap is\ncomplete. There are 2 sources of applications that must signal completeness:\n\n - The super model, once all applications have been redeployed in\n   ConfigServerBootstrap.\n - The infrastructure application, in the InfrastructureProvisioner the first\n   time it runs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTExNDI1", "url": "https://github.com/vespa-engine/vespa/pull/12314#pullrequestreview-363111425", "createdAt": "2020-02-23T17:51:16Z", "commit": {"oid": "988131792a9bf0cd22072622ec3ffd2d62efa62d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QxNzo1MToxNlrOFtR9ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QxNzo1MToxNlrOFtR9ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAyNDU0Nw==", "bodyText": "What if activate() throws?", "url": "https://github.com/vespa-engine/vespa/pull/12314#discussion_r383024547", "createdAt": "2020-02-23T17:51:16Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/InfraDeployerImpl.java", "diffHunk": "@@ -51,9 +51,19 @@ public InfraDeployerImpl(NodeRepository nodeRepository, Provisioner provisioner,\n     }\n \n     @Override\n-    public Map<ApplicationId, Deployment> getSupportedInfraDeployments() {\n-        return duperModel.getSupportedInfraApplications().stream()\n-                .collect(Collectors.toMap(InfraApplicationApi::getApplicationId, InfraDeployment::new));\n+    public void activateAllSupportedInfraApplications() {\n+        duperModel.getSupportedInfraApplications().forEach(api -> {\n+            var application = api.getApplicationId();\n+            var deployment = new InfraDeployment(api);\n+            try {\n+                deployment.activate();\n+            } catch (RuntimeException e) {\n+                logger.log(LogLevel.INFO, \"Failed to activate \" + application, e);\n+                // loop around to activate the next application\n+            }\n+        });\n+\n+        duperModel.infraApplicationsIsNowComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "988131792a9bf0cd22072622ec3ffd2d62efa62d"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "515c4ff32934e98fef121c7388f2f3703f09d897", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/515c4ff32934e98fef121c7388f2f3703f09d897", "committedDate": "2020-02-23T19:12:01Z", "message": "Fail cfg bootstrap if activation of infra apps fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjIwMzIx", "url": "https://github.com/vespa-engine/vespa/pull/12314#pullrequestreview-363220321", "createdAt": "2020-02-24T08:26:04Z", "commit": {"oid": "515c4ff32934e98fef121c7388f2f3703f09d897"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjUxOTgx", "url": "https://github.com/vespa-engine/vespa/pull/12314#pullrequestreview-363251981", "createdAt": "2020-02-24T09:28:38Z", "commit": {"oid": "515c4ff32934e98fef121c7388f2f3703f09d897"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOToyODozOFrOFtZ2Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOToyODozOFrOFtZ2Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1MzY3NA==", "bodyText": "Consider moving this to NodeRepositoryMaintenance or remove \n  \n    \n      vespa/node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/NodeRepositoryMaintenance.java\n    \n    \n         Line 90\n      in\n      6c122d4\n    \n    \n    \n    \n\n        \n          \n           infrastructureProvisioner.maintain();", "url": "https://github.com/vespa-engine/vespa/pull/12314#discussion_r383153674", "createdAt": "2020-02-24T09:28:38Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/InfrastructureProvisioner.java", "diffHunk": "@@ -23,17 +23,22 @@\n     InfrastructureProvisioner(NodeRepository nodeRepository, InfraDeployer infraDeployer, Duration interval) {\n         super(nodeRepository, interval);\n         this.infraDeployer = infraDeployer;\n+\n+        // If this fails, we fail the component graph construction and bootstrap of config server,\n+        // which is what we want.\n+        try {\n+            infraDeployer.activateAllSupportedInfraApplications(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "515c4ff32934e98fef121c7388f2f3703f09d897"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "058e220c9f3e45820df5e06463edf3ad7ae24021", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/058e220c9f3e45820df5e06463edf3ad7ae24021", "committedDate": "2020-02-24T09:37:22Z", "message": "There is already a call to maintain - unify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjU5NTYx", "url": "https://github.com/vespa-engine/vespa/pull/12314#pullrequestreview-363259561", "createdAt": "2020-02-24T09:41:22Z", "commit": {"oid": "058e220c9f3e45820df5e06463edf3ad7ae24021"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2789, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}