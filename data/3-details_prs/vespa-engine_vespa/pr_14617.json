{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NzQ0MjUx", "number": 14617, "title": "Take application lock once per run MERGEOK", "bodyText": "Old method takes application lock per node, with the default 2 minute timeout.\n@hakonhall or @freva", "createdAt": "2020-09-29T10:58:44Z", "url": "https://github.com/vespa-engine/vespa/pull/14617", "merged": true, "mergeCommit": {"oid": "cae8ba3bfc5573828a6e4a28d2616694b09cb616"}, "closed": true, "closedAt": "2020-09-29T12:31:03Z", "author": {"login": "mpolden"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNmOEygBqjM4MTg5MzY0MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNnKKfgH2gAyNDk0NzQ0MjUxOmI1ZjczOTFkMzIwNTdiNTI4M2ViMjhiZmJkNzUzNmRmOTRjMjFhM2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5de7916849148629dc89535422b4927aa7768cbd", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/5de7916849148629dc89535422b4927aa7768cbd", "committedDate": "2020-09-29T10:20:58Z", "message": "Verify node owner after acquiring lock"}, "afterCommit": {"oid": "533bb310e824073dd23bf1ea3466565edf2b53f0", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/533bb310e824073dd23bf1ea3466565edf2b53f0", "committedDate": "2020-09-29T11:05:14Z", "message": "Verify node owner after acquiring lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f971983a256ca2229590827f619d45b86d01f11", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/2f971983a256ca2229590827f619d45b86d01f11", "committedDate": "2020-09-29T11:53:32Z", "message": "Only lock application if node status changed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "436e340e6d23e5d5f85ba54a5baca3fbce37a903", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/436e340e6d23e5d5f85ba54a5baca3fbce37a903", "committedDate": "2020-09-29T11:54:30Z", "message": "Reduce lock timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "533bb310e824073dd23bf1ea3466565edf2b53f0", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/533bb310e824073dd23bf1ea3466565edf2b53f0", "committedDate": "2020-09-29T11:05:14Z", "message": "Verify node owner after acquiring lock"}, "afterCommit": {"oid": "436e340e6d23e5d5f85ba54a5baca3fbce37a903", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/436e340e6d23e5d5f85ba54a5baca3fbce37a903", "committedDate": "2020-09-29T11:54:30Z", "message": "Reduce lock timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MzkxMDYx", "url": "https://github.com/vespa-engine/vespa/pull/14617#pullrequestreview-498391061", "createdAt": "2020-09-29T11:58:59Z", "commit": {"oid": "436e340e6d23e5d5f85ba54a5baca3fbce37a903"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NDAxODMz", "url": "https://github.com/vespa-engine/vespa/pull/14617#pullrequestreview-498401833", "createdAt": "2020-09-29T12:13:32Z", "commit": {"oid": "436e340e6d23e5d5f85ba54a5baca3fbce37a903"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjoxMzozMlrOHZqHHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjoxMzozMlrOHZqHHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY2NjM5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Already recorded as down, nothing to do\n          \n          \n            \n                        // Already correct record, nothing to do", "url": "https://github.com/vespa-engine/vespa/pull/14617#discussion_r496666396", "createdAt": "2020-09-29T12:13:32Z", "author": {"login": "hakonhall"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/NodeFailer.java", "diffHunk": "@@ -187,27 +188,29 @@ private void updateNodeLivenessEventsForReadyNodes(Mutex lock) {\n      * Otherwise we remove any \"down\" history record.\n      */\n     private void updateNodeDownState() {\n-        Map<String, Node> activeNodesByHostname = nodeRepository().getNodes(Node.State.active).stream()\n-                .collect(Collectors.toMap(Node::hostname, node -> node));\n-\n-        serviceMonitor.getServiceModelSnapshot().getServiceInstancesByHostName()\n-                .forEach((hostName, serviceInstances) -> {\n-                    Node node = activeNodesByHostname.get(hostName.s());\n-                    if (node == null) return;\n-                    try (var lock = nodeRepository().lock(node.allocation().get().owner())) {\n-                        Optional<Node> currentNode = nodeRepository().getNode(node.hostname(), Node.State.active); // re-get inside lock\n-                        if (currentNode.isEmpty()) return; // Node disappeared since acquiring lock\n-                        node = currentNode.get();\n-                        if (badNode(serviceInstances)) {\n-                            recordAsDown(node, lock);\n-                        } else {\n-                            clearDownRecord(node, lock);\n-                        }\n-                    }\n-                    catch (UncheckedTimeoutException e) {\n-                        // Ignore - node may be locked on this round due to deployment\n-                    }\n-                });\n+        NodeList activeNodes = NodeList.copyOf(nodeRepository().getNodes(Node.State.active));\n+        serviceMonitor.getServiceModelSnapshot().getServiceInstancesByHostName().forEach((hostname, serviceInstances) -> {\n+            Optional<Node> node = activeNodes.matching(n -> n.hostname().equals(hostname.toString())).first();\n+            if (node.isEmpty()) return;\n+\n+            // Already recorded as down, nothing to do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "436e340e6d23e5d5f85ba54a5baca3fbce37a903"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NDAyMTUy", "url": "https://github.com/vespa-engine/vespa/pull/14617#pullrequestreview-498402152", "createdAt": "2020-09-29T12:13:57Z", "commit": {"oid": "436e340e6d23e5d5f85ba54a5baca3fbce37a903"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5f7391d32057b5283eb28bfbd7536df94c21a3e", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/b5f7391d32057b5283eb28bfbd7536df94c21a3e", "committedDate": "2020-09-29T12:15:39Z", "message": "Fix comment\n\nCo-authored-by: H\u00e5kon Hallingstad <hakon@verizonmedia.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4123, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}