{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NjU3ODky", "number": 14238, "title": "Ignore response filter chain bindings when constructing access contro\u2026", "bodyText": "\u2026l filter chains\nI confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-09-02T08:26:17Z", "url": "https://github.com/vespa-engine/vespa/pull/14238", "merged": true, "mergeCommit": {"oid": "79d2fe27d6568285b7c87991b5970125128eb447"}, "closed": true, "closedAt": "2020-09-02T08:43:03Z", "author": {"login": "bjorncs"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE3rMAgH2gAyNDc3NjU3ODkyOjBjOTZlNWE4NWZmYTYxYzVjOTIyYmVlYjE4Zjg0ZGRkMWFlNjU5OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE36oSgFqTQ4MDYwNzI4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e", "committedDate": "2020-09-02T08:24:53Z", "message": "Ignore response filter chain bindings when constructing access control filter chains"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTk4NDE5", "url": "https://github.com/vespa-engine/vespa/pull/14238#pullrequestreview-480598419", "createdAt": "2020-09-02T08:30:32Z", "commit": {"oid": "0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMDozM1rOHLj7qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMDozM1rOHLj7qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTA5OA==", "bodyText": "How about comparing the types, instead of assuming this is a request type?", "url": "https://github.com/vespa-engine/vespa/pull/14238#discussion_r481885098", "createdAt": "2020-09-02T08:30:33Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/AccessControl.java", "diffHunk": "@@ -154,14 +153,17 @@ private void removeDuplicateBindingsFromChain(Http http, ComponentId chainId) {\n         duplicateBindings.forEach(http.getBindings()::remove);\n     }\n \n-    private static boolean effectivelyDuplicateOf(BindingPattern accessControlBinding, BindingPattern other) {\n-        return accessControlBinding.equals(other)\n-                || (accessControlBinding.path().equals(other.path()) && other.matchesAnyPort());\n+    private static boolean effectivelyDuplicateOf(FilterBinding accessControlBinding, FilterBinding other) {\n+        if (accessControlBinding.chainId().equals(other.chainId())) return false; // Same filter chain\n+        if (other.type() == FilterBinding.Type.RESPONSE) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTk5MTUw", "url": "https://github.com/vespa-engine/vespa/pull/14238#pullrequestreview-480599150", "createdAt": "2020-09-02T08:31:28Z", "commit": {"oid": "0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMToyOFrOHLj--w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMToyOFrOHLj--w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTk0Nw==", "bodyText": "I assume this code isn't called by older versions of code, in the config server ... ?", "url": "https://github.com/vespa-engine/vespa/pull/14238#discussion_r481885947", "createdAt": "2020-09-02T08:31:28Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/FilterBinding.java", "diffHunk": "@@ -11,16 +11,20 @@\n  */\n public class FilterBinding {\n \n+    public enum Type {REQUEST, RESPONSE}\n+\n+    private final Type type;\n     private final ComponentSpecification chainId;\n     private final BindingPattern binding;\n \n-    private FilterBinding(ComponentSpecification chainId, BindingPattern binding) {\n+    private FilterBinding(Type type, ComponentSpecification chainId, BindingPattern binding) {\n+        this.type = type;\n         this.chainId = chainId;\n         this.binding = binding;\n     }\n \n-    public static FilterBinding create(ComponentSpecification chainId, BindingPattern binding) {\n-        return new FilterBinding(chainId, binding);\n+    public static FilterBinding create(Type type, ComponentSpecification chainId, BindingPattern binding) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTk5ODc3", "url": "https://github.com/vespa-engine/vespa/pull/14238#pullrequestreview-480599877", "createdAt": "2020-09-02T08:32:24Z", "commit": {"oid": "0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMjoyNFrOHLkCTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMjoyNFrOHLkCTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4Njc5OA==", "bodyText": "Would prefer explicit check for \"response-chain\" and throw otherwise, just to be absolutely future-proff.", "url": "https://github.com/vespa-engine/vespa/pull/14238#discussion_r481886798", "createdAt": "2020-09-02T08:32:24Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/xml/HttpBuilder.java", "diffHunk": "@@ -121,7 +121,8 @@ private static AthenzDomain getAccessControlDomain(DeployState deployState, Elem\n \n                 for (Element bindingSpec: XML.getChildren(child, \"binding\")) {\n                     String binding = XML.getValue(bindingSpec);\n-                    result.add(FilterBinding.create(chainId, UserBindingPattern.fromPattern(binding)));\n+                    FilterBinding.Type type = tagName.equals(\"request-chain\") ? FilterBinding.Type.REQUEST : FilterBinding.Type.RESPONSE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjAwMDk5", "url": "https://github.com/vespa-engine/vespa/pull/14238#pullrequestreview-480600099", "createdAt": "2020-09-02T08:32:41Z", "commit": {"oid": "0c96e5a85ffa61c5c922beeb18f84ddd1ae6599e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a6143ec80c40bcdd75b237656e430b3a299e7a4", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/0a6143ec80c40bcdd75b237656e430b3a299e7a4", "committedDate": "2020-09-02T08:39:23Z", "message": "Make tag name to binding type logic more resillient"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjA3Mjg0", "url": "https://github.com/vespa-engine/vespa/pull/14238#pullrequestreview-480607284", "createdAt": "2020-09-02T08:41:45Z", "commit": {"oid": "0a6143ec80c40bcdd75b237656e430b3a299e7a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4369, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}