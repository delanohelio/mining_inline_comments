{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NTA2MDc2", "number": 12588, "title": "Bratseth/autoscale 2", "bodyText": "Just removing logging I don't need any more and making the autoscale log message more convenient.", "createdAt": "2020-03-16T21:34:28Z", "url": "https://github.com/vespa-engine/vespa/pull/12588", "merged": true, "mergeCommit": {"oid": "08acf20a344196e0b43f0b21d32f40c2a60aaceb"}, "closed": true, "closedAt": "2020-03-16T22:16:17Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOQkUDAH2gAyMzg5NTA2MDc2OmI2NTY4NWI3M2I1YjI2ZGYzYjkxNTQ3NGVmZWVlNDk3Y2E0MGEyNGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOVqtsgH2gAyMzg5NTA2MDc2OmYwNTc0MWE0N2M0NmM5ODE2YWEyN2NhNjk0NzQ2NWU3NmI1MmU1OWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b65685b73b5b26df3b915474efeee497ca40a24c", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/b65685b73b5b26df3b915474efeee497ca40a24c", "committedDate": "2020-03-16T16:19:10Z", "message": "Log cluster resources, scale once per cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ee38ab4e8be0ea9a7c8405111d93212679501a4", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/2ee38ab4e8be0ea9a7c8405111d93212679501a4", "committedDate": "2020-03-16T16:48:23Z", "message": "More elaborate toString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ff563f3f8b8777d5f879819d59642fc859abc71", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/6ff563f3f8b8777d5f879819d59642fc859abc71", "committedDate": "2020-03-16T16:59:07Z", "message": "Only log once per hour per cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd8a943d73da17bd726e26d7892dde36276b0f2", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/ffd8a943d73da17bd726e26d7892dde36276b0f2", "committedDate": "2020-03-16T21:33:43Z", "message": "Update abi spec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjA2MzQz", "url": "https://github.com/vespa-engine/vespa/pull/12588#pullrequestreview-375606343", "createdAt": "2020-03-16T21:50:22Z", "commit": {"oid": "ffd8a943d73da17bd726e26d7892dde36276b0f2"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMTo1MDoyMlrOF3G7Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMTo1MTowMFrOF3G8Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyOTQzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                target.ifPresent(t -> log.info(\"Autoscale: \" + application + clusterType + \" \" + clusterId +\n          \n          \n            \n                                target.ifPresent(t -> log.info(\"Autoscale: \" + application + \" \" + clusterType + \" \" + clusterId +", "url": "https://github.com/vespa-engine/vespa/pull/12588#discussion_r393329431", "createdAt": "2020-03-16T21:50:22Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/AutoscalingMaintainer.java", "diffHunk": "@@ -48,17 +53,31 @@ protected void maintain() {\n     private void autoscale(ApplicationId application, List<Node> applicationNodes) {\n         try (MaintenanceDeployment deployment = new MaintenanceDeployment(application, deployer, nodeRepository())) {\n             if ( ! deployment.isValid()) return; // Another config server will consider this application\n-            nodesByCluster(applicationNodes).forEach((clusterSpec, clusterNodes) -> {\n-                Optional<AllocatableClusterResources> target = autoscaler.autoscale(application, clusterSpec, clusterNodes);\n-                target.ifPresent(t -> log.info(\"Autoscale: Application \" + application + \" cluster \" + clusterSpec +\n-                                               \" from \" + applicationNodes.size() + \" * \" + applicationNodes.get(0).flavor().resources() +\n-                                               \" to \" + t.nodes() + \" * \" + t.advertisedResources()));\n+            nodesByCluster(applicationNodes).forEach((clusterId, clusterNodes) -> {\n+                Optional<AllocatableClusterResources> target = autoscaler.autoscale(clusterNodes);\n+\n+                Instant lastLogTime = lastLogged.get(new Pair<>(application, clusterId));\n+                if (lastLogTime == null || lastLogTime.isBefore(nodeRepository().clock().instant().minus(Duration.ofHours(1)))) {\n+                    int currentGroups = (int) clusterNodes.stream().map(node -> node.allocation().get().membership().cluster().group()).distinct().count();\n+                    ClusterSpec.Type clusterType = clusterNodes.get(0).allocation().get().membership().cluster().type();\n+                    target.ifPresent(t -> log.info(\"Autoscale: \" + application + clusterType + \" \" + clusterId +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffd8a943d73da17bd726e26d7892dde36276b0f2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyOTczNA==", "bodyText": "Probably want to skip all of this if target is empty?", "url": "https://github.com/vespa-engine/vespa/pull/12588#discussion_r393329734", "createdAt": "2020-03-16T21:51:00Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/AutoscalingMaintainer.java", "diffHunk": "@@ -48,17 +53,31 @@ protected void maintain() {\n     private void autoscale(ApplicationId application, List<Node> applicationNodes) {\n         try (MaintenanceDeployment deployment = new MaintenanceDeployment(application, deployer, nodeRepository())) {\n             if ( ! deployment.isValid()) return; // Another config server will consider this application\n-            nodesByCluster(applicationNodes).forEach((clusterSpec, clusterNodes) -> {\n-                Optional<AllocatableClusterResources> target = autoscaler.autoscale(application, clusterSpec, clusterNodes);\n-                target.ifPresent(t -> log.info(\"Autoscale: Application \" + application + \" cluster \" + clusterSpec +\n-                                               \" from \" + applicationNodes.size() + \" * \" + applicationNodes.get(0).flavor().resources() +\n-                                               \" to \" + t.nodes() + \" * \" + t.advertisedResources()));\n+            nodesByCluster(applicationNodes).forEach((clusterId, clusterNodes) -> {\n+                Optional<AllocatableClusterResources> target = autoscaler.autoscale(clusterNodes);\n+\n+                Instant lastLogTime = lastLogged.get(new Pair<>(application, clusterId));\n+                if (lastLogTime == null || lastLogTime.isBefore(nodeRepository().clock().instant().minus(Duration.ofHours(1)))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffd8a943d73da17bd726e26d7892dde36276b0f2"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de56e1e1b2e0008fb9d0f5e950bb0f7ececdbccf", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/de56e1e1b2e0008fb9d0f5e950bb0f7ececdbccf", "committedDate": "2020-03-16T22:00:10Z", "message": "Update node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/AutoscalingMaintainer.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "812b9f60ed8f9ee6720186e05cd0adc2c4ff770e", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/812b9f60ed8f9ee6720186e05cd0adc2c4ff770e", "committedDate": "2020-03-16T22:14:38Z", "message": "Nicer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f05741a47c46c9816aa27ca6947465e76b52e59f", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/f05741a47c46c9816aa27ca6947465e76b52e59f", "committedDate": "2020-03-16T22:15:41Z", "message": "Merge"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2704, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}