{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMTc0OTA2", "number": 14141, "title": "Only wait for th elids that you are interested in.", "bodyText": "@toregge PR\nJust for discussion.", "createdAt": "2020-08-23T20:39:41Z", "url": "https://github.com/vespa-engine/vespa/pull/14141", "merged": true, "mergeCommit": {"oid": "a183d1b84ed8752dcf8f9486f7e9a36982db99b1"}, "closed": true, "closedAt": "2020-08-27T10:58:51Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdB0KicAH2gAyNDcyMTc0OTA2OjBlZmM2NzU3OGE4ZjBlZjBkNzRlOTY1YWIxNTZiNjE4ZmVhM2ZjNWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC-ERkAH2gAyNDcyMTc0OTA2OmNjNmI4NTgxMzkwNDhjYThiMWQ4MTAwNjllYjljZjQ4ZTg3ZTU0NDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0efc67578a8f0ef0d74e965ab156b618fea3fc5a", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/0efc67578a8f0ef0d74e965ab156b618fea3fc5a", "committedDate": "2020-08-23T20:37:44Z", "message": "Only wait for th elids that you are interested in."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4856dbea48260e229f183b819094b2c0f7d140bf", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/4856dbea48260e229f183b819094b2c0f7d140bf", "committedDate": "2020-08-25T09:43:41Z", "message": "Use two stage lid tracking."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b6b0b08d463ac42ca4a97ef24e07dfd5d27f951", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/7b6b0b08d463ac42ca4a97ef24e07dfd5d27f951", "committedDate": "2020-08-25T10:11:44Z", "message": "Ensure that we grab the token prior to optionally acking the operation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f28fd93828a64785f9f60f434131dc7e0329302", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/9f28fd93828a64785f9f60f434131dc7e0329302", "committedDate": "2020-08-25T13:20:51Z", "message": "Also track lids during remove operation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f2cbc87ff807ef4ae22db020ccbf2e49f735e23", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/0f2cbc87ff807ef4ae22db020ccbf2e49f735e23", "committedDate": "2020-08-25T13:42:36Z", "message": "Use a bool to signal the need for commit, and collapse multipe operation on same lid to 1."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NTA3OTgz", "url": "https://github.com/vespa-engine/vespa/pull/14141#pullrequestreview-474507983", "createdAt": "2020-08-25T13:57:47Z", "commit": {"oid": "0f2cbc87ff807ef4ae22db020ccbf2e49f735e23"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzo1Nzo0N1rOHGZY3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzo1Nzo0N1rOHGZY3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ2OTQ2OA==", "bodyText": "Consider reverting the above change.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r476469468", "createdAt": "2020-08-25T13:57:47Z", "author": {"login": "toregge"}, "path": "build_settings.cmake", "diffHunk": "@@ -73,7 +73,7 @@ else()\n endif()\n \n # C and C++ compiler flags\n-set(CMAKE_C_FLAGS \"${CMAKE_C_FLAGS} -g -O3 -fno-omit-frame-pointer ${C_WARN_OPTS} -fPIC ${VESPA_CXX_ABI_FLAGS} ${VESPA_XXHASH_DEFINE} -DBOOST_DISABLE_ASSERTS ${VESPA_CPU_ARCH_FLAGS} ${EXTRA_C_FLAGS}\")\n+set(CMAKE_C_FLAGS \"${CMAKE_C_FLAGS} -g -O0 -fno-omit-frame-pointer ${C_WARN_OPTS} -fPIC ${VESPA_CXX_ABI_FLAGS} ${VESPA_XXHASH_DEFINE} -DBOOST_DISABLE_ASSERTS ${VESPA_CPU_ARCH_FLAGS} ${EXTRA_C_FLAGS}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2cbc87ff807ef4ae22db020ccbf2e49f735e23"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a09968ca22a736d9f705eb9bca62b2d3f4ab88", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/d5a09968ca22a736d9f705eb9bca62b2d3f4ab88", "committedDate": "2020-08-25T16:13:31Z", "message": "Revert debug build option."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b2248ed030d2427443712e80569857016cb858e", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/5b2248ed030d2427443712e80569857016cb858e", "committedDate": "2020-08-26T10:30:00Z", "message": "Refactor and test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NDExMzk3", "url": "https://github.com/vespa-engine/vespa/pull/14141#pullrequestreview-475411397", "createdAt": "2020-08-26T11:51:40Z", "commit": {"oid": "5b2248ed030d2427443712e80569857016cb858e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxMTo1MTo0MFrOHHId5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxMTo1MTo0MFrOHHId5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI0MDgwNQ==", "bodyText": "Newline is missing at end of file.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r477240805", "createdAt": "2020-08-26T11:51:40Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.cpp", "diffHunk": "@@ -58,12 +90,137 @@ PendingLidTracker::consume(uint32_t lid) {\n     }\n }\n \n+ILidCommitState::State\n+PendingLidTracker::waitFor(MonitorGuard & guard, State state, uint32_t lid) const {\n+    for (auto found = _pending.find(lid); found != _pending.end(); found = _pending.find(lid)) {\n+        if (state == State::NEED_COMMIT) {\n+            return State::WAITING;\n+        }\n+        _cond.wait(guard);\n+    }\n+    return State::COMPLETED;\n+}\n+\n+PendingLidTrackerBase::Snapshot\n+PendingLidTracker::produceSnapshot() {\n+    return Snapshot();\n+}\n+\n+ILidCommitState::LidList\n+PendingLidTracker::pendingLids() const {\n+    MonitorGuard guard(_mutex);\n+    LidList lids;\n+    lids.reserve(_pending.size());\n+    for (const auto & entry : _pending) {\n+        lids.push_back(entry.first);\n+    }\n+    return lids;\n+}\n+\n+TwoPhasePendingLidTracker::TwoPhasePendingLidTracker() = default;\n+\n+TwoPhasePendingLidTracker::~TwoPhasePendingLidTracker() {\n+    assert(_pending.empty());\n+}\n+\n+IPendingLidTracker::Token\n+TwoPhasePendingLidTracker::produce(uint32_t lid) {\n+    std::lock_guard guard(_mutex);\n+    _pending[lid].inflight_feed++;\n+    return Token(lid, *this);\n+}\n void\n-PendingLidTracker::waitForConsumedLid(uint32_t lid) {\n-    std::unique_lock<std::mutex> guard(_mutex);\n-    while (_pending.find(lid) != _pending.end()) {\n+TwoPhasePendingLidTracker::consume(uint32_t lid) {\n+    std::lock_guard guard(_mutex);\n+    auto found = _pending.find(lid);\n+    assert (found != _pending.end());\n+    assert (found->second.inflight_feed > 0);\n+    found->second.inflight_feed--;\n+    found->second.need_commit = true;\n+}\n+\n+ILidCommitState::State\n+TwoPhasePendingLidTracker::waitFor(MonitorGuard & guard, State state, uint32_t lid) const {\n+    for (auto found = _pending.find(lid); found != _pending.end(); found = _pending.find(lid)) {\n+        if (state == State::NEED_COMMIT) {\n+            if ((found->second.inflight_feed > 0) || found->second.need_commit) {\n+                return State::NEED_COMMIT;\n+            }\n+            return State::WAITING;\n+        }\n         _cond.wait(guard);\n     }\n+    return State::COMPLETED;\n }\n \n+void\n+TwoPhasePendingLidTracker::consumeSnapshot(LidList committed) {\n+    MonitorGuard guard(_mutex);\n+    for (const auto & lid : committed) {\n+        auto found = _pending.find(lid);\n+        assert(found != _pending.end());\n+        assert(found->second.inflight_commit >= 1);\n+        found->second.inflight_commit --;\n+        if (found->second.empty()) {\n+            _pending.erase(found);\n+        }\n+    }\n+    _cond.notify_all();\n+}\n+\n+ILidCommitState::LidList\n+TwoPhasePendingLidTracker::pendingLids() const {\n+    MonitorGuard guard(_mutex);\n+    LidList lids;\n+    lids.reserve(_pending.size());\n+    for (const auto & entry : _pending) {\n+        lids.push_back(entry.first);\n+    }\n+    return lids;\n }\n+\n+namespace common::internal {\n+\n+class CommitList : public PendingLidTrackerBase::Payload {\n+public:\n+    using LidList = ILidCommitState::LidList;\n+    CommitList(LidList lids, TwoPhasePendingLidTracker & tracker)\n+        : _tracker(&tracker),\n+          _lids(std::move(lids))\n+    { }\n+    CommitList(const CommitList &) = delete;\n+    CommitList & operator = (const CommitList &) = delete;\n+    CommitList & operator = (CommitList &&) = delete;\n+    CommitList(CommitList && rhs) noexcept\n+        : _tracker(rhs._tracker),\n+          _lids(std::move(rhs._lids))\n+    {\n+        rhs._tracker = nullptr;\n+    }\n+    ~CommitList() override {\n+        if (_tracker != nullptr) {\n+            _tracker->consumeSnapshot(std::move(_lids));\n+        }\n+    }\n+private:\n+    TwoPhasePendingLidTracker * _tracker;\n+    LidList                     _lids;\n+};\n+\n+}\n+\n+PendingLidTrackerBase::Snapshot\n+TwoPhasePendingLidTracker::produceSnapshot() {\n+    LidList toCommit;\n+    MonitorGuard guard(_mutex);\n+    for (auto & entry : _pending) {\n+        if (entry.second.need_commit) {\n+            toCommit.emplace_back(entry.first);\n+            entry.second.inflight_commit ++;\n+            entry.second.need_commit = false;\n+        }\n+    }\n+    return std::make_unique<common::internal::CommitList>(std::move(toCommit), *this);\n+}\n+\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b2248ed030d2427443712e80569857016cb858e"}, "originalPosition": 241}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19e8da0ff3a552806604866d91db9176eee44585", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/19e8da0ff3a552806604866d91db9176eee44585", "committedDate": "2020-08-26T11:55:02Z", "message": "Do not build debug build...."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/dc2b32f81cc58c2ca03ee67a25526bab03a12d63", "committedDate": "2020-08-26T12:02:37Z", "message": "Missing eol."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NDczOTc5", "url": "https://github.com/vespa-engine/vespa/pull/14141#pullrequestreview-475473979", "createdAt": "2020-08-26T13:14:02Z", "commit": {"oid": "19e8da0ff3a552806604866d91db9176eee44585"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NTEyMzA3", "url": "https://github.com/vespa-engine/vespa/pull/14141#pullrequestreview-476512307", "createdAt": "2020-08-27T08:47:24Z", "commit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwODo0NzoyNFrOHIGkCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwOToxMToyOVrOHIHcMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1ODE4NQ==", "bodyText": "Some more details on the various states and transitions would be nice.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478258185", "createdAt": "2020-08-27T08:47:24Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -30,33 +32,102 @@ class IPendingLidTracker {\n     };\n     virtual ~IPendingLidTracker() = default;\n     virtual Token produce(uint32_t lid) = 0;\n-    virtual void waitForConsumedLid(uint32_t lid) = 0;\n private:\n     virtual void consume(uint32_t lid) = 0;\n-    std::mutex _mutex;\n-    std::condition_variable _cond;\n-    vespalib::hash_map<uint32_t, uint32_t> _pending;\n };\n \n-class NoopLidTracker : public IPendingLidTracker {\n+/**\n+ * This is an interface for checking/waiting the state of a lid in the feedpipeline", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1ODU3Mw==", "bodyText": "Don't think this comment is up to date as it also is used as base class for PendingLidTracker.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478258573", "createdAt": "2020-08-27T08:48:03Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -30,33 +32,102 @@ class IPendingLidTracker {\n     };\n     virtual ~IPendingLidTracker() = default;\n     virtual Token produce(uint32_t lid) = 0;\n-    virtual void waitForConsumedLid(uint32_t lid) = 0;\n private:\n     virtual void consume(uint32_t lid) = 0;\n-    std::mutex _mutex;\n-    std::condition_variable _cond;\n-    vespalib::hash_map<uint32_t, uint32_t> _pending;\n };\n \n-class NoopLidTracker : public IPendingLidTracker {\n+/**\n+ * This is an interface for checking/waiting the state of a lid in the feedpipeline\n+ */\n+class ILidCommitState {\n public:\n-    Token produce(uint32_t lid) override;\n-    void waitForConsumedLid(uint32_t ) override { }\n+    enum class State {NEED_COMMIT, WAITING, COMPLETED};\n+    using LidList = std::vector<uint32_t>;\n+    virtual ~ILidCommitState() = default;\n+    State getState() const { return waitState(State::NEED_COMMIT); }\n+    State getState(uint32_t lid) const { return waitState(State::NEED_COMMIT, lid); }\n+    State getState(const LidList & lids) const { return waitState(State::NEED_COMMIT, lids); }\n+    void waitComplete(uint32_t lid) const;\n+    void waitComplete(const LidList & lids) const;\n+    void waitComplete() const;\n private:\n-    void consume(uint32_t ) override { }\n+    virtual State waitState(State state, uint32_t lid) const = 0;\n+    virtual State waitState(State state, const LidList & lids) const = 0;\n+    virtual State waitState(State state) const = 0;\n+};\n+\n+/**\n+ * Base class for doing 2 phase lidtracking.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1ODY1Ng==", "bodyText": "Some more details on how this works would be nice.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478258656", "createdAt": "2020-08-27T08:48:11Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -30,33 +32,102 @@ class IPendingLidTracker {\n     };\n     virtual ~IPendingLidTracker() = default;\n     virtual Token produce(uint32_t lid) = 0;\n-    virtual void waitForConsumedLid(uint32_t lid) = 0;\n private:\n     virtual void consume(uint32_t lid) = 0;\n-    std::mutex _mutex;\n-    std::condition_variable _cond;\n-    vespalib::hash_map<uint32_t, uint32_t> _pending;\n };\n \n-class NoopLidTracker : public IPendingLidTracker {\n+/**\n+ * This is an interface for checking/waiting the state of a lid in the feedpipeline\n+ */\n+class ILidCommitState {\n public:\n-    Token produce(uint32_t lid) override;\n-    void waitForConsumedLid(uint32_t ) override { }\n+    enum class State {NEED_COMMIT, WAITING, COMPLETED};\n+    using LidList = std::vector<uint32_t>;\n+    virtual ~ILidCommitState() = default;\n+    State getState() const { return waitState(State::NEED_COMMIT); }\n+    State getState(uint32_t lid) const { return waitState(State::NEED_COMMIT, lid); }\n+    State getState(const LidList & lids) const { return waitState(State::NEED_COMMIT, lids); }\n+    void waitComplete(uint32_t lid) const;\n+    void waitComplete(const LidList & lids) const;\n+    void waitComplete() const;\n private:\n-    void consume(uint32_t ) override { }\n+    virtual State waitState(State state, uint32_t lid) const = 0;\n+    virtual State waitState(State state, const LidList & lids) const = 0;\n+    virtual State waitState(State state) const = 0;\n+};\n+\n+/**\n+ * Base class for doing 2 phase lidtracking.\n+ */\n+class PendingLidTrackerBase : public IPendingLidTracker,\n+                              public ILidCommitState\n+{\n+public:\n+    ~PendingLidTrackerBase();\n+    struct Payload {\n+        virtual ~Payload() = default;\n+    };\n+    using Snapshot = std::unique_ptr<Payload>;\n+    virtual Snapshot produceSnapshot() = 0;\n+\n+    State waitState(State state) const override;\n+    State waitState(State state, uint32_t lid) const override;\n+    State waitState(State state, const LidList & lids) const override;\n+protected:\n+    using MonitorGuard = std::unique_lock<std::mutex>;\n+    PendingLidTrackerBase();\n+    virtual LidList pendingLids() const = 0;\n+    virtual State waitFor(MonitorGuard & guard, State state, uint32_t lid) const = 0;\n+    MonitorGuard getGuard() { return MonitorGuard(_mutex); }\n+    mutable std::mutex                     _mutex;\n+    mutable std::condition_variable        _cond;\n };\n \n-class PendingLidTracker : public IPendingLidTracker {\n+/**\n+ * Use for tracking lids in a single phase.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1ODkzNg==", "bodyText": "Some more details on how this works would be nice.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478258936", "createdAt": "2020-08-27T08:48:41Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -30,33 +32,102 @@ class IPendingLidTracker {\n     };\n     virtual ~IPendingLidTracker() = default;\n     virtual Token produce(uint32_t lid) = 0;\n-    virtual void waitForConsumedLid(uint32_t lid) = 0;\n private:\n     virtual void consume(uint32_t lid) = 0;\n-    std::mutex _mutex;\n-    std::condition_variable _cond;\n-    vespalib::hash_map<uint32_t, uint32_t> _pending;\n };\n \n-class NoopLidTracker : public IPendingLidTracker {\n+/**\n+ * This is an interface for checking/waiting the state of a lid in the feedpipeline\n+ */\n+class ILidCommitState {\n public:\n-    Token produce(uint32_t lid) override;\n-    void waitForConsumedLid(uint32_t ) override { }\n+    enum class State {NEED_COMMIT, WAITING, COMPLETED};\n+    using LidList = std::vector<uint32_t>;\n+    virtual ~ILidCommitState() = default;\n+    State getState() const { return waitState(State::NEED_COMMIT); }\n+    State getState(uint32_t lid) const { return waitState(State::NEED_COMMIT, lid); }\n+    State getState(const LidList & lids) const { return waitState(State::NEED_COMMIT, lids); }\n+    void waitComplete(uint32_t lid) const;\n+    void waitComplete(const LidList & lids) const;\n+    void waitComplete() const;\n private:\n-    void consume(uint32_t ) override { }\n+    virtual State waitState(State state, uint32_t lid) const = 0;\n+    virtual State waitState(State state, const LidList & lids) const = 0;\n+    virtual State waitState(State state) const = 0;\n+};\n+\n+/**\n+ * Base class for doing 2 phase lidtracking.\n+ */\n+class PendingLidTrackerBase : public IPendingLidTracker,\n+                              public ILidCommitState\n+{\n+public:\n+    ~PendingLidTrackerBase();\n+    struct Payload {\n+        virtual ~Payload() = default;\n+    };\n+    using Snapshot = std::unique_ptr<Payload>;\n+    virtual Snapshot produceSnapshot() = 0;\n+\n+    State waitState(State state) const override;\n+    State waitState(State state, uint32_t lid) const override;\n+    State waitState(State state, const LidList & lids) const override;\n+protected:\n+    using MonitorGuard = std::unique_lock<std::mutex>;\n+    PendingLidTrackerBase();\n+    virtual LidList pendingLids() const = 0;\n+    virtual State waitFor(MonitorGuard & guard, State state, uint32_t lid) const = 0;\n+    MonitorGuard getGuard() { return MonitorGuard(_mutex); }\n+    mutable std::mutex                     _mutex;\n+    mutable std::condition_variable        _cond;\n };\n \n-class PendingLidTracker : public IPendingLidTracker {\n+/**\n+ * Use for tracking lids in a single phase.\n+ */\n+class PendingLidTracker : public PendingLidTrackerBase\n+{\n public:\n     PendingLidTracker();\n     ~PendingLidTracker() override;\n     Token produce(uint32_t lid) override;\n-    void waitForConsumedLid(uint32_t lid) override;\n+    Snapshot produceSnapshot() override;\n private:\n+    LidList pendingLids() const override;\n     void consume(uint32_t lid) override;\n-    std::mutex _mutex;\n-    std::condition_variable _cond;\n+    State waitFor(MonitorGuard & guard, State state, uint32_t lid) const override;\n+\n     vespalib::hash_map<uint32_t, uint32_t> _pending;\n };\n \n+namespace common::internal {\n+    class CommitList;\n+}\n+/**\n+ * Use for tracking lids in 2 phases.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI2MjkwNQ==", "bodyText": "I would like to see some more details on how this interface is used. What is a pending lid, what the Token class represents, and the relationship between produce() and consume().", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478262905", "createdAt": "2020-08-27T08:55:09Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -5,9 +5,11 @@\n #include <vespa/vespalib/stllike/hash_map.h>\n #include <mutex>\n #include <condition_variable>\n+#include <vector>\n \n namespace proton {\n \n+/** Interface for tracking lids in the feed pipeline */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI2ODE3Nw==", "bodyText": "Also describe the difference between a Token and a Snapshot.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478268177", "createdAt": "2020-08-27T09:03:59Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -30,33 +32,102 @@ class IPendingLidTracker {\n     };\n     virtual ~IPendingLidTracker() = default;\n     virtual Token produce(uint32_t lid) = 0;\n-    virtual void waitForConsumedLid(uint32_t lid) = 0;\n private:\n     virtual void consume(uint32_t lid) = 0;\n-    std::mutex _mutex;\n-    std::condition_variable _cond;\n-    vespalib::hash_map<uint32_t, uint32_t> _pending;\n };\n \n-class NoopLidTracker : public IPendingLidTracker {\n+/**\n+ * This is an interface for checking/waiting the state of a lid in the feedpipeline\n+ */\n+class ILidCommitState {\n public:\n-    Token produce(uint32_t lid) override;\n-    void waitForConsumedLid(uint32_t ) override { }\n+    enum class State {NEED_COMMIT, WAITING, COMPLETED};\n+    using LidList = std::vector<uint32_t>;\n+    virtual ~ILidCommitState() = default;\n+    State getState() const { return waitState(State::NEED_COMMIT); }\n+    State getState(uint32_t lid) const { return waitState(State::NEED_COMMIT, lid); }\n+    State getState(const LidList & lids) const { return waitState(State::NEED_COMMIT, lids); }\n+    void waitComplete(uint32_t lid) const;\n+    void waitComplete(const LidList & lids) const;\n+    void waitComplete() const;\n private:\n-    void consume(uint32_t ) override { }\n+    virtual State waitState(State state, uint32_t lid) const = 0;\n+    virtual State waitState(State state, const LidList & lids) const = 0;\n+    virtual State waitState(State state) const = 0;\n+};\n+\n+/**\n+ * Base class for doing 2 phase lidtracking.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1ODU3Mw=="}, "originalCommit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI3MjI0NA==", "bodyText": "This is named commitToken other places in this file. Any reason we use another name here? If not, consider consolidating.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478272244", "createdAt": "2020-08-27T09:10:51Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/server/storeonlyfeedview.cpp", "diffHunk": "@@ -585,19 +605,20 @@ StoreOnlyFeedView::internalRemove(FeedToken token, const RemoveOperationWithDocI\n          rmOp.getSubDbId(), rmOp.getLid(), rmOp.getPrevSubDbId(), rmOp.getPrevLid(), _params._subDbId);\n \n     PendingNotifyRemoveDone pendingNotifyRemoveDone = adjustMetaStore(rmOp, docId.getGlobalId(), docId);\n+    auto uncommitted = _pendingLidsForCommit->produce(rmOp.getLid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI3MjU2Mg==", "bodyText": "Note, there are more places we use uncomitted in this file.", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478272562", "createdAt": "2020-08-27T09:11:29Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/server/storeonlyfeedview.cpp", "diffHunk": "@@ -585,19 +605,20 @@ StoreOnlyFeedView::internalRemove(FeedToken token, const RemoveOperationWithDocI\n          rmOp.getSubDbId(), rmOp.getLid(), rmOp.getPrevSubDbId(), rmOp.getPrevLid(), _params._subDbId);\n \n     PendingNotifyRemoveDone pendingNotifyRemoveDone = adjustMetaStore(rmOp, docId.getGlobalId(), docId);\n+    auto uncommitted = _pendingLidsForCommit->produce(rmOp.getLid());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI3MjI0NA=="}, "originalCommit": {"oid": "dc2b32f81cc58c2ca03ee67a25526bab03a12d63"}, "originalPosition": 152}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a31dd20690d94bbdb12e9f6b1e94b2517fa4c5a", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/6a31dd20690d94bbdb12e9f6b1e94b2517fa4c5a", "committedDate": "2020-08-27T10:26:54Z", "message": "Improve comments and unify naming."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NTk0MDg0", "url": "https://github.com/vespa-engine/vespa/pull/14141#pullrequestreview-476594084", "createdAt": "2020-08-27T10:38:41Z", "commit": {"oid": "6a31dd20690d94bbdb12e9f6b1e94b2517fa4c5a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMDozODo0MVrOHIKe5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMDozOTozOFrOHIKggg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMyMjQwNg==", "bodyText": "whenn -> when", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478322406", "createdAt": "2020-08-27T10:38:41Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -84,7 +97,8 @@ class PendingLidTrackerBase : public IPendingLidTracker,\n };\n \n /**\n- * Use for tracking lids in a single phase.\n+ * Use for tracking lids whenn visibility-delay is zero and commit is implicit.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a31dd20690d94bbdb12e9f6b1e94b2517fa4c5a"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMyMjgxOA==", "bodyText": "unconmitted -> uncommitted", "url": "https://github.com/vespa-engine/vespa/pull/14141#discussion_r478322818", "createdAt": "2020-08-27T10:39:38Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/server/storeonlyfeedview.cpp", "diffHunk": "@@ -318,7 +318,7 @@ StoreOnlyFeedView::internalPut(FeedToken token, const PutOperation &putOp)\n          _params._subDbId, doc->toString(true).size(), doc->toString(true).c_str());\n \n     PendingNotifyRemoveDone pendingNotifyRemoveDone = adjustMetaStore(putOp, docId.getGlobalId(), docId);\n-    auto commitToken = _pendingLidsForCommit->produce(putOp.getLid());\n+    auto unconmitted = _pendingLidsForCommit->produce(putOp.getLid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a31dd20690d94bbdb12e9f6b1e94b2517fa4c5a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc6b858139048ca8b1d810069eb9cf48e87e5441", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/cc6b858139048ca8b1d810069eb9cf48e87e5441", "committedDate": "2020-08-27T10:43:52Z", "message": "Fix typo."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4452, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}