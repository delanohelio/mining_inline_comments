{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5OTMzMzY2", "number": 12602, "title": "Gjoranv/concurrent metrics retriever", "bodyText": "FYI: @olaaun", "createdAt": "2020-03-17T16:12:18Z", "url": "https://github.com/vespa-engine/vespa/pull/12602", "merged": true, "mergeCommit": {"oid": "b004765e6ee628ed1c6ba6b360f2a8281292f4ca"}, "closed": true, "closedAt": "2020-03-18T09:03:53Z", "author": {"login": "gjoranv"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOk2rwAH2gAyMzg5OTMzMzY2OjFmNmNhOTZkNGVlMzA4MWZhYTlmMTRiYjY5YjcyZmFlYmYyNWQyMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOlRuOAFqTM3NjE5OTU2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1f6ca96d4ee3081faa9f14bb69b72faebf25d212", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/1f6ca96d4ee3081faa9f14bb69b72faebf25d212", "committedDate": "2020-03-17T15:57:20Z", "message": "Don't recreate the thread pool upon exceptions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5eb9c407e00956a6aaeec44774b606070bdf192", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/b5eb9c407e00956a6aaeec44774b606070bdf192", "committedDate": "2020-03-17T16:11:14Z", "message": "Use a synchronizedMap for metrics snapshots for a single."}, "afterCommit": {"oid": "56ccfebb300ea7338e740544ce336bf9b50a7885", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/56ccfebb300ea7338e740544ce336bf9b50a7885", "committedDate": "2020-03-17T16:12:51Z", "message": "Use a synchronizedMap for metrics snapshots for each node."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTkwMjkx", "url": "https://github.com/vespa-engine/vespa/pull/12602#pullrequestreview-376190291", "createdAt": "2020-03-17T16:16:38Z", "commit": {"oid": "56ccfebb300ea7338e740544ce336bf9b50a7885"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjoxNjozOVrOF3jr9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjoxNjo1OVrOF3js7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMDY5Mg==", "bodyText": "Use ConcurrentHashMap instead. I am pretty sure that Collections.synchronizedMap may thrown ConcurrentModificationException if the map is iterated on concurrently with mutating operations.", "url": "https://github.com/vespa-engine/vespa/pull/12602#discussion_r393800692", "createdAt": "2020-03-17T16:16:39Z", "author": {"login": "bjorncs"}, "path": "metrics-proxy/src/main/java/ai/vespa/metricsproxy/http/application/NodeMetricsClient.java", "diffHunk": "@@ -41,7 +42,7 @@\n     private final HttpClient httpClient;\n     private final Clock clock;\n \n-    private final Map<ConsumerId, Snapshot> snapshots = new HashMap<>();\n+    private final Map<ConsumerId, Snapshot> snapshots = Collections.synchronizedMap(new HashMap<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56ccfebb300ea7338e740544ce336bf9b50a7885"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMDk0MQ==", "bodyText": "Consider making forkJoinPool final.", "url": "https://github.com/vespa-engine/vespa/pull/12602#discussion_r393800941", "createdAt": "2020-03-17T16:16:59Z", "author": {"login": "bjorncs"}, "path": "metrics-proxy/src/main/java/ai/vespa/metricsproxy/http/application/ApplicationMetricsRetriever.java", "diffHunk": "@@ -82,8 +82,6 @@ public void deconstruct() {\n \n         } catch (Exception e) {\n             // Since the task is a ForkJoinTask, we don't need special handling of InterruptedException\n-            forkJoinPool.shutdownNow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f6ca96d4ee3081faa9f14bb69b72faebf25d212"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "committedDate": "2020-03-17T16:23:53Z", "message": "Use a ConcurrentHashMap for metrics snapshots for each node."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56ccfebb300ea7338e740544ce336bf9b50a7885", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/56ccfebb300ea7338e740544ce336bf9b50a7885", "committedDate": "2020-03-17T16:12:51Z", "message": "Use a synchronizedMap for metrics snapshots for each node."}, "afterCommit": {"oid": "1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "committedDate": "2020-03-17T16:23:53Z", "message": "Use a ConcurrentHashMap for metrics snapshots for each node."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f67a70e76e628d558b244c99c61f805a97ca1adc", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/f67a70e76e628d558b244c99c61f805a97ca1adc", "committedDate": "2020-03-17T16:25:08Z", "message": "Declare the thread pool final."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTk5NTY3", "url": "https://github.com/vespa-engine/vespa/pull/12602#pullrequestreview-376199567", "createdAt": "2020-03-17T16:26:52Z", "commit": {"oid": "f67a70e76e628d558b244c99c61f805a97ca1adc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2720, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}