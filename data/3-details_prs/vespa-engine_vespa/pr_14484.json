{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwOTAwNDY2", "number": 14484, "title": "- Group commits to the TLS and sync to disk before acking.", "bodyText": "Add zstd as compression.\nNo immediate commit. Delay ack until fully committed instead.\n\n@toregge PR", "createdAt": "2020-09-22T12:20:39Z", "url": "https://github.com/vespa-engine/vespa/pull/14484", "merged": true, "mergeCommit": {"oid": "07e1d62f422982fcd09821122482d131c8cdf069"}, "closed": true, "closedAt": "2020-09-22T12:54:06Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLWzJngH2gAyNDkwOTAwNDY2OjJmYzQ4Yjc2YmE0MTg3Yjg4YzMwM2Y1ZmI3MzcyYzRkZjJhOTNmMWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLXf_vAFqTQ5MzQyNTYxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2fc48b76ba4187b88c303f5fb7372c4df2a93f1e", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/2fc48b76ba4187b88c303f5fb7372c4df2a93f1e", "committedDate": "2020-09-22T12:04:11Z", "message": "- Group commits to the TLS and sync to disk before acking.\n- Add zstd as compression.\n- No immediate commit. Delay ack until fully committed instead."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDA5MzQ4", "url": "https://github.com/vespa-engine/vespa/pull/14484#pullrequestreview-493409348", "createdAt": "2020-09-22T12:33:28Z", "commit": {"oid": "2fc48b76ba4187b88c303f5fb7372c4df2a93f1e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMjozMzoyOFrOHV3wrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMjozNTo0NlrOHV32KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY5NTcyNg==", "bodyText": "This if should be unneeded, we know that completed is set, otherwise previous line would have caused a crash.", "url": "https://github.com/vespa-engine/vespa/pull/14484#discussion_r492695726", "createdAt": "2020-09-22T12:33:28Z", "author": {"login": "toregge"}, "path": "searchlib/src/vespa/searchlib/transactionlog/domain.cpp", "diffHunk": "@@ -318,22 +323,78 @@ Domain::optionallyRotateFile(SerialNum serialNum) {\n     return dp;\n }\n \n+void\n+Domain::append(const Packet & packet, Writer::DoneCallback onDone) {\n+    vespalib::MonitorGuard guard(_currentChunkMonitor);\n+    if (_lastSerial >= packet.range().from()) {\n+        throw runtime_error(fmt(\"Incoming serial number(%\" PRIu64 \") must be bigger than the last one (%\" PRIu64 \").\",\n+                                packet.range().from(), _lastSerial));\n+    } else {\n+        _lastSerial = packet.range().to();\n+    }\n+    _currentChunk->add(packet, std::move(onDone));\n+    commitIfFull(guard);\n+}\n+\n Domain::CommitResult\n Domain::startCommit(DoneCallback onDone) {\n-    (void) onDone;\n+    vespalib::MonitorGuard guard(_currentChunkMonitor);\n+    if ( !_currentChunk->empty() ) {\n+        auto completed = grabCurrentChunk(guard);\n+        assert(completed);\n+        completed->setCommitDoneCallback(std::move(onDone));\n+        CommitResult result(completed->createCommitResult());\n+        commitChunk(std::move(completed), guard);\n+        return result;\n+    }\n     return CommitResult();\n }\n \n void\n-Domain::append(const Packet & packet, Writer::DoneCallback onDone)\n-{\n-    (void) onDone;\n+Domain::commitIfFull(const vespalib::MonitorGuard &guard) {\n+    if (_currentChunk->sizeBytes() > _config.getChunkSizeLimit()) {\n+        auto completed = std::move(_currentChunk);\n+        _currentChunk = std::make_unique<CommitChunk>(_config.getChunkSizeLimit(), completed->stealCallbacks());\n+        if (completed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc48b76ba4187b88c303f5fb7372c4df2a93f1e"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY5NzEyOQ==", "bodyText": "This guard should be moved into the following lambda. We want to keep chunk alive until previous chunks have been committed.", "url": "https://github.com/vespa-engine/vespa/pull/14484#discussion_r492697129", "createdAt": "2020-09-22T12:35:46Z", "author": {"login": "toregge"}, "path": "searchlib/src/vespa/searchlib/transactionlog/domain.cpp", "diffHunk": "@@ -318,22 +323,78 @@ Domain::optionallyRotateFile(SerialNum serialNum) {\n     return dp;\n }\n \n+void\n+Domain::append(const Packet & packet, Writer::DoneCallback onDone) {\n+    vespalib::MonitorGuard guard(_currentChunkMonitor);\n+    if (_lastSerial >= packet.range().from()) {\n+        throw runtime_error(fmt(\"Incoming serial number(%\" PRIu64 \") must be bigger than the last one (%\" PRIu64 \").\",\n+                                packet.range().from(), _lastSerial));\n+    } else {\n+        _lastSerial = packet.range().to();\n+    }\n+    _currentChunk->add(packet, std::move(onDone));\n+    commitIfFull(guard);\n+}\n+\n Domain::CommitResult\n Domain::startCommit(DoneCallback onDone) {\n-    (void) onDone;\n+    vespalib::MonitorGuard guard(_currentChunkMonitor);\n+    if ( !_currentChunk->empty() ) {\n+        auto completed = grabCurrentChunk(guard);\n+        assert(completed);\n+        completed->setCommitDoneCallback(std::move(onDone));\n+        CommitResult result(completed->createCommitResult());\n+        commitChunk(std::move(completed), guard);\n+        return result;\n+    }\n     return CommitResult();\n }\n \n void\n-Domain::append(const Packet & packet, Writer::DoneCallback onDone)\n-{\n-    (void) onDone;\n+Domain::commitIfFull(const vespalib::MonitorGuard &guard) {\n+    if (_currentChunk->sizeBytes() > _config.getChunkSizeLimit()) {\n+        auto completed = std::move(_currentChunk);\n+        _currentChunk = std::make_unique<CommitChunk>(_config.getChunkSizeLimit(), completed->stealCallbacks());\n+        if (completed) {\n+            commitChunk(std::move(completed), guard);\n+        }\n+    }\n+}\n+\n+std::unique_ptr<CommitChunk>\n+Domain::grabCurrentChunk(const vespalib::MonitorGuard & guard) {\n+    assert(guard.monitors(_currentChunkMonitor));\n+    auto chunk = std::move(_currentChunk);\n+    _currentChunk = createCommitChunk(_config);\n+    return chunk;\n+}\n+\n+bool\n+Domain::commitChunk(std::unique_ptr<CommitChunk> chunk, const vespalib::MonitorGuard & chunkOrderGuard) {\n+    assert(chunkOrderGuard.monitors(_currentChunkMonitor));\n+    if ( ! chunk->getPacket().empty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc48b76ba4187b88c303f5fb7372c4df2a93f1e"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7f7be2e596453f16d80896eb11f68895d275eb1", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/e7f7be2e596453f16d80896eb11f68895d275eb1", "committedDate": "2020-09-22T12:43:10Z", "message": "Remove unnecessary guard and move check for emptiness inside doCommit to ensure ordering also of empty chunks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b7f9bf28844837b7a7dfd21857806406578ec0e", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/2b7f9bf28844837b7a7dfd21857806406578ec0e", "committedDate": "2020-09-22T12:52:11Z", "message": "Check for no data, as there might be callbacks that have been moved over."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDI1NjEy", "url": "https://github.com/vespa-engine/vespa/pull/14484#pullrequestreview-493425612", "createdAt": "2020-09-22T12:53:10Z", "commit": {"oid": "2b7f9bf28844837b7a7dfd21857806406578ec0e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4288, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}