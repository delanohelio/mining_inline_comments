{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNjg1MTkw", "number": 11817, "title": "Arnej/add hnsw algo", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@geirst please review\n@havardpe FYI\n@vekterli FYI", "createdAt": "2020-01-16T14:50:25Z", "url": "https://github.com/vespa-engine/vespa/pull/11817", "merged": true, "mergeCommit": {"oid": "912caa0b773529dc53015c7de1b4b2a9154c3cd2"}, "closed": true, "closedAt": "2020-01-17T15:37:51Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb653fQAH2gAyMzYzNjg1MTkwOmM1Yjk1M2QzZDJiMDYxZGJhYjg1MzcyMDljNmRkZWRiMWMwMmNmMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7PSL3AH2gAyMzYzNjg1MTkwOjE0MTk5NWEwZjk2MWZhZDJiMWRkYzUwN2JmOTY3MjlkNDQ0NjU1MGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5b953d3d2b061dbab8537209c6ddedb1c02cf14", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/c5b953d3d2b061dbab8537209c6ddedb1c02cf14", "committedDate": "2020-01-16T13:07:44Z", "message": "add some statistics and refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ad26b78130087c78651977e593583807a0a582b", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/2ad26b78130087c78651977e593583807a0a582b", "committedDate": "2020-01-16T13:12:29Z", "message": "add HNSW algorithm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00559018537adacd5ee8444a3dc680b516926edc", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/00559018537adacd5ee8444a3dc680b516926edc", "committedDate": "2020-01-16T14:05:34Z", "message": "back to 1M documents"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NDIyOTc5", "url": "https://github.com/vespa-engine/vespa/pull/11817#pullrequestreview-344422979", "createdAt": "2020-01-17T08:27:15Z", "commit": {"oid": "2ad26b78130087c78651977e593583807a0a582b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwODoyNzoxNVrOFexwEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwODozOTo1NlrOFeyBQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgxNjcyMw==", "bodyText": "Please update copyright to current year.", "url": "https://github.com/vespa-engine/vespa/pull/11817#discussion_r367816723", "createdAt": "2020-01-17T08:27:15Z", "author": {"login": "geirst"}, "path": "eval/src/tests/ann/xp-hnswlike-nns.cpp", "diffHunk": "@@ -0,0 +1,394 @@\n+// Copyright 2019 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ad26b78130087c78651977e593583807a0a582b"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgyMTEyMA==", "bodyText": "Perhaps this could be a constructor parameter?", "url": "https://github.com/vespa-engine/vespa/pull/11817#discussion_r367821120", "createdAt": "2020-01-17T08:39:56Z", "author": {"login": "geirst"}, "path": "eval/src/tests/ann/xp-hnswlike-nns.cpp", "diffHunk": "@@ -0,0 +1,394 @@\n+// Copyright 2019 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <algorithm>\n+#include <assert.h>\n+#include <queue>\n+#include <random>\n+#include \"nns.h\"\n+\n+using LinkList = std::vector<uint32_t>;\n+\n+struct Node {\n+    std::vector<LinkList> _links;\n+    Node(uint32_t , uint32_t numLevels, uint32_t M)\n+        : _links(numLevels)\n+    {\n+        for (uint32_t i = 0; i < _links.size(); ++i) {\n+            _links[i].reserve((i == 0) ? (2 * M + 1) : (M+1));\n+        }\n+    }\n+};\n+\n+struct VisitedSet\n+{\n+    using Mark = unsigned short;\n+    Mark *ptr;\n+    Mark curval;\n+    size_t sz;\n+    VisitedSet(const VisitedSet &) = delete;\n+    VisitedSet& operator=(const VisitedSet &) = delete;\n+    explicit VisitedSet(size_t size) {\n+        ptr = (Mark *)malloc(size * sizeof(Mark));\n+        curval = -1;\n+        sz = size;\n+    }\n+    void clear() {\n+        ++curval;\n+        if (curval == 0) {\n+            memset(ptr, 0, sz * sizeof(Mark));\n+            ++curval;\n+        }\n+    }\n+    ~VisitedSet() { free(ptr); }\n+    void mark(size_t id) { ptr[id] = curval; }\n+    bool isMarked(size_t id) const { return ptr[id] == curval; }\n+};\n+\n+struct VisitedSetPool\n+{\n+    std::unique_ptr<VisitedSet> lastUsed;\n+    VisitedSetPool() {\n+        lastUsed = std::make_unique<VisitedSet>(250);\n+    }\n+    ~VisitedSetPool() {}\n+    VisitedSet &get(size_t size) {\n+        if (size > lastUsed->sz) {\n+            lastUsed = std::make_unique<VisitedSet>(size*2);\n+        }\n+        lastUsed->clear();\n+        return *lastUsed;\n+    }\n+};\n+\n+struct HnswHit {\n+    float dist;\n+    uint32_t docid;\n+    HnswHit(uint32_t di, SqDist sq) : dist(sq.distance), docid(di) {}\n+};\n+\n+\n+using QueueEntry = HnswHit;\n+struct GreaterDist {\n+    bool operator() (const QueueEntry &lhs, const QueueEntry& rhs) const {\n+        return (rhs.dist < lhs.dist);\n+    }\n+};\n+struct LesserDist {\n+    bool operator() (const QueueEntry &lhs, const QueueEntry& rhs) const {\n+        return (lhs.dist < rhs.dist);\n+    }\n+};\n+\n+using NearestList = std::vector<QueueEntry>;\n+\n+struct NearestPriQ : std::priority_queue<QueueEntry, NearestList, GreaterDist>\n+{\n+};\n+\n+struct FurthestPriQ : std::priority_queue<QueueEntry, NearestList, LesserDist>\n+{\n+   NearestList steal() {\n+       NearestList result;\n+       c.swap(result);\n+       return result;\n+   }\n+   const NearestList& peek() const { return c; }\n+};\n+\n+class HnswLikeNns : public NNS<float>\n+{\n+private:\n+    std::vector<Node> _nodes;\n+    uint32_t _entryId;\n+    int _entryLevel;\n+    uint32_t _M;\n+    uint32_t _efConstruction;\n+    double _levelMultiplier;\n+    std::default_random_engine _rndGen;\n+    VisitedSetPool _visitedSetPool;\n+\n+    double distance(Vector v, uint32_t id) const;\n+\n+    double distance(uint32_t a, uint32_t b) const {\n+        Vector v = _dva.get(a);\n+        return distance(v, b);\n+    }\n+\n+    int randomLevel() {\n+        std::uniform_real_distribution<double> distribution(0.0, 1.0);\n+        double r = -log(distribution(_rndGen)) * _levelMultiplier;\n+        return (int) r;\n+    }\n+\n+public:\n+    HnswLikeNns(uint32_t numDims, const DocVectorAccess<float> &dva)\n+        : NNS(numDims, dva),\n+          _nodes(),\n+          _entryId(0),\n+          _entryLevel(-1),\n+          _M(16),\n+          _efConstruction(150),\n+          _levelMultiplier(1.0 / log(1.0 * _M))\n+    {\n+        _nodes.reserve(1234567);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ad26b78130087c78651977e593583807a0a582b"}, "originalPosition": 133}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "141995a0f961fad2b1ddc507bf96729d4446550b", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/141995a0f961fad2b1ddc507bf96729d4446550b", "committedDate": "2020-01-17T14:04:54Z", "message": "update copyright"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4035, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}