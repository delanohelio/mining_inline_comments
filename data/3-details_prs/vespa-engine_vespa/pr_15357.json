{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNjMyMTE4", "number": 15357, "title": "Jonmv/reindexing metrics", "bodyText": "@bjorncs please review.", "createdAt": "2020-11-16T12:27:31Z", "url": "https://github.com/vespa-engine/vespa/pull/15357", "merged": true, "mergeCommit": {"oid": "d36434467f16db0483cf00990d6abeceb86cc78a"}, "closed": true, "closedAt": "2020-11-20T08:25:03Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddYIMxgFqTUzMjI4MjA1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeTBZSgFqTUzNTIwNzY2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMjgyMDU0", "url": "https://github.com/vespa-engine/vespa/pull/15357#pullrequestreview-532282054", "createdAt": "2020-11-17T11:46:53Z", "commit": {"oid": "fe5ea3f84adea4ae5aaf277f61651b35e71f463a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMTo0Njo1NFrOH0xJmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMTo0Njo1NFrOH0xJmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA5MzI3Mw==", "bodyText": "Consider having \"percent\" removed from metric name, and instead represent it as a value between 0 and 1.", "url": "https://github.com/vespa-engine/vespa/pull/15357#discussion_r525093273", "createdAt": "2020-11-17T11:46:54Z", "author": {"login": "bjorncs"}, "path": "clustercontroller-reindexer/src/main/java/ai/vespa/reindexing/ReindexingMetrics.java", "diffHunk": "@@ -0,0 +1,47 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package ai.vespa.reindexing;\n+\n+import com.yahoo.documentapi.ProgressToken;\n+import com.yahoo.jdisc.Metric;\n+\n+import java.time.Clock;\n+import java.util.Map;\n+\n+import static ai.vespa.reindexing.Reindexing.State.SUCCESSFUL;\n+\n+/**\n+ * Metrics for reindexing in a content cluster.\n+ *\n+ * @author jonmv\n+ */\n+class ReindexingMetrics {\n+\n+    private final Metric metric;\n+    private final String cluster;\n+\n+    ReindexingMetrics(Metric metric, String cluster) {\n+        this.metric = metric;\n+        this.cluster = cluster;\n+    }\n+\n+    void dump(Reindexing reindexing) {\n+        reindexing.status().forEach((type, status) -> {\n+            metric.set(\"reindexing.percent.done\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe5ea3f84adea4ae5aaf277f61651b35e71f463a"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4de0fc18bbe12a1646bfda2b505cef0d2fbe99c1", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/4de0fc18bbe12a1646bfda2b505cef0d2fbe99c1", "committedDate": "2020-11-19T10:02:41Z", "message": "Non-functional updates to doc and comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b110acc79bee12f6a3243d1e78697d5b11f5dcb", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/5b110acc79bee12f6a3243d1e78697d5b11f5dcb", "committedDate": "2020-11-19T10:04:46Z", "message": "Write metrics regularly when doing reindexing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf81e897a3dd05b1e0934d6234f5a9bf0ad9a150", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/bf81e897a3dd05b1e0934d6234f5a9bf0ad9a150", "committedDate": "2020-11-19T10:04:46Z", "message": "Avoid potential NPE in config server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efee08d9b656445ddd13c31c14394e6031654047", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/efee08d9b656445ddd13c31c14394e6031654047", "committedDate": "2020-11-19T10:04:46Z", "message": "Metric \"reindexing.progress\" with value [0, 1] instead of percentage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e70424ae2180ddd6c04267b009c0fb715a41fa5f", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/e70424ae2180ddd6c04267b009c0fb715a41fa5f", "committedDate": "2020-11-19T10:04:46Z", "message": "Status may be modified by different threads \u2014\u00a0wrap in AtomicRefence"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce74f46c57103361728ff355a5a5018b1f97a4e6", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/ce74f46c57103361728ff355a5a5018b1f97a4e6", "committedDate": "2020-11-19T09:59:59Z", "message": "Status may be modified by different threads \u2014\u00a0wrap in AtomicRefence"}, "afterCommit": {"oid": "e70424ae2180ddd6c04267b009c0fb715a41fa5f", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/e70424ae2180ddd6c04267b009c0fb715a41fa5f", "committedDate": "2020-11-19T10:04:46Z", "message": "Status may be modified by different threads \u2014\u00a0wrap in AtomicRefence"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MzI4NzM1", "url": "https://github.com/vespa-engine/vespa/pull/15357#pullrequestreview-534328735", "createdAt": "2020-11-19T11:24:33Z", "commit": {"oid": "e70424ae2180ddd6c04267b009c0fb715a41fa5f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToyNDozM1rOH2Y0SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToyNDozM1rOH2Y0SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc5MTc1Mw==", "bodyText": "You should probably use a shared monitor/lock for both reindexing and status (unless they are used completely  independently of each other).", "url": "https://github.com/vespa-engine/vespa/pull/15357#discussion_r526791753", "createdAt": "2020-11-19T11:24:33Z", "author": {"login": "bjorncs"}, "path": "clustercontroller-reindexer/src/main/java/ai/vespa/reindexing/Reindexer.java", "diffHunk": "@@ -110,20 +107,20 @@ public void reindex() throws ReindexingLockException {\n     @SuppressWarnings(\"fallthrough\") // (\u30ce\u0ca0 \u2229\u0ca0)\u30ce\u5f61( \\o\u00b0o)\\\n     private void progress(DocumentType type) {\n         // If this is a new document type (or a new cluster), no reindexing is required.\n-        reindexing = database.readReindexing();\n-        status = reindexing.status().getOrDefault(type,\n-                                                  Status.ready(clock.instant())\n-                                                        .running()\n-                                                        .successful(clock.instant()));\n-        if (ready.get(type).isAfter(status.startedAt()))\n-            status = Status.ready(clock.instant()); // Need to restart, as a newer reindexing is required.\n-\n-        database.writeReindexing(reindexing = reindexing.with(type, status));\n-        metrics.dump(reindexing);\n-\n-        switch (status.state()) {\n+        AtomicReference<Reindexing> reindexing = new AtomicReference<>(database.readReindexing());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e70424ae2180ddd6c04267b009c0fb715a41fa5f"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5af700358a57ffce0bac8dd3ffcac43d6f2cce6", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/b5af700358a57ffce0bac8dd3ffcac43d6f2cce6", "committedDate": "2020-11-19T17:09:38Z", "message": "Update with new ready-state immediately when ready"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f500364861c7dffac4f136ce218ea22c3e9da8a", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/0f500364861c7dffac4f136ce218ea22c3e9da8a", "committedDate": "2020-11-19T17:12:16Z", "message": "Update metric state dimension name to \"pending\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MjA3NjY4", "url": "https://github.com/vespa-engine/vespa/pull/15357#pullrequestreview-535207668", "createdAt": "2020-11-20T08:24:41Z", "commit": {"oid": "0f500364861c7dffac4f136ce218ea22c3e9da8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1942, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}