{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjk5NTc3", "number": 12072, "title": "reduce certificate log spam", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-02-05T10:38:26Z", "url": "https://github.com/vespa-engine/vespa/pull/12072", "merged": true, "mergeCommit": {"oid": "d05911599c0b9706d54ff7819349cbcadd30ed0a"}, "closed": true, "closedAt": "2020-02-05T11:33:27Z", "author": {"login": "andreer"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBTn6iAH2gAyMzcxMjk5NTc3OmQ1NTkyOWJlMmQ2ZDQ5OGMwZGY2NjY5MWM5OWQ2MjAyNjUxZjhjODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBUdxzAFqTM1MzY0MjM1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d55929be2d6d498c0df66691c99d6202651f8c85", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/d55929be2d6d498c0df66691c99d6202651f8c85", "committedDate": "2020-02-05T10:31:48Z", "message": "reduce certificate log spam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0116cde0673ea2897df5e83c8620911c7331d342", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/0116cde0673ea2897df5e83c8620911c7331d342", "committedDate": "2020-02-05T10:39:08Z", "message": "update abi spec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjQyMzUy", "url": "https://github.com/vespa-engine/vespa/pull/12072#pullrequestreview-353642352", "createdAt": "2020-02-05T11:23:12Z", "commit": {"oid": "0116cde0673ea2897df5e83c8620911c7331d342"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMToyMzoxMlrOFl0XUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMTozMDoyNFrOFl0j3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE5OTU2OA==", "bodyText": "Log the expected set and actual set?", "url": "https://github.com/vespa-engine/vespa/pull/12072#discussion_r375199568", "createdAt": "2020-02-05T11:23:12Z", "author": {"login": "tokle"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/endpointcertificates/EndpointCertificateManager.java", "diffHunk": "@@ -139,10 +140,13 @@ private boolean verifyEndpointCertificate(EndpointCertificateMetadata endpointCe\n                     .filter(san -> san.getType().equals(SubjectAlternativeName.Type.DNS_NAME))\n                     .map(SubjectAlternativeName::getValue).collect(Collectors.toSet());\n \n-            if (!subjectAlternativeNames.equals(Set.copyOf(dnsNamesOf(instance.id(), List.of(zone)))))\n-                return logWarning(warningPrefix, \"The list of SANs in the certificate does not match what we expect\");\n+            if(Sets.intersection(subjectAlternativeNames, Set.copyOf(dnsNamesOf(instance.id(), List.of(zone)))).isEmpty()) {\n+                return logWarning(warningPrefix, \"No overlap between SANs in certificate and expected SANs\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0116cde0673ea2897df5e83c8620911c7331d342"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwMjY5MA==", "bodyText": "This is expected on first time deployment, but not on the subsequent deployments. Consider not invoking this code path on first time deployment or include a log stating that this can be expected in certain cases.\nOn any subsequent calls this should be considered Error, not warning.", "url": "https://github.com/vespa-engine/vespa/pull/12072#discussion_r375202690", "createdAt": "2020-02-05T11:30:10Z", "author": {"login": "tokle"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/endpointcertificates/EndpointCertificateManager.java", "diffHunk": "@@ -139,10 +140,13 @@ private boolean verifyEndpointCertificate(EndpointCertificateMetadata endpointCe\n                     .filter(san -> san.getType().equals(SubjectAlternativeName.Type.DNS_NAME))\n                     .map(SubjectAlternativeName::getValue).collect(Collectors.toSet());\n \n-            if (!subjectAlternativeNames.equals(Set.copyOf(dnsNamesOf(instance.id(), List.of(zone)))))\n-                return logWarning(warningPrefix, \"The list of SANs in the certificate does not match what we expect\");\n+            if(Sets.intersection(subjectAlternativeNames, Set.copyOf(dnsNamesOf(instance.id(), List.of(zone)))).isEmpty()) {\n+                return logWarning(warningPrefix, \"No overlap between SANs in certificate and expected SANs\");\n+            }\n \n             return true; // All good then, hopefully\n+        } catch (SecretNotFoundException s) {\n+            return logWarning(warningPrefix, \"Certificate not found in secret store\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0116cde0673ea2897df5e83c8620911c7331d342"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwMjc0Mg==", "bodyText": "error?", "url": "https://github.com/vespa-engine/vespa/pull/12072#discussion_r375202742", "createdAt": "2020-02-05T11:30:18Z", "author": {"login": "tokle"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/endpointcertificates/EndpointCertificateManager.java", "diffHunk": "@@ -139,10 +140,13 @@ private boolean verifyEndpointCertificate(EndpointCertificateMetadata endpointCe\n                     .filter(san -> san.getType().equals(SubjectAlternativeName.Type.DNS_NAME))\n                     .map(SubjectAlternativeName::getValue).collect(Collectors.toSet());\n \n-            if (!subjectAlternativeNames.equals(Set.copyOf(dnsNamesOf(instance.id(), List.of(zone)))))\n-                return logWarning(warningPrefix, \"The list of SANs in the certificate does not match what we expect\");\n+            if(Sets.intersection(subjectAlternativeNames, Set.copyOf(dnsNamesOf(instance.id(), List.of(zone)))).isEmpty()) {\n+                return logWarning(warningPrefix, \"No overlap between SANs in certificate and expected SANs\");\n+            }\n \n             return true; // All good then, hopefully\n+        } catch (SecretNotFoundException s) {\n+            return logWarning(warningPrefix, \"Certificate not found in secret store\");\n         } catch (Exception e) {\n             log.log(LogLevel.WARNING, \"Exception thrown when verifying endpoint certificate\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0116cde0673ea2897df5e83c8620911c7331d342"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwMjc4Mw==", "bodyText": "error?", "url": "https://github.com/vespa-engine/vespa/pull/12072#discussion_r375202783", "createdAt": "2020-02-05T11:30:24Z", "author": {"login": "tokle"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/endpointcertificates/EndpointCertificateManager.java", "diffHunk": "@@ -116,7 +116,8 @@ private boolean verifyEndpointCertificate(EndpointCertificateMetadata endpointCe\n         try {\n             var pemEncodedEndpointCertificate = secretStore.getSecret(endpointCertificateMetadata.certName(), endpointCertificateMetadata.version());\n \n-            if (pemEncodedEndpointCertificate == null) return logWarning(warningPrefix, \"Certificate not found in secret store\");\n+            if (pemEncodedEndpointCertificate == null)\n+                return logWarning(warningPrefix, \"Secret store returned null for certificate\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0116cde0673ea2897df5e83c8620911c7331d342"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3022, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}