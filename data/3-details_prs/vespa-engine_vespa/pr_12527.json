{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MTY2MTMx", "number": 12527, "title": "Balder/compile euclidian distance for avx2 and avx512", "bodyText": "@geirst PR", "createdAt": "2020-03-10T14:27:37Z", "url": "https://github.com/vespa-engine/vespa/pull/12527", "merged": true, "mergeCommit": {"oid": "811cb02ae056b5b61520fa578ec5a90bcb6a4c4f"}, "closed": true, "closedAt": "2020-03-10T20:45:15Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMP_M9gH2gAyMzg2MTY2MTMxOjczYjE2YmJhNjg3MTJlNDdkNGY4MjBhNjdlMmMwZTdkNzRkOWViMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMZajOAFqTM3MjMzNTY4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "73b16bba68712e47d4f820a67e2c0e7d74d9eb1b", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/73b16bba68712e47d4f820a67e2c0e7d74d9eb1b", "committedDate": "2020-03-10T10:30:47Z", "message": "Add a euclidian distance that is optimal for avx, avx2 and avx512."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0bd73b016439f087edb7ce165524fed3c9ab1ee", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/e0bd73b016439f087edb7ce165524fed3c9ab1ee", "committedDate": "2020-03-10T12:27:50Z", "message": "Use method from vespalib::hwaccelrated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10856a1ba094837bf3a098f377a0d77d9e753ce8", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/10856a1ba094837bf3a098f377a0d77d9e753ce8", "committedDate": "2020-03-10T13:54:03Z", "message": "Simply follow pattern from dotproduct."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/03bd3b755650d828e63458379d5c120da63d7221", "committedDate": "2020-03-10T14:26:49Z", "message": "Moved to hw accelrated module."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDc1MTA0", "url": "https://github.com/vespa-engine/vespa/pull/12527#pullrequestreview-372075104", "createdAt": "2020-03-10T15:41:27Z", "commit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTo0MToyN1rOF0Uzew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTo1NzozNFrOF0VjOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxMTEzMQ==", "bodyText": "Please update class description to indicate that it can be hardware accelerated.", "url": "https://github.com/vespa-engine/vespa/pull/12527#discussion_r390411131", "createdAt": "2020-03-10T15:41:27Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/tensor/distance_functions.h", "diffHunk": "@@ -13,66 +14,20 @@ namespace search::tensor {\n template <typename FloatType>\n class SquaredEuclideanDistance : public DistanceFunction {\n public:\n+    SquaredEuclideanDistance()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxMTQ5MQ==", "bodyText": "Please use new copyright", "url": "https://github.com/vespa-engine/vespa/pull/12527#discussion_r390411491", "createdAt": "2020-03-10T15:41:53Z", "author": {"login": "geirst"}, "path": "vespalib/src/tests/hwaccelrated/CMakeLists.txt", "diffHunk": "@@ -0,0 +1,8 @@\n+# Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxMTY2OA==", "bodyText": "Please use new copyright", "url": "https://github.com/vespa-engine/vespa/pull/12527#discussion_r390411668", "createdAt": "2020-03-10T15:42:08Z", "author": {"login": "geirst"}, "path": "vespalib/src/tests/hwaccelrated/hwaccelrated_test.cpp", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxMjQ5MQ==", "bodyText": "Typo: \"Euclidian\" -> \"Euclidean\"", "url": "https://github.com/vespa-engine/vespa/pull/12527#discussion_r390412491", "createdAt": "2020-03-10T15:43:11Z", "author": {"login": "geirst"}, "path": "vespalib/src/tests/hwaccelrated/hwaccelrated_test.cpp", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <vespa/vespalib/testkit/test_kit.h>\n+#include <vespa/vespalib/hwaccelrated/iaccelrated.h>\n+#include <vespa/vespalib/hwaccelrated/generic.h>\n+\n+using namespace vespalib;\n+\n+template<typename T>\n+std::vector<T> createAndFill(size_t sz) {\n+    std::vector<T> v(sz);\n+    for (size_t i(0); i < sz; i++) {\n+        v[i] = i;\n+    }\n+    return v;\n+}\n+\n+template<typename T>\n+void verifyEuclidianDistance(const hwaccelrated::IAccelrated & accel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxMzI4MA==", "bodyText": "Typo: \"euclidian\" -> \"euclidean\"", "url": "https://github.com/vespa-engine/vespa/pull/12527#discussion_r390413280", "createdAt": "2020-03-10T15:44:11Z", "author": {"login": "geirst"}, "path": "vespalib/src/tests/hwaccelrated/hwaccelrated_test.cpp", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <vespa/vespalib/testkit/test_kit.h>\n+#include <vespa/vespalib/hwaccelrated/iaccelrated.h>\n+#include <vespa/vespalib/hwaccelrated/generic.h>\n+\n+using namespace vespalib;\n+\n+template<typename T>\n+std::vector<T> createAndFill(size_t sz) {\n+    std::vector<T> v(sz);\n+    for (size_t i(0); i < sz; i++) {\n+        v[i] = i;\n+    }\n+    return v;\n+}\n+\n+template<typename T>\n+void verifyEuclidianDistance(const hwaccelrated::IAccelrated & accel) {\n+    const size_t testLength(255);\n+    std::vector<T> a = createAndFill<T>(testLength);\n+    std::vector<T> b = createAndFill<T>(testLength);\n+    for (size_t j(0); j < 0x20; j++) {\n+        T sum(0);\n+        for (size_t i(j); i < testLength; i++) {\n+            sum += (a[i] - b[i]) * (a[i] - b[i]);\n+        }\n+        T hwComputedSum(accel.squaredEuclidianDistance(&a[j], &b[j], testLength - j));\n+        EXPECT_EQUAL (sum, hwComputedSum);\n+    }\n+}\n+\n+TEST(\"test euclidian distance\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxNDAxNw==", "bodyText": "Typo: \"Euclidian\" -> \"Euclidean\". This applies else where as well.", "url": "https://github.com/vespa-engine/vespa/pull/12527#discussion_r390414017", "createdAt": "2020-03-10T15:45:12Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/hwaccelrated/avx2.cpp", "diffHunk": "@@ -10,4 +10,14 @@ Avx2Accelrator::populationCount(const uint64_t *a, size_t sz) const {\n     return helper::populationCount(a, sz);\n }\n \n+double\n+Avx2Accelrator::squaredEuclidianDistance(const float * a, const float * b, size_t sz) const {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMjkyOA==", "bodyText": "Consider using different data for vectors a and b. Now they are equal, and the difference between them are always 0 -> the squared euclidean distance is 0.", "url": "https://github.com/vespa-engine/vespa/pull/12527#discussion_r390422928", "createdAt": "2020-03-10T15:57:00Z", "author": {"login": "geirst"}, "path": "vespalib/src/tests/hwaccelrated/hwaccelrated_test.cpp", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <vespa/vespalib/testkit/test_kit.h>\n+#include <vespa/vespalib/hwaccelrated/iaccelrated.h>\n+#include <vespa/vespalib/hwaccelrated/generic.h>\n+\n+using namespace vespalib;\n+\n+template<typename T>\n+std::vector<T> createAndFill(size_t sz) {\n+    std::vector<T> v(sz);\n+    for (size_t i(0); i < sz; i++) {\n+        v[i] = i;\n+    }\n+    return v;\n+}\n+\n+template<typename T>\n+void verifyEuclidianDistance(const hwaccelrated::IAccelrated & accel) {\n+    const size_t testLength(255);\n+    std::vector<T> a = createAndFill<T>(testLength);\n+    std::vector<T> b = createAndFill<T>(testLength);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMzM1NA==", "bodyText": "Consider using different data for vectors a and b. Now they are equal, and the difference between them are always 0 -> the squared euclidean distance is 0.", "url": "https://github.com/vespa-engine/vespa/pull/12527#discussion_r390423354", "createdAt": "2020-03-10T15:57:34Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/hwaccelrated/iaccelrated.cpp", "diffHunk": "@@ -65,8 +62,24 @@ void verifyAccelrator(const IAccelrated & accel)\n             LOG_ABORT(\"should not be reached\");\n         }\n     }\n-    delete [] a;\n-    delete [] b;\n+}\n+\n+template<typename T>\n+void verifyEuclidianDistance(const IAccelrated & accel) {\n+    const size_t testLength(255);\n+    std::vector<T> a = createAndFill<T>(testLength);\n+    std::vector<T> b = createAndFill<T>(testLength);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03bd3b755650d828e63458379d5c120da63d7221"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d52222315d29507930750941e268491ade98934", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/8d52222315d29507930750941e268491ade98934", "committedDate": "2020-03-10T20:09:22Z", "message": "Followup from code review.\n- Update copyright\n- euclidian -> euclidean\n- better testdata."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzM1Njg3", "url": "https://github.com/vespa-engine/vespa/pull/12527#pullrequestreview-372335687", "createdAt": "2020-03-10T21:29:48Z", "commit": {"oid": "8d52222315d29507930750941e268491ade98934"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2645, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}