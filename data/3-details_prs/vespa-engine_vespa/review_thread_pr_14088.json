{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NDYyMTA1", "number": 14088, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozMzo1MVrOEbhshQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxODowOFrOEbih7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3Mjk5MDc3OnYy", "diffSide": "RIGHT", "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozMzo1MVrOHFgbwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozMzo1MVrOHFgbwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNjMyMg==", "bodyText": "Add javadoc and author. Quota for what? \ud83d\ude42", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475536322", "createdAt": "2020-08-24T11:33:51Z", "author": {"login": "mpolden"}, "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.yahoo.config.model.api;\n+\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.slime.SlimeUtils;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+public class Quota {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3Mjk5NDY2OnYy", "diffSide": "RIGHT", "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozNTowM1rOHFgeCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozNTowM1rOHFgeCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNjkwNQ==", "bodyText": "Nit: Consider OptionalInt.", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475536905", "createdAt": "2020-08-24T11:35:03Z", "author": {"login": "mpolden"}, "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.yahoo.config.model.api;\n+\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.slime.SlimeUtils;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+public class Quota {\n+    private final Optional<Integer> maxClusterSize;\n+    private final Optional<Integer> budget;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3Mjk5NjQzOnYy", "diffSide": "RIGHT", "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozNTo0MlrOHFgfMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozNTo0MlrOHFgfMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNzIwMw==", "bodyText": "IllegalArgumentException?", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475537203", "createdAt": "2020-08-24T11:35:42Z", "author": {"login": "mpolden"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.deploy.DeployState;\n+import com.yahoo.config.provision.ClusterSpec;\n+import com.yahoo.vespa.model.VespaModel;\n+\n+import java.util.stream.Collectors;\n+\n+public class QuotaValidator extends Validator {\n+    @Override\n+    public void validate(VespaModel model, DeployState deployState) {\n+        var quota = deployState.getProperties().quota();\n+        quota.maxClusterSize().ifPresent(maxClusterSize -> validateMaxClusterSize(maxClusterSize, model));\n+    }\n+\n+    private void validateMaxClusterSize(int maxClusterSize, VespaModel model) {\n+        var invalidClusters = model.allClusters().stream()\n+                .filter(clusterId -> {\n+                    var cluster = model.provisioned().all().get(clusterId);\n+                    var clusterSize = cluster.maxResources().nodes();\n+                    return clusterSize > maxClusterSize;\n+                })\n+                .map(ClusterSpec.Id::value)\n+                .collect(Collectors.toList());\n+\n+        if (!invalidClusters.isEmpty()) {\n+            // TODO(ogronnesby): Find better exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MzEyMTA4OnYy", "diffSide": "RIGHT", "path": "vespajlib/src/main/java/com/yahoo/slime/SlimeUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNjoxMlrOHFhqHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNjoxMlrOHFhqHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NjM4Mg==", "bodyText": "Nit: Consider OptionalLong.", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475556382", "createdAt": "2020-08-24T12:16:12Z", "author": {"login": "mpolden"}, "path": "vespajlib/src/main/java/com/yahoo/slime/SlimeUtils.java", "diffHunk": "@@ -124,6 +124,13 @@ public static Slime jsonToSlimeOrThrow(byte[] json) {\n         return Optional.of(inspector.asString()).filter(s -> !s.isEmpty());\n     }\n \n+    public static Optional<Long> optionalLong(Inspector inspector) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "257f4b21f4755efc29e51738e919029610e04e98"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MzEyNDUyOnYy", "diffSide": "RIGHT", "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNzoxMlrOHFhsKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNzoxMlrOHFhsKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NjkwNQ==", "bodyText": "Add javadoc and author.", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475556905", "createdAt": "2020-08-24T12:17:12Z", "author": {"login": "mpolden"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.deploy.DeployState;\n+import com.yahoo.config.provision.ClusterSpec;\n+import com.yahoo.vespa.model.VespaModel;\n+\n+import java.util.stream.Collectors;\n+\n+public class QuotaValidator extends Validator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "257f4b21f4755efc29e51738e919029610e04e98"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MzEyNzQ4OnYy", "diffSide": "RIGHT", "path": "config-model/src/test/java/com/yahoo/vespa/model/application/validation/QuotaValidatorTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxODowOVrOHFhuAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxODowOVrOHFhuAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NzM3Ng==", "bodyText": "Missing author.", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475557376", "createdAt": "2020-08-24T12:18:09Z", "author": {"login": "mpolden"}, "path": "config-model/src/test/java/com/yahoo/vespa/model/application/validation/QuotaValidatorTest.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.api.Quota;\n+import com.yahoo.config.model.deploy.TestProperties;\n+import com.yahoo.config.provision.Environment;\n+import org.junit.Test;\n+\n+import java.util.Optional;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class QuotaValidatorTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "257f4b21f4755efc29e51738e919029610e04e98"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1463, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}