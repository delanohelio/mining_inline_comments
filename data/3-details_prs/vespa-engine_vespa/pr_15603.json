{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMDQyODAw", "number": 15603, "title": "jonmv/document and test dynamic throttling policy", "bodyText": "@baldersheim and @vekterli see if this makes sense to you :) The first commit is actually a bugfix from the previous PR \ud83d\ude2c", "createdAt": "2020-12-02T14:09:56Z", "url": "https://github.com/vespa-engine/vespa/pull/15603", "merged": true, "mergeCommit": {"oid": "a41bfa1b7c7e02ee90de60ce19a7fb199998bb89"}, "closed": true, "closedAt": "2020-12-03T14:51:10Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiPI9EgH2gAyNTMxMDQyODAwOjI0NjE1MjNhY2EzOWI1YWYzYjViYWZlZjQ0ZTUxYzdiYjEzYmU3NmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdikRIIgH2gAyNTMxMDQyODAwOjNhYmRiMzUxMjhjZTk4ZjJkZDBjZjJkZmViMzY0OTRjZjhhNjA2ODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2461523aca39b5af3b5bafef44e51c7bb13be76b", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/2461523aca39b5af3b5bafef44e51c7bb13be76b", "committedDate": "2020-12-02T14:09:01Z", "message": "Fix parentheses in carry expression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac5041033b8782e2cb8b1f64f880f004c510bea6", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/ac5041033b8782e2cb8b1f64f880f004c510bea6", "committedDate": "2020-12-02T14:09:25Z", "message": "Add unit tests and some doc for DynamicThrottlingPolicy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNzQzNjIz", "url": "https://github.com/vespa-engine/vespa/pull/15603#pullrequestreview-543743623", "createdAt": "2020-12-03T09:12:44Z", "commit": {"oid": "ac5041033b8782e2cb8b1f64f880f004c510bea6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOToxMjo0NVrOH-M1CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOToxMjo0NVrOH-M1CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk4Mzk0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * which satisfy <code>log10(1 / latency) % 1 = e</code>, for some constant <code>0 < e < 1</code>. Weird? Most certainly!\n          \n          \n            \n             * which satisfy <code>log10(1 / latency) % 1 = e</code>, for some constant <code>0 &lt; e &lt; 1</code>. Weird? Most certainly!", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r534983945", "createdAt": "2020-12-03T09:12:45Z", "author": {"login": "jonmv"}, "path": "messagebus/src/main/java/com/yahoo/messagebus/DynamicThrottlePolicy.java", "diffHunk": "@@ -8,11 +8,43 @@\n \n /**\n  * This is an implementation of the {@link ThrottlePolicy} that offers dynamic limits to the number of pending messages a\n- * {@link SourceSession} is allowed to have.\n- *\n- * <b>NOTE:</b> By context, \"pending\" is referring to the number of sent messages that have not been replied to yet.\n+ * {@link SourceSession} is allowed to have. Pending means the number of sent messages that have not been replied to yet.\n+ * <p>\n+ * The algorithm works by increasing the number of messages allowed to be pending, the <em>winidow size</em>, until\n+ * this no longer increases throughput. At this point, the algorithm is driven by synthetic attraction towards latencies\n+ * which satisfy <code>log10(1 / latency) % 1 = e</code>, for some constant <code>0 < e < 1</code>. Weird? Most certainly!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac5041033b8782e2cb8b1f64f880f004c510bea6"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7005bf273d8ed242dcecd7775e5982262192ffbb", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/7005bf273d8ed242dcecd7775e5982262192ffbb", "committedDate": "2020-12-03T09:12:59Z", "message": "fix javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODY4NzIw", "url": "https://github.com/vespa-engine/vespa/pull/15603#pullrequestreview-543868720", "createdAt": "2020-12-03T11:41:01Z", "commit": {"oid": "7005bf273d8ed242dcecd7775e5982262192ffbb"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMTo0MTowMVrOH-Wslg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjoxMjo1MlrOH-Yi8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE0NTYyMg==", "bodyText": "s/winidow/window", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r535145622", "createdAt": "2020-12-03T11:41:01Z", "author": {"login": "vekterli"}, "path": "messagebus/src/main/java/com/yahoo/messagebus/DynamicThrottlePolicy.java", "diffHunk": "@@ -8,11 +8,43 @@\n \n /**\n  * This is an implementation of the {@link ThrottlePolicy} that offers dynamic limits to the number of pending messages a\n- * {@link SourceSession} is allowed to have.\n- *\n- * <b>NOTE:</b> By context, \"pending\" is referring to the number of sent messages that have not been replied to yet.\n+ * {@link SourceSession} is allowed to have. Pending means the number of sent messages that have not been replied to yet.\n+ * <p>\n+ * The algorithm works by increasing the number of messages allowed to be pending, the <em>winidow size</em>, until", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7005bf273d8ed242dcecd7775e5982262192ffbb"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3NTkyMA==", "bodyText": "This is probably not intended to be included", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r535175920", "createdAt": "2020-12-03T12:12:52Z", "author": {"login": "vekterli"}, "path": "messagebus/src/main/java/com/yahoo/messagebus/DynamicThrottlePolicy.java", "diffHunk": "@@ -96,30 +129,31 @@ public void processMessage(Message message) {\n         numSent = 0;\n         numOk = 0;\n \n-\n         if (maxThroughput > 0 && throughput > maxThroughput * 0.95) {\n             // No need to increase window when we're this close to max.\n-        } else if (throughput >= localMaxThroughput) {\n+            // TODO jonmv: Not so sure \u2014 what if we're too high, and should back off?\n+        } else if (throughput > localMaxThroughput) {\n             localMaxThroughput = throughput;\n-            windowSize += weight*windowSizeIncrement;\n+            windowSize += weight * windowSizeIncrement;\n             if (log.isLoggable(Level.FINE)) {\n                 log.log(Level.FINE, \"windowSize \" + windowSize + \" throughput \" + throughput + \" local max \" + localMaxThroughput);\n             }\n         } else {\n             // scale up/down throughput for comparing to window size\n             double period = 1;\n-            while(throughput * period/windowSize < 2) {\n+            while(throughput * period / windowSize < 2) {\n                 period *= 10;\n             }\n-            while(throughput * period/windowSize > 2) {\n+            while(throughput * period / windowSize > 2) {\n                 period *= 0.1;\n             }\n-            double efficiency = throughput*period/windowSize;\n+            double efficiency = throughput * period / windowSize; // \"efficiency\" is a strange name. This is where on the level it is.\n+            if (Math.random() < 1e-2) System.err.println(efficiency);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7005bf273d8ed242dcecd7775e5982262192ffbb"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3abdb35128ce98f2dd0cf2dfeb36494cf8a60687", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/3abdb35128ce98f2dd0cf2dfeb36494cf8a60687", "committedDate": "2020-12-03T14:45:57Z", "message": "Apply suggestions from code review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1843, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}