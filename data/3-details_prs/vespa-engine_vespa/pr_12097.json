{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxOTMwNTI2", "number": 12097, "title": "Implement wrapper for std::atomic of type EntryRef and use it in hnsw\u2026", "bodyText": "\u2026 index to get snapshotting of level arrays.\n@vekterli please review\n@arnej27959 @toregge FYI", "createdAt": "2020-02-06T14:31:29Z", "url": "https://github.com/vespa-engine/vespa/pull/12097", "merged": true, "mergeCommit": {"oid": "608945b66ac4392c94b58fed4232254bdd7ddcee"}, "closed": true, "closedAt": "2020-02-07T06:42:45Z", "author": {"login": "geirst"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBrlovAH2gAyMzcxOTMwNTI2Ojk3MTI5MDMzMjAyZGFkYWY0MzYxNWE4YjU1YzM1ZjI4NDk3OWZhNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBssJbgFqTM1NDU1Mzc1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "97129033202dadaf43615a8b55c35f284979fa65", "author": {"user": {"login": "geirst", "name": "Geir Storli"}}, "url": "https://github.com/vespa-engine/vespa/commit/97129033202dadaf43615a8b55c35f284979fa65", "committedDate": "2020-02-06T14:27:02Z", "message": "Implement wrapper for std::atomic of type EntryRef and use it in hnsw index to get snapshotting of level arrays."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTUzNzU5", "url": "https://github.com/vespa-engine/vespa/pull/12097#pullrequestreview-354553759", "createdAt": "2020-02-06T15:43:57Z", "commit": {"oid": "97129033202dadaf43615a8b55c35f284979fa65"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNTo0Mzo1OFrOFmf5Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNTo0Mzo1OFrOFmf5Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkxMjc3MA==", "bodyText": "If this is always invoked from the writer thread, it's technically sufficient to use a load_relaxed() here since the changes to these structures shall always be visible to that thread anyway. But acquire loads are almost free on x86-64 anyway, so it's hardly something to prematurely optimize for.", "url": "https://github.com/vespa-engine/vespa/pull/12097#discussion_r375912770", "createdAt": "2020-02-06T15:43:58Z", "author": {"login": "vekterli"}, "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index_base.cpp", "diffHunk": "@@ -65,18 +64,16 @@ HnswIndexBase::get_link_array(uint32_t docid, uint32_t level) const\n {\n     auto levels = get_level_array(docid);\n     assert(level < levels.size());\n-    return _links.get(levels[level]);\n+    return _links.get(levels[level].load_acquire());\n }\n \n void\n HnswIndexBase::set_link_array(uint32_t docid, uint32_t level, const LinkArrayRef& links)\n {\n     auto links_ref = _links.add(links);\n-    // TODO: Add memory barrier?\n-    auto node_ref = _node_refs[docid];\n+    auto node_ref = _node_refs[docid].load_acquire();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97129033202dadaf43615a8b55c35f284979fa65"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3038, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}