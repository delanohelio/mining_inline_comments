{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NDk3NTM3", "number": 13930, "title": "Bjorncs/validate binding patterns", "bodyText": "FYI @oyving", "createdAt": "2020-07-21T13:16:06Z", "url": "https://github.com/vespa-engine/vespa/pull/13930", "merged": true, "mergeCommit": {"oid": "88e293db7cb6480d6970511350fc18709309b2c1"}, "closed": true, "closedAt": "2020-08-17T20:28:53Z", "author": {"login": "bjorncs"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-JzEngFqTQ2NTczNjUxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_4b4fgFqTQ2ODgxMDAwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NzM2NTE2", "url": "https://github.com/vespa-engine/vespa/pull/13930#pullrequestreview-465736516", "createdAt": "2020-08-12T09:16:53Z", "commit": {"oid": "374987be381aeeca38d77325549b68bdb4118f11"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwOToxNjo1M1rOG_Y7gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMToyMjoxMFrOG_c5_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEyMTkyMA==", "bodyText": "I suggest to use an enum instead, e.g. Type with values USER and MODEL (or SYSTEM). It usually improves the quality of code using it, and can easily be extended with more values later. Too many times have we used a flag and later wanted to add a third, or more, values.\nAlternatively, perhaps you could create two subclasses UserBindingPattern and SystemBindingPattern, if the two need separate handling anyway. The method names for the static factory methods also indicate that there is something fishy with the modelling here.", "url": "https://github.com/vespa-engine/vespa/pull/13930#discussion_r469121920", "createdAt": "2020-08-12T09:16:53Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/component/BindingPattern.java", "diffHunk": "@@ -0,0 +1,127 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.model.container.component;\n+\n+import java.util.Comparator;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * URI binding pattern used by filter and handler bindings.\n+ *\n+ * There are two types of binding; user generated and model generated bindings.\n+ * - User generated bindings are bindings which are constructed from directly from 'binding' elements from services.xml\n+ * - Model generated bindings are binding which are implicitly constructed by the model, e.g built-in handlers.\n+ *\n+ * @author bjorncs\n+ */\n+public class BindingPattern implements Comparable<BindingPattern> {\n+\n+    private static final Pattern BINDING_PATTERN =\n+            Pattern.compile(\"([^:]+)://([^:/]+)(:((\\\\*)|([0-9]+)))?(/.*)\", Pattern.UNICODE_CASE | Pattern.CANON_EQ);\n+\n+    private final String scheme;\n+    private final String host;\n+    private final String port;\n+    private final String path;\n+    private final boolean isUserGenerated;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "374987be381aeeca38d77325549b68bdb4118f11"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEyNzkxMg==", "bodyText": "Suggest to say: \"Path must have '/' as prefix:\"", "url": "https://github.com/vespa-engine/vespa/pull/13930#discussion_r469127912", "createdAt": "2020-08-12T09:27:08Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/component/BindingPattern.java", "diffHunk": "@@ -0,0 +1,127 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.model.container.component;\n+\n+import java.util.Comparator;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * URI binding pattern used by filter and handler bindings.\n+ *\n+ * There are two types of binding; user generated and model generated bindings.\n+ * - User generated bindings are bindings which are constructed from directly from 'binding' elements from services.xml\n+ * - Model generated bindings are binding which are implicitly constructed by the model, e.g built-in handlers.\n+ *\n+ * @author bjorncs\n+ */\n+public class BindingPattern implements Comparable<BindingPattern> {\n+\n+    private static final Pattern BINDING_PATTERN =\n+            Pattern.compile(\"([^:]+)://([^:/]+)(:((\\\\*)|([0-9]+)))?(/.*)\", Pattern.UNICODE_CASE | Pattern.CANON_EQ);\n+\n+    private final String scheme;\n+    private final String host;\n+    private final String port;\n+    private final String path;\n+    private final boolean isUserGenerated;\n+\n+    private BindingPattern(\n+            String scheme,\n+            String host,\n+            String port,\n+            String path,\n+            boolean isUserGenerated) {\n+        this.scheme = Objects.requireNonNull(scheme, \"Scheme in binding must be specified\");\n+        this.host = Objects.requireNonNull(host, \"Host must be specified\");\n+        this.port = port;\n+        this.path = validatePath(path);\n+        this.isUserGenerated = isUserGenerated;\n+    }\n+\n+    private static String validatePath(String path) {\n+        Objects.requireNonNull(path, \"Path must be specified\");\n+        if (!path.startsWith(\"/\")) throw new IllegalArgumentException(\"Path has not '/' as prefix: \" + path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "374987be381aeeca38d77325549b68bdb4118f11"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE3MTY0OA==", "bodyText": "Why is this better than the above?", "url": "https://github.com/vespa-engine/vespa/pull/13930#discussion_r469171648", "createdAt": "2020-08-12T10:48:48Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/builder/xml/dom/DomHandlerBuilder.java", "diffHunk": "@@ -27,11 +28,14 @@\n  */\n public class DomHandlerBuilder extends VespaDomBuilder.DomConfigProducerBuilder<Handler> {\n \n-    private static final Set<String> reservedBindings = Set.of(METRICS_V2_HANDLER_BINDING_1,\n-                                                               METRICS_V2_HANDLER_BINDING_2,\n-                                                               STATE_HANDLER_BINDING_1,\n-                                                               STATE_HANDLER_BINDING_2,\n-                                                               VIP_HANDLER_BINDING);\n+    private static final Set<BindingPattern> reservedBindings =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab28e4eb6e67d13dce275d9d652fa833834ee0a1"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4NzA3MA==", "bodyText": "These method names are rather clunky. Perhaps it would be better to have just two methods that take the type as an extra argument?\nfromPattern(String pattern, Type type)\nfromHttpPath(String path, Type type)", "url": "https://github.com/vespa-engine/vespa/pull/13930#discussion_r469187070", "createdAt": "2020-08-12T11:22:10Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/component/BindingPattern.java", "diffHunk": "@@ -0,0 +1,127 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.model.container.component;\n+\n+import java.util.Comparator;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * URI binding pattern used by filter and handler bindings.\n+ *\n+ * There are two types of binding; user generated and model generated bindings.\n+ * - User generated bindings are bindings which are constructed from directly from 'binding' elements from services.xml\n+ * - Model generated bindings are binding which are implicitly constructed by the model, e.g built-in handlers.\n+ *\n+ * @author bjorncs\n+ */\n+public class BindingPattern implements Comparable<BindingPattern> {\n+\n+    private static final Pattern BINDING_PATTERN =\n+            Pattern.compile(\"([^:]+)://([^:/]+)(:((\\\\*)|([0-9]+)))?(/.*)\", Pattern.UNICODE_CASE | Pattern.CANON_EQ);\n+\n+    private final String scheme;\n+    private final String host;\n+    private final String port;\n+    private final String path;\n+    private final boolean isUserGenerated;\n+\n+    private BindingPattern(\n+            String scheme,\n+            String host,\n+            String port,\n+            String path,\n+            boolean isUserGenerated) {\n+        this.scheme = Objects.requireNonNull(scheme, \"Scheme in binding must be specified\");\n+        this.host = Objects.requireNonNull(host, \"Host must be specified\");\n+        this.port = port;\n+        this.path = validatePath(path);\n+        this.isUserGenerated = isUserGenerated;\n+    }\n+\n+    private static String validatePath(String path) {\n+        Objects.requireNonNull(path, \"Path must be specified\");\n+        if (!path.startsWith(\"/\")) throw new IllegalArgumentException(\"Path has not '/' as prefix: \" + path);\n+        return path;\n+    }\n+\n+    public static BindingPattern createUserGeneratedFromPattern(String pattern) {\n+        return createFromBindingString(pattern, true);\n+    }\n+\n+    public static BindingPattern createUserGeneratedFromHttpPath(String path) {\n+        return new BindingPattern(\"http\", \"*\", null, path, true);\n+    }\n+\n+    public static BindingPattern createModelGeneratedFromPattern(String pattern) {\n+        return createFromBindingString(pattern, false);\n+    }\n+\n+    public static BindingPattern createModelGeneratedFromHttpPath(String path) {\n+        return new BindingPattern(\"http\", \"*\", null, path, false);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "374987be381aeeca38d77325549b68bdb4118f11"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74b5e43ba17c43db561b24c798728c0a20e10057", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/74b5e43ba17c43db561b24c798728c0a20e10057", "committedDate": "2020-08-17T14:59:29Z", "message": "Introduce type for binding patterns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66778f6a74fe71970a5470cb139b02e752ec516", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/d66778f6a74fe71970a5470cb139b02e752ec516", "committedDate": "2020-08-17T15:01:29Z", "message": "Rename 'Binding' -> 'FilterBinding'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b4dfeb835e43b852858cb128e512219270d7f93", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/4b4dfeb835e43b852858cb128e512219270d7f93", "committedDate": "2020-08-17T15:01:32Z", "message": "Remove unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ead8d2122f052436f5d38771df5db68483e10989", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/ead8d2122f052436f5d38771df5db68483e10989", "committedDate": "2020-08-17T15:04:17Z", "message": "Use BindingPattern to represent all types of binding in config model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cd0d218e9528c24cf5ac2a521e37211aa6aeb1f", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/9cd0d218e9528c24cf5ac2a521e37211aa6aeb1f", "committedDate": "2020-08-17T15:04:19Z", "message": "Restrict uri bindings for hosted applications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8b585399b9509a214204fd2450a5d5997dd18e4", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/b8b585399b9509a214204fd2450a5d5997dd18e4", "committedDate": "2020-08-17T15:04:19Z", "message": "Remove logging on https scheme from FilterBinding\n\nThis warning is now produced by UriBindingsValidator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94f7cec36cb97af2a4be9bdbe087ebe857b53db8", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/94f7cec36cb97af2a4be9bdbe087ebe857b53db8", "committedDate": "2020-08-17T15:04:19Z", "message": "Allow 'https' in scheme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efd4542b717f01798aac9dab6dc84d3f6862b9cb", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/efd4542b717f01798aac9dab6dc84d3f6862b9cb", "committedDate": "2020-08-17T15:04:19Z", "message": "Model user-generated and non user-generated bindings as separate sub-classes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd9c21734f384996cf9bd69ce05d0f13cc3b14e4", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/bd9c21734f384996cf9bd69ce05d0f13cc3b14e4", "committedDate": "2020-07-21T14:11:52Z", "message": "Allow 'https' in scheme"}, "afterCommit": {"oid": "efd4542b717f01798aac9dab6dc84d3f6862b9cb", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/efd4542b717f01798aac9dab6dc84d3f6862b9cb", "committedDate": "2020-08-17T15:04:19Z", "message": "Model user-generated and non user-generated bindings as separate sub-classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d8292d5cad64124c2cd889fa393a973c1d98d73", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/5d8292d5cad64124c2cd889fa393a973c1d98d73", "committedDate": "2020-08-17T15:08:16Z", "message": "Improve error message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4ODEwMDAw", "url": "https://github.com/vespa-engine/vespa/pull/13930#pullrequestreview-468810000", "createdAt": "2020-08-17T20:28:27Z", "commit": {"oid": "5d8292d5cad64124c2cd889fa393a973c1d98d73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3471, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}