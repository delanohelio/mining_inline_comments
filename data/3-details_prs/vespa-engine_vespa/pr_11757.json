{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMDc5MjI2", "number": 11757, "title": "Avoid checking every node when setting upgrade target", "bodyText": "Same as #11706, with one additional commit.", "createdAt": "2020-01-13T11:55:58Z", "url": "https://github.com/vespa-engine/vespa/pull/11757", "merged": true, "mergeCommit": {"oid": "09ddc9f27f81d8f1c4933cd2b6f8c7d8622372c4"}, "closed": true, "closedAt": "2020-01-13T13:31:38Z", "author": {"login": "mpolden"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb56VtSgH2gAyMzYyMDc5MjI2OjJmOWRmNzZjMGFiZDQ0N2YyYjcxNmU1NzdlYTI5NTZjNmJmYWZiZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb58GxngFqTM0MTgzMTAxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2f9df76c0abd447f2b716e577ea2956c6bfafbd7", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/2f9df76c0abd447f2b716e577ea2956c6bfafbd7", "committedDate": "2020-01-13T11:06:49Z", "message": "Avoid checking every node when setting upgrade target"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dccc1f6412808b4c10adbe8d109724c3899ff24", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/7dccc1f6412808b4c10adbe8d109724c3899ff24", "committedDate": "2020-01-13T11:06:54Z", "message": "Rename method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d93fb0f9f0642af57ebfb74e5af0a678c12f45a", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/2d93fb0f9f0642af57ebfb74e5af0a678c12f45a", "committedDate": "2020-01-13T11:06:58Z", "message": "Rename field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d6bf49ec54cf76a1c252d57a7fe65b64444e695", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/6d6bf49ec54cf76a1c252d57a7fe65b64444e695", "committedDate": "2020-01-13T11:54:56Z", "message": "Do not deploy routing application if no nodes are allocated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxODMxMDE1", "url": "https://github.com/vespa-engine/vespa/pull/11757#pullrequestreview-341831015", "createdAt": "2020-01-13T13:10:05Z", "commit": {"oid": "6d6bf49ec54cf76a1c252d57a7fe65b64444e695"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzoxMDowNlrOFc2U3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzoxMDowNlrOFc2U3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5NDUyNQ==", "bodyText": "I guess this would make it impossible to set up a new zone with a routing app, unless this was manually deployed first to give the application some nodes ... ? But that probably doesn't matter.", "url": "https://github.com/vespa-engine/vespa/pull/11757#discussion_r365794525", "createdAt": "2020-01-13T13:10:06Z", "author": {"login": "jonmv"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/SystemUpgrader.java", "diffHunk": "@@ -63,8 +63,14 @@ protected boolean shouldUpgrade(Version target, SystemApplication application, Z\n             // For applications with package we do not have a zone-wide version target. This means that we must check\n             // the wanted version of each node.\n             return minVersion(zone, application, Node::wantedVersion)\n-                    .map(target::isAfter)                                     // Upgrade if target is after any wanted version\n-                    .orElse(true);                                            // Upgrade if there are no nodes allocated\n+                    // Upgrade if target is after any wanted version\n+                    .map(target::isAfter)\n+                    // Skip upgrade if there are no nodes allocated. This is overloaded to mean that the zone is not\n+                    // expected to have a deployment of this application.\n+                    // TODO(mpolden): Once all zones are either directly routed or not: Change this to\n+                    //                always deploy proxy app and wait for convergence in zones that are not directly\n+                    //                routed.\n+                    .orElse(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d6bf49ec54cf76a1c252d57a7fe65b64444e695"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3997, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}