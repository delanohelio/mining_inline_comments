{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MjE4Njg0", "number": 15399, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNjoxNDozOVrOE7ZPbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNjoxOToxMFrOE7ZYNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzE0OTg5OnYy", "diffSide": "RIGHT", "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNjoxNDozOVrOH3BJvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODoyMTo1N1rOH3FGuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MjYwNQ==", "bodyText": "Given this usage, I think it would be simpler to just put validationId on ConfigChangeAction as an Optional.", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527452605", "createdAt": "2020-11-20T06:14:39Z", "author": {"login": "bratseth"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "diffHunk": "@@ -99,9 +105,17 @@\n                 new ContainerRestartValidator(),\n                 new NodeResourceChangeValidator()\n         };\n-        return Arrays.stream(validators)\n-                .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n-                .collect(toList());\n+        List<ConfigChangeAction> actions = Arrays.stream(validators)\n+                                                 .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n+                                                 .collect(toList());\n+        overrides.invalid(actions.stream()\n+                                 .filter(DisallowableConfigChangeAction.class::isInstance)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ4MDc0Nw==", "bodyText": "I suppose that's equally not super-obvious, but good enough, and a bit simpler, yes. Can't even remember why I didn't do this. Probably no good reason. It's \"you must provide a validatoin id for implementations which may block deployment\", in any case.", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527480747", "createdAt": "2020-11-20T07:07:24Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "diffHunk": "@@ -99,9 +105,17 @@\n                 new ContainerRestartValidator(),\n                 new NodeResourceChangeValidator()\n         };\n-        return Arrays.stream(validators)\n-                .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n-                .collect(toList());\n+        List<ConfigChangeAction> actions = Arrays.stream(validators)\n+                                                 .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n+                                                 .collect(toList());\n+        overrides.invalid(actions.stream()\n+                                 .filter(DisallowableConfigChangeAction.class::isInstance)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MjYwNQ=="}, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ4NTA2Mg==", "bodyText": "Ah, so it's because making it optional makes you have to .get() or .orElseThrow() to get the name() in the child interfaces, which is ugly. It's clearer with a separate interface, although more verbose.", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527485062", "createdAt": "2020-11-20T07:18:53Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "diffHunk": "@@ -99,9 +105,17 @@\n                 new ContainerRestartValidator(),\n                 new NodeResourceChangeValidator()\n         };\n-        return Arrays.stream(validators)\n-                .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n-                .collect(toList());\n+        List<ConfigChangeAction> actions = Arrays.stream(validators)\n+                                                 .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n+                                                 .collect(toList());\n+        overrides.invalid(actions.stream()\n+                                 .filter(DisallowableConfigChangeAction.class::isInstance)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MjYwNQ=="}, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUxNzM2OQ==", "bodyText": "Should just remove the allowed() altogether, since it no longer serves a purpose with these changes. Guess there'' be some more work here, then ...", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527517369", "createdAt": "2020-11-20T08:21:57Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "diffHunk": "@@ -99,9 +105,17 @@\n                 new ContainerRestartValidator(),\n                 new NodeResourceChangeValidator()\n         };\n-        return Arrays.stream(validators)\n-                .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n-                .collect(toList());\n+        List<ConfigChangeAction> actions = Arrays.stream(validators)\n+                                                 .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n+                                                 .collect(toList());\n+        overrides.invalid(actions.stream()\n+                                 .filter(DisallowableConfigChangeAction.class::isInstance)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MjYwNQ=="}, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzE2ODI0OnYy", "diffSide": "RIGHT", "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNjoxODoyMVrOH3BW8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNzoxMDozMVrOH3C8Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1NTk4NQ==", "bodyText": "Just to repeat my standard comment to your code: These stream statements that does everything are like a long sentence with lots of subsentences. It's easier to read shorter sentences, especially since it makes you name the thing they produce.", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527455985", "createdAt": "2020-11-20T06:18:21Z", "author": {"login": "bratseth"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "diffHunk": "@@ -99,9 +105,17 @@\n                 new ContainerRestartValidator(),\n                 new NodeResourceChangeValidator()\n         };\n-        return Arrays.stream(validators)\n-                .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n-                .collect(toList());\n+        List<ConfigChangeAction> actions = Arrays.stream(validators)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ4MTk0Ng==", "bodyText": "But.\nI.\nLike.\nLong.\nSentences.\nI appreciate your comment on this; you're probably not the only one, so I will try to adjust for readability.", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527481946", "createdAt": "2020-11-20T07:10:31Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/Validation.java", "diffHunk": "@@ -99,9 +105,17 @@\n                 new ContainerRestartValidator(),\n                 new NodeResourceChangeValidator()\n         };\n-        return Arrays.stream(validators)\n-                .flatMap(v -> v.validate(currentModel, nextModel, overrides, now).stream())\n-                .collect(toList());\n+        List<ConfigChangeAction> actions = Arrays.stream(validators)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1NTk4NQ=="}, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzE3MjM3OnYy", "diffSide": "RIGHT", "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/change/VespaRefeedAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNjoxOToxMVrOH3BZ-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNjoxOToxMVrOH3BZ-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1Njc2MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/vespa-engine/vespa/pull/15399#discussion_r527456761", "createdAt": "2020-11-20T06:19:11Z", "author": {"login": "bratseth"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/change/VespaRefeedAction.java", "diffHunk": "@@ -22,37 +23,36 @@\n      * the validation ids belong to the Vespa model while these names are exposed to the config server,\n      * which is model version independent.\n      */\n-    private final String name;\n-\n+    private final ValidationId validationId;\n     private final String documentType;\n     private final boolean allowed;\n \n-    private VespaRefeedAction(ClusterSpec.Id id, String name, String message, List<ServiceInfo> services, String documentType, boolean allowed) {\n+    private VespaRefeedAction(ClusterSpec.Id id, ValidationId validationId, String message, List<ServiceInfo> services, String documentType, boolean allowed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11e4907006c94bdd761e8f37bc9d006ae5b7bb40"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 888, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}