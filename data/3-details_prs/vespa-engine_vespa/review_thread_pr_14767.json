{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NTExODky", "number": 14767, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo1OToxNFrOErg9zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTowMjowMFrOErhCew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDY0MzM0OnYy", "diffSide": "RIGHT", "path": "document/src/vespa/document/datatype/positiondatatype.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo1OToxNFrOHeUtDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo1OToxNFrOHeUtDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1ODU0Mg==", "bodyText": "This existing implementation of double-checked locking does not seem entirely correct, as _instance may be read by a thread that has not formed a release-acquire pair with the thread that wrote it (since the reader thread won't be taking the guard).\nCould add explicit fencing, but I'd suggest just moving _instance into a static function scope variable, which makes the code simpler and also correctly does double-checked locking behind the scenes.", "url": "https://github.com/vespa-engine/vespa/pull/14767#discussion_r501558542", "createdAt": "2020-10-08T08:59:14Z", "author": {"login": "vekterli"}, "path": "document/src/vespa/document/datatype/positiondatatype.cpp", "diffHunk": "@@ -30,7 +31,7 @@ const StructDataType &\n PositionDataType::getInstance()\n {\n     if ( ! _instance) {\n-        vespalib::LockGuard guard(_lock);\n+        std::lock_guard guard(_G_lock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0fa07975af2ed8812544950f5785a48f0b41dfd"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDY1NTMxOnYy", "diffSide": "RIGHT", "path": "document/src/vespa/document/datatype/urldatatype.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTowMjowMFrOHeU0Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTowMjowMFrOHeU0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2MDM3NQ==", "bodyText": "See comment from PositionDataType re: subtly incorrect double-checked locking.", "url": "https://github.com/vespa-engine/vespa/pull/14767#discussion_r501560375", "createdAt": "2020-10-08T09:02:00Z", "author": {"login": "vekterli"}, "path": "document/src/vespa/document/datatype/urldatatype.cpp", "diffHunk": "@@ -34,7 +40,7 @@ const StructDataType &\n UrlDataType::getInstance()\n {\n     if ( ! _instance ) {\n-        vespalib::LockGuard guard(_lock);\n+        std::lock_guard guard(_G_lock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0fa07975af2ed8812544950f5785a48f0b41dfd"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1219, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}