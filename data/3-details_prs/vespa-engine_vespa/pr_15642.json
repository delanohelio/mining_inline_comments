{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxODMyMDgz", "number": 15642, "title": "Record scaling event completion", "bodyText": "", "createdAt": "2020-12-03T14:45:00Z", "url": "https://github.com/vespa-engine/vespa/pull/15642", "merged": true, "mergeCommit": {"oid": "6c3ba5ed09e8bd0b1752136fb30f2629715c1b3f"}, "closed": true, "closedAt": "2020-12-03T20:46:12Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdikOFzAH2gAyNTMxODMyMDgzOmVkY2Q5YjdlYTRhNTUwNmM4YmY2NjlhZTBmM2U4MWE2MTU3OTY3NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdilB1UgFqTU0NDA2Njg4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "edcd9b7ea4a5506c8bf669ae0f3e81a615796746", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/edcd9b7ea4a5506c8bf669ae0f3e81a615796746", "committedDate": "2020-12-03T14:42:38Z", "message": "Record scaling event completion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MDY2ODgy", "url": "https://github.com/vespa-engine/vespa/pull/15642#pullrequestreview-544066882", "createdAt": "2020-12-03T15:23:52Z", "commit": {"oid": "edcd9b7ea4a5506c8bf669ae0f3e81a615796746"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToyMzo1M1rOH-hxCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToyMzo1M1rOH-hxCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyNjk4NQ==", "bodyText": "How do we know when data distribution has to completed if we add new nodes?\nSince we know from the event what the target is, wouldn't it be better to identify the nodes that we are scaling to (i.e. the count nodes that are active, not retired and have the same resources as the cluster.targetResources()), then for each of those check with cluster controller if the node is in sync?", "url": "https://github.com/vespa-engine/vespa/pull/15642#discussion_r535326985", "createdAt": "2020-12-03T15:23:53Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/AutoscalingMaintainer.java", "diffHunk": "@@ -87,13 +95,38 @@ private Applications applications() {\n         return nodeRepository().applications();\n     }\n \n+    /** Check if the last scaling event for this cluster has completed and if so record it in the returned instance */\n+    private Cluster updateCompletion(Cluster cluster, NodeList clusterNodes) {\n+        if (cluster.lastScalingEvent().isEmpty()) return cluster;\n+        var event = cluster.lastScalingEvent().get();\n+        if (event.completion().isPresent()) return cluster;\n+\n+        // Scaling event is complete if:\n+        // - 1. no nodes which was retired by this are still present (which also implies data distribution is complete)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edcd9b7ea4a5506c8bf669ae0f3e81a615796746"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3844, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}