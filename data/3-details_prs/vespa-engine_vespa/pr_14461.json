{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMTI2NzY3", "number": 14461, "title": "Jonmv/async document v1", "bodyText": "@bratseth or @bjorncs please review.", "createdAt": "2020-09-21T08:20:24Z", "url": "https://github.com/vespa-engine/vespa/pull/14461", "merged": true, "mergeCommit": {"oid": "b8e79b130ce75292ca398afda54eef76aa932a16"}, "closed": true, "closedAt": "2020-09-21T09:39:13Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdK9hOvgH2gAyNDkwMTI2NzY3OmJjM2UyNDQ4YTFjODA1ZDkwYjRhYzhiNmVhNTlhZjZmOGVmZDdjYzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLCGF6AFqTQ5MjUyMDUzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc3e2448a1c805d90b4ac8b6ea59af6f8efd7cc1", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/bc3e2448a1c805d90b4ac8b6ea59af6f8efd7cc1", "committedDate": "2020-09-21T06:36:59Z", "message": "Let successful RemoveReponse and UpdateRespone have NOT_FOUND outcome"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "433df784ef747fe85883ab7612c08cd51866b32a", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/433df784ef747fe85883ab7612c08cd51866b32a", "committedDate": "2020-09-21T06:51:25Z", "message": "Update abi spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/af3afdb3d165df39d4548406553e4f0adee591c7", "committedDate": "2020-09-21T08:16:53Z", "message": "Provide a MessageBugDocumentAccess lazily, in containers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/86157db42aab6749f62104ff0660b66ce4a649ba", "committedDate": "2020-09-21T08:20:10Z", "message": "Update doc in DocumentAccess"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMzg0ODIx", "url": "https://github.com/vespa-engine/vespa/pull/14461#pullrequestreview-492384821", "createdAt": "2020-09-21T08:41:40Z", "commit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNDM2MTky", "url": "https://github.com/vespa-engine/vespa/pull/14461#pullrequestreview-492436192", "createdAt": "2020-09-21T09:50:38Z", "commit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1MDozOFrOHVITKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1MDozOFrOHVITKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA==", "bodyText": "Why creating it at all if shutdown is set. Can you just add it to the outer if as '&& !shutDown'", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491918120", "createdAt": "2020-09-21T09:50:38Z", "author": {"login": "baldersheim"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTIwNTMw", "url": "https://github.com/vespa-engine/vespa/pull/14461#pullrequestreview-492520530", "createdAt": "2020-09-21T11:53:08Z", "commit": {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1MzowOFrOHVMTAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1Njo0MVrOHVMevA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4MzYxOA==", "bodyText": "IMHO, throwing an exception for duplicate calls to deconstruct() is ok - it should not happen. This is too defensive.", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491983618", "createdAt": "2020-09-21T11:53:08Z", "author": {"login": "bjorncs"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)\n+                    access.shutdown();\n+            }\n+            return access;\n+        }\n+    }\n+\n+    @Override\n+    public void deconstruct() {\n+        synchronized (monitor) {\n+            if ( ! shutDown) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjM5Nw==", "bodyText": "Is this config available for all types of container clusters (e.g clustercontroller, metricsproxy, logserver)?", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491986397", "createdAt": "2020-09-21T11:56:14Z", "author": {"login": "bjorncs"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjYyMA==", "bodyText": "Should this component be available for non-application-container-clusters?", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491986620", "createdAt": "2020-09-21T11:56:41Z", "author": {"login": "bjorncs"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/ContainerCluster.java", "diffHunk": "@@ -181,6 +181,7 @@ public ContainerCluster(AbstractConfigProducer<?> parent, String subId, String n\n         addSimpleComponent(com.yahoo.metrics.simple.jdisc.JdiscMetricsFactory.class.getName(), null, MetricProperties.BUNDLE_SYMBOLIC_NAME);\n         addSimpleComponent(\"com.yahoo.container.jdisc.state.StateMonitor\");\n         addSimpleComponent(\"com.yahoo.container.jdisc.ContainerThreadFactory\");\n+        addSimpleComponent(com.yahoo.container.core.documentapi.MessageBusDocumentAccessProvider.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4275, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}