{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNjM3MTMw", "number": 12386, "title": "Only build part of application instance for host resource", "bodyText": "With service-model-cache enabled, this PR is a no-op. Disabled, it will not only disable the cache, but also generate only the parts of the service model necessary. Without this latter optimization, disabling the cache is up to a 2x CPU utilization hit for the cfg server.", "createdAt": "2020-02-28T23:03:45Z", "url": "https://github.com/vespa-engine/vespa/pull/12386", "merged": true, "mergeCommit": {"oid": "c4735deb48e380e84635a3d05741f7fe189349a7"}, "closed": true, "closedAt": "2020-03-01T14:41:30Z", "author": {"login": "hakonhall"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIyz8cAH2gAyMzgxNjM3MTMwOmU0YTA2YWNlNzFhY2FjNWFhMWUxODE3NmY3MjUzNjQ5ODgzZmJhZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJZxAGgFqTM2Njg2MTk1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e4a06ace71acac5aa1e18176f7253649883fbaed", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/e4a06ace71acac5aa1e18176f7253649883fbaed", "committedDate": "2020-02-28T16:49:28Z", "message": "Moved to more specific methods on ServiceMonitor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d515c403035aeef430507acb6a166b6cfdba9ee", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/7d515c403035aeef430507acb6a166b6cfdba9ee", "committedDate": "2020-02-28T21:26:39Z", "message": "Add host indices to duper model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "159a116ae750968719de8a63052431ea0de11a31", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/159a116ae750968719de8a63052431ea0de11a31", "committedDate": "2020-02-28T22:34:16Z", "message": "Only build part of application instance for host resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "801dd522bc2c38a35da62f3d5798b5acc4235877", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/801dd522bc2c38a35da62f3d5798b5acc4235877", "committedDate": "2020-02-29T00:10:46Z", "message": "Log and forward duper model completion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODAxNTk0", "url": "https://github.com/vespa-engine/vespa/pull/12386#pullrequestreview-366801594", "createdAt": "2020-02-29T14:45:01Z", "commit": {"oid": "801dd522bc2c38a35da62f3d5798b5acc4235877"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxNDo0NTowMlrOFwJj_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxNDo0ODozMVrOFwJk1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzMjYzNg==", "bodyText": "Most of the time oldHostnames and hostnames will be equal, maybe consider adding optimization to skip all that removal and addition if that is the case?", "url": "https://github.com/vespa-engine/vespa/pull/12386#discussion_r386032636", "createdAt": "2020-02-29T14:45:02Z", "author": {"login": "freva"}, "path": "service-monitor/src/main/java/com/yahoo/vespa/service/duper/DuperModel.java", "diffHunk": "@@ -20,37 +25,90 @@\n public class DuperModel {\n     private static Logger logger = Logger.getLogger(DuperModel.class.getName());\n \n-    private final Map<ApplicationId, ApplicationInfo> applications = new TreeMap<>();\n+    private final Map<ApplicationId, ApplicationInfo> applicationsById = new HashMap<>();\n+    private final Map<HostName, ApplicationInfo> applicationsByHostname = new HashMap<>();\n+    private final Map<ApplicationId, Set<HostName>> hostnamesById = new HashMap<>();\n+\n     private final List<DuperModelListener> listeners = new ArrayList<>();\n     private boolean isComplete = false;\n \n     public void registerListener(DuperModelListener listener) {\n-        applications.values().forEach(listener::applicationActivated);\n+        applicationsById.values().forEach(listener::applicationActivated);\n         listeners.add(listener);\n     }\n \n-    public void setCompleteness(boolean isComplete) { this.isComplete = isComplete; }\n+    void setComplete() {\n+        if (!isComplete) {\n+            logger.log(LogLevel.INFO, \"Bootstrap done - duper model is complete\");\n+            isComplete = true;\n+\n+            listeners.forEach(DuperModelListener::bootstrapComplete);\n+        }\n+    }\n+\n     public boolean isComplete() { return isComplete; }\n \n+    public int numberOfApplications() {\n+        return applicationsById.size();\n+    }\n+\n+    public int numberOfHosts() {\n+        return applicationsByHostname.size();\n+    }\n+\n     public boolean contains(ApplicationId applicationId) {\n-        return applications.containsKey(applicationId);\n+        return applicationsById.containsKey(applicationId);\n+    }\n+\n+    public Optional<ApplicationInfo> getApplicationInfo(ApplicationId applicationId) {\n+        return Optional.ofNullable(applicationsById.get(applicationId));\n+    }\n+\n+    public Optional<ApplicationInfo> getApplicationInfo(HostName hostName) {\n+        return Optional.ofNullable(applicationsByHostname.get(hostName));\n+    }\n+\n+    public List<ApplicationInfo> getApplicationInfos() {\n+        return List.copyOf(applicationsById.values());\n     }\n \n     public void add(ApplicationInfo applicationInfo) {\n-        applications.put(applicationInfo.getApplicationId(), applicationInfo);\n-        logger.log(LogLevel.DEBUG, \"Added \" + applicationInfo.getApplicationId());\n+        ApplicationInfo oldApplicationInfo = applicationsById.put(applicationInfo.getApplicationId(), applicationInfo);\n+\n+        final String logPrefix;\n+        if (oldApplicationInfo == null) {\n+            logPrefix = isComplete ? \"New application \" : \"Bootstrapped application \";\n+        } else {\n+            logPrefix = isComplete ? \"Reactivated application \" : \"Rebootstrapped application \";\n+        }\n+        logger.log(LogLevel.INFO, logPrefix + applicationInfo.getApplicationId());\n+\n+        Set<HostName> oldHostnames = hostnamesById.remove(applicationInfo.getApplicationId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "801dd522bc2c38a35da62f3d5798b5acc4235877"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzMjg1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static ApplicationId configServerApplicationId = new ConfigServerApplication().getApplicationId();\n          \n          \n            \n                private static final ApplicationId configServerApplicationId = new ConfigServerApplication().getApplicationId();", "url": "https://github.com/vespa-engine/vespa/pull/12386#discussion_r386032854", "createdAt": "2020-02-29T14:48:31Z", "author": {"login": "freva"}, "path": "service-monitor/src/main/java/com/yahoo/vespa/service/model/ApplicationInstanceGenerator.java", "diffHunk": "@@ -37,23 +43,73 @@\n \n     private final ApplicationInfo applicationInfo;\n     private final Zone zone;\n-    private ApplicationId configServerApplicationId;\n+\n+    // This is cheating a bit, but we don't expect DuperModel's config server application ID to be different.\n+    // We do this to avoid passing through the ID through multiple levels.\n+    private static ApplicationId configServerApplicationId = new ConfigServerApplication().getApplicationId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "801dd522bc2c38a35da62f3d5798b5acc4235877"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aae80e66af1e581b3bd3bdf67a48fb57bf8ac8f4", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/aae80e66af1e581b3bd3bdf67a48fb57bf8ac8f4", "committedDate": "2020-02-29T21:46:08Z", "message": "Update service-monitor/src/main/java/com/yahoo/vespa/service/model/ApplicationInstanceGenerator.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "496054ead605206c528eab589eca6f4e6f9d4f29", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/496054ead605206c528eab589eca6f4e6f9d4f29", "committedDate": "2020-03-01T13:56:11Z", "message": "More effective duper model update on activation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56e55e53e7b82f62116eb1286e60e855c6e47f90", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/56e55e53e7b82f62116eb1286e60e855c6e47f90", "committedDate": "2020-03-01T14:10:19Z", "message": "Get previous hostname set"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODYxOTU1", "url": "https://github.com/vespa-engine/vespa/pull/12386#pullrequestreview-366861955", "createdAt": "2020-03-01T14:12:33Z", "commit": {"oid": "56e55e53e7b82f62116eb1286e60e855c6e47f90"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2854, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}