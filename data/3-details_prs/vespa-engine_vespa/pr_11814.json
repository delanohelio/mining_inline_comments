{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNjQ4OTY4", "number": 11814, "title": "Refuse to start container if resolved IP address does not match node-repo IP", "bodyText": "", "createdAt": "2020-01-16T13:36:20Z", "url": "https://github.com/vespa-engine/vespa/pull/11814", "merged": true, "mergeCommit": {"oid": "21045fc38e60f44ac26b6e39a0f3a639cb94c793"}, "closed": true, "closedAt": "2020-01-16T15:57:51Z", "author": {"login": "freva"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb659YNAH2gAyMzYzNjQ4OTY4OmU3NjhhZmUxYzcyZDJlZDE2NTIyNGY2MmYzZjc2MDEyZDZmMDllZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb68A4OAFqTM0NDAwNTI3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e768afe1c72d2ed165224f62f3f76012d6f09ede", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/e768afe1c72d2ed165224f62f3f76012d6f09ede", "committedDate": "2020-01-16T13:14:10Z", "message": "Return CommandResult from DockerOperations::executeCommandInNetworkNamespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91369adf8f525d96c2a03821a44e1487fdee2b22", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/91369adf8f525d96c2a03821a44e1487fdee2b22", "committedDate": "2020-01-16T13:23:10Z", "message": "Fail if IP address from node-repo does not match the resolved IP address if feature flag i set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f16a26ec4a8893ab4d01b6c6e232c8585f25f2f", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/3f16a26ec4a8893ab4d01b6c6e232c8585f25f2f", "committedDate": "2020-01-16T13:28:55Z", "message": "Throw ConvergenceException instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTcyMjU3", "url": "https://github.com/vespa-engine/vespa/pull/11814#pullrequestreview-343972257", "createdAt": "2020-01-16T14:55:49Z", "commit": {"oid": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDo1NTo0OVrOFecLAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTowNTo0MlrOFech4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2MzE3MA==", "bodyText": "Btw I think Optional.toString() works fine too (leaving out orElse()).", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367463170", "createdAt": "2020-01-16T14:55:49Z", "author": {"login": "hakonhall"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/docker/DockerOperationsImpl.java", "diffHunk": "@@ -120,10 +125,24 @@ public void createContainer(NodeAgentContext context, ContainerData containerDat\n         command.create();\n     }\n \n+    private static void assertEqualIpAddresses(HostName hostName, Optional<? extends InetAddress> resolvedAddress,\n+                                               Set<String> nrAddresses, IPVersion ipVersion) {\n+        Optional<InetAddress> nrAddress = nrAddresses.stream()\n+                .map(InetAddresses::forString)\n+                .filter(ipVersion::match)\n+                .findFirst();\n+        if (resolvedAddress.equals(nrAddress)) return;\n+\n+        throw new ConvergenceException(String.format(\n+                \"IP address (%s) resolved from %s  does not match IP address (%s) in node-repo\",\n+                resolvedAddress.map(InetAddresses::toAddrString).orElse(\"[none]\"), hostName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2NDE0Mg==", "bodyText": "I'd vote for execute() instead of executeSilently().", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367464142", "createdAt": "2020-01-16T14:57:28Z", "author": {"login": "hakonhall"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/docker/DockerOperationsImpl.java", "diffHunk": "@@ -193,31 +212,17 @@ public ProcessResult executeCommandInContainerAsRoot(NodeAgentContext context, S\n     }\n \n     @Override\n-    public ProcessResult executeCommandInNetworkNamespace(NodeAgentContext context, String... command) {\n+    public CommandResult executeCommandInNetworkNamespace(NodeAgentContext context, String... command) {\n         int containerPid = docker.getContainer(context.containerName())\n                 .filter(container -> container.state.isRunning())\n                 .orElseThrow(() -> new RuntimeException(\n                         \"Found no running container named \" + context.containerName().asString()))\n                 .pid;\n \n-        String[] wrappedCommand = Stream.concat(Stream.of(\"nsenter\",\n-                                                          String.format(\"--net=/proc/%d/ns/net\", containerPid),\n-                                                          \"--\"),\n-                                                Stream.of(command))\n-                                        .toArray(String[]::new);\n-\n-        try {\n-            Pair<Integer, String> result = processExecuter.exec(wrappedCommand);\n-            if (result.getFirst() != 0) {\n-                throw new RuntimeException(String.format(\n-                        \"Failed to execute %s in network namespace for %s (PID = %d), exit code: %d, output: %s\",\n-                        Arrays.toString(wrappedCommand), context.containerName().asString(), containerPid, result.getFirst(), result.getSecond()));\n-            }\n-            return new ProcessResult(0, result.getSecond(), \"\");\n-        } catch (IOException e) {\n-            throw new RuntimeException(String.format(\"IOException while executing %s in network namespace for %s (PID = %d)\",\n-                    Arrays.toString(wrappedCommand), context.containerName().asString(), containerPid), e);\n-        }\n+        return terminal.newCommandLine(context)\n+                .add(\"nsenter\", String.format(\"--net=/proc/%d/ns/net\", containerPid), \"--\")\n+                .add(command)\n+                .executeSilently();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2NDkzOA==", "bodyText": "nice", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367464938", "createdAt": "2020-01-16T14:58:44Z", "author": {"login": "hakonhall"}, "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/acl/AclMaintainer.java", "diffHunk": "@@ -88,13 +85,9 @@ private boolean edit(NodeAgentContext context, String table, IPVersion ipVersion\n     }\n \n     private Supplier<List<String>> listTable(NodeAgentContext context, String table, IPVersion ipVersion) {\n-        return () -> {\n-            ProcessResult currentRulesResult =\n-                    dockerOperations.executeCommandInNetworkNamespace(context, ipVersion.iptablesCmd(), \"-S\", \"-t\", table);\n-            return Arrays.stream(currentRulesResult.getOutput().split(\"\\n\"))\n-                    .map(String::trim)\n-                    .collect(Collectors.toList());\n-        };\n+        return () -> dockerOperations\n+                .executeCommandInNetworkNamespace(context, ipVersion.iptablesCmd(), \"-S\", \"-t\", table)\n+                .mapEachLine(String::trim);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2OTAyNg==", "bodyText": "Why not use TestTerminal?", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367469026", "createdAt": "2020-01-16T15:05:42Z", "author": {"login": "hakonhall"}, "path": "node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/integrationTests/DockerTester.java", "diffHunk": "@@ -75,8 +74,7 @@\n         ipAddresses.addAddress(HOST_HOSTNAME.value(), \"f000::\");\n         for (int i = 1; i < 4; i++) ipAddresses.addAddress(\"host\" + i + \".test.yahoo.com\", \"f000::\" + i);\n \n-        ProcessExecuter processExecuter = mock(ProcessExecuter.class);\n-        uncheck(() -> when(processExecuter.exec(any(String[].class))).thenReturn(new Pair<>(0, \"\")));\n+        TerminalImpl terminal = new TerminalImpl(command -> new TestChildProcess2(0, \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b3dc39da9b25413d72eca88a78a70981017ec0e", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/8b3dc39da9b25413d72eca88a78a70981017ec0e", "committedDate": "2020-01-16T15:27:35Z", "message": "Merge branch 'master' into freva/fallback-to-node-repo-address\n\n# Conflicts:\n#\tflags/src/main/java/com/yahoo/vespa/flags/Flags.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/9a87e61b9806e79ab5669b2a126ba0d0960a7c15", "committedDate": "2020-01-16T14:48:37Z", "message": "Merge branch 'master' into freva/fallback-to-node-repo-address\n\n# Conflicts:\n#\tflags/src/main/java/com/yahoo/vespa/flags/Flags.java"}, "afterCommit": {"oid": "8b3dc39da9b25413d72eca88a78a70981017ec0e", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/8b3dc39da9b25413d72eca88a78a70981017ec0e", "committedDate": "2020-01-16T15:27:35Z", "message": "Merge branch 'master' into freva/fallback-to-node-repo-address\n\n# Conflicts:\n#\tflags/src/main/java/com/yahoo/vespa/flags/Flags.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDA1Mjc3", "url": "https://github.com/vespa-engine/vespa/pull/11814#pullrequestreview-344005277", "createdAt": "2020-01-16T15:37:48Z", "commit": {"oid": "8b3dc39da9b25413d72eca88a78a70981017ec0e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4030, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}