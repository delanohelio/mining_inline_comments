{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MTAwMTQz", "number": 14592, "title": "Arnej/new sparse tensor value 2", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@havardpe please review", "createdAt": "2020-09-28T12:15:18Z", "url": "https://github.com/vespa-engine/vespa/pull/14592", "merged": true, "mergeCommit": {"oid": "651eaba1126536893200fa777ed52c9446ac2c23"}, "closed": true, "closedAt": "2020-09-28T15:39:27Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNSbfRAH2gAyNDk0MTAwMTQzOjVhZTdjOTQ2Y2ZlN2Q4OGVmOGQ1NjhiNDY2ZGNmZTY4N2VlMTI0NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNVGR7gFqTQ5NzYzMjkzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ae7c946cfe7d88ef8d568b466dcfe687ee12458", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/5ae7c946cfe7d88ef8d568b466dcfe687ee12458", "committedDate": "2020-09-28T12:06:34Z", "message": "add SparseTensorValue class and builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0508f5625ccf3ce2107e15d17336ef771015c25b", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/0508f5625ccf3ce2107e15d17336ef771015c25b", "committedDate": "2020-09-28T12:06:34Z", "message": "subspaces may be serialized in any order\n\n* in particular, SparseTensor uses a hash-table and its\n  cell arrive in \"random\" order."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "416681c8a5a80bf3ddb960aafc9c3db98363b049", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/416681c8a5a80bf3ddb960aafc9c3db98363b049", "committedDate": "2020-09-28T12:06:35Z", "message": "ensure zero termination"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4390afc15f1de2600a89ed14cffef1881dbf6e62", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/4390afc15f1de2600a89ed14cffef1881dbf6e62", "committedDate": "2020-09-28T12:06:35Z", "message": "add DoubleValueBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55b186000b19bec24008eefeae9e4c23a476e91e", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/55b186000b19bec24008eefeae9e4c23a476e91e", "committedDate": "2020-09-28T12:06:35Z", "message": "add DenseTensorValueBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb304f3b6961292182f5f480a2789e5921746713", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/bb304f3b6961292182f5f480a2789e5921746713", "committedDate": "2020-09-28T12:06:35Z", "message": "add DefaultValueBuilderFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d15851c160648486389ef3a2154abdc4aeced7c", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/0d15851c160648486389ef3a2154abdc4aeced7c", "committedDate": "2020-09-28T12:11:30Z", "message": "optimize views"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24692327c04f076551c831b450e2c05bcafbbaed", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/24692327c04f076551c831b450e2c05bcafbbaed", "committedDate": "2020-09-28T12:11:34Z", "message": "add unit test for new factory\nno real need for SparseTensorValue to be templated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42e08d6a2649d4e9421ba64de1d310e1e82cc262", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/42e08d6a2649d4e9421ba64de1d310e1e82cc262", "committedDate": "2020-09-28T12:11:35Z", "message": "benchmark with new \"adaptive\" factory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NDU5NDE5", "url": "https://github.com/vespa-engine/vespa/pull/14592#pullrequestreview-497459419", "createdAt": "2020-09-28T12:27:17Z", "commit": {"oid": "42e08d6a2649d4e9421ba64de1d310e1e82cc262"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMjoyNzoxN1rOHY7TOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMjo0OToxNlrOHY8EZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg5OTQ1MA==", "bodyText": "test name seems a bit off...", "url": "https://github.com/vespa-engine/vespa/pull/14592#discussion_r495899450", "createdAt": "2020-09-28T12:27:17Z", "author": {"login": "havardpe"}, "path": "eval/src/tests/tensor/default_value_builder_factory/default_value_builder_factory_test.cpp", "diffHunk": "@@ -0,0 +1,61 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <vespa/eval/eval/value.h>\n+#include <vespa/eval/eval/value_codec.h>\n+#include <vespa/eval/eval/tensor_spec.h>\n+#include <vespa/eval/tensor/default_value_builder_factory.h>\n+#include <vespa/eval/tensor/mixed/packed_mixed_tensor.h>\n+#include <vespa/eval/tensor/sparse/sparse_tensor_value.h>\n+#include <vespa/eval/tensor/dense/dense_tensor.h>\n+#include <vespa/vespalib/gtest/gtest.h>\n+\n+using namespace vespalib;\n+using namespace vespalib::eval;\n+using namespace vespalib::tensor;\n+using namespace vespalib::eval::packed_mixed_tensor;\n+\n+Value::UP v_of(const TensorSpec &spec) {\n+    return value_from_spec(spec, DefaultValueBuilderFactory::get());\n+}\n+\n+TEST(MakeInputTest, print_some_test_input) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42e08d6a2649d4e9421ba64de1d310e1e82cc262"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkwODYzNw==", "bodyText": "I suggest just dropping unneeded parameters; num_mapped_in and expected_subspaces", "url": "https://github.com/vespa-engine/vespa/pull/14592#discussion_r495908637", "createdAt": "2020-09-28T12:43:43Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/tensor/dense/dense_tensor_value_builder.h", "diffHunk": "@@ -0,0 +1,32 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"dense_tensor.h\"\n+\n+namespace vespalib::tensor {\n+\n+/**\n+ * A builder for DenseTensor objects\n+ **/\n+template<typename T>\n+class DenseTensorValueBuilder : public eval::ValueBuilder<T>\n+{\n+private:\n+    eval::ValueType _type;\n+    std::vector<T> _cells;\n+public:\n+    DenseTensorValueBuilder(const eval::ValueType &type, size_t num_mapped_in,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42e08d6a2649d4e9421ba64de1d310e1e82cc262"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkwOTU4Nw==", "bodyText": "I am a bit sceptical about adding too many loop-based asserts to the code we want to benchmark for fastness.", "url": "https://github.com/vespa-engine/vespa/pull/14592#discussion_r495909587", "createdAt": "2020-09-28T12:45:17Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/tensor/dense/dense_tensor_value_builder.cpp", "diffHunk": "@@ -0,0 +1,27 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"dense_tensor_value_builder.h\"\n+\n+namespace vespalib::tensor {\n+\n+template<typename T>\n+DenseTensorValueBuilder<T>::DenseTensorValueBuilder(\n+        const eval::ValueType &type,\n+        size_t num_mapped_in,\n+        size_t subspace_size_in,\n+        size_t)\n+  : _type(type), \n+    _cells(subspace_size_in)\n+{\n+    assert(type.is_dense());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42e08d6a2649d4e9421ba64de1d310e1e82cc262"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkxMTMwMg==", "bodyText": "prefer using mapped_dims and subspace_size directly instead of 're-calculating' them.", "url": "https://github.com/vespa-engine/vespa/pull/14592#discussion_r495911302", "createdAt": "2020-09-28T12:48:03Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/tensor/default_value_builder_factory.cpp", "diffHunk": "@@ -0,0 +1,57 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"default_value_builder_factory.h\"\n+#include <vespa/vespalib/util/typify.h>\n+#include <vespa/eval/eval/value.h>\n+#include <vespa/eval/eval/double_value_builder.h>\n+#include <vespa/eval/tensor/dense/dense_tensor_value_builder.h>\n+#include <vespa/eval/tensor/mixed/packed_mixed_tensor_builder.h>\n+#include <vespa/eval/tensor/sparse/sparse_tensor_value_builder.h>\n+\n+using namespace vespalib::eval;\n+\n+namespace vespalib::tensor {\n+\n+//-----------------------------------------------------------------------------\n+\n+namespace {\n+\n+struct CreateDefaultValueBuilderBase {\n+    template <typename T> static std::unique_ptr<ValueBuilderBase> invoke(const ValueType &type,\n+                                                                          size_t num_mapped_dims_in,\n+                                                                          size_t subspace_size_in,\n+                                                                          size_t expected_subspaces)\n+    {\n+        assert(check_cell_type<T>(type.cell_type()));\n+        if (type.is_double()) {\n+            return std::make_unique<DoubleValueBuilder>(type, num_mapped_dims_in, subspace_size_in, 1);\n+        }\n+        if (type.is_dense()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42e08d6a2649d4e9421ba64de1d310e1e82cc262"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkxMTM3Mg==", "bodyText": "prefer using mapped_dims and subspace_size directly instead of 're-calculating' them.", "url": "https://github.com/vespa-engine/vespa/pull/14592#discussion_r495911372", "createdAt": "2020-09-28T12:48:09Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/tensor/default_value_builder_factory.cpp", "diffHunk": "@@ -0,0 +1,57 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"default_value_builder_factory.h\"\n+#include <vespa/vespalib/util/typify.h>\n+#include <vespa/eval/eval/value.h>\n+#include <vespa/eval/eval/double_value_builder.h>\n+#include <vespa/eval/tensor/dense/dense_tensor_value_builder.h>\n+#include <vespa/eval/tensor/mixed/packed_mixed_tensor_builder.h>\n+#include <vespa/eval/tensor/sparse/sparse_tensor_value_builder.h>\n+\n+using namespace vespalib::eval;\n+\n+namespace vespalib::tensor {\n+\n+//-----------------------------------------------------------------------------\n+\n+namespace {\n+\n+struct CreateDefaultValueBuilderBase {\n+    template <typename T> static std::unique_ptr<ValueBuilderBase> invoke(const ValueType &type,\n+                                                                          size_t num_mapped_dims_in,\n+                                                                          size_t subspace_size_in,\n+                                                                          size_t expected_subspaces)\n+    {\n+        assert(check_cell_type<T>(type.cell_type()));\n+        if (type.is_double()) {\n+            return std::make_unique<DoubleValueBuilder>(type, num_mapped_dims_in, subspace_size_in, 1);\n+        }\n+        if (type.is_dense()) {\n+            return std::make_unique<DenseTensorValueBuilder<T>>(type, num_mapped_dims_in, subspace_size_in, 1);\n+        }\n+        if (type.is_sparse()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42e08d6a2649d4e9421ba64de1d310e1e82cc262"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkxMjAzNg==", "bodyText": "consider dropping unneeded parameters", "url": "https://github.com/vespa-engine/vespa/pull/14592#discussion_r495912036", "createdAt": "2020-09-28T12:49:16Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/eval/double_value_builder.h", "diffHunk": "@@ -0,0 +1,30 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"value.h\"\n+\n+namespace vespalib::eval {\n+\n+/**\n+ * A trivial builder for DoubleValue objects\n+ **/\n+class DoubleValueBuilder : public ValueBuilder<double>\n+{\n+private:\n+    double _value;\n+public:\n+    DoubleValueBuilder(const ValueType &type, size_t num_mapped_in,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42e08d6a2649d4e9421ba64de1d310e1e82cc262"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e533d6f97052838eaa47268f086d9bbc560c20a9", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/e533d6f97052838eaa47268f086d9bbc560c20a9", "committedDate": "2020-09-28T13:37:02Z", "message": "we need templated SparseTensorValue after all"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0285fe78515a40aeef8fa2e601cd1e9e744408d9", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/0285fe78515a40aeef8fa2e601cd1e9e744408d9", "committedDate": "2020-09-28T13:57:37Z", "message": "just hold std::vector<T> inside SparseTensorValue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "574b67881df1e48c21069dba9bd59ad1a3dc2670", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/574b67881df1e48c21069dba9bd59ad1a3dc2670", "committedDate": "2020-09-28T14:03:18Z", "message": "minor refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64770dcc3e0db3fd020c03857bc781d6a4e80e98", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/64770dcc3e0db3fd020c03857bc781d6a4e80e98", "committedDate": "2020-09-28T14:15:34Z", "message": "less asserts and parameters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad6340c70b603b4e924088a8f396d92c03bcf944", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/ad6340c70b603b4e924088a8f396d92c03bcf944", "committedDate": "2020-09-28T14:30:23Z", "message": "fix naming in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52e63a912e0dd705c2885f11e5f9230e3ccd8a22", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/52e63a912e0dd705c2885f11e5f9230e3ccd8a22", "committedDate": "2020-09-28T14:39:49Z", "message": "use provided variables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjMyOTM3", "url": "https://github.com/vespa-engine/vespa/pull/14592#pullrequestreview-497632937", "createdAt": "2020-09-28T15:13:07Z", "commit": {"oid": "52e63a912e0dd705c2885f11e5f9230e3ccd8a22"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4108, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}