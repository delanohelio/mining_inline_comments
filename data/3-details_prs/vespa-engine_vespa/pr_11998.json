{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NTM5MDE3", "number": 11998, "title": "Add ReadableAttributeVector accessor to IAttributeManager", "bodyText": "@geirst @toregge please review\nProvides a unified interface for fetching both regular as well as\nimported attributes. Exposing ReadableAttributeVector instead of\nraw AttributeVector instances enforces that all access is done via\nappropriate acquired read guards.\nRefactor document selection processing code to use the new interface\nin order to prepare for imported field support in selections.", "createdAt": "2020-01-29T12:49:29Z", "url": "https://github.com/vespa-engine/vespa/pull/11998", "merged": true, "mergeCommit": {"oid": "f9d2e5638c987c678d4d6c57c872ff5e56877e20"}, "closed": true, "closedAt": "2020-01-30T09:31:11Z", "author": {"login": "vekterli"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_FAXcgH2gAyMzY4NTM5MDE3OmJiNzRmYWE1ZjJlNTZjOTMwZGIxZWMwNmViZjkxMmU1YjMxNmMwODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_LRK0AFqTM1MDM3Mzg2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bb74faa5f2e56c930db1ec06ebf912e5b316c087", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/bb74faa5f2e56c930db1ec06ebf912e5b316c087", "committedDate": "2020-01-29T12:22:05Z", "message": "Add ReadableAttributeVector accessor to IAttributeManager\n\nProvides a unified interface for fetching both regular as well as\nimported attributes. Exposing `ReadableAttributeVector` instead of\nraw `AttributeVector` instances enforces that all access is done via\nappropriate acquired read guards.\n\nRefactor document selection processing code to use the new interface\nin order to prepare for imported field support in selections."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMTYwODY4", "url": "https://github.com/vespa-engine/vespa/pull/11998#pullrequestreview-350160868", "createdAt": "2020-01-29T14:46:36Z", "commit": {"oid": "bb74faa5f2e56c930db1ec06ebf912e5b316c087"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDo0NjozNlrOFjK-fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDo0NjozNlrOFjK-fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQyNDMxOA==", "bodyText": "Do we need to expose AttributeReadGuard here or could we just return the IAttributeVector interface instead (that you get from the guard)? If so, we should probably rename the function to something like attribute_at_index() or guarded_attribute_at_index().", "url": "https://github.com/vespa-engine/vespa/pull/11998#discussion_r372424318", "createdAt": "2020-01-29T14:46:36Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/common/selectcontext.cpp", "diffHunk": "@@ -26,23 +28,30 @@ SelectContext::SelectContext(const CachedSelect &cachedSelect)\n       _cachedSelect(cachedSelect)\n { }\n \n-SelectContext::~SelectContext() { }\n+SelectContext::~SelectContext() = default;\n \n void\n SelectContext::getAttributeGuards()\n {\n-    _guards->resize(_cachedSelect.attributes().size());\n-    auto j(_cachedSelect.attributes().begin());\n-    for (std::vector<AttributeGuard>::iterator i(_guards->begin()), ie(_guards->end()); i != ie; ++i, ++j) {\n-        *i = AttributeGuard(*j);\n+    _guards->clear();\n+    _guards->reserve(_cachedSelect.attributes().size());\n+    for (const auto& attr : _cachedSelect.attributes()) {\n+        _guards->emplace_back(attr->makeReadGuard(false));\n     }\n }\n \n-\n void\n SelectContext::dropAttributeGuards()\n {\n     _guards->clear();\n }\n \n+const search::attribute::AttributeReadGuard&\n+SelectContext::read_guard_at_index(uint32_t index) const noexcept", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb74faa5f2e56c930db1ec06ebf912e5b316c087"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzczODYx", "url": "https://github.com/vespa-engine/vespa/pull/11998#pullrequestreview-350373861", "createdAt": "2020-01-29T19:39:52Z", "commit": {"oid": "bb74faa5f2e56c930db1ec06ebf912e5b316c087"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3902, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}