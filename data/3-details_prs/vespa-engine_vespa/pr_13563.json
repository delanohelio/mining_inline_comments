{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNTcwMzMz", "number": 13563, "title": "Add foreach_key_range method to btree iterator, to scan a range of", "bodyText": "the tree and call function for each key.\n@geirst : please review", "createdAt": "2020-06-12T09:28:28Z", "url": "https://github.com/vespa-engine/vespa/pull/13563", "merged": true, "mergeCommit": {"oid": "136dd71a56d4f60962da508ac3387bfafcdaeca9"}, "closed": true, "closedAt": "2020-06-15T07:59:22Z", "author": {"login": "toregge"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqfaVDgH2gAyNDMzNTcwMzMzOjZjNjk1NmY5MTIxOWU4ZDg0MThiNzQzNDM4OTZmODdhOGVhNjg2YWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrb9TGgFqTQzMDQwNTI1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa", "author": {"user": null}, "url": "https://github.com/vespa-engine/vespa/commit/6c6956f91219e8d8418b74343896f87a8ea686aa", "committedDate": "2020-06-12T09:26:43Z", "message": "Add foreach_key_range method to btree iterator, to scan a range of\nthe tree and call function for each key."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5ODI1MTAy", "url": "https://github.com/vespa-engine/vespa/pull/13563#pullrequestreview-429825102", "createdAt": "2020-06-12T15:14:26Z", "commit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNToxNDoyNlrOGjHx9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNToyNjo0OFrOGjIMmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MDgyMQ==", "bodyText": "Please add doc describing function.", "url": "https://github.com/vespa-engine/vespa/pull/13563#discussion_r439480821", "createdAt": "2020-06-12T15:14:26Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/btree/btreeiterator.h", "diffHunk": "@@ -303,6 +303,38 @@ class BTreeIteratorBase\n      * @param pathSize     New tree height (number of levels of internal nodes)\n      */\n     VESPA_DLL_LOCAL void clearPath(uint32_t pathSize);\n+\n+    template <typename FunctionType>\n+    void\n+    foreach_key_range_start(uint32_t level, FunctionType func) const", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MDg5NA==", "bodyText": "Please add doc describing function.", "url": "https://github.com/vespa-engine/vespa/pull/13563#discussion_r439480894", "createdAt": "2020-06-12T15:14:33Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/btree/btreeiterator.h", "diffHunk": "@@ -303,6 +303,38 @@ class BTreeIteratorBase\n      * @param pathSize     New tree height (number of levels of internal nodes)\n      */\n     VESPA_DLL_LOCAL void clearPath(uint32_t pathSize);\n+\n+    template <typename FunctionType>\n+    void\n+    foreach_key_range_start(uint32_t level, FunctionType func) const\n+    {\n+        if (level > 0u) {\n+            --level;\n+            foreach_key_range_start(level, func);\n+            auto &store = _allocator->getNodeStore();\n+            auto node = _path[level].getNode();\n+            uint32_t idx = _path[level].getIdx();\n+            node->foreach_key_range(store, idx + 1, node->validSlots(), func);\n+        } else {\n+            _leaf.getNode()->foreach_key_range(_leaf.getIdx(), _leaf.getNode()->validSlots(), func);\n+        }\n+    }\n+\n+    template <typename FunctionType>\n+    void\n+    foreach_key_range_end(uint32_t level, FunctionType func) const", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MjI2OA==", "bodyText": "Please add a comment on what this the result of this while loop.", "url": "https://github.com/vespa-engine/vespa/pull/13563#discussion_r439482268", "createdAt": "2020-06-12T15:17:01Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/btree/btreeiterator.h", "diffHunk": "@@ -451,6 +483,54 @@ class BTreeIteratorBase\n             _leafRoot->foreach_key(func);\n         }\n     }\n+\n+    template <typename FunctionType>\n+    void\n+    foreach_key_range(const BTreeIteratorBase &end_itr, FunctionType func) const\n+    {\n+        if (!valid()) {\n+            return;\n+        }\n+        if (!end_itr.valid()) {\n+            foreach_key_range_start(_pathSize, func);\n+            return;\n+        }\n+        assert(_pathSize == end_itr._pathSize);\n+        assert(_allocator == end_itr._allocator);\n+        uint32_t level = _pathSize;\n+        if (level > 0u) {\n+            uint32_t idx;\n+            uint32_t eidx;\n+            do {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4NjcwOA==", "bodyText": "Please add comment describing the 3 steps done here (left, middle, and right sub trees).", "url": "https://github.com/vespa-engine/vespa/pull/13563#discussion_r439486708", "createdAt": "2020-06-12T15:25:07Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/btree/btreeiterator.h", "diffHunk": "@@ -451,6 +483,54 @@ class BTreeIteratorBase\n             _leafRoot->foreach_key(func);\n         }\n     }\n+\n+    template <typename FunctionType>\n+    void\n+    foreach_key_range(const BTreeIteratorBase &end_itr, FunctionType func) const\n+    {\n+        if (!valid()) {\n+            return;\n+        }\n+        if (!end_itr.valid()) {\n+            foreach_key_range_start(_pathSize, func);\n+            return;\n+        }\n+        assert(_pathSize == end_itr._pathSize);\n+        assert(_allocator == end_itr._allocator);\n+        uint32_t level = _pathSize;\n+        if (level > 0u) {\n+            uint32_t idx;\n+            uint32_t eidx;\n+            do {\n+                --level;\n+                assert(_path[level].getNode() == end_itr._path[level].getNode());\n+                idx = _path[level].getIdx();\n+                eidx = end_itr._path[level].getIdx();\n+                if (idx > eidx) {\n+                    return;\n+                }\n+                if (idx != eidx) {\n+                    ++level;\n+                    break;\n+                }\n+            } while (level != 0);\n+            if (level > 0u) {\n+                foreach_key_range_start(level - 1, func);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4NzQxMg==", "bodyText": "Please add doc describing function.", "url": "https://github.com/vespa-engine/vespa/pull/13563#discussion_r439487412", "createdAt": "2020-06-12T15:26:23Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/btree/btreeiterator.h", "diffHunk": "@@ -451,6 +483,54 @@ class BTreeIteratorBase\n             _leafRoot->foreach_key(func);\n         }\n     }\n+\n+    template <typename FunctionType>\n+    void\n+    foreach_key_range(const BTreeIteratorBase &end_itr, FunctionType func) const", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4NzU5OQ==", "bodyText": "Please add doc describing function.", "url": "https://github.com/vespa-engine/vespa/pull/13563#discussion_r439487599", "createdAt": "2020-06-12T15:26:44Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/btree/btreenode.h", "diffHunk": "@@ -459,6 +475,16 @@ class BTreeLeafNode : public BTreeNodeTT<KeyT, DataT, AggrT, NumSlots>\n         }\n     }\n \n+    template <typename FunctionType>\n+    void foreach_key_range(uint32_t start_idx, uint32_t end_idx, FunctionType func) const {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4NzY0MA==", "bodyText": "Please add doc describing function.", "url": "https://github.com/vespa-engine/vespa/pull/13563#discussion_r439487640", "createdAt": "2020-06-12T15:26:48Z", "author": {"login": "geirst"}, "path": "vespalib/src/vespa/vespalib/btree/btreenode.h", "diffHunk": "@@ -370,6 +370,22 @@ class BTreeInternalNode : public BTreeNodeTT<KeyT, BTreeNode::Ref, AggrT,\n         }\n     }\n \n+    template <typename NodeStoreType, typename FunctionType>\n+    void foreach_key_range(NodeStoreType &store, uint32_t start_idx, uint32_t end_idx, FunctionType func) const {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6956f91219e8d8418b74343896f87a8ea686aa"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec251301abe4aedad848b1fd4c495b5bb6b76535", "author": {"user": null}, "url": "https://github.com/vespa-engine/vespa/commit/ec251301abe4aedad848b1fd4c495b5bb6b76535", "committedDate": "2020-06-12T16:44:14Z", "message": "Add comments for foreach_key_range() method and related methods."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNDA1MjU5", "url": "https://github.com/vespa-engine/vespa/pull/13563#pullrequestreview-430405259", "createdAt": "2020-06-15T07:59:13Z", "commit": {"oid": "ec251301abe4aedad848b1fd4c495b5bb6b76535"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3619, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}