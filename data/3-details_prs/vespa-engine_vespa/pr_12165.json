{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MzM3MzA5", "number": 12165, "title": "Balder/add support for trace in accesslog", "bodyText": "@bjorncs and @bratseth PR", "createdAt": "2020-02-12T14:25:48Z", "url": "https://github.com/vespa-engine/vespa/pull/12165", "merged": true, "mergeCommit": {"oid": "cf454a47f5a9de067d46e9d6db6bf046c899aeab"}, "closed": true, "closedAt": "2020-02-12T21:40:25Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDmir4AH2gAyMzc0MzM3MzA5OjdlOTM1ZjE3N2MyYzUxOTVmYzMwNTVkNjQ5ZmE5NjJkODRiMjc1ZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD3vCugFqTM1ODA3MjU2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e935f177c2c5195fc3055d649fa962d84b275e9", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/7e935f177c2c5195fc3055d649fa962d84b275e9", "committedDate": "2020-02-12T13:42:08Z", "message": "- Add trace as a field in the josn access log.\n- Add the trace top the accesslog entry if debugging is enabled in SearchHandler."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a809a9d8939d39baad3f75ee3d7a72ed2f3104d7", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/a809a9d8939d39baad3f75ee3d7a72ed2f3104d7", "committedDate": "2020-02-12T14:08:35Z", "message": "Render Inspectable."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTMyOTc1", "url": "https://github.com/vespa-engine/vespa/pull/12165#pullrequestreview-357532975", "createdAt": "2020-02-12T15:13:21Z", "commit": {"oid": "a809a9d8939d39baad3f75ee3d7a72ed2f3104d7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNToxMzoyMVrOFoyctw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNToxNToyOFrOFoyicg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMxMzkxMQ==", "bodyText": "Why are you removing the function indirection in these?", "url": "https://github.com/vespa-engine/vespa/pull/12165#discussion_r378313911", "createdAt": "2020-02-12T15:13:21Z", "author": {"login": "bratseth"}, "path": "container-search/src/main/java/com/yahoo/search/handler/SearchHandler.java", "diffHunk": "@@ -410,7 +413,7 @@ private Result search(String request, Query query, Chain<Searcher> searchChain)\n         } catch (ParseException e) {\n             ErrorMessage error = ErrorMessage.createIllegalQuery(\"Could not parse query [\" + request + \"]: \"\n                                                                  + Exceptions.toMessageString(e));\n-            log.log(LogLevel.DEBUG, () -> error.getDetailedMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a809a9d8939d39baad3f75ee3d7a72ed2f3104d7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMxNTM3OA==", "bodyText": "Isn't the naming convention here \"acceptX\"?", "url": "https://github.com/vespa-engine/vespa/pull/12165#discussion_r378315378", "createdAt": "2020-02-12T15:15:28Z", "author": {"login": "bratseth"}, "path": "container-search/src/main/java/com/yahoo/search/rendering/JsonRenderer.java", "diffHunk": "@@ -788,11 +642,11 @@ protected void renderFieldContents(Object field) throws IOException {\n             if (field instanceof Inspectable && ! (field instanceof FeatureData)) {\n                 renderInspector(((Inspectable)field).inspect());\n             } else {\n-                renderFieldContentsDirect(field);\n+                consume(field);\n             }\n         }\n \n-        private void renderFieldContentsDirect(Object field) throws IOException {\n+        public void consume(Object field) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a809a9d8939d39baad3f75ee3d7a72ed2f3104d7"}, "originalPosition": 219}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94b00309052e520213f63a39e0ef7f5929d88272", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/94b00309052e520213f63a39e0ef7f5929d88272", "committedDate": "2020-02-12T21:22:25Z", "message": "Use method reference."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a6abd7597167c066d419fc408f2a2fdd4a4dddd", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/1a6abd7597167c066d419fc408f2a2fdd4a4dddd", "committedDate": "2020-02-12T21:38:00Z", "message": "consume -> accept"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDcyNTYy", "url": "https://github.com/vespa-engine/vespa/pull/12165#pullrequestreview-358072562", "createdAt": "2020-02-13T09:38:49Z", "commit": {"oid": "7e935f177c2c5195fc3055d649fa962d84b275e9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozODo0OVrOFpM50g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTo0MDoyMVrOFpM8uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NzM0Ng==", "bodyText": "Missing copyright header and author.", "url": "https://github.com/vespa-engine/vespa/pull/12165#discussion_r378747346", "createdAt": "2020-02-13T09:38:49Z", "author": {"login": "bjorncs"}, "path": "container-accesslogging/src/main/java/com/yahoo/container/logging/TraceRenderer.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package com.yahoo.container.logging;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e935f177c2c5195fc3055d649fa962d84b275e9"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0Nzg0MQ==", "bodyText": "Consider TraceRenderer to yolean (unless it has dependencies to types in container-accesslogging). Both TraceVisitor and TraceNode are classes from yolean.", "url": "https://github.com/vespa-engine/vespa/pull/12165#discussion_r378747841", "createdAt": "2020-02-13T09:39:51Z", "author": {"login": "bjorncs"}, "path": "container-accesslogging/src/main/java/com/yahoo/container/logging/TraceRenderer.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package com.yahoo.container.logging;\n+\n+import com.yahoo.yolean.trace.TraceNode;\n+import com.yahoo.yolean.trace.TraceVisitor;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+\n+import java.io.IOException;\n+\n+public class TraceRenderer extends TraceVisitor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e935f177c2c5195fc3055d649fa962d84b275e9"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0ODA5MQ==", "bodyText": "This could be replaced with java.io.UncheckedIOException", "url": "https://github.com/vespa-engine/vespa/pull/12165#discussion_r378748091", "createdAt": "2020-02-13T09:40:21Z", "author": {"login": "bjorncs"}, "path": "container-accesslogging/src/main/java/com/yahoo/container/logging/TraceRenderer.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package com.yahoo.container.logging;\n+\n+import com.yahoo.yolean.trace.TraceNode;\n+import com.yahoo.yolean.trace.TraceVisitor;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+\n+import java.io.IOException;\n+\n+public class TraceRenderer extends TraceVisitor {\n+    private static final String TRACE_CHILDREN = \"children\";\n+    private static final String TRACE_MESSAGE = \"message\";\n+    private static final String TRACE_TIMESTAMP = \"timestamp\";\n+    private static final String TRACE = \"trace\";\n+\n+    private final long basetime;\n+    private final JsonGenerator generator;\n+    private final FieldConsumer fieldConsumer;\n+    private boolean hasFieldName = false;\n+    int emittedChildNesting = 0;\n+    int currentChildNesting = 0;\n+    private boolean insideOpenObject = false;\n+\n+    public interface FieldConsumer {\n+        void consume(Object object) throws IOException;\n+    }\n+\n+    private static class Consumer implements FieldConsumer {\n+        private final JsonGenerator generator;\n+\n+        Consumer(JsonGenerator generator) {\n+            this.generator = generator;\n+        }\n+\n+        @Override\n+        public void consume(Object object) throws IOException {\n+            generator.writeObject(object);\n+        }\n+    }\n+\n+    TraceRenderer(JsonGenerator generator, long basetime) {\n+        this(generator, new Consumer(generator), basetime);\n+    }\n+    public TraceRenderer(JsonGenerator generator, FieldConsumer consumer, long basetime) {\n+        this.generator = generator;\n+        this.fieldConsumer = consumer;\n+        this.basetime = basetime;\n+    }\n+\n+    @Override\n+    public void entering(TraceNode node) {\n+        ++currentChildNesting;\n+    }\n+\n+    @Override\n+    public void leaving(TraceNode node) {\n+        conditionalEndObject();\n+        if (currentChildNesting == emittedChildNesting) {\n+            try {\n+                generator.writeEndArray();\n+                generator.writeEndObject();\n+            } catch (IOException e) {\n+                throw new TraceRenderWrapper(e);\n+            }\n+            --emittedChildNesting;\n+        }\n+        --currentChildNesting;\n+    }\n+\n+    @Override\n+    public void visit(TraceNode node) {\n+        try {\n+            doVisit(node.timestamp(), node.payload(), node.children().iterator().hasNext());\n+        } catch (IOException e) {\n+            throw new TraceRenderWrapper(e);\n+        }\n+    }\n+\n+    private void doVisit(long timestamp, Object payload, boolean hasChildren) throws IOException {\n+        boolean dirty = false;\n+        if (timestamp != 0L) {\n+            header();\n+            generator.writeStartObject();\n+            generator.writeNumberField(TRACE_TIMESTAMP, timestamp - basetime);\n+            dirty = true;\n+        }\n+        if (payload != null) {\n+            if (!dirty) {\n+                header();\n+                generator.writeStartObject();\n+            }\n+            generator.writeFieldName(TRACE_MESSAGE);\n+            fieldConsumer.consume(payload);\n+            dirty = true;\n+        }\n+        if (dirty) {\n+            if (!hasChildren) {\n+                generator.writeEndObject();\n+            } else {\n+                setInsideOpenObject(true);\n+            }\n+        }\n+    }\n+    private void header() {\n+        fieldName();\n+        for (int i = 0; i < (currentChildNesting - emittedChildNesting); ++i) {\n+            startChildArray();\n+        }\n+        emittedChildNesting = currentChildNesting;\n+    }\n+\n+    private void startChildArray() {\n+        try {\n+            conditionalStartObject();\n+            generator.writeArrayFieldStart(TRACE_CHILDREN);\n+        } catch (IOException e) {\n+            throw new TraceRenderWrapper(e);\n+        }\n+    }\n+\n+    private void conditionalStartObject() throws IOException {\n+        if (!isInsideOpenObject()) {\n+            generator.writeStartObject();\n+        } else {\n+            setInsideOpenObject(false);\n+        }\n+    }\n+\n+    private void conditionalEndObject() {\n+        if (isInsideOpenObject()) {\n+            // This triggers if we were inside a data node with payload and\n+            // subnodes, but none of the subnodes contained data\n+            try {\n+                generator.writeEndObject();\n+                setInsideOpenObject(false);\n+            } catch (IOException e) {\n+                throw new TraceRenderWrapper(e);\n+            }\n+        }\n+    }\n+\n+    private void fieldName() {\n+        if (hasFieldName) {\n+            return;\n+        }\n+\n+        try {\n+            generator.writeFieldName(TRACE);\n+        } catch (IOException e) {\n+            throw new TraceRenderWrapper(e);\n+        }\n+        hasFieldName = true;\n+    }\n+\n+    boolean isInsideOpenObject() {\n+        return insideOpenObject;\n+    }\n+\n+    void setInsideOpenObject(boolean insideOpenObject) {\n+        this.insideOpenObject = insideOpenObject;\n+    }\n+    public static final class TraceRenderWrapper extends RuntimeException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e935f177c2c5195fc3055d649fa962d84b275e9"}, "originalPosition": 161}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2981, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}