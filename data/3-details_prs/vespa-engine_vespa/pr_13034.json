{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3OTA0OTM4", "number": 13034, "title": "Add support for aggregating over B-tree keys", "bodyText": "@toregge @geirst please review carefully. Only a subset of aggregation tests are implemented explicitly for keys; it's not obvious how to create any kind of parameterized fixture for testing both without lots of duplication and the test file tests a lot of various cases, not all related to aggregation. Not super happy with how keys vs. value branching is done, but it's a binary choice so I felt introducing enums would be a bit overkill.\nThis complements the existing support for aggregating over values.\nLet aggregate calculator specify whether it expects to be invoked\nwith keys or values.\nIn the current implementation there is some code duplication\nthat could have been removed by using e.g. tag dispatch, but\nthis is a pragmatic choice intended to guarantee these changes\ndo not introduce any performance regressions for existing\ncode using value aggregation. Can be refactored later once we\nhave a functional baseline with this for both keys and values.", "createdAt": "2020-04-23T13:09:37Z", "url": "https://github.com/vespa-engine/vespa/pull/13034", "merged": true, "mergeCommit": {"oid": "525ab5bc9bd3ab0e1a60c6332df80b03d181b3cd"}, "closed": true, "closedAt": "2020-04-24T09:08:31Z", "author": {"login": "vekterli"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcacJn7AH2gAyNDA3OTA0OTM4OmQzODliMGUyNTE5YTEzOWRjOTEwM2EyMjcwMmJlMTc1Njk4MjYyZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaev-aAFqTM5OTIyNTUzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d389b0e2519a139dc9103a22702be175698262d8", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/d389b0e2519a139dc9103a22702be175698262d8", "committedDate": "2020-04-23T12:35:58Z", "message": "Add support for aggregating over B-tree keys\n\nThis complements the existing support for aggregating over values.\n\nLet aggregate calculator specify whether it expects to be invoked\nwith keys or values.\n\nIn the current implementation there is some code duplication\nthat could have been removed by using e.g. tag dispatch, but\nthis is a pragmatic choice intended to guarantee these changes\ndo not introduce any performance regressions for existing\ncode using value aggregation. Can be refactored later once we\nhave a functional baseline with this for both keys and values."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MTM2MDk5", "url": "https://github.com/vespa-engine/vespa/pull/13034#pullrequestreview-399136099", "createdAt": "2020-04-23T14:10:10Z", "commit": {"oid": "d389b0e2519a139dc9103a22702be175698262d8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNDoxMDoxMVrOGKqEQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNDoxMDoxMVrOGKqEQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyODE2MA==", "bodyText": "Consider renaming removed to need_aggregation_recalc.", "url": "https://github.com/vespa-engine/vespa/pull/13034#discussion_r413828160", "createdAt": "2020-04-23T14:10:11Z", "author": {"login": "toregge"}, "path": "vespalib/src/vespa/vespalib/btree/btreeremover.hpp", "diffHunk": "@@ -110,11 +110,17 @@ remove(BTreeNode::Ref &root,\n     NodeAllocatorType &allocator(itr.getAllocator());\n     AggrT oldca(AggrCalcT::hasAggregated() ? lnode->getAggregated() : AggrT());\n     AggrT ca;\n-    if (AggrCalcT::hasAggregated() &&\n-        aggrCalc.remove(lnode->getAggregated(),\n-                        aggrCalc.getVal(lnode->getData(idx)))) {\n+    if constexpr (AggrCalcT::hasAggregated()) {\n+        bool removed;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d389b0e2519a139dc9103a22702be175698262d8"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3ee3ebc4e85e408a4be486e52745743bac85d0f", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/c3ee3ebc4e85e408a4be486e52745743bac85d0f", "committedDate": "2020-04-23T14:13:37Z", "message": "Rename variable to be semantically accurate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MTQxMTI4", "url": "https://github.com/vespa-engine/vespa/pull/13034#pullrequestreview-399141128", "createdAt": "2020-04-23T14:14:59Z", "commit": {"oid": "c3ee3ebc4e85e408a4be486e52745743bac85d0f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MjI1NTMy", "url": "https://github.com/vespa-engine/vespa/pull/13034#pullrequestreview-399225532", "createdAt": "2020-04-23T15:37:40Z", "commit": {"oid": "c3ee3ebc4e85e408a4be486e52745743bac85d0f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3368, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}