{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2ODk0MzQ5", "number": 13856, "title": "If flush has been triggered due to spread, we need to prioritize that\u2026", "bodyText": "\u2026 correctly.\nWe should never prioritize bloat of single file, unless global bloat is exceeded.\nThis will significantly reduce number of compaction operations.\n@toregge or @geirst PR", "createdAt": "2020-07-09T14:23:47Z", "url": "https://github.com/vespa-engine/vespa/pull/13856", "merged": true, "mergeCommit": {"oid": "dba2bb8101d98defa03d433469831efff92ea875"}, "closed": true, "closedAt": "2020-07-09T17:16:44Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczPxQmAH2gAyNDQ2ODk0MzQ5OmE1OWFmMTE3MTQ3MmVmMGY5ZjU4ZWMyMDk5NmYyMWRlYjdlN2I5ZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczeZ39AFqTQ0NjE3Njg1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a59af1171472ef0f9f58ec20996f21deb7e7b9f2", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/a59af1171472ef0f9f58ec20996f21deb7e7b9f2", "committedDate": "2020-07-09T14:18:36Z", "message": "If flush has been triggered due to spread, we need to prioritize that correctly.\nWe should never prioritize bloat of single file, unless global bloat is exceeded.\nThis will significantly reduce number of compaction operations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Njg3OTgz", "url": "https://github.com/vespa-engine/vespa/pull/13856#pullrequestreview-445687983", "createdAt": "2020-07-09T14:45:17Z", "commit": {"oid": "a59af1171472ef0f9f58ec20996f21deb7e7b9f2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDo0NToxN1rOGvUfTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDo0NToxN1rOGvUfTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3MTk0OA==", "bodyText": "Consider a strategy to avoid having to call getDiskBloat() again here, e.g. return std::pair<bool, size_t> or just a size_t from a renamed isTotalDiskBloatExceeded().", "url": "https://github.com/vespa-engine/vespa/pull/13856#discussion_r452271948", "createdAt": "2020-07-09T14:45:17Z", "author": {"login": "toregge"}, "path": "searchlib/src/vespa/searchlib/docstore/logdatastore.cpp", "diffHunk": "@@ -313,16 +313,23 @@ LogDataStore::compact(uint64_t syncToken)\n     }\n }\n \n+bool\n+LogDataStore::isTotalDiskBloatExceeded() const {\n+    const size_t diskFootPrint = getDiskFootprint();\n+    const size_t maxConfiguredDiskBloat = diskFootPrint * _config.getMaxDiskBloatFactor();\n+    return getDiskBloat() > maxConfiguredDiskBloat;\n+}\n+\n size_t\n LogDataStore::getMaxCompactGain() const\n {\n+    size_t bloat = 0;\n+    if ( isTotalDiskBloatExceeded() ) {\n+        bloat = getDiskBloat();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a59af1171472ef0f9f58ec20996f21deb7e7b9f2"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzI2MzQ0", "url": "https://github.com/vespa-engine/vespa/pull/13856#pullrequestreview-445726344", "createdAt": "2020-07-09T15:25:34Z", "commit": {"oid": "a59af1171472ef0f9f58ec20996f21deb7e7b9f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c595d62a06070f9f4463641c40e5b9aa59cbb932", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/c595d62a06070f9f4463641c40e5b9aa59cbb932", "committedDate": "2020-07-09T17:11:51Z", "message": "Refactor to avoid deadlock due to trying to aquire a lock you already hold. Also reduce number of calls to getDiskBloat/getDiskFootPrint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MTc2ODUw", "url": "https://github.com/vespa-engine/vespa/pull/13856#pullrequestreview-446176850", "createdAt": "2020-07-10T07:21:38Z", "commit": {"oid": "c595d62a06070f9f4463641c40e5b9aa59cbb932"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3540, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}