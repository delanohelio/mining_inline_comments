{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwODQ0OTY5", "number": 13501, "title": "Arnej/global filter after fetch postings", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@geirst @toregge @havardpe please review", "createdAt": "2020-06-08T07:12:25Z", "url": "https://github.com/vespa-engine/vespa/pull/13501", "merged": true, "mergeCommit": {"oid": "dff59cae99bc52c813e40dc529edcfe252de4a53"}, "closed": true, "closedAt": "2020-06-09T07:09:30Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpA27BAH2gAyNDMwODQ0OTY5OmM1ZGJlZWRiMTAwMTNjN2U1OTMxYjVkYTI3ZDAwZGU1ODA4ZTUwZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpO3xdAH2gAyNDMwODQ0OTY5OmZmZTU2NGZlZjNkZWYzNWIzNGNjM2U0YmQ2NjFiYjY4YjQ1NDY5YjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5dbeedb10013c7e5931b5da27d00de5808e50d3", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/c5dbeedb10013c7e5931b5da27d00de5808e50d3", "committedDate": "2020-06-07T19:16:58Z", "message": "perform TopK in set_global_filter\n\n* global filter must be computed after fetchPostings,\n  so move actual TopK computation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a4e89c1e85aa1e967586606676bef35a9ad47a", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/29a4e89c1e85aa1e967586606676bef35a9ad47a", "committedDate": "2020-06-07T19:17:03Z", "message": "compute and apply global filter after fetchPostings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54a23d2bc9a05eb7d503d5be5cbe5e757eea571e", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/54a23d2bc9a05eb7d503d5be5cbe5e757eea571e", "committedDate": "2020-06-08T07:38:25Z", "message": "do estimates like before, broke unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDM5ODQz", "url": "https://github.com/vespa-engine/vespa/pull/13501#pullrequestreview-426039843", "createdAt": "2020-06-08T09:04:12Z", "commit": {"oid": "54a23d2bc9a05eb7d503d5be5cbe5e757eea571e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTE0NDU1", "url": "https://github.com/vespa-engine/vespa/pull/13501#pullrequestreview-426114455", "createdAt": "2020-06-08T10:49:16Z", "commit": {"oid": "54a23d2bc9a05eb7d503d5be5cbe5e757eea571e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMDo0OToxNlrOGgYh9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMDo0OToxNlrOGgYh9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYwOTUyNg==", "bodyText": "Until we have data on performance tests, perhaps we should not do fallback to brute force. That will make it harder to interpret the results.", "url": "https://github.com/vespa-engine/vespa/pull/13501#discussion_r436609526", "createdAt": "2020-06-08T10:49:16Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/queryeval/nearest_neighbor_blueprint.cpp", "diffHunk": "@@ -84,10 +87,15 @@ NearestNeighborBlueprint::set_global_filter(const GlobalFilter &global_filter)\n {\n     _global_filter = global_filter.shared_from_this();\n     auto nns_index = _attr_tensor.nearest_neighbor_index();\n+    LOG(debug, \"set_global_filter with: %s / %s / %s\",\n+        (_approximate ? \"approximate\" : \"exact\"),\n+        (nns_index ? \"nns_index\" : \"no_index\"),\n+        (_global_filter->has_filter() ? \"has_filter\" : \"no_filter\"));\n     if (_approximate && nns_index) {\n         uint32_t est_hits = _attr_tensor.getNumDocs();\n         if (_global_filter->has_filter()) {\n             uint32_t max_hits = _global_filter->filter()->countTrueBits();\n+            LOG(debug, \"set_global_filter getNumDocs: %u / max_hits %u\", est_hits, max_hits);\n             if (max_hits * 10 < est_hits) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54a23d2bc9a05eb7d503d5be5cbe5e757eea571e"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffe564fef3def35b34cc3e4bd661bb68b45469b6", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/ffe564fef3def35b34cc3e4bd661bb68b45469b6", "committedDate": "2020-06-08T11:36:34Z", "message": "no fallback to brute force for now"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3700, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}