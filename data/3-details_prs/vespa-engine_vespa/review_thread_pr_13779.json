{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNDM3Mzg2", "number": 13779, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMToyOTozNVrOEK21aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMTozMjowOVrOEK24QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5ODE5NjI0OnYy", "diffSide": "RIGHT", "path": "container-core/src/main/java/com/yahoo/container/handler/ClustersStatus.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMToyOTozNVrOGsIz9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjoxMDoxM1rOGsKDHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzNDkwMQ==", "bodyText": "Use isEmpty ?", "url": "https://github.com/vespa-engine/vespa/pull/13779#discussion_r448934901", "createdAt": "2020-07-02T11:29:35Z", "author": {"login": "baldersheim"}, "path": "container-core/src/main/java/com/yahoo/container/handler/ClustersStatus.java", "diffHunk": "@@ -37,11 +39,15 @@ public ClustersStatus() { }\n     /** The status of clusters, when known. Note that clusters may exist for which there is no knowledge yet. */\n     private final Map<String, Boolean> clusterStatus = new HashMap<>();\n \n-    public void setContainerHasClusters(boolean containerHasClusters) {\n+    /** Sets the current clusters of this container */\n+    public void setClusters(Set<String> clusters) {\n         synchronized (mutex) {\n-            this.containerHasClusters = containerHasClusters;\n-            if ( ! containerHasClusters)\n-                clusterStatus.clear(); // forget container clusters which was configured away\n+            this.containerHasClusters = clusters.size() > 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e940918acdd342277b8beabbeae89a6e72cfb83b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NTE2Ng==", "bodyText": "I actually think this is slightly clearer by avoiding negation.", "url": "https://github.com/vespa-engine/vespa/pull/13779#discussion_r448955166", "createdAt": "2020-07-02T12:10:13Z", "author": {"login": "bratseth"}, "path": "container-core/src/main/java/com/yahoo/container/handler/ClustersStatus.java", "diffHunk": "@@ -37,11 +39,15 @@ public ClustersStatus() { }\n     /** The status of clusters, when known. Note that clusters may exist for which there is no knowledge yet. */\n     private final Map<String, Boolean> clusterStatus = new HashMap<>();\n \n-    public void setContainerHasClusters(boolean containerHasClusters) {\n+    /** Sets the current clusters of this container */\n+    public void setClusters(Set<String> clusters) {\n         synchronized (mutex) {\n-            this.containerHasClusters = containerHasClusters;\n-            if ( ! containerHasClusters)\n-                clusterStatus.clear(); // forget container clusters which was configured away\n+            this.containerHasClusters = clusters.size() > 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzNDkwMQ=="}, "originalCommit": {"oid": "e940918acdd342277b8beabbeae89a6e72cfb83b"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5ODIwMzUzOnYy", "diffSide": "RIGHT", "path": "config/src/main/java/com/yahoo/config/subscription/ConfigSubscriber.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMTozMjowOVrOGsI4tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjoxNjoxN1rOGsKP8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzNjExOQ==", "bodyText": "You probably need a separate catch for nextConfig() that is SEVERE to ensure you you only blame the subscriber when it is truly to blame.", "url": "https://github.com/vespa-engine/vespa/pull/13779#discussion_r448936119", "createdAt": "2020-07-02T11:32:09Z", "author": {"login": "baldersheim"}, "path": "config/src/main/java/com/yahoo/config/subscription/ConfigSubscriber.java", "diffHunk": "@@ -423,21 +423,26 @@ public boolean isClosed() {\n      * @return The handle of the config\n      * @see #startConfigThread(Runnable)\n      */\n-    public <T extends ConfigInstance> ConfigHandle<T> subscribe(final SingleSubscriber<T> singleSubscriber, Class<T> configClass, String configId) {\n-        if (!subscriptionHandles.isEmpty())\n-            throw new IllegalStateException(\"Can not start single-subscription because subscriptions were previously opened on this.\");\n-        final ConfigHandle<T> handle = subscribe(configClass, configId);\n-        if (!nextConfig())\n-            throw new ConfigurationRuntimeException(\"Initial config of \" + configClass.getName() + \" failed.\");\n+    public <T extends ConfigInstance> ConfigHandle<T> subscribe(SingleSubscriber<T> singleSubscriber, Class<T> configClass, String configId) {\n+        if ( ! subscriptionHandles.isEmpty())\n+            throw new IllegalStateException(\"Can not start single-subscription because subscriptions were previously opened on this\");\n+\n+        ConfigHandle<T> handle = subscribe(configClass, configId);\n+\n+        if ( ! nextConfig())\n+            throw new ConfigurationRuntimeException(\"Initial config of \" + configClass.getName() + \" failed\");\n+\n         singleSubscriber.configure(handle.getConfig());\n         startConfigThread(() -> {\n                 while (!isClosed()) {\n                     try {\n-                        if (nextConfig()) {\n-                            if (handle.isChanged()) singleSubscriber.configure(handle.getConfig());\n-                        }\n-                    } catch (Exception e) {\n-                        log.log(SEVERE, \"Exception from config system, continuing config thread: \" + Exceptions.toMessageString(e));\n+                        if (nextConfig() && handle.isChanged())\n+                            singleSubscriber.configure(handle.getConfig());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e940918acdd342277b8beabbeae89a6e72cfb83b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1ODQ0OQ==", "bodyText": "Good point, done.", "url": "https://github.com/vespa-engine/vespa/pull/13779#discussion_r448958449", "createdAt": "2020-07-02T12:16:17Z", "author": {"login": "bratseth"}, "path": "config/src/main/java/com/yahoo/config/subscription/ConfigSubscriber.java", "diffHunk": "@@ -423,21 +423,26 @@ public boolean isClosed() {\n      * @return The handle of the config\n      * @see #startConfigThread(Runnable)\n      */\n-    public <T extends ConfigInstance> ConfigHandle<T> subscribe(final SingleSubscriber<T> singleSubscriber, Class<T> configClass, String configId) {\n-        if (!subscriptionHandles.isEmpty())\n-            throw new IllegalStateException(\"Can not start single-subscription because subscriptions were previously opened on this.\");\n-        final ConfigHandle<T> handle = subscribe(configClass, configId);\n-        if (!nextConfig())\n-            throw new ConfigurationRuntimeException(\"Initial config of \" + configClass.getName() + \" failed.\");\n+    public <T extends ConfigInstance> ConfigHandle<T> subscribe(SingleSubscriber<T> singleSubscriber, Class<T> configClass, String configId) {\n+        if ( ! subscriptionHandles.isEmpty())\n+            throw new IllegalStateException(\"Can not start single-subscription because subscriptions were previously opened on this\");\n+\n+        ConfigHandle<T> handle = subscribe(configClass, configId);\n+\n+        if ( ! nextConfig())\n+            throw new ConfigurationRuntimeException(\"Initial config of \" + configClass.getName() + \" failed\");\n+\n         singleSubscriber.configure(handle.getConfig());\n         startConfigThread(() -> {\n                 while (!isClosed()) {\n                     try {\n-                        if (nextConfig()) {\n-                            if (handle.isChanged()) singleSubscriber.configure(handle.getConfig());\n-                        }\n-                    } catch (Exception e) {\n-                        log.log(SEVERE, \"Exception from config system, continuing config thread: \" + Exceptions.toMessageString(e));\n+                        if (nextConfig() && handle.isChanged())\n+                            singleSubscriber.configure(handle.getConfig());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzNjExOQ=="}, "originalCommit": {"oid": "e940918acdd342277b8beabbeae89a6e72cfb83b"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1829, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}