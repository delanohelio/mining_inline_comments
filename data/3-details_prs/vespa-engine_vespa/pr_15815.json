{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMTQxMjk1", "number": 15815, "title": "Shut down ZooKeeper properly", "bodyText": "...and kill it with fire if it doesn't.\n@hmusum", "createdAt": "2020-12-15T10:24:56Z", "url": "https://github.com/vespa-engine/vespa/pull/15815", "merged": true, "mergeCommit": {"oid": "f5ba48c4110dcc3b73154c7e9c014f479b795a88"}, "closed": true, "closedAt": "2020-12-15T11:19:51Z", "author": {"login": "mpolden"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmXs6lAH2gAyNTQwMTQxMjk1OjE0NjhhOWRmOTMxOTZmMzhkOGZjODZkNWQyYmU2MTY1MGE5NDk4MGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmcO-DgFqTU1MjU5MDYzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1468a9df93196f38d8fc86d5d2be61650a94980f", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/1468a9df93196f38d8fc86d5d2be61650a94980f", "committedDate": "2020-12-15T10:23:14Z", "message": "Shut down ZooKeeper properly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56d4bd75d2d7cfb9fa3fe5095cf39fb7903a8bab", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/56d4bd75d2d7cfb9fa3fe5095cf39fb7903a8bab", "committedDate": "2020-12-15T10:23:14Z", "message": "Use exponential backoff for ZooKeeper restart"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzExODY2", "url": "https://github.com/vespa-engine/vespa/pull/15815#pullrequestreview-552311866", "createdAt": "2020-12-15T10:31:10Z", "commit": {"oid": "56d4bd75d2d7cfb9fa3fe5095cf39fb7903a8bab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTkwNjM1", "url": "https://github.com/vespa-engine/vespa/pull/15815#pullrequestreview-552590635", "createdAt": "2020-12-15T15:40:03Z", "commit": {"oid": "56d4bd75d2d7cfb9fa3fe5095cf39fb7903a8bab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNTo0MDowM1rOIGR1Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNTo0MDowM1rOIGR1Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1NDUyMg==", "bodyText": "I think this should have worked as follows:\n\nquorumPeer.running should be set to false (under a synchronized(quorumPeer)), which means the quorumPeer thread will eventually exit its thread\nwait until quorumPeer thread exits with quorumPeer.join(),\nthen do the rest of shutdown() tearing down resources.\n\nAs it is now (3) happens before (2), tearing down resources that might be used concurrently by the quorum peer thread.\nAnd (2) may happen a long time after we return from this method, meaning it may still run concurrently with trying to start another instance of ZK.", "url": "https://github.com/vespa-engine/vespa/pull/15815#discussion_r543454522", "createdAt": "2020-12-15T15:40:03Z", "author": {"login": "hakonhall"}, "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/VespaQuorumPeer.java", "diffHunk": "@@ -0,0 +1,53 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.zookeeper;\n+\n+import org.apache.zookeeper.server.admin.AdminServer;\n+import org.apache.zookeeper.server.quorum.QuorumPeerConfig;\n+import org.apache.zookeeper.server.quorum.QuorumPeerMain;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+/**\n+ * Starts/stops a ZooKeeper server. Extends QuorumPeerMain to be able to call initializeAndRun() and wraps\n+ * exceptions so it can be used by code that does not depend on ZooKeeper.\n+ *\n+ * @author hmusum\n+ */\n+class VespaQuorumPeer extends QuorumPeerMain {\n+\n+    private static final Logger LOG = Logger.getLogger(VespaQuorumPeer.class.getName());\n+\n+    public void start(Path path) {\n+        initializeAndRun(new String[]{ path.toFile().getAbsolutePath()});\n+    }\n+\n+    public void shutdown() {\n+        if (quorumPeer != null) {\n+            try {\n+                quorumPeer.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56d4bd75d2d7cfb9fa3fe5095cf39fb7903a8bab"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3764, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}