{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MzgxNzE0", "number": 13929, "title": "Add endpoint to delete all prod deployments", "bodyText": "", "createdAt": "2020-07-21T10:52:01Z", "url": "https://github.com/vespa-engine/vespa/pull/13929", "merged": true, "mergeCommit": {"oid": "58d31227d188ee6a11b545851d6b152766cbc7cf"}, "closed": true, "closedAt": "2020-07-21T13:38:29Z", "author": {"login": "freva"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3C_LWAH2gAyNDU0MzgxNzE0OjRkNWRkYzg3OTM1NGU4OThiNDU4MTUwZGJkN2RhNjlmZWNhZGRjMGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3FtqVgFqTQ1MjQyMDkzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d5ddc879354e898b458150dbd7da69fecaddc0a", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/4d5ddc879354e898b458150dbd7da69fecaddc0a", "committedDate": "2020-07-21T09:40:44Z", "message": "Remove redundant commit argument"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd871806391296801f5475c991c1a2d0820c7f9", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/ecd871806391296801f5475c991c1a2d0820c7f9", "committedDate": "2020-07-21T10:49:14Z", "message": "Create application package to remove all deployments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9be970a77dbe288f55853c364ea0e1df9046c629", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/9be970a77dbe288f55853c364ea0e1df9046c629", "committedDate": "2020-07-21T10:49:41Z", "message": "Add endpoint to remove all prod deployments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNDA1MzY4", "url": "https://github.com/vespa-engine/vespa/pull/13929#pullrequestreview-452405368", "createdAt": "2020-07-21T12:31:08Z", "commit": {"oid": "9be970a77dbe288f55853c364ea0e1df9046c629"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjozMTowOFrOG01sgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjozOToxMlrOG01-PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1ODg4MQ==", "bodyText": "Consider simplifying to deploymentRemoval().", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458058881", "createdAt": "2020-07-21T12:31:08Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/application/ApplicationPackage.java", "diffHunk": "@@ -184,4 +189,27 @@ private static String withoutLegacyDir(String name) {\n \n     }\n \n+    /** Creates a valid application package that will remove all application's deployments */\n+    public static ApplicationPackage createEmptyForDeploymentRemoval() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be970a77dbe288f55853c364ea0e1df9046c629"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MDc4Mw==", "bodyText": "What about test/staging? If this indeed only applies to prod, we can perhaps use the path /application/v4/tenant/{tenant}/application/{application}/environment/prod?", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458060783", "createdAt": "2020-07-21T12:34:34Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -284,6 +284,7 @@ private HttpResponse handleDELETE(Path path, HttpRequest request) {\n         if (path.matches(\"/application/v4/tenant/{tenant}\")) return deleteTenant(path.get(\"tenant\"), request);\n         if (path.matches(\"/application/v4/tenant/{tenant}/key\")) return removeDeveloperKey(path.get(\"tenant\"), request);\n         if (path.matches(\"/application/v4/tenant/{tenant}/application/{application}\")) return deleteApplication(path.get(\"tenant\"), path.get(\"application\"), request);\n+        if (path.matches(\"/application/v4/tenant/{tenant}/application/{application}/deployment\")) return removeProdAllDeployments(path.get(\"tenant\"), path.get(\"application\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be970a77dbe288f55853c364ea0e1df9046c629"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MTA0OA==", "bodyText": "Consider naming it removeAllProdDeployments.", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458061048", "createdAt": "2020-07-21T12:35:00Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -1901,12 +1902,17 @@ private HttpResponse submit(String tenant, String application, HttpRequest reque\n                                                             sourceRevision,\n                                                             authorEmail,\n                                                             sourceUrl,\n-                                                            commit,\n                                                             projectId,\n                                                             applicationPackage,\n                                                             dataParts.get(EnvironmentResource.APPLICATION_TEST_ZIP));\n     }\n \n+    private HttpResponse removeProdAllDeployments(String tenant, String application) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be970a77dbe288f55853c364ea0e1df9046c629"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MzQyMQ==", "bodyText": "Would be better if this said what happened (i.e. \"all deployments removed\"), but not important.", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458063421", "createdAt": "2020-07-21T12:39:12Z", "author": {"login": "mpolden"}, "path": "controller-server/src/test/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiTest.java", "diffHunk": "@@ -974,6 +971,36 @@ public void testMeteringResponses() {\n                               new File(\"instance1-metering.json\"));\n     }\n \n+    @Test\n+    public void testRemovingAllDeployments() {\n+        createAthenzDomainWithAdmin(ATHENZ_TENANT_DOMAIN, USER_ID);\n+        ApplicationPackage applicationPackage = new ApplicationPackageBuilder()\n+                .instances(\"instance1\")\n+                .region(\"us-west-1\")\n+                .region(\"us-east-3\")\n+                .region(\"eu-west-1\")\n+                .endpoint(\"eu\", \"default\", \"eu-west-1\")\n+                .endpoint(\"default\", \"default\", \"us-west-1\", \"us-east-3\")\n+                .build();\n+\n+        deploymentTester.controllerTester().createTenant(\"tenant1\", ATHENZ_TENANT_DOMAIN.getName(), 432L);\n+\n+        // Create tenant and deploy\n+        var app = deploymentTester.newDeploymentContext(\"tenant1\", \"application1\", \"instance1\");\n+        app.submit(applicationPackage).deploy();\n+        tester.controller().jobController().deploy(app.instanceId(), JobType.devUsEast1, Optional.empty(), applicationPackage);\n+\n+        assertEquals(Set.of(ZoneId.from(\"prod.us-west-1\"), ZoneId.from(\"prod.us-east-3\"), ZoneId.from(\"prod.eu-west-1\"), ZoneId.from(\"dev.us-east-1\")),\n+                app.instance().deployments().keySet());\n+\n+        tester.assertResponse(request(\"/application/v4/tenant/tenant1/application/application1/deployment\", DELETE)\n+                        .userIdentity(USER_ID)\n+                        .oktaAccessToken(OKTA_AT).oktaIdentityToken(OKTA_IT),\n+                \"{\\\"message\\\":\\\"Application package version: 1.0.2-unknown\\\"}\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be970a77dbe288f55853c364ea0e1df9046c629"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1034436255c66d6b00b7ee6dc1c38f71701766b0", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/1034436255c66d6b00b7ee6dc1c38f71701766b0", "committedDate": "2020-07-21T12:49:07Z", "message": "Code review fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNDIwOTMy", "url": "https://github.com/vespa-engine/vespa/pull/13929#pullrequestreview-452420932", "createdAt": "2020-07-21T12:51:19Z", "commit": {"oid": "1034436255c66d6b00b7ee6dc1c38f71701766b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3467, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}