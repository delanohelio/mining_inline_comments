{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5OTc2MTUw", "number": 15324, "title": "Separate node failure maintenance from failing", "bodyText": "", "createdAt": "2020-11-12T15:47:29Z", "url": "https://github.com/vespa-engine/vespa/pull/15324", "merged": true, "mergeCommit": {"oid": "8814cd47780de1217037cfe503dc7828383e4957"}, "closed": true, "closedAt": "2020-11-13T09:22:53Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb0jcVAH2gAyNTE5OTc2MTUwOmNjYmIwNWMyMmFjNjEwYzJmNmNiNTkwMjRlZGNjM2M5MDU4NmIxYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcDpZngH2gAyNTE5OTc2MTUwOmJkZWY5ZTk1MDRhM2Q0ZGYyYjJlNjg4N2ZhNzgyOWQ3ZDA2ZDRkNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ccbb05c22ac610c2f6cb59024edcc3c90586b1a7", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/ccbb05c22ac610c2f6cb59024edcc3c90586b1a7", "committedDate": "2020-11-12T15:46:58Z", "message": "Separate node failure maintenance from failing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee332d88dbf3acdc778b5c5a5d38685c00a27297", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/ee332d88dbf3acdc778b5c5a5d38685c00a27297", "committedDate": "2020-11-12T21:37:04Z", "message": "Use node repository clock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efa0126ed6949e7897102dfaa713d76686246680", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/efa0126ed6949e7897102dfaa713d76686246680", "committedDate": "2020-11-13T07:22:34Z", "message": "Don't make changes when there are zone-wide problems"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5ODc5ODE3", "url": "https://github.com/vespa-engine/vespa/pull/15324#pullrequestreview-529879817", "createdAt": "2020-11-13T08:51:50Z", "commit": {"oid": "ccbb05c22ac610c2f6cb59024edcc3c90586b1a7"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwODo1MTo1MFrOHyluFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwODo1NzozOVrOHyl6QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgwODg1Mw==", "bodyText": "Consider a shorter name. NodeHealthTracker?", "url": "https://github.com/vespa-engine/vespa/pull/15324#discussion_r522808853", "createdAt": "2020-11-13T08:51:50Z", "author": {"login": "mpolden"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/NodeFailureStatusUpdater.java", "diffHunk": "@@ -0,0 +1,137 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.provision.maintenance;\n+\n+import com.yahoo.config.provision.ApplicationId;\n+import com.yahoo.config.provision.ApplicationLockException;\n+import com.yahoo.config.provision.HostLivenessTracker;\n+import com.yahoo.jdisc.Metric;\n+import com.yahoo.transaction.Mutex;\n+import com.yahoo.vespa.applicationmodel.ServiceInstance;\n+import com.yahoo.vespa.applicationmodel.ServiceStatus;\n+import com.yahoo.vespa.hosted.provision.Node;\n+import com.yahoo.vespa.hosted.provision.NodeList;\n+import com.yahoo.vespa.hosted.provision.NodeRepository;\n+import com.yahoo.vespa.hosted.provision.node.Agent;\n+import com.yahoo.vespa.hosted.provision.node.History;\n+import com.yahoo.vespa.service.monitor.ServiceMonitor;\n+import com.yahoo.yolean.Exceptions;\n+\n+import java.time.Clock;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.logging.Level;\n+import java.util.stream.Collectors;\n+\n+import static java.util.stream.Collectors.counting;\n+\n+/**\n+ * Checks if nodes are responding and updates their status accordingly\n+ *\n+ * @author bratseth\n+ */\n+public class NodeFailureStatusUpdater extends NodeRepositoryMaintainer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccbb05c22ac610c2f6cb59024edcc3c90586b1a7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgxMTk2OQ==", "bodyText": "Consider simplifying to (double)downNodes.size() / (double)activeNodes.size() <= 0.2.", "url": "https://github.com/vespa-engine/vespa/pull/15324#discussion_r522811969", "createdAt": "2020-11-13T08:57:39Z", "author": {"login": "mpolden"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/NodeRepository.java", "diffHunk": "@@ -385,6 +385,18 @@ private NodeAcl getNodeAcl(Node node, NodeList candidates) {\n         return List.of(getNodeAcl(node, candidates));\n     }\n \n+    /**\n+     * Returns whether the zone managed by this node repository seems to be working.\n+     * If too many nodes are not responding, there is probably some zone-wide issue\n+     * and we should probably refrain from making changes to it.\n+     */\n+    public boolean isWorking() {\n+        NodeList activeNodes = list(State.active);\n+        if (activeNodes.size() <= 5) return true; // Not enough data to decide\n+        NodeList downNodes = activeNodes.down();\n+        return ! ( (double)downNodes.size() / (double)activeNodes.size() > 0.2 );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efa0126ed6949e7897102dfaa713d76686246680"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdef9e9504a3d4df2b2e6887fa7829d7d06d4d46", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/bdef9e9504a3d4df2b2e6887fa7829d7d06d4d46", "committedDate": "2020-11-13T09:22:03Z", "message": "Shorter name"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1929, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}