{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyODIxNDQ2", "number": 12406, "title": "Fail early on submit with missing security/clients.pem", "bodyText": "These submissions would fail in the configuration server regardless, so we might as well fail them in the controller. This way users will get an error message immediately instead of having to see it in the deployment job view in the Console.", "createdAt": "2020-03-03T08:56:39Z", "url": "https://github.com/vespa-engine/vespa/pull/12406", "merged": true, "mergeCommit": {"oid": "eba8b8ff1f82e7646b6ceb4904a56abe3b75733f"}, "closed": true, "closedAt": "2020-03-04T08:40:43Z", "author": {"login": "oyving"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJ-ZumgH2gAyMzgyODIxNDQ2OmM1MDQ3ODhmNWY2MWFjZGNhODM1ZTk3YTU2MjYzZDVmMmFmNjg2YjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKCXYAAH2gAyMzgyODIxNDQ2OmRkYzE1ZjYyNTdjMWVmY2E5NmU5MTM5OWU3NTgzZmJmZWQ2NjMyZDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c504788f5f61acdca835e97a56263d5f2af686b2", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/c504788f5f61acdca835e97a56263d5f2af686b2", "committedDate": "2020-03-03T08:53:37Z", "message": "Fail early on missing security/clients.pem in application package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07baa14310cbd62b7c94bb8f223d322fd994837b", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/07baa14310cbd62b7c94bb8f223d322fd994837b", "committedDate": "2020-03-03T08:55:16Z", "message": "Add copyright header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3OTA3Njc0", "url": "https://github.com/vespa-engine/vespa/pull/12406#pullrequestreview-367907674", "createdAt": "2020-03-03T11:39:20Z", "commit": {"oid": "07baa14310cbd62b7c94bb8f223d322fd994837b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxMTozOToyMVrOFxCabA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxMTozOToyMVrOFxCabA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2NDA3Ng==", "bodyText": "This belongs in ApplicationPackageValidator.", "url": "https://github.com/vespa-engine/vespa/pull/12406#discussion_r386964076", "createdAt": "2020-03-03T11:39:21Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -1956,6 +1956,12 @@ private HttpResponse submit(String tenant, String application, HttpRequest reque\n \n         ApplicationPackage applicationPackage = new ApplicationPackage(dataParts.get(EnvironmentResource.APPLICATION_ZIP), true);\n \n+        // if we are in public and 'security/clients.pem' is not present (i.e. we don't have any trusted\n+        // certificates), we should fail early instead of waiting for the configserver to fail.\n+        if (controller.system().isPublic() && applicationPackage.trustedCertificates().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07baa14310cbd62b7c94bb8f223d322fd994837b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "357cab0701ee5f5edec2a62b7d43e81dced46e83", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/357cab0701ee5f5edec2a62b7d43e81dced46e83", "committedDate": "2020-03-03T11:55:41Z", "message": "Move validation to validator class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3OTE4Mjkx", "url": "https://github.com/vespa-engine/vespa/pull/12406#pullrequestreview-367918291", "createdAt": "2020-03-03T11:57:43Z", "commit": {"oid": "357cab0701ee5f5edec2a62b7d43e81dced46e83"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxMTo1Nzo0NFrOFxC7MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxMTo1Nzo0NFrOFxC7MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3MjQ2NA==", "bodyText": "Should be private.", "url": "https://github.com/vespa-engine/vespa/pull/12406#discussion_r386972464", "createdAt": "2020-03-03T11:57:44Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/application/ApplicationPackageValidator.java", "diffHunk": "@@ -46,6 +46,13 @@ public void validate(Application application, ApplicationPackage applicationPack\n         validateSteps(applicationPackage.deploymentSpec());\n         validateEndpointRegions(applicationPackage.deploymentSpec());\n         validateEndpointChange(application, applicationPackage, instant);\n+        validateSecurityClientsPem(applicationPackage);\n+    }\n+\n+    /** Verify that we have the security/clients.pem file for public systems */\n+    public void validateSecurityClientsPem(ApplicationPackage applicationPackage) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "357cab0701ee5f5edec2a62b7d43e81dced46e83"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f9bfebd97b4499056186024b75d7ae360e78bdd", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/5f9bfebd97b4499056186024b75d7ae360e78bdd", "committedDate": "2020-03-03T11:59:35Z", "message": "Make private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca8c2aef95c43bce8759eb468ccdf80688293da4", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/ca8c2aef95c43bce8759eb468ccdf80688293da4", "committedDate": "2020-03-03T12:11:14Z", "message": "Fix test by referencing a zone that exists in mock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3OTUyMTEy", "url": "https://github.com/vespa-engine/vespa/pull/12406#pullrequestreview-367952112", "createdAt": "2020-03-03T12:53:10Z", "commit": {"oid": "ca8c2aef95c43bce8759eb468ccdf80688293da4"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddc15f6257c1efca96e91399e7583fbfed6632d7", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/ddc15f6257c1efca96e91399e7583fbfed6632d7", "committedDate": "2020-03-03T13:30:40Z", "message": "Add a way to add a dummy certificate for testing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2866, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}