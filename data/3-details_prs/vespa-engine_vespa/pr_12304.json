{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MjcwOTMy", "number": 12304, "title": "use authority for sni", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@vekterli please review\n@bjorncs FYI", "createdAt": "2020-02-21T12:59:41Z", "url": "https://github.com/vespa-engine/vespa/pull/12304", "merged": true, "mergeCommit": {"oid": "db61d5bca38d879b6d0d5dd7b179ce689023f01a"}, "closed": true, "closedAt": "2020-02-24T10:32:50Z", "author": {"login": "havardpe"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGclaXAH2gAyMzc4MjcwOTMyOjZlMjNhNzljN2NlZjA1OTQ5NWEyMTYzZGUzOGFjYTAyYjhlM2M3OWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHbAd9AH2gAyMzc4MjcwOTMyOmFkMTU4NDMzODEyMDk3YzkwM2E4OWNlNjAwZTliM2RiZWQ3NDA0ZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6e23a79c7cef059495a2163de38aca02b8e3c79d", "author": {"user": {"login": "havardpe", "name": "H\u00e5vard Pettersen"}}, "url": "https://github.com/vespa-engine/vespa/commit/6e23a79c7cef059495a2163de38aca02b8e3c79d", "committedDate": "2020-02-21T09:47:50Z", "message": "use authority for sni"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNjQ0NTYz", "url": "https://github.com/vespa-engine/vespa/pull/12304#pullrequestreview-362644563", "createdAt": "2020-02-21T13:56:51Z", "commit": {"oid": "6e23a79c7cef059495a2163de38aca02b8e3c79d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxMzo1Njo1MVrOFs3pwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxMzo1Njo1MVrOFs3pwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU5MzQ3Mg==", "bodyText": "Is this needed here when it's already declared in util/authority.h?", "url": "https://github.com/vespa-engine/vespa/pull/12304#discussion_r382593472", "createdAt": "2020-02-21T13:56:51Z", "author": {"login": "vekterli"}, "path": "fbench/src/test/authority/authority_test.cpp", "diffHunk": "@@ -0,0 +1,89 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <util/authority.h>\n+#include <vespa/vespalib/gtest/gtest.h>\n+\n+using vespalib::SocketSpec;\n+\n+//-----------------------------------------------------------------------------\n+\n+TEST(MakeSNISpecTest, host_port_is_parsed_as_expected) {\n+    EXPECT_EQ(make_sni_spec(\"my_host:123\", \"fallback\", 456, false).host(), \"my_host\");\n+    EXPECT_EQ(make_sni_spec(\"my_host:123\", \"fallback\", 456, true).host(), \"my_host\");\n+    EXPECT_EQ(make_sni_spec(\"my_host:123\", \"fallback\", 456, false).port(), 123);\n+    EXPECT_EQ(make_sni_spec(\"my_host:123\", \"fallback\", 456, true).port(), 123);\n+}\n+\n+TEST(MakeSNISpecTest, user_info_is_stripped) {\n+    EXPECT_EQ(make_sni_spec(\"myuser:deprecated@my_host:123\", \"fallback\", 456, false).host(), \"my_host\");\n+    EXPECT_EQ(make_sni_spec(\"myuser:deprecated@my_host:123\", \"fallback\", 456, true).host(), \"my_host\");\n+    EXPECT_EQ(make_sni_spec(\"myuser:deprecated@my_host:123\", \"fallback\", 456, false).port(), 123);\n+    EXPECT_EQ(make_sni_spec(\"myuser:deprecated@my_host:123\", \"fallback\", 456, true).port(), 123);\n+}\n+\n+TEST(MakeSNISpecTest, port_can_be_skipped) {\n+    EXPECT_EQ(make_sni_spec(\"my_host\", \"fallback\", 456, false).host(), \"my_host\");\n+    EXPECT_EQ(make_sni_spec(\"my_host\", \"fallback\", 456, true).host(), \"my_host\");\n+    EXPECT_EQ(make_sni_spec(\"my_host\", \"fallback\", 456, false).port(), 80);\n+    EXPECT_EQ(make_sni_spec(\"my_host\", \"fallback\", 456, true).port(), 443);\n+}\n+\n+TEST(MakeSNISpecTest, quoted_ip_addresses_work_as_expected) {\n+    EXPECT_EQ(make_sni_spec(\"[::1]:123\", \"fallback\", 456, false).host(), \"::1\");\n+    EXPECT_EQ(make_sni_spec(\"[::1]:123\", \"fallback\", 456, true).host(), \"::1\");\n+    EXPECT_EQ(make_sni_spec(\"[::1]:123\", \"fallback\", 456, false).port(), 123);\n+    EXPECT_EQ(make_sni_spec(\"[::1]:123\", \"fallback\", 456, true).port(), 123);\n+    EXPECT_EQ(make_sni_spec(\"[::1]\", \"fallback\", 456, false).host(), \"::1\");\n+    EXPECT_EQ(make_sni_spec(\"[::1]\", \"fallback\", 456, true).host(), \"::1\");\n+    EXPECT_EQ(make_sni_spec(\"[::1]\", \"fallback\", 456, false).port(), 80);\n+    EXPECT_EQ(make_sni_spec(\"[::1]\", \"fallback\", 456, true).port(), 443);\n+}\n+\n+TEST(MakeSNISpecTest, supplied_host_port_is_used_as_fallback) {\n+    EXPECT_EQ(make_sni_spec(\"\", \"fallback\", 456, false).host(), \"fallback\");\n+    EXPECT_EQ(make_sni_spec(\"\", \"fallback\", 456, true).host(), \"fallback\");\n+    EXPECT_EQ(make_sni_spec(\"\", \"fallback\", 456, false).port(), 456);\n+    EXPECT_EQ(make_sni_spec(\"\", \"fallback\", 456, true).port(), 456);\n+}\n+\n+//-----------------------------------------------------------------------------\n+\n+std::string make_host_header_value(const vespalib::SocketSpec &sni_spec, bool use_https);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e23a79c7cef059495a2163de38aca02b8e3c79d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad158433812097c903a89ce600e9b3dbed7404fb", "author": {"user": {"login": "havardpe", "name": "H\u00e5vard Pettersen"}}, "url": "https://github.com/vespa-engine/vespa/commit/ad158433812097c903a89ce600e9b3dbed7404fb", "committedDate": "2020-02-24T10:31:30Z", "message": "remove leftovers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2938, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}