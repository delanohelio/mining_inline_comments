{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4ODc4NjQ5", "number": 15019, "title": "Create maintainer tracking host repair status", "bodyText": "Extended ZmsClient to add/delete policy rules\nExtended controller's node repo client with patchNode function", "createdAt": "2020-10-23T10:41:06Z", "url": "https://github.com/vespa-engine/vespa/pull/15019", "merged": true, "mergeCommit": {"oid": "836f93ca25c729795f5401272f087cf11793c0e0"}, "closed": true, "closedAt": "2020-10-23T17:04:32Z", "author": {"login": "olaaun"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVUHrcAH2gAyNTA4ODc4NjQ5OjM2NDJiODVkNjFlMjE5ODA5Zjc5Njg5ZjM5MmYzZGM3OGQxOGJlMGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVXpzHgFqTUxNTczMzk5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3642b85d61e219809f79689f392f3dc78d18be0d", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/3642b85d61e219809f79689f392f3dc78d18be0d", "committedDate": "2020-10-23T10:36:08Z", "message": "Create maintainer tracking host repair status\nExtended ZmsClient to add/delete policy rules\nExtended controller's node repo client with patchNode function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "877e68322991c5133c5253410a4bb9c22c55e93b", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/877e68322991c5133c5253410a4bb9c22c55e93b", "committedDate": "2020-10-23T11:33:07Z", "message": "Fix String formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ceb3deefdafd77ce2dba976a5124faa8b7f75f1", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/5ceb3deefdafd77ce2dba976a5124faa8b7f75f1", "committedDate": "2020-10-23T12:09:07Z", "message": "Id, not assertionId"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NjA1NTQ5", "url": "https://github.com/vespa-engine/vespa/pull/15019#pullrequestreview-515605549", "createdAt": "2020-10-23T12:09:14Z", "commit": {"oid": "877e68322991c5133c5253410a4bb9c22c55e93b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjowOToxNVrOHnLFjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjo1NzozOVrOHnMubw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDgzODE1Nw==", "bodyText": "Current naming convention on this seems is camel case.", "url": "https://github.com/vespa-engine/vespa/pull/15019#discussion_r510838157", "createdAt": "2020-10-23T12:09:15Z", "author": {"login": "freva"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/repair/RepairTicketReport.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.api.integration.repair;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import static com.yahoo.yolean.Exceptions.uncheck;\n+\n+/**\n+ * @author olaa\n+ */\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class RepairTicketReport {\n+\n+    private static final String REPORT_ID = \"repair-ticket\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "877e68322991c5133c5253410a4bb9c22c55e93b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg2Mjg1NQ==", "bodyText": "Doesn't the annotation apply to the next declaration? I.e. status in this case.", "url": "https://github.com/vespa-engine/vespa/pull/15019#discussion_r510862855", "createdAt": "2020-10-23T12:54:07Z", "author": {"login": "freva"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/repair/RepairTicketReport.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.api.integration.repair;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import static com.yahoo.yolean.Exceptions.uncheck;\n+\n+/**\n+ * @author olaa\n+ */\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class RepairTicketReport {\n+\n+    private static final String REPORT_ID = \"repair-ticket\";\n+    private static final ObjectMapper objectMapper = new ObjectMapper();@JsonIgnore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ceb3deefdafd77ce2dba976a5124faa8b7f75f1"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg2NTAwNw==", "bodyText": "Consider reversing this to avoid NPE", "url": "https://github.com/vespa-engine/vespa/pull/15019#discussion_r510865007", "createdAt": "2020-10-23T12:57:39Z", "author": {"login": "freva"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostRepairMaintainer.java", "diffHunk": "@@ -0,0 +1,81 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.maintenance;\n+\n+import com.yahoo.config.provision.CloudName;\n+import com.yahoo.config.provision.SystemName;\n+import com.yahoo.config.provision.zone.ZoneApi;\n+import com.yahoo.vespa.hosted.controller.Controller;\n+import com.yahoo.vespa.hosted.controller.api.integration.configserver.Node;\n+import com.yahoo.vespa.hosted.controller.api.integration.configserver.NodeRepository;\n+import com.yahoo.vespa.hosted.controller.api.integration.repair.RepairTicketReport;\n+import com.yahoo.vespa.hosted.controller.api.integration.repair.HostRepairClient;\n+import com.yahoo.yolean.Exceptions;\n+\n+import java.time.Duration;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.function.Predicate;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import static com.yahoo.yolean.Exceptions.uncheck;\n+\n+/**\n+ *\n+ * Responsible for keeping track of hosts under repair.\n+ *\n+ * @author olaa\n+ */\n+public class HostRepairMaintainer extends ControllerMaintainer {\n+\n+    private final NodeRepository nodeRepository;\n+    private final HostRepairClient repairClient;\n+\n+    private static final Logger log = Logger.getLogger(HostRepairMaintainer.class.getName());\n+\n+\n+    public HostRepairMaintainer(Controller controller, Duration interval) {\n+        super(controller, interval, null, SystemName.allOf(Predicate.not(SystemName::isPublic)));\n+        this.nodeRepository = controller.serviceRegistry().configServer().nodeRepository();\n+        this.repairClient = controller.serviceRegistry().hostRepairClient();\n+    }\n+\n+\n+    @Override\n+    protected boolean maintain() {\n+        AtomicInteger exceptions = new AtomicInteger(0);\n+\n+        controller().zoneRegistry().zones()\n+                .reachable().zones().stream()\n+                .forEach(zoneApi -> {\n+                            var nodeTicketMap = nodeRepository.list((zoneApi).getId())\n+                                    .stream()\n+                                    .filter(this::hasOpenTicket)\n+                                    .collect(Collectors.toMap(\n+                                            node -> node,\n+                                            this::getTicketReport)\n+                                    );\n+                            try {\n+                                repairClient.updateRepairStatus(zoneApi, nodeTicketMap);\n+                            } catch (Exception e) {\n+                                log.warning(\"Failed to update repair status; \" + Exceptions.toMessageString(e));\n+                                exceptions.incrementAndGet();\n+                            }\n+                        }\n+                );\n+\n+        return exceptions.get() == 0;\n+    }\n+\n+\n+    private boolean hasOpenTicket(Node node) {\n+        var reports = node.reports();\n+        if (!reports.containsKey(RepairTicketReport.getReportId())) {\n+            return false;\n+        }\n+        return getTicketReport(node).getStatus().equals(\"OPEN\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ceb3deefdafd77ce2dba976a5124faa8b7f75f1"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85609870b4efb0029c202ef2730547f8c3faa32f", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/85609870b4efb0029c202ef2730547f8c3faa32f", "committedDate": "2020-10-23T13:56:23Z", "message": "Add lastUpdated field to report. Report ID uses camel case. Remove unnecessary JsonIgnore. Reverse String comparison"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzMzOTk3", "url": "https://github.com/vespa-engine/vespa/pull/15019#pullrequestreview-515733997", "createdAt": "2020-10-23T14:43:07Z", "commit": {"oid": "85609870b4efb0029c202ef2730547f8c3faa32f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2336, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}