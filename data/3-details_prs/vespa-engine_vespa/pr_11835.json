{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MTAyNDY3", "number": 11835, "title": "Use bucket_space metric in retirement", "bodyText": "This makes the Cluster Controller use the\nvds.datastored.bucket_space.buckets_total, dimension bucketSpace=default, to\ndetermine whether a content node manages zero buckets, and if so, will allow\nthe node to go permanently down. This is used when a node is retiring, and it\nis to be removed from the application.\nThe change is guarded by the use-bucket-space-metric, default true. If the new\nmetric doesn't work as expected, we can revert to using the current/old metric\nby flipping the flag. The flag can be controlled per application.", "createdAt": "2020-01-17T11:43:00Z", "url": "https://github.com/vespa-engine/vespa/pull/11835", "merged": true, "mergeCommit": {"oid": "1efbe682b45b918d4217a1eceb9b53d19818cf10"}, "closed": true, "closedAt": "2020-01-20T08:29:05Z", "author": {"login": "hakonhall"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7NMywAH2gAyMzY0MTAyNDY3OmMyOGYxM2RhYzU5MTY3ZGVlMTI1N2Y1YjIzODM1ZTY0NDFiYzVmMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7etBFgFqTM0NDkzMTYzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c28f13dac59167dee1257f5b23835e6441bc5f31", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/c28f13dac59167dee1257f5b23835e6441bc5f31", "committedDate": "2020-01-17T11:39:12Z", "message": "Use bucket_space metric in retirement\n\nThis makes the Cluster Controller use the\nvds.datastored.bucket_space.buckets_total, dimension bucketSpace=default, to\ndetermine whether a content node manages zero buckets, and if so, will allow\nthe node to go permanently down. This is used when a node is retiring, and it\nis to be removed from the application.\n\nThe change is guarded by the use-bucket-space-metric, default true. If the new\nmetric doesn't work as expected, we can revert to using the current/old metric\nby flipping the flag. The flag can be controlled per application."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NjIyODMz", "url": "https://github.com/vespa-engine/vespa/pull/11835#pullrequestreview-344622833", "createdAt": "2020-01-17T14:42:45Z", "commit": {"oid": "c28f13dac59167dee1257f5b23835e6441bc5f31"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDo0Mjo0NVrOFe7ERg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDo0Nzo1MlrOFe7O2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk2OTM1MA==", "bodyText": "Consider moving the comment (or comma) here and above to make the inline comment point at the right parameter", "url": "https://github.com/vespa-engine/vespa/pull/11835#discussion_r367969350", "createdAt": "2020-01-17T14:42:45Z", "author": {"login": "vekterli"}, "path": "clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java", "diffHunk": "@@ -56,7 +56,7 @@ protected void setUp(boolean dontInitializeNode2) throws Exception {\n             Set<ConfiguredNode> nodesInSlobrok = FleetControllerTest.toNodes(1, 3, 5, 7);\n \n             ContentCluster cluster = new ContentCluster(\n-                    \"music\", nodes, distribution, 4 /* minStorageNodesUp*/, 0.0 /* minRatioOfStorageNodesUp */);\n+                    \"music\", nodes, distribution, 4 /* minStorageNodesUp*/, 0.0, /* minRatioOfStorageNodesUp */true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c28f13dac59167dee1257f5b23835e6441bc5f31"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk3MTA3Mg==", "bodyText": "Typo: s/efefct/effect/", "url": "https://github.com/vespa-engine/vespa/pull/11835#discussion_r367971072", "createdAt": "2020-01-17T14:45:58Z", "author": {"login": "vekterli"}, "path": "flags/src/main/java/com/yahoo/vespa/flags/Flags.java", "diffHunk": "@@ -83,6 +83,13 @@\n             \"Takes effect on next node agent tick. Change is orchestrated, but does NOT require container restart\",\n             HOSTNAME, APPLICATION_ID);\n \n+    public static final UnboundBooleanFlag USE_BUCKET_SPACE_METRIC = defineFeatureFlag(\n+            \"use-bucket-space-metric\", true,\n+            \"Whether to use vds.datastored.bucket_space.buckets_total (true) instead of \" +\n+            \"vds.datastored.alldisks.buckets (false, legacy).\",\n+            \"Takes efefct on the next deployment of the application\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c28f13dac59167dee1257f5b23835e6441bc5f31"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk3MjA1Ng==", "bodyText": "For completeness, consider also adding a check that the global bucketSpace dimension has zero buckets.", "url": "https://github.com/vespa-engine/vespa/pull/11835#discussion_r367972056", "createdAt": "2020-01-17T14:47:52Z", "author": {"login": "vekterli"}, "path": "clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/hostinfo/HostInfoTest.java", "diffHunk": "@@ -49,11 +52,16 @@ public void testFullSet() throws IOException {\n         assertThat(storageNodeList.size(), is(2));\n         assertThat(storageNodeList.get(0).getIndex(), is(0));\n         List<Metrics.Metric> metrics = hostInfo.getMetrics().getMetrics();\n-        assertThat(metrics.size(), is(2));\n-        Metrics.Value value = metrics.get(0).getValue();\n-        assertThat(value.getLast(), is(5095L));\n+        assertThat(metrics.size(), is(4));\n+        assertThat(metrics.get(0).getValue().getLast(), is(5095L));\n         assertThat(metrics.get(0).getName(), equalTo(\"vds.datastored.alldisks.buckets\"));\n+        assertThat(metrics.get(3).getValue().getLast(), is(129L));\n+        assertThat(metrics.get(3).getName(), equalTo(\"vds.datastored.bucket_space.buckets_total\"));\n         assertThat(hostInfo.getClusterStateVersionOrNull(), is(123));\n+\n+        Optional<Metrics.Value> value = hostInfo.getMetrics()\n+                .getValueAt(\"vds.datastored.bucket_space.buckets_total\", Map.of(\"bucketSpace\", \"default\"));\n+        assertThat(value.map(Metrics.Value::getLast), equalTo(Optional.of(129L)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c28f13dac59167dee1257f5b23835e6441bc5f31"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e50ede25fe5f3a45badb59fa45023af0e2d3a01e", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/e50ede25fe5f3a45badb59fa45023af0e2d3a01e", "committedDate": "2020-01-17T15:21:22Z", "message": "Test metric value for different dimensions, and more"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTMxNjMy", "url": "https://github.com/vespa-engine/vespa/pull/11835#pullrequestreview-344931632", "createdAt": "2020-01-18T08:02:47Z", "commit": {"oid": "e50ede25fe5f3a45badb59fa45023af0e2d3a01e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3929, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}