{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMDIxMzA4", "number": 15116, "title": "Add striped content node B-tree bucket database impl", "bodyText": "@geirst please review. Not production ready yet due to distribution bit enforcement limitations (and more low-level testing needed), but should be good to go for benchmarking.", "createdAt": "2020-10-30T13:54:53Z", "url": "https://github.com/vespa-engine/vespa/pull/15116", "merged": true, "mergeCommit": {"oid": "c3c3c80cc34eff69f3ca0282da08bee2caa733cc"}, "closed": true, "closedAt": "2020-11-02T12:08:30Z", "author": {"login": "vekterli"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXm4ryAH2gAyNTEzMDIxMzA4OjIwYTU3Mjk0ODQwNTIzMmM0ZmQ1Yjc0MzYwYzY2N2UyOTA1OGQyZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYieojgFqTUyMTUyOTA4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "20a572948405232c4fd5b74360c667e29058d2f8", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/20a572948405232c4fd5b74360c667e29058d2f8", "committedDate": "2020-10-30T13:35:48Z", "message": "Add striped implementation of B-tree content node bucket database\n\nAbstracts away multiple underlying B-tree DBs that each hold a subset\nof the super bucket space. Offers ordered iteration via a priority-queue\nbased view over the sub DBs.\n\nNot yet ready for prime time, as the striping inherently requires an\nabsolute lower bound on the bucket bits used in the system, which is\ncurrently not enforced."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d917736806d1e69b0b662657b5ab09e1bc5b904", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/6d917736806d1e69b0b662657b5ab09e1bc5b904", "committedDate": "2020-10-30T13:51:09Z", "message": "Add stripe bits config and wire to implementation\n\nDefault is zero bits, which causes the standard, non-striped\nimplementation to be used."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "848ef45a8fa00dc553919f7947507b6e41ed4381", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/848ef45a8fa00dc553919f7947507b6e41ed4381", "committedDate": "2020-10-30T15:18:52Z", "message": "Add test for explicit read guard iterator key ordering"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDY3OTIw", "url": "https://github.com/vespa-engine/vespa/pull/15116#pullrequestreview-521467920", "createdAt": "2020-11-02T09:40:52Z", "commit": {"oid": "20a572948405232c4fd5b74360c667e29058d2f8"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOTo0MDo1MlrOHr8zrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOTo1MjowN1rOHr9Oyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NzA4Ng==", "bodyText": "Consider adding class comment.", "url": "https://github.com/vespa-engine/vespa/pull/15116#discussion_r515847086", "createdAt": "2020-11-02T09:40:52Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/bucketdb/const_iterator.h", "diffHunk": "@@ -0,0 +1,18 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+#pragma once\n+\n+#include <cstdint>\n+\n+namespace storage::bucketdb {\n+\n+template <typename ConstRefT>\n+class ConstIterator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20a572948405232c4fd5b74360c667e29058d2f8"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0ODQwMg==", "bodyText": "Nitpick: Consider /** */ for class comments as used elsewhere.", "url": "https://github.com/vespa-engine/vespa/pull/15116#discussion_r515848402", "createdAt": "2020-11-02T09:43:07Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/bucketdb/striped_btree_lockable_map.h", "diffHunk": "@@ -0,0 +1,88 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+#pragma once\n+\n+#include \"btree_lockable_map.h\"\n+#include <memory>\n+#include <vector>\n+\n+namespace storage::bucketdb {\n+\n+// Bucket database implementation that stripes all superbuckets across", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20a572948405232c4fd5b74360c667e29058d2f8"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0OTY3OA==", "bodyText": "I think we can remove this.", "url": "https://github.com/vespa-engine/vespa/pull/15116#discussion_r515849678", "createdAt": "2020-11-02T09:45:09Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/bucketdb/striped_btree_lockable_map.hpp", "diffHunk": "@@ -0,0 +1,315 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+#pragma once\n+\n+#include \"striped_btree_lockable_map.h\"\n+#include \"btree_lockable_map.hpp\"\n+#include <algorithm>\n+#include <cassert>\n+#include <queue>\n+\n+namespace storage::bucketdb {\n+\n+namespace {\n+\n+constexpr uint8_t used_bits_of(uint64_t key) noexcept {\n+    return static_cast<uint8_t>(key & 0b11'1111ULL);\n+}\n+\n+}\n+\n+// TODO rename to sharded_btree_lockable_map instead?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20a572948405232c4fd5b74360c667e29058d2f8"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg1NDAyNw==", "bodyText": "Nitpick: Consider using /** */ instead.", "url": "https://github.com/vespa-engine/vespa/pull/15116#discussion_r515854027", "createdAt": "2020-11-02T09:52:07Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/common/content_bucket_db_options.h", "diffHunk": "@@ -0,0 +1,16 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+#pragma once\n+\n+#include <cstdint>\n+\n+namespace storage {\n+\n+// Type-safe encapsulation of any options that can be passed from config", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d917736806d1e69b0b662657b5ab09e1bc5b904"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fe9b99240dc82a0416608c1f92c6ab50eea5dc4", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/7fe9b99240dc82a0416608c1f92c6ab50eea5dc4", "committedDate": "2020-11-02T10:02:43Z", "message": "Update and add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNTI5MDgx", "url": "https://github.com/vespa-engine/vespa/pull/15116#pullrequestreview-521529081", "createdAt": "2020-11-02T11:01:25Z", "commit": {"oid": "7fe9b99240dc82a0416608c1f92c6ab50eea5dc4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMTowMToyNVrOHr_ukQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMTowMToyNVrOHr_ukQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg5NDkyOQ==", "bodyText": "This might not work as intended if _n_stripe_bits is 0.", "url": "https://github.com/vespa-engine/vespa/pull/15116#discussion_r515894929", "createdAt": "2020-11-02T11:01:25Z", "author": {"login": "toregge"}, "path": "storage/src/vespa/storage/bucketdb/striped_btree_lockable_map.hpp", "diffHunk": "@@ -0,0 +1,313 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+#pragma once\n+\n+#include \"striped_btree_lockable_map.h\"\n+#include \"btree_lockable_map.hpp\"\n+#include <algorithm>\n+#include <cassert>\n+#include <queue>\n+\n+namespace storage::bucketdb {\n+\n+namespace {\n+\n+constexpr uint8_t used_bits_of(uint64_t key) noexcept {\n+    return static_cast<uint8_t>(key & 0b11'1111ULL);\n+}\n+\n+}\n+\n+template <typename T>\n+StripedBTreeLockableMap<T>::StripedBTreeLockableMap(uint8_t n_stripe_bits)\n+    : _n_stripe_bits(n_stripe_bits),\n+      _n_stripes(1ULL << _n_stripe_bits),\n+      _stripes()\n+{\n+    assert(_n_stripe_bits > 0);\n+    assert(_n_stripe_bits <= MaxStripeBits);\n+    _stripes.reserve(_n_stripes);\n+    for (size_t i = 0; i < _n_stripes; ++i) {\n+        // TODO reduce initial sub-DB data store memory usage based on number of stripes\n+        _stripes.emplace_back(std::make_unique<BTreeLockableMap<T>>());\n+    }\n+}\n+\n+template <typename T>\n+StripedBTreeLockableMap<T>::~StripedBTreeLockableMap() = default;\n+\n+template <typename T>\n+size_t StripedBTreeLockableMap<T>::stripe_of(key_type key) const noexcept {\n+    assert(used_bits_of(key) >= _n_stripe_bits);\n+    // Since bucket keys have count-bits at the LSB positions, we want to look at the MSBs instead.\n+    return (key >> (64 - _n_stripe_bits));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fe9b99240dc82a0416608c1f92c6ab50eea5dc4"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2253, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}