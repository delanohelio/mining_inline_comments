{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxODMyMDgz", "number": 15642, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToyMzo1M1rOFATpDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToyMzo1M1rOFATpDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODY2MTI3OnYy", "diffSide": "RIGHT", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/AutoscalingMaintainer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToyMzo1M1rOH-hxCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDo0MTo0MFrOH-xm3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyNjk4NQ==", "bodyText": "How do we know when data distribution has to completed if we add new nodes?\nSince we know from the event what the target is, wouldn't it be better to identify the nodes that we are scaling to (i.e. the count nodes that are active, not retired and have the same resources as the cluster.targetResources()), then for each of those check with cluster controller if the node is in sync?", "url": "https://github.com/vespa-engine/vespa/pull/15642#discussion_r535326985", "createdAt": "2020-12-03T15:23:53Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/AutoscalingMaintainer.java", "diffHunk": "@@ -87,13 +95,38 @@ private Applications applications() {\n         return nodeRepository().applications();\n     }\n \n+    /** Check if the last scaling event for this cluster has completed and if so record it in the returned instance */\n+    private Cluster updateCompletion(Cluster cluster, NodeList clusterNodes) {\n+        if (cluster.lastScalingEvent().isEmpty()) return cluster;\n+        var event = cluster.lastScalingEvent().get();\n+        if (event.completion().isPresent()) return cluster;\n+\n+        // Scaling event is complete if:\n+        // - 1. no nodes which was retired by this are still present (which also implies data distribution is complete)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edcd9b7ea4a5506c8bf669ae0f3e81a615796746"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4NjUyNg==", "bodyText": "Yes, you are right; in that case we need to talk to the cluster controller. Not everything else is in place for content clusters yet either: They don't send the generation metric, and some times apply the new generation too quickly.", "url": "https://github.com/vespa-engine/vespa/pull/15642#discussion_r535586526", "createdAt": "2020-12-03T20:41:40Z", "author": {"login": "bratseth"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/AutoscalingMaintainer.java", "diffHunk": "@@ -87,13 +95,38 @@ private Applications applications() {\n         return nodeRepository().applications();\n     }\n \n+    /** Check if the last scaling event for this cluster has completed and if so record it in the returned instance */\n+    private Cluster updateCompletion(Cluster cluster, NodeList clusterNodes) {\n+        if (cluster.lastScalingEvent().isEmpty()) return cluster;\n+        var event = cluster.lastScalingEvent().get();\n+        if (event.completion().isPresent()) return cluster;\n+\n+        // Scaling event is complete if:\n+        // - 1. no nodes which was retired by this are still present (which also implies data distribution is complete)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyNjk4NQ=="}, "originalCommit": {"oid": "edcd9b7ea4a5506c8bf669ae0f3e81a615796746"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2115, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}