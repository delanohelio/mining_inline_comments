{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNDM3Mzg2", "number": 13779, "title": "Bratseth/healt check improvements", "bodyText": "@baldersheim see the commit message on the first commit for an explanation", "createdAt": "2020-07-02T10:52:01Z", "url": "https://github.com/vespa-engine/vespa/pull/13779", "merged": true, "mergeCommit": {"oid": "0ba33ff6c954c9103521e072ce861f1a99891353"}, "closed": true, "closedAt": "2020-07-02T12:16:28Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcw7zJrgH2gAyNDQzNDM3Mzg2OmViMzdmN2RjYmQ4OTE0MzcxNWZiZTliODM4YTkxYjI5NmRiMGEzYzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw90gAAH2gAyNDQzNDM3Mzg2OjJiMDk5YWU4NjZlN2E5OWIyN2IzNjRmNmMyNjE1N2U3ODZjYzA5MGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb37f7dcbd89143715fbe9b838a91b296db0a3c9", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/eb37f7dcbd89143715fbe9b838a91b296db0a3c9", "committedDate": "2020-07-02T09:54:43Z", "message": "Improvements to handling of cluster removal\n\n- Don't change health status to \"initializing\" when creating a new VipStatus,\n  as 'initializing' now requires all clusters to be up to transition to 'up',\n  which means that if we're already up but are missing a cluster we'll go from\n  'up' to 'initializing' and stay there.\n- Forget up/down status for removed clusters.\n- Nicer logging on ignorable reconfiguration errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96a3e9f538ee5c542566cc5cb7f5d4c35453dcde", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/96a3e9f538ee5c542566cc5cb7f5d4c35453dcde", "committedDate": "2020-07-02T10:50:47Z", "message": "Add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44ee41136395122c2d13a738b2dc9b0b66f69917", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/44ee41136395122c2d13a738b2dc9b0b66f69917", "committedDate": "2020-07-02T10:55:53Z", "message": "Update ABI spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e940918acdd342277b8beabbeae89a6e72cfb83b", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/e940918acdd342277b8beabbeae89a6e72cfb83b", "committedDate": "2020-07-02T11:11:34Z", "message": "Update expected message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNTg5OTUx", "url": "https://github.com/vespa-engine/vespa/pull/13779#pullrequestreview-441589951", "createdAt": "2020-07-02T11:29:35Z", "commit": {"oid": "e940918acdd342277b8beabbeae89a6e72cfb83b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMToyOTozNVrOGsIz9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMTozMjowOVrOGsI4tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzNDkwMQ==", "bodyText": "Use isEmpty ?", "url": "https://github.com/vespa-engine/vespa/pull/13779#discussion_r448934901", "createdAt": "2020-07-02T11:29:35Z", "author": {"login": "baldersheim"}, "path": "container-core/src/main/java/com/yahoo/container/handler/ClustersStatus.java", "diffHunk": "@@ -37,11 +39,15 @@ public ClustersStatus() { }\n     /** The status of clusters, when known. Note that clusters may exist for which there is no knowledge yet. */\n     private final Map<String, Boolean> clusterStatus = new HashMap<>();\n \n-    public void setContainerHasClusters(boolean containerHasClusters) {\n+    /** Sets the current clusters of this container */\n+    public void setClusters(Set<String> clusters) {\n         synchronized (mutex) {\n-            this.containerHasClusters = containerHasClusters;\n-            if ( ! containerHasClusters)\n-                clusterStatus.clear(); // forget container clusters which was configured away\n+            this.containerHasClusters = clusters.size() > 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e940918acdd342277b8beabbeae89a6e72cfb83b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzNjExOQ==", "bodyText": "You probably need a separate catch for nextConfig() that is SEVERE to ensure you you only blame the subscriber when it is truly to blame.", "url": "https://github.com/vespa-engine/vespa/pull/13779#discussion_r448936119", "createdAt": "2020-07-02T11:32:09Z", "author": {"login": "baldersheim"}, "path": "config/src/main/java/com/yahoo/config/subscription/ConfigSubscriber.java", "diffHunk": "@@ -423,21 +423,26 @@ public boolean isClosed() {\n      * @return The handle of the config\n      * @see #startConfigThread(Runnable)\n      */\n-    public <T extends ConfigInstance> ConfigHandle<T> subscribe(final SingleSubscriber<T> singleSubscriber, Class<T> configClass, String configId) {\n-        if (!subscriptionHandles.isEmpty())\n-            throw new IllegalStateException(\"Can not start single-subscription because subscriptions were previously opened on this.\");\n-        final ConfigHandle<T> handle = subscribe(configClass, configId);\n-        if (!nextConfig())\n-            throw new ConfigurationRuntimeException(\"Initial config of \" + configClass.getName() + \" failed.\");\n+    public <T extends ConfigInstance> ConfigHandle<T> subscribe(SingleSubscriber<T> singleSubscriber, Class<T> configClass, String configId) {\n+        if ( ! subscriptionHandles.isEmpty())\n+            throw new IllegalStateException(\"Can not start single-subscription because subscriptions were previously opened on this\");\n+\n+        ConfigHandle<T> handle = subscribe(configClass, configId);\n+\n+        if ( ! nextConfig())\n+            throw new ConfigurationRuntimeException(\"Initial config of \" + configClass.getName() + \" failed\");\n+\n         singleSubscriber.configure(handle.getConfig());\n         startConfigThread(() -> {\n                 while (!isClosed()) {\n                     try {\n-                        if (nextConfig()) {\n-                            if (handle.isChanged()) singleSubscriber.configure(handle.getConfig());\n-                        }\n-                    } catch (Exception e) {\n-                        log.log(SEVERE, \"Exception from config system, continuing config thread: \" + Exceptions.toMessageString(e));\n+                        if (nextConfig() && handle.isChanged())\n+                            singleSubscriber.configure(handle.getConfig());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e940918acdd342277b8beabbeae89a6e72cfb83b"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b099ae866e7a99b27b364f6c26157e786cc090c", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/2b099ae866e7a99b27b364f6c26157e786cc090c", "committedDate": "2020-07-02T12:16:00Z", "message": "Separate logging for errors on get and apply config"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3490, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}