{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2Mjc4MzQw", "number": 13942, "title": "Bjorncs/improve athenz access control", "bodyText": "Requires #13930 to be merged.\nFYI @gjoranv @tokle", "createdAt": "2020-07-24T13:10:06Z", "url": "https://github.com/vespa-engine/vespa/pull/13942", "merged": true, "mergeCommit": {"oid": "2f15bb0b5c5f06df7fed1876f53c8fd5d7c3450c"}, "closed": true, "closedAt": "2020-08-18T14:41:58Z", "author": {"login": "bjorncs"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdADFoVAH2gAyNDU2Mjc4MzQwOjk5NTM5ODNiYmM0M2ViZmJmNjJiMzUzYWEwNDM1NDNjN2IzZWY1Yzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAH7vAgFqTQ2OTUxNTI4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9953983bbc43ebfbf62b353aa043543c7b3ef5c9", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/9953983bbc43ebfbf62b353aa043543c7b3ef5c9", "committedDate": "2020-08-18T08:53:06Z", "message": "Add static builder taking port and path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca57e9c2cf1b72701f3ed2d454f0d59c7f56a63a", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/ca57e9c2cf1b72701f3ed2d454f0d59c7f56a63a", "committedDate": "2020-08-18T08:53:06Z", "message": "Bind access control filter to all paths on port 4443\n\nExclude bindings with separate filter chain.\nDo not bind access control filter to port 4080.\nSimplify AccessControl interface to a 'configure()' method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0479417622405fbf20290748be8dc5c3513334a5", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/0479417622405fbf20290748be8dc5c3513334a5", "committedDate": "2020-08-18T08:53:07Z", "message": "Use 'createModelAndGetHttp' in all test methods for AccessControl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0344ab1a1ef64c042e27d095a4f34d5031bbfce2", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/0344ab1a1ef64c042e27d095a4f34d5031bbfce2", "committedDate": "2020-08-18T08:53:07Z", "message": "Implement equals/hashCode for FilterBinding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40b8fd053051bd0f462ca7d400f0407c7961969f", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/40b8fd053051bd0f462ca7d400f0407c7961969f", "committedDate": "2020-08-18T08:54:50Z", "message": "Ensure that access control chain has unique bindings"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ec558f4bc3e538c7037eee8e677e2f8f76cb6b7", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/1ec558f4bc3e538c7037eee8e677e2f8f76cb6b7", "committedDate": "2020-07-24T12:37:30Z", "message": "Ensure that access control chain has unique bindings"}, "afterCommit": {"oid": "40b8fd053051bd0f462ca7d400f0407c7961969f", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/40b8fd053051bd0f462ca7d400f0407c7961969f", "committedDate": "2020-08-18T08:54:50Z", "message": "Ensure that access control chain has unique bindings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTM2OTE2", "url": "https://github.com/vespa-engine/vespa/pull/13942#pullrequestreview-469136916", "createdAt": "2020-08-18T09:09:03Z", "commit": {"oid": "9953983bbc43ebfbf62b353aa043543c7b3ef5c9"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTowOTowM1rOHCKk1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMDowMDo0M1rOHCMauw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzMjQ3MA==", "bodyText": "This seems to be inconsistent with fromHttpPath, unless the paths are semantically different?", "url": "https://github.com/vespa-engine/vespa/pull/13942#discussion_r472032470", "createdAt": "2020-08-18T09:09:03Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/component/SystemBindingPattern.java", "diffHunk": "@@ -13,6 +13,7 @@\n \n     public static SystemBindingPattern fromHttpPath(String path) { return new SystemBindingPattern(\"http\", \"*\", null, path);}\n     public static SystemBindingPattern fromPattern(String binding) { return new SystemBindingPattern(binding);}\n+    public static SystemBindingPattern fromPortAndPath(String port, String path) { return new SystemBindingPattern(\"http\", \"*\", port, path); }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9953983bbc43ebfbf62b353aa043543c7b3ef5c9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0NzkxMQ==", "bodyText": "Suggest to use a more descriptive name. This is not to configure the AccessControl object, but add a lot of stuff to the given Http. Perhaps this should be done in the Http object itself?", "url": "https://github.com/vespa-engine/vespa/pull/13942#discussion_r472047911", "createdAt": "2020-08-18T09:35:10Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/AccessControl.java", "diffHunk": "@@ -84,69 +85,75 @@ public AccessControl build() {\n     public final boolean writeEnabled;\n     private final Set<BindingPattern> excludedBindings;\n     private final Collection<Handler<?>> handlers;\n-    private final Collection<Servlet> servlets;\n \n     private AccessControl(String domain,\n                           boolean writeEnabled,\n                           boolean readEnabled,\n                           Set<BindingPattern> excludedBindings,\n-                          Collection<Servlet> servlets,\n                           Collection<Handler<?>> handlers) {\n         this.domain = domain;\n         this.readEnabled = readEnabled;\n         this.writeEnabled = writeEnabled;\n         this.excludedBindings = Collections.unmodifiableSet(excludedBindings);\n         this.handlers = handlers;\n-        this.servlets = servlets;\n     }\n \n-    public List<FilterBinding> getBindings() {\n-        return Stream.concat(getHandlerBindings(), getServletBindings())\n-                .collect(Collectors.toCollection(ArrayList::new));\n+    public void configure(Http http) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca57e9c2cf1b72701f3ed2d454f0d59c7f56a63a"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MjMwNQ==", "bodyText": "Adding this to a given object is less modular than doing it on the outside, or having a configure/use/addAccessControl in Http.", "url": "https://github.com/vespa-engine/vespa/pull/13942#discussion_r472052305", "createdAt": "2020-08-18T09:42:42Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/AccessControl.java", "diffHunk": "@@ -84,69 +85,75 @@ public AccessControl build() {\n     public final boolean writeEnabled;\n     private final Set<BindingPattern> excludedBindings;\n     private final Collection<Handler<?>> handlers;\n-    private final Collection<Servlet> servlets;\n \n     private AccessControl(String domain,\n                           boolean writeEnabled,\n                           boolean readEnabled,\n                           Set<BindingPattern> excludedBindings,\n-                          Collection<Servlet> servlets,\n                           Collection<Handler<?>> handlers) {\n         this.domain = domain;\n         this.readEnabled = readEnabled;\n         this.writeEnabled = writeEnabled;\n         this.excludedBindings = Collections.unmodifiableSet(excludedBindings);\n         this.handlers = handlers;\n-        this.servlets = servlets;\n     }\n \n-    public List<FilterBinding> getBindings() {\n-        return Stream.concat(getHandlerBindings(), getServletBindings())\n-                .collect(Collectors.toCollection(ArrayList::new));\n+    public void configure(Http http) {\n+        http.setAccessControl(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca57e9c2cf1b72701f3ed2d454f0d59c7f56a63a"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1NTE5OQ==", "bodyText": "Why not add the embedding container element in createModelAndGetHttp?", "url": "https://github.com/vespa-engine/vespa/pull/13942#discussion_r472055199", "createdAt": "2020-08-18T09:47:51Z", "author": {"login": "gjoranv"}, "path": "config-model/src/test/java/com/yahoo/vespa/model/container/xml/AccessControlTest.java", "diffHunk": "@@ -44,15 +42,14 @@\n \n     @Test\n     public void access_control_filter_chains_are_set_up() {\n-        Element clusterElem = DomBuilderTest.parse(\n+        Http http = createModelAndGetHttp(\n+                \"<container version='1.0'>\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0479417622405fbf20290748be8dc5c3513334a5"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1OTYzNA==", "bodyText": "Perhaps we could start this method by creating a map from binding->id?", "url": "https://github.com/vespa-engine/vespa/pull/13942#discussion_r472059634", "createdAt": "2020-08-18T09:55:30Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/AccessControl.java", "diffHunk": "@@ -137,6 +139,22 @@ private void addAccessControlExcludedChain(Http http) {\n         }\n     }\n \n+    // Remove bindings from access control chain that have binding pattern as a different filter chain\n+    private void removeDuplicateBindingsFromAccessControlChain(Http http) {\n+        Set<FilterBinding> duplicateBindings = new HashSet<>();\n+        for (FilterBinding binding : http.getBindings()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40b8fd053051bd0f462ca7d400f0407c7961969f"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA2MjY1MQ==", "bodyText": "BTW, is filterId() the correct name? Sounds like it should be chainId.", "url": "https://github.com/vespa-engine/vespa/pull/13942#discussion_r472062651", "createdAt": "2020-08-18T10:00:43Z", "author": {"login": "gjoranv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/AccessControl.java", "diffHunk": "@@ -137,6 +139,22 @@ private void addAccessControlExcludedChain(Http http) {\n         }\n     }\n \n+    // Remove bindings from access control chain that have binding pattern as a different filter chain\n+    private void removeDuplicateBindingsFromAccessControlChain(Http http) {\n+        Set<FilterBinding> duplicateBindings = new HashSet<>();\n+        for (FilterBinding binding : http.getBindings()) {\n+            if (binding.filterId().toId().equals(ACCESS_CONTROL_CHAIN_ID)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40b8fd053051bd0f462ca7d400f0407c7961969f"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8373e8d51ff3019e94f82211df16efae23080fe6", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/8373e8d51ff3019e94f82211df16efae23080fe6", "committedDate": "2020-08-18T11:25:58Z", "message": "Delegate configuration of noop filter to amender\n\nThe open-source model cannot configure the the noop filter, otherwise unit tests using application framework will fail when 'access-control' is in services.xml."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8f176b37a012028242b6983f0ac92994b5ec8b8", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/e8f176b37a012028242b6983f0ac92994b5ec8b8", "committedDate": "2020-08-18T11:48:06Z", "message": "Rename 'fromPortAndPath' -> 'fromHttpPortAndPath'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62d961016037e31b7d2c2abb80f087c9bf0acf49", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/62d961016037e31b7d2c2abb80f087c9bf0acf49", "committedDate": "2020-08-18T11:54:41Z", "message": "Don't duplicate container element in all unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39023ba2fd955c51a430aa5886c7fe5344050a9e", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/39023ba2fd955c51a430aa5886c7fe5344050a9e", "committedDate": "2020-08-18T11:57:20Z", "message": "Component spec in FilterBinding refers to a chain not filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c13793f64a364babc5032b5229223b562cd54fed", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/c13793f64a364babc5032b5229223b562cd54fed", "committedDate": "2020-08-18T12:13:07Z", "message": "Rename 'configure' -> 'configureHttpFilterChains'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTE1Mjg1", "url": "https://github.com/vespa-engine/vespa/pull/13942#pullrequestreview-469515285", "createdAt": "2020-08-18T14:31:49Z", "commit": {"oid": "c13793f64a364babc5032b5229223b562cd54fed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3475, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}