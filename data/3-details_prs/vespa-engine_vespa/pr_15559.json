{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwMjQyNzU1", "number": 15559, "title": "ensure all cases can test with factory", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@havardpe please take a look", "createdAt": "2020-12-01T11:41:23Z", "url": "https://github.com/vespa-engine/vespa/pull/15559", "merged": true, "mergeCommit": {"oid": "ed58cd5826de9da0ed6a963a35c1246abebac1e4"}, "closed": true, "closedAt": "2020-12-02T19:45:02Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh4WZagH2gAyNTMwMjQyNzU1OmM4NWZhMTkyMDc5NzAxNjI0YjJmNzYzYTYxYmIxNzgyMWZhNzU5NGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh6nxIAFqTU0MTkzMzUyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c85fa192079701624b2f763a61bb17821fa7594a", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/c85fa192079701624b2f763a61bb17821fa7594a", "committedDate": "2020-12-01T11:35:53Z", "message": "ensure all cases can test with factory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODYwNzA5", "url": "https://github.com/vespa-engine/vespa/pull/15559#pullrequestreview-541860709", "createdAt": "2020-12-01T12:47:33Z", "commit": {"oid": "c85fa192079701624b2f763a61bb17821fa7594a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMjo0NzozM1rOH8rDlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMjo0OToxOVrOH8rHXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MjAzOA==", "bodyText": "use TensorSpec::from_expr here", "url": "https://github.com/vespa-engine/vespa/pull/15559#discussion_r533382038", "createdAt": "2020-12-01T12:47:33Z", "author": {"login": "havardpe"}, "path": "eval/src/tests/eval/tensor_lambda/tensor_lambda_test.cpp", "diffHunk": "@@ -77,14 +78,14 @@ void verify_impl(const vespalib::string &expr, const vespalib::string &expect) {\n     verify_impl<T>(expr, expect, [](const T*){});\n }\n \n-void verify_generic(const vespalib::string &expr, const vespalib::string &expect,\n-                    EvalMode expect_eval_mode)\n-{\n-    verify_impl<DenseLambdaFunction>(expr, expect,\n-                                     [&](const DenseLambdaFunction *info)\n-                                     {\n-                                         EXPECT_EQUAL(info->eval_mode(), expect_eval_mode);\n-                                     });\n+void verify_not_optimized(const vespalib::string &expr, const vespalib::string &expect) {\n+    EvalFixture fixture(prod_factory, expr, param_repo, true);\n+    EvalFixture simple_factory_fixture(simple_factory, expr, param_repo, false);\n+    EXPECT_EQUAL(fixture.result(), simple_factory_fixture.result());\n+    EXPECT_EQUAL(fixture.result(), EvalFixture::ref(expr, param_repo));\n+    EXPECT_EQUAL(fixture.result(), EvalFixture::ref(expect, param_repo));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c85fa192079701624b2f763a61bb17821fa7594a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4Mjg1NQ==", "bodyText": "I like the verify_generic name better here", "url": "https://github.com/vespa-engine/vespa/pull/15559#discussion_r533382855", "createdAt": "2020-12-01T12:49:04Z", "author": {"login": "havardpe"}, "path": "eval/src/tests/eval/tensor_lambda/tensor_lambda_test.cpp", "diffHunk": "@@ -77,14 +78,14 @@ void verify_impl(const vespalib::string &expr, const vespalib::string &expect) {\n     verify_impl<T>(expr, expect, [](const T*){});\n }\n \n-void verify_generic(const vespalib::string &expr, const vespalib::string &expect,\n-                    EvalMode expect_eval_mode)\n-{\n-    verify_impl<DenseLambdaFunction>(expr, expect,\n-                                     [&](const DenseLambdaFunction *info)\n-                                     {\n-                                         EXPECT_EQUAL(info->eval_mode(), expect_eval_mode);\n-                                     });\n+void verify_not_optimized(const vespalib::string &expr, const vespalib::string &expect) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c85fa192079701624b2f763a61bb17821fa7594a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MzAwNA==", "bodyText": "feel free to just remove this now", "url": "https://github.com/vespa-engine/vespa/pull/15559#discussion_r533383004", "createdAt": "2020-12-01T12:49:19Z", "author": {"login": "havardpe"}, "path": "eval/src/tests/eval/tensor_lambda/tensor_lambda_test.cpp", "diffHunk": "@@ -184,13 +157,92 @@ TEST(\"require that non-continuous cell extraction is optimized\") {\n     TEST_DO(verify_idx_fun(\"tensor<float>(x[3])(x3y5f{x:(x),y:2})\", \"x3y5f{y:2}\", \"f(x)((floor(x)*5)+2)\"));\n }\n \n+TEST(\"require that simple dynamic tensor lambda works\") {\n+    TEST_DO(verify_not_optimized(\"tensor(x[3])(x+a)\", \"tensor(x[3]):[1,2,3]\"));\n+}\n+\n+TEST(\"require that compiled multi-dimensional multi-param dynamic tensor lambda works\") {\n+    TEST_DO(verify_not_optimized(\"tensor(x[3],y[2])((b-a)+x+y)\", \"tensor(x[3],y[2]):[[1,2],[2,3],[3,4]]\"));\n+    TEST_DO(verify_not_optimized(\"tensor<float>(x[3],y[2])((b-a)+x+y)\", \"tensor<float>(x[3],y[2]):[[1,2],[2,3],[3,4]]\"));\n+}\n+\n+TEST(\"require that interpreted multi-dimensional multi-param dynamic tensor lambda works\") {\n+    TEST_DO(verify_not_optimized(\"tensor(x[3],y[2])((x3{x:(a)}-a)+x+y)\", \"tensor(x[3],y[2]):[[1,2],[2,3],[3,4]]\"));\n+    TEST_DO(verify_not_optimized(\"tensor<float>(x[3],y[2])((x3{x:(a)}-a)+x+y)\", \"tensor<float>(x[3],y[2]):[[1,2],[2,3],[3,4]]\"));\n+}\n+\n+TEST(\"require that tensor lambda can be used for tensor slicing\") {\n+    TEST_DO(verify_not_optimized(\"tensor(x[2])(x3{x:(x+a)})\", \"tensor(x[2]):[2,3]\"));\n+    TEST_DO(verify_not_optimized(\"tensor(x[2])(a+x3{x:(x)})\", \"tensor(x[2]):[2,3]\"));\n+}\n+\n+TEST(\"require that tensor lambda can be used to convert from sparse to dense tensors\") {\n+    TEST_DO(verify_not_optimized(\"tensor(x[3])(x3m{x:(x)})\", \"tensor(x[3]):[1,2,3]\"));\n+    TEST_DO(verify_not_optimized(\"tensor(x[2])(x3m{x:(x)})\", \"tensor(x[2]):[1,2]\"));\n+}\n+\n+TEST(\"require that dynamic nested tensor lambda using tensor peek works\") {\n+    TEST_DO(verify_not_optimized(\"tensor(x[2])(tensor(y[2])((x+y)+a){y:(x)})\", \"tensor(x[2]):[1,3]\"));\n+}\n+\n+TEST(\"require that out-of-bounds cell extraction is not optimized\") {\n+    TEST_DO(verify_not_optimized(\"tensor(x[3])(x3y5{x:1,y:(x+3)})\", \"tensor(x[3]):[9,10,0]\"));\n+    TEST_DO(verify_not_optimized(\"tensor(x[3])(x3y5{x:1,y:(x-1)})\", \"tensor(x[3]):[0,6,7]\"));\n+    TEST_DO(verify_not_optimized(\"tensor(x[3])(x3y5{x:(x+1),y:(x)})\", \"tensor(x[3]):[6,12,0]\"));\n+    TEST_DO(verify_not_optimized(\"tensor(x[3])(x3y5{x:(x-1),y:(x)})\", \"tensor(x[3]):[0,2,8]\"));\n+}\n+\n+//---------------------------------------------------------------------------\n+// to be removed when DefaultTensorEngine is removed:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c85fa192079701624b2f763a61bb17821fa7594a"}, "originalPosition": 115}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e9bb253be74a9a4498743ff8780ecc349373dcf", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/3e9bb253be74a9a4498743ff8780ecc349373dcf", "committedDate": "2020-12-01T13:44:41Z", "message": "remove engine testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4441a93d58cee52335a67e9f82b77cf7dcd9bd81", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/4441a93d58cee52335a67e9f82b77cf7dcd9bd81", "committedDate": "2020-12-01T13:46:26Z", "message": "avoid using namespace vespalib::tensor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a06af2324933b1c40d85077e0dd28847e469d96", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/3a06af2324933b1c40d85077e0dd28847e469d96", "committedDate": "2020-12-01T13:47:43Z", "message": "verify_not_optimized -> verify_generic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxOTMzNTI0", "url": "https://github.com/vespa-engine/vespa/pull/15559#pullrequestreview-541933524", "createdAt": "2020-12-01T14:14:40Z", "commit": {"oid": "3a06af2324933b1c40d85077e0dd28847e469d96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1816, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}