{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwODI1ODQ5", "number": 13500, "title": "Revert \"Revert \"When we pull in a cacheline, we should use it too.\"\"", "bodyText": "Reverts #13499", "createdAt": "2020-06-08T06:52:12Z", "url": "https://github.com/vespa-engine/vespa/pull/13500", "merged": true, "mergeCommit": {"oid": "ca0609486cb2c915d500edc982ebd2084041089a"}, "closed": true, "closedAt": "2020-06-10T06:00:15Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpKzF3AH2gAyNDMwODI1ODQ5OmJlYmUwM2M3Yjk3MDc0NGQwOWViMjZmNzM4M2RhNGY4YzEyNDRhMzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcphr90AH2gAyNDMwODI1ODQ5OjAxM2ZmYWYxZTY2MjdhMDQ4YTMyY2VlNGQ4YzI5ZDc4NDNjOTM0NjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bebe03c7b970744d09eb26f7383da4f8c1244a36", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/bebe03c7b970744d09eb26f7383da4f8c1244a36", "committedDate": "2020-06-08T06:51:50Z", "message": "Revert \"Revert \"When we pull in a cacheline, we should use it too.\"\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTE5ODIy", "url": "https://github.com/vespa-engine/vespa/pull/13500#pullrequestreview-426919822", "createdAt": "2020-06-09T08:47:33Z", "commit": {"oid": "bebe03c7b970744d09eb26f7383da4f8c1244a36"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwODo0NzozM1rOGg_Crw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwODo0OTo0MVrOGg_ILA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0MDQ5NQ==", "bodyText": "I think the magic should be done outside the update call and the update call just forward to the appropriate function.", "url": "https://github.com/vespa-engine/vespa/pull/13500#discussion_r437240495", "createdAt": "2020-06-09T08:47:33Z", "author": {"login": "havardpe"}, "path": "searchlib/src/vespa/searchlib/queryeval/multibitvectoriterator.cpp", "diffHunk": "@@ -1,61 +1,91 @@\n // Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n \n-#include <vespa/searchlib/queryeval/multibitvectoriterator.h>\n-#include <vespa/searchlib/queryeval/andsearch.h>\n-#include <vespa/searchlib/queryeval/andnotsearch.h>\n-#include <vespa/searchlib/queryeval/sourceblendersearch.h>\n-#include <vespa/searchlib/queryeval/orsearch.h>\n+#include \"multibitvectoriterator.h\"\n+#include \"andsearch.h\"\n+#include \"andnotsearch.h\"\n+#include \"sourceblendersearch.h\"\n #include <vespa/searchlib/common/bitvectoriterator.h>\n-#include <vespa/searchlib/attribute/attributeiterators.h>\n #include <vespa/searchlib/fef/termfieldmatchdata.h>\n #include <vespa/searchlib/fef/termfieldmatchdataarray.h>\n #include <vespa/vespalib/util/optimized.h>\n+#include <vespa/vespalib/hwaccelrated/iaccelrated.h>\n \n namespace search::queryeval {\n \n using vespalib::Trinary;\n+using vespalib::hwaccelrated::IAccelrated;\n \n namespace {\n \n template<typename Update>\n class MultiBitVectorIterator : public MultiBitVectorIteratorBase\n {\n public:\n-    MultiBitVectorIterator(Children children) : MultiBitVectorIteratorBase(std::move(children)) { }\n+    explicit MultiBitVectorIterator(Children children)\n+        : MultiBitVectorIteratorBase(std::move(children)),\n+          _update(),\n+          _accel(IAccelrated::getAccelerator()),\n+          _lastWords()\n+    {\n+        static_assert(sizeof(_lastWords) == 64, \"Latswords should have 64 byte size\");\n+        memset(&_lastWords, 0, sizeof(_lastWords));\n+    }\n protected:\n     void updateLastValue(uint32_t docId);\n     void strictSeek(uint32_t docId);\n private:\n     void doSeek(uint32_t docId) override;\n     Trinary is_strict() const override { return Trinary::False; }\n     bool acceptExtraFilter() const override { return Update::isAnd(); }\n-    Update                  _update;\n+    Update              _update;\n+    const IAccelrated & _accel;\n+    alignas(64) Word    _lastWords[8];\n };\n \n template<typename Update>\n class MultiBitVectorIteratorStrict : public MultiBitVectorIterator<Update>\n {\n public:\n-    MultiBitVectorIteratorStrict(MultiSearch::Children children) : MultiBitVectorIterator<Update>(std::move(children)) { }\n+    explicit MultiBitVectorIteratorStrict(MultiSearch::Children  children)\n+        : MultiBitVectorIterator<Update>(std::move(children))\n+    { }\n private:\n     void doSeek(uint32_t docId) override { this->strictSeek(docId); }\n     Trinary is_strict() const override { return Trinary::True; }\n };\n \n+struct And {\n+    using Word = BitWord::Word;\n+    void operator () (const IAccelrated & accel, size_t offset, const std::vector<std::pair<const void *, bool>> & src, Word *dest) {\n+        accel.and64(offset*sizeof(uint64_t), src, dest);\n+    }\n+    static bool isAnd() { return true; }\n+};\n+\n+struct Or {\n+    using Word = BitWord::Word;\n+    void operator () (const IAccelrated & accel, size_t offset, const std::vector<std::pair<const void *, bool>> & src, Word *dest) {\n+        accel.or64(offset*sizeof(uint64_t), src, dest);\n+    }\n+    static bool isAnd() { return false; }\n+};\n+\n template<typename Update>\n void MultiBitVectorIterator<Update>::updateLastValue(uint32_t docId)\n {\n     if (docId >= _lastMaxDocIdLimit) {\n-        if (__builtin_expect(docId < _numDocs, true)) {\n-            const uint32_t index(wordNum(docId));\n-            _lastValue = _bvs[0][index];\n-            for(uint32_t i(1); i < _bvs.size(); i++) {\n-                _lastValue = _update(_lastValue, _bvs[i][index]);\n-            }\n-            _lastMaxDocIdLimit = (index + 1) * WordLen;\n-        } else {\n+        if (__builtin_expect(docId >= _numDocs, false)) {\n             setAtEnd();\n+            return;\n+        }\n+        const uint32_t index(wordNum(docId));\n+        if (docId >= _lastMaxDocIdLimitRequireFetch) {\n+            uint32_t baseIndex = index & ~(sizeof(_lastWords)/sizeof(Word) - 1);\n+            _update(_accel, baseIndex, _bvs, _lastWords);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bebe03c7b970744d09eb26f7383da4f8c1244a36"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0MTMwNQ==", "bodyText": "offset should already be bytes here, and destination void.", "url": "https://github.com/vespa-engine/vespa/pull/13500#discussion_r437241305", "createdAt": "2020-06-09T08:48:45Z", "author": {"login": "havardpe"}, "path": "searchlib/src/vespa/searchlib/queryeval/multibitvectoriterator.cpp", "diffHunk": "@@ -1,61 +1,91 @@\n // Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n \n-#include <vespa/searchlib/queryeval/multibitvectoriterator.h>\n-#include <vespa/searchlib/queryeval/andsearch.h>\n-#include <vespa/searchlib/queryeval/andnotsearch.h>\n-#include <vespa/searchlib/queryeval/sourceblendersearch.h>\n-#include <vespa/searchlib/queryeval/orsearch.h>\n+#include \"multibitvectoriterator.h\"\n+#include \"andsearch.h\"\n+#include \"andnotsearch.h\"\n+#include \"sourceblendersearch.h\"\n #include <vespa/searchlib/common/bitvectoriterator.h>\n-#include <vespa/searchlib/attribute/attributeiterators.h>\n #include <vespa/searchlib/fef/termfieldmatchdata.h>\n #include <vespa/searchlib/fef/termfieldmatchdataarray.h>\n #include <vespa/vespalib/util/optimized.h>\n+#include <vespa/vespalib/hwaccelrated/iaccelrated.h>\n \n namespace search::queryeval {\n \n using vespalib::Trinary;\n+using vespalib::hwaccelrated::IAccelrated;\n \n namespace {\n \n template<typename Update>\n class MultiBitVectorIterator : public MultiBitVectorIteratorBase\n {\n public:\n-    MultiBitVectorIterator(Children children) : MultiBitVectorIteratorBase(std::move(children)) { }\n+    explicit MultiBitVectorIterator(Children children)\n+        : MultiBitVectorIteratorBase(std::move(children)),\n+          _update(),\n+          _accel(IAccelrated::getAccelerator()),\n+          _lastWords()\n+    {\n+        static_assert(sizeof(_lastWords) == 64, \"Latswords should have 64 byte size\");\n+        memset(&_lastWords, 0, sizeof(_lastWords));\n+    }\n protected:\n     void updateLastValue(uint32_t docId);\n     void strictSeek(uint32_t docId);\n private:\n     void doSeek(uint32_t docId) override;\n     Trinary is_strict() const override { return Trinary::False; }\n     bool acceptExtraFilter() const override { return Update::isAnd(); }\n-    Update                  _update;\n+    Update              _update;\n+    const IAccelrated & _accel;\n+    alignas(64) Word    _lastWords[8];\n };\n \n template<typename Update>\n class MultiBitVectorIteratorStrict : public MultiBitVectorIterator<Update>\n {\n public:\n-    MultiBitVectorIteratorStrict(MultiSearch::Children children) : MultiBitVectorIterator<Update>(std::move(children)) { }\n+    explicit MultiBitVectorIteratorStrict(MultiSearch::Children  children)\n+        : MultiBitVectorIterator<Update>(std::move(children))\n+    { }\n private:\n     void doSeek(uint32_t docId) override { this->strictSeek(docId); }\n     Trinary is_strict() const override { return Trinary::True; }\n };\n \n+struct And {\n+    using Word = BitWord::Word;\n+    void operator () (const IAccelrated & accel, size_t offset, const std::vector<std::pair<const void *, bool>> & src, Word *dest) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bebe03c7b970744d09eb26f7383da4f8c1244a36"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0MTkwMA==", "bodyText": "offset is probably in Words and not in uint64_t, but I think this magic should be done together with the other magic anyways.", "url": "https://github.com/vespa-engine/vespa/pull/13500#discussion_r437241900", "createdAt": "2020-06-09T08:49:41Z", "author": {"login": "havardpe"}, "path": "searchlib/src/vespa/searchlib/queryeval/multibitvectoriterator.cpp", "diffHunk": "@@ -1,61 +1,91 @@\n // Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n \n-#include <vespa/searchlib/queryeval/multibitvectoriterator.h>\n-#include <vespa/searchlib/queryeval/andsearch.h>\n-#include <vespa/searchlib/queryeval/andnotsearch.h>\n-#include <vespa/searchlib/queryeval/sourceblendersearch.h>\n-#include <vespa/searchlib/queryeval/orsearch.h>\n+#include \"multibitvectoriterator.h\"\n+#include \"andsearch.h\"\n+#include \"andnotsearch.h\"\n+#include \"sourceblendersearch.h\"\n #include <vespa/searchlib/common/bitvectoriterator.h>\n-#include <vespa/searchlib/attribute/attributeiterators.h>\n #include <vespa/searchlib/fef/termfieldmatchdata.h>\n #include <vespa/searchlib/fef/termfieldmatchdataarray.h>\n #include <vespa/vespalib/util/optimized.h>\n+#include <vespa/vespalib/hwaccelrated/iaccelrated.h>\n \n namespace search::queryeval {\n \n using vespalib::Trinary;\n+using vespalib::hwaccelrated::IAccelrated;\n \n namespace {\n \n template<typename Update>\n class MultiBitVectorIterator : public MultiBitVectorIteratorBase\n {\n public:\n-    MultiBitVectorIterator(Children children) : MultiBitVectorIteratorBase(std::move(children)) { }\n+    explicit MultiBitVectorIterator(Children children)\n+        : MultiBitVectorIteratorBase(std::move(children)),\n+          _update(),\n+          _accel(IAccelrated::getAccelerator()),\n+          _lastWords()\n+    {\n+        static_assert(sizeof(_lastWords) == 64, \"Latswords should have 64 byte size\");\n+        memset(&_lastWords, 0, sizeof(_lastWords));\n+    }\n protected:\n     void updateLastValue(uint32_t docId);\n     void strictSeek(uint32_t docId);\n private:\n     void doSeek(uint32_t docId) override;\n     Trinary is_strict() const override { return Trinary::False; }\n     bool acceptExtraFilter() const override { return Update::isAnd(); }\n-    Update                  _update;\n+    Update              _update;\n+    const IAccelrated & _accel;\n+    alignas(64) Word    _lastWords[8];\n };\n \n template<typename Update>\n class MultiBitVectorIteratorStrict : public MultiBitVectorIterator<Update>\n {\n public:\n-    MultiBitVectorIteratorStrict(MultiSearch::Children children) : MultiBitVectorIterator<Update>(std::move(children)) { }\n+    explicit MultiBitVectorIteratorStrict(MultiSearch::Children  children)\n+        : MultiBitVectorIterator<Update>(std::move(children))\n+    { }\n private:\n     void doSeek(uint32_t docId) override { this->strictSeek(docId); }\n     Trinary is_strict() const override { return Trinary::True; }\n };\n \n+struct And {\n+    using Word = BitWord::Word;\n+    void operator () (const IAccelrated & accel, size_t offset, const std::vector<std::pair<const void *, bool>> & src, Word *dest) {\n+        accel.and64(offset*sizeof(uint64_t), src, dest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bebe03c7b970744d09eb26f7383da4f8c1244a36"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e90b78dd51b7d7387b9a8ccd2c2036f78dd65c5", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/4e90b78dd51b7d7387b9a8ccd2c2036f78dd65c5", "committedDate": "2020-06-09T09:08:56Z", "message": "Add static_assert for sanity of template arguments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "013ffaf1e6627a048a32cee4d8c29d7843c93462", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/013ffaf1e6627a048a32cee4d8c29d7843c93462", "committedDate": "2020-06-09T09:31:52Z", "message": "- Compute batch size in one place.\n- Compute offset in one place."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3696, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}