{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwOTU1Njc1", "number": 15055, "title": "Jonmv/wait for running steps when aborting and finishing ru", "bodyText": "@hakonhall please review and merge.", "createdAt": "2020-10-27T18:08:04Z", "url": "https://github.com/vespa-engine/vespa/pull/15055", "merged": true, "mergeCommit": {"oid": "91c600222b9ccde4e7113da2171b92067eeae091"}, "closed": true, "closedAt": "2020-10-28T11:00:34Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWs9LggH2gAyNTEwOTU1Njc1OjU1NWY1ZjljMWMxZDU5MzA4ZjBjYzIyOTliODFkYTYyOThiOTAzMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW7MohAFqTUxODUyODUxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "555f5f9c1c1d59308f0cc2299b81da6298b90337", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/555f5f9c1c1d59308f0cc2299b81da6298b90337", "committedDate": "2020-10-27T18:06:13Z", "message": "Wait for all steps to finish before finishing a run"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25aebb11668d399345aa38d67b4adb97423827f9", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/25aebb11668d399345aa38d67b4adb97423827f9", "committedDate": "2020-10-27T18:06:33Z", "message": "More threads for JobRunner, and name them"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9bd7b1f84bfce80592c222198b7bb7a912a710e", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/e9bd7b1f84bfce80592c222198b7bb7a912a710e", "committedDate": "2020-10-27T18:07:15Z", "message": "... and now, for something complete different (simplify)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTI4NDM5", "url": "https://github.com/vespa-engine/vespa/pull/15055#pullrequestreview-518528439", "createdAt": "2020-10-28T10:41:41Z", "commit": {"oid": "e9bd7b1f84bfce80592c222198b7bb7a912a710e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo0MTo0MVrOHpj7-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo0MTo0MVrOHpj7-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0MjQ1OQ==", "bodyText": "Btw, I don't get how locking works in the JobRunner maintainer.  Shouldn't the maintainer\n\nacquire a global zk lock\nread all Runs and decide on some actions, then either do those actions or store to zk that those actions are in progress (using ephemeral nodes)\nunlock the global zk lock\n\nInstead it looks like e.g. two JobRunner may decide to finish concurrently?  Or one thread decide to abort a job whose step may already be processed in another thread.", "url": "https://github.com/vespa-engine/vespa/pull/15055#discussion_r513342459", "createdAt": "2020-10-28T10:41:41Z", "author": {"login": "hakonhall"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/JobController.java", "diffHunk": "@@ -353,7 +354,10 @@ public void setStartTimestamp(RunId id, Instant timestamp, LockedStep step) {\n     }\n \n     /** Changes the status of the given run to inactive, and stores it as a historic run. */\n-    public void finish(RunId id) {\n+    public void finish(RunId id) throws TimeoutException {\n+        // Ensure no step is still running before we finish the run \u2014 report depends transitively on all the other steps.\n+        locked(id.application(), id.type(), report, __ -> { });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9bd7b1f84bfce80592c222198b7bb7a912a710e"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTI4NTE3", "url": "https://github.com/vespa-engine/vespa/pull/15055#pullrequestreview-518528517", "createdAt": "2020-10-28T10:41:46Z", "commit": {"oid": "e9bd7b1f84bfce80592c222198b7bb7a912a710e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2196, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}