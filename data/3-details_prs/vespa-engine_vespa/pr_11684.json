{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMDE1MDQw", "number": 11684, "title": "Jvenstad/instances with separate change", "bodyText": "@mpolden please review.", "createdAt": "2020-01-07T14:28:38Z", "url": "https://github.com/vespa-engine/vespa/pull/11684", "merged": true, "mergeCommit": {"oid": "2d280005e270cf625615a53c639fefdee73d6524"}, "closed": true, "closedAt": "2020-01-08T13:01:28Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4BoF1gH2gAyMzYwMDE1MDQwOjk1ZWZjZmQ0ZDE2NWIwNjRjN2M2MDI4NGRlZDFkZjdkNDgxYzYxMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4WPWdAFqTMzOTg5OTM1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "95efcfd4d165b064c7c60284ded1df7d481c6132", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/95efcfd4d165b064c7c60284ded1df7d481c6132", "committedDate": "2020-01-07T14:28:23Z", "message": "Store change per instance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2d9b9b58d16c618b47b2932ef1fc85b89c8ce51", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/b2d9b9b58d16c618b47b2932ef1fc85b89c8ce51", "committedDate": "2020-01-07T14:28:23Z", "message": "Compute outstanding change, instead of keeping it in sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f69ea8459763217ec20301a3e484cc3bfa7e9f42", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/f69ea8459763217ec20301a3e484cc3bfa7e9f42", "committedDate": "2020-01-07T14:28:23Z", "message": "Clarify and simplify little bits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5aaff70bd4ebdd5b659550b055a41e517378c5b", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/b5aaff70bd4ebdd5b659550b055a41e517378c5b", "committedDate": "2020-01-07T14:28:23Z", "message": "Avoid throwing around Versions when checking job completeness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52df4364530a1dac305ff7da1c785a0e8988b707", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/52df4364530a1dac305ff7da1c785a0e8988b707", "committedDate": "2020-01-07T14:28:23Z", "message": "Move changes to instances"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8b60f3e7632081872df156d4edb1066554fdcc9", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/d8b60f3e7632081872df156d4edb1066554fdcc9", "committedDate": "2020-01-07T14:28:23Z", "message": "Allow OCD to propagate revisions to instances failing upgrades"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4afaa3099d5b460f4f8421e3a1cd1bd483d960a", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/c4afaa3099d5b460f4f8421e3a1cd1bd483d960a", "committedDate": "2020-01-07T14:28:23Z", "message": "Update HTTP API handlers and responses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5e66672922229e03f8ceed15134434bfa159d74", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/a5e66672922229e03f8ceed15134434bfa159d74", "committedDate": "2020-01-07T15:32:42Z", "message": "Expand complicated deployment spec test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eea19dc015312134140456efe49280a0900c558e", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/eea19dc015312134140456efe49280a0900c558e", "committedDate": "2020-01-08T08:09:05Z", "message": "Expand test with a third, dependent instance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NzcxNjU1", "url": "https://github.com/vespa-engine/vespa/pull/11684#pullrequestreview-339771655", "createdAt": "2020-01-08T10:27:04Z", "commit": {"oid": "f69ea8459763217ec20301a3e484cc3bfa7e9f42"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDoyNzowNVrOFbSoYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDoyNzowNVrOFbSoYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE2MTEyMg==", "bodyText": "Change to \"the instance's current change\"?", "url": "https://github.com/vespa-engine/vespa/pull/11684#discussion_r364161122", "createdAt": "2020-01-08T10:27:05Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/DeploymentStatus.java", "diffHunk": "@@ -90,34 +90,42 @@ public DeploymentStatus(Application application, Map<JobId, JobStatus> allJobs,\n         this.allSteps = List.copyOf(allSteps);\n     }\n \n+    /** The application this deployment status concerns. */\n     public Application application() {\n         return application;\n     }\n \n+    /** A filterable list of the status of all jobs for this application. */\n     public JobList jobs() {\n         return allJobs;\n     }\n \n+    /** Whether any jobs of this application are failing with other errors than lack of capacity in a test zone. */\n     public boolean hasFailures() {\n         return ! allJobs.failing()\n                         .not().withStatus(RunStatus.outOfCapacity)\n                         .isEmpty();\n     }\n \n+    /** All job statuses, by job type, for the given instance. */\n     public Map<JobType, JobStatus> instanceJobs(InstanceName instance) {\n         return allJobs.asList().stream()\n                       .filter(job -> job.id().application().equals(application.id().instance(instance)))\n                       .collect(Collectors.toUnmodifiableMap(job -> job.id().type(),\n                                                          job -> job));\n     }\n \n+    /** Filterable job status lists for each instance of this application. */\n     public Map<ApplicationId, JobList> instanceJobs() {\n         return allJobs.asList().stream()\n                       .collect(groupingBy(job -> job.id().application(),\n                                           collectingAndThen(toUnmodifiableList(), JobList::from)));\n     }\n \n-    /** Returns the set of jobs that need to run for the application's current change to be considered complete. */\n+    /**\n+     * The set of jobs that need to run for the application's current change to be considered complete,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f69ea8459763217ec20301a3e484cc3bfa7e9f42"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f64861a8767c8d9d3f82c98d6a01579fcaae335e", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/f64861a8767c8d9d3f82c98d6a01579fcaae335e", "committedDate": "2020-01-08T13:00:49Z", "message": "Update javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5ODk5MzUz", "url": "https://github.com/vespa-engine/vespa/pull/11684#pullrequestreview-339899353", "createdAt": "2020-01-08T14:29:16Z", "commit": {"oid": "f64861a8767c8d9d3f82c98d6a01579fcaae335e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNDoyOToxNlrOFbYisg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNDoyOToxNlrOFbYisg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI1Nzk3MA==", "bodyText": "Ah, this should prefer production instances.", "url": "https://github.com/vespa-engine/vespa/pull/11684#discussion_r364257970", "createdAt": "2020-01-08T14:29:16Z", "author": {"login": "jonmv"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -699,24 +699,27 @@ private void toSlime(Cursor object, Application application, HttpRequest request\n                                                  \"/job/\",\n                                                  request.getUri()).toString());\n \n+        DeploymentStatus status = controller.jobController().deploymentStatus(application);\n         application.latestVersion().ifPresent(version -> toSlime(version, object.setObject(\"latestVersion\")));\n \n         application.projectId().ifPresent(id -> object.setLong(\"projectId\", id));\n \n-        // Currently deploying change\n-        if ( ! application.change().isEmpty())\n-            toSlime(object.setObject(\"deploying\"), application.change());\n+        // TODO jonmv: Remove this when users are updated.\n+        application.instances().values().stream().findFirst().ifPresent(instance -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f64861a8767c8d9d3f82c98d6a01579fcaae335e"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4084, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}