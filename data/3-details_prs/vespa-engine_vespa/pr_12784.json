{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2Mzk2Mzk4", "number": 12784, "title": "Add explicit limits to backend document selection parsing", "bodyText": "@geirst please review\nAdds the following (very generous) limits:\n\nMax AST depth of 1024\nMax input selection string size of 1 MiB\n\nHave to track AST depth manually, as there is no exposed way of\ndoing this natively via Bison.\nAlso removed a regex that had the potential of catastrophic\nbacktracking in case of massive inputs. It wasn't removed during\nthe previous purge due to being used with capture groups, which are\nnot supported by our current vespalib regex wrapper.", "createdAt": "2020-03-31T15:02:03Z", "url": "https://github.com/vespa-engine/vespa/pull/12784", "merged": true, "mergeCommit": {"oid": "be3c2e7f0f1f3edc07973dccb05b13bf30c75de1"}, "closed": true, "closedAt": "2020-04-01T09:21:17Z", "author": {"login": "vekterli"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTEGUfAH2gAyMzk2Mzk2Mzk4OmJjNjkzNDc2MTM2NjE1YmI0NGI5YzQ3MDVjZDk1OWU1M2ZlZTFhZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTUA0FAFqTM4NTM5ODg4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc693476136615bb44b9c4705cd959e53fee1afd", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/bc693476136615bb44b9c4705cd959e53fee1afd", "committedDate": "2020-03-31T14:37:10Z", "message": "Add explicit limits to backend document selection parsing\n\nAdds the following (very generous) limits:\n- Max AST depth of 1024\n- Max input selection string size of 1 MiB\n\nHave to track AST depth manually, as there is no exposed way of\ndoing this natively via Bison.\n\nAlso removed a regex that had the potential of catastrophic\nbacktracking in case of massive inputs. It wasn't removed during\nthe previous purge due to being used with capture groups, which are\nnot supported by our current vespalib regex wrapper."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "013342a0470e7a5b456921010009c38a4a0c828f", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/013342a0470e7a5b456921010009c38a4a0c828f", "committedDate": "2020-03-31T15:34:39Z", "message": "Compile Flex lexer with options for better code generation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzI1NjEw", "url": "https://github.com/vespa-engine/vespa/pull/12784#pullrequestreview-385325610", "createdAt": "2020-04-01T07:26:28Z", "commit": {"oid": "bc693476136615bb44b9c4705cd959e53fee1afd"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoyNjoyOFrOF-z8lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoyNzoyNFrOF-z-VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwNzEyNg==", "bodyText": "Consider adding the size and limit to the exception message.", "url": "https://github.com/vespa-engine/vespa/pull/12784#discussion_r401407126", "createdAt": "2020-04-01T07:26:28Z", "author": {"login": "geirst"}, "path": "document/src/vespa/document/select/parser.cpp", "diffHunk": "@@ -8,7 +9,18 @@\n \n namespace document::select {\n \n+namespace {\n+\n+void verify_expression_not_too_large(const std::string& expr) {\n+    if (expr.size() > ParserLimits::MaxSelectionByteSize) {\n+        throw ParsingFailedException(\"expression is too large to be parsed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc693476136615bb44b9c4705cd959e53fee1afd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwNzU3Mw==", "bodyText": "Consider adding the depth and max depth limit to the exception message.", "url": "https://github.com/vespa-engine/vespa/pull/12784#discussion_r401407573", "createdAt": "2020-04-01T07:27:24Z", "author": {"login": "geirst"}, "path": "document/src/vespa/document/select/parser_limits.cpp", "diffHunk": "@@ -0,0 +1,11 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+#include \"parser_limits.h\"\n+#include \"parsing_failed_exception.h\"\n+\n+namespace document::select {\n+\n+void throw_max_depth_exceeded_exception() {\n+    throw ParsingFailedException(\"expression is too deeply nested\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc693476136615bb44b9c4705cd959e53fee1afd"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "201a7320f48b1d8868bc1fb38ee1182ad3d84dd7", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/201a7320f48b1d8868bc1fb38ee1182ad3d84dd7", "committedDate": "2020-04-01T08:45:54Z", "message": "Add more limit details to parse failure messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4153969ca13541e7434963d02add12d574c9a461", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/4153969ca13541e7434963d02add12d574c9a461", "committedDate": "2020-04-01T08:49:33Z", "message": "Also include actual expression size in message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1Mzk4ODgz", "url": "https://github.com/vespa-engine/vespa/pull/12784#pullrequestreview-385398883", "createdAt": "2020-04-01T09:09:38Z", "commit": {"oid": "4153969ca13541e7434963d02add12d574c9a461"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2547, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}