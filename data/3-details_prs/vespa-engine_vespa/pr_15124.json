{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTIxODQw", "number": 15124, "title": "Bjorncs/detect reindexing config change", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-10-30T16:25:55Z", "url": "https://github.com/vespa-engine/vespa/pull/15124", "merged": true, "mergeCommit": {"oid": "071caa49645637c77abd96a30e66b5cd6424eef5"}, "closed": true, "closedAt": "2020-11-03T14:07:58Z", "author": {"login": "bjorncs"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXpT8TgH2gAyNTEzMTIxODQwOjk2ODJkOWY3YzVkZTFiMzg5NDNjM2M5OTZhYzE1MmU4OTZhMWYzN2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY5mYqAFqTUyMjUxODY2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9682d9f7c5de1b38943c3c996ac152e896a1f37b", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/9682d9f7c5de1b38943c3c996ac152e896a1f37b", "committedDate": "2020-10-30T16:25:23Z", "message": "Add types for a config change requiring reindexing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5edc6a864721e8462df29262b62f801b78b670e", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/e5edc6a864721e8462df29262b62f801b78b670e", "committedDate": "2020-10-30T16:25:23Z", "message": "Changes index mode or indexing script only requires reindexing\n\nA full refeed is not necessary for these types model changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd697c00530831e3dd711d789ca3e2c9873cd362", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/cd697c00530831e3dd711d789ca3e2c9873cd362", "committedDate": "2020-10-30T16:25:23Z", "message": "Workaround for faulty language level detection in IntelliJ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc23e7060d7b10ca352cf962b01a3b28c35e90e3", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/cc23e7060d7b10ca352cf962b01a3b28c35e90e3", "committedDate": "2020-10-30T16:25:23Z", "message": "Make method mockable from Mockito"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3749fb6b3208062783213a33d6083df3f12181d", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/b3749fb6b3208062783213a33d6083df3f12181d", "committedDate": "2020-10-30T16:25:23Z", "message": "Support reindex actions in configserver\n\nThe new classes are essentially carbon copies of the equivalent classes for refeed actions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTI3Njg0", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-520927684", "createdAt": "2020-10-30T18:20:12Z", "commit": {"oid": "9682d9f7c5de1b38943c3c996ac152e896a1f37b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyMDoxMlrOHrbLDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyMDoxMlrOHrbLDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5NjAxMg==", "bodyText": "REINDEX would be consistent with the other names here.", "url": "https://github.com/vespa-engine/vespa/pull/15124#discussion_r515296012", "createdAt": "2020-10-30T18:20:12Z", "author": {"login": "jonmv"}, "path": "config-model-api/src/main/java/com/yahoo/config/model/api/ConfigChangeAction.java", "diffHunk": "@@ -15,7 +14,7 @@\n public interface ConfigChangeAction {\n \n     enum Type {\n-        RESTART(\"restart\"), REFEED(\"refeed\");\n+        RESTART(\"restart\"), REFEED(\"refeed\"), REINDEXING(\"reindexing\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9682d9f7c5de1b38943c3c996ac152e896a1f37b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTI4ODgz", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-520928883", "createdAt": "2020-10-30T18:21:56Z", "commit": {"oid": "9682d9f7c5de1b38943c3c996ac152e896a1f37b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyMTo1NlrOHrbOig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyMTo1NlrOHrbOig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5NjkwNg==", "bodyText": "Hmm, suggestions don't work today?\nJust wanted to point out typo bed --> be", "url": "https://github.com/vespa-engine/vespa/pull/15124#discussion_r515296906", "createdAt": "2020-10-30T18:21:56Z", "author": {"login": "jonmv"}, "path": "config-model-api/src/main/java/com/yahoo/config/model/api/ConfigChangeReindexAction.java", "diffHunk": "@@ -0,0 +1,20 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.config.model.api;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Represents an action to re-index a document type in order to handle a config change.\n+ *\n+ * @author bjorncs\n+ */\n+public interface ConfigChangeReindexAction extends ConfigChangeAction {\n+\n+    @Override default Type getType() { return Type.REINDEXING; }\n+\n+    /** @return name identifying this kind of change, used to identify names which should be allowed */\n+    String name();\n+\n+    /** @return name of the document type that must bed re-indexed, or empty if all document types */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9682d9f7c5de1b38943c3c996ac152e896a1f37b"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTI5MzM4", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-520929338", "createdAt": "2020-10-30T18:22:38Z", "commit": {"oid": "9682d9f7c5de1b38943c3c996ac152e896a1f37b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyMjozOFrOHrbPyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyMjozOFrOHrbPyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5NzIyNQ==", "bodyText": "Hmm, is \"all document types\" an option here?", "url": "https://github.com/vespa-engine/vespa/pull/15124#discussion_r515297225", "createdAt": "2020-10-30T18:22:38Z", "author": {"login": "jonmv"}, "path": "config-model-api/src/main/java/com/yahoo/config/model/api/ConfigChangeReindexAction.java", "diffHunk": "@@ -0,0 +1,20 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.config.model.api;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Represents an action to re-index a document type in order to handle a config change.\n+ *\n+ * @author bjorncs\n+ */\n+public interface ConfigChangeReindexAction extends ConfigChangeAction {\n+\n+    @Override default Type getType() { return Type.REINDEXING; }\n+\n+    /** @return name identifying this kind of change, used to identify names which should be allowed */\n+    String name();\n+\n+    /** @return name of the document type that must bed re-indexed, or empty if all document types */\n+    Optional<String> getDocumentType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9682d9f7c5de1b38943c3c996ac152e896a1f37b"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTMyOTEw", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-520932910", "createdAt": "2020-10-30T18:28:04Z", "commit": {"oid": "e5edc6a864721e8462df29262b62f801b78b670e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyODowNFrOHrbaXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyODowNFrOHrbaXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5OTkzNQ==", "bodyText": "s/indexing/index/g", "url": "https://github.com/vespa-engine/vespa/pull/15124#discussion_r515299935", "createdAt": "2020-10-30T18:28:04Z", "author": {"login": "jonmv"}, "path": "config-model/src/test/java/com/yahoo/vespa/model/application/validation/change/ConfigChangeTestUtils.java", "diffHunk": "@@ -37,6 +37,15 @@ public static VespaConfigChangeAction newRefeedAction(ClusterSpec.Id id, String\n         return VespaRefeedAction.of(id, name, overrides, message, services, documentType, now);\n     }\n \n+    public static VespaConfigChangeAction newReindexingAction(ClusterSpec.Id id, String name, ValidationOverrides overrides, String message, Instant now) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5edc6a864721e8462df29262b62f801b78b670e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTM2NzU5", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-520936759", "createdAt": "2020-10-30T18:34:02Z", "commit": {"oid": "b3749fb6b3208062783213a33d6083df3f12181d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTM5OTAx", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-520939901", "createdAt": "2020-10-30T18:38:42Z", "commit": {"oid": "b3749fb6b3208062783213a33d6083df3f12181d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4d10a0528531098f8987dc090e9939c50869c31", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/f4d10a0528531098f8987dc090e9939c50869c31", "committedDate": "2020-11-02T08:54:11Z", "message": "Rename 'REINDEXING' => 'REINDEX'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89c43763d88b080840dcbb07b42d35c16a38d5fe", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/89c43763d88b080840dcbb07b42d35c16a38d5fe", "committedDate": "2020-11-02T08:54:55Z", "message": "Fix typo in Javadoc comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78c288b94c158d58ded884aa5592cf9d1f8f1b32", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/78c288b94c158d58ded884aa5592cf9d1f8f1b32", "committedDate": "2020-11-02T10:22:35Z", "message": "Rename 'newReindexingAction' => 'newReindexAction'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d86b5a0fe4388c105144db08ba01e79f5410f1df", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/d86b5a0fe4388c105144db08ba01e79f5410f1df", "committedDate": "2020-11-02T11:40:13Z", "message": "Assume document type is always present after validation is complete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3cdbc1d2f84860fe1027045daddb8681cc009ca", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/e3cdbc1d2f84860fe1027045daddb8681cc009ca", "committedDate": "2020-11-03T13:32:30Z", "message": "Expose which document types have indexing mode 'indexed' and 'streaming'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5863d0e39cb17a358fce3caf46f357d9bd6308cb", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/5863d0e39cb17a358fce3caf46f357d9bd6308cb", "committedDate": "2020-11-03T13:38:00Z", "message": "Detect which document types that have changed indexing mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNTE1MzQ2", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-522515346", "createdAt": "2020-11-03T13:54:17Z", "commit": {"oid": "e3cdbc1d2f84860fe1027045daddb8681cc009ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMzo1NDoxN1rOHsvwBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMzo1NDoxN1rOHsvwBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY4MTczMg==", "bodyText": "Not sure this first part is needed?", "url": "https://github.com/vespa-engine/vespa/pull/15124#discussion_r516681732", "createdAt": "2020-11-03T13:54:17Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/content/ContentSearchCluster.java", "diffHunk": "@@ -336,6 +336,28 @@ public void handleRedundancy(Redundancy redundancy) {\n                 .collect(Collectors.toList());\n     }\n \n+    public List<NewDocumentType> getDocumentTypesWithStreamingCluster() {\n+        List<NewDocumentType> streamingDocTypes = new ArrayList<>();\n+        for (NewDocumentType type : documentDefinitions.values()) {\n+            if (findStreamingCluster(type.getFullName().getName()).isPresent()) {\n+                streamingDocTypes.add(type);\n+            }\n+        }\n+        return streamingDocTypes;\n+    }\n+\n+    public List<NewDocumentType> getDocumentTypesWithIndexedCluster() {\n+        List<NewDocumentType> indexedDocTypes = new ArrayList<>();\n+        for (NewDocumentType type : documentDefinitions.values()) {\n+            if (findStreamingCluster(type.getFullName().getName()).isEmpty()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3cdbc1d2f84860fe1027045daddb8681cc009ca"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNTE4MzAw", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-522518300", "createdAt": "2020-11-03T13:57:33Z", "commit": {"oid": "e3cdbc1d2f84860fe1027045daddb8681cc009ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMzo1NzozM1rOHsv4pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMzo1NzozM1rOHsv4pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY4Mzk0MA==", "bodyText": "I don't think we need this, as we should be happy checking whether a document changes between \"index\" and not \"index\".", "url": "https://github.com/vespa-engine/vespa/pull/15124#discussion_r516683940", "createdAt": "2020-11-03T13:57:33Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/content/ContentSearchCluster.java", "diffHunk": "@@ -336,6 +336,28 @@ public void handleRedundancy(Redundancy redundancy) {\n                 .collect(Collectors.toList());\n     }\n \n+    public List<NewDocumentType> getDocumentTypesWithStreamingCluster() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3cdbc1d2f84860fe1027045daddb8681cc009ca"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNTE4NjY2", "url": "https://github.com/vespa-engine/vespa/pull/15124#pullrequestreview-522518666", "createdAt": "2020-11-03T13:57:55Z", "commit": {"oid": "5863d0e39cb17a358fce3caf46f357d9bd6308cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMzo1Nzo1NVrOHsv5vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMzo1Nzo1NVrOHsv5vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY4NDIyMw==", "bodyText": "We'll miss changes from \"index\" to \"store-only\", or vv.", "url": "https://github.com/vespa-engine/vespa/pull/15124#discussion_r516684223", "createdAt": "2020-11-03T13:57:55Z", "author": {"login": "jonmv"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/change/IndexingModeChangeValidator.java", "diffHunk": "@@ -27,31 +35,56 @@\n         for (Map.Entry<String, ContentCluster> currentEntry : currentModel.getContentClusters().entrySet()) {\n             ContentCluster nextCluster = nextModel.getContentClusters().get(currentEntry.getKey());\n             if (nextCluster == null) continue;\n-\n-            Optional<ConfigChangeAction> change = validateContentCluster(currentEntry.getValue(), nextCluster, overrides, now);\n-            if (change.isPresent())\n-                actions.add(change.get());\n+            actions.addAll(validateContentCluster(currentEntry.getValue(), nextCluster, overrides, now));\n         }\n         return actions;\n     }\n \n-    private Optional<ConfigChangeAction> validateContentCluster(ContentCluster currentCluster, ContentCluster nextCluster,\n-                                                                ValidationOverrides overrides, Instant now) {\n-        boolean currentClusterIsIndexed = currentCluster.getSearch().hasIndexedCluster();\n-        boolean nextClusterIsIndexed = nextCluster.getSearch().hasIndexedCluster();\n-\n-        if (currentClusterIsIndexed == nextClusterIsIndexed) return Optional.empty();\n+    private List<ConfigChangeAction> validateContentCluster(\n+            ContentCluster currentCluster, ContentCluster nextCluster, ValidationOverrides overrides, Instant now) {\n+        List<ConfigChangeAction> changes = new ArrayList<>();\n+        ContentSearchCluster currentSearchCluster = currentCluster.getSearch();\n+        ContentSearchCluster nextSearchCluster = nextCluster.getSearch();\n+        {\n+            Set<String> currentStreamingTypes = toDocumentTypeNames(currentSearchCluster.getDocumentTypesWithStreamingCluster());\n+            Set<String> nextIndexedTypes = toDocumentTypeNames(nextSearchCluster.getDocumentTypesWithIndexedCluster());\n+            for (String type : nextIndexedTypes) {\n+                if (currentStreamingTypes.contains(type)) {\n+                    changes.add(createReindexAction(overrides, now, nextCluster, type, \"streaming\", \"indexed\"));\n+                }\n+            }\n+        }\n+        {\n+            Set<String> currentIndexedTypes = toDocumentTypeNames(currentSearchCluster.getDocumentTypesWithIndexedCluster());\n+            Set<String> nextStreamingTypes = toDocumentTypeNames(nextSearchCluster.getDocumentTypesWithStreamingCluster());\n+            for (String type : nextStreamingTypes) {\n+                if (currentIndexedTypes.contains(type)) {\n+                    changes.add(createReindexAction(overrides, now, nextCluster, type, \"indexed\", \"streaming\"));\n+                }\n+            }\n+        }\n+        return changes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5863d0e39cb17a358fce3caf46f357d9bd6308cb"}, "originalPosition": 76}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2074, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}