{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMDg2Njk2", "number": 11792, "title": "Fail deployment if the wrong web service port is configured", "bodyText": "", "createdAt": "2020-01-15T11:19:03Z", "url": "https://github.com/vespa-engine/vespa/pull/11792", "merged": true, "mergeCommit": {"oid": "54f9f5a01ee741c88512dca5286a0f54e087a02a"}, "closed": true, "closedAt": "2020-01-15T15:12:20Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6jrXjgH2gAyMzYzMDg2Njk2OmRjNzFkMWY5ODc4ZWM5YjMyYTU0MzI0MDlhMmExZjNiZWFkYWIyODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6mCtGgFqTM0MzIzNzQ0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dc71d1f9878ec9b32a5432409a2a1f3beadab289", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/dc71d1f9878ec9b32a5432409a2a1f3beadab289", "committedDate": "2020-01-15T11:16:35Z", "message": "Fail deployment if the wrong web service port is configured\n\nThis will cause the application to become unavailable\nso it is not sufficient to emit a warning."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMTY4MjUy", "url": "https://github.com/vespa-engine/vespa/pull/11792#pullrequestreview-343168252", "createdAt": "2020-01-15T11:56:46Z", "commit": {"oid": "dc71d1f9878ec9b32a5432409a2a1f3beadab289"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMTo1Njo0NlrOFd1-Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMjowNjoxNVrOFd2MhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzNzM0Ng==", "bodyText": "Remove this import", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366837346", "createdAt": "2020-01-15T11:56:46Z", "author": {"login": "bjorncs"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/xml/HttpBuilder.java", "diffHunk": "@@ -20,6 +20,7 @@\n import com.yahoo.vespa.model.container.http.Binding;\n import org.w3c.dom.Element;\n \n+import javax.management.loading.MLetMBean;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc71d1f9878ec9b32a5432409a2a1f3beadab289"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzODg3MQ==", "bodyText": "Consider using ExpectedException.", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366838871", "createdAt": "2020-01-15T12:00:53Z", "author": {"login": "bjorncs"}, "path": "config-model/src/test/java/com/yahoo/config/model/provision/ModelProvisioningTest.java", "diffHunk": "@@ -1313,6 +1314,28 @@ public void testThatStandaloneSyntaxWorksOnHostedVespa() {\n         assertEquals(1, model.getContainerClusters().size());\n     }\n \n+    @Test\n+    public void testThatStandaloneSyntaxOnHostedVespaRequiresDefaultPort() {\n+        try {\n+            String services =\n+                    \"<?xml version='1.0' encoding='utf-8' ?>\" +\n+                    \"<container id='foo' version='1.0'>\" +\n+                    \"  <http>\" +\n+                    \"    <server id='server1' port='8095' />\" +\n+                    \"  </http>\" +\n+                    \"</container>\";\n+            VespaModelTester tester = new VespaModelTester();\n+            tester.addHosts(1);\n+            VespaModel model = tester.createModel(services, true);\n+            fail(\"Expected exception\");\n+        }\n+        catch (IllegalArgumentException e) {\n+            // Success\n+            assertEquals(\"Illegal port 8095 in http server 'server1': Port must be set to \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc71d1f9878ec9b32a5432409a2a1f3beadab289"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzOTgzNA==", "bodyText": "Consider using ExpectedException.", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366839834", "createdAt": "2020-01-15T12:03:17Z", "author": {"login": "bjorncs"}, "path": "config-model/src/test/java/com/yahoo/vespa/model/container/xml/ContainerModelBuilderTest.java", "diffHunk": "@@ -133,29 +134,35 @@ public void http_server_port_is_configurable_and_does_not_affect_other_ports() {\n     }\n \n     @Test\n-    public void fail_if_http_port_is_not_4080_in_hosted_vespa() throws Exception {\n-        String servicesXml =\n-                \"<services>\" +\n-                \"<admin version='3.0'>\" +\n-                \"    <nodes count='1'/>\" +\n-                \"</admin>\" +\n-                \"<container version='1.0'>\" +\n-                \"  <http>\" +\n-                \"    <server port='9000' id='foo' />\" +\n-                \"  </http>\" +\n-                nodesXml +\n-                \"</container>\" +\n-                \"</services>\";\n-        ApplicationPackage applicationPackage = new MockApplicationPackage.Builder().withServices(servicesXml).build();\n-        // Need to create VespaModel to make deploy properties have effect\n-        final TestLogger logger = new TestLogger();\n-        new VespaModel(new NullConfigModelRegistry(), new DeployState.Builder()\n-                .applicationPackage(applicationPackage)\n-                .deployLogger(logger)\n-                .properties(new TestProperties().setHostedVespa(true))\n-                .build());\n-        assertFalse(logger.msgs.isEmpty());\n-        assertThat(logger.msgs.get(0).getSecond(), containsString(String.format(\"You cannot set port to anything else than %d\", Container.BASEPORT)));\n+    public void fail_if_http_port_is_not_default_in_hosted_vespa() throws Exception {\n+        try {\n+            String servicesXml =\n+                    \"<services>\" +\n+                    \"<admin version='3.0'>\" +\n+                    \"    <nodes count='1'/>\" +\n+                    \"</admin>\" +\n+                    \"<container version='1.0'>\" +\n+                    \"  <http>\" +\n+                    \"    <server port='9000' id='foo' />\" +\n+                    \"  </http>\" +\n+                    nodesXml +\n+                    \"</container>\" +\n+                    \"</services>\";\n+            ApplicationPackage applicationPackage = new MockApplicationPackage.Builder().withServices(servicesXml).build();\n+            // Need to create VespaModel to make deploy properties have effect\n+            TestLogger logger = new TestLogger();\n+            new VespaModel(new NullConfigModelRegistry(), new DeployState.Builder()\n+                                                                  .applicationPackage(applicationPackage)\n+                                                                  .deployLogger(logger)\n+                                                                  .properties(new TestProperties().setHostedVespa(true))\n+                                                                  .build());\n+            fail(\"Expected exception\");\n+        }\n+        catch (IllegalArgumentException e) {\n+            // Success\n+            assertEquals(\"Illegal port 9000 in http server 'foo': Port must be set to \" + Defaults.getDefaults().vespaWebServicePort(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc71d1f9878ec9b32a5432409a2a1f3beadab289"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0MDk2NQ==", "bodyText": "Consider removing \"hosted Vespa\" from test name as this test does not use a hosted specific model.", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366840965", "createdAt": "2020-01-15T12:06:15Z", "author": {"login": "bjorncs"}, "path": "config-model/src/test/java/com/yahoo/config/model/provision/ModelProvisioningTest.java", "diffHunk": "@@ -1313,6 +1314,28 @@ public void testThatStandaloneSyntaxWorksOnHostedVespa() {\n         assertEquals(1, model.getContainerClusters().size());\n     }\n \n+    @Test\n+    public void testThatStandaloneSyntaxOnHostedVespaRequiresDefaultPort() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc71d1f9878ec9b32a5432409a2a1f3beadab289"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "241fd2b9a7573e0e11a9b1508d05a95a2a976859", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/241fd2b9a7573e0e11a9b1508d05a95a2a976859", "committedDate": "2020-01-15T12:10:04Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f666777e6494961cfc1aa36fd25f434874644b21", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/f666777e6494961cfc1aa36fd25f434874644b21", "committedDate": "2020-01-15T12:56:25Z", "message": "Merge with master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "566bd79f9881461dfccc24e41bffa317640da75c", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/566bd79f9881461dfccc24e41bffa317640da75c", "committedDate": "2020-01-15T13:34:45Z", "message": "Allow omitting server port to get default"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMjM3NDQ2", "url": "https://github.com/vespa-engine/vespa/pull/11792#pullrequestreview-343237446", "createdAt": "2020-01-15T14:01:53Z", "commit": {"oid": "566bd79f9881461dfccc24e41bffa317640da75c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4011, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}