{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzOTM0Nzc1", "number": 15133, "title": "Arnej/handle hash collision", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@havardpe please review", "createdAt": "2020-11-02T09:49:42Z", "url": "https://github.com/vespa-engine/vespa/pull/15133", "merged": true, "mergeCommit": {"oid": "c3c0c67621ec2ad422e69159fe46698e45e2cac1"}, "closed": true, "closedAt": "2020-11-03T14:26:12Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYhYjNAH2gAyNTEzOTM0Nzc1Ojg5NTRhMzVjYWI4OTVhNzY2YWNhMmQwMWM2ZmU1ZTZjZmFmZjcxYjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY5Wl6gFqTUyMjUwMzE3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8954a35cab895a766aca2d01c6fe5e6cfaff71b3", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/8954a35cab895a766aca2d01c6fe5e6cfaff71b3", "committedDate": "2020-11-02T09:45:06Z", "message": "handle add_subspace with same address (or hash collision)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1163c6cf86a418216af628ec7f1cbaef60bb4f53", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/1163c6cf86a418216af628ec7f1cbaef60bb4f53", "committedDate": "2020-11-02T09:45:10Z", "message": "test add_subspace robustness for FastValue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f8b850f484edb2e8aa2cfab335903c417f81628", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/8f8b850f484edb2e8aa2cfab335903c417f81628", "committedDate": "2020-11-02T09:46:25Z", "message": "disallow duplicate add_subspace for PackedMixedTensorBuilder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDc3MzE5", "url": "https://github.com/vespa-engine/vespa/pull/15133#pullrequestreview-521477319", "createdAt": "2020-11-02T09:52:47Z", "commit": {"oid": "8f8b850f484edb2e8aa2cfab335903c417f81628"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOTo1Mjo0OFrOHr9QSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDowMDo1NFrOHr9jvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg1NDQwOA==", "bodyText": "consider splitting into separate tests", "url": "https://github.com/vespa-engine/vespa/pull/15133#discussion_r515854408", "createdAt": "2020-11-02T09:52:48Z", "author": {"login": "havardpe"}, "path": "eval/src/tests/eval/fast_value/fast_value_test.cpp", "diffHunk": "@@ -56,4 +58,57 @@ TEST(FastCellsTest, add_cells_works) {\n     EXPECT_EQ(*cells.get(5), 6.0);\n }\n \n+using SA = std::vector<vespalib::stringref>;\n+\n+TEST(FastValueTest, add_subspace_robustness) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8b850f484edb2e8aa2cfab335903c417f81628"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg1NjExMQ==", "bodyText": "consider adding compiler intrinsic indicating that adding is most likely", "url": "https://github.com/vespa-engine/vespa/pull/15133#discussion_r515856111", "createdAt": "2020-11-02T09:55:32Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/eval/fast_sparse_map.h", "diffHunk": "@@ -135,6 +135,26 @@ class FastSparseMap\n         _map.insert(std::make_pair(Key(hash), value));\n     }\n \n+    // used to add a mapping, but in the unlikely case\n+    // of hash collision it works like lookup instead.\n+    template <typename T>\n+    size_t lookup_or_add_mapping(ConstArrayRef<T> addr) {\n+        uint64_t hash = 0;\n+        size_t old_labels_size = _labels.size();\n+        for (const auto &label: addr) {\n+            _labels.emplace_back(label);\n+            hash = 31 * hash + hash_label(_labels.back());\n+        }\n+        uint32_t value = _map.size();\n+        auto [iter, did_add] = _map.insert(std::make_pair(Key(hash), value));\n+        if (did_add) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8b850f484edb2e8aa2cfab335903c417f81628"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg1Nzg4MQ==", "bodyText": "consider adding compiler intrinsic indicating that adding is expected", "url": "https://github.com/vespa-engine/vespa/pull/15133#discussion_r515857881", "createdAt": "2020-11-02T09:58:27Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/eval/fast_value.hpp", "diffHunk": "@@ -230,8 +230,11 @@ struct FastValue final : Value, ValueBuilder<T> {\n     const Value::Index &index() const override { return my_index; }\n     TypedCells cells() const override { return TypedCells(my_cells.memory, get_cell_type<T>(), my_cells.size); }\n     ArrayRef<T> add_subspace(ConstArrayRef<vespalib::stringref> addr) override {\n-        my_index.map.add_mapping(addr);\n-        return my_cells.add_cells(my_subspace_size);\n+        size_t idx = my_index.map.lookup_or_add_mapping(addr) * my_subspace_size;\n+        if (idx == my_cells.size) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8b850f484edb2e8aa2cfab335903c417f81628"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg1OTM4OQ==", "bodyText": "I think we should just call this add_mapping and remove the old version altogether.", "url": "https://github.com/vespa-engine/vespa/pull/15133#discussion_r515859389", "createdAt": "2020-11-02T10:00:54Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/eval/fast_sparse_map.h", "diffHunk": "@@ -135,6 +135,26 @@ class FastSparseMap\n         _map.insert(std::make_pair(Key(hash), value));\n     }\n \n+    // used to add a mapping, but in the unlikely case\n+    // of hash collision it works like lookup instead.\n+    template <typename T>\n+    size_t lookup_or_add_mapping(ConstArrayRef<T> addr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8b850f484edb2e8aa2cfab335903c417f81628"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb6150b213bda462321e23ce10c66c8f9c62b48a", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/cb6150b213bda462321e23ce10c66c8f9c62b48a", "committedDate": "2020-11-03T09:23:52Z", "message": "consistent add_mapping\n\n* rename lookup_or_add_mapping to just add_mapping\n* change the other add_mapping to have same semantics\n* in FastValueIndex, check the result from add_mapping\n  each place\n* use __builtin_expect to tell both the reader and the\n  compiler what the expected path is"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a04bf607a523cab52af9eefa91623e327ed75b49", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/a04bf607a523cab52af9eefa91623e327ed75b49", "committedDate": "2020-11-03T12:44:13Z", "message": "split tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNTAzMTcy", "url": "https://github.com/vespa-engine/vespa/pull/15133#pullrequestreview-522503172", "createdAt": "2020-11-03T13:40:41Z", "commit": {"oid": "a04bf607a523cab52af9eefa91623e327ed75b49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2087, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}