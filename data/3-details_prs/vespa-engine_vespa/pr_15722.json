{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzNzA5MjE3", "number": 15722, "title": "Add a force_insert method to the hash_table. It is faster as it skips\u2026", "bodyText": "\u2026 the presence check and avoid equality compare.\nIt allows duplicates and should hence be used carefully.\nAt least resize will be faster as it it can safely be used there.\n@havardpe PR", "createdAt": "2020-12-07T14:19:20Z", "url": "https://github.com/vespa-engine/vespa/pull/15722", "merged": true, "mergeCommit": {"oid": "663900a1ea319d3e9f72a0cd546ff3e9706eda93"}, "closed": true, "closedAt": "2020-12-07T16:20:22Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj2NvaAH2gAyNTMzNzA5MjE3OjMxMzg3NWU1MjYxN2VkM2JhMjNjYmUyODhjYTY5ZmYyOTdhODE4YTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj4AaRgH2gAyNTMzNzA5MjE3OjQ2N2I2ZmVkOWJiYjcwMzRmODFiM2I0ZWNiYzM0MTc5MTFhZmRjMTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "313875e52617ed3ba23cbe288ca69ff297a818a6", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/313875e52617ed3ba23cbe288ca69ff297a818a6", "committedDate": "2020-12-07T14:14:28Z", "message": "Add a force_insert method to the hash_table. It is faster as it skips the presence check and avoid equality compare.\nIt allows duplicates and should hence be used carefully.\nAt least resize will be faster as it it can safely be used there."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjA0MjYy", "url": "https://github.com/vespa-engine/vespa/pull/15722#pullrequestreview-546204262", "createdAt": "2020-12-07T14:32:32Z", "commit": {"oid": "313875e52617ed3ba23cbe288ca69ff297a818a6"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDozMjozMlrOIApk2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDozNjoxMVrOIApvow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1MjA4OA==", "bodyText": "consider aliasing First to Select1st (use actual code instead of custom code that does the same)", "url": "https://github.com/vespa-engine/vespa/pull/15722#discussion_r537552088", "createdAt": "2020-12-07T14:32:32Z", "author": {"login": "havardpe"}, "path": "vespalib/src/tests/stllike/hashtable_test.cpp", "diffHunk": "@@ -73,6 +73,48 @@ TEST(\"require that hashtable<int> can be copied\") {\n     EXPECT_EQUAL(42, *table2.find(42));\n }\n \n+TEST(\"require that you can insert duplicates\") {\n+    using Pair = std::pair<int, vespalib::string>;\n+    using Map = hashtable<int, Pair, vespalib::hash<int>, std::equal_to<int>, First<int, Pair>>;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "313875e52617ed3ba23cbe288ca69ff297a818a6"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1NDg1MQ==", "bodyText": "should also verify that duplicates survive resizing", "url": "https://github.com/vespa-engine/vespa/pull/15722#discussion_r537554851", "createdAt": "2020-12-07T14:36:11Z", "author": {"login": "havardpe"}, "path": "vespalib/src/tests/stllike/hashtable_test.cpp", "diffHunk": "@@ -73,6 +73,48 @@ TEST(\"require that hashtable<int> can be copied\") {\n     EXPECT_EQUAL(42, *table2.find(42));\n }\n \n+TEST(\"require that you can insert duplicates\") {\n+    using Pair = std::pair<int, vespalib::string>;\n+    using Map = hashtable<int, Pair, vespalib::hash<int>, std::equal_to<int>, First<int, Pair>>;\n+\n+    Map m(1);\n+    EXPECT_EQUAL(0u, m.size());\n+    EXPECT_EQUAL(8u, m.capacity());\n+    auto res = m.insert(Pair(1, \"1\"));\n+    EXPECT_TRUE(res.second);\n+    EXPECT_EQUAL(1u, m.size());\n+    EXPECT_EQUAL(8u, m.capacity());\n+    res = m.insert(Pair(1, \"1.2\"));\n+    EXPECT_FALSE(res.second);\n+    auto found = m.find(1);\n+    ASSERT_TRUE(found != m.end());\n+    EXPECT_EQUAL(found->second, \"1\");\n+\n+    m.force_insert(Pair(1, \"1.2\"));\n+    EXPECT_EQUAL(2u, m.size());\n+    EXPECT_EQUAL(8u, m.capacity());\n+    m.force_insert(Pair(1, \"1.3\"));\n+    EXPECT_EQUAL(3u, m.size());\n+    EXPECT_EQUAL(16u, m.capacity());\n+    found = m.find(1);\n+    ASSERT_TRUE(found != m.end());\n+    EXPECT_EQUAL(found->second, \"1\");\n+\n+    m.erase(1);\n+    EXPECT_EQUAL(2u, m.size());\n+    EXPECT_EQUAL(16u, m.capacity());\n+    found = m.find(1);\n+    ASSERT_TRUE(found != m.end());\n+    EXPECT_EQUAL(found->second, \"1.3\");\n+\n+    m.erase(1);\n+    EXPECT_EQUAL(1u, m.size());\n+    EXPECT_EQUAL(16u, m.capacity());\n+    found = m.find(1);\n+    ASSERT_TRUE(found != m.end());\n+    EXPECT_EQUAL(found->second, \"1.2\");\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "313875e52617ed3ba23cbe288ca69ff297a818a6"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c56085ba10570d063571d5aa4a68ee538e89612", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/2c56085ba10570d063571d5aa4a68ee538e89612", "committedDate": "2020-12-07T16:08:17Z", "message": "Expect that all are present after resize too."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "467b6fed9bbb7034f81b3b4ecbc3417911afdc18", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/467b6fed9bbb7034f81b3b4ecbc3417911afdc18", "committedDate": "2020-12-07T16:19:43Z", "message": "Use Select1st"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3807, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}