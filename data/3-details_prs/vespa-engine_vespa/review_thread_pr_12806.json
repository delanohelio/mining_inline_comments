{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NTM2NDU0", "number": 12806, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMzowNzozM1rODt8auA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNToyNzo0N1rODuAbXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTAyMzkyOnYy", "diffSide": "RIGHT", "path": "fbench/src/fbench/fbench.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMzowNzozNFrOF_qUQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyNzowMVrOF_t2oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5NzkyMw==", "bodyText": "you need to check the result of the percentile calculation against the sampled data to see if it is approximate, not the input parameter of the percentile calculation...", "url": "https://github.com/vespa-engine/vespa/pull/12806#discussion_r402297923", "createdAt": "2020-04-02T13:07:34Z", "author": {"login": "havardpe"}, "path": "fbench/src/fbench/fbench.cpp", "diffHunk": "@@ -250,24 +243,24 @@ FBench::PrintSummary()\n     printf(\"minimum response time:  %8.2f ms\\n\", status._minTime);\n     printf(\"maximum response time:  %8.2f ms\\n\", status._maxTime);\n     printf(\"average response time:  %8.2f ms\\n\", status.GetAverage());\n-    if (p25 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"25 percentile:          %8.2f ms (approx)\\n\", p25);\n-    else         printf(\"25 percentile:          %8.2f ms\\n\", p25);\n-    if (p50 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"50 percentile:          %8.2f ms (approx)\\n\", p50);\n-    else         printf(\"50 percentile:          %8.2f ms\\n\", p50);\n-    if (p75 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"75 percentile:          %8.2f ms (approx)\\n\", p75);\n-    else         printf(\"75 percentile:          %8.2f ms\\n\", p75);\n-    if (p90 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"90 percentile:          %8.2f ms (approx)\\n\", p90);\n-    else         printf(\"90 percentile:          %8.2f ms\\n\", p90);\n-    if (p95 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"95 percentile:          %8.2f ms (approx)\\n\", p95);\n-    else         printf(\"95 percentile:          %8.2f ms\\n\", p95);\n-    if (p99 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"99 percentile:          %8.2f ms (approx)\\n\", p99);\n-    else         printf(\"99 percentile:          %8.2f ms\\n\", p99);\n+\n+    for (double percentile : {25.0, 50.0, 75.0, 90.0, 98.0, 99.0, 99.5, 99.6, 99.7, 99.8, 99.9}) {\n+        if (percentile <= 99.0) {\n+            //Backwards compatible printing\n+            if (percentile > (status._timetable.size() / status._timetableResolution - 1)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63eac4550cb4ebc15816f79fa052e6416821e68b"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1NTg3Mg==", "bodyText": "Good catch, fixed", "url": "https://github.com/vespa-engine/vespa/pull/12806#discussion_r402355872", "createdAt": "2020-04-02T14:27:01Z", "author": {"login": "baldersheim"}, "path": "fbench/src/fbench/fbench.cpp", "diffHunk": "@@ -250,24 +243,24 @@ FBench::PrintSummary()\n     printf(\"minimum response time:  %8.2f ms\\n\", status._minTime);\n     printf(\"maximum response time:  %8.2f ms\\n\", status._maxTime);\n     printf(\"average response time:  %8.2f ms\\n\", status.GetAverage());\n-    if (p25 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"25 percentile:          %8.2f ms (approx)\\n\", p25);\n-    else         printf(\"25 percentile:          %8.2f ms\\n\", p25);\n-    if (p50 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"50 percentile:          %8.2f ms (approx)\\n\", p50);\n-    else         printf(\"50 percentile:          %8.2f ms\\n\", p50);\n-    if (p75 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"75 percentile:          %8.2f ms (approx)\\n\", p75);\n-    else         printf(\"75 percentile:          %8.2f ms\\n\", p75);\n-    if (p90 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"90 percentile:          %8.2f ms (approx)\\n\", p90);\n-    else         printf(\"90 percentile:          %8.2f ms\\n\", p90);\n-    if (p95 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"95 percentile:          %8.2f ms (approx)\\n\", p95);\n-    else         printf(\"95 percentile:          %8.2f ms\\n\", p95);\n-    if (p99 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"99 percentile:          %8.2f ms (approx)\\n\", p99);\n-    else         printf(\"99 percentile:          %8.2f ms\\n\", p99);\n+\n+    for (double percentile : {25.0, 50.0, 75.0, 90.0, 98.0, 99.0, 99.5, 99.6, 99.7, 99.8, 99.9}) {\n+        if (percentile <= 99.0) {\n+            //Backwards compatible printing\n+            if (percentile > (status._timetable.size() / status._timetableResolution - 1)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5NzkyMw=="}, "originalCommit": {"oid": "63eac4550cb4ebc15816f79fa052e6416821e68b"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTAyNzIwOnYy", "diffSide": "RIGHT", "path": "fbench/src/fbench/fbench.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMzowODoyNFrOF_qWXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyODowMVrOF_t5tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5ODQ2Mw==", "bodyText": "factoring out the formatting of the percentile number would probably be useful here...", "url": "https://github.com/vespa-engine/vespa/pull/12806#discussion_r402298463", "createdAt": "2020-04-02T13:08:24Z", "author": {"login": "havardpe"}, "path": "fbench/src/fbench/fbench.cpp", "diffHunk": "@@ -250,24 +243,24 @@ FBench::PrintSummary()\n     printf(\"minimum response time:  %8.2f ms\\n\", status._minTime);\n     printf(\"maximum response time:  %8.2f ms\\n\", status._maxTime);\n     printf(\"average response time:  %8.2f ms\\n\", status.GetAverage());\n-    if (p25 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"25 percentile:          %8.2f ms (approx)\\n\", p25);\n-    else         printf(\"25 percentile:          %8.2f ms\\n\", p25);\n-    if (p50 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"50 percentile:          %8.2f ms (approx)\\n\", p50);\n-    else         printf(\"50 percentile:          %8.2f ms\\n\", p50);\n-    if (p75 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"75 percentile:          %8.2f ms (approx)\\n\", p75);\n-    else         printf(\"75 percentile:          %8.2f ms\\n\", p75);\n-    if (p90 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"90 percentile:          %8.2f ms (approx)\\n\", p90);\n-    else         printf(\"90 percentile:          %8.2f ms\\n\", p90);\n-    if (p95 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"95 percentile:          %8.2f ms (approx)\\n\", p95);\n-    else         printf(\"95 percentile:          %8.2f ms\\n\", p95);\n-    if (p99 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"99 percentile:          %8.2f ms (approx)\\n\", p99);\n-    else         printf(\"99 percentile:          %8.2f ms\\n\", p99);\n+\n+    for (double percentile : {25.0, 50.0, 75.0, 90.0, 98.0, 99.0, 99.5, 99.6, 99.7, 99.8, 99.9}) {\n+        if (percentile <= 99.0) {\n+            //Backwards compatible printing\n+            if (percentile > (status._timetable.size() / status._timetableResolution - 1)) {\n+                printf(\"%2d percentile:          %8.2f ms (approx)\\n\", int(percentile), status.GetPercentile(percentile));\n+            } else {\n+                printf(\"%2d percentile:          %8.2f ms\\n\", int(percentile), status.GetPercentile(percentile));\n+            }\n+        } else {\n+            if (percentile > (status._timetable.size() / status._timetableResolution - 1)) {\n+                printf(\"%2.1f percentile:          %8.2f ms (approx)\\n\", percentile, status.GetPercentile(percentile));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63eac4550cb4ebc15816f79fa052e6416821e68b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1NjY2MA==", "bodyText": "Factored out both optional (approx) and formating of percentile.", "url": "https://github.com/vespa-engine/vespa/pull/12806#discussion_r402356660", "createdAt": "2020-04-02T14:28:01Z", "author": {"login": "baldersheim"}, "path": "fbench/src/fbench/fbench.cpp", "diffHunk": "@@ -250,24 +243,24 @@ FBench::PrintSummary()\n     printf(\"minimum response time:  %8.2f ms\\n\", status._minTime);\n     printf(\"maximum response time:  %8.2f ms\\n\", status._maxTime);\n     printf(\"average response time:  %8.2f ms\\n\", status.GetAverage());\n-    if (p25 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"25 percentile:          %8.2f ms (approx)\\n\", p25);\n-    else         printf(\"25 percentile:          %8.2f ms\\n\", p25);\n-    if (p50 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"50 percentile:          %8.2f ms (approx)\\n\", p50);\n-    else         printf(\"50 percentile:          %8.2f ms\\n\", p50);\n-    if (p75 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"75 percentile:          %8.2f ms (approx)\\n\", p75);\n-    else         printf(\"75 percentile:          %8.2f ms\\n\", p75);\n-    if (p90 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"90 percentile:          %8.2f ms (approx)\\n\", p90);\n-    else         printf(\"90 percentile:          %8.2f ms\\n\", p90);\n-    if (p95 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"95 percentile:          %8.2f ms (approx)\\n\", p95);\n-    else         printf(\"95 percentile:          %8.2f ms\\n\", p95);\n-    if (p99 > status._timetable.size() / status._timetableResolution - 1)\n-        printf(\"99 percentile:          %8.2f ms (approx)\\n\", p99);\n-    else         printf(\"99 percentile:          %8.2f ms\\n\", p99);\n+\n+    for (double percentile : {25.0, 50.0, 75.0, 90.0, 98.0, 99.0, 99.5, 99.6, 99.7, 99.8, 99.9}) {\n+        if (percentile <= 99.0) {\n+            //Backwards compatible printing\n+            if (percentile > (status._timetable.size() / status._timetableResolution - 1)) {\n+                printf(\"%2d percentile:          %8.2f ms (approx)\\n\", int(percentile), status.GetPercentile(percentile));\n+            } else {\n+                printf(\"%2d percentile:          %8.2f ms\\n\", int(percentile), status.GetPercentile(percentile));\n+            }\n+        } else {\n+            if (percentile > (status._timetable.size() / status._timetableResolution - 1)) {\n+                printf(\"%2.1f percentile:          %8.2f ms (approx)\\n\", percentile, status.GetPercentile(percentile));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5ODQ2Mw=="}, "originalCommit": {"oid": "63eac4550cb4ebc15816f79fa052e6416821e68b"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTY4MDkzOnYy", "diffSide": "RIGHT", "path": "fbench/src/fbench/fbench.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNToyNzo0N1rOF_wyNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNjo0ODowMFrOF_0MRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMzg5NQ==", "bodyText": "I think this will add 2 extra spaces in the 'backwards' case...", "url": "https://github.com/vespa-engine/vespa/pull/12806#discussion_r402403895", "createdAt": "2020-04-02T15:27:47Z", "author": {"login": "havardpe"}, "path": "fbench/src/fbench/fbench.cpp", "diffHunk": "@@ -200,6 +200,28 @@ FBench::StopClients()\n     printf(\"\\nClients Joined.\\n\");\n }\n \n+namespace {\n+\n+const char *\n+approx(double latency, const ClientStatus & status) {\n+    return (latency > (status._timetable.size() / status._timetableResolution - 1))\n+           ? \"ms (approx)\"\n+           : \"ms\";\n+}\n+\n+std::string\n+fmtPercentile(double percentile) {\n+    char buf[32];\n+    if (percentile <= 99.0) {\n+        snprintf(buf, sizeof(buf), \"%2d  \", int(percentile));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953a6678dc5804ce09f98d0995db3987f1f816e2"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1OTcxNg==", "bodyText": "Yes, that is fine. I just wanted to avid decimals  in the old percentiles", "url": "https://github.com/vespa-engine/vespa/pull/12806#discussion_r402459716", "createdAt": "2020-04-02T16:48:00Z", "author": {"login": "baldersheim"}, "path": "fbench/src/fbench/fbench.cpp", "diffHunk": "@@ -200,6 +200,28 @@ FBench::StopClients()\n     printf(\"\\nClients Joined.\\n\");\n }\n \n+namespace {\n+\n+const char *\n+approx(double latency, const ClientStatus & status) {\n+    return (latency > (status._timetable.size() / status._timetableResolution - 1))\n+           ? \"ms (approx)\"\n+           : \"ms\";\n+}\n+\n+std::string\n+fmtPercentile(double percentile) {\n+    char buf[32];\n+    if (percentile <= 99.0) {\n+        snprintf(buf, sizeof(buf), \"%2d  \", int(percentile));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMzg5NQ=="}, "originalCommit": {"oid": "953a6678dc5804ce09f98d0995db3987f1f816e2"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2175, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}