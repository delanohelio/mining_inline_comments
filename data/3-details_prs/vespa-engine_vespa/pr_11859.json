{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0ODM1MTI2", "number": 11859, "title": "Support overriding global routing status of routing policies", "bodyText": "Next step is to wire this into application and operator APIs.\nFYI @tokle", "createdAt": "2020-01-20T13:31:06Z", "url": "https://github.com/vespa-engine/vespa/pull/11859", "merged": true, "mergeCommit": {"oid": "a8a1ec711376e8146a639cb860f8c4860f8f0215"}, "closed": true, "closedAt": "2020-01-21T14:29:05Z", "author": {"login": "mpolden"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8LkbmAH2gAyMzY0ODM1MTI2OjllNTZiZTY1NjhiNjhmMWUyZGQ2ZTdjNWU0ZmRiNzAzZjhhNDA2MGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8iBpCgFqTM0NTkxODA5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e56be6568b68f1e2dd6e7c5e4fdb703f8a4060e", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/9e56be6568b68f1e2dd6e7c5e4fdb703f8a4060e", "committedDate": "2020-01-20T12:19:08Z", "message": "Rename active -> loadBalancerActive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcef3c0b55b9cb153b62bd85e3ec0c8232441a7e", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/bcef3c0b55b9cb153b62bd85e3ec0c8232441a7e", "committedDate": "2020-01-20T12:19:08Z", "message": "Remove support for legacy serialized format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08c3555d2f4e6547a7ed26334aaaa5aa6536df47", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/08c3555d2f4e6547a7ed26334aaaa5aa6536df47", "committedDate": "2020-01-20T12:19:08Z", "message": "Improve names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ac7dbe56cf00751164c14d711e3466509c782c5", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/2ac7dbe56cf00751164c14d711e3466509c782c5", "committedDate": "2020-01-20T12:19:08Z", "message": "Move RoutingPolicies to routing package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ea2ad3c3f2cd7ec9e0f44150937b06e63bda5e9", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/9ea2ad3c3f2cd7ec9e0f44150937b06e63bda5e9", "committedDate": "2020-01-20T12:19:08Z", "message": "Move RoutingPolicy to routing package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63ce305d9728e7a8676b75f8263da0b08e5c4d4e", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/63ce305d9728e7a8676b75f8263da0b08e5c4d4e", "committedDate": "2020-01-20T12:19:08Z", "message": "Move RoutingId to routing package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbe39b00eab82c561bd6a531e0c27b547c85210d", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/fbe39b00eab82c561bd6a531e0c27b547c85210d", "committedDate": "2020-01-20T12:19:08Z", "message": "Extract RoutingPolicyId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff5cb1626ae172aba997b9af67f5765d195b805c", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/ff5cb1626ae172aba997b9af67f5765d195b805c", "committedDate": "2020-01-20T12:19:08Z", "message": "Group routing policies by RoutingPolicyId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94af145a942bd38b4e8029b8f508822b5cf8bd84", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/94af145a942bd38b4e8029b8f508822b5cf8bd84", "committedDate": "2020-01-20T12:19:08Z", "message": "Extract Status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce49e6b13b713a14439dd6e5dc4f398a986bb309", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/ce49e6b13b713a14439dd6e5dc4f398a986bb309", "committedDate": "2020-01-20T12:19:48Z", "message": "Simplify test code using routing policies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa8452b6d0c60c45a77e205cd0adac0a02ed1dd4", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/aa8452b6d0c60c45a77e205cd0adac0a02ed1dd4", "committedDate": "2020-01-20T12:19:48Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "713fe22418654aa88b22232f8d20e96c7e69aa24", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/713fe22418654aa88b22232f8d20e96c7e69aa24", "committedDate": "2020-01-20T13:26:13Z", "message": "Support overriding global endpoint status at deployment level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e57e76ef56dd38731f080aa0477708f547b39307", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/e57e76ef56dd38731f080aa0477708f547b39307", "committedDate": "2020-01-20T13:26:31Z", "message": "Support overriding global endpoint status at zone level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d0f3aef927403f6e4ac80b35edc99db2923ed0f", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/3d0f3aef927403f6e4ac80b35edc99db2923ed0f", "committedDate": "2020-01-20T13:26:31Z", "message": "Support overriding global routing status through deployment.xml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NzYwNDEw", "url": "https://github.com/vespa-engine/vespa/pull/11859#pullrequestreview-345760410", "createdAt": "2020-01-21T10:09:08Z", "commit": {"oid": "ff5cb1626ae172aba997b9af67f5765d195b805c"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMDowOTowOVrOFf0hYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMToxMDoyNVrOFf2V-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkxMDY4OQ==", "bodyText": "They should not happen - but consider ID collisions?", "url": "https://github.com/vespa-engine/vespa/pull/11859#discussion_r368910689", "createdAt": "2020-01-21T10:09:09Z", "author": {"login": "oyving"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/persistence/RoutingPolicySerializer.java", "diffHunk": "@@ -57,22 +59,23 @@ public Slime toSlime(Set<RoutingPolicy> routingPolicies) {\n         return slime;\n     }\n \n-    public Set<RoutingPolicy> fromSlime(ApplicationId owner, Slime slime) {\n-        var policies = new LinkedHashSet<RoutingPolicy>();\n+    public Map<RoutingPolicyId, RoutingPolicy> fromSlime(ApplicationId owner, Slime slime) {\n+        var policies = new LinkedHashMap<RoutingPolicyId, RoutingPolicy>();\n         var root = slime.get();\n         var field = root.field(routingPoliciesField);\n         field.traverse((ArrayTraverser) (i, inspect) -> {\n             var endpointIds = new LinkedHashSet<EndpointId>();\n             inspect.field(rotationsField).traverse((ArrayTraverser) (j, endpointId) -> endpointIds.add(EndpointId.of(endpointId.asString())));\n-            policies.add(new RoutingPolicy(new RoutingPolicyId(owner,\n-                                                               ClusterSpec.Id.from(inspect.field(clusterField).asString()),\n-                                                               ZoneId.from(inspect.field(zoneField).asString())),\n-                                           HostName.from(inspect.field(canonicalNameField).asString()),\n-                                           Serializers.optionalString(inspect.field(dnsZoneField)),\n-                                           endpointIds,\n-                                           inspect.field(loadBalancerActiveField).asBool()));\n+            var id = new RoutingPolicyId(owner,\n+                                         ClusterSpec.Id.from(inspect.field(clusterField).asString()),\n+                                         ZoneId.from(inspect.field(zoneField).asString()));\n+            policies.put(id, new RoutingPolicy(id,\n+                                               HostName.from(inspect.field(canonicalNameField).asString()),\n+                                               Serializers.optionalString(inspect.field(dnsZoneField)),\n+                                               endpointIds,\n+                                               inspect.field(loadBalancerActiveField).asBool()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5cb1626ae172aba997b9af67f5765d195b805c"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkxNjUwMA==", "bodyText": "This method returns nothing.", "url": "https://github.com/vespa-engine/vespa/pull/11859#discussion_r368916500", "createdAt": "2020-01-21T10:20:46Z", "author": {"login": "oyving"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/routing/RoutingPolicies.java", "diffHunk": "@@ -103,15 +104,11 @@ private void registerEndpointsInDns(AllocatedLoadBalancers loadBalancers, @Suppr\n \n     /** Store routing policies for given route. Returns the persisted policies. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5cb1626ae172aba997b9af67f5765d195b805c"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzOTU4Mw==", "bodyText": "isActive() instead?", "url": "https://github.com/vespa-engine/vespa/pull/11859#discussion_r368939583", "createdAt": "2020-01-21T11:08:20Z", "author": {"login": "oyving"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/routing/Status.java", "diffHunk": "@@ -0,0 +1,40 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.routing;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Represents the status of a routing policy.\n+ *\n+ * This is immutable.\n+ *\n+ * @author mpolden\n+ */\n+public class Status {\n+\n+    private final boolean loadBalancerActive;\n+\n+    /** DO NOT USE. Public for serialization purposes */\n+    public Status(boolean loadBalancerActive) {\n+        this.loadBalancerActive = loadBalancerActive;\n+    }\n+\n+    /** Returns whether the load balancer is active in node repository */\n+    public boolean loadBalancerActive() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94af145a942bd38b4e8029b8f508822b5cf8bd84"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0MDUzOA==", "bodyText": "Call this LoadBalancerStatus? Or were we thinking of putting other things in the Status class in the future?", "url": "https://github.com/vespa-engine/vespa/pull/11859#discussion_r368940538", "createdAt": "2020-01-21T11:10:25Z", "author": {"login": "oyving"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/routing/Status.java", "diffHunk": "@@ -0,0 +1,40 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.routing;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Represents the status of a routing policy.\n+ *\n+ * This is immutable.\n+ *\n+ * @author mpolden\n+ */\n+public class Status {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94af145a942bd38b4e8029b8f508822b5cf8bd84"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fcbf34f69c7dc00688fd2d1f2ba6f2e621f87c0", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/7fcbf34f69c7dc00688fd2d1f2ba6f2e621f87c0", "committedDate": "2020-01-21T13:32:10Z", "message": "Fix stale javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31a68b6e3f8ffc601bdb4573b6df148175eaf5af", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/31a68b6e3f8ffc601bdb4573b6df148175eaf5af", "committedDate": "2020-01-21T13:32:27Z", "message": "Rename loadBalancerActive -> isActive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5bbc53a26674ed11ebc342e2f7470a7eb5342e6", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/c5bbc53a26674ed11ebc342e2f7470a7eb5342e6", "committedDate": "2020-01-21T13:43:00Z", "message": "Test legacy format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1OTE4MDkz", "url": "https://github.com/vespa-engine/vespa/pull/11859#pullrequestreview-345918093", "createdAt": "2020-01-21T14:28:57Z", "commit": {"oid": "c5bbc53a26674ed11ebc342e2f7470a7eb5342e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3943, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}