{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNjMzNTU5", "number": 12711, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDo1NToyOVrODrQGjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwOToxODoyNVrODrjgOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Njc5MTgwOnYy", "diffSide": "RIGHT", "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDo1NToyOVrOF7fFZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMjozMToyMVrOF7w2Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxOTU4OQ==", "bodyText": "Personal opinion: calling this \"optimize_for\" or similar would be more descriptive than just \"optimization\" (also applies to C++ config)", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397919589", "createdAt": "2020-03-25T14:55:29Z", "author": {"login": "vekterli"}, "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimization enum {LATENCY, THROUGHPUT} default=LATENCY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxMDY0Nw==", "bodyText": "So be it, that was one of my options.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398210647", "createdAt": "2020-03-25T22:31:21Z", "author": {"login": "baldersheim"}, "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimization enum {LATENCY, THROUGHPUT} default=LATENCY", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxOTU4OQ=="}, "originalCommit": {"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Njg0NDY5OnYy", "diffSide": "RIGHT", "path": "jrt/src/com/yahoo/jrt/Connection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTowNjoyNlrOF7fndw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjowMzowM1rOF7iaSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyODMxMQ==", "bodyText": "Do we have any numbers that indicate disabling TCP_NODELAY is worth it? We unconditionally enabled nodelay for everything to get rid  of spurious latency spikes incurred by the in-kernel deferred packet sending.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397928311", "createdAt": "2020-03-25T15:06:26Z", "author": {"login": "vekterli"}, "path": "jrt/src/com/yahoo/jrt/Connection.java", "diffHunk": "@@ -89,21 +90,23 @@ private void setState(int state) {\n     }\n \n     public Connection(TransportThread parent, Supervisor owner,\n-                      SocketChannel channel) {\n+                      SocketChannel channel, boolean tcpNoDelay) {\n \n         this.parent = parent;\n         this.owner = owner;\n         this.socket = parent.transport().createServerCryptoSocket(channel);\n         this.spec = null;\n+        this.tcpNoDelay = tcpNoDelay;\n         server = true;\n         owner.sessionInit(this);\n     }\n \n-    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context) {\n+    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context, boolean tcpNoDelay) {\n         super(context);\n         this.parent = parent;\n         this.owner = owner;\n         this.spec = spec;\n+        this.tcpNoDelay = tcpNoDelay;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk3NDA4OA==", "bodyText": "I saw significantly lower system cpu when hardcoding it yesterday.\nHowever I did a lot of different tests then, and I am not putting more into it than it is a dimension that should be tested further. And for that to happen I need config control over it.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397974088", "createdAt": "2020-03-25T16:03:03Z", "author": {"login": "baldersheim"}, "path": "jrt/src/com/yahoo/jrt/Connection.java", "diffHunk": "@@ -89,21 +90,23 @@ private void setState(int state) {\n     }\n \n     public Connection(TransportThread parent, Supervisor owner,\n-                      SocketChannel channel) {\n+                      SocketChannel channel, boolean tcpNoDelay) {\n \n         this.parent = parent;\n         this.owner = owner;\n         this.socket = parent.transport().createServerCryptoSocket(channel);\n         this.spec = null;\n+        this.tcpNoDelay = tcpNoDelay;\n         server = true;\n         owner.sessionInit(this);\n     }\n \n-    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context) {\n+    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context, boolean tcpNoDelay) {\n         super(context);\n         this.parent = parent;\n         this.owner = owner;\n         this.spec = spec;\n+        this.tcpNoDelay = tcpNoDelay;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyODMxMQ=="}, "originalCommit": {"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Njk2NDY3OnYy", "diffSide": "RIGHT", "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTozMDo0NlrOF7gzmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTozMDo0NlrOF7gzmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzgwMw==", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397947803", "createdAt": "2020-03-25T15:30:46Z", "author": {"login": "havardpe"}, "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimization enum {LATENCY, THROUGHPUT} default=LATENCY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4f448633278360f7cb8ef2135f68291cb021a9f"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NzAyMzY0OnYy", "diffSide": "RIGHT", "path": "messagebus/src/main/java/com/yahoo/messagebus/network/rpc/RPCNetwork.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTo0Mjo0NFrOF7hZgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMDo1NTo1M1rOF7t-cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk1NzUwNQ==", "bodyText": "Consider wrapping in a shouldEnableNoDelay(params) method or similar to make semantics more obvious", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397957505", "createdAt": "2020-03-25T15:42:44Z", "author": {"login": "vekterli"}, "path": "messagebus/src/main/java/com/yahoo/messagebus/network/rpc/RPCNetwork.java", "diffHunk": "@@ -82,7 +82,7 @@ private static int getNumThreads() {\n     public RPCNetwork(RPCNetworkParams params, SlobrokConfigSubscriber slobrokConfig) {\n         this.slobroksConfig = slobrokConfig;\n         identity = params.getIdentity();\n-        orb = new Supervisor(new Transport(2));\n+        orb = new Supervisor(new Transport(params.getNumNetworkThreads(), params.getOptimization() == RPCNetworkParams.Optimization.LATENCY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "020c88692058131e4009125e00ff5ca2400a2f31"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE2MzU2OQ==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398163569", "createdAt": "2020-03-25T20:55:53Z", "author": {"login": "baldersheim"}, "path": "messagebus/src/main/java/com/yahoo/messagebus/network/rpc/RPCNetwork.java", "diffHunk": "@@ -82,7 +82,7 @@ private static int getNumThreads() {\n     public RPCNetwork(RPCNetworkParams params, SlobrokConfigSubscriber slobrokConfig) {\n         this.slobroksConfig = slobrokConfig;\n         identity = params.getIdentity();\n-        orb = new Supervisor(new Transport(2));\n+        orb = new Supervisor(new Transport(params.getNumNetworkThreads(), params.getOptimization() == RPCNetworkParams.Optimization.LATENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk1NzUwNQ=="}, "originalCommit": {"oid": "020c88692058131e4009125e00ff5ca2400a2f31"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2OTk1NjE3OnYy", "diffSide": "RIGHT", "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwOToxNTowMVrOF79iDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxODoyMFrOF7__8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQxODQ0NQ==", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398418445", "createdAt": "2020-03-26T09:15:01Z", "author": {"login": "havardpe"}, "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimize_for enum {LATENCY, THROUGHPUT} default=LATENCY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1ODg2Ng==", "bodyText": "I do not want to expose too much details. We should figure out a set that works for all.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398458866", "createdAt": "2020-03-26T10:18:20Z", "author": {"login": "baldersheim"}, "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimize_for enum {LATENCY, THROUGHPUT} default=LATENCY", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQxODQ0NQ=="}, "originalCommit": {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2OTk3MDUwOnYy", "diffSide": "RIGHT", "path": "storage/src/vespa/storage/config/stor-communicationmanager.def", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwOToxODoyNlrOF79qlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxODo1MlrOF8ABRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDYyOQ==", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398420629", "createdAt": "2020-03-26T09:18:26Z", "author": {"login": "havardpe"}, "path": "storage/src/vespa/storage/config/stor-communicationmanager.def", "diffHunk": "@@ -33,6 +33,8 @@ mbus.rpctargetcache.ttl double default = 600\n ## Any value below 1 will be 1.\n mbus.num_threads int default=4\n \n+mbus.optimize_for enum {LATENCY, THROUGHPUT} default = LATENCY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1OTIwNw==", "bodyText": "I do not want to expose too much details. We should figure out a set that works for all.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398459207", "createdAt": "2020-03-26T10:18:52Z", "author": {"login": "baldersheim"}, "path": "storage/src/vespa/storage/config/stor-communicationmanager.def", "diffHunk": "@@ -33,6 +33,8 @@ mbus.rpctargetcache.ttl double default = 600\n ## Any value below 1 will be 1.\n mbus.num_threads int default=4\n \n+mbus.optimize_for enum {LATENCY, THROUGHPUT} default = LATENCY", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDYyOQ=="}, "originalCommit": {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2224, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}