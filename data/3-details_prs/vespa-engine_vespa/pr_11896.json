{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1OTE0MDUx", "number": 11896, "title": "Add reservedTo field to Node", "bodyText": "", "createdAt": "2020-01-22T15:23:56Z", "url": "https://github.com/vespa-engine/vespa/pull/11896", "merged": true, "mergeCommit": {"oid": "b492c6d6b5f46bc484d249ef5aa3768d7dd91c71"}, "closed": true, "closedAt": "2020-01-23T09:55:24Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb83OtlAH2gAyMzY1OTE0MDUxOmFhOWNkOTk3NjMwZDMwNmY2NzEzODI0MGRiMGMyYWNlMWNmODFjODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9HLzMAFqTM0NzE2NzU4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aa9cd997630d306f67138240db0c2ace1cf81c84", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/aa9cd997630d306f67138240db0c2ace1cf81c84", "committedDate": "2020-01-22T15:11:14Z", "message": "Add reservedTo field to Node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b9f810ca24dc09c4a1677a525abd878eed896ab", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/0b9f810ca24dc09c4a1677a525abd878eed896ab", "committedDate": "2020-01-22T15:50:31Z", "message": "Surfacet reservedTo in nodes/v2 and test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "995e6883f191574ba3f386c49271950fc5e5a50a", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/995e6883f191574ba3f386c49271950fc5e5a50a", "committedDate": "2020-01-22T16:02:14Z", "message": "Don't allocate on hosts reserved to someone else"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97c2dd0fb54bd2aed689e5b8b432588cc4fb6401", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/97c2dd0fb54bd2aed689e5b8b432588cc4fb6401", "committedDate": "2020-01-22T16:35:42Z", "message": "Prefer using reserved hosts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85c9eb688804ebf00a3593c04086d4eb9354225d", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/85c9eb688804ebf00a3593c04086d4eb9354225d", "committedDate": "2020-01-22T22:47:44Z", "message": "Unreserve hosts with allocations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71d558135d4a3bc8e6c9b2d556ae7862acd44bb4", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/71d558135d4a3bc8e6c9b2d556ae7862acd44bb4", "committedDate": "2020-01-22T23:45:43Z", "message": "Test reservation of hosts to tenants"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7a253d824ebb8d096395de4e57f381cf4b92f47", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/a7a253d824ebb8d096395de4e57f381cf4b92f47", "committedDate": "2020-01-22T23:46:43Z", "message": "Cleanup test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/eaf1e0870d990092e9b5b1a1a157d8bac046c48b", "committedDate": "2020-01-23T07:23:11Z", "message": "Remove temporary short-circuit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MTA4MTQy", "url": "https://github.com/vespa-engine/vespa/pull/11896#pullrequestreview-347108142", "createdAt": "2020-01-23T07:53:22Z", "commit": {"oid": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwNzo1MzoyM1rOFg1PYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODowODoxN1rOFg1hug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3MTA0MQ==", "bodyText": "Unintended change?", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369971041", "createdAt": "2020-01-23T07:53:23Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/Node.java", "diffHunk": "@@ -41,61 +42,57 @@\n     private final NodeType type;\n     private final Reports reports;\n     private final Optional<String> modelName;\n+    private final Optional<TenantName> reservedTo;\n \n     /** Record of the last event of each type happening to this node */\n     private final History history;\n \n     /** The current allocation of this node, if any */\n     private final Optional<Allocation> allocation;\n+    private Node retire;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3MzUzMw==", "bodyText": "The convention is this class seems to be to have a withReservedTo(TenantName) and withoutReservedTo()", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369973533", "createdAt": "2020-01-23T08:00:54Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/Node.java", "diffHunk": "@@ -265,26 +273,32 @@ public Node allocate(ApplicationId owner, ClusterMembership membership, NodeReso\n      */\n     public Node with(Allocation allocation) {\n         return new Node(id, ipConfig, hostname, parentHostname, flavor, status, state,\n-                        Optional.of(allocation), history, type, reports, modelName);\n+                        Optional.of(allocation), history, type, reports, modelName, reservedTo);\n     }\n \n     /** Returns a new Node without an allocation. */\n     public Node withoutAllocation() {\n         return new Node(id, ipConfig, hostname, parentHostname, flavor, status, state,\n-                        Optional.empty(), history, type, reports, modelName);\n+                        Optional.empty(), history, type, reports, modelName, reservedTo);\n     }\n \n \n     /** Returns a copy of this node with IP config set to the given value. */\n     public Node with(IP.Config ipConfig) {\n         return new Node(id, ipConfig, hostname, parentHostname, flavor, status, state,\n-                        allocation, history, type, reports, modelName);\n+                        allocation, history, type, reports, modelName, reservedTo);\n     }\n \n     /** Returns a copy of this node with the parent hostname assigned to the given value. */\n     public Node withParentHostname(String parentHostname) {\n         return new Node(id, ipConfig, hostname, Optional.of(parentHostname), flavor, status, state,\n-                        allocation, history, type, reports, modelName);\n+                        allocation, history, type, reports, modelName, reservedTo);\n+    }\n+\n+    /** Returns a copy of this node marked as reserved to the given tenant (or empty to remove reservation) */\n+    public Node withReservedTo(Optional<TenantName> reservedTo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b"}, "originalPosition": 189}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NDkwNw==", "bodyText": "This should lock the tenant host application", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369974907", "createdAt": "2020-01-23T08:05:38Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/Activator.java", "diffHunk": "@@ -90,6 +89,27 @@ private void activateNodes(ApplicationId application, Collection<HostSpec> hosts\n         nodeRepository.deactivate(activeToRemove, transaction);\n         nodeRepository.activate(updateFrom(hosts, continuedActive), transaction); // update active with any changes\n         nodeRepository.activate(updatePortsFrom(hosts, reservedToActivate), transaction);\n+        unreserveParentsOf(reservedToActivate);\n+    }\n+\n+    /** When a tenant node is activated on a host, we can open up that host for use by others */\n+    private void unreserveParentsOf(List<Node> nodes) {\n+        List<String> reservedParents = nodes.stream()\n+                                            .filter(node -> node.parentHostname().isPresent())\n+                                            .map(node -> nodeRepository.getNode(node.parentHostname().get()))\n+                                            .filter(parent -> parent.isPresent())\n+                                            .filter(parent -> parent.get().reservedTo().isPresent())\n+                                            .map(parent -> parent.get().hostname())\n+                                            .collect(Collectors.toList());\n+        if (reservedParents.isEmpty()) return;\n+\n+        try (Mutex lock = nodeRepository.lockUnallocated()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NTczOA==", "bodyText": "Use appId in this class", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369975738", "createdAt": "2020-01-23T08:08:17Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodePrioritizer.java", "diffHunk": "@@ -122,12 +122,14 @@ void addSurplusNodes(List<Node> surplusNodes) {\n      *\n      * @param exclusively whether the ready docker nodes should only be added on hosts that\n      *                    already have nodes allocated to this tenant\n+     * @param application the application we are adding nodes for\n      */\n-    void addNewDockerNodes(boolean exclusively) {\n+    void addNewDockerNodes(boolean exclusively, ApplicationId application) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f981d6569d2d6a6ca311f82d1816e254489af477", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/f981d6569d2d6a6ca311f82d1816e254489af477", "committedDate": "2020-01-23T08:51:02Z", "message": "Remove spurious field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73bd08b8810794337a6c86f8cc32a031b6583242", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/73bd08b8810794337a6c86f8cc32a031b6583242", "committedDate": "2020-01-23T08:54:33Z", "message": "Only allow clearing reservedTo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "137173a4d6e4914497d10b68a89699b685d6b776", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/137173a4d6e4914497d10b68a89699b685d6b776", "committedDate": "2020-01-23T09:05:51Z", "message": "Use class field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdba1da4e60182595cd19fcf5945f98bce72d99e", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/cdba1da4e60182595cd19fcf5945f98bce72d99e", "committedDate": "2020-01-23T09:29:19Z", "message": "Lock node-admin app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1f353405fc65e0fa31142a6ccd9f9e8825a1163", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/d1f353405fc65e0fa31142a6ccd9f9e8825a1163", "committedDate": "2020-01-23T09:40:10Z", "message": "Follow internal API change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MTY3NTg3", "url": "https://github.com/vespa-engine/vespa/pull/11896#pullrequestreview-347167587", "createdAt": "2020-01-23T09:46:32Z", "commit": {"oid": "d1f353405fc65e0fa31142a6ccd9f9e8825a1163"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3970, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}