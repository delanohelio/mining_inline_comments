{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNDAwNTY3", "number": 12669, "title": "Use c++11 for loops and use std::move.", "bodyText": "@vekterli PR", "createdAt": "2020-03-23T13:54:41Z", "url": "https://github.com/vespa-engine/vespa/pull/12669", "merged": true, "mergeCommit": {"oid": "4310f5c7f2802b474966f2e9f9737df11aac4ca4"}, "closed": true, "closedAt": "2020-03-23T15:22:35Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQdpeQgH2gAyMzkyNDAwNTY3OjQyYTk4MWIyY2VkNzY4NzYyNTJjNDhlOTEwOWJiYzdkMzlhNzdiNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQfZXZAFqTM3OTQ2Njc1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42a981b2ced76876252c48e9109bbc7d39a77b50", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/42a981b2ced76876252c48e9109bbc7d39a77b50", "committedDate": "2020-03-23T12:41:25Z", "message": "Use c++11 for loops and use std::move."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDY2NzUw", "url": "https://github.com/vespa-engine/vespa/pull/12669#pullrequestreview-379466750", "createdAt": "2020-03-23T14:12:46Z", "commit": {"oid": "42a981b2ced76876252c48e9109bbc7d39a77b50"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDoxMjo0NlrOF6HO2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDoxMjo0NlrOF6HO2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MDIxOQ==", "bodyText": "For all these callsites, cmd is a const std::shared_ptr<T>&, so the move won't have any effect in practice.\nThis is due to how the legacy storage links/chains work, where the message is always passed to handlers (as a const ref to the shared_ptr) and the handler returns whether it handled the message after the fact. Since ownership is not known a-priori, moves cannot be done optimistically and using by-value would be too expensive.", "url": "https://github.com/vespa-engine/vespa/pull/12669#discussion_r396480219", "createdAt": "2020-03-23T14:12:46Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/distributor/externaloperationhandler.cpp", "diffHunk": "@@ -252,9 +253,10 @@ IMPL_MSG_COMMAND_H(ExternalOperationHandler, Put)\n \n     auto handle = _mutationSequencer.try_acquire(cmd->getDocumentId());\n     if (allowMutation(handle)) {\n+        document::BucketSpace bucketSpace = cmd->getBucket().getBucketSpace();\n         _op = std::make_shared<PutOperation>(*this,\n-                                             _bucketSpaceRepo.get(cmd->getBucket().getBucketSpace()),\n-                                             cmd, getMetrics().puts[cmd->getLoadType()], std::move(handle));\n+                                             _bucketSpaceRepo.get(bucketSpace),\n+                                             std::move(cmd), getMetrics().puts[loadType], std::move(handle));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42a981b2ced76876252c48e9109bbc7d39a77b50"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2604, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}