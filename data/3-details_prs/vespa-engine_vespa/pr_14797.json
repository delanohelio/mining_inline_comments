{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwMzgxNjY4", "number": 14797, "title": "pack FastSparseMap::Key tighter", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@havardpe somewhat experimental, please take a look", "createdAt": "2020-10-09T06:39:14Z", "url": "https://github.com/vespa-engine/vespa/pull/14797", "merged": true, "mergeCommit": {"oid": "e5eba689f998216fb6b090b844534f03b6ff9ca4"}, "closed": true, "closedAt": "2020-10-09T13:11:43Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQwUkaAH2gAyNTAwMzgxNjY4OmE3NWYwY2Y2N2I1YjBkZGVkZDM2YWIzNDU5NWMyNzExZjlhYjllYzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQ1891gFqTUwNTY1ODAwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7", "committedDate": "2020-10-09T06:37:56Z", "message": "pack FastSparseMap::Key tighter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDA1NjU4", "url": "https://github.com/vespa-engine/vespa/pull/14797#pullrequestreview-505405658", "createdAt": "2020-10-09T06:54:11Z", "commit": {"oid": "a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNjo1NDoxMVrOHe9UHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNjo1NDoxMVrOHe9UHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIyMzkwMw==", "bodyText": "an alternative is to not pass start and redefine the make_addr function instead to get an address from a subspace directly. That would trade a divide with a multiply for the iterate case and we would save the multiply for the time we actually need the address.", "url": "https://github.com/vespa-engine/vespa/pull/14797#discussion_r502223903", "createdAt": "2020-10-09T06:54:11Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/eval/fast_sparse_map.h", "diffHunk": "@@ -148,7 +147,7 @@ class FastSparseMap\n     void each_map_entry(F &&f) const {\n         _map.for_each([&](const auto &entry)\n                       {\n-                          f(entry.first.start, entry.second, entry.first.hash);\n+                          f(entry.second * _num_dims, entry.second, entry.first.hash);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDA2MTY4", "url": "https://github.com/vespa-engine/vespa/pull/14797#pullrequestreview-505406168", "createdAt": "2020-10-09T06:55:14Z", "commit": {"oid": "a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNjo1NToxNFrOHe9Vxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNjo1NToxNFrOHe9Vxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIyNDMyNw==", "bodyText": "if we pack, I think we should also use align 4", "url": "https://github.com/vespa-engine/vespa/pull/14797#discussion_r502224327", "createdAt": "2020-10-09T06:55:14Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/eval/fast_sparse_map.h", "diffHunk": "@@ -62,12 +62,11 @@ class FastSparseMap\n     }\n \n     struct Key {\n-        uint32_t start;\n         uint64_t hash;\n-        Key() : start(0), hash(0) {}\n-        Key(uint32_t start_in, uint64_t hash_in)\n-            : start(start_in), hash(hash_in) {}\n-    };\n+        Key() : hash(0) {}\n+        Key(uint64_t hash_in)\n+            : hash(hash_in) {}\n+    } __attribute__((packed));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80476c1d456ba294755725778fa03701d85e21c7", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/80476c1d456ba294755725778fa03701d85e21c7", "committedDate": "2020-10-09T08:00:39Z", "message": "change to subspace index for make_addr also\n\n* and add alignment attribute"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjQ1MTIy", "url": "https://github.com/vespa-engine/vespa/pull/14797#pullrequestreview-505645122", "createdAt": "2020-10-09T12:55:14Z", "commit": {"oid": "80476c1d456ba294755725778fa03701d85e21c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo1NToxNFrOHfIf3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo1NToxNFrOHfIf3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwNzEzMg==", "bodyText": "I am not sure if attributes are order sensitive, but we should switch them just to be safe.", "url": "https://github.com/vespa-engine/vespa/pull/14797#discussion_r502407132", "createdAt": "2020-10-09T12:55:14Z", "author": {"login": "havardpe"}, "path": "eval/src/vespa/eval/eval/fast_sparse_map.h", "diffHunk": "@@ -66,7 +66,7 @@ class FastSparseMap\n         Key() : hash(0) {}\n         Key(uint64_t hash_in)\n             : hash(hash_in) {}\n-    } __attribute__((packed));\n+    } __attribute__((aligned(4),packed));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80476c1d456ba294755725778fa03701d85e21c7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8219326fa9dfd2693617b049523c2b5d291492ac", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/8219326fa9dfd2693617b049523c2b5d291492ac", "committedDate": "2020-10-09T13:04:32Z", "message": "switch order of attributes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjU4MDA1", "url": "https://github.com/vespa-engine/vespa/pull/14797#pullrequestreview-505658005", "createdAt": "2020-10-09T13:11:35Z", "commit": {"oid": "8219326fa9dfd2693617b049523c2b5d291492ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2498, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}