{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4ODc4NjQ5", "number": 15019, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjowOToxNFrOExLZ1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjo1NzozOVrOExMdlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMDAyNTE5OnYy", "diffSide": "RIGHT", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/repair/RepairTicketReport.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjowOToxNVrOHnLFjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjowOToxNVrOHnLFjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDgzODE1Nw==", "bodyText": "Current naming convention on this seems is camel case.", "url": "https://github.com/vespa-engine/vespa/pull/15019#discussion_r510838157", "createdAt": "2020-10-23T12:09:15Z", "author": {"login": "freva"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/repair/RepairTicketReport.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.api.integration.repair;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import static com.yahoo.yolean.Exceptions.uncheck;\n+\n+/**\n+ * @author olaa\n+ */\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class RepairTicketReport {\n+\n+    private static final String REPORT_ID = \"repair-ticket\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "877e68322991c5133c5253410a4bb9c22c55e93b"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMDE4NDY2OnYy", "diffSide": "RIGHT", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/repair/RepairTicketReport.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjo1NDowN1rOHnMmBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjo1NDowN1rOHnMmBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg2Mjg1NQ==", "bodyText": "Doesn't the annotation apply to the next declaration? I.e. status in this case.", "url": "https://github.com/vespa-engine/vespa/pull/15019#discussion_r510862855", "createdAt": "2020-10-23T12:54:07Z", "author": {"login": "freva"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/repair/RepairTicketReport.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.api.integration.repair;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import static com.yahoo.yolean.Exceptions.uncheck;\n+\n+/**\n+ * @author olaa\n+ */\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class RepairTicketReport {\n+\n+    private static final String REPORT_ID = \"repair-ticket\";\n+    private static final ObjectMapper objectMapper = new ObjectMapper();@JsonIgnore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ceb3deefdafd77ce2dba976a5124faa8b7f75f1"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMDE5ODYzOnYy", "diffSide": "RIGHT", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostRepairMaintainer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjo1NzozOVrOHnMubw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMjo1NzozOVrOHnMubw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg2NTAwNw==", "bodyText": "Consider reversing this to avoid NPE", "url": "https://github.com/vespa-engine/vespa/pull/15019#discussion_r510865007", "createdAt": "2020-10-23T12:57:39Z", "author": {"login": "freva"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostRepairMaintainer.java", "diffHunk": "@@ -0,0 +1,81 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.maintenance;\n+\n+import com.yahoo.config.provision.CloudName;\n+import com.yahoo.config.provision.SystemName;\n+import com.yahoo.config.provision.zone.ZoneApi;\n+import com.yahoo.vespa.hosted.controller.Controller;\n+import com.yahoo.vespa.hosted.controller.api.integration.configserver.Node;\n+import com.yahoo.vespa.hosted.controller.api.integration.configserver.NodeRepository;\n+import com.yahoo.vespa.hosted.controller.api.integration.repair.RepairTicketReport;\n+import com.yahoo.vespa.hosted.controller.api.integration.repair.HostRepairClient;\n+import com.yahoo.yolean.Exceptions;\n+\n+import java.time.Duration;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.function.Predicate;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import static com.yahoo.yolean.Exceptions.uncheck;\n+\n+/**\n+ *\n+ * Responsible for keeping track of hosts under repair.\n+ *\n+ * @author olaa\n+ */\n+public class HostRepairMaintainer extends ControllerMaintainer {\n+\n+    private final NodeRepository nodeRepository;\n+    private final HostRepairClient repairClient;\n+\n+    private static final Logger log = Logger.getLogger(HostRepairMaintainer.class.getName());\n+\n+\n+    public HostRepairMaintainer(Controller controller, Duration interval) {\n+        super(controller, interval, null, SystemName.allOf(Predicate.not(SystemName::isPublic)));\n+        this.nodeRepository = controller.serviceRegistry().configServer().nodeRepository();\n+        this.repairClient = controller.serviceRegistry().hostRepairClient();\n+    }\n+\n+\n+    @Override\n+    protected boolean maintain() {\n+        AtomicInteger exceptions = new AtomicInteger(0);\n+\n+        controller().zoneRegistry().zones()\n+                .reachable().zones().stream()\n+                .forEach(zoneApi -> {\n+                            var nodeTicketMap = nodeRepository.list((zoneApi).getId())\n+                                    .stream()\n+                                    .filter(this::hasOpenTicket)\n+                                    .collect(Collectors.toMap(\n+                                            node -> node,\n+                                            this::getTicketReport)\n+                                    );\n+                            try {\n+                                repairClient.updateRepairStatus(zoneApi, nodeTicketMap);\n+                            } catch (Exception e) {\n+                                log.warning(\"Failed to update repair status; \" + Exceptions.toMessageString(e));\n+                                exceptions.incrementAndGet();\n+                            }\n+                        }\n+                );\n+\n+        return exceptions.get() == 0;\n+    }\n+\n+\n+    private boolean hasOpenTicket(Node node) {\n+        var reports = node.reports();\n+        if (!reports.containsKey(RepairTicketReport.getReportId())) {\n+            return false;\n+        }\n+        return getTicketReport(node).getStatus().equals(\"OPEN\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ceb3deefdafd77ce2dba976a5124faa8b7f75f1"}, "originalPosition": 75}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1126, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}