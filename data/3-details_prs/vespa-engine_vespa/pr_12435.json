{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNTMwODky", "number": 12435, "title": "Bratseth/handle remote disk", "bodyText": "", "createdAt": "2020-03-04T12:43:10Z", "url": "https://github.com/vespa-engine/vespa/pull/12435", "merged": true, "mergeCommit": {"oid": "763b3715b3578121a4ef22b66af41adc91336194"}, "closed": true, "closedAt": "2020-03-05T22:07:25Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKWQM8AH2gAyMzgzNTMwODkyOjVmZDlkNjI5YWNhOWFiMDhiZjNhODdlNzA5YzY2NDg4ODk5MjllMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKswqZAFqTM2OTYzNTEzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5fd9d629aca9ab08bf3a87e709c6648889929e14", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/5fd9d629aca9ab08bf3a87e709c6648889929e14", "committedDate": "2020-03-04T12:40:56Z", "message": "Handle remote disk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "597475d9380c3438ddeeec6bcae4d648729fc385", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/597475d9380c3438ddeeec6bcae4d648729fc385", "committedDate": "2020-03-04T12:42:26Z", "message": "Remove println"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzU4MTI1", "url": "https://github.com/vespa-engine/vespa/pull/12435#pullrequestreview-368758125", "createdAt": "2020-03-04T13:03:27Z", "commit": {"oid": "597475d9380c3438ddeeec6bcae4d648729fc385"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzowMzoyN1rOFxsZGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzowMzoyN1rOFxsZGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1MTg2Nw==", "bodyText": "flavor.resources() returns the real resources, need to run this through hostResourcesCalculator so the bestFlavor ends up as an advertised flavor.", "url": "https://github.com/vespa-engine/vespa/pull/12435#discussion_r387651867", "createdAt": "2020-03-04T13:03:27Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/autoscale/Autoscaler.java", "diffHunk": "@@ -142,6 +143,8 @@ private boolean similar(double r1, double r2, double threshold) {\n             Optional<Flavor> bestFlavor = Optional.empty();\n             for (Flavor flavor : nodeRepository.getAvailableFlavors().getFlavors()) {\n                 if ( ! flavor.resources().satisfies(resources.nodeResources())) continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "597475d9380c3438ddeeec6bcae4d648729fc385"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e4e9560853d49f9d0a061a7ca8a13ee8f357142", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/0e4e9560853d49f9d0a061a7ca8a13ee8f357142", "committedDate": "2020-03-04T14:25:20Z", "message": "Use advertised resources when making allocations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34548b00db9cb5865da3180afc080861ada47e2e", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/34548b00db9cb5865da3180afc080861ada47e2e", "committedDate": "2020-03-04T14:31:19Z", "message": "Simplify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78452759e689f309ec2a60b5e31a9ad7772ba7e3", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/78452759e689f309ec2a60b5e31a9ad7772ba7e3", "committedDate": "2020-03-04T14:33:40Z", "message": "Simplify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dfe87a9eb033847737dd32c1937eba42cdf25f8", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/6dfe87a9eb033847737dd32c1937eba42cdf25f8", "committedDate": "2020-03-04T14:36:53Z", "message": "Simplify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4ODQwMzAw", "url": "https://github.com/vespa-engine/vespa/pull/12435#pullrequestreview-368840300", "createdAt": "2020-03-04T14:49:31Z", "commit": {"oid": "78452759e689f309ec2a60b5e31a9ad7772ba7e3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDo0OTozMVrOFxwOjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDo0OTozMVrOFxwOjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxNDcwMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (best.isEmpty() || best.get().cost() > costOf(flavor.resources()))\n          \n          \n            \n                            if (best.isEmpty() || best.get().cost() > candidate.cost())\n          \n      \n    \n    \n  \n\nPreviously this would compare cost of advertised resources for the best match against cost of real resources for the candidate.", "url": "https://github.com/vespa-engine/vespa/pull/12435#discussion_r387714701", "createdAt": "2020-03-04T14:49:31Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/autoscale/Autoscaler.java", "diffHunk": "@@ -126,32 +126,31 @@ private boolean similar(double r1, double r2, double threshold) {\n      * Returns the smallest allocatable node resources larger than the given node resources,\n      * or empty if none available.\n      */\n-    private Optional<ClusterResourcesWithCost> toAllocatableResources(ClusterResources resources, ClusterSpec cluster) {\n+    private Optional<AllocatableClusterResources> toAllocatableResources(ClusterResources resources, ClusterSpec cluster) {\n         if (allowsHostSharing(nodeRepository.zone().cloud())) {\n             // Return the requested resources, adjusted to be legal or empty if they cannot fit on existing hosts\n             NodeResources nodeResources = nodeResourceLimits.enlargeToLegal(resources.nodeResources(), cluster.type());\n             for (Flavor flavor : nodeRepository.getAvailableFlavors().getFlavors())\n                 if (flavor.resources().satisfies(nodeResources))\n-                    return Optional.of(new ClusterResourcesWithCost(resources.with(nodeResources),\n-                                                                    costOf(nodeResources) * resources.nodes()));\n+                    return Optional.of(new AllocatableClusterResources(resources.with(nodeResources),\n+                                                                       nodeResources));\n             return Optional.empty();\n         }\n         else {\n             // return the cheapest flavor satisfying the target resources, if any\n-            double bestCost = Double.MAX_VALUE;\n-            Optional<Flavor> bestFlavor = Optional.empty();\n+            Optional<AllocatableClusterResources> best = Optional.empty();\n             for (Flavor flavor : nodeRepository.getAvailableFlavors().getFlavors()) {\n                 if ( ! flavor.resources().satisfies(resources.nodeResources())) continue;\n-                if (bestFlavor.isEmpty() || bestCost > costOf(flavor.resources())) {\n-                    bestFlavor = Optional.of(flavor);\n-                    bestCost = costOf(flavor);\n-                }\n+\n+                if (flavor.resources().storageType() == NodeResources.StorageType.remote)\n+                    flavor = flavor.with(FlavorOverrides.ofDisk(resources.nodeResources().diskGb()));\n+                var candidate = new AllocatableClusterResources(resources.with(flavor.resources()),\n+                                                                hostResourcesCalculator.availableCapacityOf(flavor.name(), flavor.resources()));\n+\n+                if (best.isEmpty() || best.get().cost() > costOf(flavor.resources()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78452759e689f309ec2a60b5e31a9ad7772ba7e3"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "448f417da4df3e674c40915cb3d5418bf110d92c", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/448f417da4df3e674c40915cb3d5418bf110d92c", "committedDate": "2020-03-05T12:57:48Z", "message": "Always track both real and advertised resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5e3c6f4b5db28bc10105188fe7c248b16e91586", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/a5e3c6f4b5db28bc10105188fe7c248b16e91586", "committedDate": "2020-03-05T12:59:28Z", "message": "Simplify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63ea662df71bbf7fa1f801fb3673b1b013e18843", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/63ea662df71bbf7fa1f801fb3673b1b013e18843", "committedDate": "2020-03-05T13:11:17Z", "message": "Use real resources when computing current usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "931cb1265c38dabfdd8104385f57a2350b63fda0", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/931cb1265c38dabfdd8104385f57a2350b63fda0", "committedDate": "2020-03-05T13:25:57Z", "message": "Don't wrap ClusterResources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52bed4d015905c1e08f5f8b2c189ff640a1c1cf8", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/52bed4d015905c1e08f5f8b2c189ff640a1c1cf8", "committedDate": "2020-03-05T13:33:20Z", "message": "Always adjust to legal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NjM1MTM4", "url": "https://github.com/vespa-engine/vespa/pull/12435#pullrequestreview-369635138", "createdAt": "2020-03-05T14:54:18Z", "commit": {"oid": "52bed4d015905c1e08f5f8b2c189ff640a1c1cf8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2746, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}