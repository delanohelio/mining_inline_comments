{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1NDU5ODI3", "number": 14937, "title": "Balder/factor out split join rebased", "bodyText": "@vekterli or @geirst PR\nThis is a rebase of #14929", "createdAt": "2020-10-18T11:54:00Z", "url": "https://github.com/vespa-engine/vespa/pull/14937", "merged": true, "mergeCommit": {"oid": "779aeaf46753f97c8cc7221774a1c7c91a797c80"}, "closed": true, "closedAt": "2020-10-19T11:47:45Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTt1J5gH2gAyNTA1NDU5ODI3OmYzNGFjZmY4ZjJmNDA5MzhkOTdiNWIyMGVkOTYwMTAxZDY2MjJlZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUCrx6gH2gAyNTA1NDU5ODI3OjRkYWYzODc3OGI0ZDljYTIyNDFiZDgxM2Q2YWQzZjUzNWQyNjM0YzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f34acff8f2f40938d97b5b20ed960101d6622eff", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/f34acff8f2f40938d97b5b20ed960101d6622eff", "committedDate": "2020-10-18T11:25:35Z", "message": "Factor out handling of operations that might change bucket ownership."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "554e8e480b6a614c7b730390472b83daf11911b9", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/554e8e480b6a614c7b730390472b83daf11911b9", "committedDate": "2020-10-18T11:25:35Z", "message": "Reduce usage of Component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7f45c9843e197c5881ef67fa83e1d23c78daa17", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/a7f45c9843e197c5881ef67fa83e1d23c78daa17", "committedDate": "2020-10-18T11:50:06Z", "message": "We must detect changes in document config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b17c5c96e18ae04a1b39b4d0ec3dc89832038c05", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/b17c5c96e18ae04a1b39b4d0ec3dc89832038c05", "committedDate": "2020-10-18T12:54:07Z", "message": "Do not retrieve config once for every thread."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e099df397486313831f09befa1d081b178384632", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/e099df397486313831f09befa1d081b178384632", "committedDate": "2020-10-18T14:54:28Z", "message": "Move join handling together with split handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/e6a8e2c087d25335784c05a8d01e1c1b665d3b3d", "committedDate": "2020-10-18T15:50:16Z", "message": "Factor out handling of the remaining messages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNjM3NDQ3", "url": "https://github.com/vespa-engine/vespa/pull/14937#pullrequestreview-511637447", "createdAt": "2020-10-19T10:50:38Z", "commit": {"oid": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMDo1MDozOVrOHkInXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTowNToxMlrOHkJGRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1MTkzMg==", "bodyText": "It's a bit philosophically questionable to have this const when it mutates state transitively, but I digress \ud83d\ude09", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507651932", "createdAt": "2020-10-19T10:50:39Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/persistence/persistenceutil.cpp", "diffHunk": "@@ -157,26 +155,23 @@ MessageTracker::generateReply(api::StorageCommand& cmd)\n }\n \n PersistenceUtil::PersistenceUtil(\n-        const config::ConfigUri & configUri,\n         ServiceLayerComponent& component,\n         FileStorHandler& fileStorHandler,\n         FileStorThreadMetrics& metrics,\n         spi::PersistenceProvider& provider)\n-    : _config(*config::ConfigGetter<vespa::config::content::StorFilestorConfig>::getConfig(configUri.getConfigId(), configUri.getContext())),\n-      _component(component),\n+    : _component(component),\n       _fileStorHandler(fileStorHandler),\n       _nodeIndex(component.getIndex()),\n       _metrics(metrics),\n       _bucketFactory(component.getBucketIdFactory()),\n-      _repo(component.getTypeRepo()->documentTypeRepo),\n       _spi(provider)\n {\n }\n \n PersistenceUtil::~PersistenceUtil() = default;\n \n void\n-PersistenceUtil::updateBucketDatabase(const document::Bucket &bucket, const api::BucketInfo& i)\n+PersistenceUtil::updateBucketDatabase(const document::Bucket &bucket, const api::BucketInfo& i) const", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1NDA2NQ==", "bodyText": "A class comment would be nice, especially for what \"simple\" means in this context", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507654065", "createdAt": "2020-10-19T10:54:30Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/persistence/simplemessagehandler.h", "diffHunk": "@@ -0,0 +1,33 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"types.h\"\n+#include \"messages.h\"\n+#include <vespa/storage/common/bucketmessages.h>\n+#include <vespa/storageapi/message/persistence.h>\n+\n+namespace storage {\n+\n+namespace spi { struct PersistenceProvider; }\n+struct PersistenceUtil;\n+\n+class SimpleMessageHandler : public Types {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1OTg0NA==", "bodyText": "Nit: missing space before context", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507659844", "createdAt": "2020-10-19T11:05:12Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/persistence/testandsethelper.cpp", "diffHunk": "@@ -35,7 +35,7 @@ void TestAndSetHelper::parseDocumentSelection(const document::DocumentTypeRepo &\n }\n \n spi::GetResult TestAndSetHelper::retrieveDocument(const document::FieldSet & fieldSet, spi::Context & context) {\n-    return _spi.get(_env.getBucket(_docId, _cmd.getBucket()), fieldSet,_cmd.getDocumentId(),context);\n+    return _spi.get(_env.getBucket(_docId, _cmd.getBucket()), fieldSet, _cmd.getDocumentId(),context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNjUzOTg4", "url": "https://github.com/vespa-engine/vespa/pull/14937#pullrequestreview-511653988", "createdAt": "2020-10-19T11:15:10Z", "commit": {"oid": "f34acff8f2f40938d97b5b20ed960101d6622eff"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMToxNToxMFrOHkJa7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTozNDoyOFrOHkKCTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY2NTEzMw==", "bodyText": "Nitpick: Missing '.' at the end. On the next sentence as well.", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507665133", "createdAt": "2020-10-19T11:15:10Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/persistence/asynchandler.h", "diffHunk": "@@ -13,8 +13,11 @@ namespace spi {\n }\n struct PersistenceUtil;\n \n+/**\n+ * Handle async operations that uses a sequenced executor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f34acff8f2f40938d97b5b20ed960101d6622eff"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY2NjgwMg==", "bodyText": "There is something wrong with this sentence.\nNitpick: Missing '.' at the end. On the next sentence as well.", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507666802", "createdAt": "2020-10-19T11:18:26Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/persistence/splitjoinhandler.h", "diffHunk": "@@ -0,0 +1,32 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"types.h\"\n+#include <vespa/storageapi/message/bucketsplitting.h>\n+\n+namespace storage {\n+\n+namespace spi { struct PersistenceProvider; }\n+struct PersistenceUtil;\n+class BucketOwnershipNotifier;\n+class RecheckBucketInfoCommand;\n+\n+/**\n+ * Handle operations that uses changes bucket ownership operations", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f34acff8f2f40938d97b5b20ed960101d6622eff"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3MTY3Mg==", "bodyText": "Consider using const auto.", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507671672", "createdAt": "2020-10-19T11:27:46Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/persistence/mergehandler.cpp", "diffHunk": "@@ -426,6 +426,7 @@ MergeHandler::fetchLocalData(\n     }\n \n     document::BucketIdFactory idFactory;\n+    const std::shared_ptr<const document::DocumentTypeRepo> repo = _env._component.getTypeRepo()->documentTypeRepo;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f45c9843e197c5881ef67fa83e1d23c78daa17"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3MzI3NQ==", "bodyText": "Consider using const auto.", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507673275", "createdAt": "2020-10-19T11:30:41Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/persistence/testandsethelper.cpp", "diffHunk": "@@ -47,8 +47,9 @@ TestAndSetHelper::TestAndSetHelper(const PersistenceUtil & env, const spi::Persi\n       _docTypePtr(_cmd.getDocumentType()),\n       _missingDocumentImpliesMatch(missingDocumentImpliesMatch)\n {\n-    resolveDocumentType(*env._repo);\n-    parseDocumentSelection(*env._repo);\n+    const std::shared_ptr<const document::DocumentTypeRepo> _repo = _env._component.getTypeRepo()->documentTypeRepo;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f45c9843e197c5881ef67fa83e1d23c78daa17"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NTIxMw==", "bodyText": "Consider updating log target.", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507675213", "createdAt": "2020-10-19T11:34:28Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/persistence/simplemessagehandler.cpp", "diffHunk": "@@ -0,0 +1,241 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"simplemessagehandler.h\"\n+#include \"persistenceutil.h\"\n+#include <vespa/persistence/spi/persistenceprovider.h>\n+#include <vespa/storage/common/bucketoperationlogger.h>\n+#include <vespa/document/base/exceptions.h>\n+#include <vespa/document/fieldset/fieldsetrepo.h>\n+\n+#include <vespa/log/log.h>\n+LOG_SETUP(\".persistence.processall\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4daf38778b4d9ca2241bd813d6ad3f535d2634c6", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/4daf38778b4d9ca2241bd813d6ad3f535d2634c6", "committedDate": "2020-10-19T11:43:21Z", "message": "Follow up PR comments\n- Improve comments, and some minor syntax.\n- const auto"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2269, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}