{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNDAwNTY3", "number": 12669, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDoxMjo0NlrODqZRsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDoxMjo0NlrODqZRsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NzgwOTE0OnYy", "diffSide": "RIGHT", "path": "storage/src/vespa/storage/distributor/externaloperationhandler.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDoxMjo0NlrOF6HO2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToyMjoxNVrOF6KcUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MDIxOQ==", "bodyText": "For all these callsites, cmd is a const std::shared_ptr<T>&, so the move won't have any effect in practice.\nThis is due to how the legacy storage links/chains work, where the message is always passed to handlers (as a const ref to the shared_ptr) and the handler returns whether it handled the message after the fact. Since ownership is not known a-priori, moves cannot be done optimistically and using by-value would be too expensive.", "url": "https://github.com/vespa-engine/vespa/pull/12669#discussion_r396480219", "createdAt": "2020-03-23T14:12:46Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/distributor/externaloperationhandler.cpp", "diffHunk": "@@ -252,9 +253,10 @@ IMPL_MSG_COMMAND_H(ExternalOperationHandler, Put)\n \n     auto handle = _mutationSequencer.try_acquire(cmd->getDocumentId());\n     if (allowMutation(handle)) {\n+        document::BucketSpace bucketSpace = cmd->getBucket().getBucketSpace();\n         _op = std::make_shared<PutOperation>(*this,\n-                                             _bucketSpaceRepo.get(cmd->getBucket().getBucketSpace()),\n-                                             cmd, getMetrics().puts[cmd->getLoadType()], std::move(handle));\n+                                             _bucketSpaceRepo.get(bucketSpace),\n+                                             std::move(cmd), getMetrics().puts[loadType], std::move(handle));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42a981b2ced76876252c48e9109bbc7d39a77b50"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUzMjgxOA==", "bodyText": "Yes, I figured that out. I just wanted to pull it as far out as possible, so when code is rewritten it will work optimal :)\nAt least one move into the PendingTrackerImpl takes effect.", "url": "https://github.com/vespa-engine/vespa/pull/12669#discussion_r396532818", "createdAt": "2020-03-23T15:22:15Z", "author": {"login": "baldersheim"}, "path": "storage/src/vespa/storage/distributor/externaloperationhandler.cpp", "diffHunk": "@@ -252,9 +253,10 @@ IMPL_MSG_COMMAND_H(ExternalOperationHandler, Put)\n \n     auto handle = _mutationSequencer.try_acquire(cmd->getDocumentId());\n     if (allowMutation(handle)) {\n+        document::BucketSpace bucketSpace = cmd->getBucket().getBucketSpace();\n         _op = std::make_shared<PutOperation>(*this,\n-                                             _bucketSpaceRepo.get(cmd->getBucket().getBucketSpace()),\n-                                             cmd, getMetrics().puts[cmd->getLoadType()], std::move(handle));\n+                                             _bucketSpaceRepo.get(bucketSpace),\n+                                             std::move(cmd), getMetrics().puts[loadType], std::move(handle));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MDIxOQ=="}, "originalCommit": {"oid": "42a981b2ced76876252c48e9109bbc7d39a77b50"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2205, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}