{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMzQyODk1", "number": 14470, "title": "Bjorncs/improve feed handler throttling", "bodyText": "FYI @jonmv", "createdAt": "2020-09-21T14:33:20Z", "url": "https://github.com/vespa-engine/vespa/pull/14470", "merged": true, "mergeCommit": {"oid": "2e03b54687b9f48db2d067d8ad59cb239a5500f6"}, "closed": true, "closedAt": "2020-09-21T15:24:47Z", "author": {"login": "bjorncs"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLC6M3gH2gAyNDkwMzQyODk1OjkyOTQzZDhiNDdhOTA3YzRhNWMzMDU4ZWU4ZTZjYTUyYjJjN2FjMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLFD5XgH2gAyNDkwMzQyODk1OmU2NzhkYTdkNjIyMGZjNTIyZWRmYjRhZmM4ZGRkMzE5MDNmOTE4YWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "92943d8b47a907c4a5c3058ee8e6ca52b2c7ac0e", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/92943d8b47a907c4a5c3058ee8e6ca52b2c7ac0e", "committedDate": "2020-09-21T12:53:47Z", "message": "Allow error response for worker pool overload to be customized by handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdc38d6215af8e4d08fffdd31743bd88d0ecdca3", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/bdc38d6215af8e4d08fffdd31743bd88d0ecdca3", "committedDate": "2020-09-21T13:17:12Z", "message": "Rename class to make surefire/junit run it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8df7e4f1fbbba3fcc065948f829b50dcc0f09217", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/8df7e4f1fbbba3fcc065948f829b50dcc0f09217", "committedDate": "2020-09-21T13:54:24Z", "message": "Add workaround for bad IntelliJ import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21b36d7313ff9f02c93f85964ba682e8bc5dd148", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/21b36d7313ff9f02c93f85964ba682e8bc5dd148", "committedDate": "2020-09-21T14:11:30Z", "message": "Make ContainerThreadPool an interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "febdf45cbdf6de694d267794d7e689b1dd445947", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/febdf45cbdf6de694d267794d7e689b1dd445947", "committedDate": "2020-09-21T14:23:17Z", "message": "Throttle using overload handling from ThreadedRequestHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03272df5273b887aef14b49a4b2e12165b5b388f", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/03272df5273b887aef14b49a4b2e12165b5b388f", "committedDate": "2020-09-21T14:25:46Z", "message": "fixup! Allow error response for worker pool overload to be customized by handler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNzEyMTg4", "url": "https://github.com/vespa-engine/vespa/pull/14470#pullrequestreview-492712188", "createdAt": "2020-09-21T15:05:15Z", "commit": {"oid": "03272df5273b887aef14b49a4b2e12165b5b388f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNTowNToxNVrOHVU8qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNTowNToxNVrOHVU8qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEyNTM1NA==", "bodyText": "Missing EOL", "url": "https://github.com/vespa-engine/vespa/pull/14470#discussion_r492125354", "createdAt": "2020-09-21T15:05:15Z", "author": {"login": "baldersheim"}, "path": "vespaclient-container-plugin/src/test/java/com/yahoo/vespa/http/server/FeedHandlerTest.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.yahoo.vespa.http.server;// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+import com.yahoo.container.handler.threadpool.ContainerThreadPool;\n+import com.yahoo.container.jdisc.RequestHandlerTestDriver;\n+import com.yahoo.container.logging.AccessLog;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.jdisc.handler.OverloadException;\n+import com.yahoo.metrics.simple.MetricReceiver;\n+import org.junit.Test;\n+\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.RejectedExecutionException;\n+\n+import static com.yahoo.vespa.http.server.FeedHandlerV3Test.createRequest;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * @author bjorncs\n+ */\n+public class FeedHandlerTest {\n+\n+    @Test\n+    public void response_has_status_code_429_when_throttling() {\n+        FeedHandler handler = new FeedHandler(\n+                new RejectingContainerThreadpool(),\n+                new CollectingMetric(),\n+                AccessLog.voidAccessLog(),\n+                new DocumentmanagerConfig(new DocumentmanagerConfig.Builder().enablecompression(true)),\n+                null /* session cache */,\n+                MetricReceiver.nullImplementation);\n+        var responseHandler = new RequestHandlerTestDriver.MockResponseHandler();\n+        try {\n+            handler.handleRequest(createRequest(100).getJDiscRequest(), responseHandler);\n+            fail();\n+        } catch (OverloadException e) {}\n+        assertEquals(429, responseHandler.getStatus());\n+    }\n+\n+    private static class RejectingContainerThreadpool implements ContainerThreadPool {\n+        private final Executor executor = ignored -> { throw new RejectedExecutionException(); };\n+\n+        @Override public Executor executor() { return executor;  }\n+    }\n+\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03272df5273b887aef14b49a4b2e12165b5b388f"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNzE0MTAy", "url": "https://github.com/vespa-engine/vespa/pull/14470#pullrequestreview-492714102", "createdAt": "2020-09-21T15:07:14Z", "commit": {"oid": "03272df5273b887aef14b49a4b2e12165b5b388f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e678da7d6220fc522edfb4afc8ddd31903f918af", "author": {"user": {"login": "bjorncs", "name": "Bj\u00f8rn Christian Seime"}}, "url": "https://github.com/vespa-engine/vespa/commit/e678da7d6220fc522edfb4afc8ddd31903f918af", "committedDate": "2020-09-21T15:24:11Z", "message": "Add missing trailing newline"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4277, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}