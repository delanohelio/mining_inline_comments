{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NzExMjQ3", "number": 14615, "title": "Try prepare allocation without locking MERGEOK", "bodyText": "", "createdAt": "2020-09-29T10:01:10Z", "url": "https://github.com/vespa-engine/vespa/pull/14615", "merged": true, "mergeCommit": {"oid": "e6fe148c64d16d57d61ec9bd7239e65081e5fdeb"}, "closed": true, "closedAt": "2020-09-29T12:30:54Z", "author": {"login": "freva"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNlOQzgH2gAyNDk0NzExMjQ3OjkwYzhiNWM5NjlmMTZiYTdjYTBiYzY0ZjcxOGEzYWQ4YmRmNTI3ZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNnVSaAFqTQ5ODQxMzA3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "90c8b5c969f16ba7ca0bc64f718a3ad8bdf527ff", "author": {"user": {"login": "freva", "name": "Valerij Fredriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/90c8b5c969f16ba7ca0bc64f718a3ad8bdf527ff", "committedDate": "2020-09-29T10:00:19Z", "message": "Try prepare allocation without locking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MzQ4NzUz", "url": "https://github.com/vespa-engine/vespa/pull/14615#pullrequestreview-498348753", "createdAt": "2020-09-29T10:57:31Z", "commit": {"oid": "90c8b5c969f16ba7ca0bc64f718a3ad8bdf527ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MzU2ODIw", "url": "https://github.com/vespa-engine/vespa/pull/14615#pullrequestreview-498356820", "createdAt": "2020-09-29T11:08:55Z", "commit": {"oid": "90c8b5c969f16ba7ca0bc64f718a3ad8bdf527ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NDA1Nzgz", "url": "https://github.com/vespa-engine/vespa/pull/14615#pullrequestreview-498405783", "createdAt": "2020-09-29T12:18:38Z", "commit": {"oid": "90c8b5c969f16ba7ca0bc64f718a3ad8bdf527ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjoxODozOFrOHZqTAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjoxODozOFrOHZqTAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY2OTQ0MA==", "bodyText": "Why are nodes removed from surplusActiveNodes - I don't see any nodes are removed in the current/previous code?", "url": "https://github.com/vespa-engine/vespa/pull/14615#discussion_r496669440", "createdAt": "2020-09-29T12:18:38Z", "author": {"login": "hakonhall"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/GroupPreparer.java", "diffHunk": "@@ -59,28 +61,26 @@ public GroupPreparer(NodeRepository nodeRepository,\n                               List<Node> surplusActiveNodes, MutableInteger highestIndex, int wantedGroups) {\n         boolean dynamicProvisioningEnabled = nodeRepository.canProvisionHosts() && nodeRepository.zone().getCloud().dynamicProvisioning();\n         boolean allocateFully = dynamicProvisioningEnabled && preprovisionCapacityFlag.value().isEmpty();\n-        try (Mutex lock = nodeRepository.lock(application)) {\n \n-            // Lock ready pool to ensure that the same nodes are not simultaneously allocated by others\n-            try (Mutex allocationLock = nodeRepository.lockUnallocated()) {\n+        // Try preparing in memory without lock. Most of the time there should be no changes and we can return nodes\n+        // previously allocated.\n+        {\n+            MutableInteger probePrepareHighestIndex = new MutableInteger(highestIndex.get());\n+            NodeAllocation probeAllocation = prepareAllocation(application, cluster, requestedNodes, surplusActiveNodes,\n+                    probePrepareHighestIndex, wantedGroups, allocateFully, PROBE_LOCK);\n+            if (probeAllocation.fulfilledAndNoChanges()) {\n+                List<Node> acceptedNodes = probeAllocation.finalNodes();\n+                surplusActiveNodes.removeAll(acceptedNodes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90c8b5c969f16ba7ca0bc64f718a3ad8bdf527ff"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NDEzMDc0", "url": "https://github.com/vespa-engine/vespa/pull/14615#pullrequestreview-498413074", "createdAt": "2020-09-29T12:27:48Z", "commit": {"oid": "90c8b5c969f16ba7ca0bc64f718a3ad8bdf527ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4119, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}