{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwODAwODUx", "number": 15050, "title": "Support provisioning of shared hosts", "bodyText": "Adds shared-host flag to enable and define resources of shared hosts.  This PR\nis a no-op until that flag is set, but there remains some integration with\nexclusiveTo (tbd in this PR or follow-up).", "createdAt": "2020-10-27T14:33:27Z", "url": "https://github.com/vespa-engine/vespa/pull/15050", "merged": true, "mergeCommit": {"oid": "352801f85a390ae635da9ff6995052b565ddd33f"}, "closed": true, "closedAt": "2020-10-28T10:54:21Z", "author": {"login": "hakonhall"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWp4U4AH2gAyNTEwODAwODUxOjYyNDc2MjdmY2IxYjhmMmFhN2QyNzdkNzM5ZjExNzAzYjQ4OGE1MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW66hVgFqTUxODUxMjc2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6247627fcb1b8f2aa7d277d739f11703b488a503", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/6247627fcb1b8f2aa7d277d739f11703b488a503", "committedDate": "2020-10-27T14:31:12Z", "message": "Support provisioning of shared hosts\n\nAdds shared-host flag to enable and define resources of shared hosts.  This PR\nis a no-op until that flag is set, but there remains some integration with\nexclusiveTo (tbd in this PR or follow-up)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODUxODM0", "url": "https://github.com/vespa-engine/vespa/pull/15050#pullrequestreview-517851834", "createdAt": "2020-10-27T15:40:49Z", "commit": {"oid": "6247627fcb1b8f2aa7d277d739f11703b488a503"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0MDo1MFrOHpC-IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0NToyMVrOHpDOnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwMjMzNw==", "bodyText": "Use requestedNodes.isExclusive()?", "url": "https://github.com/vespa-engine/vespa/pull/15050#discussion_r512802337", "createdAt": "2020-10-27T15:40:50Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/GroupPreparer.java", "diffHunk": "@@ -88,7 +88,7 @@ public GroupPreparer(NodeRepository nodeRepository,\n                             .map(deficit -> hostProvisioner.get().provisionHosts(nodeRepository.database().getProvisionIndexes(deficit.getCount()),\n                                                                                  deficit.getFlavor(),\n                                                                                  application,\n-                                                                                 osVersion))\n+                                                                                 osVersion, false))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6247627fcb1b8f2aa7d277d739f11703b488a503"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjU1Nw==", "bodyText": "This can be removed now since this is 1:1 with presence of HostProvisioner and this maintainer is only created if it is set in NodeRepositoryMaintenance", "url": "https://github.com/vespa-engine/vespa/pull/15050#discussion_r512806557", "createdAt": "2020-10-27T15:45:21Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/DynamicProvisioningMaintainer.java", "diffHunk": "@@ -113,18 +114,32 @@ private void convergeToCapacity(NodeList nodes) {\n \n \n     /**\n-     * Provision the nodes necessary to satisfy given capacity.\n+     * Provision hosts to ensure there is room to allocate spare nodes.\n      *\n-     * @return excess hosts that can safely be deprovisioned, if any\n+     * @param advertisedSpareCapacity the advertised resources of the spare nodes\n+     * @param nodes list of all nodes\n+     * @return excess hosts that can safely be deprovisioned: An excess host 1. contains no nodes allocated\n+     *         to an application, and assuming the spare nodes have been allocated, and 2. is not parked\n+     *         without wantToDeprovision (which means an operator is looking at the node).\n      */\n-    private List<Node> provision(List<NodeResources> capacity, NodeList nodes) {\n-        List<Node> existingHosts = availableHostsOf(nodes);\n-        if (nodeRepository().zone().getCloud().dynamicProvisioning()) {\n-            existingHosts = removableHostsOf(existingHosts, nodes);\n-        } else if (capacity.isEmpty()) {\n+    private List<Node> provision(List<NodeResources> advertisedSpareCapacity, NodeList nodes) {\n+        if (!nodeRepository().zone().getCloud().dynamicProvisioning()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6247627fcb1b8f2aa7d277d739f11703b488a503"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0274f45fd9c0108d3c08a1b75b77737ae421eee5", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/0274f45fd9c0108d3c08a1b75b77737ae421eee5", "committedDate": "2020-10-28T10:18:47Z", "message": "Review fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTEyNzY2", "url": "https://github.com/vespa-engine/vespa/pull/15050#pullrequestreview-518512766", "createdAt": "2020-10-28T10:21:59Z", "commit": {"oid": "0274f45fd9c0108d3c08a1b75b77737ae421eee5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2190, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}