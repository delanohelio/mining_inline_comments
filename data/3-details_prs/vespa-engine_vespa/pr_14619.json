{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0ODA5NTc4", "number": 14619, "title": "Delete session without lock", "bodyText": "Two things has changed:\n\nDo not use lock when deleting, it's not necessary, nobody else takes the lock\nDelete remote session data in zookeeper immediately, watchers on other config servers will be notified and internal state cleaned up (also local session state)", "createdAt": "2020-09-29T12:54:14Z", "url": "https://github.com/vespa-engine/vespa/pull/14619", "merged": true, "mergeCommit": {"oid": "da408a8c024b96aaa99313545f16beec1ca716e9"}, "closed": true, "closedAt": "2020-09-30T12:17:47Z", "author": {"login": "hmusum"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNm9SRgH2gAyNDk0ODA5NTc4OjYyOWFjMWZjZjZjYTM2ODZiMWY0MDZhY2RjNmY4MjE2ZmNhYTEyMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN3xMrAFqTQ5OTE1ODQ4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "629ac1fcf6ca3686b1f406acdc6f8216fcaa1230", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/629ac1fcf6ca3686b1f406acdc6f8216fcaa1230", "committedDate": "2020-09-29T12:01:35Z", "message": "Do not use lock when deleting session\n\nAlso just delete session from ZooKeeper right away, other config servers will\npick this up and delete the session there."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b90cb5066faf2e989ba7b136766655919e75904d", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/b90cb5066faf2e989ba7b136766655919e75904d", "committedDate": "2020-09-29T12:52:53Z", "message": "ZooKeeper data is deleted earlier on, no need for this here anymore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96beed744ab633a47b42365b2465e6e0f8423f31", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/96beed744ab633a47b42365b2465e6e0f8423f31", "committedDate": "2020-09-29T12:53:42Z", "message": "Simplify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MTQwMzg3", "url": "https://github.com/vespa-engine/vespa/pull/14619#pullrequestreview-499140387", "createdAt": "2020-09-30T07:09:46Z", "commit": {"oid": "96beed744ab633a47b42365b2465e6e0f8423f31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNzowOTo0NlrOHaQCbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNzowOTo0NlrOHaQCbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4Nzc4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Deleting an application is done by deleting the remote session, other config\n          \n          \n            \n                        // Deleting an application is done by deleting the remote session, all config\n          \n      \n    \n    \n  \n\nThis config server will also delete through the watcher?", "url": "https://github.com/vespa-engine/vespa/pull/14619#discussion_r497287788", "createdAt": "2020-09-30T07:09:46Z", "author": {"login": "hakonhall"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/ApplicationRepository.java", "diffHunk": "@@ -469,47 +469,21 @@ static void checkIfActiveIsNewerThanSessionToBeActivated(long sessionId, long cu\n      * @return true if the application was found and deleted, false if it was not present\n      * @throws RuntimeException if the delete transaction fails. This method is exception safe.\n      */\n-    boolean delete(ApplicationId applicationId) {\n-        return delete(applicationId, Duration.ofSeconds(60));\n-    }\n-\n-    /**\n-     * Deletes an application\n-     *\n-     * @return true if the application was found and deleted, false if it was not present\n-     * @throws RuntimeException if the delete transaction fails. This method is exception safe.\n-     */\n-    public boolean delete(ApplicationId applicationId, Duration waitTime) {\n+    public boolean delete(ApplicationId applicationId) {\n         Tenant tenant = getTenant(applicationId);\n         if (tenant == null) return false;\n \n         TenantApplications tenantApplications = tenant.getApplicationRepo();\n         try (Lock lock = tenantApplications.lock(applicationId)) {\n-            if ( ! tenantApplications.exists(applicationId)) return false;\n-\n             Optional<Long> activeSession = tenantApplications.activeSessionOf(applicationId);\n             if (activeSession.isEmpty()) return false;\n \n-            // Deleting an application is done by deleting the remote session and waiting\n-            // until the config server where the deployment happened picks it up and deletes\n-            // the local session\n-            long sessionId = activeSession.get();\n-\n-            RemoteSession remoteSession;\n+            // Deleting an application is done by deleting the remote session, other config", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96beed744ab633a47b42365b2465e6e0f8423f31"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9efe5d42c7cc1b91981cd32c9f815a5b598dcab9", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/9efe5d42c7cc1b91981cd32c9f815a5b598dcab9", "committedDate": "2020-09-30T07:18:08Z", "message": "Update configserver/src/main/java/com/yahoo/vespa/config/server/ApplicationRepository.java\n\nCo-authored-by: H\u00e5kon Hallingstad <hakon@verizonmedia.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MTQ3NDA0", "url": "https://github.com/vespa-engine/vespa/pull/14619#pullrequestreview-499147404", "createdAt": "2020-09-30T07:20:35Z", "commit": {"oid": "9efe5d42c7cc1b91981cd32c9f815a5b598dcab9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efe793a541b0c4ae3e66f6ddaddd6fa6799184c7", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/efe793a541b0c4ae3e66f6ddaddd6fa6799184c7", "committedDate": "2020-09-30T07:25:27Z", "message": "Rever doc change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MTU4NDg1", "url": "https://github.com/vespa-engine/vespa/pull/14619#pullrequestreview-499158485", "createdAt": "2020-09-30T07:36:46Z", "commit": {"oid": "efe793a541b0c4ae3e66f6ddaddd6fa6799184c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4126, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}