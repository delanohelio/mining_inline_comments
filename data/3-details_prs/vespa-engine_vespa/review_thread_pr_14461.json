{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMTI2NzY3", "number": 14461, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1MDozOFrOEllNNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1Njo0MVrOEln3gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODQyMzU2OnYy", "diffSide": "RIGHT", "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1MDozOFrOHVITKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDoyOTozMVrOHVJoug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA==", "bodyText": "Why creating it at all if shutdown is set. Can you just add it to the outer if as '&& !shutDown'", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491918120", "createdAt": "2020-09-21T09:50:38Z", "author": {"login": "baldersheim"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMTg4Nw==", "bodyText": "Then you'd return null. I thought it better to preserve the existing error message you'd get when trying to use a shut down document access.", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491921887", "createdAt": "2020-09-21T09:57:35Z", "author": {"login": "jonmv"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA=="}, "originalCommit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjE0MQ==", "bodyText": "Alternatively could throw something custom that was clear on this.", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491922141", "createdAt": "2020-09-21T09:58:00Z", "author": {"login": "jonmv"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA=="}, "originalCommit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMDYyOQ==", "bodyText": "Throw instead, no point in constructing mbus access and shut it down just to preserve error message in this case.\nThis should never happen, but throwing is probably a good idea.", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491930629", "createdAt": "2020-09-21T10:13:44Z", "author": {"login": "baldersheim"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA=="}, "originalCommit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk0MDAyNg==", "bodyText": "Can do. 'twas my first impulse as well. And, yes, this should never happen, unless someone breaks DI.", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491940026", "createdAt": "2020-09-21T10:29:31Z", "author": {"login": "jonmv"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA=="}, "originalCommit": {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODg0MTU2OnYy", "diffSide": "RIGHT", "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1MzowOFrOHVMTAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1MzowOFrOHVMTAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4MzYxOA==", "bodyText": "IMHO, throwing an exception for duplicate calls to deconstruct() is ok - it should not happen. This is too defensive.", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491983618", "createdAt": "2020-09-21T11:53:08Z", "author": {"login": "bjorncs"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)\n+                    access.shutdown();\n+            }\n+            return access;\n+        }\n+    }\n+\n+    @Override\n+    public void deconstruct() {\n+        synchronized (monitor) {\n+            if ( ! shutDown) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODg1ODE4OnYy", "diffSide": "RIGHT", "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1NjoxNFrOHVMd3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1NjoxNFrOHVMd3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjM5Nw==", "bodyText": "Is this config available for all types of container clusters (e.g clustercontroller, metricsproxy, logserver)?", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491986397", "createdAt": "2020-09-21T11:56:14Z", "author": {"login": "bjorncs"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODg1OTU0OnYy", "diffSide": "RIGHT", "path": "config-model/src/main/java/com/yahoo/vespa/model/container/ContainerCluster.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1Njo0MVrOHVMevA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1Njo0MVrOHVMevA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjYyMA==", "bodyText": "Should this component be available for non-application-container-clusters?", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491986620", "createdAt": "2020-09-21T11:56:41Z", "author": {"login": "bjorncs"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/container/ContainerCluster.java", "diffHunk": "@@ -181,6 +181,7 @@ public ContainerCluster(AbstractConfigProducer<?> parent, String subId, String n\n         addSimpleComponent(com.yahoo.metrics.simple.jdisc.JdiscMetricsFactory.class.getName(), null, MetricProperties.BUNDLE_SYMBOLIC_NAME);\n         addSimpleComponent(\"com.yahoo.container.jdisc.state.StateMonitor\");\n         addSimpleComponent(\"com.yahoo.container.jdisc.ContainerThreadFactory\");\n+        addSimpleComponent(com.yahoo.container.core.documentapi.MessageBusDocumentAccessProvider.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1362, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}