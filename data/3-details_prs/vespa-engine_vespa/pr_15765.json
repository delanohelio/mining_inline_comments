{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MjkxMDE1", "number": 15765, "title": "Add ReindexingTriggerer to controller maintenance", "bodyText": "@bjorncs", "createdAt": "2020-12-09T16:10:53Z", "url": "https://github.com/vespa-engine/vespa/pull/15765", "merged": true, "mergeCommit": {"oid": "c0721c2b266317265a2e58b84a1c44d8db26b353"}, "closed": true, "closedAt": "2020-12-10T09:22:21Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkhEzEgH2gAyNTM1MjkxMDE1OmIyMTMzZGIxYWI3YzE3MWRmYjllMTVkMTFjM2I2ZGE1OTkwNGUzNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkvvt5AFqTU0ODk5MDEzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b2133db1ab7c171dfb9e15d11c3b6da59904e370", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/b2133db1ab7c171dfb9e15d11c3b6da59904e370", "committedDate": "2020-12-09T16:10:37Z", "message": "Add ReindexingTriggerer to controller maintenance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTQwMjMw", "url": "https://github.com/vespa-engine/vespa/pull/15765#pullrequestreview-548540230", "createdAt": "2020-12-09T19:34:30Z", "commit": {"oid": "b2133db1ab7c171dfb9e15d11c3b6da59904e370"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOTozNDozMFrOICl6Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOTozNDozMFrOICl6Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4OTE1NA==", "bodyText": "Should be closed. \ud83d\ude42", "url": "https://github.com/vespa-engine/vespa/pull/15765#discussion_r539589154", "createdAt": "2020-12-09T19:34:30Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java", "diffHunk": "@@ -81,6 +82,7 @@ public ControllerMaintenance(Controller controller, Metric metric) {\n         applicationMetaDataGarbageCollector = new ApplicationMetaDataGarbageCollector(controller, intervals.applicationMetaDataGarbageCollector);\n         containerImageExpirer = new ContainerImageExpirer(controller, intervals.containerImageExpirer);\n         hostSwitchUpdater = new HostSwitchUpdater(controller, intervals.hostSwitchUpdater);\n+        reindexingTriggerer = new ReindexingTriggerer(controller, intervals.reindexingTriggerer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2133db1ab7c171dfb9e15d11c3b6da59904e370"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57ee62839849ff05bb554edb1dfb899c0f2202c", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/d57ee62839849ff05bb554edb1dfb899c0f2202c", "committedDate": "2020-12-09T19:37:43Z", "message": "Close reindexing triggerer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a963e9ed4580e22e3b351c584ba49b01b4bf03ce", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/a963e9ed4580e22e3b351c584ba49b01b4bf03ce", "committedDate": "2020-12-09T19:43:11Z", "message": "Automate deletion of newly added maintainers :))"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0107067c0a9c29dd4e60231ad79e35786c390626", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/0107067c0a9c29dd4e60231ad79e35786c390626", "committedDate": "2020-12-09T19:46:19Z", "message": "Update API test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8f8e85351b70a02b9915b6978dd05e1c2cc55c7", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/c8f8e85351b70a02b9915b6978dd05e1c2cc55c7", "committedDate": "2020-12-09T20:12:44Z", "message": "Split (async) shutdown and (sync) wait for it, and use lists in all maintainer owners"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTk2Nzky", "url": "https://github.com/vespa-engine/vespa/pull/15765#pullrequestreview-548596792", "createdAt": "2020-12-09T20:49:34Z", "commit": {"oid": "c8f8e85351b70a02b9915b6978dd05e1c2cc55c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMDo1MjozNlrOICo9VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMDo1MjozNlrOICo9VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzOTEyNQ==", "bodyText": "Better, but why do we need both if close calls shutdown when necessary?", "url": "https://github.com/vespa-engine/vespa/pull/15765#discussion_r539639125", "createdAt": "2020-12-09T20:52:36Z", "author": {"login": "mpolden"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java", "diffHunk": "@@ -28,89 +31,47 @@\n  */\n public class ControllerMaintenance extends AbstractComponent {\n \n-    private final DeploymentExpirer deploymentExpirer;\n-    private final DeploymentIssueReporter deploymentIssueReporter;\n-    private final MetricsReporter metricsReporter;\n-    private final OutstandingChangeDeployer outstandingChangeDeployer;\n-    private final VersionStatusUpdater versionStatusUpdater;\n     private final Upgrader upgrader;\n-    private final ReadyJobsTrigger readyJobsTrigger;\n-    private final DeploymentMetricsMaintainer deploymentMetricsMaintainer;\n-    private final ApplicationOwnershipConfirmer applicationOwnershipConfirmer;\n-    private final SystemUpgrader systemUpgrader;\n-    private final List<OsUpgrader> osUpgraders;\n-    private final OsVersionStatusUpdater osVersionStatusUpdater;\n-    private final JobRunner jobRunner;\n-    private final ContactInformationMaintainer contactInformationMaintainer;\n-    private final CostReportMaintainer costReportMaintainer;\n-    private final ResourceMeterMaintainer resourceMeterMaintainer;\n-    private final NameServiceDispatcher nameServiceDispatcher;\n-    private final CloudEventReporter cloudEventReporter;\n-    private final RotationStatusUpdater rotationStatusUpdater;\n-    private final ResourceTagMaintainer resourceTagMaintainer;\n-    private final SystemRoutingPolicyMaintainer systemRoutingPolicyMaintainer;\n-    private final ApplicationMetaDataGarbageCollector applicationMetaDataGarbageCollector;\n-    private final ContainerImageExpirer containerImageExpirer;\n-    private final HostSwitchUpdater hostSwitchUpdater;\n+    private final List<Maintainer> maintainers = new CopyOnWriteArrayList<>();\n \n     @Inject\n     @SuppressWarnings(\"unused\") // instantiated by Dependency Injection\n     public ControllerMaintenance(Controller controller, Metric metric) {\n         Intervals intervals = new Intervals(controller.system());\n-        deploymentExpirer = new DeploymentExpirer(controller, intervals.defaultInterval);\n-        deploymentIssueReporter = new DeploymentIssueReporter(controller, controller.serviceRegistry().deploymentIssues(), intervals.defaultInterval);\n-        metricsReporter = new MetricsReporter(controller, metric);\n-        outstandingChangeDeployer = new OutstandingChangeDeployer(controller, intervals.outstandingChangeDeployer);\n-        versionStatusUpdater = new VersionStatusUpdater(controller, intervals.versionStatusUpdater);\n         upgrader = new Upgrader(controller, intervals.defaultInterval);\n-        readyJobsTrigger = new ReadyJobsTrigger(controller, intervals.readyJobsTrigger);\n-        deploymentMetricsMaintainer = new DeploymentMetricsMaintainer(controller, intervals.deploymentMetricsMaintainer);\n-        applicationOwnershipConfirmer = new ApplicationOwnershipConfirmer(controller, intervals.applicationOwnershipConfirmer, controller.serviceRegistry().ownershipIssues());\n-        systemUpgrader = new SystemUpgrader(controller, intervals.systemUpgrader);\n-        jobRunner = new JobRunner(controller, intervals.jobRunner);\n-        osUpgraders = osUpgraders(controller, intervals.osUpgrader);\n-        osVersionStatusUpdater = new OsVersionStatusUpdater(controller, intervals.defaultInterval);\n-        contactInformationMaintainer = new ContactInformationMaintainer(controller, intervals.contactInformationMaintainer);\n-        nameServiceDispatcher = new NameServiceDispatcher(controller, intervals.nameServiceDispatcher);\n-        costReportMaintainer = new CostReportMaintainer(controller, intervals.costReportMaintainer, controller.serviceRegistry().costReportConsumer());\n-        resourceMeterMaintainer = new ResourceMeterMaintainer(controller, intervals.resourceMeterMaintainer, metric, controller.serviceRegistry().meteringService());\n-        cloudEventReporter = new CloudEventReporter(controller, intervals.cloudEventReporter, metric);\n-        rotationStatusUpdater = new RotationStatusUpdater(controller, intervals.defaultInterval);\n-        resourceTagMaintainer = new ResourceTagMaintainer(controller, intervals.resourceTagMaintainer, controller.serviceRegistry().resourceTagger());\n-        systemRoutingPolicyMaintainer = new SystemRoutingPolicyMaintainer(controller, intervals.systemRoutingPolicyMaintainer);\n-        applicationMetaDataGarbageCollector = new ApplicationMetaDataGarbageCollector(controller, intervals.applicationMetaDataGarbageCollector);\n-        containerImageExpirer = new ContainerImageExpirer(controller, intervals.containerImageExpirer);\n-        hostSwitchUpdater = new HostSwitchUpdater(controller, intervals.hostSwitchUpdater);\n+        maintainers.add(upgrader);\n+        maintainers.addAll(osUpgraders(controller, intervals.osUpgrader));\n+        maintainers.add(new DeploymentExpirer(controller, intervals.defaultInterval));\n+        maintainers.add(new DeploymentIssueReporter(controller, controller.serviceRegistry().deploymentIssues(), intervals.defaultInterval));\n+        maintainers.add(new MetricsReporter(controller, metric));\n+        maintainers.add(new OutstandingChangeDeployer(controller, intervals.outstandingChangeDeployer));\n+        maintainers.add(new VersionStatusUpdater(controller, intervals.versionStatusUpdater));\n+        maintainers.add(new ReadyJobsTrigger(controller, intervals.readyJobsTrigger));\n+        maintainers.add(new DeploymentMetricsMaintainer(controller, intervals.deploymentMetricsMaintainer));\n+        maintainers.add(new ApplicationOwnershipConfirmer(controller, intervals.applicationOwnershipConfirmer, controller.serviceRegistry().ownershipIssues()));\n+        maintainers.add(new SystemUpgrader(controller, intervals.systemUpgrader));\n+        maintainers.add(new JobRunner(controller, intervals.jobRunner));\n+        maintainers.add(new OsVersionStatusUpdater(controller, intervals.defaultInterval));\n+        maintainers.add(new ContactInformationMaintainer(controller, intervals.contactInformationMaintainer));\n+        maintainers.add(new NameServiceDispatcher(controller, intervals.nameServiceDispatcher));\n+        maintainers.add(new CostReportMaintainer(controller, intervals.costReportMaintainer, controller.serviceRegistry().costReportConsumer()));\n+        maintainers.add(new ResourceMeterMaintainer(controller, intervals.resourceMeterMaintainer, metric, controller.serviceRegistry().meteringService()));\n+        maintainers.add(new CloudEventReporter(controller, intervals.cloudEventReporter, metric));\n+        maintainers.add(new RotationStatusUpdater(controller, intervals.defaultInterval));\n+        maintainers.add(new ResourceTagMaintainer(controller, intervals.resourceTagMaintainer, controller.serviceRegistry().resourceTagger()));\n+        maintainers.add(new SystemRoutingPolicyMaintainer(controller, intervals.systemRoutingPolicyMaintainer));\n+        maintainers.add(new ApplicationMetaDataGarbageCollector(controller, intervals.applicationMetaDataGarbageCollector));\n+        maintainers.add(new ContainerImageExpirer(controller, intervals.containerImageExpirer));\n+        maintainers.add(new HostSwitchUpdater(controller, intervals.hostSwitchUpdater));\n+        maintainers.add(new ReindexingTriggerer(controller, intervals.reindexingTriggerer));\n     }\n \n     public Upgrader upgrader() { return upgrader; }\n \n     @Override\n     public void deconstruct() {\n-        deploymentExpirer.close();\n-        deploymentIssueReporter.close();\n-        metricsReporter.close();\n-        outstandingChangeDeployer.close();\n-        versionStatusUpdater.close();\n-        upgrader.close();\n-        readyJobsTrigger.close();\n-        deploymentMetricsMaintainer.close();\n-        applicationOwnershipConfirmer.close();\n-        systemUpgrader.close();\n-        osUpgraders.forEach(ControllerMaintainer::close);\n-        osVersionStatusUpdater.close();\n-        jobRunner.close();\n-        contactInformationMaintainer.close();\n-        costReportMaintainer.close();\n-        resourceMeterMaintainer.close();\n-        nameServiceDispatcher.close();\n-        cloudEventReporter.close();\n-        rotationStatusUpdater.close();\n-        resourceTagMaintainer.close();\n-        systemRoutingPolicyMaintainer.close();\n-        applicationMetaDataGarbageCollector.close();\n-        containerImageExpirer.close();\n-        hostSwitchUpdater.close();\n+        maintainers.forEach(Maintainer::shutdown);\n+        maintainers.forEach(Maintainer::close);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8f8e85351b70a02b9915b6978dd05e1c2cc55c7"}, "originalPosition": 134}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06803b97348d9a4fb56df083cae73e2afbc44438", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/06803b97348d9a4fb56df083cae73e2afbc44438", "committedDate": "2020-12-10T07:01:50Z", "message": "Rename close to awaitShutdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTkwMTM2", "url": "https://github.com/vespa-engine/vespa/pull/15765#pullrequestreview-548990136", "createdAt": "2020-12-10T09:16:10Z", "commit": {"oid": "06803b97348d9a4fb56df083cae73e2afbc44438"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3825, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}