{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNDQzNDIx", "number": 13538, "title": "tenant creation for everyone in public (with restrictions/gated by flag)", "bodyText": "", "createdAt": "2020-06-10T13:08:18Z", "url": "https://github.com/vespa-engine/vespa/pull/13538", "merged": true, "mergeCommit": {"oid": "54828b73bcea1d086b145453b318bfdcdfef93b8"}, "closed": true, "closedAt": "2020-06-11T08:31:21Z", "author": {"login": "andreer"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp5XBrgH2gAyNDMyNDQzNDIxOjg2ZDVkNDdiNDAyZTNjYjhlYmJkNjIxNGFiZTg1ODM4YTEyNjExZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqJ9X6gH2gAyNDMyNDQzNDIxOmNlZTc5NWE4MDg2MjA0MjM5MTcyMzgwMTk5MTQ3YjZmNzRmNzM4Y2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "86d5d47b402e3cb8ebbd6214abe85838a12611f1", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/86d5d47b402e3cb8ebbd6214abe85838a12611f1", "committedDate": "2020-06-10T13:06:43Z", "message": "tenant creation for everyone in public (with restrictions/gated by flag)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "committedDate": "2020-06-10T13:42:14Z", "message": "make hostedOperator/hostedSupporter inherit \"everyone\", update tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjA2Njc0", "url": "https://github.com/vespa-engine/vespa/pull/13538#pullrequestreview-428606674", "createdAt": "2020-06-11T05:42:32Z", "commit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo0MjozMlrOGiPOTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo0MjozMlrOGiPOTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NDE5MA==", "bodyText": "(((\uff3c\uff08\u2718\u0df4\u2718\uff09\uff0f)))", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438554190", "createdAt": "2020-06-11T05:42:32Z", "author": {"login": "jonmv"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/role/Policy.java", "diffHunk": "@@ -48,15 +48,10 @@\n                   .on(PathGroup.user)\n                   .in(SystemName.main, SystemName.cd, SystemName.dev)),\n \n-    /** Access to create a tenant in select systems. */\n+    /** Access to create a tenant. */\n     tenantCreate(Privilege.grant(Action.create)\n                           .on(PathGroup.tenant)\n-                          .in(SystemName.main, SystemName.cd, SystemName.dev)), // TODO SystemName.all()\n-\n-    /** Access to create a tenant in public */\n-    tenantCreatePublic(Privilege.grant(Action.create)\n-                                .on(PathGroup.tenant)\n-                                .in(SystemName.PublicCd, SystemName.Public)),\n+                          .in(SystemName.all())),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjA4MTcw", "url": "https://github.com/vespa-engine/vespa/pull/13538#pullrequestreview-428608170", "createdAt": "2020-06-11T05:46:50Z", "commit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo0Njo1MFrOGiPTBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo0Njo1MFrOGiPTBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NTM5Nw==", "bodyText": "The operator policy already provides all priviliges.", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438555397", "createdAt": "2020-06-11T05:46:50Z", "author": {"login": "jonmv"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/role/RoleDefinition.java", "diffHunk": "@@ -18,18 +18,17 @@\n  */\n public enum RoleDefinition {\n \n+    /** Base role which every user is part of. */\n+    everyone(Policy.classifiedRead,\n+            Policy.publicRead,\n+            Policy.user,\n+            Policy.tenantCreate),\n+\n     /** Deus ex machina. */\n-    hostedOperator(Policy.operator),\n+    hostedOperator(everyone, Policy.operator),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjA5MDk4", "url": "https://github.com/vespa-engine/vespa/pull/13538#pullrequestreview-428609098", "createdAt": "2020-06-11T05:49:36Z", "commit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo0OTozNlrOGiPWAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo0OTozNlrOGiPWAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NjE2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                hostedSupporter(everyone, Policy.supporter),\n          \n          \n            \n                hostedSupporter(Policy.supporter),\n          \n      \n    \n    \n  \n\nAnyone who is authenticated is automatically a member of the everyone role as well, but I guess that could be considered an implementation detail.\nI do know someone disliked thet role inheritance, though, and wanted to kill it.", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438556163", "createdAt": "2020-06-11T05:49:36Z", "author": {"login": "jonmv"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/role/RoleDefinition.java", "diffHunk": "@@ -18,18 +18,17 @@\n  */\n public enum RoleDefinition {\n \n+    /** Base role which every user is part of. */\n+    everyone(Policy.classifiedRead,\n+            Policy.publicRead,\n+            Policy.user,\n+            Policy.tenantCreate),\n+\n     /** Deus ex machina. */\n-    hostedOperator(Policy.operator),\n+    hostedOperator(everyone, Policy.operator),\n \n     /** Machina autem exspiravit. */\n-    hostedSupporter(Policy.supporter,\n-                    Policy.tenantCreatePublic),\n-\n-    /** Base role which every user is part of. */\n-    everyone(Policy.classifiedRead,\n-             Policy.publicRead,\n-             Policy.user,\n-             Policy.tenantCreate),\n+    hostedSupporter(everyone, Policy.supporter),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjEwMTcy", "url": "https://github.com/vespa-engine/vespa/pull/13538#pullrequestreview-428610172", "createdAt": "2020-06-11T05:52:48Z", "commit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo1Mjo0OFrOGiPZpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo1Mjo0OFrOGiPZpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NzA5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Override\n          \n          \n            \n                public Principal user() { return super.user(); }", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438557094", "createdAt": "2020-06-11T05:52:48Z", "author": {"login": "jonmv"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/security/Auth0Credentials.java", "diffHunk": "@@ -0,0 +1,33 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.security;\n+\n+import com.yahoo.vespa.hosted.controller.api.role.Role;\n+\n+import java.security.Principal;\n+import java.util.Collections;\n+import java.util.Set;\n+\n+/**\n+ * Like {@link Credentials}, but we know the principal is authenticated by Auth0.\n+ * Also includes the set of roles for which the principal is a member.\n+ *\n+ * @author andreer\n+ */\n+public class Auth0Credentials extends Credentials {\n+\n+    private final Set<Role> roles;\n+\n+    public Auth0Credentials(Principal user, Set<Role> roles) {\n+        super(user);\n+        this.roles = Collections.unmodifiableSet(roles);\n+    }\n+\n+    @Override\n+    public Principal user() { return super.user(); }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjExNzk4", "url": "https://github.com/vespa-engine/vespa/pull/13538#pullrequestreview-428611798", "createdAt": "2020-06-11T05:57:14Z", "commit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo1NzoxNFrOGiPe1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo1NzoxNFrOGiPe1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1ODQyMg==", "bodyText": "Yes!", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438558422", "createdAt": "2020-06-11T05:57:14Z", "author": {"login": "jonmv"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/security/CloudAccessControl.java", "diffHunk": "@@ -48,14 +60,43 @@ public CloudTenant createTenant(TenantSpec tenantSpec, Credentials credentials,\n         return tenant;\n     }\n \n+    private void requireTenantCreationAllowed(Auth0Credentials auth0Credentials) {\n+        if (allowedByPrivilegedRole(auth0Credentials)) return;\n+\n+        if (!allowedByFeatureFlag(auth0Credentials)) {\n+            throw new ForbiddenException(\"You are not currently permitted to create tenants. Please contact the Vespa team to request access.\");\n+        }\n+\n+        if(administeredTenants(auth0Credentials) >= 3) {\n+            throw new ForbiddenException(\"You are already administering 3 tenants. If you need more, please contact the Vespa team.\");\n+        }\n+    }\n+\n+    private boolean allowedByPrivilegedRole(Auth0Credentials auth0Credentials) {\n+        return auth0Credentials.getRoles().stream()\n+                .map(Role::definition)\n+                .anyMatch(rd -> rd == hostedOperator || rd == hostedSupporter);\n+    }\n+\n+    private boolean allowedByFeatureFlag(Auth0Credentials auth0Credentials) {\n+        return enablePublicSignup.with(FetchVector.Dimension.CONSOLE_USER_EMAIL, auth0Credentials.user().getName()).value();\n+    }\n+\n+    private long administeredTenants(Auth0Credentials auth0Credentials) {\n+        return auth0Credentials.getRoles().stream()\n+                .map(Role::definition)\n+                .filter(rd -> rd == administrator)\n+                .count();\n+    }\n+\n     @Override\n     public Tenant updateTenant(TenantSpec tenantSpec, Credentials credentials, List<Tenant> existing, List<Application> applications) {\n         throw new UnsupportedOperationException(\"Update is not supported here, as it would entail changing the tenant name.\");\n     }\n \n     @Override\n     public void deleteTenant(TenantName tenant, Credentials credentials) {\n-        // Probably terminate customer subscription?\n+        // TODO: allow only if 0 resources, 0 balance", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjEzODg3", "url": "https://github.com/vespa-engine/vespa/pull/13538#pullrequestreview-428613887", "createdAt": "2020-06-11T06:02:44Z", "commit": {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef9e2d67cb8cbf16a62852005781831c64483f0c", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/ef9e2d67cb8cbf16a62852005781831c64483f0c", "committedDate": "2020-06-11T07:11:10Z", "message": "operator policy already provides all privileges\n\nCo-authored-by: Jon Marius Venstad <jonmv@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d3cfffca709fa900aa7e58ee0fb3bf8f2a88f12", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/0d3cfffca709fa900aa7e58ee0fb3bf8f2a88f12", "committedDate": "2020-06-11T07:14:36Z", "message": "remove overridden method without changes\n\nCo-authored-by: Jon Marius Venstad <jonmv@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9f7420993a4f4ab0f9c770834a9f97fdf8253cd", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/b9f7420993a4f4ab0f9c770834a9f97fdf8253cd", "committedDate": "2020-06-11T07:28:25Z", "message": "always include feature flag value in user api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28dd3a27d372034352d0e8895ae59058b2d0fcb2", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/28dd3a27d372034352d0e8895ae59058b2d0fcb2", "committedDate": "2020-06-11T08:03:40Z", "message": "remove use of role inheritance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cee795a8086204239172380199147b6f74f738cd", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/cee795a8086204239172380199147b6f74f738cd", "committedDate": "2020-06-11T08:27:05Z", "message": "undo whitespace change"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3736, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}