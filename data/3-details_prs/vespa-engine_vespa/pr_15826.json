{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMzM1MTc2", "number": 15826, "title": "Gjoranv/wait for deconstruct upon shutdown", "bodyText": "This is to prevent uninstalling bundles and ClassNotFound exceptions when the container is shutting down.\nFYI: @bjorncs", "createdAt": "2020-12-15T15:29:41Z", "url": "https://github.com/vespa-engine/vespa/pull/15826", "merged": true, "mergeCommit": {"oid": "873967500b0543b29c4dff0617bc0ef163a3809d"}, "closed": true, "closedAt": "2020-12-15T16:56:39Z", "author": {"login": "gjoranv"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmaehxAH2gAyNTQwMzM1MTc2OjA4ZDE5MzNiZDdhMzRkMGZhZTNjNGNmMGRjZDhiYTI4MDg0ZDgzZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmdRNUAFqTU1MjY2Mzg2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1", "committedDate": "2020-12-15T13:37:14Z", "message": "Wait for component deconstruction to finish when shutting down.\n\n- Wait up to 10 minuts.\n- Add separate modes for reconfig and shutdown.\n- Add test ctor for setting the delay before deconstruction starts\n  in RECONFIG mode. (Tests are TBD.)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79e8e0a9632002c6c7a3bb687820b896019c4ded", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/79e8e0a9632002c6c7a3bb687820b896019c4ded", "committedDate": "2020-12-15T14:06:19Z", "message": "Add constant for the deconstruct delay in RECONFIG mode."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81d4a76511c3dfc19aed98b47153dcea95fd31fd", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/81d4a76511c3dfc19aed98b47153dcea95fd31fd", "committedDate": "2020-12-15T14:07:38Z", "message": "Extract method for task waiting and exception handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1df01cb01cb5fd95f947b8a84763662411a05b4b", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/1df01cb01cb5fd95f947b8a84763662411a05b4b", "committedDate": "2020-12-15T14:33:34Z", "message": "Switch test to use RECONFIG mode by default.\n\n- Use SHUTDOWN mode for the latest test that uses a component\n  with the delayed deconstruct method.\n- Remove the now unnecessary explanation from the class comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fc476b0a59950a75330d78fa3d96386dc0f572e", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/0fc476b0a59950a75330d78fa3d96386dc0f572e", "committedDate": "2020-12-15T14:34:22Z", "message": "Optimize imports."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbd03ebf7b571348c7b4eff762ddeebdc41e3e2c", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/cbd03ebf7b571348c7b4eff762ddeebdc41e3e2c", "committedDate": "2020-12-15T15:20:54Z", "message": "Make the deconstruct executor private again.\n\n- Add helper method in test to wait for deconstruct to finish."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjQ0MTQx", "url": "https://github.com/vespa-engine/vespa/pull/15826#pullrequestreview-552644141", "createdAt": "2020-12-15T16:32:10Z", "commit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjozMjoxMFrOIGUb6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjozMjoxMFrOIGUb6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5NzE5NQ==", "bodyText": "Isn't there also a 50s timeout on shutdown, somewhere further up?", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543497195", "createdAt": "2020-12-15T16:32:10Z", "author": {"login": "jonmv"}, "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "diffHunk": "@@ -61,9 +81,24 @@ public void deconstruct(List<Object> components, Collection<Bundle> bundles) {\n                 ((SharedResource) component).release();\n             }\n         }\n-        if (! destructibleComponents.isEmpty() || ! bundles.isEmpty())\n-            executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n+        if (!destructibleComponents.isEmpty() || !bundles.isEmpty()) {\n+            var task = executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n                               delay.getSeconds(), TimeUnit.SECONDS);\n+            if (mode.equals(Mode.SHUTDOWN)) {\n+                // Wait for deconstruction to finish\n+                try {\n+                    log.info(\"Waiting up to \" + SHUTDOWN_DECONSTRUCT_TIMEOUT.toSeconds() + \" seconds for all components to deconstruct.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjU5NTc1", "url": "https://github.com/vespa-engine/vespa/pull/15826#pullrequestreview-552659575", "createdAt": "2020-12-15T16:47:57Z", "commit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0Nzo1OFrOIGVOrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0Nzo1OFrOIGVOrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMDE5MQ==", "bodyText": "Yes, was made visible for testing. All tests can use the synchronous shutdown instead :)", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543510191", "createdAt": "2020-12-15T16:47:58Z", "author": {"login": "jonmv"}, "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "diffHunk": "@@ -35,13 +39,29 @@\n \n     private static final Logger log = Logger.getLogger(Deconstructor.class.getName());\n \n+    private static final Duration SHUTDOWN_DECONSTRUCT_TIMEOUT = Duration.ofMinutes(10);\n+\n+    public enum Mode {\n+        RECONFIG,  // Delay deconstruction to allow old components to finish processing in-flight requests.\n+        SHUTDOWN   // The container is shutting down. Start deconstructing immediately, and wait until all components\n+                   // are deconstructed, to prevent shutting down while deconstruct is in progress.\n+    }\n+\n+    // TODO: make private again", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjYwMzI1", "url": "https://github.com/vespa-engine/vespa/pull/15826#pullrequestreview-552660325", "createdAt": "2020-12-15T16:48:44Z", "commit": {"oid": "cbd03ebf7b571348c7b4eff762ddeebdc41e3e2c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9571e410b812bf014342443aacc13273a2bc0fe", "author": {"user": {"login": "gjoranv", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/f9571e410b812bf014342443aacc13273a2bc0fe", "committedDate": "2020-12-15T16:49:35Z", "message": "Reduce shutdown deconstruction timeout from 10 min -> 45 sec\n\n.. due to ConfiguredApplication.shutdownDeadlineExecutor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjYzODY4", "url": "https://github.com/vespa-engine/vespa/pull/15826#pullrequestreview-552663868", "createdAt": "2020-12-15T16:52:24Z", "commit": {"oid": "f9571e410b812bf014342443aacc13273a2bc0fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3769, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}