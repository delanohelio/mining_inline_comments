{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNjU2NzQ4", "number": 11815, "title": "Hold a JVM-wide reentrant lock to grab mutex \u2014\u00a0helps ZK stale reads?", "bodyText": "@hakonhall please review and merge.", "createdAt": "2020-01-16T13:52:31Z", "url": "https://github.com/vespa-engine/vespa/pull/11815", "merged": true, "mergeCommit": {"oid": "6cd559b2773b9cff88b7db646d9e6b8f38130b5a"}, "closed": true, "closedAt": "2020-03-20T18:39:47Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb66gG3AH2gAyMzYzNjU2NzQ4OjVkZmU4ZTI0MjFhZjVkOWVhYWUzMWQ3NzlkMTYzNjE4MDc5OWRkZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb67QwJAFqTM0Mzk2MzkyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5dfe8e2421af5d9eaae31d779d1636180799ddef", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/5dfe8e2421af5d9eaae31d779d1636180799ddef", "committedDate": "2020-01-16T13:52:06Z", "message": "Hold a JVM-wide reentrant lock to grab mutex \u2014\u00a0helps ZK stale reads?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9775572038f4d8c883a94e1fee1b957b37d0e2f5", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/9775572038f4d8c883a94e1fee1b957b37d0e2f5", "committedDate": "2020-01-16T14:08:59Z", "message": "Swap order of locks, to avoid doubling timeout duration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTQ4Mzk3", "url": "https://github.com/vespa-engine/vespa/pull/11815#pullrequestreview-343948397", "createdAt": "2020-01-16T14:24:55Z", "commit": {"oid": "9775572038f4d8c883a94e1fee1b957b37d0e2f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoyNDo1NVrOFebDnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoyNDo1NVrOFebDnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NDg5Mg==", "bodyText": "I found the previous version of this code easer to read, probably because of the implicit non-obvious assumption that tryLock() is assumed to always return true, and then relying on that here.", "url": "https://github.com/vespa-engine/vespa/pull/11815#discussion_r367444892", "createdAt": "2020-01-16T14:24:55Z", "author": {"login": "hakonhall"}, "path": "zkfacade/src/main/java/com/yahoo/vespa/curator/Lock.java", "diffHunk": "@@ -15,31 +16,46 @@\n  */\n public class Lock implements Mutex {\n \n+    private final ReentrantLock lock;\n     private final InterProcessLock mutex;\n     private final String lockPath;\n \n     public Lock(String lockPath, Curator curator) {\n         this.lockPath = lockPath;\n+        this.lock = new ReentrantLock(true);\n         mutex = curator.createMutex(lockPath);\n     }\n \n     /** Take the lock with the given timeout. This may be called multiple times from the same thread - each matched by a close */\n     public void acquire(Duration timeout) throws UncheckedTimeoutException {\n-        boolean acquired;\n+        boolean acquired = false;\n         try {\n             acquired = mutex.acquire(timeout.toMillis(), TimeUnit.MILLISECONDS);\n+            lock.tryLock(); // Should be available to only this thread, while holding the above mutex.\n         }\n         catch (Exception e) {\n+            if (acquired) release();\n             throw new RuntimeException(\"Exception acquiring lock '\" + lockPath + \"'\", e);\n         }\n \n-        if (! acquired)\n+        if ( ! lock.isHeldByCurrentThread()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9775572038f4d8c883a94e1fee1b957b37d0e2f5"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTQ4NzI0", "url": "https://github.com/vespa-engine/vespa/pull/11815#pullrequestreview-343948724", "createdAt": "2020-01-16T14:25:24Z", "commit": {"oid": "9775572038f4d8c883a94e1fee1b957b37d0e2f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9267392ca57cdd2aa642383ca652125975f7653c", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/9267392ca57cdd2aa642383ca652125975f7653c", "committedDate": "2020-01-16T14:36:21Z", "message": "Differentiate between failing to acquire the two locks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f02dd7f9b53d32e2dbc1242de56dc1b6135b097", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/1f02dd7f9b53d32e2dbc1242de56dc1b6135b097", "committedDate": "2020-01-16T14:39:58Z", "message": "Be less stupoid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTYzOTIz", "url": "https://github.com/vespa-engine/vespa/pull/11815#pullrequestreview-343963923", "createdAt": "2020-01-16T14:45:14Z", "commit": {"oid": "1f02dd7f9b53d32e2dbc1242de56dc1b6135b097"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4032, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}