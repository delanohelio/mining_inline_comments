{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNTE2NjEy", "number": 13542, "title": "Rewrite attribute tests to gtest", "bodyText": "@toregge please review", "createdAt": "2020-06-10T15:01:00Z", "url": "https://github.com/vespa-engine/vespa/pull/13542", "merged": true, "mergeCommit": {"oid": "8de8ff4f87295d812d4e660f0216953726200c92"}, "closed": true, "closedAt": "2020-06-10T19:57:29Z", "author": {"login": "geirst"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp4rDOgH2gAyNDMyNTE2NjEyOjZjMjhiMGE5ZDUxZTVmZDg1MjZjYWUxZjI2ZjdhMjQ0ODI5NDk5ZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp_Oe-gH2gAyNDMyNTE2NjEyOmUzZGQ4ZDE0YzRmMjhlMDJkMzI4NDllZjJjZGY5YjJhOGFhYWY0MDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6c28b0a9d51e5fd8526cae1f26f7a244829499f1", "author": {"user": {"login": "geirst", "name": "Geir Storli"}}, "url": "https://github.com/vespa-engine/vespa/commit/6c28b0a9d51e5fd8526cae1f26f7a244829499f1", "committedDate": "2020-06-10T12:18:41Z", "message": "Stop using script to run the attribute test.\n\nDirectoryHandler is already used to handle creation and deletion of test folder."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e23f73971dc3e5ec8b1b6431837941e671603338", "author": {"user": {"login": "geirst", "name": "Geir Storli"}}, "url": "https://github.com/vespa-engine/vespa/commit/e23f73971dc3e5ec8b1b6431837941e671603338", "committedDate": "2020-06-10T14:59:31Z", "message": "Rewrite attribute (writer) tests to use gtest."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MTk5MTc4", "url": "https://github.com/vespa-engine/vespa/pull/13542#pullrequestreview-428199178", "createdAt": "2020-06-10T15:54:18Z", "commit": {"oid": "e23f73971dc3e5ec8b1b6431837941e671603338"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNTo1NDoxOFrOGh7iyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNTo1NTo0MlrOGh7nBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzMTc1NQ==", "bodyText": "No need for if, just reset _aw unconditionally.", "url": "https://github.com/vespa-engine/vespa/pull/13542#discussion_r438231755", "createdAt": "2020-06-10T15:54:18Z", "author": {"login": "toregge"}, "path": "searchcore/src/tests/proton/attribute/attribute_test.cpp", "diffHunk": "@@ -116,34 +115,38 @@ fillAttribute(const AttributeVector::SP &attr, uint32_t from, uint32_t to, int64\n const std::shared_ptr<IDestructorCallback> emptyCallback;\n \n \n-struct Fixture\n-{\n+class AttributeWriterTest : public ::testing::Test {\n+public:\n     DirectoryHandler _dirHandler;\n-    DummyFileHeaderContext   _fileHeaderContext;\n-    ForegroundTaskExecutor   _attributeFieldWriterReal;\n-    SequencedTaskExecutorObserver _attributeFieldWriter;\n-    HwInfo                   _hwInfo;\n+    DummyFileHeaderContext _fileHeaderContext;\n+    std::unique_ptr<ForegroundTaskExecutor> _attributeFieldWriterReal;\n+    std::unique_ptr<SequencedTaskExecutorObserver> _attributeFieldWriter;\n+    HwInfo _hwInfo;\n     proton::AttributeManager::SP _m;\n     std::unique_ptr<AttributeWriter> _aw;\n \n-    Fixture(uint32_t threads)\n+    AttributeWriterTest()\n         : _dirHandler(test_dir),\n           _fileHeaderContext(),\n-          _attributeFieldWriterReal(threads),\n-          _attributeFieldWriter(_attributeFieldWriterReal),\n+          _attributeFieldWriterReal(),\n+          _attributeFieldWriter(),\n           _hwInfo(),\n-          _m(std::make_shared<proton::AttributeManager>\n-             (test_dir, \"test.subdb\", TuneFileAttributes(),\n-              _fileHeaderContext, _attributeFieldWriter, _hwInfo)),\n+          _m(),\n           _aw()\n     {\n-        allocAttributeWriter();\n+        setup(1);\n     }\n-    Fixture()\n-        : Fixture(1)\n-    {\n+    ~AttributeWriterTest();\n+    void setup(uint32_t threads) {\n+        if (_aw) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23f73971dc3e5ec8b1b6431837941e671603338"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzMjgzNg==", "bodyText": "Removing this rmdir might cause the test to fail if restarted after an interrupted test run.", "url": "https://github.com/vespa-engine/vespa/pull/13542#discussion_r438232836", "createdAt": "2020-06-10T15:55:42Z", "author": {"login": "toregge"}, "path": "searchcore/src/tests/proton/attribute/attribute_test.cpp", "diffHunk": "@@ -917,38 +905,35 @@ struct StructMapFixture : public StructFixtureBase\n         doc->setValue(_structMapField, s);\n         return doc;\n     }\n+\n     void checkAttrs(uint32_t lid, int32_t expValue, const std::map<int32_t, int32_t> &expMap) {\n         auto valueAttr = _m->getAttribute(\"value\")->getSP();\n         auto mapKeyAttr = _m->getAttribute(\"map.key\")->getSP();\n         auto mapValueAttr = _m->getAttribute(\"map.value.value\")->getSP();\n-        EXPECT_EQUAL(expValue, valueAttr->getInt(lid));\n+        EXPECT_EQ(expValue, valueAttr->getInt(lid));\n         attribute::IntegerContent mapKeys;\n         mapKeys.fill(*mapKeyAttr, lid);\n         attribute::IntegerContent mapValues;\n         mapValues.fill(*mapValueAttr, lid);\n-        EXPECT_EQUAL(expMap.size(), mapValues.size());\n-        EXPECT_EQUAL(expMap.size(), mapKeys.size());\n+        EXPECT_EQ(expMap.size(), mapValues.size());\n+        EXPECT_EQ(expMap.size(), mapKeys.size());\n         size_t i = 0;\n         for (const auto &expMapElem : expMap) {\n-            EXPECT_EQUAL(expMapElem.first, mapKeys[i]);\n-            EXPECT_EQUAL(expMapElem.second, mapValues[i]);\n+            EXPECT_EQ(expMapElem.first, mapKeys[i]);\n+            EXPECT_EQ(expMapElem.second, mapValues[i]);\n             ++i;\n         }\n     }\n };\n \n-TEST_F(\"require that update with doc argument updates struct field attributes (map)\", StructMapFixture)\n+TEST_F(StructMapWriterTest, update_with_doc_argument_updates_struct_field_attributes)\n {\n-    auto doc = f.makeDoc(10,  {{1, 11}, {2, 12}});\n-    f.put(10, *doc, 1);\n-    TEST_DO(f.checkAttrs(1, 10, {{1, 11}, {2, 12}}));\n-    doc = f.makeDoc(20, {{42, 21}});\n-    f.update(11, *doc, 1, true);\n-    TEST_DO(f.checkAttrs(1, 10, {{42, 21}}));\n+    auto doc = makeDoc(10,  {{1, 11}, {2, 12}});\n+    put(10, *doc, 1);\n+    checkAttrs(1, 10, {{1, 11}, {2, 12}});\n+    doc = makeDoc(20, {{42, 21}});\n+    update(11, *doc, 1, true);\n+    checkAttrs(1, 10, {{42, 21}});\n }\n \n-TEST_MAIN()\n-{\n-    vespalib::rmdir(test_dir, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23f73971dc3e5ec8b1b6431837941e671603338"}, "originalPosition": 1084}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3dd8d14c4f28e02d32849ef2cdf9b2a8aaaf404", "author": {"user": {"login": "geirst", "name": "Geir Storli"}}, "url": "https://github.com/vespa-engine/vespa/commit/e3dd8d14c4f28e02d32849ef2cdf9b2a8aaaf404", "committedDate": "2020-06-10T19:56:49Z", "message": "Simplify."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3743, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}