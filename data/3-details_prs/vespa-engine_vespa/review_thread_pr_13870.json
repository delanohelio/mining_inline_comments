{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MTIzNjY4", "number": 13870, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozMTo0OFrOENxzeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozMTo0OFrOENxzeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyODgyOTM3OnYy", "diffSide": "RIGHT", "path": "searchcore/src/vespa/searchcore/proton/server/proton.cpp", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozMTo0OFrOGwkn2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzoyNjo1M1rOGwod-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng==", "bodyText": "We need to reset _customComponentRootToken and _customComponentBindToken first, as these have reference to a JsonHandlerRepo owned by the StateServer, and will access this when destructed.", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453584856", "createdAt": "2020-07-13T11:31:48Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/server/proton.cpp", "diffHunk": "@@ -462,6 +462,15 @@ Proton::~Proton()\n     LOG(debug, \"Explicit destructor done\");\n }\n \n+void\n+Proton::perform_pre_service_layer_shutdown_steps()\n+{\n+    _stateServer.reset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NjMzOA==", "bodyText": "In Proton::~Proton() we do _executor.sync(); before any of this. I am not sure if we need something similar here. @toregge can you comment on that?", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453586338", "createdAt": "2020-07-13T11:34:49Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/server/proton.cpp", "diffHunk": "@@ -462,6 +462,15 @@ Proton::~Proton()\n     LOG(debug, \"Explicit destructor done\");\n }\n \n+void\n+Proton::perform_pre_service_layer_shutdown_steps()\n+{\n+    _stateServer.reset();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng=="}, "originalCommit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU5NzI3MQ==", "bodyText": "That depends on what queued tasks can contain references to the structure being destroyed.  We should probably close the config fetcher, disable reconfig and sync the executor, to avoid new DocumentDB instances arriving after we've decided to take down the metrics manager\n.", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453597271", "createdAt": "2020-07-13T11:57:12Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/proton.cpp", "diffHunk": "@@ -462,6 +462,15 @@ Proton::~Proton()\n     LOG(debug, \"Explicit destructor done\");\n }\n \n+void\n+Proton::perform_pre_service_layer_shutdown_steps()\n+{\n+    _stateServer.reset();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng=="}, "originalCommit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0Nzg2NA==", "bodyText": "I have moved config, token, state server and metrics shutdown into a dedicated method. Explicit executor sync is done in both places. PTAL", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453647864", "createdAt": "2020-07-13T13:26:53Z", "author": {"login": "vekterli"}, "path": "searchcore/src/vespa/searchcore/proton/server/proton.cpp", "diffHunk": "@@ -462,6 +462,15 @@ Proton::~Proton()\n     LOG(debug, \"Explicit destructor done\");\n }\n \n+void\n+Proton::perform_pre_service_layer_shutdown_steps()\n+{\n+    _stateServer.reset();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng=="}, "originalCommit": {"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1809, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}