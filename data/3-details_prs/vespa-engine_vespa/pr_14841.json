{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMjMzNzUw", "number": 14841, "title": "Jonmv/async doc v1 take2", "bodyText": "@bjorncs please review.\nThis does not compile, as tests are broken. I'll start working on that now.\nI already thought of one missing thing: Jetty threads don't currently help in sending enqueued operations.", "createdAt": "2020-10-13T11:53:48Z", "url": "https://github.com/vespa-engine/vespa/pull/14841", "merged": true, "mergeCommit": {"oid": "8039539c2717ef46c58060533eab5019d1b2a72e"}, "closed": true, "closedAt": "2020-10-14T08:36:37Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSHL1YAH2gAyNTAyMjMzNzUwOmM0NThmY2QyYzJhMzViMTI5NzYzMTE1NDM5YmEzZDEzNTAyYjQwZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSZBNOgFqTUwODExODE3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c458fcd2c2a35b129763115439ba3d13502b40e0", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/c458fcd2c2a35b129763115439ba3d13502b40e0", "committedDate": "2020-10-13T11:50:08Z", "message": "Expose \"writeFields\" from JsonWriter, to write only document fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89098c7afddc62256d3b969c1fdc452e95360038", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/89098c7afddc62256d3b969c1fdc452e95360038", "committedDate": "2020-10-13T11:51:14Z", "message": "Take 2 of async /document/v1 handler \u2014\u00a0handler only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d1f722b835e2f844058bfffbca66f258129bff1", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/2d1f722b835e2f844058bfffbca66f258129bff1", "committedDate": "2020-10-13T12:01:33Z", "message": "Also do dispatch when enqueueing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3Mzc4NjE4", "url": "https://github.com/vespa-engine/vespa/pull/14841#pullrequestreview-507378618", "createdAt": "2020-10-13T12:29:06Z", "commit": {"oid": "2d1f722b835e2f844058bfffbca66f258129bff1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2931da13cbf55cb62ebc384d568914673f387bdf", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/2931da13cbf55cb62ebc384d568914673f387bdf", "committedDate": "2020-10-13T15:24:53Z", "message": "Support conditional removals in AsyncSession"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53e68ede523a33a6f7e87f991ee7c392ee3a088e", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/53e68ede523a33a6f7e87f991ee7c392ee3a088e", "committedDate": "2020-10-13T18:18:14Z", "message": "Tests, more config and various fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f57d5749b65972ea4f852ddcd24e5082e40254a1", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/f57d5749b65972ea4f852ddcd24e5082e40254a1", "committedDate": "2020-10-13T18:58:07Z", "message": "Remove unneeded threading in unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "320d24ac771ed013a3d4fc408b4ca77a0f294e02", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/320d24ac771ed013a3d4fc408b4ca77a0f294e02", "committedDate": "2020-10-14T07:15:43Z", "message": "Default to a single wanted document in visits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8959673839e959ff48d4ce1961888791ff4e4346", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/8959673839e959ff48d4ce1961888791ff4e4346", "committedDate": "2020-10-14T07:15:56Z", "message": "Be stricter about request property parsing (and test this)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b9d957056e74ef79f50fd441fa2ab75afe4ca28", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/8b9d957056e74ef79f50fd441fa2ab75afe4ca28", "committedDate": "2020-10-14T07:39:45Z", "message": "Use UPDATE when doing an update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78fa36414d239450a4e7da3919c74a16452bf52f", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/78fa36414d239450a4e7da3919c74a16452bf52f", "committedDate": "2020-10-14T08:21:57Z", "message": "Remove unused VisitorOptions class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTA5NDMx", "url": "https://github.com/vespa-engine/vespa/pull/14841#pullrequestreview-508109431", "createdAt": "2020-10-14T08:26:46Z", "commit": {"oid": "53e68ede523a33a6f7e87f991ee7c392ee3a088e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODoyNjo0N1rOHhH43Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODoyOTowMVrOHhH-uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ5NDMwMQ==", "bodyText": "enqueued might be positive even when the actual queue is empty (when multiple threads executes enqueueAndDispatch simultaneously.", "url": "https://github.com/vespa-engine/vespa/pull/14841#discussion_r504494301", "createdAt": "2020-10-14T08:26:47Z", "author": {"login": "bjorncs"}, "path": "vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/resource/DocumentV1ApiHandler.java", "diffHunk": "@@ -406,18 +409,14 @@ private void enqueueAndDispatch(HttpRequest request, ResponseHandler handler, Su\n             return;\n         }\n         Operation operation = Operation.lazilyParsed(request, handler, operationParser);\n-        if (enqueued.get() == 0 && operation.dispatch()) // Bypass queue if it is empty.\n+        if (enqueued.get() == 1 && operation.dispatch()) // Bypass queue if it is empty.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e68ede523a33a6f7e87f991ee7c392ee3a088e"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ5NTgwMw==", "bodyText": "We will probably want to control resender threads from ContainerThreadpool later on.", "url": "https://github.com/vespa-engine/vespa/pull/14841#discussion_r504495803", "createdAt": "2020-10-14T08:29:01Z", "author": {"login": "bjorncs"}, "path": "vespaclient-container-plugin/src/main/resources/configdefinitions/document-operation-executor.def", "diffHunk": "@@ -1,15 +1,15 @@\n # Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package=com.yahoo.document.restapi\n \n-# Delay before a throttled operation is retried.\n-resendDelayMillis     int default=100\n-\n-# Time between a document operation is received and a timeout response is sent\n-defaultTimeoutSeconds int default=180\n-\n-# Time after which a visitor session times out\n-visitTimeoutSeconds   int default=120\n+# Duration for which resender thread sleeps after an operation is throttled\n+resendDelayMillis     int default=10\n \n # Bound on number of document operations to keep in retry queue \u2014\u00a0further operations are rejected\n maxThrottled          int default=1000\n \n+# Whether to perform dispatch from Jetty threads\n+doDispatchWithEnqueue bool default=true\n+\n+# Number of workers in the resender thread pool\n+resenderCount         int default=1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e68ede523a33a6f7e87f991ee7c392ee3a088e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c430a9ed1a8afaeae4b96a7df18a056bfd13a437", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/c430a9ed1a8afaeae4b96a7df18a056bfd13a437", "committedDate": "2020-10-14T08:34:33Z", "message": "Simpifly enqueue-dispatch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTE4MTc5", "url": "https://github.com/vespa-engine/vespa/pull/14841#pullrequestreview-508118179", "createdAt": "2020-10-14T08:36:49Z", "commit": {"oid": "c430a9ed1a8afaeae4b96a7df18a056bfd13a437"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2361, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}