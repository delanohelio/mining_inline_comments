{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MjI5NzUx", "number": 14190, "title": "Move code from RemoteSession to SessionRepository", "bodyText": "Simplify and move in the direction of unifying remote and local sessions\nMove tests and avoid a lot of low-level setup code", "createdAt": "2020-08-28T07:14:39Z", "url": "https://github.com/vespa-engine/vespa/pull/14190", "merged": true, "mergeCommit": {"oid": "75d75ab1b8cc0e1d61603439582a7bd3be3847f1"}, "closed": true, "closedAt": "2020-08-31T05:11:57Z", "author": {"login": "hmusum"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDPp5mgH2gAyNDc1MjI5NzUxOmM0ZGM3YjM3MzA5ZDg3YTVjZDllZjEzODkxYTI5MTMyMTAxMDE3Yzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDS7DWAFqTQ3NzYzNzk3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/c4dc7b37309d87a5cd9ef13891a29132101017c9", "committedDate": "2020-08-28T07:13:21Z", "message": "Move code from RemoteSession to SessionRepository\n\nSimplify and move in the direction of unifying remote and local sessions\nMove tests and avoid a lot of lowe-level setup code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b632cd8e96793f8d6b99cef7be0aab9808ebff8", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/3b632cd8e96793f8d6b99cef7be0aab9808ebff8", "committedDate": "2020-08-28T08:32:05Z", "message": "Throw NotFoundException when active session not found"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjAwNDc3", "url": "https://github.com/vespa-engine/vespa/pull/14190#pullrequestreview-477600477", "createdAt": "2020-08-28T09:55:48Z", "commit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTo1NTo0OVrOHI3D8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTo1NTo0OVrOHI3D8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA1Mjc4Ng==", "bodyText": "Would like a name change here, to deactivated()", "url": "https://github.com/vespa-engine/vespa/pull/14190#discussion_r479052786", "createdAt": "2020-08-28T09:55:49Z", "author": {"login": "jonmv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/RemoteSession.java", "diffHunk": "@@ -26,95 +15,46 @@\n  */\n public class RemoteSession extends Session {\n \n-    private static final Logger log = Logger.getLogger(RemoteSession.class.getName());\n-    private ApplicationSet applicationSet = null;\n-    private final ActivatedModelsBuilder applicationLoader;\n-    private final Clock clock;\n+    private final Optional<ApplicationSet> applicationSet;\n \n     /**\n-     * Creates a session. This involves loading the application, validating it and distributing it.\n+     * Creates a remote session, no application set loaded\n      *\n      * @param tenant The name of the tenant creating session\n      * @param sessionId The session id for this session.\n-     * @param componentRegistry a registry of global components\n      * @param zooKeeperClient a SessionZooKeeperClient instance\n      */\n     public RemoteSession(TenantName tenant,\n                          long sessionId,\n-                         GlobalComponentRegistry componentRegistry,\n                          SessionZooKeeperClient zooKeeperClient) {\n-        super(tenant, sessionId, zooKeeperClient);\n-        this.applicationLoader = new ActivatedModelsBuilder(tenant, sessionId, zooKeeperClient, componentRegistry);\n-        this.clock = componentRegistry.getClock();\n-    }\n-\n-    void prepare() {\n-        Curator.CompletionWaiter waiter = sessionZooKeeperClient.getPrepareWaiter();\n-        ensureApplicationLoaded();\n-        notifyCompletion(waiter);\n+        this(tenant, sessionId, zooKeeperClient, Optional.empty());\n     }\n \n-    private ApplicationSet loadApplication() {\n-        ApplicationPackage applicationPackage = sessionZooKeeperClient.loadApplicationPackage();\n-\n-        // Read hosts allocated on the config server instance which created this\n-        Optional<AllocatedHosts> allocatedHosts = applicationPackage.getAllocatedHosts();\n-\n-        return ApplicationSet.fromList(applicationLoader.buildModels(getApplicationId(),\n-                                                                     sessionZooKeeperClient.readDockerImageRepository(),\n-                                                                     sessionZooKeeperClient.readVespaVersion(),\n-                                                                     applicationPackage,\n-                                                                     new SettableOptional<>(allocatedHosts),\n-                                                                     clock.instant()));\n+    /**\n+     * Creates a remote session, with application set\n+     *\n+     * @param tenant The name of the tenant creating session\n+     * @param sessionId The session id for this session.\n+     * @param zooKeeperClient a SessionZooKeeperClient instance\n+     */\n+    public RemoteSession(TenantName tenant,\n+                         long sessionId,\n+                         SessionZooKeeperClient zooKeeperClient,\n+                         Optional<ApplicationSet> applicationSet) {\n+        super(tenant, sessionId, zooKeeperClient);\n+        this.applicationSet = applicationSet;\n     }\n \n-    public synchronized ApplicationSet ensureApplicationLoaded() {\n-        return applicationSet == null ? applicationSet = loadApplication() : applicationSet;\n+    Optional<ApplicationSet> applicationSet() {\n+        return applicationSet;\n     }\n \n-    public synchronized void deactivate() {\n-        applicationSet = null;\n+    public synchronized RemoteSession deactivate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjAyNTk4", "url": "https://github.com/vespa-engine/vespa/pull/14190#pullrequestreview-477602598", "createdAt": "2020-08-28T09:59:08Z", "commit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTo1OTowOVrOHI3T_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTo1OTowOVrOHI3T_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA1Njg5NQ==", "bodyText": "addSession should perhaps also be named putSession?", "url": "https://github.com/vespa-engine/vespa/pull/14190#discussion_r479056895", "createdAt": "2020-08-28T09:59:09Z", "author": {"login": "jonmv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -275,13 +280,25 @@ public int deleteExpiredRemoteSessions(Clock clock, Duration expiryTime) {\n             if (session.getStatus() == Session.Status.ACTIVATE) continue;\n             if (sessionHasExpired(session.getCreateTime(), expiryTime, clock)) {\n                 log.log(Level.FINE, \"Remote session \" + sessionId + \" for \" + tenantName + \" has expired, deleting it\");\n-                session.delete();\n+                deleteSession(session);\n                 deleted++;\n             }\n         }\n         return deleted;\n     }\n \n+\n+    public void deactivate(RemoteSession remoteSession) {\n+        remoteSessionCache.addSession(remoteSession.deactivate());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjA0MjUz", "url": "https://github.com/vespa-engine/vespa/pull/14190#pullrequestreview-477604253", "createdAt": "2020-08-28T10:01:45Z", "commit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMDowMTo0NVrOHI3grQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMDowMTo0NVrOHI3grQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA2MDE0MQ==", "bodyText": "Shouldn't this also be deactivate(remoteSession)? This does nothing now.", "url": "https://github.com/vespa-engine/vespa/pull/14190#discussion_r479060141", "createdAt": "2020-08-28T10:01:45Z", "author": {"login": "jonmv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -358,27 +375,19 @@ void activate(RemoteSession session) {\n         long sessionId = session.getSessionId();\n         Curator.CompletionWaiter waiter = createSessionZooKeeperClient(sessionId).getActiveWaiter();\n         log.log(Level.FINE, () -> session.logPre() + \"Getting session from repo: \" + sessionId);\n-        ApplicationSet app = session.ensureApplicationLoaded();\n+        ApplicationSet app = ensureApplicationLoaded(session);\n         log.log(Level.FINE, () -> session.logPre() + \"Reloading config for \" + sessionId);\n         applicationRepo.reloadConfig(app);\n         log.log(Level.FINE, () -> session.logPre() + \"Notifying \" + waiter);\n-        session.notifyCompletion(waiter);\n+        notifyCompletion(waiter, session);\n         log.log(Level.INFO, session.logPre() + \"Session activated: \" + sessionId);\n     }\n \n-    public void deactivate(RemoteSession remoteSession) {\n-        remoteSession.deactivate();\n-    }\n-\n-    public void delete(RemoteSession remoteSession, Optional<LocalSession> localSession) {\n+    public void deleteSession(RemoteSession remoteSession, Optional<LocalSession> localSession) {\n         localSession.ifPresent(this::deleteLocalSession);\n         remoteSession.deactivate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjA3NDY4", "url": "https://github.com/vespa-engine/vespa/pull/14190#pullrequestreview-477607468", "createdAt": "2020-08-28T10:07:00Z", "commit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMDowNzowMFrOHI35vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMDowNzowMFrOHI35vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA2NjU1Nw==", "bodyText": "Why session.getSessionZooKeeperClient() here, and createSessionZooKeeperClient(session.getSessionId()) elsewhere?", "url": "https://github.com/vespa-engine/vespa/pull/14190#discussion_r479066557", "createdAt": "2020-08-28T10:07:00Z", "author": {"login": "jonmv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -394,13 +403,84 @@ private void loadSessionIfActive(RemoteSession session) {\n         for (ApplicationId applicationId : applicationRepo.activeApplications()) {\n             if (applicationRepo.requireActiveSessionOf(applicationId) == session.getSessionId()) {\n                 log.log(Level.FINE, () -> \"Found active application for session \" + session.getSessionId() + \" , loading it\");\n-                applicationRepo.reloadConfig(session.ensureApplicationLoaded());\n+                applicationRepo.reloadConfig(ensureApplicationLoaded(session));\n                 log.log(Level.INFO, session.logPre() + \"Application activated successfully: \" + applicationId + \" (generation \" + session.getSessionId() + \")\");\n                 return;\n             }\n         }\n     }\n \n+    void prepareRemoteSession(RemoteSession session) {\n+        SessionZooKeeperClient sessionZooKeeperClient = createSessionZooKeeperClient(session.getSessionId());\n+        Curator.CompletionWaiter waiter = sessionZooKeeperClient.getPrepareWaiter();\n+        ensureApplicationLoaded(session);\n+        notifyCompletion(waiter, session);\n+    }\n+\n+    public synchronized ApplicationSet ensureApplicationLoaded(RemoteSession session) {\n+        Optional<ApplicationSet> applicationSet = session.applicationSet();\n+        if (applicationSet.isPresent()) {\n+            return applicationSet.get();\n+        }\n+\n+        ApplicationSet newApplicationSet = loadApplication(session);\n+        RemoteSession newSession = new RemoteSession(session.getTenantName(),\n+                                    session.getSessionId(),\n+                                    session.getSessionZooKeeperClient(),\n+                                    Optional.of(newApplicationSet));\n+        remoteSessionCache.addSession(newSession);\n+        return newApplicationSet;\n+    }\n+\n+    void confirmUpload(RemoteSession session) {\n+        Curator.CompletionWaiter waiter = session.getSessionZooKeeperClient().getUploadWaiter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4dc7b37309d87a5cd9ef13891a29132101017c9"}, "originalPosition": 129}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjExNTkx", "url": "https://github.com/vespa-engine/vespa/pull/14190#pullrequestreview-477611591", "createdAt": "2020-08-28T10:13:34Z", "commit": {"oid": "3b632cd8e96793f8d6b99cef7be0aab9808ebff8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96a55f7d48380e4e42c7383baa2eacf15ec973e4", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/96a55f7d48380e4e42c7383baa2eacf15ec973e4", "committedDate": "2020-08-28T10:58:22Z", "message": "Changes after code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjM3OTcy", "url": "https://github.com/vespa-engine/vespa/pull/14190#pullrequestreview-477637972", "createdAt": "2020-08-28T11:01:48Z", "commit": {"oid": "96a55f7d48380e4e42c7383baa2eacf15ec973e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4344, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}