{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNzc3OTc5", "number": 12361, "title": "Only get list of nodes when actually needed", "bodyText": "Use a supplier and get list of nodes only when needed (when wanting to retire\na node). This should improve performance for all other patch requests.", "createdAt": "2020-02-27T11:04:45Z", "url": "https://github.com/vespa-engine/vespa/pull/12361", "merged": true, "mergeCommit": {"oid": "1d002116992cdc80c2bf2235c46dfa11ef48b256"}, "closed": true, "closedAt": "2020-02-27T23:01:20Z", "author": {"login": "hmusum"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIZQsMAH2gAyMzgwNzc3OTc5OmM2ZGQ5ZWU2M2E5OTc5ZmFhYzkxZGIxNmQ3YTliZjI3ZmE2NWEwZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIjhYggFqTM2NjA2MDQ1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c6dd9ee63a9979faac91db16d7a9bf27fa65a0d4", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/c6dd9ee63a9979faac91db16d7a9bf27fa65a0d4", "committedDate": "2020-02-27T11:03:20Z", "message": "Only get list of nodes when actually needed\n\nUse a supplier and get list of nodes only when needed (when wanting to retire\na node). This should improve performance for all other patch requests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa97b892603f76ab45c5d03c6e62b6d6bdacdf53", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/fa97b892603f76ab45c5d03c6e62b6d6bdacdf53", "committedDate": "2020-02-27T13:13:20Z", "message": "Merge branch 'master' into hmusum/get-all-nodes-only-when-needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae06cc33e932ce132867744eab058eb8fddea25d", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/ae06cc33e932ce132867744eab058eb8fddea25d", "committedDate": "2020-02-27T17:23:28Z", "message": "Add node from request last"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDU2NjQ1", "url": "https://github.com/vespa-engine/vespa/pull/12361#pullrequestreview-366056645", "createdAt": "2020-02-27T22:51:46Z", "commit": {"oid": "ae06cc33e932ce132867744eab058eb8fddea25d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDYwNDU4", "url": "https://github.com/vespa-engine/vespa/pull/12361#pullrequestreview-366060458", "createdAt": "2020-02-27T23:00:36Z", "commit": {"oid": "ae06cc33e932ce132867744eab058eb8fddea25d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMzowMDozNlrOFvkM9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMzowMDozNlrOFvkM9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyMDUzNQ==", "bodyText": "If more than one of WANT_TO_RETIRE, ipAddresses, additionalIpAddresses are specified in the patch request, then this PR will invoke nodeRepository.list(lock) that many times. This happens e.g. on provisioning, when the last two are specified. At the risk of making this much more convoluted, consider listing at most once.", "url": "https://github.com/vespa-engine/vespa/pull/12361#discussion_r385420535", "createdAt": "2020-02-27T23:00:36Z", "author": {"login": "hakonhall"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/restapi/v2/NodePatcher.java", "diffHunk": "@@ -133,9 +130,9 @@ private Node applyField(Node node, String name, Inspector value) {\n             case \"parentHostname\" :\n                 return node.withParentHostname(asString(value));\n             case \"ipAddresses\" :\n-                return IP.Config.verify(node.with(node.ipConfig().with(asStringSet(value))), nodes);\n+                return IP.Config.verify(node.with(node.ipConfig().with(asStringSet(value))), nodes.get());\n             case \"additionalIpAddresses\" :\n-                return IP.Config.verify(node.with(node.ipConfig().with(IP.Pool.of(asStringSet(value)))), nodes);\n+                return IP.Config.verify(node.with(node.ipConfig().with(IP.Pool.of(asStringSet(value)))), nodes.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae06cc33e932ce132867744eab058eb8fddea25d"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2826, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}