{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMzM1MTc2", "number": 15826, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjozMjoxMFrOFFr6xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0Nzo1OFrOFFsc-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNTA2NzU4OnYy", "diffSide": "RIGHT", "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjozMjoxMFrOIGUb6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0OTozM1rOIGVTUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5NzE5NQ==", "bodyText": "Isn't there also a 50s timeout on shutdown, somewhere further up?", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543497195", "createdAt": "2020-12-15T16:32:10Z", "author": {"login": "jonmv"}, "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "diffHunk": "@@ -61,9 +81,24 @@ public void deconstruct(List<Object> components, Collection<Bundle> bundles) {\n                 ((SharedResource) component).release();\n             }\n         }\n-        if (! destructibleComponents.isEmpty() || ! bundles.isEmpty())\n-            executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n+        if (!destructibleComponents.isEmpty() || !bundles.isEmpty()) {\n+            var task = executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n                               delay.getSeconds(), TimeUnit.SECONDS);\n+            if (mode.equals(Mode.SHUTDOWN)) {\n+                // Wait for deconstruction to finish\n+                try {\n+                    log.info(\"Waiting up to \" + SHUTDOWN_DECONSTRUCT_TIMEOUT.toSeconds() + \" seconds for all components to deconstruct.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUwNTIyOQ==", "bodyText": "Yes, you're right. That seems a bit harsh. Perhaps we should increase the \"shutdownDeadlineExecutor\" to at least 90 sec, and set this one to 80? I don't know the background for that. Maybe it's to ensure shutdown within a reasonable amount of time. What do you think about 45 seconds? In normal use cases, that's probably plenty.", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543505229", "createdAt": "2020-12-15T16:42:06Z", "author": {"login": "gjoranv"}, "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "diffHunk": "@@ -61,9 +81,24 @@ public void deconstruct(List<Object> components, Collection<Bundle> bundles) {\n                 ((SharedResource) component).release();\n             }\n         }\n-        if (! destructibleComponents.isEmpty() || ! bundles.isEmpty())\n-            executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n+        if (!destructibleComponents.isEmpty() || !bundles.isEmpty()) {\n+            var task = executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n                               delay.getSeconds(), TimeUnit.SECONDS);\n+            if (mode.equals(Mode.SHUTDOWN)) {\n+                // Wait for deconstruction to finish\n+                try {\n+                    log.info(\"Waiting up to \" + SHUTDOWN_DECONSTRUCT_TIMEOUT.toSeconds() + \" seconds for all components to deconstruct.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5NzE5NQ=="}, "originalCommit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTM3OA==", "bodyText": "I think 45s is good!", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543511378", "createdAt": "2020-12-15T16:49:33Z", "author": {"login": "jonmv"}, "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "diffHunk": "@@ -61,9 +81,24 @@ public void deconstruct(List<Object> components, Collection<Bundle> bundles) {\n                 ((SharedResource) component).release();\n             }\n         }\n-        if (! destructibleComponents.isEmpty() || ! bundles.isEmpty())\n-            executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n+        if (!destructibleComponents.isEmpty() || !bundles.isEmpty()) {\n+            var task = executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n                               delay.getSeconds(), TimeUnit.SECONDS);\n+            if (mode.equals(Mode.SHUTDOWN)) {\n+                // Wait for deconstruction to finish\n+                try {\n+                    log.info(\"Waiting up to \" + SHUTDOWN_DECONSTRUCT_TIMEOUT.toSeconds() + \" seconds for all components to deconstruct.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5NzE5NQ=="}, "originalCommit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNTE1NTEzOnYy", "diffSide": "RIGHT", "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0Nzo1OFrOIGVOrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0Nzo1OFrOIGVOrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMDE5MQ==", "bodyText": "Yes, was made visible for testing. All tests can use the synchronous shutdown instead :)", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543510191", "createdAt": "2020-12-15T16:47:58Z", "author": {"login": "jonmv"}, "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "diffHunk": "@@ -35,13 +39,29 @@\n \n     private static final Logger log = Logger.getLogger(Deconstructor.class.getName());\n \n+    private static final Duration SHUTDOWN_DECONSTRUCT_TIMEOUT = Duration.ofMinutes(10);\n+\n+    public enum Mode {\n+        RECONFIG,  // Delay deconstruction to allow old components to finish processing in-flight requests.\n+        SHUTDOWN   // The container is shutting down. Start deconstructing immediately, and wait until all components\n+                   // are deconstructed, to prevent shutting down while deconstruct is in progress.\n+    }\n+\n+    // TODO: make private again", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2056, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}