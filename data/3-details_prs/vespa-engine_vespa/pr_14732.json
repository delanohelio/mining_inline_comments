{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4Mzg4Nzcx", "number": 14732, "title": "Reuse document meta store state from prepare step", "bodyText": "@baldersheim : please review", "createdAt": "2020-10-06T09:12:37Z", "url": "https://github.com/vespa-engine/vespa/pull/14732", "merged": true, "mergeCommit": {"oid": "5550544fe2c4950cad3141c71239435d3ff813fb"}, "closed": true, "closedAt": "2020-10-06T11:32:34Z", "author": {"login": "toregge"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP0tFAAH2gAyNDk4Mzg4NzcxOjQzY2Y1OGQyNDQ3MGUzYzBjYzg1ZWM0M2EzYmY4ZjMxNGNkMjljOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP4G2gAFqTUwMjkyMTk5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "43cf58d24470e3c0cc85ec43a3bf8f314cd29c99", "author": {"user": null}, "url": "https://github.com/vespa-engine/vespa/commit/43cf58d24470e3c0cc85ec43a3bf8f314cd29c99", "committedDate": "2020-10-06T09:10:24Z", "message": "Reuse document meta store state from prepare step instead of doing\na new lookup in btree mapping from gid to lid during live feed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyODEyNDMy", "url": "https://github.com/vespa-engine/vespa/pull/14732#pullrequestreview-502812432", "createdAt": "2020-10-06T10:50:08Z", "commit": {"oid": "43cf58d24470e3c0cc85ec43a3bf8f314cd29c99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMDo1MDowOFrOHdAlrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMDo1MDowOFrOHdAlrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MDM5OQ==", "bodyText": "Do you need this when you are using uint64_t instead of SerialNum", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500180399", "createdAt": "2020-10-06T10:50:08Z", "author": {"login": "baldersheim"}, "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/i_store.h", "diffHunk": "@@ -6,6 +6,7 @@\n #include <vespa/document/base/globalid.h>\n #include <vespa/document/bucket/bucketid.h>\n #include <persistence/spi/types.h>\n+#include <vespa/searchlib/common/serialnum.h>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43cf58d24470e3c0cc85ec43a3bf8f314cd29c99"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3858a5faffad96ef4a255afb96d344dc7ab426d7", "author": {"user": null}, "url": "https://github.com/vespa-engine/vespa/commit/3858a5faffad96ef4a255afb96d344dc7ab426d7", "committedDate": "2020-10-06T10:56:39Z", "message": "Remove unneeded include."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyODIxMjk0", "url": "https://github.com/vespa-engine/vespa/pull/14732#pullrequestreview-502821294", "createdAt": "2020-10-06T11:02:03Z", "commit": {"oid": "43cf58d24470e3c0cc85ec43a3bf8f314cd29c99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMTowMjowM1rOHdA_Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMTowMjowM1rOHdA_Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4NjkyMw==", "bodyText": "Wait with takeGuard untial after validLid check ?", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500186923", "createdAt": "2020-10-06T11:02:03Z", "author": {"login": "baldersheim"}, "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/documentmetastore.cpp", "diffHunk": "@@ -536,40 +538,44 @@ DocumentMetaStore::updateMetaData(DocId lid,\n     return true;\n }\n \n-bool\n-DocumentMetaStore::remove(DocId lid, BucketDBOwner::Guard &bucketGuard)\n+void\n+DocumentMetaStore::remove(DocId lid, uint64_t prepare_serial_num, BucketDBOwner::Guard &bucketGuard)\n {\n-    if (!validLid(lid)) {\n-        return false;\n-    }\n     const GlobalId & gid = getRawGid(lid);\n     KeyComp comp(gid, _metaDataStore, *_gidCompare);\n-    if (!_gidToLidMap.remove(lid, comp)) {\n+    auto& itr = _gid_to_lid_map_write_itr;\n+    if (prepare_serial_num == 0u || _gid_to_lid_map_write_itr_prepare_serial_num != prepare_serial_num) {\n+        itr.lower_bound(_gidToLidMap.getRoot(), lid, comp);\n+    }\n+    if (!itr.valid() || comp(lid, itr.getKey())) {\n         throw IllegalStateException(make_string(\n                         \"document meta data store corrupted,\"\n                         \" cannot remove\"\n                         \" document with lid '%u' and gid '%s'\",\n                         lid, gid.toString().c_str()));\n     }\n+    _gidToLidMap.remove(itr);\n     _lidAlloc.unregisterLid(lid);\n     RawDocumentMetaData &oldMetaData = _metaDataStore[lid];\n     bucketGuard->remove(oldMetaData.getGid(),\n                         oldMetaData.getBucketId().stripUnused(),\n                         oldMetaData.getTimestamp(), oldMetaData.getDocSize(),\n                         _subDbType);\n-    return true;\n }\n \n bool\n-DocumentMetaStore::remove(DocId lid)\n+DocumentMetaStore::remove(DocId lid, uint64_t prepare_serial_num)\n {\n     BucketDBOwner::Guard bucketGuard = _bucketDB->takeGuard();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43cf58d24470e3c0cc85ec43a3bf8f314cd29c99"}, "originalPosition": 159}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fa42f01249386655f6018184b5b4e562e9af81a", "author": {"user": null}, "url": "https://github.com/vespa-engine/vespa/commit/9fa42f01249386655f6018184b5b4e562e9af81a", "committedDate": "2020-10-06T11:07:47Z", "message": "Take bucket guard after having passed validLid() check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyOTIxOTk0", "url": "https://github.com/vespa-engine/vespa/pull/14732#pullrequestreview-502921994", "createdAt": "2020-10-06T13:07:26Z", "commit": {"oid": "9fa42f01249386655f6018184b5b4e562e9af81a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzowNzoyNlrOHdFdmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzowODowMlrOHdFfMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MDI1MA==", "bodyText": "Consider adding a helper function for this, e.g. update_gid_to_lid_map_write_itr(prepare_serial_num). Same check is used in three places.", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500260250", "createdAt": "2020-10-06T13:07:26Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/documentmetastore.cpp", "diffHunk": "@@ -462,20 +462,23 @@ DocumentMetaStore::put(const GlobalId &gid,\n                        const BucketId &bucketId,\n                        const Timestamp &timestamp,\n                        uint32_t docSize,\n-                       DocId lid)\n+                       DocId lid,\n+                       uint64_t prepare_serial_num)\n {\n     Result res;\n     RawDocumentMetaData metaData(gid, bucketId, timestamp, docSize);\n     KeyComp comp(metaData, _metaDataStore, *_gidCompare);\n-    TreeType::Iterator itr = _gidToLidMap.lowerBound(KeyComp::FIND_DOC_ID,\n-            comp);\n+    auto& itr = _gid_to_lid_map_write_itr;\n+    if (prepare_serial_num == 0u || _gid_to_lid_map_write_itr_prepare_serial_num != prepare_serial_num) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fa42f01249386655f6018184b5b4e562e9af81a"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MDY1Ng==", "bodyText": "Consider adding a comment on how this serial num relates to _gid_to_lid_map_write_itr.", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500260656", "createdAt": "2020-10-06T13:08:02Z", "author": {"login": "geirst"}, "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/documentmetastore.h", "diffHunk": "@@ -68,6 +68,8 @@ class DocumentMetaStore final : public DocumentMetaStoreAttribute,\n \n     MetaDataStore       _metaDataStore;\n     TreeType            _gidToLidMap;\n+    Iterator            _gid_to_lid_map_write_itr; // Iterator used for all updates of _gidToLidMap\n+    SerialNum           _gid_to_lid_map_write_itr_prepare_serial_num;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fa42f01249386655f6018184b5b4e562e9af81a"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2444, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}