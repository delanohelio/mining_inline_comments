{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NDIwNzU3", "number": 12199, "title": "Added Telegraf component", "bodyText": "Based on the config file defined in #12164", "createdAt": "2020-02-14T14:39:57Z", "url": "https://github.com/vespa-engine/vespa/pull/12199", "merged": true, "mergeCommit": {"oid": "0d75af12ebee18203e176cbdfa98a8c10fffca66"}, "closed": true, "closedAt": "2020-02-20T10:56:35Z", "author": {"login": "olaaun"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcESfgYgFqTM1OTA3MjY3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGI9DIgFqTM2MTgwNzkyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MDcyNjc3", "url": "https://github.com/vespa-engine/vespa/pull/12199#pullrequestreview-359072677", "createdAt": "2020-02-14T16:40:51Z", "commit": {"oid": "01f6bc47ffa13fff4b4255a7ab9d3e3c12c794c7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjo0MDo1MVrOFp8xpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjo1NDowNlrOFp9MeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUzMTY4Ng==", "bodyText": "Please skip explicit compile scope, it is the default.", "url": "https://github.com/vespa-engine/vespa/pull/12199#discussion_r379531686", "createdAt": "2020-02-14T16:40:51Z", "author": {"login": "gjoranv"}, "path": "metrics-proxy/pom.xml", "diffHunk": "@@ -132,6 +132,11 @@\n       <groupId>org.apache.httpcomponents</groupId>\n       <artifactId>httpclient</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.velocity</groupId>\n+      <artifactId>velocity</artifactId>\n+      <scope>compile</scope>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f6bc47ffa13fff4b4255a7ab9d3e3c12c794c7"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUzNzY2Nw==", "bodyText": "This should only be output if the profile is non-empty in the config. Is that implicitly being taken care of?", "url": "https://github.com/vespa-engine/vespa/pull/12199#discussion_r379537667", "createdAt": "2020-02-14T16:52:18Z", "author": {"login": "gjoranv"}, "path": "metrics-proxy/src/main/resources/templates/cloudwatch_plugin.vm", "diffHunk": "@@ -0,0 +1,30 @@\n+# Configuration for telegraf agent\n+[agent]\n+  interval = \"${intervalSeconds}s\"\n+  round_interval = true\n+  metric_batch_size = 1000\n+  metric_buffer_limit = 10000\n+  collection_jitter = \"0s\"\n+  flush_interval = \"${intervalSeconds}s\"\n+  flush_jitter = \"0s\"\n+  precision = \"\"\n+\n+# Configuration for AWS CloudWatch output.\n+[[outputs.cloudwatch]]\n+  region = \"$cloudwatchRegion\"\n+  namespace = \"$cloudwatchNamespace\"\n+#if( $isHosted )\n+  access_key = \"$cloudwatchSecretKey\"\n+  secret_key = \"$cloudwatchAccessKey\"\n+#else\n+  profile = \"$cloudwatchProfile\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f6bc47ffa13fff4b4255a7ab9d3e3c12c794c7"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUzNzc4Mw==", "bodyText": "Please add trailing newline.", "url": "https://github.com/vespa-engine/vespa/pull/12199#discussion_r379537783", "createdAt": "2020-02-14T16:52:32Z", "author": {"login": "gjoranv"}, "path": "metrics-proxy/src/main/resources/templates/cloudwatch_plugin.vm", "diffHunk": "@@ -0,0 +1,30 @@\n+# Configuration for telegraf agent\n+[agent]\n+  interval = \"${intervalSeconds}s\"\n+  round_interval = true\n+  metric_batch_size = 1000\n+  metric_buffer_limit = 10000\n+  collection_jitter = \"0s\"\n+  flush_interval = \"${intervalSeconds}s\"\n+  flush_jitter = \"0s\"\n+  precision = \"\"\n+\n+# Configuration for AWS CloudWatch output.\n+[[outputs.cloudwatch]]\n+  region = \"$cloudwatchRegion\"\n+  namespace = \"$cloudwatchNamespace\"\n+#if( $isHosted )\n+  access_key = \"$cloudwatchSecretKey\"\n+  secret_key = \"$cloudwatchAccessKey\"\n+#else\n+  profile = \"$cloudwatchProfile\"\n+#end\n+\n+# Configuration for Vespa input plugin\n+[[inputs.vespa]]\n+  url = \"http://localhost:19092/metrics/v2/values?consumer=$vespaConsumer\"\n+#if( $isHosted )\n+  tls_cert = \"${VESPA_CERTIFICATE_PATH}\"\n+  tls_key = \"${VESPA_KEY_PATH}\"\n+  insecure_skip_verify = true\n+#end", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f6bc47ffa13fff4b4255a7ab9d3e3c12c794c7"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUzODU1Mw==", "bodyText": "We probably need to consider these file paths, especially where to read the template path from.", "url": "https://github.com/vespa-engine/vespa/pull/12199#discussion_r379538553", "createdAt": "2020-02-14T16:54:06Z", "author": {"login": "gjoranv"}, "path": "metrics-proxy/src/main/java/ai/vespa/metricsproxy/telegraf/Telegraf.java", "diffHunk": "@@ -0,0 +1,77 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package ai.vespa.metricsproxy.telegraf;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.system.execution.ProcessExecutor;\n+import org.apache.velocity.Template;\n+import org.apache.velocity.VelocityContext;\n+import org.apache.velocity.app.VelocityEngine;\n+\n+import java.io.FileWriter;\n+\n+import static com.yahoo.yolean.Exceptions.uncheck;\n+\n+/**\n+ * @author olaa\n+ */\n+public class Telegraf extends AbstractComponent {\n+\n+    private static final String TELEGRAF_CONFIG_PATH = \"/etc/telegraf/telegraf.conf\";\n+    private static final String TELEGRAF_CONFIG_TEMPLATE_PATH = \"src/main/resources/templates/cloudwatch_plugin.vm\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f6bc47ffa13fff4b4255a7ab9d3e3c12c794c7"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTA0MjI2", "url": "https://github.com/vespa-engine/vespa/pull/12199#pullrequestreview-359104226", "createdAt": "2020-02-14T17:32:15Z", "commit": {"oid": "01f6bc47ffa13fff4b4255a7ab9d3e3c12c794c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNzozMjoxNVrOFp-PFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNzozMjoxNVrOFp-PFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1NTYwNw==", "bodyText": "Please add an exclude for this artifact in config-model/pom.xml's dependency on metrics-proxy. It adds an extra 0.5 MB.", "url": "https://github.com/vespa-engine/vespa/pull/12199#discussion_r379555607", "createdAt": "2020-02-14T17:32:15Z", "author": {"login": "gjoranv"}, "path": "metrics-proxy/pom.xml", "diffHunk": "@@ -132,6 +132,11 @@\n       <groupId>org.apache.httpcomponents</groupId>\n       <artifactId>httpclient</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.velocity</groupId>\n+      <artifactId>velocity</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f6bc47ffa13fff4b4255a7ab9d3e3c12c794c7"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39039b1213ecc71c19db67d84802050a5958c107", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/39039b1213ecc71c19db67d84802050a5958c107", "committedDate": "2020-02-17T13:42:56Z", "message": "Added test"}, "afterCommit": {"oid": "83c0f76f3aa0de1d76bd3cca661cfbb15899ebcb", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/83c0f76f3aa0de1d76bd3cca661cfbb15899ebcb", "committedDate": "2020-02-17T13:45:29Z", "message": "Added test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f119796b599173a8c92930575c87924d81f05e2", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/6f119796b599173a8c92930575c87924d81f05e2", "committedDate": "2020-02-20T10:09:59Z", "message": "Added Telegraf component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee4be19769784b0e27efb77012f14e38a8ca986b", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/ee4be19769784b0e27efb77012f14e38a8ca986b", "committedDate": "2020-02-20T10:09:59Z", "message": "Consider if cloudwatch profile is set. Removed compile specification in pom."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f37fde7714ca78c80f3eb584936065d07ab8ec75", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/f37fde7714ca78c80f3eb584936065d07ab8ec75", "committedDate": "2020-02-20T10:09:59Z", "message": "Exclude velocity artifact in config-model/pom.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd8303e31d6d3cc5c6c474a4449d77733998f6b", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/2fd8303e31d6d3cc5c6c474a4449d77733998f6b", "committedDate": "2020-02-20T10:09:59Z", "message": "Support configuring an arbitrary number of Cloudwatch plugins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e49ef934d2043b816f7a7547de017ef096ca74", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/20e49ef934d2043b816f7a7547de017ef096ca74", "committedDate": "2020-02-20T10:09:59Z", "message": "Added test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53e7bf587a974dd538b47fd87d0d578bcb18346b", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/53e7bf587a974dd538b47fd87d0d578bcb18346b", "committedDate": "2020-02-20T10:09:59Z", "message": "Load template using ClasspathResourceLoader. Renamed template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919450ac3928cbc8b2d8aa0be8f0ed85c7bf9b68", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/919450ac3928cbc8b2d8aa0be8f0ed85c7bf9b68", "committedDate": "2020-02-20T10:09:59Z", "message": "Map input plugins to appropriate output plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8123ab32e26c732302e3909757e0339d579576cb", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/8123ab32e26c732302e3909757e0339d579576cb", "committedDate": "2020-02-20T10:09:59Z", "message": "Evaluate template directly in Velocity engine. Read template using InputStreamReader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d05cb357065e5f743017775d6a027e310a8a1285", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/d05cb357065e5f743017775d6a027e310a8a1285", "committedDate": "2020-02-19T17:20:30Z", "message": "Evaluate template directly in Velocity engine. Read template using InputStreamReader"}, "afterCommit": {"oid": "8123ab32e26c732302e3909757e0339d579576cb", "author": {"user": {"login": "olaaun", "name": "Ola Aunr\u00f8nning"}}, "url": "https://github.com/vespa-engine/vespa/commit/8123ab32e26c732302e3909757e0339d579576cb", "committedDate": "2020-02-20T10:09:59Z", "message": "Evaluate template directly in Velocity engine. Read template using InputStreamReader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxODA3OTI2", "url": "https://github.com/vespa-engine/vespa/pull/12199#pullrequestreview-361807926", "createdAt": "2020-02-20T10:55:33Z", "commit": {"oid": "8123ab32e26c732302e3909757e0339d579576cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2997, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}