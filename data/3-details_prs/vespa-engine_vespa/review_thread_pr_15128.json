{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMzMzMDU0", "number": 15128, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyMjo1OVrOEz_oDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyODo1N1rOEz_qeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyOTU1Mjc2OnYy", "diffSide": "RIGHT", "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyMjo1OVrOHrjdXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxNTo0NjoxNVrOHroNfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTc3Mg==", "bodyText": "Consider adding braces to fix style here.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515431772", "createdAt": "2020-10-31T00:22:59Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "diffHunk": "@@ -125,14 +125,15 @@ BucketMoveJob::moveDocuments(DocumentBucketMover &mover,\n         bucketGuard = _frozenBuckets.acquireExclusiveBucket(mover.getBucket());\n         if (! bucketGuard) {\n             maybeDelayMover(mover, mover.getBucket());\n-            return;\n+            return true;\n         }\n     }\n     assert(mover.getBucket() == bucketGuard->getBucket());\n-    mover.moveDocuments(maxDocsToMove);\n+    if ( ! mover.moveDocuments(maxDocsToMove)) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTYyOQ==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509629", "createdAt": "2020-10-31T15:46:15Z", "author": {"login": "baldersheim"}, "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "diffHunk": "@@ -125,14 +125,15 @@ BucketMoveJob::moveDocuments(DocumentBucketMover &mover,\n         bucketGuard = _frozenBuckets.acquireExclusiveBucket(mover.getBucket());\n         if (! bucketGuard) {\n             maybeDelayMover(mover, mover.getBucket());\n-            return;\n+            return true;\n         }\n     }\n     assert(mover.getBucket() == bucketGuard->getBucket());\n-    mover.moveDocuments(maxDocsToMove);\n+    if ( ! mover.moveDocuments(maxDocsToMove)) return false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTc3Mg=="}, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyOTU1NDExOnYy", "diffSide": "RIGHT", "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyNDoxNlrOHrjeDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxNTo0NjoyNFrOHroNig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTk1MA==", "bodyText": "Consider adding braces to fix style.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515431950", "createdAt": "2020-10-31T00:24:16Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "diffHunk": "@@ -334,7 +335,10 @@ BucketMoveJob::run()\n     if (isBlocked()) {\n         return true; // indicate work is done, since node state is bad\n     }\n-    scanAndMove(200, 1);\n+    /// Returning false here will immediately post the job back on the executor. This will give a busy loop,\n+    /// but this is considered fine as it is very rare and it will be intermingled with multiple feed operations.\n+    if ( ! scanAndMove(200, 1) ) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTY0Mg==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509642", "createdAt": "2020-10-31T15:46:24Z", "author": {"login": "baldersheim"}, "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "diffHunk": "@@ -334,7 +335,10 @@ BucketMoveJob::run()\n     if (isBlocked()) {\n         return true; // indicate work is done, since node state is bad\n     }\n-    scanAndMove(200, 1);\n+    /// Returning false here will immediately post the job back on the executor. This will give a busy loop,\n+    /// but this is considered fine as it is very rare and it will be intermingled with multiple feed operations.\n+    if ( ! scanAndMove(200, 1) ) return false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTk1MA=="}, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyOTU1NTc2OnYy", "diffSide": "RIGHT", "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyNTozMFrOHrje6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxNTo0Njo0MlrOHroNoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjE2OQ==", "bodyText": "Consider adding braces to fix style.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432169", "createdAt": "2020-10-31T00:25:30Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "diffHunk": "@@ -19,14 +19,15 @@ namespace proton {\n \n typedef IDocumentMetaStore::Iterator Iterator;\n \n-void\n+bool\n DocumentBucketMover::moveDocument(DocumentIdT lid,\n                                   const document::GlobalId &gid,\n                                   Timestamp timestamp)\n {\n-    Document::SP doc(_source->retriever()->getFullDocument(lid).release());\n+    if ( _source->lidNeedsCommit(lid) ) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTY2NQ==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509665", "createdAt": "2020-10-31T15:46:42Z", "author": {"login": "baldersheim"}, "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "diffHunk": "@@ -19,14 +19,15 @@ namespace proton {\n \n typedef IDocumentMetaStore::Iterator Iterator;\n \n-void\n+bool\n DocumentBucketMover::moveDocument(DocumentIdT lid,\n                                   const document::GlobalId &gid,\n                                   Timestamp timestamp)\n {\n-    Document::SP doc(_source->retriever()->getFullDocument(lid).release());\n+    if ( _source->lidNeedsCommit(lid) ) return false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjE2OQ=="}, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyOTU1NjU3OnYy", "diffSide": "RIGHT", "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyNjoxMlrOHrjfVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxNTo0Njo1MFrOHroNrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjI3Nw==", "bodyText": "Consider adding braces to fix style.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432277", "createdAt": "2020-10-31T00:26:12Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "diffHunk": "@@ -131,8 +134,9 @@ DocumentBucketMover::moveDocuments(size_t maxDocsToMove)\n         setBucketDone();\n     }\n     for (const MoveKey & key : toMove) {\n-        moveDocument(key._lid, key._gid, key._timestamp);\n+        if ( ! moveDocument(key._lid, key._gid, key._timestamp)) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTY3OA==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509678", "createdAt": "2020-10-31T15:46:50Z", "author": {"login": "baldersheim"}, "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "diffHunk": "@@ -131,8 +134,9 @@ DocumentBucketMover::moveDocuments(size_t maxDocsToMove)\n         setBucketDone();\n     }\n     for (const MoveKey & key : toMove) {\n-        moveDocument(key._lid, key._gid, key._timestamp);\n+        if ( ! moveDocument(key._lid, key._gid, key._timestamp)) return false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjI3Nw=="}, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyOTU1ODk3OnYy", "diffSide": "RIGHT", "path": "searchcore/src/vespa/searchcore/proton/server/maintenancedocumentsubdb.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyODo1N1rOHrjgqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxNTo0Njo1OFrOHroNwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjYxOA==", "bodyText": "Consider adding != nullptr for a more standard style with pointer checks.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432618", "createdAt": "2020-10-31T00:28:57Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/maintenancedocumentsubdb.cpp", "diffHunk": "@@ -38,4 +41,10 @@ MaintenanceDocumentSubDB::clear()\n     _feed_view.reset();\n }\n \n+bool\n+MaintenanceDocumentSubDB::lidNeedsCommit(search::DocumentIdT lid) const {\n+    return (_pendingLidsForCommit &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTY5OA==", "bodyText": "Fixed", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509698", "createdAt": "2020-10-31T15:46:58Z", "author": {"login": "baldersheim"}, "path": "searchcore/src/vespa/searchcore/proton/server/maintenancedocumentsubdb.cpp", "diffHunk": "@@ -38,4 +41,10 @@ MaintenanceDocumentSubDB::clear()\n     _feed_view.reset();\n }\n \n+bool\n+MaintenanceDocumentSubDB::lidNeedsCommit(search::DocumentIdT lid) const {\n+    return (_pendingLidsForCommit &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjYxOA=="}, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 949, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}