{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1MDk2Mjcx", "number": 12750, "title": "Bratseth/autoscaling ranges 3", "bodyText": "This enables applications to activate autoscaling", "createdAt": "2020-03-28T13:31:01Z", "url": "https://github.com/vespa-engine/vespa/pull/12750", "merged": true, "mergeCommit": {"oid": "4ef6cadb0acb3b78f4bc44b48e242e71eb682121"}, "closed": true, "closedAt": "2020-03-28T15:47:08Z", "author": {"login": "bratseth"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRvaZfAH2gAyMzk1MDk2MjcxOmJjYWY3NGNjN2NkZGQyNmYzMTVlYTljNjBjZWI4YTVmOWI2NjUxNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSHSgUAH2gAyMzk1MDk2MjcxOjBmYzNhNTE2ODk0NzU0OTdiNjA5NTI0NDU5YzAxMTUyYTExZWE0NDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168", "committedDate": "2020-03-27T11:57:10Z", "message": "Maintain application min, max and target resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b18e2939b6632e7bf02cc12dea096dabecb9e754", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/b18e2939b6632e7bf02cc12dea096dabecb9e754", "committedDate": "2020-03-27T14:02:03Z", "message": "Activate autoscaling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3124be24e2419dbd17ae448b4cd8203e22278fea", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/3124be24e2419dbd17ae448b4cd8203e22278fea", "committedDate": "2020-03-28T12:32:18Z", "message": "Respect node resource limits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b59e13352d2f6c5c9a1f70a039e6e95bf7c246f4", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/b59e13352d2f6c5c9a1f70a039e6e95bf7c246f4", "committedDate": "2020-03-28T13:29:29Z", "message": "Prefer the best fulfilment over lowest cost"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8243b7a6c219e0bb28f15d112b02834a68977a89", "author": {"user": {"login": "vespa-headless", "name": null}}, "url": "https://github.com/vespa-engine/vespa/commit/8243b7a6c219e0bb28f15d112b02834a68977a89", "committedDate": "2020-03-28T13:35:17Z", "message": "Log in both cases, remove printlns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMzE2MTE0", "url": "https://github.com/vespa-engine/vespa/pull/12750#pullrequestreview-383316114", "createdAt": "2020-03-28T14:08:51Z", "commit": {"oid": "bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQxNDowODo1MVrOF9JtQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQxNDozODowNFrOF9J3_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY2NjQ5OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** Returns the current resources of this cluster, if it'1s already depoyed and inside the requested limits */\n          \n          \n            \n                /** Returns the current resources of this cluster, if it's already deployed and inside the requested limits */", "url": "https://github.com/vespa-engine/vespa/pull/12750#discussion_r399666498", "createdAt": "2020-03-28T14:08:51Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeRepositoryProvisioner.java", "diffHunk": "@@ -138,6 +141,39 @@ public void remove(NestedTransaction transaction, ApplicationId application) {\n         loadBalancerProvisioner.ifPresent(lbProvisioner -> lbProvisioner.deactivate(application, transaction));\n     }\n \n+    /**\n+     * Returns the target cluster resources, a value between the min and max in the requested capacity,\n+     * and updates the application store with the received min and max,\n+     */\n+    private ClusterResources decideTargetResources(ApplicationId applicationId, ClusterSpec.Id clusterId, Capacity requested) {\n+        try (Mutex lock = nodeRepository.lock(applicationId)) {\n+            Application application = nodeRepository.applications().get(applicationId, true);\n+            application.setClusterLimits(clusterId, requested.minResources(), requested.maxResources(), lock);\n+            return application.cluster(clusterId).targetResources()\n+                    .orElse(currentResources(applicationId, clusterId, requested)\n+                    .orElse(requested.minResources()));\n+        }\n+    }\n+\n+    /** Returns the current resources of this cluster, if it'1s already depoyed and inside the requested limits */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY2NjY4Nw==", "bodyText": "Consider orElseGet to avoid having to do NodeRepostiory::getNodes every time.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .orElse(currentResources(applicationId, clusterId, requested)\n          \n          \n            \n                                .orElseGet(() -> currentResources(applicationId, clusterId, requested)", "url": "https://github.com/vespa-engine/vespa/pull/12750#discussion_r399666687", "createdAt": "2020-03-28T14:10:51Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeRepositoryProvisioner.java", "diffHunk": "@@ -138,6 +141,39 @@ public void remove(NestedTransaction transaction, ApplicationId application) {\n         loadBalancerProvisioner.ifPresent(lbProvisioner -> lbProvisioner.deactivate(application, transaction));\n     }\n \n+    /**\n+     * Returns the target cluster resources, a value between the min and max in the requested capacity,\n+     * and updates the application store with the received min and max,\n+     */\n+    private ClusterResources decideTargetResources(ApplicationId applicationId, ClusterSpec.Id clusterId, Capacity requested) {\n+        try (Mutex lock = nodeRepository.lock(applicationId)) {\n+            Application application = nodeRepository.applications().get(applicationId, true);\n+            application.setClusterLimits(clusterId, requested.minResources(), requested.maxResources(), lock);\n+            return application.cluster(clusterId).targetResources()\n+                    .orElse(currentResources(applicationId, clusterId, requested)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY2OTI0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (closed) throw new IllegalStateException(this + \"is closed\");\n          \n          \n            \n                    if (closed) throw new IllegalStateException(this + \" is closed\");", "url": "https://github.com/vespa-engine/vespa/pull/12750#discussion_r399669244", "createdAt": "2020-03-28T14:38:04Z", "author": {"login": "freva"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MaintenanceDeployment.java", "diffHunk": "@@ -52,6 +50,16 @@ public boolean isValid() {\n         return deployment.isPresent();\n     }\n \n+    /**\n+     * Returns the application lock held by this, or empty if it is not held.\n+     *\n+     * @throws IllegalStateException id this is called when closed\n+     */\n+    public Optional<Mutex> applicationLock() {\n+        if (closed) throw new IllegalStateException(this + \"is closed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b18e2939b6632e7bf02cc12dea096dabecb9e754"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1e11e67da2f5f3df7da1248b58b6dc983c4d0b2", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/a1e11e67da2f5f3df7da1248b58b6dc983c4d0b2", "committedDate": "2020-03-28T15:45:48Z", "message": "Update node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeRepositoryProvisioner.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12b4ab36a248541156f80e66a66c077811507379", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/12b4ab36a248541156f80e66a66c077811507379", "committedDate": "2020-03-28T15:46:04Z", "message": "Update node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeRepositoryProvisioner.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fc3a51689475497b609524459c01152a11ea443", "author": {"user": {"login": "bratseth", "name": "Jon Bratseth"}}, "url": "https://github.com/vespa-engine/vespa/commit/0fc3a51689475497b609524459c01152a11ea443", "committedDate": "2020-03-28T15:46:16Z", "message": "Update node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MaintenanceDeployment.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2534, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}