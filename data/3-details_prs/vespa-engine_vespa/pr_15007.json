{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MjI4NzA5", "number": 15007, "title": "andreer/basic quota subtraction", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-10-22T11:45:57Z", "url": "https://github.com/vespa-engine/vespa/pull/15007", "merged": true, "mergeCommit": {"oid": "8d141c6e23668b7260260b17e09d68528cb53486"}, "closed": true, "closedAt": "2020-10-27T08:33:32Z", "author": {"login": "andreer"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUXUt9AH2gAyNTA4MjI4NzA5OmYyOGQ3MDY2OTM0ODgzMWM4Njc1NmExYjU3MGU1NzYwNWU5ODIzZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWVAtYgFqTUxNjgxNzEyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f28d70669348831c86756a1b570e57605e9823d8", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/f28d70669348831c86756a1b570e57605e9823d8", "committedDate": "2020-10-20T11:46:10Z", "message": "subtract usage by other application deployments from Quota"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90aff3a99045f5fc35aff5069a723d0bdc3a54c7", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/90aff3a99045f5fc35aff5069a723d0bdc3a54c7", "committedDate": "2020-10-22T10:35:42Z", "message": "sum usage across tenant, not application"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80391c46eeafa371d1d6f991a4f984b50add7ad3", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/80391c46eeafa371d1d6f991a4f984b50add7ad3", "committedDate": "2020-10-22T12:29:25Z", "message": "simplify unlimited check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc57f5fca98a9a0f879c6afbfffd8a8c3ce8b39", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/4fc57f5fca98a9a0f879c6afbfffd8a8c3ce8b39", "committedDate": "2020-10-23T14:20:09Z", "message": "extract class for deployment quota calculation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb1f0e479fb23add4499b712cbd2db42c5453e8b", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/cb1f0e479fb23add4499b712cbd2db42c5453e8b", "committedDate": "2020-10-25T19:09:27Z", "message": "divide application quota among deployments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41d74ab07e9e45da22a1153176061bd186bcc0e8", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/41d74ab07e9e45da22a1153176061bd186bcc0e8", "committedDate": "2020-10-25T19:43:37Z", "message": "guard against division by zero"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2cc2823c7397c30934b40cedafe2d9d34829c4a", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/c2cc2823c7397c30934b40cedafe2d9d34829c4a", "committedDate": "2020-10-25T20:38:59Z", "message": "use .zones() to get all deployments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c36b1bd081047f0e95c27cd38afac69ae880b158", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/c36b1bd081047f0e95c27cd38afac69ae880b158", "committedDate": "2020-10-25T20:39:16Z", "message": "basic unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzQ3MDM0", "url": "https://github.com/vespa-engine/vespa/pull/15007#pullrequestreview-516747034", "createdAt": "2020-10-26T12:56:17Z", "commit": {"oid": "c36b1bd081047f0e95c27cd38afac69ae880b158"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo1NjoxN1rOHoON8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo1NjoxN1rOHoON8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzODAzNQ==", "bodyText": "I don't understand why application is a parameter for .quotaUsage(...). Surely the app object knows about its own identity?", "url": "https://github.com/vespa-engine/vespa/pull/15007#discussion_r511938035", "createdAt": "2020-10-26T12:56:17Z", "author": {"login": "oyving"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/application/DeploymentQuotaCalculator.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.yahoo.vespa.hosted.controller.application;\n+\n+import com.yahoo.config.application.api.DeploymentSpec;\n+import com.yahoo.config.provision.ApplicationId;\n+import com.yahoo.config.provision.zone.ZoneId;\n+import com.yahoo.vespa.hosted.controller.Application;\n+import com.yahoo.vespa.hosted.controller.api.integration.billing.Quota;\n+\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+import java.util.List;\n+\n+/** Calculates the quota to allocate to a deployment. */\n+public class DeploymentQuotaCalculator {\n+\n+    public static Quota calculate(Quota tenantQuota,\n+                                  List<Application> tenantApps,\n+                                  ApplicationId deployingApp, ZoneId deployingZone,\n+                                  DeploymentSpec deploymentSpec) {\n+\n+        if (tenantQuota.budget().isEmpty()) return tenantQuota; // Shortcut if there is no budget limit to care about.\n+\n+        if (deployingZone.environment().isProduction()) return probablyEnoughForAll(tenantQuota, tenantApps, deployingApp, deploymentSpec);\n+\n+        return getMaximumAllowedQuota(tenantQuota, tenantApps, deployingApp, deployingZone);\n+    }\n+\n+    /** Just get the maximum quota we are allowed to use. */\n+    private static Quota getMaximumAllowedQuota(Quota tenantQuota, List<Application> applications,\n+                                                ApplicationId application, ZoneId zone) {\n+        var usageOutsideDeployment = applications.stream()\n+                .map(app -> app.quotaUsage(application, zone))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c36b1bd081047f0e95c27cd38afac69ae880b158"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODE3MTI3", "url": "https://github.com/vespa-engine/vespa/pull/15007#pullrequestreview-516817127", "createdAt": "2020-10-26T14:12:21Z", "commit": {"oid": "c36b1bd081047f0e95c27cd38afac69ae880b158"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2322, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}