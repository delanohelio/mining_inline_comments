{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNTMzMzIx", "number": 13721, "title": "Arnej/innerproduct distance metric", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@geirst please review", "createdAt": "2020-06-26T11:30:12Z", "url": "https://github.com/vespa-engine/vespa/pull/13721", "merged": true, "mergeCommit": {"oid": "a58193603b25fbf75fac825aa44e789cb711e70c"}, "closed": true, "closedAt": "2020-06-29T11:16:21Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcur18LAH2gAyNDQwNTMzMzIxOjA2ZWRkOWQ2MmM2YWJkOWQ2ZGU5NmJjYTQ5MzA5NTQ3NGQ2NjMwNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv9K0egH2gAyNDQwNTMzMzIxOjI4YTA5OTZhYjk3MTkzZWJlNTU4OGZhMjVjMzg4NzNmMzJiYTM3ZjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06edd9d62c6abd9d6de96bca493095474d663060", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/06edd9d62c6abd9d6de96bca493095474d663060", "committedDate": "2020-06-25T10:11:26Z", "message": "add new distance metric, GC old setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e273894fc49c215764c9beb4270ea206038af5f", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/3e273894fc49c215764c9beb4270ea206038af5f", "committedDate": "2020-06-25T21:03:07Z", "message": "add \"InnerProduct\" distance metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27b8596bb6508f43d03d0784378ea537347e9d3a", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/27b8596bb6508f43d03d0784378ea537347e9d3a", "committedDate": "2020-06-26T09:03:12Z", "message": "adjust angular distance slighly\n\n* now gives actual angle as final distance, in range [0,pi]\n* extend unit tests and test to_rawscore for all metrics\n* move explicit template instantiations to cpp file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b0111f134cd30e7c73bba4cf224259249358026", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/1b0111f134cd30e7c73bba4cf224259249358026", "committedDate": "2020-06-26T09:15:01Z", "message": "cannot remove unused config quite yet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8372975229b7d67f25100301ac462a305578b5fa", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/8372975229b7d67f25100301ac462a305578b5fa", "committedDate": "2020-06-26T09:19:39Z", "message": "ignore unused config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MjcyMzYz", "url": "https://github.com/vespa-engine/vespa/pull/13721#pullrequestreview-438272363", "createdAt": "2020-06-26T12:57:46Z", "commit": {"oid": "3e273894fc49c215764c9beb4270ea206038af5f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo1Nzo0NlrOGpf5bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMzowMTozMVrOGpgBGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NzQwNQ==", "bodyText": "Consider creating one test function per distance function. Makes it easier to read the tests.", "url": "https://github.com/vespa-engine/vespa/pull/13721#discussion_r446167405", "createdAt": "2020-06-26T12:57:46Z", "author": {"login": "geirst"}, "path": "searchlib/src/tests/tensor/distance_functions/distance_functions_test.cpp", "diffHunk": "@@ -37,6 +37,7 @@ TEST(DistanceFunctionsTest, gives_expected_score)\n \n     auto euclid = make_distance_function(DistanceMetric::Euclidean, ct);\n     auto angular = make_distance_function(DistanceMetric::Angular, ct);\n+    auto innerproduct = make_distance_function(DistanceMetric::InnerProduct, ct);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e273894fc49c215764c9beb4270ea206038af5f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2OTM2OQ==", "bodyText": "Consider using 'inner product' in description.", "url": "https://github.com/vespa-engine/vespa/pull/13721#discussion_r446169369", "createdAt": "2020-06-26T13:01:31Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/tensor/distance_functions.h", "diffHunk": "@@ -54,14 +54,55 @@ template class SquaredEuclideanDistance<float>;\n template class SquaredEuclideanDistance<double>;\n \n /**\n- * Calculates angular distance between vectors with assumed norm 1.\n+ * Calculates angular distance between vectors\n  */\n template <typename FloatType>\n class AngularDistance : public DistanceFunction {\n public:\n     AngularDistance()\n         : _computer(vespalib::hwaccelrated::IAccelrated::getAccelerator())\n     {}\n+    double calc(const vespalib::tensor::TypedCells& lhs, const vespalib::tensor::TypedCells& rhs) const override {\n+        auto lhs_vector = lhs.typify<FloatType>();\n+        auto rhs_vector = rhs.typify<FloatType>();\n+        size_t sz = lhs_vector.size();\n+        assert(sz == rhs_vector.size());\n+        auto a = &lhs_vector[0];\n+        auto b = &rhs_vector[0];\n+        double a_norm_sq = _computer.dotProduct(a, a, sz);\n+        double b_norm_sq = _computer.dotProduct(b, b, sz);\n+        double dot_product = _computer.dotProduct(a, b, sz);\n+        double div = sqrt(a_norm_sq * b_norm_sq);\n+        double cosine_similarity = (div > 0) ? (dot_product / div) : 0.0; // [-1, 1]\n+        double score = (1.0 - cosine_similarity) * 0.5; // [1, 0]\n+        return score;\n+    }\n+    double to_rawscore(double distance) const override {\n+        double score = 1.0 - distance;\n+        return score;\n+    }\n+    double calc_with_limit(const vespalib::tensor::TypedCells& lhs,\n+                           const vespalib::tensor::TypedCells& rhs,\n+                           double /*limit*/) const override\n+    {\n+        return calc(lhs, rhs);\n+    }\n+\n+    const vespalib::hwaccelrated::IAccelrated & _computer;\n+};\n+\n+template class AngularDistance<float>;\n+template class AngularDistance<double>;\n+\n+/**\n+ * Calculates angular distance between vectors with assumed norm 1.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e273894fc49c215764c9beb4270ea206038af5f"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32c53b5b8b8314cd41768807dd3da6d6509edd73", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/32c53b5b8b8314cd41768807dd3da6d6509edd73", "committedDate": "2020-06-29T07:32:15Z", "message": "split unit tests per distance function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28a0996ab97193ebe5588fa25c38873f32ba37f4", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/28a0996ab97193ebe5588fa25c38873f32ba37f4", "committedDate": "2020-06-29T08:56:33Z", "message": "update comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3591, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}