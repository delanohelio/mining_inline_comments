{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NzQyNTIw", "number": 13846, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDozNDo1NlrOEM1qjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDo0NzoyMVrOEM152g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODk3NjE0OnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDozNDo1NlrOGvLcYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDo0OTo1MFrOGvL42g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyMzc0NQ==", "bodyText": "nit: the middle part of the message could be simplified to \" locks older than \"", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452123745", "createdAt": "2020-07-09T10:34:56Z", "author": {"login": "gjoranv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java", "diffHunk": "@@ -35,5 +35,9 @@ protected void maintain() {\n             int deleted = applicationRepository.deleteExpiredRemoteSessions(expiryTime);\n             log.log(LogLevel.FINE, \"Deleted \" + deleted + \" expired remote sessions, expiry time \" + expiryTime);\n         }\n+\n+        Duration lockExpiryTime = Duration.ofDays(1);\n+        int deleted = applicationRepository.deleteExpiredLocks(lockExpiryTime);\n+        log.log(LogLevel.INFO, \"Deleted \" + deleted + \" expired locks, expiry time \" + lockExpiryTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzMTAzNA==", "bodyText": "thanks, will fix", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452131034", "createdAt": "2020-07-09T10:49:50Z", "author": {"login": "hmusum"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java", "diffHunk": "@@ -35,5 +35,9 @@ protected void maintain() {\n             int deleted = applicationRepository.deleteExpiredRemoteSessions(expiryTime);\n             log.log(LogLevel.FINE, \"Deleted \" + deleted + \" expired remote sessions, expiry time \" + expiryTime);\n         }\n+\n+        Duration lockExpiryTime = Duration.ofDays(1);\n+        int deleted = applicationRepository.deleteExpiredLocks(lockExpiryTime);\n+        log.log(LogLevel.INFO, \"Deleted \" + deleted + \" expired locks, expiry time \" + lockExpiryTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyMzc0NQ=="}, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODk3OTA2OnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDozNTo1MVrOGvLePQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDo0OTo0NFrOGvL4qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyNDIyMQ==", "bodyText": "intended? I don't see any new usage in this PR.", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452124221", "createdAt": "2020-07-09T10:35:51Z", "author": {"login": "gjoranv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -665,7 +687,7 @@ public Lock lock(long sessionId) {\n         return curator.lock(lockPath(sessionId), Duration.ofMinutes(1)); // These locks shouldn't be held for very long.\n     }\n \n-    private Path lockPath(long sessionId) {\n+    public Path lockPath(long sessionId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzMDk4NQ==", "bodyText": "I tried to write a test that needed this (but that was abandoned), so not anymore, will fix", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452130985", "createdAt": "2020-07-09T10:49:44Z", "author": {"login": "hmusum"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -665,7 +687,7 @@ public Lock lock(long sessionId) {\n         return curator.lock(lockPath(sessionId), Duration.ofMinutes(1)); // These locks shouldn't be held for very long.\n     }\n \n-    private Path lockPath(long sessionId) {\n+    public Path lockPath(long sessionId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyNDIyMQ=="}, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxOTAxNTMwOnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDo0NzoyMVrOGvL0Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDo1MDoxM1rOGvL5mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyOTg2Mw==", "bodyText": "perhaps this should return an Optional instead, and empty where it now returns the current time?", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452129863", "createdAt": "2020-07-09T10:47:21Z", "author": {"login": "gjoranv"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -281,6 +282,27 @@ public int deleteExpiredRemoteSessions(Clock clock, Duration expiryTime) {\n         return deleted;\n     }\n \n+    public int deleteExpiredLocks(Clock clock, Duration expiryTime) {\n+        int deleted = 0;\n+        for (var lock : curator.getChildren(locksPath)) {\n+            Path path = locksPath.append(lock);\n+            if (zooKeeperNodeCreated(path).isBefore(clock.instant().minus(expiryTime))) {\n+                log.log(Level.INFO, \"Lock  \" + path + \" has expired, deleting it\");\n+                curator.delete(path);\n+                deleted++;\n+            }\n+        }\n+        return deleted;\n+    }\n+\n+    private Instant zooKeeperNodeCreated(Path path) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzMTIyNQ==", "bodyText": "Yes, probably better, thanks", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452131225", "createdAt": "2020-07-09T10:50:13Z", "author": {"login": "hmusum"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -281,6 +282,27 @@ public int deleteExpiredRemoteSessions(Clock clock, Duration expiryTime) {\n         return deleted;\n     }\n \n+    public int deleteExpiredLocks(Clock clock, Duration expiryTime) {\n+        int deleted = 0;\n+        for (var lock : curator.getChildren(locksPath)) {\n+            Path path = locksPath.append(lock);\n+            if (zooKeeperNodeCreated(path).isBefore(clock.instant().minus(expiryTime))) {\n+                log.log(Level.INFO, \"Lock  \" + path + \" has expired, deleting it\");\n+                curator.delete(path);\n+                deleted++;\n+            }\n+        }\n+        return deleted;\n+    }\n+\n+    private Instant zooKeeperNodeCreated(Path path) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyOTg2Mw=="}, "originalCommit": {"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1861, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}