{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNTAzMDY1", "number": 15673, "title": "Retry reconfiguration if another one is in progress", "bodyText": "", "createdAt": "2020-12-04T12:28:26Z", "url": "https://github.com/vespa-engine/vespa/pull/15673", "merged": true, "mergeCommit": {"oid": "1c13243bf8c5515192e353e27f2d968feb3ea6ae"}, "closed": true, "closedAt": "2020-12-04T13:30:48Z", "author": {"login": "hmusum"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi22kKAH2gAyNTMyNTAzMDY1OjYyZjE2MDkxNGIwNzNiNTUyZmJjNjI4NjI3OGJmY2ViZTczY2U1Y2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi3bIAAFqTU0NDk0MDM2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62f160914b073b552fbc6286278bfcebe73ce5cc", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/62f160914b073b552fbc6286278bfcebe73ce5cc", "committedDate": "2020-12-04T12:25:08Z", "message": "Retry reconfiguration if another one is in progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e360658e832106ccff64f49d9f591841fe7a51d", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/4e360658e832106ccff64f49d9f591841fe7a51d", "committedDate": "2020-12-04T12:28:12Z", "message": "Split out constant"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0OTE4Mjk3", "url": "https://github.com/vespa-engine/vespa/pull/15673#pullrequestreview-544918297", "createdAt": "2020-12-04T12:32:06Z", "commit": {"oid": "4e360658e832106ccff64f49d9f591841fe7a51d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjozMzowMVrOH_O7_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjozNzoyN1rOH_PGKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2NzA3MA==", "bodyText": "This seems too long. How about 30 seconds? Typically there will only be one config change and subsequent reconfigs on other nodes will effectively be no-ops.", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536067070", "createdAt": "2020-12-04T12:33:01Z", "author": {"login": "mpolden"}, "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java", "diffHunk": "@@ -26,6 +27,7 @@\n \n     private static final Logger log = java.util.logging.Logger.getLogger(Reconfigurer.class.getName());\n     private static final Duration sessionTimeout = Duration.ofSeconds(30);\n+    private static final Duration retryReconfigurationPeriod = Duration.ofMinutes(5);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e360658e832106ccff64f49d9f591841fe7a51d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2ODU2MQ==", "bodyText": "Consider making the sleeper configurable by having an instance of Consumer<Duration> in this class, then the unit test doesn't actually have to sleep.", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536068561", "createdAt": "2020-12-04T12:35:36Z", "author": {"login": "mpolden"}, "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java", "diffHunk": "@@ -86,7 +88,26 @@ private void reconfigure(ZookeeperServerConfig newConfig) {\n         joiningServers = joiningServers.isEmpty() ? null : joiningServers;\n         log.log(Level.INFO, \"Will reconfigure ZooKeeper cluster. Joining servers: \" + joiningServers +\n                             \", leaving servers: \" + leavingServers);\n-        zooKeeperReconfigure(connectionSpec(activeConfig), joiningServers, leavingServers);\n+\n+        String connectionSpec = connectionSpec(activeConfig);\n+        boolean reconfigured = false;\n+        Instant end = Instant.now().plus(retryReconfigurationPeriod);\n+        // Loop reconfiguring since we might need to wait until another reconfiguration is finished before we can succeed\n+        while ( ! reconfigured && Instant.now().isBefore(end)) {\n+            try {\n+                zooKeeperReconfigure(connectionSpec, joiningServers, leavingServers);\n+                reconfigured = true;\n+            } catch (KeeperException e) {\n+                if ( ! (e instanceof KeeperException.ReconfigInProgress))\n+                    throw new RuntimeException(e);\n+                log.log(Level.INFO, \"Will retry in 1 second\");\n+                try {\n+                    Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e360658e832106ccff64f49d9f591841fe7a51d"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTY3NQ==", "bodyText": "Consider extracting a constant for the sleep period that is used both in the log message and sleep parameter.", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536069675", "createdAt": "2020-12-04T12:37:27Z", "author": {"login": "mpolden"}, "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java", "diffHunk": "@@ -86,7 +88,26 @@ private void reconfigure(ZookeeperServerConfig newConfig) {\n         joiningServers = joiningServers.isEmpty() ? null : joiningServers;\n         log.log(Level.INFO, \"Will reconfigure ZooKeeper cluster. Joining servers: \" + joiningServers +\n                             \", leaving servers: \" + leavingServers);\n-        zooKeeperReconfigure(connectionSpec(activeConfig), joiningServers, leavingServers);\n+\n+        String connectionSpec = connectionSpec(activeConfig);\n+        boolean reconfigured = false;\n+        Instant end = Instant.now().plus(retryReconfigurationPeriod);\n+        // Loop reconfiguring since we might need to wait until another reconfiguration is finished before we can succeed\n+        while ( ! reconfigured && Instant.now().isBefore(end)) {\n+            try {\n+                zooKeeperReconfigure(connectionSpec, joiningServers, leavingServers);\n+                reconfigured = true;\n+            } catch (KeeperException e) {\n+                if ( ! (e instanceof KeeperException.ReconfigInProgress))\n+                    throw new RuntimeException(e);\n+                log.log(Level.INFO, \"Will retry in 1 second\");\n+                try {\n+                    Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2ODU2MQ=="}, "originalCommit": {"oid": "4e360658e832106ccff64f49d9f591841fe7a51d"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0OTIyNzEz", "url": "https://github.com/vespa-engine/vespa/pull/15673#pullrequestreview-544922713", "createdAt": "2020-12-04T12:38:54Z", "commit": {"oid": "4e360658e832106ccff64f49d9f591841fe7a51d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjozODo1NFrOH_PJPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjozODo1NFrOH_PJPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3MDQ2MA==", "bodyText": "Consider logging how long reconfig took, so that we can fine-tune the timeouts.", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536070460", "createdAt": "2020-12-04T12:38:54Z", "author": {"login": "mpolden"}, "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java", "diffHunk": "@@ -86,7 +88,26 @@ private void reconfigure(ZookeeperServerConfig newConfig) {\n         joiningServers = joiningServers.isEmpty() ? null : joiningServers;\n         log.log(Level.INFO, \"Will reconfigure ZooKeeper cluster. Joining servers: \" + joiningServers +\n                             \", leaving servers: \" + leavingServers);\n-        zooKeeperReconfigure(connectionSpec(activeConfig), joiningServers, leavingServers);\n+\n+        String connectionSpec = connectionSpec(activeConfig);\n+        boolean reconfigured = false;\n+        Instant end = Instant.now().plus(retryReconfigurationPeriod);\n+        // Loop reconfiguring since we might need to wait until another reconfiguration is finished before we can succeed\n+        while ( ! reconfigured && Instant.now().isBefore(end)) {\n+            try {\n+                zooKeeperReconfigure(connectionSpec, joiningServers, leavingServers);\n+                reconfigured = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e360658e832106ccff64f49d9f591841fe7a51d"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0a120474cfd719ef6aeebfbd780f43b86b2f6e0", "author": {"user": {"login": "hmusum", "name": "Harald Musum"}}, "url": "https://github.com/vespa-engine/vespa/commit/a0a120474cfd719ef6aeebfbd780f43b86b2f6e0", "committedDate": "2020-12-04T13:03:03Z", "message": "Implement suggestions from review (sleeper, more logging, sleep shorter)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0OTQwMzYw", "url": "https://github.com/vespa-engine/vespa/pull/15673#pullrequestreview-544940360", "createdAt": "2020-12-04T13:05:04Z", "commit": {"oid": "a0a120474cfd719ef6aeebfbd780f43b86b2f6e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3860, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}