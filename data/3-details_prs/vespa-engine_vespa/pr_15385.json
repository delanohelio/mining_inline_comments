{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNDYxNzQ2", "number": 15385, "title": "Balder/reorder for smaller footprint", "bodyText": "@vekterli PR\n@geirst FYI", "createdAt": "2020-11-18T20:49:07Z", "url": "https://github.com/vespa-engine/vespa/pull/15385", "merged": true, "mergeCommit": {"oid": "66445f857b81b051c1572409ce19d032cb03024c"}, "closed": true, "closedAt": "2020-11-23T16:50:42Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddyXw9gH2gAyNTIzNDYxNzQ2OmQ2OTc1OTUzZTQyODQwNjhmYmQ3NmU4MGJiZjdlODAyMDAzYWRjYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfXxAfAH2gAyNTIzNDYxNzQ2OjdkNTNhYjFiNWE1ZTYwN2IwZTMwMjM3NTViNWFlNDA0OGNiYjJjMDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d6975953e4284068fbd76e80bbf7e802003adcaf", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/d6975953e4284068fbd76e80bbf7e802003adcaf", "committedDate": "2020-11-18T18:22:15Z", "message": "Reorder members for smaller memory footprint."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2d2d0053d16ca15c9298f3e8312b494e246c5e9", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/b2d2d0053d16ca15c9298f3e8312b494e246c5e9", "committedDate": "2020-11-18T18:22:16Z", "message": "No need to copy an empty object into another empty object."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37822a5c2ecf566bac41ea8a8c94226115ac370f", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/37822a5c2ecf566bac41ea8a8c94226115ac370f", "committedDate": "2020-11-18T18:22:16Z", "message": "Hide the modifiable TraceNode root inside the Trace object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5708135b1ddbac03f268b6235027c10121cb5ca4", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/5708135b1ddbac03f268b6235027c10121cb5ca4", "committedDate": "2020-11-18T18:22:16Z", "message": "Move the Trace and TraceNode when adding traces."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb28759a307ff298e2125d6d3deff260c941ec45", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/eb28759a307ff298e2125d6d3deff260c941ec45", "committedDate": "2020-11-18T18:22:16Z", "message": "Explicit copy construction of Trace."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78bfefbf3fd11a655560c7237bf4106aca2458b2", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/78bfefbf3fd11a655560c7237bf4106aca2458b2", "committedDate": "2020-11-18T18:22:16Z", "message": "Use a std:.unique_ptr to make Trace a thin wrapper for TraceNode to make the happy path fast."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a330fa13973762f0b05e73c0ef3969fce28734fd", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/a330fa13973762f0b05e73c0ef3969fce28734fd", "committedDate": "2020-11-18T18:22:16Z", "message": "Reduce exposure of TraceNode even further."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/35b3c13c44390271d09f3a8b9bb1709d335443c6", "committedDate": "2020-11-18T20:48:02Z", "message": "Stick to using TraceNode for testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MjI1ODAy", "url": "https://github.com/vespa-engine/vespa/pull/15385#pullrequestreview-534225802", "createdAt": "2020-11-19T09:26:25Z", "commit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOToyNjoyNVrOH2T6Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxNDozMlrOH2YMFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxMTMwNg==", "bodyText": "Do we want type-related checks to be static_asserts instead?", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526711306", "createdAt": "2020-11-19T09:26:25Z", "author": {"login": "vekterli"}, "path": "messagebus/src/tests/simpleprotocol/simpleprotocol.cpp", "diffHunk": "@@ -29,20 +27,23 @@ Test::Main()\n     {\n         // test protocol\n         IRoutingPolicy::UP bogus = protocol.createPolicy(\"bogus\", \"\");\n-        EXPECT_TRUE(bogus.get() == 0);\n+        EXPECT_FALSE(bogus);\n     }\n     TEST_FLUSH();\n     {\n         // test SimpleMessage\n-        Message::UP msg(new SimpleMessage(\"test\"));\n+        EXPECT_EQUAL(56u, sizeof(Routable));\n+        EXPECT_EQUAL(104u, sizeof(Message));\n+        EXPECT_EQUAL(184u, sizeof(SimpleMessage));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcyMTYzNg==", "bodyText": "Should this also add the trace by move?", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526721636", "createdAt": "2020-11-19T09:41:49Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/distributor/operations/external/twophaseupdateoperation.cpp", "diffHunk": "@@ -647,7 +647,7 @@ TwoPhaseUpdateOperation::satisfiesUpdateTimestampConstraint(api::Timestamp ts) c\n void\n TwoPhaseUpdateOperation::addTraceFromReply(const api::StorageReply& reply)\n {\n-    if ( ! reply.getTrace().getRoot().isEmpty()) {\n+    if ( ! reply.getTrace().isEmpty()) {\n         _trace.addChild(reply.getTrace().getRoot());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcyOTM3MA==", "bodyText": "Should this return ensureRoot()?", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526729370", "createdAt": "2020-11-19T09:52:54Z", "author": {"login": "vekterli"}, "path": "vespalib/src/vespa/vespalib/trace/trace.h", "diffHunk": "@@ -91,27 +80,50 @@ class Trace {\n      */\n     bool trace(uint32_t level, const string &note, bool addTime = true);\n \n-    /**\n-     * Returns the root of the trace tree.\n-     *\n-     * @return The root.\n-     */\n-    TraceNode &getRoot() { return _root; }\n+    void normalize() {\n+        if (_root) {\n+            _root->normalize();\n+        }\n+    }\n \n-    /**\n-     * Returns a const reference to the root of the trace tree.\n-     *\n-     * @return The root.\n-     */\n-    const TraceNode &getRoot() const { return _root; }\n+    void setStrict(bool strict) {\n+        ensureRoot().setStrict(strict);\n+    }\n+    void addChild(TraceNode && child) {\n+        ensureRoot().addChild(std::move(child));\n+    }\n+    void addChild(Trace && child) {\n+        if (!child.isEmpty()) {\n+            addChild(std::move(*child._root));\n+        }\n+    }\n+    //TODO This one should go away as we should prefer moving\n+    void addChild(const Trace & child) {\n+        if (!child.isEmpty()) {\n+            addChild(TraceNode(*child._root));\n+        }\n+    }\n+\n+    const TraceNode &getRoot() const { return *_root; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjczMTk4Mw==", "bodyText": "Consider updating comment to remove mention of returning this", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526731983", "createdAt": "2020-11-19T09:56:42Z", "author": {"login": "vekterli"}, "path": "vespalib/src/vespa/vespalib/trace/trace.h", "diffHunk": "@@ -18,53 +18,42 @@ namespace vespalib {\n  * information will be traced.\n  */\n class Trace {\n-private:\n-    uint32_t  _level;\n-    TraceNode _root;\n-\n public:\n \n     /**\n      * Create an empty Trace with level set to 0 (no tracing)\n      */\n-    Trace();\n-    ~Trace();\n-\n-    /**\n-     * Create an empty trace with given level.\n-     *\n-     * @param level Level to set.\n-     */\n-    explicit Trace(uint32_t level);\n+    Trace() : Trace(0) {}\n+    explicit Trace(uint32_t level) : _root(), _level(level) { }\n+    Trace & operator = (Trace &&) = default;\n+    Trace(Trace &&) = default;\n+    Trace(const Trace &);\n+    Trace & operator = (const Trace &) = delete;\n+    ~Trace() = default;\n \n     /**\n      * Remove all trace information and set the trace level to 0.\n      *\n      * @return This, to allow chaining.\n      */\n-    Trace &clear();\n+    void clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc2MjA1OQ==", "bodyText": "Copying the entire trace from the source command does indeed sound weird. If anything it sounds like it could create many duplicate entries when reply traces are eventually stitched together. For fan-out we normally create new commands and explicitly copy required fields into it. I suggest just copying the trace level here, and we can remove the copy ctor usage later.", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526762059", "createdAt": "2020-11-19T10:43:30Z", "author": {"login": "vekterli"}, "path": "storageapi/src/vespa/storageapi/messageapi/storagecommand.cpp", "diffHunk": "@@ -11,7 +11,12 @@ StorageCommand::StorageCommand(const StorageCommand& other)\n       _timeout(other._timeout),\n       _sourceIndex(other._sourceIndex)\n {\n-    setTrace(other.getTrace());\n+    // TODD do we really need copy construction, seems only use by CreateVisitorCommand ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc2NDU2Nw==", "bodyText": "I find rvalue-casting of returned non-rvalue refs to be dangerous since they may silently violate invariants of the source object. Consider adding an explicit steal_trace (or move_trace) function to spi::Context", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526764567", "createdAt": "2020-11-19T10:47:26Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/persistence/filestorage/filestormanager.cpp", "diffHunk": "@@ -676,7 +676,7 @@ FileStorManager::onInternal(const shared_ptr<api::InternalCommand>& msg)\n         spi::Context context(msg->getLoadType(), msg->getPriority(), msg->getTrace().getLevel());\n         shared_ptr<DestroyIteratorCommand> cmd(std::static_pointer_cast<DestroyIteratorCommand>(msg));\n         _provider->destroyIterator(cmd->getIteratorId(), context);\n-        msg->getTrace().getRoot().addChild(context.getTrace().getRoot());\n+        msg->getTrace().addChild(std::move(context.getTrace()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc2NTA0Mg==", "bodyText": "Consider adding an explicit steal_trace/move_trace function instead", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526765042", "createdAt": "2020-11-19T10:48:13Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/storageserver/communicationmanager.cpp", "diffHunk": "@@ -690,13 +690,13 @@ CommunicationManager::sendMessageBusReply(\n         if (reply->getResult().getResult() == api::ReturnCode::WRONG_DISTRIBUTION) {\n             replyUP = std::make_unique<documentapi::WrongDistributionReply>(reply->getResult().getMessage());\n             replyUP->swapState(*context._docAPIMsg);\n-            replyUP->setTrace(reply->getTrace());\n+            replyUP->setTrace(std::move(reply->getTrace()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc2OTI5OQ==", "bodyText": "From what I can tell, the answer looks to be both \"yes\" and \"preferably\". Copying the trace leaves the old trace data behind, which is later moved into the reply when swapState is called. However, this copied trace information is immediately overwritten since we then call setTrace with whatever was in the source reply (which presumably includes the trace in the original command as well)", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526769299", "createdAt": "2020-11-19T10:54:44Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/storageserver/communicationmanager.cpp", "diffHunk": "@@ -102,7 +102,7 @@ CommunicationManager::handleMessage(std::unique_ptr<mbus::Message> msg)\n             return;\n         }\n \n-        cmd->setTrace(docMsgPtr->getTrace());\n+        cmd->setTrace(vespalib::Trace(docMsgPtr->getTrace())); // Can it be moved ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MTQ2MA==", "bodyText": "The const-ness of the StorageCommand argument is already a white lie, since we destructively (and silently) acquire its transport context by move. We could probably do the same thing with traces, though we should first ensure that there aren't any callers that are unaware of this implicit copy and that try to copy/move the command's trace into the reply explicitly after constructing it.", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r526781460", "createdAt": "2020-11-19T11:14:32Z", "author": {"login": "vekterli"}, "path": "storageapi/src/vespa/storageapi/messageapi/storagereply.cpp", "diffHunk": "@@ -14,7 +14,12 @@ StorageReply::StorageReply(const StorageCommand& cmd, ReturnCode code)\n     if (cmd.getAddress()) {\n         setAddress(*cmd.getAddress());\n     }\n-    setTrace(cmd.getTrace());\n+    // TODD do we really need copy construction", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35b3c13c44390271d09f3a8b9bb1709d335443c6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f14beea4b6c12584985347b1afbeadcc3b69f021", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/f14beea4b6c12584985347b1afbeadcc3b69f021", "committedDate": "2020-11-23T10:13:12Z", "message": "Update comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95de10788c5f5a1c60e80e312091ed05b01a26fd", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/95de10788c5f5a1c60e80e312091ed05b01a26fd", "committedDate": "2020-11-23T10:24:08Z", "message": "Only copy tracelevel."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da48ee20f9d5981e4aaa5cb719f0b3fea57d17e6", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/da48ee20f9d5981e4aaa5cb719f0b3fea57d17e6", "committedDate": "2020-11-23T11:19:07Z", "message": "Move instead of copy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca29131b659c51935fe6a6cdf3ae93207c79e714", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/ca29131b659c51935fe6a6cdf3ae93207c79e714", "committedDate": "2020-11-23T11:35:11Z", "message": "Move instead of copy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3c152485a4e2d246d4dd50909a3481cdce71347", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/c3c152485a4e2d246d4dd50909a3481cdce71347", "committedDate": "2020-11-23T13:30:45Z", "message": "Steal the traces explicit and force moving of traces. Also hide access to the root."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9976e18ce5831531816abb3bb1ffa08b0aaabcb", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/a9976e18ce5831531816abb3bb1ffa08b0aaabcb", "committedDate": "2020-11-23T13:59:35Z", "message": "Avoid having mutating methods const."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NTg1MjQ5", "url": "https://github.com/vespa-engine/vespa/pull/15385#pullrequestreview-536585249", "createdAt": "2020-11-23T15:31:41Z", "commit": {"oid": "a9976e18ce5831531816abb3bb1ffa08b0aaabcb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNTozMTo0MVrOH4StjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNTozMTo0MVrOH4StjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc4ODg3Ng==", "bodyText": "Consider having a steal_trace function for these as well", "url": "https://github.com/vespa-engine/vespa/pull/15385#discussion_r528788876", "createdAt": "2020-11-23T15:31:41Z", "author": {"login": "vekterli"}, "path": "storage/src/vespa/storage/storageserver/communicationmanager.cpp", "diffHunk": "@@ -102,7 +102,7 @@ CommunicationManager::handleMessage(std::unique_ptr<mbus::Message> msg)\n             return;\n         }\n \n-        cmd->setTrace(vespalib::Trace(docMsgPtr->getTrace())); // Can it be moved ?\n+        cmd->setTrace(std::move(docMsgPtr->getTrace()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9976e18ce5831531816abb3bb1ffa08b0aaabcb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d53ab1b5a5e607b0e3023755b5ae4048cbb2c09", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/7d53ab1b5a5e607b0e3023755b5ae4048cbb2c09", "committedDate": "2020-11-23T16:30:14Z", "message": "Be explicit when stealing trace."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1967, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}