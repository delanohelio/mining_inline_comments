{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NDM4Njcy", "number": 13198, "title": "Use a lock to ensure it is thread safe.", "bodyText": "@toregge or @vekterli PR", "createdAt": "2020-05-08T21:20:11Z", "url": "https://github.com/vespa-engine/vespa/pull/13198", "merged": true, "mergeCommit": {"oid": "46926aae45554905c7895536391852233f1a8a5b"}, "closed": true, "closedAt": "2020-05-08T23:22:18Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfYmclgH2gAyNDE1NDM4NjcyOmRhZTM4Y2RmMmY4YmQ3NGRlNDg1MTMwYzNmZTYzZmI5MTcyOWZjZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgMcByAFqTQwOTAxNzE5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dae38cdf2f8bd74de485130c3fe63fb91729fce1", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/dae38cdf2f8bd74de485130c3fe63fb91729fce1", "committedDate": "2020-05-08T21:17:27Z", "message": "Use a lock to ensure it is thread safe."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NTUxOTQw", "url": "https://github.com/vespa-engine/vespa/pull/13198#pullrequestreview-408551940", "createdAt": "2020-05-08T22:00:17Z", "commit": {"oid": "dae38cdf2f8bd74de485130c3fe63fb91729fce1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQyMjowMDoxN1rOGS0_Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQyMjowNjowM1rOGS1GEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5NTY1MA==", "bodyText": "std::lock_guard<std::mutex> should be sufficient here.", "url": "https://github.com/vespa-engine/vespa/pull/13198#discussion_r422395650", "createdAt": "2020-05-08T22:00:17Z", "author": {"login": "toregge"}, "path": "storage/src/tests/persistence/common/persistenceproviderwrapper.h", "diffHunk": "@@ -50,8 +51,10 @@ class PersistenceProviderWrapper : public spi::AbstractPersistenceProvider\n private:\n     spi::PersistenceProvider& _spi;\n     spi::Result _result;\n+    mutable std::mutex  _lock;\n     mutable std::vector<std::string> _log;\n     uint32_t _failureMask;\n+    using Guard = std::unique_lock<std::mutex>;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dae38cdf2f8bd74de485130c3fe63fb91729fce1"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5NzQ1OQ==", "bodyText": "clearResult() above doesn't seem to be used. Consider removing it.", "url": "https://github.com/vespa-engine/vespa/pull/13198#discussion_r422397459", "createdAt": "2020-05-08T22:06:03Z", "author": {"login": "toregge"}, "path": "storage/src/tests/persistence/common/persistenceproviderwrapper.h", "diffHunk": "@@ -61,12 +64,16 @@ class PersistenceProviderWrapper : public spi::AbstractPersistenceProvider\n      * return the given error without the wrapped SPI ever being invoked.\n      */\n     void setResult(const spi::Result& result) {\n+        Guard guard(_lock);\n         _result = result;\n     }\n     void clearResult() {\n         _result = spi::Result(spi::Result::ErrorType::NONE, \"\");\n     }\n-    const spi::Result& getResult() const { return _result; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dae38cdf2f8bd74de485130c3fe63fb91729fce1"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36b2ee30dd912e44a4f85cd4d2d86046bbbab2ce", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/36b2ee30dd912e44a4f85cd4d2d86046bbbab2ce", "committedDate": "2020-05-08T23:21:03Z", "message": "Remove unused clearResult method, and use std::lock_guard"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDE3MTk2", "url": "https://github.com/vespa-engine/vespa/pull/13198#pullrequestreview-409017196", "createdAt": "2020-05-11T09:41:08Z", "commit": {"oid": "36b2ee30dd912e44a4f85cd4d2d86046bbbab2ce"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3199, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}