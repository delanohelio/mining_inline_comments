{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNjcxMTAy", "number": 12918, "title": "Introduce top-k-probability and use it to fetch correct proper amount\u2026", "bodyText": "\u2026 of hits from each partition\n@bratseth PR\n@jobergum FYI", "createdAt": "2020-04-15T10:20:44Z", "url": "https://github.com/vespa-engine/vespa/pull/12918", "merged": true, "mergeCommit": {"oid": "b2519d490b2bb1d4e28e9c6c5e3ed72ee16b5469"}, "closed": true, "closedAt": "2020-04-16T00:28:52Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX1WvigH2gAyNDAzNjcxMTAyOjcxMmFkODc3ZDUzODQ5NzcyZjI5YjY5NjJhNWNiMjYxMTMxZTM2Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYAyEOgH2gAyNDAzNjcxMTAyOmNjNDM2ZjQwMjExODMwMGE1ZmZiYTIyMzQ4MGNkNjNkYTIzNDUwMDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/712ad877d53849772f29b6962a5cb261131e3668", "committedDate": "2020-04-15T10:16:09Z", "message": "Introduce top-k-probability and use it to fetch correct proper amount of hits from each partition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjUxNzY2", "url": "https://github.com/vespa-engine/vespa/pull/12918#pullrequestreview-393651766", "createdAt": "2020-04-15T10:33:21Z", "commit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozMzoyMVrOGFzsmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDo0MTo1MVrOGFz-vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MzA2Ng==", "bodyText": "Not: It's just a single formula", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408743066", "createdAt": "2020-04-15T10:33:21Z", "author": {"login": "bratseth"}, "path": "configdefinitions/src/vespa/dispatch.def", "diffHunk": "@@ -23,6 +23,13 @@ distributionPolicy enum { ROUNDROBIN, ADAPTIVE } default=ROUNDROBIN\n ## don't use it if you don't (really) mean it.\n maxHitsPerNode int default=2147483647\n \n+## Probability for getting the correct topK documents.\n+## A value of 1.0 will ask all partitions for topK documents.\n+## Any value between <0, 1> will use a Student T fith 30 degrees freedom and compute a K value that\n+## will give you the topK documents according to this formulae.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NDM2Mg==", "bodyText": "Here perhaps we should say \"for the number of documents specified by the hits parameter\".\nIn general it's a bit strange that \"hits\" is suddenly called \"topK\" just because we optimize, but otoh it makes it easier to search for this :-)", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408744362", "createdAt": "2020-04-15T10:35:43Z", "author": {"login": "bratseth"}, "path": "configdefinitions/src/vespa/dispatch.def", "diffHunk": "@@ -23,6 +23,13 @@ distributionPolicy enum { ROUNDROBIN, ADAPTIVE } default=ROUNDROBIN\n ## don't use it if you don't (really) mean it.\n maxHitsPerNode int default=2147483647\n \n+## Probability for getting the correct topK documents.\n+## A value of 1.0 will ask all partitions for topK documents.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjY1OQ==", "bodyText": "Would be better to move this into the estimator I think. (And then also move it to the top level as a package-visible class).", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408746659", "createdAt": "2020-04-15T10:40:06Z", "author": {"login": "bratseth"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -76,6 +96,9 @@ public SearchCluster(String clusterId, DispatchConfig dispatchConfig, int contai\n         for (Node node : nodes)\n             nodesByHostBuilder.put(node.hostname(), node);\n         this.nodesByHost = nodesByHostBuilder.build();\n+        hitEstimator = ((0.0 < dispatchConfig.topKProbability()) && (dispatchConfig.topKProbability() < 1.0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA==", "bodyText": "Same, why not move this into the estimator.", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408746824", "createdAt": "2020-04-15T10:40:19Z", "author": {"login": "bratseth"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -240,6 +263,12 @@ private void setInRotationOnlyIf(boolean inRotation) {\n             vipStatus.removeFromRotation(clusterId);\n     }\n \n+    public int estimateHitsToFetch(int wantedHits, int numPartitions) {\n+        return ((hitEstimator == null) || (numPartitions <= 1))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NzcxMA==", "bodyText": "Might be quite useful to control this by query? How much you care can depend on use case ...", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408747710", "createdAt": "2020-04-15T10:41:51Z", "author": {"login": "bratseth"}, "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -240,6 +263,12 @@ private void setInRotationOnlyIf(boolean inRotation) {\n             vipStatus.removeFromRotation(clusterId);\n     }\n \n+    public int estimateHitsToFetch(int wantedHits, int numPartitions) {\n+        return ((hitEstimator == null) || (numPartitions <= 1))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA=="}, "originalCommit": {"oid": "712ad877d53849772f29b6962a5cb261131e3668"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cebe16d47872f08472ac52cbfc9e1102fb695da", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/2cebe16d47872f08472ac52cbfc9e1102fb695da", "committedDate": "2020-04-15T11:39:56Z", "message": "Say that we are using commons.math."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4e565c808f7999f561b0dad881f3a34040ab5d7", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/a4e565c808f7999f561b0dad881f3a34040ab5d7", "committedDate": "2020-04-15T11:58:29Z", "message": "Make SearchCluster.TopKEstimator a top level class."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNzEzNjU5", "url": "https://github.com/vespa-engine/vespa/pull/12918#pullrequestreview-393713659", "createdAt": "2020-04-15T12:11:58Z", "commit": {"oid": "a4e565c808f7999f561b0dad881f3a34040ab5d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d07b20d7655d74f0460abc5dfceb7039bb8ec371", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/d07b20d7655d74f0460abc5dfceb7039bb8ec371", "committedDate": "2020-04-15T13:32:56Z", "message": "Add query control of top-k-probability."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3cdaea393449a02f03435fd20e78d622a2abaf3", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/f3cdaea393449a02f03435fd20e78d622a2abaf3", "committedDate": "2020-04-15T13:50:22Z", "message": "Use camelcase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea8be02317e30e7f4d0f8dd02b6dc661eb8fb99a", "author": {"user": null}, "url": "https://github.com/vespa-engine/vespa/commit/ea8be02317e30e7f4d0f8dd02b6dc661eb8fb99a", "committedDate": "2020-04-15T15:13:37Z", "message": "Hide in container-dev what you use in container-search."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d54d3da12ab2a935ac97cf95f4edb49db6ca1c5a", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/d54d3da12ab2a935ac97cf95f4edb49db6ca1c5a", "committedDate": "2020-04-15T15:20:21Z", "message": "Add copyright too."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e43e5c2bbb4fcae4346d25ce9e4b96e9264aaf7c", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/e43e5c2bbb4fcae4346d25ce9e4b96e9264aaf7c", "committedDate": "2020-04-15T16:28:10Z", "message": "common -> commons"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d1d647f1a15bf2c2491b0c28df2888f0359eb7c", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/4d1d647f1a15bf2c2491b0c28df2888f0359eb7c", "committedDate": "2020-04-15T17:18:34Z", "message": "Add export pacaked on org.apache.commons.math3.distribution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40e0e4a802619c90568b79ce7b095de8ae0540b2", "author": {"user": null}, "url": "https://github.com/vespa-engine/vespa/commit/40e0e4a802619c90568b79ce7b095de8ae0540b2", "committedDate": "2020-04-15T18:19:40Z", "message": "Needed here anyway."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3188b0ed12db5c43220e99173b949911a3dcd6b6", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/3188b0ed12db5c43220e99173b949911a3dcd6b6", "committedDate": "2020-04-15T21:30:33Z", "message": "Remove exclude."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc436f402118300a5ffba223480cd63da2345008", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/cc436f402118300a5ffba223480cd63da2345008", "committedDate": "2020-04-15T23:34:57Z", "message": "- Add compile scope in applicatio/pom.xml\n- Exclude in container-dev/pom.xml"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3414, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}