{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2OTYwMzc2", "number": 15875, "title": "Use an injected VespaDocumentAccess for streaming search", "bodyText": "@baldersheim please review. This ensures document access shutdown, and avoids the need for getting config on the first query, when new searchers are constructed. Wee may want to hold merge until the messagebus config consistency issue in the container has been solvedd.", "createdAt": "2020-12-30T14:11:59Z", "url": "https://github.com/vespa-engine/vespa/pull/15875", "merged": true, "mergeCommit": {"oid": "3b17f037ee15828b45f7e271efae102200afa334"}, "closed": true, "closedAt": "2021-06-30T19:24:03Z", "author": {"login": "jonmv"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABeQ3O40gBqjQ2NDQwNjk2MDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABel5XVqAFqTY5NjUyOTk4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee99277aac9399f494ec2f95f325e20107000ddb", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/ee99277aac9399f494ec2f95f325e20107000ddb", "committedDate": "2020-12-30T14:04:08Z", "message": "Use an injected VespaDocumentAccess for streaming search"}, "afterCommit": {"oid": "86b7e6d6d6514ad4de4c2108d1552ddcd047d89e", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/86b7e6d6d6514ad4de4c2108d1552ddcd047d89e", "committedDate": "2021-04-26T10:52:03Z", "message": "Use an injected VespaDocumentAccess for streaming search"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86b7e6d6d6514ad4de4c2108d1552ddcd047d89e", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/86b7e6d6d6514ad4de4c2108d1552ddcd047d89e", "committedDate": "2021-04-26T10:52:03Z", "message": "Use an injected VespaDocumentAccess for streaming search"}, "afterCommit": {"oid": "a4dad58e80bb358027d2bb193f9198250f8d72b0", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/a4dad58e80bb358027d2bb193f9198250f8d72b0", "committedDate": "2021-05-28T12:17:37Z", "message": "Use an injected VespaDocumentAccess for streaming search"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjcyMTA1NTY3", "url": "https://github.com/vespa-engine/vespa/pull/15875#pullrequestreview-672105567", "createdAt": "2021-05-31T08:57:00Z", "commit": {"oid": "a4dad58e80bb358027d2bb193f9198250f8d72b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0zMVQwODo1NzowMFrOJkkv6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0zMVQwODo1NzowMFrOJkkv6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjMzMDYwMw==", "bodyText": "Now we end up promising to run all document access over MessageBus forever just because VdsStreamingSearcher needs it. I suggest it is better to cast there.", "url": "https://github.com/vespa-engine/vespa/pull/15875#discussion_r642330603", "createdAt": "2021-05-31T08:57:00Z", "author": {"login": "bratseth"}, "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/VespaDocumentAccess.java", "diffHunk": "@@ -33,9 +35,8 @@\n public class VespaDocumentAccess extends DocumentAccess {\n \n     private final MessageBusParams parameters;\n-    private final Object monitor = new Object();\n \n-    private DocumentAccess delegate = null;\n+    private final AtomicReference<MessageBusDocumentAccess> delegate = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4dad58e80bb358027d2bb193f9198250f8d72b0"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaed7fa806a307ca712d6f099d089288b8caaf7a", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/eaed7fa806a307ca712d6f099d089288b8caaf7a", "committedDate": "2021-06-30T18:50:15Z", "message": "Use an injected VespaDocumentAccess for streaming search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ceacdab281de851c841d395b1e1fd42c25d4f18", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/9ceacdab281de851c841d395b1e1fd42c25d4f18", "committedDate": "2021-06-30T19:06:52Z", "message": "Cast to MessageBusDocumentAccess only where needed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4dad58e80bb358027d2bb193f9198250f8d72b0", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/a4dad58e80bb358027d2bb193f9198250f8d72b0", "committedDate": "2021-05-28T12:17:37Z", "message": "Use an injected VespaDocumentAccess for streaming search"}, "afterCommit": {"oid": "9ceacdab281de851c841d395b1e1fd42c25d4f18", "author": {"user": {"login": "jonmv", "name": "Jon Marius Venstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/9ceacdab281de851c841d395b1e1fd42c25d4f18", "committedDate": "2021-06-30T19:06:52Z", "message": "Cast to MessageBusDocumentAccess only where needed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njk2NTI5OTg1", "url": "https://github.com/vespa-engine/vespa/pull/15875#pullrequestreview-696529985", "createdAt": "2021-06-30T19:13:40Z", "commit": {"oid": "9ceacdab281de851c841d395b1e1fd42c25d4f18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3798, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}