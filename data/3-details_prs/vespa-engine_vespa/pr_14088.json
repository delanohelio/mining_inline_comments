{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NDYyMTA1", "number": 14088, "title": "Quotas in the configuration server ", "bodyText": "", "createdAt": "2020-08-18T12:21:31Z", "url": "https://github.com/vespa-engine/vespa/pull/14088", "merged": true, "mergeCommit": {"oid": "4746dcd27ad567eb6f00adf773e9ac8fd55ffd35"}, "closed": true, "closedAt": "2020-08-26T07:02:21Z", "author": {"login": "oyving"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_xQA2gH2gAyNDY5NDYyMTA1OjA5Y2YyZDg3MzI2MjdmMzQ5OWRmYTIxNjU4N2MzNGQ2ZjZhMjlhNjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCScxUAH2gAyNDY5NDYyMTA1OjE3N2JlMzVmZWRkZDJmOTkxNmI0YjYwZGQxZjBkMjFmOTI2ZDQ1MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "09cf2d8732627f3499dfa216587c34d6f6a29a67", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/09cf2d8732627f3499dfa216587c34d6f6a29a67", "committedDate": "2020-08-17T12:06:09Z", "message": "Create a quota JSON encoded parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8dd34f536526bed82f19e60e92b98035694764e", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/e8dd34f536526bed82f19e60e92b98035694764e", "committedDate": "2020-08-18T07:37:48Z", "message": "Propagate quota from PrepareParams to ModelContext.Properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84ce756ab8aade82759e9ffdf8101915633f8ede", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/84ce756ab8aade82759e9ffdf8101915633f8ede", "committedDate": "2020-08-18T11:05:59Z", "message": "Persist quota and read it back"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d09d33d7e224e1699ad923937cdd29053f9133d", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/2d09d33d7e224e1699ad923937cdd29053f9133d", "committedDate": "2020-08-20T14:38:37Z", "message": "Check maxClusterSize quota in Validator step"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTczNDUz", "url": "https://github.com/vespa-engine/vespa/pull/14088#pullrequestreview-473173453", "createdAt": "2020-08-24T07:14:42Z", "commit": {"oid": "2d09d33d7e224e1699ad923937cdd29053f9133d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/8fdc33273c6993ea983cf7f3211a0a2628890f17", "committedDate": "2020-08-24T07:16:04Z", "message": "Merge branch 'master' into ogronnesby/configserver-quota"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24ed7ae1a12840c6c5aa5080fe8ca13a67c371e7", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/24ed7ae1a12840c6c5aa5080fe8ca13a67c371e7", "committedDate": "2020-08-24T11:57:06Z", "message": "Default to Quota.empty() in TestProperties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "257f4b21f4755efc29e51738e919029610e04e98", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/257f4b21f4755efc29e51738e919029610e04e98", "committedDate": "2020-08-24T11:57:55Z", "message": "Merge branch 'ogronnesby/configserver-quota' of github.com:vespa-engine/vespa into ogronnesby/configserver-quota"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzgxNjk0", "url": "https://github.com/vespa-engine/vespa/pull/14088#pullrequestreview-473381694", "createdAt": "2020-08-24T11:33:51Z", "commit": {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozMzo1MVrOHFgbwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxODowOVrOHFhuAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNjMyMg==", "bodyText": "Add javadoc and author. Quota for what? \ud83d\ude42", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475536322", "createdAt": "2020-08-24T11:33:51Z", "author": {"login": "mpolden"}, "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.yahoo.config.model.api;\n+\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.slime.SlimeUtils;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+public class Quota {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNjkwNQ==", "bodyText": "Nit: Consider OptionalInt.", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475536905", "createdAt": "2020-08-24T11:35:03Z", "author": {"login": "mpolden"}, "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.yahoo.config.model.api;\n+\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.slime.SlimeUtils;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+public class Quota {\n+    private final Optional<Integer> maxClusterSize;\n+    private final Optional<Integer> budget;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNzIwMw==", "bodyText": "IllegalArgumentException?", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475537203", "createdAt": "2020-08-24T11:35:42Z", "author": {"login": "mpolden"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.deploy.DeployState;\n+import com.yahoo.config.provision.ClusterSpec;\n+import com.yahoo.vespa.model.VespaModel;\n+\n+import java.util.stream.Collectors;\n+\n+public class QuotaValidator extends Validator {\n+    @Override\n+    public void validate(VespaModel model, DeployState deployState) {\n+        var quota = deployState.getProperties().quota();\n+        quota.maxClusterSize().ifPresent(maxClusterSize -> validateMaxClusterSize(maxClusterSize, model));\n+    }\n+\n+    private void validateMaxClusterSize(int maxClusterSize, VespaModel model) {\n+        var invalidClusters = model.allClusters().stream()\n+                .filter(clusterId -> {\n+                    var cluster = model.provisioned().all().get(clusterId);\n+                    var clusterSize = cluster.maxResources().nodes();\n+                    return clusterSize > maxClusterSize;\n+                })\n+                .map(ClusterSpec.Id::value)\n+                .collect(Collectors.toList());\n+\n+        if (!invalidClusters.isEmpty()) {\n+            // TODO(ogronnesby): Find better exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NjM4Mg==", "bodyText": "Nit: Consider OptionalLong.", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475556382", "createdAt": "2020-08-24T12:16:12Z", "author": {"login": "mpolden"}, "path": "vespajlib/src/main/java/com/yahoo/slime/SlimeUtils.java", "diffHunk": "@@ -124,6 +124,13 @@ public static Slime jsonToSlimeOrThrow(byte[] json) {\n         return Optional.of(inspector.asString()).filter(s -> !s.isEmpty());\n     }\n \n+    public static Optional<Long> optionalLong(Inspector inspector) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "257f4b21f4755efc29e51738e919029610e04e98"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NjkwNQ==", "bodyText": "Add javadoc and author.", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475556905", "createdAt": "2020-08-24T12:17:12Z", "author": {"login": "mpolden"}, "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.deploy.DeployState;\n+import com.yahoo.config.provision.ClusterSpec;\n+import com.yahoo.vespa.model.VespaModel;\n+\n+import java.util.stream.Collectors;\n+\n+public class QuotaValidator extends Validator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "257f4b21f4755efc29e51738e919029610e04e98"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NzM3Ng==", "bodyText": "Missing author.", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475557376", "createdAt": "2020-08-24T12:18:09Z", "author": {"login": "mpolden"}, "path": "config-model/src/test/java/com/yahoo/vespa/model/application/validation/QuotaValidatorTest.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.api.Quota;\n+import com.yahoo.config.model.deploy.TestProperties;\n+import com.yahoo.config.provision.Environment;\n+import org.junit.Test;\n+\n+import java.util.Optional;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class QuotaValidatorTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "257f4b21f4755efc29e51738e919029610e04e98"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "committedDate": "2020-08-24T13:21:14Z", "message": "Javadoc and authors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "728cac3f63f404bd9ed21d16dbd6b6d9680a014e", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/728cac3f63f404bd9ed21d16dbd6b6d9680a014e", "committedDate": "2020-08-25T07:53:42Z", "message": "Merge remote-tracking branch 'origin/master' into ogronnesby/configserver-quota"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "177be35feddd2f9916b4b60dd1f0d21f926d4526", "author": {"user": {"login": "oyving", "name": "\u00d8yvind Gr\u00f8nnesby"}}, "url": "https://github.com/vespa-engine/vespa/commit/177be35feddd2f9916b4b60dd1f0d21f926d4526", "committedDate": "2020-08-25T07:54:48Z", "message": "Fix parameter type after it was changed on master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4412, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}