{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMzMzMDU0", "number": 15128, "title": "Check if the lid might block due to missing commit.", "bodyText": "If so pill back and reschedule.\nRescheduling will give a busy loop, but that is rare and find.\n@toregge PR\nA test is need, and ditto for lidspace job.", "createdAt": "2020-10-30T23:44:46Z", "url": "https://github.com/vespa-engine/vespa/pull/15128", "merged": true, "mergeCommit": {"oid": "24d17917639a9bda0600fa3adec57f5fd4bbdec2"}, "closed": true, "closedAt": "2020-10-31T15:47:11Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXvjYwgH2gAyNTEzMzMzMDU0OmY2Y2I1YzI0YTQwOTUzYjZlOGQxMzBlYTNiMzllZGM5M2ExYjAyMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdX9V1UgH2gAyNTEzMzMzMDU0OjM5NzcwZjQwZDMyNjFkNmQ3ZTMzOGMwZmRlNGViOTYxMWRkOGExMDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "committedDate": "2020-10-30T23:41:41Z", "message": "Check if the lid might block due to missing commit.\nIf so pill back and reschedule.\nRescheduling will give a busy loop, but that is rare and find."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDk0MzA4", "url": "https://github.com/vespa-engine/vespa/pull/15128#pullrequestreview-521094308", "createdAt": "2020-10-31T00:22:59Z", "commit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyMjo1OVrOHrjdXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDoyODo1N1rOHrjgqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTc3Mg==", "bodyText": "Consider adding braces to fix style here.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515431772", "createdAt": "2020-10-31T00:22:59Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "diffHunk": "@@ -125,14 +125,15 @@ BucketMoveJob::moveDocuments(DocumentBucketMover &mover,\n         bucketGuard = _frozenBuckets.acquireExclusiveBucket(mover.getBucket());\n         if (! bucketGuard) {\n             maybeDelayMover(mover, mover.getBucket());\n-            return;\n+            return true;\n         }\n     }\n     assert(mover.getBucket() == bucketGuard->getBucket());\n-    mover.moveDocuments(maxDocsToMove);\n+    if ( ! mover.moveDocuments(maxDocsToMove)) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTk1MA==", "bodyText": "Consider adding braces to fix style.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515431950", "createdAt": "2020-10-31T00:24:16Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "diffHunk": "@@ -334,7 +335,10 @@ BucketMoveJob::run()\n     if (isBlocked()) {\n         return true; // indicate work is done, since node state is bad\n     }\n-    scanAndMove(200, 1);\n+    /// Returning false here will immediately post the job back on the executor. This will give a busy loop,\n+    /// but this is considered fine as it is very rare and it will be intermingled with multiple feed operations.\n+    if ( ! scanAndMove(200, 1) ) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjE2OQ==", "bodyText": "Consider adding braces to fix style.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432169", "createdAt": "2020-10-31T00:25:30Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "diffHunk": "@@ -19,14 +19,15 @@ namespace proton {\n \n typedef IDocumentMetaStore::Iterator Iterator;\n \n-void\n+bool\n DocumentBucketMover::moveDocument(DocumentIdT lid,\n                                   const document::GlobalId &gid,\n                                   Timestamp timestamp)\n {\n-    Document::SP doc(_source->retriever()->getFullDocument(lid).release());\n+    if ( _source->lidNeedsCommit(lid) ) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjI3Nw==", "bodyText": "Consider adding braces to fix style.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432277", "createdAt": "2020-10-31T00:26:12Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "diffHunk": "@@ -131,8 +134,9 @@ DocumentBucketMover::moveDocuments(size_t maxDocsToMove)\n         setBucketDone();\n     }\n     for (const MoveKey & key : toMove) {\n-        moveDocument(key._lid, key._gid, key._timestamp);\n+        if ( ! moveDocument(key._lid, key._gid, key._timestamp)) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjYxOA==", "bodyText": "Consider adding != nullptr for a more standard style with pointer checks.", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432618", "createdAt": "2020-10-31T00:28:57Z", "author": {"login": "toregge"}, "path": "searchcore/src/vespa/searchcore/proton/server/maintenancedocumentsubdb.cpp", "diffHunk": "@@ -38,4 +41,10 @@ MaintenanceDocumentSubDB::clear()\n     _feed_view.reset();\n }\n \n+bool\n+MaintenanceDocumentSubDB::lidNeedsCommit(search::DocumentIdT lid) const {\n+    return (_pendingLidsForCommit &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39770f40d3261d6d7e338c0fde4eb9611dd8a109", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/39770f40d3261d6d7e338c0fde4eb9611dd8a109", "committedDate": "2020-10-31T15:45:33Z", "message": "Use braces."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2077, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}