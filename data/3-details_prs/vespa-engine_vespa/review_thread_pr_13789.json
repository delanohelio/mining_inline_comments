{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNTE0NjQy", "number": 13789, "reviewThreads": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDozOToxOFrOEQOK2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyNjo1NlrOEW0QRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NDQ0ODI2OnYy", "diffSide": "RIGHT", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/identifiers/MetricsType.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDozOToxOFrOG0QbqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwODowNToyNlrOG1XYkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0ODM2MA==", "bodyText": "Where is this used?", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r457448360", "createdAt": "2020-07-20T14:39:18Z", "author": {"login": "olaaun"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/identifiers/MetricsType.java", "diffHunk": "@@ -0,0 +1,24 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.api.identifiers;\n+\n+/**\n+ * @author akvalsvik\n+ */\n+public class MetricsType extends SerializedIdentifier {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYxMDgzNQ==", "bodyText": "In the implementation.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r458610835", "createdAt": "2020-07-22T08:05:26Z", "author": {"login": "Oracien"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/identifiers/MetricsType.java", "diffHunk": "@@ -0,0 +1,24 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.api.identifiers;\n+\n+/**\n+ * @author akvalsvik\n+ */\n+public class MetricsType extends SerializedIdentifier {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0ODM2MA=="}, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NDU0MTQzOnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsV1Retriever.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDo1NDoxM1rOG0RR4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMTozODowMVrOG1eisA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2MjI0Mw==", "bodyText": "No need to specify V1 in this and DeploymentsMetrics", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r457462243", "createdAt": "2020-07-20T14:54:13Z", "author": {"login": "olaaun"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsV1Retriever.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import java.net.URI;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ForkJoinPool;\n+import java.util.concurrent.TimeUnit;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import static com.yahoo.vespa.config.server.metrics.ClusterDeploymentMetricsV1Retriever.doMetricsRequest;\n+import static com.yahoo.vespa.config.server.metrics.ClusterDeploymentMetricsV1Retriever.getClusterInfoFromDimensions;\n+\n+public class ClusterProtonMetricsV1Retriever {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyODExMg==", "bodyText": "Done", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r458728112", "createdAt": "2020-07-22T11:38:01Z", "author": {"login": "Oracien"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsV1Retriever.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import java.net.URI;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ForkJoinPool;\n+import java.util.concurrent.TimeUnit;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import static com.yahoo.vespa.config.server.metrics.ClusterDeploymentMetricsV1Retriever.doMetricsRequest;\n+import static com.yahoo.vespa.config.server.metrics.ClusterDeploymentMetricsV1Retriever.getClusterInfoFromDimensions;\n+\n+public class ClusterProtonMetricsV1Retriever {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2MjI0Mw=="}, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NDU1NzQ5OnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsV1Retriever.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDo1Njo0NFrOG0RbJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNDo0Nzo0N1rOG48GbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NDYxNA==", "bodyText": "This endpoint is usable only on container nodes, and will return metrics for all nodes. Additionally, it will have a slightly different dimension set, so reusing getClusterInfoFromDimensions won't work.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r457464614", "createdAt": "2020-07-20T14:56:44Z", "author": {"login": "olaaun"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsV1Retriever.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.yahoo.config.model.api.HostInfo;\n+import com.yahoo.config.model.api.ServiceInfo;\n+import com.yahoo.container.handler.metrics.JsonResponse;\n+import com.yahoo.vespa.config.server.application.Application;\n+import java.net.URI;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class ProtonMetricsV1Retriever {\n+\n+    private final ClusterProtonMetricsV1Retriever metricsRetriever;\n+    public ProtonMetricsV1Retriever() {\n+        this( new ClusterProtonMetricsV1Retriever());\n+    }\n+\n+    public ProtonMetricsV1Retriever(ClusterProtonMetricsV1Retriever metricsRetriever) {\n+        this.metricsRetriever = metricsRetriever;\n+    }\n+\n+    public JsonResponse getMetrics(Application application) {\n+        var hosts = getHostsOfApplication(application);\n+        var clusterMetrics = metricsRetriever.requestMetricsGroupedByCluster(hosts);\n+        JSONObject jsonMetrics;\n+        try {\n+            jsonMetrics = buildJSONObject(clusterMetrics);\n+        } catch (JSONException e) {\n+            jsonMetrics = new JSONObject();\n+        }\n+        return new JsonResponse(200, jsonMetrics.toString());\n+    }\n+\n+    public JSONObject buildJSONObject(Map<ClusterInfo, JSONObject> clusterMetrics) throws JSONException {\n+        JSONObject response = new JSONObject();\n+        response.put(\"name\", \"proton.metrics.aggregated\");\n+        JSONArray metrics = new JSONArray();\n+\n+        for (Map.Entry<ClusterInfo, JSONObject> entry : clusterMetrics.entrySet()) {\n+            JSONObject jsonEntry = new JSONObject();\n+            jsonEntry.put(\"cluster.id\", entry.getKey().getClusterId());\n+            jsonEntry.put(\"cluster.type\", entry.getKey().getClusterType());\n+            jsonEntry.put(\"metrics\", entry.getValue());\n+            metrics.put(jsonEntry);\n+        }\n+        response.put(\"metrics\", metrics);\n+        return response;\n+    }\n+\n+    private static Collection<URI> getHostsOfApplication(Application application) {\n+        return application.getModel().getHosts().stream()\n+                .filter(host -> host.getServices().stream().noneMatch(isLogserver()))\n+                .map(HostInfo::getHostname)\n+                .map(ProtonMetricsV1Retriever::createMetricsProxyURI)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private static Predicate<ServiceInfo> isLogserver() {\n+        return serviceInfo -> serviceInfo.getServiceType().equalsIgnoreCase(\"logserver\");\n+    }\n+\n+    private static URI createMetricsProxyURI(String hostname) {\n+        return URI.create(\"http://\" + hostname + \":4080/metrics/v2/values\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1ODEyNA==", "bodyText": "Changed to based on the /metrics/v2/values default path, should be correct for 1 node or all nodes.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r462358124", "createdAt": "2020-07-29T14:47:47Z", "author": {"login": "Oracien"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsV1Retriever.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.yahoo.config.model.api.HostInfo;\n+import com.yahoo.config.model.api.ServiceInfo;\n+import com.yahoo.container.handler.metrics.JsonResponse;\n+import com.yahoo.vespa.config.server.application.Application;\n+import java.net.URI;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class ProtonMetricsV1Retriever {\n+\n+    private final ClusterProtonMetricsV1Retriever metricsRetriever;\n+    public ProtonMetricsV1Retriever() {\n+        this( new ClusterProtonMetricsV1Retriever());\n+    }\n+\n+    public ProtonMetricsV1Retriever(ClusterProtonMetricsV1Retriever metricsRetriever) {\n+        this.metricsRetriever = metricsRetriever;\n+    }\n+\n+    public JsonResponse getMetrics(Application application) {\n+        var hosts = getHostsOfApplication(application);\n+        var clusterMetrics = metricsRetriever.requestMetricsGroupedByCluster(hosts);\n+        JSONObject jsonMetrics;\n+        try {\n+            jsonMetrics = buildJSONObject(clusterMetrics);\n+        } catch (JSONException e) {\n+            jsonMetrics = new JSONObject();\n+        }\n+        return new JsonResponse(200, jsonMetrics.toString());\n+    }\n+\n+    public JSONObject buildJSONObject(Map<ClusterInfo, JSONObject> clusterMetrics) throws JSONException {\n+        JSONObject response = new JSONObject();\n+        response.put(\"name\", \"proton.metrics.aggregated\");\n+        JSONArray metrics = new JSONArray();\n+\n+        for (Map.Entry<ClusterInfo, JSONObject> entry : clusterMetrics.entrySet()) {\n+            JSONObject jsonEntry = new JSONObject();\n+            jsonEntry.put(\"cluster.id\", entry.getKey().getClusterId());\n+            jsonEntry.put(\"cluster.type\", entry.getKey().getClusterType());\n+            jsonEntry.put(\"metrics\", entry.getValue());\n+            metrics.put(jsonEntry);\n+        }\n+        response.put(\"metrics\", metrics);\n+        return response;\n+    }\n+\n+    private static Collection<URI> getHostsOfApplication(Application application) {\n+        return application.getModel().getHosts().stream()\n+                .filter(host -> host.getServices().stream().noneMatch(isLogserver()))\n+                .map(HostInfo::getHostname)\n+                .map(ProtonMetricsV1Retriever::createMetricsProxyURI)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private static Predicate<ServiceInfo> isLogserver() {\n+        return serviceInfo -> serviceInfo.getServiceType().equalsIgnoreCase(\"logserver\");\n+    }\n+\n+    private static URI createMetricsProxyURI(String hostname) {\n+        return URI.create(\"http://\" + hostname + \":4080/metrics/v2/values\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NDYxNA=="}, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NDU2NjgxOnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterDeploymentMetricsV1Retriever.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDo1ODoxOFrOG0Rgrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMTozODoyMlrOG1ejUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NjAzMQ==", "bodyText": "Instead of removing private, extract functions to separate class", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r457466031", "createdAt": "2020-07-20T14:58:18Z", "author": {"login": "olaaun"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterDeploymentMetricsV1Retriever.java", "diffHunk": "@@ -97,7 +97,7 @@ private static void getHostMetrics(URI hostURI, Map<ClusterInfo, MetricsAggregat\n             );\n     }\n \n-    private static Slime doMetricsRequest(URI hostURI) {\n+    static Slime doMetricsRequest(URI hostURI) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyODI3Mg==", "bodyText": "done", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r458728272", "createdAt": "2020-07-22T11:38:22Z", "author": {"login": "Oracien"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterDeploymentMetricsV1Retriever.java", "diffHunk": "@@ -97,7 +97,7 @@ private static void getHostMetrics(URI hostURI, Map<ClusterInfo, MetricsAggregat\n             );\n     }\n \n-    private static Slime doMetricsRequest(URI hostURI) {\n+    static Slime doMetricsRequest(URI hostURI) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NjAzMQ=="}, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NDU5Mzg5OnYy", "diffSide": "RIGHT", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/configserver/ConfigServer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNTowMjozN1rOG0RwlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNDo0NzoyMlrOG48FFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MDEwMA==", "bodyText": "Instead of JSONObject, return a ProtonMetrics object, which can do validation and aggregation", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r457470100", "createdAt": "2020-07-20T15:02:37Z", "author": {"login": "olaaun"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/configserver/ConfigServer.java", "diffHunk": "@@ -53,7 +54,9 @@\n      */\n     InputStream getLogs(DeploymentId deployment, Map<String, String> queryParameters);\n \n-    List<ClusterMetrics> getMetrics(DeploymentId deployment);\n+    List<ClusterMetrics> getDeploymentMetricsV1(DeploymentId deployment);\n+\n+    JSONObject getProtonMetricsV1(DeploymentId deployment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1Nzc4Mw==", "bodyText": "Implemented", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r462357783", "createdAt": "2020-07-29T14:47:22Z", "author": {"login": "Oracien"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/configserver/ConfigServer.java", "diffHunk": "@@ -53,7 +54,9 @@\n      */\n     InputStream getLogs(DeploymentId deployment, Map<String, String> queryParameters);\n \n-    List<ClusterMetrics> getMetrics(DeploymentId deployment);\n+    List<ClusterMetrics> getDeploymentMetricsV1(DeploymentId deployment);\n+\n+    JSONObject getProtonMetricsV1(DeploymentId deployment);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MDEwMA=="}, "originalCommit": {"oid": "336c2c6aadeb96efe2c5291ae15edc2ae99f6018"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NzQzMzExOnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetriever.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzo1MzoyNVrOG2Lk1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNDo0Njo0MFrOG48DKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2NTk0MA==", "bodyText": "services is a list of JSON objects. You want the objects where the name field is vespa.searchnode", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r459465940", "createdAt": "2020-07-23T13:53:25Z", "author": {"login": "olaaun"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetriever.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import ai.vespa.util.http.VespaHttpClientBuilder;\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.yolean.Exceptions;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ForkJoinPool;\n+import java.util.concurrent.TimeUnit;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.apache.http.client.config.RequestConfig;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.conn.PoolingHttpClientConnectionManager;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import static com.yahoo.vespa.config.server.metrics.MetricsSlime.doMetricsRequest;\n+import static com.yahoo.vespa.config.server.metrics.MetricsSlime.getClusterInfoFromDimensions;\n+\n+public class ClusterProtonMetricsRetriever {\n+\n+    private static final Logger log = Logger.getLogger(ClusterProtonMetricsRetriever.class.getName());\n+\n+    private static final CloseableHttpClient httpClient = VespaHttpClientBuilder\n+                                                            .create(PoolingHttpClientConnectionManager::new)\n+                                                            .setDefaultRequestConfig(\n+                                                                    RequestConfig.custom()\n+                                                                            .setConnectTimeout(10 * 1000)\n+                                                                            .setSocketTimeout(10 * 1000)\n+                                                                            .build())\n+                                                            .build();\n+\n+    private static final List<String> DESIRED_METRICS = List.of(\n+            \"content.proton.documentdb.documents.active.last\",\n+            \"content.proton.documentdb.documents.ready.last\",\n+            \"content.proton.documentdb.documents.total.last\",\n+            \"content.proton.documentdb.disk_usage.last\",\n+            \"content.proton.resource_usage.disk.average\",\n+            \"content.proton.resource_usage.memory.average\"\n+    );\n+\n+    public List<ProtonMetricsAggregator> requestMetrics(Collection<URI> hosts) {\n+        List<ProtonMetricsAggregator> protonMetrics = new ArrayList<>();\n+\n+        long startTime = System.currentTimeMillis();\n+        Runnable retrieveMetricsJob = () ->\n+                hosts.parallelStream().forEach(host ->\n+                        addMetricsFromHost(host, protonMetrics)\n+                );\n+\n+        ForkJoinPool threadPool = new ForkJoinPool(10);\n+        threadPool.submit(retrieveMetricsJob);\n+        threadPool.shutdown();\n+\n+        try {\n+            threadPool.awaitTermination(1, TimeUnit.MINUTES);\n+        } catch (InterruptedException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        log.log(Level.FINE, () ->\n+                String.format(\"Proton metric retrieval for %d nodes took %d milliseconds\", hosts.size(), System.currentTimeMillis() - startTime)\n+        );\n+\n+        return protonMetrics;\n+    }\n+\n+    private static void addMetricsFromHost(URI hostURI, List<ProtonMetricsAggregator> protonMetrics) {\n+        Slime hostResponseBody;\n+        try {\n+            hostResponseBody = doMetricsRequest(hostURI, httpClient);\n+        } catch (IOException e) {\n+            log.info(\"Was unable to fetch metrics from \" + hostURI + \" : \" + Exceptions.toMessageString(e));\n+            hostResponseBody = new Slime();\n+        }\n+        var parseError = hostResponseBody.get().field(\"error_message\");\n+\n+        if (parseError.valid()) {\n+            log.info(\"Failed to retrieve metrics from \" + hostURI + \": \" + parseError.asString());\n+        }\n+\n+\n+        Inspector metric = hostResponseBody.get().field(\"services\").field(3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f57c4f9cd660b46a8c4cb093482d20fba79501f1"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1NzI5MA==", "bodyText": "made a recursive traverser, but it is highly inefficient", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r462357290", "createdAt": "2020-07-29T14:46:40Z", "author": {"login": "Oracien"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetriever.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import ai.vespa.util.http.VespaHttpClientBuilder;\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.yolean.Exceptions;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ForkJoinPool;\n+import java.util.concurrent.TimeUnit;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.apache.http.client.config.RequestConfig;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.conn.PoolingHttpClientConnectionManager;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import static com.yahoo.vespa.config.server.metrics.MetricsSlime.doMetricsRequest;\n+import static com.yahoo.vespa.config.server.metrics.MetricsSlime.getClusterInfoFromDimensions;\n+\n+public class ClusterProtonMetricsRetriever {\n+\n+    private static final Logger log = Logger.getLogger(ClusterProtonMetricsRetriever.class.getName());\n+\n+    private static final CloseableHttpClient httpClient = VespaHttpClientBuilder\n+                                                            .create(PoolingHttpClientConnectionManager::new)\n+                                                            .setDefaultRequestConfig(\n+                                                                    RequestConfig.custom()\n+                                                                            .setConnectTimeout(10 * 1000)\n+                                                                            .setSocketTimeout(10 * 1000)\n+                                                                            .build())\n+                                                            .build();\n+\n+    private static final List<String> DESIRED_METRICS = List.of(\n+            \"content.proton.documentdb.documents.active.last\",\n+            \"content.proton.documentdb.documents.ready.last\",\n+            \"content.proton.documentdb.documents.total.last\",\n+            \"content.proton.documentdb.disk_usage.last\",\n+            \"content.proton.resource_usage.disk.average\",\n+            \"content.proton.resource_usage.memory.average\"\n+    );\n+\n+    public List<ProtonMetricsAggregator> requestMetrics(Collection<URI> hosts) {\n+        List<ProtonMetricsAggregator> protonMetrics = new ArrayList<>();\n+\n+        long startTime = System.currentTimeMillis();\n+        Runnable retrieveMetricsJob = () ->\n+                hosts.parallelStream().forEach(host ->\n+                        addMetricsFromHost(host, protonMetrics)\n+                );\n+\n+        ForkJoinPool threadPool = new ForkJoinPool(10);\n+        threadPool.submit(retrieveMetricsJob);\n+        threadPool.shutdown();\n+\n+        try {\n+            threadPool.awaitTermination(1, TimeUnit.MINUTES);\n+        } catch (InterruptedException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        log.log(Level.FINE, () ->\n+                String.format(\"Proton metric retrieval for %d nodes took %d milliseconds\", hosts.size(), System.currentTimeMillis() - startTime)\n+        );\n+\n+        return protonMetrics;\n+    }\n+\n+    private static void addMetricsFromHost(URI hostURI, List<ProtonMetricsAggregator> protonMetrics) {\n+        Slime hostResponseBody;\n+        try {\n+            hostResponseBody = doMetricsRequest(hostURI, httpClient);\n+        } catch (IOException e) {\n+            log.info(\"Was unable to fetch metrics from \" + hostURI + \" : \" + Exceptions.toMessageString(e));\n+            hostResponseBody = new Slime();\n+        }\n+        var parseError = hostResponseBody.get().field(\"error_message\");\n+\n+        if (parseError.valid()) {\n+            log.info(\"Failed to retrieve metrics from \" + hostURI + \": \" + parseError.asString());\n+        }\n+\n+\n+        Inspector metric = hostResponseBody.get().field(\"services\").field(3);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2NTk0MA=="}, "originalCommit": {"oid": "f57c4f9cd660b46a8c4cb093482d20fba79501f1"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NzQzNzQ3OnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetriever.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzo1NDoxOFrOG2Lnhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzo1NDoxOFrOG2Lnhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2NjYzMQ==", "bodyText": "Unused", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r459466631", "createdAt": "2020-07-23T13:54:18Z", "author": {"login": "olaaun"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetriever.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import ai.vespa.util.http.VespaHttpClientBuilder;\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.yolean.Exceptions;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ForkJoinPool;\n+import java.util.concurrent.TimeUnit;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.apache.http.client.config.RequestConfig;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.conn.PoolingHttpClientConnectionManager;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import static com.yahoo.vespa.config.server.metrics.MetricsSlime.doMetricsRequest;\n+import static com.yahoo.vespa.config.server.metrics.MetricsSlime.getClusterInfoFromDimensions;\n+\n+public class ClusterProtonMetricsRetriever {\n+\n+    private static final Logger log = Logger.getLogger(ClusterProtonMetricsRetriever.class.getName());\n+\n+    private static final CloseableHttpClient httpClient = VespaHttpClientBuilder\n+                                                            .create(PoolingHttpClientConnectionManager::new)\n+                                                            .setDefaultRequestConfig(\n+                                                                    RequestConfig.custom()\n+                                                                            .setConnectTimeout(10 * 1000)\n+                                                                            .setSocketTimeout(10 * 1000)\n+                                                                            .build())\n+                                                            .build();\n+\n+    private static final List<String> DESIRED_METRICS = List.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f57c4f9cd660b46a8c4cb093482d20fba79501f1"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NzQ1OTQ2OnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsAggregator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzo1ODoxNVrOG2L03Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzo1ODoxNVrOG2L03Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ3MDA0NQ==", "bodyText": "I suggest splitting these into separate strings, making the addAll function more readable.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r459470045", "createdAt": "2020-07-23T13:58:15Z", "author": {"login": "olaaun"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsAggregator.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.yahoo.slime.Inspector;\n+import java.util.List;\n+\n+public class ProtonMetricsAggregator {\n+\n+    private static final List<String> DESIRED_METRICS = List.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f57c4f9cd660b46a8c4cb093482d20fba79501f1"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NzUxNDQ2OnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsAggregator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNDoxMDoyMFrOG2MXYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNDo0NjoyMFrOG48CMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ3ODg4MQ==", "bodyText": "Two notes on this class:\n\nAn application can have more than one content cluster, so it'd be useful if these metrics are aggregated per cluster.\nIf I'm reading this right, the aggregation just sums the values. At least the percentage based metrics should be averaged instead", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r459478881", "createdAt": "2020-07-23T14:10:20Z", "author": {"login": "olaaun"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsAggregator.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.yahoo.slime.Inspector;\n+import java.util.List;\n+\n+public class ProtonMetricsAggregator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f57c4f9cd660b46a8c4cb093482d20fba79501f1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1NzA0MA==", "bodyText": "Fixed in aggregator + cluster retriever.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r462357040", "createdAt": "2020-07-29T14:46:20Z", "author": {"login": "Oracien"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsAggregator.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.yahoo.slime.Inspector;\n+import java.util.List;\n+\n+public class ProtonMetricsAggregator {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ3ODg4MQ=="}, "originalCommit": {"oid": "f57c4f9cd660b46a8c4cb093482d20fba79501f1"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NDU4NTY5OnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsRetriever.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMzowMToyMFrOG6HsZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMzowMToyMFrOG6HsZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5NjY0Ng==", "bodyText": "Use port 19092", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r463596646", "createdAt": "2020-07-31T13:01:20Z", "author": {"login": "olaaun"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/metrics/ProtonMetricsRetriever.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.yahoo.config.model.api.HostInfo;\n+import com.yahoo.config.model.api.ServiceInfo;\n+import com.yahoo.vespa.config.server.application.Application;\n+import com.yahoo.vespa.config.server.http.v2.ProtonMetricsResponse;\n+import java.net.URI;\n+import java.util.Collection;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+\n+public class ProtonMetricsRetriever {\n+\n+    private final ClusterProtonMetricsRetriever metricsRetriever;\n+    public ProtonMetricsRetriever() {\n+        this( new ClusterProtonMetricsRetriever());\n+    }\n+\n+    public ProtonMetricsRetriever(ClusterProtonMetricsRetriever metricsRetriever) {\n+        this.metricsRetriever = metricsRetriever;\n+    }\n+\n+    public ProtonMetricsResponse getMetrics(Application application) {\n+        var hosts = getHostsOfApplication(application);\n+        var clusterMetrics = metricsRetriever.requestMetricsGroupedByCluster(hosts);\n+        return new ProtonMetricsResponse(200, application.getId(), clusterMetrics);\n+    }\n+\n+    private static Collection<URI> getHostsOfApplication(Application application) {\n+        return application.getModel().getHosts().stream()\n+                .filter(host -> host.getServices().stream().anyMatch(isSearchNode()))\n+                .map(HostInfo::getHostname)\n+                .map(ProtonMetricsRetriever::createMetricsProxyURI)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private static Predicate<ServiceInfo> isSearchNode() {\n+        return serviceInfo -> serviceInfo.getServiceType().equalsIgnoreCase(\"searchnode\");\n+    }\n+    private static URI createMetricsProxyURI(String hostname) {\n+        return URI.create(\"http://\" + hostname + \":4080/metrics/v2/values\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90233299c17399067d8bf03e58b17652f0b48bc5"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NDU5ODgwOnYy", "diffSide": "RIGHT", "path": "configserver/src/test/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetrieverTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMzowNTozMFrOG6H0YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMzowNTozMFrOG6H0YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5ODY4OQ==", "bodyText": "It would be good to have a list of two hosts, each having different metric values. Then we would have some actual aggregation", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r463598689", "createdAt": "2020-07-31T13:05:30Z", "author": {"login": "olaaun"}, "path": "configserver/src/test/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetrieverTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.github.tomakehurst.wiremock.junit.WireMockRule;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.get;\n+import static com.github.tomakehurst.wiremock.client.WireMock.stubFor;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+import static com.github.tomakehurst.wiremock.core.WireMockConfiguration.options;\n+import static org.junit.Assert.assertEquals;\n+\n+public class ClusterProtonMetricsRetrieverTest {\n+\n+    @Rule\n+    public final WireMockRule wireMock = new WireMockRule(options().dynamicPort(), true);\n+\n+    @Test\n+    public void testMetricAggregation() throws IOException {\n+        Collection<URI> host = List.of(URI.create(\"http://localhost:\" + wireMock.port() +\"/metrics/v2/values\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90233299c17399067d8bf03e58b17652f0b48bc5"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NDYwMzMwOnYy", "diffSide": "RIGHT", "path": "configserver/src/test/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetrieverTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMzowNzowMVrOG6H3NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMzowNzowMVrOG6H3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5OTQxMg==", "bodyText": "This file can be shortened significantly. It's a sample response from a :4080/metrics/v2 call, which includes metrics from the irrelevant container and logserver nodes as well.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r463599412", "createdAt": "2020-07-31T13:07:01Z", "author": {"login": "olaaun"}, "path": "configserver/src/test/java/com/yahoo/vespa/config/server/metrics/ClusterProtonMetricsRetrieverTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.config.server.metrics;\n+\n+import com.github.tomakehurst.wiremock.junit.WireMockRule;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.get;\n+import static com.github.tomakehurst.wiremock.client.WireMock.stubFor;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+import static com.github.tomakehurst.wiremock.core.WireMockConfiguration.options;\n+import static org.junit.Assert.assertEquals;\n+\n+public class ClusterProtonMetricsRetrieverTest {\n+\n+    @Rule\n+    public final WireMockRule wireMock = new WireMockRule(options().dynamicPort(), true);\n+\n+    @Test\n+    public void testMetricAggregation() throws IOException {\n+        Collection<URI> host = List.of(URI.create(\"http://localhost:\" + wireMock.port() +\"/metrics/v2/values\"));\n+\n+        stubFor(get(urlEqualTo(\"/metrics/v2/values\"))\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withBody(nodeMetrics())));\n+\n+        String expectedClusterName = \"content/content/0/0\";\n+        Map<String, ProtonMetricsAggregator> aggregatorMap = new ClusterProtonMetricsRetriever().requestMetricsGroupedByCluster(host);\n+\n+        compareAggregators(\n+                new ProtonMetricsAggregator()\n+                .addDocumentReadyCount(1275)\n+                .addDocumentActiveCount(1275)\n+                .addDocumentTotalCount(1275)\n+                .addDocumentDiskUsage(14781856)\n+                .addResourceDiskUsageAverage(0.0009083386306)\n+                .addResourceMemoryUsageAverage(0.0183488434436),\n+                aggregatorMap.get(expectedClusterName)\n+        );\n+\n+        wireMock.stop();\n+    }\n+\n+    private String nodeMetrics() throws IOException {\n+        return Files.readString(Path.of(\"src/test/resources/metrics/node_metrics\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90233299c17399067d8bf03e58b17652f0b48bc5"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzcyMDE2OnYy", "diffSide": "RIGHT", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/configserver/ConfigServer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOToyNzo0N1rOG7YkJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOToyNzo0N1rOG7YkJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyMTYzNg==", "bodyText": "Unused", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r464921636", "createdAt": "2020-08-04T09:27:47Z", "author": {"login": "olaaun"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/configserver/ConfigServer.java", "diffHunk": "@@ -18,6 +19,7 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n+import org.json.JSONObject;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8742b0b08a8567114670507bd28a8cf11d7bcf04"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzczOTk2OnYy", "diffSide": "RIGHT", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/metric/ConfigServerMetrics.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozMzoxNVrOG7YwQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTo0MjoyNVrOG7ZFFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNDczOQ==", "bodyText": "It's not really this class' responsibility to create HTTP responses, it does metric aggregation.\nYou can build the response directly in ApplicationApiHandler", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r464924739", "createdAt": "2020-08-04T09:33:15Z", "author": {"login": "olaaun"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/metric/ConfigServerMetrics.java", "diffHunk": "@@ -62,4 +71,20 @@ private double weightedAverageLatency(List<ClusterMetrics> metrics,\n         return weightedLatency / rateSum;\n     }\n \n+    public JsonResponse buildResponseFromProtonMetrics(List<ProtonMetrics> protonMetrics) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8742b0b08a8567114670507bd28a8cf11d7bcf04"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzMDA2OA==", "bodyText": "Done", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r464930068", "createdAt": "2020-08-04T09:42:25Z", "author": {"login": "Oracien"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/metric/ConfigServerMetrics.java", "diffHunk": "@@ -62,4 +71,20 @@ private double weightedAverageLatency(List<ClusterMetrics> metrics,\n         return weightedLatency / rateSum;\n     }\n \n+    public JsonResponse buildResponseFromProtonMetrics(List<ProtonMetrics> protonMetrics) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNDczOQ=="}, "originalCommit": {"oid": "8742b0b08a8567114670507bd28a8cf11d7bcf04"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzc0MjU5OnYy", "diffSide": "RIGHT", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/metric/ConfigServerMetrics.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozNDowMVrOG7Yx5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozNDowMVrOG7Yx5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNTE1OA==", "bodyText": "What's the meaning behind this field?", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r464925158", "createdAt": "2020-08-04T09:34:01Z", "author": {"login": "olaaun"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/metric/ConfigServerMetrics.java", "diffHunk": "@@ -62,4 +71,20 @@ private double weightedAverageLatency(List<ClusterMetrics> metrics,\n         return weightedLatency / rateSum;\n     }\n \n+    public JsonResponse buildResponseFromProtonMetrics(List<ProtonMetrics> protonMetrics) {\n+        try {\n+            var jsonObject = new JSONObject();\n+            jsonObject.put(\"name\", \"proton.metrics.application\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8742b0b08a8567114670507bd28a8cf11d7bcf04"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzc0NDk3OnYy", "diffSide": "RIGHT", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozNDo0MFrOG7YzVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozNDo0MFrOG7YzVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNTUyNA==", "bodyText": "Add unit test for this.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r464925524", "createdAt": "2020-08-04T09:34:40Z", "author": {"login": "olaaun"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -644,6 +646,16 @@ public void render(OutputStream outputStream) throws IOException {\n         };\n     }\n \n+    private HttpResponse metrics(String tenantName, String applicationName, String instanceName, String environment, String region) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8742b0b08a8567114670507bd28a8cf11d7bcf04"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzc0OTM1OnYy", "diffSide": "RIGHT", "path": "controller-server/src/test/java/com/yahoo/vespa/hosted/controller/integration/ConfigServerMock.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozNTo0N1rOG7Y19w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozNTo0N1rOG7Y19w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNjE5OQ==", "bodyText": "This is no longer a method of ConfigServer", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r464926199", "createdAt": "2020-08-04T09:35:47Z", "author": {"login": "olaaun"}, "path": "controller-server/src/test/java/com/yahoo/vespa/hosted/controller/integration/ConfigServerMock.java", "diffHunk": "@@ -445,10 +452,15 @@ public ApplicationView getApplicationView(String tenantName, String applicationN\n     }\n \n     @Override\n-    public List<ClusterMetrics> getMetrics(DeploymentId deployment) {\n+    public List<ClusterMetrics> getDeploymentMetricsV1(DeploymentId deployment) {\n         return Collections.unmodifiableList(clusterMetrics.getOrDefault(deployment, List.of()));\n     }\n \n+    @Override\n+    public JSONObject getProtonMetricsV1(DeploymentId deployment) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8742b0b08a8567114670507bd28a8cf11d7bcf04"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzU3NTQzOnYy", "diffSide": "RIGHT", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyMToxMlrOG-QqCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyMToxMlrOG-QqCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzNzgwMA==", "bodyText": "Also log exception", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r467937800", "createdAt": "2020-08-10T14:21:12Z", "author": {"login": "freva"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -647,6 +653,31 @@ public void render(OutputStream outputStream) throws IOException {\n         };\n     }\n \n+    private HttpResponse metrics(String tenantName, String applicationName, String instanceName, String environment, String region) {\n+        ApplicationId application = ApplicationId.from(tenantName, applicationName, instanceName);\n+        ZoneId zone = ZoneId.from(environment, region);\n+        DeploymentId deployment = new DeploymentId(application, zone);\n+        List<ProtonMetrics> protonMetrics = controller.serviceRegistry().configServer().getProtonMetrics(deployment);\n+        return buildResponseFromProtonMetrics(protonMetrics);\n+    }\n+\n+    private JsonResponse buildResponseFromProtonMetrics(List<ProtonMetrics> protonMetrics) {\n+        try {\n+            var jsonObject = new JSONObject();\n+            var jsonArray = new JSONArray();\n+            for (ProtonMetrics metrics : protonMetrics) {\n+                jsonArray.put(metrics.toJson());\n+            }\n+            jsonObject.put(\"metrics\", jsonArray);\n+            return new JsonResponse(200, jsonObject.toString());\n+        } catch (JSONException e) {\n+            log.severe(\"Unable to build JsonResponse with Proton data\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzU3NjUzOnYy", "diffSide": "RIGHT", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyMToyOVrOG-QqyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyMToyOVrOG-QqyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzNzk5Mg==", "bodyText": "Add some error message here as well", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r467937992", "createdAt": "2020-08-10T14:21:29Z", "author": {"login": "freva"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -647,6 +653,31 @@ public void render(OutputStream outputStream) throws IOException {\n         };\n     }\n \n+    private HttpResponse metrics(String tenantName, String applicationName, String instanceName, String environment, String region) {\n+        ApplicationId application = ApplicationId.from(tenantName, applicationName, instanceName);\n+        ZoneId zone = ZoneId.from(environment, region);\n+        DeploymentId deployment = new DeploymentId(application, zone);\n+        List<ProtonMetrics> protonMetrics = controller.serviceRegistry().configServer().getProtonMetrics(deployment);\n+        return buildResponseFromProtonMetrics(protonMetrics);\n+    }\n+\n+    private JsonResponse buildResponseFromProtonMetrics(List<ProtonMetrics> protonMetrics) {\n+        try {\n+            var jsonObject = new JSONObject();\n+            var jsonArray = new JSONArray();\n+            for (ProtonMetrics metrics : protonMetrics) {\n+                jsonArray.put(metrics.toJson());\n+            }\n+            jsonObject.put(\"metrics\", jsonArray);\n+            return new JsonResponse(200, jsonObject.toString());\n+        } catch (JSONException e) {\n+            log.severe(\"Unable to build JsonResponse with Proton data\");\n+            return new JsonResponse(500, \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzU4NTUxOnYy", "diffSide": "RIGHT", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyMzozM1rOG-Qwaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyMzozM1rOG-Qwaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzOTQzNQ==", "bodyText": "tenant/application/environment/region/instance is the legacy order, change this to tenant/application/instance/environment/region", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r467939435", "createdAt": "2020-08-10T14:23:33Z", "author": {"login": "freva"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -228,6 +233,7 @@ private HttpResponse handleGET(Path path, HttpRequest request) {\n         if (path.matches(\"/application/v4/tenant/{tenant}/application/{application}/instance/{instance}/environment/{environment}/region/{region}/nodes\")) return nodes(path.get(\"tenant\"), path.get(\"application\"), path.get(\"instance\"), path.get(\"environment\"), path.get(\"region\"));\n         if (path.matches(\"/application/v4/tenant/{tenant}/application/{application}/instance/{instance}/environment/{environment}/region/{region}/clusters\")) return clusters(path.get(\"tenant\"), path.get(\"application\"), path.get(\"instance\"), path.get(\"environment\"), path.get(\"region\"));\n         if (path.matches(\"/application/v4/tenant/{tenant}/application/{application}/instance/{instance}/environment/{environment}/region/{region}/logs\")) return logs(path.get(\"tenant\"), path.get(\"application\"), path.get(\"instance\"), path.get(\"environment\"), path.get(\"region\"), request.propertyMap());\n+        if (path.matches(\"/application/v4/tenant/{tenant}/application/{application}/environment/{environment}/region/{region}/instance/{instance}/metrics\")) return metrics(path.get(\"tenant\"), path.get(\"application\"), path.get(\"instance\"), path.get(\"environment\"), path.get(\"region\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzU5NTg3OnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ApplicationHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyNTozM1rOG-Q2dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyNTozM1rOG-Q2dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0MDk4MA==", "bodyText": "No need to duplicate path here, it will pick the first one that matches", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r467940980", "createdAt": "2020-08-10T14:25:33Z", "author": {"login": "freva"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ApplicationHandler.java", "diffHunk": "@@ -55,7 +55,8 @@\n             \"http://*/application/v2/tenant/*/application/*/environment/*/region/*/instance/*/serviceconverge\",\n             \"http://*/application/v2/tenant/*/application/*/environment/*/region/*/instance/*/serviceconverge/*\",\n             \"http://*/application/v2/tenant/*/application/*/environment/*/region/*/instance/*/clustercontroller/*/status/*\",\n-            \"http://*/application/v2/tenant/*/application/*/environment/*/region/*/instance/*/metrics\",\n+            \"http://*/application/v2/tenant/*/application/*/environment/*/region/*/instance/*/metrics/*\",\n+            \"http://*/application/v2/tenant/*/application/*/environment/*/region/*/instance/*/metrics/*\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzU5OTIyOnYy", "diffSide": "RIGHT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ProtonMetricsResponse.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyNjoxNlrOG-Q4nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNTowNTozMlrOG-SldQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0MTUzMw==", "bodyText": "Consider extending com.yahoo.restapi.SlimeJsonResponse", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r467941533", "createdAt": "2020-08-10T14:26:16Z", "author": {"login": "freva"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ProtonMetricsResponse.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.yahoo.vespa.config.server.http.v2;\n+\n+import com.yahoo.config.provision.ApplicationId;\n+import com.yahoo.container.jdisc.HttpResponse;\n+import com.yahoo.slime.Cursor;\n+import com.yahoo.slime.JsonFormat;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.vespa.config.server.http.HttpConfigResponse;\n+import com.yahoo.vespa.config.server.metrics.ProtonMetricsAggregator;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Map;\n+\n+public class ProtonMetricsResponse extends HttpResponse {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk2OTM5Nw==", "bodyText": "Implemented, but response handling will most likely need updates.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r467969397", "createdAt": "2020-08-10T15:05:32Z", "author": {"login": "Oracien"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ProtonMetricsResponse.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.yahoo.vespa.config.server.http.v2;\n+\n+import com.yahoo.config.provision.ApplicationId;\n+import com.yahoo.container.jdisc.HttpResponse;\n+import com.yahoo.slime.Cursor;\n+import com.yahoo.slime.JsonFormat;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.vespa.config.server.http.HttpConfigResponse;\n+import com.yahoo.vespa.config.server.metrics.ProtonMetricsAggregator;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Map;\n+\n+public class ProtonMetricsResponse extends HttpResponse {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0MTUzMw=="}, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzYwMjYwOnYy", "diffSide": "LEFT", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ApplicationHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyNjo1NlrOG-Q6jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzoyNzoyOFrOG-ro1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0MjAzMA==", "bodyText": "Is there anything that currently uses the old path?", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r467942030", "createdAt": "2020-08-10T14:26:56Z", "author": {"login": "freva"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ApplicationHandler.java", "diffHunk": "@@ -137,8 +138,12 @@ public HttpResponse handleGET(HttpRequest request) {\n             return applicationRepository.getLogs(applicationId, hostname, apiParams);\n         }\n \n-        if (isMetricsRequest(request)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk2MTQzNA==", "bodyText": "Please see the isVintageMetrics(request) method for now.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r467961434", "createdAt": "2020-08-10T14:54:30Z", "author": {"login": "Oracien"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ApplicationHandler.java", "diffHunk": "@@ -137,8 +138,12 @@ public HttpResponse handleGET(HttpRequest request) {\n             return applicationRepository.getLogs(applicationId, hostname, apiParams);\n         }\n \n-        if (isMetricsRequest(request)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0MjAzMA=="}, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3OTg2MQ==", "bodyText": "No breakage, assuming old path is not used. Removing isVintageMetrics.", "url": "https://github.com/vespa-engine/vespa/pull/13789#discussion_r468379861", "createdAt": "2020-08-11T07:27:28Z", "author": {"login": "Oracien"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/http/v2/ApplicationHandler.java", "diffHunk": "@@ -137,8 +138,12 @@ public HttpResponse handleGET(HttpRequest request) {\n             return applicationRepository.getLogs(applicationId, hostname, apiParams);\n         }\n \n-        if (isMetricsRequest(request)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0MjAzMA=="}, "originalCommit": {"oid": "c3b37ccb08396639216cb28233f6221aba6d36a6"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1842, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}