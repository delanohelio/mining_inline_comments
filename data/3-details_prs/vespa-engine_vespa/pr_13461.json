{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NzQ4NjM4", "number": 13461, "title": "As the source bit vector might change in a different thread,", "bodyText": "ensure that we sample size once to avoid incosistent read outs during copy.\n@toregge PR", "createdAt": "2020-06-02T18:09:38Z", "url": "https://github.com/vespa-engine/vespa/pull/13461", "merged": true, "mergeCommit": {"oid": "2359f4f05befd21c30078bca0bcaee0044ee255f"}, "closed": true, "closedAt": "2020-06-03T10:17:17Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnYyy-AH2gAyNDI2NzQ4NjM4OmIzOGEwOTllYjc5ZWZhOWNmMWZhNGM5ZmNlNjhhNGQ3ZTNkNDIzYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnmrpsAH2gAyNDI2NzQ4NjM4Ojk3ZTY5OTBmMzFmMDE4Y2E5OGQ3N2QyNzM4NGY2MGNjNmZjMzBiNzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b38a099eb79efa9cf1fa4c9fce68a4d7e3d423b5", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/b38a099eb79efa9cf1fa4c9fce68a4d7e3d423b5", "committedDate": "2020-06-02T18:02:20Z", "message": "As the source bit vector might change in a different thread,\nensure that we sample size once to avoid incosistent read outs during copy."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzc1NTQy", "url": "https://github.com/vespa-engine/vespa/pull/13461#pullrequestreview-423375542", "createdAt": "2020-06-03T09:25:54Z", "commit": {"oid": "b38a099eb79efa9cf1fa4c9fce68a4d7e3d423b5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOToyNTo1NFrOGeTmiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOToyNTo1NFrOGeTmiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzMTYyNA==", "bodyText": "If size and capacity is reduced at the same time on the underlying bitvector then capacity can become less than size here.", "url": "https://github.com/vespa-engine/vespa/pull/13461#discussion_r434431624", "createdAt": "2020-06-03T09:25:54Z", "author": {"login": "toregge"}, "path": "searchlib/src/vespa/searchlib/common/allocatedbitvector.cpp", "diffHunk": "@@ -17,6 +17,21 @@ size_t computeCapacity(size_t capacity, size_t allocatedBytes) {\n     return possibleCapacity;\n }\n \n+// This is to ensure that we only read size and capacity once during copy\n+// to ensure that they do not change unexpectedly under our feet due to resizing in different thread.\n+std::pair<BitVector::Index, BitVector::Index>\n+extract_size_size(const BitVector & bv) {\n+    BitVector::Index size = bv.size();\n+    return std::pair<BitVector::Index, BitVector::Index>(size, size);\n+}\n+\n+std::pair<BitVector::Index, BitVector::Index>\n+extract_size_capacity(const AllocatedBitVector & bv) {\n+    BitVector::Index size = bv.size();\n+    BitVector::Index capacity = bv.capacity();\n+    return std::pair<BitVector::Index, BitVector::Index>(size, capacity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b38a099eb79efa9cf1fa4c9fce68a4d7e3d423b5"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4babc05819a7bdf06a1082e238ad0751fbeacf0e", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/4babc05819a7bdf06a1082e238ad0751fbeacf0e", "committedDate": "2020-06-03T09:55:45Z", "message": "Protect against inconsistency when sampling size and capacity."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNDA1MjY1", "url": "https://github.com/vespa-engine/vespa/pull/13461#pullrequestreview-423405265", "createdAt": "2020-06-03T10:04:52Z", "commit": {"oid": "4babc05819a7bdf06a1082e238ad0751fbeacf0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMDowNDo1MlrOGeVBmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMDowNDo1MlrOGeVBmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ1NDkzNw==", "bodyText": "both size() and capacity() are very small inlined methods.  Thus the compiler can just cache the result in a register. You need to add a std::atomic_thread_fence or replace the loop with size = std::min(size, capacity);", "url": "https://github.com/vespa-engine/vespa/pull/13461#discussion_r434454937", "createdAt": "2020-06-03T10:04:52Z", "author": {"login": "toregge"}, "path": "searchlib/src/vespa/searchlib/common/allocatedbitvector.cpp", "diffHunk": "@@ -29,6 +29,12 @@ std::pair<BitVector::Index, BitVector::Index>\n extract_size_capacity(const AllocatedBitVector & bv) {\n     BitVector::Index size = bv.size();\n     BitVector::Index capacity = bv.capacity();\n+    while (capacity < size) {\n+        // Since size and capacity might be changed in another thread we need\n+        // this fallback to avoid inconsistency during shrink.\n+        size = bv.size();\n+        capacity = bv.capacity();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4babc05819a7bdf06a1082e238ad0751fbeacf0e"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97e6990f31f018ca98d77d27384f60cc6fc30b79", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/97e6990f31f018ca98d77d27384f60cc6fc30b79", "committedDate": "2020-06-03T10:13:12Z", "message": "Ensure sequential consistency."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3110, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}