{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNjMxMDI2", "number": 12652, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo0MjoyM1rODp8LVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo0MjoyM1rODp8LVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzA0MTQ5OnYy", "diffSide": "RIGHT", "path": "node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo0MjoyM1rOF5bUpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo0OTowNVrOF5bkdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MDgwNg==", "bodyText": "is -> it?", "url": "https://github.com/vespa-engine/vespa/pull/12652#discussion_r395760806", "createdAt": "2020-03-20T16:42:23Z", "author": {"login": "freva"}, "path": "node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java", "diffHunk": "@@ -148,32 +148,42 @@ public void delete_host_only_after_all_the_children_have_been_deleted() {\n     }\n \n     @Test\n-    public void deprovisioned_hosts_are_resurrected_on_add() {\n+    public void relevant_information_from_deprovisioned_hosts_are_merged_into_readded_host() {\n         NodeRepositoryTester tester = new NodeRepositoryTester();\n         Instant testStart = tester.nodeRepository().clock().instant();\n \n-        ((ManualClock)tester.nodeRepository().clock()).advance(Duration.ofSeconds(1));\n+        tester.clock().advance(Duration.ofSeconds(1));\n         tester.addNode(\"id1\", \"host1\", \"default\", NodeType.host);\n         tester.addNode(\"id2\", \"host2\", \"default\", NodeType.host);\n         assertFalse(tester.nodeRepository().getNode(\"host1\").get().history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n \n-        // Set host 1 properties and remove it\n+        // Set host 1 properties and deprovision it\n         Node host1 = tester.nodeRepository().getNode(\"host1\").get();\n         host1 = host1.withWantToRetire(true, Agent.system, tester.nodeRepository().clock().instant());\n         host1 = host1.with(host1.status().withWantToDeprovision(true));\n+        host1 = host1.withFirmwareVerifiedAt(tester.clock().instant());\n+        host1 = host1.with(host1.status().withIncreasedFailCount());\n+        host1 = host1.with(host1.reports().withReport(Report.basicReport(\"id\", Report.Type.HARD_FAIL, tester.clock().instant(), \"Test report\")));\n         tester.nodeRepository().write(host1, tester.nodeRepository().lock(host1));\n         tester.nodeRepository().removeRecursively(\"host1\");\n \n         // Host 1 is deprovisioned and unwanted properties are cleared\n         host1 = tester.nodeRepository().getNode(\"host1\").get();\n         assertEquals(Node.State.deprovisioned, host1.state());\n         assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n-        assertFalse(host1.status().wantToRetire());\n-        assertFalse(host1.status().wantToDeprovision());\n \n-        // Adding it again moves it from deprovisioned\n-        host1 = tester.addNode(\"id1\", \"host1\", \"default\", NodeType.host);\n-        assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n+        // Adding it again preserves some information from the deprovisioned host and removes is", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9355926f5faec617354279b02adcf56ae59b4f9f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2NDg1Mw==", "bodyText": "Thanks", "url": "https://github.com/vespa-engine/vespa/pull/12652#discussion_r395764853", "createdAt": "2020-03-20T16:49:05Z", "author": {"login": "bratseth"}, "path": "node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java", "diffHunk": "@@ -148,32 +148,42 @@ public void delete_host_only_after_all_the_children_have_been_deleted() {\n     }\n \n     @Test\n-    public void deprovisioned_hosts_are_resurrected_on_add() {\n+    public void relevant_information_from_deprovisioned_hosts_are_merged_into_readded_host() {\n         NodeRepositoryTester tester = new NodeRepositoryTester();\n         Instant testStart = tester.nodeRepository().clock().instant();\n \n-        ((ManualClock)tester.nodeRepository().clock()).advance(Duration.ofSeconds(1));\n+        tester.clock().advance(Duration.ofSeconds(1));\n         tester.addNode(\"id1\", \"host1\", \"default\", NodeType.host);\n         tester.addNode(\"id2\", \"host2\", \"default\", NodeType.host);\n         assertFalse(tester.nodeRepository().getNode(\"host1\").get().history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n \n-        // Set host 1 properties and remove it\n+        // Set host 1 properties and deprovision it\n         Node host1 = tester.nodeRepository().getNode(\"host1\").get();\n         host1 = host1.withWantToRetire(true, Agent.system, tester.nodeRepository().clock().instant());\n         host1 = host1.with(host1.status().withWantToDeprovision(true));\n+        host1 = host1.withFirmwareVerifiedAt(tester.clock().instant());\n+        host1 = host1.with(host1.status().withIncreasedFailCount());\n+        host1 = host1.with(host1.reports().withReport(Report.basicReport(\"id\", Report.Type.HARD_FAIL, tester.clock().instant(), \"Test report\")));\n         tester.nodeRepository().write(host1, tester.nodeRepository().lock(host1));\n         tester.nodeRepository().removeRecursively(\"host1\");\n \n         // Host 1 is deprovisioned and unwanted properties are cleared\n         host1 = tester.nodeRepository().getNode(\"host1\").get();\n         assertEquals(Node.State.deprovisioned, host1.state());\n         assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n-        assertFalse(host1.status().wantToRetire());\n-        assertFalse(host1.status().wantToDeprovision());\n \n-        // Adding it again moves it from deprovisioned\n-        host1 = tester.addNode(\"id1\", \"host1\", \"default\", NodeType.host);\n-        assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n+        // Adding it again preserves some information from the deprovisioned host and removes is", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MDgwNg=="}, "originalCommit": {"oid": "9355926f5faec617354279b02adcf56ae59b4f9f"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2198, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}