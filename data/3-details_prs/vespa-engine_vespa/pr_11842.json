{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MjA4Njcy", "number": 11842, "title": "accept and store json endpoint cert metadata on deploy", "bodyText": "also refactor from tlsSecretKeys -> several \"endpoint certificate\" classes", "createdAt": "2020-01-17T16:00:42Z", "url": "https://github.com/vespa-engine/vespa/pull/11842", "merged": true, "mergeCommit": {"oid": "5ee42fd430e45766def38d1c0d412781e393f2e2"}, "closed": true, "closedAt": "2020-01-20T12:58:24Z", "author": {"login": "andreer"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7Q7PfgH2gAyMzY0MjA4NjcyOmU2NmUwYmEyY2NkMmI5NzNhMTNlZmY4NjQ1YWY2NjA3M2ViYTMxZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8L5XcAH2gAyMzY0MjA4NjcyOjQ5Yzg5MjlhYjk1MjNhZjNlNzAyYWYwZTA0YjI5OTRlOThhYzg4ZTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e66e0ba2ccd2b973a13eff8645af66073eba31ed", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/e66e0ba2ccd2b973a13eff8645af66073eba31ed", "committedDate": "2020-01-17T15:59:39Z", "message": "accept and store json endpoint cert metadata on deploy\n\nalso refactor from tlsSecretKeys -> several \"endpoint certificate\" classes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MTE2Njkw", "url": "https://github.com/vespa-engine/vespa/pull/11842#pullrequestreview-345116690", "createdAt": "2020-01-20T07:30:11Z", "commit": {"oid": "e66e0ba2ccd2b973a13eff8645af66073eba31ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNzozMDoxMVrOFfVU7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNzozMDo0N1rOFfVVfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5OTU5Nw==", "bodyText": "We've had cases where the version of private key and cert were incompatible. Would it make sense to validate that the cert is indeed issued using the private key?", "url": "https://github.com/vespa-engine/vespa/pull/11842#discussion_r368399597", "createdAt": "2020-01-20T07:30:11Z", "author": {"login": "tokle"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/tenant/EndpointCertificateRetriever.java", "diffHunk": "@@ -0,0 +1,37 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.config.server.tenant;\n+\n+import com.yahoo.config.model.api.EndpointCertificateMetadata;\n+import com.yahoo.config.model.api.EndpointCertificateSecrets;\n+import com.yahoo.container.jdisc.secretstore.SecretStore;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Used to retrieve actual endpoint certificate/key from secret store.\n+ *\n+ * @author andreer\n+ */\n+public class EndpointCertificateRetriever {\n+\n+    private final SecretStore secretStore;\n+\n+    public EndpointCertificateRetriever(SecretStore secretStore) {\n+        this.secretStore = secretStore;\n+    }\n+\n+    public Optional<EndpointCertificateSecrets> readEndpointCertificateSecrets(EndpointCertificateMetadata metadata) {\n+        return Optional.of(readFromSecretStore(metadata));\n+    }\n+\n+    private EndpointCertificateSecrets readFromSecretStore(EndpointCertificateMetadata endpointCertificateMetadata) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66e0ba2ccd2b973a13eff8645af66073eba31ed"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5OTc0Mw==", "bodyText": "Won't this violate the principle of \"serialized on version N+1 can be read by version N\"?", "url": "https://github.com/vespa-engine/vespa/pull/11842#discussion_r368399743", "createdAt": "2020-01-20T07:30:47Z", "author": {"login": "tokle"}, "path": "configserver/src/main/java/com/yahoo/vespa/config/server/tenant/EndpointCertificateMetadataSerializer.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.vespa.config.server.tenant;\n+\n+import com.yahoo.config.model.api.EndpointCertificateMetadata;\n+import com.yahoo.slime.Cursor;\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+\n+/**\n+ * (de)serializes endpoint certificate metadata\n+ *\n+ * @author andreer\n+ */\n+public class EndpointCertificateMetadataSerializer {\n+\n+    // WARNING: Since there are multiple servers in a ZooKeeper cluster and they upgrade one by one\n+    //          (and rewrite all nodes on startup), changes to the serialized format must be made\n+    //          such that what is serialized on version N+1 can be read by version N:\n+    //          - ADDING FIELDS: Always ok\n+    //          - REMOVING FIELDS: Stop reading the field first. Stop writing it on a later version.\n+    //          - CHANGING THE FORMAT OF A FIELD: Don't do it bro.\n+\n+    private final static String keyNameField = \"keyName\";\n+    private final static String certNameField = \"certName\";\n+    private final static String versionField = \"version\";\n+\n+    public static void toSlime(EndpointCertificateMetadata metadata, Cursor object) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66e0ba2ccd2b973a13eff8645af66073eba31ed"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c67da739049f3c392b8d6c16953a771fcb1df5fd", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/c67da739049f3c392b8d6c16953a771fcb1df5fd", "committedDate": "2020-01-20T10:19:41Z", "message": "verify public key matches private key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MjI4ODg1", "url": "https://github.com/vespa-engine/vespa/pull/11842#pullrequestreview-345228885", "createdAt": "2020-01-20T10:58:04Z", "commit": {"oid": "c67da739049f3c392b8d6c16953a771fcb1df5fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db7ae7f2f7e65c01703689a418476f963e3d8dd4", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/db7ae7f2f7e65c01703689a418476f963e3d8dd4", "committedDate": "2020-01-20T11:04:54Z", "message": "use valid cert/key in test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MjQ3ODA2", "url": "https://github.com/vespa-engine/vespa/pull/11842#pullrequestreview-345247806", "createdAt": "2020-01-20T11:34:16Z", "commit": {"oid": "db7ae7f2f7e65c01703689a418476f963e3d8dd4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49c8929ab9523af3e702af0e04b2994e98ac88e7", "author": {"user": {"login": "andreer", "name": "Andreas Eriksen"}}, "url": "https://github.com/vespa-engine/vespa/commit/49c8929ab9523af3e702af0e04b2994e98ac88e7", "committedDate": "2020-01-20T12:42:00Z", "message": "use valid cert/key in test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3932, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}