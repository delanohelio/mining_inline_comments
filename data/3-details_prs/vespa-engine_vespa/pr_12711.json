{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNjMzNTU5", "number": 12711, "title": "Add control over mbus params", "bodyText": "num network threads\nnum connections per target\ntcpnodelay\nDefaults are unchanged.\n\n@vekterlior @havardpe  PR", "createdAt": "2020-03-25T14:50:07Z", "url": "https://github.com/vespa-engine/vespa/pull/12711", "merged": true, "mergeCommit": {"oid": "c63b665680b46a9fcd3cb41e4110947c9060f1b4"}, "closed": true, "closedAt": "2020-03-26T10:18:58Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRIa1qgH2gAyMzkzNjMzNTU5OjViYTQ0OTRjYWNhYjJkZGE3ZTAzN2FlY2QxOGJmOTA1NTAzMzA5NGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRYjyEAFqTM4MTI2NDg0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/5ba4494cacab2dda7e037aecd18bf9055033094d", "committedDate": "2020-03-25T14:31:21Z", "message": "Add control over\n - num network threads\n - num connections per target\n - tcpnodelay\nDefaults are unchanged."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4f448633278360f7cb8ef2135f68291cb021a9f", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/a4f448633278360f7cb8ef2135f68291cb021a9f", "committedDate": "2020-03-25T14:53:32Z", "message": "Use auto and captitalize first word in sentence."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "020c88692058131e4009125e00ff5ca2400a2f31", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/020c88692058131e4009125e00ff5ca2400a2f31", "committedDate": "2020-03-25T15:20:53Z", "message": "Add config control over tcpnodelay for c++ too."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjI4NzY4", "url": "https://github.com/vespa-engine/vespa/pull/12711#pullrequestreview-381228768", "createdAt": "2020-03-25T14:55:29Z", "commit": {"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDo1NToyOVrOF7fFZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTo0Mjo0NFrOF7hZgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxOTU4OQ==", "bodyText": "Personal opinion: calling this \"optimize_for\" or similar would be more descriptive than just \"optimization\" (also applies to C++ config)", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397919589", "createdAt": "2020-03-25T14:55:29Z", "author": {"login": "vekterli"}, "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimization enum {LATENCY, THROUGHPUT} default=LATENCY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyODMxMQ==", "bodyText": "Do we have any numbers that indicate disabling TCP_NODELAY is worth it? We unconditionally enabled nodelay for everything to get rid  of spurious latency spikes incurred by the in-kernel deferred packet sending.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397928311", "createdAt": "2020-03-25T15:06:26Z", "author": {"login": "vekterli"}, "path": "jrt/src/com/yahoo/jrt/Connection.java", "diffHunk": "@@ -89,21 +90,23 @@ private void setState(int state) {\n     }\n \n     public Connection(TransportThread parent, Supervisor owner,\n-                      SocketChannel channel) {\n+                      SocketChannel channel, boolean tcpNoDelay) {\n \n         this.parent = parent;\n         this.owner = owner;\n         this.socket = parent.transport().createServerCryptoSocket(channel);\n         this.spec = null;\n+        this.tcpNoDelay = tcpNoDelay;\n         server = true;\n         owner.sessionInit(this);\n     }\n \n-    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context) {\n+    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context, boolean tcpNoDelay) {\n         super(context);\n         this.parent = parent;\n         this.owner = owner;\n         this.spec = spec;\n+        this.tcpNoDelay = tcpNoDelay;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk1NzUwNQ==", "bodyText": "Consider wrapping in a shouldEnableNoDelay(params) method or similar to make semantics more obvious", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397957505", "createdAt": "2020-03-25T15:42:44Z", "author": {"login": "vekterli"}, "path": "messagebus/src/main/java/com/yahoo/messagebus/network/rpc/RPCNetwork.java", "diffHunk": "@@ -82,7 +82,7 @@ private static int getNumThreads() {\n     public RPCNetwork(RPCNetworkParams params, SlobrokConfigSubscriber slobrokConfig) {\n         this.slobroksConfig = slobrokConfig;\n         identity = params.getIdentity();\n-        orb = new Supervisor(new Transport(2));\n+        orb = new Supervisor(new Transport(params.getNumNetworkThreads(), params.getOptimization() == RPCNetworkParams.Optimization.LATENCY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "020c88692058131e4009125e00ff5ca2400a2f31"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cd7be25c87fca3e558c6c793fb7279762a4a7d7", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/3cd7be25c87fca3e558c6c793fb7279762a4a7d7", "committedDate": "2020-03-25T20:54:27Z", "message": "Use a well named helper method for readability."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4", "committedDate": "2020-03-25T22:30:20Z", "message": "optimization => optimize_for"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjY0ODQx", "url": "https://github.com/vespa-engine/vespa/pull/12711#pullrequestreview-381264841", "createdAt": "2020-03-25T15:30:46Z", "commit": {"oid": "a4f448633278360f7cb8ef2135f68291cb021a9f"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTozMDo0NlrOF7gzmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwOToxODoyNlrOF79qlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzgwMw==", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397947803", "createdAt": "2020-03-25T15:30:46Z", "author": {"login": "havardpe"}, "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimization enum {LATENCY, THROUGHPUT} default=LATENCY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4f448633278360f7cb8ef2135f68291cb021a9f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQxODQ0NQ==", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398418445", "createdAt": "2020-03-26T09:15:01Z", "author": {"login": "havardpe"}, "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimize_for enum {LATENCY, THROUGHPUT} default=LATENCY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDYyOQ==", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398420629", "createdAt": "2020-03-26T09:18:26Z", "author": {"login": "havardpe"}, "path": "storage/src/vespa/storage/config/stor-communicationmanager.def", "diffHunk": "@@ -33,6 +33,8 @@ mbus.rpctargetcache.ttl double default = 600\n ## Any value below 1 will be 1.\n mbus.num_threads int default=4\n \n+mbus.optimize_for enum {LATENCY, THROUGHPUT} default = LATENCY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2630, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}