{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5NDQ0NzUx", "number": 14281, "title": "Import TensorFlow models via ONNX conversion", "bodyText": "@bratseth Please review. Second attempt at converting TF models to ONNX. The main change since last time is the vespa-convert-tf2onnx wrapper script around the direct tf2onnx call we did last time in TensorFlowImporter.java.", "createdAt": "2020-09-04T08:34:49Z", "url": "https://github.com/vespa-engine/vespa/pull/14281", "merged": true, "mergeCommit": {"oid": "503b0ff5037f0db031b3410899e1f9cccb23bd0a"}, "closed": true, "closedAt": "2020-09-04T09:59:00Z", "author": {"login": "lesters"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFfPG-gH2gAyNDc5NDQ0NzUxOjY3Y2FmM2I2ZWVlNjkwYmNkMGM3ZmM3YTc2NjZiZDJjZjQxYjg4MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFhifmAH2gAyNDc5NDQ0NzUxOjVmOTZiZmRjYjRkYmYzODc0M2ZkNGM5M2JhZDllM2FjYWJiYmQzYjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816", "author": {"user": {"login": "lesters", "name": "Lester Solbakken"}}, "url": "https://github.com/vespa-engine/vespa/commit/67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816", "committedDate": "2020-09-04T06:30:25Z", "message": "Import TensorFlow models via ONNX conversion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDcxMjYx", "url": "https://github.com/vespa-engine/vespa/pull/14281#pullrequestreview-482471261", "createdAt": "2020-09-04T08:43:21Z", "commit": {"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0MzoyMVrOHNFGbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0Mzo1MlrOHNFHiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzEwMQ==", "bodyText": "Might be useful to include the last reason here?", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483477101", "createdAt": "2020-09-04T08:43:21Z", "author": {"login": "bratseth"}, "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "diffHunk": "@@ -78,15 +69,18 @@ public ImportedModel importModel(String modelName, String modelDir, SavedModelBu\n     private ImportedModel convertToOnnxAndImport(String modelName, String modelDir) {\n         Path tempDir = null;\n         try {\n-            log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX...\");\n             tempDir = Files.createTempDirectory(\"tf2onnx\");\n             String convertedPath = tempDir.toString() + File.separatorChar + \"converted.onnx\";\n-            Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, defaultOnnxOpset);\n-            if (res.getFirst() != 0) {\n-                throw new IllegalArgumentException(\"Conversion from TensorFlow to ONNX failed for '\" + modelDir + \"'. \" +\n-                        \"Reason: \" + res.getSecond());\n+            for (int opset : onnxOpsetsToTry) {\n+                log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX with opset \" + opset + \"...\");\n+                Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, opset);\n+                if (res.getFirst() == 0) {\n+                    log.info(\"Conversion to ONNX with opset \" + opset + \" successful.\");\n+                    return onnxImporter.importModel(modelName, convertedPath);\n+                }\n+                log.info(\"Conversion to ONNX with opset \" + opset + \" failed. Reason: \" + res.getSecond());\n             }\n-            return onnxImporter.importModel(modelName, convertedPath);\n+            throw new IllegalArgumentException(\"Unable to convert TensorFlow model in '\" + modelDir + \"' to ONNX.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzM4NQ==", "bodyText": "I think this should probably be Level.FINE?", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483477385", "createdAt": "2020-09-04T08:43:52Z", "author": {"login": "bratseth"}, "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "diffHunk": "@@ -78,15 +69,18 @@ public ImportedModel importModel(String modelName, String modelDir, SavedModelBu\n     private ImportedModel convertToOnnxAndImport(String modelName, String modelDir) {\n         Path tempDir = null;\n         try {\n-            log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX...\");\n             tempDir = Files.createTempDirectory(\"tf2onnx\");\n             String convertedPath = tempDir.toString() + File.separatorChar + \"converted.onnx\";\n-            Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, defaultOnnxOpset);\n-            if (res.getFirst() != 0) {\n-                throw new IllegalArgumentException(\"Conversion from TensorFlow to ONNX failed for '\" + modelDir + \"'. \" +\n-                        \"Reason: \" + res.getSecond());\n+            for (int opset : onnxOpsetsToTry) {\n+                log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX with opset \" + opset + \"...\");\n+                Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, opset);\n+                if (res.getFirst() == 0) {\n+                    log.info(\"Conversion to ONNX with opset \" + opset + \" successful.\");\n+                    return onnxImporter.importModel(modelName, convertedPath);\n+                }\n+                log.info(\"Conversion to ONNX with opset \" + opset + \" failed. Reason: \" + res.getSecond());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f96bfdcb4dbf38743fd4c93bad9e3acabbbd3b0", "author": {"user": {"login": "lesters", "name": "Lester Solbakken"}}, "url": "https://github.com/vespa-engine/vespa/commit/5f96bfdcb4dbf38743fd4c93bad9e3acabbbd3b0", "committedDate": "2020-09-04T09:11:24Z", "message": "Add reason for conversion fail to exception"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4402, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}