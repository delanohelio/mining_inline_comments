{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMzkyMzYw", "number": 14528, "title": "Expose locks info in REST API", "bodyText": "", "createdAt": "2020-09-24T11:53:46Z", "url": "https://github.com/vespa-engine/vespa/pull/14528", "merged": true, "mergeCommit": {"oid": "2d84a79ce45d7bae3bdaf06c3c0ac48f2a03c71c"}, "closed": true, "closedAt": "2020-09-28T13:27:34Z", "author": {"login": "hakonhall"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL_2PaAH2gAyNDkyMzkyMzYwOjA2OTcxNmQ2MTBkYmVhNmZhNThlMDA5Y2FjOGM1NDk1YzVlN2QwNmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNS4hqgFqTQ5NzQ2NzQyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "069716d610dbea6fa58e009cac8c5495c5e7d06d", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/069716d610dbea6fa58e009cac8c5495c5e7d06d", "committedDate": "2020-09-24T11:53:40Z", "message": "Expose locks info in REST API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTI2NjQy", "url": "https://github.com/vespa-engine/vespa/pull/14528#pullrequestreview-495526642", "createdAt": "2020-09-24T12:40:00Z", "commit": {"oid": "069716d610dbea6fa58e009cac8c5495c5e7d06d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMjo0MDowMVrOHXYrYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMjo1Njo1NVrOHXZWKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4MzYxOA==", "bodyText": "Is this done to track the re-entry count?", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r494283618", "createdAt": "2020-09-24T12:40:01Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/main/java/com/yahoo/vespa/curator/ThreadLockInfo.java", "diffHunk": "@@ -0,0 +1,125 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.curator;\n+\n+import java.time.Duration;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.function.Consumer;\n+\n+/**\n+ * This class contains process-wide statistics and information related to acquiring and releasing\n+ * {@link Lock}.  Instances of this class contain information tied to a specific thread and lock path.\n+ *\n+ * <p>Instances of this class are thread-safe as long as foreign threads (!= this.thread) avoid mutable methods.</p>\n+ */\n+public class ThreadLockInfo {\n+\n+    private static final ConcurrentHashMap<Thread, ThreadLockInfo> locks = new ConcurrentHashMap<>();\n+\n+    private static final int MAX_COMPLETED_LOCK_INFOS_SIZE = 10;\n+    private static final ConcurrentLinkedDeque<LockInfo> completedLockInfos = new ConcurrentLinkedDeque<>();\n+\n+    private static final AtomicInteger invokeAcquireCount = new AtomicInteger(0);\n+    private static final AtomicInteger inCriticalRegionCount = new AtomicInteger(0);\n+    private static final AtomicInteger acquireTimedOutCount = new AtomicInteger(0);\n+    private static final AtomicInteger lockAcquiredCount = new AtomicInteger(0);\n+    private static final AtomicInteger locksReleasedCount = new AtomicInteger(0);\n+\n+    private static final AtomicInteger failedToAcquireReentrantLockCount = new AtomicInteger(0);\n+    private static final AtomicInteger noLocksErrorCount = new AtomicInteger(0);\n+    private static final AtomicInteger timeoutOnReentrancyErrorCount = new AtomicInteger(0);\n+\n+    private final Thread thread;\n+    private final String lockPath;\n+    private final ReentrantLock lock;\n+\n+    /** The locks are reentrant so there may be more than 1 lock for this thread. */\n+    private final ConcurrentLinkedQueue<LockInfo> lockInfos = new ConcurrentLinkedQueue<>();\n+\n+    public static int invokeAcquireCount() { return invokeAcquireCount.get(); }\n+    public static int inCriticalRegionCount() { return inCriticalRegionCount.get(); }\n+    public static int acquireTimedOutCount() { return acquireTimedOutCount.get(); }\n+    public static int lockAcquiredCount() { return lockAcquiredCount.get(); }\n+    public static int locksReleasedCount() { return locksReleasedCount.get(); }\n+    public static int noLocksErrorCount() { return noLocksErrorCount.get(); }\n+    public static int failedToAcquireReentrantLockCount() { return failedToAcquireReentrantLockCount.get(); }\n+    public static int timeoutOnReentrancyErrorCount() { return timeoutOnReentrancyErrorCount.get(); }\n+    public static List<ThreadLockInfo> getThreadLockInfos() { return List.copyOf(locks.values()); }\n+\n+    /** Returns the per-thread singleton ThreadLockInfo. */\n+    static ThreadLockInfo getCurrentThreadLockInfo(String lockPath, ReentrantLock lock) {\n+        return locks.computeIfAbsent(\n+                Thread.currentThread(),\n+                currentThread -> new ThreadLockInfo(currentThread, lockPath, lock));\n+    }\n+\n+    ThreadLockInfo(Thread currentThread, String lockPath, ReentrantLock lock) {\n+        this.thread = currentThread;\n+        this.lockPath = lockPath;\n+        this.lock = lock;\n+    }\n+\n+    public String getThreadName() { return thread.getName(); }\n+    public String getLockPath() { return lockPath; }\n+    public List<LockInfo> getLockInfos() { return List.copyOf(lockInfos); }\n+\n+    /** Mutable method (see class doc) */\n+    void invokingAcquire(Duration timeout) {\n+        invokeAcquireCount.incrementAndGet();\n+        inCriticalRegionCount.incrementAndGet();\n+        lockInfos.add(LockInfo.invokingAcquire(lock.getHoldCount(), timeout));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "069716d610dbea6fa58e009cac8c5495c5e7d06d"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4NzA5Mw==", "bodyText": "Maybe LockMetrics is a better name for this?", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r494287093", "createdAt": "2020-09-24T12:45:51Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/main/java/com/yahoo/vespa/curator/LockInfo.java", "diffHunk": "@@ -0,0 +1,64 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.curator;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+\n+/**\n+ * Information about a lock.\n+ *\n+ * <p>Should be mutated by a single thread.  Other threads may see an inconsistent state of this instance.</p>\n+ */\n+public class LockInfo {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "069716d610dbea6fa58e009cac8c5495c5e7d06d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI5NDE5OA==", "bodyText": "Missing author/javadoc. Applies to some of the other classes as well.", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r494294198", "createdAt": "2020-09-24T12:56:20Z", "author": {"login": "mpolden"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/restapi/LocksResponse.java", "diffHunk": "@@ -0,0 +1,73 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.provision.restapi;\n+\n+import com.yahoo.container.jdisc.HttpResponse;\n+import com.yahoo.slime.Cursor;\n+import com.yahoo.slime.JsonFormat;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.vespa.curator.LockInfo;\n+import com.yahoo.vespa.curator.ThreadLockInfo;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.time.Instant;\n+import java.util.List;\n+\n+public class LocksResponse extends HttpResponse {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "069716d610dbea6fa58e009cac8c5495c5e7d06d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI5NDU3MA==", "bodyText": "Unintentional reformatting?", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r494294570", "createdAt": "2020-09-24T12:56:55Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/main/java/com/yahoo/vespa/curator/Lock.java", "diffHunk": "@@ -32,12 +32,20 @@ public Lock(String lockPath, Curator curator) {\n \n     /** Take the lock with the given timeout. This may be called multiple times from the same thread - each matched by a close */\n     public void acquire(Duration timeout) throws UncheckedTimeoutException {\n+        ThreadLockInfo threadLockInfo = getThreadLockInfo();\n+        threadLockInfo.invokingAcquire(timeout);\n         try {\n-            if ( ! mutex.acquire(timeout.toMillis(), TimeUnit.MILLISECONDS))\n+            if ( ! mutex.acquire(timeout.toMillis(), TimeUnit.MILLISECONDS)) {\n+                threadLockInfo.acquireTimedOut();\n+\n                 throw new UncheckedTimeoutException(\"Timed out after waiting \" + timeout +\n-                                                    \" to acquire lock '\" + lockPath + \"'\");\n+                        \" to acquire lock '\" + lockPath + \"'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "069716d610dbea6fa58e009cac8c5495c5e7d06d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88db94528ecbb96f88e30c5fa69ea9427e8ef0a7", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/88db94528ecbb96f88e30c5fa69ea9427e8ef0a7", "committedDate": "2020-09-24T13:15:32Z", "message": "Count events per zk path and move to separate package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "731ec8fb898164b066b64d26019a74aa13b08710", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/731ec8fb898164b066b64d26019a74aa13b08710", "committedDate": "2020-09-24T15:05:54Z", "message": "Also show the longest-living historical locks, with stack trace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18cf8e6154be4d6d1fb0399ba9fec2d26408740d", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/18cf8e6154be4d6d1fb0399ba9fec2d26408740d", "committedDate": "2020-09-24T15:25:11Z", "message": "Make stacktraces for active locks during request handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed06bab257cbaba2a2ea21df3d51f91d5ba6470c", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/ed06bab257cbaba2a2ea21df3d51f91d5ba6470c", "committedDate": "2020-09-25T06:58:45Z", "message": "Avoid double iteration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "032d45a7cdab3ab4f358ac0371a5d6b0eb57415a", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/032d45a7cdab3ab4f358ac0371a5d6b0eb57415a", "committedDate": "2020-09-25T07:23:24Z", "message": "Add duration of acquire, in locked, and total"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afbbe9c191ebdaf9ab8d84c727d53825f69fe64f", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/afbbe9c191ebdaf9ab8d84c727d53825f69fe64f", "committedDate": "2020-09-25T10:18:27Z", "message": "Remove reentrant lock no longer needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce446b7bc567d541b061d72ec0c5d2aa6fe7392e", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/ce446b7bc567d541b061d72ec0c5d2aa6fe7392e", "committedDate": "2020-09-25T13:40:48Z", "message": "Adds method name to stack trace and adds timeout count and test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3097883d260238fdd883034f9448c4d63e08e3fc", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/3097883d260238fdd883034f9448c4d63e08e3fc", "committedDate": "2020-09-25T21:34:10Z", "message": "Fill stack trace for all threads in critical region"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e38ba64f8253746739674720035d11bdcda5e155", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/e38ba64f8253746739674720035d11bdcda5e155", "committedDate": "2020-09-25T22:20:28Z", "message": "Dump stack trace once per thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7118a218d4704b52ed9883e4ff381a519adb7c1", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/d7118a218d4704b52ed9883e4ff381a519adb7c1", "committedDate": "2020-09-26T16:33:19Z", "message": "Mock lock path from thread to per-lock (bug)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48", "committedDate": "2020-09-28T10:10:38Z", "message": "Use deque as stack"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NDAyNzc1", "url": "https://github.com/vespa-engine/vespa/pull/14528#pullrequestreview-497402775", "createdAt": "2020-09-28T10:59:56Z", "commit": {"oid": "afbbe9c191ebdaf9ab8d84c727d53825f69fe64f"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMDo1OTo1NlrOHY4pdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMToyMzowN1rOHY5VUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1NTk5MQ==", "bodyText": "Did it became redundant now or has it always been?", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495855991", "createdAt": "2020-09-28T10:59:56Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/main/java/com/yahoo/vespa/curator/Lock.java", "diffHunk": "@@ -21,51 +20,38 @@\n  */\n public class Lock implements Mutex {\n \n-    private final ReentrantLock lock;\n     private final InterProcessLock mutex;\n     private final String lockPath;\n \n     public Lock(String lockPath, Curator curator) {\n         this.lockPath = lockPath;\n-        this.lock = new ReentrantLock(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afbbe9c191ebdaf9ab8d84c727d53825f69fe64f"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1NjQ0NQ==", "bodyText": "Fine for now, but I think we should extract this into a top-level /debug/ API if we intend to keep it.", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495856445", "createdAt": "2020-09-28T11:00:56Z", "author": {"login": "mpolden"}, "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/restapi/NodesV2ApiHandler.java", "diffHunk": "@@ -116,6 +116,7 @@ private HttpResponse handleGET(HttpRequest request) {\n         if (pathS.startsWith(\"/nodes/v2/state/\")) return new NodesResponse(ResponseType.nodesInStateList, request, orchestrator, nodeRepository);\n         if (pathS.startsWith(\"/nodes/v2/acl/\")) return new NodeAclResponse(request, nodeRepository);\n         if (pathS.equals(    \"/nodes/v2/command/\")) return new ResourceResponse(request.getUri(), \"restart\", \"reboot\");\n+        if (pathS.equals(    \"/nodes/v2/locks\")) return new LocksResponse();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1ODgwMA==", "bodyText": "Bug in test template? Copyright should be on first line.", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495858800", "createdAt": "2020-09-28T11:05:49Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/test/java/com/yahoo/vespa/curator/stats/LockInfoSamplesTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.yahoo.vespa.curator.stats;// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1OTIyOA==", "bodyText": "Same as above.", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495859228", "createdAt": "2020-09-28T11:06:44Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/test/java/com/yahoo/vespa/curator/stats/LockTest.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package com.yahoo.vespa.curator.stats;// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1OTY2OQ==", "bodyText": "Missing @author.", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495859669", "createdAt": "2020-09-28T11:07:43Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/test/java/com/yahoo/vespa/curator/stats/LockInfoSamplesTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.yahoo.vespa.curator.stats;// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+import org.junit.Test;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+public class LockInfoSamplesTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1OTcxOA==", "bodyText": "Same as above.", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495859718", "createdAt": "2020-09-28T11:07:50Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/test/java/com/yahoo/vespa/curator/stats/LockTest.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package com.yahoo.vespa.curator.stats;// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+import com.yahoo.vespa.curator.Lock;\n+import org.apache.curator.framework.recipes.locks.InterProcessLock;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.time.Duration;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertSame;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyLong;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class LockTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NTMwNw==", "bodyText": "How about LockAttempt? Info is very generic.", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495865307", "createdAt": "2020-09-28T11:19:25Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/main/java/com/yahoo/vespa/curator/stats/LockInfo.java", "diffHunk": "@@ -0,0 +1,99 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.curator.stats;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+\n+/**\n+ * Information about a lock.\n+ *\n+ * <p>Should be mutated by a single thread, except {@link #fillStackTrace()} which can be\n+ * invoked by any threads.  Other threads may see an inconsistent state of this instance.</p>\n+ *\n+ * @author hakon\n+ */\n+public class LockInfo {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NTkwOA==", "bodyText": "ThreadLockStats? Matches the javadoc.", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495865908", "createdAt": "2020-09-28T11:20:36Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/main/java/com/yahoo/vespa/curator/stats/ThreadLockInfo.java", "diffHunk": "@@ -0,0 +1,139 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.curator.stats;\n+\n+import com.yahoo.vespa.curator.Lock;\n+\n+import java.time.Duration;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.function.Consumer;\n+\n+/**\n+ * This class contains process-wide statistics and information related to acquiring and releasing\n+ * {@link Lock}.  Instances of this class contain information tied to a specific thread and lock path.\n+ *\n+ * <p>Instances of this class are thread-safe as long as foreign threads (!= this.thread) avoid mutable methods.</p>\n+ *\n+ * @author hakon\n+ */\n+public class ThreadLockInfo {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2NzIxNg==", "bodyText": "Shouldn't this happen after the mutex.release() below?", "url": "https://github.com/vespa-engine/vespa/pull/14528#discussion_r495867216", "createdAt": "2020-09-28T11:23:07Z", "author": {"login": "mpolden"}, "path": "zkfacade/src/main/java/com/yahoo/vespa/curator/Lock.java", "diffHunk": "@@ -20,54 +20,50 @@\n  */\n public class Lock implements Mutex {\n \n-    private final ReentrantLock lock;\n     private final InterProcessLock mutex;\n     private final String lockPath;\n \n     public Lock(String lockPath, Curator curator) {\n+        this(lockPath, curator.createMutex(lockPath));\n+    }\n+\n+    /** Public for testing only */\n+    public Lock(String lockPath, InterProcessLock mutex) {\n         this.lockPath = lockPath;\n-        this.lock = new ReentrantLock(true);\n-        mutex = curator.createMutex(lockPath);\n+        this.mutex = mutex;\n     }\n \n     /** Take the lock with the given timeout. This may be called multiple times from the same thread - each matched by a close */\n     public void acquire(Duration timeout) throws UncheckedTimeoutException {\n+        ThreadLockInfo threadLockInfo = ThreadLockInfo.getCurrentThreadLockInfo();\n+        threadLockInfo.invokingAcquire(lockPath, timeout);\n+\n+        final boolean acquired;\n         try {\n-            if ( ! mutex.acquire(timeout.toMillis(), TimeUnit.MILLISECONDS))\n-                throw new UncheckedTimeoutException(\"Timed out after waiting \" + timeout +\n-                                                    \" to acquire lock '\" + lockPath + \"'\");\n-            if ( ! lock.tryLock()) { // Should be available to only this thread, while holding the above mutex.\n-                release();\n-                throw new IllegalStateException(\"InterProcessMutex acquired, but guarded lock held by someone else, for lock '\" + lockPath + \"'\");\n-            }\n-        }\n-        catch (UncheckedTimeoutException | IllegalStateException e) {\n-            throw e;\n-        }\n-        catch (Exception e) {\n+            acquired = mutex.acquire(timeout.toMillis(), TimeUnit.MILLISECONDS);\n+        } catch (Exception e) {\n+            threadLockInfo.acquireFailed(lockPath);\n             throw new RuntimeException(\"Exception acquiring lock '\" + lockPath + \"'\", e);\n         }\n-    }\n \n-    @Override\n-    public void close() {\n-        try {\n-            lock.unlock();\n-        }\n-        finally {\n-            release();\n+        if (!acquired) {\n+            threadLockInfo.acquireTimedOut(lockPath);\n+            throw new UncheckedTimeoutException(\"Timed out after waiting \" + timeout +\n+                    \" to acquire lock '\" + lockPath + \"'\");\n         }\n+        threadLockInfo.lockAcquired(lockPath);\n     }\n \n-    private void release() {\n+    @Override\n+    public void close() {\n+        ThreadLockInfo.getCurrentThreadLockInfo().lockReleased(lockPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e284ef06a2e6dafbaeae8e486b6f68fa53d5d48"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fd2db62039bf5fed95dcb71bd3ff59267812c7c", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/4fd2db62039bf5fed95dcb71bd3ff59267812c7c", "committedDate": "2020-09-28T11:49:49Z", "message": "LockInfo -> LockAttempt, ThreadLockInfo -> ThreadLockStats, and more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c888ea9295ea84216a920d9ceca3883f75f1ce32", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/c888ea9295ea84216a920d9ceca3883f75f1ce32", "committedDate": "2020-09-28T11:52:23Z", "message": "More info -> attempt renames"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "314aa652acd2409def51ac051093a99c8bdf0ce0", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/314aa652acd2409def51ac051093a99c8bdf0ce0", "committedDate": "2020-09-28T12:20:36Z", "message": "Add count of failed releases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NDY3NDI4", "url": "https://github.com/vespa-engine/vespa/pull/14528#pullrequestreview-497467428", "createdAt": "2020-09-28T12:38:17Z", "commit": {"oid": "314aa652acd2409def51ac051093a99c8bdf0ce0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4200, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}