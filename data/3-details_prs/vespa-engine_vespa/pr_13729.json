{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMjkzMTA1", "number": 13729, "title": "filter invalid UTF-8 (including encoded surrogates) to make protobuf \u2026", "bodyText": "\u2026happy\nI confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@geirst please review\n@havardpe @vekterli FYI\nif any of you know where we send \"string\" type fields through protobuf and it's possible that we can produce invalid UTF-8, we will need to add similar filtering there.", "createdAt": "2020-06-29T08:48:55Z", "url": "https://github.com/vespa-engine/vespa/pull/13729", "merged": true, "mergeCommit": {"oid": "5aea1d09520da60523f5f972b50890ce930d6d54"}, "closed": true, "closedAt": "2020-06-30T08:46:44Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvC1tiAH2gAyNDQxMjkzMTA1OmUwYzVmZmM5MzMwNTYzODY5NDdlYjhkMmEyY2RmZjk0MGE2OGRmYzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwRn4wAFqTQzOTgwMTk3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e0c5ffc933056386947eb8d2a2cdff940a68dfc1", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/e0c5ffc933056386947eb8d2a2cdff940a68dfc1", "committedDate": "2020-06-26T12:59:00Z", "message": "filter invalid UTF-8 (including encoded surrogates) to make protobuf happy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24fdd53f64c84f4ed0533b4480810a8cb67b3071", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/24fdd53f64c84f4ed0533b4480810a8cb67b3071", "committedDate": "2020-06-29T07:59:41Z", "message": "fix bug/typo in surrogate range constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7f9060cec1a9671a65b71cc60457c51edf92c17", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/e7f9060cec1a9671a65b71cc60457c51edf92c17", "committedDate": "2020-06-29T08:13:13Z", "message": "Utf8Reader does the surrogate filtering; unit test that it works"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2df4a50f754fc8d1021dc7c201e050279a4a47dd", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/2df4a50f754fc8d1021dc7c201e050279a4a47dd", "committedDate": "2020-06-29T08:43:43Z", "message": "allow Utf8Writer to target std::string as well"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MDYyMTU4", "url": "https://github.com/vespa-engine/vespa/pull/13729#pullrequestreview-439062158", "createdAt": "2020-06-29T11:51:18Z", "commit": {"oid": "e0c5ffc933056386947eb8d2a2cdff940a68dfc1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMTo1MToxOFrOGqNP5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMTo1MToxOFrOGqNP5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxMDQzOA==", "bodyText": "Consider moving the filtering to a helper function to make the code easier to read.", "url": "https://github.com/vespa-engine/vespa/pull/13729#discussion_r446910438", "createdAt": "2020-06-29T11:51:18Z", "author": {"login": "geirst"}, "path": "logd/src/logd/proto_converter.cpp", "diffHunk": "@@ -59,7 +60,20 @@ ProtoConverter::log_message_to_proto(const LogMessage& message, ProtoLogMessage&\n     proto.set_service(message.service());\n     proto.set_component(message.component());\n     proto.set_level(convert_level(message.level()));\n-    proto.set_payload(message.payload());\n+    const std::string &payload = message.payload();\n+    vespalib::Utf8Reader reader(payload.c_str(), payload.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0c5ffc933056386947eb8d2a2cdff940a68dfc1"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "975afb02388be225e7e7bd827e6aaa8e5ccf7aea", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/975afb02388be225e7e7bd827e6aaa8e5ccf7aea", "committedDate": "2020-06-30T07:39:04Z", "message": "move UTF-8 filtering to vespalib::Utf8"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c1b6e8cece2f1a317a05052e8bf35934680743e", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/8c1b6e8cece2f1a317a05052e8bf35934680743e", "committedDate": "2020-06-30T07:41:07Z", "message": "use common filtering function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODAxOTcy", "url": "https://github.com/vespa-engine/vespa/pull/13729#pullrequestreview-439801972", "createdAt": "2020-06-30T08:46:24Z", "commit": {"oid": "8c1b6e8cece2f1a317a05052e8bf35934680743e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3598, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}