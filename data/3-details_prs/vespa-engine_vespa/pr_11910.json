{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NDM5ODEx", "number": 11910, "title": "Since-timestamp on Orc suspended status", "bodyText": "Introduce a new type of suspension status: PERMANENTLY_DOWN, which\nis set when a node is scheduled to be removed from the application.\nA normal resume call will NOT clear PERMANENTLY_DOWN.\nStore a JSON for each suspended host: Contains status, and a since timestamp\nfor the time when the node was suspended. The suspension timestamp\nis preserved when switching statuses between suspension statuses.\nThe JSON is stored in a new path, void of any zone. This means that\nwe eventually can get rid of the zone-part of the application instance\nreference.", "createdAt": "2020-01-23T16:04:08Z", "url": "https://github.com/vespa-engine/vespa/pull/11910", "merged": true, "mergeCommit": {"oid": "88438542822aee1b75747b8e252a91f9189147cc"}, "closed": true, "closedAt": "2020-01-24T11:14:48Z", "author": {"login": "hakonhall"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9Mgd7AH2gAyMzY2NDM5ODExOjk2N2ZlNGRkM2Y1YTNlNDE4YjBkZDZiMmJjZDA2ZmU1ZmQ0NjAyOTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9cHRwAFqTM0Nzg1NDQ3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290", "committedDate": "2020-01-23T15:58:38Z", "message": "Since-timestamp on Orc suspended status\n\n - Introduce a new type of suspension status: PERMANENTLY_DOWN, which\n   is set when a node is scheduled to be removed from the application.\n   A normal resume call will NOT clear PERMANENTLY_DOWN.\n - Store a JSON for each suspended host: Contains status, and a since timestamp\n   for the time when the node was suspended. The suspension timestamp\n   is preserved when switching statuses between suspension statuses.\n - The JSON is stored in a new path, void of any zone. This means that\n   we eventually can get rid of the zone-part of the application instance\n   reference."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODEzODAw", "url": "https://github.com/vespa-engine/vespa/pull/11910#pullrequestreview-347813800", "createdAt": "2020-01-24T08:52:25Z", "commit": {"oid": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwODo1MjoyNVrOFhXFDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToxOToyMlrOFhXsYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUyNTQ1Mg==", "bodyText": "Can be removed", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370525452", "createdAt": "2020-01-24T08:52:25Z", "author": {"login": "freva"}, "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java", "diffHunk": "@@ -45,7 +48,7 @@\n     final static String HOST_STATUS_CACHE_COUNTER_PATH = \"/vespa/host-status-service-cache-counter\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMDIwMw==", "bodyText": "Filter for what's not already in hostInfos?", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370530203", "createdAt": "2020-01-24T09:05:16Z", "author": {"login": "freva"}, "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java", "diffHunk": "@@ -247,6 +285,55 @@ public HostStatus getHostStatus(ApplicationInstanceReference applicationInstance\n         }\n     }\n \n+    /** Do not call this directly: should be called behind a cache. */\n+    private HostInfos getHostInfosFromZk(ApplicationInstanceReference application) {\n+        Map<HostName, HostInfo> hostInfos;\n+        String hostsRootPath = hostsPath(application);\n+        if (uncheck(() -> curator.framework().checkExists().forPath(hostsRootPath)) == null) {\n+            hostInfos = new HashMap<>();\n+        } else {\n+            List<String> hostnames = uncheck(() -> curator.framework().getChildren().forPath(hostsRootPath));\n+            hostInfos = new HashMap<>(hostnames.stream().collect(Collectors.toMap(\n+                    hostname -> new HostName(hostname),\n+                    hostname -> {\n+                        byte[] bytes = uncheck(() -> curator.framework().getData().forPath(hostsRootPath + \"/\" + hostname));\n+                        return WireHostInfo.deserialize(bytes);\n+                    })));\n+        }\n+\n+        // For backwards compatibility we'll add HostInfos from the old hosts-allowed-down ZK path,\n+        // using the creation time as the since path. The new hosts ZK path should contain a subset of\n+        // the hostnames under hosts-allowed-down ZK path. Eventually these sets should be identical.\n+        // Once that's true we can stop writing to hosts-allowed-down, remove this code, and all\n+        // data in hosts-allowed-down can be removed.\n+        Set<HostName> legacyHostsDown = hostsDownFor(application);\n+        Map<HostName, HostInfo> legacyHostInfos = legacyHostsDown.stream().collect(Collectors.toMap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNTUyMg==", "bodyText": "Consider adding a method that returns true when the status is one of the down statuses to avoid doing != NO_REMARKS", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370535522", "createdAt": "2020-01-24T09:19:22Z", "author": {"login": "freva"}, "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/HostStatus.java", "diffHunk": "@@ -2,11 +2,20 @@\n package com.yahoo.vespa.orchestrator.status;\n \n /**\n- * Enumeration of the different status' a host can have.\n+ * Enumeration of the different statuses a host can have.\n  *\n  * @author oyving\n  */\n public enum HostStatus {\n+    /** The services on the host is supposed to be up. */\n     NO_REMARKS,\n-    ALLOWED_TO_BE_DOWN;\n+\n+    /** The services on the host is allowed to be down. */\n+    ALLOWED_TO_BE_DOWN,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c62e3b2e96d565cb2c785661e1899a9e62556163", "author": {"user": {"login": "hakonhall", "name": "H\u00e5kon Hallingstad"}}, "url": "https://github.com/vespa-engine/vespa/commit/c62e3b2e96d565cb2c785661e1899a9e62556163", "committedDate": "2020-01-24T10:05:19Z", "message": "Define suspended attribute on HostStatus, plus minor review fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODU0NDc5", "url": "https://github.com/vespa-engine/vespa/pull/11910#pullrequestreview-347854479", "createdAt": "2020-01-24T10:09:36Z", "commit": {"oid": "c62e3b2e96d565cb2c785661e1899a9e62556163"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3987, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}