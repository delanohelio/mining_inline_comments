{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5NDQ0NzUx", "number": 14281, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0MzoyMVrOEgTCaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0Mzo1MlrOEgTDGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMzAxODAzOnYy", "diffSide": "RIGHT", "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0MzoyMVrOHNFGbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOToxMjoyM1rOHNGFvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzEwMQ==", "bodyText": "Might be useful to include the last reason here?", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483477101", "createdAt": "2020-09-04T08:43:21Z", "author": {"login": "bratseth"}, "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "diffHunk": "@@ -78,15 +69,18 @@ public ImportedModel importModel(String modelName, String modelDir, SavedModelBu\n     private ImportedModel convertToOnnxAndImport(String modelName, String modelDir) {\n         Path tempDir = null;\n         try {\n-            log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX...\");\n             tempDir = Files.createTempDirectory(\"tf2onnx\");\n             String convertedPath = tempDir.toString() + File.separatorChar + \"converted.onnx\";\n-            Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, defaultOnnxOpset);\n-            if (res.getFirst() != 0) {\n-                throw new IllegalArgumentException(\"Conversion from TensorFlow to ONNX failed for '\" + modelDir + \"'. \" +\n-                        \"Reason: \" + res.getSecond());\n+            for (int opset : onnxOpsetsToTry) {\n+                log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX with opset \" + opset + \"...\");\n+                Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, opset);\n+                if (res.getFirst() == 0) {\n+                    log.info(\"Conversion to ONNX with opset \" + opset + \" successful.\");\n+                    return onnxImporter.importModel(modelName, convertedPath);\n+                }\n+                log.info(\"Conversion to ONNX with opset \" + opset + \" failed. Reason: \" + res.getSecond());\n             }\n-            return onnxImporter.importModel(modelName, convertedPath);\n+            throw new IllegalArgumentException(\"Unable to convert TensorFlow model in '\" + modelDir + \"' to ONNX.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MzMwOQ==", "bodyText": "Good suggestion. Fixed.", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483493309", "createdAt": "2020-09-04T09:12:23Z", "author": {"login": "lesters"}, "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "diffHunk": "@@ -78,15 +69,18 @@ public ImportedModel importModel(String modelName, String modelDir, SavedModelBu\n     private ImportedModel convertToOnnxAndImport(String modelName, String modelDir) {\n         Path tempDir = null;\n         try {\n-            log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX...\");\n             tempDir = Files.createTempDirectory(\"tf2onnx\");\n             String convertedPath = tempDir.toString() + File.separatorChar + \"converted.onnx\";\n-            Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, defaultOnnxOpset);\n-            if (res.getFirst() != 0) {\n-                throw new IllegalArgumentException(\"Conversion from TensorFlow to ONNX failed for '\" + modelDir + \"'. \" +\n-                        \"Reason: \" + res.getSecond());\n+            for (int opset : onnxOpsetsToTry) {\n+                log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX with opset \" + opset + \"...\");\n+                Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, opset);\n+                if (res.getFirst() == 0) {\n+                    log.info(\"Conversion to ONNX with opset \" + opset + \" successful.\");\n+                    return onnxImporter.importModel(modelName, convertedPath);\n+                }\n+                log.info(\"Conversion to ONNX with opset \" + opset + \" failed. Reason: \" + res.getSecond());\n             }\n-            return onnxImporter.importModel(modelName, convertedPath);\n+            throw new IllegalArgumentException(\"Unable to convert TensorFlow model in '\" + modelDir + \"' to ONNX.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzEwMQ=="}, "originalCommit": {"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMzAxOTc2OnYy", "diffSide": "RIGHT", "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0Mzo1MlrOHNFHiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOToxMjozNVrOHNGGKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzM4NQ==", "bodyText": "I think this should probably be Level.FINE?", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483477385", "createdAt": "2020-09-04T08:43:52Z", "author": {"login": "bratseth"}, "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "diffHunk": "@@ -78,15 +69,18 @@ public ImportedModel importModel(String modelName, String modelDir, SavedModelBu\n     private ImportedModel convertToOnnxAndImport(String modelName, String modelDir) {\n         Path tempDir = null;\n         try {\n-            log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX...\");\n             tempDir = Files.createTempDirectory(\"tf2onnx\");\n             String convertedPath = tempDir.toString() + File.separatorChar + \"converted.onnx\";\n-            Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, defaultOnnxOpset);\n-            if (res.getFirst() != 0) {\n-                throw new IllegalArgumentException(\"Conversion from TensorFlow to ONNX failed for '\" + modelDir + \"'. \" +\n-                        \"Reason: \" + res.getSecond());\n+            for (int opset : onnxOpsetsToTry) {\n+                log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX with opset \" + opset + \"...\");\n+                Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, opset);\n+                if (res.getFirst() == 0) {\n+                    log.info(\"Conversion to ONNX with opset \" + opset + \" successful.\");\n+                    return onnxImporter.importModel(modelName, convertedPath);\n+                }\n+                log.info(\"Conversion to ONNX with opset \" + opset + \" failed. Reason: \" + res.getSecond());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MzQxOA==", "bodyText": "Fixed.", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483493418", "createdAt": "2020-09-04T09:12:35Z", "author": {"login": "lesters"}, "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "diffHunk": "@@ -78,15 +69,18 @@ public ImportedModel importModel(String modelName, String modelDir, SavedModelBu\n     private ImportedModel convertToOnnxAndImport(String modelName, String modelDir) {\n         Path tempDir = null;\n         try {\n-            log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX...\");\n             tempDir = Files.createTempDirectory(\"tf2onnx\");\n             String convertedPath = tempDir.toString() + File.separatorChar + \"converted.onnx\";\n-            Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, defaultOnnxOpset);\n-            if (res.getFirst() != 0) {\n-                throw new IllegalArgumentException(\"Conversion from TensorFlow to ONNX failed for '\" + modelDir + \"'. \" +\n-                        \"Reason: \" + res.getSecond());\n+            for (int opset : onnxOpsetsToTry) {\n+                log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX with opset \" + opset + \"...\");\n+                Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, opset);\n+                if (res.getFirst() == 0) {\n+                    log.info(\"Conversion to ONNX with opset \" + opset + \" successful.\");\n+                    return onnxImporter.importModel(modelName, convertedPath);\n+                }\n+                log.info(\"Conversion to ONNX with opset \" + opset + \" failed. Reason: \" + res.getSecond());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzM4NQ=="}, "originalCommit": {"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1456, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}