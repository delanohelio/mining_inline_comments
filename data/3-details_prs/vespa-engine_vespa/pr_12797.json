{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MTE0MjY0", "number": 12797, "title": "- Redo the servicepool to resolve addresses first time and not loadba\u2026", "bodyText": "\u2026lance.\n\nMake it thread safe.\nRemove any loadbalancing tests\nAssert that no loadbalancing is requested.\n\n@vekterli PR", "createdAt": "2020-04-01T16:52:34Z", "url": "https://github.com/vespa-engine/vespa/pull/12797", "merged": true, "mergeCommit": {"oid": "47019081334e7a779eda4d241546e663ed8f87bc"}, "closed": true, "closedAt": "2020-04-02T14:32:10Z", "author": {"login": "baldersheim"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTamnMgH2gAyMzk3MTE0MjY0OjU1NGY1YWJjNTY1YjVlNmMyZDg5OTY1NzQ4NTdjMjVmOTFjMDJlZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTswDOgH2gAyMzk3MTE0MjY0OjUzM2VkNGMxZWQ1YjJhMGU0NWJjOWZlNWE1MThkMjNkYTVmNWNkMTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "554f5abc565b5e6c2d8996574857c25f91c02ee1", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/554f5abc565b5e6c2d8996574857c25f91c02ee1", "committedDate": "2020-04-01T16:50:21Z", "message": "- Redo the servicepool to resolve addresses first time and not loadbalance.\n- Make it thread safe.\n- Remove any loadbalancing tests\n- Assert that no loadbalancing is requested."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MjIyNTcx", "url": "https://github.com/vespa-engine/vespa/pull/12797#pullrequestreview-386222571", "createdAt": "2020-04-02T08:46:37Z", "commit": {"oid": "554f5abc565b5e6c2d8996574857c25f91c02ee1"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo0NjozN1rOF_hRow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOTowODozNlrOF_iHzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE0OTc5NQ==", "bodyText": "Since I believe it's conceivable that someone could (by accident or deliberately) put up a slobrok service with multiple endpoints (or use a message route that uses a service prefix), I think we might not want assert here. Instead, could just deterministically pick the first entry. Won't be load balanced, but won't leave a smoking crater behind either.\nAlternatively, first have a couple of full factory runs with the assertion in to verify nothing breaks that we haven't thought about... \ud83d\ude42", "url": "https://github.com/vespa-engine/vespa/pull/12797#discussion_r402149795", "createdAt": "2020-04-02T08:46:37Z", "author": {"login": "vekterli"}, "path": "messagebus/src/vespa/messagebus/network/rpcservice.cpp", "diffHunk": "@@ -6,36 +6,36 @@\n namespace mbus {\n \n RPCService::RPCService(const Mirror &mirror, const string &pattern) :\n-    _mirror(mirror),\n-    _pattern(pattern),\n-    _addressIdx(random()),\n-    _addressGen(0),\n-    _addressList()\n-{ }\n+    _serviceName(),\n+    _connectionSpec()\n+{\n+    if (pattern.find(\"tcp/\") == 0) {\n+        size_t pos = pattern.find_last_of('/');\n+        if (pos != string::npos && pos < pattern.size() - 1) {\n+            RPCServiceAddress test(pattern, pattern.substr(0, pos));\n+            if ( ! test.isMalformed()) {\n+                _serviceName = pattern;\n+                _connectionSpec = pattern.substr(0, pos);\n+            }\n+        }\n+    } else {\n+        Mirror::SpecList addressList = mirror.lookup(pattern);\n+        if (!addressList.empty()) {\n+            assert(addressList.size() == 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "554f5abc565b5e6c2d8996574857c25f91c02ee1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1MDE2Nw==", "bodyText": "Simplify to addressList.front() now instead of invoking RNG?", "url": "https://github.com/vespa-engine/vespa/pull/12797#discussion_r402150167", "createdAt": "2020-04-02T08:47:16Z", "author": {"login": "vekterli"}, "path": "messagebus/src/vespa/messagebus/network/rpcservice.cpp", "diffHunk": "@@ -6,36 +6,36 @@\n namespace mbus {\n \n RPCService::RPCService(const Mirror &mirror, const string &pattern) :\n-    _mirror(mirror),\n-    _pattern(pattern),\n-    _addressIdx(random()),\n-    _addressGen(0),\n-    _addressList()\n-{ }\n+    _serviceName(),\n+    _connectionSpec()\n+{\n+    if (pattern.find(\"tcp/\") == 0) {\n+        size_t pos = pattern.find_last_of('/');\n+        if (pos != string::npos && pos < pattern.size() - 1) {\n+            RPCServiceAddress test(pattern, pattern.substr(0, pos));\n+            if ( ! test.isMalformed()) {\n+                _serviceName = pattern;\n+                _connectionSpec = pattern.substr(0, pos);\n+            }\n+        }\n+    } else {\n+        Mirror::SpecList addressList = mirror.lookup(pattern);\n+        if (!addressList.empty()) {\n+            assert(addressList.size() == 1);\n+            const auto &entry = addressList[random() % addressList.size()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "554f5abc565b5e6c2d8996574857c25f91c02ee1"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2MzY2MA==", "bodyText": "Should the name of this function be changed to e.g. make_address() instead? It doesn't do any actual resolving anymore.", "url": "https://github.com/vespa-engine/vespa/pull/12797#discussion_r402163660", "createdAt": "2020-04-02T09:08:36Z", "author": {"login": "vekterli"}, "path": "messagebus/src/vespa/messagebus/network/rpcservicepool.cpp", "diffHunk": "@@ -19,27 +22,52 @@ RPCServicePool::~RPCServicePool() = default;\n RPCServiceAddress::UP\n RPCServicePool::resolve(const string &pattern)\n {\n-    std::unique_ptr<RPCService> * found = _lru.findAndRef(pattern);\n-    if (found) {\n-        return (*found)->resolve();\n+    std::shared_ptr<RPCService> service;\n+    {\n+        LockGuard guard(_lock);\n+        handleMirrorUpdates(guard);\n+        std::shared_ptr<RPCService> *found = _lru->findAndRef(pattern);\n+        if (found) {\n+            service = *found;\n+        }\n+    }\n+\n+    if (service) {\n+        return service->resolve();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "554f5abc565b5e6c2d8996574857c25f91c02ee1"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "676dc64e73f418be10ef4cee68b102068bbc5530", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/676dc64e73f418be10ef4cee68b102068bbc5530", "committedDate": "2020-04-02T10:34:35Z", "message": "reslove() -> make_address"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c3b09bbdd2d3819ae2edb35b867d996daa4a744", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/9c3b09bbdd2d3819ae2edb35b867d996daa4a744", "committedDate": "2020-04-02T10:52:34Z", "message": "Unify tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5713fb87bc776b6d7eaa252b70a965c89972e98b", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/5713fb87bc776b6d7eaa252b70a965c89972e98b", "committedDate": "2020-04-02T11:25:15Z", "message": "Add some more info too failing test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfac02f352328cdae0d78fa9d6320468ba9be658", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/cfac02f352328cdae0d78fa9d6320468ba9be658", "committedDate": "2020-04-02T13:13:39Z", "message": "Must wait for all sessions to be registered."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30b6bce74ee98480b72d4a23328c0b30c28b4566", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/30b6bce74ee98480b72d4a23328c0b30c28b4566", "committedDate": "2020-04-02T13:58:37Z", "message": "Improve thread visibility."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "533ed4c1ed5b2a0e45bc9fe5a518d23da5f5cd17", "author": {"user": {"login": "baldersheim", "name": "Henning Baldersheim"}}, "url": "https://github.com/vespa-engine/vespa/commit/533ed4c1ed5b2a0e45bc9fe5a518d23da5f5cd17", "committedDate": "2020-04-02T13:58:57Z", "message": "Since killing a task involves unlinking it, all other tasks scheduked must have been killed/unlinked.\nIf not you will touching freed memory."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2553, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}