{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwOTE3MzY4", "number": 15588, "title": "Add host switch updater", "bodyText": "@freva", "createdAt": "2020-12-02T10:33:54Z", "url": "https://github.com/vespa-engine/vespa/pull/15588", "merged": true, "mergeCommit": {"oid": "0158d3df8fa0925bf98cbcaa603e90c9a39827b1"}, "closed": true, "closedAt": "2020-12-02T11:56:00Z", "author": {"login": "mpolden"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiMTRJAFqTU0MjcxMjU4NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiM4yggH2gAyNTMwOTE3MzY4OmUwMTc1OGFjYTY4NTJkMmMzOTFmMGIxYjQ2Mjc0MzQ0MDYxYmVjMzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNzEyNTg1", "url": "https://github.com/vespa-engine/vespa/pull/15588#pullrequestreview-542712585", "createdAt": "2020-12-02T10:47:59Z", "commit": {"oid": "d4a0f2f0f0963ca85d5ebee7e61e37085ac4630a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDo0ODowMFrOH9VHhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDo1MDoxOFrOH9VNOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3MTE3NA==", "bodyText": "I don't think builders should take Optionals, instead the caller should avoid calling if the field is not present.", "url": "https://github.com/vespa-engine/vespa/pull/15588#discussion_r534071174", "createdAt": "2020-12-02T10:48:00Z", "author": {"login": "freva"}, "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/configserver/Node.java", "diffHunk": "@@ -495,12 +503,17 @@ public Builder openStackId(String openStackId) {\n             return this;\n         }\n \n+        public Builder switchHostname(Optional<String> switchHostname) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a0f2f0f0963ca85d5ebee7e61e37085ac4630a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3MjYzMg==", "bodyText": "If we are guaranteed that this is set, this should be .orElseThrow(), otherwise we should filter this in shouldUpdate()", "url": "https://github.com/vespa-engine/vespa/pull/15588#discussion_r534072632", "createdAt": "2020-12-02T10:50:18Z", "author": {"login": "freva"}, "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostSwitchUpdater.java", "diffHunk": "@@ -0,0 +1,52 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.maintenance;\n+\n+import com.yahoo.vespa.hosted.controller.Controller;\n+import com.yahoo.vespa.hosted.controller.api.integration.configserver.Node;\n+import com.yahoo.vespa.hosted.controller.api.integration.configserver.NodeRepository;\n+import com.yahoo.vespa.hosted.controller.api.integration.entity.NodeEntity;\n+import com.yahoo.vespa.hosted.controller.api.integration.noderepository.NodeRepositoryNode;\n+\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Ensures that the switch information for all hosts is up to date.\n+ *\n+ * @author mpolden\n+ */\n+public class HostSwitchUpdater extends ControllerMaintainer {\n+\n+    private final NodeRepository nodeRepository;\n+\n+    public HostSwitchUpdater(Controller controller, Duration interval) {\n+        super(controller, interval);\n+        this.nodeRepository = controller.serviceRegistry().configServer().nodeRepository();\n+    }\n+\n+    @Override\n+    protected boolean maintain() {\n+        Map<String, NodeEntity> nodeEntities = controller().serviceRegistry().entityService().listNodes().stream()\n+                                                           .collect(Collectors.toMap(NodeEntity::hostname,\n+                                                                                     Function.identity()));\n+        for (var zone : controller().zoneRegistry().zones().controllerUpgraded().all().ids()) {\n+            for (var node : nodeRepository.list(zone)) {\n+                NodeEntity nodeEntity = nodeEntities.get(node.hostname().value());\n+                if (!shouldUpdate(node, nodeEntity)) continue;\n+\n+                NodeRepositoryNode updatedNode = new NodeRepositoryNode();\n+                updatedNode.setSwitchHostname(nodeEntity.switchHostname().orElse(null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a0f2f0f0963ca85d5ebee7e61e37085ac4630a"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d33f25b291d4a4d7ba44847da85ef9ad1f5b62f", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/3d33f25b291d4a4d7ba44847da85ef9ad1f5b62f", "committedDate": "2020-12-02T11:17:02Z", "message": "Add host switch updater"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4a0f2f0f0963ca85d5ebee7e61e37085ac4630a", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/d4a0f2f0f0963ca85d5ebee7e61e37085ac4630a", "committedDate": "2020-12-02T10:16:47Z", "message": "Add host switch updater"}, "afterCommit": {"oid": "3d33f25b291d4a4d7ba44847da85ef9ad1f5b62f", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/3d33f25b291d4a4d7ba44847da85ef9ad1f5b62f", "committedDate": "2020-12-02T11:17:02Z", "message": "Add host switch updater"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e01758aca6852d2c391f0b1b46274344061bec35", "author": {"user": {"login": "mpolden", "name": "Martin Polden"}}, "url": "https://github.com/vespa-engine/vespa/commit/e01758aca6852d2c391f0b1b46274344061bec35", "committedDate": "2020-12-02T11:31:33Z", "message": "Never clear switch hostname"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1832, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}