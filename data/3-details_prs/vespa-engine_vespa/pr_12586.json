{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MzI4MDI5", "number": 12586, "title": "Add initial metadata-only phase to inconsistent update handling ", "bodyText": "@geirst please review. Some notes:\n\nTwoPhaseUpdate... classes and tests should be renamed (since it's more than 2 now), but enough refactoring done in this PR as it is \ud83d\ude42\nThis features is config disabled by default for now\n\nIf bucket replicas are inconsistent, the common case is that only\na small subset of documents contained in the buckets are actually\nmutually out of sync. The added metadata phase optimizes for\nsuch a case by initially sending Get requests to all divergent\nreplicas that only ask for the timestamps (and no fields). This\nis a very cheap and fast operation. If all returned timestamps are\nin sync, the update can be restarted in the fast path. Otherwise, a\nfull Get will only be sent to the newest replica, and its result will\nbe used for performing the update on the distributor itself, before\npushing out the result as Puts.\nThis is in contrast to today's behavior where full Gets are sent\nto all replicas. For users with large documents this can be very\nexpensive.\nIn addition, the metadata Get operations are sent with weak internal\nread consistency (as they do not need to read any previously written,\npossibly in-flight fields). This lets them bypass the main commit queue\nentirely.\nThis relates to issue #3703", "createdAt": "2020-03-16T15:48:23Z", "url": "https://github.com/vespa-engine/vespa/pull/12586", "merged": true, "mergeCommit": {"oid": "141c98cbcf97153858d6ae5a535e331d7cf174ca"}, "closed": true, "closedAt": "2020-03-19T10:42:57Z", "author": {"login": "vekterli"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOPosngH2gAyMzg5MzI4MDI5OmViMjg5NjJjYjhlZGZkYzNhZDc1ZmM5Mjk4YTcxYmYzMWFiOTZhZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOiywZAH2gAyMzg5MzI4MDI5OjYxMWU1NzIxODRlMDk1Y2VhYTBmYjA5ZTdhMmRhMDYyYTY5OWIxZDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/eb28962cb8edfdc3ad75fc9298a71bf31ab96af2", "committedDate": "2020-03-16T15:14:03Z", "message": "Add initial metadata-only phase to inconsistent update handling\n\nIf bucket replicas are inconsistent, the common case is that only\na small subset of documents contained in the buckets are actually\nmutually out of sync. The added metadata phase optimizes for\nsuch a case by initially sending Get requests to all divergent\nreplicas that only ask for the timestamps (and no fields). This\nis a very cheap and fast operation. If all returned timestamps\nare in sync, the update can be restarted in the fast path.\nOtherwise, a full Get will _only_ be sent to the newest replica,\nand its result will be used for performing the update on the\ndistributor itself, before pushing out the result as Puts.\n\nThis is in contrast to today's behavior where full Gets are\nsent to all replicas. For users with large documents this\ncan be very expensive.\n\nIn addition, the metadata Get operations are sent with weak\ninternal read consistency (as they do not need to read any\npreviously written, possibly in-flight fields). This lets them\nbypass the main commit queue entirely."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1ODQzODA5", "url": "https://github.com/vespa-engine/vespa/pull/12586#pullrequestreview-375843809", "createdAt": "2020-03-17T08:58:56Z", "commit": {"oid": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODo1ODo1NlrOF3TCfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODo1OToyM1rOF3TDag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyNzkzNA==", "bodyText": "Please add class comment", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393527934", "createdAt": "2020-03-17T08:58:56Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/distributor/operations/external/newest_replica.h", "diffHunk": "@@ -0,0 +1,38 @@\n+#pragma once\n+\n+#include <vespa/document/bucket/bucketid.h>\n+#include <vespa/storageapi/defs.h>\n+#include <iosfwd>\n+#include <stddef.h>\n+\n+namespace storage::distributor {\n+\n+struct NewestReplica {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyODA3Ng==", "bodyText": "Please add copyright", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393528076", "createdAt": "2020-03-17T08:59:11Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/distributor/operations/external/newest_replica.h", "diffHunk": "@@ -0,0 +1,38 @@\n+#pragma once", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyODE3MA==", "bodyText": "Please add copyright", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393528170", "createdAt": "2020-03-17T08:59:23Z", "author": {"login": "geirst"}, "path": "storage/src/vespa/storage/distributor/operations/external/newest_replica.cpp", "diffHunk": "@@ -0,0 +1,13 @@\n+#include \"newest_replica.h\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "611e572184e095ceaa0fb09e7a2da062a699b1d3", "author": {"user": {"login": "vekterli", "name": "Tor Brede Vekterli"}}, "url": "https://github.com/vespa-engine/vespa/commit/611e572184e095ceaa0fb09e7a2da062a699b1d3", "committedDate": "2020-03-17T13:33:14Z", "message": "Add comments and some extra safety handling of single Get command"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2696, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}