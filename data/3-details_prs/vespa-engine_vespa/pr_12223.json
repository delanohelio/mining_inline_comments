{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MTYwMTQx", "number": 12223, "title": "Arnej/hnsw search preview.", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.\n@geirst @havardpe first draft, please review", "createdAt": "2020-02-17T14:16:21Z", "url": "https://github.com/vespa-engine/vespa/pull/12223", "merged": true, "mergeCommit": {"oid": "7a9cc89d9bde01cec32d6c3d6d67c6c51c840e6f"}, "closed": true, "closedAt": "2020-02-20T07:28:31Z", "author": {"login": "arnej27959"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFM6-jgH2gAyMzc2MTYwMTQxOmI3Mzk0NGQ5ZDc3NDVmYTU5YjIyODk1OGI3NWNiYTQ2YTkyNDQ3Yjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF38EzAFqTM2MTE4OTE5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b73944d9d7745fa59b228958b75cba46a92447b8", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/b73944d9d7745fa59b228958b75cba46a92447b8", "committedDate": "2020-02-17T12:58:59Z", "message": "add simple find_top_k method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4d3589c6b00c330246fa486afc5fe20f6a0f9fe", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/f4d3589c6b00c330246fa486afc5fe20f6a0f9fe", "committedDate": "2020-02-17T13:25:04Z", "message": "test find_top_k also"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ab187d4152775a22d1b554fd2364ec5058cdfee", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/1ab187d4152775a22d1b554fd2364ec5058cdfee", "committedDate": "2020-02-17T14:07:24Z", "message": "add search API in NearestNeighborIndex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3853d707b9fd95a7cdb9d0edf1ad8de245dc049", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/d3853d707b9fd95a7cdb9d0edf1ad8de245dc049", "committedDate": "2020-02-17T14:13:50Z", "message": "test top-level API also"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMTUwMTQ0", "url": "https://github.com/vespa-engine/vespa/pull/12223#pullrequestreview-360150144", "createdAt": "2020-02-18T08:39:16Z", "commit": {"oid": "d3853d707b9fd95a7cdb9d0edf1ad8de245dc049"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwODozOToxNlrOFq5W9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwODozOToxNlrOFq5W9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNDI3OQ==", "bodyText": "Perhaps 'k + 100' should be a parameter to the function instead, e.g. 'search_k'?", "url": "https://github.com/vespa-engine/vespa/pull/12223#discussion_r380524279", "createdAt": "2020-02-18T08:39:16Z", "author": {"login": "geirst"}, "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.cpp", "diffHunk": "@@ -310,6 +310,43 @@ HnswIndex::remove_document(uint32_t docid)\n     _node_refs[docid].store_release(invalid);\n }\n \n+std::vector<uint32_t>\n+HnswIndex::find_top_k(TypedCells vector, uint32_t k)\n+{\n+    std::vector<uint32_t> result;\n+    std::vector<HnswCandidate> candidates = top_k_candidates(vector, k + 100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3853d707b9fd95a7cdb9d0edf1ad8de245dc049"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMTUzNDY4", "url": "https://github.com/vespa-engine/vespa/pull/12223#pullrequestreview-360153468", "createdAt": "2020-02-18T08:44:55Z", "commit": {"oid": "d3853d707b9fd95a7cdb9d0edf1ad8de245dc049"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwODo0NDo1NVrOFq5hUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwODo0NDo1NVrOFq5hUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNjkyOA==", "bodyText": "Consider removing this.", "url": "https://github.com/vespa-engine/vespa/pull/12223#discussion_r380526928", "createdAt": "2020-02-18T08:44:55Z", "author": {"login": "geirst"}, "path": "searchlib/src/tests/tensor/hnsw_index/hnsw_index_test.cpp", "diffHunk": "@@ -86,6 +86,24 @@ class HnswIndexTest : public ::testing::Test {\n         ASSERT_EQ(exp_levels.size(), act_node.size());\n         EXPECT_EQ(exp_levels, act_node.levels());\n     }\n+    void expect_top_3(uint32_t docid, std::vector<uint32_t> exp_hits) {\n+        uint32_t k = 3;\n+        auto qv = vectors.get_vector(docid);\n+        auto rv = index->top_k_candidates(qv, k);\n+        size_t idx = 0;\n+        for (const auto & hit : rv) {\n+            // fprintf(stderr, \"found docid %u dist %.1f\\n\", hit.docid, hit.distance);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3853d707b9fd95a7cdb9d0edf1ad8de245dc049"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d06888aeadc0f10f9c5ac1d0e780fdbb00701aa", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/6d06888aeadc0f10f9c5ac1d0e780fdbb00701aa", "committedDate": "2020-02-19T12:15:00Z", "message": "expose explore_k in top level API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "347c2d62ef1d1a73bc53da22ce5dfa3f213946da", "author": {"user": {"login": "arnej27959", "name": "Arne H Juul"}}, "url": "https://github.com/vespa-engine/vespa/commit/347c2d62ef1d1a73bc53da22ce5dfa3f213946da", "committedDate": "2020-02-19T14:42:19Z", "message": "explore at least k always"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMTg5MTk1", "url": "https://github.com/vespa-engine/vespa/pull/12223#pullrequestreview-361189195", "createdAt": "2020-02-19T15:06:08Z", "commit": {"oid": "347c2d62ef1d1a73bc53da22ce5dfa3f213946da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2884, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}