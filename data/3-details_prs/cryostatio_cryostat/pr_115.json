{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5Njc4OTMy", "number": 115, "title": "Better WebSocket concurrency handling", "bodyText": "Rewrite MessagingServer handling of concurrent WebSocket connections to\nreduce latency, avoid polling, and fix a concurrent modification\nexception bug. This also adds logic for limiting the maximum number of\nWebSocket connections that can be simultaneously open, which is\nconfigurable.\nFixes #114", "createdAt": "2020-01-31T17:06:39Z", "url": "https://github.com/cryostatio/cryostat/pull/115", "merged": true, "mergeCommit": {"oid": "6c35de36e0033ea6a19c538c2a78d4fae61977a8"}, "closed": true, "closedAt": "2020-02-03T16:23:12Z", "author": {"login": "andrewazores"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_yQRVgH2gAyMzY5Njc4OTMyOjI4ZjczODM0OTRlMzM5ODdlNWNiYTRiYTJkYzU0ZTQ3NjA0ZTIxZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAvWkIAFqTM1MjM3NzY2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "28f7383494e33987e5cba4ba2dc54e47604e21ed", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/28f7383494e33987e5cba4ba2dc54e47604e21ed", "committedDate": "2020-01-31T17:05:11Z", "message": "Better WebSocket concurrency handling\n\nRewrite MessagingServer handling of concurrent WebSocket connections to\nreduce latency, avoid polling, and fix a concurrent modification\nexception bug. This also adds logic for limiting the maximum number of\nWebSocket connections that can be simultaneously open, which is\nconfigurable.\n\nFixes #114"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNzI3MDUz", "url": "https://github.com/cryostatio/cryostat/pull/115#pullrequestreview-351727053", "createdAt": "2020-01-31T19:30:01Z", "commit": {"oid": "28f7383494e33987e5cba4ba2dc54e47604e21ed"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxOTozMDowMVrOFkVofw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMjo1NjoxOVrOFkaJAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY0NzQ4Nw==", "bodyText": "Do we need synchronized access for connections here too?", "url": "https://github.com/cryostatio/cryostat/pull/115#discussion_r373647487", "createdAt": "2020-01-31T19:30:01Z", "author": {"login": "ebaron"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/tui/ws/MessagingServer.java", "diffHunk": "@@ -43,6 +57,14 @@ void start() throws SocketException, UnknownHostException {\n                         return;\n                     }\n                     String remoteAddress = sws.remoteAddress().toString();\n+                    if (connections.size() >= maxConnections) {\n+                        logger.info(\n+                                String.format(\n+                                        \"Dropping remote client %s due to too many concurrent connections\",\n+                                        remoteAddress));\n+                        sws.reject();\n+                        return;\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28f7383494e33987e5cba4ba2dc54e47604e21ed"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcyMDE3Nw==", "bodyText": "Maybe need some synchronization here if readingThread becomes null after the check, but this might be overkill for now.", "url": "https://github.com/cryostatio/cryostat/pull/115#discussion_r373720177", "createdAt": "2020-01-31T22:52:18Z", "author": {"login": "ebaron"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/tui/ws/WsClientReaderWriter.java", "diffHunk": "@@ -35,11 +34,10 @@ public void handle(String msg) {\n \n     @Override\n     public void close() {\n-        if (running && readingThread != null) {\n-            inQ.clear();\n+        inQ.clear();\n+        if (readingThread != null) {\n             readingThread.interrupt();\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28f7383494e33987e5cba4ba2dc54e47604e21ed"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcyMTM0NQ==", "bodyText": "What do you think about logging a warning here, so the user knows their argument is invalid and will be ignored?", "url": "https://github.com/cryostatio/cryostat/pull/115#discussion_r373721345", "createdAt": "2020-01-31T22:56:19Z", "author": {"login": "ebaron"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/tui/ws/MessagingServer.java", "diffHunk": "@@ -161,4 +183,21 @@ public void println(Exception e) {\n             }\n         };\n     }\n+\n+    private int determineMaximumWsConnections(Environment env) {\n+        try {\n+            int maxConn =\n+                    Integer.parseInt(\n+                            env.getEnv(\n+                                    MAX_CONNECTIONS_ENV_VAR,\n+                                    String.valueOf(DEFAULT_MAX_CONNECTIONS)));\n+            if (maxConn > 64 || maxConn < 1) {\n+                return DEFAULT_MAX_CONNECTIONS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28f7383494e33987e5cba4ba2dc54e47604e21ed"}, "originalPosition": 173}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0239665c18b947e466c1a5c20c50a4b8d7334874", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/0239665c18b947e466c1a5c20c50a4b8d7334874", "committedDate": "2020-02-03T14:29:46Z", "message": "Ensure thread safety while accepting new connection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97c7dc7f3d75035dcc51d2366253a1acfe088923", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/97c7dc7f3d75035dcc51d2366253a1acfe088923", "committedDate": "2020-02-03T15:34:28Z", "message": "Add locking to ensure thread does not become null while interrupting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a393d29f79b72080d54405d14b0ab6ab26eb443", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/2a393d29f79b72080d54405d14b0ab6ab26eb443", "committedDate": "2020-02-03T15:39:04Z", "message": "Better enforcement and logging of min/max WS connections"}, "afterCommit": {"oid": "aae80959b2039e6f03082f16a1c99ec730327380", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/aae80959b2039e6f03082f16a1c99ec730327380", "committedDate": "2020-02-03T15:43:36Z", "message": "Better enforcement and logging of min/max WS connections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1716a52ce953b36d9e3a250e8c9b184a15c29e6d", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/1716a52ce953b36d9e3a250e8c9b184a15c29e6d", "committedDate": "2020-02-03T15:44:10Z", "message": "Better enforcement and logging of min/max WS connections"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aae80959b2039e6f03082f16a1c99ec730327380", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/aae80959b2039e6f03082f16a1c99ec730327380", "committedDate": "2020-02-03T15:43:36Z", "message": "Better enforcement and logging of min/max WS connections"}, "afterCommit": {"oid": "1716a52ce953b36d9e3a250e8c9b184a15c29e6d", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/1716a52ce953b36d9e3a250e8c9b184a15c29e6d", "committedDate": "2020-02-03T15:44:10Z", "message": "Better enforcement and logging of min/max WS connections"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMzc3NjY3", "url": "https://github.com/cryostatio/cryostat/pull/115#pullrequestreview-352377667", "createdAt": "2020-02-03T16:16:16Z", "commit": {"oid": "1716a52ce953b36d9e3a250e8c9b184a15c29e6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3117, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}