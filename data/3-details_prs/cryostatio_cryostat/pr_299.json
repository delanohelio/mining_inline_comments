{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0Mzk1Njgy", "number": 299, "title": "Upload certificate", "bodyText": "Fixes #273\nA few things that may need attention:\n\nThe status code 409 for certificate already exists (not sure if that is the most appropriate)\nI am not sure if the fact that a restart of the JVM is needed should be communicated anywhere (I guess it would be added to the docs and in the future web UI)\nWhen uploading the certificate, it is in a form with the name cert (it checks for this). This might not be the best name or even the most appropriate way to send it. (current curl command is curl -X POST -F cert=@PATH/vertx-fib-demo.cer -vk https://localhost:8181/api/v2/certificates)", "createdAt": "2020-10-15T21:23:22Z", "url": "https://github.com/cryostatio/cryostat/pull/299", "merged": true, "mergeCommit": {"oid": "36ef45d31abd34143966ff4fb26d1c9cef4cffcf"}, "closed": true, "closedAt": "2020-10-23T14:55:29Z", "author": {"login": "Alexjsenn"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS2O1egH2gAyNTA0Mzk1NjgyOjg3MmU2NmM1MGIwZmI4NTc1MmNkYzg4YTg3MjE1MjZlZjRmMGUxYjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVX0yPgFqTUxNTc0NTIzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "872e66c50b0fb85752cdc88a8721526ef4f0e1b3", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/872e66c50b0fb85752cdc88a8721526ef4f0e1b3", "committedDate": "2020-10-15T18:38:57Z", "message": "Create handler for certificate post request, writes to truststore but trustore is not dynamically read during runtime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06f8a087b9694a9906e352b4d4ccb056584a2c6e", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/06f8a087b9694a9906e352b4d4ccb056584a2c6e", "committedDate": "2020-10-15T18:38:57Z", "message": "add truststore dir as env var"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/a03e8372d02b33211767d1230a2b8052447e81f2", "committedDate": "2020-10-15T21:08:40Z", "message": "Certificate post handler saves file to truststore dir, requires JVM restart for cert to take effect"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODI0MTM5", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-509824139", "createdAt": "2020-10-15T21:31:18Z", "commit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTozMToxOFrOHib7qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTozMToxOFrOHib7qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3MTI3NA==", "bodyText": "Maybe this should be more direct about the problem, like A file named \"cert\" was not included in the request?", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r505871274", "createdAt": "2020-10-15T21:31:18Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"No certificate found\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "originalPosition": 121}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODI2MTE0", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-509826114", "createdAt": "2020-10-15T21:35:01Z", "commit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTozNTowMVrOHicGSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTozNTowMVrOHicGSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3Mzk5NA==", "bodyText": "Better to avoid manually constructing paths like this. fs.pathOf takes varargs, so you should just be able to do fs.exists(fs.pathOf(truststoreDir, cert.fileName()))", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r505873994", "createdAt": "2020-10-15T21:35:01Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"No certificate found\");\n+        }\n+\n+        String certPath = fs.pathOf(cert.uploadedFileName()).normalize().toString();\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = truststoreDir + \"/\" + cert.fileName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODI4Mzcz", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-509828373", "createdAt": "2020-10-15T21:39:18Z", "commit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTozOToxOFrOHicStg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTozOToxOFrOHicStg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NzE3NA==", "bodyText": "This looks like it can/should be refactored to use try-with-resources:\ntry (DataInputStream dis = new DataInputStream(new FileInputStream(certPath))) {\n// do stuff\n}\n\nThis is assuming that these resources are autocloseable, but I would expect they are. Generally anything that is autocloseable should be wrapped in a try-with-resources, since it guarantees that the resource is properly closed, even if an exception is thrown or there is an early return statement or any other exit condition. Probably all of the various Streams in here should be wrapped in this way.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r505877174", "createdAt": "2020-10-15T21:39:18Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"No certificate found\");\n+        }\n+\n+        String certPath = fs.pathOf(cert.uploadedFileName()).normalize().toString();\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = truststoreDir + \"/\" + cert.fileName();\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, \"Certificate already exists\");\n+        }\n+\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "originalPosition": 136}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODI5MTQ5", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-509829149", "createdAt": "2020-10-15T21:40:51Z", "commit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTo0MDo1MVrOHicWzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTo0MDo1MVrOHicWzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3ODIyMQ==", "bodyText": "May as well include the name of the conflicting certificate here, just for ease of debugging if this is showing up in ex. Operator logs or something.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r505878221", "createdAt": "2020-10-15T21:40:51Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"No certificate found\");\n+        }\n+\n+        String certPath = fs.pathOf(cert.uploadedFileName()).normalize().toString();\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = truststoreDir + \"/\" + cert.fileName();\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, \"Certificate already exists\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "originalPosition": 133}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODI5Nzg4", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-509829788", "createdAt": "2020-10-15T21:42:08Z", "commit": {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16df3bb3d6b19bb305fcf980f33829dcc2318de1", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/16df3bb3d6b19bb305fcf980f33829dcc2318de1", "committedDate": "2020-10-19T15:22:00Z", "message": "Change error messages, refactor try block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExODg3NDgw", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-511887480", "createdAt": "2020-10-19T15:27:30Z", "commit": {"oid": "16df3bb3d6b19bb305fcf980f33829dcc2318de1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNToyNzozMFrOHkUX8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNToyNzozMFrOHkUX8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0NDU5NQ==", "bodyText": "I think ByteArrayInputStream must also be closed, and is AutoCloseable.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r507844595", "createdAt": "2020-10-19T15:27:30Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        String certPath = fs.pathOf(cert.uploadedFileName()).normalize().toString();\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, filePath + \" Certificate already exists\");\n+        }\n+\n+        File certFile = new File(filePath);\n+\n+        try (FileInputStream fis = new FileInputStream(certPath);\n+                DataInputStream dis = new DataInputStream(fis);\n+                FileOutputStream out = new FileOutputStream(certFile)) {\n+            CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n+\n+            byte[] bytes = new byte[dis.available()];\n+            dis.readFully(bytes);\n+\n+            ByteArrayInputStream bytestream = new ByteArrayInputStream(bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16df3bb3d6b19bb305fcf980f33829dcc2318de1"}, "originalPosition": 146}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bdf82ae7b92a3c815cce85ed2ee0faaf02d03f7", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/5bdf82ae7b92a3c815cce85ed2ee0faaf02d03f7", "committedDate": "2020-10-21T19:04:40Z", "message": "Add unit tests for certificatePostHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/edc75015f9d01666a2c53e81bb3057ef39fe906e", "committedDate": "2020-10-21T19:43:08Z", "message": "suppress spotbug error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTI2MTkw", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-514126190", "createdAt": "2020-10-21T19:46:50Z", "commit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0Njo1MVrOHmA6mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0Njo1MVrOHmA6mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyMjkzNw==", "bodyText": "verify doesn't seem like the right name given the argument types and return type, even though it does reflect what the caller is currently using the method for. certificateFromBytes or something might be a more accurate/descriptive name, or even just createCertificate or parseCertificate.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509622937", "createdAt": "2020-10-21T19:46:51Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/security/CertificateValidator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.security;\n+\n+import java.io.ByteArrayInputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+\n+public class CertificateValidator {\n+\n+    public Certificate verify(ByteArrayInputStream byteStream) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTI4NTY4", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-514128568", "createdAt": "2020-10-21T19:48:48Z", "commit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0ODo0OFrOHmA_lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0ODo0OFrOHmA_lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNDIxMw==", "bodyText": "I think filePath can be left as type Path here, removing the .toString()...", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509624213", "createdAt": "2020-10-21T19:48:48Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "originalPosition": 147}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTI4ODQ1", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-514128845", "createdAt": "2020-10-21T19:49:12Z", "commit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0OToxMlrOHmBAVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0OToxMlrOHmBAVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNDQwNg==", "bodyText": "... which would remove the need for the repeated fs.pathOf here...", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509624406", "createdAt": "2020-10-21T19:49:12Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();\n+\n+        if (fs.exists(fs.pathOf(filePath))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "originalPosition": 149}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTI5MzE0", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-514129314", "createdAt": "2020-10-21T19:49:44Z", "commit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0OTo0NFrOHmBBkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0OTo0NFrOHmBBkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNDcyMg==", "bodyText": "... and here, filePath.toFile() would achieve the same thing if you really need it as a File.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509624722", "createdAt": "2020-10-21T19:49:44Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();\n+\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, filePath + \" Certificate already exists\");\n+        }\n+\n+        File certFile = new File(filePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "originalPosition": 153}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTM1MTUz", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-514135153", "createdAt": "2020-10-21T19:53:55Z", "commit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo1Mzo1NVrOHmBTmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo1Mzo1NVrOHmBTmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyOTMzNw==", "bodyText": "This catch clause should probably be removed - the parent AbstractAuthenticatedRequestHandler class already has handling for exceptions thrown by subclasses, including general Exceptions which get wrapped into 500s similar to what has been repeated here. IMO it would be better to allow the abstract parent class to handle this so that the behaviour across all concrete implementations is uniform.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509629337", "createdAt": "2020-10-21T19:53:55Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();\n+\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, filePath + \" Certificate already exists\");\n+        }\n+\n+        File certFile = new File(filePath);\n+\n+        try (InputStream fis = fs.newInputStream(certPath);\n+                DataInputStream dis = new DataInputStream(fis);\n+                FileOutputStream out = outputStreamFunction.apply(certFile)) {\n+\n+            byte[] bytes = new byte[dis.available()];\n+            dis.readFully(bytes);\n+            ByteArrayInputStream bytestream = new ByteArrayInputStream(bytes);\n+            Certificate certificate = certValidator.verify(bytestream);\n+            byte[] buf = certificate.getEncoded();\n+\n+            out.write(buf);\n+        } catch (Exception e) {\n+            throw new HttpStatusException(500, e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e"}, "originalPosition": 167}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "759f5d5052af9b578ab7799aaa70a6603e7a7cf3", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/759f5d5052af9b578ab7799aaa70a6603e7a7cf3", "committedDate": "2020-10-21T20:06:43Z", "message": "Change certificateValidator method name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c32f319801869263927398dca550de1510e98f0e", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/c32f319801869263927398dca550de1510e98f0e", "committedDate": "2020-10-21T20:15:00Z", "message": "remove catch statement in certificatePostHandler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODUzMzkx", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-514853391", "createdAt": "2020-10-22T15:27:42Z", "commit": {"oid": "c32f319801869263927398dca550de1510e98f0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNToyNzo0MlrOHmndfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNToyNzo0MlrOHmndfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1NDQ2Mw==", "bodyText": "buf seems unnecessary - if parseCertificate is just being used to validate that bytestream represents a well-formed certificate, can't we do out.write(bytestream) and avoid potentially re-encoding the Certificate back into a byte array, since we already have the byte array that encoded it to begin with?", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510254463", "createdAt": "2020-10-22T15:27:42Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        Path filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize();\n+\n+        if (fs.exists(filePath)) {\n+            throw new HttpStatusException(409, filePath.toString() + \" Certificate already exists\");\n+        }\n+\n+        try (InputStream fis = fs.newInputStream(certPath);\n+                DataInputStream dis = new DataInputStream(fis);\n+                FileOutputStream out = outputStreamFunction.apply(filePath.toFile())) {\n+\n+            byte[] bytes = new byte[dis.available()];\n+            dis.readFully(bytes);\n+            ByteArrayInputStream bytestream = new ByteArrayInputStream(bytes);\n+            Certificate certificate = certValidator.parseCertificate(bytestream);\n+            byte[] buf = certificate.getEncoded();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c32f319801869263927398dca550de1510e98f0e"}, "originalPosition": 161}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86ef8d24b71af739a45de9b8e86907b91b4d0f3e", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/86ef8d24b71af739a45de9b8e86907b91b4d0f3e", "committedDate": "2020-10-22T15:33:31Z", "message": "close byteArrayInputStream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODY1MTI4", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-514865128", "createdAt": "2020-10-22T15:39:27Z", "commit": {"oid": "86ef8d24b71af739a45de9b8e86907b91b4d0f3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTozOToyN1rOHmn_-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTozOToyN1rOHmn_-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MzI5MA==", "bodyText": "Are you sure dis.available() tells you the total size of the certificate data in all scenarios? Not all streams implement available() in this way - it's more common that this method reports the number of bytes that can be read without blocking on the next invocation of read(). If this is the case, then for larger certificates (or various other conditions perhaps to do with the underlying OS/kernel, filesystem, etc.), this byte buffer may end up undersized and only some initial chunk of the certificate will be read into the buffer, rather than the whole thing.\nWhy is the ByteArrayInputStream wrapping around this buffer needed to begin with? Can't fis or dis be passed directly to parseCertificate? The docs for generateCertificate say it accepts a generic InputStream, not specifically a ByteArrayInputStream.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510263290", "createdAt": "2020-10-22T15:39:27Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        Path filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize();\n+\n+        if (fs.exists(filePath)) {\n+            throw new HttpStatusException(409, filePath.toString() + \" Certificate already exists\");\n+        }\n+\n+        try (InputStream fis = fs.newInputStream(certPath);\n+                DataInputStream dis = new DataInputStream(fis);\n+                FileOutputStream out = outputStreamFunction.apply(filePath.toFile())) {\n+\n+            byte[] bytes = new byte[dis.available()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86ef8d24b71af739a45de9b8e86907b91b4d0f3e"}, "originalPosition": 157}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4409c0d1ccd80fcac088d2441ad2c45d690fdefc", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/4409c0d1ccd80fcac088d2441ad2c45d690fdefc", "committedDate": "2020-10-22T19:26:32Z", "message": "Change certificateValidator to return Collection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDcyMjA2", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-515072206", "createdAt": "2020-10-22T19:57:39Z", "commit": {"oid": "4409c0d1ccd80fcac088d2441ad2c45d690fdefc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTo1NzozOVrOHmxmpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTo1NzozOVrOHmxmpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyMDY0Nw==", "bodyText": "Little nitpick: since this now returns a Collection, the method name should probably be update to reflect that. ie parseCertificates. Also, the raw type Collection could probably be written here as Collection<Certificate> for a bit of extra type-safety.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510420647", "createdAt": "2020-10-22T19:57:39Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/security/CertificateValidator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.security;\n+\n+import java.io.InputStream;\n+import java.security.cert.CertificateFactory;\n+import java.util.Collection;\n+\n+public class CertificateValidator {\n+\n+    public Collection parseCertificate(InputStream stream) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4409c0d1ccd80fcac088d2441ad2c45d690fdefc"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDczNjg1", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-515073685", "createdAt": "2020-10-22T19:59:42Z", "commit": {"oid": "4409c0d1ccd80fcac088d2441ad2c45d690fdefc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTo1OTo0MlrOHmxrIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTo1OTo0MlrOHmxrIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyMTc5NQ==", "bodyText": "Likewise, this Collection and its Iterator are raw types here but are generics and so should be Collection<? extends Certificate> and Iterator<? extends Certificate>.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510421795", "createdAt": "2020-10-22T19:59:42Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        Path filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize();\n+\n+        if (fs.exists(filePath)) {\n+            throw new HttpStatusException(409, filePath.toString() + \" Certificate already exists\");\n+        }\n+\n+        try (InputStream fis = fs.newInputStream(certPath);\n+                FileOutputStream out = outputStreamFunction.apply(filePath.toFile())) {\n+\n+            Collection certificates = certValidator.parseCertificate(fis);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4409c0d1ccd80fcac088d2441ad2c45d690fdefc"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ee4e9d18a55802d54a404367e9bcbe06d74f5ed", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/5ee4e9d18a55802d54a404367e9bcbe06d74f5ed", "committedDate": "2020-10-22T20:50:28Z", "message": "Change method name for certificateValidator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzI0MTg0", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-515724184", "createdAt": "2020-10-23T14:32:36Z", "commit": {"oid": "5ee4e9d18a55802d54a404367e9bcbe06d74f5ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDozMjozNlrOHnQdfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDozMjozNlrOHnQdfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkyNjIwNw==", "bodyText": "This is failing to compile for me - this line returns Collection<? extends Certificate> but the return type of parseCertificates is Collection<Certificate>. The method return type should be updated to match the bounded wildcard as we discussed over IRC.", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510926207", "createdAt": "2020-10-23T14:32:36Z", "author": {"login": "andrewazores"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/security/CertificateValidator.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.security;\n+\n+import java.io.InputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.util.Collection;\n+\n+public class CertificateValidator {\n+\n+    public Collection<Certificate> parseCertificates(InputStream stream) throws Exception {\n+        CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n+        return cf.generateCertificates(stream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee4e9d18a55802d54a404367e9bcbe06d74f5ed"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdf52d81ad68eb63b51e3c15235c34497c4e4a3f", "author": {"user": {"login": "Alexjsenn", "name": "Alex Senn"}}, "url": "https://github.com/cryostatio/cryostat/commit/cdf52d81ad68eb63b51e3c15235c34497c4e4a3f", "committedDate": "2020-10-23T14:46:34Z", "message": "Change return type for parseCertificates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzQ1MjMw", "url": "https://github.com/cryostatio/cryostat/pull/299#pullrequestreview-515745230", "createdAt": "2020-10-23T14:55:07Z", "commit": {"oid": "cdf52d81ad68eb63b51e3c15235c34497c4e4a3f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3089, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}