{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMzg3Mzgz", "number": 360, "title": "TargetConnectionManager allows concurrent connections", "bodyText": "Based on top of #359 - requires subprocess to not use its own independent TargetConnectionManager\nThis modifies the TargetConnectionManager to use a timed cache of JFRConnections, which by default expire (are closed and removed from cache) 90 seconds after their last access.\nThe advantage is that targeted requests taking place within a short time period of each other - such as a web-client user navigating around to see event templates, then creating a recording, then viewing a report, etc. - can generally use one long-lived connection between the ContainerJFR backend and the target, rather than opening and closing the connection on each user operation. This significantly improves responsiveness by removing a lot of latency from targeted API responses. This also allows for concurrent connections to multiple targets, whereas previously only one open connection to a single target was allowed, and requests would be blocked until the previous connection was closed.\n\nIntegration tests should be added to exercise the multi-target scenario in a consistent way, rather than simply by manual smoketesting. This will be much easier to do after #376 .", "createdAt": "2020-12-16T19:23:42Z", "url": "https://github.com/cryostatio/cryostat/pull/360", "merged": true, "mergeCommit": {"oid": "f727d34b160fca25652294c2972f8ea7f030f9f8"}, "closed": true, "closedAt": "2021-01-14T15:36:29Z", "author": {"login": "andrewazores"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnHEvsABqjQxMjYyNTY4ODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdwEeulgFqTU2ODIzOTEyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2d2bc6b913c60481f0843bb17a9114d59b2e1c5", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/a2d2bc6b913c60481f0843bb17a9114d59b2e1c5", "committedDate": "2020-12-16T19:19:57Z", "message": "Implement concurrent JMX connection and enable timed reuse"}, "afterCommit": {"oid": "e4b1e228b2e44a10ee339cbc57c9956e4f56ec57", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/e4b1e228b2e44a10ee339cbc57c9956e4f56ec57", "committedDate": "2020-12-17T17:34:40Z", "message": "Implement concurrent JMX connection and enable timed reuse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4b1e228b2e44a10ee339cbc57c9956e4f56ec57", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/e4b1e228b2e44a10ee339cbc57c9956e4f56ec57", "committedDate": "2020-12-17T17:34:40Z", "message": "Implement concurrent JMX connection and enable timed reuse"}, "afterCommit": {"oid": "80c439567d4f9a05aa005e19b50a1eb36d417768", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/80c439567d4f9a05aa005e19b50a1eb36d417768", "committedDate": "2020-12-17T19:02:26Z", "message": "Implement concurrent JMX connection and enable timed reuse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80c439567d4f9a05aa005e19b50a1eb36d417768", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/80c439567d4f9a05aa005e19b50a1eb36d417768", "committedDate": "2020-12-17T19:02:26Z", "message": "Implement concurrent JMX connection and enable timed reuse"}, "afterCommit": {"oid": "d5cbe460a7be6183421c8b08a4d7001904caa974", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/d5cbe460a7be6183421c8b08a4d7001904caa974", "committedDate": "2020-12-18T17:20:39Z", "message": "Implement concurrent JMX connection and enable timed reuse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5cbe460a7be6183421c8b08a4d7001904caa974", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/d5cbe460a7be6183421c8b08a4d7001904caa974", "committedDate": "2020-12-18T17:20:39Z", "message": "Implement concurrent JMX connection and enable timed reuse"}, "afterCommit": {"oid": "a3f89dd857d797a70e1c770ca292048e8702b7cd", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/a3f89dd857d797a70e1c770ca292048e8702b7cd", "committedDate": "2020-12-18T17:25:59Z", "message": "Implement concurrent JMX connection and enable timed reuse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa382b2165dd2516ec95fe469631a85fb8fa9c56", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/aa382b2165dd2516ec95fe469631a85fb8fa9c56", "committedDate": "2020-12-18T18:01:12Z", "message": "Do not expose RemovalListener in public interface"}, "afterCommit": {"oid": "d883e6a0f28bc4ee32415fe2eeff8b310f9610d6", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/d883e6a0f28bc4ee32415fe2eeff8b310f9610d6", "committedDate": "2020-12-18T18:03:58Z", "message": "Do not expose RemovalListener in public interface"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1220c39158f311baf6bbe2221a9b79cd91e03c5", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/d1220c39158f311baf6bbe2221a9b79cd91e03c5", "committedDate": "2020-12-18T18:14:42Z", "message": "Invalidate cached connection if explicitly closed"}, "afterCommit": {"oid": "56601ddd59bfd5ca537848c805ba60a45bf7368d", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/56601ddd59bfd5ca537848c805ba60a45bf7368d", "committedDate": "2020-12-18T18:28:27Z", "message": "Invalidate cached connection if explicitly closed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53b43633433bcedcaa11245fcc6aa1a88beba533", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/53b43633433bcedcaa11245fcc6aa1a88beba533", "committedDate": "2020-12-18T19:01:47Z", "message": "Implement method for long-running operations to mark connection as still in use"}, "afterCommit": {"oid": "faf55f551f9110b9cbc923bd3350656a02a506bc", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/faf55f551f9110b9cbc923bd3350656a02a506bc", "committedDate": "2020-12-18T19:03:35Z", "message": "Implement method for long-running operations to mark connection as still in use"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "faf55f551f9110b9cbc923bd3350656a02a506bc", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/faf55f551f9110b9cbc923bd3350656a02a506bc", "committedDate": "2020-12-18T19:03:35Z", "message": "Implement method for long-running operations to mark connection as still in use"}, "afterCommit": {"oid": "7b722dd551d1e3510ec7d41294c6facbf99372f1", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/7b722dd551d1e3510ec7d41294c6facbf99372f1", "committedDate": "2020-12-18T19:05:45Z", "message": "Implement method for long-running operations to mark connection as still in use"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b722dd551d1e3510ec7d41294c6facbf99372f1", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/7b722dd551d1e3510ec7d41294c6facbf99372f1", "committedDate": "2020-12-18T19:05:45Z", "message": "Implement method for long-running operations to mark connection as still in use"}, "afterCommit": {"oid": "e344b75dc0189f39cdad66dea25c757264136003", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/e344b75dc0189f39cdad66dea25c757264136003", "committedDate": "2020-12-21T15:42:13Z", "message": "Implement method for long-running operations to mark connection as still in use"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e344b75dc0189f39cdad66dea25c757264136003", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/e344b75dc0189f39cdad66dea25c757264136003", "committedDate": "2020-12-21T15:42:13Z", "message": "Implement method for long-running operations to mark connection as still in use"}, "afterCommit": {"oid": "187e67c70f6f51706de0cef7f4b7a17a483fd099", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/187e67c70f6f51706de0cef7f4b7a17a483fd099", "committedDate": "2020-12-21T18:26:03Z", "message": "Implement method for long-running operations to mark connection as still in use"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4c783257a4309a0a8fa6c52494a86764a6fc95f", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/e4c783257a4309a0a8fa6c52494a86764a6fc95f", "committedDate": "2020-12-21T18:26:26Z", "message": "Report generation lock should attempt fairness"}, "afterCommit": {"oid": "9d95d66dc417949e8ef8eb2633777d23a13a6a16", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/9d95d66dc417949e8ef8eb2633777d23a13a6a16", "committedDate": "2020-12-22T23:29:51Z", "message": "Update JUnit to 5.7.0"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30e2c3e5c3a6154f0748fd88fdb8c4604b5dc250", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/30e2c3e5c3a6154f0748fd88fdb8c4604b5dc250", "committedDate": "2020-12-22T23:30:48Z", "message": "Set up test container inside a pod"}, "afterCommit": {"oid": "b588ff62bae934c9164ae08362e3b2e5b425375a", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/b588ff62bae934c9164ae08362e3b2e5b425375a", "committedDate": "2020-12-23T16:15:46Z", "message": "Set up test container inside a pod"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c14b12f891456e92c9e8d9f602741350c4807049", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/c14b12f891456e92c9e8d9f602741350c4807049", "committedDate": "2020-12-23T18:31:27Z", "message": "Add basic external container discovery test\n\nAdd test and utils to run an external container within the test pod, check that ContainerJFR discovers it, and then tear down"}, "afterCommit": {"oid": "5f91be48b40ce1d914e92b9f233a46d42bde92c3", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/5f91be48b40ce1d914e92b9f233a46d42bde92c3", "committedDate": "2020-12-23T21:13:19Z", "message": "Report generation lock should attempt fairness"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f91be48b40ce1d914e92b9f233a46d42bde92c3", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/5f91be48b40ce1d914e92b9f233a46d42bde92c3", "committedDate": "2020-12-23T21:13:19Z", "message": "Report generation lock should attempt fairness"}, "afterCommit": {"oid": "21acdd849b7a2be683db3ea47cc76b1decaae2d2", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/21acdd849b7a2be683db3ea47cc76b1decaae2d2", "committedDate": "2021-01-12T21:19:31Z", "message": "Report generation lock should attempt fairness"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21acdd849b7a2be683db3ea47cc76b1decaae2d2", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/21acdd849b7a2be683db3ea47cc76b1decaae2d2", "committedDate": "2021-01-12T21:19:31Z", "message": "Report generation lock should attempt fairness"}, "afterCommit": {"oid": "1a6e9fbbe8c148a794b33cd5ddfa2188427f08b7", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/1a6e9fbbe8c148a794b33cd5ddfa2188427f08b7", "committedDate": "2021-01-12T21:26:26Z", "message": "Report generation lock should attempt fairness"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a6e9fbbe8c148a794b33cd5ddfa2188427f08b7", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/1a6e9fbbe8c148a794b33cd5ddfa2188427f08b7", "committedDate": "2021-01-12T21:26:26Z", "message": "Report generation lock should attempt fairness"}, "afterCommit": {"oid": "ed191f8b3906f4c2de4fff29f017258fb09f1979", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/ed191f8b3906f4c2de4fff29f017258fb09f1979", "committedDate": "2021-01-12T21:35:13Z", "message": "Report generation lock should attempt fairness"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed191f8b3906f4c2de4fff29f017258fb09f1979", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/ed191f8b3906f4c2de4fff29f017258fb09f1979", "committedDate": "2021-01-12T21:35:13Z", "message": "Report generation lock should attempt fairness"}, "afterCommit": {"oid": "d1bf1de660de23a985207b064d79fc55f6e2fada", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/d1bf1de660de23a985207b064d79fc55f6e2fada", "committedDate": "2021-01-12T21:37:17Z", "message": "Minor typo fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56f8356a5226bcea076ed3837307ad9589c7fb26", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/56f8356a5226bcea076ed3837307ad9589c7fb26", "committedDate": "2021-01-12T22:02:59Z", "message": "Use vertx-fib-demo:0.6.0\n\nDeploy one without SSL or auth, one with just auth, and one with both"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "960bb16cf4d7bc98456b7a5a87f73c744e7f52c2", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/960bb16cf4d7bc98456b7a5a87f73c744e7f52c2", "committedDate": "2021-01-12T22:02:59Z", "message": "Rename test class and add many-container interleaved requests test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1bf1de660de23a985207b064d79fc55f6e2fada", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/d1bf1de660de23a985207b064d79fc55f6e2fada", "committedDate": "2021-01-12T21:37:17Z", "message": "Minor typo fix"}, "afterCommit": {"oid": "a0795d846cff926717ba257eebea59fc86382d70", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/a0795d846cff926717ba257eebea59fc86382d70", "committedDate": "2021-01-12T22:02:59Z", "message": "Minor typo fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b3316320b0439fc0982e75e9e08be5c86db8864", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/5b3316320b0439fc0982e75e9e08be5c86db8864", "committedDate": "2021-01-13T14:43:36Z", "message": "Perform test result verification in parallel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0795d846cff926717ba257eebea59fc86382d70", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/a0795d846cff926717ba257eebea59fc86382d70", "committedDate": "2021-01-12T22:02:59Z", "message": "Minor typo fix"}, "afterCommit": {"oid": "3691b24b7d1516051a1dfc4b29a97c530a98a733", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/3691b24b7d1516051a1dfc4b29a97c530a98a733", "committedDate": "2021-01-13T14:43:37Z", "message": "Minor typo fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28ac09c391455332c8fde8010e70e91e33228d01", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/28ac09c391455332c8fde8010e70e91e33228d01", "committedDate": "2021-01-13T15:17:45Z", "message": "Ensure recording deletions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6a1461fc9dad9eec14cb2470fbe77a51a70020c", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/f6a1461fc9dad9eec14cb2470fbe77a51a70020c", "committedDate": "2021-01-13T15:17:45Z", "message": "Implement concurrent JMX connection and enable timed reuse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0301c6ba46b7e56d43d736320a1e08ad960ceaa4", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/0301c6ba46b7e56d43d736320a1e08ad960ceaa4", "committedDate": "2021-01-13T15:17:45Z", "message": "Remove explicit public connect method\n\nAll consumers of TargetConnectionManager now use executeConnectedTask and use the cached connection semantics, with manual resource handling and closure removed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28bdf7b7f63af5a46f35581a2f257a8e5913ff1f", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/28bdf7b7f63af5a46f35581a2f257a8e5913ff1f", "committedDate": "2021-01-13T15:17:45Z", "message": "Do not expose RemovalListener in public interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9104b04adf2f6f92fd7bd4545761b396347835e5", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/9104b04adf2f6f92fd7bd4545761b396347835e5", "committedDate": "2021-01-13T15:17:45Z", "message": "Invalidate cached connection if explicitly closed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55e548516623dd9ce18a6f6e77511be01ca9afd4", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/55e548516623dd9ce18a6f6e77511be01ca9afd4", "committedDate": "2021-01-13T15:17:45Z", "message": "Implement method for long-running operations to mark connection as still in use"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52f6e253cb93accce8fce9a09b61de3fca676c81", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/52f6e253cb93accce8fce9a09b61de3fca676c81", "committedDate": "2021-01-13T15:17:45Z", "message": "Report generation lock should attempt fairness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ae1983a0267d8ef0c8a018359485624d2ed44a9", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/5ae1983a0267d8ef0c8a018359485624d2ed44a9", "committedDate": "2021-01-13T15:17:45Z", "message": "Minor typo fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3691b24b7d1516051a1dfc4b29a97c530a98a733", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/3691b24b7d1516051a1dfc4b29a97c530a98a733", "committedDate": "2021-01-13T14:43:37Z", "message": "Minor typo fix"}, "afterCommit": {"oid": "5ae1983a0267d8ef0c8a018359485624d2ed44a9", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/5ae1983a0267d8ef0c8a018359485624d2ed44a9", "committedDate": "2021-01-13T15:17:45Z", "message": "Minor typo fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NjE5MzQ2", "url": "https://github.com/cryostatio/cryostat/pull/360#pullrequestreview-567619346", "createdAt": "2021-01-13T20:55:30Z", "commit": {"oid": "5ae1983a0267d8ef0c8a018359485624d2ed44a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QyMDo1NTozMFrOITBuzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QyMDo1NTozMFrOITBuzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgyMjIyMQ==", "bodyText": "This can be written as logger.info(\"removing cached connection for %s\", descriptor.getTargetId()). I changed all the string.format statements in a PR a month ago, it probably makes sense to keep it consistent!", "url": "https://github.com/cryostatio/cryostat/pull/360#discussion_r556822221", "createdAt": "2021-01-13T20:55:30Z", "author": {"login": "Alexjsenn"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/TargetConnectionManager.java", "diffHunk": "@@ -63,42 +67,72 @@\n     public static final Pattern HOST_PORT_PAIR_PATTERN =\n             Pattern.compile(\"^([^:\\\\s]+)(?::(\\\\d{1,5}))?$\");\n \n-    private final Logger logger;\n-    // FIXME verify concurrent connection safety and remove locking\n-    private final ReentrantLock lock = new ReentrantLock();\n-    // maintain a short-lived cache of connections to allow nested ConnectedTasks\n-    // without having to manage connection reuse\n-    private final Map<ConnectionDescriptor, JFRConnection> activeConnections = new HashMap<>();\n+    static final Duration DEFAULT_TTL = Duration.ofSeconds(90);\n+\n     private final Lazy<JFRConnectionToolkit> jfrConnectionToolkit;\n+    private final Logger logger;\n \n-    public TargetConnectionManager(Logger logger, Lazy<JFRConnectionToolkit> jfrConnectionToolkit) {\n-        this.logger = logger;\n+    private final LoadingCache<ConnectionDescriptor, JFRConnection> connections;\n+\n+    TargetConnectionManager(\n+            Lazy<JFRConnectionToolkit> jfrConnectionToolkit, Duration ttl, Logger logger) {\n         this.jfrConnectionToolkit = jfrConnectionToolkit;\n+        this.logger = logger;\n+\n+        this.connections =\n+                Caffeine.newBuilder()\n+                        .scheduler(Scheduler.systemScheduler())\n+                        .expireAfterAccess(ttl)\n+                        .removalListener(\n+                                new RemovalListener<ConnectionDescriptor, JFRConnection>() {\n+                                    @Override\n+                                    public void onRemoval(\n+                                            ConnectionDescriptor descriptor,\n+                                            JFRConnection connection,\n+                                            RemovalCause cause) {\n+                                        if (descriptor == null) {\n+                                            logger.warn(\n+                                                    \"Connection eviction triggered with null descriptor\");\n+                                            return;\n+                                        }\n+                                        if (connection == null) {\n+                                            logger.warn(\n+                                                    \"Connection eviction triggered with null connection\");\n+                                            return;\n+                                        }\n+                                        logger.info(\n+                                                String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae1983a0267d8ef0c8a018359485624d2ed44a9"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6aea85d68e9417a3f4166fc345e470a7e1e8fbb2", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/6aea85d68e9417a3f4166fc345e470a7e1e8fbb2", "committedDate": "2021-01-13T21:02:43Z", "message": "Fix logger message format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MjM5MTIw", "url": "https://github.com/cryostatio/cryostat/pull/360#pullrequestreview-568239120", "createdAt": "2021-01-14T13:38:47Z", "commit": {"oid": "6aea85d68e9417a3f4166fc345e470a7e1e8fbb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3108, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}