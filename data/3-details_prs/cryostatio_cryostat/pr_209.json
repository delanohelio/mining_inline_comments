{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNDUyMjI1", "number": 209, "title": "Initial JMX authentication foundation", "bodyText": "Related to #5\nSee also cryostatio/cryostat-core#42\nThis PR lays down initial support for connections to targets using JMX access control/authentication. No mechanism for the user to supply JMX credentials is yet implemented, but connections to targets configured with JMX security will now fail with an identifiable exception, including an appropriate HTTP header for HTTP API requests or an appropriate status code for WebSocket API commands. HTTP API support for supplying credentials will be relatively simple - the AbstractAuthenticatedRequestHandler#getConnectionDescriptorFromContext method will simply be updated to check the Proxy-Authorization request header for Basic auth credentials to pass on to the target JMX connection. WebSocket API support for optional credentials will require more work (see: #205 for one proposed solution), or perhaps the WebSocket API will simply never gain JMX auth support and all such requests will need to go through the HTTP REST API instead.\nAdditionally, the ContainerJFR container image is now built with a custom entrypoint script, and the entrypoint by default enables JMX access control on the container's own remote JMX port, with an autogenerated password for the default \"containerjfr\" user. This password can be seen in the ContainerJFR instance's logs at startup time. This authentication (and the password generation) can be disabled for testing/development purposes. The SelfDisoveryPlatformClient is also removed and JDP autodiscovery is enabled instead so that the ContainerJFR instance can use JDP to discover itself within its container in a more uniform manner, providing itself with its own JMXServiceURL and Main-Class name. In environments where JDP autodiscovery is not used, ex. Kubernetes/OpenShift, this also has the net effect of preventing the self-connection list item from appearing in the discovered targets list.", "createdAt": "2020-07-16T19:31:15Z", "url": "https://github.com/cryostatio/cryostat/pull/209", "merged": true, "mergeCommit": {"oid": "6924d9451dc876b5ccd1d0fd5b24bc1daebe6178"}, "closed": true, "closedAt": "2020-07-28T18:06:18Z", "author": {"login": "andrewazores"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1kvj6ABqjM1NTQ4ODMzMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5XKqtAFqTQ1NjY4MjIzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc749df0e7da59023acc6ede50dd99bad16dea4b", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/bc749df0e7da59023acc6ede50dd99bad16dea4b", "committedDate": "2020-07-16T19:12:23Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}, "afterCommit": {"oid": "bf5f67548e28ac2b883ae387b63b7ecfbdebfd2c", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/bf5f67548e28ac2b883ae387b63b7ecfbdebfd2c", "committedDate": "2020-07-16T19:52:29Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf5f67548e28ac2b883ae387b63b7ecfbdebfd2c", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/bf5f67548e28ac2b883ae387b63b7ecfbdebfd2c", "committedDate": "2020-07-16T19:52:29Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}, "afterCommit": {"oid": "41f8047e0ddc29a4c2fa4821c6187578375e49c9", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/41f8047e0ddc29a4c2fa4821c6187578375e49c9", "committedDate": "2020-07-16T21:41:15Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41f8047e0ddc29a4c2fa4821c6187578375e49c9", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/41f8047e0ddc29a4c2fa4821c6187578375e49c9", "committedDate": "2020-07-16T21:41:15Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}, "afterCommit": {"oid": "2500246165d0560100659ff2e9d8529b6e0582d9", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/2500246165d0560100659ff2e9d8529b6e0582d9", "committedDate": "2020-07-20T19:10:59Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9760ece2f464df3e45b2140ae2e0a51a099fd5c5", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/9760ece2f464df3e45b2140ae2e0a51a099fd5c5", "committedDate": "2020-07-21T19:35:05Z", "message": "Bump required container-jfr-core version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c7246873e400bc231e5c7640c54a425420ae953", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/0c7246873e400bc231e5c7640c54a425420ae953", "committedDate": "2020-07-21T19:35:05Z", "message": "Bubble HTTP Handler JMX auth failure exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b02009cef692e35154bdb82ec2b3706085ff9c2", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/0b02009cef692e35154bdb82ec2b3706085ff9c2", "committedDate": "2020-07-21T19:35:05Z", "message": "Reformat JVM flags for readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eaded0d2dff54e82c23a81658a5ea39d9a0498a", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/5eaded0d2dff54e82c23a81658a5ea39d9a0498a", "committedDate": "2020-07-21T19:35:05Z", "message": "Configure containerjfr for JMX authentication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43bbc5266627c47a23aa3005c59346b40db81b91", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/43bbc5266627c47a23aa3005c59346b40db81b91", "committedDate": "2020-07-21T19:35:05Z", "message": "Avoid NPE on invalid URL format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478eea139d1236dcb88d062b5115b122c5366f7b", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/478eea139d1236dcb88d062b5115b122c5366f7b", "committedDate": "2020-07-21T19:35:05Z", "message": "Wrap container in pod for easy rootless multi-container network testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1da6bd27179eaf3bb99b97b181297bb0fcabf03", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/c1da6bd27179eaf3bb99b97b181297bb0fcabf03", "committedDate": "2020-07-21T19:35:05Z", "message": "Autogenerate self-connection jmxremote.password\n\nAutogenerate credentials for jmxremote.password file used to secure\nContainerJFR's own JMX port at image generation time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aaa022b12d2f4a2c5a6b5b2fca090c84fe8a432", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/7aaa022b12d2f4a2c5a6b5b2fca090c84fe8a432", "committedDate": "2020-07-21T19:35:05Z", "message": "Use custom entrypoint script\n\nEntrypoint generates remote JMX password at container startup time to\nsecure ContainerJFR's own incoming connection port"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28d7507570a5521ae3bcf5a7bbf008fbbdfeccf6", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/28d7507570a5521ae3bcf5a7bbf008fbbdfeccf6", "committedDate": "2020-07-21T19:35:05Z", "message": "Return 404 instead of 500 if target connection fails (other than auth)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a49c5b6900447cfa968ad824917d92713ef8af73", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/a49c5b6900447cfa968ad824917d92713ef8af73", "committedDate": "2020-07-21T19:35:05Z", "message": "Respond with more appropriate status code if target RJMX auth fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7496b59926b27687bc7f624bb7a30ae523566168", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/7496b59926b27687bc7f624bb7a30ae523566168", "committedDate": "2020-07-21T19:35:05Z", "message": "Minor tweak to use updated -core JFRConnectionToolkit with Credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1027d9e91e4d85b2f8f96f5c768d047d961e00", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/1d1027d9e91e4d85b2f8f96f5c768d047d961e00", "committedDate": "2020-07-21T19:35:05Z", "message": "Add serialized command response status enum"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e67fd0f2f83a38930832a747174196146321006", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/0e67fd0f2f83a38930832a747174196146321006", "committedDate": "2020-07-21T19:35:05Z", "message": "Refactor TargetConnectionManager to accept optional JMX connection credentials\n\nSupport for retrieving credentials from commands or HTTP requests not yet implemented, but this lays the foundation to do so"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce4f3f7eb25381a7b0ea4d1daca55c20e45fd196", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/ce4f3f7eb25381a7b0ea4d1daca55c20e45fd196", "committedDate": "2020-07-21T19:35:05Z", "message": "Rebase cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02c981791e710e86237a11a7d472f6dd449bab4c", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/02c981791e710e86237a11a7d472f6dd449bab4c", "committedDate": "2020-07-21T19:35:05Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2500246165d0560100659ff2e9d8529b6e0582d9", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/2500246165d0560100659ff2e9d8529b6e0582d9", "committedDate": "2020-07-20T19:10:59Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}, "afterCommit": {"oid": "02c981791e710e86237a11a7d472f6dd449bab4c", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/02c981791e710e86237a11a7d472f6dd449bab4c", "committedDate": "2020-07-21T19:35:05Z", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTA4MDgx", "url": "https://github.com/cryostatio/cryostat/pull/209#pullrequestreview-456108081", "createdAt": "2020-07-27T20:24:34Z", "commit": {"oid": "02c981791e710e86237a11a7d472f6dd449bab4c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMDoyNDozNVrOG3yO_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMDo1MTowMFrOG3zFoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NzkwMA==", "bodyText": "I think we can remove this catch, or does it still serve a purpose?", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461147900", "createdAt": "2020-07-27T20:24:35Z", "author": {"login": "ebaron"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/TargetConnectionManager.java", "diffHunk": "@@ -93,56 +97,55 @@\n      * finished with it. When possible, clients should use executeConnectedTask instead, which does\n      * perform automatic cleanup when the provided task has been completed.\n      */\n-    public JFRConnection connect(String targetId) throws Exception {\n+    public JFRConnection connect(ConnectionDescriptor connectionDescriptor) throws Exception {\n         try {\n-            return attemptConnectAsJMXServiceURL(targetId);\n+            return attemptConnectAsJMXServiceURL(connectionDescriptor);\n+        } catch (MalformedURLException mue) {\n+            return attemptConnectAsHostPortPair(connectionDescriptor);\n         } catch (Exception e) {\n-            return attemptConnectAsHostPortPair(targetId);\n+            throw e;\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02c981791e710e86237a11a7d472f6dd449bab4c"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1NjM1Mg==", "bodyText": "Real minor thing, but this would be more readable IMO if we used JMC's ConnectionToolkit.createServiceURL. Maybe worth adding a wrapper for it in core next time you make changes there.", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461156352", "createdAt": "2020-07-27T20:40:31Z", "author": {"login": "ebaron"}, "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/TargetConnectionManager.java", "diffHunk": "@@ -93,56 +97,55 @@\n      * finished with it. When possible, clients should use executeConnectedTask instead, which does\n      * perform automatic cleanup when the provided task has been completed.\n      */\n-    public JFRConnection connect(String targetId) throws Exception {\n+    public JFRConnection connect(ConnectionDescriptor connectionDescriptor) throws Exception {\n         try {\n-            return attemptConnectAsJMXServiceURL(targetId);\n+            return attemptConnectAsJMXServiceURL(connectionDescriptor);\n+        } catch (MalformedURLException mue) {\n+            return attemptConnectAsHostPortPair(connectionDescriptor);\n         } catch (Exception e) {\n-            return attemptConnectAsHostPortPair(targetId);\n+            throw e;\n         }\n     }\n \n-    private JFRConnection attemptConnectAsJMXServiceURL(String url) throws Exception {\n-        return connect(new JMXServiceURL(url));\n+    private JFRConnection attemptConnectAsJMXServiceURL(ConnectionDescriptor connectionDescriptor)\n+            throws Exception {\n+        return connect(\n+                new JMXServiceURL(connectionDescriptor.getTargetId()),\n+                connectionDescriptor.getCredentials());\n     }\n \n-    private JFRConnection attemptConnectAsHostPortPair(String s) throws Exception {\n+    private JFRConnection attemptConnectAsHostPortPair(ConnectionDescriptor connectionDescriptor)\n+            throws Exception {\n+        String s = connectionDescriptor.getTargetId();\n         Matcher m = HOST_PORT_PAIR_PATTERN.matcher(s);\n         if (!m.find()) {\n-            return null;\n+            throw new MalformedURLException(s);\n         }\n         String host = m.group(1);\n         String port = m.group(2);\n         if (port == null) {\n             port = \"9091\";\n         }\n-        return connect(host, Integer.parseInt(port));\n+        return connect(\n+                new JMXServiceURL(\n+                        \"rmi\", \"\", 0, String.format(\"/jndi/rmi://%s:%s/jmxrmi\", host, port)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02c981791e710e86237a11a7d472f6dd449bab4c"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE2MTg4OQ==", "bodyText": "I don't see this being called anywhere with an argument. We could probably simplify this to head -c32, unless you want to keep this length parameter for the future.", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461161889", "createdAt": "2020-07-27T20:51:00Z", "author": {"login": "ebaron"}, "path": "src/main/extras/app/entrypoint.sh", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/bin/sh\n+\n+set -x\n+set -e\n+\n+PWFILE=\"/tmp/jmxremote.password\"\n+function createJmxPassword() {\n+    PASS=\"$(< /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c${1:-32})\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02c981791e710e86237a11a7d472f6dd449bab4c"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb0a0da0c1bfce0d7fc86bb3e5931d8dd192657f", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/bb0a0da0c1bfce0d7fc86bb3e5931d8dd192657f", "committedDate": "2020-07-27T21:58:40Z", "message": "Remove redundant 'catch' clause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f51e4fd55a39b1ddff62a6798baf907e86c1a5a2", "author": {"user": {"login": "andrewazores", "name": "Andrew Azores"}}, "url": "https://github.com/cryostatio/cryostat/commit/f51e4fd55a39b1ddff62a6798baf907e86c1a5a2", "committedDate": "2020-07-27T22:03:25Z", "message": "Use fixed-length generated password"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjgyMjM4", "url": "https://github.com/cryostatio/cryostat/pull/209#pullrequestreview-456682238", "createdAt": "2020-07-28T14:19:14Z", "commit": {"oid": "f51e4fd55a39b1ddff62a6798baf907e86c1a5a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3174, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}