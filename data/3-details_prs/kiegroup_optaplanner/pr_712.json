{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMDc2Mjc0", "number": 712, "title": "PLANNER-1865 Disable Drools rules when constraint weight is zero", "bodyText": "I've benchmarked this to cause ~ 5 % performance drop when creating KieSession. (Went from 3300 sessions per second to ~ 3100.)\nConsidering that this operation is not performed frequently, and that it will be followed by a much longer-running solver operation, I do not consider the drop to be significant. Even if the solver only runs for 5 seconds, we have lost a fraction of a millisecond here.", "createdAt": "2020-03-03T17:18:45Z", "url": "https://github.com/kiegroup/optaplanner/pull/712", "merged": true, "mergeCommit": {"oid": "9200f493c5fdc0ffbfa0325d8ec9f2bbb68d0c53"}, "closed": true, "closedAt": "2020-03-10T10:43:32Z", "author": {"login": "triceo"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKKYrkAFqTM2ODM4NTE0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMPGn3gBqjMxMTM4ODgwMzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4Mzg1MTQ2", "url": "https://github.com/kiegroup/optaplanner/pull/712#pullrequestreview-368385146", "createdAt": "2020-03-03T22:51:20Z", "commit": {"oid": "606cb28e9d74d1f9326350df9e657acd6cf88eec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMjo1MToyMFrOFxZioQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMjo1MToyMFrOFxZioQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0MzAwOQ==", "bodyText": "I'll refactor this to disabledConstraintIdSet - that will cause less operations with the collection, and therefore perform better.", "url": "https://github.com/kiegroup/optaplanner/pull/712#discussion_r387343009", "createdAt": "2020-03-03T22:51:20Z", "author": {"login": "triceo"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/drools/DroolsConstraintSessionFactory.java", "diffHunk": "@@ -42,30 +49,65 @@\n public class DroolsConstraintSessionFactory<Solution_> implements ConstraintSessionFactory<Solution_> {\n \n     private final SolutionDescriptor<Solution_> solutionDescriptor;\n-    private final KieBase kieBase;\n-    private final Map<Rule, DroolsConstraint<Solution_>> constraints;\n+    private final Model originalModel;\n+    private KieBase originalKieBase;\n+    private KieBase activeKieBase;\n+    private Set<String> activeConstraintIdSet = null;\n+    private final Map<Rule, DroolsConstraint<Solution_>> compiledRuleToConstraintMap;\n+    private final Map<String, org.drools.model.Rule> constraintToModelRuleMap;\n \n-    public DroolsConstraintSessionFactory(SolutionDescriptor<Solution_> solutionDescriptor, KieBase kieBase,\n+    public DroolsConstraintSessionFactory(SolutionDescriptor<Solution_> solutionDescriptor, Model model,\n             List<DroolsConstraint<Solution_>> constraintList) {\n         this.solutionDescriptor = solutionDescriptor;\n-        this.kieBase = kieBase;\n-        this.constraints = constraintList.stream()\n-                .collect(toMap(constraint -> kieBase.getRule(constraint.getConstraintPackage(),\n+        this.originalModel = model;\n+        this.originalKieBase = KieBaseBuilder.createKieBaseFromModel(model);\n+        this.activeKieBase = originalKieBase;\n+        this.compiledRuleToConstraintMap = constraintList.stream()\n+                .collect(toMap(constraint -> activeKieBase.getRule(constraint.getConstraintPackage(),\n                         constraint.getConstraintName()), Function.identity()));\n+        this.constraintToModelRuleMap = constraintList.stream()\n+                .collect(toMap(Constraint::getConstraintId, constraint -> model.getRules().stream()\n+                        .filter(rule -> Objects.equals(rule.getName(), constraint.getConstraintName()))\n+                        .filter(rule -> Objects.equals(rule.getPackage(), constraint.getConstraintPackage()))\n+                        .findFirst()\n+                        .orElseThrow(() -> new IllegalStateException(\"Programming error: Rule for constraint (\" +\n+                                constraint + \") not found.\"))));\n     }\n \n     @Override\n     public ConstraintSession<Solution_> buildSession(boolean constraintMatchEnabled, Solution_ workingSolution) {\n         ScoreDefinition scoreDefinition = solutionDescriptor.getScoreDefinition();\n         AbstractScoreHolder scoreHolder = (AbstractScoreHolder) scoreDefinition.buildScoreHolder(constraintMatchEnabled);\n         scoreHolder.setJustificationListConverter((justificationList, rule) ->\n-                matchJustificationsToOutput((List<Object>) justificationList, constraints.get(rule).getExpectedJustificationTypes()));\n-        constraints.forEach((rule, constraint) -> scoreHolder.configureConstraintWeight(rule,\n-                constraint.extractConstraintWeight(workingSolution)));\n-        KieSession kieSession = kieBase.newKieSession();\n-        ((RuleEventManager) kieSession).addEventListener(new OptaPlannerRuleEventListener()); // Enables undo in rules\n+                matchJustificationsToOutput((List<Object>) justificationList,\n+                        compiledRuleToConstraintMap.get(rule).getExpectedJustificationTypes()));\n+        // Determine which rules to enable based on the fact that their constraints carry weight.\n+        Score<?> zero = scoreDefinition.getZeroScore();\n+        Set<String> enabledConstraintIdSet = new LinkedHashSet<>(compiledRuleToConstraintMap.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "606cb28e9d74d1f9326350df9e657acd6cf88eec"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMDg3Mzc4", "url": "https://github.com/kiegroup/optaplanner/pull/712#pullrequestreview-371087378", "createdAt": "2020-03-09T11:26:24Z", "commit": {"oid": "f2e006390396d70576ef718c73f75a439845dd0a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMToyNjoyNFrOFzjZpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMToyNjoyNFrOFzjZpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYwMTcwMQ==", "bodyText": "Soft: might be worth extracting a NO_OP_UNDO into AbstractConstraintStream?", "url": "https://github.com/kiegroup/optaplanner/pull/712#discussion_r389601701", "createdAt": "2020-03-09T11:26:24Z", "author": {"login": "ge0ffrey"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/bi/BavetScoringBiConstraintStream.java", "diffHunk": "@@ -113,6 +113,9 @@ private BavetScoringBiConstraintStream(BavetConstraintFactory<Solution_> constra\n             if (intMatchWeigher != null) {\n                 scoreImpacter = (A a, B b, Consumer<Score<?>> matchScoreConsumer) -> {\n                     int matchWeight = intMatchWeigher.applyAsInt(a, b);\n+                    if (matchWeight == 0) { // No need to include and no need to undo later.\n+                        return () -> { /* NOOP */ };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2e006390396d70576ef718c73f75a439845dd0a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMDg5NjQ5", "url": "https://github.com/kiegroup/optaplanner/pull/712#pullrequestreview-371089649", "createdAt": "2020-03-09T11:30:37Z", "commit": {"oid": "f2e006390396d70576ef718c73f75a439845dd0a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTozMDozN1rOFzjguQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTozMDozN1rOFzjguQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYwMzUxMw==", "bodyText": "Same here: if a matchWeigth is zero, it probably shouldn't disable the indictment. For clarity: If the constraintWeight is zero, it should (and the entire constraint execution too, as it does in the rest of this PR).", "url": "https://github.com/kiegroup/optaplanner/pull/712#discussion_r389603513", "createdAt": "2020-03-09T11:30:37Z", "author": {"login": "ge0ffrey"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/drools/common/DroolsCondition.java", "diffHunk": "@@ -175,20 +175,29 @@ protected DroolsCondition(T ruleStructure) {\n \n     protected <S extends Score<S>, H extends AbstractScoreHolder<S>> void impactScore(DroolsConstraint<?> constraint,\n             Drools drools, H scoreHolder, int impact) {\n+        if (impact == 0) { // No need to include and no need to undo later.\n+            return;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2e006390396d70576ef718c73f75a439845dd0a"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMDkwMjgy", "url": "https://github.com/kiegroup/optaplanner/pull/712#pullrequestreview-371090282", "createdAt": "2020-03-09T11:31:52Z", "commit": {"oid": "f2e006390396d70576ef718c73f75a439845dd0a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ca83d05474dab3a0df594185500866966f03d6", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/85ca83d05474dab3a0df594185500866966f03d6", "committedDate": "2020-03-10T09:26:51Z", "message": "Don't do (and undo) zero matches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "072ee93fd57cc838b6785fe4a66955f4300b253e", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/072ee93fd57cc838b6785fe4a66955f4300b253e", "committedDate": "2020-03-10T09:27:50Z", "message": "Disable rules when necessary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83f113bb5c5135907c1c2c27d26b0f653e2f806d", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/83f113bb5c5135907c1c2c27d26b0f653e2f806d", "committedDate": "2020-03-10T09:27:50Z", "message": "Improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aca855e5c430e488f304f3d1aafd9272c04b37e", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/7aca855e5c430e488f304f3d1aafd9272c04b37e", "committedDate": "2020-03-10T09:27:50Z", "message": "Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b07c2d3cf9918961f6ebde68ba9784503bbcfd53", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/b07c2d3cf9918961f6ebde68ba9784503bbcfd53", "committedDate": "2020-03-10T09:27:50Z", "message": "Refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "715aaaaf30935becb8e1030c6e3de118068712b5", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/715aaaaf30935becb8e1030c6e3de118068712b5", "committedDate": "2020-03-10T09:27:50Z", "message": "Revert \"Don't do (and undo) zero matches\"\n\nThis reverts commit 8a7459df"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dac85ad4d82c1260a27a51dcf1592c833b642445", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/dac85ad4d82c1260a27a51dcf1592c833b642445", "committedDate": "2020-03-10T09:27:50Z", "message": "Revert \"Don't do (and undo) zero matches\"\n\nThis reverts commit 8a7459df"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6ffefdac7e084414043603f206a64f02f96415f", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/a6ffefdac7e084414043603f206a64f02f96415f", "committedDate": "2020-03-10T09:25:40Z", "message": "Revert \"Don't do (and undo) zero matches\"\n\nThis reverts commit 8a7459df"}, "afterCommit": {"oid": "dac85ad4d82c1260a27a51dcf1592c833b642445", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/dac85ad4d82c1260a27a51dcf1592c833b642445", "committedDate": "2020-03-10T09:27:50Z", "message": "Revert \"Don't do (and undo) zero matches\"\n\nThis reverts commit 8a7459df"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2887, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}