{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MzI0ODc4", "number": 792, "title": "PLANNER-1961 Only process trailing entities when there's supply", "bodyText": "", "createdAt": "2020-05-28T08:16:56Z", "url": "https://github.com/kiegroup/optaplanner/pull/792", "merged": true, "mergeCommit": {"oid": "e521d5400760daa97dda083c6eebf28d6d0d1687"}, "closed": true, "closedAt": "2020-06-02T13:37:35Z", "author": {"login": "triceo"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclpngEAFqTQxOTg4OTMwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnUvABAH2gAyNDI0MzI0ODc4OmM1NThjMGQzZDFkOGNkOGYzYWM5OTM4YzdhOTMxMWQ1ZmVmMGE4YjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODg5MzA1", "url": "https://github.com/kiegroup/optaplanner/pull/792#pullrequestreview-419889305", "createdAt": "2020-05-28T08:30:32Z", "commit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozMDozMlrOGbq-1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozMDozMlrOGbq-1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2ODk0OQ==", "bodyText": "And this is why you don't put types of variables in variable names. This implementation detail now proliferated into places of this PR, which would otherwise be unaffected.", "url": "https://github.com/kiegroup/optaplanner/pull/792#discussion_r431668949", "createdAt": "2020-05-28T08:30:32Z", "author": {"login": "triceo"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/heuristic/selector/move/generic/SwapMoveSelector.java", "diffHunk": "@@ -90,26 +94,19 @@ public boolean supportsPhaseAndSolverCaching() {\n     public void solvingStarted(DefaultSolverScope solverScope) {\n         super.solvingStarted(solverScope);\n         if (anyChained) {\n-            inverseVariableSupplyList = new ArrayList<>(variableDescriptorList.size());\n             SupplyManager supplyManager = solverScope.getScoreDirector().getSupplyManager();\n-            for (GenuineVariableDescriptor variableDescriptor : variableDescriptorList) {\n-                SingletonInverseVariableSupply inverseVariableSupply;\n-                if (variableDescriptor.isChained()) {\n-                    inverseVariableSupply = supplyManager.demand(\n-                            new SingletonInverseVariableDemand(variableDescriptor));\n-                } else {\n-                    inverseVariableSupply = null;\n-                }\n-                inverseVariableSupplyList.add(inverseVariableSupply);\n-            }\n+            inverseVariableSupplyMap = variableDescriptorList.stream()\n+                    .filter(GenuineVariableDescriptor::isChained)\n+                    .collect(toMap(Functions.identity(), variableDescriptor -> supplyManager\n+                            .demand(new SingletonInverseVariableDemand(variableDescriptor))));\n         }\n     }\n \n     @Override\n     public void solvingEnded(DefaultSolverScope solverScope) {\n         super.solvingEnded(solverScope);\n         if (anyChained) {\n-            inverseVariableSupplyList = null;\n+            inverseVariableSupplyMap = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjMzNjQ5", "url": "https://github.com/kiegroup/optaplanner/pull/792#pullrequestreview-421633649", "createdAt": "2020-06-01T07:04:42Z", "commit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzowNDo0MlrOGdAvQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzowNDo0MlrOGdAvQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA3Mzk4NQ==", "bodyText": "So when I have a plannning entity LessonVisit with a chained planning variable previous and a non-chained planning variable room, this code will execute for the room  too? That room should behave like a normal swap. Does it?\nWhat happens to room if it's trailing entities are null, both left and right? I guess it behaves like a normal swap move indeed?", "url": "https://github.com/kiegroup/optaplanner/pull/792#discussion_r433073985", "createdAt": "2020-06-01T07:04:42Z", "author": {"login": "ge0ffrey"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/heuristic/selector/move/generic/chained/ChainedSwapMove.java", "diffHunk": "@@ -74,8 +77,8 @@ protected void doMoveOnGenuineVariables(ScoreDirector<Solution_> scoreDirector)\n                     scoreDirector.changeVariableFacade(variableDescriptor, leftEntity, oldRightValue);\n                     scoreDirector.changeVariableFacade(variableDescriptor, rightEntity, oldLeftValue);\n                 } else {\n-                    Object oldLeftTrailingEntity = oldLeftTrailingEntityList.get(i);\n-                    Object oldRightTrailingEntity = oldRightTrailingEntityList.get(i);\n+                    Object oldLeftTrailingEntity = oldLeftTrailingEntityMap.get(variableDescriptor);\n+                    Object oldRightTrailingEntity = oldRightTrailingEntityMap.get(variableDescriptor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjM0MDI3", "url": "https://github.com/kiegroup/optaplanner/pull/792#pullrequestreview-421634027", "createdAt": "2020-06-01T07:05:34Z", "commit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzowNTozNFrOGdAwXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzowNTozNFrOGdAwXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA3NDI2OQ==", "bodyText": "This is where you put the null that is then thrown later.", "url": "https://github.com/kiegroup/optaplanner/pull/792#discussion_r433074269", "createdAt": "2020-06-01T07:05:34Z", "author": {"login": "triceo"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/heuristic/selector/move/generic/SwapMoveSelector.java", "diffHunk": "@@ -90,26 +94,19 @@ public boolean supportsPhaseAndSolverCaching() {\n     public void solvingStarted(DefaultSolverScope solverScope) {\n         super.solvingStarted(solverScope);\n         if (anyChained) {\n-            inverseVariableSupplyList = new ArrayList<>(variableDescriptorList.size());\n             SupplyManager supplyManager = solverScope.getScoreDirector().getSupplyManager();\n-            for (GenuineVariableDescriptor variableDescriptor : variableDescriptorList) {\n-                SingletonInverseVariableSupply inverseVariableSupply;\n-                if (variableDescriptor.isChained()) {\n-                    inverseVariableSupply = supplyManager.demand(\n-                            new SingletonInverseVariableDemand(variableDescriptor));\n-                } else {\n-                    inverseVariableSupply = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjM0MzAy", "url": "https://github.com/kiegroup/optaplanner/pull/792#pullrequestreview-421634302", "createdAt": "2020-06-01T07:06:13Z", "commit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzowNjoxM1rOGdAxOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzowNjoxM1rOGdAxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA3NDQ4OQ==", "bodyText": "This is where the null would be thrown.\nI fix that by not iterating over the cases where the null would be thrown. (Non-chained vars.)", "url": "https://github.com/kiegroup/optaplanner/pull/792#discussion_r433074489", "createdAt": "2020-06-01T07:06:13Z", "author": {"login": "triceo"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/heuristic/selector/move/generic/chained/ChainedSwapMove.java", "diffHunk": "@@ -31,26 +32,28 @@\n  */\n public class ChainedSwapMove<Solution_> extends SwapMove<Solution_> {\n \n-    protected final List<Object> oldLeftTrailingEntityList;\n-    protected final List<Object> oldRightTrailingEntityList;\n+    protected final Map<GenuineVariableDescriptor<Solution_>, Object> oldLeftTrailingEntityMap;\n+    protected final Map<GenuineVariableDescriptor<Solution_>, Object> oldRightTrailingEntityMap;\n \n     public ChainedSwapMove(List<GenuineVariableDescriptor<Solution_>> variableDescriptorList,\n-            List<SingletonInverseVariableSupply> inverseVariableSupplyList, Object leftEntity, Object rightEntity) {\n+            Map<GenuineVariableDescriptor<Solution_>, SingletonInverseVariableSupply> inverseVariableSupplyMap,\n+            Object leftEntity, Object rightEntity) {\n         super(variableDescriptorList, leftEntity, rightEntity);\n-        oldLeftTrailingEntityList = new ArrayList<>(inverseVariableSupplyList.size());\n-        oldRightTrailingEntityList = new ArrayList<>(inverseVariableSupplyList.size());\n-        for (SingletonInverseVariableSupply inverseVariableSupply : inverseVariableSupplyList) {\n-            oldLeftTrailingEntityList.add(inverseVariableSupply.getInverseSingleton(leftEntity));\n-            oldRightTrailingEntityList.add(inverseVariableSupply.getInverseSingleton(rightEntity));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjM3ODY1", "url": "https://github.com/kiegroup/optaplanner/pull/792#pullrequestreview-421637865", "createdAt": "2020-06-01T07:14:37Z", "commit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzoxNDozN1rOGdA8DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzoxNDozN1rOGdA8DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA3NzI2MA==", "bodyText": "These map calls are a performance loss. We're replacing an indexed lookup by a hash lookup.\nI'd keep the index lookup (so the trailingEntityList has the same size as variableDescriptorList and their indexes match), but given that \"Object oldLeftTrailingEntity \" can be null, I 'd put a null as an element where we cache that (move constructor)", "url": "https://github.com/kiegroup/optaplanner/pull/792#discussion_r433077260", "createdAt": "2020-06-01T07:14:37Z", "author": {"login": "ge0ffrey"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/heuristic/selector/move/generic/chained/ChainedSwapMove.java", "diffHunk": "@@ -74,8 +77,8 @@ protected void doMoveOnGenuineVariables(ScoreDirector<Solution_> scoreDirector)\n                     scoreDirector.changeVariableFacade(variableDescriptor, leftEntity, oldRightValue);\n                     scoreDirector.changeVariableFacade(variableDescriptor, rightEntity, oldLeftValue);\n                 } else {\n-                    Object oldLeftTrailingEntity = oldLeftTrailingEntityList.get(i);\n-                    Object oldRightTrailingEntity = oldRightTrailingEntityList.get(i);\n+                    Object oldLeftTrailingEntity = oldLeftTrailingEntityMap.get(variableDescriptor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "393961a4cdcd29ee810af182798127b841b27a7f", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/393961a4cdcd29ee810af182798127b841b27a7f", "committedDate": "2020-06-01T14:55:31Z", "message": "PLANNER-1961 Only create inverse singletons for chained vars"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "294762c60ba25c02317b187e2e9b7c3aaa392328", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/294762c60ba25c02317b187e2e9b7c3aaa392328", "committedDate": "2020-06-01T15:25:40Z", "message": "PLANNER-1961 Add test for correct swap moves"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "caf0ec79730961ed68545fb48958b397960ac89f", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/caf0ec79730961ed68545fb48958b397960ac89f", "committedDate": "2020-05-28T08:10:12Z", "message": "PLANNER-1961 Only create inverse supply for chained variables"}, "afterCommit": {"oid": "294762c60ba25c02317b187e2e9b7c3aaa392328", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/294762c60ba25c02317b187e2e9b7c3aaa392328", "committedDate": "2020-06-01T15:25:40Z", "message": "PLANNER-1961 Add test for correct swap moves"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eec39132a94378b750578cc8a2a566a4fb2c72d5", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/eec39132a94378b750578cc8a2a566a4fb2c72d5", "committedDate": "2020-06-01T15:28:48Z", "message": "PLANNER-1961 Final fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjUyNjc0", "url": "https://github.com/kiegroup/optaplanner/pull/792#pullrequestreview-422652674", "createdAt": "2020-06-02T13:03:17Z", "commit": {"oid": "eec39132a94378b750578cc8a2a566a4fb2c72d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzowMzoxN1rOGdwjsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzowMzoxN1rOGdwjsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NzQ1OQ==", "bodyText": "(very soft) I 'd have used TestdataValue as a type for unchainedObject, calling it unchainedValue instead, for consistency with other testdata. But it doesn't matter much.", "url": "https://github.com/kiegroup/optaplanner/pull/792#discussion_r433857459", "createdAt": "2020-06-02T13:03:17Z", "author": {"login": "ge0ffrey"}, "path": "optaplanner-core/src/test/java/org/optaplanner/core/impl/testdata/domain/chained/TestdataChainedEntity.java", "diffHunk": "@@ -39,7 +39,15 @@\n         return entityDescriptor.getGenuineVariableDescriptor(\"chainedObject\");\n     }\n \n+    public static GenuineVariableDescriptor<TestdataChainedSolution> buildVariableDescriptorForUnchainedObject() {\n+        SolutionDescriptor<TestdataChainedSolution> solutionDescriptor = TestdataChainedSolution.buildSolutionDescriptor();\n+        EntityDescriptor<TestdataChainedSolution> entityDescriptor = solutionDescriptor\n+                .findEntityDescriptorOrFail(TestdataChainedEntity.class);\n+        return entityDescriptor.getGenuineVariableDescriptor(\"unchainedObject\");\n+    }\n+\n     private TestdataChainedObject chainedObject;\n+    private TestdataObject unchainedObject;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eec39132a94378b750578cc8a2a566a4fb2c72d5"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjUyNzIy", "url": "https://github.com/kiegroup/optaplanner/pull/792#pullrequestreview-422652722", "createdAt": "2020-06-02T13:03:21Z", "commit": {"oid": "eec39132a94378b750578cc8a2a566a4fb2c72d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c558c0d3d1d8cd8f3ac9938c7a9311d5fef0a8b6", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/c558c0d3d1d8cd8f3ac9938c7a9311d5fef0a8b6", "committedDate": "2020-06-02T13:18:34Z", "message": "Address final review comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3014, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}