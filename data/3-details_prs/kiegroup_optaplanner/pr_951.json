{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NjA3MzAw", "number": 951, "title": "PLANNER-2181 Encapsulate reflection operations in SolutionDescriptor", "bodyText": "Merge with squash.", "createdAt": "2020-09-30T15:46:30Z", "url": "https://github.com/kiegroup/optaplanner/pull/951", "merged": true, "mergeCommit": {"oid": "e5a7d6b5a1e68bdb25a891cd70459486a29ed7c2"}, "closed": true, "closedAt": "2020-10-05T10:56:21Z", "author": {"login": "triceo"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN-wDTgH2gAyNDk1NjA3MzAwOmUzNWJjMTMyZjZkZWI2NGVmM2JhNDBjNjc0ZDYzOWVjNGVjNzQxNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPg19cAH2gAyNDk1NjA3MzAwOjI0YWQ4MTk4NzViYTYwZWM0NTgzNjhlNzRmNjM4NDBjNDZjODhmMmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e35bc132f6deb64ef3ba40c674d639ec4ec7414b", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/e35bc132f6deb64ef3ba40c674d639ec4ec7414b", "committedDate": "2020-09-30T15:44:51Z", "message": "PLANNER-2181 Encapsulate reflection operations in SolutionDescriptor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMjg4Mzcx", "url": "https://github.com/kiegroup/optaplanner/pull/951#pullrequestreview-500288371", "createdAt": "2020-10-01T12:21:52Z", "commit": {"oid": "e35bc132f6deb64ef3ba40c674d639ec4ec7414b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMjoyMTo1MlrOHbHxFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMjoyMTo1MlrOHbHxFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwMDg1NQ==", "bodyText": "I think the problemFactClassSet should be a cached as a field on the SolutionDescriptor, so this code runs once.\nThis code to fill in that new field could run at the end of SolutionDescriptor.processProblemFactPropertyAnnotation() (or at the end of SolutionDescriptor.processFactEntityOrScoreAnnotation() if it relies on entities too).\nA basic rule around reflection is to scan each class only once for the same thing.\nThat rule is violated as this code calls extractCollectionGenericTypeParameter() (which uses reflection) for every from() call.\nAlso, as this code calls that reflection method, thinking Quarkus wise, it's much better if it already runs during SolutinDescriptor creation.", "url": "https://github.com/kiegroup/optaplanner/pull/951#discussion_r498200855", "createdAt": "2020-10-01T12:21:52Z", "author": {"login": "ge0ffrey"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/domain/solution/descriptor/SolutionDescriptor.java", "diffHunk": "@@ -712,6 +714,23 @@ public ScoreDefinition getScoreDefinition() {\n         return memberNames;\n     }\n \n+    public Set<Class<?>> getProblemFactClassSet() {\n+        Stream<Class<?>> factClassStream = getProblemFactMemberAccessorMap()\n+                .values()\n+                .stream()\n+                .map(MemberAccessor::getType);\n+        Stream<Class<?>> factCollectionClassStream = getProblemFactCollectionMemberAccessorMap()\n+                .entrySet()\n+                .stream()\n+                .map(entry -> {\n+                    MemberAccessor accessor = entry.getValue();\n+                    return ConfigUtils.extractCollectionGenericTypeParameter(\"solutionClass\", getSolutionClass(),\n+                            accessor.getType(), accessor.getGenericType(), ProblemFactCollectionProperty.class, entry.getKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e35bc132f6deb64ef3ba40c674d639ec4ec7414b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMjg5OTg0", "url": "https://github.com/kiegroup/optaplanner/pull/951#pullrequestreview-500289984", "createdAt": "2020-10-01T12:24:02Z", "commit": {"oid": "e35bc132f6deb64ef3ba40c674d639ec4ec7414b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMjoyNDowMlrOHbH14A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMjoyNDowMlrOHbH14A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwMjA4MA==", "bodyText": "I think we don't need a field problemFactClassSet on SolutionDescriptor, but a problemFactOrEntityClassSet (== allAcceptedClassSet) field instead? That would avoid this mapping too and the problemFactOrEntityClassSet is only used here.", "url": "https://github.com/kiegroup/optaplanner/pull/951#discussion_r498202080", "createdAt": "2020-10-01T12:24:02Z", "author": {"login": "ge0ffrey"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/InnerConstraintFactory.java", "diffHunk": "@@ -82,22 +81,11 @@\n \n     public <A> void assertValidFromType(Class<A> fromType) {\n         SolutionDescriptor<Solution_> solutionDescriptor = getSolutionDescriptor();\n-        Stream<Class> entityClassStream = solutionDescriptor.getEntityDescriptors().stream()\n+        Stream<Class<?>> entityClassStream = solutionDescriptor.getEntityDescriptors().stream()\n                 .map(EntityDescriptor::getEntityClass);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e35bc132f6deb64ef3ba40c674d639ec4ec7414b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2088a9daa6d68b3e4f677dd9940654231ea833a4", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/2088a9daa6d68b3e4f677dd9940654231ea833a4", "committedDate": "2020-10-01T12:44:57Z", "message": "Address code review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "519aaf9806441aa86c4c1bb18f15c9fce3d48c8c", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/519aaf9806441aa86c4c1bb18f15c9fce3d48c8c", "committedDate": "2020-10-01T12:59:16Z", "message": "This impl will stick"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d18316f662d4c01f52b8b0c9395ed67ea7e8b04", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/6d18316f662d4c01f52b8b0c9395ed67ea7e8b04", "committedDate": "2020-10-01T13:03:24Z", "message": "Minor optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "522fe428058353026bff34f855449a34f59166dd", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/522fe428058353026bff34f855449a34f59166dd", "committedDate": "2020-10-01T13:22:14Z", "message": "Attempt to fix the unfixable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMzQxMjA1", "url": "https://github.com/kiegroup/optaplanner/pull/951#pullrequestreview-500341205", "createdAt": "2020-10-01T13:23:29Z", "commit": {"oid": "522fe428058353026bff34f855449a34f59166dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMzoyMzozMFrOHbKLHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMzoyMzozMFrOHbKLHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0MDI4NA==", "bodyText": "The fail-fast is incorrect here. Raw Collection is not an untyped collection. It's Collection<Object>. This should not fail.", "url": "https://github.com/kiegroup/optaplanner/pull/951#discussion_r498240284", "createdAt": "2020-10-01T13:23:30Z", "author": {"login": "triceo"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/config/util/ConfigUtils.java", "diffHunk": "@@ -347,14 +347,7 @@ public static int resolvePoolSize(String propertyName, String value, String... m\n             Class<?> type, Type genericType,\n             Class<? extends Annotation> annotationClass, String memberName) {\n         if (!(genericType instanceof ParameterizedType)) {\n-            throw new IllegalArgumentException(\"The \" + parentClassConcept + \" (\" + parentClass + \") has a \"\n-                    + (annotationClass == null ? \"auto discovered\" : annotationClass.getSimpleName() + \" annotated\")\n-                    + \" member (\" + memberName\n-                    + \") with a member type (\" + type\n-                    + \") that returns a \" + Collection.class.getSimpleName()\n-                    + \" which has no generic parameters.\\n\"\n-                    + \"Maybe the member (\" + memberName + \") should return a typed \"\n-                    + Collection.class.getSimpleName() + \".\");\n+            return Object.class;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "522fe428058353026bff34f855449a34f59166dd"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMzQyMzY4", "url": "https://github.com/kiegroup/optaplanner/pull/951#pullrequestreview-500342368", "createdAt": "2020-10-01T13:24:39Z", "commit": {"oid": "522fe428058353026bff34f855449a34f59166dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMzoyNDo0MFrOHbKOag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMzoyNDo0MFrOHbKOag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0MTEzMA==", "bodyText": "Another instance of an over-eager fail-fast. Collection<Something<T>> shouldn't fail just because we don't know what T is. It's a Collection<Something> then.", "url": "https://github.com/kiegroup/optaplanner/pull/951#discussion_r498241130", "createdAt": "2020-10-01T13:24:40Z", "author": {"login": "triceo"}, "path": "optaplanner-core/src/main/java/org/optaplanner/core/config/util/ConfigUtils.java", "diffHunk": "@@ -390,6 +383,9 @@ public static int resolvePoolSize(String propertyName, String value, String... m\n                 typeArgument = upperBounds[0];\n             }\n         }\n+        if (typeArgument instanceof ParameterizedType) {\n+            return (Class) ((ParameterizedType) typeArgument).getRawType();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "522fe428058353026bff34f855449a34f59166dd"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1fffbcb72971c0d0c12940a656daf0019b7d420", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/c1fffbcb72971c0d0c12940a656daf0019b7d420", "committedDate": "2020-10-05T09:51:15Z", "message": "Move one fail-fast"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24ad819875ba60ec458368e74f63840c46c88f2b", "author": {"user": {"login": "triceo", "name": "Luk\u00e1\u0161 Petrovick\u00fd"}}, "url": "https://github.com/kiegroup/optaplanner/commit/24ad819875ba60ec458368e74f63840c46c88f2b", "committedDate": "2020-10-05T10:02:00Z", "message": "Fix logic"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3232, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}