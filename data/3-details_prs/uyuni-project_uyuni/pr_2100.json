{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NjI3MTkz", "number": 2100, "title": "Testsuite - traditional clients bootstrapped by script", "bodyText": "What does this PR change?\nThis PR replaces current mechanism of traditional client registration (using rhnreg_ks command) with bootstrap script as it is supported and recommended way to register new traditional client.\nLinks\nSUSE/spacewalk#10661\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\" (Test skipped, there are no changes to test)\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-04-06T12:57:25Z", "url": "https://github.com/uyuni-project/uyuni/pull/2100", "merged": true, "mergeCommit": {"oid": "39f30411200d1196410a60e12dc1f01ad2e64c47"}, "closed": true, "closedAt": "2020-04-07T14:10:37Z", "author": {"login": "lkotek"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVAa4NgFqTM4ODM2NDAyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVS-pygBqjMyMDk3NTYyMDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MzY0MDI2", "url": "https://github.com/uyuni-project/uyuni/pull/2100#pullrequestreview-388364026", "createdAt": "2020-04-06T15:27:46Z", "commit": {"oid": "35e738c9f7162e9f4f49d2fefd542e610731fd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNToyNzo0NlrOGBdSsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNToyNzo0NlrOGBdSsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw==", "bodyText": "Given that we are bootstrapping using the script, so not using the WebUI.\nIt would be awesome if we can stay like that during the whole scenario.\nWhat about check it using Then I should see \"sle_client\" in spacewalk as it was before?\nWe will also rid of the step of log in, which it use to be slow.", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404181683", "createdAt": "2020-04-06T15:27:46Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/init_clients/sle_client.feature", "diffHunk": "@@ -3,12 +3,13 @@\n \n Feature: Register a traditional client\n   In order to register a traditional client to the SUSE Manager server\n-  As the root user\n-  I want to call rhnreg_ks\n+  I want to create, parametrize and run boostrap script from proxy\n \n   Scenario: Register a traditional client\n-    When I register using \"1-SUSE-DEV-x86_64\" key\n-    Then I should see \"sle_client\" in spacewalk\n+    Given I am authorized\n+    When I bootstrap traditional client \"sle_client\" using bootstrap script with activation key \"1-SUSE-DEV-x86_64\" from the proxy\n+    And I follow the left menu \"Systems > Overview\"\n+    And I wait until I see the name of \"sle_client\", refreshing the page", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e738c9f7162e9f4f49d2fefd542e610731fd5c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Mzc5NDI1", "url": "https://github.com/uyuni-project/uyuni/pull/2100#pullrequestreview-388379425", "createdAt": "2020-04-06T15:44:07Z", "commit": {"oid": "35e738c9f7162e9f4f49d2fefd542e610731fd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNTo0NDowN1rOGBeDGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNTo0NDowN1rOGBeDGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDA3NQ==", "bodyText": "If we remove I should see \"sle_client\" in spacewalkeverywhere, then maybe we should also remove it from the step definitions?", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404194075", "createdAt": "2020-04-06T15:44:07Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/trad_baremetal_discovery.feature", "diffHunk": "@@ -23,8 +23,10 @@ Feature: Bare metal discovery\n     And the PXE default profile should be enabled\n \n   Scenario: Register a client for bare metal discovery\n-    When I register using \"1-spacewalk-bootstrap-activation-key\" key\n-    Then I should see \"sle_client\" in spacewalk\n+    Given I am authorized as \"admin\" with password \"admin\"\n+    When I bootstrap traditional client \"sle_client\" using bootstrap script with activation key \"1-spacewalk-bootstrap-activation-key\" from the proxy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e738c9f7162e9f4f49d2fefd542e610731fd5c"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MzgwMjIx", "url": "https://github.com/uyuni-project/uyuni/pull/2100#pullrequestreview-388380221", "createdAt": "2020-04-06T15:44:56Z", "commit": {"oid": "35e738c9f7162e9f4f49d2fefd542e610731fd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNTo0NDo1NlrOGBeFrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNTo0NDo1NlrOGBeFrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDczNQ==", "bodyText": "concatenate all these commands into one string and then run it only once (performance)", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404194735", "createdAt": "2020-04-06T15:44:56Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -643,6 +643,26 @@\n   $server.run(\"salt-key -y --accept=pxeboot.example.org\")\n end\n \n+When(/^I bootstrap traditional client \"([^\"]*)\" using bootstrap script with activation key \"([^\"]*)\" from the proxy$/) do |host, key|\n+  # Preparation of bootstrap script for traditional client\n+  $proxy.run('mgr-bootstrap --traditional')\n+  $proxy.run('sed -i s\\'/^exit 1//\\' /srv/www/htdocs/pub/bootstrap/bootstrap.sh')\n+  $proxy.run(\"sed -i '/^ACTIVATION_KEYS=/c\\\\ACTIVATION_KEYS=#{key}' /srv/www/htdocs/pub/bootstrap/bootstrap.sh\")\n+  $proxy.run('chmod 644 /srv/www/htdocs/pub/RHN-ORG-TRUSTED-SSL-CERT')\n+  $proxy.run(\"sed -i '/^ORG_GPG_KEY=/c\\\\ORG_GPG_KEY=RHN-ORG-TRUSTED-SSL-CERT' /srv/www/htdocs/pub/bootstrap/bootstrap.sh\")\n+  output, code = $proxy.run('cat /srv/www/htdocs/pub/bootstrap/bootstrap.sh')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e738c9f7162e9f4f49d2fefd542e610731fd5c"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDkzODEy", "url": "https://github.com/uyuni-project/uyuni/pull/2100#pullrequestreview-389093812", "createdAt": "2020-04-07T13:04:47Z", "commit": {"oid": "13f1178923334321387ede3e21074c6537a086f0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca8bb75bc1119e3bafdd1d9e21d4aff380de9f22", "author": {"user": null}, "url": "https://github.com/uyuni-project/uyuni/commit/ca8bb75bc1119e3bafdd1d9e21d4aff380de9f22", "committedDate": "2020-04-07T13:04:52Z", "message": "traditional clients bootstrapped by script"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13f1178923334321387ede3e21074c6537a086f0", "author": {"user": null}, "url": "https://github.com/uyuni-project/uyuni/commit/13f1178923334321387ede3e21074c6537a086f0", "committedDate": "2020-04-07T12:44:51Z", "message": "replaced"}, "afterCommit": {"oid": "ca8bb75bc1119e3bafdd1d9e21d4aff380de9f22", "author": {"user": null}, "url": "https://github.com/uyuni-project/uyuni/commit/ca8bb75bc1119e3bafdd1d9e21d4aff380de9f22", "committedDate": "2020-04-07T13:04:52Z", "message": "traditional clients bootstrapped by script"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1589, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}