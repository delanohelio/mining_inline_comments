{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NTAxMDMz", "number": 2226, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjozMzo0OFrOD9eGxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNTowODowNVrOEA7fRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NzgyOTgyOnYy", "diffSide": "RIGHT", "path": "susemanager-utils/susemanager-sls/src/modules/mgr_caasp_manager.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjozMzo0OFrOGW_BTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjozMzo0OFrOGW_BTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1NDM4Mw==", "bodyText": "@ereslibre : for this file only and related to skuba upgrade: can you please review?\nIt should be as per your comment in #2128 (comment)", "url": "https://github.com/uyuni-project/uyuni/pull/2226#discussion_r426754383", "createdAt": "2020-05-18T16:33:48Z", "author": {"login": "mbologna"}, "path": "susemanager-utils/susemanager-sls/src/modules/mgr_caasp_manager.py", "diffHunk": "@@ -175,19 +196,115 @@ def add_node(skuba_cluster_path,\n     return ret\n \n \n+def _upgrade_cluster_plan(skuba_cluster_path,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c87941824c062b5588e9539290d781e09806b5f"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDEwMTE4OnYy", "diffSide": "RIGHT", "path": "susemanager-utils/susemanager-sls/src/modules/mgr_caasp_manager.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNTowODowNVrOGcgygQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMjoyMTo1MFrOGeZTTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1MDUyOQ==", "bodyText": "From what I see there's no safety in that list_nodes will list control plane nodes first, right? I think I have always seen them listed first, but it would be good if we ensure that this is the case, so when we upgrade nodes we enforce the upgrade of the control plane nodes first, then the workers.", "url": "https://github.com/uyuni-project/uyuni/pull/2226#discussion_r432550529", "createdAt": "2020-05-29T15:08:05Z", "author": {"login": "ereslibre"}, "path": "susemanager-utils/susemanager-sls/src/modules/mgr_caasp_manager.py", "diffHunk": "@@ -175,19 +229,114 @@ def add_node(skuba_cluster_path,\n     return ret\n \n \n+def _upgrade_cluster_plan(skuba_cluster_path,\n+                          verbosity=None,\n+                          timeout=DEFAULT_TIMEOUT,\n+                          **kwargs):\n+\n+    cmd_args = \"cluster upgrade plan\"\n+\n+    if verbosity:\n+        cmd_args += \" --verbosity {}\".format(verbosity)\n+\n+    skuba_proc = _call_skuba(skuba_cluster_path, cmd_args, timeout=timeout)\n+    if skuba_proc.process.returncode != 0:\n+        error_msg = \"Unexpected error {} at skuba when upgrading the cluster: {}\".format(\n+                skuba_proc.process.returncode,\n+                salt.utils.stringutils.to_str(skuba_proc.stderr))\n+        log.error(error_msg)\n+\n+    ret = {\n+        'stdout': salt.utils.stringutils.to_str(skuba_proc.stdout),\n+        'stderr': salt.utils.stringutils.to_str(skuba_proc.stderr),\n+        'success': not skuba_proc.process.returncode,\n+        'retcode': skuba_proc.process.returncode,\n+    }\n+    return ret\n+\n+\n def upgrade_cluster(skuba_cluster_path,\n                     verbosity=None,\n                     timeout=DEFAULT_TIMEOUT,\n+                    plan=False,\n                     **kwargs):\n \n-    cmd_args = \"cluster upgrade plan\"\n+    if plan:\n+        return _upgrade_cluster_plan(skuba_cluster_path=skuba_cluster_path,\n+                                     verbosity=verbosity,\n+                                     timeout=timeout,\n+                                     **kwargs)\n+\n+    # Perform the cluster upgrade procedure.\n+    # 1. Upgrade addons\n+    # 2. Upgrade all nodes\n+    # 3. Upgrade addons\n+    ret = {\n+        'success' : True,\n+        'retcode' : 0,\n+        'stage0_upgrade_addons': {},\n+        'stage1_upgrade_nodes': {},\n+        'stage2_upgrade_addons': {},\n+    }\n+\n+    ret['stage0_upgrade_addons'] = upgrade_addons(skuba_cluster_path=skuba_cluster_path,\n+                                                  verbosity=verbosity,\n+                                                  timeout=timeout,\n+                                                  plan=plan,\n+                                                  **kwargs)\n+\n+    if not ret['stage0_upgrade_addons']['success']:\n+        ret['success'] = False\n+        return ret\n+\n+    nodes = list_nodes(skuba_cluster_path=skuba_cluster_path,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18861842c15ac6715ba6a5641756e82152b4877c"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUyNTAwNw==", "bodyText": "Thanks for the feedback @ereslibre.\nI've pushed a minor change to ensure master nodes are always upgraded first \ud83d\udc4d", "url": "https://github.com/uyuni-project/uyuni/pull/2226#discussion_r434525007", "createdAt": "2020-06-03T12:21:50Z", "author": {"login": "meaksh"}, "path": "susemanager-utils/susemanager-sls/src/modules/mgr_caasp_manager.py", "diffHunk": "@@ -175,19 +229,114 @@ def add_node(skuba_cluster_path,\n     return ret\n \n \n+def _upgrade_cluster_plan(skuba_cluster_path,\n+                          verbosity=None,\n+                          timeout=DEFAULT_TIMEOUT,\n+                          **kwargs):\n+\n+    cmd_args = \"cluster upgrade plan\"\n+\n+    if verbosity:\n+        cmd_args += \" --verbosity {}\".format(verbosity)\n+\n+    skuba_proc = _call_skuba(skuba_cluster_path, cmd_args, timeout=timeout)\n+    if skuba_proc.process.returncode != 0:\n+        error_msg = \"Unexpected error {} at skuba when upgrading the cluster: {}\".format(\n+                skuba_proc.process.returncode,\n+                salt.utils.stringutils.to_str(skuba_proc.stderr))\n+        log.error(error_msg)\n+\n+    ret = {\n+        'stdout': salt.utils.stringutils.to_str(skuba_proc.stdout),\n+        'stderr': salt.utils.stringutils.to_str(skuba_proc.stderr),\n+        'success': not skuba_proc.process.returncode,\n+        'retcode': skuba_proc.process.returncode,\n+    }\n+    return ret\n+\n+\n def upgrade_cluster(skuba_cluster_path,\n                     verbosity=None,\n                     timeout=DEFAULT_TIMEOUT,\n+                    plan=False,\n                     **kwargs):\n \n-    cmd_args = \"cluster upgrade plan\"\n+    if plan:\n+        return _upgrade_cluster_plan(skuba_cluster_path=skuba_cluster_path,\n+                                     verbosity=verbosity,\n+                                     timeout=timeout,\n+                                     **kwargs)\n+\n+    # Perform the cluster upgrade procedure.\n+    # 1. Upgrade addons\n+    # 2. Upgrade all nodes\n+    # 3. Upgrade addons\n+    ret = {\n+        'success' : True,\n+        'retcode' : 0,\n+        'stage0_upgrade_addons': {},\n+        'stage1_upgrade_nodes': {},\n+        'stage2_upgrade_addons': {},\n+    }\n+\n+    ret['stage0_upgrade_addons'] = upgrade_addons(skuba_cluster_path=skuba_cluster_path,\n+                                                  verbosity=verbosity,\n+                                                  timeout=timeout,\n+                                                  plan=plan,\n+                                                  **kwargs)\n+\n+    if not ret['stage0_upgrade_addons']['success']:\n+        ret['success'] = False\n+        return ret\n+\n+    nodes = list_nodes(skuba_cluster_path=skuba_cluster_path,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1MDUyOQ=="}, "originalCommit": {"oid": "18861842c15ac6715ba6a5641756e82152b4877c"}, "originalPosition": 145}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4417, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}