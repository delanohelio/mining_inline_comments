{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MjUxMzI2", "number": 2020, "title": "Add child product channel sync status visibility at parent level", "bodyText": "What does this PR change?\nIn the Product page a children product channel sync fails, we need to report to the collapsed parent tree this information.\nNo reason to keep the progress bar percentage indicator as it was not really reporting a sync progress, but just a percentage of how many channels finished on how many channels it is syncing\n@hustodemon this is the commit where I really need a review, because I am not sure about performances and if it is the correct way of doing it. The scope of that commit is just to add the channelId to each channel of products when the channel exists. I am not sure if it is better to do as I did or just iterating on the complete tree at the very end just once and add finally.\nGUI diff\nBefore:\n\nAfter:\n\n\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: @Loquacity do you think we need to document this somehow? Screenshots?\n\n\n DONE\n\n\nTest coverage\n\n\nNo tests: @srbarrios ?\n\n\n DONE\n\n\nLinks\nFixes SUSE/spacewalk#9884\nTracks #\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-03-16T13:54:21Z", "url": "https://github.com/uyuni-project/uyuni/pull/2020", "merged": true, "mergeCommit": {"oid": "ff1f502a1bfab2afaee9d20c36c5e58b2f8b9e57"}, "closed": true, "closedAt": "2020-03-27T22:42:50Z", "author": {"login": "ncounter"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOOklPgBqjMxMzMzMTU0MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcR4jqhABqjMxNzQyOTgyMDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3c6d28d3d4cb2b1efe4829b1331ddd2fae1cee3", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/d3c6d28d3d4cb2b1efe4829b1331ddd2fae1cee3", "committedDate": "2020-03-16T12:55:35Z", "message": "Show separate info for syncing product channels and children"}, "afterCommit": {"oid": "5f332c37e382c596d766ab81b5e05ee4f8378b02", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5f332c37e382c596d766ab81b5e05ee4f8378b02", "committedDate": "2020-03-16T13:59:28Z", "message": "Show separate info for syncing product channels and children"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f332c37e382c596d766ab81b5e05ee4f8378b02", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5f332c37e382c596d766ab81b5e05ee4f8378b02", "committedDate": "2020-03-16T13:59:28Z", "message": "Show separate info for syncing product channels and children"}, "afterCommit": {"oid": "5528093bdb42a4b2a0cd541a3919fff937332248", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5528093bdb42a4b2a0cd541a3919fff937332248", "committedDate": "2020-03-20T22:43:12Z", "message": "Reintroduce button to schedule all channels product sync"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ff58bb581c7f53aff30d5291e742217c52e051a", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9ff58bb581c7f53aff30d5291e742217c52e051a", "committedDate": "2020-03-22T13:37:38Z", "message": "Fix checkstyle"}, "afterCommit": {"oid": "29b23a355d2ee261b4ec6f32458110afbec9a806", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/29b23a355d2ee261b4ec6f32458110afbec9a806", "committedDate": "2020-03-25T20:05:40Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxODYyNzY4", "url": "https://github.com/uyuni-project/uyuni/pull/2020#pullrequestreview-381862768", "createdAt": "2020-03-26T10:10:17Z", "commit": {"oid": "29b23a355d2ee261b4ec6f32458110afbec9a806"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxMDoxN1rOF7_tIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxMDozM1rOF7_twA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NDA0OA==", "bodyText": "I think this is too expensive and there is a better way to get the ID.\nCheck line 300: there is a map \"channelByLabel\" of all Channels. Please use that map to get the Channel and the ID.", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r398454048", "createdAt": "2020-03-26T10:10:17Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/suse/manager/webui/controllers/ProductsController.java", "diffHunk": "@@ -319,6 +318,10 @@ public static String data(Request request, Response response, User user) {\n                                             s.getStatus(),\n                                             s.getChannels().stream().map(c ->\n                                                     new ChannelJson(\n+                                                            s.getStatus().equals(MgrSyncStatus.INSTALLED) &&\n+                                                                    ChannelFactory.lookupByLabel(c.getLabel()) != null ?\n+                                                                    ChannelFactory.lookupByLabel(c.getLabel()).getId() :\n+                                                                    -1L,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b23a355d2ee261b4ec6f32458110afbec9a806"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NDIwOA==", "bodyText": "Same as above", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r398454208", "createdAt": "2020-03-26T10:10:33Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/suse/manager/webui/controllers/ProductsController.java", "diffHunk": "@@ -365,6 +368,10 @@ public static String data(Request request, Response response, User user) {\n                         rootExtensions,\n                         syncProduct.getChannels().stream().map(c ->\n                                 new ChannelJson(\n+                                        syncProduct.getStatus().equals(MgrSyncStatus.INSTALLED) &&\n+                                                ChannelFactory.lookupByLabel(c.getLabel()) != null ?\n+                                                ChannelFactory.lookupByLabel(c.getLabel()).getId() :\n+                                                -1L,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b23a355d2ee261b4ec6f32458110afbec9a806"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMDkzNzQ2", "url": "https://github.com/uyuni-project/uyuni/pull/2020#pullrequestreview-382093746", "createdAt": "2020-03-26T14:57:44Z", "commit": {"oid": "5aefa09e4ed072e24770a1dadf966e63d39f4409"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTY5MzMz", "url": "https://github.com/uyuni-project/uyuni/pull/2020#pullrequestreview-382969333", "createdAt": "2020-03-27T15:35:45Z", "commit": {"oid": "bba4b644cbce9fc015c16201f429463e02d04ebc"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTozNTo0NVrOF82lzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNjowNToyMFrOF832Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1MzI5NA==", "bodyText": "Nit: typo.", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399353294", "createdAt": "2020-03-27T15:35:45Z", "author": {"login": "hustodemon"}, "path": "web/html/src/manager/admin/setup/products/products.js", "diffHunk": "@@ -706,6 +706,78 @@ class CheckListItem extends React.Component {\n     }\n     /*****/\n \n+    /** generate channel sync statys **/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bba4b644cbce9fc015c16201f429463e02d04ebc"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzM4MA==", "bodyText": "To me it seems this triple if-else does the same thing as the one above, but on a different data (childProductChannels vs. currentProductChannels). Could this be extracted to a separate function to reduce code duplication?", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399363380", "createdAt": "2020-03-27T15:50:07Z", "author": {"login": "hustodemon"}, "path": "web/html/src/manager/admin/setup/products/products.js", "diffHunk": "@@ -735,49 +745,101 @@ class CheckListItem extends React.Component {\n     }\n     /*****/\n \n-    /** generate channel sync progress bar **/\n+    /** generate channel sync statys **/\n     let channelSyncContent;\n     if (this.isInstalled()) {\n-      const mandatoryChannelList = currentItem.channels.filter(c => !c.optional);\n+      let currentProductChannels = currentItem.channels.filter(c => c.status != _CHANNEL_STATUS.notSynced);\n \n       // if the product sync has just been scheduled\n-      if (this.props.bypassProps.scheduledItems.includes(currentItem.identifier)) {\n-        channelSyncContent = <span className=\"text-info\">{t('Sync scheduled')}</span>;\n+      if (currentProductChannels.filter(c => c.status == _CHANNEL_STATUS.failed).length > 0) {\n+        channelSyncContent =\n+          <span className=\"text-danger\" title={t('Product channels sync failed')}>\n+            <i className=\"fa fa-exclamation-circle fa-1-5x\"></i>\n+          </span>;\n       }\n-      // if any failed sync channel, show the error only\n-      else if (mandatoryChannelList.filter(c => c.status == _CHANNEL_STATUS.failed).length > 0) {\n-        channelSyncContent = <span className=\"text-danger\">{t('Sync failed')}</span>;\n+      else if (currentProductChannels.filter(c => c.status == _CHANNEL_STATUS.syncing).length > 0) {\n+        channelSyncContent =\n+          <span className=\"text-info\" title={t('Product channels sync in progress')}>\n+            <i className=\"fa fa-spinner fa-spin fa-1-5x\"></i>\n+          </span>;\n       }\n-      else {\n-        const syncedChannels = mandatoryChannelList.filter(c => c.status == _CHANNEL_STATUS.synced).length;\n-        const toBeSyncedChannels = mandatoryChannelList.length;\n-        const channelSyncProgress = Math.round(( syncedChannels / toBeSyncedChannels ) * 100);\n-        channelSyncContent = <ProgressBar progress={channelSyncProgress} title={t('Product sync status')} width='60%'/>;\n+      else if (currentProductChannels.filter(c => c.status == _CHANNEL_STATUS.synced).length > 0) {\n+        channelSyncContent =\n+          <span className=\"text-success\" title={t('Product channels synced')}>\n+            <i className=\"fa fa-check-circle fa-1-5x\"></i>\n+          </span>;\n+      }\n+    }\n+\n+    let childProductChannelSyncContent;\n+    if (this.isInstalled()) {\n+      // add all channels of the subtree\n+      let childProductChannels = [];\n+\n+      this.getChildrenTree(currentItem)\n+        .filter(product => product.status == _PRODUCT_STATUS.installed)\n+        .forEach(prod => {\n+          prod.channels.filter(channel => channel.status != _CHANNEL_STATUS.notSynced)\n+            .forEach(chan => { childProductChannels.push(chan) })\n+        });\n+      if (childProductChannels.filter(c => c.status == _CHANNEL_STATUS.failed).length > 0) {\n+        childProductChannelSyncContent =\n+          <span className=\"text-danger\" title={t('Child products channels sync failed')}>\n+            (<i className=\"fa fa-exclamation-circle\"></i>)\n+          </span>;\n+      }\n+      else if (childProductChannels.filter(c => c.status == _CHANNEL_STATUS.syncing).length > 0) {\n+        childProductChannelSyncContent =\n+          <span className=\"text-info\" title={t('Child products channels in progress')}>\n+            (<i className=\"fa fa-spinner fa-spin\"></i>)\n+          </span>;\n+      }\n+      else if (childProductChannels.filter(c => c.status == _CHANNEL_STATUS.synced).length > 0) {\n+        childProductChannelSyncContent =\n+          <span className=\"text-success\" title={t('Child products channels synced')}>\n+            (<i className=\"fa fa-check-circle\"></i>)\n+          </span>;\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aefa09e4ed072e24770a1dadf966e63d39f4409"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3MzUwOA==", "bodyText": "Nitpick: (this is totally matter of taste, so disregard it, if you don't like it.)\nI found an alternative syntax to be more readable:\nOptional.ofNullable(channelByLabel.get(c.getLabel()))\n    .map(chan -> chan.getId())\n    .orElse(-1L)", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399373508", "createdAt": "2020-03-27T16:04:47Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/suse/manager/webui/controllers/ProductsController.java", "diffHunk": "@@ -319,6 +318,10 @@ public static String data(Request request, Response response, User user) {\n                                             s.getStatus(),\n                                             s.getChannels().stream().map(c ->\n                                                     new ChannelJson(\n+                                                            Opt.fold(Optional.ofNullable(\n+                                                                            channelByLabel.get(c.getLabel())),\n+                                                                    () -> -1L,\n+                                                                    x -> x.getId()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aefa09e4ed072e24770a1dadf966e63d39f4409"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3Mzg3OA==", "bodyText": "Same here, feel free not to agree \ud83d\ude09", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399373878", "createdAt": "2020-03-27T16:05:20Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/suse/manager/webui/controllers/ProductsController.java", "diffHunk": "@@ -365,6 +368,9 @@ public static String data(Request request, Response response, User user) {\n                         rootExtensions,\n                         syncProduct.getChannels().stream().map(c ->\n                                 new ChannelJson(\n+                                        Opt.fold(Optional.ofNullable(channelByLabel.get(c.getLabel())),\n+                                                () -> -1L,\n+                                                x -> x.getId()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aefa09e4ed072e24770a1dadf966e63d39f4409"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90b7e695c20dde9a3707e16de1f0ae6ffaf5d1d3", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/90b7e695c20dde9a3707e16de1f0ae6ffaf5d1d3", "committedDate": "2020-03-27T21:32:39Z", "message": "Print proper channel name in the channel list detail"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6be95e098b95daa6e68ca7ab1bb85b3b3feced46", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6be95e098b95daa6e68ca7ab1bb85b3b3feced46", "committedDate": "2020-03-27T21:32:39Z", "message": "Prevent reactjs warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f0e3a44035d2037761ab94c561f564434445e9f", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6f0e3a44035d2037761ab94c561f564434445e9f", "committedDate": "2020-03-27T21:32:40Z", "message": "Drop channel sync status info in the product page"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39cfffda9652bbbab216dbc50af255b68c9f0ab7", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/39cfffda9652bbbab216dbc50af255b68c9f0ab7", "committedDate": "2020-03-27T21:32:40Z", "message": "Use normal disabled checkbox instead of icon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bdbb5334ec94136de61cdac71205f38d497053a", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9bdbb5334ec94136de61cdac71205f38d497053a", "committedDate": "2020-03-27T21:32:40Z", "message": "Fix products page alternate row color"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eecfaa744e6df4fa16e849c4847f0c29e12c373a", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/eecfaa744e6df4fa16e849c4847f0c29e12c373a", "committedDate": "2020-03-27T21:32:41Z", "message": "Show separate info for syncing product channels and children"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afdc094340dda989021dcaf06fad36fd4aa9d716", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/afdc094340dda989021dcaf06fad36fd4aa9d716", "committedDate": "2020-03-27T21:32:41Z", "message": "Link to the channel page from product if channel exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f018871dcc50f8f3d8319d48597278248c721376", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f018871dcc50f8f3d8319d48597278248c721376", "committedDate": "2020-03-27T21:32:41Z", "message": "Reintroduce button to schedule all channels product sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30b1115d84b69f7c83051f5aa99a095b4a592f4a", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/30b1115d84b69f7c83051f5aa99a095b4a592f4a", "committedDate": "2020-03-27T21:32:41Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9341fa8895fa477f6e06529f04f88c1c7467b517", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9341fa8895fa477f6e06529f04f88c1c7467b517", "committedDate": "2020-03-27T21:32:42Z", "message": "Better perfomance to get channel id if it exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25e3f5079890d18c088541d509f5bc12f2f6109e", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/25e3f5079890d18c088541d509f5bc12f2f6109e", "committedDate": "2020-03-27T22:34:51Z", "message": "Extract and reuse the same code to generate icon sync status"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5aefa09e4ed072e24770a1dadf966e63d39f4409", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5aefa09e4ed072e24770a1dadf966e63d39f4409", "committedDate": "2020-03-26T14:20:35Z", "message": "Better perfomance to get channel id if it exists"}, "afterCommit": {"oid": "25e3f5079890d18c088541d509f5bc12f2f6109e", "author": {"user": {"login": "ncounter", "name": "Dario Leidi"}}, "url": "https://github.com/uyuni-project/uyuni/commit/25e3f5079890d18c088541d509f5bc12f2f6109e", "committedDate": "2020-03-27T22:34:51Z", "message": "Extract and reuse the same code to generate icon sync status"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1498, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}