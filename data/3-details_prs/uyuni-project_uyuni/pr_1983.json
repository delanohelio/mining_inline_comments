{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MjI4MDIx", "number": 1983, "title": "Virt pool definition", "bodyText": "What does this PR change?\nAdd REST API and ReactJS component to fetch the XML definition of a virtual storage pool.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: only internal pieces\n\n\n DONE\n\n\nTest coverage\n\n\nUnit tests were added\n\n\n DONE\n\n\nLinks\nFixes #\nTracks # add downstream PR, if any\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-03-05T11:43:47Z", "url": "https://github.com/uyuni-project/uyuni/pull/1983", "merged": true, "mergeCommit": {"oid": "4b8471e5bf023486bbbeb872cd9c0e351a094ac8"}, "closed": true, "closedAt": "2020-03-09T13:55:48Z", "author": {"login": "cbosdo"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKt5bngBqjMxMDE4ODYyMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLARQjABqjMxMDUzODE5MjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49ab21686e58ed1ac6c29dd081d535c195853473", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/49ab21686e58ed1ac6c29dd081d535c195853473", "committedDate": "2020-03-05T11:41:15Z", "message": "Expose REST API to provide the definition of a virtual storage pool."}, "afterCommit": {"oid": "3ddf597601fe17c8ef0256b001bcb327824470bb", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3ddf597601fe17c8ef0256b001bcb327824470bb", "committedDate": "2020-03-05T16:13:31Z", "message": "Expose REST API to provide the definition of a virtual storage pool."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzA1NTc0", "url": "https://github.com/uyuni-project/uyuni/pull/1983#pullrequestreview-369705574", "createdAt": "2020-03-05T16:10:52Z", "commit": {"oid": "49ab21686e58ed1ac6c29dd081d535c195853473"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjoxMDo1MlrOFyZ7PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjoyMDozMFrOFyaTyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5Nzg4NA==", "bodyText": "Nitpick: This code seems to repeat across your PRs. Maybe you can extract it to utility function after the PRs with similar code are merged.", "url": "https://github.com/uyuni-project/uyuni/pull/1983#discussion_r388397884", "createdAt": "2020-03-05T16:10:52Z", "author": {"login": "mateiw"}, "path": "web/html/src/manager/virtualization/pools/virtualization-pool-definition-api.js", "diffHunk": "@@ -0,0 +1,39 @@\n+// @flow\n+import * as React from 'react';\n+import Network from 'utils/network';\n+import * as Messages from 'components/messages';\n+\n+type Props = {\n+  /** Virtual host server ID */\n+  hostid: string,\n+  /** Name of the pool for which to get the defintion*/\n+  poolName: string,\n+  /** Children function rendering the content depending on the request result */\n+  children: ({definition: Object, messages: React.Node}) => React.Node,\n+};\n+\n+/** Component calling the Uyuni REST API to get the XML definition of a virtual storage pool */\n+export function VirtualizationPoolDefinitionApi(props: Props) {\n+  const [messages, setMessages] = React.useState([]);\n+  const [definition, setDefinition] = React.useState(null);\n+\n+  React.useEffect(() => {\n+    Network.get(`/rhn/manager/api/systems/details/virtualization/pools/${props.hostid}/pool/${props.poolName}`,\n+      'application/json').promise\n+      .then((response) => {\n+        setDefinition(response);\n+      }, (xhr) => {\n+        const errMessages = xhr.status === 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49ab21686e58ed1ac6c29dd081d535c195853473"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwNDE2OQ==", "bodyText": "I think this can throw a NullPointerException if for some reason the parsing fails and pool is null.", "url": "https://github.com/uyuni-project/uyuni/pull/1983#discussion_r388404169", "createdAt": "2020-03-05T16:20:30Z", "author": {"login": "mateiw"}, "path": "java/code/src/com/suse/manager/virtualization/VirtManager.java", "diffHunk": "@@ -80,6 +80,29 @@\n         return saltService.callSync(call, minionId);\n     }\n \n+    /**\n+     * Query virtual storage pool definition\n+     *\n+     * @param minionId the host minion ID\n+     * @param poolName the domain name to look for\n+     * @return the XML definition or an empty Optional\n+     */\n+    public static Optional<PoolDefinition> getPoolDefinition(String minionId, String poolName) {\n+        Map<String, JsonObject> infos = getPools(minionId);\n+\n+        Map<String, Object> args = new LinkedHashMap<>();\n+        args.put(\"name\", poolName);\n+        LocalCall<String> call =\n+                new LocalCall<>(\"virt.pool_get_xml\", Optional.empty(), Optional.of(args), new TypeToken<String>() { });\n+\n+        Optional<String> result = saltService.callSync(call, minionId);\n+        return result.filter(s -> !s.startsWith(\"ERROR\")).map(xml -> {\n+            PoolDefinition pool = PoolDefinition.parse(xml);\n+            pool.setAutostart(infos.get(poolName).get(\"autostart\").getAsInt() == 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ddf597601fe17c8ef0256b001bcb327824470bb"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ddf597601fe17c8ef0256b001bcb327824470bb", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3ddf597601fe17c8ef0256b001bcb327824470bb", "committedDate": "2020-03-05T16:13:31Z", "message": "Expose REST API to provide the definition of a virtual storage pool."}, "afterCommit": {"oid": "a277fe244c04c2f8e8717fedd45c66569a7d6aef", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a277fe244c04c2f8e8717fedd45c66569a7d6aef", "committedDate": "2020-03-05T17:18:59Z", "message": "Expose REST API to provide the definition of a virtual storage pool."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "599bec39a543be219eb5e76f57dfb3a11bbd4cdf", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/599bec39a543be219eb5e76f57dfb3a11bbd4cdf", "committedDate": "2020-03-06T13:37:55Z", "message": "Add virtual pool definition model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c82a03f3f219f6153e7b605dcc876306d86de5d5", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c82a03f3f219f6153e7b605dcc876306d86de5d5", "committedDate": "2020-03-06T13:37:55Z", "message": "VirtManager: expose API to get a pool definition\n\nIn order to edit an existing pool, we need to fetch and parse the\ndefinition from libvirt."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b8452433f0cee9c0bc434b58f6ffc670e186258", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9b8452433f0cee9c0bc434b58f6ffc670e186258", "committedDate": "2020-03-06T13:37:55Z", "message": "Expose REST API to provide the definition of a virtual storage pool."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a277fe244c04c2f8e8717fedd45c66569a7d6aef", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a277fe244c04c2f8e8717fedd45c66569a7d6aef", "committedDate": "2020-03-05T17:18:59Z", "message": "Expose REST API to provide the definition of a virtual storage pool."}, "afterCommit": {"oid": "9b8452433f0cee9c0bc434b58f6ffc670e186258", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9b8452433f0cee9c0bc434b58f6ffc670e186258", "committedDate": "2020-03-06T13:37:55Z", "message": "Expose REST API to provide the definition of a virtual storage pool."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1615, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}