{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NDAwMDI1", "number": 2344, "title": "for the base channel use generated metadata", "bodyText": "What does this PR change?\nSLE 15 Online media has empty metadata. In this case the installer ask for an SCC registration.\nCheck for a kernel option useonlinerepo and switch to use the metadata from the mirrored repo for the ks/dist URL.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nSUSE/spacewalk#11810\n\n\n DONE\n\n\nTest coverage\n\n\nNo tests: autoinstallation can only be tested manual\n\n\n DONE\n\n\nLinks\nFixes #\nTracks # add downstream PR, if any\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-06-20T11:18:27Z", "url": "https://github.com/uyuni-project/uyuni/pull/2344", "merged": true, "mergeCommit": {"oid": "6c7e0b7092da9d1ca871da70ef9cab24846ff7a8"}, "closed": true, "closedAt": "2020-06-26T13:46:59Z", "author": {"login": "mcalmer"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuWxVoABqjM0NzY2NjY0Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvDgAkABqjM0ODY2NzQ0MDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04b9de394c1d87eadecfd2461f6422cf4003b077", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/04b9de394c1d87eadecfd2461f6422cf4003b077", "committedDate": "2020-06-22T14:11:58Z", "message": "Only when kernel option is given"}, "afterCommit": {"oid": "a64be6fe4f5ff8811509884562d47278c47910c0", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a64be6fe4f5ff8811509884562d47278c47910c0", "committedDate": "2020-06-24T09:38:08Z", "message": "update changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47a7390d38581b3acc8ce141b4f2785e0d111808", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/47a7390d38581b3acc8ce141b4f2785e0d111808", "committedDate": "2020-06-24T13:43:30Z", "message": "fixup! deliver media.1/products file when requested"}, "afterCommit": {"oid": "83149c162a47e5c60a9dbdedca1658966b76bdd6", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/83149c162a47e5c60a9dbdedca1658966b76bdd6", "committedDate": "2020-06-24T14:37:14Z", "message": "fixup! deliver media.1/products file when requested"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7b38c68b99235de58fb2f6c80fe18f60feb522e", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c7b38c68b99235de58fb2f6c80fe18f60feb522e", "committedDate": "2020-06-25T08:50:32Z", "message": "check if file exists"}, "afterCommit": {"oid": "cac3c59798a5b75ac39de0101547e7f19da61e5a", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cac3c59798a5b75ac39de0101547e7f19da61e5a", "committedDate": "2020-06-25T12:46:07Z", "message": "download media.1/products when available and store it in DB"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cac3c59798a5b75ac39de0101547e7f19da61e5a", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cac3c59798a5b75ac39de0101547e7f19da61e5a", "committedDate": "2020-06-25T12:46:07Z", "message": "download media.1/products when available and store it in DB"}, "afterCommit": {"oid": "b890ce2cd3571991a1bab4c4b7386c7765cbc296", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b890ce2cd3571991a1bab4c4b7386c7765cbc296", "committedDate": "2020-06-25T13:36:51Z", "message": "update changelogs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTIxMzYz", "url": "https://github.com/uyuni-project/uyuni/pull/2344#pullrequestreview-437521363", "createdAt": "2020-06-25T13:58:29Z", "commit": {"oid": "b890ce2cd3571991a1bab4c4b7386c7765cbc296"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzo1ODoyOVrOGo8A4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzo1ODoyOVrOGo8A4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU3OTQ4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        # no mirror list found continue without\n          \n          \n            \n                        # no 'media.1/products' file found", "url": "https://github.com/uyuni-project/uyuni/pull/2344#discussion_r445579489", "createdAt": "2020-06-25T13:58:29Z", "author": {"login": "meaksh"}, "path": "backend/satellite_tools/repo_plugins/yum_src.py", "diffHunk": "@@ -964,6 +964,30 @@ def get_modules(self):\n             modules = self._retrieve_md_path('modules')\n         return modules\n \n+    def get_mediaproducts(self):\n+        \"\"\"\n+        Return path to media.1/products file if available\n+\n+        :returns: str\n+        \"\"\"\n+        media_products_path = os.path.join(self._get_repodata_path(), 'media.1/products')\n+        try:\n+            (s,b,p,q,f,o) = urlparse(self.url)\n+            if p[-1] != '/':\n+                p = p + '/'\n+            p = p + 'media.1/products'\n+        except (ValueError, IndexError, KeyError) as e:\n+            return None\n+        url = urlunparse((s,b,p,q,f,o))\n+        try:\n+            urlgrabber_opts = {}\n+            self.set_download_parameters(urlgrabber_opts, url, media_products_path)\n+            urlgrabber.urlgrab(url, media_products_path, **urlgrabber_opts)\n+        except Exception as exc:\n+            # no mirror list found continue without", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b890ce2cd3571991a1bab4c4b7386c7765cbc296"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTIxNzUy", "url": "https://github.com/uyuni-project/uyuni/pull/2344#pullrequestreview-437521752", "createdAt": "2020-06-25T13:58:52Z", "commit": {"oid": "b890ce2cd3571991a1bab4c4b7386c7765cbc296"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzo1ODo1MlrOGo8CFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzo1ODo1MlrOGo8CFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU3OTc5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                def import_mediaproducts(self, plug):\n          \n          \n            \n                    mediaproducts = plug.get_mediaproducts()\n          \n          \n            \n                    if mediaproducts:\n          \n          \n            \n                        self.copy_metadata_file(plug, mediaproducts, 'mediaproducts', relative_mediaproducts_dir)\n          \n          \n            \n            \n          \n          \n            \n                def import_mediaproducts(self, plug):\n          \n          \n            \n                    mediaproducts = plug.get_mediaproducts()\n          \n          \n            \n                    if mediaproducts:\n          \n          \n            \n                        self.copy_metadata_file(plug, mediaproducts, 'mediaproducts', relative_mediaproducts_dir)", "url": "https://github.com/uyuni-project/uyuni/pull/2344#discussion_r445579797", "createdAt": "2020-06-25T13:58:52Z", "author": {"login": "meaksh"}, "path": "backend/satellite_tools/reposync.py", "diffHunk": "@@ -813,6 +816,11 @@ def import_modules(self, plug):\n         modulesfile = plug.get_modules()\n         if modulesfile:\n             self.copy_metadata_file(plug, modulesfile, 'modules', relative_modules_dir)\n+    def import_mediaproducts(self, plug):\n+        mediaproducts = plug.get_mediaproducts()\n+        if mediaproducts:\n+            self.copy_metadata_file(plug, mediaproducts, 'mediaproducts', relative_mediaproducts_dir)\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b890ce2cd3571991a1bab4c4b7386c7765cbc296"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTIzMzA0", "url": "https://github.com/uyuni-project/uyuni/pull/2344#pullrequestreview-437523304", "createdAt": "2020-06-25T14:00:23Z", "commit": {"oid": "b890ce2cd3571991a1bab4c4b7386c7765cbc296"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTI0OTYx", "url": "https://github.com/uyuni-project/uyuni/pull/2344#pullrequestreview-437524961", "createdAt": "2020-06-25T14:02:06Z", "commit": {"oid": "b890ce2cd3571991a1bab4c4b7386c7765cbc296"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTQ5Nzcz", "url": "https://github.com/uyuni-project/uyuni/pull/2344#pullrequestreview-437549773", "createdAt": "2020-06-25T14:27:20Z", "commit": {"oid": "3f83aed1a801e085972e5d7a5e84a6ed39297487"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTI3OTcx", "url": "https://github.com/uyuni-project/uyuni/pull/2344#pullrequestreview-437527971", "createdAt": "2020-06-25T14:05:08Z", "commit": {"oid": "fbc049378ba0f9e78d3d1c18f8cfea6d64167e95"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDowNTowOVrOGo8TXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDoxMjozMFrOGo8nKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU4NDIyMw==", "bodyText": "Does this correspond to the mount point for repomd cache? This is configurable (repomd_cache_mount_point global option). Maybe you can also pull the value out of config instead of hardcoding.", "url": "https://github.com/uyuni-project/uyuni/pull/2344#discussion_r445584223", "createdAt": "2020-06-25T14:05:09Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/frontend/action/common/DownloadFile.java", "diffHunk": "@@ -619,7 +619,18 @@ private StreamInfo getStreamInfoKickstart(ActionMapping mapping, ActionForm form\n             // my $dp = File::Spec->catfile($kickstart_mount, $tree->base_path, $path);\n \n             if (child == null) {\n-                diskPath = kickstartMount + \"/\" + tree.getBasePath() + path;\n+                if (path.contains(\"repodata/\") && tree.getKernelOptions().contains(\"useonlinerepo\")) {\n+                    String[] split = StringUtils.split(path, '/');\n+                    if (split[0].equals(\"repodata\")) {\n+                        split[0] = tree.getChannel().getLabel();\n+                    }\n+                    diskPath = \"/var/cache/\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbc049378ba0f9e78d3d1c18f8cfea6d64167e95"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU4OTI4OQ==", "bodyText": "These are quite explicit conditions, I'd suggest adding some logging here, which could simplify debugging (at least the final diskPath, if it's not logged by something else). That could simplify debugging, in case of problems.", "url": "https://github.com/uyuni-project/uyuni/pull/2344#discussion_r445589289", "createdAt": "2020-06-25T14:12:30Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/frontend/action/common/DownloadFile.java", "diffHunk": "@@ -619,7 +619,18 @@ private StreamInfo getStreamInfoKickstart(ActionMapping mapping, ActionForm form\n             // my $dp = File::Spec->catfile($kickstart_mount, $tree->base_path, $path);\n \n             if (child == null) {\n-                diskPath = kickstartMount + \"/\" + tree.getBasePath() + path;\n+                if (path.contains(\"repodata/\") && tree.getKernelOptions().contains(\"useonlinerepo\")) {\n+                    String[] split = StringUtils.split(path, '/');\n+                    if (split[0].equals(\"repodata\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbc049378ba0f9e78d3d1c18f8cfea6d64167e95"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NzI2OTgx", "url": "https://github.com/uyuni-project/uyuni/pull/2344#pullrequestreview-437726981", "createdAt": "2020-06-25T17:53:07Z", "commit": {"oid": "b21aedbd2894cc8839948cec2c1b4d5470d625c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b21aedbd2894cc8839948cec2c1b4d5470d625c2", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b21aedbd2894cc8839948cec2c1b4d5470d625c2", "committedDate": "2020-06-25T14:51:36Z", "message": "use cache dir from config"}, "afterCommit": {"oid": "76020bce73f5fe12c9747b3f8d72e55391a11b00", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/76020bce73f5fe12c9747b3f8d72e55391a11b00", "committedDate": "2020-06-26T13:24:51Z", "message": "use cache dir from config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d975fb25e9a5b85e5cd3a06d8ca3d729e8180dc", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0d975fb25e9a5b85e5cd3a06d8ca3d729e8180dc", "committedDate": "2020-06-26T13:43:58Z", "message": "for the base channel use generated metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c583fa62640f64b01840a6b748bfa94d1f0bd0e", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4c583fa62640f64b01840a6b748bfa94d1f0bd0e", "committedDate": "2020-06-26T13:43:58Z", "message": "new comps type mediaproducts for media.1/products files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "421d5a002248720ab97fd2813ba4feca1a4a3ac0", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/421d5a002248720ab97fd2813ba4feca1a4a3ac0", "committedDate": "2020-06-26T13:43:59Z", "message": "deliver media.1/products file when requested"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77a37a8d8d46784259f60fcaddd36dd1527e663d", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/77a37a8d8d46784259f60fcaddd36dd1527e663d", "committedDate": "2020-06-26T13:43:59Z", "message": "download media.1/products when available and store it in DB"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7861601b29192ac730e708664aa74ea21ebb910e", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7861601b29192ac730e708664aa74ea21ebb910e", "committedDate": "2020-06-26T13:44:54Z", "message": "update changelogs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "411e77e977f43e7c6c319632927d361a8d4bf242", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/411e77e977f43e7c6c319632927d361a8d4bf242", "committedDate": "2020-06-26T13:44:56Z", "message": "Update Comment\n\nCo-authored-by: Pablo Su\u00e1rez Hern\u00e1ndez <psuarezhernandez@suse.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef4e7477b54459cd8ff17c9750cd679598d27d8f", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ef4e7477b54459cd8ff17c9750cd679598d27d8f", "committedDate": "2020-06-26T13:44:56Z", "message": "Add extra line\n\nCo-authored-by: Pablo Su\u00e1rez Hern\u00e1ndez <psuarezhernandez@suse.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92fd27cf3dd4960c175839c748201c970efc8e9f", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/92fd27cf3dd4960c175839c748201c970efc8e9f", "committedDate": "2020-06-26T13:44:56Z", "message": "fix unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dd0673d9d7d34274cf7e058630e80e8389e3293", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2dd0673d9d7d34274cf7e058630e80e8389e3293", "committedDate": "2020-06-26T13:44:56Z", "message": "use cache dir from config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76020bce73f5fe12c9747b3f8d72e55391a11b00", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/76020bce73f5fe12c9747b3f8d72e55391a11b00", "committedDate": "2020-06-26T13:24:51Z", "message": "use cache dir from config"}, "afterCommit": {"oid": "2dd0673d9d7d34274cf7e058630e80e8389e3293", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2dd0673d9d7d34274cf7e058630e80e8389e3293", "committedDate": "2020-06-26T13:44:56Z", "message": "use cache dir from config"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1158, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}