{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NTAxMDMz", "number": 2226, "title": "Implement CaaSP cluster upgrade procedure in cluster provider module", "bodyText": "What does this PR change?\nThis PR improves custom Salt mgr_caasp_provider module in order to implement the CaaSP cluster upgrade procedure according to: #2128 (comment)\n\nUpgrade cluster addons\nUpgrade each node\nUpgrade cluster addons\n\nExample:\next-suma-head-caasp-srv:~ # salt ext-suma-head-caasp-min-sles15sp1-v1.tf.local state.apply clusters.upgradecluster pillar='{\"cluster_type\": \"caasp\", \"ssh_auth_sock\": \"/tmp/ssh-akwpjkOHbb/agent.935\", \"params\": {\"skuba_cluster_path\":\"/root/my-cluster-salt\"}}'\next-suma-head-caasp-min-sles15sp1-v1.tf.local:\n----------\n          ID: sync_modules\n    Function: saltutil.sync_modules\n      Result: True\n     Comment: No updates to sync\n     Started: 14:44:54.291674\n    Duration: 180.794 ms\n     Changes:   \n----------\n          ID: mgr_ssh_agent_socket_upgradecluster\n    Function: environ.setenv\n        Name: SSH_AUTH_SOCK\n      Result: True\n     Comment: Environ values were set\n     Started: 14:44:54.473117\n    Duration: 9.146 ms\n     Changes:   \n              ----------\n              SSH_AUTH_SOCK:\n                  /tmp/ssh-akwpjkOHbb/agent.935\n----------\n          ID: mgr_cluster_upgrade_cluster\n    Function: module.run\n        Name: mgrclusters.upgrade_cluster\n      Result: True\n     Comment: Module function mgrclusters.upgrade_cluster executed\n     Started: 14:44:54.483575\n    Duration: 1272.032 ms\n     Changes:   \n              ----------\n              ret:\n                  ----------\n                  retcode:\n                      0\n                  stage0_upgrade_addons:\n                      ----------\n                      retcode:\n                          0\n                      stderr:\n                      stdout:\n                          Current Kubernetes cluster version: 1.17.4\n                          Latest Kubernetes version: 1.17.4\n                          \n                          [apply] Congratulations! Addons for 1.17.4 are already at the latest version available\n                      success:\n                          True\n                  stage1_upgrade_nodes:\n                      ----------\n                      master-one:\n                          ----------\n                          retcode:\n                              0\n                          stderr:\n                          stdout:\n                              Current Kubernetes cluster version: 1.17.4\n                              Latest Kubernetes version: 1.17.4\n                              Current Node version: 1.17.4\n                              \n                              Node master-one is up to date\n                          success:\n                              True\n                      worker-one:\n                          ----------\n                          retcode:\n                              0\n                          stderr:\n                          stdout:\n                              Current Kubernetes cluster version: 1.17.4\n                              Latest Kubernetes version: 1.17.4\n                              Current Node version: 1.17.4\n                              \n                              Node worker-one is up to date\n                          success:\n                              True\n                  stage2_upgrade_addons:\n                      ----------\n                      retcode:\n                          0\n                      stderr:\n                      stdout:\n                          Current Kubernetes cluster version: 1.17.4\n                          Latest Kubernetes version: 1.17.4\n                          \n                          [apply] Congratulations! Addons for 1.17.4 are already at the latest version available\n                      success:\n                          True\n                  success:\n                      True\n\nSummary for ext-suma-head-caasp-min-sles15sp1-v1.tf.local\n------------\nSucceeded: 3 (changed=2)\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:   1.462 s\nThis PR also cherry-picks two requiered commits from: #2070\n\ne003511\nde73030\n\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: backend code\n\n\n DONE\n\n\nTest coverage\n\n\nNo tests: new feature - no tests yet\n\n\n DONE\n\n\nLinks\nTracks SUSE/spacewalk#11435\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-05-18T13:26:55Z", "url": "https://github.com/uyuni-project/uyuni/pull/2226", "merged": true, "mergeCommit": {"oid": "53a03bdee925266aa4d0a23124c6c000ea42800e"}, "closed": true, "closedAt": "2020-06-03T12:27:56Z", "author": {"login": "meaksh"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciif4RAFqTQxMzc1NzE5NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnolcnAFqTQyMzQ5OTM1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNzU3MTk0", "url": "https://github.com/uyuni-project/uyuni/pull/2226#pullrequestreview-413757194", "createdAt": "2020-05-18T16:31:06Z", "commit": {"oid": "3c87941824c062b5588e9539290d781e09806b5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNzU5MjEw", "url": "https://github.com/uyuni-project/uyuni/pull/2226#pullrequestreview-413759210", "createdAt": "2020-05-18T16:33:48Z", "commit": {"oid": "3c87941824c062b5588e9539290d781e09806b5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjozMzo0OFrOGW_BTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjozMzo0OFrOGW_BTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1NDM4Mw==", "bodyText": "@ereslibre : for this file only and related to skuba upgrade: can you please review?\nIt should be as per your comment in #2128 (comment)", "url": "https://github.com/uyuni-project/uyuni/pull/2226#discussion_r426754383", "createdAt": "2020-05-18T16:33:48Z", "author": {"login": "mbologna"}, "path": "susemanager-utils/susemanager-sls/src/modules/mgr_caasp_manager.py", "diffHunk": "@@ -175,19 +196,115 @@ def add_node(skuba_cluster_path,\n     return ret\n \n \n+def _upgrade_cluster_plan(skuba_cluster_path,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c87941824c062b5588e9539290d781e09806b5f"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f80150caeac6b33ef8baafb953b162275f920e85", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f80150caeac6b33ef8baafb953b162275f920e85", "committedDate": "2020-05-20T08:41:27Z", "message": "Do not crash if kubernetes python libs are not found"}, "afterCommit": {"oid": "19f7502ca5227f5bce761079a6d08e67730df9ea", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/19f7502ca5227f5bce761079a6d08e67730df9ea", "committedDate": "2020-05-20T09:35:13Z", "message": "Do not crash if kubernetes python libs are not found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43d536242a59ab15c7ce49916c85f12999e943bb", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/43d536242a59ab15c7ce49916c85f12999e943bb", "committedDate": "2020-05-27T11:46:27Z", "message": "Feat: make Salt clusters.listnodes return the machine-id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b601ae20dc8fa1f31e4d5e970eeb5413b478042b", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b601ae20dc8fa1f31e4d5e970eeb5413b478042b", "committedDate": "2020-05-27T11:46:30Z", "message": "Fix: match parameters with the example"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d357eaf78823de6545b6e065a222d2f0cd691ffc", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/d357eaf78823de6545b6e065a222d2f0cd691ffc", "committedDate": "2020-05-27T11:46:30Z", "message": "Collect internal IPs from kubeapi and expose them on list_nodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9cb130e41a87eaa61413b6d5a998a040dc4839a", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f9cb130e41a87eaa61413b6d5a998a040dc4839a", "committedDate": "2020-05-27T11:46:30Z", "message": "Refactor code and add _join_return_dicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8e2ee876dd9e21b60a15bdaa27446c59d5d558b", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c8e2ee876dd9e21b60a15bdaa27446c59d5d558b", "committedDate": "2020-05-27T11:46:31Z", "message": "Implement CaaSP cluster upgrade procedure for upgrade_cluster method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b84260fc061a0b67260ad5ecda9e3a80b7e62928", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b84260fc061a0b67260ad5ecda9e3a80b7e62928", "committedDate": "2020-05-27T11:46:52Z", "message": "Update changelog for spacewalk-sls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "538141025fc5d67a6a7f68138fc711ed930e86b0", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/538141025fc5d67a6a7f68138fc711ed930e86b0", "committedDate": "2020-05-27T11:46:52Z", "message": "Fix indentation and upgrade procedure comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d9e0de9c964b5f8cbef5489d4f0c2e559f149f4", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3d9e0de9c964b5f8cbef5489d4f0c2e559f149f4", "committedDate": "2020-05-27T11:46:53Z", "message": "Add missing header to ClusterProviderParameters.java file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e183e073e306c0d5d22709aaece88c75e3c65c52", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/e183e073e306c0d5d22709aaece88c75e3c65c52", "committedDate": "2020-05-27T11:46:53Z", "message": "Do not crash if kubernetes python libs are not found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18861842c15ac6715ba6a5641756e82152b4877c", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/18861842c15ac6715ba6a5641756e82152b4877c", "committedDate": "2020-05-27T11:48:57Z", "message": "Use kubectl instead of python kubernetes library"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19f7502ca5227f5bce761079a6d08e67730df9ea", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/19f7502ca5227f5bce761079a6d08e67730df9ea", "committedDate": "2020-05-20T09:35:13Z", "message": "Do not crash if kubernetes python libs are not found"}, "afterCommit": {"oid": "18861842c15ac6715ba6a5641756e82152b4877c", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/18861842c15ac6715ba6a5641756e82152b4877c", "committedDate": "2020-05-27T11:48:57Z", "message": "Use kubectl instead of python kubernetes library"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMDQyMzAy", "url": "https://github.com/uyuni-project/uyuni/pull/2226#pullrequestreview-421042302", "createdAt": "2020-05-29T15:08:05Z", "commit": {"oid": "18861842c15ac6715ba6a5641756e82152b4877c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNTowODowNVrOGcgygQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNTowODowNVrOGcgygQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1MDUyOQ==", "bodyText": "From what I see there's no safety in that list_nodes will list control plane nodes first, right? I think I have always seen them listed first, but it would be good if we ensure that this is the case, so when we upgrade nodes we enforce the upgrade of the control plane nodes first, then the workers.", "url": "https://github.com/uyuni-project/uyuni/pull/2226#discussion_r432550529", "createdAt": "2020-05-29T15:08:05Z", "author": {"login": "ereslibre"}, "path": "susemanager-utils/susemanager-sls/src/modules/mgr_caasp_manager.py", "diffHunk": "@@ -175,19 +229,114 @@ def add_node(skuba_cluster_path,\n     return ret\n \n \n+def _upgrade_cluster_plan(skuba_cluster_path,\n+                          verbosity=None,\n+                          timeout=DEFAULT_TIMEOUT,\n+                          **kwargs):\n+\n+    cmd_args = \"cluster upgrade plan\"\n+\n+    if verbosity:\n+        cmd_args += \" --verbosity {}\".format(verbosity)\n+\n+    skuba_proc = _call_skuba(skuba_cluster_path, cmd_args, timeout=timeout)\n+    if skuba_proc.process.returncode != 0:\n+        error_msg = \"Unexpected error {} at skuba when upgrading the cluster: {}\".format(\n+                skuba_proc.process.returncode,\n+                salt.utils.stringutils.to_str(skuba_proc.stderr))\n+        log.error(error_msg)\n+\n+    ret = {\n+        'stdout': salt.utils.stringutils.to_str(skuba_proc.stdout),\n+        'stderr': salt.utils.stringutils.to_str(skuba_proc.stderr),\n+        'success': not skuba_proc.process.returncode,\n+        'retcode': skuba_proc.process.returncode,\n+    }\n+    return ret\n+\n+\n def upgrade_cluster(skuba_cluster_path,\n                     verbosity=None,\n                     timeout=DEFAULT_TIMEOUT,\n+                    plan=False,\n                     **kwargs):\n \n-    cmd_args = \"cluster upgrade plan\"\n+    if plan:\n+        return _upgrade_cluster_plan(skuba_cluster_path=skuba_cluster_path,\n+                                     verbosity=verbosity,\n+                                     timeout=timeout,\n+                                     **kwargs)\n+\n+    # Perform the cluster upgrade procedure.\n+    # 1. Upgrade addons\n+    # 2. Upgrade all nodes\n+    # 3. Upgrade addons\n+    ret = {\n+        'success' : True,\n+        'retcode' : 0,\n+        'stage0_upgrade_addons': {},\n+        'stage1_upgrade_nodes': {},\n+        'stage2_upgrade_addons': {},\n+    }\n+\n+    ret['stage0_upgrade_addons'] = upgrade_addons(skuba_cluster_path=skuba_cluster_path,\n+                                                  verbosity=verbosity,\n+                                                  timeout=timeout,\n+                                                  plan=plan,\n+                                                  **kwargs)\n+\n+    if not ret['stage0_upgrade_addons']['success']:\n+        ret['success'] = False\n+        return ret\n+\n+    nodes = list_nodes(skuba_cluster_path=skuba_cluster_path,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18861842c15ac6715ba6a5641756e82152b4877c"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3439d75c9c8363ac034219736a5aed63fc7e706e", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3439d75c9c8363ac034219736a5aed63fc7e706e", "committedDate": "2020-06-03T12:18:05Z", "message": "Ensure master nodes are upgraded first"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNDk5MzU0", "url": "https://github.com/uyuni-project/uyuni/pull/2226#pullrequestreview-423499354", "createdAt": "2020-06-03T12:26:14Z", "commit": {"oid": "3439d75c9c8363ac034219736a5aed63fc7e706e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1474, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}