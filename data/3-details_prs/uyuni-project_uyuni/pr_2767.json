{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNDA2OTgw", "number": 2767, "title": "Feat: Implement a Debian package comparator", "bodyText": "What does this PR change?\nIntroduces a new package comparator for Debian packages.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: this is targeting the internal version comparator. Transparent for the final user\n\n\n DONE\n\n\nTest coverage\n\n\nUnit tests were added\n\n\n DONE\n\n\nLinks\nTracks:\nSUSE/spacewalk#8187\nSUSE/spacewalk#12772\nSUSE/spacewalk#12773\nSUSE/spacewalk#12771\n\n DONE\n\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-10-28T09:33:50Z", "url": "https://github.com/uyuni-project/uyuni/pull/2767", "merged": true, "mergeCommit": {"oid": "cb9e25e29a676a92233e0b4a0103f9508f691723"}, "closed": true, "closedAt": "2020-12-16T14:36:15Z", "author": {"login": "mbologna"}, "timelineItems": {"totalCount": 62, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW6W_5gBqjM5MzAyODM5NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmvdcDgFqTU1MzcxNDg3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb00239447d9428f54713d2b8702f7718de331c6", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bb00239447d9428f54713d2b8702f7718de331c6", "committedDate": "2020-10-26T16:04:52Z", "message": "add type to evr"}, "afterCommit": {"oid": "e8a33da12199c23ce8ca98e89ffc440561e9da5a", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/e8a33da12199c23ce8ca98e89ffc440561e9da5a", "committedDate": "2020-10-28T09:42:39Z", "message": "add type to evr"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e83bb489ba9eb7f97673fa51f17e10154f98e0d", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/8e83bb489ba9eb7f97673fa51f17e10154f98e0d", "committedDate": "2020-10-28T11:43:02Z", "message": "Feat: call Debian versioncmp in dispatcher"}, "afterCommit": {"oid": "cd2fbb282f1a28ebbbd222de21e5301c48d7ee73", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cd2fbb282f1a28ebbbd222de21e5301c48d7ee73", "committedDate": "2020-10-28T14:29:01Z", "message": "fix deps file"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84f59b0df4218341cea36bc41a96a6a06a894d2b", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/84f59b0df4218341cea36bc41a96a6a06a894d2b", "committedDate": "2020-10-28T15:57:32Z", "message": "fix type attribute access"}, "afterCommit": {"oid": "4e7f1552ff66d8f347b846ed4d27579700a251fe", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4e7f1552ff66d8f347b846ed4d27579700a251fe", "committedDate": "2020-10-28T16:00:31Z", "message": "fix type attribute access"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8dbe13c54395cb2c884e94d5905256063ed664d", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f8dbe13c54395cb2c884e94d5905256063ed664d", "committedDate": "2020-10-29T11:29:25Z", "message": "fix python package type detection"}, "afterCommit": {"oid": "3334dad21f982db8134e80a1ee1f1b0030253f5c", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3334dad21f982db8134e80a1ee1f1b0030253f5c", "committedDate": "2020-10-29T15:18:02Z", "message": "adjust rhnpackageevr indices"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e5ef3acdaa74f670edd1f2d6d11bdc02587b8ae", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5e5ef3acdaa74f670edd1f2d6d11bdc02587b8ae", "committedDate": "2020-11-03T16:59:21Z", "message": "fix idempotency"}, "afterCommit": {"oid": "9ad2693b9d16298f5e1ac6508e68b7c6e22a1501", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9ad2693b9d16298f5e1ac6508e68b7c6e22a1501", "committedDate": "2020-11-04T10:27:03Z", "message": "fix idempotency"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91d0be48bcde4de528009cd00538e4414337b9dc", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/91d0be48bcde4de528009cd00538e4414337b9dc", "committedDate": "2020-11-05T13:10:34Z", "message": "remove references to rpm.vercmp in queries"}, "afterCommit": {"oid": "43c93a0afcfa8b00e482dc776c8112995801f518", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/43c93a0afcfa8b00e482dc776c8112995801f518", "committedDate": "2020-11-05T13:50:14Z", "message": "remove references to rpm.vercmp in queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43c93a0afcfa8b00e482dc776c8112995801f518", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/43c93a0afcfa8b00e482dc776c8112995801f518", "committedDate": "2020-11-05T13:50:14Z", "message": "remove references to rpm.vercmp in queries"}, "afterCommit": {"oid": "a54740b5e97e12c8a538d7c8dccc23a0270da430", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a54740b5e97e12c8a538d7c8dccc23a0270da430", "committedDate": "2020-11-05T14:26:57Z", "message": "remove references to rpm.vercmp in queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8319da64d3058beadf31dd4a452e6775ccfbba67", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/8319da64d3058beadf31dd4a452e6775ccfbba67", "committedDate": "2020-11-06T16:12:31Z", "message": "fix java unit test"}, "afterCommit": {"oid": "5a7a3464468fd847866e1ea173814c3e3f3443e1", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5a7a3464468fd847866e1ea173814c3e3f3443e1", "committedDate": "2020-11-07T15:33:27Z", "message": "fix java unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3c34126544de930a636039eeba3888b70dac9f4", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c3c34126544de930a636039eeba3888b70dac9f4", "committedDate": "2020-11-09T12:23:41Z", "message": "change deb/rpm comparison"}, "afterCommit": {"oid": "2a77564e67b86c92a1c5a1e4c774fa223f9e4838", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2a77564e67b86c92a1c5a1e4c774fa223f9e4838", "committedDate": "2020-11-09T12:58:01Z", "message": "change deb/rpm comparison"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e306b28d19a8b14fdd411ac6545c945adfdac98", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7e306b28d19a8b14fdd411ac6545c945adfdac98", "committedDate": "2020-11-09T15:00:33Z", "message": "remove todo"}, "afterCommit": {"oid": "5621a1f5a687bb5cca360af877fc06f0fc9ea263", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5621a1f5a687bb5cca360af877fc06f0fc9ea263", "committedDate": "2020-11-09T17:50:53Z", "message": "change deb/rpm comparison"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d61f546149de3bfcc2fb2605483cf2b13f807f5b", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/d61f546149de3bfcc2fb2605483cf2b13f807f5b", "committedDate": "2020-11-10T14:12:43Z", "message": "make version type an enum"}, "afterCommit": {"oid": "f8c2ab9ad53608356164c661968291ad7ec340cb", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f8c2ab9ad53608356164c661968291ad7ec340cb", "committedDate": "2020-11-10T14:47:29Z", "message": "make version type an enum"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8c2ab9ad53608356164c661968291ad7ec340cb", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f8c2ab9ad53608356164c661968291ad7ec340cb", "committedDate": "2020-11-10T14:47:29Z", "message": "make version type an enum"}, "afterCommit": {"oid": "bd276e425802bcc6d34bcc2a42f4a766b0bfa991", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bd276e425802bcc6d34bcc2a42f4a766b0bfa991", "committedDate": "2020-11-10T09:58:51Z", "message": "renmae lookup_evr2 back to lookup_evr"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd276e425802bcc6d34bcc2a42f4a766b0bfa991", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bd276e425802bcc6d34bcc2a42f4a766b0bfa991", "committedDate": "2020-11-10T09:58:51Z", "message": "renmae lookup_evr2 back to lookup_evr"}, "afterCommit": {"oid": "ff95dabd38bbc53a17f747b901d293bcd4c185ab", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ff95dabd38bbc53a17f747b901d293bcd4c185ab", "committedDate": "2020-11-11T16:49:51Z", "message": "renmae lookup_evr2 back to lookup_evr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNzk3NjE2", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-530797616", "createdAt": "2020-11-15T13:14:23Z", "commit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzoxNDoyM1rOHzfmdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzoxNDoyM1rOHzfmdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1NzE3Mg==", "bodyText": "This is not anymore the test for PackageUtils. Should we move these tests to PackageEvrTest?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523757172", "createdAt": "2020-11-15T13:14:23Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/suse/manager/utils/test/PackageUtilsTest.java", "diffHunk": "@@ -19,23 +19,21 @@\n import com.redhat.rhn.domain.rhnpackage.PackageFactory;\n import com.redhat.rhn.domain.rhnpackage.test.PackageTest;\n import com.redhat.rhn.testing.BaseTestCaseWithUser;\n-import com.suse.manager.utils.PackageUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNzk4MjUw", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-530798250", "createdAt": "2020-11-15T13:22:34Z", "commit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzoyMjozNVrOHzfqMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzoyMjozNVrOHzfqMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1ODEzMA==", "bodyText": "Why do we still store epoch, version and release as single values? Could we just change the getters to return packageEvr.getXXX() ?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523758130", "createdAt": "2020-11-15T13:22:35Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/suse/manager/webui/utils/gson/PackageStateJson.java", "diffHunk": "@@ -89,6 +92,7 @@ public PackageStateJson(String nameIn, PackageEvr evrIn, String archIn) {\n         this.arch = archIn;\n         this.packageStateId = Optional.empty();\n         this.versionConstraintId = Optional.empty();\n+        this.packageEvr = evrIn;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNzk4NDMy", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-530798432", "createdAt": "2020-11-15T13:24:57Z", "commit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzoyNDo1OFrOHzfrMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzoyNDo1OFrOHzfrMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1ODM4NQ==", "bodyText": "Is it sufficient to use packageEvr directly? It might not contain the DB ID when it was just initialized with new.\nDo we need the ID?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523758385", "createdAt": "2020-11-15T13:24:58Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/suse/manager/webui/utils/gson/PackageStateJson.java", "diffHunk": "@@ -164,8 +168,7 @@ public String getArch() {\n                     VersionConstraints vc = versionConstraint.get();\n                     if (!Arrays.asList(VersionConstraints.LATEST, VersionConstraints.ANY)\n                             .contains(vc)) {\n-                        packageState.setEvr(PackageEvrFactory.lookupOrCreatePackageEvr(\n-                                getEpoch(), getVersion(), getRelease()));\n+                        packageState.setEvr(packageEvr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNzk5NjA5", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-530799609", "createdAt": "2020-11-15T13:39:00Z", "commit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzozOTowMVrOHzfx_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzozOTowMVrOHzfx_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc2MDEyNw==", "bodyText": "When a_in is null, this will create a EVR without type.\nThis function is used in backend with an explicit arch set to None.\nhttps://github.com/uyuni-project/uyuni/blob/debvercmp-uyuni/backend/server/rhnServer/server_kickstart.py#L172-L207", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523760127", "createdAt": "2020-11-15T13:39:01Z", "author": {"login": "mcalmer"}, "path": "schema/spacewalk/postgres/procs/lookup_transaction_package.sql", "diffHunk": "@@ -40,13 +41,16 @@ begin\n     end if;\n \n     n_id := lookup_package_name(n_in);\n-    e_id := lookup_evr(e_in, v_in, r_in);\n     p_arch_id := null;\n \n     if a_in is not null then\n         p_arch_id := lookup_package_arch(a_in);\n+        SELECT t.label into type from rhnpackagearch pa join rhnarchtype t\n+         on t.id = pa.arch_type_id where pa.id = p_arch_id;\n     end if;\n \n+    e_id := lookup_evr(e_in, v_in, r_in, type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODAwOTA3", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-530800907", "createdAt": "2020-11-15T13:54:25Z", "commit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzo1NDoyNVrOHzf5kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxMzo1NDoyNVrOHzf5kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc2MjA2Nw==", "bodyText": "I think this will create a mess when we run it multiple times.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            update rhnpackageevr set evr.type = 'rpm';\n          \n          \n            \n            update rhnpackageevr set evr.type = 'rpm' where evr.type is NULL;", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523762067", "createdAt": "2020-11-15T13:54:25Z", "author": {"login": "mcalmer"}, "path": "schema/spacewalk/upgrade/susemanager-schema-4.2.2-to-susemanager-schema-4.2.3/1000-debvercmp.sql", "diffHunk": "@@ -0,0 +1,506 @@\n+DO $$\n+BEGIN\n+    IF NOT EXISTS (\n+        SELECT 1\n+        FROM pg_type t\n+        JOIN pg_class c ON c.oid = t.typrelid\n+        JOIN pg_attribute a ON a.attrelid = c.oid\n+        WHERE t.typname = 'evr_t'\n+        AND a.attname = 'type'\n+        )\n+    THEN\n+        alter type evr_t add attribute type varchar(10);\n+    END IF;\n+END $$;\n+\n+drop index rhn_pe_v_r_e_uq;\n+create unique index rhn_pe_v_r_e_uq\n+    on rhnpackageevr (version, release, epoch, ((evr).type))\n+ where epoch is not null;\n+\n+drop index rhn_pe_v_r_uq;\n+create unique index rhn_pe_v_r_uq\n+    on rhnpackageevr (version, release, ((evr).type))\n+ where epoch is null;\n+\n+create or replace function evr_t(e varchar, v varchar, r varchar, t varchar)\n+returns evr_t as $$\n+select row($1,$2,$3,$4)::evr_t\n+$$ language sql;\n+\n+\n+-- update evr_t comparison function to take type into account.\n+create or replace function evr_t_compare( a evr_t, b evr_t )\n+returns int as $$\n+begin\n+  if a.type = b.type then\n+      if a.type = 'rpm' then\n+        return rpm.vercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+      elsif a.type = 'deb' then\n+        return deb.debvercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+      else\n+        raise EXCEPTION 'unknown evr type (using rpm) -> %', a.type;\n+      end if;\n+  else\n+     raise NOTICE 'comparing incompatible evr types. Using %', a.type;\n+     if a.type = 'deb' then\n+       return -1;\n+     else\n+       return 1;\n+     end if;\n+  end if;\n+end;\n+$$ language plpgsql immutable strict;\n+\n+\n+create or replace function evr_t_ne( a evr_t, b evr_t )\n+returns boolean as $$\n+begin\n+  return evr_t_compare( a, b ) != 0;\n+end;\n+$$ language plpgsql immutable strict;\n+\n+drop operator if exists <> (evr_t, evr_t);\n+create operator <> (\n+  leftarg = evr_t,\n+  rightarg = evr_t,\n+  procedure = evr_t_ne,\n+  commutator = <>,\n+  negator = =,\n+  restrict = eqsel,\n+  join = eqjoinsel\n+);\n+\n+\n+-- update insert_evr\n+create or replace function\n+insert_evr(e_in in varchar, v_in in varchar, r_in in varchar, t_in in varchar)\n+returns numeric\n+as\n+$$\n+declare\n+    evr_id  numeric;\n+begin\n+    evr_id := nextval('rhn_pkg_evr_seq');\n+\n+    insert into rhnPackageEVR(id, epoch, version, release, evr)\n+        values (evr_id, e_in, v_in, r_in, evr_t(e_in, v_in, r_in, t_in))\n+        on conflict do nothing;\n+\n+    select id\n+        into strict evr_id\n+        from rhnPackageEVR\n+        where ((epoch is null and e_in is null) or (epoch = e_in)) and\n+           version = v_in and release = r_in and (evr).type = t_in;\n+\n+    return evr_id;\n+end;\n+$$ language plpgsql;\n+\n+\n+-- update lookup_evr\n+create or replace function\n+lookup_evr(e_in in varchar, v_in in varchar, r_in in varchar, t_in in varchar)\n+returns numeric\n+as\n+$$\n+declare\n+    evr_id  numeric;\n+begin\n+    select id\n+      into evr_id\n+      from rhnPackageEVR\n+     where ((epoch is null and e_in is null) or (epoch = e_in)) and\n+           version = v_in and\n+           release = r_in and\n+           (evr).type = t_in;\n+\n+    if not found then\n+        -- HACK: insert is isolated in own function in order to be able to declare this function immutable\n+        -- Postgres optimizes immutable functions calls but those are compatible with the contract of lookup_\\*\n+        -- see https://www.postgresql.org/docs/9.6/xfunc-volatility.html\n+        return insert_evr(e_in, v_in, r_in, t_in);\n+    end if;\n+\n+    return evr_id;\n+end;\n+$$ language plpgsql immutable;\n+\n+\n+create or replace function\n+lookup_transaction_package(\n+    o_in in varchar,\n+    n_in in varchar,\n+    e_in in varchar,\n+    v_in in varchar,\n+    r_in in varchar,\n+    a_in in varchar)\n+returns numeric\n+as\n+$$\n+declare\n+    o_id        numeric;\n+    n_id        numeric;\n+    e_id        numeric;\n+    p_arch_id   numeric;\n+    tp_id       numeric;\n+    type        varchar;\n+begin\n+    select id\n+      into o_id\n+      from rhnTransactionOperation\n+     where label = o_in;\n+\n+    if not found then\n+        perform rhn_exception.raise_exception('invalid_transaction_operation');\n+    end if;\n+\n+    n_id := lookup_package_name(n_in);\n+    p_arch_id := null;\n+\n+    if a_in is not null then\n+        p_arch_id := lookup_package_arch(a_in);\n+        SELECT t.label into type from rhnpackagearch pa join rhnarchtype t\n+         on t.id = pa.arch_type_id where pa.id = p_arch_id;\n+    end if;\n+\n+    e_id := lookup_evr(e_in, v_in, r_in, type);\n+\n+    select id\n+      into tp_id\n+      from rhnTransactionPackage\n+     where operation = o_id and\n+           name_id = n_id and\n+           evr_id = e_id and\n+           (package_arch_id = p_arch_id or (p_arch_id is null and package_arch_id is null));\n+\n+    if not found then\n+        -- HACK: insert is isolated in own function in order to be able to declare this function immutable\n+        -- Postgres optimizes immutable functions calls but those are compatible with the contract of lookup_\\*\n+        -- see https://www.postgresql.org/docs/9.6/xfunc-volatility.html\n+        return insert_transaction_package(o_id, n_id, e_id, p_arch_id);\n+    end if;\n+    return tp_id;\n+end;\n+$$ language plpgsql immutable;\n+\n+\n+ALTER TABLE rhnpackageevr DISABLE TRIGGER USER;\n+\n+-- set all existing rhnpackageevr to rpm\n+update rhnpackageevr set evr.type = 'rpm';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "originalPosition": 191}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODAxNDQ1", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-530801445", "createdAt": "2020-11-15T14:00:36Z", "commit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxNDowMDozNlrOHzf8aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxNDowMDozNlrOHzf8aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc2Mjc5Mg==", "bodyText": "Wouldn't it be better to use '{0}', '{1}' .... ?\nI think then you need to specify the variables in format only once.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523762792", "createdAt": "2020-11-15T14:00:36Z", "author": {"login": "mcalmer"}, "path": "schema/util/debian-versioncmp-database-testgenerator.py", "diffHunk": "@@ -0,0 +1,74 @@\n+#!/usr/bin/python3\n+\n+OUTPUT_SQL_SCRIPT_FILENAME = 'debian_version_database_comparator_tests.sql'\n+\n+preamble = \"\"\"\n+-- launch me with spacewalk-sql -i < {}\n+DO\n+$$\n+declare\n+\tresult NUMERIC := 0;\n+begin\n+\n+\"\"\".format(OUTPUT_SQL_SCRIPT_FILENAME)\n+\n+conclusion = \"\"\"\n+end;\n+$$\n+\"\"\"\n+\n+# source: https://git.dpkg.org/cgit/dpkg/dpkg.git/tree/scripts/t/Dpkg_Version.t\n+tests = \"\"\"1.0-1 2.0-2 -1\n+2.2~rc-4 2.2-1 -1\n+2.2-1 2.2~rc-4 1\n+1.0000-1 1.0-1 0\n+0foo 0foo 0\n+0foo-0 0foo 0\n+0foo 0foo-0 0\n+0foo 0fo 1\n+0foo-0 0foo+ -1\n+0foo~1 0foo -1\n+0foo~foo+Bar 0foo~foo+bar -1\n+0foo~~ 0foo~ -1\n+1~ 1 -1\n+12345+that-really-is-some-ver-0 12345+that-really-is-some-ver-10 -1\n+0foo-0 0foo-01 -1\n+0foo.bar 0foobar 1\n+0foo.bar 0foo1bar 1\n+0foo.bar 0foo0bar 1\n+0foo1bar-1 0foobar-1 -1\n+0foo2.0 0foo2 1\n+0foo2.0.0 0foo2.10.0 -1\n+0foo2.0 0foo2.0.0 -1\n+0foo2.0 0foo2.10 -1\n+0foo2.1 0foo2.10 -1\n+1.09 1.9 0\n+1.0.8+nmu1 1.0.8 1\n+3.11 3.10+nmu1 1\n+0.9j-20080306-4 0.9i-20070324-2 1\n+1.2.0~b7-1 1.2.0~b6-1 1\n+1.011-1 1.06-2 1\n+0.0.9+dfsg1-1 0.0.8+dfsg1-3 1\n+4.6.99+svn6582-1 4.6.99+svn6496-1 1\n+53 52 1\n+0.9.9~pre122-1 0.9.9~pre111-1 1\n+1.0.1+gpl-1 1.0.1-2 1\n+1a 1000a -1\"\"\"\n+\n+with open(OUTPUT_SQL_SCRIPT_FILENAME, 'w') as f:\n+    f.write(preamble)\n+\n+    for test in tests.split('\\n'):\n+        operand1, operand2, expected_result = test.split(' ')\n+        statement = \"\"\"--\n+    select * into result from deb.debstrcmp('{}', '{}');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0b2f881efc342d1eea8e5b1862fabfca06411a2"}, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96251f4fa858206f8c71f16e336df261066272fb", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/96251f4fa858206f8c71f16e336df261066272fb", "committedDate": "2020-11-17T11:38:20Z", "message": "reorder order migration scripts"}, "afterCommit": {"oid": "03c5f67a930c8525a20874c1ecf7dfd20a4391ff", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/03c5f67a930c8525a20874c1ecf7dfd20a4391ff", "committedDate": "2020-11-17T11:38:59Z", "message": "reorder migration scripts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03c5f67a930c8525a20874c1ecf7dfd20a4391ff", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/03c5f67a930c8525a20874c1ecf7dfd20a4391ff", "committedDate": "2020-11-17T11:38:59Z", "message": "reorder migration scripts"}, "afterCommit": {"oid": "3d985d475c087b5666c987f1de8a3d48ec6e60bb", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3d985d475c087b5666c987f1de8a3d48ec6e60bb", "committedDate": "2020-11-17T16:16:14Z", "message": "reorder migration scripts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d985d475c087b5666c987f1de8a3d48ec6e60bb", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3d985d475c087b5666c987f1de8a3d48ec6e60bb", "committedDate": "2020-11-17T16:16:14Z", "message": "reorder migration scripts"}, "afterCommit": {"oid": "829ef079f90def2181a4b7ed684c6714c7ee7f95", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/829ef079f90def2181a4b7ed684c6714c7ee7f95", "committedDate": "2020-11-17T16:27:46Z", "message": "reorder migration scripts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9be758feb4a7929ec1944c5484c82e70deff3a71", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9be758feb4a7929ec1944c5484c82e70deff3a71", "committedDate": "2020-11-19T09:30:31Z", "message": "fixup! remove evr field in PackageStateJson"}, "afterCommit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/933085fab8e348b5583cfef1d2ba155a0a0d7632", "committedDate": "2020-11-20T17:13:02Z", "message": "reorder migration scripts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MjU0NTkw", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-537254590", "createdAt": "2020-11-24T08:51:06Z", "commit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODo1OTozNlrOH4yasw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTo1OToxNVrOH5rqbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwODMzOQ==", "bodyText": "Likely a C&P comment.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r529308339", "createdAt": "2020-11-24T08:59:36Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/common/util/DebVersionComparator.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.common.util;\n+\n+import java.util.Comparator;\n+\n+/**\n+ * DebVersionComparatorTest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMxNzMzMw==", "bodyText": "Nit (here and below): unsupported/unknown would be more fitting, IMHO. When we implement a new type, but forget to change this method, we will \"reach the unreachable\" in the log \ud83d\ude09", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r529317333", "createdAt": "2020-11-24T09:07:04Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/domain/rhnpackage/PackageEvr.java", "diffHunk": "@@ -221,4 +293,100 @@ public String toUniversalEvrString() {\n \n         return builder.toString();\n     }\n+\n+    /**\n+     * Parses a Debian package version string to create a {@link PackageEvr} object.\n+     *\n+     * Debian package versioning policy format: [epoch:]upstream_version[-debian_revision]\n+     * Additional ':' and '-' characters are allowed in 'upstream_version'\n+     * https://www.debian.org/doc/debian-policy/ch-controlfields.html#version\n+     *\n+     * @param version the package version string\n+     * @return the package EVR\n+     */\n+    public static PackageEvr parseDebian(String version) {\n+\n+        // repo-sync replaces empty releases with 'X'. We copy the same behavior.\n+        String release = \"X\";\n+        String epoch = null;\n+\n+        int epochIndex = version.indexOf(':');\n+        if (epochIndex > 0) {\n+            // Strip away optional 'epoch'\n+            epoch = version.substring(0, epochIndex);\n+            version = version.substring(epochIndex + 1);\n+        }\n+\n+        int releaseIndex = version.lastIndexOf('-');\n+        if (releaseIndex > 0) {\n+            // Strip away optional 'release'\n+            release = version.substring(releaseIndex + 1);\n+            version = version.substring(0, releaseIndex);\n+        }\n+\n+        return new PackageEvr(epoch, version, release, \"deb\");\n+    }\n+\n+    /**\n+     * Parses a RPM package version string to create a {@link PackageEvr} object.\n+     *\n+     * RPM package version policy format: [epoch:]version[-release]\n+     *\n+     * @param version the package version string\n+     * @return the package EVR\n+     */\n+    public static PackageEvr parseRpm(String version) {\n+        String release = \"\";\n+        String epoch = null;\n+\n+        int epochIndex = version.indexOf(':');\n+        if (epochIndex > 0) {\n+            // Strip away optional 'epoch'\n+            epoch = version.substring(0, epochIndex);\n+            version = version.substring(epochIndex + 1);\n+        }\n+\n+        int releaseIndex = version.lastIndexOf('-');\n+        if (releaseIndex > 0) {\n+            // Strip away optional 'release'\n+            release = version.substring(releaseIndex + 1);\n+            version = version.substring(0, releaseIndex);\n+        }\n+\n+        return new PackageEvr(epoch, version, release, \"rpm\");\n+    }\n+\n+    /**\n+     * @return package type\n+     */\n+    public PackageType getPackageType() {\n+        if (type.equals(PackageType.DEB.getDbString())) {\n+            return PackageType.DEB;\n+        }\n+        else if (type.equals(PackageType.RPM.getDbString())) {\n+            return PackageType.RPM;\n+        }\n+        else {\n+            throw new RuntimeException(\"unreachable\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632"}, "originalPosition": 252}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMyMDQ4NA==", "bodyText": "Is there a reason for modifying existing tests instead of just writing new? Don't we support comparing evr in format 0-0-0 anymore?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r529320484", "createdAt": "2020-11-24T09:09:37Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/domain/rhnpackage/test/PackageEvrComparableTest.java", "diffHunk": "@@ -24,42 +24,51 @@\n \n /**\n  * Test the compare() method in PackageEvr\n- * @version $Rev$\n  */\n public class PackageEvrComparableTest extends RhnBaseTestCase {\n \n     public void testEquality() {\n-        compare(0, \"0-0-0\", \"0-0-0\");\n-        compare(0, \"null-0-0\", \"0-0-0\");\n-        compare(0, \"null-0-0\", \"null-0-0\");\n+        compare(0, \"0:0-0\", \"0:0-0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5Nzg0Nw==", "bodyText": "Nice approach! IIUC, the type column is:\n\nread only\ngenerated on every insert\nre-generated on every evr update,\n\nwhich should make the data in the table consistent.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530197847", "createdAt": "2020-11-25T08:47:40Z", "author": {"login": "hustodemon"}, "path": "schema/spacewalk/common/tables/rhnPackageEVR.sql", "diffHunk": "@@ -21,7 +21,8 @@ CREATE TABLE rhnPackageEVR\n     epoch    VARCHAR(16),\n     version  VARCHAR(512) NOT NULL,\n     release  VARCHAR(512) NOT NULL,\n-    evr      EVR_T NOT NULL\n+    evr      EVR_T NOT NULL,\n+    type varchar(10) generated always as ((evr).type) stored", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0MzM4NA==", "bodyText": "Please either fix this right away or create a github issue.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530243384", "createdAt": "2020-11-25T09:55:10Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/suse/manager/utils/SaltUtils.java", "diffHunk": "@@ -1593,7 +1594,10 @@ public static String packageToKey(String name, Pkg.Info info) {\n                 new PackageEvr(\n                         info.getEpoch().orElse(null),\n                         info.getVersion().get(),\n-                        info.getRelease().orElse(\"X\")\n+                        info.getRelease().orElse(\"X\"),\n+                        //TODO: this is not correct but does not effect toUniversalEvrString.\n+                        // we should still do this differently", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0Mzk5OQ==", "bodyText": "Same as above.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530243999", "createdAt": "2020-11-25T09:56:02Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/suse/manager/webui/controllers/StatesAPI.java", "diffHunk": "@@ -585,7 +588,8 @@ private Date getScheduleDate(ServerApplyHighstateJson json) {\n             new PackageStateJson(\n                     state.getName().getName(),\n                     Optional.ofNullable(state.getEvr())\n-                            .orElse(new PackageEvr(\"\", \"\", \"\")),\n+                            //TODO: this should probably be rather null instead of a dummy value\n+                            .orElse(new PackageEvr(\"\", \"\", \"\", PackageType.RPM)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0NjI1Mw==", "bodyText": "Please do it now or create a new issue. Piling up TODOs in the code is not good.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530246253", "createdAt": "2020-11-25T09:59:15Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/domain/server/Server.java", "diffHunk": "@@ -2192,4 +2193,9 @@ public String getChannelHost() {\n         return this.getFirstServerPath().map(p -> p.getHostname())\n                 .orElseGet(() -> ConfigDefaults.get().getCobblerHost());\n     }\n+\n+    public PackageType getPackageType() {\n+        //TODO: consider moving this to getOs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0ODgwNzI1", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-544880725", "createdAt": "2020-12-04T11:33:36Z", "commit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "state": "COMMENTED", "comments": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMTozMzozN1rOH_M-Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNTo1NDowOFrOH_W-PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNDg1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                               AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release, (select at.label from rhnArchType at join rhnPackageArch pa ON pa.arch_type_id = at.id where pa.id = p.package_arch_id))\n          \n          \n            \n                               AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release, (SELECT at.label FROM rhnArchType at JOIN rhnPackageArch pa ON pa.arch_type_id = at.id WHERE pa.id = p.package_arch_id))\n          \n      \n    \n    \n  \n\nNitpick: keep casing coherent with rest of query", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536034851", "createdAt": "2020-12-04T11:33:37Z", "author": {"login": "moio"}, "path": "backend/satellite_tools/reposync.py", "diffHunk": "@@ -2105,7 +2105,7 @@ def import_susedata(self, repo):\n                   JOIN rhnChecksumView c ON p.checksum_id = c.id\n                   JOIN rhnChannelPackage cp ON p.id = cp.package_id\n                  WHERE pn.name = :name\n-                   AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release)\n+                   AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release, (select at.label from rhnArchType at join rhnPackageArch pa ON pa.arch_type_id = at.id where pa.id = p.package_arch_id))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNTg1MQ==", "bodyText": "Question: can repo.get_susedata() return any package on non-RPM repos? When does that happen?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536035851", "createdAt": "2020-12-04T11:35:22Z", "author": {"login": "moio"}, "path": "backend/satellite_tools/reposync.py", "diffHunk": "@@ -2105,7 +2105,7 @@ def import_susedata(self, repo):\n                   JOIN rhnChecksumView c ON p.checksum_id = c.id\n                   JOIN rhnChannelPackage cp ON p.id = cp.package_id\n                  WHERE pn.name = :name\n-                   AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzOTY2Nw==", "bodyText": "I wonder whether running a subquery for each chunk (with a result for each package) is the right approach here.\nBy the time we hit this _diff_packages_process, satsync.py should know if we are talking about an rpm or a deb repo here - woudn't it be better if we just passed it as a parameter along with :epoch, :version and :release at this point?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536039667", "createdAt": "2020-12-04T11:42:37Z", "author": {"login": "moio"}, "path": "backend/satellite_tools/satsync.py", "diffHunk": "@@ -920,7 +920,7 @@ def processShortPackages(self):\n                TO_CHAR(p.last_modified, 'YYYYMMDDHH24MISS') last_modified\n           from rhnPackage p, rhnChecksumView c\n          where p.name_id = lookup_package_name(:name)\n-           and p.evr_id = lookup_evr(:epoch, :version, :release)\n+           and p.evr_id = lookup_evr(:epoch, :version, :release, (select at.label from rhnArchType at join rhnPackageArch pa ON pa.arch_type_id = at.id where pa.id = p.package_arch_id))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0MzA5Nw==", "bodyText": "I wonder whether running a subquery for each package is the right approach here.\nInput to this query comes from rhnLib.parseRPMFilename, which actually is a very bad function name as it can parse both RPM and DEB file names.\nI think it would be better to have that function return the package type as well, and to pipe it into the query along with :epoch, :version and :release.\nWe should also probably take the occasion and rename it to parsePackageFilename or similar.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536043097", "createdAt": "2020-12-04T11:49:00Z", "author": {"login": "moio"}, "path": "backend/satellite_exporter/handlers/non_auth_dumper.py", "diffHunk": "@@ -537,7 +537,7 @@ def _send_package_stream(self, package, channel, checksum):\n                and cp.channel_id = c.id\n                and cp.package_id = p.id\n                and p.name_id = LOOKUP_PACKAGE_NAME(:name)\n-               and p.evr_id = LOOKUP_EVR(:epoch, :version, :release)\n+               and p.evr_id = LOOKUP_EVR(:epoch, :version, :release, (select at.label from rhnArchType at where at.id = pa.arch_type_id))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjExOTA2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    SELECT t.label into type from rhnpackagearch pa join rhnarchtype t\n          \n          \n            \n                    select t.label into type from rhnpackagearch pa join rhnarchtype t\n          \n      \n    \n    \n  \n\nNitpick: stay coherent with surroundings", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536119060", "createdAt": "2020-12-04T14:00:01Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/procs/lookup_transaction_package.sql", "diffHunk": "@@ -40,13 +41,19 @@ begin\n     end if;\n \n     n_id := lookup_package_name(n_in);\n-    e_id := lookup_evr(e_in, v_in, r_in);\n     p_arch_id := null;\n \n     if a_in is not null then\n         p_arch_id := lookup_package_arch(a_in);\n+        SELECT t.label into type from rhnpackagearch pa join rhnarchtype t", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyMzc1OA==", "bodyText": "Noob question: is there any particular reason to prefer an ad-hoc method name to toString here?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536123758", "createdAt": "2020-12-04T14:07:11Z", "author": {"login": "moio"}, "path": "java/code/src/com/redhat/rhn/domain/rhnpackage/PackageType.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.domain.rhnpackage;\n+\n+public enum PackageType {\n+    RPM(\"rpm\"),\n+    DEB(\"deb\");\n+\n+    private final String dbString;\n+\n+    PackageType(String dbStringIn) {\n+        dbString = dbStringIn;\n+    }\n+\n+    public String getDbString() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE0MTExMg==", "bodyText": "It'd be nice to have a test over ISS, ideally with a deb channel. Do we have a plan to at least try it out manually?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536141112", "createdAt": "2020-12-04T14:32:45Z", "author": {"login": "moio"}, "path": "backend/server/importlib/errataImport.py", "diffHunk": "@@ -117,13 +119,16 @@ def fix(self):\n                 if eft not in self.file_types:\n                     raise Exception(\"Unknown file type %s\" % eft)\n                 ef['type'] = self.file_types[eft]\n+        for label, aid in self.package_arches.items():\n+            self.package_type = self.backend.lookupPackageArchType(aid)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NjMxMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - Feat: Debian package comparator\n          \n          \n            \n            - Fix Debian package version comparison\n          \n      \n    \n    \n  \n\nI feel a text like the above reflects the change better from a user's perspective. Maybe we should even have a bug number? Surely it can't be presented as a feature, as the PR description says,  \"this is targeting the internal version comparator. Transparent for the final user\"", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536166310", "createdAt": "2020-12-04T15:08:49Z", "author": {"login": "moio"}, "path": "backend/spacewalk-backend.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- Feat: Debian package comparator", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NjkyNQ==", "bodyText": "See comment in backend/spacewalk-backend.changes", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536166925", "createdAt": "2020-12-04T15:09:38Z", "author": {"login": "moio"}, "path": "java/spacewalk-java.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- Feat: Debian package comparator", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NzAxNw==", "bodyText": "See comment in backend/spacewalk-backend.changes", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536167017", "createdAt": "2020-12-04T15:09:47Z", "author": {"login": "moio"}, "path": "schema/spacewalk/susemanager-schema.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- Feat: Debian package comparator", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MDEyNA==", "bodyText": "Can we have this (very useful IMO!) script running as part of our Python unit testsuite?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536170124", "createdAt": "2020-12-04T15:14:09Z", "author": {"login": "moio"}, "path": "schema/util/debian-versioncmp-database-testgenerator.py", "diffHunk": "@@ -0,0 +1,74 @@\n+#!/usr/bin/python3\n+\n+OUTPUT_SQL_SCRIPT_FILENAME = 'debian_version_database_comparator_tests.sql'\n+\n+preamble = \"\"\"\n+-- launch me with spacewalk-sql -i < {}\n+DO\n+$$\n+declare\n+\tresult NUMERIC := 0;\n+begin\n+\n+\"\"\".format(OUTPUT_SQL_SCRIPT_FILENAME)\n+\n+conclusion = \"\"\"\n+end;\n+$$\n+\"\"\"\n+\n+# source: https://git.dpkg.org/cgit/dpkg/dpkg.git/tree/scripts/t/Dpkg_Version.t\n+tests = \"\"\"1.0-1 2.0-2 -1\n+2.2~rc-4 2.2-1 -1\n+2.2-1 2.2~rc-4 1\n+1.0000-1 1.0-1 0\n+0foo 0foo 0\n+0foo-0 0foo 0\n+0foo 0foo-0 0\n+0foo 0fo 1\n+0foo-0 0foo+ -1\n+0foo~1 0foo -1\n+0foo~foo+Bar 0foo~foo+bar -1\n+0foo~~ 0foo~ -1\n+1~ 1 -1\n+12345+that-really-is-some-ver-0 12345+that-really-is-some-ver-10 -1\n+0foo-0 0foo-01 -1\n+0foo.bar 0foobar 1\n+0foo.bar 0foo1bar 1\n+0foo.bar 0foo0bar 1\n+0foo1bar-1 0foobar-1 -1\n+0foo2.0 0foo2 1\n+0foo2.0.0 0foo2.10.0 -1\n+0foo2.0 0foo2.0.0 -1\n+0foo2.0 0foo2.10 -1\n+0foo2.1 0foo2.10 -1\n+1.09 1.9 0\n+1.0.8+nmu1 1.0.8 1\n+3.11 3.10+nmu1 1\n+0.9j-20080306-4 0.9i-20070324-2 1\n+1.2.0~b7-1 1.2.0~b6-1 1\n+1.011-1 1.06-2 1\n+0.0.9+dfsg1-1 0.0.8+dfsg1-3 1\n+4.6.99+svn6582-1 4.6.99+svn6496-1 1\n+53 52 1\n+0.9.9~pre122-1 0.9.9~pre111-1 1\n+1.0.1+gpl-1 1.0.1-2 1\n+1a 1000a -1\"\"\"\n+\n+with open(OUTPUT_SQL_SCRIPT_FILENAME, 'w') as f:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4MDA4Mw==", "bodyText": "Hmmm, I'm unsure about this one.\nAre you sure no queries remain that look for rows in this table by version+release only, or by version+release+epoch only?\nIf the answer is yes, then we might consider adding an index instead of changing existing indexes.\nOr we could use partial indexes.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536180083", "createdAt": "2020-12-04T15:27:43Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/tables/rhnPackageEVR_index.sql", "diffHunk": "@@ -14,9 +14,9 @@\n --\n \n create unique index rhn_pe_v_r_e_uq\n-    on rhnpackageevr (version, release, epoch)\n+    on rhnpackageevr (version, release, epoch, ((evr).type))\n  where epoch is not null;\n \n create unique index rhn_pe_v_r_uq\n-    on rhnpackageevr (version, release)\n+    on rhnpackageevr (version, release, ((evr).type))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4NDI2OQ==", "bodyText": "I am probably missing something, what does (evr). mean here?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536184269", "createdAt": "2020-12-04T15:33:42Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/procs/lookup_evr.sql", "diffHunk": "@@ -25,13 +25,14 @@ begin\n       from rhnPackageEVR\n      where ((epoch is null and e_in is null) or (epoch = e_in)) and\n            version = v_in and\n-           release = r_in;\n+           release = r_in and\n+           (evr).type = t_in;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4NDc1OA==", "bodyText": "I am probably missing something, what does (evr). mean here?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536184758", "createdAt": "2020-12-04T15:34:25Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/procs/insert_evr.sql", "diffHunk": "@@ -10,14 +10,14 @@ begin\n     evr_id := nextval('rhn_pkg_evr_seq');\n \n     insert into rhnPackageEVR(id, epoch, version, release, evr)\n-        values (evr_id, e_in, v_in, r_in, evr_t(e_in, v_in, r_in))\n+        values (evr_id, e_in, v_in, r_in, evr_t(e_in, v_in, r_in, t_in))\n         on conflict do nothing;\n \n     select id\n         into strict evr_id\n         from rhnPackageEVR\n         where ((epoch is null and e_in is null) or (epoch = e_in)) and\n-           version = v_in and release = r_in;\n+           version = v_in and release = r_in and (evr).type = t_in;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5MzM1MA==", "bodyText": "More code below refers to the ~ character which to my understanding is Debian only.\nhttps://fedoraproject.org/wiki/Archive:Tools/RPM/VersionComparison\nhttps://www.debian.org/doc/debian-policy/ch-controlfields.html#version\nI guess those should be fixed as well?\nI also see references to the caret symbol ^ and I cannot find docs about it anywhere. Please double check.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536193350", "createdAt": "2020-12-04T15:46:50Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/packages/rpm.pkb", "diffHunk": "@@ -69,38 +65,6 @@ $$ language 'plpgsql';\n         then\n             return 0;\n         end if;\n-        if POSITION('+' in str1) <> 0 AND POSITION('+' in str2) <> 0 AND POSITION('~' in str1) = 0 AND POSITION('~' in str2) = 0 AND POSITION('.module' in str1) = 0 AND POSITION('.module' in str2) = 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NDY2MA==", "bodyText": "It would be nice to add comments pointing to URLs defining the standard and/or existing implementations of the algorithm to check against.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536194660", "createdAt": "2020-12-04T15:48:42Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/packages/deb.pkb", "diffHunk": "@@ -0,0 +1,185 @@\n+-- oracle equivalent source sha1 539cb03eb177b7e87992701071488bbb32bb0624\n+create schema deb;\n+\n+--update pg_setting\n+update pg_settings set setting = 'deb,' || setting where name = 'search_path';\n+\n+CREATE OR REPLACE FUNCTION lastIndexOf(needle text, haystack text)\n+RETURNS integer AS $$\n+    DECLARE\n+        rc INTEGER;\n+    BEGIN\n+     rc := length(haystack) - position(needle in reverse(haystack));\n+     if rc = length(haystack) then rc = -1; end if;\n+     return rc;\n+    END;\n+$$ language 'plpgsql';\n+\n+create or replace function isdigit(ch CHAR)\n+    RETURNS BOOLEAN as $$\n+    BEGIN\n+        if ascii(ch) between ascii('0') and ascii('9')\n+        then\n+            return TRUE;\n+        end if;\n+        return FALSE;\n+    END ;\n+$$ language 'plpgsql';\n+\n+\n+create or replace FUNCTION isalpha(ch CHAR)\n+    RETURNS BOOLEAN as $$\n+    BEGIN\n+        if ascii(ch) between ascii('a') and ascii('z') or\n+            ascii(ch) between ascii('A') and ascii('Z')\n+        then\n+            return TRUE;\n+        end if;\n+        return FALSE;\n+    END;\n+$$ language 'plpgsql';\n+\n+create or replace FUNCTION charAt(str IN VARCHAR, pos IN INTEGER)\n+    RETURNS CHARACTER as $$\n+    BEGIN\n+        return SUBSTR(str, pos + 1, 1);\n+    END;\n+$$ language 'plpgsql';\n+\n+create or replace function deborder(c INTEGER)\n+    RETURNS INTEGER as $$\n+    BEGIN\n+        if deb.isdigit(chr(c)) then return 0; end if;\n+        if deb.isalpha(chr(c)) then return c; end if;\n+        if c = ascii('~') then return -1; end if;\n+        if c != 0 then return c + 256; end if;\n+        return 0;\n+    END ;\n+$$ language 'plpgsql';\n+\n+create or replace FUNCTION verrevcmp(a1 IN VARCHAR, b1 IN VARCHAR)\n+    RETURNS INTEGER as $$\n+    DECLARE\n+        a VARCHAR;\n+        b VARCHAR;\n+        i INTEGER := 0;\n+        j INTEGER := 0;\n+    BEGIN\n+        IF a1 IS NULL then a := ''; end if;\n+        IF b1 IS NULL then b := ''; end if;\n+        a := a1;\n+        b := b1;\n+        WHILE (i < LENGTH(a)) or (j < LENGTH(b))\n+        LOOP\n+            DECLARE\n+                firstDiff INTEGER := 0;\n+            BEGIN\n+                while ((i < LENGTH(a)) and not deb.isdigit(deb.charAt(a,i))) or ((j < LENGTH(b)) and not deb.isdigit(deb.charAt(b,j)))\n+                LOOP\n+                DECLARE\n+                    ac INTEGER;\n+                    bc INTEGER;\n+                BEGIN\n+                    if i >= length(a)\n+                    then\n+                        ac := 0;\n+                    else\n+                        ac := deb.deborder(ascii(deb.charAt(a, i)));\n+                    end if;\n+                    if j >= length(b)\n+                    then\n+                        bc := 0;\n+                    else\n+                        bc := deb.deborder(ascii(deb.charAt(b, j)));\n+                    end if;\n+                    if ac != bc then return ac-bc; end if;\n+                    i := i + 1;\n+                    j := j + 1;\n+                END;\n+                END LOOP;\n+                while (i < length(a)) and (deb.charAt(a, i) = '0')\n+                LOOP\n+                    i := i + 1;\n+                END LOOP;\n+                while (j < length(b)) and (deb.charAt(b, j) = '0')\n+                LOOP\n+                    j := j + 1;\n+                END LOOP;\n+                WHILE (i < LENGTH(a)) and (j < LENGTH(b)) and (deb.isdigit(deb.charAt(a,i))) and (deb.isdigit(deb.charAt(b, j)))\n+                LOOP\n+                    if firstDiff = 0 then firstDiff := ascii(deb.charAt(a, i)) - ascii(deb.charAt(b, j)); end if;\n+                    i := i + 1;\n+                    j := j + 1;\n+                END LOOP;\n+                IF (i < LENGTH(a)) and (deb.isdigit(deb.charAt(a,i))) then return 1; end if;\n+                IF (j < LENGTH(b)) and (deb.isdigit(deb.charAt(b,j))) then return -1; end if;\n+                IF firstDiff != 0 then return firstDiff; end if;\n+            END;\n+        END LOOP;\n+        RETURN 0;\n+    END;\n+$$ language 'plpgsql';\n+\n+create or replace FUNCTION debstrcmp (o1 IN VARCHAR, o2 IN VARCHAR)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NTUyNg==", "bodyText": "What would be pros/cons of using EXCEPTION here?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536195526", "createdAt": "2020-12-04T15:49:53Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/class/evr_t.sql", "diffHunk": "@@ -7,27 +7,43 @@\n -- FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n -- along with this software; if not, see\n -- http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n--- \n+--\n -- Red Hat trademarks are not licensed under GPLv2. No permission is\n -- granted to use or replicate Red Hat trademarks that are incorporated\n--- in this software or its documentation. \n+-- in this software or its documentation.\n --\n \n create type evr_t as (\n         epoch           varchar(16),\n         version         varchar(512),\n-        release         varchar(512)\n+        release         varchar(512),\n+        type            varchar(10)\n );\n \n-create or replace function evr_t(e varchar, v varchar, r varchar)\n+create or replace function evr_t(e varchar, v varchar, r varchar, t varchar)\n returns evr_t as $$\n-select row($1,$2,$3)::evr_t\n+select row($1,$2,$3,$4)::evr_t\n $$ language sql;\n \n create or replace function evr_t_compare( a evr_t, b evr_t )\n returns int as $$\n begin\n-  return rpm.vercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+  if a.type = b.type then\n+      if a.type = 'rpm' then\n+        return rpm.vercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+      elsif a.type = 'deb' then\n+        return deb.debvercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+      else\n+        raise EXCEPTION 'unknown evr type (using rpm) -> %', a.type;\n+      end if;\n+  else\n+     raise NOTICE 'comparing incompatible evr types. Using %', a.type;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NzE3OQ==", "bodyText": "What would be the pros/cons of not having this generated column?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536197179", "createdAt": "2020-12-04T15:52:06Z", "author": {"login": "moio"}, "path": "schema/spacewalk/common/tables/rhnPackageEVR.sql", "diffHunk": "@@ -21,7 +21,8 @@ CREATE TABLE rhnPackageEVR\n     epoch    VARCHAR(16),\n     version  VARCHAR(512) NOT NULL,\n     release  VARCHAR(512) NOT NULL,\n-    evr      EVR_T NOT NULL\n+    evr      EVR_T NOT NULL,\n+    type     varchar(10) generated always as ((evr).type) stored", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5ODcxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            create schema deb;\n          \n          \n            \n            create schema if not exists deb;\n          \n      \n    \n    \n  \n\nNitpick: does not hurt to have this file identical to schema/spacewalk/upgrade/susemanager-schema-4.2.2-to-susemanager-schema-4.2.3/701-rpm.pkb.sql", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536198717", "createdAt": "2020-12-04T15:54:08Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/packages/deb.pkb", "diffHunk": "@@ -0,0 +1,185 @@\n+-- oracle equivalent source sha1 539cb03eb177b7e87992701071488bbb32bb0624\n+create schema deb;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 2}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2062c5165392949774e37502cd77bfe1a4cac67f", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2062c5165392949774e37502cd77bfe1a4cac67f", "committedDate": "2020-12-07T15:37:35Z", "message": "fixup! Feat: migration scripts - PL/pgSQL\n\nCo-authored-by: Silvio Moioli <smoioli@suse.de>"}, "afterCommit": {"oid": "0e2462b2016ece0db831c4816fdd72d4de0e97ec", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0e2462b2016ece0db831c4816fdd72d4de0e97ec", "committedDate": "2020-12-07T15:48:05Z", "message": "cleanup code and todos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzg1Mjkx", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-552385291", "createdAt": "2020-12-15T12:08:54Z", "commit": {"oid": "7cd0b4bbc31863ec140305581e3f75643c2e7055"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMjowODo1NFrOIGHt7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMzoxNDowNVrOIGKQJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI4ODgxNA==", "bodyText": "No as \"susedata\" exists only for SUSE systems and all of them are RPM based.\n\nIn that case shouldn't we rather hardcode the RPM type in the line below?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543288814", "createdAt": "2020-12-15T12:08:54Z", "author": {"login": "moio"}, "path": "backend/satellite_tools/reposync.py", "diffHunk": "@@ -2105,7 +2105,7 @@ def import_susedata(self, repo):\n                   JOIN rhnChecksumView c ON p.checksum_id = c.id\n                   JOIN rhnChannelPackage cp ON p.id = cp.package_id\n                  WHERE pn.name = :name\n-                   AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNTg1MQ=="}, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5NzMxMQ==", "bodyText": "Update: test passed. Resolving conversation", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543297311", "createdAt": "2020-12-15T12:22:42Z", "author": {"login": "moio"}, "path": "backend/server/importlib/errataImport.py", "diffHunk": "@@ -117,13 +119,16 @@ def fix(self):\n                 if eft not in self.file_types:\n                     raise Exception(\"Unknown file type %s\" % eft)\n                 ef['type'] = self.file_types[eft]\n+        for label, aid in self.package_arches.items():\n+            self.package_type = self.backend.lookupPackageArchType(aid)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE0MTExMg=="}, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5ODgyNA==", "bodyText": "I was suggesting to just add this to the current Python tests, without a new job.\nCan it be done in the context of this PR?", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543298824", "createdAt": "2020-12-15T12:25:15Z", "author": {"login": "moio"}, "path": "schema/util/debian-versioncmp-database-testgenerator.py", "diffHunk": "@@ -0,0 +1,74 @@\n+#!/usr/bin/python3\n+\n+OUTPUT_SQL_SCRIPT_FILENAME = 'debian_version_database_comparator_tests.sql'\n+\n+preamble = \"\"\"\n+-- launch me with spacewalk-sql -i < {}\n+DO\n+$$\n+declare\n+\tresult NUMERIC := 0;\n+begin\n+\n+\"\"\".format(OUTPUT_SQL_SCRIPT_FILENAME)\n+\n+conclusion = \"\"\"\n+end;\n+$$\n+\"\"\"\n+\n+# source: https://git.dpkg.org/cgit/dpkg/dpkg.git/tree/scripts/t/Dpkg_Version.t\n+tests = \"\"\"1.0-1 2.0-2 -1\n+2.2~rc-4 2.2-1 -1\n+2.2-1 2.2~rc-4 1\n+1.0000-1 1.0-1 0\n+0foo 0foo 0\n+0foo-0 0foo 0\n+0foo 0foo-0 0\n+0foo 0fo 1\n+0foo-0 0foo+ -1\n+0foo~1 0foo -1\n+0foo~foo+Bar 0foo~foo+bar -1\n+0foo~~ 0foo~ -1\n+1~ 1 -1\n+12345+that-really-is-some-ver-0 12345+that-really-is-some-ver-10 -1\n+0foo-0 0foo-01 -1\n+0foo.bar 0foobar 1\n+0foo.bar 0foo1bar 1\n+0foo.bar 0foo0bar 1\n+0foo1bar-1 0foobar-1 -1\n+0foo2.0 0foo2 1\n+0foo2.0.0 0foo2.10.0 -1\n+0foo2.0 0foo2.0.0 -1\n+0foo2.0 0foo2.10 -1\n+0foo2.1 0foo2.10 -1\n+1.09 1.9 0\n+1.0.8+nmu1 1.0.8 1\n+3.11 3.10+nmu1 1\n+0.9j-20080306-4 0.9i-20070324-2 1\n+1.2.0~b7-1 1.2.0~b6-1 1\n+1.011-1 1.06-2 1\n+0.0.9+dfsg1-1 0.0.8+dfsg1-3 1\n+4.6.99+svn6582-1 4.6.99+svn6496-1 1\n+53 52 1\n+0.9.9~pre122-1 0.9.9~pre111-1 1\n+1.0.1+gpl-1 1.0.1-2 1\n+1a 1000a -1\"\"\"\n+\n+with open(OUTPUT_SQL_SCRIPT_FILENAME, 'w') as f:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MDEyNA=="}, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwMTA1NQ==", "bodyText": "Well, we talk about an unique index here. The index is only unique with the type.\n\nI am OK from the constraint perspective.\nStill the question remains: do we have any remaining query that addresses V+R or E+V+R without any type? How many of them are left, if any? In which contexts?\nReason is that this index will not help these queries any longer, so if any remain, they might see slowdowns.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543301055", "createdAt": "2020-12-15T12:29:03Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/tables/rhnPackageEVR_index.sql", "diffHunk": "@@ -14,9 +14,9 @@\n --\n \n create unique index rhn_pe_v_r_e_uq\n-    on rhnpackageevr (version, release, epoch)\n+    on rhnpackageevr (version, release, epoch, ((evr).type))\n  where epoch is not null;\n \n create unique index rhn_pe_v_r_uq\n-    on rhnpackageevr (version, release)\n+    on rhnpackageevr (version, release, ((evr).type))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4MDA4Mw=="}, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNDk5OQ==", "bodyText": "OK, I learnt something new again.\n@lucidd you might be aware of this data set: it contains a huge amount of versions in the correct order. It can be used to check a version comparison algorithm for correctness. HTH", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543304999", "createdAt": "2020-12-15T12:35:37Z", "author": {"login": "moio"}, "path": "schema/spacewalk/postgres/packages/rpm.pkb", "diffHunk": "@@ -69,38 +65,6 @@ $$ language 'plpgsql';\n         then\n             return 0;\n         end if;\n-        if POSITION('+' in str1) <> 0 AND POSITION('+' in str2) <> 0 AND POSITION('~' in str1) = 0 AND POSITION('~' in str2) = 0 AND POSITION('.module' in str1) = 0 AND POSITION('.module' in str2) = 0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5MzM1MA=="}, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwODEyOA==", "bodyText": "I always wonder whether creating a custom type was actually ever worth the trouble.\nIn any case, no discussion to be made now.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543308128", "createdAt": "2020-12-15T12:40:34Z", "author": {"login": "moio"}, "path": "schema/spacewalk/common/tables/rhnPackageEVR.sql", "diffHunk": "@@ -21,7 +21,8 @@ CREATE TABLE rhnPackageEVR\n     epoch    VARCHAR(16),\n     version  VARCHAR(512) NOT NULL,\n     release  VARCHAR(512) NOT NULL,\n-    evr      EVR_T NOT NULL\n+    evr      EVR_T NOT NULL,\n+    type     varchar(10) generated always as ((evr).type) stored", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NzE3OQ=="}, "originalCommit": {"oid": "72d561e27e22e40a522e5b4838903a28e909f03d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyNjc4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @version $Rev$", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543326785", "createdAt": "2020-12-15T13:08:49Z", "author": {"login": "moio"}, "path": "java/code/src/com/redhat/rhn/common/util/DebVersionComparator.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.common.util;\n+\n+import java.util.Comparator;\n+\n+/**\n+ * DebVersionComparator\n+ * @version $Rev$", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cd0b4bbc31863ec140305581e3f75643c2e7055"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMzMDM0Mw==", "bodyText": "Could we re-use data in this method to also check the stored procedure implementation of the algorithm?\nOne way to do it could be to create a List of those versions and then sorting it with the Comparator, and inspecting the sorted result.", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543330343", "createdAt": "2020-12-15T13:14:05Z", "author": {"login": "moio"}, "path": "java/code/src/com/redhat/rhn/common/util/test/DebVersionComparatorTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.common.util.test;\n+\n+import com.redhat.rhn.common.util.DebVersionComparator;\n+\n+import junit.framework.TestCase;\n+\n+/**\n+ * DebVersionComparatorTest\n+ */\n+public class DebVersionComparatorTest extends TestCase {\n+\n+    private DebVersionComparator cmp;\n+\n+    protected void setUp() throws Exception {\n+        super.setUp();\n+        cmp = new DebVersionComparator();\n+    }\n+\n+    protected void tearDown() throws Exception {\n+        cmp = null;\n+        super.tearDown();\n+    }\n+\n+    public void testDpkgTestCases() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cd0b4bbc31863ec140305581e3f75643c2e7055"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDk3Mzg3", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-553497387", "createdAt": "2020-12-16T09:25:20Z", "commit": {"oid": "845cf71d2929f388f0b007a13025e1603d422080"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwOToyNToyMFrOIG7sSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwOToyNToyMFrOIG7sSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDE0MDM2MA==", "bodyText": "Nitpick: if these queries are only used for testing, they could be added to the test_queries.xml file", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r544140360", "createdAt": "2020-12-16T09:25:20Z", "author": {"login": "moio"}, "path": "java/code/src/com/redhat/rhn/common/db/datasource/xml/PackageEvr_queries.xml", "diffHunk": "@@ -0,0 +1,13 @@\n+<datasource_modes>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "845cf71d2929f388f0b007a13025e1603d422080"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNjY1Njgx", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-553665681", "createdAt": "2020-12-16T13:05:17Z", "commit": {"oid": "29605aea7010b782717c373bb7b5dcb3c0a30f54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e8021c163658f7595da5fbad66962c29025ae90", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/8e8021c163658f7595da5fbad66962c29025ae90", "committedDate": "2020-12-16T13:08:52Z", "message": "bits and pieces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29605aea7010b782717c373bb7b5dcb3c0a30f54", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/29605aea7010b782717c373bb7b5dcb3c0a30f54", "committedDate": "2020-12-16T09:48:37Z", "message": "Refactor: move mode queries to test queries"}, "afterCommit": {"oid": "ef9a51cfa9c8e77abf9fdcdf69c0bfa39ee8e20c", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ef9a51cfa9c8e77abf9fdcdf69c0bfa39ee8e20c", "committedDate": "2020-12-16T13:09:30Z", "message": "Refactor: move mode queries to test queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "172c90f096b44a966be1714619ce67e48774f6cc", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/172c90f096b44a966be1714619ce67e48774f6cc", "committedDate": "2020-12-16T13:20:12Z", "message": "Feat: Debian package version comparator - Java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98f0452c7a690580a425ac4e1cc74c08e6d62e56", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/98f0452c7a690580a425ac4e1cc74c08e6d62e56", "committedDate": "2020-12-16T13:20:14Z", "message": "Test: refactor tests for Debian vercmp - Java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93a6e16b737eb5e6a60e53ae3dd38ab102fe7ade", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/93a6e16b737eb5e6a60e53ae3dd38ab102fe7ade", "committedDate": "2020-12-16T13:20:14Z", "message": "Refactor: restore RPM version cmp pre-Debian - Java\n\nReference commit id: 74c79db537c7762360d3675b280c2257d71cb698"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eb13c0bbacfc3d4afc4e91c58cd0b4abdee4c72", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3eb13c0bbacfc3d4afc4e91c58cd0b4abdee4c72", "committedDate": "2020-12-16T13:20:15Z", "message": "Feat: Debian package version comparator - PL/pgSQL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "405381c1c17b6c7b3b7c3262e04f0556a7f994c4", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/405381c1c17b6c7b3b7c3262e04f0556a7f994c4", "committedDate": "2020-12-16T13:20:15Z", "message": "Test: generator for Debian vercmp - PL/pgSQL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c93ea7054b8c1791101ff456c02e107ae184c40", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7c93ea7054b8c1791101ff456c02e107ae184c40", "committedDate": "2020-12-16T13:20:15Z", "message": "Refactor: restore RPM version cmp pre-Debian cmp - PL/pgSQL\n\nReference commit id: e133ffeeb303b6a757dda9f5561e6d329e077ad3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4bc1492d457a7c0bdb89582d77927da32c7bfe3", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c4bc1492d457a7c0bdb89582d77927da32c7bfe3", "committedDate": "2020-12-16T13:20:15Z", "message": "Feat: migration scripts - PL/pgSQL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc27e84073ea9f8f7b0b645f0e94d6bf887dedb6", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cc27e84073ea9f8f7b0b645f0e94d6bf887dedb6", "committedDate": "2020-12-16T13:20:15Z", "message": "Feat: call Debian versioncmp in dispatcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5405536994bd4a4a6bedb39641102286ee9782f", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/e5405536994bd4a4a6bedb39641102286ee9782f", "committedDate": "2020-12-16T13:20:15Z", "message": "cleanup unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f7f3fe5e4f4c5b99b99ff886fd5e63d8cd65a22", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2f7f3fe5e4f4c5b99b99ff886fd5e63d8cd65a22", "committedDate": "2020-12-16T13:20:50Z", "message": "add type to evr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d3e9d4e97a8bd7931124049bf6ebc0ff6b2d4dd", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5d3e9d4e97a8bd7931124049bf6ebc0ff6b2d4dd", "committedDate": "2020-12-16T13:20:52Z", "message": "import packages with evr package type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20452be5c5965e619b82dc6fbb862f72046bd91f", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/20452be5c5965e619b82dc6fbb862f72046bd91f", "committedDate": "2020-12-16T13:20:52Z", "message": "use new EVR lookup function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f3bbe29e0f01047f32a8e0ac136b58f206d3aef", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6f3bbe29e0f01047f32a8e0ac136b58f206d3aef", "committedDate": "2020-12-16T13:20:53Z", "message": "add potential solution for type dubpication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4355bd4aaea0ca584e73c648d47aaca5604a4879", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4355bd4aaea0ca584e73c648d47aaca5604a4879", "committedDate": "2020-12-16T13:20:53Z", "message": "dispatch compare based on packageevr type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f76e1cbc5f7b2739912bff5eba480552037530b", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5f76e1cbc5f7b2739912bff5eba480552037530b", "committedDate": "2020-12-16T13:20:53Z", "message": "Fix: add call to Debian version comparator in dispatcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a7593b29d7d847441210407c10183a114ff4a6", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/d5a7593b29d7d847441210407c10183a114ff4a6", "committedDate": "2020-12-16T13:20:53Z", "message": "remove references to rpm.vercmp in queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfab1827bceb955763246772eefdb432a99e0858", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bfab1827bceb955763246772eefdb432a99e0858", "committedDate": "2020-12-16T13:20:53Z", "message": "type errors should be reported as exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f77b09179bcf01655e71e3b683c5a57cff287c4", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7f77b09179bcf01655e71e3b683c5a57cff287c4", "committedDate": "2020-12-16T13:20:53Z", "message": "limit compare to same EVR types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3614cbf96e3e5bedf1242877f2389f137844164d", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3614cbf96e3e5bedf1242877f2389f137844164d", "committedDate": "2020-12-16T13:20:53Z", "message": "java: limit compare to same EVR types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ee5686792453e11b66c056a07c17aab7da14e6d", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7ee5686792453e11b66c056a07c17aab7da14e6d", "committedDate": "2020-12-16T13:20:53Z", "message": "declare operator <>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "538ad4ca9271aeecf1aa268da2078d3c0c86b0d6", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/538ad4ca9271aeecf1aa268da2078d3c0c86b0d6", "committedDate": "2020-12-16T13:20:53Z", "message": "change deb/rpm comparison"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3d652536caaa48191717aa76351a6c5ab11de13", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c3d652536caaa48191717aa76351a6c5ab11de13", "committedDate": "2020-12-16T13:20:53Z", "message": "Chore: announce changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a4c00cf5e1a747a50fea04dbb40d78d4ce41cb", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/d5a4c00cf5e1a747a50fea04dbb40d78d4ce41cb", "committedDate": "2020-12-16T13:21:19Z", "message": "renmae lookup_evr2 back to lookup_evr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f28998f96a70c9a01f0ef9a4a44e31ba9eb1e369", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f28998f96a70c9a01f0ef9a4a44e31ba9eb1e369", "committedDate": "2020-12-16T13:21:21Z", "message": "use standard EVR parser for unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d2b87e1176ecf5476974267db3c429f3005d879", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0d2b87e1176ecf5476974267db3c429f3005d879", "committedDate": "2020-12-16T13:21:21Z", "message": "remove evr field in PackageStateJson"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53497c8c75fb137caaa9b3b0b4cc7033d5e188f2", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/53497c8c75fb137caaa9b3b0b4cc7033d5e188f2", "committedDate": "2020-12-16T13:21:21Z", "message": "move PackageUtilsTest tests to fitting location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0298ad9f74b1d0b4c5c884876dfc3a79f606ce8", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c0298ad9f74b1d0b4c5c884876dfc3a79f606ce8", "committedDate": "2020-12-16T13:21:21Z", "message": "reorder migration scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2922c9eba38e9b1ca33867cb872d82e3d514f0b9", "author": {"user": {"login": "lucidd", "name": "Kevin Walter"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2922c9eba38e9b1ca33867cb872d82e3d514f0b9", "committedDate": "2020-12-16T13:21:54Z", "message": "cleanup code and todos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07a9cb7058c605b89c14c7e4522baa3b1962e88f", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/07a9cb7058c605b89c14c7e4522baa3b1962e88f", "committedDate": "2020-12-16T13:25:37Z", "message": "Refactor: Debian package version comparator Tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef9a51cfa9c8e77abf9fdcdf69c0bfa39ee8e20c", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ef9a51cfa9c8e77abf9fdcdf69c0bfa39ee8e20c", "committedDate": "2020-12-16T13:09:30Z", "message": "Refactor: move mode queries to test queries"}, "afterCommit": {"oid": "07a9cb7058c605b89c14c7e4522baa3b1962e88f", "author": {"user": {"login": "mbologna", "name": "Michele Bologna"}}, "url": "https://github.com/uyuni-project/uyuni/commit/07a9cb7058c605b89c14c7e4522baa3b1962e88f", "committedDate": "2020-12-16T13:25:37Z", "message": "Refactor: Debian package version comparator Tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNzE0ODcy", "url": "https://github.com/uyuni-project/uyuni/pull/2767#pullrequestreview-553714872", "createdAt": "2020-12-16T14:04:03Z", "commit": {"oid": "07a9cb7058c605b89c14c7e4522baa3b1962e88f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 942, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}