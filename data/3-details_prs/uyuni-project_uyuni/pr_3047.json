{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNTE0Mzg2", "number": 3047, "title": "Improve extra key handling", "bodyText": "What does this PR change?\nAdding new extratag keys during reposync can fail with\nduplicate key value violates unique constraint \"rhn_pkg_extra_tag_key_idx\"\nDETAIL:  Key (name)=(Cnf-Extra-Commands) already exists.\n\nThis result in failed imports of a bunch of packages. To improve the creation of new keys, this PR declare lookup and insert functions and make use of it in the import code.\nSecond case found while inserting into rhnPackageKey.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: only internal and user invisible changes\n\n\n DONE\n\n\nTest coverage\n\n\nNo tests: manual\n\n\n DONE\n\n\nLinks\nFixes #3040\nTracks SUSE/spacewalk#13545\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-12-18T12:28:50Z", "url": "https://github.com/uyuni-project/uyuni/pull/3047", "merged": true, "mergeCommit": {"oid": "d80310b02929767dee2cb9a515a09695aca6db84"}, "closed": true, "closedAt": "2020-12-30T15:47:10Z", "author": {"login": "mcalmer"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoTU9rAFqTU1NjI3NjU0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdrNA_zABqjQxNTY5MTIzMTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2Mjc2NTQw", "url": "https://github.com/uyuni-project/uyuni/pull/3047#pullrequestreview-556276540", "createdAt": "2020-12-21T10:25:18Z", "commit": {"oid": "4e5ec3f0bf160d3c6b717db9170e7dc4436d9c6b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e5ec3f0bf160d3c6b717db9170e7dc4436d9c6b", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4e5ec3f0bf160d3c6b717db9170e7dc4436d9c6b", "committedDate": "2020-12-18T14:43:45Z", "message": "do no raise unique constraint violation on conflicts"}, "afterCommit": {"oid": "0f38dcfb05e99b85acc67520911619242de4a3aa", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0f38dcfb05e99b85acc67520911619242de4a3aa", "committedDate": "2020-12-21T16:53:41Z", "message": "update changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTU0NzQ3", "url": "https://github.com/uyuni-project/uyuni/pull/3047#pullrequestreview-556954747", "createdAt": "2020-12-22T09:54:32Z", "commit": {"oid": "0f38dcfb05e99b85acc67520911619242de4a3aa"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTo1NDozMlrOIJ1LnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTo1NTowMlrOIJ1MlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE3OTQyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                       LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name\n          \n          \n            \n                                LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name", "url": "https://github.com/uyuni-project/uyuni/pull/3047#discussion_r547179421", "createdAt": "2020-12-22T09:54:32Z", "author": {"login": "moio"}, "path": "backend/server/importlib/backend.py", "diffHunk": "@@ -299,40 +298,40 @@ def processCVEs(self, cveHash):\n         h.executemany(id=toinsert[0], name=toinsert[1])\n \n     def processExtraTags(self, extraTags):\n-        query_lookup = \"\"\"\n-            SELECT id\n-              FROM rhnPackageExtraTagKey\n-             WHERE name = :name\n+        if not extraTags:\n+            return\n+        sql = \"\"\"\n+            WITH wanted (name) AS (\n+              VALUES %s\n+            )\n+            missing AS (\n+              SELECT nextval('rhn_package_extra_tags_keys_id_seq') AS id, wanted.name\n+                FROM wanted\n+           LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f38dcfb05e99b85acc67520911619242de4a3aa"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE3OTU3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        SELECT * from missing\n          \n          \n            \n                            SELECT * from missing", "url": "https://github.com/uyuni-project/uyuni/pull/3047#discussion_r547179574", "createdAt": "2020-12-22T09:54:51Z", "author": {"login": "moio"}, "path": "backend/server/importlib/backend.py", "diffHunk": "@@ -299,40 +298,40 @@ def processCVEs(self, cveHash):\n         h.executemany(id=toinsert[0], name=toinsert[1])\n \n     def processExtraTags(self, extraTags):\n-        query_lookup = \"\"\"\n-            SELECT id\n-              FROM rhnPackageExtraTagKey\n-             WHERE name = :name\n+        if not extraTags:\n+            return\n+        sql = \"\"\"\n+            WITH wanted (name) AS (\n+              VALUES %s\n+            )\n+            missing AS (\n+              SELECT nextval('rhn_package_extra_tags_keys_id_seq') AS id, wanted.name\n+                FROM wanted\n+           LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name\n+               WHERE rhnPackageExtraTagKey.id IS NULL\n+            )\n+            INSERT INTO rhnPackageExtraTagKey (id, name)\n+            SELECT * from missing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f38dcfb05e99b85acc67520911619242de4a3aa"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE3OTY2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ON CONFLICT DO NOTHING\n          \n          \n            \n                            ON CONFLICT DO NOTHING", "url": "https://github.com/uyuni-project/uyuni/pull/3047#discussion_r547179668", "createdAt": "2020-12-22T09:55:02Z", "author": {"login": "moio"}, "path": "backend/server/importlib/backend.py", "diffHunk": "@@ -299,40 +298,40 @@ def processCVEs(self, cveHash):\n         h.executemany(id=toinsert[0], name=toinsert[1])\n \n     def processExtraTags(self, extraTags):\n-        query_lookup = \"\"\"\n-            SELECT id\n-              FROM rhnPackageExtraTagKey\n-             WHERE name = :name\n+        if not extraTags:\n+            return\n+        sql = \"\"\"\n+            WITH wanted (name) AS (\n+              VALUES %s\n+            )\n+            missing AS (\n+              SELECT nextval('rhn_package_extra_tags_keys_id_seq') AS id, wanted.name\n+                FROM wanted\n+           LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name\n+               WHERE rhnPackageExtraTagKey.id IS NULL\n+            )\n+            INSERT INTO rhnPackageExtraTagKey (id, name)\n+            SELECT * from missing\n+            ON CONFLICT DO NOTHING", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f38dcfb05e99b85acc67520911619242de4a3aa"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71792e766980fa8400a329131a2677cdcb52f6f9", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/71792e766980fa8400a329131a2677cdcb52f6f9", "committedDate": "2020-12-30T10:44:41Z", "message": "do no raise unique constraint violation on conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "467af5f8c4f45702eb57cd1419e856d11df87981", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/467af5f8c4f45702eb57cd1419e856d11df87981", "committedDate": "2020-12-30T10:44:41Z", "message": "use execute_values for extra tag keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ae30efd97508795496ba0f9c81574ba21db33ea", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4ae30efd97508795496ba0f9c81574ba21db33ea", "committedDate": "2020-12-30T10:44:41Z", "message": "update changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b2b473327817ee47b8fca7623cd0eb93cd4d64", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/02b2b473327817ee47b8fca7623cd0eb93cd4d64", "committedDate": "2020-12-30T10:45:01Z", "message": "Update backend/server/importlib/backend.py\n\nCo-authored-by: Silvio Moioli <moio@suse.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ed8a4709514348a5fb536672703eeb7588cbb38", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4ed8a4709514348a5fb536672703eeb7588cbb38", "committedDate": "2020-12-30T10:43:41Z", "message": "Update backend/server/importlib/backend.py\n\nCo-authored-by: Silvio Moioli <moio@suse.com>"}, "afterCommit": {"oid": "02b2b473327817ee47b8fca7623cd0eb93cd4d64", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/02b2b473327817ee47b8fca7623cd0eb93cd4d64", "committedDate": "2020-12-30T10:45:01Z", "message": "Update backend/server/importlib/backend.py\n\nCo-authored-by: Silvio Moioli <moio@suse.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 759, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}