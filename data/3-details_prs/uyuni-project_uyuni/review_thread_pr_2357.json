{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5OTc2NjU5", "number": 2357, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMjowMDo1MlrOENP7ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwOTo1Njo1N1rOENv0Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzI3OTk0OnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/common/security/acl/test/AccessTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMjowMDo1MlrOGv0sdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDoyMzo0OVrOGwigQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc5OTYwNg==", "bodyText": "What's the rationale behind getting, for example ServerGroupManager instance from GlobalInstanceHolder but creating new instance for ClusterManager.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452799606", "createdAt": "2020-07-10T12:00:52Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/common/security/acl/test/AccessTest.java", "diffHunk": "@@ -51,16 +57,22 @@\n public class AccessTest extends BaseTestCaseWithUser {\n \n     private Acl acl;\n+    private final SaltService saltService = new SaltService();\n+    private final SystemQuery systemQuery = saltService;\n+    private final SaltApi saltApi = saltService;\n+    private final ServerGroupManager serverGroupManager = GlobalInstanceHolder.SERVER_GROUP_MANAGER;\n+    private final FormulaManager formulaManager = new FormulaManager(saltApi);\n+    private final ClusterManager clusterManager = new ClusterManager(saltApi, systemQuery, serverGroupManager, formulaManager);\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU1MDE0Ng==", "bodyText": "No specific reason. There is a lot of test code and a lot of things that can be simplified there so i mainly focused on non test code first and left test code to mostly automatic refactoring to speed up the process.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453550146", "createdAt": "2020-07-13T10:23:49Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/common/security/acl/test/AccessTest.java", "diffHunk": "@@ -51,16 +57,22 @@\n public class AccessTest extends BaseTestCaseWithUser {\n \n     private Acl acl;\n+    private final SaltService saltService = new SaltService();\n+    private final SystemQuery systemQuery = saltService;\n+    private final SaltApi saltApi = saltService;\n+    private final ServerGroupManager serverGroupManager = GlobalInstanceHolder.SERVER_GROUP_MANAGER;\n+    private final FormulaManager formulaManager = new FormulaManager(saltApi);\n+    private final ClusterManager clusterManager = new ClusterManager(saltApi, systemQuery, serverGroupManager, formulaManager);\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc5OTYwNg=="}, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzYxNTE4OnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/frontend/action/groups/GroupDetailAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzo0Mjo0OVrOGv330A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzo0Mjo0OVrOGv330A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1MTY2NA==", "bodyText": "Unrelated to this PR's theme but because we are touching the line, maybe we just remove this useless cast and change the errataCounts to Map.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452851664", "createdAt": "2020-07-10T13:42:49Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/frontend/action/groups/GroupDetailAction.java", "diffHunk": "@@ -48,7 +51,7 @@ public ActionForward execute(ActionMapping mapping, ActionForm form,\n         User user = rctx.getCurrentUser();\n         ManagedServerGroup sg = rctx.lookupAndBindServerGroup();\n         HashMap errataCounts =\n-                (HashMap) ServerGroupManager.getInstance().errataCounts(user, sg);\n+                (HashMap) serverGroupManager.errataCounts(user, sg);\n         long minionCount = MinionServerUtils.filterSaltMinions(sg.getServers()).count();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzY1MzQwOnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/frontend/action/systems/sdc/SystemDetailsEditAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzo1MzowM1rOGv4PpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzo1MzowM1rOGv4PpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1Nzc2NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        GlobalInstanceHolder.SYSTEM_ENTITLEMENT_MANAGER.setBaseEntitlement(s, base);\n          \n          \n            \n                        systemEntitlementManager.setBaseEntitlement(s, base);", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452857764", "createdAt": "2020-07-10T13:53:03Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/frontend/action/systems/sdc/SystemDetailsEditAction.java", "diffHunk": "@@ -145,7 +146,7 @@ private boolean processSubmission(HttpServletRequest request,\n         Entitlement base = EntitlementManager.getByName(selectedEnt);\n         log.debug(\"base: \" + base);\n         if (base != null) {\n-            SystemEntitlementManager.INSTANCE.setBaseEntitlement(s, base);\n+            GlobalInstanceHolder.SYSTEM_ENTITLEMENT_MANAGER.setBaseEntitlement(s, base);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzkyNTEyOnYy", "diffSide": "LEFT", "path": "java/code/src/com/redhat/rhn/common/security/acl/AclFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTowNTowMlrOGv66kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTo1Mzo1M1rOGwlRzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkwMTUyMg==", "bodyText": "This will change the method logic. Before every time we call this method a new instance of Access was created, now the same instance is shared across all method invocations. Will this logic change  impact something on the code?\nSince Access class doesn't have any private fields I'm not expecting problems", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452901522", "createdAt": "2020-07-10T15:05:02Z", "author": {"login": "rjmateus"}, "path": "java/code/src/com/redhat/rhn/common/security/acl/AclFactory.java", "diffHunk": "@@ -54,14 +46,15 @@ public static AclFactory getInstance() {\n      */\n     public Acl getAcl(String mixinsIn) {\n         Acl aclObj = new Acl();\n-        Access access = new Access();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU5NTU5OQ==", "bodyText": "yeah that was my though too. Its not much different structure wise then all the other Manager/Utils classes.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453595599", "createdAt": "2020-07-13T11:53:53Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/common/security/acl/AclFactory.java", "diffHunk": "@@ -54,14 +46,15 @@ public static AclFactory getInstance() {\n      */\n     public Acl getAcl(String mixinsIn) {\n         Acl aclObj = new Acl();\n-        Access access = new Access();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkwMTUyMg=="}, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzk4MTUyOnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/common/security/acl/AclFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNToyMDozNFrOGv7eZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDozNDo0NVrOGwi3SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkxMDY5Mg==", "bodyText": "I know we are not doing pure functional programming but it seems weird to have this side effect of registering handlers in a getter and on top of that every time. Can we do it better?", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452910692", "createdAt": "2020-07-10T15:20:34Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/common/security/acl/AclFactory.java", "diffHunk": "@@ -54,14 +46,15 @@ public static AclFactory getInstance() {\n      */\n     public Acl getAcl(String mixinsIn) {\n         Acl aclObj = new Acl();\n-        Access access = new Access();\n         aclObj.registerHandler(access);\n \n         // Add the mixin handlers as well.\n         if (mixinsIn != null) {\n             String[] mixin = StringUtils.split(mixinsIn, \",\");\n             for (int i = 0; i < mixin.length; i++) {\n-                aclObj.registerHandler(StringUtils.trim(mixin[i]));\n+                if (!mixin[i].equals(Access.class.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU1NjA0MA==", "bodyText": "yeah the method name is a bit weird. There is also a todo comment at the top of this class about implementing cashing. I think this would be a good topic for another refactoring while also getting rid of the use of reflection here.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453556040", "createdAt": "2020-07-13T10:34:45Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/common/security/acl/AclFactory.java", "diffHunk": "@@ -54,14 +46,15 @@ public static AclFactory getInstance() {\n      */\n     public Acl getAcl(String mixinsIn) {\n         Acl aclObj = new Acl();\n-        Access access = new Access();\n         aclObj.registerHandler(access);\n \n         // Add the mixin handlers as well.\n         if (mixinsIn != null) {\n             String[] mixin = StringUtils.split(mixinsIn, \",\");\n             for (int i = 0; i < mixin.length; i++) {\n-                aclObj.registerHandler(StringUtils.trim(mixin[i]));\n+                if (!mixin[i].equals(Access.class.getName())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkxMDY5Mg=="}, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDAxMDg4OnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/common/security/acl/Access.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNToyODozOVrOGv7w0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDo1Njo0NVrOGwjj4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkxNTQxMA==", "bodyText": "I expect that we will be moving all the *Manager classes used in this class to the constructor as well and will modify the needed static methods from them. Do we have a strategy here that we will follow or will it be just Adhoc like we did it here for ClusterManager?\nOn a side note: One thing that looks odd or not so good is passing null in the constructor of Access at so many places in Test*  just to satisfy the signature.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452915410", "createdAt": "2020-07-10T15:28:39Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/common/security/acl/Access.java", "diffHunk": "@@ -51,12 +51,14 @@\n public class Access extends BaseHandler {\n \n     protected static final Logger LOG = Logger.getLogger(Access.class);\n+    private final ClusterManager clusterManager;\n \n     /**\n      * Constructor for Access object\n+     * @param clusterManagerIn\n      */\n-    public Access() {\n-        super();\n+    public Access(ClusterManager clusterManagerIn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU2NzQ1Nw==", "bodyText": "I expect that we will be moving all the *Manager classes used in this class to the constructor as well and will modify the needed static methods from them.\nDo we have a strategy here that we will follow or will it be just Adhoc like we did it here for ClusterManager?\n\nYes that the plan. The current goal was still on removing all global references to SaltService/SystemQuery/SaltApi.\nSo the strategy is use is to go top down and refactor everything needed to get rid of a particular global reference and try to mostly ignore anything else.\n\nOn a side note: One thing that looks odd or not so good is passing null in the constructor of Access at so many places in Test* just to satisfy the signature.\n\nI know. i think i will fix that now. I just did that to safe time because its obvious that ClusterManager is rarely even used by Access.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453567457", "createdAt": "2020-07-13T10:56:45Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/common/security/acl/Access.java", "diffHunk": "@@ -51,12 +51,14 @@\n public class Access extends BaseHandler {\n \n     protected static final Logger LOG = Logger.getLogger(Access.class);\n+    private final ClusterManager clusterManager;\n \n     /**\n      * Constructor for Access object\n+     * @param clusterManagerIn\n      */\n-    public Access() {\n-        super();\n+    public Access(ClusterManager clusterManagerIn) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkxNTQxMA=="}, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDA2MzcwOnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/formula/FormulaHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTo0NDoxOVrOGv8SyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTo0NDoxOVrOGv8SyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkyNDEwNQ==", "bodyText": "Nitpick: maybe return the result directly.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452924105", "createdAt": "2020-07-10T15:44:19Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/formula/FormulaHandler.java", "diffHunk": "@@ -210,8 +210,8 @@ public int setFormulasOfServer(User loggedInUser, Integer systemId,\n      * @xmlrpc.returntype struct with saved formula data\n      */\n     public Map<String, Object> getSystemFormulaData(User loggedInUser, Integer systemId, String formulaName) {\n-        FormulaManager manager = FormulaManager.getInstance();\n-        Map<String, Object> savedData = manager.getSystemFormulaData(loggedInUser, formulaName, systemId.longValue());\n+        Map<String, Object> savedData = formulaManager\n+                .getSystemFormulaData(loggedInUser, formulaName, systemId.longValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDE0NjY2OnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/manager/org/MigrationManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjowODozNlrOGv9G7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoxNjo0OFrOGwqkzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzNzQ1Mg==", "bodyText": "Nitpick: If we are using it only once, maybe inline it and directly use GlobalInstanceHolder.SERVER_GROUP_MANAGER", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452937452", "createdAt": "2020-07-10T16:08:36Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/manager/org/MigrationManager.java", "diffHunk": "@@ -130,11 +133,10 @@ public static void removeOrgRelationships(User user, Server server) {\n         SystemManager.unsubscribeServerFromChannel(server, server.getBaseChannel());\n \n         // Remove from all system groups:\n-        ServerGroupManager manager = ServerGroupManager.getInstance();\n         for (ManagedServerGroup group : server.getManagedGroups()) {\n             List<Server> tempList = new LinkedList<Server>();\n             tempList.add(server);\n-            manager.removeServers(group, tempList);\n+            SERVER_GROUP_MANAGER.removeServers(group, tempList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MjM4Mw==", "bodyText": "I did this as an in between step since those classes should also be refactored at some point. The other reason was to keep references to GlobalInstanceHolder.* to a minimum so the find usage dialog in intellij is easier to work with.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453682383", "createdAt": "2020-07-13T14:16:48Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/manager/org/MigrationManager.java", "diffHunk": "@@ -130,11 +133,10 @@ public static void removeOrgRelationships(User user, Server server) {\n         SystemManager.unsubscribeServerFromChannel(server, server.getBaseChannel());\n \n         // Remove from all system groups:\n-        ServerGroupManager manager = ServerGroupManager.getInstance();\n         for (ManagedServerGroup group : server.getManagedGroups()) {\n             List<Server> tempList = new LinkedList<Server>();\n             tempList.add(server);\n-            manager.removeServers(group, tempList);\n+            SERVER_GROUP_MANAGER.removeServers(group, tempList);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzNzQ1Mg=="}, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDE0OTg3OnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/manager/recurringactions/RecurringActionManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjowOTo0MVrOGv9JEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjowOTo0MVrOGv9JEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzODAwMw==", "bodyText": "Same as above...directly use GlobalInstanceHolder.SERVER_GROUP_MANAGER", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452938003", "createdAt": "2020-07-10T16:09:41Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/manager/recurringactions/RecurringActionManager.java", "diffHunk": "@@ -157,13 +159,12 @@ private static OrgRecurringAction createOrgRecurringAction(long orgId, User user\n      * @return list of group recurring actions\n      */\n     public static List<GroupRecurringAction> listGroupRecurringActions(long groupId, User user) {\n-        ServerGroupManager groupManager = ServerGroupManager.getInstance();\n         if (!user.hasRole(RoleFactory.SYSTEM_GROUP_ADMIN)) {\n             throw new PermissionException(String.format(\"User does not have access to group id %d\", groupId));\n         }\n         try {\n             /* Check if user has permission to access the group */\n-            groupManager.lookup(groupId, user);\n+            SERVER_GROUP_MANAGER.lookup(groupId, user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDE1NDg4OnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/manager/user/UserManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjoxMToxMlrOGv9MTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjoxMToxMlrOGv9MTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzODgzMA==", "bodyText": "same as above", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452938830", "createdAt": "2020-07-10T16:11:12Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/manager/user/UserManager.java", "diffHunk": "@@ -922,7 +925,7 @@ public static DataResult usersInSet(User user, String label, PageControl pc) {\n     public static boolean canAdministerSystemGroup(User user, ManagedServerGroup group) {\n         return (user != null &&\n                 group != null &&\n-                ServerGroupManager.getInstance().canAccess(user, group) &&\n+                SERVER_GROUP_MANAGER.canAccess(user, group) &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDE3MDkzOnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/taskomatic/task/sshpush/test/SSHPushWorkerSaltTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjoxNjoxOVrOGv9Wdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoxODowOVrOGwqohA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk0MTQzMA==", "bodyText": "This looks funny :)", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452941430", "createdAt": "2020-07-10T16:16:19Z", "author": {"login": "admd"}, "path": "java/code/src/com/redhat/rhn/taskomatic/task/sshpush/test/SSHPushWorkerSaltTest.java", "diffHunk": "@@ -240,7 +247,7 @@ public void testSystemIsRebooting() throws Exception {\n             }\n         };\n \n-        SSHPushWorkerSalt worker = successWorker(systemQuery);\n+        SSHPushWorkerSalt worker = successWorker(saltService, saltService);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MzMzMg==", "bodyText": "yeah it weird until we split the implementation of SystemQuery and SaltApi so they are not implemented by the same class.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453683332", "createdAt": "2020-07-13T14:18:09Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/taskomatic/task/sshpush/test/SSHPushWorkerSaltTest.java", "diffHunk": "@@ -240,7 +247,7 @@ public void testSystemIsRebooting() throws Exception {\n             }\n         };\n \n-        SSHPushWorkerSalt worker = successWorker(systemQuery);\n+        SSHPushWorkerSalt worker = successWorker(saltService, saltService);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk0MTQzMA=="}, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDQ5NzY2OnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/frontend/action/token/groups/AddGroupsAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxODowNDoyNVrOGwAkjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMjoxNToxOVrOGwl7Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk5NDE4OA==", "bodyText": "Since GlobalInstanceHolder.SERVER_GROUP_MANAGER is static and the class field sgm is not passed as contructor argument, should sgm variable changed to static and avoid get it again in this method?", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452994188", "createdAt": "2020-07-10T18:04:25Z", "author": {"login": "rjmateus"}, "path": "java/code/src/com/redhat/rhn/frontend/action/token/groups/AddGroupsAction.java", "diffHunk": "@@ -95,7 +97,7 @@ public ActionForward handleDispatch(ListSessionSetHelper helper,\n      * @param groups list of server groups\n      */\n     static void setupAccessMap(RequestContext context, List<ManagedServerGroup> groups) {\n-        ServerGroupManager sgm = ServerGroupManager.getInstance();\n+        ServerGroupManager sgm = GlobalInstanceHolder.SERVER_GROUP_MANAGER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYwNjI0Nw==", "bodyText": "Yeah i was thinking about that. But i think setupAccessMap is the problem. It makes it so one action class is used like a utility class by another one which seems arbitrary. It would be better to move this method into a Utility class at some point but i left it out of this PR.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453606247", "createdAt": "2020-07-13T12:15:19Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/frontend/action/token/groups/AddGroupsAction.java", "diffHunk": "@@ -95,7 +97,7 @@ public ActionForward handleDispatch(ListSessionSetHelper helper,\n      * @param groups list of server groups\n      */\n     static void setupAccessMap(RequestContext context, List<ManagedServerGroup> groups) {\n-        ServerGroupManager sgm = ServerGroupManager.getInstance();\n+        ServerGroupManager sgm = GlobalInstanceHolder.SERVER_GROUP_MANAGER;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk5NDE4OA=="}, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDUyMzYxOnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/manager/acl/AclManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxODoxMzoxN1rOGwA00g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMjoxODowOVrOGwmBUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk5ODM1NA==", "bodyText": "since is static, var name should be upcase?", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r452998354", "createdAt": "2020-07-10T18:13:17Z", "author": {"login": "rjmateus"}, "path": "java/code/src/com/redhat/rhn/manager/acl/AclManager.java", "diffHunk": "@@ -30,6 +31,8 @@\n  */\n public class AclManager {\n \n+    private static AclFactory aclFactory = GlobalInstanceHolder.ACL_FACTORY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYwNzc2Mw==", "bodyText": "yeah kind of. I forgot the final here so checkstyle did not tell me. Will fix it \ud83d\udc4d", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453607763", "createdAt": "2020-07-13T12:18:09Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/manager/acl/AclManager.java", "diffHunk": "@@ -30,6 +31,8 @@\n  */\n public class AclManager {\n \n+    private static AclFactory aclFactory = GlobalInstanceHolder.ACL_FACTORY;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk5ODM1NA=="}, "originalCommit": {"oid": "0250c77ea9def19e9d8404b2d98fa20520003c73"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyODUwMzk4OnYy", "diffSide": "RIGHT", "path": "java/code/src/com/redhat/rhn/domain/server/test/ServerFactoryTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwOTo1Njo1N1rOGwhkPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMjozMDoyN1rOGwmaYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzNDc4MA==", "bodyText": "I was wondering here: even if you keep an instance of ServerGroupManager above (private serverGroupManager), why are you using GlobalInstanceHolder.SERVER_GROUP_MANAGER and assign it to another variable? Couldn't you just use the above instance?", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453534780", "createdAt": "2020-07-13T09:56:57Z", "author": {"login": "renner"}, "path": "java/code/src/com/redhat/rhn/domain/server/test/ServerFactoryTest.java", "diffHunk": "@@ -254,7 +273,7 @@ public void testServerGroups() throws Exception {\n \n         Collection servers = new ArrayList();\n         servers.add(server);\n-        ServerGroupManager manager = ServerGroupManager.getInstance();\n+        ServerGroupManager manager = GlobalInstanceHolder.SERVER_GROUP_MANAGER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d02b8e5b3364e71084c7603f6449fc01270c5333"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYxNDE3OA==", "bodyText": "Yeah you are right. ServerGroupManager in tests is mostly just automatic refactoring and i have not gone over all cases and checked if they could be simplified more. I will check those now since it came up multiple times in this review already.", "url": "https://github.com/uyuni-project/uyuni/pull/2357#discussion_r453614178", "createdAt": "2020-07-13T12:30:27Z", "author": {"login": "lucidd"}, "path": "java/code/src/com/redhat/rhn/domain/server/test/ServerFactoryTest.java", "diffHunk": "@@ -254,7 +273,7 @@ public void testServerGroups() throws Exception {\n \n         Collection servers = new ArrayList();\n         servers.add(server);\n-        ServerGroupManager manager = ServerGroupManager.getInstance();\n+        ServerGroupManager manager = GlobalInstanceHolder.SERVER_GROUP_MANAGER;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzNDc4MA=="}, "originalCommit": {"oid": "d02b8e5b3364e71084c7603f6449fc01270c5333"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4218, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}