{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MTkwOTUx", "number": 2451, "title": "Maintenance Windows fix assigning schedules to systems", "bodyText": "What does this PR change?\nFixes a couple of issues that occurred when assigning schedules to systems using the default Fail reschedule\nstrategy.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: Just bugfixes\n\n\n DONE\n\n\nTest coverage\n\n\nNo tests: add explanation\n\n\n DONE\n\n\nLinks\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-07-27T14:12:27Z", "url": "https://github.com/uyuni-project/uyuni/pull/2451", "merged": true, "mergeCommit": {"oid": "b7f2d1e67dc50fa56610fa1efcada5f94e8a6bd3"}, "closed": true, "closedAt": "2020-07-28T10:28:03Z", "author": {"login": "parlt91"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5AxiAAH2gAyNDU3MTkwOTUxOjMwZDM1YTQ1OWEzMjZhNzZhMTZkYjMzMzZiZDhlOGIyNDhjNzhiNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5TeAOAFqTQ1NjQ4NDg1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30d35a459a326a76a16db3336bd8e8b248c78b43", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/30d35a459a326a76a16db3336bd8e8b248c78b43", "committedDate": "2020-07-27T12:13:52Z", "message": "Move maintenance window related code to the end of the function\n\nIf `Fail` is selected as the reschedule strategy and there is actions\ninside of the maintenance windows of selected schedule, changing the\nschedule fails and a db rollback occurs.\nThis rollback also affect querying the `BaseEntitlement` of the system\nwhich causes an internal server error.\nMoving the maintenance window related code to the end of the\n`processSubmission` call ensures that the rollback occurs after any\nother db interactions.\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26e9f44d93fb134708a1a7b7f7ca96d163311d62", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/26e9f44d93fb134708a1a7b7f7ca96d163311d62", "committedDate": "2020-07-27T13:15:58Z", "message": "Don't fail rescheduling if list of affected actions is empty\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd35cbc037c7aa4f1d5f8fc4d9c0b44a37f75c0a", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/dd35cbc037c7aa4f1d5f8fc4d9c0b44a37f75c0a", "committedDate": "2020-07-27T13:31:05Z", "message": "Set default strategy to `Fail` if none is given\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1ODIzNTkx", "url": "https://github.com/uyuni-project/uyuni/pull/2451#pullrequestreview-455823591", "createdAt": "2020-07-27T14:16:01Z", "commit": {"oid": "0e1acff4ebe446b26bf4f824ed29f26a0da97242"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNDoxNjowMVrOG3kdOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNDoxNjowMVrOG3kdOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkyMjE2OA==", "bodyText": "I renamed this one to be consistent with CancelRescheduleStrategy", "url": "https://github.com/uyuni-project/uyuni/pull/2451#discussion_r460922168", "createdAt": "2020-07-27T14:16:01Z", "author": {"login": "parlt91"}, "path": "java/code/src/com/suse/manager/maintenance/rescheduling/FailRescheduleStrategy.java", "diffHunk": "@@ -32,9 +32,15 @@\n     private static final Logger LOG = Logger.getLogger(CancelRescheduleStrategy.class);\n \n     @Override\n-    public RescheduleResult reschedule(User user, Map<Action, List<Server>> actionServer,\n+    public RescheduleResult reschedule(User user, Map<Action, List<Server>> actionsServers,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1acff4ebe446b26bf4f824ed29f26a0da97242"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aae3a9eaac99a5a8d37739e1d20a08f9a0e840d", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5aae3a9eaac99a5a8d37739e1d20a08f9a0e840d", "committedDate": "2020-07-27T14:26:59Z", "message": "Correctly pass error message from backend\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e1acff4ebe446b26bf4f824ed29f26a0da97242", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0e1acff4ebe446b26bf4f824ed29f26a0da97242", "committedDate": "2020-07-27T14:02:52Z", "message": "Correctly pass error message from backend\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}, "afterCommit": {"oid": "5aae3a9eaac99a5a8d37739e1d20a08f9a0e840d", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5aae3a9eaac99a5a8d37739e1d20a08f9a0e840d", "committedDate": "2020-07-27T14:26:59Z", "message": "Correctly pass error message from backend\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1ODczODA4", "url": "https://github.com/uyuni-project/uyuni/pull/2451#pullrequestreview-455873808", "createdAt": "2020-07-27T15:07:56Z", "commit": {"oid": "5aae3a9eaac99a5a8d37739e1d20a08f9a0e840d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNTowNzo1N1rOG3m05w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNTowNzo1N1rOG3m05w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk2MDk5OQ==", "bodyText": "Would it be possible to test this case in a unit test?", "url": "https://github.com/uyuni-project/uyuni/pull/2451#discussion_r460960999", "createdAt": "2020-07-27T15:07:57Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/suse/manager/maintenance/rescheduling/FailRescheduleStrategy.java", "diffHunk": "@@ -32,9 +32,15 @@\n     private static final Logger LOG = Logger.getLogger(CancelRescheduleStrategy.class);\n \n     @Override\n-    public RescheduleResult reschedule(User user, Map<Action, List<Server>> actionServer,\n+    public RescheduleResult reschedule(User user, Map<Action, List<Server>> actionsServers,\n             MaintenanceSchedule schedule) throws RescheduleException {\n \n+        if (actionsServers.isEmpty()) {\n+            RescheduleResult result = new RescheduleResult(getType().getLabel(), schedule.getName(), actionsServers);\n+            result.setSuccess(true);\n+            return  result;\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aae3a9eaac99a5a8d37739e1d20a08f9a0e840d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7165d75b88e4b74e60723e3079668cdab8c7d57a", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7165d75b88e4b74e60723e3079668cdab8c7d57a", "committedDate": "2020-07-28T08:48:41Z", "message": "Adapt test to assign schedules to systems to use actual data\n\nUsing the 'FAIL' strategy:\nMaintenance window affected actions scheduled outside a maintenance\nwindow should cause the reschedule to fail.\nActions scheduled inside should allow assigning the schedule.\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "afac8c0c9fb6fa0bf3d6c8492c78ea4d9e7cffae", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/afac8c0c9fb6fa0bf3d6c8492c78ea4d9e7cffae", "committedDate": "2020-07-28T08:41:45Z", "message": "Adapt test to assign schedules to systems to use actual data\n\nUsing the 'FAIL' strategy:\nMaintenance window affected actions scheduled outside a maintenance\nwindow should cause the reschedule to fail.\nActions scheduled inside should allow assigning the schedule.\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}, "afterCommit": {"oid": "7165d75b88e4b74e60723e3079668cdab8c7d57a", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7165d75b88e4b74e60723e3079668cdab8c7d57a", "committedDate": "2020-07-28T08:48:41Z", "message": "Adapt test to assign schedules to systems to use actual data\n\nUsing the 'FAIL' strategy:\nMaintenance window affected actions scheduled outside a maintenance\nwindow should cause the reschedule to fail.\nActions scheduled inside should allow assigning the schedule.\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61c95a9fef1dac059ad936cb6d0bf58a9bea915c", "author": {"user": {"login": "parlt91", "name": "Pascal Arlt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/61c95a9fef1dac059ad936cb6d0bf58a9bea915c", "committedDate": "2020-07-28T09:37:31Z", "message": "Set earliest to first maintenanceWindow item instead of Time.now()\n\nOnly if the system has a maintenance schedule assigned.\n\nSigned-off-by: Pascal Arlt <parlt@suse.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NDg0ODUz", "url": "https://github.com/uyuni-project/uyuni/pull/2451#pullrequestreview-456484853", "createdAt": "2020-07-28T10:00:44Z", "commit": {"oid": "61c95a9fef1dac059ad936cb6d0bf58a9bea915c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1241, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}