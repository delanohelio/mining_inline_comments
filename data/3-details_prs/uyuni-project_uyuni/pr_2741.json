{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MDc3NjAx", "number": 2741, "title": "Remove virtpoller beacon", "bodyText": "What does this PR change?\nThis pull request removes the virtpoller beacon and replaces it with a button in the UI triggering a refresh of the database using Salt virt.vm_info output.\nImportant implementation notes for reviewers:\n\nThe virtualization host type is not refresh as it was using virtpoller: I expect this is done by the hardware refresh action already\nThe VM virtualization type isn't provided by virt.vm_info yet. To avoid getting the XML definition of each VM (one Salt call each), this is left as the default (Para-virtualized). This may be changed later by enhancing the Salt virt.vm_info output.\nIn order to properly refresh the UI, the refresh websocket notification is send after each VM creation, removal or update rahter than after applying the whole plan. This has the advantage to ensure that the UI got at least one event after the DB has been committed, but increases the number of reloading of the whole VMs list. This may turn into a scalability issue if the virtual host has too many VMs defined on it.\n\nGUI diff\nThe blue Synchronize button in this screenshot has been added:\n\n\n DONE\n\nDocumentation\n\n\nDocumentation issue was created: TBD\n\n\n DONE\n\n\nTest coverage\n\n\nUnit tests were added\n\n\nCucumber tests were updated\n\n\n DONE\n\n\nLinks\nFixes SUSE/spacewalk#12698\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-10-22T07:23:12Z", "url": "https://github.com/uyuni-project/uyuni/pull/2741", "merged": true, "mergeCommit": {"oid": "336919d5e3e13d89e9d5c68dff5fa9c2b3c743b1"}, "closed": true, "closedAt": "2020-12-08T10:20:25Z", "author": {"login": "cbosdo"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVDPxLgBqjM5MDk1NTYzNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj3maNgBqjQwODAzNDI4NDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "924e7889b72c93e4f93cdb320d497e68ce4a4bfb", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/924e7889b72c93e4f93cdb320d497e68ce4a4bfb", "committedDate": "2020-10-22T07:12:43Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}, "afterCommit": {"oid": "0b9eab47c84f5ce68aeb7e0b902aeff19f5331d8", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0b9eab47c84f5ce68aeb7e0b902aeff19f5331d8", "committedDate": "2020-10-22T12:42:16Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b9eab47c84f5ce68aeb7e0b902aeff19f5331d8", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0b9eab47c84f5ce68aeb7e0b902aeff19f5331d8", "committedDate": "2020-10-22T12:42:16Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}, "afterCommit": {"oid": "b684ab4b7adf0577e54210d554eb485d712635ba", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b684ab4b7adf0577e54210d554eb485d712635ba", "committedDate": "2020-10-22T16:52:00Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b684ab4b7adf0577e54210d554eb485d712635ba", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b684ab4b7adf0577e54210d554eb485d712635ba", "committedDate": "2020-10-22T16:52:00Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}, "afterCommit": {"oid": "dc3f7aef8301a9d936281f61bc82d855b9a1cf47", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/dc3f7aef8301a9d936281f61bc82d855b9a1cf47", "committedDate": "2020-10-23T09:58:46Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NjI4NDg5", "url": "https://github.com/uyuni-project/uyuni/pull/2741#pullrequestreview-536628489", "createdAt": "2020-11-23T16:14:08Z", "commit": {"oid": "dc3f7aef8301a9d936281f61bc82d855b9a1cf47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc3f7aef8301a9d936281f61bc82d855b9a1cf47", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/dc3f7aef8301a9d936281f61bc82d855b9a1cf47", "committedDate": "2020-10-23T09:58:46Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}, "afterCommit": {"oid": "6982f17ddfa543eca29686ebecb861e6ec4a8282", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6982f17ddfa543eca29686ebecb861e6ec4a8282", "committedDate": "2020-11-24T08:27:45Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MjQ0ODM0", "url": "https://github.com/uyuni-project/uyuni/pull/2741#pullrequestreview-537244834", "createdAt": "2020-11-24T08:46:06Z", "commit": {"oid": "6982f17ddfa543eca29686ebecb861e6ec4a8282"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODo0NjowNlrOH4xz8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODo0OTozMlrOH4x8Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5ODQxOQ==", "bodyText": "empty end line missing", "url": "https://github.com/uyuni-project/uyuni/pull/2741#discussion_r529298419", "createdAt": "2020-11-24T08:46:06Z", "author": {"login": "ncounter"}, "path": "java/code/src/com/suse/manager/virtualization/test/virt.vm_info.all.json", "diffHunk": "@@ -0,0 +1,108 @@\n+{\n+  \"vm01\": {\n+    \"cpu\": 2,\n+    \"cputime\": 0,\n+    \"disks\": {\n+      \"vda\": {\n+        \"file\": \"/srv/vms/sles12sp2.qcow2\",\n+        \"type\": \"disk\",\n+        \"file format\": \"qcow2\",\n+        \"disk size\": 350658560,\n+        \"virtual size\": 214748364800,\n+        \"cluster size\": 65536\n+      },\n+      \"vdb\": {\n+        \"file\": \"ses-pool/test-vol\",\n+        \"type\": \"disk\",\n+        \"file format\": \"raw\"\n+      }\n+    },\n+    \"graphics\": {\n+      \"autoport\": \"yes\",\n+      \"keymap\": \"None\",\n+      \"listen\": \"127.0.0.1\",\n+      \"port\": \"None\",\n+      \"type\": \"spice\"\n+    },\n+    \"nics\": {\n+      \"52:54:00:b3:0e:ea\": {\n+        \"type\": \"network\",\n+        \"mac\": \"52:54:00:b3:0e:ea\",\n+        \"source\": {\n+          \"network\": \"default\"\n+        },\n+        \"model\": \"rtl8139\",\n+        \"address\": {\n+          \"type\": \"pci\",\n+          \"domain\": \"0x0000\",\n+          \"bus\": \"0x00\",\n+          \"slot\": \"0x03\",\n+          \"function\": \"0x0\"\n+        }\n+      }\n+    },\n+    \"uuid\": \"b99a8176-4f40-498d-8e61-2f6ade654fe2\",\n+    \"loader\": {\n+      \"path\": \"None\"\n+    },\n+    \"on_crash\": \"restart\",\n+    \"on_reboot\": \"restart\",\n+    \"on_poweroff\": \"destroy\",\n+    \"maxMem\": 1048576,\n+    \"mem\": 1048576,\n+    \"state\": \"shutdown\"\n+  },\n+  \"vm02\": {\n+    \"cpu\": 12,\n+    \"cputime\": 0,\n+    \"disks\": {\n+      \"vda\": {\n+        \"file\": \"/srv/vms/sles12sp2.qcow2\",\n+        \"type\": \"disk\",\n+        \"file format\": \"qcow2\",\n+        \"disk size\": 350658560,\n+        \"virtual size\": 214748364800,\n+        \"cluster size\": 65536\n+      },\n+      \"vdb\": {\n+        \"file\": \"ses-pool/test-vol\",\n+        \"type\": \"disk\",\n+        \"file format\": \"raw\"\n+      }\n+    },\n+    \"graphics\": {\n+      \"autoport\": \"yes\",\n+      \"keymap\": \"None\",\n+      \"listen\": \"127.0.0.1\",\n+      \"port\": \"None\",\n+      \"type\": \"spice\"\n+    },\n+    \"nics\": {\n+      \"52:54:00:b3:0e:ea\": {\n+        \"type\": \"network\",\n+        \"mac\": \"52:54:00:b3:0e:ea\",\n+        \"source\": {\n+          \"network\": \"default\"\n+        },\n+        \"model\": \"rtl8139\",\n+        \"address\": {\n+          \"type\": \"pci\",\n+          \"domain\": \"0x0000\",\n+          \"bus\": \"0x00\",\n+          \"slot\": \"0x03\",\n+          \"function\": \"0x0\"\n+        }\n+      }\n+    },\n+    \"uuid\": \"98eef4f7-eb7f-4be8-859d-11658506c496\",\n+    \"loader\": {\n+      \"path\": \"None\"\n+    },\n+    \"on_crash\": \"restart\",\n+    \"on_reboot\": \"restart\",\n+    \"on_poweroff\": \"destroy\",\n+    \"maxMem\": 2097152,\n+    \"mem\": 1048576,\n+    \"state\": \"running\"\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6982f17ddfa543eca29686ebecb861e6ec4a8282"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5ODc5Nw==", "bodyText": "you can keep it all in one line, we can go up to 140 characters IIRC \ud83d\ude09", "url": "https://github.com/uyuni-project/uyuni/pull/2741#discussion_r529298797", "createdAt": "2020-11-24T08:46:42Z", "author": {"login": "ncounter"}, "path": "java/code/src/com/suse/manager/webui/controllers/virtualization/VirtualGuestsController.java", "diffHunk": "@@ -132,6 +134,8 @@ public void initRoutes(JadeTemplateEngine jade) {\n                 withUserPreferences(withCsrfToken(withDocsLocale(withUser(this::console)))), jade);\n         get(\"/manager/api/systems/details/virtualization/guests/:sid/data\",\n                 withUser(this::data));\n+        post(\"/manager/api/systems/details/virtualization/guests/:sid/refresh\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6982f17ddfa543eca29686ebecb861e6ec4a8282"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwMDU1NA==", "bodyText": "Why do you need to return a String instead of the Boolean value of the isPresent()?", "url": "https://github.com/uyuni-project/uyuni/pull/2741#discussion_r529300554", "createdAt": "2020-11-24T08:49:32Z", "author": {"login": "ncounter"}, "path": "java/code/src/com/suse/manager/webui/controllers/virtualization/VirtualGuestsController.java", "diffHunk": "@@ -423,6 +427,23 @@ public ModelAndView console(Request request, Response response, User user) {\n         return renderPage(request, response, user, \"console\", () -> data);\n     }\n \n+    /**\n+     * Refresh the database with the actual list of virtual machines from the host\n+     *\n+     * @param request the request\n+     * @param response the response\n+     * @param user the user\n+     * @return JSON result of the API call\n+     */\n+    public String refresh(Request request, Response response, User user) {\n+        Server host = getServer(request, user);\n+        VirtualInstanceManager.updateHostVirtualInstance(host,\n+                VirtualInstanceFactory.getInstance().getFullyVirtType());\n+        Optional<List<VmInfo>> plan = virtManager.getGuestsUpdatePlan(host.getMinionId());\n+        plan.ifPresent(updatePlan -> VirtualInstanceManager.updateGuestsVirtualInstances(host, updatePlan));\n+        return plan.isPresent() ? \"Done\" : \"Failed\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6982f17ddfa543eca29686ebecb861e6ec4a8282"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6982f17ddfa543eca29686ebecb861e6ec4a8282", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6982f17ddfa543eca29686ebecb861e6ec4a8282", "committedDate": "2020-11-24T08:27:45Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}, "afterCommit": {"oid": "45e327be522bd37479f1071c753705e218f0d0a9", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/45e327be522bd37479f1071c753705e218f0d0a9", "committedDate": "2020-11-24T10:14:29Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45e327be522bd37479f1071c753705e218f0d0a9", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/45e327be522bd37479f1071c753705e218f0d0a9", "committedDate": "2020-11-24T10:14:29Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}, "afterCommit": {"oid": "59da48d6684293476f54da3f6a436baceb6bda41", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/59da48d6684293476f54da3f6a436baceb6bda41", "committedDate": "2020-11-24T10:16:20Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59da48d6684293476f54da3f6a436baceb6bda41", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/59da48d6684293476f54da3f6a436baceb6bda41", "committedDate": "2020-11-24T10:16:20Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}, "afterCommit": {"oid": "180ca91f7f9b5e98a89ec76b1e712598911b1c7d", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/180ca91f7f9b5e98a89ec76b1e712598911b1c7d", "committedDate": "2020-11-24T10:26:33Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7206f4b837551470dd3e2fd701af7e3e178615d4", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7206f4b837551470dd3e2fd701af7e3e178615d4", "committedDate": "2020-12-07T15:50:29Z", "message": "Remove the virtpoller beacon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d7220087e690bdff8275f751054c752268a2f01", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6d7220087e690bdff8275f751054c752268a2f01", "committedDate": "2020-12-07T15:50:52Z", "message": "Add VM refresh button\n\nSince the virtpoller beacon is now gone, the user may want to manually\nrefresh the VMs list of a virtual host in case libvirt events were\nmissed. Add an button in the UI for this."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0cad0df5fd0749e2ab38a9b801d7de9d399f6e9", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c0cad0df5fd0749e2ab38a9b801d7de9d399f6e9", "committedDate": "2020-12-07T15:50:54Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "180ca91f7f9b5e98a89ec76b1e712598911b1c7d", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/180ca91f7f9b5e98a89ec76b1e712598911b1c7d", "committedDate": "2020-11-24T10:26:33Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}, "afterCommit": {"oid": "c0cad0df5fd0749e2ab38a9b801d7de9d399f6e9", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c0cad0df5fd0749e2ab38a9b801d7de9d399f6e9", "committedDate": "2020-12-07T15:50:54Z", "message": "Better VM changes notifications in VirtualInstanceManager\n\nSo far VM refresh events where sent only when the plan was applied in\nVirtualInstanceManager. Send the refresh event in the functions actually\nadding / deleting / updating the VM in the database."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 914, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}