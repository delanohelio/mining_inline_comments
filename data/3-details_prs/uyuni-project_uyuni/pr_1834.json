{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NDcxOTEy", "number": 1834, "title": "Fix tests of organization credentials", "bodyText": "What does this PR change?\nOn the organization pages, we can have several organizations. The tests were almost always looking for the first icon (trash bin, star, list), no matter to which organization it would belong. It sometimes triggered race conditions where we would click on the wrong icon.\nThis PR fixes that problem.\nIt also fixes wrong test of existence of credentials in case sumaform sets them to \"|\".\nLinks\nPorts:\n\n4.0: SUSE/spacewalk#10611\n3.2: SUSE/spacewalk#10612\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed", "createdAt": "2020-01-27T12:46:39Z", "url": "https://github.com/uyuni-project/uyuni/pull/1834", "merged": true, "mergeCommit": {"oid": "47c3cf325466dfe9d3caf8280e64639e77f2a246"}, "closed": true, "closedAt": "2020-01-28T10:33:24Z", "author": {"login": "Bischoff"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-ccuWgFqTM0ODY0NjkyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-r3kjgFqTM0OTE2MjYzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NjQ2OTIz", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348646923", "createdAt": "2020-01-27T13:06:57Z", "commit": {"oid": "b64ea928af1f1365f59a4eedcee688eaa94d6ae8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NjUxNDg5", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348651489", "createdAt": "2020-01-27T13:14:55Z", "commit": {"oid": "523606ed1879a564e3676423303e9a904ab3564a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NjY1MjE1", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348665215", "createdAt": "2020-01-27T13:36:57Z", "commit": {"oid": "d5572d718631f2ad428fb6e5255cdb9389efd92c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4Nzk2ODk3", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348796897", "createdAt": "2020-01-27T16:25:54Z", "commit": {"oid": "7b18890575037786847e596b539b3997192e822c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjoyNTo1NVrOFiI9Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjoyNTo1NVrOFiI9Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0MjY0Mw==", "bodyText": "I suggest:\nscc_username, scc_password = ENV['SCC_CREDENTIALS'].split('|')", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371342643", "createdAt": "2020-01-27T16:25:55Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -371,22 +371,71 @@\n \n # setup wizard\n \n-When(/^I make the credentials primary$/) do\n-  raise 'xpath: i.fa-star-o not found' unless find('i.fa-star-o').click\n+Then(/^HTTP proxy verification should have succeeded$/) do\n+  raise 'xpath: i.text-success not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n end\n \n-When(/^I delete the primary credentials$/) do\n-  raise 'xpath: i.fa-trash-o not found' unless find('i.fa-trash-o', match: :first).click\n-  step 'I click on \"Delete\"'\n+When(/^I enter the address of the HTTP proxy as \"([^\"]*)\"/) do |hostname|\n+  step %(I enter \"#{$server_http_proxy}\" as \"#{hostname}\")\n+end\n+\n+When(/^I ask to add new credentials$/) do\n+  raise 'xpath: i.fa-plus-circle not found' unless find('i.fa-plus-circle').click\n+end\n+\n+When(/^I enter the SCC credentials$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b18890575037786847e596b539b3997192e822c"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4Nzk4OTU3", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348798957", "createdAt": "2020-01-27T16:28:27Z", "commit": {"oid": "7b18890575037786847e596b539b3997192e822c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjoyODoyN1rOFiJDPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjoyODoyN1rOFiJDPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NDE5MQ==", "bodyText": "I would say we need to catch raise 'Star icon not found' unless find('i.fa-star-o'), without the click.\nOtherwise, if the element is not found and we try to click, it will raise an exception isn't it?", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371344191", "createdAt": "2020-01-27T16:28:27Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -371,22 +371,71 @@\n \n # setup wizard\n \n-When(/^I make the credentials primary$/) do\n-  raise 'xpath: i.fa-star-o not found' unless find('i.fa-star-o').click\n+Then(/^HTTP proxy verification should have succeeded$/) do\n+  raise 'xpath: i.text-success not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n end\n \n-When(/^I delete the primary credentials$/) do\n-  raise 'xpath: i.fa-trash-o not found' unless find('i.fa-trash-o', match: :first).click\n-  step 'I click on \"Delete\"'\n+When(/^I enter the address of the HTTP proxy as \"([^\"]*)\"/) do |hostname|\n+  step %(I enter \"#{$server_http_proxy}\" as \"#{hostname}\")\n+end\n+\n+When(/^I ask to add new credentials$/) do\n+  raise 'xpath: i.fa-plus-circle not found' unless find('i.fa-plus-circle').click\n+end\n+\n+When(/^I enter the SCC credentials$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]\n+  steps %(\n+    And I enter \"#{scc_username}\" as \"edit-user\"\n+    And I enter \"#{scc_password}\" as \"edit-password\"\n+  )\n+end\n+\n+Then(/^the SCC credentials should be valid$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]\n+  within(:xpath, \"//h3[contains(text(), '#{scc_username}')]/../..\") do\n+    raise 'Valid icon not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n+  end\n+end\n+\n+Then(/^the credentials for \"([^\"]*)\" should be invalid$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Invalid icon not found' unless find('i.text-danger', wait: DEFAULT_TIMEOUT)\n+  end\n+end\n+\n+When(/^I make the credentials for \"([^\"]*)\" primary$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Star icon not found' unless find('i.fa-star-o').click", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b18890575037786847e596b539b3997192e822c"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODAxMzUx", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348801351", "createdAt": "2020-01-27T16:31:22Z", "commit": {"oid": "7b18890575037786847e596b539b3997192e822c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjozMToyMlrOFiJKMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjozMToyMlrOFiJKMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NTk2OA==", "bodyText": "We don't need to add the sleep method, the find will already have its default timeout.\nUhmmm in fact, what we can think to do here is to get rid of the repeat_until_timeout method, just taking the power of capybara and its wait parameter in find method. To make it work, instead of looking for 'i.fa-trash-o' you will need to create a xpath that includes the style also, and the desired \"not-allowed\" value", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371345968", "createdAt": "2020-01-27T16:31:22Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -371,22 +371,71 @@\n \n # setup wizard\n \n-When(/^I make the credentials primary$/) do\n-  raise 'xpath: i.fa-star-o not found' unless find('i.fa-star-o').click\n+Then(/^HTTP proxy verification should have succeeded$/) do\n+  raise 'xpath: i.text-success not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n end\n \n-When(/^I delete the primary credentials$/) do\n-  raise 'xpath: i.fa-trash-o not found' unless find('i.fa-trash-o', match: :first).click\n-  step 'I click on \"Delete\"'\n+When(/^I enter the address of the HTTP proxy as \"([^\"]*)\"/) do |hostname|\n+  step %(I enter \"#{$server_http_proxy}\" as \"#{hostname}\")\n+end\n+\n+When(/^I ask to add new credentials$/) do\n+  raise 'xpath: i.fa-plus-circle not found' unless find('i.fa-plus-circle').click\n+end\n+\n+When(/^I enter the SCC credentials$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]\n+  steps %(\n+    And I enter \"#{scc_username}\" as \"edit-user\"\n+    And I enter \"#{scc_password}\" as \"edit-password\"\n+  )\n+end\n+\n+Then(/^the SCC credentials should be valid$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]\n+  within(:xpath, \"//h3[contains(text(), '#{scc_username}')]/../..\") do\n+    raise 'Valid icon not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n+  end\n+end\n+\n+Then(/^the credentials for \"([^\"]*)\" should be invalid$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Invalid icon not found' unless find('i.text-danger', wait: DEFAULT_TIMEOUT)\n+  end\n+end\n+\n+When(/^I make the credentials for \"([^\"]*)\" primary$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Star icon not found' unless find('i.fa-star-o').click\n+  end\n end\n \n-When(/^I view the primary subscription list$/) do\n-  raise 'xpath: i.fa-th-list not found' unless find('i.fa-th-list', match: :first).click\n+Then(/^the credentials for \"([^\"]*)\" should be primary$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Star icon not selected' unless find('i.fa-star')\n+  end\n+end\n+\n+When(/^I wait for the trash icon to appear for \"([^\"]*)\"$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    repeat_until_timeout(message: 'Trash icon is still greyed out') do\n+      break unless find('i.fa-trash-o')[:style].include? \"not-allowed\"\n+      sleep 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b18890575037786847e596b539b3997192e822c"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODA0MDY1", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348804065", "createdAt": "2020-01-27T16:34:45Z", "commit": {"oid": "7b18890575037786847e596b539b3997192e822c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjozNDo0NVrOFiJR-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjozNDo0NVrOFiJR-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0Nzk2Mw==", "bodyText": "I think we should move that variable outside the method, we can have it with the rest of global variables which retrieves values from ENV", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371347963", "createdAt": "2020-01-27T16:34:45Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/navigation_steps.rb", "diffHunk": "@@ -781,12 +777,14 @@\n \n # Image-specific steps\n When(/^I enter \"([^\"]*)\" relative to profiles as \"([^\"]*)\"$/) do |path, field|\n-  step %(I enter \"#{$git_profiles}/#{path}\" as \"#{field}\")\n+  git_profiles = ENV['GITPROFILES']", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b18890575037786847e596b539b3997192e822c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f69288f0261bc7320ef37e910fa61149a140ae", "author": {"user": {"login": "Bischoff", "name": "E Bischoff"}}, "url": "https://github.com/uyuni-project/uyuni/commit/23f69288f0261bc7320ef37e910fa61149a140ae", "committedDate": "2020-01-27T17:31:59Z", "message": "Fix tests of organization credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "687be61b93536e85f69d1925adf66d0e31f25221", "author": {"user": {"login": "Bischoff", "name": "E Bischoff"}}, "url": "https://github.com/uyuni-project/uyuni/commit/687be61b93536e85f69d1925adf66d0e31f25221", "committedDate": "2020-01-27T17:33:09Z", "message": "Don't run SCC credentials test if they are set to empty strings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODgzNzM1", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348883735", "createdAt": "2020-01-27T18:34:35Z", "commit": {"oid": "687be61b93536e85f69d1925adf66d0e31f25221"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxODozNDozNlrOFiNE1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxODozNDozNlrOFiNE1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxMDEzMw==", "bodyText": "I still confused every time I see DEFAULT_TIMEOUT specified somewhere xD\nBut, yes, it is different from `Capybara.default_max_wait_time = 10``:)", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371410133", "createdAt": "2020-01-27T18:34:36Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -371,22 +371,69 @@\n \n # setup wizard\n \n-When(/^I make the credentials primary$/) do\n-  raise 'xpath: i.fa-star-o not found' unless find('i.fa-star-o').click\n+Then(/^HTTP proxy verification should have succeeded$/) do\n+  raise 'Success icon not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "687be61b93536e85f69d1925adf66d0e31f25221"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODgzOTcz", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-348883973", "createdAt": "2020-01-27T18:35:02Z", "commit": {"oid": "687be61b93536e85f69d1925adf66d0e31f25221"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTYyNjM1", "url": "https://github.com/uyuni-project/uyuni/pull/1834#pullrequestreview-349162635", "createdAt": "2020-01-28T07:04:51Z", "commit": {"oid": "687be61b93536e85f69d1925adf66d0e31f25221"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1751, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}