{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0ODk5MTcw", "number": 2880, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoxNDoyOFrOE8GzvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyOTozNlrOE8HHyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDYxNTY1OnYy", "diffSide": "LEFT", "path": "testsuite/features/support/constants.rb", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoxNDoyOFrOH4CtOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODo1MToxNlrOH4D1qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNjY1MA==", "bodyText": "I don't like the idea to remove these constants.\nI prefer to have outside from a method this information, as it's easier to tweak and handle it.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528526650", "createdAt": "2020-11-23T08:14:28Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/support/constants.rb", "diffHunk": "@@ -197,12 +197,3 @@\n                       'ubuntu1804_minion' => 'x86_64',\n                       'ubuntu2004_ssh_minion' => 'x86_64',\n                       'ubuntu2004_minion' => 'x86_64' }.freeze\n-\n-TRADITIONAL_STACK_RPMS = 'spacewalk-client-tools spacewalk-check spacewalk-client-setup '\\\n-                         'mgr-daemon mgr-osad mgr-cfg-actions'.freeze\n-\n-OPEN_SCAP_CENTOS_DEPS = 'spacewalk-oscap scap-security-guide'.freeze\n-\n-OPEN_SCAP_TRAD_DEPS = 'spacewalk-oscap'.freeze\n-\n-OPEN_SCAP_SALT_DEPS = 'openscap-utils openscap-content scap-security-guide'.freeze", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzAwNQ==", "bodyText": "I knew you would say that. I still don't understand how having things at different places helps. Having them where they are needed avoid me losing overview.\nSaid overwise, a constant (or a method) that is used only once does not really make sense to me.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528533005", "createdAt": "2020-11-23T08:27:41Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/support/constants.rb", "diffHunk": "@@ -197,12 +197,3 @@\n                       'ubuntu1804_minion' => 'x86_64',\n                       'ubuntu2004_ssh_minion' => 'x86_64',\n                       'ubuntu2004_minion' => 'x86_64' }.freeze\n-\n-TRADITIONAL_STACK_RPMS = 'spacewalk-client-tools spacewalk-check spacewalk-client-setup '\\\n-                         'mgr-daemon mgr-osad mgr-cfg-actions'.freeze\n-\n-OPEN_SCAP_CENTOS_DEPS = 'spacewalk-oscap scap-security-guide'.freeze\n-\n-OPEN_SCAP_TRAD_DEPS = 'spacewalk-oscap'.freeze\n-\n-OPEN_SCAP_SALT_DEPS = 'openscap-utils openscap-content scap-security-guide'.freeze", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNjY1MA=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0NTE5Mw==", "bodyText": "That's a lost battle, you will never agree with me in relation to encapsulation and isolation, so... go ahead.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528545193", "createdAt": "2020-11-23T08:51:16Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/support/constants.rb", "diffHunk": "@@ -197,12 +197,3 @@\n                       'ubuntu1804_minion' => 'x86_64',\n                       'ubuntu2004_ssh_minion' => 'x86_64',\n                       'ubuntu2004_minion' => 'x86_64' }.freeze\n-\n-TRADITIONAL_STACK_RPMS = 'spacewalk-client-tools spacewalk-check spacewalk-client-setup '\\\n-                         'mgr-daemon mgr-osad mgr-cfg-actions'.freeze\n-\n-OPEN_SCAP_CENTOS_DEPS = 'spacewalk-oscap scap-security-guide'.freeze\n-\n-OPEN_SCAP_TRAD_DEPS = 'spacewalk-oscap'.freeze\n-\n-OPEN_SCAP_SALT_DEPS = 'openscap-utils openscap-content scap-security-guide'.freeze", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNjY1MA=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDYyMzA1OnYy", "diffSide": "RIGHT", "path": "testsuite/features/step_definitions/common_steps.rb", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoxNjo0NVrOH4CxSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODo0MDozMVrOH4DgCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNzY4OQ==", "bodyText": "I'd prefer if we join these two steps definitions that are doing the same, but with the opposite result", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528527689", "createdAt": "2020-11-23T08:16:45Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -729,6 +729,32 @@\n   end\n end\n \n+When(/^I disable SUSE Manager tools repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    repos, _code = node.run('zypper lr | grep \"tools\" | cut -d\"|\" -f2')\n+    node.run(\"zypper mr --disable #{repos.gsub(/\\s/, ' ')}\")\n+  elsif os_family =~ /^centos/\n+    repos, _code = node.run('yum repolist enabled 2>/dev/null | grep \"tools\" | cut -d\" \" -f1')\n+    repos.gsub(/\\s/, ' ').split.each do |repo|\n+      node.run(\"sed -i 's/enabled=.*/enabled=0/g' /etc/yum.repos.d/#{repo}.repo\")\n+    end\n+  end\n+end\n+\n+When(/^I enable universe repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  node.run(\"sed -i '/^#\\\\s*deb http:\\\\/\\\\/archive.ubuntu.com\\\\/ubuntu .* universe/ s/^#\\\\s*deb /deb /' /etc/apt/sources.list\")\n+  node.run(\"apt-get update\")\n+end\n+\n+When(/^I disable universe repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  node.run(\"sed -i '/^deb http:\\\\/\\\\/archive.ubuntu.com\\\\/ubuntu .* universe/ s/^deb /# deb /' /etc/apt/sources.list\")\n+  node.run(\"apt-get update\")\n+end\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzY5Mg==", "bodyText": "I don't think that helps readability and I prefer it like this. But if you wish to \"fix\" this someday I won't oppose either.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528533692", "createdAt": "2020-11-23T08:29:07Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -729,6 +729,32 @@\n   end\n end\n \n+When(/^I disable SUSE Manager tools repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    repos, _code = node.run('zypper lr | grep \"tools\" | cut -d\"|\" -f2')\n+    node.run(\"zypper mr --disable #{repos.gsub(/\\s/, ' ')}\")\n+  elsif os_family =~ /^centos/\n+    repos, _code = node.run('yum repolist enabled 2>/dev/null | grep \"tools\" | cut -d\" \" -f1')\n+    repos.gsub(/\\s/, ' ').split.each do |repo|\n+      node.run(\"sed -i 's/enabled=.*/enabled=0/g' /etc/yum.repos.d/#{repo}.repo\")\n+    end\n+  end\n+end\n+\n+When(/^I enable universe repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  node.run(\"sed -i '/^#\\\\s*deb http:\\\\/\\\\/archive.ubuntu.com\\\\/ubuntu .* universe/ s/^#\\\\s*deb /deb /' /etc/apt/sources.list\")\n+  node.run(\"apt-get update\")\n+end\n+\n+When(/^I disable universe repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  node.run(\"sed -i '/^deb http:\\\\/\\\\/archive.ubuntu.com\\\\/ubuntu .* universe/ s/^deb /# deb /' /etc/apt/sources.list\")\n+  node.run(\"apt-get update\")\n+end\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNzY4OQ=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzOTY1OQ==", "bodyText": "Using add-apt-repository on Ubuntu20, will be safer and will simplify it in a step.\nIf we use Ubuntu16 or Ubuntu18, we just need to first install software-properties-common", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528539659", "createdAt": "2020-11-23T08:40:31Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -729,6 +729,32 @@\n   end\n end\n \n+When(/^I disable SUSE Manager tools repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    repos, _code = node.run('zypper lr | grep \"tools\" | cut -d\"|\" -f2')\n+    node.run(\"zypper mr --disable #{repos.gsub(/\\s/, ' ')}\")\n+  elsif os_family =~ /^centos/\n+    repos, _code = node.run('yum repolist enabled 2>/dev/null | grep \"tools\" | cut -d\" \" -f1')\n+    repos.gsub(/\\s/, ' ').split.each do |repo|\n+      node.run(\"sed -i 's/enabled=.*/enabled=0/g' /etc/yum.repos.d/#{repo}.repo\")\n+    end\n+  end\n+end\n+\n+When(/^I enable universe repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  node.run(\"sed -i '/^#\\\\s*deb http:\\\\/\\\\/archive.ubuntu.com\\\\/ubuntu .* universe/ s/^#\\\\s*deb /deb /' /etc/apt/sources.list\")\n+  node.run(\"apt-get update\")\n+end\n+\n+When(/^I disable universe repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  node.run(\"sed -i '/^deb http:\\\\/\\\\/archive.ubuntu.com\\\\/ubuntu .* universe/ s/^deb /# deb /' /etc/apt/sources.list\")\n+  node.run(\"apt-get update\")\n+end\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNzY4OQ=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDYzNTg2OnYy", "diffSide": "RIGHT", "path": "testsuite/features/step_definitions/common_steps.rb", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyMDozN1rOH4C4QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODo0NTowNlrOH4DpSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTQ3Mw==", "bodyText": "I hope we never pass Sonarcube in our code, as we are adding a lot of duplicated code :S\nI would also refactor this code in the manner you wish, to don't have two \"step definitions\" doing exactly the same behavior but with the opposite result.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528529473", "createdAt": "2020-11-23T08:20:37Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -729,6 +729,32 @@\n   end\n end\n \n+When(/^I disable SUSE Manager tools repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    repos, _code = node.run('zypper lr | grep \"tools\" | cut -d\"|\" -f2')\n+    node.run(\"zypper mr --disable #{repos.gsub(/\\s/, ' ')}\")\n+  elsif os_family =~ /^centos/\n+    repos, _code = node.run('yum repolist enabled 2>/dev/null | grep \"tools\" | cut -d\" \" -f1')\n+    repos.gsub(/\\s/, ' ').split.each do |repo|\n+      node.run(\"sed -i 's/enabled=.*/enabled=0/g' /etc/yum.repos.d/#{repo}.repo\")\n+    end\n+  end\n+end", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzNDE2Nw==", "bodyText": "Same, feel free to do it. I don't think it helps readability, and strictly speaking it slows down execution a bit, but ok.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528534167", "createdAt": "2020-11-23T08:30:02Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -729,6 +729,32 @@\n   end\n end\n \n+When(/^I disable SUSE Manager tools repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    repos, _code = node.run('zypper lr | grep \"tools\" | cut -d\"|\" -f2')\n+    node.run(\"zypper mr --disable #{repos.gsub(/\\s/, ' ')}\")\n+  elsif os_family =~ /^centos/\n+    repos, _code = node.run('yum repolist enabled 2>/dev/null | grep \"tools\" | cut -d\" \" -f1')\n+    repos.gsub(/\\s/, ' ').split.each do |repo|\n+      node.run(\"sed -i 's/enabled=.*/enabled=0/g' /etc/yum.repos.d/#{repo}.repo\")\n+    end\n+  end\n+end", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTQ3Mw=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0MjAyNw==", "bodyText": "\ud83d\ude06 Really do you feel the time of execution will change more than a microsecond?\nI would prefer we refactor those steps to use both enable/disable options, but I will not go behind other's code refactoring it in another PR...", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528542027", "createdAt": "2020-11-23T08:45:06Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -729,6 +729,32 @@\n   end\n end\n \n+When(/^I disable SUSE Manager tools repositories on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    repos, _code = node.run('zypper lr | grep \"tools\" | cut -d\"|\" -f2')\n+    node.run(\"zypper mr --disable #{repos.gsub(/\\s/, ' ')}\")\n+  elsif os_family =~ /^centos/\n+    repos, _code = node.run('yum repolist enabled 2>/dev/null | grep \"tools\" | cut -d\" \" -f1')\n+    repos.gsub(/\\s/, ' ').split.each do |repo|\n+      node.run(\"sed -i 's/enabled=.*/enabled=0/g' /etc/yum.repos.d/#{repo}.repo\")\n+    end\n+  end\n+end", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTQ3Mw=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDY0ODEwOnYy", "diffSide": "RIGHT", "path": "testsuite/features/step_definitions/command_steps.rb", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyNDoxMFrOH4C_Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODo0ODoyOFrOH4Dv-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMTIxOQ==", "bodyText": "Does it only happen in CentOS7? It doesn't happen on CentOS 8?", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528531219", "createdAt": "2020-11-23T08:24:10Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -771,17 +771,30 @@\n end\n \n When(/^I (install|remove) the traditional stack utils (on|from) \"([^\"]*)\"$/) do |action, where, host|\n-  step %(I #{action} packages \"#{TRADITIONAL_STACK_RPMS}\" #{where} this \"#{host}\")\n+  pkgs = 'spacewalk-client-tools spacewalk-check spacewalk-client-setup mgr-daemon mgr-osad mgr-cfg-actions'\n+  step %(I #{action} packages \"#{pkgs}\" #{where} this \"#{host}\")\n end\n \n-When(/^I (install|remove) OpenSCAP (traditional|salt|centos) dependencies (on|from) \"([^\"]*)\"$/) do |action, client_type, where, host|\n-  if client_type == 'traditional'\n-    step %(I #{action} packages \"#{OPEN_SCAP_TRAD_DEPS}\" #{where} this \"#{host}\")\n-  elsif client_type == 'salt'\n-    step %(I #{action} packages \"#{OPEN_SCAP_SALT_DEPS}\" #{where} this \"#{host}\")\n-  else\n-    step %(I #{action} packages \"#{OPEN_SCAP_CENTOS_DEPS}\" #{where} this \"#{host}\")\n+When(/^I (install|remove) OpenSCAP dependencies (on|from) \"([^\"]*)\"$/) do |action, where, host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    pkgs = 'openscap-utils openscap-content'\n+  elsif os_family =~ /^centos/\n+    pkgs = 'openscap-utils scap-security-guide'\n+  elsif os_family =~ /^ubuntu/\n+    pkgs = 'libopenscap8 ssg-debderived'\n   end\n+  pkgs += ' spacewalk-oscap' if host.include? 'client'\n+  step %(I #{action} packages \"#{pkgs}\" #{where} this \"#{host}\")\n+end\n+\n+# On CentOS 7, OpenSCAP files are for RedHat and need a small adaptation for CentOS\n+When(/^I fix CentOS 7 OpenSCAP files on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  script = '/<\\/rear-matter>/a  <platform idref=\"cpe:/o:centos:centos:7\"/>'\n+  file = \"/usr/share/xml/scap/ssg/content/ssg-rhel7-xccdf.xml\"\n+  node.run(\"sed -i '#{script}' #{file}\")\n end", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzNjA1NA==", "bodyText": "This is an interesting and open question. In the doubt, I took a conservative approach and chose  to use it on CentOS 7 only. We can add it to CentOS 8 too if we see notapplicable there as well.\nI am sure it happens in CentOS 6 because of https://forums.centos.org/viewtopic.php?t=50462 .\nIt also happens in Ubuntu !!! But I did not find the correct fix and gave up after one hour searching. I added a TODO in the code as a way to remember the issue.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528536054", "createdAt": "2020-11-23T08:33:48Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -771,17 +771,30 @@\n end\n \n When(/^I (install|remove) the traditional stack utils (on|from) \"([^\"]*)\"$/) do |action, where, host|\n-  step %(I #{action} packages \"#{TRADITIONAL_STACK_RPMS}\" #{where} this \"#{host}\")\n+  pkgs = 'spacewalk-client-tools spacewalk-check spacewalk-client-setup mgr-daemon mgr-osad mgr-cfg-actions'\n+  step %(I #{action} packages \"#{pkgs}\" #{where} this \"#{host}\")\n end\n \n-When(/^I (install|remove) OpenSCAP (traditional|salt|centos) dependencies (on|from) \"([^\"]*)\"$/) do |action, client_type, where, host|\n-  if client_type == 'traditional'\n-    step %(I #{action} packages \"#{OPEN_SCAP_TRAD_DEPS}\" #{where} this \"#{host}\")\n-  elsif client_type == 'salt'\n-    step %(I #{action} packages \"#{OPEN_SCAP_SALT_DEPS}\" #{where} this \"#{host}\")\n-  else\n-    step %(I #{action} packages \"#{OPEN_SCAP_CENTOS_DEPS}\" #{where} this \"#{host}\")\n+When(/^I (install|remove) OpenSCAP dependencies (on|from) \"([^\"]*)\"$/) do |action, where, host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    pkgs = 'openscap-utils openscap-content'\n+  elsif os_family =~ /^centos/\n+    pkgs = 'openscap-utils scap-security-guide'\n+  elsif os_family =~ /^ubuntu/\n+    pkgs = 'libopenscap8 ssg-debderived'\n   end\n+  pkgs += ' spacewalk-oscap' if host.include? 'client'\n+  step %(I #{action} packages \"#{pkgs}\" #{where} this \"#{host}\")\n+end\n+\n+# On CentOS 7, OpenSCAP files are for RedHat and need a small adaptation for CentOS\n+When(/^I fix CentOS 7 OpenSCAP files on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  script = '/<\\/rear-matter>/a  <platform idref=\"cpe:/o:centos:centos:7\"/>'\n+  file = \"/usr/share/xml/scap/ssg/content/ssg-rhel7-xccdf.xml\"\n+  node.run(\"sed -i '#{script}' #{file}\")\n end", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMTIxOQ=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0MzczNw==", "bodyText": "Ok, keep in mind it, and maybe add a comment in the card to upgrade our CI to CentOS8, as that could emerge at some moment.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528543737", "createdAt": "2020-11-23T08:48:28Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -771,17 +771,30 @@\n end\n \n When(/^I (install|remove) the traditional stack utils (on|from) \"([^\"]*)\"$/) do |action, where, host|\n-  step %(I #{action} packages \"#{TRADITIONAL_STACK_RPMS}\" #{where} this \"#{host}\")\n+  pkgs = 'spacewalk-client-tools spacewalk-check spacewalk-client-setup mgr-daemon mgr-osad mgr-cfg-actions'\n+  step %(I #{action} packages \"#{pkgs}\" #{where} this \"#{host}\")\n end\n \n-When(/^I (install|remove) OpenSCAP (traditional|salt|centos) dependencies (on|from) \"([^\"]*)\"$/) do |action, client_type, where, host|\n-  if client_type == 'traditional'\n-    step %(I #{action} packages \"#{OPEN_SCAP_TRAD_DEPS}\" #{where} this \"#{host}\")\n-  elsif client_type == 'salt'\n-    step %(I #{action} packages \"#{OPEN_SCAP_SALT_DEPS}\" #{where} this \"#{host}\")\n-  else\n-    step %(I #{action} packages \"#{OPEN_SCAP_CENTOS_DEPS}\" #{where} this \"#{host}\")\n+When(/^I (install|remove) OpenSCAP dependencies (on|from) \"([^\"]*)\"$/) do |action, where, host|\n+  node = get_target(host)\n+  os_version, os_family = get_os_version(node)\n+  if os_family =~ /^opensuse/ || os_family =~ /^sles/\n+    pkgs = 'openscap-utils openscap-content'\n+  elsif os_family =~ /^centos/\n+    pkgs = 'openscap-utils scap-security-guide'\n+  elsif os_family =~ /^ubuntu/\n+    pkgs = 'libopenscap8 ssg-debderived'\n   end\n+  pkgs += ' spacewalk-oscap' if host.include? 'client'\n+  step %(I #{action} packages \"#{pkgs}\" #{where} this \"#{host}\")\n+end\n+\n+# On CentOS 7, OpenSCAP files are for RedHat and need a small adaptation for CentOS\n+When(/^I fix CentOS 7 OpenSCAP files on \"([^\"]*)\"$/) do |host|\n+  node = get_target(host)\n+  script = '/<\\/rear-matter>/a  <platform idref=\"cpe:/o:centos:centos:7\"/>'\n+  file = \"/usr/share/xml/scap/ssg/content/ssg-rhel7-xccdf.xml\"\n+  node.run(\"sed -i '#{script}' #{file}\")\n end", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMTIxOQ=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDY1NTg2OnYy", "diffSide": "RIGHT", "path": "testsuite/features/secondary/trad_openscap_audit.feature", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyNjoyMVrOH4DDbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODo0NzoxOFrOH4Dt2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMjMzMw==", "bodyText": "If I recall correctly, a few weeks ago I manage to hide this information from the Gherkin code.\nCould you review that there is no method that provides you this action without specifying fake repository names (os_pool_repo os_update_repo) here in the scenario?", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528532333", "createdAt": "2020-11-23T08:26:21Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -34,19 +40,24 @@ Feature: openSCAP audit of traditional client\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n \n-  Scenario: Delete audit results from traditional client\n+  Scenario: Cleanup: delete audit results from traditional client\n     Given I am on the Systems overview page of this \"sle_client\"\n     When I follow \"Audit\" in the content area\n     And I follow \"List Scans\" in the content area\n     And I click on \"Select All\"\n     And I click on \"Remove Selected Scans\"\n     And I click on \"Confirm\"\n-    Then I should see a \"deleted. 0 SCAP Scan(s) retained\" text\n+    Then I should see a \"1 SCAP Scan(s) deleted. 0 SCAP Scan(s) retained\" text\n \n-  Scenario: Restore audit scans retention period on traditional client\n+  Scenario: Cleanup: restore audit scans retention period on traditional client\n     Given I am on the Organizations page\n     When I follow \"SUSE Test\" in the content area\n     And I follow \"Configuration\" in the content area\n     And I enter \"90\" as \"scap_retention_period\"\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n+\n+  Scenario: Cleanup: remove the openSCAP packages from the traditional client\n+    When I remove OpenSCAP dependencies from \"sle_client\"\n+    And I disable SUSE Manager tools repositories on \"sle_client\"\n+    And I disable repository \"os_pool_repo os_update_repo\" on this \"sle_client\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzOTAyMQ==", "bodyText": "No, we do hide this, but for other stuff : Docker, Prometeus, etc.\nTo be noticed: the existing code was not hiding the details either (And I enable repository \"CentOS Base\").\nI tried to hide it the same way:\nAnd I install packages before testing OpenSCAP\nbut it resulted complicated, especially due to the fact we reuse steps like I disable SUSE Manager tools repositories that are already doing part of the hiding, but are also used standalone for bootstrapping. The other thing that makes it difficult is that it depends both on OS and on traditional/minion.\nI agree this refactor would be beneficial, but I also already lost too much time on openSCAP, which is somehow marginal.\nFeel free to write these \"hiding\" steps (but hiding all repository enable/disable, not only a couple of them). Would be great.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528539021", "createdAt": "2020-11-23T08:39:23Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -34,19 +40,24 @@ Feature: openSCAP audit of traditional client\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n \n-  Scenario: Delete audit results from traditional client\n+  Scenario: Cleanup: delete audit results from traditional client\n     Given I am on the Systems overview page of this \"sle_client\"\n     When I follow \"Audit\" in the content area\n     And I follow \"List Scans\" in the content area\n     And I click on \"Select All\"\n     And I click on \"Remove Selected Scans\"\n     And I click on \"Confirm\"\n-    Then I should see a \"deleted. 0 SCAP Scan(s) retained\" text\n+    Then I should see a \"1 SCAP Scan(s) deleted. 0 SCAP Scan(s) retained\" text\n \n-  Scenario: Restore audit scans retention period on traditional client\n+  Scenario: Cleanup: restore audit scans retention period on traditional client\n     Given I am on the Organizations page\n     When I follow \"SUSE Test\" in the content area\n     And I follow \"Configuration\" in the content area\n     And I enter \"90\" as \"scap_retention_period\"\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n+\n+  Scenario: Cleanup: remove the openSCAP packages from the traditional client\n+    When I remove OpenSCAP dependencies from \"sle_client\"\n+    And I disable SUSE Manager tools repositories on \"sle_client\"\n+    And I disable repository \"os_pool_repo os_update_repo\" on this \"sle_client\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMjMzMw=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0MzE5NA==", "bodyText": "As I said, I will not go behind others' code refactoring it. If you really feel it's ok like that, I will not oppose, I'm just giving my personal opinion :)", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528543194", "createdAt": "2020-11-23T08:47:18Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -34,19 +40,24 @@ Feature: openSCAP audit of traditional client\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n \n-  Scenario: Delete audit results from traditional client\n+  Scenario: Cleanup: delete audit results from traditional client\n     Given I am on the Systems overview page of this \"sle_client\"\n     When I follow \"Audit\" in the content area\n     And I follow \"List Scans\" in the content area\n     And I click on \"Select All\"\n     And I click on \"Remove Selected Scans\"\n     And I click on \"Confirm\"\n-    Then I should see a \"deleted. 0 SCAP Scan(s) retained\" text\n+    Then I should see a \"1 SCAP Scan(s) deleted. 0 SCAP Scan(s) retained\" text\n \n-  Scenario: Restore audit scans retention period on traditional client\n+  Scenario: Cleanup: restore audit scans retention period on traditional client\n     Given I am on the Organizations page\n     When I follow \"SUSE Test\" in the content area\n     And I follow \"Configuration\" in the content area\n     And I enter \"90\" as \"scap_retention_period\"\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n+\n+  Scenario: Cleanup: remove the openSCAP packages from the traditional client\n+    When I remove OpenSCAP dependencies from \"sle_client\"\n+    And I disable SUSE Manager tools repositories on \"sle_client\"\n+    And I disable repository \"os_pool_repo os_update_repo\" on this \"sle_client\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMjMzMw=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDY2MTgwOnYy", "diffSide": "RIGHT", "path": "testsuite/features/secondary/trad_openscap_audit.feature", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyODowNVrOH4DGyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwOToyMTo0N1rOH4E2JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzE5NQ==", "bodyText": "These kinds of assumptions are very problematic for idempotency and it's a source of issues if we decide to run the tests in parallel. Please keep that in mind. Note it will not impact if the minion only runs SCAP in this feature.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528533195", "createdAt": "2020-11-23T08:28:05Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -34,19 +40,24 @@ Feature: openSCAP audit of traditional client\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n \n-  Scenario: Delete audit results from traditional client\n+  Scenario: Cleanup: delete audit results from traditional client\n     Given I am on the Systems overview page of this \"sle_client\"\n     When I follow \"Audit\" in the content area\n     And I follow \"List Scans\" in the content area\n     And I click on \"Select All\"\n     And I click on \"Remove Selected Scans\"\n     And I click on \"Confirm\"\n-    Then I should see a \"deleted. 0 SCAP Scan(s) retained\" text\n+    Then I should see a \"1 SCAP Scan(s) deleted. 0 SCAP Scan(s) retained\" text", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzOTQ5NA==", "bodyText": "Agree. Will remove it everywhere. Was done to align to same code on all types of clients, but I aligned the wrong way round.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528539494", "createdAt": "2020-11-23T08:40:12Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -34,19 +40,24 @@ Feature: openSCAP audit of traditional client\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n \n-  Scenario: Delete audit results from traditional client\n+  Scenario: Cleanup: delete audit results from traditional client\n     Given I am on the Systems overview page of this \"sle_client\"\n     When I follow \"Audit\" in the content area\n     And I follow \"List Scans\" in the content area\n     And I click on \"Select All\"\n     And I click on \"Remove Selected Scans\"\n     And I click on \"Confirm\"\n-    Then I should see a \"deleted. 0 SCAP Scan(s) retained\" text\n+    Then I should see a \"1 SCAP Scan(s) deleted. 0 SCAP Scan(s) retained\" text", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzE5NQ=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU1NzUwOQ==", "bodyText": "Done.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528557509", "createdAt": "2020-11-23T09:14:16Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -34,19 +40,24 @@ Feature: openSCAP audit of traditional client\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n \n-  Scenario: Delete audit results from traditional client\n+  Scenario: Cleanup: delete audit results from traditional client\n     Given I am on the Systems overview page of this \"sle_client\"\n     When I follow \"Audit\" in the content area\n     And I follow \"List Scans\" in the content area\n     And I click on \"Select All\"\n     And I click on \"Remove Selected Scans\"\n     And I click on \"Confirm\"\n-    Then I should see a \"deleted. 0 SCAP Scan(s) retained\" text\n+    Then I should see a \"1 SCAP Scan(s) deleted. 0 SCAP Scan(s) retained\" text", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzE5NQ=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU2MTcwMQ==", "bodyText": "As a side note, it could not have created problems with parallelism, as it happens on different clients, and each has its own audit screen. But OK.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528561701", "createdAt": "2020-11-23T09:21:47Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -34,19 +40,24 @@ Feature: openSCAP audit of traditional client\n     And I click on \"Update Organization\"\n     Then I should see a \"Organization SUSE Test was successfully updated.\" text\n \n-  Scenario: Delete audit results from traditional client\n+  Scenario: Cleanup: delete audit results from traditional client\n     Given I am on the Systems overview page of this \"sle_client\"\n     When I follow \"Audit\" in the content area\n     And I follow \"List Scans\" in the content area\n     And I click on \"Select All\"\n     And I click on \"Remove Selected Scans\"\n     And I click on \"Confirm\"\n-    Then I should see a \"deleted. 0 SCAP Scan(s) retained\" text\n+    Then I should see a \"1 SCAP Scan(s) deleted. 0 SCAP Scan(s) retained\" text", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzE5NQ=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDY2Njk4OnYy", "diffSide": "RIGHT", "path": "testsuite/features/secondary/trad_openscap_audit.feature", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyOTozNlrOH4DJwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODo0MDo0MlrOH4DgYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzk1Mg==", "bodyText": "Unless \"rule-pwd-warnage\" text is visible on the UI and for the user, I'd prefer to have a step definition hiding this technical detail.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528533952", "createdAt": "2020-11-23T08:29:36Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -23,8 +28,9 @@ Feature: openSCAP audit of traditional client\n     Then I should see a \"Details of XCCDF Scan\" text\n     And I should see a \"Default\" text\n     And I should see a \"XCCDF Rule Results\" text\n-    And I should see a \"pass\" text or \"notapplicable\" text\n-    And I should see a \"rule-\" link\n+    When I enter \"pass\" as the filtered XCCDF result type\n+    And I click on the filter button\n+    Then I should see a \"rule-pwd-warnage\" link", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzOTc0Nw==", "bodyText": "It is visible on UI and therefore easy to check when we get screenshots.", "url": "https://github.com/uyuni-project/uyuni/pull/2880#discussion_r528539747", "createdAt": "2020-11-23T08:40:42Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/trad_openscap_audit.feature", "diffHunk": "@@ -23,8 +28,9 @@ Feature: openSCAP audit of traditional client\n     Then I should see a \"Details of XCCDF Scan\" text\n     And I should see a \"Default\" text\n     And I should see a \"XCCDF Rule Results\" text\n-    And I should see a \"pass\" text or \"notapplicable\" text\n-    And I should see a \"rule-\" link\n+    When I enter \"pass\" as the filtered XCCDF result type\n+    And I click on the filter button\n+    Then I should see a \"rule-pwd-warnage\" link", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzk1Mg=="}, "originalCommit": {"oid": "96bd145af012c202d783f20313ef0aa04dc42fcb"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3917, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}