{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyOTY0Nzk5", "number": 2519, "title": "Re-adds ability to download from local mirrors", "bodyText": "What does this PR change?\nDownloads (and GPG checks) from local mirrors are now possible again. This went away with the introduction of requests for GPG checks. No additional dependencies are needed.\nGUI diff\nNo difference.\nDocumentation\n\nNo documentation needed: This is a bugfix\n\nTest coverage\n\nTests were added.\n\nLinks\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-08-25T06:09:11Z", "url": "https://github.com/uyuni-project/uyuni/pull/2519", "merged": true, "mergeCommit": {"oid": "8d6083671e54474afa83fd1cd84697e405e59b8e"}, "closed": true, "closedAt": "2020-10-28T09:10:20Z", "author": {"login": "brejoc"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCQ5wZgH2gAyNDcyOTY0Nzk5OmNhZWMwNDIwMDY3ZjkxZjAwYzk4MDdkZDA3ZDg1YTQwZGFkYjFhMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWrndLgFqTUxNzkwODM5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "caec0420067f91f00c9807dd07d85a40dadb1a39", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/caec0420067f91f00c9807dd07d85a40dadb1a39", "committedDate": "2020-08-25T06:06:39Z", "message": "Adds file adapter for requests\n\nrequests is per default not able to 'get' files from the local fs.\nWith this file adapter this can be done."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c32395afe9f93c16e60c445ad04bad137d806ff", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1c32395afe9f93c16e60c445ad04bad137d806ff", "committedDate": "2020-08-26T15:06:31Z", "message": "Switch to processing local files directly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1980d3e85a8be90c773047c519f18acb87501181", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1980d3e85a8be90c773047c519f18acb87501181", "committedDate": "2020-08-27T14:40:30Z", "message": "Adds missing permission check\n\nos.access needs to know which permissions should be checked."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a0c0630c6be55c7a641d9ad9a8a1c847224846f", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9a0c0630c6be55c7a641d9ad9a8a1c847224846f", "committedDate": "2020-08-28T15:07:47Z", "message": "Seems like pkg index is expected to be a bytes string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "262c44e3b566666fd81bc164dc5bece5152b97fd", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/262c44e3b566666fd81bc164dc5bece5152b97fd", "committedDate": "2020-08-28T15:47:04Z", "message": "Flat and non flat repo handling fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c767034a3587ce4b603896294cb6102e9f978ad", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0c767034a3587ce4b603896294cb6102e9f978ad", "committedDate": "2020-08-31T08:54:37Z", "message": "Fixes parameters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTI0NjAy", "url": "https://github.com/uyuni-project/uyuni/pull/2519#pullrequestreview-479524602", "createdAt": "2020-09-01T08:43:24Z", "commit": {"oid": "0c767034a3587ce4b603896294cb6102e9f978ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODo0MzoyNFrOHKsQlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODo0MzoyNFrOHKsQlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk3Mjk1MA==", "bodyText": "There is an exception handling missing.", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r480972950", "createdAt": "2020-09-01T08:43:24Z", "author": {"login": "brejoc"}, "path": "backend/common/repo.py", "diffHunk": "@@ -110,11 +110,19 @@ def get_pkg_index_raw(self) -> typing.Tuple[str, bytes]:\n         if self._pkg_index[0] == \"\":\n             for cnt_fname in [DpkgRepo.PKG_GZ, DpkgRepo.PKG_XZ, DpkgRepo.PKG_RW]:\n                 packages_url = self.append_index_file(cnt_fname)\n-                resp = requests.get(packages_url, proxies=self.proxies)\n-                if resp.status_code == http.HTTPStatus.OK:\n-                    self._pkg_index = cnt_fname, resp.content\n-                    break\n-                resp.close()\n+                if packages_url.startswith(\"file://\"):\n+                    try:\n+                        with open(packages_url.replace(\"file://\", \"\"), \"rb\") as f:\n+                            self._pkg_index = cnt_fname, f.read()\n+                            break\n+                    except:\n+                        pass", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c767034a3587ce4b603896294cb6102e9f978ad"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTcwNjQy", "url": "https://github.com/uyuni-project/uyuni/pull/2519#pullrequestreview-479570642", "createdAt": "2020-09-01T09:43:49Z", "commit": {"oid": "0c767034a3587ce4b603896294cb6102e9f978ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwOTo0Mzo0OVrOHKubTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwOTo0Mzo0OVrOHKubTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAwODQ2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    # Repo format is flat\n          \n          \n            \n                    if self.is_flat():\n          \n          \n            \n                    # Repo format is flat\n          \n          \n            \n                    else:", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r481008460", "createdAt": "2020-09-01T09:43:49Z", "author": {"login": "meaksh"}, "path": "backend/common/repo.py", "diffHunk": "@@ -232,7 +271,57 @@ def get_release_index(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntry\"]:\n         :raises GeneralRepoException if the Release file cannot be found or the GPG signature can't be verified.\n         :return: string\n         \"\"\"\n+        if self._url.startswith(\"file://\"):\n+            return self._get_release_index_from_file()\n+        else:\n+            return self._get_release_index_from_http()\n+\n+\n+    def _get_release_index_from_file(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntry\"]:\n+        # InRelease files take precedence per uyuni-rfc 00057-deb-repo-sync-gpg-check\n+        local_path = self._url.replace(\"file://\", \"\")\n+        release_file = None\n+        if os.access(self._get_parent_url(local_path, 2, \"InRelease\"), os.R_OK):\n+            release_file = self._get_parent_url(local_path, 2, \"InRelease\")\n+            self._flat = False\n+        elif os.access(self._get_parent_url(local_path, 2, \"Release\"), os.R_OK):\n+            release_file = self._get_parent_url(local_path, 2, \"InRelease\")\n+            self._flat = False\n+        else:\n+            self._flat = True\n+        self._flat_checked = 1\n+\n+        # Repo format is not flat\n+        if not self.is_flat():\n+            if self.gpg_verify and not self._has_valid_gpg_signature(local_path):\n+                raise GeneralRepoException(\"GPG verfication failed: {}\".format(release_file))\n+            try:\n+                with open(release_file, \"rb\") as f:\n+                    self._release = self._parse_release_index(f.read().decode(\"utf-8\"))\n+            except IOError:\n+                raise GeneralRepoException(\"IOError while accessing file: {}\".format(release_file))\n+\n+        # Repo format is flat\n+        if self.is_flat():", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c767034a3587ce4b603896294cb6102e9f978ad"}, "originalPosition": 150}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "322586e223392205ff03e0aac28d03683fbe257d", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/322586e223392205ff03e0aac28d03683fbe257d", "committedDate": "2020-10-22T08:52:25Z", "message": "Better if-else flow\n\nCo-authored-by: Pablo Su\u00e1rez Hern\u00e1ndez <psuarezhernandez@suse.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95984f164675cf7851477ab615534f5b5420892c", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/95984f164675cf7851477ab615534f5b5420892c", "committedDate": "2020-10-26T09:22:13Z", "message": "Adds test for local file repos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9fe32da3ca07e1c425ea3ebe1d939a6aa5cf334", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f9fe32da3ca07e1c425ea3ebe1d939a6aa5cf334", "committedDate": "2020-10-26T09:24:40Z", "message": "Removed error handling\n\nSince there is no logging currently error catching was removed. This has\nto fail, so that the user has a chance to see what's going on."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b808660dc4231e58cbd634ae2d972ff5b62610dc", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b808660dc4231e58cbd634ae2d972ff5b62610dc", "committedDate": "2020-10-26T13:49:22Z", "message": "Adds changelog entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bf35e2769da3389307c39484179d5cb92426d5b", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0bf35e2769da3389307c39484179d5cb92426d5b", "committedDate": "2020-10-27T15:17:00Z", "message": "Merge remote-tracking branch 'uyuni/master' into uyuni-master-local-file-for-requests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODkyMzQy", "url": "https://github.com/uyuni-project/uyuni/pull/2519#pullrequestreview-517892342", "createdAt": "2020-10-27T16:17:35Z", "commit": {"oid": "0bf35e2769da3389307c39484179d5cb92426d5b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjoxNzozNVrOHpE4wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjoyMDoyMFrOHpFBKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzMzcyOQ==", "bodyText": "Could we do the actual logging instead of having this TODO here?", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r512833729", "createdAt": "2020-10-27T16:17:35Z", "author": {"login": "meaksh"}, "path": "backend/common/repo.py", "diffHunk": "@@ -110,11 +110,17 @@ def get_pkg_index_raw(self) -> typing.Tuple[str, bytes]:\n         if self._pkg_index[0] == \"\":\n             for cnt_fname in [DpkgRepo.PKG_GZ, DpkgRepo.PKG_XZ, DpkgRepo.PKG_RW]:\n                 packages_url = self.append_index_file(cnt_fname)\n-                resp = requests.get(packages_url, proxies=self.proxies)\n-                if resp.status_code == http.HTTPStatus.OK:\n-                    self._pkg_index = cnt_fname, resp.content\n-                    break\n-                resp.close()\n+                if packages_url.startswith(\"file://\"):\n+                    with open(packages_url.replace(\"file://\", \"\"), \"rb\") as f:\n+                        self._pkg_index = cnt_fname, f.read()\n+                        break\n+                    # TODO: Add logging in error case!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf35e2769da3389307c39484179d5cb92426d5b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzNTg4MA==", "bodyText": "We don't want to introduce this \ud83d\ude04\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            >>>>>>> uyuni/master", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r512835880", "createdAt": "2020-10-27T16:20:20Z", "author": {"login": "meaksh"}, "path": "backend/spacewalk-backend.changes", "diffHunk": "@@ -11,6 +12,7 @@ Fri Sep 18 12:13:40 CEST 2020 - jgonzalez@suse.com\n \n - version 4.2.1-1\n - Only regenerate bootstrap repositories when linking new packages (bsc#1174636)\n+>>>>>>> uyuni/master", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf35e2769da3389307c39484179d5cb92426d5b"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b5fabb9249264aea01bb2cb8fc5183d834440df", "author": {"user": {"login": "brejoc", "name": "Jochen Breuer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4b5fabb9249264aea01bb2cb8fc5183d834440df", "committedDate": "2020-10-27T16:26:26Z", "message": "Update backend/spacewalk-backend.changes\n\nCo-authored-by: Pablo Su\u00e1rez Hern\u00e1ndez <psuarezhernandez@suse.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTA4Mzk4", "url": "https://github.com/uyuni-project/uyuni/pull/2519#pullrequestreview-517908398", "createdAt": "2020-10-27T16:32:35Z", "commit": {"oid": "4b5fabb9249264aea01bb2cb8fc5183d834440df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1112, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}