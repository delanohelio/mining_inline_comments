{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5Mzc3MTc0", "number": 2225, "title": "Fix bug with vhm refresh and orgadmins ", "bodyText": "What does this PR change?\nThe SparkApplicationHelper checks for org admin rights but when scheduling it via TaskomaticAPI it checks for satadmin rights. So I made a new function that checks for org admin rights for this case.\nShould be ported to 4.0 also\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed:\n\n\n DONE\n\n\nTest coverage\n\n\nNo tests:\n\n\n DONE\n\n\nLinks\n11386 spacewalk issue\nFixes #\nTracks # add downstream PR, if any\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-05-18T09:32:51Z", "url": "https://github.com/uyuni-project/uyuni/pull/2225", "merged": true, "mergeCommit": {"oid": "5f145b8ca64e69243433ca802bccc6ac5d650dd2"}, "closed": true, "closedAt": "2020-06-03T23:18:31Z", "author": {"login": "mseidl"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcidlr3gFqTQxMzQ3Njk1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnwqM4ABqjM0MDQyMDM2NzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDc2OTUz", "url": "https://github.com/uyuni-project/uyuni/pull/2225#pullrequestreview-413476953", "createdAt": "2020-05-18T10:43:54Z", "commit": {"oid": "16f22055d6c81c71cd097f0669a9b6d426e22455"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMDo0Mzo1NFrOGWxmKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMDo0Mzo1NFrOGWxmKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNDQ0Mw==", "bodyText": "With this name, I think we should limit the use and hardcode the bunchName.\nOtherwise it can be used to schedule any bunch which requires Satelite permissions using this new endpoint.\nSee also scheduleRepoSync() .....", "url": "https://github.com/uyuni-project/uyuni/pull/2225#discussion_r426534443", "createdAt": "2020-05-18T10:43:54Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/redhat/rhn/taskomatic/TaskomaticApi.java", "diffHunk": "@@ -221,6 +221,20 @@ public Date scheduleSingleSatBunch(User user, String bunchName,\n         return (Date) invoke(\"tasko.scheduleSingleSatBunchRun\", bunchName, params);\n     }\n \n+    /**\n+     * Creates a new single gatherer schedule\n+     * @param user shall be org admin\n+     * @param bunchName bunch name\n+     * @param params parameters for the bunch\n+     * @return date of the first schedule\n+     * @throws TaskomaticApiException if there was an error\n+     */\n+    public Date scheduleGathererRefresh(User user, String bunchName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f22055d6c81c71cd097f0669a9b6d426e22455"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16f22055d6c81c71cd097f0669a9b6d426e22455", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/16f22055d6c81c71cd097f0669a9b6d426e22455", "committedDate": "2020-05-18T09:23:33Z", "message": "update changelog"}, "afterCommit": {"oid": "89743629e8120464dd1c215f63a1713b4f5e5f00", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/89743629e8120464dd1c215f63a1713b4f5e5f00", "committedDate": "2020-05-18T11:24:05Z", "message": "update changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89743629e8120464dd1c215f63a1713b4f5e5f00", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/89743629e8120464dd1c215f63a1713b4f5e5f00", "committedDate": "2020-05-18T11:24:05Z", "message": "update changelog"}, "afterCommit": {"oid": "17e80d014cf547cc1fc2668bd4e55560644a4f53", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/17e80d014cf547cc1fc2668bd4e55560644a4f53", "committedDate": "2020-05-19T07:18:29Z", "message": "update changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NjAyMDEy", "url": "https://github.com/uyuni-project/uyuni/pull/2225#pullrequestreview-417602012", "createdAt": "2020-05-25T09:58:50Z", "commit": {"oid": "17e80d014cf547cc1fc2668bd4e55560644a4f53"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwOTo1ODo1MFrOGZ73MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwOTo1OToxNFrOGZ735Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg0ODM2OA==", "bodyText": "If the label is the only possible value which can be set I would also go with @hustodemon suggestion to replace \"params\" with \"label\" and create the params map inside of the method.\nBut for me this is optional. Not sure what franky think :-)", "url": "https://github.com/uyuni-project/uyuni/pull/2225#discussion_r429848368", "createdAt": "2020-05-25T09:58:50Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/suse/manager/webui/controllers/VirtualHostManagerController.java", "diffHunk": "@@ -616,8 +616,7 @@ public static Object refresh(Request request, Response response, User user) {\n             Map<String, String> params = new HashMap<>();\n             params.put(GathererJob.VHM_LABEL, label);\n             try {\n-                new TaskomaticApi()\n-                        .scheduleSingleSatBunch(user, \"gatherer-matcher-bunch\", params);\n+                new TaskomaticApi().scheduleGathererRefresh(user, params);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e80d014cf547cc1fc2668bd4e55560644a4f53"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg0ODU0OQ==", "bodyText": "Do we have a bugreport with a bugnumber for this?", "url": "https://github.com/uyuni-project/uyuni/pull/2225#discussion_r429848549", "createdAt": "2020-05-25T09:59:14Z", "author": {"login": "mcalmer"}, "path": "java/spacewalk-java.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- fixed bug where in scheduling a vhm refresh would result in a permission error for org admins", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e80d014cf547cc1fc2668bd4e55560644a4f53"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17e80d014cf547cc1fc2668bd4e55560644a4f53", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/17e80d014cf547cc1fc2668bd4e55560644a4f53", "committedDate": "2020-05-19T07:18:29Z", "message": "update changelog"}, "afterCommit": {"oid": "5c5529eea71c548c02b29234b0b373017f32abf6", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5c5529eea71c548c02b29234b0b373017f32abf6", "committedDate": "2020-05-25T12:23:04Z", "message": "update changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8078a2bd940e4c75c92acec5a9e2b6399059754a", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/8078a2bd940e4c75c92acec5a9e2b6399059754a", "committedDate": "2020-06-03T21:49:55Z", "message": "fix permission issue with orgadmins on vhm refresh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09cc1d7213897d3065bb005ab9b151f4ba4a1666", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/09cc1d7213897d3065bb005ab9b151f4ba4a1666", "committedDate": "2020-06-03T21:50:19Z", "message": "update changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c5529eea71c548c02b29234b0b373017f32abf6", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5c5529eea71c548c02b29234b0b373017f32abf6", "committedDate": "2020-05-25T12:23:04Z", "message": "update changelog"}, "afterCommit": {"oid": "09cc1d7213897d3065bb005ab9b151f4ba4a1666", "author": {"user": {"login": "mseidl", "name": "Martin Seidl"}}, "url": "https://github.com/uyuni-project/uyuni/commit/09cc1d7213897d3065bb005ab9b151f4ba4a1666", "committedDate": "2020-06-03T21:50:19Z", "message": "update changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1471, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}