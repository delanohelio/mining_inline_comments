{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjU1NzA1", "number": 2377, "title": "Fix CentOS systems detection at bootstrap to properly set the bootstrap repo (bsc#1173556)", "bodyText": "What does this PR change?\nThis PR changes the bootstrap procedure for CentOS systems to properly set the bootstrap repository and avoid possible issues depending on the particular scenario.\n\nPreserve same previous behavior for RHEL instances.\nCheck /etc/centos-release to determine whether the instance is CentOS or not.\nIn case of a CentOS instance, use \"centos\" bootstrap repo. If it does not exist, then failback to use \"res\" bootstrap repo.\nTake care of the special case of SLES_ES 6, as we already do in the bootstrap script.\nAlign bootstrap SLS and bootstrap script behavior\n\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\nNo documentation needed: bugfix\n DONE\n\nTest coverage\n\nNo tests: manually tested by QA\n DONE\n\nLinks\nFixes #\nTracks # add downstream PR, if any\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-07-01T12:07:04Z", "url": "https://github.com/uyuni-project/uyuni/pull/2377", "merged": true, "mergeCommit": {"oid": "63500222d58172dcd68729e801ef6feed10a6d4b"}, "closed": true, "closedAt": "2020-07-01T14:02:18Z", "author": {"login": "meaksh"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwpMoUgFqTQ0MDgxMTQ2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwqsj-AFqTQ0MDg5NTY5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODExNDY5", "url": "https://github.com/uyuni-project/uyuni/pull/2377#pullrequestreview-440811469", "createdAt": "2020-07-01T12:12:29Z", "commit": {"oid": "927411aa2403ee1f118eb032345910529c897b28"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoxMjoyOVrOGrjSfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoxNDowNlrOGrjVXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDEyNw==", "bodyText": "Does $FETCH print any value on screen?\nNot sure if you need &> /dev/null", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448320127", "createdAt": "2020-07-01T12:12:29Z", "author": {"login": "juliogonzalez"}, "path": "spacewalk/certs-tools/rhn_bootstrap_strings.py", "diffHunk": "@@ -406,6 +406,11 @@ def getRegistrationStackSh(saltEnabled):\n     CLIENT_REPO_NAME=\"susemanager:bootstrap\"\n     CLIENT_REPO_FILE=\"/etc/yum.repos.d/$CLIENT_REPO_NAME.repo\"\n \n+    # In case of CentOS, check is centos bootstrap repository is available, if not, failback to res.\n+    if [[ \"$Y_CLIENT_CODE_BASE\" == centos && ! `$FETCH $CLIENT_REPO_URL/repodata/repomd.xml` ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "927411aa2403ee1f118eb032345910529c897b28"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDM3MA==", "bodyText": "901? :-?", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448320370", "createdAt": "2020-07-01T12:13:01Z", "author": {"login": "juliogonzalez"}, "path": "susemanager-utils/susemanager-sls/salt/bootstrap/init.sls", "diffHunk": "@@ -26,14 +26,31 @@ mgr_server_localhost_alias_absent:\n {%- else %}\n {% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/' ~ os_base ~ '/' ~ grains['osrelease'] ~ '/0/bootstrap/' %}\n {%- endif %}\n+\n {%- elif grains['os_family'] == 'RedHat' %}\n-{%- if salt['file.file_exists' ]('/etc/oracle-release') %}\n+{%- if salt['file.file_exists']('/etc/oracle-release') %}\n {% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/oracle/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n-{%- elif salt['file.file_exists' ]('/etc/redhat-release') %}\n+\n+{%- elif salt['file.file_exists']('/usr/share/doc/sles_es-release') %}\n+{% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/res/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n+\n+{%- elif salt['file.file_exists']('/etc/centos-release') %}\n+{# We try CentOS bootstrap repository first. Failback to RES #}\n+{% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/centos/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n+{% set bootstrap_repo_request = salt['http.query'](bootstrap_repo_url + 'repodata/repomd.xml', status=True, verify_ssl=False) %}\n+{%- if bootstrap_repo_request['status'] == 901 %}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "927411aa2403ee1f118eb032345910529c897b28"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDg2Mw==", "bodyText": "This is so you can follow redirects? But if so, how do you know the target of a redirect is valid?", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448320863", "createdAt": "2020-07-01T12:14:06Z", "author": {"login": "juliogonzalez"}, "path": "susemanager-utils/susemanager-sls/salt/bootstrap/init.sls", "diffHunk": "@@ -26,14 +26,31 @@ mgr_server_localhost_alias_absent:\n {%- else %}\n {% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/' ~ os_base ~ '/' ~ grains['osrelease'] ~ '/0/bootstrap/' %}\n {%- endif %}\n+\n {%- elif grains['os_family'] == 'RedHat' %}\n-{%- if salt['file.file_exists' ]('/etc/oracle-release') %}\n+{%- if salt['file.file_exists']('/etc/oracle-release') %}\n {% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/oracle/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n-{%- elif salt['file.file_exists' ]('/etc/redhat-release') %}\n+\n+{%- elif salt['file.file_exists']('/usr/share/doc/sles_es-release') %}\n+{% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/res/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n+\n+{%- elif salt['file.file_exists']('/etc/centos-release') %}\n+{# We try CentOS bootstrap repository first. Failback to RES #}\n+{% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/centos/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n+{% set bootstrap_repo_request = salt['http.query'](bootstrap_repo_url + 'repodata/repomd.xml', status=True, verify_ssl=False) %}\n+{%- if bootstrap_repo_request['status'] == 901 %}\n+{{ raise(bootstrap_repo_request['error']) }}\n+{%- elif not (0 < bootstrap_repo_request['status'] < 300) %}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "927411aa2403ee1f118eb032345910529c897b28"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODE2OTUy", "url": "https://github.com/uyuni-project/uyuni/pull/2377#pullrequestreview-440816952", "createdAt": "2020-07-01T12:20:45Z", "commit": {"oid": "927411aa2403ee1f118eb032345910529c897b28"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoyMDo0NVrOGrjibA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoyMDo0NVrOGrjibA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyNDIwNA==", "bodyText": "failback does not exist. I think you mean fallback.\nThis exists also in some comments in the code.", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448324204", "createdAt": "2020-07-01T12:20:45Z", "author": {"login": "mcalmer"}, "path": "spacewalk/certs-tools/spacewalk-certs-tools.changes", "diffHunk": "@@ -1,3 +1,5 @@\n+- Use RES bootstrap repository as failback repo when bootstrapping CentOS (bsc#1173556)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "927411aa2403ee1f118eb032345910529c897b28"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1310a147bde5210ed4169ac573d5b9e5b253dad6", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1310a147bde5210ed4169ac573d5b9e5b253dad6", "committedDate": "2020-07-01T12:54:02Z", "message": "Fix typo on comments and changelog"}, "afterCommit": {"oid": "04397a55aadeade7ab2d1d591c8a1d8cd35bdc33", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/04397a55aadeade7ab2d1d591c8a1d8cd35bdc33", "committedDate": "2020-07-01T13:03:01Z", "message": "Use more friendly message when switching from CentOS to RES bootstrap repo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f52bacc90c4f58c2922949177a515981f97df10", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1f52bacc90c4f58c2922949177a515981f97df10", "committedDate": "2020-07-01T13:53:52Z", "message": "Fix detection of CentOS systems to properly set bootstrap repo (bsc#1173556)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41ab2a5d88806d3a00f72f6810fd26ad73e7a6c8", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/41ab2a5d88806d3a00f72f6810fd26ad73e7a6c8", "committedDate": "2020-07-01T13:54:13Z", "message": "Update changelog for susemanager-sls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "928864cfa7e8f93f6e89f09525394309b6a00ab2", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/928864cfa7e8f93f6e89f09525394309b6a00ab2", "committedDate": "2020-07-01T13:54:16Z", "message": "Add SLES_ES case to calculate bootstrap repo on boostrap SLS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1afb128a38b9d4cdfc39c6bb9feddbd007d4946d", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1afb128a38b9d4cdfc39c6bb9feddbd007d4946d", "committedDate": "2020-07-01T13:54:16Z", "message": "Remove unnecessary whitespaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46f89b9113d9529df74158df1979d45b78284547", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/46f89b9113d9529df74158df1979d45b78284547", "committedDate": "2020-07-01T13:54:16Z", "message": "Use RES bootstrap repository as failback repo when bootstrapping for CentOS (bsc#1173556)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7773fe5ce394fa7235db39e15052b381ce7723e7", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7773fe5ce394fa7235db39e15052b381ce7723e7", "committedDate": "2020-07-01T13:54:16Z", "message": "Update changelog for spacewalk-certs-tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "979be723d300c3e60434b5fbea210b840040137c", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/979be723d300c3e60434b5fbea210b840040137c", "committedDate": "2020-07-01T13:54:16Z", "message": "Fix typo on comments and changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07291ef9589b79002a0776b45b51a3ec956dafc2", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/07291ef9589b79002a0776b45b51a3ec956dafc2", "committedDate": "2020-07-01T13:54:16Z", "message": "Use more friendly message when switching from CentOS to RES bootstrap repo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04397a55aadeade7ab2d1d591c8a1d8cd35bdc33", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/04397a55aadeade7ab2d1d591c8a1d8cd35bdc33", "committedDate": "2020-07-01T13:03:01Z", "message": "Use more friendly message when switching from CentOS to RES bootstrap repo"}, "afterCommit": {"oid": "07291ef9589b79002a0776b45b51a3ec956dafc2", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/07291ef9589b79002a0776b45b51a3ec956dafc2", "committedDate": "2020-07-01T13:54:16Z", "message": "Use more friendly message when switching from CentOS to RES bootstrap repo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d363b5c67221e73952775a8f46e388d1a3b7c90", "author": {"user": {"login": "meaksh", "name": "Pablo Su\u00e1rez Hern\u00e1ndez"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7d363b5c67221e73952775a8f46e388d1a3b7c90", "committedDate": "2020-07-01T13:55:49Z", "message": "Fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODk1Njk1", "url": "https://github.com/uyuni-project/uyuni/pull/2377#pullrequestreview-440895695", "createdAt": "2020-07-01T13:59:08Z", "commit": {"oid": "7d363b5c67221e73952775a8f46e388d1a3b7c90"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1201, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}