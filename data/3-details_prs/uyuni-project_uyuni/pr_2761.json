{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNjQ2MTcz", "number": 2761, "title": "Maintain list of synced images in pillar", "bodyText": "What does this PR change?\nThis adds functionality for adding and removing \"synced\" flag for each image in each branch, based on salt events emitted by image-sync formula.\nIt also limits visibility of image pillars to buildhost org only.\nGUI diff\nNo difference.\nDocumentation\n\nNo documentation needed.\n\nTest coverage\n\n DONE\n\nLinks\nFixes SUSE/spacewalk#10577 and SUSE/spacewalk#12388\nDepends on uyuni-project/retail#67\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-10-27T10:35:36Z", "url": "https://github.com/uyuni-project/uyuni/pull/2761", "merged": true, "mergeCommit": {"oid": "4710d279d0822d590baacda6a08704e357b5d719"}, "closed": true, "closedAt": "2020-11-04T10:08:21Z", "author": {"login": "nadvornik"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWm4hfABqjM5MjUyODA4MDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZKZfTABqjM5NTY2NTMxMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d26c38036ed114d6f04c2bc7124c43b26b2454c7", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/d26c38036ed114d6f04c2bc7124c43b26b2454c7", "committedDate": "2020-10-27T09:50:45Z", "message": "Maintain list of synced images in pillar"}, "afterCommit": {"oid": "f83a8f0ce3c88ad7c78c2da544c26d512dcf7f06", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f83a8f0ce3c88ad7c78c2da544c26d512dcf7f06", "committedDate": "2020-10-27T11:00:21Z", "message": "Maintain list of synced images in pillar"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NjY3OTI1", "url": "https://github.com/uyuni-project/uyuni/pull/2761#pullrequestreview-517667925", "createdAt": "2020-10-27T12:53:24Z", "commit": {"oid": "f83a8f0ce3c88ad7c78c2da544c26d512dcf7f06"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjo1MzoyNVrOHo6qLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMzowMjoxN1rOHo7BOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2NjE1Ng==", "bodyText": "Nitpick: Nothing wrong with this but instead of using isPresent and then get method, better use ifPresent like here. It's more concise and more compatible with functional style.", "url": "https://github.com/uyuni-project/uyuni/pull/2761#discussion_r512666156", "createdAt": "2020-10-27T12:53:25Z", "author": {"login": "admd"}, "path": "java/code/src/com/suse/manager/reactor/messaging/ImageSyncedEventMessageAction.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+\n+package com.suse.manager.reactor.messaging;\n+\n+import com.redhat.rhn.common.messaging.EventMessage;\n+import com.redhat.rhn.common.messaging.MessageAction;\n+import com.redhat.rhn.domain.server.ServerFactory;\n+import com.redhat.rhn.domain.server.ServerGroupFactory;\n+import com.redhat.rhn.domain.server.ManagedServerGroup;\n+import com.redhat.rhn.domain.server.MinionServer;\n+import com.redhat.rhn.domain.server.MinionServerFactory;\n+import com.suse.manager.webui.services.SaltStateGeneratorService;\n+import com.suse.manager.webui.utils.salt.custom.ImageSyncedEvent;\n+import org.apache.log4j.Logger;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Logic responsible for reacting to 'image deployed' event.\n+ */\n+public class ImageSyncedEventMessageAction implements MessageAction {\n+\n+    private static final Logger LOG = Logger.getLogger(ImageSyncedEventMessageAction.class);\n+\n+\n+    @Override\n+    public void execute(EventMessage msg) {\n+        ImageSyncedEvent imageSyncedEvent = ((ImageSyncedEventMessage) msg).getImageSyncedEvent();\n+\n+        String minionId = imageSyncedEvent.getMinionId();\n+\n+        Optional<MinionServer> minionOpt = MinionServerFactory.findByMinionId(minionId);\n+        if (minionOpt.isPresent()) {\n+            MinionServer minion = minionOpt.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83a8f0ce3c88ad7c78c2da544c26d512dcf7f06"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY3MjA1OA==", "bodyText": "Any particular reason to use TreeMap instead of HashMap? Do you need to maintain order? Moreover, if a map is going to have only one entry, may be better user collections's singletonMap method like here", "url": "https://github.com/uyuni-project/uyuni/pull/2761#discussion_r512672058", "createdAt": "2020-10-27T13:02:17Z", "author": {"login": "admd"}, "path": "java/code/src/com/suse/manager/webui/services/SaltStateGeneratorService.java", "diffHunk": "@@ -193,6 +193,58 @@ private String getImagePillarFileName(OSImageInspectSlsResult.Bundle bundle) {\n                 bundle.getId().replace('.', '-') + \".\" + PILLAR_IMAGE_DATA_FILE_EXT;\n     }\n \n+    public void createImageSyncedPillar(ServerGroup branch, String name, String version) {\n+\n+        try {\n+            SaltPillar pillar = new SaltPillar();\n+            Map<String, Object> imagePillar = new TreeMap<String, Object>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83a8f0ce3c88ad7c78c2da544c26d512dcf7f06"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f83a8f0ce3c88ad7c78c2da544c26d512dcf7f06", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f83a8f0ce3c88ad7c78c2da544c26d512dcf7f06", "committedDate": "2020-10-27T11:00:21Z", "message": "Maintain list of synced images in pillar"}, "afterCommit": {"oid": "e069c8e08910c18c0aa5c922428c6fa99a1b2052", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/e069c8e08910c18c0aa5c922428c6fa99a1b2052", "committedDate": "2020-10-29T16:18:19Z", "message": "Handle group- and org-specific image pillars"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e069c8e08910c18c0aa5c922428c6fa99a1b2052", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/e069c8e08910c18c0aa5c922428c6fa99a1b2052", "committedDate": "2020-10-29T16:18:19Z", "message": "Handle group- and org-specific image pillars"}, "afterCommit": {"oid": "c74a5ec74ebd0051a16ef3bd488da7aaa0970a32", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c74a5ec74ebd0051a16ef3bd488da7aaa0970a32", "committedDate": "2020-10-30T12:31:26Z", "message": "Handle group- and org-specific image pillars"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c74a5ec74ebd0051a16ef3bd488da7aaa0970a32", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c74a5ec74ebd0051a16ef3bd488da7aaa0970a32", "committedDate": "2020-10-30T12:31:26Z", "message": "Handle group- and org-specific image pillars"}, "afterCommit": {"oid": "3c7f0d4b57c6e2932f1c1afe4777f87359ed7fea", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3c7f0d4b57c6e2932f1c1afe4777f87359ed7fea", "committedDate": "2020-10-30T16:02:25Z", "message": "Unit test for ImageSyncedPillar"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c7f0d4b57c6e2932f1c1afe4777f87359ed7fea", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3c7f0d4b57c6e2932f1c1afe4777f87359ed7fea", "committedDate": "2020-10-30T16:02:25Z", "message": "Unit test for ImageSyncedPillar"}, "afterCommit": {"oid": "0f9e8b66f84a6d3b02b29d861a9ebcd015a9b0d4", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0f9e8b66f84a6d3b02b29d861a9ebcd015a9b0d4", "committedDate": "2020-11-03T09:35:19Z", "message": "Update changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDkyNjkw", "url": "https://github.com/uyuni-project/uyuni/pull/2761#pullrequestreview-522492690", "createdAt": "2020-11-03T13:28:01Z", "commit": {"oid": "55a55201446fca7ce9da66cbbd23e84c0eae433b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzU2OTYz", "url": "https://github.com/uyuni-project/uyuni/pull/2761#pullrequestreview-522756963", "createdAt": "2020-11-03T18:09:51Z", "commit": {"oid": "55a55201446fca7ce9da66cbbd23e84c0eae433b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxODowOTo1MVrOHs6yGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxODowOTo1MVrOHs6yGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg2MjQ5MQ==", "bodyText": "Nitpic, is the warning enough? Shouldn't this be an error?", "url": "https://github.com/uyuni-project/uyuni/pull/2761#discussion_r516862491", "createdAt": "2020-11-03T18:09:51Z", "author": {"login": "aaannz"}, "path": "java/code/src/com/suse/manager/reactor/messaging/ImageSyncedEventMessageAction.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+\n+package com.suse.manager.reactor.messaging;\n+\n+import com.redhat.rhn.common.messaging.EventMessage;\n+import com.redhat.rhn.common.messaging.MessageAction;\n+import com.redhat.rhn.domain.server.ServerGroupFactory;\n+import com.redhat.rhn.domain.server.ManagedServerGroup;\n+import com.redhat.rhn.domain.server.MinionServer;\n+import com.redhat.rhn.domain.server.MinionServerFactory;\n+import com.suse.manager.webui.services.SaltStateGeneratorService;\n+import com.suse.manager.webui.utils.salt.custom.ImageSyncedEvent;\n+import org.apache.log4j.Logger;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Logic responsible for reacting to 'image synced' event.\n+ */\n+public class ImageSyncedEventMessageAction implements MessageAction {\n+\n+    private static final Logger LOG = Logger.getLogger(ImageSyncedEventMessageAction.class);\n+\n+\n+    @Override\n+    public void execute(EventMessage msg) {\n+        ImageSyncedEvent imageSyncedEvent = ((ImageSyncedEventMessage) msg).getImageSyncedEvent();\n+\n+        String minionId = imageSyncedEvent.getMinionId();\n+\n+        Optional<MinionServer> minionOpt = MinionServerFactory.findByMinionId(minionId);\n+        minionOpt.ifPresent(minion -> {\n+            ManagedServerGroup branchGroup = ServerGroupFactory.lookupByNameAndOrg(imageSyncedEvent.getBranch(),\n+                minion.getOrg());\n+\n+            if (!minion.getGroups().contains(branchGroup)) {\n+                LOG.warn(\"Branch server \" + minionId + \" is not in group \" + imageSyncedEvent.getBranch());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55a55201446fca7ce9da66cbbd23e84c0eae433b"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a29afff852d7ce87ca4931573ed4e020322da1b7", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a29afff852d7ce87ca4931573ed4e020322da1b7", "committedDate": "2020-11-04T09:31:50Z", "message": "Maintain list of synced images in pillar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69bf2b64e64990be1e01359d29ebfc7b5c5ae983", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/69bf2b64e64990be1e01359d29ebfc7b5c5ae983", "committedDate": "2020-11-04T09:31:50Z", "message": "Make image pillar visible only in buildhost org"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db2876edfa61d58a3f8873a4e0e47494628e91ef", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/db2876edfa61d58a3f8873a4e0e47494628e91ef", "committedDate": "2020-11-04T09:31:50Z", "message": "Handle group- and org-specific image pillars"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b87bb1658309c10087308f6f263f92af39836326", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b87bb1658309c10087308f6f263f92af39836326", "committedDate": "2020-11-04T09:31:50Z", "message": "Unit test for ImageSyncedPillar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fdc7ce1c93cc9c1de61fb5ee386420897b6d41e", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5fdc7ce1c93cc9c1de61fb5ee386420897b6d41e", "committedDate": "2020-11-04T09:31:50Z", "message": "Test for ImageSyncedEventMessageAction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb4d31633d6fe96324a233d74786fb2e4bf646cd", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/eb4d31633d6fe96324a233d74786fb2e4bf646cd", "committedDate": "2020-11-04T09:31:50Z", "message": "Update changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbe57813f41e7ea8d7e87396de133b45dccc4465", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bbe57813f41e7ea8d7e87396de133b45dccc4465", "committedDate": "2020-11-04T09:31:50Z", "message": "Fix JobReturnEventMessageActionTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55a55201446fca7ce9da66cbbd23e84c0eae433b", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/55a55201446fca7ce9da66cbbd23e84c0eae433b", "committedDate": "2020-11-03T10:17:14Z", "message": "Fix JobReturnEventMessageActionTest"}, "afterCommit": {"oid": "bbe57813f41e7ea8d7e87396de133b45dccc4465", "author": {"user": {"login": "nadvornik", "name": "Vladimir Nadvornik"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bbe57813f41e7ea8d7e87396de133b45dccc4465", "committedDate": "2020-11-04T09:31:50Z", "message": "Fix JobReturnEventMessageActionTest"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 927, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}