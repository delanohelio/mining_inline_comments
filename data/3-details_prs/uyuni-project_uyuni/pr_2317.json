{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMzQyNjMx", "number": 2317, "title": "Virt disks", "bodyText": "What does this PR change?\nAllow selecting volumes as VM disks and allow attaching / detaching cdrom iso images.\nGUI diff\nBefore:\n\nAfter:\n\n\n DONE\n\nDocumentation\n\n\n(OPTIONAL) Documentation PR\n\n\n DONE\n\n\nTest coverage\n\n\nUnit tests were added\n\n\nCucumber tests were added\n\n\n DONE\n\n\nLinks\nFixes SUSE/spacewalk#11007\nRequires openSUSE/salt#236 in the salt package\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-06-10T09:54:21Z", "url": "https://github.com/uyuni-project/uyuni/pull/2317", "merged": true, "mergeCommit": {"oid": "25c3d58fb3733467f6cc1b5ce529207306f17393"}, "closed": true, "closedAt": "2020-06-19T13:45:32Z", "author": {"login": "cbosdo"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqiG-3ABqjM0MzgyMzM0MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcszDaRABqjM0NjI0NTg4NDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0094885009a9ae6ac8b7c1ffbbb04fc6ee95267c", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0094885009a9ae6ac8b7c1ffbbb04fc6ee95267c", "committedDate": "2020-06-10T10:07:55Z", "message": "Update changelogs"}, "afterCommit": {"oid": "7c93cc9b53c10c5557030ac6125ae695511403ce", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7c93cc9b53c10c5557030ac6125ae695511403ce", "committedDate": "2020-06-12T12:35:06Z", "message": "Don't remove the virtual instance when deleting a virtual system\n\nWhen a virtual instance's host is known don't remove it when deleting\nthe system otherwise the VM will disappear from the guests list of the\nhost too."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c93cc9b53c10c5557030ac6125ae695511403ce", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7c93cc9b53c10c5557030ac6125ae695511403ce", "committedDate": "2020-06-12T12:35:06Z", "message": "Don't remove the virtual instance when deleting a virtual system\n\nWhen a virtual instance's host is known don't remove it when deleting\nthe system otherwise the VM will disappear from the guests list of the\nhost too."}, "afterCommit": {"oid": "87afc2c9d7e4b54472425f0580ea5d9e85240cdb", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/87afc2c9d7e4b54472425f0580ea5d9e85240cdb", "committedDate": "2020-06-15T08:14:37Z", "message": "Don't remove the virtual instance when deleting a virtual system\n\nWhen a virtual instance's host is known don't remove it when deleting\nthe system otherwise the VM will disappear from the guests list of the\nhost too."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNDgzOTMx", "url": "https://github.com/uyuni-project/uyuni/pull/2317#pullrequestreview-430483931", "createdAt": "2020-06-15T09:43:44Z", "commit": {"oid": "87afc2c9d7e4b54472425f0580ea5d9e85240cdb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87afc2c9d7e4b54472425f0580ea5d9e85240cdb", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/87afc2c9d7e4b54472425f0580ea5d9e85240cdb", "committedDate": "2020-06-15T08:14:37Z", "message": "Don't remove the virtual instance when deleting a virtual system\n\nWhen a virtual instance's host is known don't remove it when deleting\nthe system otherwise the VM will disappear from the guests list of the\nhost too."}, "afterCommit": {"oid": "fd598ffa885933eeb6f26bb829c62128a7505ee6", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/fd598ffa885933eeb6f26bb829c62128a7505ee6", "committedDate": "2020-06-17T13:43:54Z", "message": "Update changelogs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b34cb5b6d0f8cc7ba7984333d566e9533ee24bd2", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b34cb5b6d0f8cc7ba7984333d566e9533ee24bd2", "committedDate": "2020-06-19T09:54:45Z", "message": "VM properties dialog: convert disks fields into components\n\nThe existing code was not using React components enough. Converting\nbefore heavy changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51d00ae7169184275d378dd7ef885013f7d059ee", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/51d00ae7169184275d378dd7ef885013f7d059ee", "committedDate": "2020-06-19T09:54:46Z", "message": "Remove the disk type from the VM properties dialog\n\nThe user doesn't need to specify the disk type for each disk: this will\nbe guessed from the source value. Either it is a file path or a volume\nname."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa98fd0053e131d60086046ada5fcaa5b4dbf00b", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/aa98fd0053e131d60086046ada5fcaa5b4dbf00b", "committedDate": "2020-06-19T09:54:46Z", "message": "Convert GuestProperties to a function component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d91b19d5c60b3e51f09a1bef5ea759305063408", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6d91b19d5c60b3e51f09a1bef5ea759305063408", "committedDate": "2020-06-19T09:54:46Z", "message": "VM editing dialog: split disk fields into one component per type\n\nSince disk of various types may have different uses and fields, split\nthose into multiple components."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ea83437096825487f5b0fba7d73e9a05be7859c", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4ea83437096825487f5b0fba7d73e9a05be7859c", "committedDate": "2020-06-19T09:54:46Z", "message": "virt: handle cdrom devices as disks of file type\n\ncdrom devices are pretty likely not to be volumes. Use the file type for\nthem so that users can select file path or URL for the ISO.\n\nAlso remove the paravirtualized items from the busses list since those\naren't supporting cdrom devices."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5deea3b02e7269162862b4f6a183888dfed00e3a", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5deea3b02e7269162862b4f6a183888dfed00e3a", "committedDate": "2020-06-19T09:54:46Z", "message": "virt: add volumes listbox for disks of volume type\n\nTo allow the user to select an existing volume add a volume listbox in\nthe GuestDiskVolumeFields component."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f9144743ed1381b9f54693a1d4b9c4d7beb8477", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5f9144743ed1381b9f54693a1d4b9c4d7beb8477", "committedDate": "2020-06-19T09:54:46Z", "message": "virt: get pool capabilities in GuestProperties\n\nThe pool capabilities will come in helpful to populate the disk fields."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c12b5f92a3a32ef8f7d5c0815b9a93889d9dc787", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c12b5f92a3a32ef8f7d5c0815b9a93889d9dc787", "committedDate": "2020-06-19T09:54:46Z", "message": "virt: add disk format field\n\nSo far we are defaulting the disk format to qcow2... which works in the\nmajority of cases, but we need to handle other formats. This is even\nmore important when dealing with non-file disks or cdroms devices."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbd721d246a04c023330c4faf9dcc1614af0c3be", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/dbd721d246a04c023330c4faf9dcc1614af0c3be", "committedDate": "2020-06-19T09:54:46Z", "message": "Set the disk volume name in query and state\n\nSalt uses the source_file property to reuse an existing volume in a\npool. Use this property in the UI and query for that too."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzOTQ1NDMx", "url": "https://github.com/uyuni-project/uyuni/pull/2317#pullrequestreview-433945431", "createdAt": "2020-06-19T09:48:32Z", "commit": {"oid": "fd598ffa885933eeb6f26bb829c62128a7505ee6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwOTo0ODozM1rOGmO3zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwOTo0ODozM1rOGmO3zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0MjczMg==", "bodyText": "Nitpick:  Arrays.asList(\"rbd\", \"gluster\") can be extracted into a constant.", "url": "https://github.com/uyuni-project/uyuni/pull/2317#discussion_r442742732", "createdAt": "2020-06-19T09:48:33Z", "author": {"login": "mateiw"}, "path": "java/code/src/com/suse/manager/virtualization/GuestDiskDef.java", "diffHunk": "@@ -187,6 +190,31 @@ public static GuestDiskDef parse(Element node) throws IllegalArgumentException {\n                     }\n                 });\n             }\n+\n+            // virt.vm_info provides consolidated file using pools when possible, use it\n+            Optional<VmInfoDiskJson> diskInfo = vmInfo.map(info -> info.getDisks().get(disk.getTarget()));\n+            diskInfo.ifPresent(info -> {\n+                if (\"network\".equals(disk.getType())) {\n+                    String protocol = (String)source.get(\"protocol\");\n+                    // RBD and gluster volumes are automatically converted to network disks. Take the infos from Salt\n+                    if (Arrays.asList(\"rbd\", \"gluster\").contains(protocol) &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd598ffa885933eeb6f26bb829c62128a7505ee6"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd598ffa885933eeb6f26bb829c62128a7505ee6", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/fd598ffa885933eeb6f26bb829c62128a7505ee6", "committedDate": "2020-06-17T13:43:54Z", "message": "Update changelogs"}, "afterCommit": {"oid": "bcb9f512a89b7291f862597f6df812296a73648d", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bcb9f512a89b7291f862597f6df812296a73648d", "committedDate": "2020-06-19T10:12:44Z", "message": "Update changelogs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42a5cd80c5238637b56518b077a4e3825f268abd", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/42a5cd80c5238637b56518b077a4e3825f268abd", "committedDate": "2020-06-19T13:27:26Z", "message": "virt getDefinition: merge data from virt.get_xml and virt.vm_info\n\nvirt.vm_info holds the proper pool and volume pair while the XML\ndefinition may have something different like in the RBD case. Merge the\nvirt.vm_info disks data into the existing GuestDefinition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a20cf7657ed2ed960061b71eae204136d09067a", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2a20cf7657ed2ed960061b71eae204136d09067a", "committedDate": "2020-06-19T13:27:26Z", "message": "VM create/edit: make cdrom path editable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80e30cf076194c1d07418ab27862d86192bea026", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/80e30cf076194c1d07418ab27862d86192bea026", "committedDate": "2020-06-19T13:27:26Z", "message": "VM events: don't flag VM as stopped in live updates\n\nWhen updating a VM that is running we need to keep its state rather than\nforcing it marked as stopped."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65ffbed049078f68c9209e42f5878b8322fc202e", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/65ffbed049078f68c9209e42f5878b8322fc202e", "committedDate": "2020-06-19T13:27:26Z", "message": "Timeout version of 'I wait until table row for \"test-vm\" contains button \"Resume\"'\n\nSince we want to have longer timeout for this step in the Xen virtual\nhost case, add another step allowing to set how much we wnt to wait."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "100eab85716f753bfab601e5c58fb68d138266bb", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/100eab85716f753bfab601e5c58fb68d138266bb", "committedDate": "2020-06-19T13:27:26Z", "message": "testsuite: fix minxen feature to pass on nested Xen\n\nIn order to automate the virtualization featutes tests on Xen hypervisor\nwe need to use a nested Xen setup... but this introduces some latencies.\nIncrease some timeouts to handle this.\n\nWe also need to reduce the amount of memory allocated to each test VM.\nWith a 2GB virtual-host, even if we only set 800MB for Dom0 we can't\nspend too much on the VMs.\n\nThis commit also fixes a few Xen-related testsuite issues, like:\n\n * the console file log is a KVM-only feature: use a file console\n   instead.\n * fix the storage pool tests: default pool doesn't exist in the test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "970312b760601dd5ce94b8df585b378fcdc5dba4", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/970312b760601dd5ce94b8df585b378fcdc5dba4", "committedDate": "2020-06-19T13:27:27Z", "message": "Test the virtualization host formula"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e578d43ecb812f9cf17700290f4463dd4764571", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1e578d43ecb812f9cf17700290f4463dd4764571", "committedDate": "2020-06-19T13:27:27Z", "message": "testsuite: KVM restart the minion after applying entitlement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b1be6c11ea602054fb4c1baf41f23f71112051c", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4b1be6c11ea602054fb4c1baf41f23f71112051c", "committedDate": "2020-06-19T13:27:27Z", "message": "virt: update tests to handle volume disks\n\nSince the disks are now handled as volumes in pools, the tests need to\nbe adjusted."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7267335dd1a04edc9003e56b1fcf885ae8017d5", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/e7267335dd1a04edc9003e56b1fcf885ae8017d5", "committedDate": "2020-06-19T13:27:27Z", "message": "testsuite: Test cdrom attach and volume selection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d338512ea3940f782eaec5077a1cfca6840685c", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1d338512ea3940f782eaec5077a1cfca6840685c", "committedDate": "2020-06-19T13:27:27Z", "message": "Update changelogs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcb9f512a89b7291f862597f6df812296a73648d", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bcb9f512a89b7291f862597f6df812296a73648d", "committedDate": "2020-06-19T10:12:44Z", "message": "Update changelogs"}, "afterCommit": {"oid": "1d338512ea3940f782eaec5077a1cfca6840685c", "author": {"user": {"login": "cbosdo", "name": "Cedric Bosdonnat"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1d338512ea3940f782eaec5077a1cfca6840685c", "committedDate": "2020-06-19T13:27:27Z", "message": "Update changelogs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1321, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}