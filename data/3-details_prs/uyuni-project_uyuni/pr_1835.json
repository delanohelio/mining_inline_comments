{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NTg1MjM0", "number": 1835, "title": "Migrate pillar and formula data on minion id change", "bodyText": "What does this PR change?\nWhen salt client change its minion id, uyuni correctly recognized this and adapt the database entry. However do nothing else and pillar data together with formula data are not renamed/recreated. This then causes missing pillar information for new minion id.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: bugfix\n\n\n DONE\n\n\nTest coverage\n\n\nUnit tests TODO\n\n\nCucumber tests were added\n\n\n DONE\n\n\nLinks\nFixes SUSE/spacewalk#10496\nTracks # add downstream PR, if any\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-01-27T16:28:21Z", "url": "https://github.com/uyuni-project/uyuni/pull/1835", "merged": true, "mergeCommit": {"oid": "7a330e16ea67eca7d43ffc29aafacb9b4208afb5"}, "closed": true, "closedAt": "2020-02-06T14:28:02Z", "author": {"login": "aaannz"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAs_8egBqjMwMDIyMDI5NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBq0wzgBqjMwMTM4ODc4MTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fb36c11ab41149c2102a865abb54f260b97ca27", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5fb36c11ab41149c2102a865abb54f260b97ca27", "committedDate": "2020-01-27T16:23:26Z", "message": "Migrate pillar and formula data on minion id change"}, "afterCommit": {"oid": "4d3d0bea0ce982556f1f61e6fc338d0e21b1845c", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4d3d0bea0ce982556f1f61e6fc338d0e21b1845c", "committedDate": "2020-02-03T13:31:14Z", "message": "Migrate pillar and formula data on minion id change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d3d0bea0ce982556f1f61e6fc338d0e21b1845c", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4d3d0bea0ce982556f1f61e6fc338d0e21b1845c", "committedDate": "2020-02-03T13:31:14Z", "message": "Migrate pillar and formula data on minion id change"}, "afterCommit": {"oid": "ce090dee1c6ea2687f62f0ef44a1b2d1d478f432", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ce090dee1c6ea2687f62f0ef44a1b2d1d478f432", "committedDate": "2020-02-03T16:20:11Z", "message": "Allow twenties in copyright year"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjE1ODMw", "url": "https://github.com/uyuni-project/uyuni/pull/1835#pullrequestreview-353615830", "createdAt": "2020-02-05T10:38:00Z", "commit": {"oid": "ce090dee1c6ea2687f62f0ef44a1b2d1d478f432"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMDozODowMFrOFlzGjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMDozOTo1M1rOFlzKOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE3ODg5Mg==", "bodyText": "Nitpick: just inline the Optional.of(oldMinionId) directly in method parameter", "url": "https://github.com/uyuni-project/uyuni/pull/1835#discussion_r375178892", "createdAt": "2020-02-05T10:38:00Z", "author": {"login": "admd"}, "path": "java/code/src/com/suse/manager/reactor/messaging/RegisterMinionEventMessageAction.java", "diffHunk": "@@ -225,15 +225,21 @@ public boolean checkIfMinionAlreadyRegistered(String minionId,\n             if (!minionId.equals(oldMinionId)) {\n                 LOG.warn(\"Minion '\" + oldMinionId + \"' already registered, updating \" +\n                         \"profile to '\" + minionId + \"' [\" + machineId + \"]\");\n+\n                 registeredMinion.setName(minionId);\n                 registeredMinion.setMinionId(minionId);\n                 ServerFactory.save(registeredMinion);\n-                SystemManager.addHistoryEvent(registeredMinion, \"Duplicate Machine ID\", \"Minion '\" +\n-                        oldMinionId + \"' has been updated to '\" + minionId + \"'\");\n \n-                if (!minionId.equals(oldMinionId)) {\n-                    SALT_SERVICE.deleteKey(oldMinionId);\n-                }\n+                SaltStateGeneratorService.INSTANCE.generatePillar(registeredMinion);\n+                SaltStateGeneratorService.INSTANCE.removePillar(oldMinionId);\n+\n+                Optional<String> optOldMinionId = Optional.of(oldMinionId);\n+                migrateMinionFormula(minionId, optOldMinionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce090dee1c6ea2687f62f0ef44a1b2d1d478f432"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE3OTgzNA==", "bodyText": "Nitpick: We are not checking here if the server is minion, rather it is already assumed so maybe update the method docs accordingly.", "url": "https://github.com/uyuni-project/uyuni/pull/1835#discussion_r375179834", "createdAt": "2020-02-05T10:39:53Z", "author": {"login": "admd"}, "path": "java/code/src/com/suse/manager/webui/services/SaltStateGeneratorService.java", "diffHunk": "@@ -384,9 +384,17 @@ private String getImagePillarFileName(OSImageInspectSlsResult.Bundle bundle) {\n      * @param minion the minion server\n      */\n     public void removePillar(MinionServer minion) {\n-        LOG.debug(\"Removing pillar file for minion: \" + minion.getMinionId());\n+        removePillar(minion.getMinionId());\n+    }\n+\n+    /**\n+     * Remove the corresponding pillar data if the server is a minion.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce090dee1c6ea2687f62f0ef44a1b2d1d478f432"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce090dee1c6ea2687f62f0ef44a1b2d1d478f432", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ce090dee1c6ea2687f62f0ef44a1b2d1d478f432", "committedDate": "2020-02-03T16:20:11Z", "message": "Allow twenties in copyright year"}, "afterCommit": {"oid": "496735686962fb29651f6ec00c46ec2b55f47191", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/496735686962fb29651f6ec00c46ec2b55f47191", "committedDate": "2020-02-05T12:46:02Z", "message": "Allow twenties in copyright year"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MzQ3MDcx", "url": "https://github.com/uyuni-project/uyuni/pull/1835#pullrequestreview-354347071", "createdAt": "2020-02-06T10:32:48Z", "commit": {"oid": "496735686962fb29651f6ec00c46ec2b55f47191"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "465732b4f679d3f1a2d6b1243f1fd73570938a2a", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/465732b4f679d3f1a2d6b1243f1fd73570938a2a", "committedDate": "2020-02-06T13:00:46Z", "message": "Migrate pillar and formula data on minion id change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "496735686962fb29651f6ec00c46ec2b55f47191", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/496735686962fb29651f6ec00c46ec2b55f47191", "committedDate": "2020-02-05T12:46:02Z", "message": "Allow twenties in copyright year"}, "afterCommit": {"oid": "465732b4f679d3f1a2d6b1243f1fd73570938a2a", "author": {"user": {"login": "aaannz", "name": "Ond\u0159ej Hole\u010dek"}}, "url": "https://github.com/uyuni-project/uyuni/commit/465732b4f679d3f1a2d6b1243f1fd73570938a2a", "committedDate": "2020-02-06T13:00:46Z", "message": "Migrate pillar and formula data on minion id change"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1754, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}