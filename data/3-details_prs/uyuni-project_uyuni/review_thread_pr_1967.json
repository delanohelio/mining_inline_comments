{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMzM1NTY1", "number": 1967, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNToxMjoxM1rODksRaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNToyMDo0MVrODksgSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODAwNjgxOnYy", "diffSide": "RIGHT", "path": "susemanager/src/mgr-create-bootstrap-repo", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNToxMjoxM1rOFxJ21w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjowMDowNFrOFxL6IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NjAzOQ==", "bodyText": "In the end this is to generate the repo first, replace the old then. Or am I missing anything?", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387086039", "createdAt": "2020-03-03T15:12:13Z", "author": {"login": "juliogonzalez"}, "path": "susemanager/src/mgr-create-bootstrap-repo", "diffHunk": "@@ -301,104 +433,158 @@ def create_repo(label, flush, additional=[]):\n             codename=\"bootstrap\"\n             reprepro_conf = reprepro_conf_tmpl.substitute(origin=\"mgr\",\n                     label=\"mgr\", codename=codename, arches=\"amd64 i386\", comps=\"main\", desc=\"Bootstrap repo\")\n-            reprepro_conf_dir = os.path.join(destdir, \"conf\")\n+            reprepro_conf_dir = os.path.join(destdirtmp, \"conf\")\n             if not os.path.exists(reprepro_conf_dir):\n                 os.makedirs(reprepro_conf_dir)\n             with open(os.path.join(reprepro_conf_dir, \"distributions\"), \"w\") as conf_file:\n                 conf_file.write(reprepro_conf)\n-            logging.debug(\"Created reprepro config file in {0}\".format(os.path.join(destdir, \"distributions\")))\n+            log(\"Created reprepro config file in {0}\".format(os.path.join(destdirtmp, \"distributions\")), 2)\n             debs = [os.path.join(debs_dir, f) for f in os.listdir(debs_dir)]\n             try:\n-                subprocess.run([\"/usr/bin/reprepro\", \"-b\", destdir, \"includedeb\", codename] + debs, check=True)\n-                logging.debug(\"Removing directory {0}\".format(debs_dir))\n+                subprocess.run([\"/usr/bin/reprepro\", \"-b\", destdirtmp, \"includedeb\", codename] + debs, check=True)\n+                log(\"Removing directory {0}\".format(debs_dir), 2)\n                 shutil.rmtree(debs_dir, ignore_errors=True)\n             except subprocess.CalledProcessError as err:\n-                print(\"Error creating bootstrap repo.\")\n-                logging.debug(err)\n-                sys.exit(1)\n-        else:    \n-            os.system(\"createrepo -s sha %s\" % destdir)\n+                log_error(\"Error creating bootstrap repo.\")\n+                log(err, 2)\n+                return 1\n+        else:\n+            os.system(\"createrepo -s sha %s\" % destdirtmp)\n+        # move tmp dir to final location", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 556}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExOTY0OQ==", "bodyText": "Right and do this as quick as possible.\nSo we rename the existing to \".old\" first. Then the newly created \".tmp\" to the really used name. At this point it is \"life\". Now we have time to remove the \".old\" repo as it is not needed anymore.", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387119649", "createdAt": "2020-03-03T16:00:04Z", "author": {"login": "mcalmer"}, "path": "susemanager/src/mgr-create-bootstrap-repo", "diffHunk": "@@ -301,104 +433,158 @@ def create_repo(label, flush, additional=[]):\n             codename=\"bootstrap\"\n             reprepro_conf = reprepro_conf_tmpl.substitute(origin=\"mgr\",\n                     label=\"mgr\", codename=codename, arches=\"amd64 i386\", comps=\"main\", desc=\"Bootstrap repo\")\n-            reprepro_conf_dir = os.path.join(destdir, \"conf\")\n+            reprepro_conf_dir = os.path.join(destdirtmp, \"conf\")\n             if not os.path.exists(reprepro_conf_dir):\n                 os.makedirs(reprepro_conf_dir)\n             with open(os.path.join(reprepro_conf_dir, \"distributions\"), \"w\") as conf_file:\n                 conf_file.write(reprepro_conf)\n-            logging.debug(\"Created reprepro config file in {0}\".format(os.path.join(destdir, \"distributions\")))\n+            log(\"Created reprepro config file in {0}\".format(os.path.join(destdirtmp, \"distributions\")), 2)\n             debs = [os.path.join(debs_dir, f) for f in os.listdir(debs_dir)]\n             try:\n-                subprocess.run([\"/usr/bin/reprepro\", \"-b\", destdir, \"includedeb\", codename] + debs, check=True)\n-                logging.debug(\"Removing directory {0}\".format(debs_dir))\n+                subprocess.run([\"/usr/bin/reprepro\", \"-b\", destdirtmp, \"includedeb\", codename] + debs, check=True)\n+                log(\"Removing directory {0}\".format(debs_dir), 2)\n                 shutil.rmtree(debs_dir, ignore_errors=True)\n             except subprocess.CalledProcessError as err:\n-                print(\"Error creating bootstrap repo.\")\n-                logging.debug(err)\n-                sys.exit(1)\n-        else:    \n-            os.system(\"createrepo -s sha %s\" % destdir)\n+                log_error(\"Error creating bootstrap repo.\")\n+                log(err, 2)\n+                return 1\n+        else:\n+            os.system(\"createrepo -s sha %s\" % destdirtmp)\n+        # move tmp dir to final location", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NjAzOQ=="}, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 556}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODAxNDE0OnYy", "diffSide": "RIGHT", "path": "susemanager/susemanager.changes", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNToxMzo1NFrOFxJ7Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjowNDozNVrOFxMGAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NzE4Mw==", "bodyText": "It seems to me we need another entry to mention the support for Beta channels, no?", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387087183", "createdAt": "2020-03-03T15:13:54Z", "author": {"login": "juliogonzalez"}, "path": "susemanager/susemanager.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- add automatic mode to mgr-create-bootstrap-repo", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNzIxNQ==", "bodyText": "Ok, as we have bugreports about it, I will add a line", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387117215", "createdAt": "2020-03-03T15:56:45Z", "author": {"login": "mcalmer"}, "path": "susemanager/susemanager.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- add automatic mode to mgr-create-bootstrap-repo", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NzE4Mw=="}, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyMjY5MA==", "bodyText": "done", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387122690", "createdAt": "2020-03-03T16:04:35Z", "author": {"login": "mcalmer"}, "path": "susemanager/susemanager.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- add automatic mode to mgr-create-bootstrap-repo", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NzE4Mw=="}, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODAxODc0OnYy", "diffSide": "RIGHT", "path": "susemanager/rhn-conf/rhn_server_susemanager.conf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNToxNTowMVrOFxJ-Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo1NjowMFrOFxLuSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NzkxOA==", "bodyText": "Is this because we plan to support more data files :-?", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387087918", "createdAt": "2020-03-03T15:15:01Z", "author": {"login": "juliogonzalez"}, "path": "susemanager/rhn-conf/rhn_server_susemanager.conf", "diffHunk": "@@ -28,3 +28,9 @@ temp_token_lifetime = 60\n token_lifetime = 525600\n # automatically deploy tokens once they are refreshed\n token_refresh_auto_deploy = true\n+\n+# when re-generating bootstrap repos remove old content first\n+bootstrap_repo_flush = 1\n+\n+# data module used for mgr-create-bootstrap-repo\n+bootstrap_repo_datamodule = mgr_bootstrap_data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNjYxNw==", "bodyText": "In case a customer must change the package list he can write his own file and configure the tool to use it. Our mgr_bootstrap_data.py file is not a config, it is a data file which will be overwritten with every update.\nI think we will not prominent announce this, but it is there when needed .", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387116617", "createdAt": "2020-03-03T15:56:00Z", "author": {"login": "mcalmer"}, "path": "susemanager/rhn-conf/rhn_server_susemanager.conf", "diffHunk": "@@ -28,3 +28,9 @@ temp_token_lifetime = 60\n token_lifetime = 525600\n # automatically deploy tokens once they are refreshed\n token_refresh_auto_deploy = true\n+\n+# when re-generating bootstrap repos remove old content first\n+bootstrap_repo_flush = 1\n+\n+# data module used for mgr-create-bootstrap-repo\n+bootstrap_repo_datamodule = mgr_bootstrap_data", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NzkxOA=="}, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODAyNTMwOnYy", "diffSide": "RIGHT", "path": "susemanager/src/mgr-create-bootstrap-repo", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNToxNjoxOFrOFxKB_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo1NDoxNVrOFxLpog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODg5Mw==", "bodyText": "As far as I can see, this log is now always generated.\nIIUC, then I strongly suggest we add this info to the help of this script.", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387088893", "createdAt": "2020-03-03T15:16:18Z", "author": {"login": "juliogonzalez"}, "path": "susemanager/src/mgr-create-bootstrap-repo", "diffHunk": "@@ -1,41 +1,58 @@\n #!/usr/bin/python3\n-from __future__ import print_function\n+\n import sys\n import os\n import shutil\n-import logging\n import subprocess\n+import time\n+import traceback\n+from optparse import OptionParser\n+from rhn import rhnLockfile\n from spacewalk.server import rhnSQL\n-from uyuni.common import usix\n+from spacewalk.common.rhnLog import initLOG, log_time, log_clean\n from spacewalk.common.rhnConfig import CFG, initCFG\n-from optparse import OptionParser\n-import textwrap\n from string import Template\n-\n-try:\n-   input = raw_input\n-except NameError:\n-   pass\n-\n-msg_wrapper = textwrap.TextWrapper()\n-msg_wrapper.initial_indent = '- '\n-msg_wrapper.width = 75\n-msg_wrapper.subsequent_indent = '  '\n+from uyuni.common import usix, rhnLib\n \n sys.path.append(\"/usr/share/susemanager\")\n \n initCFG('server.susemanager')\n rhnSQL.initDB()\n \n basepath = CFG.MOUNT_POINT or '/var/spacewalk'\n+logfile = '/var/log/rhn/mgr-create-bootstrap-repo.log'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNTQyNg==", "bodyText": "ok, and I added the file to logrotate configuration", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387115426", "createdAt": "2020-03-03T15:54:15Z", "author": {"login": "mcalmer"}, "path": "susemanager/src/mgr-create-bootstrap-repo", "diffHunk": "@@ -1,41 +1,58 @@\n #!/usr/bin/python3\n-from __future__ import print_function\n+\n import sys\n import os\n import shutil\n-import logging\n import subprocess\n+import time\n+import traceback\n+from optparse import OptionParser\n+from rhn import rhnLockfile\n from spacewalk.server import rhnSQL\n-from uyuni.common import usix\n+from spacewalk.common.rhnLog import initLOG, log_time, log_clean\n from spacewalk.common.rhnConfig import CFG, initCFG\n-from optparse import OptionParser\n-import textwrap\n from string import Template\n-\n-try:\n-   input = raw_input\n-except NameError:\n-   pass\n-\n-msg_wrapper = textwrap.TextWrapper()\n-msg_wrapper.initial_indent = '- '\n-msg_wrapper.width = 75\n-msg_wrapper.subsequent_indent = '  '\n+from uyuni.common import usix, rhnLib\n \n sys.path.append(\"/usr/share/susemanager\")\n \n initCFG('server.susemanager')\n rhnSQL.initDB()\n \n basepath = CFG.MOUNT_POINT or '/var/spacewalk'\n+logfile = '/var/log/rhn/mgr-create-bootstrap-repo.log'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4ODg5Mw=="}, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODAzNjg4OnYy", "diffSide": "RIGHT", "path": "java/spacewalk-java.spec", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNToxODo0N1rOFxKI5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjowMToyN1rOFxL9-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MDY2MQ==", "bodyText": "Can you refresh my mind? What was the idea here, changing this manually when we are not doing SUSE Manager betas anymore?", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387090661", "createdAt": "2020-03-03T15:18:47Z", "author": {"login": "juliogonzalez"}, "path": "java/spacewalk-java.spec", "diffHunk": "@@ -500,9 +500,9 @@ install -m 644 conf/rhn_java_sso.conf $RPM_BUILD_ROOT%{_prefix}/share/rhn/config\n \n # Adjust product tree tag\n %if 0%{?sle_version} && !0%{?is_opensuse}\n-sed -i -e 's/^java.product_tree.tag =.*$/java.product_tree.tag = Beta/' $RPM_BUILD_ROOT%{_prefix}/share/rhn/config-defaults/rhn_java.conf\n+sed -i -e 's/^java.product_tree_tag =.*$/java.product_tree_tag = Beta/' $RPM_BUILD_ROOT%{_prefix}/share/rhn/config-defaults/rhn_java.conf", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyMDYzNA==", "bodyText": "Yes. For SUSE Manager we remove the line completly. We have the final real value commited in the config (SUMA4.1). Uyuni stays.", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387120634", "createdAt": "2020-03-03T16:01:27Z", "author": {"login": "mcalmer"}, "path": "java/spacewalk-java.spec", "diffHunk": "@@ -500,9 +500,9 @@ install -m 644 conf/rhn_java_sso.conf $RPM_BUILD_ROOT%{_prefix}/share/rhn/config\n \n # Adjust product tree tag\n %if 0%{?sle_version} && !0%{?is_opensuse}\n-sed -i -e 's/^java.product_tree.tag =.*$/java.product_tree.tag = Beta/' $RPM_BUILD_ROOT%{_prefix}/share/rhn/config-defaults/rhn_java.conf\n+sed -i -e 's/^java.product_tree_tag =.*$/java.product_tree_tag = Beta/' $RPM_BUILD_ROOT%{_prefix}/share/rhn/config-defaults/rhn_java.conf", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MDY2MQ=="}, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODA0NDkwOnYy", "diffSide": "RIGHT", "path": "susemanager/src/mgr-create-bootstrap-repo", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNToyMDo0MVrOFxKN1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjowMzowNVrOFxMCOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MTkyNw==", "bodyText": "Shouldn't we release the lock as well?", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387091927", "createdAt": "2020-03-03T15:20:41Z", "author": {"login": "juliogonzalez"}, "path": "susemanager/src/mgr-create-bootstrap-repo", "diffHunk": "@@ -301,104 +433,158 @@ def create_repo(label, flush, additional=[]):\n             codename=\"bootstrap\"\n             reprepro_conf = reprepro_conf_tmpl.substitute(origin=\"mgr\",\n                     label=\"mgr\", codename=codename, arches=\"amd64 i386\", comps=\"main\", desc=\"Bootstrap repo\")\n-            reprepro_conf_dir = os.path.join(destdir, \"conf\")\n+            reprepro_conf_dir = os.path.join(destdirtmp, \"conf\")\n             if not os.path.exists(reprepro_conf_dir):\n                 os.makedirs(reprepro_conf_dir)\n             with open(os.path.join(reprepro_conf_dir, \"distributions\"), \"w\") as conf_file:\n                 conf_file.write(reprepro_conf)\n-            logging.debug(\"Created reprepro config file in {0}\".format(os.path.join(destdir, \"distributions\")))\n+            log(\"Created reprepro config file in {0}\".format(os.path.join(destdirtmp, \"distributions\")), 2)\n             debs = [os.path.join(debs_dir, f) for f in os.listdir(debs_dir)]\n             try:\n-                subprocess.run([\"/usr/bin/reprepro\", \"-b\", destdir, \"includedeb\", codename] + debs, check=True)\n-                logging.debug(\"Removing directory {0}\".format(debs_dir))\n+                subprocess.run([\"/usr/bin/reprepro\", \"-b\", destdirtmp, \"includedeb\", codename] + debs, check=True)\n+                log(\"Removing directory {0}\".format(debs_dir), 2)\n                 shutil.rmtree(debs_dir, ignore_errors=True)\n             except subprocess.CalledProcessError as err:\n-                print(\"Error creating bootstrap repo.\")\n-                logging.debug(err)\n-                sys.exit(1)\n-        else:    \n-            os.system(\"createrepo -s sha %s\" % destdir)\n+                log_error(\"Error creating bootstrap repo.\")\n+                log(err, 2)\n+                return 1\n+        else:\n+            os.system(\"createrepo -s sha %s\" % destdirtmp)\n+        # move tmp dir to final location\n+        os.rename(destdir, destdirold)\n+        os.rename(destdirtmp, destdir)\n+        cleanup_dir(destdirold)\n+\n     if errors:\n         for m in messages:\n-            print(m)\n+            log_error(m)\n         if (label.startswith('RES') or label.startswith('RHEL') or label.lower().startswith('ubuntu'))  and not options.usecustomchannels:\n-            print(\"If the installation media was imported into a custom channel, try to run again with --with-custom-channels option\")\n+            log_error(\"If the installation media was imported into a custom channel, try to run again with --with-custom-channels option\")\n         suggestions = list([_f for _f in list(suggestions.values()) if _f])\n         if suggestions:\n-            print(\"\\nSuggestions:\")\n+            log_error(\"\\nSuggestions:\")\n             for suggestion in suggestions:\n-                print(msg_wrapper.fill(suggestion) + \"\\n\")\n-        sys.exit(1)\n+                log_error(suggestion)\n+        return 1\n+    return 0\n \n-usage = \"usage: %prog [options] [additional_pkg1 additional_pkg2 ...]\"\n-parser = OptionParser(usage=usage)\n-parser.add_option('-n', '--dryrun', action='store_true', dest='dryrun',\n-                  help='Dry run. Show only changes - do not execute them')\n-parser.add_option('-i', '--interactive', action='store_true', dest='interactive',\n-                  help='Interactive mode (default)')\n-parser.add_option('-l', '--list', action='store_true', dest='list',\n-                  help='list available distributions')\n-parser.add_option('-c', '--create', action='store', dest='create',\n-                  help='create bootstrap repo for given distribution label')\n-parser.add_option('-f', '--flush', action='store_true', dest='flush',\n-                  help='when used in conjuction with --create, deletes the target repository before creating it')\n-parser.add_option('', '--datamodule', action=\"store\", dest='datamodule',\n-                  help='Use an own datamodule (Default: mgr_bootstrap_data)')\n-parser.add_option('', '--with-custom-channels', action='store_true', dest='usecustomchannels',\n-                  help='Take custom channels into account when searching for newest package versions')\n-parser.add_option('', '--with-parent-channel', action=\"store\", dest='parentchannel',\n-                  help='use child channels below this parent')\n-parser.add_option('-d', '--debug', action='store_true', dest='debug',\n-                  help='Enable debug mode')\n-\n-(options, args) = parser.parse_args()\n-\n-if options.debug:\n-    logging.basicConfig(format='%(levelname)s:%(message)s', level=logging.DEBUG)\n-\n-modulename = \"mgr_bootstrap_data\"\n-if options.datamodule and options.datamodule != '':\n-    modulename = options.datamodule\n-\n-try:\n-    mgr_bootstrap_data = __import__(modulename)\n-    for label in mgr_bootstrap_data.DATA:\n-        if 'PDID' in mgr_bootstrap_data.DATA[label]:\n-            if not isinstance(mgr_bootstrap_data.DATA[label]['PDID'], usix.ListType):\n-                mgr_bootstrap_data.DATA[label]['PDID'] = list(map(str, [int(mgr_bootstrap_data.DATA[label]['PDID'])]))\n+def generate_all(options, mgr_bootstrap_data, additional=[]):\n+    repos = {}\n+    errors = 0\n+\n+    for dist in sorted(list_labels(mgr_bootstrap_data, do_print=False).values()):\n+        if mgr_bootstrap_data.DATA[dist]['DEST'] in repos:\n+            continue\n+        repos[mgr_bootstrap_data.DATA[dist]['DEST']] = mgr_bootstrap_data.DATA[dist]\n+        repos[mgr_bootstrap_data.DATA[dist]['DEST']]['DIST'] = dist\n+\n+    for dest, repo in repos.items():\n+        destfile = os.path.join(dest, 'repodata', 'repomd.xml')\n+        if 'TYPE' in repo and repo['TYPE'] == 'deb':\n+            destfile = os.path.join(dest, 'dists', 'bootstrap', 'Release')\n+\n+        filemodtime = 0\n+        if os.path.exists(destfile):\n+            filemodtime = os.path.getmtime(destfile)\n+\n+        log(\"{0} modified: {1}\".format(destfile, filemodtime), 2)\n+        if 'PDID' in repo:\n+            pdids = ', '.join(repo['PDID'])\n+            h = rhnSQL.prepare(rhnSQL.Statement(_find_mand_modified_repos % (pdids)))\n+            h.execute(filemod=time.strftime('%Y-%m-%d %H:%M:%S %z', time.localtime(filemodtime)))\n+        if 'BASECHANNEL' in repo:\n+            h = rhnSQL.prepare(rhnSQL.Statement(_find_modified_repos_by_basechannel))\n+            h.execute(filemod=time.strftime('%Y-%m-%d %H:%M:%S %z', time.localtime(filemodtime)), basechannel=repo['BASECHANNEL'])\n+\n+        res = h.fetchall_dict() or []\n+        if not res:\n+            continue\n+        regen = True\n+        oneNewerTimestamp = 0\n+        #import pdb; pdb.set_trace()\n+        for channelinfo in res:\n+            if channelinfo['newer'] == 1:\n+                log(\"{0} modified after last bootstrap generation\".format(channelinfo['label']), 2)\n+                regen = regen and True\n+                if channelinfo['last_synced'] and channelinfo['last_synced'].timestamp() > oneNewerTimestamp:\n+                    oneNewerTimestamp = channelinfo['last_synced'].timestamp()\n             else:\n-                mgr_bootstrap_data.DATA[label]['PDID'] = list(map(str, [int(pdid) for pdid in mgr_bootstrap_data.DATA[label]['PDID']]))\n+                log(\"{0} not modified\".format(channelinfo['label']), 2)\n+                regen = regen and False\n+        if not regen and oneNewerTimestamp > 0 and time.time() - oneNewerTimestamp > 4 * 60 * 60:\n+            log(\"latest channel sync at: {0}. Grace period over. Regenarate bootstrap repo.\".format(oneNewerTimestamp), 2)\n+            regen = True\n+        if regen:\n+            errors += create_repo(repo['DIST'], options, mgr_bootstrap_data, additional=additional)\n \n-except ImportError as e:\n-    sys.stderr.write(\"Unable to load module '%s'\\n\" % modulename)\n-    sys.stderr.write(str(e) + \"\\n\")\n-    sys.exit(1)\n+    return errors\n \n-dryrun = options.dryrun\n \n-if not options.list and not options.create:\n-    options.interactive = True\n \n-if options.interactive:\n-    label_map = list_labels()\n+#################################################################################\n+### main\n+#################################################################################\n \n-    elabel = None\n-    while True:\n-        try:\n-            elabel = label_map.get(int(input(\"Enter a number of a product label: \")), '')\n-            break\n-        except Exception:\n-            print(\"Please enter a number.\")\n-\n-    if elabel not in mgr_bootstrap_data.DATA:\n-        print(\"'%s' not found\" % elabel)\n+def main():\n+    # quick check to see if you are a super-user.\n+    if os.getuid() != 0:\n+        sys.stderr.write('ERROR: must be root to execute.\\n')\n         sys.exit(1)\n \n-    create_repo(elabel, options.flush, additional=args)\n-elif options.list:\n-    list_labels()\n-elif options.create:\n-    if options.create not in mgr_bootstrap_data.DATA:\n-        print(\"'%s' not found\" % options.create)\n+    global LOCK\n+    try:\n+        LOCK = rhnLockfile.Lockfile('/var/run/mgr-create-bootstrap-repo.pid')\n+    except rhnLockfile.LockfileLockedException:\n+        sys.stderr.write(\"ERROR: attempting to run more than one instance of \"\n+                         \"mgr-create-bootstrap-repo Exiting.\\n\")\n         sys.exit(1)\n-    create_repo(options.create, options.flush, additional=args)\n+\n+    global BETA\n+\n+    opts, args, mgr_bootstrap_data = cli()\n+    r = 0\n+\n+    if opts.auto:\n+        r = generate_all(opts, mgr_bootstrap_data, additional=args)\n+    elif opts.interactive:\n+        label_map = list_labels(mgr_bootstrap_data)\n+        if not label_map:\n+            log(\"No products available\")\n+            sys.exit(0)\n+\n+        elabel = None\n+        while True:\n+            try:\n+                elabel = label_map.get(int(input(\"Enter a number of a product label: \")), '')\n+                break\n+            except Exception:\n+                print(\"Please enter a number.\")\n+\n+        if elabel not in mgr_bootstrap_data.DATA:\n+            log_error(\"'%s' not found\" % elabel)\n+            sys.exit(1)\n+\n+        r = create_repo(elabel, opts, mgr_bootstrap_data, additional=args)\n+    elif opts.list:\n+        list_labels(mgr_bootstrap_data)\n+    elif opts.create:\n+        if opts.create not in mgr_bootstrap_data.DATA:\n+            log_error(\"'%s' not found\" % opts.create)\n+            sys.exit(1)\n+        r = create_repo(opts.create, opts, mgr_bootstrap_data, additional=args)\n+    releaseLOCK()\n+    return r\n+\n+if __name__ == '__main__':\n+    try:\n+        sys.exit(abs(main() or 0))\n+    except KeyboardInterrupt:\n+        sys.stderr.write(\"\\nProcess has been interrupted.\\n\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 753}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyMTcyMA==", "bodyText": "I just copied what spacewalk-repo-sync is doing and it does not release the lock in this case.", "url": "https://github.com/uyuni-project/uyuni/pull/1967#discussion_r387121720", "createdAt": "2020-03-03T16:03:05Z", "author": {"login": "mcalmer"}, "path": "susemanager/src/mgr-create-bootstrap-repo", "diffHunk": "@@ -301,104 +433,158 @@ def create_repo(label, flush, additional=[]):\n             codename=\"bootstrap\"\n             reprepro_conf = reprepro_conf_tmpl.substitute(origin=\"mgr\",\n                     label=\"mgr\", codename=codename, arches=\"amd64 i386\", comps=\"main\", desc=\"Bootstrap repo\")\n-            reprepro_conf_dir = os.path.join(destdir, \"conf\")\n+            reprepro_conf_dir = os.path.join(destdirtmp, \"conf\")\n             if not os.path.exists(reprepro_conf_dir):\n                 os.makedirs(reprepro_conf_dir)\n             with open(os.path.join(reprepro_conf_dir, \"distributions\"), \"w\") as conf_file:\n                 conf_file.write(reprepro_conf)\n-            logging.debug(\"Created reprepro config file in {0}\".format(os.path.join(destdir, \"distributions\")))\n+            log(\"Created reprepro config file in {0}\".format(os.path.join(destdirtmp, \"distributions\")), 2)\n             debs = [os.path.join(debs_dir, f) for f in os.listdir(debs_dir)]\n             try:\n-                subprocess.run([\"/usr/bin/reprepro\", \"-b\", destdir, \"includedeb\", codename] + debs, check=True)\n-                logging.debug(\"Removing directory {0}\".format(debs_dir))\n+                subprocess.run([\"/usr/bin/reprepro\", \"-b\", destdirtmp, \"includedeb\", codename] + debs, check=True)\n+                log(\"Removing directory {0}\".format(debs_dir), 2)\n                 shutil.rmtree(debs_dir, ignore_errors=True)\n             except subprocess.CalledProcessError as err:\n-                print(\"Error creating bootstrap repo.\")\n-                logging.debug(err)\n-                sys.exit(1)\n-        else:    \n-            os.system(\"createrepo -s sha %s\" % destdir)\n+                log_error(\"Error creating bootstrap repo.\")\n+                log(err, 2)\n+                return 1\n+        else:\n+            os.system(\"createrepo -s sha %s\" % destdirtmp)\n+        # move tmp dir to final location\n+        os.rename(destdir, destdirold)\n+        os.rename(destdirtmp, destdir)\n+        cleanup_dir(destdirold)\n+\n     if errors:\n         for m in messages:\n-            print(m)\n+            log_error(m)\n         if (label.startswith('RES') or label.startswith('RHEL') or label.lower().startswith('ubuntu'))  and not options.usecustomchannels:\n-            print(\"If the installation media was imported into a custom channel, try to run again with --with-custom-channels option\")\n+            log_error(\"If the installation media was imported into a custom channel, try to run again with --with-custom-channels option\")\n         suggestions = list([_f for _f in list(suggestions.values()) if _f])\n         if suggestions:\n-            print(\"\\nSuggestions:\")\n+            log_error(\"\\nSuggestions:\")\n             for suggestion in suggestions:\n-                print(msg_wrapper.fill(suggestion) + \"\\n\")\n-        sys.exit(1)\n+                log_error(suggestion)\n+        return 1\n+    return 0\n \n-usage = \"usage: %prog [options] [additional_pkg1 additional_pkg2 ...]\"\n-parser = OptionParser(usage=usage)\n-parser.add_option('-n', '--dryrun', action='store_true', dest='dryrun',\n-                  help='Dry run. Show only changes - do not execute them')\n-parser.add_option('-i', '--interactive', action='store_true', dest='interactive',\n-                  help='Interactive mode (default)')\n-parser.add_option('-l', '--list', action='store_true', dest='list',\n-                  help='list available distributions')\n-parser.add_option('-c', '--create', action='store', dest='create',\n-                  help='create bootstrap repo for given distribution label')\n-parser.add_option('-f', '--flush', action='store_true', dest='flush',\n-                  help='when used in conjuction with --create, deletes the target repository before creating it')\n-parser.add_option('', '--datamodule', action=\"store\", dest='datamodule',\n-                  help='Use an own datamodule (Default: mgr_bootstrap_data)')\n-parser.add_option('', '--with-custom-channels', action='store_true', dest='usecustomchannels',\n-                  help='Take custom channels into account when searching for newest package versions')\n-parser.add_option('', '--with-parent-channel', action=\"store\", dest='parentchannel',\n-                  help='use child channels below this parent')\n-parser.add_option('-d', '--debug', action='store_true', dest='debug',\n-                  help='Enable debug mode')\n-\n-(options, args) = parser.parse_args()\n-\n-if options.debug:\n-    logging.basicConfig(format='%(levelname)s:%(message)s', level=logging.DEBUG)\n-\n-modulename = \"mgr_bootstrap_data\"\n-if options.datamodule and options.datamodule != '':\n-    modulename = options.datamodule\n-\n-try:\n-    mgr_bootstrap_data = __import__(modulename)\n-    for label in mgr_bootstrap_data.DATA:\n-        if 'PDID' in mgr_bootstrap_data.DATA[label]:\n-            if not isinstance(mgr_bootstrap_data.DATA[label]['PDID'], usix.ListType):\n-                mgr_bootstrap_data.DATA[label]['PDID'] = list(map(str, [int(mgr_bootstrap_data.DATA[label]['PDID'])]))\n+def generate_all(options, mgr_bootstrap_data, additional=[]):\n+    repos = {}\n+    errors = 0\n+\n+    for dist in sorted(list_labels(mgr_bootstrap_data, do_print=False).values()):\n+        if mgr_bootstrap_data.DATA[dist]['DEST'] in repos:\n+            continue\n+        repos[mgr_bootstrap_data.DATA[dist]['DEST']] = mgr_bootstrap_data.DATA[dist]\n+        repos[mgr_bootstrap_data.DATA[dist]['DEST']]['DIST'] = dist\n+\n+    for dest, repo in repos.items():\n+        destfile = os.path.join(dest, 'repodata', 'repomd.xml')\n+        if 'TYPE' in repo and repo['TYPE'] == 'deb':\n+            destfile = os.path.join(dest, 'dists', 'bootstrap', 'Release')\n+\n+        filemodtime = 0\n+        if os.path.exists(destfile):\n+            filemodtime = os.path.getmtime(destfile)\n+\n+        log(\"{0} modified: {1}\".format(destfile, filemodtime), 2)\n+        if 'PDID' in repo:\n+            pdids = ', '.join(repo['PDID'])\n+            h = rhnSQL.prepare(rhnSQL.Statement(_find_mand_modified_repos % (pdids)))\n+            h.execute(filemod=time.strftime('%Y-%m-%d %H:%M:%S %z', time.localtime(filemodtime)))\n+        if 'BASECHANNEL' in repo:\n+            h = rhnSQL.prepare(rhnSQL.Statement(_find_modified_repos_by_basechannel))\n+            h.execute(filemod=time.strftime('%Y-%m-%d %H:%M:%S %z', time.localtime(filemodtime)), basechannel=repo['BASECHANNEL'])\n+\n+        res = h.fetchall_dict() or []\n+        if not res:\n+            continue\n+        regen = True\n+        oneNewerTimestamp = 0\n+        #import pdb; pdb.set_trace()\n+        for channelinfo in res:\n+            if channelinfo['newer'] == 1:\n+                log(\"{0} modified after last bootstrap generation\".format(channelinfo['label']), 2)\n+                regen = regen and True\n+                if channelinfo['last_synced'] and channelinfo['last_synced'].timestamp() > oneNewerTimestamp:\n+                    oneNewerTimestamp = channelinfo['last_synced'].timestamp()\n             else:\n-                mgr_bootstrap_data.DATA[label]['PDID'] = list(map(str, [int(pdid) for pdid in mgr_bootstrap_data.DATA[label]['PDID']]))\n+                log(\"{0} not modified\".format(channelinfo['label']), 2)\n+                regen = regen and False\n+        if not regen and oneNewerTimestamp > 0 and time.time() - oneNewerTimestamp > 4 * 60 * 60:\n+            log(\"latest channel sync at: {0}. Grace period over. Regenarate bootstrap repo.\".format(oneNewerTimestamp), 2)\n+            regen = True\n+        if regen:\n+            errors += create_repo(repo['DIST'], options, mgr_bootstrap_data, additional=additional)\n \n-except ImportError as e:\n-    sys.stderr.write(\"Unable to load module '%s'\\n\" % modulename)\n-    sys.stderr.write(str(e) + \"\\n\")\n-    sys.exit(1)\n+    return errors\n \n-dryrun = options.dryrun\n \n-if not options.list and not options.create:\n-    options.interactive = True\n \n-if options.interactive:\n-    label_map = list_labels()\n+#################################################################################\n+### main\n+#################################################################################\n \n-    elabel = None\n-    while True:\n-        try:\n-            elabel = label_map.get(int(input(\"Enter a number of a product label: \")), '')\n-            break\n-        except Exception:\n-            print(\"Please enter a number.\")\n-\n-    if elabel not in mgr_bootstrap_data.DATA:\n-        print(\"'%s' not found\" % elabel)\n+def main():\n+    # quick check to see if you are a super-user.\n+    if os.getuid() != 0:\n+        sys.stderr.write('ERROR: must be root to execute.\\n')\n         sys.exit(1)\n \n-    create_repo(elabel, options.flush, additional=args)\n-elif options.list:\n-    list_labels()\n-elif options.create:\n-    if options.create not in mgr_bootstrap_data.DATA:\n-        print(\"'%s' not found\" % options.create)\n+    global LOCK\n+    try:\n+        LOCK = rhnLockfile.Lockfile('/var/run/mgr-create-bootstrap-repo.pid')\n+    except rhnLockfile.LockfileLockedException:\n+        sys.stderr.write(\"ERROR: attempting to run more than one instance of \"\n+                         \"mgr-create-bootstrap-repo Exiting.\\n\")\n         sys.exit(1)\n-    create_repo(options.create, options.flush, additional=args)\n+\n+    global BETA\n+\n+    opts, args, mgr_bootstrap_data = cli()\n+    r = 0\n+\n+    if opts.auto:\n+        r = generate_all(opts, mgr_bootstrap_data, additional=args)\n+    elif opts.interactive:\n+        label_map = list_labels(mgr_bootstrap_data)\n+        if not label_map:\n+            log(\"No products available\")\n+            sys.exit(0)\n+\n+        elabel = None\n+        while True:\n+            try:\n+                elabel = label_map.get(int(input(\"Enter a number of a product label: \")), '')\n+                break\n+            except Exception:\n+                print(\"Please enter a number.\")\n+\n+        if elabel not in mgr_bootstrap_data.DATA:\n+            log_error(\"'%s' not found\" % elabel)\n+            sys.exit(1)\n+\n+        r = create_repo(elabel, opts, mgr_bootstrap_data, additional=args)\n+    elif opts.list:\n+        list_labels(mgr_bootstrap_data)\n+    elif opts.create:\n+        if opts.create not in mgr_bootstrap_data.DATA:\n+            log_error(\"'%s' not found\" % opts.create)\n+            sys.exit(1)\n+        r = create_repo(opts.create, opts, mgr_bootstrap_data, additional=args)\n+    releaseLOCK()\n+    return r\n+\n+if __name__ == '__main__':\n+    try:\n+        sys.exit(abs(main() or 0))\n+    except KeyboardInterrupt:\n+        sys.stderr.write(\"\\nProcess has been interrupted.\\n\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MTkyNw=="}, "originalCommit": {"oid": "4a9c662b48fc42462cdf6a453f8eb6de9bdda19f"}, "originalPosition": 753}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 194, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}