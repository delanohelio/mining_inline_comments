{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNDAyNzcy", "number": 1868, "title": "CLM: Module filters for RHEL modular repository support", "bodyText": "Introduces a new type of CLM filter named 'AppStream filters' for selecting AppStreams in modular repositories and building flattened \"regular\" repositories from them.\nFor more context, the detailed design is described in the RFC: Modular repositories with CLM\nThe Python API implementation: mgr-libmod\nGUI diff\nBefore:\n\nAfter:\n\n\nDocumentation\n\nhttps://github.com/SUSE/doc-susemanager/issues/915\n\nTest coverage\n\nUnit tests were added\n\nLinks\nFixes SUSE/spacewalk#10091\nEPIC: AppStream filters in CLM for modular repository support\nRFC: Modular Repositories with CLM\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-02-05T14:27:13Z", "url": "https://github.com/uyuni-project/uyuni/pull/1868", "merged": true, "mergeCommit": {"oid": "fd886ad54d976add20c7c376f5fa5cff60e75553"}, "closed": true, "closedAt": "2020-02-12T15:21:21Z", "author": {"login": "cbbayburt"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBXSmEABqjMwMTAyODEyMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDnlq_ABqjMwMzExMzE3Nzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc5b739ee2c636778ecfb49ffbaffed665fc2aa2", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bc5b739ee2c636778ecfb49ffbaffed665fc2aa2", "committedDate": "2020-02-05T14:13:32Z", "message": "Implement type-specific UI for AppStream filters"}, "afterCommit": {"oid": "b37aafeddc2d2e12a7c6f84d813104fb99a5b3f4", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b37aafeddc2d2e12a7c6f84d813104fb99a5b3f4", "committedDate": "2020-02-05T14:47:53Z", "message": "Implement type-specific UI for AppStream filters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b37aafeddc2d2e12a7c6f84d813104fb99a5b3f4", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b37aafeddc2d2e12a7c6f84d813104fb99a5b3f4", "committedDate": "2020-02-05T14:47:53Z", "message": "Implement type-specific UI for AppStream filters"}, "afterCommit": {"oid": "45eb680aeb86c37f69393c2e6223082a9cb1b7f6", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/45eb680aeb86c37f69393c2e6223082a9cb1b7f6", "committedDate": "2020-02-05T15:39:40Z", "message": "Implement type-specific UI for AppStream filters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTIzNTI4", "url": "https://github.com/uyuni-project/uyuni/pull/1868#pullrequestreview-354123528", "createdAt": "2020-02-05T23:57:15Z", "commit": {"oid": "45eb680aeb86c37f69393c2e6223082a9cb1b7f6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMzo1NzoxNVrOFmLRyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMDowMjoxN1rOFmLXGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NDk4Nw==", "bodyText": "why to call this if the return is not used?", "url": "https://github.com/uyuni-project/uyuni/pull/1868#discussion_r375574987", "createdAt": "2020-02-05T23:57:15Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/redhat/rhn/domain/contentmgmt/PackageFilter.java", "diffHunk": "@@ -61,7 +60,10 @@ public boolean test(Package pack) {\n             case \"nevr\":\n                 return type.cast(pack.getNameEvr());\n             case \"nevra\":\n-                return type.cast(pack.getNameEvra());\n+                pack.getNameEvra();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45eb680aeb86c37f69393c2e6223082a9cb1b7f6"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NjM0NA==", "bodyText": "this(null) : is this something special I do not know?", "url": "https://github.com/uyuni-project/uyuni/pull/1868#discussion_r375576344", "createdAt": "2020-02-06T00:02:17Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/redhat/rhn/manager/contentmgmt/ContentManager.java", "diffHunk": "@@ -81,9 +85,23 @@\n public class ContentManager {\n \n     private static final String DELIMITER = \"-\";\n+    private static final Logger LOG = Logger.getLogger(ContentManager.class);\n+    private ModulemdApi modulemdApi;\n \n-    // forbid instantiation\n-    private ContentManager() { }\n+    /**\n+     * Initialize a new instance\n+     */\n+    public ContentManager() {\n+        this(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45eb680aeb86c37f69393c2e6223082a9cb1b7f6"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTIwMTcy", "url": "https://github.com/uyuni-project/uyuni/pull/1868#pullrequestreview-354520172", "createdAt": "2020-02-06T15:05:21Z", "commit": {"oid": "45eb680aeb86c37f69393c2e6223082a9cb1b7f6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNTowNToyMlrOFmeVhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNTowNToyMlrOFmeVhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg4NzIzOQ==", "bodyText": "I gave it a try and if I just enter a fake name without any : in the value, it breaks the filters list page (it does not show anything but the error page) because it cannot return and Array of 3 values. We need to make sure the field is populated with valid values.", "url": "https://github.com/uyuni-project/uyuni/pull/1868#discussion_r375887239", "createdAt": "2020-02-06T15:05:22Z", "author": {"login": "ncounter"}, "path": "web/html/src/manager/content-management/list-filters/filter.utils.js", "diffHunk": "@@ -126,6 +129,12 @@ export function mapResponseToFilterForm(filtersResponse: Array<FilterServerType>\n         filterForm.release = release;\n         filterForm.architecture = architecture;\n       }\n+    } else if(filterResponse.criteriaKey === clmFilterOptions.STREAM.key) {\n+      if(!_isEmpty(filterResponse.criteriaValue)) {\n+        const [, module, stream] = filterResponse.criteriaValue.match(/(.*)(?::(.*))/);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45eb680aeb86c37f69393c2e6223082a9cb1b7f6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NTI5MTgx", "url": "https://github.com/uyuni-project/uyuni/pull/1868#pullrequestreview-356529181", "createdAt": "2020-02-11T09:59:59Z", "commit": {"oid": "145ef8f08a11b03021a6a87047d1f1cdb83bdad1"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwOTo1OTo1OVrOFoC7vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMDoxMzo1OVrOFoDXBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUzNTQyMA==", "bodyText": "I'm wondering: how is the mgr-libmod utility going to be distributed? Is this going to be a python script in the SUMA codebase, or a separate RPM? This must be clarified before releasing.", "url": "https://github.com/uyuni-project/uyuni/pull/1868#discussion_r377535420", "createdAt": "2020-02-11T09:59:59Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/domain/contentmgmt/modulemd/ModulemdApi.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+\n+package com.redhat.rhn.domain.contentmgmt.modulemd;\n+\n+import com.google.gson.FieldNamingPolicy;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+import com.redhat.rhn.common.conf.Config;\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.domain.channel.Channel;\n+import com.redhat.rhn.domain.channel.Modules;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * modulemd Python API service\n+ */\n+public class ModulemdApi {\n+\n+    private static final String MOUNT_POINT_PATH = Config.get().getString(ConfigDefaults.MOUNT_POINT);\n+    private static final String API_EXE = \"mgr-libmod\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145ef8f08a11b03021a6a87047d1f1cdb83bdad1"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUzNTgxOQ==", "bodyText": "Is this method used?", "url": "https://github.com/uyuni-project/uyuni/pull/1868#discussion_r377535819", "createdAt": "2020-02-11T10:00:54Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/domain/contentmgmt/modulemd/ModulemdApi.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+\n+package com.redhat.rhn.domain.contentmgmt.modulemd;\n+\n+import com.google.gson.FieldNamingPolicy;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+import com.redhat.rhn.common.conf.Config;\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.domain.channel.Channel;\n+import com.redhat.rhn.domain.channel.Modules;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStreamWriter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * modulemd Python API service\n+ */\n+public class ModulemdApi {\n+\n+    private static final String MOUNT_POINT_PATH = Config.get().getString(ConfigDefaults.MOUNT_POINT);\n+    private static final String API_EXE = \"mgr-libmod\";\n+    public static final Gson GSON =\n+            new GsonBuilder().setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES).create();\n+\n+    /**\n+     * Get all defined modules in a channel's metadata\n+     *\n+     * @param channel the modular channel\n+     * @return a map of module name to module/stream objects\n+     */\n+    public Map<String, List<Module>> getAllModulesInChannel(Channel channel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145ef8f08a11b03021a6a87047d1f1cdb83bdad1"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUzNzk4Mw==", "bodyText": "Just a question: Is stripping the metadata from the \"target\" channel something that needs to be done (to overcome some errors), or is it just for clarity (cloned channels shouldn't be modular).", "url": "https://github.com/uyuni-project/uyuni/pull/1868#discussion_r377537983", "createdAt": "2020-02-11T10:05:27Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/manager/contentmgmt/ContentManager.java", "diffHunk": "@@ -642,9 +660,38 @@ private static void alignEnvironment(ContentEnvironment env, Channel baseChannel\n                 .sorted((t1, t2) -> Boolean.compare(t1.getChannel().isBaseChannel(), t2.getChannel().isBaseChannel()))\n                 .forEach(toRemove -> ContentProjectFactory.purgeTarget(toRemove));\n \n-        // align the contents\n-        newSrcTgtPairs.forEach(srcTgt ->\n-                alignEnvironmentTarget(srcTgt.getLeft(), srcTgt.getRight(), filters, async, user));\n+        // Strip modules metadata from the modular repositories if any modular filter is present", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145ef8f08a11b03021a6a87047d1f1cdb83bdad1"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU0MDkzNQ==", "bodyText": "Is DEBUG enough here? I think the log threshold is set to INFO in regular setups - i.e. this message would be silenced. With my current understanding of the PR, this line shouldn't get hit on a correctly set-up project, so I'd be in favor of using at least INFO here.", "url": "https://github.com/uyuni-project/uyuni/pull/1868#discussion_r377540935", "createdAt": "2020-02-11T10:11:07Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/manager/contentmgmt/ContentManager.java", "diffHunk": "@@ -642,9 +660,38 @@ private static void alignEnvironment(ContentEnvironment env, Channel baseChannel\n                 .sorted((t1, t2) -> Boolean.compare(t1.getChannel().isBaseChannel(), t2.getChannel().isBaseChannel()))\n                 .forEach(toRemove -> ContentProjectFactory.purgeTarget(toRemove));\n \n-        // align the contents\n-        newSrcTgtPairs.forEach(srcTgt ->\n-                alignEnvironmentTarget(srcTgt.getLeft(), srcTgt.getRight(), filters, async, user));\n+        // Strip modules metadata from the modular repositories if any modular filter is present\n+        if (filters.stream().anyMatch(f -> f.asModuleFilter().isPresent())) {\n+            newSrcTgtPairs.stream().map(p -> p.getRight().getChannel()).forEach(this::stripModuleMetadata);\n+        }\n+\n+        // Resolve filters for dependencies\n+        try {\n+            DependencyResolver resolver = new DependencyResolver(env.getContentProject(), this.modulemdApi);\n+            List<ContentFilter> resolvedFilters = resolver.resolveFilters(filters);\n+\n+            // align the contents\n+            newSrcTgtPairs.forEach(srcTgt ->\n+                    alignEnvironmentTarget(srcTgt.getLeft(), srcTgt.getRight(), resolvedFilters, async, user));\n+        }\n+        catch (DependencyResolutionException e) {\n+            if (e.getCause() instanceof ModuleNotFoundException) {\n+                ModuleNotFoundException cause = (ModuleNotFoundException) e.getCause();\n+                LOG.debug(String.format(\"Module '%s:%s' not found.\", cause.getModule().getName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145ef8f08a11b03021a6a87047d1f1cdb83bdad1"}, "originalPosition": 242}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU0MjQwNA==", "bodyText": "I'm not sure getting all sources of a project in this situation is the right thing. I think we should filter out DETACHED sources, i.e. the sources flagged for removal after the project build. We had a similar situation in past for filters (they also support \"soft-delete\" mechanism) and for this purpose, we implemented a helper method ContentProject.getActiveFilters. Maybe we need something similar for the sources.", "url": "https://github.com/uyuni-project/uyuni/pull/1868#discussion_r377542404", "createdAt": "2020-02-11T10:13:59Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/manager/contentmgmt/DependencyResolver.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+\n+package com.redhat.rhn.manager.contentmgmt;\n+\n+import com.redhat.rhn.domain.channel.Channel;\n+import com.redhat.rhn.domain.contentmgmt.modulemd.ConflictingStreamsException;\n+import com.redhat.rhn.domain.contentmgmt.ContentFilter;\n+import com.redhat.rhn.domain.contentmgmt.ContentProject;\n+import com.redhat.rhn.domain.contentmgmt.FilterCriteria;\n+import com.redhat.rhn.domain.contentmgmt.modulemd.Module;\n+import com.redhat.rhn.domain.contentmgmt.ModuleFilter;\n+import com.redhat.rhn.domain.contentmgmt.modulemd.ModuleNotFoundException;\n+import com.redhat.rhn.domain.contentmgmt.modulemd.ModulemdApi;\n+import com.redhat.rhn.domain.contentmgmt.modulemd.ModulePackagesResponse;\n+import com.redhat.rhn.domain.contentmgmt.PackageFilter;\n+import com.redhat.rhn.domain.contentmgmt.ProjectSource;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n+import static com.suse.utils.Opt.stream;\n+import static java.util.stream.Collectors.toList;\n+\n+/**\n+ * Resolves dependencies in a content management project\n+ *\n+ * At the moment, dependency resolution only works with module filters and modular dependencies. This class can be\n+ * enhanced to resolve package dependencies as well.\n+ *\n+ * The resolution process takes the complete list of filters as input and queries the libmodulemd API with all the\n+ * module streams in filters. A module filter represents a selected module in one of the modular sources (filter rules\n+ * have no effect for module filters). The API returns all the related packages that must be allowed/denied as per\n+ * current module selection. In return, all module filters are translated into a collection of package filters by the\n+ * following rules:\n+ *\n+ * 1. All modular packages are denied (deny by nevra)\n+ * 2. For each package publicly provided by a module, all the packages from other sources with the same package name\n+ *    are denied. As a result, a specific package is only provided exclusively by the module to prevent any conflicts\n+ *    (deny by name).\n+ * 3. Modular packages from selected modules are overridden to be allowed (allow by nevra)\n+ *\n+ * This algorithm only runs if there are any module filters in the input list. Otherwise the process is bypassed and no\n+ * filter transformation is done.\n+ *\n+ * TODO: Resolve deny-allow override problem:\n+ * One problem with this approach is that the allow filters will override any further deny filters defined by the user\n+ * on those packages. We need to figure out if this is an important case and if so, come up with a different solution.\n+ *\n+ * @see com.redhat.rhn.manager.contentmgmt.test.DependencyResolverTest#testModuleFiltersForeignPackagesSelected\n+ * @see com.redhat.rhn.manager.contentmgmt.test.DependencyResolverTest#testModuleFiltersForeignPackagesConflicting\n+ *\n+ */\n+public class DependencyResolver {\n+\n+    private ContentProject project;\n+    private ModulemdApi modulemdApi;\n+\n+    /**\n+     * Initialize a new instance with a content project and a {@link ModulemdApi} instance\n+     *\n+     * @param projectIn the content project\n+     * @param modulemdApiIn the libmodulemd API instance\n+     */\n+    public DependencyResolver(ContentProject projectIn, ModulemdApi modulemdApiIn) {\n+        this.project = projectIn;\n+        this.modulemdApi = Objects.requireNonNullElseGet(modulemdApiIn, ModulemdApi::new);\n+    }\n+\n+    /**\n+     * Enhances the list of filters with dependency filters by looking up the dependencies in the sources\n+     *\n+     * @param filters the complete list of filters to be included in the project\n+     * @return the updated list of filters\n+     * @throws DependencyResolutionException if dependency resolution fails for some reason\n+     */\n+    public List<ContentFilter> resolveFilters(List<ContentFilter> filters) throws DependencyResolutionException {\n+\n+        List<ModuleFilter> moduleFilters = filters.stream()\n+                .flatMap(f -> stream((Optional<ModuleFilter>) f.asModuleFilter()))\n+                .collect(toList());\n+\n+        List<ContentFilter> updatedFilters = new ArrayList<>(filters);\n+\n+        // Transform module filters to package filters\n+        // If no module filters are attached, no modular package should be filtered out\n+        if (moduleFilters.size() > 0) {\n+            List<PackageFilter> modulePkgFilters = resolveModularDependencies(moduleFilters);\n+            updatedFilters.addAll(modulePkgFilters);\n+            updatedFilters.removeAll(moduleFilters);\n+        }\n+\n+        // Any other dependency filters (e.g. package dependencies) can be appended here\n+        // TODO: This module can also be called at setup time to provide feedback using DependencyResolutionException\n+\n+        return updatedFilters;\n+    }\n+\n+    /**\n+     * Resolves modular dependencies and convert all module filters to package filters\n+     *\n+     * @param filters the list of module filters to be included in the project\n+     * @return a list of package filters derived from the module filters, including dependencies\n+     */\n+    private List<PackageFilter> resolveModularDependencies(List<ModuleFilter> filters)\n+            throws DependencyResolutionException {\n+        List<Channel> sources = this.getSources();\n+        List<Module> modules = filters.stream().map(ModuleFilter::getModule).collect(toList());\n+        ModulePackagesResponse modPkgList;\n+        try {\n+            modPkgList = modulemdApi.getPackagesForModules(sources, modules);\n+        }\n+        catch (ConflictingStreamsException | ModuleNotFoundException e) {\n+            throw new DependencyResolutionException(\"Failed to resolve modular dependencies.\", e);\n+        }\n+\n+        // 1. Modular packages to be denied\n+        Stream<PackageFilter> pkgDenyFilters = modulemdApi.getAllPackages(sources).stream()\n+                .map((String nevra) -> initFilterFromPackageNevra(nevra, ContentFilter.Rule.DENY));\n+\n+        // 2. Non-modular packages to be denied by name\n+        Stream<PackageFilter> providedRpmApiFilters = modPkgList.getRpmApis().stream().map(\n+                DependencyResolver::initFilterFromPackageName);\n+\n+        // 3. Modular packages to be allowed\n+        Stream<PackageFilter> pkgAllowFilters = modPkgList.getRpmPackages().stream()\n+                .map((String nevra) -> initFilterFromPackageNevra(nevra, ContentFilter.Rule.ALLOW));\n+\n+        // Concatenate filter streams into a list\n+        return Stream.of(pkgDenyFilters, providedRpmApiFilters, pkgAllowFilters).flatMap(s -> s).collect(toList());\n+    }\n+\n+\n+    private static PackageFilter initFilterFromPackageNevra(String nevra, ContentFilter.Rule rule) {\n+        FilterCriteria criteria = new FilterCriteria(FilterCriteria.Matcher.EQUALS, \"nevra\", nevra);\n+        PackageFilter filter = new PackageFilter();\n+        filter.setRule(rule);\n+        filter.setCriteria(criteria);\n+        return filter;\n+    }\n+\n+    private static PackageFilter initFilterFromPackageName(String name) {\n+        FilterCriteria criteria = new FilterCriteria(FilterCriteria.Matcher.MATCHES, \"name\", name);\n+        PackageFilter filter = new PackageFilter();\n+        filter.setRule(ContentFilter.Rule.DENY);\n+        filter.setCriteria(criteria);\n+        return filter;\n+    }\n+\n+    /**\n+     * Get a list of modular channels among the sources\n+     * @return the list of modular channels\n+     */\n+    private List<Channel> getSources() {\n+        return project.getSources().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145ef8f08a11b03021a6a87047d1f1cdb83bdad1"}, "originalPosition": 170}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NjE2MTM2", "url": "https://github.com/uyuni-project/uyuni/pull/1868#pullrequestreview-356616136", "createdAt": "2020-02-11T12:27:14Z", "commit": {"oid": "145ef8f08a11b03021a6a87047d1f1cdb83bdad1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6494660d2d8a7aa5e47c84e7db4ef8e41cdcfc96", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6494660d2d8a7aa5e47c84e7db4ef8e41cdcfc96", "committedDate": "2020-02-11T15:48:42Z", "message": "fixup! Implement module filtering logic and dependency resolution"}, "afterCommit": {"oid": "c01c27496f2d443267c397ff92075cd15d36fe3c", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c01c27496f2d443267c397ff92075cd15d36fe3c", "committedDate": "2020-02-11T15:58:07Z", "message": "fixup! Implement module filtering logic and dependency resolution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "289e0a2f661a13ec4b2cd15791f7deeae523abc6", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/289e0a2f661a13ec4b2cd15791f7deeae523abc6", "committedDate": "2020-02-12T14:49:51Z", "message": "Add module stream filter type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "369e1cabd24a59937c2b845031fda4fde2668680", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/369e1cabd24a59937c2b845031fda4fde2668680", "committedDate": "2020-02-12T14:49:52Z", "message": "Implement module filtering logic and dependency resolution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a49e5c1024ee2209a3c70b62b11f5f70a3a5739b", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a49e5c1024ee2209a3c70b62b11f5f70a3a5739b", "committedDate": "2020-02-12T14:49:52Z", "message": "Strip module metadata from modular repositories"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a338fe0aaae7b0ae59b76c2004cf307a47f5a261", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a338fe0aaae7b0ae59b76c2004cf307a47f5a261", "committedDate": "2020-02-12T14:49:52Z", "message": "Convert ContentManager into a non-static class for easier testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a8da4bffedd98f38bb3b7d94b22a9d5d5e7334d", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0a8da4bffedd98f38bb3b7d94b22a9d5d5e7334d", "committedDate": "2020-02-12T14:49:53Z", "message": "Add ContentManager test scenarios with module filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e64f16641a74c7d103466e1fa7ef7baccccb5b", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/99e64f16641a74c7d103466e1fa7ef7baccccb5b", "committedDate": "2020-02-12T14:49:53Z", "message": "Implement type-specific UI for AppStream filters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c01c27496f2d443267c397ff92075cd15d36fe3c", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c01c27496f2d443267c397ff92075cd15d36fe3c", "committedDate": "2020-02-11T15:58:07Z", "message": "fixup! Implement module filtering logic and dependency resolution"}, "afterCommit": {"oid": "99e64f16641a74c7d103466e1fa7ef7baccccb5b", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/99e64f16641a74c7d103466e1fa7ef7baccccb5b", "committedDate": "2020-02-12T14:49:53Z", "message": "Implement type-specific UI for AppStream filters"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1642, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}