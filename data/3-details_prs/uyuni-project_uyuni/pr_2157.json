{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NTE3ODA2", "number": 2157, "title": "Reposync speedup part 2", "bodyText": "What does this PR change?\nIt replaces the existing mechanism in spacewalk-repo-sync to insert package capabilities, changelogs and checksums with a more efficient one.\nTotal speedup is ~25%, individual contributions from relevant commits as measured in my setup (syncing sles12-sp5-updates-x86_64 from a local mirror, robustly transferable to other channels) follow:\n\n\n\nCommit\nSpeedup\n\n\n\n\nreposync speedup: use execute_values for capabilities\n5.18%\n\n\nAdd INDEX to rhnPackageCapability.name\n8.16%\n\n\nreposync speedup: use execute_values for checksums\n4.57%\n\n\nreposync speedup: use execute_values for changelogs\n5.28%\n\n\n\nThe old mechanism being replaced\nCapabilities/checksums/changelogs were inserted one by one via a lookup_ stored procedure. The stored procedure was coded in a way to avoid that inserting an already-existing object would cause a unique constraint error - it did so by opening a secondary Postgres connection that was dedicated to just those insertions.\nThe new mechanism proposed in this PR\nMain differences are:\n\nnormal INSERT INTO statements are used instead of stored procedures\ninsertions are batched (one statement for many VALUEs)\nbatching happens via the via the psycopg2 execute_many helper. According to the library documentation and my tests using such helper is much faster than simply looping over a statement or the previously-used executemany method\npotential conflicts with concurrent insertions are resolved via the the INSERT INTO ... ON CONFLICT DO NOTHING clause of PostgreSQL instead of the secondary connection\ncode implementing the secondary connection is dropped\n\nThis requires the latest psycopg2 library in order to work. This is being added to SLE as part of the addition of PostgreSQL 12 and we will add the package to Uyuni temporarily.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\nNo documentation needed: internal change only\n DONE\n\nTest coverage\n\n\nNo tests: Cucumber tests to be implemented after reposync is fast enough\n\n\n DONE\n\n\nLinks\nFixes partially SUSE/spacewalk#9275\n\n DONE\n\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-04-24T12:19:49Z", "url": "https://github.com/uyuni-project/uyuni/pull/2157", "merged": true, "mergeCommit": {"oid": "accce9235dc79444d452bc2399d8ec26c8dc66f0"}, "closed": true, "closedAt": "2020-04-25T12:26:21Z", "author": {"login": "moio"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaxoHsgFqTM5OTk1MjgzMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbFMo1ABqjMyNzE4NzQxMTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTUyODMx", "url": "https://github.com/uyuni-project/uyuni/pull/2157#pullrequestreview-399952831", "createdAt": "2020-04-24T13:37:10Z", "commit": {"oid": "0552d28a9a718b459c146a75e72541a22a870758"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzozNzoxMFrOGLYEhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzozNzoxMFrOGLYEhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU4MTg5NQ==", "bodyText": "Are you sure you want this script here?\nI think you instead need it at https://github.com/uyuni-project/uyuni/tree/master/schema/spacewalk/upgrade/susemanager-schema-4.1.6-to-susemanager-schema-4.1.7", "url": "https://github.com/uyuni-project/uyuni/pull/2157#discussion_r414581895", "createdAt": "2020-04-24T13:37:10Z", "author": {"login": "juliogonzalez"}, "path": "schema/spacewalk/upgrade/susemanager-schema-4.1.4-to-susemanager-schema-4.1.5/003-rhnpackagecapability-name-index.sql", "diffHunk": "@@ -0,0 +1,2 @@\n+CREATE INDEX rhn_pkg_cap_name", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0552d28a9a718b459c146a75e72541a22a870758"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0552d28a9a718b459c146a75e72541a22a870758", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0552d28a9a718b459c146a75e72541a22a870758", "committedDate": "2020-04-24T12:27:09Z", "message": "Changelogs updated"}, "afterCommit": {"oid": "a4382b03e5a4176c1aecf9bf26009511c66b56ff", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a4382b03e5a4176c1aecf9bf26009511c66b56ff", "committedDate": "2020-04-24T14:13:32Z", "message": "Changelogs updated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMDM0MTI5", "url": "https://github.com/uyuni-project/uyuni/pull/2157#pullrequestreview-400034129", "createdAt": "2020-04-24T15:10:08Z", "commit": {"oid": "a4382b03e5a4176c1aecf9bf26009511c66b56ff"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzg4Mjc0", "url": "https://github.com/uyuni-project/uyuni/pull/2157#pullrequestreview-400388274", "createdAt": "2020-04-25T12:17:38Z", "commit": {"oid": "a4382b03e5a4176c1aecf9bf26009511c66b56ff"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQxMjoxNzozOFrOGL0t3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQxMjoxNzo1NFrOGL0t_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTA1MTIzMA==", "bodyText": "nit pick: normal index names use _idx as suffix. Maybe you can rename.", "url": "https://github.com/uyuni-project/uyuni/pull/2157#discussion_r415051230", "createdAt": "2020-04-25T12:17:38Z", "author": {"login": "mcalmer"}, "path": "schema/spacewalk/postgres/tables/rhnPackageCapability_index.sql", "diffHunk": "@@ -20,3 +20,6 @@ CREATE UNIQUE INDEX rhn_pkg_cap_name_version_uq\n create unique index rhn_pkg_cap_name_uq\n     on rhnPackageCapability (name)\n  where version is null;\n+\n+CREATE INDEX rhn_pkg_cap_name", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4382b03e5a4176c1aecf9bf26009511c66b56ff"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTA1MTI2Mw==", "bodyText": "same as above", "url": "https://github.com/uyuni-project/uyuni/pull/2157#discussion_r415051263", "createdAt": "2020-04-25T12:17:54Z", "author": {"login": "mcalmer"}, "path": "schema/spacewalk/upgrade/susemanager-schema-4.1.6-to-susemanager-schema-4.1.7/003-rhnpackagecapability-name-index.sql", "diffHunk": "@@ -0,0 +1,2 @@\n+CREATE INDEX IF NOT EXISTS rhn_pkg_cap_name\n+    ON rhnPackageCapability USING HASH (name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4382b03e5a4176c1aecf9bf26009511c66b56ff"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3873be7e27fb75ca7f143cefb549792837618471", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3873be7e27fb75ca7f143cefb549792837618471", "committedDate": "2020-04-25T12:24:04Z", "message": "Add support for psycopg's execute_many"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cf53569eccc0f8839c3ca9fe2f234835ba2eaf4", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2cf53569eccc0f8839c3ca9fe2f234835ba2eaf4", "committedDate": "2020-04-25T12:24:04Z", "message": "reposync speedup: use execute_values for capabilities\n\nPrevious code called a stored procedure (lookup_capabilities) per\ncapability, per package. As packages can be thousands and capabilities\ncan be hundreds of thousands per package, the number of calls to the\ndatabase was very high.\n\nThe execute_values method of psycopg allows to insert rows in batches,\nthereby reducing the number of calls to one per package, for all of its\ncapabilities - indexes to find out if a capability already exists can\nthen be scanned once only.\n\nMoreover INSERT ... ON CONFLICT DO NOTHING is used instead of the\nprevious mechanism using a second connection to Postgres to make sure no\nfailures happen on unique key constraints. This is also much more\nlightweight than explicit locks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "839861b83ca318f58d8492414871d924b248cd3a", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/839861b83ca318f58d8492414871d924b248cd3a", "committedDate": "2020-04-25T12:25:05Z", "message": "Add INDEX to rhnPackageCapability.name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82ee0130a08ce2f8dce9270b21aab7fd2d84b585", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/82ee0130a08ce2f8dce9270b21aab7fd2d84b585", "committedDate": "2020-04-25T12:25:09Z", "message": "reposync speedup: use execute_values for checksums\n\nPrevious code called a stored procedure (lookup_checksum) per\nchecksum, per package. As packages can be thousands and have hundreds\nof files, each of which has a checksum, the number of calls to the\ndatabase was very high.\n\nThe execute_values method of psycopg allows to insert rows in batches,\nthereby reducing the number of calls to one per package, for all of its\nchecksums - indexes to find out if a checksum already exists can\nthen be scanned once only.\n\nMoreover INSERT ... ON CONFLICT DO NOTHING is used instead of the\nprevious mechanism using a second connection to Postgres to make sure no\nfailures happen on unique key constraints. This is also much more\nlightweight than explicit locks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd580172fe9ccc0ba9ad2591ef6486b8f9ef4df0", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cd580172fe9ccc0ba9ad2591ef6486b8f9ef4df0", "committedDate": "2020-04-25T12:25:10Z", "message": "reposync speedup: use execute_values for changelogs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a946827e9bb38afd836f71183e26eeffff41e463", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a946827e9bb38afd836f71183e26eeffff41e463", "committedDate": "2020-04-25T12:25:10Z", "message": "refactoring: dead code removal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9940beadd643bd08338dfb7ced941ed19733f71", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c9940beadd643bd08338dfb7ced941ed19733f71", "committedDate": "2020-04-25T12:25:10Z", "message": "Changelogs updated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4382b03e5a4176c1aecf9bf26009511c66b56ff", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a4382b03e5a4176c1aecf9bf26009511c66b56ff", "committedDate": "2020-04-24T14:13:32Z", "message": "Changelogs updated"}, "afterCommit": {"oid": "c9940beadd643bd08338dfb7ced941ed19733f71", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c9940beadd643bd08338dfb7ced941ed19733f71", "committedDate": "2020-04-25T12:25:10Z", "message": "Changelogs updated"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1380, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}