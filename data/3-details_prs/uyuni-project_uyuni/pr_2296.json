{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NDc1Njgw", "number": 2296, "title": "Drop unpublished errata functionality (API and commandline tools)", "bodyText": "What does this PR change?\nBackground\nUyuni allows users to create their own patches/errata (via WebUI or API).\nAfter a patch is created, it can be published or left unpublished. When a patch is left unpublished, it is not part of any channel so it will just not be visible to any client. At some point users can publish an unpublished patch, and at that moment it will be seen normally by clients that have corresponding\nchannels attached. In the vast majority of use cases, both the documentation and the Web UI assume that any \"patch\" is in fact a \"published patch\" - unless otherwise noted. More information is available in our documentation:\nhttps://www.uyuni-project.org/uyuni-docs/uyuni/client-configuration/patch-management.html\nhttps://www.uyuni-project.org/uyuni-docs/uyuni/reference/patches/manage-patches-unpublished.html\nhttps://www.uyuni-project.org/uyuni-docs/uyuni/reference/patches/clone-patches.html\nThe unpublished errata mechanism has been created very long ago (the earliest trace we found is 2002), when lifecycle tools did not exist at all. Today, instead of creating an unpublished patch, it would be advisable to use a regular (published) patch to a test channel instead - the Content Lifecycle Management feature for instance makes it easy to promote it once it has been tested successfully. Testing is just impossible with unpublished errata, which makes us believe the whole mechanism is basically redundant as of today.\nAnother reason for the drop is that, as of now, its presence makes it more difficult to improve the codebase in other aspects (case in point is performance of channel management).\nA request to the Uyuni community did not so far receive replies from users needing this feature:\nhttps://lists.opensuse.org/uyuni-users/2020-05/msg00029.html\nPR organization\nThis PR is the first in a series to drop user-visible bits of functionality. After that is merged, one or more additional PRs will be opened to clean up any cruft.\nContents of this PR\n\ndrop of the rhn-clone-errata script, now obsoleted\ndrop the errata.listUnpublishedErrata endpoint\nprevent creation of unpublished errata via the API\nlimit details retrieval and setting on unpublished errata\ndo not return unpublished errata via Oval\nprevent scheduling the application of unpublished errata (was a bug)\nunit test fixes\n\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: only changes are in the API, and documentation is generated from code\n\n\n DONE\n\n\nTest coverage\n\n\nUnit tests were updated\n\n\n DONE\n\n\nLinks\nPartially addressing SUSE/spacewalk#11548\n\n DONE\n\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-06-05T14:11:37Z", "url": "https://github.com/uyuni-project/uyuni/pull/2296", "merged": true, "mergeCommit": {"oid": "7f046ceffe6ba4c9f4436a81e3bc213f93a3a858"}, "closed": true, "closedAt": "2020-06-08T15:14:58Z", "author": {"login": "moio"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoT-m5AFqTQyNTM3NzExNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpR_QDgBqjM0MjA2MTI1NjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1Mzc3MTE3", "url": "https://github.com/uyuni-project/uyuni/pull/2296#pullrequestreview-425377117", "createdAt": "2020-06-05T14:57:23Z", "commit": {"oid": "2d95f9845e1f15efe141db10c3749e4e3e86c1cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDo1NzoyM1rOGfx_lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDo1NzoyM1rOGfx_lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3ODEzNQ==", "bodyText": "seems you have this line now 2 times", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r435978135", "createdAt": "2020-06-05T14:57:23Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/redhat/rhn/frontend/action/errata/test/NotifySetupActionTest.java", "diffHunk": "@@ -52,22 +51,10 @@ public void testExecute() throws Exception {\n         User user = requestContext.getCurrentUser();\n         Errata published = ErrataFactoryTest\n                 .createTestPublishedErrata(user.getOrg().getId());\n-        Errata unpublished = ErrataFactoryTest\n-                .createTestUnpublishedErrata(user.getOrg().getId());\n-\n-        //test bad parameter exception\n-        request.setupAddParameter(\"eid\", unpublished.getId().toString());\n-        try {\n-            action.execute(mapping, form, request, response);\n-            fail();\n-        }\n-        catch (BadParameterException e) {\n-            //Success!!!\n-        }\n \n         //test default case\n         request.setupAddParameter(\"eid\", published.getId().toString());\n-        request.setupAddParameter(\"eid\", unpublished.getId().toString());\n+        request.setupAddParameter(\"eid\", published.getId().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d95f9845e1f15efe141db10c3749e4e3e86c1cf"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "856d9cdf74c780ab229a6e97e0fc755c956d7907", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/856d9cdf74c780ab229a6e97e0fc755c956d7907", "committedDate": "2020-06-05T14:10:53Z", "message": "Changelog updated"}, "afterCommit": {"oid": "61cf70777b538bf9da566b5b711dd3424049de41", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/61cf70777b538bf9da566b5b711dd3424049de41", "committedDate": "2020-06-05T16:28:16Z", "message": "Changelog updated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDMyMjM1", "url": "https://github.com/uyuni-project/uyuni/pull/2296#pullrequestreview-426032235", "createdAt": "2020-06-08T08:54:41Z", "commit": {"oid": "1df855337efafdba4a654ad9c11e736f194d4408"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwODo1NDo0MVrOGgUv1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwODo1NDo0MVrOGgUv1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0NzU0Mg==", "bodyText": "do we still need this method? shouldn't it be removed entirely?", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436547542", "createdAt": "2020-06-08T08:54:41Z", "author": {"login": "chiaradiamarcelo"}, "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java", "diffHunk": "@@ -1324,15 +1324,15 @@ public Errata publish(User loggedInUser, String advisory, List<String> channelLa\n     }\n \n     /**\n-     * Publishes an existing (unpublished) cloned errata to a set of cloned channels\n+     * Publishes an existing cloned errata to a set of cloned channels\n      * according to its original erratum\n      * @param loggedInUser The current user\n      * @param advisory The advisory Name of the errata to publish\n      * @param channelLabels List of channels to publish the errata to\n      * @throws InvalidChannelRoleException if the user perms are incorrect\n      * @return the published errata\n      *\n-     * @xmlrpc.doc Publishes an existing (unpublished) cloned errata to a set of cloned\n+     * @xmlrpc.doc Publishes an existing cloned errata to a set of cloned", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1df855337efafdba4a654ad9c11e736f194d4408"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDMyODA2", "url": "https://github.com/uyuni-project/uyuni/pull/2296#pullrequestreview-426032806", "createdAt": "2020-06-08T08:55:27Z", "commit": {"oid": "1df855337efafdba4a654ad9c11e736f194d4408"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwODo1NToyN1rOGgUxoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwODo1NToyN1rOGgUxoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0ODAwMQ==", "bodyText": "do we still need this method? shouldn't it be removed entirely?", "url": "https://github.com/uyuni-project/uyuni/pull/2296#discussion_r436548001", "createdAt": "2020-06-08T08:55:27Z", "author": {"login": "chiaradiamarcelo"}, "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/errata/ErrataHandler.java", "diffHunk": "@@ -1303,13 +1303,13 @@ public Integer delete(User loggedInUser, String advisoryName)\n     }\n \n     /**\n-     * Publishes an existing (unpublished) errata to a set of channels\n+     * Publishes an existing errata to a set of channels\n      * @param loggedInUser The current user\n      * @param advisory The advisory Name of the errata to publish\n      * @param channelLabels List of channels to publish the errata to\n      * @return the published errata\n      *\n-     * @xmlrpc.doc Publish an existing (unpublished) errata to a set of channels.\n+     * @xmlrpc.doc Publish an existing errata to a set of channels.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1df855337efafdba4a654ad9c11e736f194d4408"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDQyMTMx", "url": "https://github.com/uyuni-project/uyuni/pull/2296#pullrequestreview-426042131", "createdAt": "2020-06-08T09:07:09Z", "commit": {"oid": "61cf70777b538bf9da566b5b711dd3424049de41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61cf70777b538bf9da566b5b711dd3424049de41", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/61cf70777b538bf9da566b5b711dd3424049de41", "committedDate": "2020-06-05T16:28:16Z", "message": "Changelog updated"}, "afterCommit": {"oid": "bdffac42afb3ee69a3a5ac3b79f3559ed94bb360", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bdffac42afb3ee69a3a5ac3b79f3559ed94bb360", "committedDate": "2020-06-08T10:59:59Z", "message": "Changelog updated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48d85d73e016380c090c29a9401db9962c9abb54", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/48d85d73e016380c090c29a9401db9962c9abb54", "committedDate": "2020-06-08T15:12:56Z", "message": "rhn-clone-errata: drop\n\nThis is a script to clone errata from the Red Hat Network API, which has\nlong been dropped."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ef4552ae3351fde37829f5904be4d6e45b1d80", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/51ef4552ae3351fde37829f5904be4d6e45b1d80", "committedDate": "2020-06-08T15:12:56Z", "message": "ErrataHandler.create: remove flag to create unpublished errata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ac4cea94157ff947ca2e1a08756b41135ac3b1c", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2ac4cea94157ff947ca2e1a08756b41135ac3b1c", "committedDate": "2020-06-08T15:12:56Z", "message": "ErrataHandler.listUnpublishedErrata: drop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32373664a84cf554f26063ac9aa9967eb687a3e8", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/32373664a84cf554f26063ac9aa9967eb687a3e8", "committedDate": "2020-06-08T15:12:56Z", "message": "ErrataHandler.getDetails: limit to published errata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e63f2138138fcbfb362b1888eecc3661e8722e0", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9e63f2138138fcbfb362b1888eecc3661e8722e0", "committedDate": "2020-06-08T15:12:56Z", "message": "ErrataHandler.setDetails: fix documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "662b69e99ea3b0d47717862c019f3904b44b0c6f", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/662b69e99ea3b0d47717862c019f3904b44b0c6f", "committedDate": "2020-06-08T15:12:56Z", "message": "ErrataHandler.listCves: fix documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0066f85f297be4137ce85c683fa3346027265969", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0066f85f297be4137ce85c683fa3346027265969", "committedDate": "2020-06-08T15:12:56Z", "message": "ErrataHandler.publish*: clarify documentation\n\nContrary to what was documented, these methods work equally well on\npublished an unpublished errata."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f5efc10192e4fd00ab9b034c73c3273c90164ac", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4f5efc10192e4fd00ab9b034c73c3273c90164ac", "committedDate": "2020-06-08T15:12:57Z", "message": "ErrataHandler: fix doc up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "608b41efc8adc8e3e473965f15cbadce2a9d5fef", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/608b41efc8adc8e3e473965f15cbadce2a9d5fef", "committedDate": "2020-06-08T15:12:57Z", "message": "OvalServlet: do not return unpublished errata\n\nErrataFactory.lookupByAdvisoryId is only called by\nErrataFactory.lookupByIdentifier which is only called by\nErrataManager.lookupErrataByIdentifier which is only called by\nOvalServlet.doGet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebdcff8c36f541a29031b305a685154b05839c2e", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ebdcff8c36f541a29031b305a685154b05839c2e", "committedDate": "2020-06-08T15:12:57Z", "message": "Bugfix: prevent unpublished errata from being scheduled to apply\n\nErrataFactory.listErrata is only called by\nErrataManager.lookupErrataByIds which is only called by\nErrataManager.applyErrata which is ultimately called by\n - call sites which only used published errata as input:\n   - the single-system errata apply page (which implicitly checked via the UI data flow)\n   - the SSM errata apply page (which implicitly checked via the UI data flow)\n   - the package push page (which implicitly checked via the UI data flow)\n   - the errata notification page (which explicitly checked)\n   - the errata to channel assignment page (which explicitly checked)\n   - ActionManager.scheduleAllErrataUpdate (which only used published errata)\n   - SystemManager.setAutoUpdateBulk (which only used published errata)\n   - ErrataManager.updateStackUpdateNeeded (which only used published errata)\n   - ChannelSoftwareHandler.syncErrata (which explicitly checked)\n\n - call sites which did not check whether input included unpublished\nerrata, and are being fixed by this commit:\n   - ActionChainHandler.addErrataUpdate\n   - ServerGroupHandler.scheduleApplyErrataToActive\n   - SystemHandler.scheduleApplyErrata\n   - the page listing systems affected by an errata\n\n - call sites that are actually broken by this patch\n   - pages to list/add/remove packages, bugs, channels other details to an errata.\nDoing such edits to an unpublished errata will not work at this time,\nunpublished errata will need filtering\n   - the is_published_errata JSP ACL. Pages using that ACL will not work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7783d94e63eae6390d69cc9b142423e101f7b87", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c7783d94e63eae6390d69cc9b142423e101f7b87", "committedDate": "2020-06-08T15:12:57Z", "message": "Fix JUnit tests after disabling of unpublished errata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f096691f399d0ac621c3e4fb107e710f1a225741", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f096691f399d0ac621c3e4fb107e710f1a225741", "committedDate": "2020-06-08T15:14:07Z", "message": "Changelog updated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdffac42afb3ee69a3a5ac3b79f3559ed94bb360", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bdffac42afb3ee69a3a5ac3b79f3559ed94bb360", "committedDate": "2020-06-08T10:59:59Z", "message": "Changelog updated"}, "afterCommit": {"oid": "f096691f399d0ac621c3e4fb107e710f1a225741", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/f096691f399d0ac621c3e4fb107e710f1a225741", "committedDate": "2020-06-08T15:14:07Z", "message": "Changelog updated"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1304, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}