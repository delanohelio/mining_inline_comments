{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MTA3NTk3", "number": 2735, "title": "Reposync add timeout config", "bodyText": "What does this PR change?\nAdd a configuration value for setting the minimal transfer rate and a timeout period. If the transfer speed falls under the minimal transfer rate for the timeout duration, the download is aborted.\nI've reused the variable names (minrate, timeout) from ulrgrabber. They are passed through to PyCurl, therefore it is also an option to use libCurl's names (LOW_SPEED_TIME, LOW_SPEED_LIMIT). I find the urlgrabber ones a little bit nicer, but I don't mind either way.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nDocumentation issue was created:\n\n\nPR: uyuni-project/uyuni-docs#816\n\n\n DONE\n\n\nTest coverage\n\nNo tests: Don't know how this can be tested in a meaningful way. Ideas welcome.\n DONE\n\nLinks\nFixes SUSE/spacewalk#12635\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-10-19T16:21:45Z", "url": "https://github.com/uyuni-project/uyuni/pull/2735", "merged": true, "mergeCommit": {"oid": "1bac45a0cd0af47cf3083646d7c41dc864a30a6f"}, "closed": true, "closedAt": "2021-03-18T14:07:01Z", "author": {"login": "agraul"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgVmZ7AFqTUzOTQ1MTA2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeEV4ISABqjQ0NzYwMTg4Nzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDUxMDY3", "url": "https://github.com/uyuni-project/uyuni/pull/2735#pullrequestreview-539451067", "createdAt": "2020-11-26T16:32:06Z", "commit": {"oid": "fffa0ada67d293882addc267d9828e8257332158"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjozMjowN1rOH6iBNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjozMjowN1rOH6iBNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEzNjgyMQ==", "bodyText": "Why is the reason of removing this block? Wouldn't we miss to do:\nself.curl_obj.setopt(pycurl.FORBID_REUSE, 0)", "url": "https://github.com/uyuni-project/uyuni/pull/2735#discussion_r531136821", "createdAt": "2020-11-26T16:32:07Z", "author": {"login": "meaksh"}, "path": "backend/satellite_tools/download.py", "diffHunk": "@@ -138,11 +138,6 @@ def _do_perform(self):\n                 self.parent.first_in_queue_done = True\n                 self.parent.first_in_queue_lock.release()\n \n-    def _set_opts(self, opts=None):\n-        if not opts:\n-            opts = {}\n-        PyCurlFileObject._set_opts(self, opts=opts)\n-        self.curl_obj.setopt(pycurl.FORBID_REUSE, 0) # pylint: disable=E1101", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fffa0ada67d293882addc267d9828e8257332158"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4161425dac425e39a18a8f5e441f5152002aab38", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4161425dac425e39a18a8f5e441f5152002aab38", "committedDate": "2020-10-19T16:13:40Z", "message": "Use super() for inheritance"}, "afterCommit": {"oid": "fbfd6c97ff4fc16d015444c89f06bd170ad3d767", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/fbfd6c97ff4fc16d015444c89f06bd170ad3d767", "committedDate": "2020-11-27T10:50:21Z", "message": "Use super() for inheritance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODg4NTE0", "url": "https://github.com/uyuni-project/uyuni/pull/2735#pullrequestreview-539888514", "createdAt": "2020-11-27T10:56:19Z", "commit": {"oid": "fbfd6c97ff4fc16d015444c89f06bd170ad3d767"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMDo1NjoxOVrOH66Aeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMDo1NjoxOVrOH66Aeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUyOTg1MA==", "bodyText": "Here I was not sure if this should be its own setting or if we want to re-use timeout in rhn_server.conf.\nI think the former, but I'm interested in what you are thinking.", "url": "https://github.com/uyuni-project/uyuni/pull/2735#discussion_r531529850", "createdAt": "2020-11-27T10:56:19Z", "author": {"login": "agraul"}, "path": "backend/satellite_tools/download.py", "diffHunk": "@@ -278,16 +282,31 @@ class ThreadedDownloader:\n     def __init__(self, retries=3, log_obj=None, force=False):\n         self.queues = {}\n         comp = CFG.getComponent()\n-        initCFG('server.satellite')\n+        initCFG(\"server.satellite\")\n         try:\n             self.threads = int(CFG.REPOSYNC_DOWNLOAD_THREADS)\n         except ValueError:\n-            initCFG(comp)\n-            raise ValueError(\"Number of threads expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS)\n-        else:\n-            initCFG(comp)\n+            raise ValueError(\n+                \"Number of threads expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS\n+            )\n+        try:\n+            self.timeout = int(CFG.REPOSYNC_TIMEOUT)  # we could also use CFG.TIMEOUT", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbfd6c97ff4fc16d015444c89f06bd170ad3d767"}, "originalPosition": 82}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fbfd6c97ff4fc16d015444c89f06bd170ad3d767", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/fbfd6c97ff4fc16d015444c89f06bd170ad3d767", "committedDate": "2020-11-27T10:50:21Z", "message": "Use super() for inheritance"}, "afterCommit": {"oid": "4f9065c9509b05bd5345635e9043a5c0fed905e2", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4f9065c9509b05bd5345635e9043a5c0fed905e2", "committedDate": "2021-02-18T15:05:32Z", "message": "Use super() for inheritance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f9065c9509b05bd5345635e9043a5c0fed905e2", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4f9065c9509b05bd5345635e9043a5c0fed905e2", "committedDate": "2021-02-18T15:05:32Z", "message": "Use super() for inheritance"}, "afterCommit": {"oid": "bf4a0ac026acc20a0161d71ba75348cbfb2a84a3", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bf4a0ac026acc20a0161d71ba75348cbfb2a84a3", "committedDate": "2021-02-25T17:39:10Z", "message": "Use super() for inheritance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjEyMjAzNjkx", "url": "https://github.com/uyuni-project/uyuni/pull/2735#pullrequestreview-612203691", "createdAt": "2021-03-15T13:42:33Z", "commit": {"oid": "bf4a0ac026acc20a0161d71ba75348cbfb2a84a3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNVQxMzo0MjozM1rOI2z7ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNVQxMzo0MzoxOFrOI2z9ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM0NDgxMA==", "bodyText": "I think this is a copy-paste error.", "url": "https://github.com/uyuni-project/uyuni/pull/2735#discussion_r594344810", "createdAt": "2021-03-15T13:42:33Z", "author": {"login": "brejoc"}, "path": "backend/satellite_tools/download.py", "diffHunk": "@@ -278,16 +282,31 @@ class ThreadedDownloader:\n     def __init__(self, retries=3, log_obj=None, force=False):\n         self.queues = {}\n         comp = CFG.getComponent()\n-        initCFG('server.satellite')\n+        initCFG(\"server.satellite\")\n         try:\n             self.threads = int(CFG.REPOSYNC_DOWNLOAD_THREADS)\n         except ValueError:\n-            initCFG(comp)\n-            raise ValueError(\"Number of threads expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS)\n-        else:\n-            initCFG(comp)\n+            raise ValueError(\n+                \"Number of threads expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS\n+            )\n+        try:\n+            self.timeout = int(CFG.REPOSYNC_TIMEOUT)  # we could also use CFG.TIMEOUT\n+        except ValueError:\n+            raise ValueError(\n+                \"Timeout in seconds expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf4a0ac026acc20a0161d71ba75348cbfb2a84a3"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM0NTM1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"Timeout in seconds expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS\n          \n          \n            \n                            \"Timeout in seconds expected, found: '%s'\" % CFG.REPOSYNC_TIMEOUT", "url": "https://github.com/uyuni-project/uyuni/pull/2735#discussion_r594345354", "createdAt": "2021-03-15T13:43:18Z", "author": {"login": "brejoc"}, "path": "backend/satellite_tools/download.py", "diffHunk": "@@ -278,16 +282,31 @@ class ThreadedDownloader:\n     def __init__(self, retries=3, log_obj=None, force=False):\n         self.queues = {}\n         comp = CFG.getComponent()\n-        initCFG('server.satellite')\n+        initCFG(\"server.satellite\")\n         try:\n             self.threads = int(CFG.REPOSYNC_DOWNLOAD_THREADS)\n         except ValueError:\n-            initCFG(comp)\n-            raise ValueError(\"Number of threads expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS)\n-        else:\n-            initCFG(comp)\n+            raise ValueError(\n+                \"Number of threads expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS\n+            )\n+        try:\n+            self.timeout = int(CFG.REPOSYNC_TIMEOUT)  # we could also use CFG.TIMEOUT\n+        except ValueError:\n+            raise ValueError(\n+                \"Timeout in seconds expected, found: '%s'\" % CFG.REPOSYNC_DOWNLOAD_THREADS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf4a0ac026acc20a0161d71ba75348cbfb2a84a3"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjEyNDc0MTA2", "url": "https://github.com/uyuni-project/uyuni/pull/2735#pullrequestreview-612474106", "createdAt": "2021-03-15T17:40:15Z", "commit": {"oid": "bf4a0ac026acc20a0161d71ba75348cbfb2a84a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNVQxNzo0MDoxNVrOI3AZCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNVQxNzo0MDoxNVrOI3AZCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDU0OTAwMQ==", "bodyText": "self shouldn't be passed here (noting here so I don't forget to change it)", "url": "https://github.com/uyuni-project/uyuni/pull/2735#discussion_r594549001", "createdAt": "2021-03-15T17:40:15Z", "author": {"login": "agraul"}, "path": "backend/satellite_tools/download.py", "diffHunk": "@@ -132,26 +132,20 @@ def _do_perform(self):\n             if self.parent.first_in_queue_done:\n                 self.parent.first_in_queue_lock.release()\n         try:\n-            PyCurlFileObject._do_perform(self)\n+            super()._do_perform(self)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf4a0ac026acc20a0161d71ba75348cbfb2a84a3"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf4a0ac026acc20a0161d71ba75348cbfb2a84a3", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/bf4a0ac026acc20a0161d71ba75348cbfb2a84a3", "committedDate": "2021-02-25T17:39:10Z", "message": "Use super() for inheritance"}, "afterCommit": {"oid": "606af4a792353ba2e4eb639a3c14a688a732b053", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/606af4a792353ba2e4eb639a3c14a688a732b053", "committedDate": "2021-03-16T18:39:13Z", "message": "Test that reposync config values are used"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjE0MDY5MjE4", "url": "https://github.com/uyuni-project/uyuni/pull/2735#pullrequestreview-614069218", "createdAt": "2021-03-17T09:11:38Z", "commit": {"oid": "606af4a792353ba2e4eb639a3c14a688a732b053"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da1c8bf0f6bfdc69139fca6a73062fa0bd70396e", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/da1c8bf0f6bfdc69139fca6a73062fa0bd70396e", "committedDate": "2021-03-18T13:12:12Z", "message": "Add timeout/minrate config values to reposync\n\nAdd a configuration value for setting the minimal transfer rate and a\ntimeout period. If the transfer speed falls under the minimal transfer\nrate for the timeout duration, the download is aborted.\n\nI've reused the variable names (\"minrate\", \"timeout\") from urlgrabber."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd1b088ee1c0a711d6f2490b811eca46497a39a7", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/fd1b088ee1c0a711d6f2490b811eca46497a39a7", "committedDate": "2021-03-18T13:12:23Z", "message": "Use super() for inheritance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "577c49800a4bcb485870b0a1197a67875a293b1b", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/577c49800a4bcb485870b0a1197a67875a293b1b", "committedDate": "2021-03-18T13:12:24Z", "message": "Test that reposync config values are used"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "606af4a792353ba2e4eb639a3c14a688a732b053", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/606af4a792353ba2e4eb639a3c14a688a732b053", "committedDate": "2021-03-16T18:39:13Z", "message": "Test that reposync config values are used"}, "afterCommit": {"oid": "577c49800a4bcb485870b0a1197a67875a293b1b", "author": {"user": {"login": "agraul", "name": "Alexander Graul"}}, "url": "https://github.com/uyuni-project/uyuni/commit/577c49800a4bcb485870b0a1197a67875a293b1b", "committedDate": "2021-03-18T13:12:24Z", "message": "Test that reposync config values are used"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 903, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}