{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMDY1MDkx", "number": 2034, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMDozNVrODpknkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMzoyMFrODpksWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0OTE4MTYyOnYy", "diffSide": "RIGHT", "path": "testsuite/features/support/lavanda.rb", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMDozNVrOF41SQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjoyNzoxOVrOF42cVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzNzYwMQ==", "bodyText": "If the command returns nonzero status, then there is no such a process running (thus we are all set):\nbreak if code.zero? -> break unless code.zero?", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395137601", "createdAt": "2020-03-19T16:00:35Z", "author": {"login": "calancha"}, "path": "testsuite/features/support/lavanda.rb", "diffHunk": "@@ -65,4 +65,14 @@ def run_until_fail(cmd)\n       result\n     end\n   end\n+\n+  def wait_while_process_running(process)\n+    result = nil\n+    repeat_until_timeout(report_result: true) do\n+      result, code = run(\"pgrep -x #{process} >/dev/null\", false)\n+      break if code.zero?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1NjU2NQ==", "bodyText": "Right, my bad, thank you!", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395156565", "createdAt": "2020-03-19T16:27:19Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/support/lavanda.rb", "diffHunk": "@@ -65,4 +65,14 @@ def run_until_fail(cmd)\n       result\n     end\n   end\n+\n+  def wait_while_process_running(process)\n+    result = nil\n+    repeat_until_timeout(report_result: true) do\n+      result, code = run(\"pgrep -x #{process} >/dev/null\", false)\n+      break if code.zero?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzNzYwMQ=="}, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0OTE4NjA5OnYy", "diffSide": "RIGHT", "path": "testsuite/features/step_definitions/command_steps.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMTozMFrOF41U-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMTozMFrOF41U-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzODI5OQ==", "bodyText": "Rather \"When\" (there's no \"should\" in step title, it's rather an action than a test...)", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395138299", "createdAt": "2020-03-19T16:01:30Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -60,6 +60,31 @@\n   node.run(\"rpm -q #{package}; test $? -ne 0\")\n end\n \n+Then(/^I wait for \"([^\"]*)\" to be (uninstalled|installed) on \"([^\"]*)\"$/) do |package, status, host|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0OTE5MTM2OnYy", "diffSide": "RIGHT", "path": "testsuite/features/step_definitions/command_steps.rb", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMjo0N1rOF41YiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjoxODoxMlrOF42DmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTIwOA==", "bodyText": "OK we go that way. Fine.", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395139208", "createdAt": "2020-03-19T16:02:47Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -60,6 +60,31 @@\n   node.run(\"rpm -q #{package}; test $? -ne 0\")\n end\n \n+Then(/^I wait for \"([^\"]*)\" to be (uninstalled|installed) on \"([^\"]*)\"$/) do |package, status, host|\n+  if package.include?(\"suma\") && $product == \"Uyuni\"\n+    package.gsub! \"suma\", \"uyuni\"\n+  end\n+  node = get_target(host)\n+  if host.include? 'ubuntu'\n+    node.wait_while_process_running('apt-get')\n+    pkg_version = package.split('-')[-1]\n+    pkg_name = package.delete_suffix(\"-#{pkg_version}\")\n+    pkg_version_regexp = pkg_version.gsub('.', '\\\\.')\n+    if status == 'installed'\n+      node.run_until_ok(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    else\n+      node.run_until_fail(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    end\n+  else\n+    node.wait_while_process_running('zypper')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE0OTA3OA==", "bodyText": "Yep, but just because that step is strictly related to the action of installation so the command tool to install packages.\nSo here, we want to make sure that the installation process is fully completed.\nOtherwise, yes, as we discussed... if we do that somewhere else it will hide the issue and is not what we want.", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395149078", "createdAt": "2020-03-19T16:16:38Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -60,6 +60,31 @@\n   node.run(\"rpm -q #{package}; test $? -ne 0\")\n end\n \n+Then(/^I wait for \"([^\"]*)\" to be (uninstalled|installed) on \"([^\"]*)\"$/) do |package, status, host|\n+  if package.include?(\"suma\") && $product == \"Uyuni\"\n+    package.gsub! \"suma\", \"uyuni\"\n+  end\n+  node = get_target(host)\n+  if host.include? 'ubuntu'\n+    node.wait_while_process_running('apt-get')\n+    pkg_version = package.split('-')[-1]\n+    pkg_name = package.delete_suffix(\"-#{pkg_version}\")\n+    pkg_version_regexp = pkg_version.gsub('.', '\\\\.')\n+    if status == 'installed'\n+      node.run_until_ok(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    else\n+      node.run_until_fail(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    end\n+  else\n+    node.wait_while_process_running('zypper')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTIwOA=="}, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1MDIzMg==", "bodyText": "Exactly.", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395150232", "createdAt": "2020-03-19T16:18:12Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -60,6 +60,31 @@\n   node.run(\"rpm -q #{package}; test $? -ne 0\")\n end\n \n+Then(/^I wait for \"([^\"]*)\" to be (uninstalled|installed) on \"([^\"]*)\"$/) do |package, status, host|\n+  if package.include?(\"suma\") && $product == \"Uyuni\"\n+    package.gsub! \"suma\", \"uyuni\"\n+  end\n+  node = get_target(host)\n+  if host.include? 'ubuntu'\n+    node.wait_while_process_running('apt-get')\n+    pkg_version = package.split('-')[-1]\n+    pkg_name = package.delete_suffix(\"-#{pkg_version}\")\n+    pkg_version_regexp = pkg_version.gsub('.', '\\\\.')\n+    if status == 'installed'\n+      node.run_until_ok(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    else\n+      node.run_until_fail(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    end\n+  else\n+    node.wait_while_process_running('zypper')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTIwOA=="}, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0OTE5Mzg2OnYy", "diffSide": "RIGHT", "path": "testsuite/features/secondary/min_action_chain.feature", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMzoyMFrOF41aHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMzoyMFrOF41aHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTYxNQ==", "bodyText": "Ooooh cool I wanted to get rid of these \"this\" for so long...", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395139615", "createdAt": "2020-03-19T16:03:20Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/min_action_chain.feature", "diffHunk": "@@ -165,7 +165,7 @@ Feature: Action chains on Salt minions\n     And I follow \"new action chain\"\n     And I click on \"Save and Schedule\"\n     Then I should see a \"Action Chain new action chain has been scheduled for execution.\" text\n-    When I wait for \"virgo-dummy\" to be installed on this \"sle_minion\"\n+    When I wait for \"virgo-dummy\" to be installed on \"sle_minion\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 22, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}