{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MDI1OTgz", "number": 2262, "title": "Validate CLM projects on build/promote with XMLRPC", "bodyText": "Validate CLM projects on build/promote with XMLRPC\nDocumentation\n\nDocumented in API docs\n\nTest coverage\n\nUnit tests were added\n\nLinks\nFixes SUSE/spacewalk#11422\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-05-27T18:05:00Z", "url": "https://github.com/uyuni-project/uyuni/pull/2262", "merged": true, "mergeCommit": {"oid": "a04225c548463667e2982e215bdabe5e4cea615c"}, "closed": true, "closedAt": "2020-06-03T14:14:24Z", "author": {"login": "cbbayburt"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcldQ4dABqjMzNzk0MjQ1NTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnm0vuABqjM0MDE0NzkyMTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6d059ae74a7933011903c38c36140890463b103", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a6d059ae74a7933011903c38c36140890463b103", "committedDate": "2020-05-27T18:04:12Z", "message": "Validate CLM projects on build/promote with XMLRPC"}, "afterCommit": {"oid": "9c2330efa313dd7ab12e55066433ff836c8bc733", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9c2330efa313dd7ab12e55066433ff836c8bc733", "committedDate": "2020-05-27T18:06:38Z", "message": "Validate CLM projects on build/promote with XMLRPC"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c2330efa313dd7ab12e55066433ff836c8bc733", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9c2330efa313dd7ab12e55066433ff836c8bc733", "committedDate": "2020-05-27T18:06:38Z", "message": "Validate CLM projects on build/promote with XMLRPC"}, "afterCommit": {"oid": "a19afba4608a6284b989f79583a0fd817f997f21", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a19afba4608a6284b989f79583a0fd817f997f21", "committedDate": "2020-05-27T18:09:29Z", "message": "Validate CLM projects on build/promote with XMLRPC"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDk0NTE1", "url": "https://github.com/uyuni-project/uyuni/pull/2262#pullrequestreview-419494515", "createdAt": "2020-05-27T18:22:27Z", "commit": {"oid": "a19afba4608a6284b989f79583a0fd817f997f21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODoyMjoyN1rOGbXo1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODoyMjoyN1rOGbXo1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1MjAyMA==", "bodyText": "We have 2020 :-)", "url": "https://github.com/uyuni-project/uyuni/pull/2262#discussion_r431352020", "createdAt": "2020-05-27T18:22:27Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/ContentValidationFaultException.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/**\n+ * Copyright (c) 2019 SUSE LLC", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a19afba4608a6284b989f79583a0fd817f997f21"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNTkzNDgz", "url": "https://github.com/uyuni-project/uyuni/pull/2262#pullrequestreview-422593483", "createdAt": "2020-06-02T11:42:40Z", "commit": {"oid": "430e2c0b2fcd8db11d9b155443ac907218418630"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMTo0Mjo0MFrOGdt1GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMjoyNDo1NVrOGdvLQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgxMjc2MA==", "bodyText": "Nit: typo in comment (promote).", "url": "https://github.com/uyuni-project/uyuni/pull/2262#discussion_r433812760", "createdAt": "2020-06-02T11:42:40Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/contentmgmt/ContentManagementHandler.java", "diffHunk": "@@ -825,6 +861,11 @@ public int buildProject(User loggedInUser, String projectLabel, String message)\n      */\n     public int promoteProject(User loggedInUser, String projectLabel, String envLabel) {\n         ensureOrgAdmin(loggedInUser);\n+\n+        // Validate the project for build", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430e2c0b2fcd8db11d9b155443ac907218418630"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgxMzU5NQ==", "bodyText": "Is there a reason for not using lookupProject that is already present in this class? It also throws EntityNotExistsFaultException already.", "url": "https://github.com/uyuni-project/uyuni/pull/2262#discussion_r433813595", "createdAt": "2020-06-02T11:44:23Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/contentmgmt/ContentManagementHandler.java", "diffHunk": "@@ -836,4 +877,45 @@ public int promoteProject(User loggedInUser, String projectLabel, String envLabe\n         }\n         return 1;\n     }\n+\n+    /**\n+     * Get a {@link ContentProject} instance using the project label\n+     *\n+     * @param loggedInUser the user\n+     * @param projectLabel the project label\n+     * @return the content project instance\n+     * @throws EntityNotExistsFaultException when project doesn't exist\n+     */\n+    private ContentProject getContentProject(User loggedInUser, String projectLabel)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430e2c0b2fcd8db11d9b155443ac907218418630"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgzMTQzOQ==", "bodyText": "In the UI we seem to also have a project validator that consists of ModularSourceValidator and ModularDependencyValidator. Could some portion (at least the list of used validators) of the validator initialization be extracted to a common place, so that next time we want to add a validator, we just change it on one place?", "url": "https://github.com/uyuni-project/uyuni/pull/2262#discussion_r433831439", "createdAt": "2020-06-02T12:18:28Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/contentmgmt/ContentManagementHandler.java", "diffHunk": "@@ -836,4 +877,45 @@ public int promoteProject(User loggedInUser, String projectLabel, String envLabe\n         }\n         return 1;\n     }\n+\n+    /**\n+     * Get a {@link ContentProject} instance using the project label\n+     *\n+     * @param loggedInUser the user\n+     * @param projectLabel the project label\n+     * @return the content project instance\n+     * @throws EntityNotExistsFaultException when project doesn't exist\n+     */\n+    private ContentProject getContentProject(User loggedInUser, String projectLabel)\n+            throws EntityNotExistsFaultException {\n+        return ContentManager.lookupProject(projectLabel, loggedInUser)\n+                .orElseThrow(() -> new EntityNotExistsFaultException(new EntityNotExistsException(projectLabel)));\n+    }\n+\n+    /**\n+     * Validates a content project for build/promote\n+     *\n+     * The validation fails only in case of an error. Info and warning messages are ignored since the build/promote\n+     * operation can still be performed.\n+     *\n+     * @param project the {@link ContentProject} instance\n+     * @throws ContentValidationFaultException when validation fails with messages\n+     */\n+    private void validateContentProject(ContentProject project) throws ContentValidationFaultException {\n+        ContentProjectValidator projectValidator = new ContentProjectValidator(project,\n+                Arrays.asList(\n+                    new ModularSourcesValidator(),\n+                    new ModularDependencyValidator(contentManager.getModulemdApi())\n+                ));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430e2c0b2fcd8db11d9b155443ac907218418630"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgzNDgxOA==", "bodyText": "I'd prefer, if we slap the user on the hand (e.g. with IllegalArgumentsException), propagate it to the XMLRPC API and there re-throw some fault. This way, they will really know that they did something forbidden. If you think this is a bad idea, let me know and we can talk about it :)", "url": "https://github.com/uyuni-project/uyuni/pull/2262#discussion_r433834818", "createdAt": "2020-06-02T12:24:55Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/manager/contentmgmt/ContentManager.java", "diffHunk": "@@ -455,6 +455,12 @@ public ContentFilter createFilter(String name, ContentFilter.Rule rule, ContentF\n         lookupFilterByNameAndOrg(name, user).ifPresent(cp -> {\n             throw new EntityExistsException(cp);\n         });\n+\n+        if (ContentFilter.EntityType.MODULE.equals(entityType)) {\n+            // Rules are not applicable for module filters\n+            // Set the rule to ALLOW for all module filters to avoid confusion when listing with XMLRPC\n+            rule = ContentFilter.Rule.ALLOW;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430e2c0b2fcd8db11d9b155443ac907218418630"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7c1f0aaa4c49148798ef089a559db8023046cc1", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/d7c1f0aaa4c49148798ef089a559db8023046cc1", "committedDate": "2020-06-02T17:36:18Z", "message": "fixup! Validate CLM projects on build/promote with XMLRPC\n\nEnforce 'allow' rule for appstream filters"}, "afterCommit": {"oid": "a668644f96a70aa22f5099aa5fb38de37e5ec85e", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a668644f96a70aa22f5099aa5fb38de37e5ec85e", "committedDate": "2020-06-02T17:40:53Z", "message": "fixup! Validate CLM projects on build/promote with XMLRPC\n\nEnforce 'allow' rule for appstream filters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a668644f96a70aa22f5099aa5fb38de37e5ec85e", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a668644f96a70aa22f5099aa5fb38de37e5ec85e", "committedDate": "2020-06-02T17:40:53Z", "message": "fixup! Validate CLM projects on build/promote with XMLRPC\n\nEnforce 'allow' rule for appstream filters"}, "afterCommit": {"oid": "5d58fe34c94ff543948bb0b6ed6b59b9df48b24b", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5d58fe34c94ff543948bb0b6ed6b59b9df48b24b", "committedDate": "2020-06-02T17:52:53Z", "message": "fixup! Validate CLM projects on build/promote with XMLRPC\n\nEnforce 'allow' rule for appstream filters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMjg5MDcx", "url": "https://github.com/uyuni-project/uyuni/pull/2262#pullrequestreview-423289071", "createdAt": "2020-06-03T07:31:51Z", "commit": {"oid": "5d58fe34c94ff543948bb0b6ed6b59b9df48b24b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96bd126a6ac0367f4e9b53c4b56fc288a3822694", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/96bd126a6ac0367f4e9b53c4b56fc288a3822694", "committedDate": "2020-06-03T10:22:12Z", "message": "Validate CLM projects on build/promote with XMLRPC"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d58fe34c94ff543948bb0b6ed6b59b9df48b24b", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5d58fe34c94ff543948bb0b6ed6b59b9df48b24b", "committedDate": "2020-06-02T17:52:53Z", "message": "fixup! Validate CLM projects on build/promote with XMLRPC\n\nEnforce 'allow' rule for appstream filters"}, "afterCommit": {"oid": "96bd126a6ac0367f4e9b53c4b56fc288a3822694", "author": {"user": {"login": "cbbayburt", "name": "Can Bulut Bayburt"}}, "url": "https://github.com/uyuni-project/uyuni/commit/96bd126a6ac0367f4e9b53c4b56fc288a3822694", "committedDate": "2020-06-03T10:22:12Z", "message": "Validate CLM projects on build/promote with XMLRPC"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1270, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}