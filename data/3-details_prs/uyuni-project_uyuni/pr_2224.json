{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4OTcyODQ5", "number": 2224, "title": "Configure registry", "bodyText": "What does this PR change?\nUse a variable which point to a container registry to use.\nUse Case:\n\nprovo setup where a registry could run in the minima mirror\npublic cloud where also a mirror in the cloud could have the registry\n\nWe need to adapt the FROM instructions according to the environment.\nI created copies of the profiles, but did not yet cleanup the old one.\nPart of a series of PRs in different repos:\nuyuni-project/sumaform#716\nSUSE/susemanager-ci#78\n#2224\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: internal\n\n\n DONE\n\n\nTest coverage\n\n\nCucumber tests adapted\n\n\n DONE\n\n\nLinks\nFixes #\nTracks # add downstream PR, if any\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-05-16T14:06:52Z", "url": "https://github.com/uyuni-project/uyuni/pull/2224", "merged": true, "mergeCommit": {"oid": "873d5b36423aca50e0eb8f0dbd577d31dd843cee"}, "closed": true, "closedAt": "2020-09-19T09:41:00Z", "author": {"login": "mcalmer"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABch3kXcgBqjMzNDM2NTM5Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKWgY5ABqjM3ODQ5Njc4Mjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca7a5a6ece5672186d232649e2a3b95872019053", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ca7a5a6ece5672186d232649e2a3b95872019053", "committedDate": "2020-05-16T14:02:23Z", "message": "test portus server with configured portus uri"}, "afterCommit": {"oid": "3e6217b129e6982cd539b77e2f9ec15acfcb03c6", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/3e6217b129e6982cd539b77e2f9ec15acfcb03c6", "committedDate": "2020-05-16T14:29:53Z", "message": "test portus server with configured portus uri"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MzUwMDA2", "url": "https://github.com/uyuni-project/uyuni/pull/2224#pullrequestreview-414350006", "createdAt": "2020-05-19T11:26:34Z", "commit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMToyNjozNFrOGXb6KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMTo1MjoxNlrOGXcw4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIyNzY4OQ==", "bodyText": "English, not computese, please \ud83d\ude38\nAnd I enter the registry's URI as \"uri\"", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427227689", "createdAt": "2020-05-19T11:26:34Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/core/srv_docker.feature", "diffHunk": "@@ -40,7 +40,7 @@ Feature: Prepare server for using Docker\n     When I follow the left menu \"Images > Stores\"\n     And I follow \"Create\"\n     And I enter \"galaxy-registry\" as \"label\"\n-    And I enter \"registry.mgr.suse.de\" as \"uri\"\n+    And I enter the registry_uri as \"uri\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzMDkzNA==", "bodyText": "What about making that filename independant of real host's hostname?\nPossible solution:\ntestsuite/features/profiles/Docker/internal_nue/authprofile/Dockerfile\nThat way, if it moves e.g. to docker.mgr.suse.de or docker.qa.suse.de or whatever else, we don't need to fix the test suite.", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427230934", "createdAt": "2020-05-19T11:32:36Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/profiles/mgr.suse.de/Docker/authprofile/Dockerfile", "diffHunk": "@@ -0,0 +1,20 @@\n+# Container used to test Content Management feature", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzMjAzNg==", "bodyText": "Same suggestion:\nmake mgr.suse.de something less implementation-dependant, for example internal_nue", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427232036", "createdAt": "2020-05-19T11:34:35Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/profiles/mgr.suse.de/Kiwi/POS_Image-JeOS6_32/config.sh", "diffHunk": "@@ -0,0 +1,142 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzNjU3Nw==", "bodyText": "... and those ones would be internal_prv instead of prv.suse.net\n(or external_prv? not sure how this will be open to uyuni contributors)", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427236577", "createdAt": "2020-05-19T11:42:47Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/profiles/prv.suse.net/Docker/Dockerfile", "diffHunk": "@@ -0,0 +1,16 @@\n+FROM minima-mirror.prv.suse.net/toaster-sles12sp3-products", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzODEzNA==", "bodyText": "English: the registry's URI", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427238134", "createdAt": "2020-05-19T11:45:47Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/srv_docker_advanced_content_management.feature", "diffHunk": "@@ -8,7 +8,7 @@ Feature: Advanced content management\n     When I follow the left menu \"Images > Stores\"\n     And I follow \"Create\"\n     And I enter \"docker_admin\" as \"label\"\n-    And I enter \"registry.mgr.suse.de\" as \"uri\"\n+    And I enter the registry_uri as \"uri\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzODg0Mw==", "bodyText": "See my remarks on sumaform PR: an alternative would be to make this server non-mandatory. In that case, that variable could be empty, and those whole tests would be skipped.", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427238843", "createdAt": "2020-05-19T11:47:16Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -56,7 +56,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'\n   else\n-    url = 'https://portus.mgr.suse.de:5000'\n+    portus_uri = ENV['PORTUS_URI']", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzOTgzNQ==", "bodyText": "That's what I suggested during standup: if we get a server in the Uyuni case,then this is not \"not implemented anymore\". In that case, just remove those lines (the whole \"uyuni\" case).", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427239835", "createdAt": "2020-05-19T11:49:02Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -56,7 +56,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MDQ2Mg==", "bodyText": "Same remark: isn't that done now? If so, please remove this error message (the whole \"Uyuni\" case).", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427240462", "createdAt": "2020-05-19T11:50:10Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -66,7 +67,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTE4MA==", "bodyText": "Same remark: if we make it non-mandatory in sumaform, then it's possible this variable is just empty. If that's the case, we just skip the tests implying a registry.", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427241180", "createdAt": "2020-05-19T11:51:24Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -66,7 +67,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'\n   else\n-    url = 'https://registry.mgr.suse.de:443'\n+    registry_uri = ENV['REGISTRY_URI']", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTUxNA==", "bodyText": "why not make https:// part of the variable's content?", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427241514", "createdAt": "2020-05-19T11:51:59Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -66,7 +67,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'\n   else\n-    url = 'https://registry.mgr.suse.de:443'\n+    registry_uri = ENV['REGISTRY_URI']\n+    url = \"https://#{registry_uri}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTY5Nw==", "bodyText": "No technicalities in cucumber text :-) registry's URI", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427241697", "createdAt": "2020-05-19T11:52:16Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/navigation_steps.rb", "diffHunk": "@@ -163,6 +163,11 @@\n   end\n end\n \n+When(/^I enter the registry_uri as \"([^\"]*)\"$/) do |arg1|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5d0dd700224ad069a2ea2548a14f1393b6a05c14", "committedDate": "2020-05-17T12:14:56Z", "message": "fix syntax error"}, "afterCommit": {"oid": "485fcb0c48fe14c67d0e59a8033ac48ac7b97967", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/485fcb0c48fe14c67d0e59a8033ac48ac7b97967", "committedDate": "2020-05-22T13:35:05Z", "message": "fix syntax error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db08bcd70391472d704cadfee626e21ff8ea940b", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/db08bcd70391472d704cadfee626e21ff8ea940b", "committedDate": "2020-05-22T13:59:41Z", "message": "make registries and image building optional"}, "afterCommit": {"oid": "806d82810dd806b04dcd31d24ec3d5b942dd33ae", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/806d82810dd806b04dcd31d24ec3d5b942dd33ae", "committedDate": "2020-05-22T14:10:33Z", "message": "make registries and image building optional"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjY0NTU2", "url": "https://github.com/uyuni-project/uyuni/pull/2224#pullrequestreview-456664556", "createdAt": "2020-07-28T14:04:05Z", "commit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDowNDowNVrOG4OKow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxMDowMVrOG4OcJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNTUzOQ==", "bodyText": "When I configure, upper case \"I\"", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461605539", "createdAt": "2020-07-28T14:04:05Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/core/allcli_sanity.feature", "diffHunk": "@@ -56,5 +56,13 @@ Feature: Sanity checks\n     And it should be possible to reach the build sources\n     And it should be possible to reach the container profiles\n     And it should be possible to reach the test suite profiles\n-    And it should be possible to reach the portus registry\n-    And it should be possible to reach the other registry\n+\n+@auth_registry\n+  Scenario: The registry with authentication is healthy\n+    When i configure the global portus registry", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNTcyNA==", "bodyText": "Upper case \"I\", please", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461605724", "createdAt": "2020-07-28T14:04:21Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/core/allcli_sanity.feature", "diffHunk": "@@ -56,5 +56,13 @@ Feature: Sanity checks\n     And it should be possible to reach the build sources\n     And it should be possible to reach the container profiles\n     And it should be possible to reach the test suite profiles\n-    And it should be possible to reach the portus registry\n-    And it should be possible to reach the other registry\n+\n+@auth_registry\n+  Scenario: The registry with authentication is healthy\n+    When i configure the global portus registry\n+    Then it should be possible to reach the portus registry\n+\n+@noauth_registry\n+  Scenario: The registry without authentication is healthy\n+    When i configure the global registry", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNjAzOQ==", "bodyText": "Upper case \"I\"", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461606039", "createdAt": "2020-07-28T14:04:45Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNjE3OQ==", "bodyText": "same", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461606179", "createdAt": "2020-07-28T14:04:56Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNjMzMw==", "bodyText": "same", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461606333", "createdAt": "2020-07-28T14:05:10Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)\n+  $auth_registry = $auth_registry.sub(registry.to_s, \"portus.localnet\")\n+end\n+\n+When(/^i configure the global registry$/) do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNjQyNA==", "bodyText": "same", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461606424", "createdAt": "2020-07-28T14:05:18Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)\n+  $auth_registry = $auth_registry.sub(registry.to_s, \"portus.localnet\")\n+end\n+\n+When(/^i configure the global registry$/) do\n+  registry, _extra = $noauth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"registry.localnet\" registry)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNzYxOQ==", "bodyText": "same", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461607619", "createdAt": "2020-07-28T14:06:56Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)\n+  $auth_registry = $auth_registry.sub(registry.to_s, \"portus.localnet\")\n+end\n+\n+When(/^i configure the global registry$/) do\n+  registry, _extra = $noauth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"registry.localnet\" registry)\n+  $noauth_registry = $noauth_registry.sub(registry.to_s, \"registry.localnet\")\n+end\n+\n+When(/^i configure the \"([^\"]*)\" as \"([^\"]*)\" registry$/) do |registry, newname|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwODIwMA==", "bodyText": "ok", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461608200", "createdAt": "2020-07-28T14:07:41Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)\n+  $auth_registry = $auth_registry.sub(registry.to_s, \"portus.localnet\")\n+end\n+\n+When(/^i configure the global registry$/) do\n+  registry, _extra = $noauth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"registry.localnet\" registry)\n+  $noauth_registry = $noauth_registry.sub(registry.to_s, \"registry.localnet\")\n+end\n+\n+When(/^i configure the \"([^\"]*)\" as \"([^\"]*)\" registry$/) do |registry, newname|\n+  out = `host #{registry}`.split(\"\\n\")\n+  out.each do |line|\n+    match = line.match(\"#{registry} has address (.*)\")\n+    if match && match[1]\n+      ipv4 = match[1]\n+      if not File.foreach(\"/etc/hosts\").grep(/#{ipv4} #{newname}/).any?\n+        open('/etc/hosts', 'a') { |f|\n+          f.puts \"#{ipv4} #{newname}\"\n+        }\n+      end\n+      $minion.run(\"grep '#{ipv4} #{newname}' /etc/hosts || echo '#{ipv4} #{newname}' >> /etc/hosts\")\n+      $server.run(\"grep '#{ipv4} #{newname}' /etc/hosts || echo '#{ipv4} #{newname}' >> /etc/hosts\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMDAyMA==", "bodyText": "We could consider renaming PORTUS_URI and REGISTER_URI variables accordingly (to AUTH_REGISTERY and NOAUTH_REGISTERY), but that would mean changes in sumaform", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461610020", "createdAt": "2020-07-28T14:10:01Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/support/twopence_init.rb", "diffHunk": "@@ -189,6 +189,8 @@ def file_inject(node, local_file, remote_file)\n $private_net = ENV['PRIVATENET'] if ENV['PRIVATENET']\n $mirror = ENV['MIRROR']\n $server_http_proxy = ENV['SERVER_HTTP_PROXY'] if ENV['SERVER_HTTP_PROXY']\n+$noauth_registry = ENV['REGISTRY_URI'] if ENV['REGISTRY_URI']\n+$auth_registry = ENV['PORTUS_URI'] if ENV['PORTUS_URI']", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjk1NDg4", "url": "https://github.com/uyuni-project/uyuni/pull/2224#pullrequestreview-481695488", "createdAt": "2020-09-03T10:12:30Z", "commit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDoxMjozMFrOHMf1yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDoxMjozMFrOHMf1yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2NjYzMg==", "bodyText": "Warning just in case, apparently we use sles12sp3 image, but then in the line number 13, we add sles12sp4 repo, all right?", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r482866632", "createdAt": "2020-09-03T10:12:30Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/profiles/mgr.suse.de/Docker/Dockerfile", "diffHunk": "@@ -0,0 +1,16 @@\n+FROM registry.mgr.suse.de/toaster-sles12sp3-products", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjk5MzE1", "url": "https://github.com/uyuni-project/uyuni/pull/2224#pullrequestreview-481699315", "createdAt": "2020-09-03T10:18:11Z", "commit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDoxODoxMVrOHMgCCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDoxODoxMVrOHMgCCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2OTc2OQ==", "bodyText": "Can I ask to use no_auth_registry instead?\nFrom my point of view, either we separate all the words with a _  either we don't separate them.", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r482869769", "createdAt": "2020-09-03T10:18:11Z", "author": {"login": "srbarrios"}, "path": "testsuite/features/support/env.rb", "diffHunk": "@@ -254,6 +254,16 @@ def enable_assertions\n   skip_this_scenario unless $server_http_proxy\n end\n \n+# do test only if the registry is available\n+Before('@noauth_registry') do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "committedDate": "2020-05-23T21:01:32Z", "message": "fixes"}, "afterCommit": {"oid": "b21df48671eaa37b9a0678feb5f52c0425c93baf", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b21df48671eaa37b9a0678feb5f52c0425c93baf", "committedDate": "2020-09-18T08:18:31Z", "message": "fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b21df48671eaa37b9a0678feb5f52c0425c93baf", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b21df48671eaa37b9a0678feb5f52c0425c93baf", "committedDate": "2020-09-18T08:18:31Z", "message": "fixes"}, "afterCommit": {"oid": "1a763d8a88dffcac3accebb1e606c30e45d10a41", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1a763d8a88dffcac3accebb1e606c30e45d10a41", "committedDate": "2020-09-18T09:31:45Z", "message": "change environment names and autogenerate profiles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a763d8a88dffcac3accebb1e606c30e45d10a41", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1a763d8a88dffcac3accebb1e606c30e45d10a41", "committedDate": "2020-09-18T09:31:45Z", "message": "change environment names and autogenerate profiles"}, "afterCommit": {"oid": "60813c526548df2928cb606f3ce72a40a178606c", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/60813c526548df2928cb606f3ce72a40a178606c", "committedDate": "2020-09-18T10:37:10Z", "message": "change environment names and autogenerate profiles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNDIxNzA1", "url": "https://github.com/uyuni-project/uyuni/pull/2224#pullrequestreview-491421705", "createdAt": "2020-09-18T12:32:45Z", "commit": {"oid": "76e779dae21293b2d127b0a6d8fd4b5db76befcc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNDI1MzY4", "url": "https://github.com/uyuni-project/uyuni/pull/2224#pullrequestreview-491425368", "createdAt": "2020-09-18T12:38:10Z", "commit": {"oid": "76e779dae21293b2d127b0a6d8fd4b5db76befcc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6322751b14501af82bb3967b39ebe8a80a2dd2c", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b6322751b14501af82bb3967b39ebe8a80a2dd2c", "committedDate": "2020-09-18T12:40:13Z", "message": "rename registry variables"}, "afterCommit": {"oid": "01da7be2ca76e01282a5ebc1c1e594bc588ab9c1", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/01da7be2ca76e01282a5ebc1c1e594bc588ab9c1", "committedDate": "2020-09-18T12:45:30Z", "message": "rename registry variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8a853f64889d3801cbace0c4a97f8b5ba8529db", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b8a853f64889d3801cbace0c4a97f8b5ba8529db", "committedDate": "2020-09-19T09:08:00Z", "message": "define auth_registry and no_auth_registry and read them from env vars"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33e0cfcbfd5457dfeaf0b39af99df3bc1694b353", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/33e0cfcbfd5457dfeaf0b39af99df3bc1694b353", "committedDate": "2020-09-19T09:09:10Z", "message": "generate test profiles for different environments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01da7be2ca76e01282a5ebc1c1e594bc588ab9c1", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/01da7be2ca76e01282a5ebc1c1e594bc588ab9c1", "committedDate": "2020-09-18T12:45:30Z", "message": "rename registry variables"}, "afterCommit": {"oid": "33e0cfcbfd5457dfeaf0b39af99df3bc1694b353", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/33e0cfcbfd5457dfeaf0b39af99df3bc1694b353", "committedDate": "2020-09-19T09:09:10Z", "message": "generate test profiles for different environments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1468, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}