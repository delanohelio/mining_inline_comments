{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNjIwMTYx", "number": 2039, "title": "Automatic db schema upgrade", "bodyText": "What does this PR change?\nTo prevent people forgetting to update the database schema, apply it when the services start.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nPart of SUSE/spacewalk#10993\n\n\n DONE\n\n\nTest coverage\n\n\nNo tests: manual\n\n\n DONE\n\n\nLinks\nFixes SUSE/spacewalk#10574\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-03-20T16:15:15Z", "url": "https://github.com/uyuni-project/uyuni/pull/2039", "merged": true, "mergeCommit": {"oid": "80e23eda254876ef5f94d1aa856d5cc4a71bf4e4"}, "closed": true, "closedAt": "2020-03-23T15:52:09Z", "author": {"login": "mcalmer"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQaScigFqTM3OTIyMjQwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQgGNggBqjMxNTU3NzQyNzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MjIyNDA4", "url": "https://github.com/uyuni-project/uyuni/pull/2039#pullrequestreview-379222408", "createdAt": "2020-03-23T08:41:57Z", "commit": {"oid": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODo0MTo1OFrOF57XEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODo0NDo0MVrOF57dFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NTcxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The changes will be applied automatically at the end\n          \n          \n            \n            The patch will be applied automatically at the end", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396285712", "createdAt": "2020-03-23T08:41:58Z", "author": {"login": "keichwa"}, "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjAxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            In case of a failure, some services are stopped or cannot\n          \n          \n            \n            In case of a failure, spacewalk services are stopped and cannot", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396286012", "createdAt": "2020-03-23T08:42:29Z", "author": {"login": "keichwa"}, "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end\n+of the update.\n+In case of a failure, some services are stopped or cannot", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjI3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            be started util the issue was fixed.\n          \n          \n            \n            be started until the issue is fixed.", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396286277", "createdAt": "2020-03-23T08:42:56Z", "author": {"login": "keichwa"}, "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end\n+of the update.\n+In case of a failure, some services are stopped or cannot\n+be started util the issue was fixed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4Njc0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            For more information about the failure call:\n          \n          \n            \n            For more information about the failure, enter:", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396286744", "createdAt": "2020-03-23T08:43:46Z", "author": {"login": "keichwa"}, "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end\n+of the update.\n+In case of a failure, some services are stopped or cannot\n+be started util the issue was fixed.\n \n-1. Stop the Spacewalk service before you apply this patch:\n-spacewalk-service stop\n+For more information about the failure call:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NzI1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When the schema update was applied successfully, start the\n          \n          \n            \n            When the schema update is applied successfully, start the", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396287253", "createdAt": "2020-03-23T08:44:41Z", "author": {"login": "keichwa"}, "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end\n+of the update.\n+In case of a failure, some services are stopped or cannot\n+be started util the issue was fixed.\n \n-1. Stop the Spacewalk service before you apply this patch:\n-spacewalk-service stop\n+For more information about the failure call:\n \n-2. Apply the patch.\n+systemctl status uyuni-check-database.service\n \n-3. If the SUSE Manager database is running on the same machine as\n-your SUSE Manager Server, take care that the database instance is\n-running\n+When the schema update was applied successfully, start the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MjU5NDQz", "url": "https://github.com/uyuni-project/uyuni/pull/2039#pullrequestreview-379259443", "createdAt": "2020-03-23T09:33:34Z", "commit": {"oid": "7b9092e6ec88fa0878c2fe068813943d64cd2188"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwOTozMzozNFrOF59MVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwOTozOTo1NVrOF59byA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxNTczNA==", "bodyText": "Shouldn't  it be spacewalk service as we had before?", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396315734", "createdAt": "2020-03-23T09:33:34Z", "author": {"login": "juliogonzalez"}, "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The patch will be applied automatically at the end\n+of the update.\n+In case of a failure, spacewalk services are stopped and cannot", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b9092e6ec88fa0878c2fe068813943d64cd2188"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxNjQ3Ng==", "bodyText": "As I don't see this service here, I guess it was added in the past, right?\nThis looks good, the package will not break as we always return true, so there will be this error, but services will not start.", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396316476", "createdAt": "2020-03-23T09:34:49Z", "author": {"login": "juliogonzalez"}, "path": "schema/spacewalk/susemanager-schema.spec", "diffHunk": "@@ -103,6 +103,9 @@ else\n fi\n %endif\n \n+%posttrans\n+systemctl try-restart uyuni-check-database.service ||:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b9092e6ec88fa0878c2fe068813943d64cd2188"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxOTY4OA==", "bodyText": "service or services?", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396319688", "createdAt": "2020-03-23T09:39:55Z", "author": {"login": "juliogonzalez"}, "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The patch will be applied automatically at the end\n+of the update.\n+In case of a failure, spacewalk services are stopped and cannot\n+be started until the issue is fixed.\n \n-1. Stop the Spacewalk service before you apply this patch:\n-spacewalk-service stop\n+For more information about the failure, enter:\n \n-2. Apply the patch.\n+systemctl status uyuni-check-database.service\n \n-3. If the SUSE Manager database is running on the same machine as\n-your SUSE Manager Server, take care that the database instance is\n-running\n+When the schema update is applied successfully, start the\n+services again with:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b9092e6ec88fa0878c2fe068813943d64cd2188"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MzAwNjA4", "url": "https://github.com/uyuni-project/uyuni/pull/2039#pullrequestreview-379300608", "createdAt": "2020-03-23T10:28:43Z", "commit": {"oid": "7b9092e6ec88fa0878c2fe068813943d64cd2188"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMDoyODo0NFrOF5_Nhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMDoyODo0NFrOF5_Nhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0ODgwNg==", "bodyText": "Why do we need this change?", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396348806", "createdAt": "2020-03-23T10:28:44Z", "author": {"login": "hustodemon"}, "path": "spacewalk/admin/spacewalk-admin.spec", "diffHunk": "@@ -86,6 +86,12 @@ ln -s spacewalk-service $RPM_BUILD_ROOT%{_sbindir}/rhn-satellite\n sed -i 's|#!/usr/bin/python|#!/usr/bin/python3|' $RPM_BUILD_ROOT/usr/bin/mgr-events-config.py\n %endif\n \n+%post", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b9092e6ec88fa0878c2fe068813943d64cd2188"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDMzODU5", "url": "https://github.com/uyuni-project/uyuni/pull/2039#pullrequestreview-379433859", "createdAt": "2020-03-23T13:36:39Z", "commit": {"oid": "7b9092e6ec88fa0878c2fe068813943d64cd2188"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24aa504e1b84e73a10225c51cafc5700ba06ce24", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/24aa504e1b84e73a10225c51cafc5700ba06ce24", "committedDate": "2020-03-23T15:04:54Z", "message": "run database schema upgrade on startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eccd5fbfce35956f056063e2689f2e0de3535fc3", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/eccd5fbfce35956f056063e2689f2e0de3535fc3", "committedDate": "2020-03-23T15:04:54Z", "message": "update changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be06938711ddee0a782f77acaf4708c77c250308", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/be06938711ddee0a782f77acaf4708c77c250308", "committedDate": "2020-03-23T15:04:54Z", "message": "reload systemd daemon on package install or update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b43cb6ce07a90ce83dcdd370543c82de148f1220", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/b43cb6ce07a90ce83dcdd370543c82de148f1220", "committedDate": "2020-03-23T15:04:54Z", "message": "change update message to reflect schema auto upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c3f78653ce3f452867386e343c56fca61f1aead", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/8c3f78653ce3f452867386e343c56fca61f1aead", "committedDate": "2020-03-23T15:04:54Z", "message": "try to restart database check to apply schema upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47312d3cc728257e9b3fe9295e084d4d43740982", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/47312d3cc728257e9b3fe9295e084d4d43740982", "committedDate": "2020-03-23T15:05:13Z", "message": "update changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b9092e6ec88fa0878c2fe068813943d64cd2188", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7b9092e6ec88fa0878c2fe068813943d64cd2188", "committedDate": "2020-03-23T08:49:17Z", "message": "Update schema/spacewalk/update-messages.txt\n\nCo-Authored-By: Karl Eichwalder <ke@suse.de>"}, "afterCommit": {"oid": "21dd3dc17cfa8fc1c4132965f9a6a5e191ae0729", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/21dd3dc17cfa8fc1c4132965f9a6a5e191ae0729", "committedDate": "2020-03-23T15:05:46Z", "message": "Update update-messages.txt\n\nCo-Authored-By: Karl Eichwalder <ke@suse.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "307cb9eb0bf6ba18dd89ed9275d0ad08b9569a3f", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/307cb9eb0bf6ba18dd89ed9275d0ad08b9569a3f", "committedDate": "2020-03-23T15:32:25Z", "message": "Update update-messages.txt\n\nCo-Authored-By: Karl Eichwalder <ke@suse.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21dd3dc17cfa8fc1c4132965f9a6a5e191ae0729", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/21dd3dc17cfa8fc1c4132965f9a6a5e191ae0729", "committedDate": "2020-03-23T15:05:46Z", "message": "Update update-messages.txt\n\nCo-Authored-By: Karl Eichwalder <ke@suse.de>"}, "afterCommit": {"oid": "307cb9eb0bf6ba18dd89ed9275d0ad08b9569a3f", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/307cb9eb0bf6ba18dd89ed9275d0ad08b9569a3f", "committedDate": "2020-03-23T15:32:25Z", "message": "Update update-messages.txt\n\nCo-Authored-By: Karl Eichwalder <ke@suse.de>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1516, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}