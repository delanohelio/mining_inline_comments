{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMDY1MDkx", "number": 2034, "title": "Refactoring the validation of a package installed", "bodyText": "What does this PR change?\nThat PR intends to fix an intermittent issue with the zypper command, which was running in the background at the moment we were executing another zypper command.\nThe whole conflict seems to be caused due to a check of the status of a salt-action, we only do it via command line, by testing if a package is installed, instead of checking the salt event status from webUI.\nHere we had two solutions, either we change the validation from command line and we check it via webU as we do in other scenarios, either we assure during the command line steps that not only the package is installed but also the zypper/apt-get command has finished.\nFor now, as it is less disruptive, I went through the second option.\nNote:\nYou will notice also small changes, like a rename of a step to combine two opposite steps and removing unuseful sleep calls as just after it they have a wait command.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed\n\n\n DONE\n\n\nTest coverage\n\n\nCucumber tests were changed\n\n\n DONE\n\n\nLinks\nFixes # https://ci.suse.de/view/Manager/view/Uyuni/job/uyuni-master-cucumber-pipeline-NUE/1230/TestSuite_20Report/\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-03-19T15:18:15Z", "url": "https://github.com/uyuni-project/uyuni/pull/2034", "merged": true, "mergeCommit": {"oid": "0b0aa9b5fa778ff56476deb0523bdc81f50b8634"}, "closed": true, "closedAt": "2020-03-31T13:21:39Z", "author": {"login": "srbarrios"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPOH34gFqTM3Nzg2MjkyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPcG5IgFqTM3ODI5Mjc4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODYyOTIy", "url": "https://github.com/uyuni-project/uyuni/pull/2034#pullrequestreview-377862922", "createdAt": "2020-03-19T16:00:35Z", "commit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMDozNVrOF41SQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMDozNVrOF41SQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzNzYwMQ==", "bodyText": "If the command returns nonzero status, then there is no such a process running (thus we are all set):\nbreak if code.zero? -> break unless code.zero?", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395137601", "createdAt": "2020-03-19T16:00:35Z", "author": {"login": "calancha"}, "path": "testsuite/features/support/lavanda.rb", "diffHunk": "@@ -65,4 +65,14 @@ def run_until_fail(cmd)\n       result\n     end\n   end\n+\n+  def wait_while_process_running(process)\n+    result = nil\n+    repeat_until_timeout(report_result: true) do\n+      result, code = run(\"pgrep -x #{process} >/dev/null\", false)\n+      break if code.zero?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODYzODE3", "url": "https://github.com/uyuni-project/uyuni/pull/2034#pullrequestreview-377863817", "createdAt": "2020-03-19T16:01:30Z", "commit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMTozMFrOF41U-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjowMzoyMFrOF41aHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzODI5OQ==", "bodyText": "Rather \"When\" (there's no \"should\" in step title, it's rather an action than a test...)", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395138299", "createdAt": "2020-03-19T16:01:30Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -60,6 +60,31 @@\n   node.run(\"rpm -q #{package}; test $? -ne 0\")\n end\n \n+Then(/^I wait for \"([^\"]*)\" to be (uninstalled|installed) on \"([^\"]*)\"$/) do |package, status, host|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTIwOA==", "bodyText": "OK we go that way. Fine.", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395139208", "createdAt": "2020-03-19T16:02:47Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -60,6 +60,31 @@\n   node.run(\"rpm -q #{package}; test $? -ne 0\")\n end\n \n+Then(/^I wait for \"([^\"]*)\" to be (uninstalled|installed) on \"([^\"]*)\"$/) do |package, status, host|\n+  if package.include?(\"suma\") && $product == \"Uyuni\"\n+    package.gsub! \"suma\", \"uyuni\"\n+  end\n+  node = get_target(host)\n+  if host.include? 'ubuntu'\n+    node.wait_while_process_running('apt-get')\n+    pkg_version = package.split('-')[-1]\n+    pkg_name = package.delete_suffix(\"-#{pkg_version}\")\n+    pkg_version_regexp = pkg_version.gsub('.', '\\\\.')\n+    if status == 'installed'\n+      node.run_until_ok(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    else\n+      node.run_until_fail(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    end\n+  else\n+    node.wait_while_process_running('zypper')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTYxNQ==", "bodyText": "Ooooh cool I wanted to get rid of these \"this\" for so long...", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395139615", "createdAt": "2020-03-19T16:03:20Z", "author": {"login": "Bischoff"}, "path": "testsuite/features/secondary/min_action_chain.feature", "diffHunk": "@@ -165,7 +165,7 @@ Feature: Action chains on Salt minions\n     And I follow \"new action chain\"\n     And I click on \"Save and Schedule\"\n     Then I should see a \"Action Chain new action chain has been scheduled for execution.\" text\n-    When I wait for \"virgo-dummy\" to be installed on this \"sle_minion\"\n+    When I wait for \"virgo-dummy\" to be installed on \"sle_minion\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f0d5922c229218f5112b3b99f5c5f02998d64f8"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fa78201fa548884c47152c9e8e6f022337c4ec8", "author": {"user": {"login": "srbarrios", "name": "Oscar Barrios"}}, "url": "https://github.com/uyuni-project/uyuni/commit/5fa78201fa548884c47152c9e8e6f022337c4ec8", "committedDate": "2020-03-19T16:35:07Z", "message": "Refactoring the validation of a package installed"}, "afterCommit": {"oid": "ab3a9b2e0efef4d466a97d5204d4224c8a548271", "author": {"user": {"login": "srbarrios", "name": "Oscar Barrios"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ab3a9b2e0efef4d466a97d5204d4224c8a548271", "committedDate": "2020-03-19T16:36:39Z", "message": "Refactoring the validation of a package installed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6049c36e5196c1a290b0aeb2b7bcb158f886cc0d", "author": {"user": {"login": "srbarrios", "name": "Oscar Barrios"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6049c36e5196c1a290b0aeb2b7bcb158f886cc0d", "committedDate": "2020-03-19T16:46:33Z", "message": "Refactoring the validation of a package installed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab3a9b2e0efef4d466a97d5204d4224c8a548271", "author": {"user": {"login": "srbarrios", "name": "Oscar Barrios"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ab3a9b2e0efef4d466a97d5204d4224c8a548271", "committedDate": "2020-03-19T16:36:39Z", "message": "Refactoring the validation of a package installed"}, "afterCommit": {"oid": "6049c36e5196c1a290b0aeb2b7bcb158f886cc0d", "author": {"user": {"login": "srbarrios", "name": "Oscar Barrios"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6049c36e5196c1a290b0aeb2b7bcb158f886cc0d", "committedDate": "2020-03-19T16:46:33Z", "message": "Refactoring the validation of a package installed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4Mjg2OTg4", "url": "https://github.com/uyuni-project/uyuni/pull/2034#pullrequestreview-378286988", "createdAt": "2020-03-20T08:08:07Z", "commit": {"oid": "6049c36e5196c1a290b0aeb2b7bcb158f886cc0d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MjkyNzgx", "url": "https://github.com/uyuni-project/uyuni/pull/2034#pullrequestreview-378292781", "createdAt": "2020-03-20T08:19:49Z", "commit": {"oid": "6049c36e5196c1a290b0aeb2b7bcb158f886cc0d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1508, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}