{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MzI5OTIx", "number": 2201, "title": "Content Lifecycle Management: speedup", "bodyText": "What does this PR change?\nIt makes typical operations in CLM (build and promote) faster.\nMeasured speedups follow:\n\n\n\n\nSLES 12 SP3\nRES 7\n\n\n\n\nbuild\n~9x (35 min \u2192 4 min)\n~91x (2003 min \u2192 22 min)\n\n\npromote\n~10x (30 min \u2192 3 min)\n~223x (2010 min \u2192 9 min)\n\n\n\nThis was tested on my laptop building a SLES 12 SP3 or RES 7 project without filters or with a simple date filter on patches.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: no user visible change\n\n\n DONE\n\n\nTest coverage\n\n\nUnit tests were adapted\n\n\n DONE\n\n\nLinks\nFixes SUSE/spacewalk#10361\nTracks SUSE/spacewalk#11473\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\" (Test skipped, there are no changes to test)\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-05-11T20:30:08Z", "url": "https://github.com/uyuni-project/uyuni/pull/2201", "merged": true, "mergeCommit": {"oid": "344c00be66b17fd8d6c498c11a3f35dc08784a00"}, "closed": true, "closedAt": "2020-05-16T14:28:01Z", "author": {"login": "moio"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgX20SgBqjMzMjUwODk5MDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchncbgABqjMzNDIzMTgwMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e505a2244c884d9ad556abb6ebc4f76ae279163c", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/e505a2244c884d9ad556abb6ebc4f76ae279163c", "committedDate": "2020-05-11T20:25:39Z", "message": "refactoring: inline publish() and delete dead code\n\nErrataManager.publish() used to:\n\n - call ErrataFactory.publish(), but that is a noop if the errata is\nalready published, which is always the case here\n - call addChannelsToErrata(), which used to:\n   - make sure the user had access to the specified channel. Moved to\ntop lookup instead, so that it is not done for each errata\n   - call ErrataCacheManager.insertCacheForChannelErrata(), retained\n   - call storeErrata(), which saved the Hibernate entity, but it is not\nchanged by current code (so also a noop)\n   - call updateSearchIndex(), retained"}, "afterCommit": {"oid": "70c471e33c19264d9dba8fb6c8a1cd4c95a47806", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/70c471e33c19264d9dba8fb6c8a1cd4c95a47806", "committedDate": "2020-05-11T22:58:11Z", "message": "CLM speedup: disable autoflushing on more code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d37d93693f74399c3c731c1cd73e4cdf732ebb34", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/d37d93693f74399c3c731c1cd73e4cdf732ebb34", "committedDate": "2020-05-13T16:41:52Z", "message": "bugfix: unit test used incorrect user"}, "afterCommit": {"oid": "4b5e753f800a993a5f536ed35770840c7636d58b", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4b5e753f800a993a5f536ed35770840c7636d58b", "committedDate": "2020-05-13T21:23:22Z", "message": "Changelog update"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b5e753f800a993a5f536ed35770840c7636d58b", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/4b5e753f800a993a5f536ed35770840c7636d58b", "committedDate": "2020-05-13T21:23:22Z", "message": "Changelog update"}, "afterCommit": {"oid": "9eed7a7cd04c508ac488cf5ec4cd9fabb9d9affc", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/9eed7a7cd04c508ac488cf5ec4cd9fabb9d9affc", "committedDate": "2020-05-14T20:56:51Z", "message": "Changelog update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNjIzNDgy", "url": "https://github.com/uyuni-project/uyuni/pull/2201#pullrequestreview-412623482", "createdAt": "2020-05-15T12:57:03Z", "commit": {"oid": "b21afbe6dc08926ac37c27e9d2add33ce4d2d7a1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMjo1NzowM1rOGWDtew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMzoxNTo0OVrOGWEYWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc4MjY1MQ==", "bodyText": "Nit tip: Set.of(errataId)", "url": "https://github.com/uyuni-project/uyuni/pull/2201#discussion_r425782651", "createdAt": "2020-05-15T12:57:03Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/manager/errata/cache/ErrataCacheManager.java", "diffHunk": "@@ -269,6 +271,7 @@ public static void insertCacheForChannelErrataAsync(List<Long> channelIdsToUpdat\n      */\n     public static void insertCacheForChannelErrata(Collection<Long> channelIdsToUpdate, Long errataId) {\n         for (Long cid : channelIdsToUpdate) {\n+            ChannelFactory.addErrataToChannel(new HashSet<Long>() {{ add(errataId); }}, cid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b21afbe6dc08926ac37c27e9d2add33ce4d2d7a1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc5MzYyNA==", "bodyText": "call ErrataFactory.publish(), but that is a noop if the errata is\nalready published, which is always the case here\n\nIs this true in general (outside CLM context)? This method is also used for general errata cloning via XMLRPC (ChannelSoftwareHandler.mergeErrata).", "url": "https://github.com/uyuni-project/uyuni/pull/2201#discussion_r425793624", "createdAt": "2020-05-15T13:15:49Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/redhat/rhn/manager/errata/ErrataManager.java", "diffHunk": "@@ -2300,7 +2293,11 @@ public static void cloneErrata(Long channelId, Collection<Long> errataToClone, b\n                 }\n                 else {\n                     log.debug(\"Re-publishing clone\");\n-                    publish(clones.get(0), cids, user);\n+                    Errata firstClone = clones.get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed0743459b6c1c42d721d88a7ae2fc845826b2d"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acd7026ee942feffecf73cbaca38e3cea1d0cf83", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/acd7026ee942feffecf73cbaca38e3cea1d0cf83", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: make comment agree with code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503e14d690a404191b56b3ef55bc65fa09334483", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/503e14d690a404191b56b3ef55bc65fa09334483", "committedDate": "2020-05-15T19:42:02Z", "message": "Make mode queries aware of Hibernate's flush mode\n\nWhen handling many objects in the Hibernate cache, it is sometimes\nappropriate to use the HibernateFactory#doWithoutAutoFlushing helpers\nin order to prevent needless flushing which hurts performance.\n\nMode queries always flushed, thereby making it more difficult to mix\nHibernate-based and mode-query-based code in presence of many objects in\nHibernate's cache.\n\nThis change will prevent flushing in mode queries when\ndoWithoutAutoFlushing is used."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffdb99a326c6e3e0838d8044808eebbd21acef4c", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ffdb99a326c6e3e0838d8044808eebbd21acef4c", "committedDate": "2020-05-15T19:42:02Z", "message": "CLM speedup: use cloneErrataFaster and avoid flushing\n\nPublishErrataHelper.cloneErrataFaster is indeed faster than\nPublishErrataHelper.cloneErrataFast, but only under the assumption not\nvery many objects are present in Hibernate's cache, because being\nimplemented in mode queries it means it flush()es the Hibernate session\nfrequently.\n\nThis chance uses the faster method, while also preventing flushes - on a\ntypical CLM scenario (SLES 12 SP3-based) it makes the build time ~3x\nfaster."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cd4761b73ad9537d3cec662410bc491637573a8", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/2cd4761b73ad9537d3cec662410bc491637573a8", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: change parameter type to reflect implementation is mode-queries only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8afbe4c54fc2925bc1b8496842cbe5a72951699f", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/8afbe4c54fc2925bc1b8496842cbe5a72951699f", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: insertCacheForChannelErrata: accept any Collection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a30693f779379219625507492b86718d204a931", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/7a30693f779379219625507492b86718d204a931", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: method rename to reflect code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfae6fc591374addf0c77aec567891d977a6985a", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/dfae6fc591374addf0c77aec567891d977a6985a", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: lookupByIdAndUser never returns null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78ea8236e496dd5af978d2e22e78732994136ee7", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/78ea8236e496dd5af978d2e22e78732994136ee7", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: move adding errata to channel inside of insertCacheForChannelErrata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a0fb1f8aef47a90086fed7852f4032baf2ed55f", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/1a0fb1f8aef47a90086fed7852f4032baf2ed55f", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: change parameter type to reflect implementation is mode-queries only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29785e51880181fd95f718921d5c4eb8c7317d5c", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/29785e51880181fd95f718921d5c4eb8c7317d5c", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: rename to reflect what code actually does"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "807b461a24187948885affc610c0d1b2794f6d92", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/807b461a24187948885affc610c0d1b2794f6d92", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: move method to ErrataManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8d4dd43bf0ff9535ce48185eb7c6b098d8ecf75", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c8d4dd43bf0ff9535ce48185eb7c6b098d8ecf75", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: move notification setting inside of insertCacheForChannelErrata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15b4e9df21904809ea10721a28787b342a5eb181", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/15b4e9df21904809ea10721a28787b342a5eb181", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: inline publish() and delete dead code\n\nErrataManager.publish() used to:\n\n - call ErrataFactory.publish(), but that is a noop if the errata is\nalready published, which is always the case here\n - call addChannelsToErrata(), which used to:\n   - make sure the user had access to the specified channel. Moved to\ntop lookup instead, so that it is not done for each errata\n   - call ErrataCacheManager.insertCacheForChannelErrata(), retained\n   - call storeErrata(), which saved the Hibernate entity, but it is not\nchanged by current code (so also a noop)\n   - call updateSearchIndex(), retained"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbfbc5bfcdaaec1a20cf3c3499585a3a49b60df0", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cbfbc5bfcdaaec1a20cf3c3499585a3a49b60df0", "committedDate": "2020-05-15T19:42:02Z", "message": "CLM speedup: reindex search on errata once per channel, not once per errata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbc39ac9c67b93e84ce87b5926d60c1b87cd686b", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cbc39ac9c67b93e84ce87b5926d60c1b87cd686b", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: remove dead code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "267d6f8af5fbfaf6b266a31d7782bdd353b8ebf0", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/267d6f8af5fbfaf6b266a31d7782bdd353b8ebf0", "committedDate": "2020-05-15T19:42:02Z", "message": "refactoring: rename method to new semantics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce40d483c1642ac53836d592b667286f013f39e1", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ce40d483c1642ac53836d592b667286f013f39e1", "committedDate": "2020-05-15T19:42:02Z", "message": "CLM speedup: disable autoflushing on more code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4e5df92bb12f705ed1caafc4445647e1e1aa87a", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/c4e5df92bb12f705ed1caafc4445647e1e1aa87a", "committedDate": "2020-05-15T19:42:02Z", "message": "CLM speedup: force ANALYZE of rhnChannelPackage after massive insertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b6a4f61847cdc11a62d60c8ba6d8464e6af47a", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/70b6a4f61847cdc11a62d60c8ba6d8464e6af47a", "committedDate": "2020-05-15T19:42:02Z", "message": "bugfix: unit test used incorrect user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ac9e772d6ba490e4641e0ee38b8a94a33438cc9", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/0ac9e772d6ba490e4641e0ee38b8a94a33438cc9", "committedDate": "2020-05-15T19:42:23Z", "message": "Changelog update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2acdd2fa5612ce627a9b54ad3434805cbe409c7", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a2acdd2fa5612ce627a9b54ad3434805cbe409c7", "committedDate": "2020-05-15T19:42:23Z", "message": "refactoring: use proper Set constructor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "449c930fe237307ff4f44db8faf36809c7179939", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/449c930fe237307ff4f44db8faf36809c7179939", "committedDate": "2020-05-15T14:00:05Z", "message": "refactoring: use proper Set constructor"}, "afterCommit": {"oid": "a2acdd2fa5612ce627a9b54ad3434805cbe409c7", "author": {"user": {"login": "moio", "name": "Silvio Moioli"}}, "url": "https://github.com/uyuni-project/uyuni/commit/a2acdd2fa5612ce627a9b54ad3434805cbe409c7", "committedDate": "2020-05-15T19:42:23Z", "message": "refactoring: use proper Set constructor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1436, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}