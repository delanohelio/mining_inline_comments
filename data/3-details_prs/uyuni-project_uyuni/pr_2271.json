{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NDg1NTQ4", "number": 2271, "title": "Highstate on bootstrap with entitlements", "bodyText": "What does this PR change?\nDuring bootstrapping of a system an aktivation key could be used to enable add-on system types like buildhost and monitoring node. They require to run a highstate to get the system configured properly.\nCheck for add-on system types in the activation key and run a full highstate when they are used.\nGUI diff\nNo difference.\n\n DONE\n\nDocumentation\n\n\nNo documentation needed: internal\n\n\n DONE\n\n\nTest coverage\n\n\nNo tests testing message queues is impossible\n\n\n DONE\n\n\nLinks\nFixes SUSE/spacewalk#11568\nTracks SUSE/spacewalk#11615\n\n DONE\n\nChangelogs\nIf you don't need a changelog check, please mark this checkbox:\n\n No changelog needed\n\nIf you uncheck the checkbox after the PR is created, you will need to re-run changelog_test (see below)\nRe-run a test\nIf you need to re-run a test, please mark the related checkbox, it will be unchecked automatically once it has re-run:\n\n Re-run test \"changelog_test\"\n Re-run test \"backend_unittests_pgsql\"\n Re-run test \"java_lint_checkstyle\"\n Re-run test \"java_pgsql_tests\"\n Re-run test \"ruby_rubocop\"\n Re-run test \"schema_migration_test_oracle\"\n Re-run test \"schema_migration_test_pgsql\"\n Re-run test \"susemanager_unittests\"\n Re-run test \"javascript_lint\"\n Re-run test \"spacecmd_unittests\"", "createdAt": "2020-06-02T10:09:57Z", "url": "https://github.com/uyuni-project/uyuni/pull/2271", "merged": true, "mergeCommit": {"oid": "9344d0974c24b47211c9b788a0f17b4431e928e2"}, "closed": true, "closedAt": "2020-06-04T09:12:30Z", "author": {"login": "mcalmer"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnU3rrgFqTQyMjY3NDQ2Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn5sU4ABqjM0MDU2NzMyNDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjc0NDYz", "url": "https://github.com/uyuni-project/uyuni/pull/2271#pullrequestreview-422674463", "createdAt": "2020-06-02T13:28:02Z", "commit": {"oid": "99af08c7d71c9052e3bd15f6424b279c3346f64d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzoyODowMlrOGdxj6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzoyODowMlrOGdxj6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3Mzg5Ng==", "bodyText": "I would be happy about ideas for better testing it.\nI also have no idea why the first state.apply seems to be \"executed\" and not be anymore in the queue,\nbut the hightstate stay in the queue.", "url": "https://github.com/uyuni-project/uyuni/pull/2271#discussion_r433873896", "createdAt": "2020-06-02T13:28:02Z", "author": {"login": "mcalmer"}, "path": "java/code/src/com/suse/manager/reactor/test/RegisterMinionActionTest.java", "diffHunk": "@@ -1905,6 +1911,72 @@ public void testMinionWithUsedReActivationKeyWithStartUpGrains() throws Exceptio\n                 Optional.of(minionStartUpGrains));\n     }\n \n+    public void testRegisterMinionWithActivationKeyAndAddOns() throws Exception {\n+        MessageQueue.registerAction(new ApplyStatesEventMessageAction(),\n+                ApplyStatesEventMessage.class);\n+        MessageQueue.startMessaging();\n+        ChannelFamily channelFamily = createTestChannelFamily();\n+        SUSEProduct product = SUSEProductTestUtils.createTestSUSEProduct(channelFamily);\n+        Channel baseChannelX8664 = setupBaseAndRequiredChannels(channelFamily, product);\n+        HibernateFactory.getSession().flush();\n+        executeTest(\n+                (saltServiceMock, key) -> new Expectations() {{\n+                    allowing(saltServiceMock).getMasterHostname(MINION_ID);\n+                    will(returnValue(Optional.of(MINION_ID)));\n+                    allowing(saltServiceMock).getMachineId(MINION_ID);\n+                    will(returnValue(Optional.of(MACHINE_ID)));\n+                    MinionStartupGrains.SuseManagerGrain suseManagerGrain = new MinionStartupGrains.SuseManagerGrain(Optional.of(key));\n+                    MinionStartupGrains minionStartUpGrains =  new MinionStartupGrains.MinionStartupGrainsBuilder()\n+                            .machineId(MACHINE_ID).saltbootInitrd(false).susemanagerGrain(suseManagerGrain)\n+                            .createMinionStartUpGrains();\n+                    allowing(saltServiceMock).getGrains(with(any(String.class)), with(any(TypeToken.class)),with(any(String[].class)));\n+                    will(returnValue(Optional.of(minionStartUpGrains)));\n+                    allowing(saltServiceMock).syncGrains(with(any(MinionList.class)));\n+                    allowing(saltServiceMock).syncModules(with(any(MinionList.class)));\n+                    allowing(saltServiceMock).getGrains(MINION_ID);\n+                    will(returnValue(getGrains(MINION_ID, null, key)));\n+                }},\n+                (contactMethod) -> {\n+                    ActivationKey key = ActivationKeyTest.createTestActivationKey(user);\n+                    key.setBaseChannel(baseChannelX8664);\n+                    baseChannelX8664.getAccessibleChildrenFor(user)\n+                            .forEach(channel -> key.addChannel(channel));\n+                    key.setOrg(user.getOrg());\n+\n+                    Set<ServerGroupType> entitlementsIn = key.getEntitlements();\n+                    entitlementsIn.add(ServerConstants.getServerGroupTypeContainerBuildHostEntitled());\n+                    key.setEntitlements(entitlementsIn);\n+\n+                    ActivationKeyFactory.save(key);\n+                    return key.getKey();\n+                },\n+                (optMinion, machineId, key) -> {\n+                    assertTrue(optMinion.isPresent());\n+                    MinionServer minion = optMinion.get();\n+                    assertEquals(MINION_ID, minion.getName());\n+\n+                    // only channel associated with Activation Key and child\n+                    // channels associated with it must be present\n+                    assertNotNull(minion.getBaseChannel());\n+                    HashSet<Channel> channels = new HashSet<>();\n+                    channels.add(baseChannelX8664);\n+                    baseChannelX8664.getAccessibleChildrenFor(user)\n+                    .forEach(channel -> channels.add(channel));\n+                    assertEquals(baseChannelX8664, minion.getBaseChannel());\n+                    assertEquals(channels.size(), minion.getChannels().size());\n+                    assertTrue(minion.getChannels().containsAll(channels));\n+\n+                    assertTrue(minion.getFqdns().isEmpty());\n+                    // the first ApplyStatesEvent with channels is executed.\n+                    // the second (highstate) stay in the queue and can be counted\n+                    assertEquals(1, MessageQueue.getMessageCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99af08c7d71c9052e3bd15f6424b279c3346f64d"}, "originalPosition": 92}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99af08c7d71c9052e3bd15f6424b279c3346f64d", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/99af08c7d71c9052e3bd15f6424b279c3346f64d", "committedDate": "2020-06-02T13:26:00Z", "message": "unit test: addOns should cause a highstate when onboarding a system"}, "afterCommit": {"oid": "cd78b6c6c73a2036b397247236335ae66c1e045f", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cd78b6c6c73a2036b397247236335ae66c1e045f", "committedDate": "2020-06-02T15:49:41Z", "message": "unit test: addOns should cause a highstate when onboarding a system"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMjc1OTE5", "url": "https://github.com/uyuni-project/uyuni/pull/2271#pullrequestreview-423275919", "createdAt": "2020-06-03T07:12:28Z", "commit": {"oid": "cd78b6c6c73a2036b397247236335ae66c1e045f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwNzoxMjoyOFrOGeO44Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwNzoxMjoyOFrOGeO44Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1NDQwMQ==", "bodyText": "Hm, although it would be nice to have this tested, testing it this way looks quite dangerous to me. The reason, why we only get 1 message here is that the previous ApplyStatesEvent was processed by another thread (RHN dispatcher thread). The tests run in \"main\" thread, which could potentially bring some race conditions (e.g. if you put Thread.sleep(10000L); in the MessageQueue.popEventMessage on line 144, your test starts failing, as there will be 2 messages in the queue (this simulates the behavior, when the first ApplyStatesEvent \"would take longer\")).\nI think that testability of the MessageQueue is part of a bigger problem, which should be solved separately and properly, therefore I'd suggest removing this test.", "url": "https://github.com/uyuni-project/uyuni/pull/2271#discussion_r434354401", "createdAt": "2020-06-03T07:12:28Z", "author": {"login": "hustodemon"}, "path": "java/code/src/com/suse/manager/reactor/test/RegisterMinionActionTest.java", "diffHunk": "@@ -1905,6 +1911,72 @@ public void testMinionWithUsedReActivationKeyWithStartUpGrains() throws Exceptio\n                 Optional.of(minionStartUpGrains));\n     }\n \n+    public void testRegisterMinionWithActivationKeyAndAddOns() throws Exception {\n+        MessageQueue.registerAction(new ApplyStatesEventMessageAction(),\n+                ApplyStatesEventMessage.class);\n+        MessageQueue.startMessaging();\n+        ChannelFamily channelFamily = createTestChannelFamily();\n+        SUSEProduct product = SUSEProductTestUtils.createTestSUSEProduct(channelFamily);\n+        Channel baseChannelX8664 = setupBaseAndRequiredChannels(channelFamily, product);\n+        HibernateFactory.getSession().flush();\n+        executeTest(\n+                (saltServiceMock, key) -> new Expectations() {{\n+                    allowing(saltServiceMock).getMasterHostname(MINION_ID);\n+                    will(returnValue(Optional.of(MINION_ID)));\n+                    allowing(saltServiceMock).getMachineId(MINION_ID);\n+                    will(returnValue(Optional.of(MACHINE_ID)));\n+                    MinionStartupGrains.SuseManagerGrain suseManagerGrain = new MinionStartupGrains.SuseManagerGrain(Optional.of(key));\n+                    MinionStartupGrains minionStartUpGrains =  new MinionStartupGrains.MinionStartupGrainsBuilder()\n+                            .machineId(MACHINE_ID).saltbootInitrd(false).susemanagerGrain(suseManagerGrain)\n+                            .createMinionStartUpGrains();\n+                    allowing(saltServiceMock).getGrains(with(any(String.class)), with(any(TypeToken.class)),with(any(String[].class)));\n+                    will(returnValue(Optional.of(minionStartUpGrains)));\n+                    allowing(saltServiceMock).syncGrains(with(any(MinionList.class)));\n+                    allowing(saltServiceMock).syncModules(with(any(MinionList.class)));\n+                    allowing(saltServiceMock).getGrains(MINION_ID);\n+                    will(returnValue(getGrains(MINION_ID, null, key)));\n+                }},\n+                (contactMethod) -> {\n+                    ActivationKey key = ActivationKeyTest.createTestActivationKey(user);\n+                    key.setBaseChannel(baseChannelX8664);\n+                    baseChannelX8664.getAccessibleChildrenFor(user)\n+                            .forEach(channel -> key.addChannel(channel));\n+                    key.setOrg(user.getOrg());\n+\n+                    Set<ServerGroupType> entitlementsIn = key.getEntitlements();\n+                    entitlementsIn.add(ServerConstants.getServerGroupTypeContainerBuildHostEntitled());\n+                    key.setEntitlements(entitlementsIn);\n+\n+                    ActivationKeyFactory.save(key);\n+                    return key.getKey();\n+                },\n+                (optMinion, machineId, key) -> {\n+                    assertTrue(optMinion.isPresent());\n+                    MinionServer minion = optMinion.get();\n+                    assertEquals(MINION_ID, minion.getName());\n+\n+                    // only channel associated with Activation Key and child\n+                    // channels associated with it must be present\n+                    assertNotNull(minion.getBaseChannel());\n+                    HashSet<Channel> channels = new HashSet<>();\n+                    channels.add(baseChannelX8664);\n+                    baseChannelX8664.getAccessibleChildrenFor(user)\n+                    .forEach(channel -> channels.add(channel));\n+                    assertEquals(baseChannelX8664, minion.getBaseChannel());\n+                    assertEquals(channels.size(), minion.getChannels().size());\n+                    assertTrue(minion.getChannels().containsAll(channels));\n+\n+                    assertTrue(minion.getFqdns().isEmpty());\n+                    // the first ApplyStatesEvent with channels is executed.\n+                    // the second (highstate) stay in the queue and can be counted\n+                    assertEquals(1, MessageQueue.getMessageCount());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3Mzg5Ng=="}, "originalCommit": {"oid": "99af08c7d71c9052e3bd15f6424b279c3346f64d"}, "originalPosition": 92}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd78b6c6c73a2036b397247236335ae66c1e045f", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/cd78b6c6c73a2036b397247236335ae66c1e045f", "committedDate": "2020-06-02T15:49:41Z", "message": "unit test: addOns should cause a highstate when onboarding a system"}, "afterCommit": {"oid": "6660548145a1860a0e8ed4ca9d7fa67a4058c5b5", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6660548145a1860a0e8ed4ca9d7fa67a4058c5b5", "committedDate": "2020-06-02T15:49:41Z", "message": "update changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjAwNjEx", "url": "https://github.com/uyuni-project/uyuni/pull/2271#pullrequestreview-423600611", "createdAt": "2020-06-03T14:17:49Z", "commit": {"oid": "6660548145a1860a0e8ed4ca9d7fa67a4058c5b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6660548145a1860a0e8ed4ca9d7fa67a4058c5b5", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/6660548145a1860a0e8ed4ca9d7fa67a4058c5b5", "committedDate": "2020-06-02T15:49:41Z", "message": "update changelog"}, "afterCommit": {"oid": "87948a7af22d6e1bb1b1c3fedcb321ec6300f451", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/87948a7af22d6e1bb1b1c3fedcb321ec6300f451", "committedDate": "2020-06-03T15:07:36Z", "message": "update changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10f567f2c73d215f27276135ebbcf66f26fd8e42", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/10f567f2c73d215f27276135ebbcf66f26fd8e42", "committedDate": "2020-06-04T08:21:11Z", "message": "apply highstate when add-on system types should be applied to the on bootstrapping (bsc#1172190)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae406b9afbf3b2a559e4196c4a75a5087c0ff940", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ae406b9afbf3b2a559e4196c4a75a5087c0ff940", "committedDate": "2020-06-04T08:21:43Z", "message": "update changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87948a7af22d6e1bb1b1c3fedcb321ec6300f451", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/87948a7af22d6e1bb1b1c3fedcb321ec6300f451", "committedDate": "2020-06-03T15:07:36Z", "message": "update changelog"}, "afterCommit": {"oid": "ae406b9afbf3b2a559e4196c4a75a5087c0ff940", "author": {"user": {"login": "mcalmer", "name": "Michael Calmer"}}, "url": "https://github.com/uyuni-project/uyuni/commit/ae406b9afbf3b2a559e4196c4a75a5087c0ff940", "committedDate": "2020-06-04T08:21:43Z", "message": "update changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1282, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}