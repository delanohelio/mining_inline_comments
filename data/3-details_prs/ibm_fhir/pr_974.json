{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NTQ3Nzcx", "number": 974, "title": "issue #930 - ensure status is never null from delete AND return 200 OK on success", "bodyText": "While investigating the issue, I found that delete and conditionalDelete were handled subtely different.\nNow the response status is set in FHIRRestHelper.doDelete() and these two variants share a common buildResponse helper.\nAdditionally, we were inconsistent in the response status being returned.\nPreviously we were returning 204 (No Content) for some deletes and 200 (OK) status for others.\nNow we will always return a 200 (OK) for a successful delete and the response will always contain an OperationOutcome:\n\nFor conditional deletes with no matches, we return a warning\nFor the deletion of a previously deleted resource, we return a warning\nFor the deletion of a non-existent resource, we return a warning\nFor any other successful deletion (conditional or not), we return an informational message with the number of resources deleted (and their logical ids)\n\nSigned-off-by: Lee Surprenant lmsurpre@us.ibm.com", "createdAt": "2020-04-22T21:05:08Z", "url": "https://github.com/IBM/FHIR/pull/974", "merged": true, "mergeCommit": {"oid": "ec5117d37576fa33402f72c868d7b84202534c37"}, "closed": true, "closedAt": "2020-04-24T14:18:09Z", "author": {"login": "lmsurpre"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaO1HYAH2gAyNDA3NTQ3NzcxOjFiNTQ1ZTM3ZjNmMDVmNDhkYTZmNzMxNGFjOTRkNWU0YTBiZTJkNjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaxgHAAH2gAyNDA3NTQ3NzcxOmM1NGM1OTlmNDAxZTU1ZmU1NTJmMWIzNjA4NDJhNDQ1NmQ0YzQ4Yzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1b545e37f3f05f48da6f7314ac94d5e4a0be2d61", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/1b545e37f3f05f48da6f7314ac94d5e4a0be2d61", "committedDate": "2020-04-22T21:04:48Z", "message": "issue #930 - ensure status is never null from delete\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Njg2Mzk1", "url": "https://github.com/IBM/FHIR/pull/974#pullrequestreview-398686395", "createdAt": "2020-04-23T00:47:13Z", "commit": {"oid": "1b545e37f3f05f48da6f7314ac94d5e4a0be2d61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa3d36e9d967180c9c90db03907284982564bc33", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/fa3d36e9d967180c9c90db03907284982564bc33", "committedDate": "2020-04-23T19:40:46Z", "message": "issue #930 - normalize delete and conditionalDelete\n\nI found that these two delete options were handled subtely different.\nNow the response status is set properly in FHIRRestHelper.doDelete() and\nthese two variants share a common buildResponse helper.\n\nDeleting a non-existent or previously deleted resource will always\nresult in a 200 with an OperationOutcome that has a WARNING.\n\nDeleting a resource will continue to result in HTTP 204 (No Content).\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "667dce16d791a23649b54e08687e15f7bbbfe233", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/667dce16d791a23649b54e08687e15f7bbbfe233", "committedDate": "2020-04-23T19:08:46Z", "message": "issue #930 - normalize delete and conditionalDelete\n\nI found that these two delete options were handled subtely different.\nNow the response status is set properly in FHIRRestHelper.doDelete() and\nthese two variants share a common buildResponse helper.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "fa3d36e9d967180c9c90db03907284982564bc33", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/fa3d36e9d967180c9c90db03907284982564bc33", "committedDate": "2020-04-23T19:40:46Z", "message": "issue #930 - normalize delete and conditionalDelete\n\nI found that these two delete options were handled subtely different.\nNow the response status is set properly in FHIRRestHelper.doDelete() and\nthese two variants share a common buildResponse helper.\n\nDeleting a non-existent or previously deleted resource will always\nresult in a 200 with an OperationOutcome that has a WARNING.\n\nDeleting a resource will continue to result in HTTP 204 (No Content).\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "committedDate": "2020-04-23T20:23:44Z", "message": "issue #930 - added informational message for all successful deletes\n\nNow all successful delete operations will always result in an HTTP 200\n(OK).  Conditional deletes will return the number of resources deleted\n(and their logical ids) in the OperationOutcome response.\n\nAlso fixed a subtle bug in SearchNearTest.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcec06d5597c4ff3948a7ab1734ec8e8991262de", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/bcec06d5597c4ff3948a7ab1734ec8e8991262de", "committedDate": "2020-04-23T20:02:07Z", "message": "issue #930 - added informational message for all successful deletes\n\nNow all successful delete operations will always result in an HTTP 200\n(OK).  Conditional deletes will return the number of resources deleted\n(and their logical ids) in the OperationOutcome response.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "committedDate": "2020-04-23T20:23:44Z", "message": "issue #930 - added informational message for all successful deletes\n\nNow all successful delete operations will always result in an HTTP 200\n(OK).  Conditional deletes will return the number of resources deleted\n(and their logical ids) in the OperationOutcome response.\n\nAlso fixed a subtle bug in SearchNearTest.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDU3NDkx", "url": "https://github.com/IBM/FHIR/pull/974#pullrequestreview-399457491", "createdAt": "2020-04-23T20:37:50Z", "commit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDozNzo1MFrOGK7F5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDozNzo1MFrOGK7F5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwNzExMQ==", "bodyText": "the changes here are mostly just for style:  by moving the exception cases to the top, i reduced the main code block by two levels of indentation", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414107111", "createdAt": "2020-04-23T20:37:50Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -567,75 +567,77 @@ private ResourceDAO getResourceDao() {\n         try {\n             existingResourceDTO = this.getResourceDao().read(logicalId, resourceType.getSimpleName());\n \n-            if (existingResourceDTO != null) {\n-                if (existingResourceDTO.isDeleted()) {\n-                    existingResource = this.convertResourceDTO(existingResourceDTO, resourceType, null);\n-                    resourceBuilder = existingResource.toBuilder();\n-\n-                    SingleResourceResult<T> result = new SingleResourceResult.Builder<T>()\n-                            .success(true)\n-                            .resource(existingResource)\n-                            .build();\n+            if (existingResourceDTO == null) {\n+                throw new FHIRPersistenceResourceNotFoundException(\"resource does not exist: \" + \n+                        resourceType.getSimpleName() + \":\" + logicalId);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDYyODY5", "url": "https://github.com/IBM/FHIR/pull/974#pullrequestreview-399462869", "createdAt": "2020-04-23T20:45:47Z", "commit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODg4MTQ4", "url": "https://github.com/IBM/FHIR/pull/974#pullrequestreview-399888148", "createdAt": "2020-04-24T12:09:24Z", "commit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMjowOToyNFrOGLUpoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMjowOToyNFrOGLUpoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUyNTg1Nw==", "bodyText": "2 \":\" seems a little bit strange, can we change to\nresourceType.getSimpleName() + \":\" + logicalId\" + \"does not exist.\"\nor use the same style as the other warning info of the following codes.", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414525857", "createdAt": "2020-04-24T12:09:24Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -567,75 +567,77 @@ private ResourceDAO getResourceDao() {\n         try {\n             existingResourceDTO = this.getResourceDao().read(logicalId, resourceType.getSimpleName());\n \n-            if (existingResourceDTO != null) {\n-                if (existingResourceDTO.isDeleted()) {\n-                    existingResource = this.convertResourceDTO(existingResourceDTO, resourceType, null);\n-                    resourceBuilder = existingResource.toBuilder();\n-\n-                    SingleResourceResult<T> result = new SingleResourceResult.Builder<T>()\n-                            .success(true)\n-                            .resource(existingResource)\n-                            .build();\n+            if (existingResourceDTO == null) {\n+                throw new FHIRPersistenceResourceNotFoundException(\"resource does not exist: \" + \n+                        resourceType.getSimpleName() + \":\" + logicalId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODg5NTk3", "url": "https://github.com/IBM/FHIR/pull/974#pullrequestreview-399889597", "createdAt": "2020-04-24T12:11:33Z", "commit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODk5NTUx", "url": "https://github.com/IBM/FHIR/pull/974#pullrequestreview-399899551", "createdAt": "2020-04-24T12:26:32Z", "commit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMjoyNjozMlrOGLVR8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMjoyNjozMlrOGLVR8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzNjE3OA==", "bodyText": "wrong method name", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414536178", "createdAt": "2020-04-24T12:26:32Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -893,8 +902,7 @@ private ResourceDAO getResourceDao() {\n      * @throws IOException\n      */\n     protected List<Resource> buildSortedFhirResources(FHIRPersistenceContext context, Class<? extends Resource> resourceType, List<Long> sortedIdList,\n-                                                      List<String> elements)\n-                            throws FHIRException, FHIRPersistenceException, IOException {\n+            List<String> elements) throws FHIRException, FHIRPersistenceException, IOException {\n         final String METHOD_NAME = \"buildFhirResource\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "originalPosition": 185}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTAxMDY4", "url": "https://github.com/IBM/FHIR/pull/974#pullrequestreview-399901068", "createdAt": "2020-04-24T12:28:43Z", "commit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTQyNTA5", "url": "https://github.com/IBM/FHIR/pull/974#pullrequestreview-399942509", "createdAt": "2020-04-24T13:24:42Z", "commit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzoyNDo0MlrOGLXiZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzoyNDo0MlrOGLXiZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MzE1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    resourceType.getSimpleName() + \":\" + logicalId);\n          \n          \n            \n                                    resourceType.getSimpleName() + \"/\" + logicalId);", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414573159", "createdAt": "2020-04-24T13:24:42Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -567,75 +567,77 @@ private ResourceDAO getResourceDao() {\n         try {\n             existingResourceDTO = this.getResourceDao().read(logicalId, resourceType.getSimpleName());\n \n-            if (existingResourceDTO != null) {\n-                if (existingResourceDTO.isDeleted()) {\n-                    existingResource = this.convertResourceDTO(existingResourceDTO, resourceType, null);\n-                    resourceBuilder = existingResource.toBuilder();\n-\n-                    SingleResourceResult<T> result = new SingleResourceResult.Builder<T>()\n-                            .success(true)\n-                            .resource(existingResource)\n-                            .build();\n+            if (existingResourceDTO == null) {\n+                throw new FHIRPersistenceResourceNotFoundException(\"resource does not exist: \" + \n+                        resourceType.getSimpleName() + \":\" + logicalId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c54c599f401e55fe552f1b360842a4456d4c48c8", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/c54c599f401e55fe552f1b360842a4456d4c48c8", "committedDate": "2020-04-24T13:28:32Z", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 383, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}