{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0OTUwMjU0", "number": 1840, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNDo0MDo0N1rOFK6vXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMzo0NjowOVrOFLSUdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2OTkyNDc4OnYy", "diffSide": "RIGHT", "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNDo0MDo0N1rOIN0Fow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNToyNzozMVrOIN12yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NTgxMQ==", "bodyText": "want to use extension-search-parameters.json instead of extension-search-parameters.xml ?", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551355811", "createdAt": "2021-01-04T14:40:47Z", "author": {"login": "michaelwschroeder"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -125,28 +125,17 @@\n     private static final Sort sort = new Sort();\n \n     /*\n-     * This is our in-memory cache of SearchParameter objects. The cache is\n-     * organized at the top level by tenant-id,\n-     * with the built-in (FHIR spec-defined) SearchParameters stored under the\n-     * \"built-in\" pseudo-tenant-id.\n-     * SearchParameters contained in the default tenant's\n-     * extension-search-parameters.xml file are stored under the\n-     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their\n-     * tenant-specific\n-     * extension-search-parameters.xml files) will be stored under their respective\n-     * tenant-ids as well. The objects\n-     * stored in our cache are of type CachedObjectHolder, with each one containing\n-     * a Map<String, Map<String,\n-     * SearchParameter>>. This map is keyed by resource type (simple name, e.g.\n-     * \"Patient\"). Each object stored in this\n-     * map contains the SearchParameters for that resource type, keyed by\n-     * SearchParameter name (e.g. \"_lastUpdated\").\n-     * When getSearchParameter(resourceType, name) is called, we'll need to first\n-     * search in the current tenant's map,\n-     * then if not found, look in the \"built-in\" tenant's map. Also, when\n-     * getSearchParameters(resourceType) is called,\n-     * we'll need to return a List that contains SearchParameters from the current\n-     * tenant's map (if present) plus those\n+     * This is our in-memory cache of SearchParameter objects. The cache is organized at the top level by tenant-id,\n+     * with the built-in (FHIR spec-defined) SearchParameters stored under the \"built-in\" pseudo-tenant-id.\n+     * SearchParameters contained in the default tenant's extension-search-parameters.xml file are stored under the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM4NDc3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * SearchParameters contained in the default tenant's extension-search-parameters.xml file are stored under the\n          \n          \n            \n                 * SearchParameters contained in the default tenant's extension-search-parameters.json file are stored under the", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551384777", "createdAt": "2021-01-04T15:27:31Z", "author": {"login": "lmsurpre"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -125,28 +125,17 @@\n     private static final Sort sort = new Sort();\n \n     /*\n-     * This is our in-memory cache of SearchParameter objects. The cache is\n-     * organized at the top level by tenant-id,\n-     * with the built-in (FHIR spec-defined) SearchParameters stored under the\n-     * \"built-in\" pseudo-tenant-id.\n-     * SearchParameters contained in the default tenant's\n-     * extension-search-parameters.xml file are stored under the\n-     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their\n-     * tenant-specific\n-     * extension-search-parameters.xml files) will be stored under their respective\n-     * tenant-ids as well. The objects\n-     * stored in our cache are of type CachedObjectHolder, with each one containing\n-     * a Map<String, Map<String,\n-     * SearchParameter>>. This map is keyed by resource type (simple name, e.g.\n-     * \"Patient\"). Each object stored in this\n-     * map contains the SearchParameters for that resource type, keyed by\n-     * SearchParameter name (e.g. \"_lastUpdated\").\n-     * When getSearchParameter(resourceType, name) is called, we'll need to first\n-     * search in the current tenant's map,\n-     * then if not found, look in the \"built-in\" tenant's map. Also, when\n-     * getSearchParameters(resourceType) is called,\n-     * we'll need to return a List that contains SearchParameters from the current\n-     * tenant's map (if present) plus those\n+     * This is our in-memory cache of SearchParameter objects. The cache is organized at the top level by tenant-id,\n+     * with the built-in (FHIR spec-defined) SearchParameters stored under the \"built-in\" pseudo-tenant-id.\n+     * SearchParameters contained in the default tenant's extension-search-parameters.xml file are stored under the", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NTgxMQ=="}, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2OTkyNjQ0OnYy", "diffSide": "RIGHT", "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNDo0MToxN1rOIN0GtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNToyNzo0NFrOIN13UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NjA4NA==", "bodyText": "same as above", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551356084", "createdAt": "2021-01-04T14:41:17Z", "author": {"login": "michaelwschroeder"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -125,28 +125,17 @@\n     private static final Sort sort = new Sort();\n \n     /*\n-     * This is our in-memory cache of SearchParameter objects. The cache is\n-     * organized at the top level by tenant-id,\n-     * with the built-in (FHIR spec-defined) SearchParameters stored under the\n-     * \"built-in\" pseudo-tenant-id.\n-     * SearchParameters contained in the default tenant's\n-     * extension-search-parameters.xml file are stored under the\n-     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their\n-     * tenant-specific\n-     * extension-search-parameters.xml files) will be stored under their respective\n-     * tenant-ids as well. The objects\n-     * stored in our cache are of type CachedObjectHolder, with each one containing\n-     * a Map<String, Map<String,\n-     * SearchParameter>>. This map is keyed by resource type (simple name, e.g.\n-     * \"Patient\"). Each object stored in this\n-     * map contains the SearchParameters for that resource type, keyed by\n-     * SearchParameter name (e.g. \"_lastUpdated\").\n-     * When getSearchParameter(resourceType, name) is called, we'll need to first\n-     * search in the current tenant's map,\n-     * then if not found, look in the \"built-in\" tenant's map. Also, when\n-     * getSearchParameters(resourceType) is called,\n-     * we'll need to return a List that contains SearchParameters from the current\n-     * tenant's map (if present) plus those\n+     * This is our in-memory cache of SearchParameter objects. The cache is organized at the top level by tenant-id,\n+     * with the built-in (FHIR spec-defined) SearchParameters stored under the \"built-in\" pseudo-tenant-id.\n+     * SearchParameters contained in the default tenant's extension-search-parameters.xml file are stored under the\n+     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their tenant-specific\n+     * extension-search-parameters.xml files) will be stored under their respective tenant-ids as well. The objects", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM4NDkxMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * extension-search-parameters.xml files) will be stored under their respective tenant-ids as well. The objects\n          \n          \n            \n                 * extension-search-parameters.json files) will be stored under their respective tenant-ids as well. The objects", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551384912", "createdAt": "2021-01-04T15:27:44Z", "author": {"login": "lmsurpre"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -125,28 +125,17 @@\n     private static final Sort sort = new Sort();\n \n     /*\n-     * This is our in-memory cache of SearchParameter objects. The cache is\n-     * organized at the top level by tenant-id,\n-     * with the built-in (FHIR spec-defined) SearchParameters stored under the\n-     * \"built-in\" pseudo-tenant-id.\n-     * SearchParameters contained in the default tenant's\n-     * extension-search-parameters.xml file are stored under the\n-     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their\n-     * tenant-specific\n-     * extension-search-parameters.xml files) will be stored under their respective\n-     * tenant-ids as well. The objects\n-     * stored in our cache are of type CachedObjectHolder, with each one containing\n-     * a Map<String, Map<String,\n-     * SearchParameter>>. This map is keyed by resource type (simple name, e.g.\n-     * \"Patient\"). Each object stored in this\n-     * map contains the SearchParameters for that resource type, keyed by\n-     * SearchParameter name (e.g. \"_lastUpdated\").\n-     * When getSearchParameter(resourceType, name) is called, we'll need to first\n-     * search in the current tenant's map,\n-     * then if not found, look in the \"built-in\" tenant's map. Also, when\n-     * getSearchParameters(resourceType) is called,\n-     * we'll need to return a List that contains SearchParameters from the current\n-     * tenant's map (if present) plus those\n+     * This is our in-memory cache of SearchParameter objects. The cache is organized at the top level by tenant-id,\n+     * with the built-in (FHIR spec-defined) SearchParameters stored under the \"built-in\" pseudo-tenant-id.\n+     * SearchParameters contained in the default tenant's extension-search-parameters.xml file are stored under the\n+     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their tenant-specific\n+     * extension-search-parameters.xml files) will be stored under their respective tenant-ids as well. The objects", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NjA4NA=="}, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2OTkzNDg0OnYy", "diffSide": "RIGHT", "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNDo0MzozOFrOIN0Lvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNToyODoxOFrOIN14jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NzM3NQ==", "bodyText": "Do you want to use log.fine here, since that's what you're checking against in the line above?", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551357375", "createdAt": "2021-01-04T14:43:38Z", "author": {"login": "michaelwschroeder"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -301,23 +282,27 @@ public static void init() {\n                 if (includedSPs.containsKey(code)) {\n                     String configuredUrl = includedSPs.get(code);\n                     if (configuredUrl != null && configuredUrl.equals(url)) {\n-                        results.add(sp);\n-                    } else {\n+                        results.put(code, sp);\n+                    } else if (log.isLoggable(Level.FINE)) {\n                         log.info(\"Skipping search parameter with id='\" + sp.getId() + \"'. \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM4NTIyOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    log.info(\"Skipping search parameter with id='\" + sp.getId() + \"'. \"\n          \n          \n            \n                                    log.fine(\"Skipping search parameter with id='\" + sp.getId() + \"'. \"", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551385229", "createdAt": "2021-01-04T15:28:18Z", "author": {"login": "lmsurpre"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -301,23 +282,27 @@ public static void init() {\n                 if (includedSPs.containsKey(code)) {\n                     String configuredUrl = includedSPs.get(code);\n                     if (configuredUrl != null && configuredUrl.equals(url)) {\n-                        results.add(sp);\n-                    } else {\n+                        results.put(code, sp);\n+                    } else if (log.isLoggable(Level.FINE)) {\n                         log.info(\"Skipping search parameter with id='\" + sp.getId() + \"'. \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NzM3NQ=="}, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3Mzc4ODA3OnYy", "diffSide": "LEFT", "path": "fhir-search/src/main/java/com/ibm/fhir/search/parameters/ParametersMap.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMzo0NjowOVrOIOXyZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODozNzo0MVrOIOisUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk0MDcxMA==", "bodyText": "Minor. This Set is mutable. Could make this immutable on return. That may have performance implications given how much this stuff gets used. Perhaps use a custom class which is a HashSet and implements an interface with only the getters you need.", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551940710", "createdAt": "2021-01-05T13:46:09Z", "author": {"login": "punktilious"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/parameters/ParametersMap.java", "diffHunk": "@@ -97,12 +71,12 @@ public void insert(String code, SearchParameter parameter) {\n      * @implSpec package-private to prevent insertion from outside the package\n      */\n     public void insertAll(ParametersMap map) {\n-        for (Entry<String, SearchParameter> entry : map.codeMap.entrySet()) {\n-            insert(entry.getKey(), entry.getValue());\n+        for (SearchParameter sp : map.urlMap.values()) {\n+            insert(sp.getCode().getValue(), sp);\n         }\n     }\n \n-    public SearchParameter lookupByCode(String searchParameterCode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk3NjgyMQ==", "bodyText": "Good call.  I think wrapping the set via Collections.immutableSet should be fine.", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551976821", "createdAt": "2021-01-05T14:46:31Z", "author": {"login": "lmsurpre"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/parameters/ParametersMap.java", "diffHunk": "@@ -97,12 +71,12 @@ public void insert(String code, SearchParameter parameter) {\n      * @implSpec package-private to prevent insertion from outside the package\n      */\n     public void insertAll(ParametersMap map) {\n-        for (Entry<String, SearchParameter> entry : map.codeMap.entrySet()) {\n-            insert(entry.getKey(), entry.getValue());\n+        for (SearchParameter sp : map.urlMap.values()) {\n+            insert(sp.getCode().getValue(), sp);\n         }\n     }\n \n-    public SearchParameter lookupByCode(String searchParameterCode) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk0MDcxMA=="}, "originalCommit": {"oid": "80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExOTM3Nw==", "bodyText": "done", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r552119377", "createdAt": "2021-01-05T18:37:41Z", "author": {"login": "lmsurpre"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/parameters/ParametersMap.java", "diffHunk": "@@ -97,12 +71,12 @@ public void insert(String code, SearchParameter parameter) {\n      * @implSpec package-private to prevent insertion from outside the package\n      */\n     public void insertAll(ParametersMap map) {\n-        for (Entry<String, SearchParameter> entry : map.codeMap.entrySet()) {\n-            insert(entry.getKey(), entry.getValue());\n+        for (SearchParameter sp : map.urlMap.values()) {\n+            insert(sp.getCode().getValue(), sp);\n         }\n     }\n \n-    public SearchParameter lookupByCode(String searchParameterCode) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk0MDcxMA=="}, "originalCommit": {"oid": "80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db"}, "originalPosition": 76}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4585, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}