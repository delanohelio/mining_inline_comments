{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNTUwMDEw", "number": 813, "title": "Prepopulate ResourceType Names in Tenant Allocation #811", "bodyText": "Signed-off-by: Paul Bastide pbastide@us.ibm.com", "createdAt": "2020-03-18T16:48:47Z", "url": "https://github.com/IBM/FHIR/pull/813", "merged": true, "mergeCommit": {"oid": "88e383f69ed654cbc6d7d1a1cab96b9111384b5b"}, "closed": true, "closedAt": "2020-03-19T21:36:14Z", "author": {"login": "prb112"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO6LnOAH2gAyMzkwNTUwMDEwOjYxOTU5NDg2M2I4ZDMzYTMxODFmN2NiMTFjZGMwNTE2MmE0YmIxMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPSrJfAFqTM3ODEwMjA4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/619594863b8d33a3181f7cb11cdc05162a4bb139", "committedDate": "2020-03-18T16:48:12Z", "message": "Prepopulate ResourceType Names in Tenant Allocation #811\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTY5NTc0", "url": "https://github.com/IBM/FHIR/pull/813#pullrequestreview-377169574", "createdAt": "2020-03-18T19:25:24Z", "commit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNToyNFrOF4TtPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNToyNFrOF4TtPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzQ1Mg==", "bodyText": "can we use one try here?", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r394587452", "createdAt": "2020-03-18T19:25:24Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -816,6 +817,23 @@ protected void allocateTenant() {\n         // Fill any static data tables (which are also partitioned by tenant)\n         populateStaticTables(gen, tenantKey);\n \n+        // Prepopulate the Resource Type Tables\n+        try (ITransaction tx = TransactionFactory.openTransaction(connectionPool)) {\n+            try {\n+                Connection c = connectionPool.getConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTcwNDM2", "url": "https://github.com/IBM/FHIR/pull/813#pullrequestreview-377170436", "createdAt": "2020-03-18T19:26:43Z", "commit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjo0M1rOF4TwAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjo0M1rOF4TwAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4ODE2MA==", "bodyText": "better to remove the empty lines.", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r394588160", "createdAt": "2020-03-18T19:26:43Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.schema.control;\n+\n+import java.sql.CallableStatement;\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.sql.Types;\n+\n+import com.ibm.fhir.database.utils.api.IDatabaseStatement;\n+import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.model.type.code.FHIRResourceType;\n+\n+/**\n+ * Populates the Resource Types Table\n+ */\n+public class Db2PopulateResourceTypes implements IDatabaseStatement {\n+    private final String adminSchemaName;\n+    private final String schemaName;\n+    private final int tenantId;\n+\n+    public Db2PopulateResourceTypes(String adminSchemaName, String schemaName, int tenantId) {\n+        this.adminSchemaName = adminSchemaName;\n+        this.schemaName      = schemaName;\n+        this.tenantId        = tenantId;\n+    }\n+\n+    @Override\n+    public void run(IDatabaseTranslator translator, Connection c) {\n+        try (Statement s = c.createStatement()) {\n+            s.execute(\"SET \" + adminSchemaName + \".SV_TENANT_ID = \" + tenantId);\n+            // Create tables for each resource type\n+\n+            for (FHIRResourceType.ValueSet rt : FHIRResourceType.ValueSet.values()) {\n+                String resourceType = rt.value();\n+                String callableStr = \"CALL \" + schemaName + \" .add_resource_type(?, ?)\";\n+                try (CallableStatement cStmt = c.prepareCall(callableStr);) {\n+                    cStmt.setString(1, resourceType);\n+                    cStmt.registerOutParameter(2, Types.INTEGER);\n+                    cStmt.execute();\n+                }\n+            }\n+        } catch (SQLException x) {\n+            throw translator.translate(x);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTcxMjc2", "url": "https://github.com/IBM/FHIR/pull/813#pullrequestreview-377171276", "createdAt": "2020-03-18T19:28:02Z", "commit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a966772fc847cecc13a3cb6f2385515955fa59b8", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/a966772fc847cecc13a3cb6f2385515955fa59b8", "committedDate": "2020-03-19T17:28:31Z", "message": "Prepopulate ResourceType Names in Tenant Allocation #811\n\n- The resource_types.properties map is introduces to cache the reserved\nlogical_ids\n- A corresponding correctness test is introduced into the build process\n- Modify the CommonDatabaseAdapter to start at 1000\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dd32fe00baa417838533ce7722f423ce31fc72d", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/9dd32fe00baa417838533ce7722f423ce31fc72d", "committedDate": "2020-03-19T17:31:39Z", "message": "Prepopulate ResourceType Names in Tenant Allocation #811\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTU4MDQ1", "url": "https://github.com/IBM/FHIR/pull/813#pullrequestreview-377958045", "createdAt": "2020-03-19T17:49:44Z", "commit": {"oid": "9dd32fe00baa417838533ce7722f423ce31fc72d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDA2Mzcy", "url": "https://github.com/IBM/FHIR/pull/813#pullrequestreview-378006372", "createdAt": "2020-03-19T18:55:14Z", "commit": {"oid": "9dd32fe00baa417838533ce7722f423ce31fc72d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxODo1NToxNFrOF48LBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxODo1NToxNFrOF48LBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI1MDQzOQ==", "bodyText": "maybe it should be Level.SEVERE and rollback?  Is there a case where we'd see this and want to keep going?", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r395250439", "createdAt": "2020-03-19T18:55:14Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.schema.control;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.logging.Logger;\n+\n+import com.ibm.fhir.database.utils.api.IDatabaseStatement;\n+import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.model.type.code.FHIRResourceType;\n+\n+/**\n+ * Populates the Resource Types Table\n+ */\n+public class Db2PopulateResourceTypes implements IDatabaseStatement {\n+    private static final Logger LOGGER = Logger.getLogger(Db2PopulateResourceTypes.class.getName());\n+    private final String adminSchemaName;\n+    private final String schemaName;\n+    private final int tenantId;\n+\n+    public Db2PopulateResourceTypes(String adminSchemaName, String schemaName, int tenantId) {\n+        this.adminSchemaName = adminSchemaName;\n+        this.schemaName      = schemaName;\n+        this.tenantId        = tenantId;\n+    }\n+\n+    @Override\n+    public void run(IDatabaseTranslator translator, Connection c) {\n+        final String stmtVariable = String.format(\"SET %s.SV_TENANT_ID = %d\", adminSchemaName, tenantId);\n+        final String stmtResourceTypeInsert =\n+                String.format(\n+                        \"INSERT INTO %s.resource_types (mt_id, resource_type_id, resource_type) \" +\n+                                \"VALUES %s.sv_tenant_id, ?, ?);\",\n+                        schemaName, adminSchemaName);\n+        try (Statement s = c.createStatement(); PreparedStatement batch = c.prepareStatement(stmtResourceTypeInsert)) {\n+            s.execute(stmtVariable);\n+            try (InputStream fis =\n+                    Db2PopulateResourceTypes.class.getClassLoader().getResourceAsStream(\"resource_types.properties\")) {\n+                Properties props = new Properties();\n+                props.load(fis);\n+\n+                for (Entry<Object, Object> valueEntry : props.entrySet()) {\n+                    Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n+                    String resource = (String) valueEntry.getKey();\n+                    batch.setString(1, resource);\n+                    batch.setLong(2, curVal);\n+                }\n+\n+                // Check Error Codes. \n+                int[] codes = batch.executeBatch();\n+                int errorCodes = 0;\n+                for (int code : codes) {\n+                    if (code != 0) {\n+                        errorCodes++;\n+                    }\n+                }\n+                if (errorCodes > 0) {\n+                    LOGGER.warning(\"at least one of the Resource Types are not populated [\" + errorCodes + \"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dd32fe00baa417838533ce7722f423ce31fc72d"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa1ffd3603031146ed0d82301589c6e125dc3119", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/fa1ffd3603031146ed0d82301589c6e125dc3119", "committedDate": "2020-03-19T19:12:43Z", "message": "Prepopulate ResourceType Names in Tenant Allocation #811\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MTAyMDg3", "url": "https://github.com/IBM/FHIR/pull/813#pullrequestreview-378102087", "createdAt": "2020-03-19T21:20:22Z", "commit": {"oid": "fa1ffd3603031146ed0d82301589c6e125dc3119"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 533, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}