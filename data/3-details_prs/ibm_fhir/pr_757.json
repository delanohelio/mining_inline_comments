{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzODM1OTE1", "number": 757, "title": "REST layer refactoring/cleanup", "bodyText": "added originalRequestUri to FHIRRequestContext\nset it from FHIRRestServletFilter\nuse it from FHIRResource\nremove unused queryString parm from SearchUtil.parseQueryParameters\n\nSigned-off-by: Lee Surprenant lmsurpre@us.ibm.com", "createdAt": "2020-03-04T19:59:57Z", "url": "https://github.com/IBM/FHIR/pull/757", "merged": true, "mergeCommit": {"oid": "efeb2fd0e5f07d78176a38139615ed35e6e0ce10"}, "closed": true, "closedAt": "2020-03-04T22:23:35Z", "author": {"login": "lmsurpre"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKc1npABqjMwOTgzNjAyNTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKeOExgH2gAyMzgzODM1OTE1OjJkNzlhZTVhNmMxOGM1YTgwY2M1YjM5Mjg3ZTQyMDc4Y2UzNDNjZWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d03b3650eb1dae81593b6564af03ab598c730815", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/d03b3650eb1dae81593b6564af03ab598c730815", "committedDate": "2020-03-04T19:59:02Z", "message": "REST layer refactoring/cleanup\n\n1. added originalRequestUri to FHIRRequestContext\n2. set it from FHIRRestServletFilter\n3. use it from FHIRResource\n4. remove unused `queryString` parm from SearchUtil.parseQueryParameters\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "c874a52af917549e1cafa62cd15c4c004051473b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/c874a52af917549e1cafa62cd15c4c004051473b", "committedDate": "2020-03-04T20:21:04Z", "message": "REST layer refactoring/cleanup\n\n1. added originalRequestUri to FHIRRequestContext\n2. set it from FHIRRestServletFilter\n3. use it from FHIRResource\n4. remove unused `queryString` parm from SearchUtil.parseQueryParameters\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/84f8a1daed1df1ce035f77dc0854ab213daf1d17", "committedDate": "2020-03-04T20:40:25Z", "message": "REST layer refactoring/cleanup\n\n1. added originalRequestUri to FHIRRequestContext\n2. set it from FHIRRestServletFilter\n3. use it from FHIRResource\n4. remove unused `queryString` parm from SearchUtil.parseQueryParameters\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c874a52af917549e1cafa62cd15c4c004051473b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/c874a52af917549e1cafa62cd15c4c004051473b", "committedDate": "2020-03-04T20:21:04Z", "message": "REST layer refactoring/cleanup\n\n1. added originalRequestUri to FHIRRequestContext\n2. set it from FHIRRestServletFilter\n3. use it from FHIRResource\n4. remove unused `queryString` parm from SearchUtil.parseQueryParameters\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/84f8a1daed1df1ce035f77dc0854ab213daf1d17", "committedDate": "2020-03-04T20:40:25Z", "message": "REST layer refactoring/cleanup\n\n1. added originalRequestUri to FHIRRequestContext\n2. set it from FHIRRestServletFilter\n3. use it from FHIRResource\n4. remove unused `queryString` parm from SearchUtil.parseQueryParameters\n\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTMyNzU5", "url": "https://github.com/IBM/FHIR/pull/757#pullrequestreview-369132759", "createdAt": "2020-03-04T21:23:16Z", "commit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyMzoxNlrOFx-H6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyMzoxNlrOFx-H6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MjM3OQ==", "bodyText": "After our earlier discussion, this is only called once? or does it synchronize across multiple requests, I could see this being slow unintentionally.", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387942379", "createdAt": "2020-03-04T21:23:16Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/FHIRResource.java", "diffHunk": "@@ -3560,10 +3561,9 @@ private String serializeOperationOutcome(OperationOutcome oo) {\n         }\n     }\n \n-    private synchronized CapabilityStatement getCapabilityStatement() throws Exception {\n+    private synchronized CapabilityStatement getCapabilityStatement() throws FHIROperationException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTMzMjMx", "url": "https://github.com/IBM/FHIR/pull/757#pullrequestreview-369133231", "createdAt": "2020-03-04T21:23:59Z", "commit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyMzo1OVrOFx-JaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyMzo1OVrOFx-JaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0Mjc2MQ==", "bodyText": "are you actually serializing this class?  best to generate it not use 1l.", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387942761", "createdAt": "2020-03-04T21:23:59Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/filter/rest/FHIRRestServletFilter.java", "diffHunk": "@@ -39,54 +41,54 @@\n /**\n  * This class is a servlet filter which is registered with the REST API's servlet. The main purpose of the class is to\n  * log entry/exit information and elapsed time for each REST API request processed by the server.\n- * \n- * @author padams\n  */\n-public class FHIRRestServletFilter implements Filter {\n+public class FHIRRestServletFilter extends HttpFilter {\n+    private static final long serialVersionUID = 1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTM0MDY3", "url": "https://github.com/IBM/FHIR/pull/757#pullrequestreview-369134067", "createdAt": "2020-03-04T21:25:21Z", "commit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyNToyMVrOFx-L1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyNToyMVrOFx-L1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MzM4MA==", "bodyText": "Totally agree with this change!", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387943380", "createdAt": "2020-03-04T21:25:21Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/filter/rest/FHIRRestServletFilter.java", "diffHunk": "@@ -100,56 +102,33 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n         requestDescription.append(\"] method:[\");\n         requestDescription.append(getRequestMethod(request));\n         requestDescription.append(\"] uri:[\");\n-        requestDescription.append(getRequestURL(request));\n-        final String encodedRequestDescription = Encode.forHtml(requestDescription.toString());\n-\n+        requestDescription.append(requestUrl);\n+        if (!requestUrl.equals(originalRequestUri)) {\n+            requestDescription.append(\"] originalUri:[\");\n+            requestDescription.append(originalRequestUri);\n+        }\n+        requestDescription.append(\"]\");\n+        String encodedRequestDescription = Encode.forHtml(requestDescription.toString());\n         log.info(\"Received request: \" + encodedRequestDescription);\n-        \n+\n         try {\n             // Create a new FHIRRequestContext and set it on the current thread.\n             FHIRRequestContext context = new FHIRRequestContext(tenantId, dsId);\n             FHIRRequestContext.set(context);\n-            \n+\n+            context.setOriginalRequestUri(originalRequestUri);\n+\n             // Set the handling preference.\n-            HTTPHandlingPreference handlingPref = HTTPHandlingPreference.from(FHIRConfigHelper.getStringProperty(FHIRConfiguration.PROPERTY_DEFAULT_HANDLING, \"strict\"));\n-            boolean allowClientHandlingPref = FHIRConfigHelper.getBooleanProperty(FHIRConfiguration.PROPERTY_ALLOW_CLIENT_HANDLING_PREF, true);\n-            if (allowClientHandlingPref) {\n-                String handlingPrefString = ((HttpServletRequest) request).getHeader(preferHeaderName + \":\" + preferHandlingHeaderSectionName);\n-                if (handlingPrefString != null && !handlingPrefString.isEmpty()) {\n-                    try {\n-                        handlingPref = HTTPHandlingPreference.from(handlingPrefString);\n-                    } catch (IllegalArgumentException e) {\n-                        String message = \"Invalid HTTP handling preference passed in header 'Prefer': '\" + handlingPrefString + \"'\";\n-                        if (handlingPref == HTTPHandlingPreference.STRICT) {\n-                            throw new FHIRException(message + \"; use 'strict' or 'lenient'.\");\n-                        } else {\n-                            log.fine(message + \"; using \" + handlingPref.value() + \".\");\n-                        }\n-                    }\n-                }\n-            }\n-            FHIRRequestContext.get().setHandlingPreference(handlingPref);\n+            HTTPHandlingPreference handlingPref = computeHandlingPref(request);\n+            context.setHandlingPreference(handlingPref);\n \n             // Set the return preference.\n-            HTTPReturnPreference returnPref = defaultHttpReturnPref;\n-            String returnPrefString = ((HttpServletRequest) request).getHeader(preferHeaderName + \":\" + preferReturnHeaderSectionName);\n-            if (returnPrefString != null && !returnPrefString.isEmpty()) {\n-                try {\n-                    returnPref = HTTPReturnPreference.from(returnPrefString);\n-                } catch (IllegalArgumentException e) {\n-                    String message = \"Invalid HTTP return preference passed in header 'Prefer': '\" + returnPrefString + \"'\";\n-                    if (handlingPref == HTTPHandlingPreference.STRICT) {\n-                        throw new FHIRException(message + \"; use 'minimal', 'representation' or 'OperationOutcome'.\");\n-                    } else {\n-                        log.fine(message + \"; using \" + returnPref.value() + \".\");\n-                    }\n-                }\n-            }\n-            FHIRRequestContext.get().setReturnPreference(returnPref);\n+            HTTPReturnPreference returnPref = computeReturnPref(request, handlingPref);\n+            context.setReturnPreference(returnPref);\n \n             // Pass the request through to the next filter in the chain.\n             chain.doFilter(request, response);\n-        } catch (FHIRException e) {\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "originalPosition": 188}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTM1ODQy", "url": "https://github.com/IBM/FHIR/pull/757#pullrequestreview-369135842", "createdAt": "2020-03-04T21:28:10Z", "commit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyODoxMFrOFx-RCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyODoxMFrOFx-RCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0NDcxMg==", "bodyText": "I thought Filters were stateless? ... so the reason I mention this...\nif the configuration changes, a server restart needs to be called to re-activate the init filter", "url": "https://github.com/IBM/FHIR/pull/757#discussion_r387944712", "createdAt": "2020-03-04T21:28:10Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/filter/rest/FHIRRestServletFilter.java", "diffHunk": "@@ -39,54 +41,54 @@\n /**\n  * This class is a servlet filter which is registered with the REST API's servlet. The main purpose of the class is to\n  * log entry/exit information and elapsed time for each REST API request processed by the server.\n- * \n- * @author padams\n  */\n-public class FHIRRestServletFilter implements Filter {\n+public class FHIRRestServletFilter extends HttpFilter {\n+    private static final long serialVersionUID = 1L;\n+\n     private static final Logger log = Logger.getLogger(FHIRRestServletFilter.class.getName());\n \n     private static String tenantIdHeaderName = null;\n     private static String datastoreIdHeaderName = null;\n+    private static String originalRequestUriHeaderName = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTM3NDk3", "url": "https://github.com/IBM/FHIR/pull/757#pullrequestreview-369137497", "createdAt": "2020-03-04T21:30:51Z", "commit": {"oid": "84f8a1daed1df1ce035f77dc0854ab213daf1d17"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3d64beb4b27d64800d4c6278cbc432ab0190d5b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/b3d64beb4b27d64800d4c6278cbc432ab0190d5b", "committedDate": "2020-03-04T21:38:32Z", "message": "update userguide to show originalRequestUriHeaderName is not dynamic\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTQ0ODcw", "url": "https://github.com/IBM/FHIR/pull/757#pullrequestreview-369144870", "createdAt": "2020-03-04T21:43:14Z", "commit": {"oid": "b3d64beb4b27d64800d4c6278cbc432ab0190d5b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d79ae5a6c18c5a80cc5b39287e42078ce343cea", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/2d79ae5a6c18c5a80cc5b39287e42078ce343cea", "committedDate": "2020-03-04T21:57:51Z", "message": "Actually use FHIRRequestContext.getOriginalRequestUri\n\nIn the previous commits, I added `originalRequestUri` to the FHIRRequestContext so that we don't need to keep recomputing it.\r\nI meant to also start using that from FHIRResource, but I must have missed that change.\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 481, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}