{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NTY1NDc2", "number": 725, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo1MDozMlrODitWEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNDoxNTowNlrODit6FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NzIxMTA2OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/BulkDataUtils.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo1MDozMlrOFuGv_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1Nzo1OVrOFuTMRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4OTQwNQ==", "bodyText": "Is abort for exception handling logic? if so, why is it in the main try?", "url": "https://github.com/IBM/FHIR/pull/725#discussion_r383889405", "createdAt": "2020-02-25T13:50:32Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/BulkDataUtils.java", "diffHunk": "@@ -157,8 +158,11 @@ public static int readFhirResourceFromObjectStore(AmazonS3 cosClient, String buc\n            int numOfLinesToSkip, List<Resource> fhirResources) {\n         int exported;\n         S3Object item = cosClient.getObject(new GetObjectRequest(bucketName, itemName));\n-        try (BufferedReader resReader = new BufferedReader(new InputStreamReader(item.getObjectContent()))) {\n+        try (S3ObjectInputStream s3InStream = item.getObjectContent();\n+             BufferedReader resReader = new BufferedReader(new InputStreamReader(s3InStream))) {\n             exported = getFhirResourceFromBufferReader(resReader, numOfLinesToSkip, fhirResources);\n+            // Notify s3 client to abort and prevent the server from keeping on sending data.\n+            s3InStream.abort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2beb7ee7af5ac84cdd17cd2dc1e565d316f18"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk3MTI3NA==", "bodyText": "it's not for exception handling logic, if exception happens, the exported will be 0, and the job will be finished with error message in the log, so there will be no issue.   This is for the normal flow of the chunk job, e.g, in first chunk, the job opens the objectstream, read 1000 lines and then abort the stream, and then writes to fhir server, persistence 1000 to checkpoint as the tobeskipped lines, and then in the following second chunk, the job opens the objectstream again, skip 1000 lines first, then read 1000 lines and then abort the stream, and then writes to fhir server, and persistence 2000 to checkpoint as the tobeskipped lines, repeat the above steps till all the lines are processed.      Note: In current implementation,  I didn't provide option to reuse the inputstream/reader across all the chunk operations, because I thought the to-be-imported file can be very huge, and this can cause the connection to be occupied by the import job for too long time which in theory may cause issue for the server if too many concurrent huge files are imported at the same time.  But I did have opened issue #726 to provide option(e.g, controlled by a switch) to reuse the inputstream/reader across all chunk operations if the job is not paused or stopped and continued.", "url": "https://github.com/IBM/FHIR/pull/725#discussion_r383971274", "createdAt": "2020-02-25T15:57:10Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/BulkDataUtils.java", "diffHunk": "@@ -157,8 +158,11 @@ public static int readFhirResourceFromObjectStore(AmazonS3 cosClient, String buc\n            int numOfLinesToSkip, List<Resource> fhirResources) {\n         int exported;\n         S3Object item = cosClient.getObject(new GetObjectRequest(bucketName, itemName));\n-        try (BufferedReader resReader = new BufferedReader(new InputStreamReader(item.getObjectContent()))) {\n+        try (S3ObjectInputStream s3InStream = item.getObjectContent();\n+             BufferedReader resReader = new BufferedReader(new InputStreamReader(s3InStream))) {\n             exported = getFhirResourceFromBufferReader(resReader, numOfLinesToSkip, fhirResources);\n+            // Notify s3 client to abort and prevent the server from keeping on sending data.\n+            s3InStream.abort();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4OTQwNQ=="}, "originalCommit": {"oid": "eaf2beb7ee7af5ac84cdd17cd2dc1e565d316f18"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MzI1NA==", "bodyText": "I get it! this makes sense.", "url": "https://github.com/IBM/FHIR/pull/725#discussion_r384093254", "createdAt": "2020-02-25T19:57:59Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/BulkDataUtils.java", "diffHunk": "@@ -157,8 +158,11 @@ public static int readFhirResourceFromObjectStore(AmazonS3 cosClient, String buc\n            int numOfLinesToSkip, List<Resource> fhirResources) {\n         int exported;\n         S3Object item = cosClient.getObject(new GetObjectRequest(bucketName, itemName));\n-        try (BufferedReader resReader = new BufferedReader(new InputStreamReader(item.getObjectContent()))) {\n+        try (S3ObjectInputStream s3InStream = item.getObjectContent();\n+             BufferedReader resReader = new BufferedReader(new InputStreamReader(s3InStream))) {\n             exported = getFhirResourceFromBufferReader(resReader, numOfLinesToSkip, fhirResources);\n+            // Notify s3 client to abort and prevent the server from keeping on sending data.\n+            s3InStream.abort();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4OTQwNQ=="}, "originalCommit": {"oid": "eaf2beb7ee7af5ac84cdd17cd2dc1e565d316f18"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NzMwMzI0OnYy", "diffSide": "RIGHT", "path": "fhir-parent/pom.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNDoxNTowNlrOFuHoPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNTo1ODo0NVrOFuL0Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwMzgwNg==", "bodyText": "FYI, I looked at the dependency trees:\n+- com.ibm.cos:ibm-cos-java-sdk:jar:2.1.0:compile\n[INFO] |  +- com.ibm.cos:ibm-cos-java-sdk-s3:jar:2.1.0:compile\n[INFO] |  |  +- (com.ibm.cos:ibm-cos-java-sdk-kms:jar:2.1.0:compile - omitted for duplicate)\n[INFO] |  |  - (com.ibm.cos:ibm-cos-java-sdk-core:jar:2.1.0:compile - omitted for duplicate)\n[INFO] |  +- com.ibm.cos:ibm-cos-java-sdk-kms:jar:2.1.0:compile\n[INFO] |  |  - (com.ibm.cos:ibm-cos-java-sdk-core:jar:2.1.0:compile - omitted for duplicate)\n[INFO] |  - com.ibm.cos:ibm-cos-java-sdk-core:jar:2.1.0:compile\n[INFO] |     +- (commons-logging:commons-logging:jar:1.1.3:compile - omitted for conflict with 1.2)\n[INFO] |     +- (org.apache.httpcomponents:httpclient:jar:4.5.6:compile - version managed from 4.5.2; omitted for duplicate)\n[INFO] |     +- software.amazon.ion:ion-java:jar:1.0.2:compile\n[INFO] |     +- com.fasterxml.jackson.core:jackson-databind:jar:2.6.6:compile\n[INFO] |     |  +- com.fasterxml.jackson.core:jackson-annotations:jar:2.6.0:compile\n[INFO] |     |  - com.fasterxml.jackson.core:jackson-core:jar:2.6.6:compile\n[INFO] |     +- com.fasterxml.jackson.dataformat:jackson-dataformat-cbor:jar:2.6.6:compile\n[INFO] |     |  - (com.fasterxml.jackson.core:jackson-core:jar:2.6.6:compile - omitted for duplicate)\n[INFO] |     +- (org.apache.httpcomponents:httpasyncclient:jar:4.1.3:compile - omitted for conflict with 4.1.4)\n[INFO] |     - joda-time:joda-time:jar:2.8.1:compile\n+- com.ibm.cos:ibm-cos-java-sdk:jar:2.6.1:compile\n[INFO] |  +- com.ibm.cos:ibm-cos-java-sdk-s3:jar:2.6.1:compile\n[INFO] |  |  +- (com.ibm.cos:ibm-cos-java-sdk-kms:jar:2.6.1:compile - omitted for duplicate)\n[INFO] |  |  - (com.ibm.cos:ibm-cos-java-sdk-core:jar:2.6.1:compile - omitted for duplicate)\n[INFO] |  +- com.ibm.cos:ibm-cos-java-sdk-kms:jar:2.6.1:compile\n[INFO] |  |  - (com.ibm.cos:ibm-cos-java-sdk-core:jar:2.6.1:compile - omitted for duplicate)\n[INFO] |  - com.ibm.cos:ibm-cos-java-sdk-core:jar:2.6.1:compile\n[INFO] |     +- (commons-logging:commons-logging:jar:1.1.3:compile - omitted for conflict with 1.2)\n[INFO] |     +- (org.apache.httpcomponents:httpclient:jar:4.5.6:compile - version managed from 4.5.9; omitted for duplicate)\n[INFO] |     +- software.amazon.ion:ion-java:jar:1.2.0:compile\n[INFO] |     +- com.fasterxml.jackson.core:jackson-databind:jar:2.10.2:compile\n[INFO] |     |  +- com.fasterxml.jackson.core:jackson-annotations:jar:2.10.2:compile\n[INFO] |     |  - com.fasterxml.jackson.core:jackson-core:jar:2.10.2:compile\n[INFO] |     +- com.fasterxml.jackson.dataformat:jackson-dataformat-cbor:jar:2.10.0:compile\n[INFO] |     |  - (com.fasterxml.jackson.core:jackson-core:jar:2.10.0:compile - omitted for conflict with 2.10.2)\n[INFO] |     - joda-time:joda-time:jar:2.8.2:compile", "url": "https://github.com/IBM/FHIR/pull/725#discussion_r383903806", "createdAt": "2020-02-25T14:15:06Z", "author": {"login": "prb112"}, "path": "fhir-parent/pom.xml", "diffHunk": "@@ -285,7 +285,7 @@\n             <dependency>\n                 <groupId>com.ibm.cos</groupId>\n                 <artifactId>ibm-cos-java-sdk</artifactId>\n-                <version>2.1.0</version>\n+                <version>2.6.1</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2beb7ee7af5ac84cdd17cd2dc1e565d316f18"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNDEzOA==", "bodyText": "reasonably the same and up to date.", "url": "https://github.com/IBM/FHIR/pull/725#discussion_r383904138", "createdAt": "2020-02-25T14:15:40Z", "author": {"login": "prb112"}, "path": "fhir-parent/pom.xml", "diffHunk": "@@ -285,7 +285,7 @@\n             <dependency>\n                 <groupId>com.ibm.cos</groupId>\n                 <artifactId>ibm-cos-java-sdk</artifactId>\n-                <version>2.1.0</version>\n+                <version>2.6.1</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwMzgwNg=="}, "originalCommit": {"oid": "eaf2beb7ee7af5ac84cdd17cd2dc1e565d316f18"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk3MjM5OA==", "bodyText": "thanks for the check!", "url": "https://github.com/IBM/FHIR/pull/725#discussion_r383972398", "createdAt": "2020-02-25T15:58:45Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-parent/pom.xml", "diffHunk": "@@ -285,7 +285,7 @@\n             <dependency>\n                 <groupId>com.ibm.cos</groupId>\n                 <artifactId>ibm-cos-java-sdk</artifactId>\n-                <version>2.1.0</version>\n+                <version>2.6.1</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwMzgwNg=="}, "originalCommit": {"oid": "eaf2beb7ee7af5ac84cdd17cd2dc1e565d316f18"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 267, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}