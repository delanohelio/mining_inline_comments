{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1Nzc0Njk3", "number": 866, "title": "issue #833 - add db2 migration test and fix issues", "bodyText": "Introduced variant of e2e-db2 test for testing migration which:\n\ncreates a db2 instance and deploys the previous version of the schema\nruns migration\nexecutes the e2e tests\n\nThis uncovered a couple different issues with our existing migrations:\n\nDB2 SQL Error: SQLCODE=-2310, SQLSTATE=     , SQLERRMC=-668\nwhile executing runstats after dropping a column\nDB2 SQL Error: SQLCODE=-108, SQLSTATE=42601, SQLERRMC=FK_OBSERVATION_COMPOSITES_DATE\nwhile executing DropForeignKeyConstraint\nDB2 SQL Error: SQLCODE=-204, SQLSTATE=42704, SQLERRMC=FK_OBSERVATION_COMPOSITES_DATE\nwhile executing DropForeignKeyConstraint\n\nFor number 1, the fix was to avoid executing RUNSTATS until after the\ntable with the dropped column has been REORGed.\nFor number 2, the fix was to stop qualifying the constraintName with the\nschema name.\nFor number 3, the fix was to avoid hard-coding Observation in the FK\nnames being dropped.\nSigned-off-by: Lee Surprenant lmsurpre@us.ibm.com", "createdAt": "2020-03-30T16:51:58Z", "url": "https://github.com/IBM/FHIR/pull/866", "merged": true, "mergeCommit": {"oid": "5e5420f2af8a610fc507f925dbd7558f7d3e845d"}, "closed": true, "closedAt": "2020-03-31T19:43:01Z", "author": {"login": "lmsurpre"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSxcNogFqTM4NDA0NzYzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTFxOSABqjMxODQxNTk5NDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDQ3NjM1", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384047635", "createdAt": "2020-03-30T16:52:53Z", "commit": {"oid": "39f864b54e2ee4af55559ddecb04d81f804110f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjo1Mjo1M1rOF9zEkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjo1Mjo1M1rOF9zEkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NDIwOA==", "bodyText": "wasn't sure whether to use the same build.yml or introduce new one for this", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400344208", "createdAt": "2020-03-30T16:52:53Z", "author": {"login": "lmsurpre"}, "path": ".github/workflows/build.yml", "diffHunk": "@@ -266,3 +266,57 @@ jobs:\n       with:\n         name: integration-test-results-db2-${{ matrix.java }}\n         path: integration-test-results\n+db2-migration:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39f864b54e2ee4af55559ddecb04d81f804110f2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDQ4NzQy", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384048742", "createdAt": "2020-03-30T16:54:11Z", "commit": {"oid": "39f864b54e2ee4af55559ddecb04d81f804110f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjo1NDoxMlrOF9zINQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjo1NDoxMlrOF9zINQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NTE0MQ==", "bodyText": "this script is much like pre-integration-test-docker.sh except it calls a modified copy-dependencies script that downloads a previous schema cli jar instead of taking the newly built one from fhir-persistence-schema/target", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400345141", "createdAt": "2020-03-30T16:54:12Z", "author": {"login": "lmsurpre"}, "path": "build/pre-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,103 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39f864b54e2ee4af55559ddecb04d81f804110f2"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDQ5Nzg1", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384049785", "createdAt": "2020-03-30T16:55:26Z", "commit": {"oid": "39f864b54e2ee4af55559ddecb04d81f804110f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjo1NToyNlrOF9zLbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjo1NToyNlrOF9zLbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NTk2NA==", "bodyText": "this will overwrite the \"previous version\" of the schema cli jar with the newly built one", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400345964", "createdAt": "2020-03-30T16:55:26Z", "author": {"login": "lmsurpre"}, "path": "build/pre-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,103 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh\n+./copy-test-operations.sh\n+\n+# Stand up a docker container running the fhir server configured for integration tests\n+echo \"Bringing down any fhir server containers that might already be running as a precaution\"\n+docker-compose kill\n+docker-compose rm -f\n+\n+echo \"Bringing up db2... be patient, this will take a minute\"\n+docker-compose build --pull db2\n+docker-compose up -d db2\n+echo \">>> Current time: \" $(date)\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow db2 & P=$! && sleep 100 && kill $P)\n+\n+\n+echo \"Deploying the Db2 schema...\"\n+./deploySchemaAndTenant.sh\n+\n+echo \"Migrating the schema to the latest version...\"\n+./copy-dependencies-db2.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39f864b54e2ee4af55559ddecb04d81f804110f2"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8e849065b496af41907f306298abbde2a1833da", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/e8e849065b496af41907f306298abbde2a1833da", "committedDate": "2020-03-30T16:57:21Z", "message": "issue #833 - add db2 migration test and fix issues\n\nIntroduced variant of e2e-db2 test for testing migration which:\n1. creates a db2 instance and deploys the previous version of the schema\n2. runs migration\n3. executes the e2e tests\n\nThis uncovered a couple different issues with our existing migrations:\n1. `DB2 SQL Error: SQLCODE=-2310, SQLSTATE=     , SQLERRMC=-668`\n    while executing runstats after dropping a column\n2. `DB2 SQL Error: SQLCODE=-108, SQLSTATE=42601,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n3. `DB2 SQL Error: SQLCODE=-204, SQLSTATE=42704,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n\nFor number 1, the fix was to avoid executing RUNSTATS until after the\ntable with the dropped column has been REORGed.\n\nFor number 2, the fix was to stop qualifying the constraintName with the\nschema name.\n\nFor number 3, the fix was to avoid hard-coding Observation in the FK\nnames being dropped.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39f864b54e2ee4af55559ddecb04d81f804110f2", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/39f864b54e2ee4af55559ddecb04d81f804110f2", "committedDate": "2020-03-30T16:49:57Z", "message": "issue #833 - add db2 migration test and fix issues\n\nIntroduced variant of e2e-db2 test for testing migration which:\n1. creates a db2 instance and deploys the previous version of the schema\n2. runs migration\n3. executes the e2e tests\n\nThis uncovered a couple different issues with our existing migrations:\n1. `DB2 SQL Error: SQLCODE=-2310, SQLSTATE=     , SQLERRMC=-668`\n    while executing runstats after dropping a column\n2. `DB2 SQL Error: SQLCODE=-108, SQLSTATE=42601,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n3. `DB2 SQL Error: SQLCODE=-204, SQLSTATE=42704,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n\nFor number 1, the fix was to avoid executing RUNSTATS until after the\ntable with the dropped column has been REORGed.\n\nFor number 2, the fix was to stop qualifying the constraintName with the\nschema name.\n\nFor number 3, the fix was to avoid hard-coding Observation in the FK\nnames being dropped.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "e8e849065b496af41907f306298abbde2a1833da", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/e8e849065b496af41907f306298abbde2a1833da", "committedDate": "2020-03-30T16:57:21Z", "message": "issue #833 - add db2 migration test and fix issues\n\nIntroduced variant of e2e-db2 test for testing migration which:\n1. creates a db2 instance and deploys the previous version of the schema\n2. runs migration\n3. executes the e2e tests\n\nThis uncovered a couple different issues with our existing migrations:\n1. `DB2 SQL Error: SQLCODE=-2310, SQLSTATE=     , SQLERRMC=-668`\n    while executing runstats after dropping a column\n2. `DB2 SQL Error: SQLCODE=-108, SQLSTATE=42601,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n3. `DB2 SQL Error: SQLCODE=-204, SQLSTATE=42704,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n\nFor number 1, the fix was to avoid executing RUNSTATS until after the\ntable with the dropped column has been REORGed.\n\nFor number 2, the fix was to stop qualifying the constraintName with the\nschema name.\n\nFor number 3, the fix was to avoid hard-coding Observation in the FK\nnames being dropped.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb5c9b32e9f9c49a45733cd4dd5a917e218b1dec", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/cb5c9b32e9f9c49a45733cd4dd5a917e218b1dec", "committedDate": "2020-03-30T18:13:46Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "268f41b7af57b00dc9c327aad16ad8196ac9c836", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/268f41b7af57b00dc9c327aad16ad8196ac9c836", "committedDate": "2020-03-30T18:43:56Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "268f41b7af57b00dc9c327aad16ad8196ac9c836", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/268f41b7af57b00dc9c327aad16ad8196ac9c836", "committedDate": "2020-03-30T18:43:56Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "b44502e9b636086e35ed7fc7660f194920e5248a", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/b44502e9b636086e35ed7fc7660f194920e5248a", "committedDate": "2020-03-30T19:21:09Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b44502e9b636086e35ed7fc7660f194920e5248a", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/b44502e9b636086e35ed7fc7660f194920e5248a", "committedDate": "2020-03-30T19:21:09Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "d17578614003258e00c531bf3b9aa86552d5451b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/d17578614003258e00c531bf3b9aa86552d5451b", "committedDate": "2020-03-30T19:29:04Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "932c8360c57147dcb6680fc9ed7ba2b48cdeecab", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/932c8360c57147dcb6680fc9ed7ba2b48cdeecab", "committedDate": "2020-03-30T20:04:17Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml, switched to\njdk8 to improve speed, and renamed the logs to avoid conflict with\n`e2e-db2` results\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d17578614003258e00c531bf3b9aa86552d5451b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/d17578614003258e00c531bf3b9aa86552d5451b", "committedDate": "2020-03-30T19:29:04Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "932c8360c57147dcb6680fc9ed7ba2b48cdeecab", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/932c8360c57147dcb6680fc9ed7ba2b48cdeecab", "committedDate": "2020-03-30T20:04:17Z", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml, switched to\njdk8 to improve speed, and renamed the logs to avoid conflict with\n`e2e-db2` results\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03bb893fc4acedeb3b1d89ccb469133de9a0261b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/03bb893fc4acedeb3b1d89ccb469133de9a0261b", "committedDate": "2020-03-30T20:34:53Z", "message": "Set reduced poolsize from deploySchemaAndTenant.sh\n\nIn PR #841 we reduced the default to 1 in order to avoid issue #845\nbut the db2-migration-test is pulling down an older version with a\npool-size of 80 and so we were hitting intermittent deadlocks.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b7df06fe281d937d298e75c74b556080df74f8d", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/6b7df06fe281d937d298e75c74b556080df74f8d", "committedDate": "2020-03-30T20:24:15Z", "message": "Set reduced poolsize from deploySchemaAndTenant.sh\n\nIn PR #841 we reduced the default to 1 in order to avoid issue #845\nbut the db2-migration-test is pulling down an older version with a\npool-size of 80 and so we were hitting intermittent deadlocks.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "03bb893fc4acedeb3b1d89ccb469133de9a0261b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/03bb893fc4acedeb3b1d89ccb469133de9a0261b", "committedDate": "2020-03-30T20:34:53Z", "message": "Set reduced poolsize from deploySchemaAndTenant.sh\n\nIn PR #841 we reduced the default to 1 in order to avoid issue #845\nbut the db2-migration-test is pulling down an older version with a\npool-size of 80 and so we were hitting intermittent deadlocks.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/66cd850024d41b3aa39549f2251a9399f93af902", "committedDate": "2020-03-30T22:23:00Z", "message": "Update permission after updating tables\n\nWithout this, db2 was failing on updates and deletes with errors like:\n> DB2 SQL Error: SQLCODE=-5188, SQLSTATE=560D0,\n> SQLERRMC=FHIRDATA.MEDICATION_NUMBER_VALUES_TENANT;PERMISSION`\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzI2MDQy", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384326042", "createdAt": "2020-03-31T00:34:36Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDozNDozNlrOF-BJEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDozNDozNlrOF-BJEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NDczOQ==", "bodyText": "Is the purpose of this change to make it possible to run grant access multiple times for the same tenant?", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400574739", "createdAt": "2020-03-31T00:34:36Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/api/IDatabaseAdapter.java", "diffHunk": "@@ -185,7 +185,7 @@ public void createIndex(String schemaName, String tableName, String indexName, S\n      * @param tableName\n      * @param predicate\n      */\n-    public void createPermission(String schemaName, String permissionName, String tableName, String predicate);\n+    public void createOrReplacePermission(String schemaName, String permissionName, String tableName, String predicate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzI3NTg5", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384327589", "createdAt": "2020-03-31T00:39:10Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDozOToxMFrOF-BOAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDozOToxMFrOF-BOAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NjAwMw==", "bodyText": "are you going to make db2 migration test part of the pipeline? seems it's only needed if there is any new db schema version available ...  and are you going to cover the migration path from all the previous versions to the current version ...", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400576003", "createdAt": "2020-03-31T00:39:10Z", "author": {"login": "albertwang-ibm"}, "path": ".github/workflows/build.yml", "diffHunk": "@@ -266,3 +266,56 @@ jobs:\n       with:\n         name: integration-test-results-db2-${{ matrix.java }}\n         path: integration-test-results\n+  db2-migration:\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        java: [ 'openjdk8' ]\n+      fail-fast: false\n+    steps:\n+    - uses: actions/checkout@v2\n+    - name: Set up OpenJDK\n+      uses: joschi/setup-jdk@v1\n+      with:\n+        java-version: ${{ matrix.java }}\n+    - name: Build samples\n+      run: mvn -B install --file fhir-examples --no-transfer-progress\n+    - name: Build parent without tests\n+      run: |\n+        mvn -B install --file fhir-parent -DskipTests -P integration --no-transfer-progress\n+    - name: Server Integration Tests\n+      env:\n+        # debian-based linux uses C.UTF-8 by default and Derby doesn't like that\n+        LC_ALL: en_US.UTF-8\n+      run: |\n+        export WORKSPACE=${GITHUB_WORKSPACE}\n+        build/db2-migration-test-docker.sh\n+        mvn -B test -DskipTests=false -f fhir-server-test -DskipWebSocketTest=true --no-transfer-progress\n+        build/post-integration-test-docker.sh\n+    - name: Gather error logs\n+      if: failure()\n+      run: |\n+        it_results=integration-test-results\n+        rm -fr ${it_results} 2>/dev/null\n+        mkdir -p ${it_results}/server-logs\n+        mkdir -p ${it_results}/fhir-server-test\n+        containerId=$(docker ps -a | grep fhir | cut -d ' ' -f 1)\n+        if [[ -z \"${containerId}\" ]]; then\n+            echo \"Warning: Could not find fhir container!!!\"\n+        else\n+            echo \"fhir container id: $containerId\"\n+\n+            # Grab the container's console log\n+            docker logs $containerId  >& ${it_results}/docker-console.txt\n+\n+            echo \"Gathering post-test server logs from docker container: $containerId\"\n+            docker cp -L $containerId:/logs ${it_results}/server-logs\n+        fi\n+        echo \"Gathering integration test output\"\n+        cp -pr ${GITHUB_WORKSPACE}/fhir-server-test/target/surefire-reports/* ${it_results}/fhir-server-test\n+    - name: Upload logs\n+      if: always()\n+      uses: actions/upload-artifact@master\n+      with:\n+        name: db2-migration-test-results-${{ matrix.java }}\n+        path: integration-test-results", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzI5MTM4", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384329138", "createdAt": "2020-03-31T00:44:00Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NDowMFrOF-BTcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NDowMFrOF-BTcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NzM5NQ==", "bodyText": "which version of the schema is used here? version 1?", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400577395", "createdAt": "2020-03-31T00:44:00Z", "author": {"login": "albertwang-ibm"}, "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh\n+\n+# Stand up a docker container running the fhir server configured for integration tests\n+echo \"Bringing down any fhir server containers that might already be running as a precaution\"\n+docker-compose kill\n+docker-compose rm -f\n+\n+echo \"Bringing up db2... be patient, this will take a minute\"\n+docker-compose build --pull db2\n+docker-compose up -d db2\n+echo \">>> Current time: \" $(date)\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow db2 & P=$! && sleep 100 && kill $P)\n+\n+echo \"Deploying the Db2 schema...\"\n+./deploySchemaAndTenant.sh\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzI5NTYy", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384329562", "createdAt": "2020-03-31T00:45:15Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NToxNVrOF-BU5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NToxNVrOF-BU5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3Nzc2Ng==", "bodyText": "can this script can always (and only) upgrade version 1 to the latest version?", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400577766", "createdAt": "2020-03-31T00:45:15Z", "author": {"login": "albertwang-ibm"}, "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh\n+\n+# Stand up a docker container running the fhir server configured for integration tests\n+echo \"Bringing down any fhir server containers that might already be running as a precaution\"\n+docker-compose kill\n+docker-compose rm -f\n+\n+echo \"Bringing up db2... be patient, this will take a minute\"\n+docker-compose build --pull db2\n+docker-compose up -d db2\n+echo \">>> Current time: \" $(date)\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow db2 & P=$! && sleep 100 && kill $P)\n+\n+echo \"Deploying the Db2 schema...\"\n+./deploySchemaAndTenant.sh\n+\n+\n+echo \"Bringing up the FHIR server... be patient, this will take a minute\"\n+./copy-test-operations.sh\n+docker-compose build --pull fhir\n+docker-compose up -d fhir\n+echo \">>> Current time: \" $(date)\n+\n+echo \"Migrating the schema to the latest version...\"\n+./copy-dependencies-db2.sh\n+./updateSchema.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzQyNTIy", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384342522", "createdAt": "2020-03-31T01:26:09Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMToyNjowOVrOF-CBCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMToyNjowOVrOF-CBCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU4OTA2Nw==", "bodyText": "great catch! seems we have never noticed this before!!", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400589067", "createdAt": "2020-03-31T01:26:09Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/FhirResourceTableGroup.java", "diffHunk": "@@ -679,12 +679,12 @@ public void addComposites(List<IDatabaseObject> group, String prefix) {\n                 }\n \n                 statements.add(new DropForeignKeyConstraint(schemaName, tableName,\n-                        \"FK_OBSERVATION_COMPOSITES_DATE\",\n-                        \"FK_OBSERVATION_COMPOSITES_LATLNG\",\n-                        \"FK_OBSERVATION_COMPOSITES_NUMBER\",\n-                        \"FK_OBSERVATION_COMPOSITES_QUANTITY\",\n-                        \"FK_OBSERVATION_COMPOSITES_STR\",\n-                        \"FK_OBSERVATION_COMPOSITES_TOKEN\"));\n+                        FK + tableName + _STR,\n+                        FK + tableName + _NUMBER,\n+                        FK + tableName + _DATE,\n+                        FK + tableName + _TOKEN,\n+                        FK + tableName + _QUANTITY,\n+                        FK + tableName + _LATLNG));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzQ0MzUz", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384344353", "createdAt": "2020-03-31T01:31:26Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTozMToyNlrOF-CHeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTozMToyNlrOF-CHeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MDcxMw==", "bodyText": "make a lot sense, as I remember, most of the alter table operations requires reorg before the table is really usable ... otherwise it will always show reorg pending error for sql ...", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400590713", "createdAt": "2020-03-31T01:31:26Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/db2/Db2Adapter.java", "diffHunk": "@@ -456,12 +456,10 @@ public void runStatement(IDatabaseStatement stmt) {\n \n             String qname = ((DropColumn) stmt).getSchemaName() + \".\" + ((DropColumn) stmt).getTableName();\n \n-            Db2AdminCommand runstats = new Db2AdminCommand(\"RUNSTATS ON TABLE \" + qname + \" WITH DISTRIBUTION AND DETAILED INDEXES ALL\");\n-            super.runStatement(runstats);\n-\n             String reorgCommand = \"REORG TABLE \" + qname;\n             super.runStatement(new Db2AdminCommand(reorgCommand));\n \n+            Db2AdminCommand runstats = new Db2AdminCommand(\"RUNSTATS ON TABLE \" + qname + \" WITH DISTRIBUTION AND DETAILED INDEXES ALL\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzQ1NDY3", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384345467", "createdAt": "2020-03-31T01:34:51Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTozNDo1MVrOF-CLhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTozNDo1MVrOF-CLhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MTc0OA==", "bodyText": "this does remember me of one question, should we force all db connections to drop first before we run reorg during migration?", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400591748", "createdAt": "2020-03-31T01:34:51Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/db2/Db2Reorg.java", "diffHunk": "@@ -16,6 +16,10 @@\n \n /**\n  * Reorg the schema.table\n+ *\n+ * Be sure to complete all database operations and release all locks before you invoke REORG.\n+ * @see <a href=\"https://www.ibm.com/support/knowledgecenter/SSEPGG_11.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0001966.html\">\n+ *      https://www.ibm.com/support/knowledgecenter/SSEPGG_11.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0001966.html</a>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjA2NTEy", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384606512", "createdAt": "2020-03-31T10:36:35Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDozNjozNVrOF-Pjcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDozNjozNVrOF-Pjcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMDg2Nw==", "bodyText": "I wonder if this is necessary in Db2. No fix necessary... just an outloud discussion.", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400810867", "createdAt": "2020-03-31T10:36:35Z", "author": {"login": "prb112"}, "path": ".github/workflows/build.yml", "diffHunk": "@@ -266,3 +266,56 @@ jobs:\n       with:\n         name: integration-test-results-db2-${{ matrix.java }}\n         path: integration-test-results\n+  db2-migration:\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        java: [ 'openjdk8' ]\n+      fail-fast: false\n+    steps:\n+    - uses: actions/checkout@v2\n+    - name: Set up OpenJDK\n+      uses: joschi/setup-jdk@v1\n+      with:\n+        java-version: ${{ matrix.java }}\n+    - name: Build samples\n+      run: mvn -B install --file fhir-examples --no-transfer-progress\n+    - name: Build parent without tests\n+      run: |\n+        mvn -B install --file fhir-parent -DskipTests -P integration --no-transfer-progress\n+    - name: Server Integration Tests\n+      env:\n+        # debian-based linux uses C.UTF-8 by default and Derby doesn't like that\n+        LC_ALL: en_US.UTF-8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjA3NTYz", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384607563", "createdAt": "2020-03-31T10:38:07Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDozODowN1rOF-PnBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDozODowN1rOF-PnBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMTc4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # (C) Copyright IBM Corp. 2016, 2020\n          \n          \n            \n            # (C) Copyright IBM Corp. 2020\n          \n      \n    \n    \n  \n\nisn't this just 2020", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400811782", "createdAt": "2020-03-31T10:38:07Z", "author": {"login": "prb112"}, "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjA4MTQ1", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384608145", "createdAt": "2020-03-31T10:39:03Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDozOTowM1rOF-Po8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDozOTowM1rOF-Po8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMjI3NA==", "bodyText": "you could probably map this in env to be consistent with the prior step", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400812274", "createdAt": "2020-03-31T10:39:03Z", "author": {"login": "prb112"}, "path": ".github/workflows/build.yml", "diffHunk": "@@ -266,3 +266,56 @@ jobs:\n       with:\n         name: integration-test-results-db2-${{ matrix.java }}\n         path: integration-test-results\n+  db2-migration:\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        java: [ 'openjdk8' ]\n+      fail-fast: false\n+    steps:\n+    - uses: actions/checkout@v2\n+    - name: Set up OpenJDK\n+      uses: joschi/setup-jdk@v1\n+      with:\n+        java-version: ${{ matrix.java }}\n+    - name: Build samples\n+      run: mvn -B install --file fhir-examples --no-transfer-progress\n+    - name: Build parent without tests\n+      run: |\n+        mvn -B install --file fhir-parent -DskipTests -P integration --no-transfer-progress\n+    - name: Server Integration Tests\n+      env:\n+        # debian-based linux uses C.UTF-8 by default and Derby doesn't like that\n+        LC_ALL: en_US.UTF-8\n+      run: |\n+        export WORKSPACE=${GITHUB_WORKSPACE}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjEwMjQ2", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384610246", "createdAt": "2020-03-31T10:42:15Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0MjoxNVrOF-PvPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0MjoxNVrOF-PvPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMzg4NA==", "bodyText": "these lines are duplicate of other scripts. perhaps refactoring into an imported script is best?", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400813884", "createdAt": "2020-03-31T10:42:15Z", "author": {"login": "prb112"}, "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh\n+\n+# Stand up a docker container running the fhir server configured for integration tests\n+echo \"Bringing down any fhir server containers that might already be running as a precaution\"\n+docker-compose kill\n+docker-compose rm -f\n+\n+echo \"Bringing up db2... be patient, this will take a minute\"\n+docker-compose build --pull db2\n+docker-compose up -d db2\n+echo \">>> Current time: \" $(date)\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow db2 & P=$! && sleep 100 && kill $P)\n+\n+echo \"Deploying the Db2 schema...\"\n+./deploySchemaAndTenant.sh\n+\n+\n+echo \"Bringing up the FHIR server... be patient, this will take a minute\"\n+./copy-test-operations.sh\n+docker-compose build --pull fhir\n+docker-compose up -d fhir\n+echo \">>> Current time: \" $(date)\n+\n+echo \"Migrating the schema to the latest version...\"\n+./copy-dependencies-db2.sh\n+./updateSchema.sh\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow fhir & P=$! && sleep 60 && kill $P)\n+\n+# Gather up all the server logs so we can trouble-shoot any problems during startup\n+cd -\n+pre_it_logs=${WORKSPACE}/pre-it-logs\n+zip_file=${WORKSPACE}/pre-it-logs.zip\n+rm -fr ${pre_it_logs} 2>/dev/null\n+mkdir -p ${pre_it_logs}\n+rm -f ${zip_file}\n+\n+echo \"\n+Docker container status:\"\n+docker ps -a\n+\n+containerId=$(docker ps -a | grep fhir | cut -d ' ' -f 1)\n+if [[ -z \"${containerId}\" ]]; then\n+    echo \"Warning: Could not find the fhir container!!!\"\n+else\n+    echo \"fhir container id: $containerId\"\n+\n+    # Grab the container's console log\n+    docker logs $containerId  >& ${pre_it_logs}/docker-console.txt\n+\n+    echo \"Gathering pre-test server logs from docker container: $containerId\"\n+    docker cp -L $containerId:/opt/ol/wlp/usr/servers/fhir-server/logs ${pre_it_logs}\n+\n+    echo \"Zipping up pre-test server logs\"\n+    zip -r ${zip_file} ${pre_it_logs}\n+fi\n+\n+# Wait until the fhir server is up and running...\n+echo \"Waiting for fhir-server to complete initialization...\"\n+healthcheck_url='https://localhost:9443/fhir-server/api/v4/$healthcheck'\n+tries=0\n+status=0\n+while [ $status -ne 200 -a $tries -lt 3 ]; do\n+    tries=$((tries + 1))\n+    cmd=\"curl -k -o ${WORKSPACE}/health.json -I -w \"%{http_code}\" -u fhiruser:change-password $healthcheck_url\"\n+    echo \"Executing[$tries]: $cmd\"\n+    status=$($cmd)\n+    echo \"Status code: $status\"\n+    if [ $status -ne 200 ]\n+    then\n+       echo \"Sleeping 10 secs...\"\n+       sleep 10\n+    fi\n+done\n+\n+if [ $status -ne 200 ]\n+then\n+    echo \"Could not establish a connection to the fhir-server within $tries REST API invocations!\"\n+    exit 1\n+fi\n+\n+echo \"The fhir-server appears to be running...\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjExNzM3", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384611737", "createdAt": "2020-03-31T10:44:33Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0NDozM1rOF-Pzzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0NDozM1rOF-Pzzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNTA1NA==", "bodyText": "2020", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400815054", "createdAt": "2020-03-31T10:44:33Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/db2/Db2Adapter.java", "diffHunk": "@@ -105,15 +105,15 @@ public void createIntVariable(String schemaName, String variableName) {\n     }\n \n     @Override\n-    public void createPermission(String schemaName, String permissionName, String tableName, String predicate) {\n+    public void createOrReplacePermission(String schemaName, String permissionName, String tableName, String predicate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjEzMDY4", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384613068", "createdAt": "2020-03-31T10:46:40Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0Njo0MVrOF-P4Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0Njo0MVrOF-P4Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjE0Nw==", "bodyText": "Interesting... it's left aligned in the output.\nCREATE PERMISSION FHIRAPP.STR_VALUES_TENANT                      ON FHIRAPP.STR_VALUES          FOR ROWS WHERE FHIRAPP.STR_VALUES.MT_ID = FHIR_ADMIN.SV_TENANT_ID ENFORCED FOR ALL ACCESS ENABLE ;", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400816147", "createdAt": "2020-03-31T10:46:41Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/db2/Db2Adapter.java", "diffHunk": "@@ -105,15 +105,15 @@ public void createIntVariable(String schemaName, String variableName) {\n     }\n \n     @Override\n-    public void createPermission(String schemaName, String permissionName, String tableName, String predicate) {\n+    public void createOrReplacePermission(String schemaName, String permissionName, String tableName, String predicate) {\n         final String qualifiedPermissionName = DataDefinitionUtil.getQualifiedName(schemaName, permissionName);\n         final String qualifiedTableName = DataDefinitionUtil.getQualifiedName(schemaName, tableName);\n         DataDefinitionUtil.assertSecure(predicate);\n \n         final String ddl = \"\"\n-                + \"       CREATE PERMISSION \" + qualifiedPermissionName\n-                + \"                      ON \" + qualifiedTableName\n-                + \"          FOR ROWS WHERE \" + predicate\n+                + \"CREATE OR REPLACE PERMISSION \" + qualifiedPermissionName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjE1MDc2", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384615076", "createdAt": "2020-03-31T10:49:43Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0OTo0NFrOF-P-OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0OTo0NFrOF-P-OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNzcyMQ==", "bodyText": "I think the prior line 45 was good defensive programming\nit asserts if the passed schemaName and constraintName are valid", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400817721", "createdAt": "2020-03-31T10:49:44Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/common/DropForeignKeyConstraint.java", "diffHunk": "@@ -42,8 +42,7 @@ public void run(IDatabaseTranslator translator, Connection c) {\n \n         for (String constraintName : constraintNames) {\n             StringBuilder ddl = new StringBuilder(\"ALTER TABLE \" + qTableName);\n-            String qConstraintName = DataDefinitionUtil.getQualifiedName(schemaName, constraintName);\n-            ddl.append(\"\\n\\t\" + \"DROP FOREIGN KEY \" + qConstraintName);\n+            ddl.append(\"\\n\\t\" + \"DROP FOREIGN KEY \" + constraintName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjE5NjAy", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384619602", "createdAt": "2020-03-31T10:56:33Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1NjozM1rOF-QMVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1NjozM1rOF-QMVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMTMzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # (C) Copyright IBM Corp. 2016, 2020\n          \n          \n            \n            # (C) Copyright IBM Corp. 2020\n          \n      \n    \n    \n  \n\n2020", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400821335", "createdAt": "2020-03-31T10:56:33Z", "author": {"login": "prb112"}, "path": "fhir-install/docker/copy-dependencies-db2-migration.sh", "diffHunk": "@@ -0,0 +1,33 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjE5ODI4", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384619828", "createdAt": "2020-03-31T10:56:52Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1Njo1MlrOF-QNJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1Njo1MlrOF-QNJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMTU0Mg==", "bodyText": "We should document this needs to be updated in DB2SchemaMigration.md", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400821542", "createdAt": "2020-03-31T10:56:52Z", "author": {"login": "prb112"}, "path": "fhir-install/docker/copy-dependencies-db2-migration.sh", "diffHunk": "@@ -0,0 +1,33 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+SCHEMA_VERSION=\"4.0.1\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjIwNjUw", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384620650", "createdAt": "2020-03-31T10:58:04Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1ODowNFrOF-QPtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1ODowNFrOF-QPtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMjE5OA==", "bodyText": "Any specific reasons other than whitespace for this update?", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400822198", "createdAt": "2020-03-31T10:58:04Z", "author": {"login": "prb112"}, "path": "fhir-notification-kafka/src/main/java/com/ibm/fhir/notifications/kafka/impl/FHIRNotificationKafkaPublisher.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * (C) Copyright IBM Corp. 2016,2019\n+ * (C) Copyright IBM Corp. 2016, 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjIwODcy", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384620872", "createdAt": "2020-03-31T10:58:22Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1ODoyM1rOF-QQtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1ODoyM1rOF-QQtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMjQ1NQ==", "bodyText": "Whitespace?", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400822455", "createdAt": "2020-03-31T10:58:23Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/search/test/JDBCSearchCompositeTest.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * (C) Copyright IBM Corp. 2018,2019\n+ * (C) Copyright IBM Corp. 2018, 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjIyMjY2", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384622266", "createdAt": "2020-03-31T11:00:21Z", "commit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTowMDoyMVrOF-QU-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTowMDoyMVrOF-QU-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMzU0Nw==", "bodyText": "let's document this file in Db2SchemaMigrations.md", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400823547", "createdAt": "2020-03-31T11:00:21Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/deployPriorVersions.sh", "diffHunk": "@@ -9,8 +9,9 @@ set -e\n \n # Version 4.0.1 of the fhir-persistence-schema cli doesn't support derby, but starting with 4.1.0 we should do something like this:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66cd850024d41b3aa39549f2251a9399f93af902"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb4258c42c95411c8250e6ce41b9720c645d16c7", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/fb4258c42c95411c8250e6ce41b9720c645d16c7", "committedDate": "2020-03-31T14:20:56Z", "message": "Updates per PR feedback\n\nAdded \"Testing migrations\" section to DB2SchemaMigration.md\n\nModified ddl formatting, removed unnecessary env var in ci jobs, and\nfixed more copyrights\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "481d84a724b85d58482cde2df9facb60a4000464", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/481d84a724b85d58482cde2df9facb60a4000464", "committedDate": "2020-03-31T13:55:53Z", "message": "Updates per PR feedback\n\nAdded \"Testing migrations\" section to DB2SchemaMigration.md\n\nModified ddl formatting and fixed more copyrights\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "fb4258c42c95411c8250e6ce41b9720c645d16c7", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/fb4258c42c95411c8250e6ce41b9720c645d16c7", "committedDate": "2020-03-31T14:20:56Z", "message": "Updates per PR feedback\n\nAdded \"Testing migrations\" section to DB2SchemaMigration.md\n\nModified ddl formatting, removed unnecessary env var in ci jobs, and\nfixed more copyrights\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Nzk0MzM2", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384794336", "createdAt": "2020-03-31T14:32:28Z", "commit": {"oid": "fb4258c42c95411c8250e6ce41b9720c645d16c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTAzMTY4", "url": "https://github.com/IBM/FHIR/pull/866#pullrequestreview-384903168", "createdAt": "2020-03-31T16:27:03Z", "commit": {"oid": "ab45099b35d8175d0a367bfc089f9b8b00a56fec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjoyNzowM1rOF-eFSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjoyNzowM1rOF-eFSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0ODkwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When the schema is applied for the first time, it creates the table (and related constructs) as according to the definition.\n          \n          \n            \n            When the schema is applied to an existing database, the framework will check the `FHIR_ADMIN.VERSION_HISTORY` table and, \n          \n          \n            \n            if the version in the table is less than the version being applied, the framework will invoke the Migrations *instead*\n          \n          \n            \n            of calling CREATE with the table definition. Care should be taken to ensure that the migrated schema will match a freshly applied schema.\n          \n          \n            \n            See [Testing migrations](#testing-migrations) for information on verifying the fidelity of the schema migrations.\n          \n          \n            \n            \n          \n          \n            \n            NOTE: In Db2, certain alter table statements require a table REORG before the table becomes usable again. Additionally, the REORG\n          \n          \n            \n            may commit the current \"unit of work\" which can prevent the \"all or nothing\" semantics of the migration. For these reasons, its recommended\n          \n          \n            \n            to backup the database before invoking a migration and performing the migration off-line.\n          \n          \n            \n            \n          \n          \n            \n            In this way, if a new resource is added to the specification, the schema utility will automatically provision the corresponding table on the next execution of the fhir-persistence-schema `--update-schema` action. \n          \n          \n            \n            When the schema is applied for the first time, it creates the table (and related constructs) as according to the definition.\n          \n          \n            \n            When the schema is applied to an existing database, the framework checks the `FHIR_ADMIN.VERSION_HISTORY` table and, \n          \n          \n            \n            if the version in the table is less than the version being applied, the framework invokes the Migrations *instead*\n          \n          \n            \n            of calling CREATE with the table definition. **Care** should be taken to ensure that the migrated schema matches a freshly applied schema.\n          \n          \n            \n            See [Testing migrations](#testing-migrations) for information on verifying the fidelity of the schema migrations.\n          \n          \n            \n            \n          \n          \n            \n            NOTE: In Db2, certain alter table statements require a table REORG before the table becomes usable again. Additionally, the REORG\n          \n          \n            \n            may commit the current \"unit of work\" which can prevent the \"all or nothing\" semantics of the migration. For these reasons, its recommended\n          \n          \n            \n            to backup the database before invoking a migration and performing the migration offline.\n          \n          \n            \n            \n          \n          \n            \n            In this way, if a new resource is added to the specification, the schema utility automatically provisions the corresponding table on the next execution of the fhir-persistence-schema `--update-schema` action.", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r401048907", "createdAt": "2020-03-31T16:27:03Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/docs/DB2SchemaMigration.md", "diffHunk": "@@ -218,10 +226,27 @@ Table tbl = Table.builder(schemaName, tableName)\n     .setTablespace(fhirTablespace)\n     .addPrivileges(resourceTablePrivileges)\n     .enableAccessControl(this.sessionVariable)\n+    .addMigration(priorVersion -> {\n+            List<IDatabaseStatement> statements = new ArrayList<>();\n+                if (priorVersion == 1) {\n+                    // Add statements here\n+                }\n+                return statements;\n+            })\n     .build(model);\n ```\n \n-If a new resource is added to the specification, the schema utility automatically provisions it on the next execution of the update schema actions. \n+When the schema is applied for the first time, it creates the table (and related constructs) as according to the definition.\n+When the schema is applied to an existing database, the framework will check the `FHIR_ADMIN.VERSION_HISTORY` table and, \n+if the version in the table is less than the version being applied, the framework will invoke the Migrations *instead*\n+of calling CREATE with the table definition. Care should be taken to ensure that the migrated schema will match a freshly applied schema.\n+See [Testing migrations](#testing-migrations) for information on verifying the fidelity of the schema migrations.\n+\n+NOTE: In Db2, certain alter table statements require a table REORG before the table becomes usable again. Additionally, the REORG\n+may commit the current \"unit of work\" which can prevent the \"all or nothing\" semantics of the migration. For these reasons, its recommended\n+to backup the database before invoking a migration and performing the migration off-line.\n+\n+In this way, if a new resource is added to the specification, the schema utility will automatically provision the corresponding table on the next execution of the fhir-persistence-schema `--update-schema` action. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab45099b35d8175d0a367bfc089f9b8b00a56fec"}, "originalPosition": 126}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab45099b35d8175d0a367bfc089f9b8b00a56fec", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/ab45099b35d8175d0a367bfc089f9b8b00a56fec", "committedDate": "2020-03-31T16:15:36Z", "message": "Added migration details to Managing TABLE section\n\nAdded info on setting up automated migrations and recommendations to:\n1. avoid destructive changes like dropping columns;\n2. backup the database before invoking a migration; and\n3. perform the migration off-line\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "26a373ed9a021e677644c5837a0d5c46847a17af", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/26a373ed9a021e677644c5837a0d5c46847a17af", "committedDate": "2020-03-31T16:27:41Z", "message": "Added migration details to Managing TABLE section\n\nAdded info on setting up automated migrations and recommendations to:\n1. avoid destructive changes like dropping columns;\n2. backup the database before invoking a migration; and\n3. perform the migration off-line\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfc74dde879fb35716ee502401be720f1888dfb9", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/dfc74dde879fb35716ee502401be720f1888dfb9", "committedDate": "2020-03-31T16:33:44Z", "message": "Added migration details to Managing TABLE section\n\nAdded info on setting up automated migrations and recommendations to:\n1. avoid destructive changes like dropping columns;\n2. backup the database before invoking a migration; and\n3. perform the migration off-line\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26a373ed9a021e677644c5837a0d5c46847a17af", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/26a373ed9a021e677644c5837a0d5c46847a17af", "committedDate": "2020-03-31T16:27:41Z", "message": "Added migration details to Managing TABLE section\n\nAdded info on setting up automated migrations and recommendations to:\n1. avoid destructive changes like dropping columns;\n2. backup the database before invoking a migration; and\n3. perform the migration off-line\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "dfc74dde879fb35716ee502401be720f1888dfb9", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/dfc74dde879fb35716ee502401be720f1888dfb9", "committedDate": "2020-03-31T16:33:44Z", "message": "Added migration details to Managing TABLE section\n\nAdded info on setting up automated migrations and recommendations to:\n1. avoid destructive changes like dropping columns;\n2. backup the database before invoking a migration; and\n3. perform the migration off-line\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 559, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}