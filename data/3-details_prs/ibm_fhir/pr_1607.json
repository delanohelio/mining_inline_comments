{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2ODk0MzY3", "number": 1607, "title": "DropSchema related changes for issue #1595", "bodyText": "Previously, if --drop-schema was used without --drop-schema-fhir, --drop-schema-oauth, or --drop-schema-jbatch then it completed with success without actually doing anything.\nI think what happened is that we were debating two different options for these args:\nA. passing some kind of argument to --drop-schema, so it might be like --drop-schema fhir or --drop-schema oauth jbatch; or\nB. using explicit flags for dropping the fhir, schema, or oauth tables, so usage would be like --drop-schema-fhir --drop-schema-oauth\nBut somehow we ended up with a combination of the two which I hope we can all agree is not very good.\nThis pull request modifies the current behavior and turns it into option B, removing support for the --drop-schema action.\nNote: this PR does not actually address issue #1595 ...it only reworks the user experience of the cli so that others can avoid the error that I made initially.", "createdAt": "2020-10-20T15:16:08Z", "url": "https://github.com/IBM/FHIR/pull/1607", "merged": true, "mergeCommit": {"oid": "971490ce1a9873bda73134910151d76e60adc2b6"}, "closed": true, "closedAt": "2020-10-21T14:46:59Z", "author": {"login": "lmsurpre"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUaXseABqjM4OTkzNDAzMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUt8UcAH2gAyNTA2ODk0MzY3OjBlNjZkNTI4ZGViYjIzYjVmNTIyMGQ2ZGIzNTk5ZThmOTMwYjU2MDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a8002a9d20bbc60b218f081a94a005cdee9a224", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/4a8002a9d20bbc60b218f081a94a005cdee9a224", "committedDate": "2020-10-20T15:14:42Z", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "218e1cc932001ba7fbf5a20f4b574d80e5022d18", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/218e1cc932001ba7fbf5a20f4b574d80e5022d18", "committedDate": "2020-10-20T15:18:22Z", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "218e1cc932001ba7fbf5a20f4b574d80e5022d18", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/218e1cc932001ba7fbf5a20f4b574d80e5022d18", "committedDate": "2020-10-20T15:18:22Z", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "45a551818479fa7af37225e9259be2669cc98c60", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/45a551818479fa7af37225e9259be2669cc98c60", "committedDate": "2020-10-20T15:24:43Z", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd7807268a93ffdf832811c69799e49b7d566dc5", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/fd7807268a93ffdf832811c69799e49b7d566dc5", "committedDate": "2020-10-21T12:05:13Z", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45a551818479fa7af37225e9259be2669cc98c60", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/45a551818479fa7af37225e9259be2669cc98c60", "committedDate": "2020-10-20T15:24:43Z", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "fd7807268a93ffdf832811c69799e49b7d566dc5", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/fd7807268a93ffdf832811c69799e49b7d566dc5", "committedDate": "2020-10-21T12:05:13Z", "message": "DropSchema related changes for issue #1595\n\nThis is only a partial fix. More work needs to happen for drop-schema to\nwork on PostgreSQL.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "committedDate": "2020-10-21T13:17:09Z", "message": "Fix the SQLState for an undefined object name for postgresql\n\nAlso added try/catch for dropping undefined indexes\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d226073ace4b314b06f6d0e66856a1bf94ee2bc1", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/d226073ace4b314b06f6d0e66856a1bf94ee2bc1", "committedDate": "2020-10-21T13:14:15Z", "message": "Fix the SQLState for an undefined object name for postgresql\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/2ca04e41a866de3c261888d55a9c7f08f0f9bb99", "committedDate": "2020-10-21T13:17:09Z", "message": "Fix the SQLState for an undefined object name for postgresql\n\nAlso added try/catch for dropping undefined indexes\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjc4MjAy", "url": "https://github.com/IBM/FHIR/pull/1607#pullrequestreview-513678202", "createdAt": "2020-10-21T13:27:39Z", "commit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoyNzozOVrOHlr-dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoyNzozOVrOHlr-dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3OTg2MQ==", "bodyText": "Maybe this should be an OR with\n42883 | undefined_function\n42P01 | undefined_table\n42P02 | undefined_parameter\n42704 | undefined_object", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509279861", "createdAt": "2020-10-21T13:27:39Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlTranslator.java", "diffHunk": "@@ -113,7 +113,7 @@ public boolean isDuplicateSchema(SQLException x) {\n \n     @Override\n     public boolean isUndefinedName(SQLException x) {\n-        return \"42X05\".equals(x.getSQLState());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjgwMzcz", "url": "https://github.com/IBM/FHIR/pull/1607#pullrequestreview-513680373", "createdAt": "2020-10-21T13:28:59Z", "commit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoyODo1OVrOHlsD6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoyODo1OVrOHlsD6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4MTI1OQ==", "bodyText": "maybe we should add all three in this example, or mention in a comment below this update that you can use --drop-schema-oauth and jbatch?", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509281259", "createdAt": "2020-10-21T13:28:59Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/README.md", "diffHunk": "@@ -85,7 +85,7 @@ The following sections include common values for `OPTIONS`.\n ```\n --prop-file db2.properties\n --schema-name FHIRDATA\n---drop-schema\n+--drop-schema-fhir\n --drop-admin\n --confirm-drop\n ```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjgyNDQ2", "url": "https://github.com/IBM/FHIR/pull/1607#pullrequestreview-513682446", "createdAt": "2020-10-21T13:30:19Z", "commit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozMDoxOVrOHlsLxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozMDoxOVrOHlsLxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4MzI2OA==", "bodyText": "is the adminDrop implicit here? what if we just call dropAdmin", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509283268", "createdAt": "2020-10-21T13:30:19Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -424,7 +423,7 @@ protected void dropSchema() {\n                     JdbcTarget target = new JdbcTarget(c);\n                     IDatabaseAdapter adapter = getDbAdapter(dbType, target);\n \n-                    if (this.dropSchema) {\n+                    if (dropFhirSchema || dropOauthSchema || dropJavaBatchSchema) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjgzNzE1", "url": "https://github.com/IBM/FHIR/pull/1607#pullrequestreview-513683715", "createdAt": "2020-10-21T13:31:32Z", "commit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozMTozMlrOHlsR5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozMTozMlrOHlsR5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4NDgzOQ==", "bodyText": "See 426", "url": "https://github.com/IBM/FHIR/pull/1607#discussion_r509284839", "createdAt": "2020-10-21T13:31:32Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -1387,20 +1385,13 @@ protected void process() {\n \n         if (addKeyForTenant != null) {\n             addTenantKey();\n-        } else if (this.dropSchema) {\n+        } else if (this.dropAdmin || this.dropFhirSchema || this.dropJavaBatchSchema || this.dropOauthSchema) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "originalPosition": 224}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjg2Nzgy", "url": "https://github.com/IBM/FHIR/pull/1607#pullrequestreview-513686782", "createdAt": "2020-10-21T13:34:32Z", "commit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNzAyNzg5", "url": "https://github.com/IBM/FHIR/pull/1607#pullrequestreview-513702789", "createdAt": "2020-10-21T13:45:07Z", "commit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNzA5NTEx", "url": "https://github.com/IBM/FHIR/pull/1607#pullrequestreview-513709511", "createdAt": "2020-10-21T13:51:24Z", "commit": {"oid": "2ca04e41a866de3c261888d55a9c7f08f0f9bb99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b87388e431c73a3d522aa30a34a42ff83d54358b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/b87388e431c73a3d522aa30a34a42ff83d54358b", "committedDate": "2020-10-21T14:04:18Z", "message": "Warn and skip drop permission statements for postgresql\n\nPermission objects are not used in our use of PostgreSQL\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e66d528debb23b5f5220d6db3599e8f930b5608", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/0e66d528debb23b5f5220d6db3599e8f930b5608", "committedDate": "2020-10-21T14:07:20Z", "message": "Added additional codes for isUndefined\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 915, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}