{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MjQzODQ0", "number": 883, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo0MjowNlrODtt3xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjowMjozM1rODtuPXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjY0MDcxOnYy", "diffSide": "LEFT", "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/test/spec/R4JDBCExamplesTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo0MjowNlrOF_TsIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjowNDowMFrOF_USxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNzIwMQ==", "bodyText": "intesting,  why this bootstrapAndLoad function was basically do nothing...", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401927201", "createdAt": "2020-04-01T21:42:06Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/test/spec/R4JDBCExamplesTest.java", "diffHunk": "@@ -40,16 +38,13 @@ public R4JDBCExamplesTest() throws Exception {\n         this.properties = TestUtil.readTestProperties(\"test.jdbc.properties\");\n     }\n \n-    @BeforeSuite\n-    public void bootstrapAndLoad() {\n-        System.out.println(\"Bootstrapping database:\");\n-\n-\n-        System.out.println(\"Processing examples:\");\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzA5NA==", "bodyText": "I am not sure", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401937094", "createdAt": "2020-04-01T22:04:00Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/test/spec/R4JDBCExamplesTest.java", "diffHunk": "@@ -40,16 +38,13 @@ public R4JDBCExamplesTest() throws Exception {\n         this.properties = TestUtil.readTestProperties(\"test.jdbc.properties\");\n     }\n \n-    @BeforeSuite\n-    public void bootstrapAndLoad() {\n-        System.out.println(\"Bootstrapping database:\");\n-\n-\n-        System.out.println(\"Processing examples:\");\n-    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNzIwMQ=="}, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjY0Nzg4OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/test/spec/R4JDBCExamplesTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo0NDozNFrOF_TweQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjowNDoxN1rOF_UTRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyODMxMw==", "bodyText": "just curious, maybe long time ago, these codes were in bootstrapAndLoad() function?", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401928313", "createdAt": "2020-04-01T21:44:34Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/test/spec/R4JDBCExamplesTest.java", "diffHunk": "@@ -40,16 +38,13 @@ public R4JDBCExamplesTest() throws Exception {\n         this.properties = TestUtil.readTestProperties(\"test.jdbc.properties\");\n     }\n \n-    @BeforeSuite\n-    public void bootstrapAndLoad() {\n-        System.out.println(\"Bootstrapping database:\");\n-\n-\n-        System.out.println(\"Processing examples:\");\n-    }\n-\n-    @Test(groups = { \"jdbc-seed\" })\n+    @Test(groups = { \"jdbc-seed\" }, singleThreaded = true, priority = -1)\n     public void perform() throws Exception {\n+        if(this.database == null) {\n+            System.out.println(\"Bootstrapping database:\");\n+            this.database = new DerbyFhirDatabase(DerbyInitializer.DB_NAME);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzIyMQ==", "bodyText": "no - I added, and move the output statement.", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401937221", "createdAt": "2020-04-01T22:04:17Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/test/spec/R4JDBCExamplesTest.java", "diffHunk": "@@ -40,16 +38,13 @@ public R4JDBCExamplesTest() throws Exception {\n         this.properties = TestUtil.readTestProperties(\"test.jdbc.properties\");\n     }\n \n-    @BeforeSuite\n-    public void bootstrapAndLoad() {\n-        System.out.println(\"Bootstrapping database:\");\n-\n-\n-        System.out.println(\"Processing examples:\");\n-    }\n-\n-    @Test(groups = { \"jdbc-seed\" })\n+    @Test(groups = { \"jdbc-seed\" }, singleThreaded = true, priority = -1)\n     public void perform() throws Exception {\n+        if(this.database == null) {\n+            System.out.println(\"Bootstrapping database:\");\n+            this.database = new DerbyFhirDatabase(DerbyInitializer.DB_NAME);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyODMxMw=="}, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjY3NDM3OnYy", "diffSide": "RIGHT", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo1Mjo1M1rOF_T_2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo1Mjo1M1rOF_T_2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzMjI0OQ==", "bodyText": "good change, I did find in my local message.log, seems apply has been done again and again for all existing derby databases, really nice to see this change, I guess this should be able to fix the issue I see.  and btw, I guess we will always have to change this sequence.java whenever any schema update is made, really want to know how would we support upgrade from any previous version to this version ...", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401932249", "createdAt": "2020-04-01T21:52:53Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "diffHunk": "@@ -37,7 +38,12 @@ public void apply(Integer priorVersion, IDatabaseAdapter target) {\n         if (priorVersion != null && priorVersion > 0 && this.version > priorVersion) {\n             throw new UnsupportedOperationException(\"Upgrading sequences is not supported\");\n         }\n-        apply(target);\n+\n+        // Only if VERSION1 then we want to apply, else fall through\n+        // Re-creating a sequence can have unintended consequences.\n+        if (this.version == 1 && priorVersion == 0) {\n+            apply(target);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjY3NTcwOnYy", "diffSide": "RIGHT", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo1MzoyMlrOF_UAqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDowODoyNlrOF_W8aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzMjQ1OQ==", "bodyText": "Originally I think this class was intended to be generic / agnostic to the specific schema getting created.  This is why its in fhir-database-utils and not fhir-persistence-schema", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401932459", "createdAt": "2020-04-01T21:53:22Z", "author": {"login": "lmsurpre"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java", "diffHunk": "@@ -15,19 +15,27 @@\n import java.util.logging.Level;\n import java.util.logging.Logger;\n \n-import com.ibm.fhir.database.utils.api.AllVersionHistoryService;\n import com.ibm.fhir.database.utils.api.DataAccessException;\n import com.ibm.fhir.database.utils.api.IDatabaseAdapter;\n import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.database.utils.api.ITransactionProvider;\n import com.ibm.fhir.database.utils.api.IVersionHistoryService;\n+import com.ibm.fhir.database.utils.common.JdbcConnectionProvider;\n+import com.ibm.fhir.database.utils.common.JdbcPropertyAdapter;\n import com.ibm.fhir.database.utils.common.JdbcTarget;\n import com.ibm.fhir.database.utils.common.PrintTarget;\n import com.ibm.fhir.database.utils.model.PhysicalDataModel;\n+import com.ibm.fhir.database.utils.pool.PoolConnectionProvider;\n+import com.ibm.fhir.database.utils.transaction.SimpleTransactionProvider;\n+import com.ibm.fhir.database.utils.version.CreateVersionHistory;\n+import com.ibm.fhir.database.utils.version.VersionHistoryService;\n \n /**\n  * Set up an instance of Derby for use with unit tests\n  */\n public class DerbyMaster implements AutoCloseable {\n+    private static final String SCHEMA_NAME = \"FHIRDATA\";\n+    private static final String ADMIN_SCHEMA_NAME = \"FHIR_ADMIN\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzU3MQ==", "bodyText": "I totally understand.  any suggestions?", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401937571", "createdAt": "2020-04-01T22:05:07Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java", "diffHunk": "@@ -15,19 +15,27 @@\n import java.util.logging.Level;\n import java.util.logging.Logger;\n \n-import com.ibm.fhir.database.utils.api.AllVersionHistoryService;\n import com.ibm.fhir.database.utils.api.DataAccessException;\n import com.ibm.fhir.database.utils.api.IDatabaseAdapter;\n import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.database.utils.api.ITransactionProvider;\n import com.ibm.fhir.database.utils.api.IVersionHistoryService;\n+import com.ibm.fhir.database.utils.common.JdbcConnectionProvider;\n+import com.ibm.fhir.database.utils.common.JdbcPropertyAdapter;\n import com.ibm.fhir.database.utils.common.JdbcTarget;\n import com.ibm.fhir.database.utils.common.PrintTarget;\n import com.ibm.fhir.database.utils.model.PhysicalDataModel;\n+import com.ibm.fhir.database.utils.pool.PoolConnectionProvider;\n+import com.ibm.fhir.database.utils.transaction.SimpleTransactionProvider;\n+import com.ibm.fhir.database.utils.version.CreateVersionHistory;\n+import com.ibm.fhir.database.utils.version.VersionHistoryService;\n \n /**\n  * Set up an instance of Derby for use with unit tests\n  */\n public class DerbyMaster implements AutoCloseable {\n+    private static final String SCHEMA_NAME = \"FHIRDATA\";\n+    private static final String ADMIN_SCHEMA_NAME = \"FHIR_ADMIN\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzMjQ1OQ=="}, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MDUyMw==", "bodyText": "Fixed", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401980523", "createdAt": "2020-04-02T00:08:26Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java", "diffHunk": "@@ -15,19 +15,27 @@\n import java.util.logging.Level;\n import java.util.logging.Logger;\n \n-import com.ibm.fhir.database.utils.api.AllVersionHistoryService;\n import com.ibm.fhir.database.utils.api.DataAccessException;\n import com.ibm.fhir.database.utils.api.IDatabaseAdapter;\n import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.database.utils.api.ITransactionProvider;\n import com.ibm.fhir.database.utils.api.IVersionHistoryService;\n+import com.ibm.fhir.database.utils.common.JdbcConnectionProvider;\n+import com.ibm.fhir.database.utils.common.JdbcPropertyAdapter;\n import com.ibm.fhir.database.utils.common.JdbcTarget;\n import com.ibm.fhir.database.utils.common.PrintTarget;\n import com.ibm.fhir.database.utils.model.PhysicalDataModel;\n+import com.ibm.fhir.database.utils.pool.PoolConnectionProvider;\n+import com.ibm.fhir.database.utils.transaction.SimpleTransactionProvider;\n+import com.ibm.fhir.database.utils.version.CreateVersionHistory;\n+import com.ibm.fhir.database.utils.version.VersionHistoryService;\n \n /**\n  * Set up an instance of Derby for use with unit tests\n  */\n public class DerbyMaster implements AutoCloseable {\n+    private static final String SCHEMA_NAME = \"FHIRDATA\";\n+    private static final String ADMIN_SCHEMA_NAME = \"FHIR_ADMIN\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzMjQ1OQ=="}, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjY5MTk1OnYy", "diffSide": "RIGHT", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo1ODo1NFrOF_UKaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDowODo1MlrOF_W8_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNDk1NQ==", "bodyText": "this skips the apply when priorVersion == null, which is what that AllVersionHistoryService service always passes.  I see we don't use that any more, but i think we should also handle nulls here unless we totally remove it", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401934955", "createdAt": "2020-04-01T21:58:54Z", "author": {"login": "lmsurpre"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "diffHunk": "@@ -37,7 +38,12 @@ public void apply(Integer priorVersion, IDatabaseAdapter target) {\n         if (priorVersion != null && priorVersion > 0 && this.version > priorVersion) {\n             throw new UnsupportedOperationException(\"Upgrading sequences is not supported\");\n         }\n-        apply(target);\n+\n+        // Only if VERSION1 then we want to apply, else fall through\n+        // Re-creating a sequence can have unintended consequences.\n+        if (this.version == 1 && priorVersion == 0) {\n+            apply(target);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MDY3MA==", "bodyText": "yes - I accepted your change - a good guard is now in place.", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401980670", "createdAt": "2020-04-02T00:08:52Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "diffHunk": "@@ -37,7 +38,12 @@ public void apply(Integer priorVersion, IDatabaseAdapter target) {\n         if (priorVersion != null && priorVersion > 0 && this.version > priorVersion) {\n             throw new UnsupportedOperationException(\"Upgrading sequences is not supported\");\n         }\n-        apply(target);\n+\n+        // Only if VERSION1 then we want to apply, else fall through\n+        // Re-creating a sequence can have unintended consequences.\n+        if (this.version == 1 && priorVersion == 0) {\n+            apply(target);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNDk1NQ=="}, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjY5MzU4OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/test/spec/R4JDBCExamplesProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo1OTozNVrOF_ULeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMTo1OTozNVrOF_ULeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNTIyNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Create a anew FHIRPersistenceContext configure with a FHIRHistoryContext\n          \n          \n            \n                 * Create a new FHIRPersistenceContext configure with a FHIRHistoryContext", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401935224", "createdAt": "2020-04-01T21:59:35Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/test/spec/R4JDBCExamplesProcessor.java", "diffHunk": "@@ -182,7 +180,7 @@ protected FHIRPersistenceContext createPersistenceContext() {\n     }\n \n     /**\n-     * Createa anew FHIRPersistenceContext configure with a FHIRHistoryContext\n+     * Create a anew FHIRPersistenceContext configure with a FHIRHistoryContext", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjY5NTg5OnYy", "diffSide": "RIGHT", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjowMDoyNlrOF_UM8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjo1Njo0OFrOF_VjWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNTYwMg==", "bodyText": "good to see that we don't create the versionhistoryService every time calling createSchema now!\njust double check, createSchema is never called before runWithAdapter(), correct?", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401935602", "createdAt": "2020-04-01T22:00:26Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java", "diffHunk": "@@ -162,7 +173,7 @@ public IDatabaseTranslator getTranslator() {\n      * @param pdm\n      */\n     public void createSchema(PhysicalDataModel pdm) {\n-        createSchema(new AllVersionHistoryService(), pdm);\n+        createSchema(vhs, pdm);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NzcyMQ==", "bodyText": "indirectly - yes", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401957721", "createdAt": "2020-04-01T22:56:48Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/derby/DerbyMaster.java", "diffHunk": "@@ -162,7 +173,7 @@ public IDatabaseTranslator getTranslator() {\n      * @param pdm\n      */\n     public void createSchema(PhysicalDataModel pdm) {\n-        createSchema(new AllVersionHistoryService(), pdm);\n+        createSchema(vhs, pdm);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNTYwMg=="}, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjcwMTEwOnYy", "diffSide": "RIGHT", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjowMjozM1rOF_UQRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjowNzoyOFrOF_UYMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNjQ1Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (this.version == 1 && priorVersion == 0) {\n          \n          \n            \n                    if (this.version == 1 && (priorVersion == 0 || priorVersion == null)) {", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401936452", "createdAt": "2020-04-01T22:02:33Z", "author": {"login": "lmsurpre"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "diffHunk": "@@ -37,7 +38,12 @@ public void apply(Integer priorVersion, IDatabaseAdapter target) {\n         if (priorVersion != null && priorVersion > 0 && this.version > priorVersion) {\n             throw new UnsupportedOperationException(\"Upgrading sequences is not supported\");\n         }\n-        apply(target);\n+\n+        // Only if VERSION1 then we want to apply, else fall through\n+        // Re-creating a sequence can have unintended consequences.\n+        if (this.version == 1 && priorVersion == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzODM5Mg==", "bodyText": "I didn't run into the situation where it was null.  I had some logging statements, and it was always zero or 1", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401938392", "createdAt": "2020-04-01T22:07:16Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "diffHunk": "@@ -37,7 +38,12 @@ public void apply(Integer priorVersion, IDatabaseAdapter target) {\n         if (priorVersion != null && priorVersion > 0 && this.version > priorVersion) {\n             throw new UnsupportedOperationException(\"Upgrading sequences is not supported\");\n         }\n-        apply(target);\n+\n+        // Only if VERSION1 then we want to apply, else fall through\n+        // Re-creating a sequence can have unintended consequences.\n+        if (this.version == 1 && priorVersion == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNjQ1Mg=="}, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzODQ4MQ==", "bodyText": "Adding as it's a good guard (just in case)", "url": "https://github.com/IBM/FHIR/pull/883#discussion_r401938481", "createdAt": "2020-04-01T22:07:28Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/model/Sequence.java", "diffHunk": "@@ -37,7 +38,12 @@ public void apply(Integer priorVersion, IDatabaseAdapter target) {\n         if (priorVersion != null && priorVersion > 0 && this.version > priorVersion) {\n             throw new UnsupportedOperationException(\"Upgrading sequences is not supported\");\n         }\n-        apply(target);\n+\n+        // Only if VERSION1 then we want to apply, else fall through\n+        // Re-creating a sequence can have unintended consequences.\n+        if (this.version == 1 && priorVersion == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNjQ1Mg=="}, "originalCommit": {"oid": "ee301cd388e3a8bc837193f5dbb0d39da48818ad"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 159, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}