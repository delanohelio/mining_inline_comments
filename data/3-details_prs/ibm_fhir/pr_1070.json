{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MzU4NjM0", "number": 1070, "title": "issue #1061 fixes for improving postgresql update performance", "bodyText": "To achieve better update performance:\n-Updated add_any_resource function for postgresql to use \"no key update\";\n-Updated postgresqladapter to disable the constrains for composites.\nPer tests, the first change improved the updates of observations from only about 3/second to more than 33/second; and the second change further improved the performance to about 60/second, almost the same as importing new resources.\nSigned-off-by: Albert Wang xuwang@us.ibm.com", "createdAt": "2020-05-11T21:28:16Z", "url": "https://github.com/IBM/FHIR/pull/1070", "merged": true, "mergeCommit": {"oid": "9badfd0f70a2e1cf3b1ea7ad29e190ea0ca30ab6"}, "closed": true, "closedAt": "2020-05-12T00:08:41Z", "author": {"login": "albertwang-ibm"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgWb83AH2gAyNDE2MzU4NjM0OjJkYTA5Y2Q0N2FlZjdhYTc2ZWNkNGY2ZDU0ZGExMjdmNTc1MWRhMGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgYT7kgFqTQwOTYwMDQzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2da09cd47aef7aa76ecd4f6d54da127f5751da0a", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/2da09cd47aef7aa76ecd4f6d54da127f5751da0a", "committedDate": "2020-05-11T21:20:06Z", "message": "issue #1061 fixes for improving update  performance\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTYxMjc3", "url": "https://github.com/IBM/FHIR/pull/1070#pullrequestreview-409561277", "createdAt": "2020-05-11T21:58:54Z", "commit": {"oid": "2da09cd47aef7aa76ecd4f6d54da127f5751da0a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMTo1ODo1NVrOGTu4mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMTo1ODo1NVrOGTu4mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NDI4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Make the call, but\n          \n          \n            \n                    // 1. without the tenantColumnName because PostgreSql doesn't support our multi-tenant implementation; and\n          \n          \n            \n                    // 2. with enforced=true because PostgreSql doesn't support non-default constraint characteristics\n          \n          \n            \n                    // If enforced=false, skip the constraint because PostgreSQL doesn't support unenforced constraints", "url": "https://github.com/IBM/FHIR/pull/1070#discussion_r423344282", "createdAt": "2020-05-11T21:58:55Z", "author": {"login": "lmsurpre"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlAdapter.java", "diffHunk": "@@ -250,7 +250,9 @@ public void createForeignKeyConstraint(String constraintName, String schemaName,\n         // Make the call, but\n         // 1. without the tenantColumnName because PostgreSql doesn't support our multi-tenant implementation; and\n         // 2. with enforced=true because PostgreSql doesn't support non-default constraint characteristics", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da09cd47aef7aa76ecd4f6d54da127f5751da0a"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTYxNTg3", "url": "https://github.com/IBM/FHIR/pull/1070#pullrequestreview-409561587", "createdAt": "2020-05-11T21:59:34Z", "commit": {"oid": "2da09cd47aef7aa76ecd4f6d54da127f5751da0a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMTo1OTozNFrOGTu5fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMTo1OTozNFrOGTu5fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NDUxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        super.createForeignKeyConstraint(constraintName, schemaName, name, targetSchema, targetTable, null, columns, true);\n          \n          \n            \n                        // Make the call, but without the tenantColumnName because PostgreSQL doesn't support our multi-tenant implementation\n          \n          \n            \n                        super.createForeignKeyConstraint(constraintName, schemaName, name, targetSchema, targetTable, null, columns, true);", "url": "https://github.com/IBM/FHIR/pull/1070#discussion_r423344511", "createdAt": "2020-05-11T21:59:34Z", "author": {"login": "lmsurpre"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlAdapter.java", "diffHunk": "@@ -250,7 +250,9 @@ public void createForeignKeyConstraint(String constraintName, String schemaName,\n         // Make the call, but\n         // 1. without the tenantColumnName because PostgreSql doesn't support our multi-tenant implementation; and\n         // 2. with enforced=true because PostgreSql doesn't support non-default constraint characteristics\n-        super.createForeignKeyConstraint(constraintName, schemaName, name, targetSchema, targetTable, null, columns, true);\n+        if (enforced) {\n+            super.createForeignKeyConstraint(constraintName, schemaName, name, targetSchema, targetTable, null, columns, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da09cd47aef7aa76ecd4f6d54da127f5751da0a"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTYxODE0", "url": "https://github.com/IBM/FHIR/pull/1070#pullrequestreview-409561814", "createdAt": "2020-05-11T22:00:01Z", "commit": {"oid": "2da09cd47aef7aa76ecd4f6d54da127f5751da0a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjowMDowMlrOGTu6Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjowMDowMlrOGTu6Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NDY4Mw==", "bodyText": "somewhat minor/unrelated, but can we make this same change on the Derby side for consistency?", "url": "https://github.com/IBM/FHIR/pull/1070#discussion_r423344683", "createdAt": "2020-05-11T22:00:02Z", "author": {"login": "lmsurpre"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlAdapter.java", "diffHunk": "@@ -250,7 +250,9 @@ public void createForeignKeyConstraint(String constraintName, String schemaName,\n         // Make the call, but\n         // 1. without the tenantColumnName because PostgreSql doesn't support our multi-tenant implementation; and\n         // 2. with enforced=true because PostgreSql doesn't support non-default constraint characteristics\n-        super.createForeignKeyConstraint(constraintName, schemaName, name, targetSchema, targetTable, null, columns, true);\n+        if (enforced) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da09cd47aef7aa76ecd4f6d54da127f5751da0a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07e55445050a27deafcf2a58ff450c3165cd5621", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/07e55445050a27deafcf2a58ff450c3165cd5621", "committedDate": "2020-05-11T22:05:37Z", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>\n\nCo-authored-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "184cc2979a8f1cece593af9d53238b7f89f2866c", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/184cc2979a8f1cece593af9d53238b7f89f2866c", "committedDate": "2020-05-11T22:11:38Z", "message": "issue #1061 update derbyadapter constrain codes\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a6ba33e3ec28dab1af9bbbfd8810a5b2a670e1e", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/5a6ba33e3ec28dab1af9bbbfd8810a5b2a670e1e", "committedDate": "2020-05-11T22:14:25Z", "message": "issue #1061 minor update to comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NjAwMzg3", "url": "https://github.com/IBM/FHIR/pull/1070#pullrequestreview-409600387", "createdAt": "2020-05-11T23:31:01Z", "commit": {"oid": "5a6ba33e3ec28dab1af9bbbfd8810a5b2a670e1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMzozMTowMVrOGTw6NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMzozMTowMVrOGTw6NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NzQ2MQ==", "bodyText": "good comment.", "url": "https://github.com/IBM/FHIR/pull/1070#discussion_r423377461", "createdAt": "2020-05-11T23:31:01Z", "author": {"login": "prb112"}, "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/postgresql/PostgreSqlAdapter.java", "diffHunk": "@@ -247,10 +247,11 @@ public void createForeignKeyConstraint(String constraintName, String schemaName,\n             String targetSchema, String targetTable, String tenantColumnName,\n             List<String> columns, boolean enforced) {\n \n-        // Make the call, but\n-        // 1. without the tenantColumnName because PostgreSql doesn't support our multi-tenant implementation; and\n-        // 2. with enforced=true because PostgreSql doesn't support non-default constraint characteristics\n-        super.createForeignKeyConstraint(constraintName, schemaName, name, targetSchema, targetTable, null, columns, true);\n+        // If enforced=false, skip the constraint because PostgreSQL doesn't support unenforced constraints\n+        if (enforced) {\n+            // Make the call, but without the tenantColumnName because PostgreSQL doesn't support our multi-tenant implementation\n+            super.createForeignKeyConstraint(constraintName, schemaName, name, targetSchema, targetTable, null, columns, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a6ba33e3ec28dab1af9bbbfd8810a5b2a670e1e"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NjAwNDMx", "url": "https://github.com/IBM/FHIR/pull/1070#pullrequestreview-409600431", "createdAt": "2020-05-11T23:31:09Z", "commit": {"oid": "5a6ba33e3ec28dab1af9bbbfd8810a5b2a670e1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 465, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}