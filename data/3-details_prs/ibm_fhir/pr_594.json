{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMzEwOTEy", "number": 594, "title": "issue #108 #618 bulkdata export for group members and instruction for exports", "bodyText": "The changes include:\n(1) New batch job for group member patients export;\n(2) New operation for group member patients export;\n(3) Integration tests for system, patient and group exports.\n(4) Added Instruction for bulkdata export to server user guide.\nSigned-off-by: Albert Wang xuwang@us.ibm.com", "createdAt": "2020-01-15T19:56:15Z", "url": "https://github.com/IBM/FHIR/pull/594", "merged": true, "mergeCommit": {"oid": "f46a1c8d445413c9a66e77fc385d0ce2ba90e0c2"}, "closed": true, "closedAt": "2020-01-23T17:54:51Z", "author": {"login": "albertwang-ibm"}, "timelineItems": {"totalCount": 114, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9LSY2gH2gAyMzYzMzEwOTEyOmE4YzhiNTc2ZjE4NzgwOWYwZWM3MmZjN2QwMjkwYzdiNDUzNjQ0YzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9NtwNgH2gAyMzYzMzEwOTEyOjhhZWI1Yzk5NDFkN2UzODA3MzA4NmNkMTQ0NjM0MTg0MGM3YWUwYmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a8c8b576f187809f0ec72fc7d0290c7b453644c2", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/a8c8b576f187809f0ec72fc7d0290c7b453644c2", "committedDate": "2020-01-23T14:33:21Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd5d848eb4bda4a6c0dd04740c6df46bfe1a5337", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/fd5d848eb4bda4a6c0dd04740c6df46bfe1a5337", "committedDate": "2020-01-23T14:33:43Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cd91fb12e7c4d0f437203a193773ddd3f32f95f", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/3cd91fb12e7c4d0f437203a193773ddd3f32f95f", "committedDate": "2020-01-23T14:34:05Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6a060142056769ba7f49b79281389b3c3af8aeb", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/b6a060142056769ba7f49b79281389b3c3af8aeb", "committedDate": "2020-01-23T14:34:21Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82c49e6403e51899ce8afea8947d728fb086112a", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/82c49e6403e51899ce8afea8947d728fb086112a", "committedDate": "2020-01-23T14:34:39Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0b7845ac77ed7b7d913cc3f9d44011fbe310e03", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/f0b7845ac77ed7b7d913cc3f9d44011fbe310e03", "committedDate": "2020-01-23T14:35:08Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b300473427c7e7550e8aca6a15004fafbb900f6a", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/b300473427c7e7550e8aca6a15004fafbb900f6a", "committedDate": "2020-01-23T14:35:31Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b5f305451a3a2ef065b00f9f55996d0a61827d2", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/2b5f305451a3a2ef065b00f9f55996d0a61827d2", "committedDate": "2020-01-23T14:35:43Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d80dd887c13ef9589b92a39bafb144ddc7d0f952", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/d80dd887c13ef9589b92a39bafb144ddc7d0f952", "committedDate": "2020-01-23T14:36:08Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4aa4f9ba945dd6665688265e2170641c5d97fc0", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/b4aa4f9ba945dd6665688265e2170641c5d97fc0", "committedDate": "2020-01-23T14:57:26Z", "message": "Update fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a50e91deb919bf5c15ef5710bfb1eb1640556ba2", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/a50e91deb919bf5c15ef5710bfb1eb1640556ba2", "committedDate": "2020-01-23T15:10:03Z", "message": "issue #108 changes per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3Mzc1NzUz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347375753", "createdAt": "2020-01-23T15:15:32Z", "commit": {"oid": "a50e91deb919bf5c15ef5710bfb1eb1640556ba2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNToxNTozMlrOFhB3fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNToxNTozMlrOFhB3fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3NzkxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n          \n          \n            \n            BulkData web application writes the exported FHIR resources to an IBM Cloud Object Storage (COS) or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file. The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370177917", "createdAt": "2020-01-23T15:15:32Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,143 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* module implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* module to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* module for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a50e91deb919bf5c15ef5710bfb1eb1640556ba2"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NDM1NDc4", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347435478", "createdAt": "2020-01-23T16:28:07Z", "commit": {"oid": "a50e91deb919bf5c15ef5710bfb1eb1640556ba2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aeb5c9941d7e38073086cd1446341840c7ae0be", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/8aeb5c9941d7e38073086cd1446341840c7ae0be", "committedDate": "2020-01-23T17:23:03Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8bef36bbee277673e25908308c6b0762bffaa4a", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/b8bef36bbee277673e25908308c6b0762bffaa4a", "committedDate": "2020-01-15T19:55:38Z", "message": "issue #108 bulkdata export for group members initial code drop\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb069a19f62a88115d8126d0aef936707281e07e", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/cb069a19f62a88115d8126d0aef936707281e07e", "committedDate": "2020-01-16T15:17:15Z", "message": "issue #108 add support for nested group\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed52a92c0352c56f4f97cf317d43a1385b62d835", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/ed52a92c0352c56f4f97cf317d43a1385b62d835", "committedDate": "2020-01-16T16:25:49Z", "message": "issue #108 fix for exit status\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ff78cbc8e56ea11e4ee63f8edda9ca387d73a9d", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/3ff78cbc8e56ea11e4ee63f8edda9ca387d73a9d", "committedDate": "2020-01-16T18:58:55Z", "message": "issue #108 changes to survive circle reference of groups\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6434c62a97873e1b6cf977201e8e98fb55a89c36", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/6434c62a97873e1b6cf977201e8e98fb55a89c36", "committedDate": "2020-01-16T19:36:15Z", "message": "issue #108 adjust log level to fine for some locations\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34dd7262b0ab58f432964898676c370c63df8b20", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/34dd7262b0ab58f432964898676c370c63df8b20", "committedDate": "2020-01-17T14:13:50Z", "message": "issue #108 add integration tests for export operations\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "411dfae242931e3c85c0ae79e2edcbc4a0acd7f5", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/411dfae242931e3c85c0ae79e2edcbc4a0acd7f5", "committedDate": "2020-01-20T22:03:52Z", "message": "issue #108 instruction for bulkdata export\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/4247b9102386532ab7e481ca0989dc5659031c72", "committedDate": "2020-01-20T22:38:22Z", "message": "issue #108 added description for the new integration tests\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTc5NjQy", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345579642", "createdAt": "2020-01-21T00:15:48Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNTo0OFrOFfrmuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNTo0OFrOFfrmuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDYwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n          \n          \n            \n            BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368764603", "createdAt": "2020-01-21T00:15:48Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTc5Njg4", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345579688", "createdAt": "2020-01-21T00:16:02Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNjowM1rOFfrm4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNjowM1rOFfrm4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDY0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            There are 2 projects involved inside the implementation:\n          \n          \n            \n            There are 2 modules involved inside the implementation:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368764641", "createdAt": "2020-01-21T00:16:03Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTc5ODUw", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345579850", "createdAt": "2020-01-21T00:16:51Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNjo1MVrOFfrnWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNjo1MVrOFfrnWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDc2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            (There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n          \n          \n            \n            To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368764762", "createdAt": "2020-01-21T00:16:51Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTc5OTA2", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345579906", "createdAt": "2020-01-21T00:17:09Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNzoxMFrOFfrngQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNzoxMFrOFfrngQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDgwMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n          \n          \n            \n            \n          \n          \n            \n            There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368764801", "createdAt": "2020-01-21T00:17:10Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgwMzM1", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345580335", "createdAt": "2020-01-21T00:19:31Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxOTozMVrOFfro6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxOTozMVrOFfro6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTE2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n          \n          \n            \n            The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765163", "createdAt": "2020-01-21T00:19:31Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgwNjc3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345580677", "createdAt": "2020-01-21T00:21:36Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMTozNlrOFfrqHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMTozNlrOFfrqHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTQ2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n          \n          \n            \n            The *fhir-bulkimportexport-webapp* project is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765468", "createdAt": "2020-01-21T00:21:36Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgwNzE3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345580717", "createdAt": "2020-01-21T00:21:49Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMTo0OVrOFfrqOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMTo0OVrOFfrqOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTQ5OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            ``` xml", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765499", "createdAt": "2020-01-21T00:21:49Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgxMDQz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345581043", "createdAt": "2020-01-21T00:23:48Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMzo0OFrOFfrrQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMzo0OFrOFfrrQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTc2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n          \n          \n            \n            BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765761", "createdAt": "2020-01-21T00:23:48Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgxMDY3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345581067", "createdAt": "2020-01-21T00:23:58Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMzo1OFrOFfrrWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMzo1OFrOFfrrWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTc4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            ``` json", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765786", "createdAt": "2020-01-21T00:23:58Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgxMjc2", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345581276", "createdAt": "2020-01-21T00:25:06Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNTowNlrOFfrsBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNTowNlrOFfrsBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTk1OA==", "bodyText": "maybe 1-2 output examples is OK?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765958", "createdAt": "2020-01-21T00:25:06Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgxMzA0", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345581304", "createdAt": "2020-01-21T00:25:17Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNToxN1rOFfrsJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNToxN1rOFfrsJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTk4OQ==", "bodyText": "Suggested change", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765989", "createdAt": "2020-01-21T00:25:17Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgxNTk0", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345581594", "createdAt": "2020-01-21T00:26:54Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNjo1NFrOFfrtHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNjo1NFrOFfrtHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg==", "bodyText": "I am not sure I follow this?\nIf a file is written out to Object Storage, it's public by default? only protected by obfuscation?\nThe above paragraph is a bit tricky to read", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766236", "createdAt": "2020-01-21T00:26:54Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgxNjE1", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345581615", "createdAt": "2020-01-21T00:27:04Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNzowNFrOFfrtKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNzowNFrOFfrtKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjI0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            ``` xml", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766249", "createdAt": "2020-01-21T00:27:04Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n+  \n+JavaBatch feature must be enabled in server.xml as following for liberty server:\n+\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgxNjYx", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345581661", "createdAt": "2020-01-21T00:27:22Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNzoyMlrOFfrtTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNzoyMlrOFfrtTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjI4Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            And JavaBatch user used in bulkdata.json can be configured in server.xml as following: \n          \n          \n            \n            The JavaBatch user is configured in server.xml and the bulkdata.json:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766287", "createdAt": "2020-01-21T00:27:22Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n+  \n+JavaBatch feature must be enabled in server.xml as following for liberty server:\n+\n+```\n+    <!-- Enable features -->\n+    <featureManager>\n+        ...\n+        <feature>batchManagement-1.0</feature>\n+        ...\n+    </featureManager>\n+```\n+And JavaBatch user used in bulkdata.json can be configured in server.xml as following: ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 121}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgyMDY0", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345582064", "createdAt": "2020-01-21T00:29:38Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyOTozOFrOFfrumg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyOTozOFrOFfrumg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjYxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Please notice that a user with at least batchSubmitter role should be used for batch-user of bulkdata.json.\n          \n          \n            \n            Note: The user referenced in the bulkdata.json must have a role of at least batchSubmitter.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766618", "createdAt": "2020-01-21T00:29:38Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n+  \n+JavaBatch feature must be enabled in server.xml as following for liberty server:\n+\n+```\n+    <!-- Enable features -->\n+    <featureManager>\n+        ...\n+        <feature>batchManagement-1.0</feature>\n+        ...\n+    </featureManager>\n+```\n+And JavaBatch user used in bulkdata.json can be configured in server.xml as following: \n+\n+```    \n+<authorization-roles id=\"com.ibm.ws.batch\">\n+\t<security-role name=\"batchAdmin\">\t\n+\t\t<user name=\"fhiradmin\"/>\t\n+\t</security-role>\n+\t<security-role name=\"batchSubmitter\">\n+\t\t<user name=\"fhiruser\"/>\n+\t</security-role>\n+\t<security-role name=\"batchMonitor\">\n+\t\t<user name=\"fhiradmin\"/>\n+\t\t<user name=\"fhiruser\"/>\n+\t</security-role>\n+</authorization-roles>\n+```\n+Please notice that a user with at least batchSubmitter role should be used for batch-user of bulkdata.json.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 137}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgyMTQ3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345582147", "createdAt": "2020-01-21T00:30:06Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMDowN1rOFfru1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMDowN1rOFfru1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjY3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            By default, in-memory derby database is used for persistence of the JavaBatch Jobs. Instruction is also provided in \"Configuring a Liberty Datasource with API Key\" section of the DB2OnCloudSetup guide to configure DB2 service in IBM Clouds as JavaBatch persistence store. Liberty JavaBath framework creates the Database, DB schema and tables automatically by default for both approaches.   \n          \n          \n            \n            By default, in-memory Derby database is used for persistence of the JavaBatch Jobs. Instruction is also provided in \"Configuring a Liberty Datasource with API Key\" section of the DB2OnCloudSetup guide to configure DB2 service in IBM Clouds as JavaBatch persistence store. Liberty JavaBatch framework creates the Database, DB schema and tables automatically by default for both approaches.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766677", "createdAt": "2020-01-21T00:30:07Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n+  \n+JavaBatch feature must be enabled in server.xml as following for liberty server:\n+\n+```\n+    <!-- Enable features -->\n+    <featureManager>\n+        ...\n+        <feature>batchManagement-1.0</feature>\n+        ...\n+    </featureManager>\n+```\n+And JavaBatch user used in bulkdata.json can be configured in server.xml as following: \n+\n+```    \n+<authorization-roles id=\"com.ibm.ws.batch\">\n+\t<security-role name=\"batchAdmin\">\t\n+\t\t<user name=\"fhiradmin\"/>\t\n+\t</security-role>\n+\t<security-role name=\"batchSubmitter\">\n+\t\t<user name=\"fhiruser\"/>\n+\t</security-role>\n+\t<security-role name=\"batchMonitor\">\n+\t\t<user name=\"fhiradmin\"/>\n+\t\t<user name=\"fhiruser\"/>\n+\t</security-role>\n+</authorization-roles>\n+```\n+Please notice that a user with at least batchSubmitter role should be used for batch-user of bulkdata.json.\n+\n+By default, in-memory derby database is used for persistence of the JavaBatch Jobs. Instruction is also provided in \"Configuring a Liberty Datasource with API Key\" section of the DB2OnCloudSetup guide to configure DB2 service in IBM Clouds as JavaBatch persistence store. Liberty JavaBath framework creates the Database, DB schema and tables automatically by default for both approaches.   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 139}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgyNjE1", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345582615", "createdAt": "2020-01-21T00:32:39Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMjozOVrOFfrwTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMjozOVrOFfrwTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzA1Mw==", "bodyText": "maybe the values that can be set above should be described for the client?\nAlso cos.bucket.prefix ? it seems pretty useful.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767053", "createdAt": "2020-01-21T00:32:39Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgyNjQ3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345582647", "createdAt": "2020-01-21T00:32:49Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMjo0OVrOFfrwag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMjo0OVrOFfrwag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzA4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"contextRoot\" : \"/fhir-server/api/v4\"\n          \n          \n            \n               \"contextRoot\" : \"/fhir-server/api/v4\"", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767082", "createdAt": "2020-01-21T00:32:49Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgyODgz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345582883", "createdAt": "2020-01-21T00:34:13Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozNDoxNFrOFfrxKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozNDoxNFrOFfrxKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzI3Mw==", "bodyText": "just a note to Albert... I'll change this in my PR.  so we don't just force DEFAULT_TENANT_ID", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767273", "createdAt": "2020-01-21T00:34:14Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/processor/impl/CosExportImpl.java", "diffHunk": "@@ -161,13 +163,48 @@ public Parameters exportPatient(String logicalId, MediaType outputFormat, Instan\n         }\n     }\n \n-    // not implemented yet\n     @Override\n     public Parameters exportGroup(String logicalId, MediaType outputFormat, Instant since,\n         List<String> types, List<String> typeFilters, FHIRRequestContext ctx,\n         FHIRResourceHelpers resourceHelper, FHIROperationContext operationContext,\n         BulkDataTenantSpecificCache cache) throws FHIROperationException {\n-        throw new FHIROperationException(\"No $export group operation right now\");\n+\n+        try {\n+            log.fine(\"Using the COS Implementation\");\n+\n+            Map<String, String> properties =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgzMDc1", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345583075", "createdAt": "2020-01-21T00:35:18Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozNToxOFrOFfrxsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozNToxOFrOFfrxsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzQxMA==", "bodyText": "on line 121, can you remove the printstacktrace", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767410", "createdAt": "2020-01-21T00:35:18Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/processor/impl/CosExportImpl.java", "diffHunk": "@@ -161,13 +163,48 @@ public Parameters exportPatient(String logicalId, MediaType outputFormat, Instan\n         }\n     }\n \n-    // not implemented yet\n     @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgzNjM3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345583637", "createdAt": "2020-01-21T00:38:25Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozODoyNVrOFfrzeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozODoyNVrOFfrzeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Nzg2Ng==", "bodyText": "Suggested change", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767866", "createdAt": "2020-01-21T00:38:25Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 112}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgzNzc4", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345583778", "createdAt": "2020-01-21T00:39:14Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOToxNFrOFfrz6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOToxNFrOFfrz6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Nzk3Nw==", "bodyText": "Suggested change", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767977", "createdAt": "2020-01-21T00:39:14Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 184}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgzODE2", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345583816", "createdAt": "2020-01-21T00:39:27Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOToyN1rOFfr0CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOToyN1rOFfr0CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODAwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n          \n          \n            \n                private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768008", "createdAt": "2020-01-21T00:39:27Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 187}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTgzODQ0", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345583844", "createdAt": "2020-01-21T00:39:37Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOTozN1rOFfr0Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOTozN1rOFfr0Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODAzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n          \n          \n            \n                private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768030", "createdAt": "2020-01-21T00:39:37Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 206}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTg0MDQ5", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345584049", "createdAt": "2020-01-21T00:40:45Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MDo0NVrOFfr00w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MDo0NVrOFfr00w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODIxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n          \n          \n            \n                    Group group = findGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768211", "createdAt": "2020-01-21T00:40:45Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset partNum and move resource type index to the next.\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 276}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTg0MDc5", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345584079", "createdAt": "2020-01-21T00:40:55Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MDo1NVrOFfr0_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MDo1NVrOFfr0_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODI1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n          \n          \n            \n                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768252", "createdAt": "2020-01-21T00:40:55Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset partNum and move resource type index to the next.\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+        // List for the patients\n+        List<Member> patientMembers = new ArrayList<>();\n+        // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+        HashSet<String> groupsInPath = new HashSet<>();\n+        ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 281}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTg0MTUw", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345584150", "createdAt": "2020-01-21T00:41:20Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MToyMFrOFfr1OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MToyMFrOFfr1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODMxMg==", "bodyText": "what does setPageNum 2 mean?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768312", "createdAt": "2020-01-21T00:41:20Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset partNum and move resource type index to the next.\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+        // List for the patients\n+        List<Member> patientMembers = new ArrayList<>();\n+        // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+        HashSet<String> groupsInPath = new HashSet<>();\n+        ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(0, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+        }\n+        // The fhir resources of one resource type for all the patients will be exported into one COS object.\n+        // Here we simply set the lastPageNum to be smaller than the next PageNum to ask the common ChunkWriter\n+        // to close the writing for current resource type.\n+        chunkData.setPageNum(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 293}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTg0NDE0", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345584414", "createdAt": "2020-01-21T00:42:38Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MjozOFrOFfr2KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MjozOFrOFfr2KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODU1Mw==", "bodyText": "? gets replaced?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768553", "createdAt": "2020-01-21T00:42:38Z", "author": {"login": "prb112"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTg0NDcz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345584473", "createdAt": "2020-01-21T00:42:53Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0Mjo1NFrOFfr2Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0Mjo1NFrOFfr2Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODYwNw==", "bodyText": "camelcase and visibility modifier?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768607", "createdAt": "2020-01-21T00:42:54Z", "author": {"login": "prb112"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;\n \n-    public static final boolean ON = false;\n-    \n-    @Test(groups = { TEST_GROUP_NAME }, enabled = ON)\n-    public void testBaseExport() throws FHIRGeneratorException, IOException {\n-        Response response =\n-            doPost(BASE_VALID_URL, FHIRMediaType.APPLICATION_FHIR_JSON, FORMAT, Instant.of(\"2019-01-01T08:21:26.94-04:00\"), Arrays.asList(\"Patient\"), null);\n-        assertEquals(response.getStatus(), 202);\n-\n-        // Debug the content-location that's returned. \n-        String contentLocation = response.getHeaderString(\"Content-Location\");\n-        System.out.println(\"Content Location: \" + contentLocation);\n-        \n-        assertEquals(contentLocation, \"/fhir-server/api/v4/$export-status?job=1\");\n-\n-    }\n+    public static final boolean DEBUG = false;\n+    String ExportStatusUrl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTg0NTc3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345584577", "createdAt": "2020-01-21T00:43:23Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MzoyNFrOFfr2tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MzoyNFrOFfr2tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODY5Mw==", "bodyText": "we run these on each Integration test?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768693", "createdAt": "2020-01-21T00:43:24Z", "author": {"login": "prb112"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTg0OTE3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-345584917", "createdAt": "2020-01-21T00:45:22Z", "commit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "184fbe33b9aefcf02e944fa0f40f0812cccf8010", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/184fbe33b9aefcf02e944fa0f40f0812cccf8010", "committedDate": "2020-01-21T13:18:30Z", "message": "issue #618 document updates per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45f4cb78555d4e1bf53ed9f2a5b43cbb447b2922", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/45f4cb78555d4e1bf53ed9f2a5b43cbb447b2922", "committedDate": "2020-01-21T14:19:42Z", "message": "issue #108 #618 updates per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6965fc97e2967ece4f3f8fe0d1d087fce3bbe020", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/6965fc97e2967ece4f3f8fe0d1d087fce3bbe020", "committedDate": "2020-01-21T14:42:31Z", "message": "issue #108 enable export test in pipeline\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9df819f42512da12a3c910cea2e571887d8a097", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/f9df819f42512da12a3c910cea2e571887d8a097", "committedDate": "2020-01-21T15:31:32Z", "message": "issue #108 remove db2 config for JavaBatch\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e22edf066d7a58943d54b68b9d35f07d217eed4", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/4e22edf066d7a58943d54b68b9d35f07d217eed4", "committedDate": "2020-01-21T15:55:43Z", "message": "Merge pull request #622 from IBM/master\n\nfetch most current master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3bba30aad14547373aaaaf954baa2ec70f3c4d1", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/d3bba30aad14547373aaaaf954baa2ec70f3c4d1", "committedDate": "2020-01-21T18:43:56Z", "message": "issue #108 fix config issues\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/6f2466f7cb0177e0b74f27b9afba812caec290d1", "committedDate": "2020-01-21T19:25:12Z", "message": "issue #108 remove export test from testng to allow pipeline pass\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTQ0ODUx", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346144851", "createdAt": "2020-01-21T19:47:11Z", "commit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo0NzoxMlrOFgGnXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo0NzoxMlrOFgGnXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwNzEzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n          \n          \n            \n            BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n          \n      \n    \n    \n  \n\nsorry - I realized I gave a bad edit before", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369207134", "createdAt": "2020-01-21T19:47:12Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTQ2OTcz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346146973", "createdAt": "2020-01-21T19:50:35Z", "commit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1MDozNVrOFgGt_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1MDozNVrOFgGt_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwODgzMA==", "bodyText": "Why can't the fhirbatchDS exist here? I suggest we comment it out, and remove server-withDb2JavaBatch.xml", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369208830", "createdAt": "2020-01-21T19:50:35Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -190,23 +190,6 @@\n     </dataSource>\n     -->\n \n-    <dataSource id=\"fhirbatchDS\" jndiName=\"jdbc/fhirbatchDB\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTUwNzQ0", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346150744", "createdAt": "2020-01-21T19:56:27Z", "commit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1NjoyN1rOFgG56w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1NjoyN1rOFgG56w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMTg4Mw==", "bodyText": "<!--Host name part of the server generated polling location url -->\n  \"contextRoot\" : \"/fhir-server/api/v4\"\t\t   <!--Context root part of the server generated polling location url -->\n}\n\nI think these comments should be outside of the JSON", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369211883", "createdAt": "2020-01-21T19:56:27Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\t       <!--Host name part of the server generated polling location url -->\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\t\t   <!--Context root part of the server generated polling location url -->\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTU0MzQ1", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346154345", "createdAt": "2020-01-21T20:02:13Z", "commit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDowMjoxM1rOFgHE_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDowMjoxM1rOFgHE_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxNDcxNw==", "bodyText": "these elements should be described in a table.\n\n\n\nParameter Name\nDescription\n\n\n\n\napplicationName\nfixed value\n\n\nmoduleName\nfixed value\n\n\njobParameters.cos.bucket.name\nfixed value\n\n\njobParameters.cos.location\nfixed value\n\n\njobParameters.cos.endpointurl\nfixed value\n\n\njobParameters.credential.ibm\nfixed value\n\n\njobParameters.cos.api.key\nfixed value\n\n\njobParameters.cos.srvinst.id\nfixed value\n\n\nimplementation_type\nfixed value\n\n\nbatch-uri\nfixed value\n\n\nbatch-user\nfixed value\n\n\nbatch-user-password\nfixed value\n\n\nbatch-truststore\nfixed value\n\n\nbatch-truststore-password\nfixed value\n\n\nserverHostname\nfixed value\n\n\ncontextRoot\nfixed value", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369214717", "createdAt": "2020-01-21T20:02:13Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "154e61301388bdecc5313d6b7415383e6c41c209", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/154e61301388bdecc5313d6b7415383e6c41c209", "committedDate": "2020-01-21T20:07:54Z", "message": "issue #618 updated document per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1616ff4967c5d1430a53a5e53cb6f1b44d2fc702", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/1616ff4967c5d1430a53a5e53cb6f1b44d2fc702", "committedDate": "2020-01-21T20:29:08Z", "message": "issue #108 use optional included config for javabatch db\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/94d170953ff21bce3925e5d564778cffadb097f7", "committedDate": "2020-01-21T20:55:34Z", "message": "issue #618 add more comments for job parameters\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTkwNzYw", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346190760", "createdAt": "2020-01-21T21:06:02Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODM1OTYx", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346835961", "createdAt": "2020-01-22T19:15:13Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNToxM1rOFgn2YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNToxM1rOFgn2YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MTY0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              * [4.10 BulkData](#410-bulkdata)\n          \n          \n            \n              * [4.10 Bulk data operations](#410-bulk-data-operations)", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369751649", "createdAt": "2020-01-22T19:15:13Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -27,7 +27,8 @@ permalink: /FHIRServerUsersGuide/\n   * [4.7 FHIR command-line interface (fhir-cli)](#47-fhir-command-line-interface-fhir-cli)\n   * [4.8 Using local references within request bundles](#48-using-local-references-within-request-bundles)\n   * [4.9 Multi-tenancy](#49-multi-tenancy)\n-  * [4.10 CADF audit logging service](#410-CADF-audit-logging-service)\n+  * [4.10 BulkData](#410-bulkdata)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODM2NzYx", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346836761", "createdAt": "2020-01-22T19:16:33Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNjozM1rOFgn5AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNjozM1rOFgn5AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MjMyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              * [4.11 CADF audit logging service](#410-CADF-audit-logging-service)\n          \n          \n            \n              * [4.11 CADF audit logging service](#411-CADF-audit-logging-service)", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369752321", "createdAt": "2020-01-22T19:16:33Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -27,7 +27,8 @@ permalink: /FHIRServerUsersGuide/\n   * [4.7 FHIR command-line interface (fhir-cli)](#47-fhir-command-line-interface-fhir-cli)\n   * [4.8 Using local references within request bundles](#48-using-local-references-within-request-bundles)\n   * [4.9 Multi-tenancy](#49-multi-tenancy)\n-  * [4.10 CADF audit logging service](#410-CADF-audit-logging-service)\n+  * [4.10 BulkData](#410-bulkdata)\n+  * [4.11 CADF audit logging service](#410-CADF-audit-logging-service)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODM3MDAz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346837003", "createdAt": "2020-01-22T19:16:57Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNjo1OFrOFgn5vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNjo1OFrOFgn5vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MjUxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ## 4.10 BulkData\n          \n          \n            \n            ## 4.10 Bulk data operations", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369752511", "createdAt": "2020-01-22T19:16:58Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODM3NzEy", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346837712", "createdAt": "2020-01-22T19:18:05Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxODowNVrOFgn7_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxODowNVrOFgn7_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MzA4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ### 4.10.1 BulkData Export\n          \n          \n            \n            ### 4.10.1 Bulk data export", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369753085", "createdAt": "2020-01-22T19:18:05Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODM4NjQ0", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346838644", "createdAt": "2020-01-22T19:19:32Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxOTozMlrOFgn-sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxOTozMlrOFgn-sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1Mzc3Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n          \n          \n            \n            Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369753776", "createdAt": "2020-01-22T19:19:32Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODM5MTIy", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346839122", "createdAt": "2020-01-22T19:20:17Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyMDoxOFrOFgoAFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyMDoxOFrOFgoAFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1NDEzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n          \n          \n            \n            To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369754132", "createdAt": "2020-01-22T19:20:18Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODQwNjg2", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346840686", "createdAt": "2020-01-22T19:22:49Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyMjo0OVrOFgoExw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyMjo0OVrOFgoExw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1NTMzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n          \n          \n            \n            The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n          \n          \n            \n            * ExportOperation - system export\n          \n          \n            \n            * PatientExportOperation - Patient export\n          \n          \n            \n            * GroupExportOperation - group export.\n          \n          \n            \n            Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369755335", "createdAt": "2020-01-22T19:22:49Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODQxNzk3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346841797", "createdAt": "2020-01-22T19:24:34Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyNDozNVrOFgoIZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyNDozNVrOFgoIZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1NjI2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n          \n          \n            \n            The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369756263", "createdAt": "2020-01-22T19:24:35Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODQ0MTcz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346844173", "createdAt": "2020-01-22T19:28:20Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyODoyMFrOFgoPyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyODoyMFrOFgoPyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODE1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n          \n          \n            \n            To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369758153", "createdAt": "2020-01-22T19:28:20Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODY4Mjkw", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-346868290", "createdAt": "2020-01-22T20:07:33Z", "commit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDowNzozNFrOFgpYjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDowNzozNFrOFgpYjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3Njc4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369776782", "createdAt": "2020-01-22T20:07:34Z", "author": {"login": "lmsurpre"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,323 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cfad480ccd71ea1cacaa36f0618e5a3a8d05129", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/9cfad480ccd71ea1cacaa36f0618e5a3a8d05129", "committedDate": "2020-01-22T20:08:43Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2205ebcb971600b4ef48a31dafca5f5d28d7768", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/e2205ebcb971600b4ef48a31dafca5f5d28d7768", "committedDate": "2020-01-22T20:11:09Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd471ae28b1dfb80024941d9f44242c88fe034f", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/abd471ae28b1dfb80024941d9f44242c88fe034f", "committedDate": "2020-01-22T20:11:28Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9893c32fbfd42697a192bb9ea2ddfbe94d3724d0", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/9893c32fbfd42697a192bb9ea2ddfbe94d3724d0", "committedDate": "2020-01-22T20:12:06Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcb855bd23804549796909a1977190458f5ed86c", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/fcb855bd23804549796909a1977190458f5ed86c", "committedDate": "2020-01-22T20:12:31Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "666b17823ce47ba3a93f6c2b35faae72922aaa23", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/666b17823ce47ba3a93f6c2b35faae72922aaa23", "committedDate": "2020-01-22T20:12:54Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cb6259a12b83e750e37e00fde69aaeae6102d9e", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/2cb6259a12b83e750e37e00fde69aaeae6102d9e", "committedDate": "2020-01-22T20:13:13Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4abcf9e42921c975378a9d3bfe9280a0f80f4cd", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/a4abcf9e42921c975378a9d3bfe9280a0f80f4cd", "committedDate": "2020-01-22T20:13:45Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2521ee541f65036241189df925208ef51ca4d23", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/b2521ee541f65036241189df925208ef51ca4d23", "committedDate": "2020-01-22T20:14:24Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ea77cf94259eff32d85395f97501af3ae5e46c4", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/4ea77cf94259eff32d85395f97501af3ae5e46c4", "committedDate": "2020-01-22T20:14:47Z", "message": "Update fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2383da13041b59d74156c0c4306729dd54b63d47", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/2383da13041b59d74156c0c4306729dd54b63d47", "committedDate": "2020-01-23T03:45:03Z", "message": "issue #108 added paging support for the group members\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "380d727f9a68588844e74d86a84a29ae5766b049", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/380d727f9a68588844e74d86a84a29ae5766b049", "committedDate": "2020-01-23T03:52:23Z", "message": "Merge branch 'Albert-Master-New' of git@github.com:IBM/FHIR.git into Albert-Master-New"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/3f7248a159d479d2f59db706924fd31293a809bd", "committedDate": "2020-01-23T13:07:32Z", "message": "issue #108 one minor fix\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzE4NjA5", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347318609", "createdAt": "2020-01-23T14:04:28Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNDoyOFrOFg_PHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNDoyOFrOFg_PHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNDgxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n          \n          \n            \n            The *fhir-operation-bulkdata* module implements the REST APIs for bulk data export as FHIR operations.  There are three operations:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370134815", "createdAt": "2020-01-23T14:04:28Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzE5MDk3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347319097", "createdAt": "2020-01-23T14:05:07Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNTowN1rOFg_Qdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNTowN1rOFg_Qdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNTE1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n          \n      \n    \n    \n  \n\nI think this should be removed.  I don't think it's necessary, maybe include as a readme in the bulkdata operation module.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370135159", "createdAt": "2020-01-23T14:05:07Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzE5NzMx", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347319731", "createdAt": "2020-01-23T14:06:02Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNjowM1rOFg_Scw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNjowM1rOFg_Scw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNTY2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n          \n          \n            \n            Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* module to execute the export unit-of-work.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370135667", "createdAt": "2020-01-23T14:06:03Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzE5ODg3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347319887", "createdAt": "2020-01-23T14:06:15Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNjoxNlrOFg_S7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNjoxNlrOFg_S7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNTc5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n          \n          \n            \n            There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* module for the above 3 export operations:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370135790", "createdAt": "2020-01-23T14:06:16Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzIwODM3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347320837", "createdAt": "2020-01-23T14:07:24Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNzoyNFrOFg_VYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNzoyNFrOFg_VYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNjQxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            The following configured parameters are:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370136418", "createdAt": "2020-01-23T14:07:24Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzIxNDMz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347321433", "createdAt": "2020-01-23T14:08:11Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODoxMVrOFg_XCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODoxMVrOFg_XCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNjg0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`implementation_type`| fixed value |\n          \n          \n            \n            |`implementation_type`| cos or dummy which matches the desired bulk operation implementation type |", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370136840", "createdAt": "2020-01-23T14:08:11Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzIxNzY1", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347321765", "createdAt": "2020-01-23T14:08:37Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODozN1rOFg_X9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODozN1rOFg_X9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNzA3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`batch-uri`| fixed value |\n          \n          \n            \n            |`batch-uri`| the URL to access the FHIR server hosting the batch web application |", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370137079", "createdAt": "2020-01-23T14:08:37Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzIyMDM5", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347322039", "createdAt": "2020-01-23T14:08:59Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODo1OVrOFg_Y2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODo1OVrOFg_Y2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNzMwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`applicationName`| fixed value |\n          \n          \n            \n            |`applicationName`| fixed value, always set to fhir-bulkimportexport-webapp |", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370137307", "createdAt": "2020-01-23T14:08:59Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzIyMzE2", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347322316", "createdAt": "2020-01-23T14:09:20Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowOToyMFrOFg_ZpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowOToyMFrOFg_ZpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNzUwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`moduleName`| fixed value |\n          \n          \n            \n            |`moduleName`| fixed value, always set to fhir-bulkimportexport.war |", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370137509", "createdAt": "2020-01-23T14:09:20Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzIzMDAw", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347323000", "createdAt": "2020-01-23T14:10:11Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDoxMVrOFg_bgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDoxMVrOFg_bgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNzk4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n          \n          \n            \n            .../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370137984", "createdAt": "2020-01-23T14:10:11Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzIzMjk3", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347323297", "createdAt": "2020-01-23T14:10:37Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDozN1rOFg_cZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDozN1rOFg_cZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzODIxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t...", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370138215", "createdAt": "2020-01-23T14:10:37Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```json\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+\t...", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzIzNDI2", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347323426", "createdAt": "2020-01-23T14:10:48Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDo0OFrOFg_cyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDo0OFrOFg_cyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzODMxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"count\": 81},\n          \n          \n            \n                \"count\": 81}", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370138312", "createdAt": "2020-01-23T14:10:48Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```json\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzI0Nzkx", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347324791", "createdAt": "2020-01-23T14:12:35Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMjozNVrOFg_g4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMjozNVrOFg_g4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzOTM2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n          \n          \n            \n            The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please note that IBM COS does not support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. For both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370139362", "createdAt": "2020-01-23T14:12:35Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```json\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+\t...\n+}\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 118}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzI2NjQ4", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347326648", "createdAt": "2020-01-23T14:15:03Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxNTowM1rOFg_mXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxNTowM1rOFg_mXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MDc2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n          \n          \n            \n                                        chunkData.getBufferStream().write(Constants.NDJSON_LINESEPARATOR.getBytes());\n          \n      \n    \n    \n  \n\nWhy not make the NDJSON_LINESEPARATOR bytes anyway?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370140764", "createdAt": "2020-01-23T14:15:03Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzI3NDY5", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347327469", "createdAt": "2020-01-23T14:16:07Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxNjowN1rOFg_oxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxNjowN1rOFg_oxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MTM4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            List<String> searchCreterial = new ArrayList<String>();\n          \n          \n            \n                            List<String> searchCriteria = new ArrayList<String>();", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370141381", "createdAt": "2020-01-23T14:16:07Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 134}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzI5NTYw", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347329560", "createdAt": "2020-01-23T14:18:48Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxODo0OFrOFg_u8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxODo0OFrOFg_u8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0Mjk2Mw==", "bodyText": "shouldn't this throw a more specific exception?  more easily differentiating in code downstream?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370142963", "createdAt": "2020-01-23T14:18:48Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 183}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzMwMDA0", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347330004", "createdAt": "2020-01-23T14:19:20Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxOToyMFrOFg_wPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxOToyMFrOFg_wPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MzI5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n          \n          \n            \n                private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, Set<String> groupsInPath)", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370143293", "createdAt": "2020-01-23T14:19:20Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 187}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzMxOTM4", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347331938", "createdAt": "2020-01-23T14:21:48Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMTo0OFrOFg_16Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMTo0OFrOFg_16Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NDc0NQ==", "bodyText": "I think we should throw an exception.  This could lead to unintended consequences.  if a tenant is not passed in, it should be treated as invalid.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370144745", "createdAt": "2020-01-23T14:21:48Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 260}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzMyODQz", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347332843", "createdAt": "2020-01-23T14:22:56Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMjo1N1rOFg_4iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMjo1N1rOFg_4iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NTQxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n          \n          \n            \n                            logger.warning(\"readItem: Set page size to default [\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \"]\");\n          \n      \n    \n    \n  \n\ngeneral pattern", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370145417", "createdAt": "2020-01-23T14:22:57Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 273}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MzMzNjQ1", "url": "https://github.com/IBM/FHIR/pull/594#pullrequestreview-347333645", "createdAt": "2020-01-23T14:23:55Z", "commit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMzo1NlrOFg_6uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMzo1NlrOFg_6uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NTk3OQ==", "bodyText": "maybe add a logger.fine for debug purposes?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370145979", "createdAt": "2020-01-23T14:23:56Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        if (patientMembers == null) {\n+            Group group = findGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+            patientMembers = new ArrayList<>();\n+            // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+            HashSet<String> groupsInPath = new HashSet<>();\n+            expandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+        }\n+        List<Member> patientPageMembers = patientMembers.subList((pageNum - 1) * pageSize,\n+                pageNum * pageSize <= patientMembers.size() ? pageNum * pageSize : patientMembers.size());\n+        pageNum++;\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(pageNum, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+            chunkData.setPageNum(pageNum);\n+        }\n+        chunkData.setLastPageNum((patientMembers.size() + pageSize -1)/pageSize );\n+\n+        if (!patientPageMembers.isEmpty()) {\n+            logger.fine(\"readItem: loaded patients number - \" + patientMembers.size());\n+            fillChunkDataBuffer(patientPageMembers);\n+        } else {\n+            logger.fine(\"readItem: End of reading!\");\n+        }\n+\n+        return patientPageMembers;\n+    }\n+\n+    @Override\n+    public void open(Serializable checkpoint) throws Exception {\n+        if (checkpoint != null) {\n+            CheckPointUserData checkPointData = (CheckPointUserData) checkpoint;\n+            pageNum = checkPointData.getPageNum();\n+            indexOfCurrentResourceType = checkPointData.getIndexOfCurrentResourceType();\n+            jobContext.setTransientUserData(TransientUserData.fromCheckPointUserData(checkPointData));\n+        }\n+    }\n+\n+    @Override\n+    public void close() throws Exception {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 320}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac5d50b24ed03d9841411aef2fb395891fea31c4", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/ac5d50b24ed03d9841411aef2fb395891fea31c4", "committedDate": "2020-01-23T14:28:25Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf2fabcbf2c87159f81316a936c9a7e14411889f", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/cf2fabcbf2c87159f81316a936c9a7e14411889f", "committedDate": "2020-01-23T14:29:25Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fa6b3223bb7bfb14048beffebd9ddc09aa0f2fa", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/4fa6b3223bb7bfb14048beffebd9ddc09aa0f2fa", "committedDate": "2020-01-23T14:32:59Z", "message": "Update docs/src/pages/guides/FHIRServerUsersGuide.md\r\n\r\nSigned-off-by: Albert Wang xuwang@us.ibm.com\n\nCo-Authored-By: Paul Bastide <pbastide@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 633, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}