{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NTMwODc4", "number": 1687, "title": "fix: allocate-tenant fails when run twice", "bodyText": "Signed-off-by: Paul Bastide pbastide@us.ibm.com", "createdAt": "2020-11-10T14:32:20Z", "url": "https://github.com/IBM/FHIR/pull/1687", "merged": true, "mergeCommit": {"oid": "311aca73ca959ba86e20333f740cdab2623d0846"}, "closed": true, "closedAt": "2020-11-10T16:11:37Z", "author": {"login": "prb112"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbKQIwAH2gAyNTE4NTMwODc4OjMyMzg3YTAzZmQxNzI1OWRhMzQ2YmYwZjFmYTZiNGVmYTg2ODZlODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbLrsIAFqTUyNzM2NDIwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/32387a03fd17259da346bf0f1fa6b4efa8686e81", "committedDate": "2020-11-10T14:29:52Z", "message": "fix: allocate-tenant fails when run twice\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mjc2MzE1", "url": "https://github.com/IBM/FHIR/pull/1687#pullrequestreview-527276315", "createdAt": "2020-11-10T14:46:43Z", "commit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo0Njo0M1rOHwgAug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo0Njo0M1rOHwgAug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYxODE3MA==", "bodyText": "As this is being run as maintenance task I supposed we're not going to be too worried about concurrency. Selecting first then inserting what's missing isn't thread-safe but it's probably not a big deal here.", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520618170", "createdAt": "2020-11-10T14:46:43Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -52,15 +54,27 @@ public PopulateParameterNames(String adminSchemaName, String schemaName, Integer\n     public void run(IDatabaseTranslator translator, Connection c) {\n         final String stmtVariable = String.format(\"SET %s.SV_TENANT_ID = %d\", adminSchemaName, tenantId);\n         final String stmtResourceTypeInsert;\n+        final String PARAMETER_NAMES = String.format(\"SELECT PARAMETER_NAME_ID, PARAMETER_NAME FROM %s.parameter_names\", schemaName);\n         if (tenantId != null) {\n             stmtResourceTypeInsert =\n                     String.format(\"INSERT INTO %s.parameter_names (MT_ID, PARAMETER_NAME_ID, PARAMETER_NAME) \"\n                             + \"VALUES (%s.sv_tenant_id, ?, ?)\", schemaName, adminSchemaName);\n         } else {\n             stmtResourceTypeInsert =\n-                    String.format(\n-                            \"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\",\n-                            schemaName);\n+                    String.format(\"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\", schemaName);\n+        }\n+\n+        Map<String, Integer> values = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mjg0NTUy", "url": "https://github.com/IBM/FHIR/pull/1687#pullrequestreview-527284552", "createdAt": "2020-11-10T14:54:20Z", "commit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1NDoyMFrOHwgYqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1NDoyMFrOHwgYqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNDI5OA==", "bodyText": "Parameter", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520624298", "createdAt": "2020-11-10T14:54:20Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -76,26 +90,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n-                    batch.setLong(1, curVal);\n-                    batch.setString(2, code);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(code)) {\n+                        batch.setLong(1, curVal);\n+                        batch.setString(2, code);\n+                        batch.addBatch();\n+                        numToProcess++;\n                     }\n                 }\n-                if (errorCodes > 0) {\n-                    String msg = \"at least one of the Paramater Name/Codes are not populated [\" + errorCodes + \"]\";\n-                    LOGGER.severe(msg);\n-                    throw new IllegalArgumentException(msg);\n+\n+                // Only execute with num to process\n+                if (numToProcess > 0) {\n+                    // Check Error Codes.\n+                    int[] codes = batch.executeBatch();\n+                    int errorCodes = 0;\n+                    for (int code : codes) {\n+                        if (code < 0) {\n+                            errorCodes++;\n+                        }\n+                    }\n+                    if (errorCodes > 0) {\n+                        String msg = \"at least one of the Paramater Name/Codes are not populated [\" + errorCodes + \"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mjg4OTM0", "url": "https://github.com/IBM/FHIR/pull/1687#pullrequestreview-527288934", "createdAt": "2020-11-10T14:58:30Z", "commit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1ODozMFrOHwglzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1ODozMFrOHwglzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNzY2MQ==", "bodyText": "Shouldn't this be\n   if (!values.containsKey(code))", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520627661", "createdAt": "2020-11-10T14:58:30Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -76,26 +90,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n-                    batch.setLong(1, curVal);\n-                    batch.setString(2, code);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(code)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mjg5NTU4", "url": "https://github.com/IBM/FHIR/pull/1687#pullrequestreview-527289558", "createdAt": "2020-11-10T14:59:02Z", "commit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1OTowM1rOHwgnng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1OTowM1rOHwgnng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyODEyNg==", "bodyText": "Shouldn't this be\n   if (!values.containsKey(code))", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520628126", "createdAt": "2020-11-10T14:59:03Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java", "diffHunk": "@@ -66,26 +82,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String resource = (String) valueEntry.getKey();\n-                    batch.setInt(1, curVal);\n-                    batch.setString(2, resource);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(resource)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd6ee0573822ed84ae875143e04f783c12854f49", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/fd6ee0573822ed84ae875143e04f783c12854f49", "committedDate": "2020-11-10T15:12:17Z", "message": "fix: bad logic found in code review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MzY0MjA5", "url": "https://github.com/IBM/FHIR/pull/1687#pullrequestreview-527364209", "createdAt": "2020-11-10T16:09:52Z", "commit": {"oid": "fd6ee0573822ed84ae875143e04f783c12854f49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 764, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}