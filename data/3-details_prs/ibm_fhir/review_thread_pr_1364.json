{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MzAzMzM4", "number": 1364, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0MDo1MlrOESfYyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0MjoxMlrOESfapg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODI0MDc1OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/TimestampPrefixedUUID.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0MDo1MlrOG3s0dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODowMjo0NlrOG3tlbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1OTE4OA==", "bodyText": "Does this impact any regular expressions? or potentially any fhir path?\nDoes it impact FHIR Uuid type?\nprivate static final Pattern PATTERN = Pattern.compile(\"urn:uuid:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\");.", "url": "https://github.com/IBM/FHIR/pull/1364#discussion_r461059188", "createdAt": "2020-07-27T17:40:52Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/TimestampPrefixedUUID.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.persistence.jdbc.util;\n+\n+import java.util.UUID;\n+\n+/**\n+ * Provides identity strings using random UUID for uniqueness but\n+ * prefixed with an encoded time string to improve database locality\n+ * when used in b-tree indexes.\n+ */\n+public class TimestampPrefixedUUID implements LogicalIdentityProvider {\n+\n+    @Override\n+    public String createNewIdentityValue() {\n+        // It's OK to use milli-time here. It doesn't matter too much if the time changes\n+        // because we're not using the timestamp to determine uniqueness in any way. The\n+        // timestamp prefix is purely to help push index writes to the right hand side\n+        // of the btree, minimizing the number of physical reads likely required \n+        // during ingestion when an index is too large to be fully cached.\n+        long millis = System.currentTimeMillis();\n+        \n+        // String encoding. Needs to collate correctly, so don't use any\n+        // byte-based encoding which would be sensitive to endian issues. For simplicity,\n+        // hex is sufficient, although a custom encoding using the full character set\n+        // supported by FHIR identifiers would be a little more compact (== smaller indexes).\n+        // Do not use Base64.\n+        String prefix = Long.toHexString(millis);\n+        \n+        UUID uuid = UUID.randomUUID();\n+        \n+        StringBuilder result = new StringBuilder();\n+        result.append(prefix);\n+        result.append(\"-\"); // redundant, but more visually appealing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92afad88849674dfd27ffc1acd83c8369a5ba9e6"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTc0MA==", "bodyText": "Resource.id is a system string with a hinted type of https://www.hl7.org/fhir/datatypes.html#id (and not UUID), so as long as we only use it for that, then I think we're OK on this one.", "url": "https://github.com/IBM/FHIR/pull/1364#discussion_r461065740", "createdAt": "2020-07-27T17:52:26Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/TimestampPrefixedUUID.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.persistence.jdbc.util;\n+\n+import java.util.UUID;\n+\n+/**\n+ * Provides identity strings using random UUID for uniqueness but\n+ * prefixed with an encoded time string to improve database locality\n+ * when used in b-tree indexes.\n+ */\n+public class TimestampPrefixedUUID implements LogicalIdentityProvider {\n+\n+    @Override\n+    public String createNewIdentityValue() {\n+        // It's OK to use milli-time here. It doesn't matter too much if the time changes\n+        // because we're not using the timestamp to determine uniqueness in any way. The\n+        // timestamp prefix is purely to help push index writes to the right hand side\n+        // of the btree, minimizing the number of physical reads likely required \n+        // during ingestion when an index is too large to be fully cached.\n+        long millis = System.currentTimeMillis();\n+        \n+        // String encoding. Needs to collate correctly, so don't use any\n+        // byte-based encoding which would be sensitive to endian issues. For simplicity,\n+        // hex is sufficient, although a custom encoding using the full character set\n+        // supported by FHIR identifiers would be a little more compact (== smaller indexes).\n+        // Do not use Base64.\n+        String prefix = Long.toHexString(millis);\n+        \n+        UUID uuid = UUID.randomUUID();\n+        \n+        StringBuilder result = new StringBuilder();\n+        result.append(prefix);\n+        result.append(\"-\"); // redundant, but more visually appealing.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1OTE4OA=="}, "originalCommit": {"oid": "92afad88849674dfd27ffc1acd83c8369a5ba9e6"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NjI0OQ==", "bodyText": "It shouldn't, because identifiers are constrained by a different pattern according to the spec.", "url": "https://github.com/IBM/FHIR/pull/1364#discussion_r461066249", "createdAt": "2020-07-27T17:53:11Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/TimestampPrefixedUUID.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.persistence.jdbc.util;\n+\n+import java.util.UUID;\n+\n+/**\n+ * Provides identity strings using random UUID for uniqueness but\n+ * prefixed with an encoded time string to improve database locality\n+ * when used in b-tree indexes.\n+ */\n+public class TimestampPrefixedUUID implements LogicalIdentityProvider {\n+\n+    @Override\n+    public String createNewIdentityValue() {\n+        // It's OK to use milli-time here. It doesn't matter too much if the time changes\n+        // because we're not using the timestamp to determine uniqueness in any way. The\n+        // timestamp prefix is purely to help push index writes to the right hand side\n+        // of the btree, minimizing the number of physical reads likely required \n+        // during ingestion when an index is too large to be fully cached.\n+        long millis = System.currentTimeMillis();\n+        \n+        // String encoding. Needs to collate correctly, so don't use any\n+        // byte-based encoding which would be sensitive to endian issues. For simplicity,\n+        // hex is sufficient, although a custom encoding using the full character set\n+        // supported by FHIR identifiers would be a little more compact (== smaller indexes).\n+        // Do not use Base64.\n+        String prefix = Long.toHexString(millis);\n+        \n+        UUID uuid = UUID.randomUUID();\n+        \n+        StringBuilder result = new StringBuilder();\n+        result.append(prefix);\n+        result.append(\"-\"); // redundant, but more visually appealing.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1OTE4OA=="}, "originalCommit": {"oid": "92afad88849674dfd27ffc1acd83c8369a5ba9e6"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3MTcyNw==", "bodyText": "Works for me", "url": "https://github.com/IBM/FHIR/pull/1364#discussion_r461071727", "createdAt": "2020-07-27T18:02:46Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/TimestampPrefixedUUID.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.persistence.jdbc.util;\n+\n+import java.util.UUID;\n+\n+/**\n+ * Provides identity strings using random UUID for uniqueness but\n+ * prefixed with an encoded time string to improve database locality\n+ * when used in b-tree indexes.\n+ */\n+public class TimestampPrefixedUUID implements LogicalIdentityProvider {\n+\n+    @Override\n+    public String createNewIdentityValue() {\n+        // It's OK to use milli-time here. It doesn't matter too much if the time changes\n+        // because we're not using the timestamp to determine uniqueness in any way. The\n+        // timestamp prefix is purely to help push index writes to the right hand side\n+        // of the btree, minimizing the number of physical reads likely required \n+        // during ingestion when an index is too large to be fully cached.\n+        long millis = System.currentTimeMillis();\n+        \n+        // String encoding. Needs to collate correctly, so don't use any\n+        // byte-based encoding which would be sensitive to endian issues. For simplicity,\n+        // hex is sufficient, although a custom encoding using the full character set\n+        // supported by FHIR identifiers would be a little more compact (== smaller indexes).\n+        // Do not use Base64.\n+        String prefix = Long.toHexString(millis);\n+        \n+        UUID uuid = UUID.randomUUID();\n+        \n+        StringBuilder result = new StringBuilder();\n+        result.append(prefix);\n+        result.append(\"-\"); // redundant, but more visually appealing.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1OTE4OA=="}, "originalCommit": {"oid": "92afad88849674dfd27ffc1acd83c8369a5ba9e6"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODI0NTUwOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0MjoxMlrOG3s3QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODowNzo0MVrOG3tv-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1OTkwNA==", "bodyText": "For ResourceDAOImpl, Also what about line 518? stmt.setString(6, UUID.randomUUID().toString());", "url": "https://github.com/IBM/FHIR/pull/1364#discussion_r461059904", "createdAt": "2020-07-27T17:42:12Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -278,7 +283,7 @@ protected Action buildActionChain() {\n             // system-generated value. For the update-or-create scenario, see update().\n             // Default version is 1 for a brand new FHIR Resource.\n             int newVersionNumber = 1;\n-            logicalId = UUID.randomUUID().toString();\n+            logicalId = logicalIdentityProvider.createNewIdentityValue();\n             if (log.isLoggable(Level.FINE)) {\n                 log.fine(\"Creating new FHIR Resource of type '\" + resource.getClass().getSimpleName() + \"'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92afad88849674dfd27ffc1acd83c8369a5ba9e6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MjI4Mg==", "bodyText": "Also DerbyResourceDao on 117?  PostgreSqlResourceDAO 112\nFHIRRestHelper 329? id = UUID.randomUUID().toString(); (lots of instances there)", "url": "https://github.com/IBM/FHIR/pull/1364#discussion_r461062282", "createdAt": "2020-07-27T17:46:27Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -278,7 +283,7 @@ protected Action buildActionChain() {\n             // system-generated value. For the update-or-create scenario, see update().\n             // Default version is 1 for a brand new FHIR Resource.\n             int newVersionNumber = 1;\n-            logicalId = UUID.randomUUID().toString();\n+            logicalId = logicalIdentityProvider.createNewIdentityValue();\n             if (log.isLoggable(Level.FINE)) {\n                 log.fine(\"Creating new FHIR Resource of type '\" + resource.getClass().getSimpleName() + \"'\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1OTkwNA=="}, "originalCommit": {"oid": "92afad88849674dfd27ffc1acd83c8369a5ba9e6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTU1Nw==", "bodyText": "Yikes...no idea why we'd be manipulating data values in the DAO...good catch...will check", "url": "https://github.com/IBM/FHIR/pull/1364#discussion_r461065557", "createdAt": "2020-07-27T17:52:04Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -278,7 +283,7 @@ protected Action buildActionChain() {\n             // system-generated value. For the update-or-create scenario, see update().\n             // Default version is 1 for a brand new FHIR Resource.\n             int newVersionNumber = 1;\n-            logicalId = UUID.randomUUID().toString();\n+            logicalId = logicalIdentityProvider.createNewIdentityValue();\n             if (log.isLoggable(Level.FINE)) {\n                 log.fine(\"Creating new FHIR Resource of type '\" + resource.getClass().getSimpleName() + \"'\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1OTkwNA=="}, "originalCommit": {"oid": "92afad88849674dfd27ffc1acd83c8369a5ba9e6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3NDQyNg==", "bodyText": "That's the sourceKey which was previously used to ensure idempotence in replication scenarios. It is no longer used and can be removed. Will create a new issue. It is benign here.", "url": "https://github.com/IBM/FHIR/pull/1364#discussion_r461074426", "createdAt": "2020-07-27T18:07:41Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -278,7 +283,7 @@ protected Action buildActionChain() {\n             // system-generated value. For the update-or-create scenario, see update().\n             // Default version is 1 for a brand new FHIR Resource.\n             int newVersionNumber = 1;\n-            logicalId = UUID.randomUUID().toString();\n+            logicalId = logicalIdentityProvider.createNewIdentityValue();\n             if (log.isLoggable(Level.FINE)) {\n                 log.fine(\"Creating new FHIR Resource of type '\" + resource.getClass().getSimpleName() + \"'\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1OTkwNA=="}, "originalCommit": {"oid": "92afad88849674dfd27ffc1acd83c8369a5ba9e6"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4773, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}