{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NTgwNTY0", "number": 556, "title": "issue #160 conditional read support", "bodyText": "Added full support for conditional read:\n(1) Support If-Modified-Since\nSupport RFC_1123, RFC_850, ANSIC and touchstone date time formats.\n(2) Support If-None-Match\nSupport ETag value with or without \" (and W/)\ne.g:  1, \"1\", W/1, W/\"1\" (the first format is used by TouchStone)\nAdded statement  of conditional read full support to server capability.\nAdded server integrations tests for conditional read.\nFixed the date time format of Last-Modified response header.\nUpdated last-modified response header test codes accordingly.", "createdAt": "2020-01-06T15:04:59Z", "url": "https://github.com/IBM/FHIR/pull/556", "merged": true, "mergeCommit": {"oid": "d288d15a556a63e0eaa58b98dc36bd1c3c3bceeb"}, "closed": true, "closedAt": "2020-01-07T19:12:30Z", "author": {"login": "albertwang-ibm"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2aQStAH2gAyMzU5NTgwNTY0OjRlYjE0YThiNDkyNDc1OGQ2ZDkxY2U5MWE4MWRjZDNjNmYxM2ZkMzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4YojJAFqTM0MDAxNzMwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4eb14a8b4924758d6d91ce91a81dcd3c6f13fd34", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/4eb14a8b4924758d6d91ce91a81dcd3c6f13fd34", "committedDate": "2020-01-02T14:02:10Z", "message": "Merge pull request #554 from IBM/master\n\nsync with master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aacc9326287118f365afad1aeeec09d35d9bbcf3", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/aacc9326287118f365afad1aeeec09d35d9bbcf3", "committedDate": "2020-01-06T14:49:34Z", "message": "Merge pull request #555 from IBM/master\n\nsync with master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44eab97a87168d4282dc9befd735f6b7e90d4e21", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/44eab97a87168d4282dc9befd735f6b7e90d4e21", "committedDate": "2020-01-06T15:00:00Z", "message": "issue #160 Conditional read support\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4d02a30d5e2a3030a4ed2c0b74aacf32a892cbe", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/d4d02a30d5e2a3030a4ed2c0b74aacf32a892cbe", "committedDate": "2020-01-06T15:17:40Z", "message": "issue #160  minor update\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NzMzNjk0", "url": "https://github.com/IBM/FHIR/pull/556#pullrequestreview-338733694", "createdAt": "2020-01-06T16:09:11Z", "commit": {"oid": "d4d02a30d5e2a3030a4ed2c0b74aacf32a892cbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxNjowOToxMlrOFahzMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxNjowOToxMlrOFahzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM2MTA3Mg==", "bodyText": "We can probably use DateTimeHandler from Search's pattern and use a parseBest\nSnippet\nprivate static final DateTimeFormatter DATE_TIME_PARSER_FORMATTER =\n            new DateTimeFormatterBuilder()\n                    .appendPattern(\"yyyy\")\n                    .optionalStart()\n                        .appendLiteral('-')\n                        .appendPattern(\"MM\")\n                        .optionalStart()\n                            .appendLiteral('-')\n                            .appendPattern(\"dd\")\n                            .optionalStart()\n                                .appendLiteral(\"T\")\n                                .optionalStart()\n                                .appendPattern(\"HH\")\n                                .optionalStart()\n                                    .appendLiteral(':')\n                                    .appendPattern(\"mm\")\n                                    .optionalStart()\n                                        .appendLiteral(':')\n                                        .appendPattern(\"ss\")\n                                        .optionalStart()\n                                            .appendFraction(ChronoField.MICRO_OF_SECOND, 0, 6, true)\n                                        .optionalEnd()\n                                    .optionalEnd()\n                                .optionalEnd()\n                                .optionalStart()\n                                    .appendPattern(\"XXX\")\n                                .optionalEnd()\n                            .optionalEnd()\n                            .optionalEnd()\n                        .optionalEnd()\n                    .optionalEnd()\n                    .toFormatter();\n    // @formatter:on\n\nthen one call to\nreturn DATE_TIME_PARSER_FORMATTER.withResolverStyle(ResolverStyle.SMART).parseBest(value,\n                    ZonedDateTime::from, LocalDateTime::from, LocalDate::from, YearMonth::from, Year::from);", "url": "https://github.com/IBM/FHIR/pull/556#discussion_r363361072", "createdAt": "2020-01-06T16:09:12Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/FHIRResource.java", "diffHunk": "@@ -600,6 +618,30 @@ public Response conditionalDelete(@PathParam(\"type\") String type) throws Excepti\n             log.exiting(this.getClass().getName(), \"delete(String,String)\");\n         }\n     }\n+    \n+    \n+    private long parseIfModifiedSince() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4d02a30d5e2a3030a4ed2c0b74aacf32a892cbe"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94b8182a34d6ae96a5dd5013882d0cc20f693d0b", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/94b8182a34d6ae96a5dd5013882d0cc20f693d0b", "committedDate": "2020-01-06T16:39:46Z", "message": "issue #160 update last-modified test codes\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/cb89226e632a08bf6f13965956d72ff07ba43b51", "committedDate": "2020-01-06T23:34:43Z", "message": "issue #160 change to use DateTimeFormatter for asc and touchstone\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTYyNTc4", "url": "https://github.com/IBM/FHIR/pull/556#pullrequestreview-338962578", "createdAt": "2020-01-06T23:47:40Z", "commit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo0Nzo0MVrOFaseFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo0Nzo0MVrOFaseFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNTg5Mg==", "bodyText": "Maybe add a comment indicating what it supports? and format?", "url": "https://github.com/IBM/FHIR/pull/556#discussion_r363535892", "createdAt": "2020-01-06T23:47:41Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/FHIRResource.java", "diffHunk": "@@ -162,6 +172,17 @@\n     private static final String LOCAL_REF_PREFIX = \"urn:\";\n     private static final String HEADERNAME_IF_NONE_EXIST = \"If-None-Exist\";\n     private static final String HEADERNAME_PREFER = \"Prefer\";\n+    private static final String HEADERNAME_IF_MODIFIED_SINCE = \"If-Modified-Since\";\n+    private static final String HEADERNAME_IF_NONE_MATCH = \"If-None-Match\";\n+\n+    public static final DateTimeFormatter PARSER_FORMATTER = new DateTimeFormatterBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTYyNzQx", "url": "https://github.com/IBM/FHIR/pull/556#pullrequestreview-338962741", "createdAt": "2020-01-06T23:48:16Z", "commit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo0ODoxNlrOFaseiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo0ODoxNlrOFaseiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNjAwOQ==", "bodyText": "so it can be a long? or timestamp?", "url": "https://github.com/IBM/FHIR/pull/556#discussion_r363536009", "createdAt": "2020-01-06T23:48:16Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/FHIRResource.java", "diffHunk": "@@ -600,6 +621,28 @@ public Response conditionalDelete(@PathParam(\"type\") String type) throws Excepti\n             log.exiting(this.getClass().getName(), \"delete(String,String)\");\n         }\n     }\n+    \n+    \n+    private long parseIfModifiedSince() {\n+        long modifiedSince = -1;\n+        try {\n+            // Handle RFC_1123 and RFC_850 formats first. \n+            // e.g \"Sun, 06 Nov 1994 08:49:37 GMT\", \"Sunday, 06-Nov-94 08:49:37 GMT\", \"Sunday, 06-Nov-1994 08:49:37 GMT\"\n+            // If 2 digits year is used, then means 1940 to 2039.\n+            modifiedSince = httpServletRequest.getDateHeader(HEADERNAME_IF_MODIFIED_SINCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTYzMjI4", "url": "https://github.com/IBM/FHIR/pull/556#pullrequestreview-338963228", "createdAt": "2020-01-06T23:49:54Z", "commit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo0OTo1NFrOFasgDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo0OTo1NFrOFasgDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNjM5Ng==", "bodyText": "I think this part should be done one time, not twice as on 664/666", "url": "https://github.com/IBM/FHIR/pull/556#discussion_r363536396", "createdAt": "2020-01-06T23:49:54Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/FHIRResource.java", "diffHunk": "@@ -610,9 +653,50 @@ public Response read(@PathParam(\"type\") String type, @PathParam(\"id\") String id)\n         try {\n             checkInitComplete();\n             MultivaluedMap<String, String> queryParameters = uriInfo.getQueryParameters();\n+            long modifiedSince = parseIfModifiedSince();\n+            \n+            String ifNoneMatch = httpHeaders.getHeaderString(HEADERNAME_IF_NONE_MATCH);\n+            \n             Resource resource = doRead(type, id, true, false, null, null, queryParameters);\n-            ResponseBuilder response = Response.ok().entity(resource);\n-            response = addHeaders(response, resource);\n+            int version2Match = -1;\n+            // Support ETag value with or without \" (and W/)\n+            // e.g:  1, \"1\", W/1, W/\"1\" (the first format is used by TouchStone)\n+            if (ifNoneMatch != null && !ifNoneMatch.replaceAll(\"\\\"\", \"\").replaceAll(\"W/\", \"\").trim().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTYzNTU4", "url": "https://github.com/IBM/FHIR/pull/556#pullrequestreview-338963558", "createdAt": "2020-01-06T23:50:47Z", "commit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo1MDo0N1rOFashFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo1MDo0N1rOFashFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNjY2MA==", "bodyText": "slight spelling ... Modified", "url": "https://github.com/IBM/FHIR/pull/556#discussion_r363536660", "createdAt": "2020-01-06T23:50:47Z", "author": {"login": "prb112"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/FHIRResource.java", "diffHunk": "@@ -610,9 +653,50 @@ public Response read(@PathParam(\"type\") String type, @PathParam(\"id\") String id)\n         try {\n             checkInitComplete();\n             MultivaluedMap<String, String> queryParameters = uriInfo.getQueryParameters();\n+            long modifiedSince = parseIfModifiedSince();\n+            \n+            String ifNoneMatch = httpHeaders.getHeaderString(HEADERNAME_IF_NONE_MATCH);\n+            \n             Resource resource = doRead(type, id, true, false, null, null, queryParameters);\n-            ResponseBuilder response = Response.ok().entity(resource);\n-            response = addHeaders(response, resource);\n+            int version2Match = -1;\n+            // Support ETag value with or without \" (and W/)\n+            // e.g:  1, \"1\", W/1, W/\"1\" (the first format is used by TouchStone)\n+            if (ifNoneMatch != null && !ifNoneMatch.replaceAll(\"\\\"\", \"\").replaceAll(\"W/\", \"\").trim().isEmpty()) {\n+                try {\n+                    version2Match = Integer.parseInt(ifNoneMatch.replaceAll(\"\\\"\", \"\").replaceAll(\"W/\", \"\").trim());\n+                }\n+                catch (NumberFormatException e)\n+                {\n+                    // ignore invalid version\n+                    version2Match = -1;\n+                }\n+            }\n+            Instant modifiedTime2Compare = null;\n+            if (modifiedSince > 0 ) {\n+                modifiedTime2Compare = Instant.ofEpochMilli(modifiedSince);\n+            }\n+            \n+            boolean isModifed = true;\n+            // check if-not-match first\n+            if (version2Match != -1) {\n+                if (version2Match == Integer.parseInt(resource.getMeta().getVersionId().getValue())) {\n+                    isModifed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb89226e632a08bf6f13965956d72ff07ba43b51"}, "originalPosition": 120}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2d8b4a68790fcb75a870a5c8dbe87c30f639713", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/f2d8b4a68790fcb75a870a5c8dbe87c30f639713", "committedDate": "2020-01-07T14:34:05Z", "message": "issue #160 minor updates per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "431fb0ce454e1c57d545c290e9e795727a08c9a2", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/431fb0ce454e1c57d545c290e9e795727a08c9a2", "committedDate": "2020-01-07T16:02:39Z", "message": "issue #160 add more negative test cases\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31fc7b724ad00ea476ace993d5a10654f8678a4f", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/31fc7b724ad00ea476ace993d5a10654f8678a4f", "committedDate": "2020-01-07T16:11:11Z", "message": "issue #160 minor update\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d923190840429f311a7ce855f435a9c826febb25", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/d923190840429f311a7ce855f435a9c826febb25", "committedDate": "2020-01-07T16:14:11Z", "message": "issue #160 minor comment update\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzcxNTkx", "url": "https://github.com/IBM/FHIR/pull/556#pullrequestreview-339371591", "createdAt": "2020-01-07T16:59:24Z", "commit": {"oid": "d923190840429f311a7ce855f435a9c826febb25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMDE3MDc3", "url": "https://github.com/IBM/FHIR/pull/556#pullrequestreview-340017077", "createdAt": "2020-01-08T17:16:20Z", "commit": {"oid": "d923190840429f311a7ce855f435a9c826febb25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNzoxNjoyMVrOFbd8PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNzoxNjoyMVrOFbd8PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM0NjQyOA==", "bodyText": "this was not right.  should have been 2016,2020", "url": "https://github.com/IBM/FHIR/pull/556#discussion_r364346428", "createdAt": "2020-01-08T17:16:21Z", "author": {"login": "lmsurpre"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/resources/FHIRResource.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * (C) Copyright IBM Corp. 2016,2019\n+ * (C) Copyright IBM Corp. 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d923190840429f311a7ce855f435a9c826febb25"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMDE3MzAy", "url": "https://github.com/IBM/FHIR/pull/556#pullrequestreview-340017302", "createdAt": "2020-01-08T17:16:41Z", "commit": {"oid": "d923190840429f311a7ce855f435a9c826febb25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNzoxNjo0MlrOFbd88A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNzoxNjo0MlrOFbd88A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM0NjYwOA==", "bodyText": "not right.  should be 2016,2020", "url": "https://github.com/IBM/FHIR/pull/556#discussion_r364346608", "createdAt": "2020-01-08T17:16:42Z", "author": {"login": "lmsurpre"}, "path": "fhir-client/src/main/java/com/ibm/fhir/client/impl/FHIRResponseImpl.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * (C) Copyright IBM Corp. 2016,2019\n+ * (C) Copyright IBM Corp. 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d923190840429f311a7ce855f435a9c826febb25"}, "originalPosition": 3}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 719, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}