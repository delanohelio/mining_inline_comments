{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMzEwOTEy", "number": 594, "reviewThreads": {"totalCount": 65, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNTo0OFrODZWLhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNToxNTozMlrODaNQLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA0MzkwOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNTo0OFrOFfrmuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNTo0OFrOFfrmuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDYwMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n          \n          \n            \n            BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368764603", "createdAt": "2020-01-21T00:15:48Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA0NDE4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNjowM1rOFfrm4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNjowM1rOFfrm4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDY0MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            There are 2 projects involved inside the implementation:\n          \n          \n            \n            There are 2 modules involved inside the implementation:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368764641", "createdAt": "2020-01-21T00:16:03Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA0NDk5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNjo1MVrOFfrnWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNjo1MVrOFfrnWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDc2Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            (There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n          \n          \n            \n            To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368764762", "createdAt": "2020-01-21T00:16:51Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA0NTE4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNzoxMFrOFfrngQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxNzoxMFrOFfrngQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDgwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n          \n          \n            \n            \n          \n          \n            \n            There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368764801", "createdAt": "2020-01-21T00:17:10Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA0NzY5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxOTozMVrOFfro6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoxOTozMVrOFfro6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTE2Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n          \n          \n            \n            The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765163", "createdAt": "2020-01-21T00:19:31Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA0OTc0OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMTozNlrOFfrqHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMTozNlrOFfrqHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTQ2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n          \n          \n            \n            The *fhir-bulkimportexport-webapp* project is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765468", "createdAt": "2020-01-21T00:21:36Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA0OTkyOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMTo0OVrOFfrqOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMTo0OVrOFfrqOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTQ5OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            ``` xml", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765499", "createdAt": "2020-01-21T00:21:49Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1MTY2OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMzo0OFrOFfrrQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMzo0OFrOFfrrQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTc2MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n          \n          \n            \n            BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765761", "createdAt": "2020-01-21T00:23:48Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1MTg1OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMzo1OFrOFfrrWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyMzo1OFrOFfrrWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTc4Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            ``` json", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765786", "createdAt": "2020-01-21T00:23:58Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1Mjk4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNTowNlrOFfrsBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNTowNlrOFfrsBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTk1OA==", "bodyText": "maybe 1-2 output examples is OK?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765958", "createdAt": "2020-01-21T00:25:06Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1MzE3OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNToxN1rOFfrsJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNToxN1rOFfrsJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTk4OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368765989", "createdAt": "2020-01-21T00:25:17Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1NDkwOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNjo1NFrOFfrtHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDowNzoxMFrOFgpX2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg==", "bodyText": "I am not sure I follow this?\nIf a file is written out to Object Storage, it's public by default? only protected by obfuscation?\nThe above paragraph is a bit tricky to read", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766236", "createdAt": "2020-01-21T00:26:54Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk5MDQ3MQ==", "bodyText": "yes, the object is written with public access acl setting.\nFor safe reason, I added expiration time to the objects, and also mentioned that we should never give public access for the bucket itself which allow the user to list and get all the generated objects.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368990471", "createdAt": "2020-01-21T13:11:08Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk5MzI4Mw==", "bodyText": "hum, this doesn't seem ideal.  Are there any alternatives?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368993283", "createdAt": "2020-01-21T13:16:57Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAxODMyNA==", "bodyText": "The other similar choice is the pre-signed urls which provide temp url for read and write, but the idea is the similar - a temp url with secret(signature) in path and can expire automatically.  https://cloud.ibm.com/docs/services/cloud-object-storage?topic=cloud-object-storage-presign-url.    and this approach is a little bit complicated than what I did in codes.   This is the url format of this approach:\nvar requestUrl = endpoint + '/' +\nbucket + '/' +\nobjectKey + '?' +\nstandardizedQuerystring +\n'&X-Amz-Signature=' +\nsignature;", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369018324", "createdAt": "2020-01-21T14:04:46Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI0MjUxOA==", "bodyText": "I'm curious what Lee thinks.  Otherwise looks good.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369242518", "createdAt": "2020-01-21T21:05:43Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2MjA2Ng==", "bodyText": "Albert and I came up with this approach together.  If there is enough \"entropy\" in the name, I think it would be acceptable for at least some use cases.  Similar to a box \"share\" link or a password reset link you get via email.  I do wish we could totally hide the internals though (i.e. not leak our bucket name).\nAnd we should be very clear that its publicly accessible (if you have the link).", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369762066", "createdAt": "2020-01-22T19:36:18Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2NTQxNA==", "bodyText": "Yeah - I 100% agree.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369765414", "createdAt": "2020-01-22T19:43:24Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2NTgzMA==", "bodyText": "One design goal for this was to keep us out of playing \"middleman\" for these downloads.  In most of our deployments we have a 60 second HTTP timeout, so the download sort of needs to be a direct connection with COS.\nhttp://hl7.org/fhir/uv/bulkdata/STU1/authorization/index.html explains how to use SMART authentication to provide a temporary access token, but I'm not sure how to do that.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369765830", "createdAt": "2020-01-22T19:44:12Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3NjYwMg==", "bodyText": "I thought about generate temp bear token for the download, but the problem is that the bear token could give the user full access to the bucket even COS service. maybe we could create a spec user/apikey without any access by default, and then give read access in the object ACL to this user, and generate the bear token for user to download the object, this will be much more complicated ...", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369776602", "createdAt": "2020-01-22T20:07:10Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjIzNg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1NDk5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNzowNFrOFfrtKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNzowNFrOFfrtKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjI0OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            ``` xml", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766249", "createdAt": "2020-01-21T00:27:04Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n+  \n+JavaBatch feature must be enabled in server.xml as following for liberty server:\n+\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1NTI2OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNzoyMlrOFfrtTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyNzoyMlrOFfrtTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjI4Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            And JavaBatch user used in bulkdata.json can be configured in server.xml as following: \n          \n          \n            \n            The JavaBatch user is configured in server.xml and the bulkdata.json:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766287", "createdAt": "2020-01-21T00:27:22Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n+  \n+JavaBatch feature must be enabled in server.xml as following for liberty server:\n+\n+```\n+    <!-- Enable features -->\n+    <featureManager>\n+        ...\n+        <feature>batchManagement-1.0</feature>\n+        ...\n+    </featureManager>\n+```\n+And JavaBatch user used in bulkdata.json can be configured in server.xml as following: ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 121}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1NzM4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyOTozOFrOFfrumg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDoyOTozOFrOFfrumg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjYxOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Please notice that a user with at least batchSubmitter role should be used for batch-user of bulkdata.json.\n          \n          \n            \n            Note: The user referenced in the bulkdata.json must have a role of at least batchSubmitter.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766618", "createdAt": "2020-01-21T00:29:38Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n+  \n+JavaBatch feature must be enabled in server.xml as following for liberty server:\n+\n+```\n+    <!-- Enable features -->\n+    <featureManager>\n+        ...\n+        <feature>batchManagement-1.0</feature>\n+        ...\n+    </featureManager>\n+```\n+And JavaBatch user used in bulkdata.json can be configured in server.xml as following: \n+\n+```    \n+<authorization-roles id=\"com.ibm.ws.batch\">\n+\t<security-role name=\"batchAdmin\">\t\n+\t\t<user name=\"fhiradmin\"/>\t\n+\t</security-role>\n+\t<security-role name=\"batchSubmitter\">\n+\t\t<user name=\"fhiruser\"/>\n+\t</security-role>\n+\t<security-role name=\"batchMonitor\">\n+\t\t<user name=\"fhiradmin\"/>\n+\t\t<user name=\"fhiruser\"/>\n+\t</security-role>\n+</authorization-roles>\n+```\n+Please notice that a user with at least batchSubmitter role should be used for batch-user of bulkdata.json.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA1Nzc1OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMDowN1rOFfru1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMDowN1rOFfru1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NjY3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            By default, in-memory derby database is used for persistence of the JavaBatch Jobs. Instruction is also provided in \"Configuring a Liberty Datasource with API Key\" section of the DB2OnCloudSetup guide to configure DB2 service in IBM Clouds as JavaBatch persistence store. Liberty JavaBath framework creates the Database, DB schema and tables automatically by default for both approaches.   \n          \n          \n            \n            By default, in-memory Derby database is used for persistence of the JavaBatch Jobs. Instruction is also provided in \"Configuring a Liberty Datasource with API Key\" section of the DB2OnCloudSetup guide to configure DB2 service in IBM Clouds as JavaBatch persistence store. Liberty JavaBatch framework creates the Database, DB schema and tables automatically by default for both approaches.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368766677", "createdAt": "2020-01-21T00:30:07Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+  { \"type\" : \"Group\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Group_1.ndjson\", \n+    \"count\": 15},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_1.ndjson\", \n+    \"count\": 30},\n+  { \"type\" : \"Condition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Condition_2.ndjson\", \n+    \"count\": 21},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"Composition\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Composition_2.ndjson\", \n+    \"count\": 8}]\n+}\n+\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n+  \n+JavaBatch feature must be enabled in server.xml as following for liberty server:\n+\n+```\n+    <!-- Enable features -->\n+    <featureManager>\n+        ...\n+        <feature>batchManagement-1.0</feature>\n+        ...\n+    </featureManager>\n+```\n+And JavaBatch user used in bulkdata.json can be configured in server.xml as following: \n+\n+```    \n+<authorization-roles id=\"com.ibm.ws.batch\">\n+\t<security-role name=\"batchAdmin\">\t\n+\t\t<user name=\"fhiradmin\"/>\t\n+\t</security-role>\n+\t<security-role name=\"batchSubmitter\">\n+\t\t<user name=\"fhiruser\"/>\n+\t</security-role>\n+\t<security-role name=\"batchMonitor\">\n+\t\t<user name=\"fhiradmin\"/>\n+\t\t<user name=\"fhiruser\"/>\n+\t</security-role>\n+</authorization-roles>\n+```\n+Please notice that a user with at least batchSubmitter role should be used for batch-user of bulkdata.json.\n+\n+By default, in-memory derby database is used for persistence of the JavaBatch Jobs. Instruction is also provided in \"Configuring a Liberty Datasource with API Key\" section of the DB2OnCloudSetup guide to configure DB2 service in IBM Clouds as JavaBatch persistence store. Liberty JavaBath framework creates the Database, DB schema and tables automatically by default for both approaches.   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 139}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2MDEyOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMjozOVrOFfrwTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMzoxNjozN1rOFf5jeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzA1Mw==", "bodyText": "maybe the values that can be set above should be described for the client?\nAlso cos.bucket.prefix ? it seems pretty useful.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767053", "createdAt": "2020-01-21T00:32:39Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk5MzE0Ng==", "bodyText": "good point, will add. cos.bucket.prefix is generated automatically by codes, so I didn't add it.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368993146", "createdAt": "2020-01-21T13:16:37Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzA1Mw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2MDI4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMjo0OVrOFfrwag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozMjo0OVrOFfrwag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzA4Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"contextRoot\" : \"/fhir-server/api/v4\"\n          \n          \n            \n               \"contextRoot\" : \"/fhir-server/api/v4\"", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767082", "createdAt": "2020-01-21T00:32:49Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,135 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData export is implemented according to [Fhir r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 projects involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+(There is a ExportOperationTest.java in fhir-server-test project with server integration test cases for system, patient and group export)  \n+The fhir-operation-bulkdata project implements the REST APIs for Bulkdata export as FHIR operations, there are ExportOperation, PatientExportOperation and GroupExportOperation defined for system export, patient export and group export accordingly. And these operations call JavaBatch jobs defined in the fhir-bulkimportexport-webapp project to do the real export work.   \n+There are 3 chunk style JavaBatch jobs defined as following in fhir-bulkimportexport-webapp project for the above 3 export operations:  \n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The fhir-bulkimportexport-webapp project is also a wrapper for the whole BulkData web application, which generates fhir-bulkimportexport.war, this war should be copied to the apps directory of the liberty fhir-server instance. Following is a sample deployment description for fhir-bulkimportexport.war in server.xml of liberty server:\n+\n+```\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+The exported FHIR resources can be configured to be written into IBM COS or Amazon S3 bucket in the per-tenant bulkdata.json configuration file which is put under the tenant configuration directory of the fhir-server instance. Following is a sample bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+    \"contextRoot\" : \"/fhir-server/api/v4\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2MTMyOnYy", "diffSide": "RIGHT", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/processor/impl/CosExportImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozNDoxNFrOFfrxKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDoxMzozM1rOFf7YpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzI3Mw==", "bodyText": "just a note to Albert... I'll change this in my PR.  so we don't just force DEFAULT_TENANT_ID", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767273", "createdAt": "2020-01-21T00:34:14Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/processor/impl/CosExportImpl.java", "diffHunk": "@@ -161,13 +163,48 @@ public Parameters exportPatient(String logicalId, MediaType outputFormat, Instan\n         }\n     }\n \n-    // not implemented yet\n     @Override\n     public Parameters exportGroup(String logicalId, MediaType outputFormat, Instant since,\n         List<String> types, List<String> typeFilters, FHIRRequestContext ctx,\n         FHIRResourceHelpers resourceHelper, FHIROperationContext operationContext,\n         BulkDataTenantSpecificCache cache) throws FHIROperationException {\n-        throw new FHIROperationException(\"No $export group operation right now\");\n+\n+        try {\n+            log.fine(\"Using the COS Implementation\");\n+\n+            Map<String, String> properties =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMzE0MA==", "bodyText": "sounds great!! thanks!", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369023140", "createdAt": "2020-01-21T14:13:33Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/processor/impl/CosExportImpl.java", "diffHunk": "@@ -161,13 +163,48 @@ public Parameters exportPatient(String logicalId, MediaType outputFormat, Instan\n         }\n     }\n \n-    // not implemented yet\n     @Override\n     public Parameters exportGroup(String logicalId, MediaType outputFormat, Instant since,\n         List<String> types, List<String> typeFilters, FHIRRequestContext ctx,\n         FHIRResourceHelpers resourceHelper, FHIROperationContext operationContext,\n         BulkDataTenantSpecificCache cache) throws FHIROperationException {\n-        throw new FHIROperationException(\"No $export group operation right now\");\n+\n+        try {\n+            log.fine(\"Using the COS Implementation\");\n+\n+            Map<String, String> properties =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzI3Mw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2MjE0OnYy", "diffSide": "RIGHT", "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/processor/impl/CosExportImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozNToxOFrOFfrxsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDoxNToyMVrOFf7cXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzQxMA==", "bodyText": "on line 121, can you remove the printstacktrace", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767410", "createdAt": "2020-01-21T00:35:18Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/processor/impl/CosExportImpl.java", "diffHunk": "@@ -161,13 +163,48 @@ public Parameters exportPatient(String logicalId, MediaType outputFormat, Instan\n         }\n     }\n \n-    // not implemented yet\n     @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyNDA5NA==", "bodyText": "done", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369024094", "createdAt": "2020-01-21T14:15:21Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/processor/impl/CosExportImpl.java", "diffHunk": "@@ -161,13 +163,48 @@ public Parameters exportPatient(String logicalId, MediaType outputFormat, Instan\n         }\n     }\n \n-    // not implemented yet\n     @Override", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NzQxMA=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2NTI1OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozODoyNVrOFfrzeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozODoyNVrOFfrzeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Nzg2Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767866", "createdAt": "2020-01-21T00:38:25Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2NTk0OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOToxNFrOFfrz6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOToxNFrOFfrz6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Nzk3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368767977", "createdAt": "2020-01-21T00:39:14Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 184}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2NjE0OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOToyN1rOFfr0CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOToyN1rOFfr0CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODAwOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n          \n          \n            \n                private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768008", "createdAt": "2020-01-21T00:39:27Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 187}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2NjMwOnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOTozN1rOFfr0Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDozOTozN1rOFfr0Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODAzMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n          \n          \n            \n                private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768030", "createdAt": "2020-01-21T00:39:37Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 206}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2NzQ5OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MDo0NVrOFfr00w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MDo0NVrOFfr00w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODIxMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n          \n          \n            \n                    Group group = findGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768211", "createdAt": "2020-01-21T00:40:45Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset partNum and move resource type index to the next.\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 276}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2NzgwOnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MDo1NVrOFfr0_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MDo1NVrOFfr0_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODI1Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n          \n          \n            \n                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768252", "createdAt": "2020-01-21T00:40:55Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset partNum and move resource type index to the next.\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+        // List for the patients\n+        List<Member> patientMembers = new ArrayList<>();\n+        // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+        HashSet<String> groupsInPath = new HashSet<>();\n+        ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 281}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA2ODI2OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MToyMFrOFfr1OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo0NjowNVrOFgGlQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODMxMg==", "bodyText": "what does setPageNum 2 mean?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768312", "createdAt": "2020-01-21T00:41:20Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset partNum and move resource type index to the next.\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+        // List for the patients\n+        List<Member> patientMembers = new ArrayList<>();\n+        // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+        HashSet<String> groupsInPath = new HashSet<>();\n+        ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(0, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+        }\n+        // The fhir resources of one resource type for all the patients will be exported into one COS object.\n+        // Here we simply set the lastPageNum to be smaller than the next PageNum to ask the common ChunkWriter\n+        // to close the writing for current resource type.\n+        chunkData.setPageNum(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 293}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAzMTk3Ng==", "bodyText": "paging is used for the common implementation. e.g, for patient export, the codes read page of patients, and then write these patients' resources of current to-be-exported resource type to COS, and then move to the next page of patients.\nBut for group export, we don't really use paging for patients, we get all patient in one batch, so just as mentioned in the comments, we simply set current page number to be 2 and the lastpagenum to be 1 to simply sign the CheckPoint and ChunkWriter to finish writing for current resource type.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369031976", "createdAt": "2020-01-21T14:28:39Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset partNum and move resource type index to the next.\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+        // List for the patients\n+        List<Member> patientMembers = new ArrayList<>();\n+        // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+        HashSet<String> groupsInPath = new HashSet<>();\n+        ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(0, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+        }\n+        // The fhir resources of one resource type for all the patients will be exported into one COS object.\n+        // Here we simply set the lastPageNum to be smaller than the next PageNum to ask the common ChunkWriter\n+        // to close the writing for current resource type.\n+        chunkData.setPageNum(2);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODMxMg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 293}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwNjU5Mw==", "bodyText": "OK - I got it now.  Thanks.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369206593", "createdAt": "2020-01-21T19:46:05Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,325 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+\n+    }\n+\n+    private void ExpandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = FindGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group FindGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset partNum and move resource type index to the next.\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        Group group = FindGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+        // List for the patients\n+        List<Member> patientMembers = new ArrayList<>();\n+        // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+        HashSet<String> groupsInPath = new HashSet<>();\n+        ExpandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(0, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+        }\n+        // The fhir resources of one resource type for all the patients will be exported into one COS object.\n+        // Here we simply set the lastPageNum to be smaller than the next PageNum to ask the common ChunkWriter\n+        // to close the writing for current resource type.\n+        chunkData.setPageNum(2);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODMxMg=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 293}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA3MDE5OnYy", "diffSide": "RIGHT", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MjozOFrOFfr2KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDoxODo0NlrOFf7kUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODU1Mw==", "bodyText": "? gets replaced?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768553", "createdAt": "2020-01-21T00:42:38Z", "author": {"login": "prb112"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyNjEzMQ==", "bodyText": "yes, ? will be replace with the group id", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369026131", "createdAt": "2020-01-21T14:18:46Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODU1Mw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA3MDYwOnYy", "diffSide": "RIGHT", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0Mjo1NFrOFfr2Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDozMTozNFrOFf8B_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODYwNw==", "bodyText": "camelcase and visibility modifier?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768607", "createdAt": "2020-01-21T00:42:54Z", "author": {"login": "prb112"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;\n \n-    public static final boolean ON = false;\n-    \n-    @Test(groups = { TEST_GROUP_NAME }, enabled = ON)\n-    public void testBaseExport() throws FHIRGeneratorException, IOException {\n-        Response response =\n-            doPost(BASE_VALID_URL, FHIRMediaType.APPLICATION_FHIR_JSON, FORMAT, Instant.of(\"2019-01-01T08:21:26.94-04:00\"), Arrays.asList(\"Patient\"), null);\n-        assertEquals(response.getStatus(), 202);\n-\n-        // Debug the content-location that's returned. \n-        String contentLocation = response.getHeaderString(\"Content-Location\");\n-        System.out.println(\"Content Location: \" + contentLocation);\n-        \n-        assertEquals(contentLocation, \"/fhir-server/api/v4/$export-status?job=1\");\n-\n-    }\n+    public static final boolean DEBUG = false;\n+    String ExportStatusUrl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAzMzcyNQ==", "bodyText": "good catch.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369033725", "createdAt": "2020-01-21T14:31:34Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;\n \n-    public static final boolean ON = false;\n-    \n-    @Test(groups = { TEST_GROUP_NAME }, enabled = ON)\n-    public void testBaseExport() throws FHIRGeneratorException, IOException {\n-        Response response =\n-            doPost(BASE_VALID_URL, FHIRMediaType.APPLICATION_FHIR_JSON, FORMAT, Instant.of(\"2019-01-01T08:21:26.94-04:00\"), Arrays.asList(\"Patient\"), null);\n-        assertEquals(response.getStatus(), 202);\n-\n-        // Debug the content-location that's returned. \n-        String contentLocation = response.getHeaderString(\"Content-Location\");\n-        System.out.println(\"Content Location: \" + contentLocation);\n-        \n-        assertEquals(contentLocation, \"/fhir-server/api/v4/$export-status?job=1\");\n-\n-    }\n+    public static final boolean DEBUG = false;\n+    String ExportStatusUrl;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODYwNw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTA3MTI1OnYy", "diffSide": "RIGHT", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMDo0MzoyNFrOFfr2tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToyODowMlrOFgGENg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODY5Mw==", "bodyText": "we run these on each Integration test?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r368768693", "createdAt": "2020-01-21T00:43:24Z", "author": {"login": "prb112"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAzODYyNQ==", "bodyText": "I didn't add ExportOperationTest to server integration test testng.xml, so it doesn't run in the pipeline now.  I prefer to run this in local integration test at present.  but let me add it to the pipeline, because seems the deployment/configurations are ready in the pipeline, so, let me try to enable it now and let's see what we can get...", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369038625", "createdAt": "2020-01-21T14:39:42Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODY5Mw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA2MTM3OA==", "bodyText": "en, it failed in the pipeline, because there is unfinished db2 javabatch config in server.xml, let me remove it from server.xml.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369061378", "createdAt": "2020-01-21T15:16:40Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODY5Mw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA4ODY0OA==", "bodyText": "interesting, got ClassNotFound error, seems cause by the removing of databaseutil in the dependency. let me sync with master and test in my local to find out if I can reproduce this...\njava.lang.NoClassDefFoundError: com/ibm/fhir/database/utils/api/IDatabaseTarget com.ibm.jbatch.container.controller.impl.ChunkStepControllerImpl", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369088648", "createdAt": "2020-01-21T15:59:40Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODY5Mw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEwNzcxNw==", "bodyText": "en... does reproduced in my local the same error ... trying to figure out how this can happen ...", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369107717", "createdAt": "2020-01-21T16:30:45Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODY5Mw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5ODEzNA==", "bodyText": "fixed the error by adding databaseUtil to bulkdata webapp war, and removed the export test from testng.xml of integration test because it needs COS key and service id to be configured correctly.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369198134", "createdAt": "2020-01-21T19:28:02Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/ExportOperationTest.java", "diffHunk": "@@ -26,68 +31,54 @@\n import com.ibm.fhir.model.format.Format;\n import com.ibm.fhir.model.generator.FHIRGenerator;\n import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Condition;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Observation;\n import com.ibm.fhir.model.resource.Parameters;\n import com.ibm.fhir.model.resource.Parameters.Parameter;\n+import com.ibm.fhir.model.resource.Patient;\n+import com.ibm.fhir.model.test.TestUtil;\n import com.ibm.fhir.model.type.Instant;\n+import com.ibm.fhir.model.type.Reference;\n \n /**\n- * These tests exercise the $export operation, a BulkData specification defined operation.\n- * \n- * @author pbastide\n+ * These tests exercise the $export operation, a BulkData specification defined operation\n  *\n  */\n public class ExportOperationTest extends FHIRServerTestBase {\n-\n     public static final String TEST_GROUP_NAME = \"export-operation\";\n-\n     public static final String PATIENT_VALID_URL = \"Patient/$export\";\n-    public static final String GROUP_VALID_URL = \"Group/$export\";\n+    public static final String GROUP_VALID_URL = \"Group/?/$export\";\n     public static final String BASE_VALID_URL = \"/$export\";\n-\n     public static final String BASE_VALID_STATUS_URL = \"/$export-status\";\n-\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    public static final boolean ON = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2ODY5Mw=="}, "originalCommit": {"oid": "4247b9102386532ab7e481ca0989dc5659031c72"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTg2MTM0OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo0NzoxMlrOFgGnXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDowODoyM1rOFgHPvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwNzEzNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n          \n          \n            \n            BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n          \n      \n    \n    \n  \n\nsorry - I realized I gave a bad edit before", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369207134", "createdAt": "2020-01-21T19:47:12Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzE5MQ==", "bodyText": "np, let me fix it.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369213191", "createdAt": "2020-01-21T19:59:00Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwNzEzNA=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxNzQ3MA==", "bodyText": "done", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369217470", "createdAt": "2020-01-21T20:08:23Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwNzEzNA=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTg3MTk2OnYy", "diffSide": "LEFT", "path": "fhir-server/liberty-config/server.xml", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1MDozNVrOFgGt_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDoyOToyOFrOFgHzRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwODgzMA==", "bodyText": "Why can't the fhirbatchDS exist here? I suggest we comment it out, and remove server-withDb2JavaBatch.xml", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369208830", "createdAt": "2020-01-21T19:50:35Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -190,23 +190,6 @@\n     </dataSource>\n     -->\n \n-    <dataSource id=\"fhirbatchDS\" jndiName=\"jdbc/fhirbatchDB\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwOTk4Mw==", "bodyText": "actually - I suggest\n <include optional=\"true\" location=\"${server.config.dir}/batchDs.xml\"/>", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369209983", "createdAt": "2020-01-21T19:52:55Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -190,23 +190,6 @@\n     </dataSource>\n     -->\n \n-    <dataSource id=\"fhirbatchDS\" jndiName=\"jdbc/fhirbatchDB\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwODgzMA=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMjY5MA==", "bodyText": "haha, yeah, sound good", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369212690", "createdAt": "2020-01-21T19:58:02Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -190,23 +190,6 @@\n     </dataSource>\n     -->\n \n-    <dataSource id=\"fhirbatchDS\" jndiName=\"jdbc/fhirbatchDB\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwODgzMA=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIyNjU2Nw==", "bodyText": "done", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369226567", "createdAt": "2020-01-21T20:29:28Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -190,23 +190,6 @@\n     </dataSource>\n     -->\n \n-    <dataSource id=\"fhirbatchDS\" jndiName=\"jdbc/fhirbatchDB\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwODgzMA=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTg5MTQ4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1NjoyN1rOFgG56w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDowODoxMFrOFgHPXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMTg4Mw==", "bodyText": "<!--Host name part of the server generated polling location url -->\n  \"contextRoot\" : \"/fhir-server/api/v4\"\t\t   <!--Context root part of the server generated polling location url -->\n}\n\nI think these comments should be outside of the JSON", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369211883", "createdAt": "2020-01-21T19:56:27Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\t       <!--Host name part of the server generated polling location url -->\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\t\t   <!--Context root part of the server generated polling location url -->\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxNDcyNg==", "bodyText": "yeah, make sense", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369214726", "createdAt": "2020-01-21T20:02:14Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\t       <!--Host name part of the server generated polling location url -->\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\t\t   <!--Context root part of the server generated polling location url -->\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMTg4Mw=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxNzM3NQ==", "bodyText": "done", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369217375", "createdAt": "2020-01-21T20:08:10Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\t       <!--Host name part of the server generated polling location url -->\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\t\t   <!--Context root part of the server generated polling location url -->\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMTg4Mw=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTkwOTQ4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDowMjoxM1rOFgHE_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDo1NzozN1rOFgIjzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxNDcxNw==", "bodyText": "these elements should be described in a table.\n\n\n\nParameter Name\nDescription\n\n\n\n\napplicationName\nfixed value\n\n\nmoduleName\nfixed value\n\n\njobParameters.cos.bucket.name\nfixed value\n\n\njobParameters.cos.location\nfixed value\n\n\njobParameters.cos.endpointurl\nfixed value\n\n\njobParameters.credential.ibm\nfixed value\n\n\njobParameters.cos.api.key\nfixed value\n\n\njobParameters.cos.srvinst.id\nfixed value\n\n\nimplementation_type\nfixed value\n\n\nbatch-uri\nfixed value\n\n\nbatch-user\nfixed value\n\n\nbatch-user-password\nfixed value\n\n\nbatch-truststore\nfixed value\n\n\nbatch-truststore-password\nfixed value\n\n\nserverHostname\nfixed value\n\n\ncontextRoot\nfixed value", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369214717", "createdAt": "2020-01-21T20:02:13Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxNDg0MA==", "bodyText": "you can copy the above table below the JSON, I hope it helps", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369214840", "createdAt": "2020-01-21T20:02:28Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxNDcxNw=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzODk4OQ==", "bodyText": "the description for the others parameters are very descriptive, so I didn't add comments for them. but yes, make sense to add them all. I have just added the table to the document", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369238989", "createdAt": "2020-01-21T20:57:37Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,121 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR r4 BulkData spec](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxNDcxNw=="}, "originalCommit": {"oid": "6f2466f7cb0177e0b74f27b9afba812caec290d1"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTMyNTA1OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNToxM1rOFgn2YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNToxM1rOFgn2YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MTY0OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              * [4.10 BulkData](#410-bulkdata)\n          \n          \n            \n              * [4.10 Bulk data operations](#410-bulk-data-operations)", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369751649", "createdAt": "2020-01-22T19:15:13Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -27,7 +27,8 @@ permalink: /FHIRServerUsersGuide/\n   * [4.7 FHIR command-line interface (fhir-cli)](#47-fhir-command-line-interface-fhir-cli)\n   * [4.8 Using local references within request bundles](#48-using-local-references-within-request-bundles)\n   * [4.9 Multi-tenancy](#49-multi-tenancy)\n-  * [4.10 CADF audit logging service](#410-CADF-audit-logging-service)\n+  * [4.10 BulkData](#410-bulkdata)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTMyOTI3OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNjozM1rOFgn5AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNjozM1rOFgn5AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MjMyMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              * [4.11 CADF audit logging service](#410-CADF-audit-logging-service)\n          \n          \n            \n              * [4.11 CADF audit logging service](#411-CADF-audit-logging-service)", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369752321", "createdAt": "2020-01-22T19:16:33Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -27,7 +27,8 @@ permalink: /FHIRServerUsersGuide/\n   * [4.7 FHIR command-line interface (fhir-cli)](#47-fhir-command-line-interface-fhir-cli)\n   * [4.8 Using local references within request bundles](#48-using-local-references-within-request-bundles)\n   * [4.9 Multi-tenancy](#49-multi-tenancy)\n-  * [4.10 CADF audit logging service](#410-CADF-audit-logging-service)\n+  * [4.10 BulkData](#410-bulkdata)\n+  * [4.11 CADF audit logging service](#410-CADF-audit-logging-service)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTMzMDUyOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNjo1OFrOFgn5vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNjo1OFrOFgn5vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MjUxMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ## 4.10 BulkData\n          \n          \n            \n            ## 4.10 Bulk data operations", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369752511", "createdAt": "2020-01-22T19:16:58Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTMzNDE5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxODowNVrOFgn7_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxODowNVrOFgn7_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MzA4NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ### 4.10.1 BulkData Export\n          \n          \n            \n            ### 4.10.1 Bulk data export", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369753085", "createdAt": "2020-01-22T19:18:05Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTMzODI3OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxOTozMlrOFgn-sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxOTozMlrOFgn-sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1Mzc3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n          \n          \n            \n            Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369753776", "createdAt": "2020-01-22T19:19:32Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTM0MDQ2OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyMDoxOFrOFgoAFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyMDoxOFrOFgoAFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1NDEzMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n          \n          \n            \n            To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369754132", "createdAt": "2020-01-22T19:20:18Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTM0NzgzOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyMjo0OVrOFgoExw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyMjo0OVrOFgoExw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1NTMzNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n          \n          \n            \n            The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n          \n          \n            \n            * ExportOperation - system export\n          \n          \n            \n            * PatientExportOperation - Patient export\n          \n          \n            \n            * GroupExportOperation - group export.\n          \n          \n            \n            Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369755335", "createdAt": "2020-01-22T19:22:49Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTM1Mzg2OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyNDozNVrOFgoIZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyNDozNVrOFgoIZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1NjI2Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n          \n          \n            \n            The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369756263", "createdAt": "2020-01-22T19:24:35Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTM2NTYxOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyODoyMFrOFgoPyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyODoyMFrOFgoPyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODE1Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  \n          \n          \n            \n            To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369758153", "createdAt": "2020-01-22T19:28:20Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,140 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 BulkData\n+### 4.10.1 BulkData Export\n+BulkData Export is implemented according to [FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).   \n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test BulkData, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for Bulkdata export as FHIR operations.  There are three operations ExportOperation - system export, PatientExportOperation - Patient export and GroupExportOperation - group export.  Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war.   This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. This following is a sample path to the exported ndjson file, the full path can be gotten from the response to the polling location request after the export request (please refer to Fhir BulkDate spec for details).  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTQ3OTc1OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDowNzozNFrOFgpYjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDowNzozNFrOFgpYjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3Njc4Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r369776782", "createdAt": "2020-01-22T20:07:34Z", "author": {"login": "lmsurpre"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,323 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d170953ff21bce3925e5d564778cffadb097f7"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzc5MTMyOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNDoyOFrOFg_PHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNDoyOFrOFg_PHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNDgxNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n          \n          \n            \n            The *fhir-operation-bulkdata* module implements the REST APIs for bulk data export as FHIR operations.  There are three operations:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370134815", "createdAt": "2020-01-23T14:04:28Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzc5MzU5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNTowN1rOFg_Qdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyOToxNVrOFhAHgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNTE1OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n          \n      \n    \n    \n  \n\nI think this should be removed.  I don't think it's necessary, maybe include as a readme in the bulkdata operation module.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370135159", "createdAt": "2020-01-23T14:05:07Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0OTI1MA==", "bodyText": "I would prefer to keep this.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370149250", "createdAt": "2020-01-23T14:29:15Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNTE1OQ=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzc5NzA2OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNjowM1rOFg_Scw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNjowM1rOFg_Scw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNTY2Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n          \n          \n            \n            Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* module to execute the export unit-of-work.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370135667", "createdAt": "2020-01-23T14:06:03Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzc5NzgzOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNjoxNlrOFg_S7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDozMjo1MlrOFhAQGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNTc5MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n          \n          \n            \n            There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* module for the above 3 export operations:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370135790", "createdAt": "2020-01-23T14:06:16Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE1MTQ1MQ==", "bodyText": "just noticed that it's changed to project by Lee.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370151451", "createdAt": "2020-01-23T14:32:52Z", "author": {"login": "albertwang-ibm"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNTc5MA=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgwMTkzOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNzoyNFrOFg_VYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowNzoyNFrOFg_VYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNjQxOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            The following configured parameters are:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370136418", "createdAt": "2020-01-23T14:07:24Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgwNDkwOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODoxMVrOFg_XCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODoxMVrOFg_XCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNjg0MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`implementation_type`| fixed value |\n          \n          \n            \n            |`implementation_type`| cos or dummy which matches the desired bulk operation implementation type |", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370136840", "createdAt": "2020-01-23T14:08:11Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgwNjU4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODozN1rOFg_X9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODozN1rOFg_X9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNzA3OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`batch-uri`| fixed value |\n          \n          \n            \n            |`batch-uri`| the URL to access the FHIR server hosting the batch web application |", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370137079", "createdAt": "2020-01-23T14:08:37Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgwODEwOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODo1OVrOFg_Y2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowODo1OVrOFg_Y2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNzMwNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`applicationName`| fixed value |\n          \n          \n            \n            |`applicationName`| fixed value, always set to fhir-bulkimportexport-webapp |", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370137307", "createdAt": "2020-01-23T14:08:59Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgwOTQxOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowOToyMFrOFg_ZpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowOToyMFrOFg_ZpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNzUwOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`moduleName`| fixed value |\n          \n          \n            \n            |`moduleName`| fixed value, always set to fhir-bulkimportexport.war |", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370137509", "createdAt": "2020-01-23T14:09:20Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgxMjQ5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDoxMVrOFg_bgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDoxMVrOFg_bgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNzk4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n          \n          \n            \n            .../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370137984", "createdAt": "2020-01-23T14:10:11Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgxNDA5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDozN1rOFg_cZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDozN1rOFg_cZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzODIxNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t...", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370138215", "createdAt": "2020-01-23T14:10:37Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```json\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+\t...", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgxNDcyOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDo0OFrOFg_cyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMDo0OFrOFg_cyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzODMxMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"count\": 81},\n          \n          \n            \n                \"count\": 81}", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370138312", "createdAt": "2020-01-23T14:10:48Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```json\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgyMTYyOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMjozNVrOFg_g4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxMjozNVrOFg_g4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzOTM2Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  \n          \n          \n            \n            The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please note that IBM COS does not support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. For both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370139362", "createdAt": "2020-01-23T14:12:35Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,144 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* project implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* project to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* project for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n+\n+```json\n+{\n+  \"applicationName\": \"fhir-bulkimportexport-webapp\",\n+  \"moduleName\": \"fhir-bulkimportexport.war\",\n+  \"jobParameters\": {\n+    \"cos.bucket.name\": \"fhir-bulkdata-sample\",\n+    \"cos.location\": \"us\",\n+    \"cos.endpointurl\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud\",\n+    \"cos.credential.ibm\": \"Y\",\n+    \"cos.api.key\": \"xxxxxxxxxxxxxxxxxxxxxxx\",\n+    \"cos.srvinst.id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n+  },\n+  \"implementation_type\": \"cos\",\n+  \"batch-uri\": \"https://localhost:9443/ibm/api/batch/jobinstances\",\n+  \"batch-user\": \"fhiradmin\",\n+  \"batch-user-password\": \"xxxxxxxxxxxx\",\n+  \"batch-truststore\" : \"resources/security/fhirTruststore.jks\",\n+  \"batch-truststore-password\" : \"xxxxxxxxxxxx\",\n+  \"serverHostname\" : \"localhost:9443\",\n+  \"contextRoot\" : \"/fhir-server/api/v4\"\n+}\n+```\n+|Parameter Name   | Description|\n+|--------------| ------------|\n+|`applicationName`| fixed value |\n+|`moduleName`| fixed value |\n+|`jobParameters.cos.bucket.name`| object store bucket name |\n+|`jobParameters.cos.location`| object store location |\n+|`jobParameters.cos.endpointurl`| object store end point url |\n+|`jobParameters.credential.ibm`| if use IBM credential |\n+|`jobParameters.cos.api.key`| api key for accessing IBM COS |\n+|`jobParameters.cos.srvinst.id`| service instance Id for accessing IBM COS |\n+|`implementation_type`| fixed value |\n+|`batch-uri`| fixed value |\n+|`batch-user`| user for submitting JavaBatch job |\n+|`batch-user-password`| password for above batch user |\n+|`batch-truststore`| trust store for JavaBatch job submission |\n+|`batch-truststore-password`| password for above trust store |\n+|`serverHostname`| host name part of the server generated polling location url |\n+|`contextRoot`| context root part of the server generated polling location url |\n+\n+To use Amazon S3 bucket for exporting, please set cos.credential.ibm to \"N\", set cos.api.key to S3 access key, and set cos.srvinst.id to S3 secret key. The following is a sample path to the exported ndjson file, the full path can be found in the response to the polling location request after the export request (please refer to the FHIR BulkDataAccess spec for details).  \n+\n+```\n+\t.../fhir-bulkimexport-connectathon/6xjd4M8afi6Xo95eYv7zPxBqSCoOEFywZLoqH1QBtbw=/Patient_1.ndjson\n+```\n+Following is the beautified response of sample polling location request after the export is finished:\n+\n+```json\n+{\n+\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n+\"request\": \"/$export?_type=\",\n+\"requiresAccessToken\": false,\n+\"output\" : [\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\", \n+    \"count\": 20},\n+  { \"type\" : \"AllergyIntolerance\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\", \n+    \"count\": 8},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\", \n+    \"count\": 234},\n+  { \"type\" : \"Observation\", \n+      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\", \n+    \"count\": 81},\n+\t...\n+}\n+```\n+\n+The exported ndjson file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. please notice that IBM COS doesn't support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. And for both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 118}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgzMDY2OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxNTowM1rOFg_mXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDo1NDozMFrOFhBEMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MDc2NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n          \n          \n            \n                                        chunkData.getBufferStream().write(Constants.NDJSON_LINESEPARATOR.getBytes());\n          \n      \n    \n    \n  \n\nWhy not make the NDJSON_LINESEPARATOR bytes anyway?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370140764", "createdAt": "2020-01-23T14:15:03Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MDk2MQ==", "bodyText": "avoiding getBytes each time?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370140961", "createdAt": "2020-01-23T14:15:27Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MDc2NA=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2NDc4Nw==", "bodyText": "I didn't because I thought the cost is very minor, but make sense for me to make the change.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370164787", "createdAt": "2020-01-23T14:54:30Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MDc2NA=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 165}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzgzNDU5OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxNjowN1rOFg_oxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDo0OToyMFrOFhA3jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MTM4MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            List<String> searchCreterial = new ArrayList<String>();\n          \n          \n            \n                            List<String> searchCriteria = new ArrayList<String>();", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370141381", "createdAt": "2020-01-23T14:16:07Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2MTU1MA==", "bodyText": "this is a refactor, will change in eclipse and commit.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370161550", "createdAt": "2020-01-23T14:49:20Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MTM4MQ=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzg0NDk4OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxODo0OFrOFg_u8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDozODozM1rOFhAdJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0Mjk2Mw==", "bodyText": "shouldn't this throw a more specific exception?  more easily differentiating in code downstream?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370142963", "createdAt": "2020-01-23T14:18:48Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE1NDc4OA==", "bodyText": "not needed, the job always exit when this rare error happens, exception info in log is enough", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370154788", "createdAt": "2020-01-23T14:38:33Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0Mjk2Mw=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 183}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzg0Njk0OnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoxOToyMFrOFg_wPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDo0MDozNVrOFhAhfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MzI5Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n          \n          \n            \n                private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, Set<String> groupsInPath)", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370143293", "createdAt": "2020-01-23T14:19:20Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE1NTkwMw==", "bodyText": "I used HashSet on purpose here, didn't want this to be generic, it's for internally used only.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370155903", "createdAt": "2020-01-23T14:40:35Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0MzI5Mw=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 187}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzg1NjQxOnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMTo0OFrOFg_16Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDo0MjozOVrOFhAmeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NDc0NQ==", "bodyText": "I think we should throw an exception.  This could lead to unintended consequences.  if a tenant is not passed in, it should be treated as invalid.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370144745", "createdAt": "2020-01-23T14:21:48Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 260}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE1NzE3Ng==", "bodyText": "the control should be in the operation side, the javabatch itself allows non tenant id to make the javabatch Job test itself easier.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370157176", "createdAt": "2020-01-23T14:42:39Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NDc0NQ=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 260}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzg2MDkzOnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMjo1N1rOFg_4iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDo1NzoxOFrOFhBLFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NTQxNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n          \n          \n            \n                            logger.warning(\"readItem: Set page size to default [\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \"]\");\n          \n      \n    \n    \n  \n\ngeneral pattern", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370145417", "createdAt": "2020-01-23T14:22:57Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 273}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2NjU0OA==", "bodyText": "Signed-off-by: Albert Wang xuwang@us.ibm.com", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370166548", "createdAt": "2020-01-23T14:57:18Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NTQxNw=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 273}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzg2NDUxOnYy", "diffSide": "RIGHT", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDoyMzo1NlrOFg_6uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNToyNzoxNVrOFhCV7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NTk3OQ==", "bodyText": "maybe add a logger.fine for debug purposes?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370145979", "createdAt": "2020-01-23T14:23:56Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        if (patientMembers == null) {\n+            Group group = findGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+            patientMembers = new ArrayList<>();\n+            // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+            HashSet<String> groupsInPath = new HashSet<>();\n+            expandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+        }\n+        List<Member> patientPageMembers = patientMembers.subList((pageNum - 1) * pageSize,\n+                pageNum * pageSize <= patientMembers.size() ? pageNum * pageSize : patientMembers.size());\n+        pageNum++;\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(pageNum, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+            chunkData.setPageNum(pageNum);\n+        }\n+        chunkData.setLastPageNum((patientMembers.size() + pageSize -1)/pageSize );\n+\n+        if (!patientPageMembers.isEmpty()) {\n+            logger.fine(\"readItem: loaded patients number - \" + patientMembers.size());\n+            fillChunkDataBuffer(patientPageMembers);\n+        } else {\n+            logger.fine(\"readItem: End of reading!\");\n+        }\n+\n+        return patientPageMembers;\n+    }\n+\n+    @Override\n+    public void open(Serializable checkpoint) throws Exception {\n+        if (checkpoint != null) {\n+            CheckPointUserData checkPointData = (CheckPointUserData) checkpoint;\n+            pageNum = checkPointData.getPageNum();\n+            indexOfCurrentResourceType = checkPointData.getIndexOfCurrentResourceType();\n+            jobContext.setTransientUserData(TransientUserData.fromCheckPointUserData(checkPointData));\n+        }\n+    }\n+\n+    @Override\n+    public void close() throws Exception {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 320}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NjQyNQ==", "bodyText": "also chunkData.getBufferStream() <-- who is response to close this?", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370146425", "createdAt": "2020-01-23T14:24:37Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        if (patientMembers == null) {\n+            Group group = findGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+            patientMembers = new ArrayList<>();\n+            // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+            HashSet<String> groupsInPath = new HashSet<>();\n+            expandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+        }\n+        List<Member> patientPageMembers = patientMembers.subList((pageNum - 1) * pageSize,\n+                pageNum * pageSize <= patientMembers.size() ? pageNum * pageSize : patientMembers.size());\n+        pageNum++;\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(pageNum, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+            chunkData.setPageNum(pageNum);\n+        }\n+        chunkData.setLastPageNum((patientMembers.size() + pageSize -1)/pageSize );\n+\n+        if (!patientPageMembers.isEmpty()) {\n+            logger.fine(\"readItem: loaded patients number - \" + patientMembers.size());\n+            fillChunkDataBuffer(patientPageMembers);\n+        } else {\n+            logger.fine(\"readItem: End of reading!\");\n+        }\n+\n+        return patientPageMembers;\n+    }\n+\n+    @Override\n+    public void open(Serializable checkpoint) throws Exception {\n+        if (checkpoint != null) {\n+            CheckPointUserData checkPointData = (CheckPointUserData) checkpoint;\n+            pageNum = checkPointData.getPageNum();\n+            indexOfCurrentResourceType = checkPointData.getIndexOfCurrentResourceType();\n+            jobContext.setTransientUserData(TransientUserData.fromCheckPointUserData(checkPointData));\n+        }\n+    }\n+\n+    @Override\n+    public void close() throws Exception {\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NTk3OQ=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 320}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3ODY5OQ==", "bodyText": "haha, good question. Actually Closing a ByteArrayOutputStream has no effect per java document, actually the function is empty in codes. it's handled by garbage collector after no reference to it.  and the same ByteArrayOutputStream is used the whole life circle of the batch job.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370178699", "createdAt": "2020-01-23T15:16:46Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        if (patientMembers == null) {\n+            Group group = findGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+            patientMembers = new ArrayList<>();\n+            // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+            HashSet<String> groupsInPath = new HashSet<>();\n+            expandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+        }\n+        List<Member> patientPageMembers = patientMembers.subList((pageNum - 1) * pageSize,\n+                pageNum * pageSize <= patientMembers.size() ? pageNum * pageSize : patientMembers.size());\n+        pageNum++;\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(pageNum, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+            chunkData.setPageNum(pageNum);\n+        }\n+        chunkData.setLastPageNum((patientMembers.size() + pageSize -1)/pageSize );\n+\n+        if (!patientPageMembers.isEmpty()) {\n+            logger.fine(\"readItem: loaded patients number - \" + patientMembers.size());\n+            fillChunkDataBuffer(patientPageMembers);\n+        } else {\n+            logger.fine(\"readItem: End of reading!\");\n+        }\n+\n+        return patientPageMembers;\n+    }\n+\n+    @Override\n+    public void open(Serializable checkpoint) throws Exception {\n+        if (checkpoint != null) {\n+            CheckPointUserData checkPointData = (CheckPointUserData) checkpoint;\n+            pageNum = checkPointData.getPageNum();\n+            indexOfCurrentResourceType = checkPointData.getIndexOfCurrentResourceType();\n+            jobContext.setTransientUserData(TransientUserData.fromCheckPointUserData(checkPointData));\n+        }\n+    }\n+\n+    @Override\n+    public void close() throws Exception {\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NTk3OQ=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 320}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NTcxMQ==", "bodyText": "OK, I think adding a comment to that effect is good thing in the code.", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370185711", "createdAt": "2020-01-23T15:27:15Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/group/ChunkReader.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * (C) Copyright IBM Corp. 2019, 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.group;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.chunk.AbstractItemReader;\n+import javax.batch.runtime.context.JobContext;\n+import javax.inject.Inject;\n+\n+import com.ibm.cloud.objectstorage.services.s3.model.PartETag;\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+import com.ibm.fhir.bulkexport.common.TransientUserData;\n+import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.format.Format;\n+import com.ibm.fhir.model.generator.FHIRGenerator;\n+import com.ibm.fhir.model.generator.exception.FHIRGeneratorException;\n+import com.ibm.fhir.model.resource.Group;\n+import com.ibm.fhir.model.resource.Group.Member;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.util.ModelSupport;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.search.compartment.CompartmentUtil;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+/**\n+ * Bulk patient group export Chunk implementation - the Reader.\n+ */\n+public class ChunkReader extends AbstractItemReader {\n+    int pageNum = 1;\n+    // List for the patients\n+    List<Member> patientMembers = null;\n+    private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n+    int indexOfCurrentResourceType = 0;\n+    // Control the number of records to read in each page.\n+    int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n+\n+    private FHIRPersistence fhirPersistence;\n+    private List<String> resourceTypes;\n+\n+    /**\n+     * Fhir tenant id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.tenant\")\n+    String fhirTenant;\n+\n+    /**\n+     * Fhir data store id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.datastoreid\")\n+    String fhirDatastoreId;\n+\n+    /**\n+     * Fhir ResourceType.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.resourcetype\")\n+    String fhirResourceType;\n+\n+    /**\n+     * Fhir Search from date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.fromdate\")\n+    String fhirSearchFromDate;\n+\n+    /**\n+     * Fhir search to date.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.todate\")\n+    String fhirSearchToDate;\n+\n+    /**\n+     * Fhir search patient group id.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.patientgroupid\")\n+    String fhirSearchPatientGroupId;\n+\n+    /**\n+     * Fhir search page size.\n+     */\n+    @Inject\n+    @BatchProperty(name = \"fhir.search.pagesize\")\n+    String fhirSearchPageSize;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    public ChunkReader() {\n+        super();\n+    }\n+\n+    private void fillChunkDataBuffer(List<Member> patientRefs) throws Exception {\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        int compartmentPageNum = 1;\n+        int resSubTotal = 0;\n+        FHIRSearchContext searchContext;\n+        Class<? extends Resource> resourceType = ModelSupport\n+                .getResourceType(resourceTypes.get(indexOfCurrentResourceType));\n+        if (chunkData != null) {\n+            for (Member patientRef : patientRefs) {\n+                if (patientRef == null) {\n+                    continue;\n+                }\n+\n+                String patientId =  patientRef.getEntity().getReference().getValue().substring(8);\n+                Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+                List<String> searchCreterial = new ArrayList<String>();\n+\n+                if (fhirSearchFromDate != null) {\n+                    searchCreterial.add(\"ge\" + fhirSearchFromDate);\n+                }\n+                if (fhirSearchToDate != null) {\n+                    searchCreterial.add(\"lt\" + fhirSearchToDate);\n+                }\n+                if (!searchCreterial.isEmpty()) {\n+                    queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCreterial);\n+                }\n+\n+                queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n+                searchContext = SearchUtil.parseQueryParameters(\"Patient\", patientId,\n+                        ModelSupport.getResourceType(resourceTypes.get(indexOfCurrentResourceType)), queryParameters, null, true);\n+                do {\n+                    searchContext.setPageSize(pageSize);\n+                    searchContext.setPageNumber(compartmentPageNum);\n+                    FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+                    txn.begin();\n+                    FHIRPersistenceContext persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+                    List<Resource> resources2 = fhirPersistence.search(persistenceContext, resourceType).getResource();\n+                    txn.commit();\n+                    compartmentPageNum++;\n+\n+                    for (Resource res2 : resources2) {\n+                        if (res2 == null) {\n+                            continue;\n+                        }\n+                        try {\n+                            FHIRGenerator.generator(Format.JSON).generate(res2, chunkData.getBufferStream());\n+                            chunkData.getBufferStream().write(Constants.NDJSON_LINESEPERATOR.getBytes());\n+                            resSubTotal++;\n+                        } catch (FHIRGeneratorException e) {\n+                            logger.log(Level.WARNING, \"fillChunkDataBuffer: Error while writing resources with id '\"\n+                                        + patientId + \"'\", e);\n+                        } catch (IOException e) {\n+                            logger.warning(\"fillChunkDataBuffer: chunkDataBuffer written error!\");\n+                            throw e;\n+                        }\n+                    }\n+\n+                } while (searchContext.getLastPageNumber() >= compartmentPageNum);\n+            }\n+            chunkData.setCurrentPartResourceNum(chunkData.getCurrentPartResourceNum() + resSubTotal);\n+            logger.fine(\"fillChunkDataBuffer: Processed resources - \" + resSubTotal + \"; Bufferred data size - \"\n+                    + chunkData.getBufferStream().size());\n+        } else {\n+            logger.warning(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+            throw new Exception(\"fillChunkDataBuffer: chunkData is null, this should never happen!\");\n+        }\n+    }\n+\n+    private void expandGroup2Patients(String fhirTenant, String fhirDatastoreId, Group group, List<Member> patients, HashSet<String> groupsInPath)\n+            throws Exception{\n+        if (group == null) {\n+            return;\n+        }\n+        groupsInPath.add(group.getId());\n+        for (Member member : group.getMember()) {\n+            String refValue = member.getEntity().getReference().getValue();\n+            if (refValue.startsWith(\"Patient\")) {\n+                patients.add(member);\n+            } else if (refValue.startsWith(\"Group\")) {\n+                Group group2 = findGroupByID(fhirTenant, fhirDatastoreId, refValue.substring(6));\n+                if (!groupsInPath.contains(group.getId())) {\n+                    expandGroup2Patients(fhirTenant, fhirDatastoreId, group2, patients, groupsInPath);\n+                }\n+            }\n+        }\n+    }\n+\n+    private Group findGroupByID(String fhirTenant, String fhirDatastoreId, String groupId) throws Exception{\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        FHIRPersistenceHelper fhirPersistenceHelper = new FHIRPersistenceHelper();\n+        fhirPersistence = fhirPersistenceHelper.getFHIRPersistenceImplementation();\n+\n+        FHIRSearchContext searchContext;\n+        FHIRPersistenceContext persistenceContext;\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+\n+        queryParameters.put(\"_id\", Arrays.asList(new String[] { groupId }));\n+        searchContext = SearchUtil.parseQueryParameters(Group.class, queryParameters);\n+        List<Resource> resources = null;\n+        FHIRTransactionHelper txn = new FHIRTransactionHelper(fhirPersistence.getTransaction());\n+        txn.begin();\n+        persistenceContext = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+        resources = fhirPersistence.search(persistenceContext, Group.class).getResource();\n+        txn.commit();\n+\n+        if (resources != null) {\n+            return (Group) resources.get(0);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public Object readItem() throws Exception {\n+        List <String> allCompartmentResourceTypes = CompartmentUtil.getCompartmentResourceTypes(\"Patient\");\n+        if (fhirResourceType == null ) {\n+            resourceTypes = allCompartmentResourceTypes;\n+        } else {\n+            List<String> tmpResourceTypes = Arrays.asList(fhirResourceType.split(\"\\\\s*,\\\\s*\"));\n+            resourceTypes = tmpResourceTypes.stream().filter(item-> allCompartmentResourceTypes.contains(item)).collect(Collectors.toList());\n+            if (resourceTypes == null || resourceTypes.isEmpty()) {\n+                throw new Exception(\"readItem: None of the input resource types is valid!\");\n+            }\n+        }\n+\n+        if (fhirSearchPatientGroupId == null) {\n+            throw new Exception(\"readItem: missing group id for this group export job!\");\n+        }\n+\n+        TransientUserData chunkData = (TransientUserData) jobContext.getTransientUserData();\n+        if (chunkData != null && pageNum > chunkData.getLastPageNum()) {\n+            if (resourceTypes.size() == indexOfCurrentResourceType + 1) {\n+                // No more resource type and page to read, so return null to end the reading.\n+                return null;\n+            } else {\n+                // More resource types to read, so reset pageNum, partNum and move resource type index to the next.\n+                pageNum = 1;\n+                chunkData.setPartNum(1);\n+                indexOfCurrentResourceType++;\n+            }\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"readItem: Set DatastoreId to default!\");\n+        }\n+        if (fhirSearchPageSize != null) {\n+            try {\n+                pageSize = Integer.parseInt(fhirSearchPageSize);\n+                logger.fine(\"readItem: Set page size to \" + pageSize + \".\");\n+            } catch (Exception e) {\n+                logger.warning(\"readItem: Set page size to default(\" + Constants.DEFAULT_SEARCH_PAGE_SIZE + \").\");\n+            }\n+        }\n+\n+        if (patientMembers == null) {\n+            Group group = findGroupByID(fhirTenant, fhirDatastoreId, fhirSearchPatientGroupId);\n+            patientMembers = new ArrayList<>();\n+            // List for the group and sub groups in the expansion paths, this is used to avoid dead loop caused by circle reference of the groups.\n+            HashSet<String> groupsInPath = new HashSet<>();\n+            expandGroup2Patients(fhirTenant, fhirDatastoreId, group, patientMembers, groupsInPath);\n+        }\n+        List<Member> patientPageMembers = patientMembers.subList((pageNum - 1) * pageSize,\n+                pageNum * pageSize <= patientMembers.size() ? pageNum * pageSize : patientMembers.size());\n+        pageNum++;\n+\n+        if (chunkData == null) {\n+            chunkData = new TransientUserData(pageNum, null, new ArrayList<PartETag>(), 1);\n+            chunkData.setIndexOfCurrentResourceType(0);\n+            jobContext.setTransientUserData(chunkData);\n+        } else {\n+            chunkData.setIndexOfCurrentResourceType(indexOfCurrentResourceType);\n+            chunkData.setPageNum(pageNum);\n+        }\n+        chunkData.setLastPageNum((patientMembers.size() + pageSize -1)/pageSize );\n+\n+        if (!patientPageMembers.isEmpty()) {\n+            logger.fine(\"readItem: loaded patients number - \" + patientMembers.size());\n+            fillChunkDataBuffer(patientPageMembers);\n+        } else {\n+            logger.fine(\"readItem: End of reading!\");\n+        }\n+\n+        return patientPageMembers;\n+    }\n+\n+    @Override\n+    public void open(Serializable checkpoint) throws Exception {\n+        if (checkpoint != null) {\n+            CheckPointUserData checkPointData = (CheckPointUserData) checkpoint;\n+            pageNum = checkPointData.getPageNum();\n+            indexOfCurrentResourceType = checkPointData.getIndexOfCurrentResourceType();\n+            jobContext.setTransientUserData(TransientUserData.fromCheckPointUserData(checkPointData));\n+        }\n+    }\n+\n+    @Override\n+    public void close() throws Exception {\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NTk3OQ=="}, "originalCommit": {"oid": "3f7248a159d479d2f59db706924fd31293a809bd"}, "originalPosition": 320}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODA2NzAzOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNToxNTozMlrOFhB3fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNToxNTozMlrOFhB3fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3NzkxNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: \n          \n          \n            \n            BulkData web application writes the exported FHIR resources to an IBM Cloud Object Storage (COS) or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file. The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS:", "url": "https://github.com/IBM/FHIR/pull/594#discussion_r370177917", "createdAt": "2020-01-23T15:15:32Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1098,6 +1099,143 @@ team can more easilly read the messages.\n It is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\n database hostname or database schema name.\n \n+## 4.10 Bulk data operations\n+### 4.10.1 Bulk data export\n+Bulk data export is implemented according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html).\n+There are 2 modules involved inside the implementation:\n+- fhir-operation-bulkdata\n+- fhir-bulkimportexport-webapp   \n+\n+To integration test, there are tests in ExportOperationTest.java in fhir-server-test module with server integration test cases for system, patient and group export.  \n+The *fhir-operation-bulkdata* module implements the REST APIs for bulk data export as FHIR operations.  There are three operations:\n+* ExportOperation - system export\n+* PatientExportOperation - Patient export\n+* GroupExportOperation - group export.\n+Each operation calls the JavaBatch framework defined in the *fhir-bulkimportexport-webapp* module to execute the export unit-of-work.   \n+There are 3 chunk style JavaBatch jobs defined as following in *fhir-bulkimportexport-webapp* module for the above 3 export operations:  \n+\n+- FhirBulkExportChunkJob\n+- FhirBulkExportPatientChunkJob\n+- FhirBulkExportGroupChunkJob\n+\n+The *fhir-bulkimportexport-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkimportexport.war. This web archive is copied to the apps directory of the liberty fhir-server instance. Following is a sample liberty server configuration (server.xml) for fhir-bulkimportexport.war:\n+\n+```xml\n+    <webApplication id=\"fhir-bulkimportexport-webapp\" location=\"fhir-bulkimportexport.war\" name=\"fhir-bulkimportexport-webapp\">\n+        <classloader commonLibraryRef=\"fhirSharedLib\" privateLibraryRef=\"configResources,fhirUserLib\"/>\n+        <application-bnd>\n+            <security-role id=\"users\" name=\"FHIRUsers\">\n+                <group name=\"FHIRUsers\"/>\n+            </security-role>\n+        </application-bnd>\n+    </webApplication>\n+```\n+\n+BulkData web application writes the exported FHIR resources to IBM COS or Amazon S3 bucket, as configured in the per-tenant bulkdata.json configuration file.  The bulkdata.json file is stored in the tenant configuration directory of each fhir-server instance. The following is a bulkdata.json which is configured to export the FHIR resources into fhir-bulkdata-sample bucket of IBM COS: ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a50e91deb919bf5c15ef5710bfb1eb1640556ba2"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 212, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}