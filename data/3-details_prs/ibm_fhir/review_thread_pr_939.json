{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0OTIxNzI3", "number": 939, "reviewThreads": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDoyODoyN1rODzCTCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMzowMjo1MVrOD0vrvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQxNjA4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDoyODoyN1rOGHcINA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDoyODoyN1rOGHcINA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NDA2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To properly configure the FHIR server's keystore and truststore files, perform the following steps:\n          \n          \n            \n            To properly configure the FHIR server's keystore and truststore files, perform the following steps.\n          \n      \n    \n    \n  \n\nend in a period, since the other parts are now no longer build points rather sections", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410454068", "createdAt": "2020-04-17T20:28:27Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1454,17 +1455,19 @@ must restart the server for that change to take effect.\n As stated earlier, the FHIR server is installed with a default configuration in `server.xml` which includes the definition of a keystore (`fhirKeystore.jks`) and a truststore (`fhirTruststore.jks`)<sup id=\"a7\">[7](#f7)</sup>. These files are provided only as examples and while they may suffice in a test environment, the FHIR server deployer should generate a new keystore and truststore for any installations where security is a concern. Review the information in the following topics to learn how to configure a secure keystore and truststore.\n \n ### 5.2.2 WebApp security\n-By default, the FHIR server REST API is available on both HTTP and HTTPS endpoints. In addition, the web application (WAR) that contains the FHIR server's REST API implementation is secured via client certificate-based authentication. As a backup to the client authentication scheme, basic authentication is also supported. If the client chooses to use OAuth 2.0 authentication using a Bearer Token mechanism, this can be done as well and is described in more detail in [Section 5.2.5 Oauth 2.0](#525-oauth-20).\n+By default, the FHIR server REST API is only available via HTTPS on port 9443 and protect by HTTP basic authentication.\n+Alternatively, the server can use OpenID Connect and OAuth 2.0 via a Bearer Token as described in [Section 5.2.4 Oauth 2.0](#524-oauth-20).\n+In addition, the FHIR server web application can be secured via client certificate-based authentication.\n \n Here are some notes related to these authentication schemes:\n-*   Basic authentication is a very simple authentication scheme and can be used on both HTTP or HTTPS endpoints, although it is extremely insecure when used with an HTTP endpoint since the user and password information is essentially transmitted in plain text.\n-*   Client certificate-based authentication can only be used in conjunction with an HTTPS endpoint since it involves SSL handshake negotiations.\n-*   The main value of client authentication is that the server is able to securely authenticate the client through the use of certificates.\n-*   OAuth 2.0 authentication can only be used in conjunction with an HTTPS endpoint, because OAuth authorization steps rely on SSL handshake negotiations.\n+*   Basic authentication is a very simple authentication scheme and should only be used over HTTPS because the username and password are essentially transmitted in plain text.\n+*   OAuth 2.0 authentication can only be used in conjunction with an HTTPS endpoint because the OAuth authorization steps rely on SSL handshake negotiations.\n+*   Client certificate-based authentication can only be used in conjunction with an HTTPS endpoint since it involves SSL handshake negotiations. The main value of client authentication is that the server is able to securely authenticate the client through the use of certificates.\n \n-### 5.2.3 Server configuration steps\n+### 5.2.3 Configuring mutual TLS authentication\n To properly configure the FHIR server's keystore and truststore files, perform the following steps:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQyMjM2OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMTowNVrOGHcMbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMTowNVrOGHcMbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NTE0OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n          \n          \n            \n            as well.\n          \n          \n            \n            The following sections are adapted from [WebSphere Liberty knowledge center](https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html) and related pages; the steps apply to OpenLiberty as well.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410455148", "createdAt": "2020-04-17T20:31:05Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQyNTExOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMjoxMVrOGHcOLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo0NToyMFrOGIB7uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NTU5Nw==", "bodyText": "maybe mention that the server.xml has the feature enabled by default? it's just not configured?", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410455597", "createdAt": "2020-04-17T20:32:11Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3MzQ2Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n          \n          \n            \n            Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html). This feature is enabled by default, but must be configured as described in the following sections to take effect.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411073467", "createdAt": "2020-04-20T03:45:20Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NTU5Nw=="}, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQyNjQ5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMjo0MlrOGHcPEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMjo0MlrOGHcPEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NTgyNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n          \n          \n            \n            OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at [Defining OAuth](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html).", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410455826", "createdAt": "2020-04-17T20:32:42Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQyNzU5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMzoxNVrOGHcP3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo0Njo1N1rOGIB9ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NjAyOQ==", "bodyText": "should this be datasource?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To support \"dynamic client registration\", use a databaseStore by:\n          \n          \n            \n            To support \"dynamic client registration\", use a dataSource by:", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410456029", "createdAt": "2020-04-17T20:33:15Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3Mzg5Mw==", "bodyText": "No, I think databaseStore is right.  Previous sentence says you can use a \"localStore\" or a \"databaseStore\" and that is the actual element under oauthProvider.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411073893", "createdAt": "2020-04-20T03:46:57Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NjAyOQ=="}, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQyODkxOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMzo0N1rOGHcQxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNDoxMDoyN1rOGJ4jpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NjI2Mg==", "bodyText": "put this in a file in the fhir-server?", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410456262", "createdAt": "2020-04-17T20:33:47Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3NDgwOQ==", "bodyText": "yeah.  i still think its dumb that we need to create these tables at all...why doesn't it just auto-create the tables like the batch feature?\nanyway, I need to decide how to package all this info to make it easier to configure.  I was thinking it would just be an optional configDropin, but then we have this stupid DDL that we need to run.  Maybe we just invoke it as part of fhir-persistence-schema even though its only used if you are using OAuth with a databaseStore...", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411074809", "createdAt": "2020-04-20T03:50:28Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NjI2Mg=="}, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAxNjk5Ng==", "bodyText": "I've now modified fhir-persistence-schema to deploy these tables by default.\nAdditionally, I updated the derby bootstrapping to create them when the jdbc/OAuth2DB datasource is available.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r413016996", "createdAt": "2020-04-22T14:10:27Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NjI2Mg=="}, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 138}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzMDA0OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNDoxM1rOGHcRfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNDoxM1rOGHcRfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NjQ0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n          \n          \n            \n            2. Manually creating the necessary tables in your database as described at [OAuth Databases](https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html):", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410456445", "createdAt": "2020-04-17T20:34:13Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 136}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzMTM1OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNDo0OFrOGHcSVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNDo0OFrOGHcSVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NjY2MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n          \n          \n            \n            3. Attempting to register a client (based on the [Client Registration Article](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html)). The endpoint is determined by the id value of the oauthProvider element from the previous step.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410456660", "createdAt": "2020-04-17T20:34:48Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 191}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzMjk0OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNTozN1rOGHcTdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNTozN1rOGHcTdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1Njk0OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To add the OpenID Connect Provider config, you must first create a key to use for\n          \n          \n            \n            the signatureAlgorithm.\n          \n          \n            \n            To add the OpenID Connect Provider config, you must first create a key to use for the signatureAlgorithm.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410456949", "createdAt": "2020-04-17T20:35:37Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 231}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzMzI0OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNTo0OFrOGHcTrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNTo0OFrOGHcTrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NzAwNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n          \n          \n            \n            Instead, allow Liberty to generate its own keystore and use that.\n          \n          \n            \n            Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.  Instead, allow Liberty to generate its own keystore and use that.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410457005", "createdAt": "2020-04-17T20:35:48Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 234}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzNDQwOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNjoxNFrOGHcUag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNjoxNFrOGHcUag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NzE5NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n          \n          \n            \n            the token endpoint with the configured code for your client to obtain an access token.\n          \n          \n            \n            After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke the token endpoint with the configured code for your client to obtain an access token.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410457194", "createdAt": "2020-04-17T20:36:14Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 246}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzNTA1OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNjozMlrOGHcUzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNjozMlrOGHcUzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NzI5Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n          \n          \n            \n            For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL is", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410457293", "createdAt": "2020-04-17T20:36:32Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 249}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzNTMxOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNjo0MlrOGHcVAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNjo0MlrOGHcVAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NzM0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.\n          \n          \n            \n            `https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL is `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410457345", "createdAt": "2020-04-17T20:36:42Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n+`https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 250}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzNzIwOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNzozM1rOGHcWVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozNzozM1rOGHcWVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NzY4Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer\n          \n          \n            \n            * keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer\n          \n          \n            \n            \n          \n          \n            \n            2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n          \n          \n            \n            * keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n          \n          \n            \n            * keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n          \n          \n            \n            * `keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer`\n          \n          \n            \n            * `keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer`\n          \n          \n            \n            \n          \n          \n            \n            2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n          \n          \n            \n            * `keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt`\n          \n          \n            \n            * `keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt`", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410457687", "createdAt": "2020-04-17T20:37:33Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n+`https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.\n+\n+### 5.3.2 Configure Liberty as the OpenID Connect Relying Party\n+Liberty can be configured to act as an OpenID Connect Relying Party via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html).\n+\n+### 5.3.2.1 Configure the trustStore\n+1. Export the server's certificate from the configured keystore via one of the following commands:\n+* keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer\n+* keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer\n+\n+2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n+* keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+* keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 262}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzODU5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozODowMVrOGHcXKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozODowMVrOGHcXKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1Nzg5OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ```\n          \n          \n            \n            ``` xml\n          \n      \n    \n    \n  \n\ndoing this one for formatting demo", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410457898", "createdAt": "2020-04-17T20:38:01Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n+`https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.\n+\n+### 5.3.2 Configure Liberty as the OpenID Connect Relying Party\n+Liberty can be configured to act as an OpenID Connect Relying Party via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html).\n+\n+### 5.3.2.1 Configure the trustStore\n+1. Export the server's certificate from the configured keystore via one of the following commands:\n+* keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer\n+* keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer\n+\n+2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n+* keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+* keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+\n+### 5.3.2.2 Configure server.xml\n+Add an openidConnectClient element to the server.xml config and point at the trustStore from the previous section:\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 266}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQzOTg5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozODo0MFrOGHcYGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo1Mzo0OFrOGICEeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1ODEzOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <requestUrl urlPattern=\"/fhir-server\" />\n          \n          \n            \n                <requestUrl urlPattern=\"/fhir-server\" />\n          \n      \n    \n    \n  \n\nshould we make a note about bulkimport not being client usable?", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410458138", "createdAt": "2020-04-17T20:38:40Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n+`https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.\n+\n+### 5.3.2 Configure Liberty as the OpenID Connect Relying Party\n+Liberty can be configured to act as an OpenID Connect Relying Party via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html).\n+\n+### 5.3.2.1 Configure the trustStore\n+1. Export the server's certificate from the configured keystore via one of the following commands:\n+* keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer\n+* keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer\n+\n+2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n+* keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+* keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+\n+### 5.3.2.2 Configure server.xml\n+Add an openidConnectClient element to the server.xml config and point at the trustStore from the previous section:\n+```\n+<openidConnectClient id=\"RS\" inboundPropagation=\"required\"\n+    clientId=\"inferno\"\n+    mapIdentityToRegistryUser=\"true\"\n+    trustStoreRef=\"defaultKeyStore\"\n+    trustAliasName=\"libertyop\"\n+    validationEndpointUrl=\"https://localhost:9443/oidc/endpoint/oidc-provider/introspect\"\n+    signatureAlgorithm=\"RS256\"\n+    authFilterRef=\"filter\"\n+    issuerIdentifier=\"https://localhost:9443/oauth2/endpoint/oauth2-provider,https://host.docker.internal:9443/oauth2/endpoint/oauth2-provider\"\n+    />\n+\n+<authFilter id=\"filter\">\n+    <requestUrl urlPattern=\"/fhir-server\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 279}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3NTcwNg==", "bodyText": "I guess we should figure out how to secure that endpoint via OAuth too...not totally sure how to handle the different groups yet.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411075706", "createdAt": "2020-04-20T03:53:48Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n+`https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.\n+\n+### 5.3.2 Configure Liberty as the OpenID Connect Relying Party\n+Liberty can be configured to act as an OpenID Connect Relying Party via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html).\n+\n+### 5.3.2.1 Configure the trustStore\n+1. Export the server's certificate from the configured keystore via one of the following commands:\n+* keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer\n+* keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer\n+\n+2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n+* keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+* keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+\n+### 5.3.2.2 Configure server.xml\n+Add an openidConnectClient element to the server.xml config and point at the trustStore from the previous section:\n+```\n+<openidConnectClient id=\"RS\" inboundPropagation=\"required\"\n+    clientId=\"inferno\"\n+    mapIdentityToRegistryUser=\"true\"\n+    trustStoreRef=\"defaultKeyStore\"\n+    trustAliasName=\"libertyop\"\n+    validationEndpointUrl=\"https://localhost:9443/oidc/endpoint/oidc-provider/introspect\"\n+    signatureAlgorithm=\"RS256\"\n+    authFilterRef=\"filter\"\n+    issuerIdentifier=\"https://localhost:9443/oauth2/endpoint/oauth2-provider,https://host.docker.internal:9443/oauth2/endpoint/oauth2-provider\"\n+    />\n+\n+<authFilter id=\"filter\">\n+    <requestUrl urlPattern=\"/fhir-server\" />", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1ODEzOA=="}, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 279}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQ0MTkwOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozOToxOVrOGHcZSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozOToxOVrOGHcZSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1ODQ0MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Note: if the server is also acting as an OAuth/OpenId Connect provider, be sure to include an authFilter to avoid a catch-22 where\n          \n          \n            \n            the token and authorization endpoints are themselves protected by the openidConnectClient.\n          \n          \n            \n            Note: if the server is also acting as an OAuth/OpenId Connect provider, be sure to include an authFilter to avoid the problem where the token and authorization endpoints are protected by the openidConnectClient.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410458441", "createdAt": "2020-04-17T20:39:19Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n+`https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.\n+\n+### 5.3.2 Configure Liberty as the OpenID Connect Relying Party\n+Liberty can be configured to act as an OpenID Connect Relying Party via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html).\n+\n+### 5.3.2.1 Configure the trustStore\n+1. Export the server's certificate from the configured keystore via one of the following commands:\n+* keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer\n+* keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer\n+\n+2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n+* keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+* keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+\n+### 5.3.2.2 Configure server.xml\n+Add an openidConnectClient element to the server.xml config and point at the trustStore from the previous section:\n+```\n+<openidConnectClient id=\"RS\" inboundPropagation=\"required\"\n+    clientId=\"inferno\"\n+    mapIdentityToRegistryUser=\"true\"\n+    trustStoreRef=\"defaultKeyStore\"\n+    trustAliasName=\"libertyop\"\n+    validationEndpointUrl=\"https://localhost:9443/oidc/endpoint/oidc-provider/introspect\"\n+    signatureAlgorithm=\"RS256\"\n+    authFilterRef=\"filter\"\n+    issuerIdentifier=\"https://localhost:9443/oauth2/endpoint/oauth2-provider,https://host.docker.internal:9443/oauth2/endpoint/oauth2-provider\"\n+    />\n+\n+<authFilter id=\"filter\">\n+    <requestUrl urlPattern=\"/fhir-server\" />\n+</authFilter>\n+```\n+\n+Note: if the server is also acting as an OAuth/OpenId Connect provider, be sure to include an authFilter to avoid a catch-22 where\n+the token and authorization endpoints are themselves protected by the openidConnectClient.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 284}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQ0MjQ4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozOTozNVrOGHcZqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozOTozNVrOGHcZqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1ODUzOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            To configure the FHIR Server with the OpenID Connect and OAuth 2.0 endpoints for the providers,\n          \n          \n            \n            specify the following values in the default fhir-server-config.json file:\n          \n          \n            \n            To configure the FHIR Server with the OpenID Connect and OAuth 2.0 endpoints for the providers, specify the following values in the default fhir-server-config.json file:", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410458538", "createdAt": "2020-04-17T20:39:35Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n+`https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.\n+\n+### 5.3.2 Configure Liberty as the OpenID Connect Relying Party\n+Liberty can be configured to act as an OpenID Connect Relying Party via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html).\n+\n+### 5.3.2.1 Configure the trustStore\n+1. Export the server's certificate from the configured keystore via one of the following commands:\n+* keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer\n+* keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer\n+\n+2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n+* keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+* keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+\n+### 5.3.2.2 Configure server.xml\n+Add an openidConnectClient element to the server.xml config and point at the trustStore from the previous section:\n+```\n+<openidConnectClient id=\"RS\" inboundPropagation=\"required\"\n+    clientId=\"inferno\"\n+    mapIdentityToRegistryUser=\"true\"\n+    trustStoreRef=\"defaultKeyStore\"\n+    trustAliasName=\"libertyop\"\n+    validationEndpointUrl=\"https://localhost:9443/oidc/endpoint/oidc-provider/introspect\"\n+    signatureAlgorithm=\"RS256\"\n+    authFilterRef=\"filter\"\n+    issuerIdentifier=\"https://localhost:9443/oauth2/endpoint/oauth2-provider,https://host.docker.internal:9443/oauth2/endpoint/oauth2-provider\"\n+    />\n+\n+<authFilter id=\"filter\">\n+    <requestUrl urlPattern=\"/fhir-server\" />\n+</authFilter>\n+```\n+\n+Note: if the server is also acting as an OAuth/OpenId Connect provider, be sure to include an authFilter to avoid a catch-22 where\n+the token and authorization endpoints are themselves protected by the openidConnectClient.\n+\n+### 5.3.3 Configure the fhir-server\n+To configure the FHIR Server with the OpenID Connect and OAuth 2.0 endpoints for the providers,\n+specify the following values in the default fhir-server-config.json file:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 288}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQ0NDM4OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDo0MDoxNFrOGHca6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDo0MDoxNFrOGHca6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1ODg1Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When the Liberty server is the OpenID Connect / OAuth 2.0 provider, use a placeholder of `<host>` in the property values\n          \n          \n            \n            to have the server automatically replace this text with the hostname of the original request (see `fhirServer/core/originalRequestUriHeaderName`).\n          \n          \n            \n            \n          \n          \n            \n            These values will be used to populate the corresponding entries in both the server capability statement (`GET [base]/metadata`)\n          \n          \n            \n            and the smart-configuration (`GET [base]/.well-known/smart-configuration`).\n          \n          \n            \n            \n          \n          \n            \n            For example, the following excerpt from a CapabilityStatement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n          \n          \n            \n            When the Liberty server is the OpenID Connect / OAuth 2.0 provider, use a placeholder of `<host>` in the property values to have the server automatically replace this text with the hostname of the original request (see `fhirServer/core/originalRequestUriHeaderName`).\n          \n          \n            \n            \n          \n          \n            \n            These values will be used to populate the corresponding entries in both the server capability statement (`GET [base]/metadata`) and the smart-configuration (`GET [base]/.well-known/smart-configuration`).\n          \n          \n            \n            \n          \n          \n            \n            For example, the following excerpt from a CapabilityStatement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r410458856", "createdAt": "2020-04-17T20:40:14Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n *   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n \n-### 5.2.5 OAuth 2.0\n-In the default configuration, the FHIR server acts as an authorization server as well as a resource server. The FHIR server's conformance statement includes the OAuth-related URLs you will need to get started. The following excerpt from a conformance statement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.\n+## 5.3 OpenID Connect and OAuth 2.0\n+The FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\n+The IBM FHIR Server supports these via Liberty's OpenID Connect support.\n+The following sections are adapted from https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html and related pages in the WebSphere Liberty knowledge center, but they apply to OpenLiberty\n+as well.\n+\n+### 5.3.1 Configure Liberty as the OpenID Connect Provider\n+Liberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html).\n+\n+### 5.3.1.1 Configure Liberty as an OAuth 2.0 Provider\n+OpenID Connect is built on OAuth 2.0 and so you must first configure Liberty as an OAuth provider as described at https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html.\n+\n+Liberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\n+To support \"dynamic client registration\", use a databaseStore by:\n \n+1. Configuring a clientManager oauth-role and specifying a databaseStore in the oauthProvider element of `server.xml`.\n+    For example, to use Apache Derby for the store, include something like the following:\n+    ```\n+    <oauth-roles>\n+        <authenticated>\n+            <special-subject type=\"ALL_AUTHENTICATED_USERS\"/>\n+        </authenticated>\n+        <clientManager>\n+            <group name=\"clientAdministrator\" />\n+        </clientManager>\n+    </oauth-roles>\n+\n+    <oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n+        <grantType>authorization_code</grantType>\n+        <databaseStore dataSourceRef=\"OAuthDataSource\" />\n+    </oauthProvider>\n+\n+    <dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n+        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n+        <jdbcDriver libraryRef=\"derbyLib\"/>\n+    </dataSource>\n+\n+    <library id=\"derbyLib\">\n+        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n+    </library>\n+    ```\n+\n+2. Manually creating the necessary tables in your database as described at https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html:\n+\n+```\n+----- CREATE TABLES -----\n+CREATE TABLE OAuthDBSchema.OAUTH20CACHE\n+(\n+  LOOKUPKEY VARCHAR(256) NOT NULL,\n+  UNIQUEID VARCHAR(128) NOT NULL,\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  TYPE VARCHAR(64) NOT NULL,\n+  SUBTYPE VARCHAR(64),\n+  CREATEDAT BIGINT,\n+  LIFETIME INT,\n+  EXPIRES BIGINT,\n+  TOKENSTRING VARCHAR(2048) NOT NULL,\n+  CLIENTID VARCHAR(64) NOT NULL,\n+  USERNAME VARCHAR(64) NOT NULL,\n+  SCOPE VARCHAR(512) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  STATEID VARCHAR(64) NOT NULL,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+(\n+  COMPONENTID VARCHAR(256) NOT NULL,\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  CLIENTSECRET VARCHAR(256),\n+  DISPLAYNAME VARCHAR(256) NOT NULL,\n+  REDIRECTURI VARCHAR(2048),\n+  ENABLED INT,\n+  CLIENTMETADATA CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+CREATE TABLE OAuthDBSchema.OAUTH20CONSENTCACHE\n+(\n+  CLIENTID VARCHAR(256) NOT NULL,\n+  USERID VARCHAR(256),\n+  PROVIDERID VARCHAR(256) NOT NULL,\n+  SCOPE VARCHAR(1024) NOT NULL,\n+  EXPIRES BIGINT,\n+  EXTENDEDFIELDS CLOB NOT NULL DEFAULT '{}'\n+);\n+\n+----- ADD CONSTRAINTS -----\n+ALTER TABLE OAuthDBSchema.OAUTH20CACHE\n+  ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);\n+\n+ALTER TABLE OAuthDBSchema.OAUTH20CLIENTCONFIG\n+  ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);\n+\n+----- CREATE INDEXES -----\n+CREATE INDEX OAUTH20CACHE_EXPIRES ON OAUTHDBSCHEMA.OAUTH20CACHE (EXPIRES ASC);\n+```\n+\n+3. Attempting to register a client (based on https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html). The endpoint is determined by the id value of the oauthProvider element from the previous step.\n+\n+For example, for an OAuth provider with `id=\"oauth2-provider\"`:\n+```\n+curl -u 'fhiruser:change-password' 'https://localhost:9443/oidc/endpoint/oauth2-provider/registration' \\\n+--header 'Content-Type: application/json' \\\n+--data-raw '{\n+   \"token_endpoint_auth_method\":\"client_secret_basic\",\n+   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"grant_types\":[\n+      \"authorization_code\",\n+      \"client_credentials\",\n+      \"implicit\",\n+      \"refresh_token\",\n+      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n+   ],\n+   \"response_types\":[\n+      \"code\",\n+      \"token\",\n+      \"id_token token\"\n+   ],\n+   \"application_type\":\"web\",\n+   \"subject_type\":\"public\",\n+   \"post_logout_redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ],\n+   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n+   \"introspect_tokens\":true,\n+   \"trusted_uri_prefixes\":[\n+      \"https://server.example.com:9000/trusted/\"\n+   ],\n+   \"redirect_uris\":[\n+      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n+   ]\n+}'\n+```\n+\n+### 5.3.1.2 Configure Liberty as an OAuth 2.0 Provider\n+\n+To add the OpenID Connect Provider config, you must first create a key to use for\n+the signatureAlgorithm.\n+\n+Note: the current private key in the fhirKeystore.jks keystore is NOT usable as a signing key.\n+Instead, allow Liberty to generate its own keystore and use that.\n+\n+Assuming the defaultKeyStore has a valid key for signing, add the openidConnectProvider element to your server.xml:\n+```\n+<openidConnectProvider id=\"oidc-provider\"\n+    oauthProviderRef=\"oauth2-provider\"\n+    keyStoreRef=\"defaultKeyStore\"\n+    signatureAlgorithm=\"RS256\" />\n+```\n+\n+### 5.3.1.3 Request an access token\n+After you've registered a client (either via dynamic registration or static config) and configured the openidConnectProvider, invoke\n+the token endpoint with the configured code for your client to obtain an access token.\n+\n+The specific endpoint is determined by the id value of the openidConnectProvider element from the previous section.\n+For example, for an OpenID Connect provider with `id=\"oidc-provider\"`, the auth URL will be\n+`https://[host]:[port]/oauth2/endpoint/oidc-provider/authorize` and the token URL will be `https://[host]:[port]/oauth2/endpoint/oidc-provider/token`.\n+\n+### 5.3.2 Configure Liberty as the OpenID Connect Relying Party\n+Liberty can be configured to act as an OpenID Connect Relying Party via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html).\n+\n+### 5.3.2.1 Configure the trustStore\n+1. Export the server's certificate from the configured keystore via one of the following commands:\n+* keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer\n+* keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer\n+\n+2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n+* keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+* keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt\n+\n+### 5.3.2.2 Configure server.xml\n+Add an openidConnectClient element to the server.xml config and point at the trustStore from the previous section:\n+```\n+<openidConnectClient id=\"RS\" inboundPropagation=\"required\"\n+    clientId=\"inferno\"\n+    mapIdentityToRegistryUser=\"true\"\n+    trustStoreRef=\"defaultKeyStore\"\n+    trustAliasName=\"libertyop\"\n+    validationEndpointUrl=\"https://localhost:9443/oidc/endpoint/oidc-provider/introspect\"\n+    signatureAlgorithm=\"RS256\"\n+    authFilterRef=\"filter\"\n+    issuerIdentifier=\"https://localhost:9443/oauth2/endpoint/oauth2-provider,https://host.docker.internal:9443/oauth2/endpoint/oauth2-provider\"\n+    />\n+\n+<authFilter id=\"filter\">\n+    <requestUrl urlPattern=\"/fhir-server\" />\n+</authFilter>\n+```\n+\n+Note: if the server is also acting as an OAuth/OpenId Connect provider, be sure to include an authFilter to avoid a catch-22 where\n+the token and authorization endpoints are themselves protected by the openidConnectClient.\n+\n+### 5.3.3 Configure the fhir-server\n+To configure the FHIR Server with the OpenID Connect and OAuth 2.0 endpoints for the providers,\n+specify the following values in the default fhir-server-config.json file:\n+* `fhirServer/oauth/regUrl`\n+* `fhirServer/oauth/authUrl`\n+* `fhirServer/oauth/tokenUrl`\n+\n+When the Liberty server is the OpenID Connect / OAuth 2.0 provider, use a placeholder of `<host>` in the property values\n+to have the server automatically replace this text with the hostname of the original request (see `fhirServer/core/originalRequestUriHeaderName`).\n+\n+These values will be used to populate the corresponding entries in both the server capability statement (`GET [base]/metadata`)\n+and the smart-configuration (`GET [base]/.well-known/smart-configuration`).\n+\n+For example, the following excerpt from a CapabilityStatement shows sample OAuth-related URLs (token, authorize, and register) as values of the `valueUri` elements.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 299}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1MzU4MjY5OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzozODowN1rOGIB0LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzozODowN1rOGIB0LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3MTUzMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              * [5.3 OpenID Connect and OAuth 2.0](#53-openid-connect-and-oauth-2_0)\n          \n          \n            \n              * [5.3 OpenID Connect and OAuth 2.0](#53-openid-connect-and-oauth-20)", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411071532", "createdAt": "2020-04-20T03:38:07Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -32,7 +32,8 @@ permalink: /FHIRServerUsersGuide/\n - [5 Appendix](#5-appendix)\n   * [5.1 Configuration properties reference](#51-configuration-properties-reference)\n   * [5.2 Keystores, truststores, and the FHIR server](#52-keystores-truststores-and-the-fhir-server)\n-  * [5.3 Custom HTTP Headers](#53-custom-http-headers)\n+  * [5.3 OpenID Connect and OAuth 2.0](#53-openid-connect-and-oauth-2_0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1MzU4NDkwOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzozOTowMFrOGIB1Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzozOTowMFrOGIB1Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3MTgwMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            By default, the FHIR server REST API is only available via HTTPS on port 9443 and protect by HTTP basic authentication.\n          \n          \n            \n            By default, the FHIR server REST API is only available via HTTPS on port 9443 and is protected by HTTP basic authentication.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411071802", "createdAt": "2020-04-20T03:39:00Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1454,17 +1455,19 @@ must restart the server for that change to take effect.\n As stated earlier, the FHIR server is installed with a default configuration in `server.xml` which includes the definition of a keystore (`fhirKeystore.jks`) and a truststore (`fhirTruststore.jks`)<sup id=\"a7\">[7](#f7)</sup>. These files are provided only as examples and while they may suffice in a test environment, the FHIR server deployer should generate a new keystore and truststore for any installations where security is a concern. Review the information in the following topics to learn how to configure a secure keystore and truststore.\n \n ### 5.2.2 WebApp security\n-By default, the FHIR server REST API is available on both HTTP and HTTPS endpoints. In addition, the web application (WAR) that contains the FHIR server's REST API implementation is secured via client certificate-based authentication. As a backup to the client authentication scheme, basic authentication is also supported. If the client chooses to use OAuth 2.0 authentication using a Bearer Token mechanism, this can be done as well and is described in more detail in [Section 5.2.5 Oauth 2.0](#525-oauth-20).\n+By default, the FHIR server REST API is only available via HTTPS on port 9443 and protect by HTTP basic authentication.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1MzU5MDgzOnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo0MjoxMVrOGIB4XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo0MjoxMVrOGIB4XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3MjYwNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n          \n          \n            \n            *   If the client is using the FHIR server's HTTPS endpoint, then the client's truststore should be configured with the certificate of the FHIR server<sup id=\"a11\">[11](#f11)</sup>.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411072604", "createdAt": "2020-04-20T03:42:11Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1MzU5MzE0OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo0MzoyMVrOGIB5kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo0MzoyMVrOGIB5kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3MjkxMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.\n          \n          \n            \n            *   If the client is using client certificate-based Authentication, then the client keystore must be configured with a certificate that is trusted by the FHIR server<sup id=\"a12\">[12](#f12)</sup>.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411072912", "createdAt": "2020-04-20T03:43:21Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1505,23 +1508,230 @@ To properly configure the FHIR server's keystore and truststore files, perform t\n     ```\n \n 6.  Import the client's public key certificate into the server's truststore:\n-keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n \n-7.  Be sure to copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n+    ```\n+    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n+    ```\n+\n+At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n \n-### 5.2.4 Client configuration\n-FHIR REST API consumers (clients) must be properly configured to successfully participate in client certificate-based authentication. The previous section provided instructions on how to configure a keystore and truststore on the server. Those instructions also included the steps involving the client keystore and truststore as well. At this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n+### 5.2.3.1 Configure the server\n+Copy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`$WLP_HOME/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n \n-Although the steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, the client has several main requirements, as summarized in the following list:\n+### 5.2.3.2 Configure the client\n+The precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n \n *   If the client is using the FHIR server's HTTPS endpoint, then the client truststore should be configured with the REST API client framework<sup id=\"a11\">[11](#f11)</sup>.\n *   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n *   If the client is using client certificate-based Authentication, then the client keystore must be configured with the REST API client framework<sup id=\"a12\">[12](#f12)</sup>.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1MzYxNjU0OnYy", "diffSide": "RIGHT", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo1NToxMFrOGICFyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMzo1NToxMFrOGICFyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA3NjA0Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            SMART on FHIR applications should use the `.well-known` endpoint to determine the OAuth URLs to use for authorization,\n          \n          \n            \n            SMART on FHIR applications should use the `.well-known/smart-configuration` endpoint to determine the OAuth URLs to use for authorization,", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r411076043", "createdAt": "2020-04-20T03:55:10Z", "author": {"login": "lmsurpre"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1530,38 +1740,30 @@ In the default configuration, the FHIR server acts as an authorization server as\n       \"security\": {\n         \"extension\": [\n           {\n-            \"url\": \"http://<SERVER>\",\n+            \"url\": \"http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris\"\n             \"extension\": [\n               {\n                 \"url\": \"token\",\n-                \"valueUri\": \"https://<host>:<httpsPort>/oauth2/endpoint/oauth2-provider/token\"\n+                \"valueUri\": \"https://localhost:9443/oauth2/endpoint/oauth2-provider/token\"\n               },\n               {\n                 \"url\": \"authorize\",\n-                \"valueUri\": \"https://<host>:<httpsPort>/oauth2/endpoint/oauth2-provider/authorize\"\n+                \"valueUri\": \"https://localhost:9443/oauth2/endpoint/oauth2-provider/authorize\"\n               },\n               {\n                 \"url\": \"register\",\n-                \"valueUri\": \"https://<host>:<httpsPort>/oidc/endpoint/oidc-provider/registration\"\n+                \"valueUri\": \"https://localhost:9443/oidc/endpoint/oidc-provider/registration\"\n               }\n             ]\n           }\n         ],\n \u2026\n ```\n \n-First, a client application (web or mobile) must register itself with the Open ID Connect Provider using the following URL:  \n-`https://<host>:<httpsPort>/oidc/endpoint/oidc-provider/registration`\n-\n-For more information about client registration, see the [WebSphere Application Server Liberty base documentation](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html).\n-\n-By default, a Derby database is used to persist the OAuth-related configuration.\n-\n-TODO: document how to configure Db2 for use with the Liberty OAuth 2.0 feature.\n-\n-SMART on FHIR applications use the capability statement to determine the OAuth URLs to use for authorization.\n+SMART on FHIR applications should use the `.well-known` endpoint to determine the OAuth URLs to use for authorization,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1f9c3c1a2fd1cf39932974b3884dc01c5f183b"}, "originalPosition": 341}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NjMzNzkxOnYy", "diffSide": "RIGHT", "path": "fhir-server/liberty-config/server.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMzowMjo1MVrOGJ1N2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMzowNDozOVrOGJ1SnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk2MjI2NQ==", "bodyText": "this causes lazy loading.", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r412962265", "createdAt": "2020-04-22T13:02:51Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -2,99 +2,35 @@\n \n     <!-- Enable features -->\n     <featureManager>\n+        <feature>transportSecurity-1.0</feature>\n         <feature>appSecurity-2.0</feature>\n-        <feature>batchManagement-1.0</feature>\n         <feature>jaxrs-2.1</feature>\n+        <feature>servlet-4.0</feature>\n+        <feature>jsonp-1.1</feature>\n         <!-- the db2 jcc driver for 11.5.0.0 doesn't fully implement jdbc-4.2 -->\n         <feature>jdbc-4.1</feature>\n-        <feature>jsonp-1.1</feature>\n-        <feature>mpOpenAPI-1.0</feature>\n-        <feature>openidConnectServer-1.0</feature>\n-        <feature>servlet-4.0</feature>\n-        <feature>transportSecurity-1.0</feature>\n         <feature>websocket-1.1</feature>\n+        <feature>localConnector-1.0</feature>\n+        <feature>mpOpenAPI-1.0</feature>\n     </featureManager>\n \n     <!-- Disable welcome page so that internal server info won't be revealed in responses\n          to requests with an invalid context root.\n     -->\n-    <httpDispatcher enableWelcomePage=\"false\" />\n+    <httpDispatcher enableWelcomePage=\"false\"/>\n     <!-- Disable X-Powered-By header to avoid leaking information and\n          override the default error pages to avoid showing stack traces\n          for nonsensical queries like requests for a JSP page that doesn't exist.\n     -->\n-    <webContainer disableXPoweredBy=\"true\" \n-        displaytextwhennoerrorpagedefined=\"Unexpected request/response. Please check the URL and try again.\"\n-        deferServletLoad=\"false\" />\n+    <webContainer disableXPoweredBy=\"true\"\n+        displayTextWhenNoErrorPageDefined=\"Unexpected request/response. Please check the URL and try again.\"\n+        deferServletLoad=\"true\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "567dc9b564a2f49586445d5a5dabaeb101290e99"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk2MzQ4NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    deferServletLoad=\"true\"/>\n          \n          \n            \n                    deferServletLoad=\"false\"/>", "url": "https://github.com/IBM/FHIR/pull/939#discussion_r412963485", "createdAt": "2020-04-22T13:04:39Z", "author": {"login": "lmsurpre"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -2,99 +2,35 @@\n \n     <!-- Enable features -->\n     <featureManager>\n+        <feature>transportSecurity-1.0</feature>\n         <feature>appSecurity-2.0</feature>\n-        <feature>batchManagement-1.0</feature>\n         <feature>jaxrs-2.1</feature>\n+        <feature>servlet-4.0</feature>\n+        <feature>jsonp-1.1</feature>\n         <!-- the db2 jcc driver for 11.5.0.0 doesn't fully implement jdbc-4.2 -->\n         <feature>jdbc-4.1</feature>\n-        <feature>jsonp-1.1</feature>\n-        <feature>mpOpenAPI-1.0</feature>\n-        <feature>openidConnectServer-1.0</feature>\n-        <feature>servlet-4.0</feature>\n-        <feature>transportSecurity-1.0</feature>\n         <feature>websocket-1.1</feature>\n+        <feature>localConnector-1.0</feature>\n+        <feature>mpOpenAPI-1.0</feature>\n     </featureManager>\n \n     <!-- Disable welcome page so that internal server info won't be revealed in responses\n          to requests with an invalid context root.\n     -->\n-    <httpDispatcher enableWelcomePage=\"false\" />\n+    <httpDispatcher enableWelcomePage=\"false\"/>\n     <!-- Disable X-Powered-By header to avoid leaking information and\n          override the default error pages to avoid showing stack traces\n          for nonsensical queries like requests for a JSP page that doesn't exist.\n     -->\n-    <webContainer disableXPoweredBy=\"true\" \n-        displaytextwhennoerrorpagedefined=\"Unexpected request/response. Please check the URL and try again.\"\n-        deferServletLoad=\"false\" />\n+    <webContainer disableXPoweredBy=\"true\"\n+        displayTextWhenNoErrorPageDefined=\"Unexpected request/response. Please check the URL and try again.\"\n+        deferServletLoad=\"true\"/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk2MjI2NQ=="}, "originalCommit": {"oid": "567dc9b564a2f49586445d5a5dabaeb101290e99"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4956, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}