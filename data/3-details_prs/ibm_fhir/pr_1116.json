{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzEyNTgz", "number": 1116, "title": "issue #779 #1150 partitionize bulkexport JavaBatch Job & fix CWWKY0041W warnings", "bodyText": "Summary of the changes:\n(1) Partitionized bulkdata export jobs - system, patient and group exports.\n(2) Dropped single COS file multi-parts uploading for the whole export job.\n(3) Added multi-parts uploading for each partition.\n(4) Added server configurations to control the file size or resource number of each COS file.\n- fhirServer/bulkdata/cosFileMaxResources\n- fhirServer/bulkdata/cosFileMaxSize\n(5) Added simple metrics for the exporting jobs.\n(6) Fixed CWWKY0041W warnings of bulkdata both export and import jobs.\n(7) Refactoring of the bulkdata export codes.", "createdAt": "2020-05-18T20:01:00Z", "url": "https://github.com/IBM/FHIR/pull/1116", "merged": true, "mergeCommit": {"oid": "85e71020c93cde0ff6c9b8cfb3744122c706c127"}, "closed": true, "closedAt": "2020-05-26T17:49:53Z", "author": {"login": "albertwang-ibm"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcglZk8gH2gAyNDE5NzEyNTgzOjExNjRkZTM2NTk3ZjgwOWRiNzQzNTg5NzA2ODNkYWIzZDFlM2FmYTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclGcGOAFqTQxODQxODk5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1164de36597f809db74358970683dab3d1e3afa5", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/1164de36597f809db74358970683dab3d1e3afa5", "committedDate": "2020-05-12T14:46:05Z", "message": "Merge pull request #1075 from IBM/issue-#953\n\nIssue #953"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e94da7b85f47cbffa0a47e3497e2e876a45c6c71", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/e94da7b85f47cbffa0a47e3497e2e876a45c6c71", "committedDate": "2020-05-18T15:55:15Z", "message": "Merge pull request #1114 from IBM/issue-779\n\nIssue 779 - sync with master before PR bulkexport partition updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0694a550adac3efff2277ddeda6c51bb1c0014fd", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/0694a550adac3efff2277ddeda6c51bb1c0014fd", "committedDate": "2020-05-18T19:59:40Z", "message": "issue #779 partitionize bulkexport javabatch job\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17dab0f293a6af33394834dc60cc5e0e27ecedb2", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/17dab0f293a6af33394834dc60cc5e0e27ecedb2", "committedDate": "2020-05-21T12:41:01Z", "message": "issue #779 bulkexport results in job exit status and simple metrics\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cfcdfa1cb9508e8df9acecf6085c6cc832fa57d", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/4cfcdfa1cb9508e8df9acecf6085c6cc832fa57d", "committedDate": "2020-05-21T18:16:19Z", "message": "issue #779 checkpoint algorithm updates\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4a64643681f778b9ae7e49f5fa97a5b99edc598", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/c4a64643681f778b9ae7e49f5fa97a5b99edc598", "committedDate": "2020-05-26T12:57:06Z", "message": "issue #779 #1150 further refactor and fix CWWKY0041W warnings\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "066c797643da029380943400aae495f9296c15da", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/066c797643da029380943400aae495f9296c15da", "committedDate": "2020-05-26T13:18:39Z", "message": "issue #1150 add cdi-api for fixing CWWKY0041\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Mjk4OTg1", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418298985", "createdAt": "2020-05-26T13:30:54Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMDo1NFrOGaeWUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMDo1NFrOGaeWUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxMzM5Mw==", "bodyText": "Please use\n<dependency>\n    <groupId>jakarta.enterprise</groupId>\n    <artifactId>jakarta.enterprise.cdi-api</artifactId>\n    <version>2.0.2</version>\n    <scope>provided</scope>\n</dependency>", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430413393", "createdAt": "2020-05-26T13:30:54Z", "author": {"login": "prb112"}, "path": "fhir-parent/pom.xml", "diffHunk": "@@ -297,6 +297,12 @@\n                 <artifactId>jakarta.inject-api</artifactId>\n                 <version>1.0</version>\n             </dependency>\n+            <dependency>\n+                <groupId>javax.enterprise</groupId>\n+                <artifactId>cdi-api</artifactId>\n+                <version>2.0.SP1</version>\n+                <scope>provided</scope>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Mjk5ODk3", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418299897", "createdAt": "2020-05-26T13:31:51Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMTo1MlrOGaeY_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMTo1MlrOGaeY_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDA3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`fhirServer/bulkdata/cosFileMaxResources`|int|Max FHIR resources per COS file, \"-1\" means no limit |\n          \n          \n            \n            |`fhirServer/bulkdata/cosFileMaxResources`|int|The maximum number of FHIR resources per COS file, \"-1\" means no limit |", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430414077", "createdAt": "2020-05-26T13:31:52Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1486,6 +1486,8 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/bulkdata/validBaseUrls`|string|The list of supported urls which are approved for the fhir server to access|\n |`fhirServer/bulkdata/validBaseUrlsDisabled`|boolean|Disables the URL checking feature|\n |`fhirServer/bulkdata/maxInputPerRequest`|integer|The maximum inputs per bulk import|\n+|`fhirServer/bulkdata/cosFileMaxResources`|int|Max FHIR resources per COS file, \"-1\" means no limit |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzAwMTI3", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418300127", "createdAt": "2020-05-26T13:32:09Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMjowOVrOGaeZvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMjowOVrOGaeZvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDI3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`fhirServer/bulkdata/cosFileMaxSize`|int|Max COS file size in bytes, \"-1\" means no limit |\n          \n          \n            \n            |`fhirServer/bulkdata/cosFileMaxSize`|int|The maximum COS file size in bytes, \"-1\" means no limit |", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430414271", "createdAt": "2020-05-26T13:32:09Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1486,6 +1486,8 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/bulkdata/validBaseUrls`|string|The list of supported urls which are approved for the fhir server to access|\n |`fhirServer/bulkdata/validBaseUrlsDisabled`|boolean|Disables the URL checking feature|\n |`fhirServer/bulkdata/maxInputPerRequest`|integer|The maximum inputs per bulk import|\n+|`fhirServer/bulkdata/cosFileMaxResources`|int|Max FHIR resources per COS file, \"-1\" means no limit |\n+|`fhirServer/bulkdata/cosFileMaxSize`|int|Max COS file size in bytes, \"-1\" means no limit |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzAwNjUy", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418300652", "createdAt": "2020-05-26T13:32:42Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMjo0M1rOGaebTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMjo0M1rOGaebTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDY3MA==", "bodyText": "What does this equate to? 2G?", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430414670", "createdAt": "2020-05-26T13:32:43Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1532,6 +1534,8 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/audit/serviceProperties/geoCounty`|US|\n |`fhirServer/bulkdata/isExportPublic`|true|\n |`fhirServer/bulkdata/validBaseUrlsDisabled`|false|\n+|`fhirServer/bulkdata/cosFileMaxResources`|500000|\n+|`fhirServer/bulkdata/cosFileMaxSize`|209715200|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzAxMTAy", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418301102", "createdAt": "2020-05-26T13:33:16Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMzoxNlrOGaecsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMzoxNlrOGaecsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTAyNA==", "bodyText": "should this be server wide?", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430415024", "createdAt": "2020-05-26T13:33:16Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1596,6 +1600,8 @@ must restart the server for that change to take effect.\n |`fhirServer/bulkdata/validBaseUrls`|Y|Y|\n |`fhirServer/bulkdata/maxInputPerRequest`|Y|Y|\n |`fhirServer/bulkdata/validBaseUrlsDisabled`|Y|Y|\n+|`fhirServer/bulkdata/cosFileMaxResources`|N|Y|\n+|`fhirServer/bulkdata/cosFileMaxSize`|N|Y|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzAxMjk2", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418301296", "createdAt": "2020-05-26T13:33:28Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMzoyOVrOGaedQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozMzoyOVrOGaedQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTE3MA==", "bodyText": "<dependency>\n    <groupId>jakarta.enterprise</groupId>\n    <artifactId>jakarta.enterprise.cdi-api</artifactId>\n    <version>2.0.2</version>\n    <scope>provided</scope>\n</dependency>", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430415170", "createdAt": "2020-05-26T13:33:29Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/pom.xml", "diffHunk": "@@ -33,6 +33,10 @@\n             <groupId>org.glassfish</groupId>\n             <artifactId>jakarta.json</artifactId>\n         </dependency>\n+        <dependency>\n+            <groupId>javax.enterprise</groupId>\n+            <artifactId>cdi-api</artifactId>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzAxOTYz", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418301963", "createdAt": "2020-05-26T13:34:13Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozNDoxNFrOGaefQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozNDoxNFrOGaefQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTY4Mw==", "bodyText": "Why the change from the fhir. prefix?", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430415683", "createdAt": "2020-05-26T13:34:14Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/META-INF/batch-jobs/FhirBulkExportGroupChunkJob.xml", "diffHunk": "@@ -1,20 +1,23 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <job xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://xmlns.jcp.org/xml/ns/javaee\" xsi:schemaLocation=\"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd\" id=\"bulkgroupexportchunkjob\" restartable=\"true\" version=\"1.0\">\n+    <listeners>\n+        <listener ref=\"com.ibm.fhir.bulkexport.system.ExportJobListener\"/>\n+    </listeners>\n     <step id=\"step1\">\n-        <chunk checkpoint-policy=\"item\" item-count=\"1\">\n+        <chunk checkpoint-policy=\"custom\">\n             <reader ref=\"com.ibm.fhir.bulkexport.group.ChunkReader\">\n                 <properties >\n                     <property name=\"fhir.tenant\" value=\"#{jobParameters['fhir.tenant']}\"/>\n                     <property name=\"fhir.datastoreid\" value=\"#{jobParameters['fhir.datastoreid']}\"/>                   \n-                    <property name=\"fhir.resourcetype\" value=\"#{jobParameters['fhir.resourcetype']}\"/>\n+                    <property name=\"partition.resourcetype\" value=\"#{partitionPlan['partition.resourcetype']}\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzAyMjIx", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418302221", "createdAt": "2020-05-26T13:34:31Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozNDozMVrOGaegAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozNDozMVrOGaegAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTg3Mw==", "bodyText": "Why the change from the fhir. prefix?", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430415873", "createdAt": "2020-05-26T13:34:31Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/META-INF/batch-jobs/FhirBulkExportGroupChunkJob.xml", "diffHunk": "@@ -23,9 +26,24 @@\n                     <property name=\"cos.credential.ibm\" value=\"#{jobParameters['cos.credential.ibm']}\"/>\n                     <property name=\"cos.bucket.name\" value=\"#{jobParameters['cos.bucket.name']}\"/>\n                     <property name=\"cos.bucket.pathprefix\" value=\"#{jobParameters['cos.bucket.pathprefix']}\"/>\n-                    <property name=\"fhir.resourcetype\" value=\"#{jobParameters['fhir.resourcetype']}\"/>\n+                    <property name=\"partition.resourcetype\" value=\"#{partitionPlan['partition.resourcetype']}\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzAzNTY2", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418303566", "createdAt": "2020-05-26T13:35:57Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozNTo1N1rOGaej7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozNTo1N1rOGaej7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNjg3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @BatchProperty(name = Constants.COS_BUCKET_FILE_MAX_SZIE)\n          \n          \n            \n                @BatchProperty(name = Constants.COS_BUCKET_FILE_MAX_SIZE)", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430416879", "createdAt": "2020-05-26T13:35:57Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/common/CheckPointAlgorithm.java", "diffHunk": "@@ -6,38 +6,45 @@\n \n package com.ibm.fhir.bulkexport.common;\n \n+import java.util.logging.Level;\n import java.util.logging.Logger;\n \n import javax.batch.api.BatchProperty;\n import javax.batch.api.chunk.CheckpointAlgorithm;\n-import javax.batch.runtime.context.JobContext;\n+import javax.batch.runtime.context.StepContext;\n+import javax.enterprise.context.Dependent;\n import javax.inject.Inject;\n \n import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.config.FHIRConfigHelper;\n+import com.ibm.fhir.config.FHIRConfiguration;\n \n /**\n  * Bulk export Chunk implementation - custom checkpoint algorithm.\n  *\n  */\n-\n+@Dependent\n public class CheckPointAlgorithm implements CheckpointAlgorithm {\n     private final static Logger logger = Logger.getLogger(CheckPointAlgorithm.class.getName());\n+    private int cosFileMaxResources = FHIRConfigHelper.getIntProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_COSFILEMAXRESOURCES, Constants.DEFAULT_COSFILE_MAX_RESOURCESNUMBER);\n+    private int cosFileMaxSize = FHIRConfigHelper.getIntProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_COSFILEMAXSIZE  , Constants.DEFAULT_COSFILE_MAX_SIZE);\n+\n     @Inject\n-    JobContext jobContext;\n+    StepContext stepCtx;\n \n     /**\n-     * The cos.pagesperobject.\n+     * The file resources number limit when exporting to multiple COS files.\n      */\n     @Inject\n-    @BatchProperty(name = \"cos.pagesperobject\")\n-    String pagesPerCosObject;\n+    @BatchProperty(name = Constants.COS_BUCKET_FILE_MAX_RESOURCES)\n+    String cosBucketFileMaxResources;\n \n     /**\n      * The file size limit when exporting to multiple COS files.\n      */\n     @Inject\n-    @BatchProperty(name = \"cos.bucket.maxfilesize\")\n-    String cosBucketMaxFileSize;\n+    @BatchProperty(name = Constants.COS_BUCKET_FILE_MAX_SZIE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzAzODUy", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418303852", "createdAt": "2020-05-26T13:36:14Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozNjoxNFrOGaektA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozNjoxNFrOGaektA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNzA3Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String COS_BUCKET_FILE_MAX_SZIE = \"cos.bucket.filemaxsize\";\n          \n          \n            \n                public static final String COS_BUCKET_FILE_MAX_SIZE = \"cos.bucket.filemaxsize\";", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430417076", "createdAt": "2020-05-26T13:36:14Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/Constants.java", "diffHunk": "@@ -40,17 +40,26 @@\n     public static final String COS_LOCATION = \"cos.location\";\n     public static final String COS_BUCKET_NAME = \"cos.bucket.name\";\n     public static final String COS_IS_IBM_CREDENTIAL = \"cos.credential.ibm\";\n+    public static final String COS_BUCKET_FILE_MAX_SZIE = \"cos.bucket.filemaxsize\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzA1ODEx", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418305811", "createdAt": "2020-05-26T13:38:24Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozODoyNFrOGaeqbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzozODoyNFrOGaeqbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxODU0MA==", "bodyText": "protected?\nthis change from List is because each resourceType is split into separate executions?", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430418540", "createdAt": "2020-05-26T13:38:24Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -41,23 +42,22 @@\n import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n-import com.ibm.fhir.search.compartment.CompartmentUtil;\n import com.ibm.fhir.search.context.FHIRSearchContext;\n import com.ibm.fhir.search.util.SearchUtil;\n \n /**\n  * Bulk patient export Chunk implementation - the Reader.\n  *\n  */\n+@Dependent\n public class ChunkReader extends AbstractItemReader {\n     private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n     protected int pageNum = 1;\n-    protected int indexOfCurrentResourceType = 0;\n     // Control the number of records to read in each \"item\".\n     protected int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n \n     protected FHIRPersistence fhirPersistence;\n-    protected List<String> resourceTypes;\n+    Class<? extends Resource> resourceType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzA5OTU5", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418309959", "createdAt": "2020-05-26T13:42:43Z", "commit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo0Mjo0NFrOGae2EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo0Mjo0NFrOGae2EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyMTUyMQ==", "bodyText": "this seems like a good thing to have a log.fine", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430421521", "createdAt": "2020-05-26T13:42:44Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/system/ExportJobListener.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.system;\n+\n+import java.text.DecimalFormat;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.logging.Logger;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.listener.JobListener;\n+import javax.batch.operations.JobOperator;\n+import javax.batch.runtime.BatchRuntime;\n+import javax.batch.runtime.JobExecution;\n+import javax.batch.runtime.context.JobContext;\n+import javax.enterprise.context.Dependent;\n+import javax.inject.Inject;\n+\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+\n+@Dependent\n+public class ExportJobListener implements JobListener {\n+    private static final Logger logger = Logger.getLogger(ExportJobListener.class.getName());\n+\n+    long currentExecutionStartTimeInMS;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    @Inject\n+    @BatchProperty(name = Constants.IMPORT_FHIR_DATASOURCES)\n+    String dataSourcesInfo;\n+\n+    public ExportJobListener() {\n+        // do nothing\n+    }\n+\n+\n+    @Override\n+    public void afterJob() {\n+        long currentExecutionEndTimeInMS = TimeUnit.NANOSECONDS.toMillis(System.nanoTime());\n+\n+        // Used for generating response for all the import data resources.\n+        @SuppressWarnings(\"unchecked\")\n+        List<CheckPointUserData> partitionSummaries = (List<CheckPointUserData>)jobContext.getTransientUserData();\n+\n+        JobOperator jobOperator = BatchRuntime.getJobOperator();\n+        long totalJobExecutionMilliSeconds = 0;\n+        // The job can be started, stopped and then started again, so we need to add them all to get the whole job execution duration.\n+        for ( JobExecution jobExecution: jobOperator.getJobExecutions(jobOperator.getJobInstance(jobContext.getExecutionId()))) {\n+            // For current execution, jobExecution.getEndTime() is either null or with wrong value because the current execution is not\n+            // finished yet, so always use system time for both job execution start time and end time.\n+            if (jobExecution.getExecutionId()  == jobContext.getExecutionId()) {\n+                totalJobExecutionMilliSeconds += (currentExecutionEndTimeInMS - currentExecutionStartTimeInMS);\n+            } else {\n+                totalJobExecutionMilliSeconds += (jobExecution.getEndTime().getTime() - jobExecution.getStartTime().getTime());\n+            }\n+        }\n+\n+        // If the job is stopped before any partition is finished, then nothing to show.\n+        if (partitionSummaries == null) {\n+            return;\n+        }\n+\n+        double jobProcessingSeconds = totalJobExecutionMilliSeconds / 1000.0;\n+        jobProcessingSeconds = jobProcessingSeconds < 1 ? 1.0 : jobProcessingSeconds;\n+\n+        // log the simple metrics.\n+        logger.info(\" ---- Fhir resources exported in \" + jobProcessingSeconds + \"seconds ----\");\n+        logger.info(\"ResourceType \\t| Exported\");\n+        int totalExportedFhirResources = 0;\n+        List<String> resourceTypeSummaries = new ArrayList<>();\n+        for (CheckPointUserData partitionSummary : partitionSummaries) {\n+            logger.info(partitionSummary.getResourceTypeSummary() + \"\\t|\"\n+                  + partitionSummary.getTotalResourcesNum());\n+            resourceTypeSummaries.add(partitionSummary.getResourceTypeSummary());\n+            totalExportedFhirResources += partitionSummary.getTotalResourcesNum();\n+        }\n+\n+        logger.info(\" ---- Total: \" + totalExportedFhirResources", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "066c797643da029380943400aae495f9296c15da"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "356ab6a372fe748746c03937f97d61a93a9a5bba", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/356ab6a372fe748746c03937f97d61a93a9a5bba", "committedDate": "2020-05-26T14:15:56Z", "message": "issue #779 adding fhir-server-config.json and updates per review\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NDE4OTk4", "url": "https://github.com/IBM/FHIR/pull/1116#pullrequestreview-418418998", "createdAt": "2020-05-26T15:31:24Z", "commit": {"oid": "356ab6a372fe748746c03937f97d61a93a9a5bba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 223, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}