{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNjY0ODU2", "number": 1582, "title": "Issue #1504 - add back in sort for PUT/DELETE requests", "bodyText": "Signed-off-by: Mike Schroeder mschroed@us.ibm.com", "createdAt": "2020-10-14T21:31:00Z", "url": "https://github.com/IBM/FHIR/pull/1582", "merged": true, "mergeCommit": {"oid": "86d6299f87f19fa28e8c432afd87ff373e9bdd56"}, "closed": true, "closedAt": "2020-10-15T16:26:57Z", "author": {"login": "michaelwschroeder"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSkEHagH2gAyNTAzNjY0ODU2OjNiYWQ3Y2YwMmYxMzc2NmM5MTc1ZTFjNjllNmJiZWU2NjgxNTk1OWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS0V7MgFqTUwOTU1OTE1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bad7cf02f13766c9175e1c69e6bbee66815959b", "author": {"user": {"login": "michaelwschroeder", "name": "Michael W Schroeder"}}, "url": "https://github.com/IBM/FHIR/commit/3bad7cf02f13766c9175e1c69e6bbee66815959b", "committedDate": "2020-10-14T21:28:57Z", "message": "Issue #1504 - add back in sort for PUT/DELETE requests\n\nSigned-off-by: Mike Schroeder <mschroed@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODM0MTIy", "url": "https://github.com/IBM/FHIR/pull/1582#pullrequestreview-508834122", "createdAt": "2020-10-14T23:13:55Z", "commit": {"oid": "3bad7cf02f13766c9175e1c69e6bbee66815959b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxMzo1NVrOHhqIpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxMzo1NVrOHhqIpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NTM5OQ==", "bodyText": "Need if isLoggable barrier here", "url": "https://github.com/IBM/FHIR/pull/1582#discussion_r505055399", "createdAt": "2020-10-14T23:13:55Z", "author": {"login": "punktilious"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java", "diffHunk": "@@ -2023,6 +2044,98 @@ private Bundle reconstructResponseBundle(Bundle responseBundle,\n         return responseBundle;\n     }\n \n+    /**\n+     * Returns a list of Integers that provide the indices of the bundle entries associated with the specified http\n+     * method.\n+     *\n+     * @param requestBundle\n+     *            the request bundle\n+     * @param httpMethod\n+     *            the http method to look for\n+     * @return\n+     */\n+    private List<Integer> getBundleRequestIndicesForMethod(Bundle requestBundle,\n+        Bundle responseBundle, HTTPVerb httpMethod) {\n+        List<Integer> indices = new ArrayList<>();\n+        for (int i = 0; i < requestBundle.getEntry().size(); i++) {\n+            Bundle.Entry requestEntry = requestBundle.getEntry().get(i);\n+            Bundle.Entry.Request request = requestEntry.getRequest();\n+\n+            Bundle.Entry responseEntry = responseBundle.getEntry().get(i);\n+            Bundle.Entry.Response response = responseEntry.getResponse();\n+\n+            // If the response status is SC_OK which means the request passed the validation,\n+            // and this request entry's http method is the one we're looking for,\n+            // then record the index in our list.\n+            // (please notice that status can not be null since R4, So we set the response status as SC_OK\n+            // after the resource validation. )\n+            if (response.getStatus().equals(SC_OK_STRING)\n+                    && request.getMethod().equals(httpMethod)) {\n+                indices.add(Integer.valueOf(i));\n+            }\n+        }\n+        return indices;\n+    }\n+\n+    /**\n+     * This function sorts the request entries in the specified bundle, based on the path part of the entry's 'url'\n+     * field.\n+     *\n+     * @param bundle\n+     *            the bundle containing the request entries to be sorted.\n+     * @return an array of Integer which provides the \"sorted\" ordering of request entry index values.\n+     */\n+    private void sortBundleRequestEntries(Bundle bundle, List<Integer> indices) {\n+        // Sort the list of indices based on the contents of their entries in the bundle.\n+        Collections.sort(indices, new BundleEntryComparator(bundle.getEntry()));\n+    }\n+\n+    private static class BundleEntryComparator implements Comparator<Integer> {\n+        private List<Bundle.Entry> entries;\n+\n+        public BundleEntryComparator(List<Bundle.Entry> entries) {\n+            this.entries = entries;\n+        }\n+\n+        @Override\n+        public int compare(Integer indexA, Integer indexB) {\n+            Bundle.Entry a = entries.get(indexA);\n+            Bundle.Entry b = entries.get(indexB);\n+            String pathA = getUrlPath(a);\n+            String pathB = getUrlPath(b);\n+\n+            log.fine(\"Comparing request entry URL paths: \" + pathA + \", \" + pathB);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bad7cf02f13766c9175e1c69e6bbee66815959b"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920ca45a2a1f6ec05adca2773ebb6a2223ea146a", "author": {"user": {"login": "michaelwschroeder", "name": "Michael W Schroeder"}}, "url": "https://github.com/IBM/FHIR/commit/920ca45a2a1f6ec05adca2773ebb6a2223ea146a", "committedDate": "2020-10-15T12:14:26Z", "message": "Issue #1504 - add isLoggable checks around log.fine() statements\n\nSigned-off-by: Mike Schroeder <mschroed@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MzMxODQ4", "url": "https://github.com/IBM/FHIR/pull/1582#pullrequestreview-509331848", "createdAt": "2020-10-15T12:39:04Z", "commit": {"oid": "920ca45a2a1f6ec05adca2773ebb6a2223ea146a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxMjozOTowNFrOHiFslg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxMjozOTowNFrOHiFslg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwNjk2Ng==", "bodyText": "I think @punktilious requested to add this one back in \"to avoid deadlock issues in case the same id appears in another bundle\", but I'm hoping someone can explain it to me because I'm not sure I get it.", "url": "https://github.com/IBM/FHIR/pull/1582#discussion_r505506966", "createdAt": "2020-10-15T12:39:04Z", "author": {"login": "lmsurpre"}, "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/FHIRRestHelper.java", "diffHunk": "@@ -1549,10 +1571,27 @@ private Bundle processEntriesForMethod(Bundle requestBundle, Bundle responseBund\n         log.entering(this.getClass().getName(), \"processEntriesForMethod\", new Object[] {\"httpMethod\", httpMethod });\n         \n         try {\n-            // Visit each of the request entries, processing those with the specified request method.\n+            // First, obtain a list of request entry indices for the entries that we'll process.\n+            // This list will contain the indices associated with only the entries for the specified http method.\n+            List<Integer> entryIndices =\n+                    getBundleRequestIndicesForMethod(requestBundle, responseBundle, httpMethod);\n+            if (log.isLoggable(Level.FINER)) {\n+                log.finer(\"Bundle request indices to be processed: \" + entryIndices.toString());\n+            }\n+\n+            // Next, for PUT and DELETE requests, we need to sort the indices by the request url path value.\n+            if (httpMethod.equals(HTTPVerb.PUT) || httpMethod.equals(HTTPVerb.DELETE)) {\n+                sortBundleRequestEntries(requestBundle, entryIndices);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "920ca45a2a1f6ec05adca2773ebb6a2223ea146a"}, "originalPosition": 139}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NDUwNTQz", "url": "https://github.com/IBM/FHIR/pull/1582#pullrequestreview-509450543", "createdAt": "2020-10-15T14:36:22Z", "commit": {"oid": "920ca45a2a1f6ec05adca2773ebb6a2223ea146a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTU5MTU5", "url": "https://github.com/IBM/FHIR/pull/1582#pullrequestreview-509559159", "createdAt": "2020-10-15T16:26:53Z", "commit": {"oid": "920ca45a2a1f6ec05adca2773ebb6a2223ea146a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 887, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}