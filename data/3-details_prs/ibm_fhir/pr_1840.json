{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0OTUwMjU0", "number": 1840, "title": "issues #1839 and #1743 - support search parameter disambiguation", "bodyText": "Update ParametersMap to support storing multiple search parameters\nwith the same code\nAddress minor perf concern from #1743 by collecting to a map instead of a list\nUpdate SearchUtil.getSearchParameter to lookup the search parameter\nby URI from the config if possible (instead of applying the filter to\nthe full set of built-in parameters).\nUpdate the docs to reflect that search parameter filtering now\napplies to tenant-specific search parameters as well. This should help\nus move toward #1596\n\nAlso fixed a bad trace message and did some minor formatting / javadoc.\nSigned-off-by: Lee Surprenant lmsurpre@us.ibm.com", "createdAt": "2020-12-23T17:25:44Z", "url": "https://github.com/IBM/FHIR/pull/1840", "merged": true, "mergeCommit": {"oid": "e72c0965b46fb5a89aa49161b72f8807ddf1f926"}, "closed": true, "closedAt": "2021-01-05T19:54:12Z", "author": {"login": "lmsurpre"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpChMmAH2gAyNTQ0OTUwMjU0OjJhNmUzNTFiZTJmN2Y0ZGYxYzg4ODJjNTUyYjk2YjNmNGFlMTgzNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtPdP4gBqjQxNzEzNzcwNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/2a6e351be2f7f4df1c8882c552b96b3f4ae18348", "committedDate": "2020-12-23T17:24:12Z", "message": "issues #1839 and #1743 - support search parameter disambiguation\n\n1. Update ParametersMap to support storing multiple search parameters\nwith the same code\n2. Address #1743 by collecting to a map instead of a list\n3. Update SearchUtil.getSearchParameter to lookup the search parameter\nby URI from the config if possible (instead of applying the filter to\nthe full set of built-in parameters).\n4. Update the docs to reflect that search parameter filtering now\napplies to tenant-specific search parameters as well. This should help\nus move toward https://github.com/IBM/FHIR/issues/1596\n\nAlso fixed a bad trace message and did some minor formatting / javadoc.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMDU3NTA2", "url": "https://github.com/IBM/FHIR/pull/1840#pullrequestreview-561057506", "createdAt": "2021-01-04T14:11:54Z", "commit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMDgwMjUw", "url": "https://github.com/IBM/FHIR/pull/1840#pullrequestreview-561080250", "createdAt": "2021-01-04T14:40:47Z", "commit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNDo0MDo0N1rOIN0Fow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNDo0MzozOFrOIN0Lvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NTgxMQ==", "bodyText": "want to use extension-search-parameters.json instead of extension-search-parameters.xml ?", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551355811", "createdAt": "2021-01-04T14:40:47Z", "author": {"login": "michaelwschroeder"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -125,28 +125,17 @@\n     private static final Sort sort = new Sort();\n \n     /*\n-     * This is our in-memory cache of SearchParameter objects. The cache is\n-     * organized at the top level by tenant-id,\n-     * with the built-in (FHIR spec-defined) SearchParameters stored under the\n-     * \"built-in\" pseudo-tenant-id.\n-     * SearchParameters contained in the default tenant's\n-     * extension-search-parameters.xml file are stored under the\n-     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their\n-     * tenant-specific\n-     * extension-search-parameters.xml files) will be stored under their respective\n-     * tenant-ids as well. The objects\n-     * stored in our cache are of type CachedObjectHolder, with each one containing\n-     * a Map<String, Map<String,\n-     * SearchParameter>>. This map is keyed by resource type (simple name, e.g.\n-     * \"Patient\"). Each object stored in this\n-     * map contains the SearchParameters for that resource type, keyed by\n-     * SearchParameter name (e.g. \"_lastUpdated\").\n-     * When getSearchParameter(resourceType, name) is called, we'll need to first\n-     * search in the current tenant's map,\n-     * then if not found, look in the \"built-in\" tenant's map. Also, when\n-     * getSearchParameters(resourceType) is called,\n-     * we'll need to return a List that contains SearchParameters from the current\n-     * tenant's map (if present) plus those\n+     * This is our in-memory cache of SearchParameter objects. The cache is organized at the top level by tenant-id,\n+     * with the built-in (FHIR spec-defined) SearchParameters stored under the \"built-in\" pseudo-tenant-id.\n+     * SearchParameters contained in the default tenant's extension-search-parameters.xml file are stored under the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NjA4NA==", "bodyText": "same as above", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551356084", "createdAt": "2021-01-04T14:41:17Z", "author": {"login": "michaelwschroeder"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -125,28 +125,17 @@\n     private static final Sort sort = new Sort();\n \n     /*\n-     * This is our in-memory cache of SearchParameter objects. The cache is\n-     * organized at the top level by tenant-id,\n-     * with the built-in (FHIR spec-defined) SearchParameters stored under the\n-     * \"built-in\" pseudo-tenant-id.\n-     * SearchParameters contained in the default tenant's\n-     * extension-search-parameters.xml file are stored under the\n-     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their\n-     * tenant-specific\n-     * extension-search-parameters.xml files) will be stored under their respective\n-     * tenant-ids as well. The objects\n-     * stored in our cache are of type CachedObjectHolder, with each one containing\n-     * a Map<String, Map<String,\n-     * SearchParameter>>. This map is keyed by resource type (simple name, e.g.\n-     * \"Patient\"). Each object stored in this\n-     * map contains the SearchParameters for that resource type, keyed by\n-     * SearchParameter name (e.g. \"_lastUpdated\").\n-     * When getSearchParameter(resourceType, name) is called, we'll need to first\n-     * search in the current tenant's map,\n-     * then if not found, look in the \"built-in\" tenant's map. Also, when\n-     * getSearchParameters(resourceType) is called,\n-     * we'll need to return a List that contains SearchParameters from the current\n-     * tenant's map (if present) plus those\n+     * This is our in-memory cache of SearchParameter objects. The cache is organized at the top level by tenant-id,\n+     * with the built-in (FHIR spec-defined) SearchParameters stored under the \"built-in\" pseudo-tenant-id.\n+     * SearchParameters contained in the default tenant's extension-search-parameters.xml file are stored under the\n+     * \"default\" tenant-id, and other tenants' SearchParameters (defined in their tenant-specific\n+     * extension-search-parameters.xml files) will be stored under their respective tenant-ids as well. The objects", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1NzM3NQ==", "bodyText": "Do you want to use log.fine here, since that's what you're checking against in the line above?", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551357375", "createdAt": "2021-01-04T14:43:38Z", "author": {"login": "michaelwschroeder"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -301,23 +282,27 @@ public static void init() {\n                 if (includedSPs.containsKey(code)) {\n                     String configuredUrl = includedSPs.get(code);\n                     if (configuredUrl != null && configuredUrl.equals(url)) {\n-                        results.add(sp);\n-                    } else {\n+                        results.put(code, sp);\n+                    } else if (log.isLoggable(Level.FINE)) {\n                         log.info(\"Skipping search parameter with id='\" + sp.getId() + \"'. \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a6e351be2f7f4df1c8882c552b96b3f4ae18348"}, "originalPosition": 134}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTUyMTIz", "url": "https://github.com/IBM/FHIR/pull/1840#pullrequestreview-561152123", "createdAt": "2021-01-04T16:12:35Z", "commit": {"oid": "10d6493da99fc902d3201f8c1c6491836a02a9c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578c40e3a7ac1ad852bf07a1624d9d893fbe501b", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/578c40e3a7ac1ad852bf07a1624d9d893fbe501b", "committedDate": "2021-01-04T21:35:54Z", "message": "issues #1839 and #1743 - support search parameter disambiguation\n\n1. Update ParametersMap to support storing multiple search parameters\nwith the same code\n2. Address #1743 by collecting to a map instead of a list\n3. Update SearchUtil.getSearchParameter to lookup the search parameter\nby URI from the config if possible (instead of applying the filter to\nthe full set of built-in parameters).\n4. Update the docs to reflect that search parameter filtering now\napplies to tenant-specific search parameters as well. This should help\nus move toward https://github.com/IBM/FHIR/issues/1596\n\nAlso fixed a bad trace message and did some minor formatting / javadoc.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db", "committedDate": "2021-01-04T21:35:54Z", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10d6493da99fc902d3201f8c1c6491836a02a9c4", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/10d6493da99fc902d3201f8c1c6491836a02a9c4", "committedDate": "2021-01-04T15:51:05Z", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db", "committedDate": "2021-01-04T21:35:54Z", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNzk4NjA3", "url": "https://github.com/IBM/FHIR/pull/1840#pullrequestreview-561798607", "createdAt": "2021-01-05T13:46:09Z", "commit": {"oid": "80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMzo0NjowOVrOIOXyZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMzo0NjowOVrOIOXyZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk0MDcxMA==", "bodyText": "Minor. This Set is mutable. Could make this immutable on return. That may have performance implications given how much this stuff gets used. Perhaps use a custom class which is a HashSet and implements an interface with only the getters you need.", "url": "https://github.com/IBM/FHIR/pull/1840#discussion_r551940710", "createdAt": "2021-01-05T13:46:09Z", "author": {"login": "punktilious"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/parameters/ParametersMap.java", "diffHunk": "@@ -97,12 +71,12 @@ public void insert(String code, SearchParameter parameter) {\n      * @implSpec package-private to prevent insertion from outside the package\n      */\n     public void insertAll(ParametersMap map) {\n-        for (Entry<String, SearchParameter> entry : map.codeMap.entrySet()) {\n-            insert(entry.getKey(), entry.getValue());\n+        for (SearchParameter sp : map.urlMap.values()) {\n+            insert(sp.getCode().getValue(), sp);\n         }\n     }\n \n-    public SearchParameter lookupByCode(String searchParameterCode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80ea4a8839bca31d72ea8a36e4f9b82a9c0a93db"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b6e554ac44fa96623c24276eb86bd8e42a0c62", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/49b6e554ac44fa96623c24276eb86bd8e42a0c62", "committedDate": "2021-01-05T14:53:35Z", "message": "merge suggestions into rebased branch\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f166128a8373749f74f3bf63b86d434a34f42f2c", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/f166128a8373749f74f3bf63b86d434a34f42f2c", "committedDate": "2021-01-05T18:42:37Z", "message": "Add unit tests for the ParametersMap\n\nAlso made a minor change to insertAll so it gets the code from the\nexisting ParametersMap instead of from the SearchParameters in the map.\nUsually these are the same, but they can differ.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3183a1f3c10c8e176e487680162b212661407d9", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/b3183a1f3c10c8e176e487680162b212661407d9", "committedDate": "2021-01-05T18:35:32Z", "message": "Add unit tests for the ParametersMap\n\nAlso made a minor change to insertAll so it gets the code from the\nexisting ParametersMap instead of from the SearchParameters in the map.\nUsually these are the same, but they can differ.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}, "afterCommit": {"oid": "f166128a8373749f74f3bf63b86d434a34f42f2c", "author": {"user": {"login": "lmsurpre", "name": "Lee Surprenant"}}, "url": "https://github.com/IBM/FHIR/commit/f166128a8373749f74f3bf63b86d434a34f42f2c", "committedDate": "2021-01-05T18:42:37Z", "message": "Add unit tests for the ParametersMap\n\nAlso made a minor change to insertAll so it gets the code from the\nexisting ParametersMap instead of from the SearchParameters in the map.\nUsually these are the same, but they can differ.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 725, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}