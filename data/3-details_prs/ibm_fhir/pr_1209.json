{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMDE2MTQ3", "number": 1209, "title": "issue #1198 performance enhancement for patient/group export", "bodyText": "Performance enhancement:\nchanged to get resources for the whole page of patients in one query for each compartment search criteria instead of do compartment search for the resource type patient by patient.\nAccording to the test results, this has improved the export performance by more than 10 times.\nSigned-off-by: Albert Wang xuwang@us.ibm.com", "createdAt": "2020-06-09T19:23:31Z", "url": "https://github.com/IBM/FHIR/pull/1209", "merged": true, "mergeCommit": {"oid": "9c727c3e03e7cd17ef325cc6481e86db016ae280"}, "closed": true, "closedAt": "2020-06-10T11:08:02Z", "author": {"login": "albertwang-ibm"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpqESCAH2gAyNDMyMDE2MTQ3OmU2Nzg2NWVlYjFlM2FlZmIxMzM4YWNmNzZhYmJkNzUxZDUzODIwOWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp3VMHAH2gAyNDMyMDE2MTQ3OjM3NTRkNGJiMjQ5NjlhNTI4N2IzZWU2MThhMDYxY2ZhODU5OTg5OGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/e67865eeb1e3aefb1338acf76abbd751d538209e", "committedDate": "2020-06-09T19:17:40Z", "message": "issue #1198 performance enhancement for patient/group export\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDc0OTg2", "url": "https://github.com/IBM/FHIR/pull/1209#pullrequestreview-427474986", "createdAt": "2020-06-09T19:28:46Z", "commit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOToyODo0NlrOGhZFZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOToyODo0NlrOGhZFZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NzE3NQ==", "bodyText": "took me a second to follow this, but looks OK.", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437667175", "createdAt": "2020-06-09T19:28:46Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -154,12 +156,20 @@ protected void fillChunkDataBuffer(List<String> patientIds) throws Exception {\n                 if (!searchCriteria.isEmpty()) {\n                     queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCriteria);\n                 }\n-\n                 queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n \n-                for (String patientId : patientIds) {\n+                List<String> compartmentSearchCriterias = CompartmentUtil.getCompartmentResourceTypeInclusionCriteria(\"Patient\", resourceType.getSimpleName());\n+                if (compartmentSearchCriterias.size() > 1) {\n+                    isDoDuplicationCheck = true;\n+                }\n+\n+                for (String compartmentSearchCriteria: compartmentSearchCriterias) {\n+                    HashMap<String, List<String>> queryTmpParameters = new HashMap<>();\n+                    queryTmpParameters.putAll(queryParameters);\n+\n+                    queryTmpParameters.put(compartmentSearchCriteria, Arrays.asList(new String[] {String.join(\",\", patientIds)}));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDc1MDc4", "url": "https://github.com/IBM/FHIR/pull/1209#pullrequestreview-427475078", "createdAt": "2020-06-09T19:28:54Z", "commit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDkzNDc0", "url": "https://github.com/IBM/FHIR/pull/1209#pullrequestreview-427493474", "createdAt": "2020-06-09T19:56:02Z", "commit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOTo1NjowMlrOGhZ9Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOTo1NjowMlrOGhZ9Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MTQ5MA==", "bodyText": "maybe add a TODO with a link to Issue #300 so that we remember to remove this line when we get to that?", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437681490", "createdAt": "2020-06-09T19:56:02Z", "author": {"login": "lmsurpre"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -133,6 +134,7 @@ protected void fillChunkDataBuffer(List<String> patientIds) throws Exception {\n         FHIRSearchContext searchContext;\n \n         if (chunkData != null) {\n+            patientIds.replaceAll(x -> \"Patient/\" + x);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDk2MzQz", "url": "https://github.com/IBM/FHIR/pull/1209#pullrequestreview-427496343", "createdAt": "2020-06-09T19:59:58Z", "commit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOTo1OTo1OFrOGhaF2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOTo1OTo1OFrOGhaF2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzY3Mw==", "bodyText": "where is this used?", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437683673", "createdAt": "2020-06-09T19:59:58Z", "author": {"login": "lmsurpre"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -154,12 +156,20 @@ protected void fillChunkDataBuffer(List<String> patientIds) throws Exception {\n                 if (!searchCriteria.isEmpty()) {\n                     queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCriteria);\n                 }\n-\n                 queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n \n-                for (String patientId : patientIds) {\n+                List<String> compartmentSearchCriterias = CompartmentUtil.getCompartmentResourceTypeInclusionCriteria(\"Patient\", resourceType.getSimpleName());\n+                if (compartmentSearchCriterias.size() > 1) {\n+                    isDoDuplicationCheck = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDk2NzYx", "url": "https://github.com/IBM/FHIR/pull/1209#pullrequestreview-427496761", "createdAt": "2020-06-09T20:00:33Z", "commit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMDowMDozNFrOGhaHIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMDowMDozNFrOGhaHIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4NDAwMA==", "bodyText": "should this be outside the for loop?", "url": "https://github.com/IBM/FHIR/pull/1209#discussion_r437684000", "createdAt": "2020-06-09T20:00:34Z", "author": {"login": "lmsurpre"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -154,12 +156,20 @@ protected void fillChunkDataBuffer(List<String> patientIds) throws Exception {\n                 if (!searchCriteria.isEmpty()) {\n                     queryParameters.put(Constants.FHIR_SEARCH_LASTUPDATED, searchCriteria);\n                 }\n-\n                 queryParameters.put(\"_sort\", Arrays.asList(new String[] { Constants.FHIR_SEARCH_LASTUPDATED }));\n \n-                for (String patientId : patientIds) {\n+                List<String> compartmentSearchCriterias = CompartmentUtil.getCompartmentResourceTypeInclusionCriteria(\"Patient\", resourceType.getSimpleName());\n+                if (compartmentSearchCriterias.size() > 1) {\n+                    isDoDuplicationCheck = true;\n+                }\n+\n+                for (String compartmentSearchCriteria: compartmentSearchCriterias) {\n+                    HashMap<String, List<String>> queryTmpParameters = new HashMap<>();\n+                    queryTmpParameters.putAll(queryParameters);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e67865eeb1e3aefb1338acf76abbd751d538209e"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3754d4bb24969a5287b3ee618a061cfa8599898f", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/3754d4bb24969a5287b3ee618a061cfa8599898f", "committedDate": "2020-06-10T10:44:54Z", "message": "issue #1198 add link to issue #300\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 267, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}