{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MzE4ODk3", "number": 1664, "title": "issue #916 static datasource option and make it the default", "bodyText": "First step in deprecating the proxy datasource and replacing it with plain old Liberty datasource. Also includes provisional support for leveraging a read-only datasource which is useful when supporting read-only replicas. The remaining piece of this work is to update the REST layer to inject the read-only nature of the request into the request context, which will be addressed under #1657.\nAlso includes a simple query change, replacing is_deleted <> 'Y' to is_deleted = 'N' which will help with some optimizer plans. See issue #1649.", "createdAt": "2020-11-02T21:11:45Z", "url": "https://github.com/IBM/FHIR/pull/1664", "merged": true, "mergeCommit": {"oid": "8c4af53e992b8777452bcadf55fb416d8b4b73e4"}, "closed": true, "closedAt": "2020-11-10T13:53:40Z", "author": {"login": "punktilious"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYq1oygH2gAyNTE0MzE4ODk3OmE1YjQwZTUzNTUxN2E0NWNjNTQwYjBlZDJkMTM3NDNhMTI0M2NkYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbCb6GgH2gAyNTE0MzE4ODk3OjU0NWMzZTBkNThiNjBiZGU4MzEzZTc2ZTA5ZDI5YzlmMTk5MDBkOGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a5b40e535517a45cc540b0ed2d13743a1243cda9", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/a5b40e535517a45cc540b0ed2d13743a1243cda9", "committedDate": "2020-11-02T20:46:01Z", "message": "issue #916 static datasource option and make it the default\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35bad477418a4a689f682f7dd662091dfec36d7d", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/35bad477418a4a689f682f7dd662091dfec36d7d", "committedDate": "2020-11-02T20:47:08Z", "message": "Merge remote-tracking branch 'origin/master' into robin-proto"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMDE3NjQ2", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-522017646", "createdAt": "2020-11-02T21:48:54Z", "commit": {"oid": "35bad477418a4a689f682f7dd662091dfec36d7d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMTo0ODo1NFrOHsW4Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMTo0ODo1NFrOHsW4Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI3NDI0Ng==", "bodyText": "How does the multiple db work? Is there a doc update?", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r516274246", "createdAt": "2020-11-02T21:48:54Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/configDropins/overrides/datasource-postgresql.xml", "diffHunk": "@@ -0,0 +1,18 @@\n+<server>\n+    <!-- ============================================================== -->\n+    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.postgresql.xa.PGXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.postgresql\n+                 serverName=\"localhost\"\n+                 portNumber=\"5432\"\n+                 databaseName=\"fhirdb\"\n+                 user=\"fhirserver\"\n+                 password=\"change-password\"\n+                 currentSchema=\"fhirdata\"\n+             />\n+        />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35bad477418a4a689f682f7dd662091dfec36d7d"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d343e20a0af25d2dcf00d70b247bc87a602350e2", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/d343e20a0af25d2dcf00d70b247bc87a602350e2", "committedDate": "2020-11-03T19:29:37Z", "message": "issue #916 make proxy datasource the default config and fix jndi naming for bootstrap derby databases\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3509cf04510b7d86be108bc4b64b5b1c8353e64", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/e3509cf04510b7d86be108bc4b64b5b1c8353e64", "committedDate": "2020-11-03T20:01:16Z", "message": "issue #916 datasource-derby.xml was renamed to datasource-bootstrap.xml\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9e6b5c0f786331ce1091362222360819e9f89b2", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/e9e6b5c0f786331ce1091362222360819e9f89b2", "committedDate": "2020-11-03T21:28:24Z", "message": "issue #916 updated db2 and postgres test config to match docker-composed environment\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "committedDate": "2020-11-04T04:50:23Z", "message": "issue updated FHIRServerUsersGuide.md with new datasource configuration info\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDE5MDMx", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523419031", "createdAt": "2020-11-04T14:35:04Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNTowNFrOHta27Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNTowNFrOHta27Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4ODAxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Since release 4.5.0, the FHIR server supports standard JDBC datasources defined in the server '.xml' files. Datasource elements can be defined in the 'server.xml' file but can also be defined in the 'configDropins/overrides' directory to simplify configuration, especially where automation may need to add multiple datasources.\n          \n          \n            \n            Since release 4.5.0, the IBM FHIR Server supports standard JDBC datasources defined in the server '.xml' files. Datasource elements can be defined in the 'server.xml' file but can also be defined in the 'configDropins/overrides' directory to simplify configuration, especially where automation may need to add multiple datasources.\n          \n      \n    \n    \n  \n\nA few points...\n1 - So when you update this guide it goes live right away, we should probably use 4.4.1 as a reference rather than the non-existent 4.5.0\n2 - I don't think we should tell folks to update the server.xml directly, perhaps invert the recommendation and use the but to updates to the server.xml.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517388013", "createdAt": "2020-11-04T14:35:04Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -307,10 +307,14 @@ Since release 4.3.2 you can use the `search.reopt` query optimizer hint (shown a\n \n ### 3.4.2 Properties-based datastore configuration\n \n-Normally, a Liberty application that uses one or more Derby or Db2 datastores will require a datasource to be defined within the Liberty server.xml file for each database. One drawback to this approach is that each of the datasources are statically defined in the 'server.xml' file, which means that any updates (modifications, additions, etc.) will require a server re-start.\n+Normally, a Liberty application that uses one or more JDBC datastores will require a datasource to be defined within the Liberty server.xml file for each database. One drawback to this approach is that each of the datasources are statically defined in the 'server.xml' file, which means that any updates (modifications, additions, etc.) will require a server re-start.\n \n As part of it's multi-tenant support, the FHIR server provides an alternate mechanism which consists of a single \u201cproxy datasource\u201d along with a set of properties configured in the `fhir-server-config.json` file. This proxy datasource can be used by the JDBC persistence layer implementation to establish connections to either Derby or Db2 databases. This approach allows for new datastores to be configured without the need to restart the FHIR server.\n \n+Since release 4.5.0, the FHIR server supports standard JDBC datasources defined in the server '.xml' files. Datasource elements can be defined in the 'server.xml' file but can also be defined in the 'configDropins/overrides' directory to simplify configuration, especially where automation may need to add multiple datasources.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDE5NTI4", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523419528", "createdAt": "2020-11-04T14:35:34Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNTozNVrOHta4WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNTozNVrOHta4WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4ODM3Ng==", "bodyText": "You should check and update the table-of-contents.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517388376", "createdAt": "2020-11-04T14:35:35Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDIwNDg1", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523420485", "createdAt": "2020-11-04T14:36:34Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNjozNVrOHta7KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNjozNVrOHta7KA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4OTA5Ng==", "bodyText": "Verify the TOC please", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517389096", "createdAt": "2020-11-04T14:36:35Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -397,7 +522,80 @@ Furthermore, the REST API consumers associated with Acme applications will be co\n }\n ```\n \n-#### 3.4.2.3 Datastore configuration reference\n+##### 3.4.2.3.3 Example 3\n+\n+Example 3 implements the same configuration as Example 2 using standard Liberty datasource definitions.\n+\n+```\n+{\n+    \"__comment\":\"Acme's FHIR server configuration\",\n+    \"fhirServer\":{\n+        \u2026\n+        \"persistence\":{\n+            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n+            \"jdbc\": {\n+                \"enableProxyDatasource\": false\n+            },\n+            \u2026\n+            \"datasources\": {\n+                \"study1\": {\n+                    \"tenantKey\": \"<the-base64-tenant-key>\",\n+                    \"type\": \"db2\"\n+                },\n+                \"study2\": {\n+                    \"tenantKey\": \"<the-base64-tenant-key>\",\n+                    \"type\": \"db2\"\n+                }\n+            }\n+            \u2026\n+        }\n+    }\n+}\n+```\n+\n+Note that because this example is using the default FHIR server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property, although you can specify it should you wish to make the mapping clear. The \"type\" must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.\n+\n+The datasource definitions for the 'acme' tenant are defined as a drop-in configuration in '{serverHome}/configDropins/datasources-acme.xml':\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceAcmeStudy1\" jndiName=\"jdbc/fhir_acme_study1\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"dbserver1\"\n+                 portNumber=\"50000\"\n+                 user=\"db2inst1\"\n+                 password=\"change-password\"\n+                 databaseName=\"ACMESTUDY1\"\n+                 currentSchema=\"DB2INST1\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+\n+    <dataSource id=\"fhirDatasourceAcmeStudy2\" jndiName=\"jdbc/fhir_acme_study2\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"dbserver1\"\n+                 portNumber=\"50000\"\n+                 user=\"db2inst1\"\n+                 password=\"change-password\"\n+                 databaseName=\"ACMESTUDY2\"\n+                 currentSchema=\"DB2INST1\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+\n+</server>\n+```\n+\n+In the above configuration, each datasource gets its own connection pool with properties defined by the 'connectionManager' element.\n+\n+\n+#### 3.4.2.4 Datastore configuration reference", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 251}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDIwNzg5", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523420789", "createdAt": "2020-11-04T14:36:52Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNjo1MlrOHta8GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNjo1MlrOHta8GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4OTMzNg==", "bodyText": "Verify the TOC please", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517389336", "createdAt": "2020-11-04T14:36:52Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources\n+\n+To use standard JDBC datasources, disable the proxy datasource behavior by setting the 'enableProxyDatasource' flag to false (default is true):\n+\n+```\n+    {\n+        \"fhirServer\": {\n+            \u2026\n+            \"persistence\": {\n+                \u2026\n+                \"jdbc\": {\n+                    \u2026\n+                    \"enableProxyDatasource\": false\n+                }\n+                \u2026\n+            }\n+    }\n+```\n+\n+The 'dataSourceJndiName' property can be removed as it is only used when 'enableProxyDatasource' is true. The 'connectionProperties' element can also be removed (these properties are defined in the Liberty JDBC datasource definition). By default, the JNDI name of the datasource is 'jdbc/fhir_<tenantId>_<dsId>' where '<tenantId>' and '<dsId>' represent the tenant and datastore ids respectively. The JNDI address of the datasource can also be provided explicitly using the 'jndiName' property as shown in the following example:\n+\n+    ```\n+    {\n+        \"fhirServer\":{\n+            \u2026\n+            \"persistence\":{\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"tenantKey\": \"<the-base64-tenant-key>\",\n+                        \"jndiName\": \"jdbc/fhir_default_default\",\n+                        \"type\": \"db2\",\n+                        \"hints\" : {\n+                            \"search.reopt\": \"ONCE\"\n+                        }\n+                    }\n+                }\n+            \u2026\n+            }\n+        }\n+    }\n+    ```\n+When configured explicitly, the jndiName does not have to follow the standard naming convention, although this is not recommended.\n+\n+Continuing the above example, configure a drop-in server configuration file 'configDropins/overrides/datastore-default.xml' as follows:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"db2\"\n+                 portNumber=\"*****\"\n+                 user=\"*****\"\n+                 password=\"*****\"\n+                 databaseName=\"*****\"\n+                 currentSchema=\"*****\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+This file is picked up when the server starts as indicated by the following AUDIT message:\n+\n+```\n+[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: /fhir/wlp/usr/servers/fhir-server/configDropins/overrides/datasource-default.xml\n+```\n+\n+A special case exists for configuring the Derby 'bootstrapped' datasources. To avoid naming conflicts, these datasources must use custom JNDI names, not the default naming pattern. For example, a Derby datasource defined in configDropins/overrides/datasource-bootstrap.xml' might look like this:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceBootstrapDefaultDefault\" jndiName=\"jdbc/bootstrap_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+Note the use of 'jdbc/bootstrap'. How this is used is described below. The corresponding definition in 'fhir-server-config.json' must be configured like this:\n+\n+```\n+    {\n+        \"fhirServer\":{\n+\n+            \"persistence\": {\n+                ...\n+                \"jdbc\": {\n+                    \"bootstrapDb\": true,\n+                    \"enableProxyDatasource\": false,\n+                    \"bootstrapDataSourceBase\": \"jdbc/bootstrap\"\n+                    ...\n+                },\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"jndiName\": \"jdbc/bootstrap_default_default\",\n+                        \"type\": \"derby\",\n+                        \"currentSchema\": \"APP\"\n+                    },\n+                    ...\n+                }\n+            }\n+        }\n+    }\n+```\n+\n+Note 1. The introduction of the new property 'bootstrapDataSourceBase'. This value is required to correctly identify the datasources to use when bootstrapping the Derby databases. The value 'jdbc/bootstrap' is the prefix which should be common to all the Derby datasource JNDI names referencing bootstrapped Derby databases (currently 'default', 'profile', 'reference', 'study1').\n+\n+Note 2. The 'default' bootstrapped Derby database is called fhirDB. By default these databases are located in the '{serverHome}/derby/' directory.\n+\n+\n+#### 3.4.2.3 Datastore configuration examples", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 135}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDIxODY1", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523421865", "createdAt": "2020-11-04T14:38:03Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozODowM1rOHta_SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozODowM1rOHta_SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MDE1Mg==", "bodyText": "please shift the Markdown code block left. avoiding gatsby compilation issues.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517390152", "createdAt": "2020-11-04T14:38:03Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources\n+\n+To use standard JDBC datasources, disable the proxy datasource behavior by setting the 'enableProxyDatasource' flag to false (default is true):\n+\n+```\n+    {\n+        \"fhirServer\": {\n+            \u2026\n+            \"persistence\": {\n+                \u2026\n+                \"jdbc\": {\n+                    \u2026\n+                    \"enableProxyDatasource\": false\n+                }\n+                \u2026\n+            }\n+    }\n+```\n+\n+The 'dataSourceJndiName' property can be removed as it is only used when 'enableProxyDatasource' is true. The 'connectionProperties' element can also be removed (these properties are defined in the Liberty JDBC datasource definition). By default, the JNDI name of the datasource is 'jdbc/fhir_<tenantId>_<dsId>' where '<tenantId>' and '<dsId>' represent the tenant and datastore ids respectively. The JNDI address of the datasource can also be provided explicitly using the 'jndiName' property as shown in the following example:\n+\n+    ```\n+    {\n+        \"fhirServer\":{\n+            \u2026\n+            \"persistence\":{\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"tenantKey\": \"<the-base64-tenant-key>\",\n+                        \"jndiName\": \"jdbc/fhir_default_default\",\n+                        \"type\": \"db2\",\n+                        \"hints\" : {\n+                            \"search.reopt\": \"ONCE\"\n+                        }\n+                    }\n+                }\n+            \u2026\n+            }\n+        }\n+    }\n+    ```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDI0NTEw", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523424510", "createdAt": "2020-11-04T14:40:46Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0MDo0N1rOHtbHXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0MDo0N1rOHtbHXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MjIyMw==", "bodyText": "Curious as to why boostrapDataSourceBase? what does it mean?\nIf it's just a lookup name, maybe be a bit more direct\nbootstrapDataSourceBase maybe simplify to bootstrapName ...", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517392223", "createdAt": "2020-11-04T14:40:47Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources\n+\n+To use standard JDBC datasources, disable the proxy datasource behavior by setting the 'enableProxyDatasource' flag to false (default is true):\n+\n+```\n+    {\n+        \"fhirServer\": {\n+            \u2026\n+            \"persistence\": {\n+                \u2026\n+                \"jdbc\": {\n+                    \u2026\n+                    \"enableProxyDatasource\": false\n+                }\n+                \u2026\n+            }\n+    }\n+```\n+\n+The 'dataSourceJndiName' property can be removed as it is only used when 'enableProxyDatasource' is true. The 'connectionProperties' element can also be removed (these properties are defined in the Liberty JDBC datasource definition). By default, the JNDI name of the datasource is 'jdbc/fhir_<tenantId>_<dsId>' where '<tenantId>' and '<dsId>' represent the tenant and datastore ids respectively. The JNDI address of the datasource can also be provided explicitly using the 'jndiName' property as shown in the following example:\n+\n+    ```\n+    {\n+        \"fhirServer\":{\n+            \u2026\n+            \"persistence\":{\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"tenantKey\": \"<the-base64-tenant-key>\",\n+                        \"jndiName\": \"jdbc/fhir_default_default\",\n+                        \"type\": \"db2\",\n+                        \"hints\" : {\n+                            \"search.reopt\": \"ONCE\"\n+                        }\n+                    }\n+                }\n+            \u2026\n+            }\n+        }\n+    }\n+    ```\n+When configured explicitly, the jndiName does not have to follow the standard naming convention, although this is not recommended.\n+\n+Continuing the above example, configure a drop-in server configuration file 'configDropins/overrides/datastore-default.xml' as follows:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"db2\"\n+                 portNumber=\"*****\"\n+                 user=\"*****\"\n+                 password=\"*****\"\n+                 databaseName=\"*****\"\n+                 currentSchema=\"*****\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+This file is picked up when the server starts as indicated by the following AUDIT message:\n+\n+```\n+[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: /fhir/wlp/usr/servers/fhir-server/configDropins/overrides/datasource-default.xml\n+```\n+\n+A special case exists for configuring the Derby 'bootstrapped' datasources. To avoid naming conflicts, these datasources must use custom JNDI names, not the default naming pattern. For example, a Derby datasource defined in configDropins/overrides/datasource-bootstrap.xml' might look like this:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceBootstrapDefaultDefault\" jndiName=\"jdbc/bootstrap_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+Note the use of 'jdbc/bootstrap'. How this is used is described below. The corresponding definition in 'fhir-server-config.json' must be configured like this:\n+\n+```\n+    {\n+        \"fhirServer\":{\n+\n+            \"persistence\": {\n+                ...\n+                \"jdbc\": {\n+                    \"bootstrapDb\": true,\n+                    \"enableProxyDatasource\": false,\n+                    \"bootstrapDataSourceBase\": \"jdbc/bootstrap\"\n+                    ...\n+                },\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"jndiName\": \"jdbc/bootstrap_default_default\",\n+                        \"type\": \"derby\",\n+                        \"currentSchema\": \"APP\"\n+                    },\n+                    ...\n+                }\n+            }\n+        }\n+    }\n+```\n+\n+Note 1. The introduction of the new property 'bootstrapDataSourceBase'. This value is required to correctly identify the datasources to use when bootstrapping the Derby databases. The value 'jdbc/bootstrap' is the prefix which should be common to all the Derby datasource JNDI names referencing bootstrapped Derby databases (currently 'default', 'profile', 'reference', 'study1').", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDI0OTQ0", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523424944", "createdAt": "2020-11-04T14:41:14Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0MToxNFrOHtbIwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0MToxNFrOHtbIwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MjU3Ng==", "bodyText": "Also please update the configuration section of the users guide indicating defaults and tenancy.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517392576", "createdAt": "2020-11-04T14:41:14Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources\n+\n+To use standard JDBC datasources, disable the proxy datasource behavior by setting the 'enableProxyDatasource' flag to false (default is true):\n+\n+```\n+    {\n+        \"fhirServer\": {\n+            \u2026\n+            \"persistence\": {\n+                \u2026\n+                \"jdbc\": {\n+                    \u2026\n+                    \"enableProxyDatasource\": false\n+                }\n+                \u2026\n+            }\n+    }\n+```\n+\n+The 'dataSourceJndiName' property can be removed as it is only used when 'enableProxyDatasource' is true. The 'connectionProperties' element can also be removed (these properties are defined in the Liberty JDBC datasource definition). By default, the JNDI name of the datasource is 'jdbc/fhir_<tenantId>_<dsId>' where '<tenantId>' and '<dsId>' represent the tenant and datastore ids respectively. The JNDI address of the datasource can also be provided explicitly using the 'jndiName' property as shown in the following example:\n+\n+    ```\n+    {\n+        \"fhirServer\":{\n+            \u2026\n+            \"persistence\":{\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"tenantKey\": \"<the-base64-tenant-key>\",\n+                        \"jndiName\": \"jdbc/fhir_default_default\",\n+                        \"type\": \"db2\",\n+                        \"hints\" : {\n+                            \"search.reopt\": \"ONCE\"\n+                        }\n+                    }\n+                }\n+            \u2026\n+            }\n+        }\n+    }\n+    ```\n+When configured explicitly, the jndiName does not have to follow the standard naming convention, although this is not recommended.\n+\n+Continuing the above example, configure a drop-in server configuration file 'configDropins/overrides/datastore-default.xml' as follows:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"db2\"\n+                 portNumber=\"*****\"\n+                 user=\"*****\"\n+                 password=\"*****\"\n+                 databaseName=\"*****\"\n+                 currentSchema=\"*****\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+This file is picked up when the server starts as indicated by the following AUDIT message:\n+\n+```\n+[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: /fhir/wlp/usr/servers/fhir-server/configDropins/overrides/datasource-default.xml\n+```\n+\n+A special case exists for configuring the Derby 'bootstrapped' datasources. To avoid naming conflicts, these datasources must use custom JNDI names, not the default naming pattern. For example, a Derby datasource defined in configDropins/overrides/datasource-bootstrap.xml' might look like this:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceBootstrapDefaultDefault\" jndiName=\"jdbc/bootstrap_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+Note the use of 'jdbc/bootstrap'. How this is used is described below. The corresponding definition in 'fhir-server-config.json' must be configured like this:\n+\n+```\n+    {\n+        \"fhirServer\":{\n+\n+            \"persistence\": {\n+                ...\n+                \"jdbc\": {\n+                    \"bootstrapDb\": true,\n+                    \"enableProxyDatasource\": false,\n+                    \"bootstrapDataSourceBase\": \"jdbc/bootstrap\"\n+                    ...\n+                },\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"jndiName\": \"jdbc/bootstrap_default_default\",\n+                        \"type\": \"derby\",\n+                        \"currentSchema\": \"APP\"\n+                    },\n+                    ...\n+                }\n+            }\n+        }\n+    }\n+```\n+\n+Note 1. The introduction of the new property 'bootstrapDataSourceBase'. This value is required to correctly identify the datasources to use when bootstrapping the Derby databases. The value 'jdbc/bootstrap' is the prefix which should be common to all the Derby datasource JNDI names referencing bootstrapped Derby databases (currently 'default', 'profile', 'reference', 'study1').\n+\n+Note 2. The 'default' bootstrapped Derby database is called fhirDB. By default these databases are located in the '{serverHome}/derby/' directory.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 132}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDI2Nzkx", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523426791", "createdAt": "2020-11-04T14:43:07Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0MzowN1rOHtbOFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0MzowN1rOHtbOFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5Mzk0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Note that because this example is using the default FHIR server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property, although you can specify it should you wish to make the mapping clear. The \"type\" must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.\n          \n          \n            \n            Note that because this example is using the default IBM \n          \n          \n            \n            FHIR Server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property, although you can specify it should you wish to make the mapping clear. The \"type\" must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517393941", "createdAt": "2020-11-04T14:43:07Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -397,7 +522,80 @@ Furthermore, the REST API consumers associated with Acme applications will be co\n }\n ```\n \n-#### 3.4.2.3 Datastore configuration reference\n+##### 3.4.2.3.3 Example 3\n+\n+Example 3 implements the same configuration as Example 2 using standard Liberty datasource definitions.\n+\n+```\n+{\n+    \"__comment\":\"Acme's FHIR server configuration\",\n+    \"fhirServer\":{\n+        \u2026\n+        \"persistence\":{\n+            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n+            \"jdbc\": {\n+                \"enableProxyDatasource\": false\n+            },\n+            \u2026\n+            \"datasources\": {\n+                \"study1\": {\n+                    \"tenantKey\": \"<the-base64-tenant-key>\",\n+                    \"type\": \"db2\"\n+                },\n+                \"study2\": {\n+                    \"tenantKey\": \"<the-base64-tenant-key>\",\n+                    \"type\": \"db2\"\n+                }\n+            }\n+            \u2026\n+        }\n+    }\n+}\n+```\n+\n+Note that because this example is using the default FHIR server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property, although you can specify it should you wish to make the mapping clear. The \"type\" must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 209}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDI3MzY2", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523427366", "createdAt": "2020-11-04T14:43:39Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0MzozOVrOHtbPrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0MzozOVrOHtbPrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NDM0OQ==", "bodyText": "name is kind of wonkey", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517394349", "createdAt": "2020-11-04T14:43:39Z", "author": {"login": "prb112"}, "path": "fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java", "diffHunk": "@@ -92,6 +92,9 @@\n     public static final String PROPERTY_DATASOURCES = \"fhirServer/persistence/datasources\";\n     public static final String PROPERTY_JDBC_BOOTSTRAP_DB = \"fhirServer/persistence/jdbc/bootstrapDb\";\n     public static final String PROPERTY_JDBC_DATASOURCE_JNDINAME = \"fhirServer/persistence/jdbc/dataSourceJndiName\";\n+    public static final String PROPERTY_JDBC_BOOTSTRAP_DATASOURCE_BASE = \"fhirServer/persistence/jdbc/bootstrapDataSourceBase\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDI4NDQ5", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523428449", "createdAt": "2020-11-04T14:44:44Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0NDo0NFrOHtbS6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0NDo0NFrOHtbS6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NTE3Ng==", "bodyText": "Correct me if I'm wrong, in our next release we can get rid of this.\nAnd start packing in fhir-core, fhir-config in the war.\nif so, I think we should release 4.5.0 soon, and get to 4.5.X soon after", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517395176", "createdAt": "2020-11-04T14:44:44Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbProxyDatasourceConnectionStrategy.java", "diffHunk": "@@ -24,28 +24,29 @@\n \n /**\n  * Hides the logic behind obtaining a JDBC {@link Connection} from the DAO code.\n- * \n- * This strategy is used for configurations using the FHIR proxy datasource, \n+ *\n+ * This strategy is used for configurations using the FHIR proxy datasource,\n  * which supports dynamic configurations of datasources without requiring\n  * the application server to restart.\n- * \n+ *\n  * @implNote Refactored from {@link FHIRDbDAOImpl}. Improves separation of\n  *           concerns by removing connection management code from the DAO\n  *           and injecting it as a strategy instead. This not only simplifies\n  *           things, but also makes it easier to implement new strategies,\n  *           such as using a JEE datasource directly instead of the FHIR\n  *           proxy datasource used here.\n  */\n+@Deprecated\n public class FHIRDbProxyDatasourceConnectionStrategy extends FHIRDbConnectionStrategyBase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDMwMTg4", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523430188", "createdAt": "2020-11-04T14:46:33Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0NjozM1rOHtbYCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0NjozM1rOHtbYCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NjQ5MQ==", "bodyText": "I saw something in the documentation that we make a recommendation on the JNDI name but not required.  I think based on this it's required? correct?", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517396491", "createdAt": "2020-11-04T14:46:33Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbTenantDatasourceConnectionStrategy.java", "diffHunk": "@@ -54,40 +52,45 @@\n \n     // number of nanoseconds in a millisecond\n     private static final long NANOMS = 1000000;\n-    \n-    // JNDI address of the (proxy) datasource\n-    private final String datasourceBaseName = \"jdbc/fhir_\";\n+\n+    // JNDI prefix  of the (proxy) datasource\n+    private static final String DATASOURCE_BASE_NAME = \"jdbc/fhir\";\n \n     // Cache of datasources we've found\n     private final Map<String, DataSource> datasourceMap = new ConcurrentHashMap<>();\n-    \n+\n     // the flavor of the database we are configured to represent\n     private final FHIRDbFlavor flavor;\n \n+    // Should we use read-only datasources for isReadOnly() requests?\n+    private final boolean enableReadOnlyReplicas;\n+\n     /**\n      * Public constructor. The proxy datasource must be present (registered in JNDI)\n      * at server startup.\n      * @throws FHIRPersistenceDBConnectException if the proxy datasource is not configured\n      */\n-    public FHIRDbTenantDatasourceConnectionStrategy(TransactionSynchronizationRegistry trxSyncRegistry, Action newConnectionAction) throws FHIRException {\n+    public FHIRDbTenantDatasourceConnectionStrategy(TransactionSynchronizationRegistry trxSyncRegistry, Action newConnectionAction, boolean enableReadOnlyReplicas) throws FHIRException {\n         super(trxSyncRegistry, newConnectionAction);\n+        this.flavor = createFlavor();\n+        this.enableReadOnlyReplicas = enableReadOnlyReplicas;\n+    }\n \n-        // Find the base JNDI name of the datasource we want to use\n-        try {\n-//            this.datasourceBaseName =\n-//                    FHIRConfiguration.getInstance().loadConfiguration().getStringProperty(\n-//                        FHIRConfiguration.PROPERTY_JDBC_DATASOURCE_JNDINAME, FHIRDbDAO.FHIRDB_JNDI_NAME_DEFAULT);\n-            \n-            if (log.isLoggable(Level.FINE)) {\n-                log.fine(\"Using datasource JNDI name: \" + datasourceBaseName);\n-            }\n-        } catch (Throwable e) {\n-            FHIRException fx = new FHIRPersistenceDBConnectException(\"Failure acquiring datasource\");\n-            log.log(Level.SEVERE, fx.addProbeId(\"Failure to find proxy datasource in FHIR server configuration\"), e);\n-            throw fx;\n+    public static String makeTenantDatasourceJNDIName(String jndiBase, String tenantId, String dsId, boolean readOnly) {\n+        final StringBuilder builder = new StringBuilder();\n+\n+        builder.append(jndiBase);\n+        builder.append(\"_\");\n+        builder.append(tenantId);\n+        builder.append(\"_\");\n+        builder.append(dsId);\n+\n+        if (readOnly) {\n+            // Allow the query to hit read-only replicas if we're supporting that\n+            builder.append(\"_ro\");\n         }\n-        \n-        this.flavor = createFlavor();\n+\n+        return builder.toString();\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDMxMDY1", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523431065", "createdAt": "2020-11-04T14:47:25Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0NzoyNVrOHtbanw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0NzoyNVrOHtbanw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NzE1MQ==", "bodyText": "makes sense now", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517397151", "createdAt": "2020-11-04T14:47:25Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbTenantDatasourceConnectionStrategy.java", "diffHunk": "@@ -98,43 +101,63 @@ public Connection getConnection() throws FHIRPersistenceDBConnectException {\n         if (log.isLoggable(Level.FINEST)) {\n             log.entering(CLASSNAME, METHODNAME);\n         }\n-        \n+\n         // the dsId/tenantId specific datasource we need to locate\n         DataSource datasource;\n-        \n+\n         // Resources can be routed to different databases using the dsId currently\n         // set on the context.\n         String tenantId = FHIRRequestContext.get().getTenantId();\n         String dsId = FHIRRequestContext.get().getDataStoreId();\n-        \n-        // this is the important bit...how we name our actual datasources\n-        final String datasourceName = datasourceBaseName + tenantId + \"_\" + dsId;\n-        \n+        boolean readOnly = this.enableReadOnlyReplicas && FHIRRequestContext.get().isReadOnly();\n+\n+        // The jndiName may be given explicitly in the fhir-server-config\n+        String jndiName;\n+\n+        final String jndiNameProperty = FHIRConfiguration.PROPERTY_DATASOURCES + \"/\" + dsId + \"/jndiName\";\n+        try {\n+            PropertyGroup fhirConfig = FHIRConfiguration.getInstance().loadConfigurationForTenant(tenantId);\n+            jndiName = fhirConfig.getStringProperty(jndiNameProperty, null);\n+\n+            if (readOnly) {\n+                jndiName = jndiName + \"_ro\";\n+            }\n+        } catch (Exception x) {\n+            log.log(Level.SEVERE, \"Error getting value for tenant/datasource jndiName property: \" + jndiNameProperty, x);\n+            throw new FHIRPersistenceDBConnectException(\"FHIR server configuration error. See server log for details\");\n+        }\n+\n+        if (jndiName == null) {\n+            // Name wasn't provided, so build the name using a standard pattern: jdbc/fhir_<tenantId>_<dsId>[_ro]\n+            jndiName = makeTenantDatasourceJNDIName(DATASOURCE_BASE_NAME, tenantId, dsId, readOnly);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 137}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDM0NzM3", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523434737", "createdAt": "2020-11-04T14:51:13Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1MToxM1rOHtblaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1MToxM1rOHtblaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5OTkxMg==", "bodyText": "so interesting to see how many places this clause is used.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517399912", "createdAt": "2020-11-04T14:51:13Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -61,7 +61,7 @@\n     protected static final String SELECT_COUNT_ROOT = \"SELECT COUNT(DISTINCT R.RESOURCE_ID) \";\n     protected static final String SYSTEM_LEVEL_SELECT_COUNT_ROOT = \"SELECT SUM(CNT) \";\n     protected static final String SYSTEM_LEVEL_SUBSELECT_COUNT_ROOT = \" SELECT COUNT(DISTINCT LR.LOGICAL_RESOURCE_ID) AS CNT \";\n-    protected static final String WHERE_CLAUSE_ROOT = \"WHERE R.IS_DELETED <> 'Y'\";\n+    protected static final String WHERE_CLAUSE_ROOT = \"WHERE R.IS_DELETED = 'N'\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQwODcw", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523440870", "createdAt": "2020-11-04T14:57:15Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1NzoxNVrOHtb3JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1NzoxNVrOHtb3JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNDQ1Mg==", "bodyText": "Are you pushing this into a default? it seems like this should remain for one version or be moved completely to a configDropin default.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517404452", "createdAt": "2020-11-04T14:57:15Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -93,10 +93,12 @@\n         <fileset dir=\"${shared.resource.dir}/lib/fhir\" includes=\"*.jar\"/>\n     </library>\n \n+    <!-- Since 4.5.0: Enable the fhirProxyDataSource only if you need the legacy datasource behavior\n     <dataSource id=\"fhirProxyDataSource\" jndiName=\"jdbc/fhirProxyDataSource\" type=\"javax.sql.XADataSource\" validationTimeout=\"30s\">\n         <jdbcDriver javax.sql.XADataSource=\"com.ibm.fhir.persistence.proxy.FHIRProxyXADataSource\" libraryRef=\"fhirSharedLib\"/>\n         <connectionManager/>\n     </dataSource>\n+    -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQyMTIz", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523442123", "createdAt": "2020-11-04T14:58:30Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1ODozMFrOHtb7Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1ODozMFrOHtb7Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNTQ1NA==", "bodyText": "Shouldn't these ids be unique across all overrides?\nI think this should go in the disabled directory and note the overrides.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517405454", "createdAt": "2020-11-04T14:58:30Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/configDropins/overrides/datasource-postgresql.xml", "diffHunk": "@@ -0,0 +1,18 @@\n+<server>\n+    <!-- ============================================================== -->\n+    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQyMzUw", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523442350", "createdAt": "2020-11-04T14:58:44Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1ODo0NFrOHtb72w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1ODo0NFrOHtb72w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNTY1OQ==", "bodyText": "Put my comment in the postgres.xml", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517405659", "createdAt": "2020-11-04T14:58:44Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/configDropins/overrides/datasource-db2.xml", "diffHunk": "@@ -0,0 +1,19 @@\n+<server>\n+    <!-- ============================================================== -->\n+    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"db2\"\n+                 portNumber=\"50000\"\n+                 user=\"fhirserver\"\n+                 password=\"change-password\"\n+                 databaseName=\"FHIRDB\"\n+                 currentSchema=\"FHIRDATA\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQyNzA5", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523442709", "createdAt": "2020-11-04T14:59:06Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1OTowNlrOHtb8xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo1OTowNlrOHtb8xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNTg5NA==", "bodyText": "Put my comment in the postgres.xml, however I think this one should be in default.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517405894", "createdAt": "2020-11-04T14:59:06Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/configDropins/overrides/datasource-bootstrap.xml", "diffHunk": "@@ -0,0 +1,44 @@\n+<server>\n+    <!-- ============================================================== -->\n+    <!-- These datasources are used by the FHIR server Derby bootstrap  -->\n+    <!-- process. We have to name them differently so they do not       -->\n+    <!-- clash with other datasources which may be assigned JNDI names  -->\n+    <!-- like \"jdbc/fhir_default_default\"                               -->\n+    <!-- ============================================================== -->\n+\n+    <!-- ============================================================== -->\n+    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceBootstrapDefaultDefault\" jndiName=\"jdbc/bootstrap_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+\n+    <!-- ============================================================== -->\n+    <!-- TENANT: tenant1; DSID: profile; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceBootstrapTenant1Profile\" jndiName=\"jdbc/bootstrap_tenant1_profile\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/profile\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+\n+    <!-- ============================================================== -->\n+    <!-- TENANT: tenant1; DSID: reference; TYPE: read-write             -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceBootstrapTenant1Reference\" jndiName=\"jdbc/bootstrap_tenant1_reference\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/reference\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+\n+    <!-- ============================================================== -->\n+    <!-- TENANT: tenant1; DSID: study1; TYPE: read-write                -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceBootstrapTenant1Study1\" jndiName=\"jdbc/bootstrap_tenant1_study1\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/study1\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQ0NDE4", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523444418", "createdAt": "2020-11-04T15:00:32Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMDozMlrOHtcBhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMDozMlrOHtcBhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzEwOQ==", "bodyText": "Doesn't feel so much like deprecating, rather this is a breaking change.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517407109", "createdAt": "2020-11-04T15:00:32Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/config/default/fhir-server-config-postgresql.json", "diffHunk": "@@ -49,22 +49,16 @@\n             \"jdbc\": {\n                 \"__comment\": \"Configuration properties for the JDBC persistence implementation\",\n                 \"bootstrapDb\": true,\n-                \"dataSourceJndiName\": \"jdbc/fhirProxyDataSource\",\n+                \"enableProxyDatasource\": false,\n+                \"bootstrapDataSourceBase\": \"jdbc/bootstrap\",\n                 \"enableCodeSystemsCache\": true,\n                 \"enableParameterNamesCache\": true,\n                 \"enableResourceTypesCache\": true\n             },\n             \"datasources\": {\n                 \"default\": {\n                     \"type\": \"postgresql\",\n-                    \"connectionProperties\": {\n-                        \"serverName\": \"postgres_postgres_1\",\n-                        \"portNumber\": 5432,\n-                        \"databaseName\": \"fhirdb\",\n-                        \"user\": \"fhirserver\",\n-                        \"password\": \"change-password\",\n-                        \"currentSchema\": \"fhirdata\"\n-                    }\n+                    \"currentSchema\": \"fhirdata\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQ0NjE2", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523444616", "createdAt": "2020-11-04T15:00:43Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMDo0M1rOHtcCBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMDo0M1rOHtcCBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzIzOQ==", "bodyText": "Doesn't feel so much like deprecating, rather this is a breaking change.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517407239", "createdAt": "2020-11-04T15:00:43Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/config/default/fhir-server-config-db2.json", "diffHunk": "@@ -100,25 +100,18 @@\n             \"jdbc\": {\n                 \"__comment\": \"Configuration properties for the JDBC persistence implementation\",\n                 \"bootstrapDb\": true,\n-                \"dataSourceJndiName\": \"jdbc/fhirProxyDataSource\",\n+                \"enableProxyDatasource\": false,\n+                \"bootstrapDataSourceBase\": \"jdbc/bootstrap\",\n                 \"enableCodeSystemsCache\": true,\n                 \"enableParameterNamesCache\": true,\n                 \"enableResourceTypesCache\": true\n             },\n             \"datasources\": {\n                 \"default\": {\n                     \"type\": \"db2\",\n+                    \"currentSchema\": \"fhirdata\",\n                     \"hints\" : {\n                       \"search.reopt\": \"ONCE\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQ1Mjg3", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523445287", "createdAt": "2020-11-04T15:01:19Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMToxOVrOHtcDyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMToxOVrOHtcDyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzY5MQ==", "bodyText": "I think with derby this is a-ok", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517407691", "createdAt": "2020-11-04T15:01:19Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config-tenants/config/tenant1/fhir-server-config.json", "diffHunk": "@@ -21,28 +21,19 @@\n         \"persistence\": {\n             \"datasources\": {\n                 \"profile\": {\n+                    \"jndiName\": \"jdbc/bootstrap_tenant1_profile\",\n                     \"type\": \"derby\",\n-                    \"currentSchema\": \"APP\",\n-                    \"connectionProperties\": {\n-                        \"databaseName\": \"derby/profile\",\n-                        \"createDatabase\": \"create\"\n-                    }\n+                    \"currentSchema\": \"APP\"\n                 },\n                 \"reference\": {\n+                    \"jndiName\": \"jdbc/bootstrap_tenant1_reference\",\n                     \"type\": \"derby\",\n-                    \"currentSchema\": \"APP\",\n-                    \"connectionProperties\": {\n-                        \"databaseName\": \"derby/reference\",\n-                        \"createDatabase\": \"create\"\n-                    }\n+                    \"currentSchema\": \"APP\"\n                 },\n                 \"study1\": {\n+                    \"jndiName\": \"jdbc/bootstrap_tenant1_study1\",\n                     \"type\": \"derby\",\n-                    \"currentSchema\": \"APP\",\n-                    \"connectionProperties\": {\n-                        \"databaseName\": \"derby/study1\",\n-                        \"createDatabase\": \"create\"\n-                    }\n+                    \"currentSchema\": \"APP\"\n                 }\n             }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQ2MDQ2", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523446046", "createdAt": "2020-11-04T15:02:06Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMjowNlrOHtcF9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMjowNlrOHtcF9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwODI0Nw==", "bodyText": "@michaelwschroeder FYI - the <> change, I think you might have already adopted this", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517408247", "createdAt": "2020-11-04T15:02:06Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/JDBCQueryBuilder.java", "diffHunk": "@@ -823,13 +823,13 @@ private void appendInnerSelect(StringBuilder whereClauseSegment, QueryParameter\n \n         whereClauseSegment.append(\" WHERE \");\n \n-        // CR1.RESOURCE_ID = CLR1.CURRENT_RESOURCE_ID AND CR1.IS_DELETED <> 'Y' AND\n+        // CR1.RESOURCE_ID = CLR1.CURRENT_RESOURCE_ID AND CR1.IS_DELETED = 'N' AND\n         // CP1.LOGICAL_RESOURCE_ID = CLR1.LOGICAL_RESOURCE_ID AND\n         whereClauseSegment.append(chainedResourceTableAlias).append(\"RESOURCE_ID = \")\n                 .append(chainedLogicalResourceTableAlias).append(\"CURRENT_RESOURCE_ID\")\n                 .append(AND)\n                 .append(chainedResourceTableAlias)\n-                .append(\"IS_DELETED\").append(\" <> 'Y'\")\n+                .append(\"IS_DELETED\").append(\" = 'N'\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQ3MzE3", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523447317", "createdAt": "2020-11-04T15:03:21Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMzoyMVrOHtcJng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMzoyMVrOHtcJng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwOTE4Mg==", "bodyText": "I think we should reference the issue since 4.5.0 doesn't yet exist.", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517409182", "createdAt": "2020-11-04T15:03:21Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -224,8 +224,18 @@ public FHIRPersistenceJDBCImpl(FHIRPersistenceJDBCCache cache) throws Exception\n         // are processed the first time a connection is established to a particular tenant/datasource.\n         this.configProvider = new DefaultFHIRConfigProvider(); // before buildActionChain()\n         this.schemaNameSupplier = new SchemaNameImpl(this);\n-        this.connectionStrategy = new FHIRDbProxyDatasourceConnectionStrategy(trxSynchRegistry, buildActionChain());\n-        this.transactionAdapter = new FHIRUserTransactionAdapter(userTransaction, trxSynchRegistry, cache, TXN_DATA_KEY);        \n+\n+        // Release 4.5.0: Still default to the old proxy datasource configuration so we don't break existing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDQ4MzE1", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-523448315", "createdAt": "2020-11-04T15:04:23Z", "commit": {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a7e9993f8658fdf570af65cd8aac5c4bf65d85a", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/3a7e9993f8658fdf570af65cd8aac5c4bf65d85a", "committedDate": "2020-11-06T16:24:49Z", "message": "issue #916 addressed review comments, use legacy proxy datasource config for Db2 SITs\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2abacfbd47c952bcb3359f7de20fa4bd89469689", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/2abacfbd47c952bcb3359f7de20fa4bd89469689", "committedDate": "2020-11-06T16:25:43Z", "message": "Merge remote-tracking branch 'origin/master' into robin-proto"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02151f9577ab0fa5e3bcec0d8e21fd582b6940f9", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/02151f9577ab0fa5e3bcec0d8e21fd582b6940f9", "committedDate": "2020-11-06T16:53:11Z", "message": "issue #916 fixed comment referencing future release\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e91293c46a16dd46e78c189bc52dcb71c47dff1", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/9e91293c46a16dd46e78c189bc52dcb71c47dff1", "committedDate": "2020-11-06T19:12:55Z", "message": "issue #916 derby bootstrap must default using proxy datasource config\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ed643b4aa0ccff36acd1aee02866156af8f814d", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/7ed643b4aa0ccff36acd1aee02866156af8f814d", "committedDate": "2020-11-06T19:59:45Z", "message": "issue #916 must keep fhirProxyDataSource defined in server.xml\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec7bab525ba9fd3f218b77ce4cc332f1f36e11e3", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/ec7bab525ba9fd3f218b77ce4cc332f1f36e11e3", "committedDate": "2020-11-06T21:06:15Z", "message": "issue #916 db2 tests require legacy Derby datasource config for tenant1\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjE1MjM3", "url": "https://github.com/IBM/FHIR/pull/1664#pullrequestreview-526615237", "createdAt": "2020-11-09T20:09:32Z", "commit": {"oid": "ec7bab525ba9fd3f218b77ce4cc332f1f36e11e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "642ff7258659f03eab8bfa0f57a7f312a285e43b", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/642ff7258659f03eab8bfa0f57a7f312a285e43b", "committedDate": "2020-11-10T05:03:32Z", "message": "issue #916 updated FHIRServerUsersGuide per review comments\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "545c3e0d58b60bde8313e76e09d29c9f19900d8d", "author": {"user": {"login": "punktilious", "name": "Robin Arnold"}}, "url": "https://github.com/IBM/FHIR/commit/545c3e0d58b60bde8313e76e09d29c9f19900d8d", "committedDate": "2020-11-10T05:23:29Z", "message": "issue #916 merged with master\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 741, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}