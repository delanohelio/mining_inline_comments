{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNTUwMDEw", "number": 813, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNToyNFrODpP6XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxODo1NToxNFrODpowng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NTc4OTA4OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNToyNFrOF4TtPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzozMTo1MlrOF45JLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzQ1Mg==", "bodyText": "can we use one try here?", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r394587452", "createdAt": "2020-03-18T19:25:24Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -816,6 +817,23 @@ protected void allocateTenant() {\n         // Fill any static data tables (which are also partitioned by tenant)\n         populateStaticTables(gen, tenantKey);\n \n+        // Prepopulate the Resource Type Tables\n+        try (ITransaction tx = TransactionFactory.openTransaction(connectionPool)) {\n+            try {\n+                Connection c = connectionPool.getConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4ODY2OQ==", "bodyText": "it's the pattern that Robin follows through the code. thus the transaction factory, and then the nested tries", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r394588669", "createdAt": "2020-03-18T19:27:45Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -816,6 +817,23 @@ protected void allocateTenant() {\n         // Fill any static data tables (which are also partitioned by tenant)\n         populateStaticTables(gen, tenantKey);\n \n+        // Prepopulate the Resource Type Tables\n+        try (ITransaction tx = TransactionFactory.openTransaction(connectionPool)) {\n+            try {\n+                Connection c = connectionPool.getConnection();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzQ1Mg=="}, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5MDQyMg==", "bodyText": "not sure if we need to close the connection or put it back to the connection pool ...", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r394590422", "createdAt": "2020-03-18T19:31:10Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -816,6 +817,23 @@ protected void allocateTenant() {\n         // Fill any static data tables (which are also partitioned by tenant)\n         populateStaticTables(gen, tenantKey);\n \n+        // Prepopulate the Resource Type Tables\n+        try (ITransaction tx = TransactionFactory.openTransaction(connectionPool)) {\n+            try {\n+                Connection c = connectionPool.getConnection();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzQ1Mg=="}, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5OTYyNg==", "bodyText": "We do not need to put it back in the pool... from what I've reviewed in the code, however, you are correct that we need to do autocloseable.", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r395199626", "createdAt": "2020-03-19T17:30:07Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -816,6 +817,23 @@ protected void allocateTenant() {\n         // Fill any static data tables (which are also partitioned by tenant)\n         populateStaticTables(gen, tenantKey);\n \n+        // Prepopulate the Resource Type Tables\n+        try (ITransaction tx = TransactionFactory.openTransaction(connectionPool)) {\n+            try {\n+                Connection c = connectionPool.getConnection();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzQ1Mg=="}, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwMDgxMw==", "bodyText": "fixed", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r395200813", "createdAt": "2020-03-19T17:31:52Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -816,6 +817,23 @@ protected void allocateTenant() {\n         // Fill any static data tables (which are also partitioned by tenant)\n         populateStaticTables(gen, tenantKey);\n \n+        // Prepopulate the Resource Type Tables\n+        try (ITransaction tx = TransactionFactory.openTransaction(connectionPool)) {\n+            try {\n+                Connection c = connectionPool.getConnection();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzQ1Mg=="}, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NTc5MzU4OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjo0M1rOF4TwAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzoxMDoyMlrOF44QoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4ODE2MA==", "bodyText": "better to remove the empty lines.", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r394588160", "createdAt": "2020-03-18T19:26:43Z", "author": {"login": "albertwang-ibm"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.schema.control;\n+\n+import java.sql.CallableStatement;\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.sql.Types;\n+\n+import com.ibm.fhir.database.utils.api.IDatabaseStatement;\n+import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.model.type.code.FHIRResourceType;\n+\n+/**\n+ * Populates the Resource Types Table\n+ */\n+public class Db2PopulateResourceTypes implements IDatabaseStatement {\n+    private final String adminSchemaName;\n+    private final String schemaName;\n+    private final int tenantId;\n+\n+    public Db2PopulateResourceTypes(String adminSchemaName, String schemaName, int tenantId) {\n+        this.adminSchemaName = adminSchemaName;\n+        this.schemaName      = schemaName;\n+        this.tenantId        = tenantId;\n+    }\n+\n+    @Override\n+    public void run(IDatabaseTranslator translator, Connection c) {\n+        try (Statement s = c.createStatement()) {\n+            s.execute(\"SET \" + adminSchemaName + \".SV_TENANT_ID = \" + tenantId);\n+            // Create tables for each resource type\n+\n+            for (FHIRResourceType.ValueSet rt : FHIRResourceType.ValueSet.values()) {\n+                String resourceType = rt.value();\n+                String callableStr = \"CALL \" + schemaName + \" .add_resource_type(?, ?)\";\n+                try (CallableStatement cStmt = c.prepareCall(callableStr);) {\n+                    cStmt.setString(1, resourceType);\n+                    cStmt.registerOutParameter(2, Types.INTEGER);\n+                    cStmt.execute();\n+                }\n+            }\n+        } catch (SQLException x) {\n+            throw translator.translate(x);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4ODQxOQ==", "bodyText": "will do.", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r394588419", "createdAt": "2020-03-18T19:27:15Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.schema.control;\n+\n+import java.sql.CallableStatement;\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.sql.Types;\n+\n+import com.ibm.fhir.database.utils.api.IDatabaseStatement;\n+import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.model.type.code.FHIRResourceType;\n+\n+/**\n+ * Populates the Resource Types Table\n+ */\n+public class Db2PopulateResourceTypes implements IDatabaseStatement {\n+    private final String adminSchemaName;\n+    private final String schemaName;\n+    private final int tenantId;\n+\n+    public Db2PopulateResourceTypes(String adminSchemaName, String schemaName, int tenantId) {\n+        this.adminSchemaName = adminSchemaName;\n+        this.schemaName      = schemaName;\n+        this.tenantId        = tenantId;\n+    }\n+\n+    @Override\n+    public void run(IDatabaseTranslator translator, Connection c) {\n+        try (Statement s = c.createStatement()) {\n+            s.execute(\"SET \" + adminSchemaName + \".SV_TENANT_ID = \" + tenantId);\n+            // Create tables for each resource type\n+\n+            for (FHIRResourceType.ValueSet rt : FHIRResourceType.ValueSet.values()) {\n+                String resourceType = rt.value();\n+                String callableStr = \"CALL \" + schemaName + \" .add_resource_type(?, ?)\";\n+                try (CallableStatement cStmt = c.prepareCall(callableStr);) {\n+                    cStmt.setString(1, resourceType);\n+                    cStmt.registerOutParameter(2, Types.INTEGER);\n+                    cStmt.execute();\n+                }\n+            }\n+        } catch (SQLException x) {\n+            throw translator.translate(x);\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4ODE2MA=="}, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4NjMzNw==", "bodyText": "fixed in my local commit", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r395186337", "createdAt": "2020-03-19T17:10:22Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.schema.control;\n+\n+import java.sql.CallableStatement;\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.sql.Types;\n+\n+import com.ibm.fhir.database.utils.api.IDatabaseStatement;\n+import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.model.type.code.FHIRResourceType;\n+\n+/**\n+ * Populates the Resource Types Table\n+ */\n+public class Db2PopulateResourceTypes implements IDatabaseStatement {\n+    private final String adminSchemaName;\n+    private final String schemaName;\n+    private final int tenantId;\n+\n+    public Db2PopulateResourceTypes(String adminSchemaName, String schemaName, int tenantId) {\n+        this.adminSchemaName = adminSchemaName;\n+        this.schemaName      = schemaName;\n+        this.tenantId        = tenantId;\n+    }\n+\n+    @Override\n+    public void run(IDatabaseTranslator translator, Connection c) {\n+        try (Statement s = c.createStatement()) {\n+            s.execute(\"SET \" + adminSchemaName + \".SV_TENANT_ID = \" + tenantId);\n+            // Create tables for each resource type\n+\n+            for (FHIRResourceType.ValueSet rt : FHIRResourceType.ValueSet.values()) {\n+                String resourceType = rt.value();\n+                String callableStr = \"CALL \" + schemaName + \" .add_resource_type(?, ?)\";\n+                try (CallableStatement cStmt = c.prepareCall(callableStr);) {\n+                    cStmt.setString(1, resourceType);\n+                    cStmt.registerOutParameter(2, Types.INTEGER);\n+                    cStmt.execute();\n+                }\n+            }\n+        } catch (SQLException x) {\n+            throw translator.translate(x);\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4ODE2MA=="}, "originalCommit": {"oid": "619594863b8d33a3181f7cb11cdc05162a4bb139"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0OTg2MDE0OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxODo1NToxNFrOF48LBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxOTowMDozNlrOF48XUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI1MDQzOQ==", "bodyText": "maybe it should be Level.SEVERE and rollback?  Is there a case where we'd see this and want to keep going?", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r395250439", "createdAt": "2020-03-19T18:55:14Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.schema.control;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.logging.Logger;\n+\n+import com.ibm.fhir.database.utils.api.IDatabaseStatement;\n+import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.model.type.code.FHIRResourceType;\n+\n+/**\n+ * Populates the Resource Types Table\n+ */\n+public class Db2PopulateResourceTypes implements IDatabaseStatement {\n+    private static final Logger LOGGER = Logger.getLogger(Db2PopulateResourceTypes.class.getName());\n+    private final String adminSchemaName;\n+    private final String schemaName;\n+    private final int tenantId;\n+\n+    public Db2PopulateResourceTypes(String adminSchemaName, String schemaName, int tenantId) {\n+        this.adminSchemaName = adminSchemaName;\n+        this.schemaName      = schemaName;\n+        this.tenantId        = tenantId;\n+    }\n+\n+    @Override\n+    public void run(IDatabaseTranslator translator, Connection c) {\n+        final String stmtVariable = String.format(\"SET %s.SV_TENANT_ID = %d\", adminSchemaName, tenantId);\n+        final String stmtResourceTypeInsert =\n+                String.format(\n+                        \"INSERT INTO %s.resource_types (mt_id, resource_type_id, resource_type) \" +\n+                                \"VALUES %s.sv_tenant_id, ?, ?);\",\n+                        schemaName, adminSchemaName);\n+        try (Statement s = c.createStatement(); PreparedStatement batch = c.prepareStatement(stmtResourceTypeInsert)) {\n+            s.execute(stmtVariable);\n+            try (InputStream fis =\n+                    Db2PopulateResourceTypes.class.getClassLoader().getResourceAsStream(\"resource_types.properties\")) {\n+                Properties props = new Properties();\n+                props.load(fis);\n+\n+                for (Entry<Object, Object> valueEntry : props.entrySet()) {\n+                    Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n+                    String resource = (String) valueEntry.getKey();\n+                    batch.setString(1, resource);\n+                    batch.setLong(2, curVal);\n+                }\n+\n+                // Check Error Codes. \n+                int[] codes = batch.executeBatch();\n+                int errorCodes = 0;\n+                for (int code : codes) {\n+                    if (code != 0) {\n+                        errorCodes++;\n+                    }\n+                }\n+                if (errorCodes > 0) {\n+                    LOGGER.warning(\"at least one of the Resource Types are not populated [\" + errorCodes + \"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dd32fe00baa417838533ce7722f423ce31fc72d"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI1MzU4Nw==", "bodyText": "You are right - fixing", "url": "https://github.com/IBM/FHIR/pull/813#discussion_r395253587", "createdAt": "2020-03-19T19:00:36Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/Db2PopulateResourceTypes.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.schema.control;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.logging.Logger;\n+\n+import com.ibm.fhir.database.utils.api.IDatabaseStatement;\n+import com.ibm.fhir.database.utils.api.IDatabaseTranslator;\n+import com.ibm.fhir.model.type.code.FHIRResourceType;\n+\n+/**\n+ * Populates the Resource Types Table\n+ */\n+public class Db2PopulateResourceTypes implements IDatabaseStatement {\n+    private static final Logger LOGGER = Logger.getLogger(Db2PopulateResourceTypes.class.getName());\n+    private final String adminSchemaName;\n+    private final String schemaName;\n+    private final int tenantId;\n+\n+    public Db2PopulateResourceTypes(String adminSchemaName, String schemaName, int tenantId) {\n+        this.adminSchemaName = adminSchemaName;\n+        this.schemaName      = schemaName;\n+        this.tenantId        = tenantId;\n+    }\n+\n+    @Override\n+    public void run(IDatabaseTranslator translator, Connection c) {\n+        final String stmtVariable = String.format(\"SET %s.SV_TENANT_ID = %d\", adminSchemaName, tenantId);\n+        final String stmtResourceTypeInsert =\n+                String.format(\n+                        \"INSERT INTO %s.resource_types (mt_id, resource_type_id, resource_type) \" +\n+                                \"VALUES %s.sv_tenant_id, ?, ?);\",\n+                        schemaName, adminSchemaName);\n+        try (Statement s = c.createStatement(); PreparedStatement batch = c.prepareStatement(stmtResourceTypeInsert)) {\n+            s.execute(stmtVariable);\n+            try (InputStream fis =\n+                    Db2PopulateResourceTypes.class.getClassLoader().getResourceAsStream(\"resource_types.properties\")) {\n+                Properties props = new Properties();\n+                props.load(fis);\n+\n+                for (Entry<Object, Object> valueEntry : props.entrySet()) {\n+                    Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n+                    String resource = (String) valueEntry.getKey();\n+                    batch.setString(1, resource);\n+                    batch.setLong(2, curVal);\n+                }\n+\n+                // Check Error Codes. \n+                int[] codes = batch.executeBatch();\n+                int errorCodes = 0;\n+                for (int code : codes) {\n+                    if (code != 0) {\n+                        errorCodes++;\n+                    }\n+                }\n+                if (errorCodes > 0) {\n+                    LOGGER.warning(\"at least one of the Resource Types are not populated [\" + errorCodes + \"]\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI1MDQzOQ=="}, "originalCommit": {"oid": "9dd32fe00baa417838533ce7722f423ce31fc72d"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 130, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}