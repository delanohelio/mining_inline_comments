{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5Mzc2Mjgw", "number": 1389, "title": "Resolves Search Issues #1383 #1384 #1388", "bodyText": "fix: Whole system search with multiple _lastUpdated results in incorrect queries #1383\nrefactor: Values Table have duplicate data for _id and _lastUpdated #1388\n\nFHIRPersistenceJDBCImpl filters the codes in the\nextractParameterValues step and keeps the parameter values from hitting\nthe corresponding tables\n\nfix: Chained Search with _id result in Http Status 500 #1384\nURL\nhttps://localhost:9443/fhir-server/api/v4/Procedure?_count=10&subject:Patient._id=173a1657ba3-b9399454-1c17-4b96-9665-6cb930bc9c36&_page=1\nGENERATES SQL\nSELECT R.RESOURCE_ID, R.LOGICAL_RESOURCE_ID, R.VERSION_ID, R.LAST_UPDATED, R.IS_DELETED, R.DATA, LR.LOGICAL_ID  FROM PROCEDURE_RESOURCES R JOIN (SELECT DISTINCT LR.LOGICAL_RESOURCE_ID, LR.LOGICAL_ID, LR.CURRENT_RESOURCE_ID FROM Procedure_LOGICAL_RESOURCES LR  JOIN Procedure_RESOURCES R ON R.LOGICAL_RESOURCE_ID = LR.LOGICAL_RESOURCE_ID   AND R.RESOURCE_ID = LR.CURRENT_RESOURCE_ID   AND R.IS_DELETED <> 'Y'  JOIN Procedure_STR_VALUES  AS param0 ON (param0.PARAMETER_NAME_ID=1396 AND (param0.STR_VALUE IN (SELECT 'Patient' || '/' || CLR1.LOGICAL_ID FROM Patient_RESOURCES CR1, Patient_LOGICAL_RESOURCES CLR1, Patient_TOKEN_VALUES CP1 WHERE CR1.RESOURCE_ID = CLR1.CURRENT_RESOURCE_ID AND CR1.IS_DELETED <> 'Y' AND CP1.LOGICAL_RESOURCE_ID = CR1.LOGICAL_RESOURCE_ID AND CLR1.LOGICAL_ID IN (?) ))) AND LR.LOGICAL_RESOURCE_ID = param0.LOGICAL_RESOURCE_ID) AS LR  ON      R.LOGICAL_RESOURCE_ID = LR.LOGICAL_RESOURCE_ID  AND R.RESOURCE_ID = LR.CURRENT_RESOURCE_ID  AND R.IS_DELETED <> 'Y' ORDER BY RESOURCE_ID ASC  OFFSET 0 ROWS FETCH NEXT 10 ROWS ONLY  searchArgs=[173a1657ba3-b9399454-1c17-4b96-9665-6cb930bc9c36] executionTime=26.225081ms\nSigned-off-by: Paul Bastide pbastide@us.ibm.com", "createdAt": "2020-07-30T16:35:38Z", "url": "https://github.com/IBM/FHIR/pull/1389", "merged": true, "mergeCommit": {"oid": "d2e2981cdec67e42db6929e59c37965714b60192"}, "closed": true, "closedAt": "2020-08-01T13:45:11Z", "author": {"login": "prb112"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6CSPAgH2gAyNDU5Mzc2MjgwOjA2ZmIyZDVhZjYzYWQ3OTAxNDZiZjY5ZWYzZmY5MTI4MWY4ZWQ5ZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6nl1pgFqTQ1OTU3Mzc3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06fb2d5af63ad790146bf69ef3ff91281f8ed9e3", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/06fb2d5af63ad790146bf69ef3ff91281f8ed9e3", "committedDate": "2020-07-30T16:33:25Z", "message": "refactor: Values Table have duplicate data for _id and _lastUpdated\n#1388\n\n- FHIRPersistenceJDBCImpl filters the codes in the\nextractParameterValues step and keeps the parameter values from hitting\nthe corresponding tables\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08ae7e050842506214d1a175ad16e79d47d584e1", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/08ae7e050842506214d1a175ad16e79d47d584e1", "committedDate": "2020-07-30T23:37:22Z", "message": "fix: Chained Search with _id result in Http Status 500 #1384\n\n- Add a branch for _id to be called/used off of the chained reference\ntable\n- Clean up QuerySegment Aggregator for _id\n- Removed unused imports from persistence-jdbc\n- Take out the deprecated API call in AbstractSearchIdAndLastUpdatedTest\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c874c306cef3fac95029075f86fc3dd44d9b9c0", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/1c874c306cef3fac95029075f86fc3dd44d9b9c0", "committedDate": "2020-07-31T00:28:53Z", "message": "fix: Whole system search with multiple _lastUpdated results in incorrect\nqueries #1383\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/0d2ec598d930039484b17f77bed126c7c17508c5", "committedDate": "2020-07-31T13:32:56Z", "message": "fix: Whole system search with multiple _lastUpdated results in incorrect\nqueries #1383\n\n- Tone down logging in SearchChainTest\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDQ4NDgw", "url": "https://github.com/IBM/FHIR/pull/1389#pullrequestreview-459448480", "createdAt": "2020-07-31T20:24:03Z", "commit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDoyNDowM1rOG6VObw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDoyNDowM1rOG6VObw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxODM1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n          \n          \n            \n                        // An important step here is to add _id, values table bind variables, and then _lastUpdated", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463818351", "createdAt": "2020-07-31T20:24:03Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -196,15 +196,16 @@ protected SqlQueryData buildQuery() throws Exception {\n             queryString.append(\"     R.LOGICAL_RESOURCE_ID = LR.LOGICAL_RESOURCE_ID \");\n             queryString.append(\" AND R.RESOURCE_ID = LR.CURRENT_RESOURCE_ID \");\n             queryString.append(\" AND R.IS_DELETED <> 'Y'\");\n-            \n \n-            // Bind Variables\n+\n+            // An important step here is to add _id, values table bind variables, and then and _lastUpdated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDQ4Njk1", "url": "https://github.com/IBM/FHIR/pull/1389#pullrequestreview-459448695", "createdAt": "2020-07-31T20:24:27Z", "commit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDoyNDoyN1rOG6VPBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDoyNDoyN1rOG6VPBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxODUwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n          \n          \n            \n                        // An important step here is to add _id, values table bind variables, and then _lastUpdated", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463818503", "createdAt": "2020-07-31T20:24:27Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -267,13 +268,14 @@ protected SqlQueryData buildCountQuery() throws Exception {\n             buildFromClause(queryString, simpleName);\n             buildWhereClause(queryString, null);\n \n-            // An important step here is to add _id then all other values. \n+            // An important step here is to add _id, values table bind variables, and then and _lastUpdated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5"}, "originalPosition": 126}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDQ5MTQ5", "url": "https://github.com/IBM/FHIR/pull/1389#pullrequestreview-459449149", "createdAt": "2020-07-31T20:25:23Z", "commit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDoyNToyM1rOG6VQsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDoyNToyM1rOG6VQsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxODkzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            // An important step here is to add _id, values table bind variables, and then and _lastUpdated\n          \n          \n            \n                            // An important step here is to add _id, values table bind variables, and then _lastUpdated", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463818930", "createdAt": "2020-07-31T20:25:23Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -358,20 +359,19 @@ protected SqlQueryData buildSystemLevelQuery(String selectRoot, String subSelect\n                 queryString.append(JOIN);\n                 processFromClauseForLastUpdated(queryString, resourceTypeName);\n                 queryString.append(\" AS R \");\n-                                \n-                // An important step here is to add _id and _lastUpdated\n-                allBindVariables.addAll(idsObjects);\n-                allBindVariables.addAll(lastUpdatedObjects);\n \n                 queryString.append(ON);\n                 queryString.append(\"     R.LOGICAL_RESOURCE_ID = LR.LOGICAL_RESOURCE_ID \");\n                 queryString.append(\" AND R.RESOURCE_ID = LR.CURRENT_RESOURCE_ID \");\n                 queryString.append(\" AND R.IS_DELETED <> 'Y'\");\n-                \n+\n+                // An important step here is to add _id, values table bind variables, and then and _lastUpdated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5"}, "originalPosition": 181}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDQ5NTI4", "url": "https://github.com/IBM/FHIR/pull/1389#pullrequestreview-459449528", "createdAt": "2020-07-31T20:26:03Z", "commit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDoyNjowM1rOG6VR0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDoyNjowM1rOG6VR0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgxOTIxNw==", "bodyText": "did you mean to take this back out?  if not, it should be a log statement, not sysout", "url": "https://github.com/IBM/FHIR/pull/1389#discussion_r463819217", "createdAt": "2020-07-31T20:26:03Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -604,7 +606,10 @@ protected void buildWhereClause(StringBuilder whereClause, String overrideType)\n                         .append(\".LOGICAL_RESOURCE_ID = R.LOGICAL_RESOURCE_ID\");\n                     }\n                 }\n-            } // end if SKIP_WHERE\n+            } else {\n+                // end if SKIP_WHERE\n+                System.out.println(whereClause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d2ec598d930039484b17f77bed126c7c17508c5"}, "originalPosition": 333}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46036803588c76b306700cff91b1ba82777d6a9d", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/46036803588c76b306700cff91b1ba82777d6a9d", "committedDate": "2020-07-31T20:51:01Z", "message": "fix: Add Tests for _id and _lastUpdated #1383\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTI5MjQ1", "url": "https://github.com/IBM/FHIR/pull/1389#pullrequestreview-459529245", "createdAt": "2020-08-01T00:04:39Z", "commit": {"oid": "46036803588c76b306700cff91b1ba82777d6a9d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3af13ed7dca44d032580715507a19866bda213e1", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/3af13ed7dca44d032580715507a19866bda213e1", "committedDate": "2020-08-01T00:07:41Z", "message": "fix: per code review updating the comments\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84a1bdab0e56ededd80025bb27b58af0252050ce", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/84a1bdab0e56ededd80025bb27b58af0252050ce", "committedDate": "2020-08-01T00:37:51Z", "message": "fix: per code review updating the comments\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTM3MTI3", "url": "https://github.com/IBM/FHIR/pull/1389#pullrequestreview-459537127", "createdAt": "2020-08-01T01:05:48Z", "commit": {"oid": "84a1bdab0e56ededd80025bb27b58af0252050ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTczNzc2", "url": "https://github.com/IBM/FHIR/pull/1389#pullrequestreview-459573776", "createdAt": "2020-08-01T12:01:19Z", "commit": {"oid": "84a1bdab0e56ededd80025bb27b58af0252050ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1375, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}