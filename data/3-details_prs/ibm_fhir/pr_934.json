{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzOTc1ODY0", "number": 934, "title": "Issue #933 - add profile reference validation to FHIRValidator", "bodyText": "Signed-off-by: John T.E. Timm johntimm@us.ibm.com", "createdAt": "2020-04-15T20:35:09Z", "url": "https://github.com/IBM/FHIR/pull/934", "merged": true, "mergeCommit": {"oid": "21cbff37dbab7f8c6536499f937e122c0e543054"}, "closed": true, "closedAt": "2020-04-15T22:01:51Z", "author": {"login": "JohnTimm"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX-NObAH2gAyNDAzOTc1ODY0Ojg5ZDYyZDcxZjNmMzJiNjQ1YjBjZDczNDVjOTY3NjcxNTY0NGYwYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX-28WAH2gAyNDAzOTc1ODY0OmQ5MzA4ZDRkNjFmZmJmZGJlYmUwZmI2ZjUzOWYzNDk1NjVlMTQ4Y2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae", "author": {"user": {"login": "JohnTimm", "name": "John T.E. Timm"}}, "url": "https://github.com/IBM/FHIR/commit/89d62d71f3f32b645b0cd7345c9676715644f0ae", "committedDate": "2020-04-15T20:34:54Z", "message": "Issue #933 - add profile reference validation to FHIRValidator\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MTIzNjk0", "url": "https://github.com/IBM/FHIR/pull/934#pullrequestreview-394123694", "createdAt": "2020-04-15T20:48:35Z", "commit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDo0ODozNVrOGGK-0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDo0ODozNVrOGGK-0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNDU2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n          \n          \n            \n                 * passed in as arguments to this method, generate an issue with severity ERROR.\n          \n          \n            \n                 * <p>Resource-asserted profile references that are not available in the FHIRRegistry result in issues with severity WARNING.\n          \n          \n            \n                 * <p>Unknown profile references passed as arguments to this method result in issues with severity ERROR.", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409124563", "createdAt": "2020-04-15T20:48:35Z", "author": {"login": "lmsurpre"}, "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -37,21 +40,19 @@\n import com.ibm.fhir.validation.exception.FHIRValidationException;\n \n public class FHIRValidator {\n-    public static boolean DEBUG = false;\n-\n-    private ValidatingNodeVisitor visitor = new ValidatingNodeVisitor();\n+    private static final Logger log = Logger.getLogger(FHIRValidator.class.getName());\n \n     private FHIRValidator() { }\n \n     /**\n      * Validate a {@link Resource} against constraints in the base specification and\n      * resource-asserted profile references or specific profile references but not both.\n      *\n-     * <p>Resource-asserted profiles which are unknown to the server will be ignored. Conversely,\n-     * unknown profiles passed explicitly as arguments will result in a FHIRValidationException.\n+     * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n+     * passed in as arguments to this method, generate an issue with severity ERROR.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MTI1NTQ0", "url": "https://github.com/IBM/FHIR/pull/934#pullrequestreview-394125544", "createdAt": "2020-04-15T20:51:20Z", "commit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDo1MToyMFrOGGLFcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDo1MToyMFrOGGLFcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNjI1OA==", "bodyText": "why remove this paragraph?\nthat seems like useful information and the question has come up before wrt contained resources", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409126258", "createdAt": "2020-04-15T20:51:20Z", "author": {"login": "lmsurpre"}, "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -37,21 +40,19 @@\n import com.ibm.fhir.validation.exception.FHIRValidationException;\n \n public class FHIRValidator {\n-    public static boolean DEBUG = false;\n-\n-    private ValidatingNodeVisitor visitor = new ValidatingNodeVisitor();\n+    private static final Logger log = Logger.getLogger(FHIRValidator.class.getName());\n \n     private FHIRValidator() { }\n \n     /**\n      * Validate a {@link Resource} against constraints in the base specification and\n      * resource-asserted profile references or specific profile references but not both.\n      *\n-     * <p>Resource-asserted profiles which are unknown to the server will be ignored. Conversely,\n-     * unknown profiles passed explicitly as arguments will result in a FHIRValidationException.\n+     * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n+     * passed in as arguments to this method, generate an issue with severity ERROR.\n      *\n-     * <p>Profile references that are passed into this method are only applicable to the outermost\n-     * resource (not contained resources).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a78761318b0a57fb7658027bd9c4910084a45629", "author": {"user": {"login": "JohnTimm", "name": "John T.E. Timm"}}, "url": "https://github.com/IBM/FHIR/commit/a78761318b0a57fb7658027bd9c4910084a45629", "committedDate": "2020-04-15T21:01:04Z", "message": "Issue #933 - updates per PR feedback\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MTMzMDQ4", "url": "https://github.com/IBM/FHIR/pull/934#pullrequestreview-394133048", "createdAt": "2020-04-15T21:03:05Z", "commit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMTowMzowNVrOGGLcqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMTowMzowNVrOGGLcqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzMjIwMA==", "bodyText": "pretty minor, but i like to put the variable in ' just so whitespace stands out\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    .text(string(\"Profile: \" + url + \" is not applicable to resource type: \" + resourceType.getSimpleName()))\n          \n          \n            \n                                    .text(string(\"Profile '\" + url + \"' is not applicable to resource type: \" + resourceType.getSimpleName()))", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409132200", "createdAt": "2020-04-15T21:03:05Z", "author": {"login": "lmsurpre"}, "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -156,26 +165,71 @@ public static FHIRValidator validator() {\n         return new FHIRValidator();\n     }\n \n-    private static class ValidatingNodeVisitor extends FHIRPathDefaultNodeVisitor {\n-        private FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();\n-        private EvaluationContext evaluationContext;\n-        private boolean includeResourceAssertedProfiles;\n-        private List<String> profiles;\n-        private List<Issue> issues = new ArrayList<>();\n+    /**\n+     * Validate a list of profile references to ensure they are supported (known by the FHIR registry) and applicable\n+     * (the type constrained by the profile is compatible with the resource being validated).\n+     *\n+     * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n+     * passed in as arguments to the {@link FHIRValidator#validate(EvaluationContext, boolean, String...)} method, generate an\n+     * issue with severity ERROR.\n+     *\n+     * <p>If a specific profile is known but incompatible with the resource being validated, then an issue with severity\n+     * ERROR is generated.\n+     *\n+     * @param resourceNode\n+     *     the resource node being validated by a FHIRValidator instance\n+     * @param profileReferences\n+     *     the list of profile references to validate\n+     * @param resourceAsserted\n+     *     indicates whether the profile references came from the resource or were explicitly passed in as arguments\n+     * @param issues\n+     *     the list of issues to add to\n+     */\n+    private static void validateProfileReferences(\n+            FHIRPathResourceNode resourceNode,\n+            List<String> profileReferences,\n+            boolean resourceAsserted,\n+            List<Issue> issues) {\n+        Class<?> resourceType = resourceNode.resource().getClass();\n+        for (String url : profileReferences) {\n+            StructureDefinition profile = ProfileSupport.getProfile(url);\n+            if (profile == null) {\n+                issues.add(Issue.builder()\n+                    .severity(resourceAsserted ? IssueSeverity.WARNING : IssueSeverity.ERROR)\n+                    .code(IssueType.NOT_SUPPORTED)\n+                    .details(CodeableConcept.builder()\n+                        .text(string(\"Profile: \" + url + \" is not supported\"))\n+                        .build())\n+                    .expression(string(resourceNode.path()))\n+                    .build());\n+            } else if (!ProfileSupport.isApplicable(profile, resourceType)) {\n+                issues.add(Issue.builder()\n+                    .severity(IssueSeverity.ERROR)\n+                    .code(IssueType.INVALID)\n+                    .details(CodeableConcept.builder()\n+                        .text(string(\"Profile: \" + url + \" is not applicable to resource type: \" + resourceType.getSimpleName()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MTMzOTMz", "url": "https://github.com/IBM/FHIR/pull/934#pullrequestreview-394133933", "createdAt": "2020-04-15T21:04:28Z", "commit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMTowNDoyOFrOGGLfng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMTowNDoyOFrOGGLfng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzMjk1OA==", "bodyText": "why no more reset?  I guess it was never used and its on private class so seems fine...but I would have thought it was there to allow a validator to re-use a single visitor multiple times", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409132958", "createdAt": "2020-04-15T21:04:28Z", "author": {"login": "lmsurpre"}, "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -156,26 +165,71 @@ public static FHIRValidator validator() {\n         return new FHIRValidator();\n     }\n \n-    private static class ValidatingNodeVisitor extends FHIRPathDefaultNodeVisitor {\n-        private FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();\n-        private EvaluationContext evaluationContext;\n-        private boolean includeResourceAssertedProfiles;\n-        private List<String> profiles;\n-        private List<Issue> issues = new ArrayList<>();\n+    /**\n+     * Validate a list of profile references to ensure they are supported (known by the FHIR registry) and applicable\n+     * (the type constrained by the profile is compatible with the resource being validated).\n+     *\n+     * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n+     * passed in as arguments to the {@link FHIRValidator#validate(EvaluationContext, boolean, String...)} method, generate an\n+     * issue with severity ERROR.\n+     *\n+     * <p>If a specific profile is known but incompatible with the resource being validated, then an issue with severity\n+     * ERROR is generated.\n+     *\n+     * @param resourceNode\n+     *     the resource node being validated by a FHIRValidator instance\n+     * @param profileReferences\n+     *     the list of profile references to validate\n+     * @param resourceAsserted\n+     *     indicates whether the profile references came from the resource or were explicitly passed in as arguments\n+     * @param issues\n+     *     the list of issues to add to\n+     */\n+    private static void validateProfileReferences(\n+            FHIRPathResourceNode resourceNode,\n+            List<String> profileReferences,\n+            boolean resourceAsserted,\n+            List<Issue> issues) {\n+        Class<?> resourceType = resourceNode.resource().getClass();\n+        for (String url : profileReferences) {\n+            StructureDefinition profile = ProfileSupport.getProfile(url);\n+            if (profile == null) {\n+                issues.add(Issue.builder()\n+                    .severity(resourceAsserted ? IssueSeverity.WARNING : IssueSeverity.ERROR)\n+                    .code(IssueType.NOT_SUPPORTED)\n+                    .details(CodeableConcept.builder()\n+                        .text(string(\"Profile: \" + url + \" is not supported\"))\n+                        .build())\n+                    .expression(string(resourceNode.path()))\n+                    .build());\n+            } else if (!ProfileSupport.isApplicable(profile, resourceType)) {\n+                issues.add(Issue.builder()\n+                    .severity(IssueSeverity.ERROR)\n+                    .code(IssueType.INVALID)\n+                    .details(CodeableConcept.builder()\n+                        .text(string(\"Profile: \" + url + \" is not applicable to resource type: \" + resourceType.getSimpleName()))\n+                        .build())\n+                    .expression(string(resourceNode.path()))\n+                    .build());\n+            }\n+        }\n+    }\n \n-        private ValidatingNodeVisitor() { }\n+    private static class ValidatingNodeVisitor extends FHIRPathDefaultNodeVisitor {\n+        private final FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();\n+        private final EvaluationContext evaluationContext;\n+        private final boolean includeResourceAssertedProfiles;\n+        private final List<String> profiles;\n+        private final List<Issue> issues = new ArrayList<>();\n \n-        private List<Issue> validate(EvaluationContext evaluationContext, boolean includeResourceAssertedProfiles, String... profiles) {\n-            reset();\n+        private ValidatingNodeVisitor(EvaluationContext evaluationContext, boolean includeResourceAssertedProfiles, List<String> profiles) {\n             this.evaluationContext = evaluationContext;\n             this.includeResourceAssertedProfiles = includeResourceAssertedProfiles;\n-            this.profiles = Arrays.asList(profiles);\n-            this.evaluationContext.getTree().getRoot().accept(this);\n-            return Collections.unmodifiableList(issues);\n+            this.profiles = profiles;\n         }\n \n-        private void reset() {\n-            issues.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae"}, "originalPosition": 188}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0296dad810834fd951a5d40b9c444160e415499", "author": {"user": {"login": "JohnTimm", "name": "John T.E. Timm"}}, "url": "https://github.com/IBM/FHIR/commit/e0296dad810834fd951a5d40b9c444160e415499", "committedDate": "2020-04-15T21:04:28Z", "message": "Update fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java\r\n\r\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MTM3OTM1", "url": "https://github.com/IBM/FHIR/pull/934#pullrequestreview-394137935", "createdAt": "2020-04-15T21:11:01Z", "commit": {"oid": "e0296dad810834fd951a5d40b9c444160e415499"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMToxMTowMVrOGGLsDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMToxMTowMVrOGGLsDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNjE0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * <p>Profiles that are incompatible with the resource being validated result in issues with severity ERROR.\n          \n          \n            \n                 * <p>Profiles that are incompatible with the resource type being validated result in issues with severity ERROR.", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409136142", "createdAt": "2020-04-15T21:11:01Z", "author": {"login": "lmsurpre"}, "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -120,8 +130,11 @@ private FHIRValidator() { }\n      * Validate a resource, using an {@link EvaluationContext}, against constraints in the base specification and\n      * resource-asserted profile references and/or specific profile references.\n      *\n-     * <p>Resource-asserted profiles which are unknown to the server will be ignored. Conversely,\n-     * unknown profiles passed explicitly as arguments will result in a FHIRValidationException.\n+     * <p>Resource-asserted profile references that are not available in the FHIRRegistry result in issues with severity WARNING.\n+     *\n+     * <p>Unknown profile references passed as arguments to this method result in issues with severity ERROR.\n+     *\n+     * <p>Profiles that are incompatible with the resource being validated result in issues with severity ERROR.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0296dad810834fd951a5d40b9c444160e415499"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MTM4OTg1", "url": "https://github.com/IBM/FHIR/pull/934#pullrequestreview-394138985", "createdAt": "2020-04-15T21:12:46Z", "commit": {"oid": "e0296dad810834fd951a5d40b9c444160e415499"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d7535d237bd3cca399a70cc708a94766c3ab4ac", "author": {"user": {"login": "JohnTimm", "name": "John T.E. Timm"}}, "url": "https://github.com/IBM/FHIR/commit/5d7535d237bd3cca399a70cc708a94766c3ab4ac", "committedDate": "2020-04-15T21:15:47Z", "message": "Issue #933 - added \"type\" into Javadoc to clarify statement\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3c3bac19d50cf3c2d42119c1b3341cba2d05053", "author": {"user": {"login": "JohnTimm", "name": "John T.E. Timm"}}, "url": "https://github.com/IBM/FHIR/commit/e3c3bac19d50cf3c2d42119c1b3341cba2d05053", "committedDate": "2020-04-15T21:18:47Z", "message": "Issue #933 - added single quotes to issue details\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9308d4d61ffbfdbebe0fb6f539f349565e148cc", "author": {"user": {"login": "JohnTimm", "name": "John T.E. Timm"}}, "url": "https://github.com/IBM/FHIR/commit/d9308d4d61ffbfdbebe0fb6f539f349565e148cc", "committedDate": "2020-04-15T21:20:28Z", "message": "Issue #933 - missed removal of colon in issue details\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 337, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}