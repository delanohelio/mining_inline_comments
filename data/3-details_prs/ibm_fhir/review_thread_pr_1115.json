{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzExMzYy", "number": 1115, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowMTo0OFrOD9iPOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowMzozNlrOD9iRMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODUwNjgzOnYy", "diffSide": "RIGHT", "path": "fhir-path/src/main/java/com/ibm/fhir/path/function/MemberOfFunction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowMTo0OFrOGXFqfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowNjoyNFrOGXFy_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2MzIzMA==", "bodyText": "is this change related?", "url": "https://github.com/IBM/FHIR/pull/1115#discussion_r426863230", "createdAt": "2020-05-18T20:01:48Z", "author": {"login": "lmsurpre"}, "path": "fhir-path/src/main/java/com/ibm/fhir/path/function/MemberOfFunction.java", "diffHunk": "@@ -150,7 +148,7 @@ public int getMaxArity() {\n \n     private boolean contains(Map<String, Set<String>> codeSetMap, Coding coding) {\n         String system = (coding.getSystem() != null) ? coding.getSystem().getValue() : null;\n-        String version = (coding.getVersion() != null) ? coding.getVersion().getValue() : FHIRRegistry.getInstance().getLatestVersion(system, CodeSystem.class);\n+        String version = (coding.getVersion() != null) ? coding.getVersion().getValue() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2NTQwNg==", "bodyText": "Only tangentially related. There were warnings associated with a bug in the CARIN BB IG because we were defaulting an unknown version to Latest Version was causing superfluous warnings to be generated. This change makes the code a bit more tolerant.", "url": "https://github.com/IBM/FHIR/pull/1115#discussion_r426865406", "createdAt": "2020-05-18T20:06:24Z", "author": {"login": "JohnTimm"}, "path": "fhir-path/src/main/java/com/ibm/fhir/path/function/MemberOfFunction.java", "diffHunk": "@@ -150,7 +148,7 @@ public int getMaxArity() {\n \n     private boolean contains(Map<String, Set<String>> codeSetMap, Coding coding) {\n         String system = (coding.getSystem() != null) ? coding.getSystem().getValue() : null;\n-        String version = (coding.getVersion() != null) ? coding.getVersion().getValue() : FHIRRegistry.getInstance().getLatestVersion(system, CodeSystem.class);\n+        String version = (coding.getVersion() != null) ? coding.getVersion().getValue() : null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2MzIzMA=="}, "originalCommit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODUxMTg0OnYy", "diffSide": "RIGHT", "path": "fhir-profile/src/main/java/com/ibm/fhir/profile/ConstraintGenerator.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowMzozNlrOGXFtuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowNToxMVrOGXFw3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2NDA1OQ==", "bodyText": "any way to format this to make it a little simpler to see whats going on?", "url": "https://github.com/IBM/FHIR/pull/1115#discussion_r426864059", "createdAt": "2020-05-18T20:03:36Z", "author": {"login": "lmsurpre"}, "path": "fhir-profile/src/main/java/com/ibm/fhir/profile/ConstraintGenerator.java", "diffHunk": "@@ -304,13 +313,38 @@ private String generatePatternValueConstraint(ElementDefinition elementDefinitio\n             CodeableConcept codeableConcept = pattern.as(CodeableConcept.class);\n             Coding coding = codeableConcept.getCoding().get(0);\n             String system = (coding.getSystem() != null) ? coding.getSystem().getValue() : null;\n+\n             sb.append(\".where(coding.where(\");\n+\n             if (system != null) {\n                 sb.append(\"system = '\").append(system).append(\"' and \");\n             }\n-            sb.append(\"code = '\")\n-                .append(coding.getCode().getValue())\n-                .append(\"').exists()).exists()\");\n+\n+            sb.append(\"code = '\").append(coding.getCode().getValue()).append(\"').exists()).exists()\");\n+        } else if (pattern.is(Identifier.class)) {\n+            Identifier _identifier = pattern.as(Identifier.class);\n+            String system = _identifier.getSystem().getValue();\n+\n+            sb.append(\".where(system = '\").append(system).append(\"').count()\");\n+\n+            Integer min = elementDefinition.getMin().getValue();\n+            String max = elementDefinition.getMax().getValue();\n+\n+            if (\"*\".equals(max)) {\n+                sb.append(\" >= \").append(min);\n+            } else if (\"1\".equals(max)) {\n+                if (min == 0) {\n+                    sb.append(\" <= 1\");\n+                } else {\n+                    sb.append(\" = 1\");\n+                }\n+            } else {\n+                sb.append(\" >= \").append(min).append(\" and \").append(identifier).append(\".where(system = '\").append(system).append(\"').count() <= \").append(max);\n+            }\n+\n+            if (!node.children.isEmpty()) {\n+                sb.append(\" and (\").append(identifier).append(\".where(system = '\").append(system).append(\"').exists()\").append(\" implies (\").append(identifier).append(\".where(system = '\").append(system).append(\"' and \").append(generate(node.children)).append(\")))\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2NDY3Ng==", "bodyText": "or maybe just a comment to indicate what this and clause is doing (at a high level)?", "url": "https://github.com/IBM/FHIR/pull/1115#discussion_r426864676", "createdAt": "2020-05-18T20:04:48Z", "author": {"login": "lmsurpre"}, "path": "fhir-profile/src/main/java/com/ibm/fhir/profile/ConstraintGenerator.java", "diffHunk": "@@ -304,13 +313,38 @@ private String generatePatternValueConstraint(ElementDefinition elementDefinitio\n             CodeableConcept codeableConcept = pattern.as(CodeableConcept.class);\n             Coding coding = codeableConcept.getCoding().get(0);\n             String system = (coding.getSystem() != null) ? coding.getSystem().getValue() : null;\n+\n             sb.append(\".where(coding.where(\");\n+\n             if (system != null) {\n                 sb.append(\"system = '\").append(system).append(\"' and \");\n             }\n-            sb.append(\"code = '\")\n-                .append(coding.getCode().getValue())\n-                .append(\"').exists()).exists()\");\n+\n+            sb.append(\"code = '\").append(coding.getCode().getValue()).append(\"').exists()).exists()\");\n+        } else if (pattern.is(Identifier.class)) {\n+            Identifier _identifier = pattern.as(Identifier.class);\n+            String system = _identifier.getSystem().getValue();\n+\n+            sb.append(\".where(system = '\").append(system).append(\"').count()\");\n+\n+            Integer min = elementDefinition.getMin().getValue();\n+            String max = elementDefinition.getMax().getValue();\n+\n+            if (\"*\".equals(max)) {\n+                sb.append(\" >= \").append(min);\n+            } else if (\"1\".equals(max)) {\n+                if (min == 0) {\n+                    sb.append(\" <= 1\");\n+                } else {\n+                    sb.append(\" = 1\");\n+                }\n+            } else {\n+                sb.append(\" >= \").append(min).append(\" and \").append(identifier).append(\".where(system = '\").append(system).append(\"').count() <= \").append(max);\n+            }\n+\n+            if (!node.children.isEmpty()) {\n+                sb.append(\" and (\").append(identifier).append(\".where(system = '\").append(system).append(\"').exists()\").append(\" implies (\").append(identifier).append(\".where(system = '\").append(system).append(\"' and \").append(generate(node.children)).append(\")))\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2NDA1OQ=="}, "originalCommit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2NDg2Mg==", "bodyText": "The way the constraint is generated, there isn't much in the way of indentation that will do it justice. Looking at the actual generated constraint is more helpful.", "url": "https://github.com/IBM/FHIR/pull/1115#discussion_r426864862", "createdAt": "2020-05-18T20:05:11Z", "author": {"login": "JohnTimm"}, "path": "fhir-profile/src/main/java/com/ibm/fhir/profile/ConstraintGenerator.java", "diffHunk": "@@ -304,13 +313,38 @@ private String generatePatternValueConstraint(ElementDefinition elementDefinitio\n             CodeableConcept codeableConcept = pattern.as(CodeableConcept.class);\n             Coding coding = codeableConcept.getCoding().get(0);\n             String system = (coding.getSystem() != null) ? coding.getSystem().getValue() : null;\n+\n             sb.append(\".where(coding.where(\");\n+\n             if (system != null) {\n                 sb.append(\"system = '\").append(system).append(\"' and \");\n             }\n-            sb.append(\"code = '\")\n-                .append(coding.getCode().getValue())\n-                .append(\"').exists()).exists()\");\n+\n+            sb.append(\"code = '\").append(coding.getCode().getValue()).append(\"').exists()).exists()\");\n+        } else if (pattern.is(Identifier.class)) {\n+            Identifier _identifier = pattern.as(Identifier.class);\n+            String system = _identifier.getSystem().getValue();\n+\n+            sb.append(\".where(system = '\").append(system).append(\"').count()\");\n+\n+            Integer min = elementDefinition.getMin().getValue();\n+            String max = elementDefinition.getMax().getValue();\n+\n+            if (\"*\".equals(max)) {\n+                sb.append(\" >= \").append(min);\n+            } else if (\"1\".equals(max)) {\n+                if (min == 0) {\n+                    sb.append(\" <= 1\");\n+                } else {\n+                    sb.append(\" = 1\");\n+                }\n+            } else {\n+                sb.append(\" >= \").append(min).append(\" and \").append(identifier).append(\".where(system = '\").append(system).append(\"').count() <= \").append(max);\n+            }\n+\n+            if (!node.children.isEmpty()) {\n+                sb.append(\" and (\").append(identifier).append(\".where(system = '\").append(system).append(\"').exists()\").append(\" implies (\").append(identifier).append(\".where(system = '\").append(system).append(\"' and \").append(generate(node.children)).append(\")))\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2NDA1OQ=="}, "originalCommit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "originalPosition": 131}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4834, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}