{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MDU1MDMx", "number": 1677, "reviewThreads": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMzozMzozNFrOE4dKEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMjo0ODo1NFrOE5vpEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NjMzNDI1OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMzozMzozNFrOHyYffA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMzoyNToxOFrOHyuNHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjEyNA==", "bodyText": "where does it actually set the bytes for the BLOB column?!", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522592124", "createdAt": "2020-11-13T03:33:34Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -549,6 +564,19 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n \n             resource.setId(stmt.getLong(7));\n \n+            if (large) {\n+                // Use the long id to update the record in the database.\n+                String largeStmtString = String.format(LARGE_BLOB, getSchemaName(), resource.getResourceType());\n+                PreparedStatement ps = connection.prepareStatement(largeStmtString);\n+                ps.setLong(1, stmt.getLong(7));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04652994181754ca2614233e318f27e0eecd7cc1"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk0Nzg3MQ==", "bodyText": "Thanks, silly me - I was doing this late at night", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522947871", "createdAt": "2020-11-13T13:25:18Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -549,6 +564,19 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n \n             resource.setId(stmt.getLong(7));\n \n+            if (large) {\n+                // Use the long id to update the record in the database.\n+                String largeStmtString = String.format(LARGE_BLOB, getSchemaName(), resource.getResourceType());\n+                PreparedStatement ps = connection.prepareStatement(largeStmtString);\n+                ps.setLong(1, stmt.getLong(7));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjEyNA=="}, "originalCommit": {"oid": "04652994181754ca2614233e318f27e0eecd7cc1"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODYyMjA2OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMzo1NDoxOFrOHyvKMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMzo1NDoxOFrOHyvKMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk2MzUwNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    log.fine(\"DB search by ids complete. SQL=[\" + largeStmtString + \"]  executionTime=\" + dbCallDuration2 + \"ms\");\n          \n          \n            \n                                    log.fine(\"DB update complete. SQL=[\" + largeStmtString + \"]  executionTime=\" + dbCallDuration2 + \"ms\");", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522963506", "createdAt": "2020-11-13T13:54:18Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -549,6 +564,21 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n \n             resource.setId(stmt.getLong(7));\n \n+            if (large) {\n+                // Use the long id to update the record in the database.\n+                String largeStmtString = String.format(LARGE_BLOB, getSchemaName(), resource.getResourceType());\n+                try (PreparedStatement ps = connection.prepareStatement(largeStmtString);) {\n+                    ps.setBytes(1, resource.getData());\n+                    ps.setLong(2, stmt.getLong(7));\n+                    long dbCallStartTime2 = System.nanoTime();\n+                    stmt.execute();\n+                    double dbCallDuration2 = (System.nanoTime() - dbCallStartTime2) / 1e6;\n+                    if (log.isLoggable(Level.FINE)) {\n+                        log.fine(\"DB search by ids complete. SQL=[\" + largeStmtString + \"]  executionTime=\" + dbCallDuration2 + \"ms\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f9710ff252c5a96deb8244d7170a788ffdb68a7"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODcxMDYwOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoxNzo0NFrOHywALg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyNTowM1rOHzADoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3NzMyNg==", "bodyText": "That's going to overwrite the data for every version. You need to use resource_id = ? which is the PK for this table.", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522977326", "createdAt": "2020-11-13T14:17:44Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -57,6 +57,12 @@\n public class ResourceDAOImpl extends FHIRDbDAOImpl implements ResourceDAO {\n     private static final Logger log = Logger.getLogger(ResourceDAOImpl.class.getName());\n     private static final String CLASSNAME = ResourceDAOImpl.class.getName();\n+\n+    // Per issue with private memory in db2, we have set this to 1M.\n+    // Anything larger than 1M is then inserted into the db with an update.\n+    private static final int SIZE_LIMIT = 1048576;\n+    private static final String LARGE_BLOB = \"UPDATE %s.%s_RESOURCES SET data = ? WHERE logical_resource_id = ?\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MDM1Mg==", "bodyText": "Right - great point, fixed", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523240352", "createdAt": "2020-11-13T21:25:03Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -57,6 +57,12 @@\n public class ResourceDAOImpl extends FHIRDbDAOImpl implements ResourceDAO {\n     private static final Logger log = Logger.getLogger(ResourceDAOImpl.class.getName());\n     private static final String CLASSNAME = ResourceDAOImpl.class.getName();\n+\n+    // Per issue with private memory in db2, we have set this to 1M.\n+    // Anything larger than 1M is then inserted into the db with an update.\n+    private static final int SIZE_LIMIT = 1048576;\n+    private static final String LARGE_BLOB = \"UPDATE %s.%s_RESOURCES SET data = ? WHERE logical_resource_id = ?\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3NzMyNg=="}, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODcxNjU0OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoxOToxNlrOHywD0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyNDo1MFrOHzADRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3ODI1OQ==", "bodyText": "Move to FhirSchemaConstants (if fhir-persistence-schema is already a dependency).", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522978259", "createdAt": "2020-11-13T14:19:16Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -57,6 +57,12 @@\n public class ResourceDAOImpl extends FHIRDbDAOImpl implements ResourceDAO {\n     private static final Logger log = Logger.getLogger(ResourceDAOImpl.class.getName());\n     private static final String CLASSNAME = ResourceDAOImpl.class.getName();\n+\n+    // Per issue with private memory in db2, we have set this to 1M.\n+    // Anything larger than 1M is then inserted into the db with an update.\n+    private static final int SIZE_LIMIT = 1048576;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MDI2Mg==", "bodyText": "Done", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523240262", "createdAt": "2020-11-13T21:24:50Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -57,6 +57,12 @@\n public class ResourceDAOImpl extends FHIRDbDAOImpl implements ResourceDAO {\n     private static final Logger log = Logger.getLogger(ResourceDAOImpl.class.getName());\n     private static final String CLASSNAME = ResourceDAOImpl.class.getName();\n+\n+    // Per issue with private memory in db2, we have set this to 1M.\n+    // Anything larger than 1M is then inserted into the db with an update.\n+    private static final int SIZE_LIMIT = 1048576;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3ODI1OQ=="}, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODcxOTM0OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoxOTo1NlrOHywFfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMjoyMVrOHy_-yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3ODY4Nw==", "bodyText": "I think it should be:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String LARGE_BLOB = \"UPDATE %s.%s_RESOURCES SET data = ? WHERE logical_resource_id = ?\";\n          \n          \n            \n                private static final String LARGE_BLOB = \"UPDATE %s.%s_RESOURCES SET data = ? WHERE resource_id = ?\";\n          \n      \n    \n    \n  \n\nWould like to see a test that creates a large resource, updates it, then reads both versions and confirms they are right.", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522978687", "createdAt": "2020-11-13T14:19:56Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -57,6 +57,12 @@\n public class ResourceDAOImpl extends FHIRDbDAOImpl implements ResourceDAO {\n     private static final Logger log = Logger.getLogger(ResourceDAOImpl.class.getName());\n     private static final String CLASSNAME = ResourceDAOImpl.class.getName();\n+\n+    // Per issue with private memory in db2, we have set this to 1M.\n+    // Anything larger than 1M is then inserted into the db with an update.\n+    private static final int SIZE_LIMIT = 1048576;\n+    private static final String LARGE_BLOB = \"UPDATE %s.%s_RESOURCES SET data = ? WHERE logical_resource_id = ?\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTExMw==", "bodyText": "Fixed", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523239113", "createdAt": "2020-11-13T21:22:21Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -57,6 +57,12 @@\n public class ResourceDAOImpl extends FHIRDbDAOImpl implements ResourceDAO {\n     private static final Logger log = Logger.getLogger(ResourceDAOImpl.class.getName());\n     private static final String CLASSNAME = ResourceDAOImpl.class.getName();\n+\n+    // Per issue with private memory in db2, we have set this to 1M.\n+    // Anything larger than 1M is then inserted into the db with an update.\n+    private static final int SIZE_LIMIT = 1048576;\n+    private static final String LARGE_BLOB = \"UPDATE %s.%s_RESOURCES SET data = ? WHERE logical_resource_id = ?\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3ODY4Nw=="}, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODcyMzY0OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoyMDo1OFrOHywIHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMjo1NlrOHy__sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3OTM1Nw==", "bodyText": "You should specify the actual data-type here: java.sql.Types.BLOB.", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522979357", "createdAt": "2020-11-13T14:20:58Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -535,7 +541,16 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n             stmt = connection.prepareCall(stmtString);\n             stmt.setString(1, resource.getResourceType());\n             stmt.setString(2, resource.getLogicalId());\n-            stmt.setBytes(3, resource.getData());\n+\n+            boolean large = false;\n+            if (SIZE_LIMIT < resource.getData().length) {\n+                // Outside of the normal flow we have a BIG JSON or XML\n+                stmt.setNull(3, java.sql.Types.NULL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTM0Nw==", "bodyText": "Done", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523239347", "createdAt": "2020-11-13T21:22:56Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -535,7 +541,16 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n             stmt = connection.prepareCall(stmtString);\n             stmt.setString(1, resource.getResourceType());\n             stmt.setString(2, resource.getLogicalId());\n-            stmt.setBytes(3, resource.getData());\n+\n+            boolean large = false;\n+            if (SIZE_LIMIT < resource.getData().length) {\n+                // Outside of the normal flow we have a BIG JSON or XML\n+                stmt.setNull(3, java.sql.Types.NULL);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3OTM1Nw=="}, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODczNzA4OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoyNDoxNlrOHywQJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMjozNVrOHy__LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4MTQxMg==", "bodyText": "For table access, don't need to qualify with the schema name, although it doesn't hurt.", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522981412", "createdAt": "2020-11-13T14:24:16Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -549,6 +564,21 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n \n             resource.setId(stmt.getLong(7));\n \n+            if (large) {\n+                // Use the long id to update the record in the database.\n+                String largeStmtString = String.format(LARGE_BLOB, getSchemaName(), resource.getResourceType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTIxMg==", "bodyText": "Thanks", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523239212", "createdAt": "2020-11-13T21:22:35Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -549,6 +564,21 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n \n             resource.setId(stmt.getLong(7));\n \n+            if (large) {\n+                // Use the long id to update the record in the database.\n+                String largeStmtString = String.format(LARGE_BLOB, getSchemaName(), resource.getResourceType());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4MTQxMg=="}, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODc0MDEzOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoyNTowMFrOHywR7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyNTo0MFrOHzAEqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4MTg2OQ==", "bodyText": "; is redundant", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522981869", "createdAt": "2020-11-13T14:25:00Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -549,6 +564,21 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n \n             resource.setId(stmt.getLong(7));\n \n+            if (large) {\n+                // Use the long id to update the record in the database.\n+                String largeStmtString = String.format(LARGE_BLOB, getSchemaName(), resource.getResourceType());\n+                try (PreparedStatement ps = connection.prepareStatement(largeStmtString);) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MDYxOA==", "bodyText": "Yeah - sometimes I get in the habit, as I often add second closeables, I've removed in this case", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523240618", "createdAt": "2020-11-13T21:25:40Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -549,6 +564,21 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n \n             resource.setId(stmt.getLong(7));\n \n+            if (large) {\n+                // Use the long id to update the record in the database.\n+                String largeStmtString = String.format(LARGE_BLOB, getSchemaName(), resource.getResourceType());\n+                try (PreparedStatement ps = connection.prepareStatement(largeStmtString);) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4MTg2OQ=="}, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODc0NzAwOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoyNjo0NlrOHywWLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoyNjo0NlrOHywWLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4Mjk1Nw==", "bodyText": "I'd put stmt.getLong(7) into a local variable like dbResourceId just so we know what is being passed here.", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522982957", "createdAt": "2020-11-13T14:26:46Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -549,6 +564,21 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n \n             resource.setId(stmt.getLong(7));\n \n+            if (large) {\n+                // Use the long id to update the record in the database.\n+                String largeStmtString = String.format(LARGE_BLOB, getSchemaName(), resource.getResourceType());\n+                try (PreparedStatement ps = connection.prepareStatement(largeStmtString);) {\n+                    ps.setBytes(1, resource.getData());\n+                    ps.setLong(2, stmt.getLong(7));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODc1NTQzOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/resources/db2/add_any_resource.sql", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDoyODo1MVrOHywbjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyNjo1NVrOHzAGuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4NDMzNA==", "bodyText": "That's definitely 1MiB not 1MB, right?", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r522984334", "createdAt": "2020-11-13T14:28:51Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/resources/db2/add_any_resource.sql", "diffHunk": "@@ -17,7 +17,7 @@\n -- ----------------------------------------------------------------------------\n     ( IN p_resource_type                 VARCHAR( 36 OCTETS),\n       IN p_logical_id                    VARCHAR(255 OCTETS), \n-      IN p_payload                          BLOB(2147483647),\n+      IN p_payload                          BLOB(1M),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MTE0NQ==", "bodyText": "Fixed to be explicit - I was under the impression it was 1MB (all capital)", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523241145", "createdAt": "2020-11-13T21:26:55Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/resources/db2/add_any_resource.sql", "diffHunk": "@@ -17,7 +17,7 @@\n -- ----------------------------------------------------------------------------\n     ( IN p_resource_type                 VARCHAR( 36 OCTETS),\n       IN p_logical_id                    VARCHAR(255 OCTETS), \n-      IN p_payload                          BLOB(2147483647),\n+      IN p_payload                          BLOB(1M),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4NDMzNA=="}, "originalCommit": {"oid": "9c44d38ee51a3fcb7f1cf1d89882c959c1036460"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDc3OTIzOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMDozODowOFrOHzDxKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMDo1NToyNFrOHzD-HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwMTE2MA==", "bodyText": "I know robin recommended to save this to a local variable, but I really don't like this variable name.  It makes it seem like it is the LOGICAL_RESOURCE_ID from this table but it is actually the RESOURCE_ID.\nAside:  I also don't love that we use the name RESOURCE_ID for this column...I'd have preferred something like VERSIONED_RESOURCE_ID or RESOURCE_VERSION_ROW_ID or similar, but we've had that since forever.\nSince we probably don't want to touch the schema, maybe we can at least use that to name the variable?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        long logicalResourceId = stmt.getLong(7);\n          \n          \n            \n                        long versionedResourceRowId = stmt.getLong(7);", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523301160", "createdAt": "2020-11-14T00:38:08Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -547,7 +563,23 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n             long latestTime = System.nanoTime();\n             double dbCallDuration = (latestTime-dbCallStartTime)/1e6;\n \n-            resource.setId(stmt.getLong(7));\n+            long logicalResourceId = stmt.getLong(7);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9b353d1d7f22f7155f3fac9f02f7b9ab5f04c7f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDQ3Ng==", "bodyText": "Actually, scratch that, it is the logical resource id that we get back.  In this case the variable was named correctly but the update command won't.  We need to get the RESOURCE_ID (and not the LOGICAL_RESOURCE_ID) that was just written so that we can update just that row.", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r523304476", "createdAt": "2020-11-14T00:55:24Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -547,7 +563,23 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n             long latestTime = System.nanoTime();\n             double dbCallDuration = (latestTime-dbCallStartTime)/1e6;\n \n-            resource.setId(stmt.getLong(7));\n+            long logicalResourceId = stmt.getLong(7);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwMTE2MA=="}, "originalCommit": {"oid": "a9b353d1d7f22f7155f3fac9f02f7b9ab5f04c7f"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzY5MTQwOnYy", "diffSide": "LEFT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNTozNVrOH0DzLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNTozNVrOH0DzLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MDI1NQ==", "bodyText": "bad formatting change.  the double-indent signifies that its a continuation of the previous line so that it doesn't look like the first line of the method", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524350255", "createdAt": "2020-11-16T15:25:35Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -178,7 +188,7 @@ protected ParameterTransactionDataImpl getTransactionData() {\n \n     @Override\n     public Resource read(String logicalId, String resourceType)\n-            throws FHIRPersistenceDataAccessException, FHIRPersistenceDBConnectException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 133}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzY5MTc2OnYy", "diffSide": "LEFT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNTo0MVrOH0Dzag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNTo0MVrOH0Dzag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MDMxNA==", "bodyText": "bad formatting change.  the double-indent signifies that its a continuation of the previous line so that it doesn't look like the first line of the method", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524350314", "createdAt": "2020-11-16T15:25:41Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -200,7 +210,7 @@ public Resource read(String logicalId, String resourceType)\n \n     @Override\n     public Resource versionRead(String logicalId, String resourceType, int versionId)\n-            throws FHIRPersistenceDataAccessException, FHIRPersistenceDBConnectException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzY5Mzg1OnYy", "diffSide": "LEFT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNjowNlrOH0D0qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNjowNlrOH0D0qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MDYzMg==", "bodyText": "bad formatting change.  should be a double-indent", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524350632", "createdAt": "2020-11-16T15:26:06Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -253,7 +265,7 @@ protected Resource createDTO(ResultSet resultSet) throws FHIRPersistenceDataAcce\n \n     @Override\n     public List<Resource> history(String resourceType, String logicalId, Timestamp fromDateTime, int offset, int maxResults)\n-                                    throws FHIRPersistenceDataAccessException, FHIRPersistenceDBConnectException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 162}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzY5NTgyOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNjoyOVrOH0D19A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNjoyOVrOH0D19A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MDk2NA==", "bodyText": "double-indent", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524350964", "createdAt": "2020-11-16T15:26:29Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -281,13 +293,14 @@ protected Resource createDTO(ResultSet resultSet) throws FHIRPersistenceDataAcce\n                 }\n             }\n         } finally {\n-            log.exiting(CLASSNAME, METHODNAME, Arrays.toString(new Object[] {resources}));\n+            log.exiting(CLASSNAME, METHODNAME, Arrays.toString(new Object[] { resources }));\n         }\n         return resources;\n     }\n \n     @Override\n-    public int historyCount(String resourceType, String logicalId, Timestamp fromDateTime) throws FHIRPersistenceDataAccessException, FHIRPersistenceDBConnectException {\n+    public int historyCount(String resourceType, String logicalId, Timestamp fromDateTime)\n+        throws FHIRPersistenceDataAccessException, FHIRPersistenceDBConnectException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 180}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzY5NjY2OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNjozOVrOH0D2gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNjozOVrOH0D2gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MTEwNg==", "bodyText": "double-indent", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524351106", "createdAt": "2020-11-16T15:26:39Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -350,7 +363,7 @@ public void setPersistenceContext(FHIRPersistenceContext context) {\n \n     @Override\n     public Map<String, Integer> readAllResourceTypeNames()\n-                                         throws FHIRPersistenceDBConnectException, FHIRPersistenceDataAccessException {\n+        throws FHIRPersistenceDBConnectException, FHIRPersistenceDataAccessException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 198}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzcwMjQ0OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNzo1MFrOH0D6JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyNzo1MFrOH0D6JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MjAzNg==", "bodyText": "bad formatting change.  the double-indent signifies that its a continuation of the previous line so that it doesn't look like the first line of the method", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524352036", "createdAt": "2020-11-16T15:27:50Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -720,7 +739,7 @@ public int searchCount(String sqlSelectCount) throws FHIRPersistenceDataAccessEx\n \n     @Override\n     public List<String> searchStringValues(SqlQueryData queryData)\n-            throws FHIRPersistenceDataAccessException, FHIRPersistenceDBConnectException {\n+        throws FHIRPersistenceDataAccessException, FHIRPersistenceDBConnectException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 428}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzcxMTkxOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/resources/db2/add_any_resource.sql", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyOTo0NlrOH0EAFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTo0MjozMlrOH0Enfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MzU1OQ==", "bodyText": "I'm still confused about how this can be a BIGINT.  I guess its not the same as the Resource.id field of the resource?", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524353559", "createdAt": "2020-11-16T15:29:46Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-schema/src/main/resources/db2/add_any_resource.sql", "diffHunk": "@@ -13,15 +13,17 @@\n -- p_last_updated the last_updated time given by the FHIR server\n -- p_is_deleted: the soft delete flag\n -- p_version_id: the version id if this is a replicated message\n+-- o_logical_resource_id: output field returning the newly assigned logical_resource_id value\n -- o_resource_id: output field returning the newly assigned resource_id value\n -- ----------------------------------------------------------------------------\n-    ( IN p_resource_type                 VARCHAR( 36 OCTETS),\n-      IN p_logical_id                    VARCHAR(255 OCTETS), \n-      IN p_payload                          BLOB(1048576),\n-      IN p_last_updated                TIMESTAMP,\n-      IN p_is_deleted                       CHAR(  1),\n-      IN p_version                           INT,\n-      OUT o_logical_resource_id            BIGINT\n+    ( IN p_resource_type                VARCHAR( 36 OCTETS),\n+      IN p_logical_id                   VARCHAR(255 OCTETS), \n+      IN p_payload                         BLOB(1048576),\n+      IN p_last_updated               TIMESTAMP,\n+      IN p_is_deleted                      CHAR(  1),\n+      IN p_version                          INT,\n+      OUT o_logical_resource_id          BIGINT,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2MzY0Nw==", "bodyText": "ok, I looked this up.  its not the first time I've been tripped up on this:\nX_LOGICAL_RESOURCES.LOGICAL_RESOURCE_ID = the unique key of the X_LOGICAL_RESOURCES table\nX_LOGICAL_RESOURCES.LOGICAL_ID = the value of the Resource.id field for this resource\n\nso o_logical_resource_id corresponds to X_LOGICAL_RESOURCES.LOGICAL_RESOURCE_ID", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524363647", "createdAt": "2020-11-16T15:42:32Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-schema/src/main/resources/db2/add_any_resource.sql", "diffHunk": "@@ -13,15 +13,17 @@\n -- p_last_updated the last_updated time given by the FHIR server\n -- p_is_deleted: the soft delete flag\n -- p_version_id: the version id if this is a replicated message\n+-- o_logical_resource_id: output field returning the newly assigned logical_resource_id value\n -- o_resource_id: output field returning the newly assigned resource_id value\n -- ----------------------------------------------------------------------------\n-    ( IN p_resource_type                 VARCHAR( 36 OCTETS),\n-      IN p_logical_id                    VARCHAR(255 OCTETS), \n-      IN p_payload                          BLOB(1048576),\n-      IN p_last_updated                TIMESTAMP,\n-      IN p_is_deleted                       CHAR(  1),\n-      IN p_version                           INT,\n-      OUT o_logical_resource_id            BIGINT\n+    ( IN p_resource_type                VARCHAR( 36 OCTETS),\n+      IN p_logical_id                   VARCHAR(255 OCTETS), \n+      IN p_payload                         BLOB(1048576),\n+      IN p_last_updated               TIMESTAMP,\n+      IN p_is_deleted                      CHAR(  1),\n+      IN p_version                          INT,\n+      OUT o_logical_resource_id          BIGINT,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MzU1OQ=="}, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4ODQyMTEwOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNzo1NTo1N1rOH0KuRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODo0MDo1MVrOH0MZNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2MzY4NA==", "bodyText": "&& resource.getData() != null", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524463684", "createdAt": "2020-11-16T17:55:57Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -535,19 +558,46 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n             stmt = connection.prepareCall(stmtString);\n             stmt.setString(1, resource.getResourceType());\n             stmt.setString(2, resource.getLogicalId());\n-            stmt.setBytes(3, resource.getData());\n+\n+            // Check for large objects, and branch around it.\n+            boolean large = FhirSchemaConstants.STORED_PROCEDURE_SIZE_LIMIT < resource.getData().length;\n+            if (large) {\n+                // Outside of the normal flow we have a BIG JSON or XML\n+                stmt.setNull(3, Types.BLOB);\n+            } else {\n+                // Normal Flow, we set the data\n+                stmt.setBytes(3, resource.getData());\n+            }\n \n             lastUpdated = resource.getLastUpdated();\n             stmt.setTimestamp(4, lastUpdated, UTC);\n             stmt.setString(5, resource.isDeleted() ? \"Y\": \"N\");\n             stmt.setInt(6, resource.getVersionId());\n             stmt.registerOutParameter(7, Types.BIGINT);\n+            stmt.registerOutParameter(8, Types.BIGINT);\n \n             stmt.execute();\n             long latestTime = System.nanoTime();\n             double dbCallDuration = (latestTime-dbCallStartTime)/1e6;\n \n             resource.setId(stmt.getLong(7));\n+            long versionedResourceRowId = stmt.getLong(8);\n+            if (large) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 332}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5MTA2Mw==", "bodyText": "it would have thrown a NPE prior to this.", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524491063", "createdAt": "2020-11-16T18:40:51Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -535,19 +558,46 @@ public Resource insert(Resource resource, List<ExtractedParameterValue> paramete\n             stmt = connection.prepareCall(stmtString);\n             stmt.setString(1, resource.getResourceType());\n             stmt.setString(2, resource.getLogicalId());\n-            stmt.setBytes(3, resource.getData());\n+\n+            // Check for large objects, and branch around it.\n+            boolean large = FhirSchemaConstants.STORED_PROCEDURE_SIZE_LIMIT < resource.getData().length;\n+            if (large) {\n+                // Outside of the normal flow we have a BIG JSON or XML\n+                stmt.setNull(3, Types.BLOB);\n+            } else {\n+                // Normal Flow, we set the data\n+                stmt.setBytes(3, resource.getData());\n+            }\n \n             lastUpdated = resource.getLastUpdated();\n             stmt.setTimestamp(4, lastUpdated, UTC);\n             stmt.setString(5, resource.isDeleted() ? \"Y\": \"N\");\n             stmt.setInt(6, resource.getVersionId());\n             stmt.registerOutParameter(7, Types.BIGINT);\n+            stmt.registerOutParameter(8, Types.BIGINT);\n \n             stmt.execute();\n             long latestTime = System.nanoTime();\n             double dbCallDuration = (latestTime-dbCallStartTime)/1e6;\n \n             resource.setId(stmt.getLong(7));\n+            long versionedResourceRowId = stmt.getLong(8);\n+            if (large) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2MzY4NA=="}, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 332}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4ODQyNzM5OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/resources/db2/add_any_resource.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNzo1NzoyNlrOH0KyCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNzo1NzoyNlrOH0KyCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2NDY0OA==", "bodyText": "This comment no longer applied", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524464648", "createdAt": "2020-11-16T17:57:26Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/resources/db2/add_any_resource.sql", "diffHunk": "@@ -198,4 +200,7 @@ BEGIN\n   -- only the logical_resource_id is the target of any FK, so there's no need to return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb76e7eed12715fd0cb8397a55a66adec54b8750"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4OTg0ODQ5OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMjo0ODo1NFrOH0ZRiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMjo0ODo1NFrOH0ZRiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDcwMjA4OQ==", "bodyText": "double-indent pls", "url": "https://github.com/IBM/FHIR/pull/1677#discussion_r524702089", "createdAt": "2020-11-16T22:48:54Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/dao/impl/ResourceDAOImpl.java", "diffHunk": "@@ -142,8 +142,7 @@\n      * @param trxSyncRegistry\n      */\n     public ResourceDAOImpl(Connection c, String schemaName, FHIRDbFlavor flavor, TransactionSynchronizationRegistry trxSynchRegistry,\n-            FHIRPersistenceJDBCCache cache, IResourceReferenceDAO rrd,\n-            ParameterTransactionDataImpl ptdi) {\n+        FHIRPersistenceJDBCCache cache, IResourceReferenceDAO rrd, ParameterTransactionDataImpl ptdi) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a691a9bfe33cc214dcd3208b8c3bc6d171cb247"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4616, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}