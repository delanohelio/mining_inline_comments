{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NTMwODc4", "number": 1687, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo0Njo0M1rOE3QpfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1OTowM1rOE3RB1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2Mzc5OTAxOnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo0Njo0M1rOHwgAug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNToyNzowOVrOHwh94A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYxODE3MA==", "bodyText": "As this is being run as maintenance task I supposed we're not going to be too worried about concurrency. Selecting first then inserting what's missing isn't thread-safe but it's probably not a big deal here.", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520618170", "createdAt": "2020-11-10T14:46:43Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -52,15 +54,27 @@ public PopulateParameterNames(String adminSchemaName, String schemaName, Integer\n     public void run(IDatabaseTranslator translator, Connection c) {\n         final String stmtVariable = String.format(\"SET %s.SV_TENANT_ID = %d\", adminSchemaName, tenantId);\n         final String stmtResourceTypeInsert;\n+        final String PARAMETER_NAMES = String.format(\"SELECT PARAMETER_NAME_ID, PARAMETER_NAME FROM %s.parameter_names\", schemaName);\n         if (tenantId != null) {\n             stmtResourceTypeInsert =\n                     String.format(\"INSERT INTO %s.parameter_names (MT_ID, PARAMETER_NAME_ID, PARAMETER_NAME) \"\n                             + \"VALUES (%s.sv_tenant_id, ?, ?)\", schemaName, adminSchemaName);\n         } else {\n             stmtResourceTypeInsert =\n-                    String.format(\n-                            \"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\",\n-                            schemaName);\n+                    String.format(\"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\", schemaName);\n+        }\n+\n+        Map<String, Integer> values = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzODIxNg==", "bodyText": "Good point, I'll have to defer this part... if customers hit we can add USING RS", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520638216", "createdAt": "2020-11-10T15:12:00Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -52,15 +54,27 @@ public PopulateParameterNames(String adminSchemaName, String schemaName, Integer\n     public void run(IDatabaseTranslator translator, Connection c) {\n         final String stmtVariable = String.format(\"SET %s.SV_TENANT_ID = %d\", adminSchemaName, tenantId);\n         final String stmtResourceTypeInsert;\n+        final String PARAMETER_NAMES = String.format(\"SELECT PARAMETER_NAME_ID, PARAMETER_NAME FROM %s.parameter_names\", schemaName);\n         if (tenantId != null) {\n             stmtResourceTypeInsert =\n                     String.format(\"INSERT INTO %s.parameter_names (MT_ID, PARAMETER_NAME_ID, PARAMETER_NAME) \"\n                             + \"VALUES (%s.sv_tenant_id, ?, ?)\", schemaName, adminSchemaName);\n         } else {\n             stmtResourceTypeInsert =\n-                    String.format(\n-                            \"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\",\n-                            schemaName);\n+                    String.format(\"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\", schemaName);\n+        }\n+\n+        Map<String, Integer> values = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYxODE3MA=="}, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY1MDIwOA==", "bodyText": "Yeah, I'm not too worried about this in this context.", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520650208", "createdAt": "2020-11-10T15:27:09Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -52,15 +54,27 @@ public PopulateParameterNames(String adminSchemaName, String schemaName, Integer\n     public void run(IDatabaseTranslator translator, Connection c) {\n         final String stmtVariable = String.format(\"SET %s.SV_TENANT_ID = %d\", adminSchemaName, tenantId);\n         final String stmtResourceTypeInsert;\n+        final String PARAMETER_NAMES = String.format(\"SELECT PARAMETER_NAME_ID, PARAMETER_NAME FROM %s.parameter_names\", schemaName);\n         if (tenantId != null) {\n             stmtResourceTypeInsert =\n                     String.format(\"INSERT INTO %s.parameter_names (MT_ID, PARAMETER_NAME_ID, PARAMETER_NAME) \"\n                             + \"VALUES (%s.sv_tenant_id, ?, ?)\", schemaName, adminSchemaName);\n         } else {\n             stmtResourceTypeInsert =\n-                    String.format(\n-                            \"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\",\n-                            schemaName);\n+                    String.format(\"INSERT INTO %s.parameter_names (PARAMETER_NAME_ID, PARAMETER_NAME) \" + \"VALUES (?, ?)\", schemaName);\n+        }\n+\n+        Map<String, Integer> values = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYxODE3MA=="}, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MzgzNjg4OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1NDoyMFrOHwgYqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1NDoyMFrOHwgYqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNDI5OA==", "bodyText": "Parameter", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520624298", "createdAt": "2020-11-10T14:54:20Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -76,26 +90,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n-                    batch.setLong(1, curVal);\n-                    batch.setString(2, code);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(code)) {\n+                        batch.setLong(1, curVal);\n+                        batch.setString(2, code);\n+                        batch.addBatch();\n+                        numToProcess++;\n                     }\n                 }\n-                if (errorCodes > 0) {\n-                    String msg = \"at least one of the Paramater Name/Codes are not populated [\" + errorCodes + \"]\";\n-                    LOGGER.severe(msg);\n-                    throw new IllegalArgumentException(msg);\n+\n+                // Only execute with num to process\n+                if (numToProcess > 0) {\n+                    // Check Error Codes.\n+                    int[] codes = batch.executeBatch();\n+                    int errorCodes = 0;\n+                    for (int code : codes) {\n+                        if (code < 0) {\n+                            errorCodes++;\n+                        }\n+                    }\n+                    if (errorCodes > 0) {\n+                        String msg = \"at least one of the Paramater Name/Codes are not populated [\" + errorCodes + \"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2Mzg1ODQ3OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1ODozMFrOHwglzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNToxMTowN1rOHwhMHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNzY2MQ==", "bodyText": "Shouldn't this be\n   if (!values.containsKey(code))", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520627661", "createdAt": "2020-11-10T14:58:30Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -76,26 +90,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n-                    batch.setLong(1, curVal);\n-                    batch.setString(2, code);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(code)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzNzQ2OQ==", "bodyText": "Yes! eagle eyes", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520637469", "createdAt": "2020-11-10T15:11:07Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateParameterNames.java", "diffHunk": "@@ -76,26 +90,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String code = (String) valueEntry.getKey();\n-                    batch.setLong(1, curVal);\n-                    batch.setString(2, code);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(code)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNzY2MQ=="}, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2Mzg2MTM0OnYy", "diffSide": "RIGHT", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDo1OTowM1rOHwgnng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNToxMToxOVrOHwhMzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyODEyNg==", "bodyText": "Shouldn't this be\n   if (!values.containsKey(code))", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520628126", "createdAt": "2020-11-10T14:59:03Z", "author": {"login": "punktilious"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java", "diffHunk": "@@ -66,26 +82,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String resource = (String) valueEntry.getKey();\n-                    batch.setInt(1, curVal);\n-                    batch.setString(2, resource);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(resource)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMTgxMA==", "bodyText": "ack... how did this work locally... I'll fix this up", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520631810", "createdAt": "2020-11-10T15:03:49Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java", "diffHunk": "@@ -66,26 +82,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String resource = (String) valueEntry.getKey();\n-                    batch.setInt(1, curVal);\n-                    batch.setString(2, resource);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(resource)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyODEyNg=="}, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzNzY0Nw==", "bodyText": "Eagle Eyes again! thank you", "url": "https://github.com/IBM/FHIR/pull/1687#discussion_r520637647", "createdAt": "2020-11-10T15:11:19Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/PopulateResourceTypes.java", "diffHunk": "@@ -66,26 +82,34 @@ public void run(IDatabaseTranslator translator, Connection c) {\n                 Properties props = new Properties();\n                 props.load(fis);\n \n+                int numToProcess = 0;\n                 for (Entry<Object, Object> valueEntry : props.entrySet()) {\n                     Integer curVal = Integer.parseInt((String) valueEntry.getValue());\n                     String resource = (String) valueEntry.getKey();\n-                    batch.setInt(1, curVal);\n-                    batch.setString(2, resource);\n-                    batch.addBatch();\n-                }\n \n-                // Check Error Codes.\n-                int[] codes = batch.executeBatch();\n-                int errorCodes = 0;\n-                for (int code : codes) {\n-                    if (code < 0) {\n-                        errorCodes++;\n+                    if (values.containsKey(resource)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyODEyNg=="}, "originalCommit": {"oid": "32387a03fd17259da346bf0f1fa6b4efa8686e81"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4624, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}