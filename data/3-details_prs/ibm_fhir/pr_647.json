{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MjE1MTEw", "number": 647, "title": "issue #636 encrypt the internal Javabatch job id used in bulkdata apis", "bodyText": "Signed-off-by: Albert Wang xuwang@us.ibm.com", "createdAt": "2020-01-28T20:32:01Z", "url": "https://github.com/IBM/FHIR/pull/647", "merged": true, "mergeCommit": {"oid": "f92eef744c9189971d2c8adc758bdb729b742cd1"}, "closed": true, "closedAt": "2020-01-30T19:47:15Z", "author": {"login": "albertwang-ibm"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-3aIIgH2gAyMzY4MjE1MTEwOjEwOTc4ZDM0NmM4ODZkYTg0NmVjNjY5Y2U2NGQwNTRkOGM3NGNlNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_e6ZtAH2gAyMzY4MjE1MTEwOmI2NzY4ZDY5NzNiMWNlYTM0MmMwNGViMTEzZjZlOTM1ZTU2MTMyN2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "10978d346c886da846ec669ce64d054d8c74ce48", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/10978d346c886da846ec669ce64d054d8c74ce48", "committedDate": "2020-01-28T20:31:33Z", "message": "issue #636 initial code drop\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0b9c9e922028eb009f4c9f1327c06098ba9560c", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/f0b9c9e922028eb009f4c9f1327c06098ba9560c", "committedDate": "2020-01-28T20:45:11Z", "message": "issue #636 add the encryption key config to server.xml\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6443157ae46f102e45c99a6a99f8d24ec7a3efb", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/a6443157ae46f102e45c99a6a99f8d24ec7a3efb", "committedDate": "2020-01-28T20:59:44Z", "message": "issue #636 pom change\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/c4eda51617704a4f98a28ffc94b5a96ad88de6be", "committedDate": "2020-01-29T03:55:02Z", "message": "issue #636 refactor and add uni-test cases\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDQ2NzQ2", "url": "https://github.com/IBM/FHIR/pull/647#pullrequestreview-350446746", "createdAt": "2020-01-29T21:46:01Z", "commit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0NjowMlrOFjYoQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0NjowMlrOFjYoQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODAwMA==", "bodyText": "I think this should be removed.", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372648000", "createdAt": "2020-01-29T21:46:02Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/pom.xml", "diffHunk": "@@ -34,5 +34,10 @@\n             <artifactId>jsonassert</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>fhir-server</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDQ2OTk3", "url": "https://github.com/IBM/FHIR/pull/647#pullrequestreview-350446997", "createdAt": "2020-01-29T21:46:25Z", "commit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0NjoyNlrOFjYpBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0NjoyNlrOFjYpBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODE5Ng==", "bodyText": "Pull this value from the tenant configuration for bulkdata or pull from the property group.", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372648196", "createdAt": "2020-01-29T21:46:26Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/BulkDataConstants.java", "diffHunk": "@@ -31,6 +36,10 @@\n     public static final String PARAM_GROUP_ID = \"groupId\";\n     public static final String PARAM_JOB = \"job\";\n \n+    // Encryption key used for JavaBatch Job ID\n+    public static final SecretKeySpec BATCHJOBID_ENCRYPTION_KEY =\n+            BulkDataConfigUtil.getBatchJobIdEncryptionKey(FHIRServerUtils.getJNDIValue(\"config/bulkDataBatchJobIdEncryptionKey\", null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDQ3OTc2", "url": "https://github.com/IBM/FHIR/pull/647#pullrequestreview-350447976", "createdAt": "2020-01-29T21:48:06Z", "commit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0ODowNlrOFjYsGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0ODowNlrOFjYsGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODk4Nw==", "bodyText": "so it will default through to the normal job id?", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372648987", "createdAt": "2020-01-29T21:48:06Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataUtil.java", "diffHunk": "@@ -284,4 +287,37 @@ public static String checkAndValidateJob(Parameters parameters) throws FHIROpera\n \n         throw new FHIROperationException(\"no job identifier is passed\");\n     }\n+\n+\n+    public static String encryptBatchJobId(String strToEncrypt, SecretKeySpec key) {\n+        // Encrypt and UrlEncode the batch job id.\n+        if (key == null) {\n+            return strToEncrypt;\n+        } else {\n+            try\n+            {\n+                Cipher cp = Cipher.getInstance(\"AES/ECB/PKCS5Padding\");\n+                cp.init(Cipher.ENCRYPT_MODE, key);\n+                return java.net.URLEncoder.encode(Base64.getEncoder().encodeToString(cp.doFinal(strToEncrypt.getBytes(\"UTF-8\"))), StandardCharsets.UTF_8.name());\n+            } catch (Exception e) {\n+                return strToEncrypt;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDQ4NDAy", "url": "https://github.com/IBM/FHIR/pull/647#pullrequestreview-350448402", "createdAt": "2020-01-29T21:48:48Z", "commit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0ODo0OFrOFjYtdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0ODo0OFrOFjYtdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTMzMw==", "bodyText": "worthy of a comment", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372649333", "createdAt": "2020-01-29T21:48:48Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataUtil.java", "diffHunk": "@@ -284,4 +287,37 @@ public static String checkAndValidateJob(Parameters parameters) throws FHIROpera\n \n         throw new FHIROperationException(\"no job identifier is passed\");\n     }\n+\n+\n+    public static String encryptBatchJobId(String strToEncrypt, SecretKeySpec key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDQ4NTg2", "url": "https://github.com/IBM/FHIR/pull/647#pullrequestreview-350448586", "createdAt": "2020-01-29T21:49:06Z", "commit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0OTowN1rOFjYuFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0OTowN1rOFjYuFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0OTQ5NA==", "bodyText": "Worthy of a comment", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372649494", "createdAt": "2020-01-29T21:49:07Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataUtil.java", "diffHunk": "@@ -284,4 +287,37 @@ public static String checkAndValidateJob(Parameters parameters) throws FHIROpera\n \n         throw new FHIROperationException(\"no job identifier is passed\");\n     }\n+\n+\n+    public static String encryptBatchJobId(String strToEncrypt, SecretKeySpec key) {\n+        // Encrypt and UrlEncode the batch job id.\n+        if (key == null) {\n+            return strToEncrypt;\n+        } else {\n+            try\n+            {\n+                Cipher cp = Cipher.getInstance(\"AES/ECB/PKCS5Padding\");\n+                cp.init(Cipher.ENCRYPT_MODE, key);\n+                return java.net.URLEncoder.encode(Base64.getEncoder().encodeToString(cp.doFinal(strToEncrypt.getBytes(\"UTF-8\"))), StandardCharsets.UTF_8.name());\n+            } catch (Exception e) {\n+                return strToEncrypt;\n+            }\n+        }\n+    }\n+\n+    public static String decryptBatchJobId(String strToDecrypt, SecretKeySpec key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDQ5MzE3", "url": "https://github.com/IBM/FHIR/pull/647#pullrequestreview-350449317", "createdAt": "2020-01-29T21:50:22Z", "commit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo1MDoyMlrOFjYwgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo1MDoyMlrOFjYwgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDExNQ==", "bodyText": "is this the lightest weight cipher?  it doesn't need to be strong.", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372650115", "createdAt": "2020-01-29T21:50:22Z", "author": {"login": "prb112"}, "path": "fhir-operation-bulkdata/src/main/java/com/ibm/fhir/operation/bulkdata/util/BulkDataUtil.java", "diffHunk": "@@ -284,4 +287,37 @@ public static String checkAndValidateJob(Parameters parameters) throws FHIROpera\n \n         throw new FHIROperationException(\"no job identifier is passed\");\n     }\n+\n+\n+    public static String encryptBatchJobId(String strToEncrypt, SecretKeySpec key) {\n+        // Encrypt and UrlEncode the batch job id.\n+        if (key == null) {\n+            return strToEncrypt;\n+        } else {\n+            try\n+            {\n+                Cipher cp = Cipher.getInstance(\"AES/ECB/PKCS5Padding\");\n+                cp.init(Cipher.ENCRYPT_MODE, key);\n+                return java.net.URLEncoder.encode(Base64.getEncoder().encodeToString(cp.doFinal(strToEncrypt.getBytes(\"UTF-8\"))), StandardCharsets.UTF_8.name());\n+            } catch (Exception e) {\n+                return strToEncrypt;\n+            }\n+        }\n+    }\n+\n+    public static String decryptBatchJobId(String strToDecrypt, SecretKeySpec key) {\n+        // Decrypt to get the batch job id\n+        if (key == null) {\n+            return strToDecrypt;\n+        } else {\n+            try\n+            {\n+                Cipher cp = Cipher.getInstance(\"AES/ECB/PKCS5PADDING\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "originalPosition": 110}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDUwMjg1", "url": "https://github.com/IBM/FHIR/pull/647#pullrequestreview-350450285", "createdAt": "2020-01-29T21:52:02Z", "commit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo1MjowMlrOFjYzaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo1MjowMlrOFjYzaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDg1OQ==", "bodyText": "I think this should go into the properties file separate from JNDI", "url": "https://github.com/IBM/FHIR/pull/647#discussion_r372650859", "createdAt": "2020-01-29T21:52:02Z", "author": {"login": "prb112"}, "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -199,4 +199,7 @@\n         </application-bnd>\n     </webApplication>\n     <include optional=\"true\" location=\"${server.config.dir}/batchDs.xml\"/>\n+    \n+    <!-- The key used for encryption of the internal JavaBatch Job instance/execution id which is used in bulkdata APIs  -->\n+    <jndiEntry jndiName=\"config/bulkdatajobencryptionkey\" value=\"change-password\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eda51617704a4f98a28ffc94b5a96ad88de6be"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0d1ae1287df2d5810967cd7b6bec3b2498ec52d", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/c0d1ae1287df2d5810967cd7b6bec3b2498ec52d", "committedDate": "2020-01-30T18:08:54Z", "message": "issue #636 change to use fhir server config for the encryption key\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDQ2MTI3", "url": "https://github.com/IBM/FHIR/pull/647#pullrequestreview-351046127", "createdAt": "2020-01-30T18:30:14Z", "commit": {"oid": "c0d1ae1287df2d5810967cd7b6bec3b2498ec52d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6768d6973b1cea342c04eb113f6e935e561327c", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/b6768d6973b1cea342c04eb113f6e935e561327c", "committedDate": "2020-01-30T18:33:06Z", "message": "issue #636 minor format and comment changes\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 675, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}