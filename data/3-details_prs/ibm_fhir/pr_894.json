{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MjcwMjY1", "number": 894, "title": "issue #838 Add more metrics for bulkImport java Batch Job", "bodyText": "Added metrics for each resource type:\n(1) In-fly importing rate.\n(2) Processing times used for reading from data source and writing to target DB.\n(3) Total resource size and average resource size.\n(4) Validation time.\nSigned-off-by: Albert Wang xuwang@us.ibm.com", "createdAt": "2020-04-03T16:29:05Z", "url": "https://github.com/IBM/FHIR/pull/894", "merged": true, "mergeCommit": {"oid": "82d420d0c6820b225336535d22f0bdcf4b21b2c7"}, "closed": true, "closedAt": "2020-04-06T20:33:21Z", "author": {"login": "albertwang-ibm"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUDbNQAH2gAyMzk4MjcwMjY1OmZlMTE5ODMyYzlmM2E1ODJkNDI2MDg4ZjU5MDI3MzYyNzYyODRmYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVEE3zAH2gAyMzk4MjcwMjY1OjQxMDRjZDRkYTVkZDkxZmFhOGY0ZDZiYTZmNGQxNWYxNWYwNTY2MGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe119832c9f3a582d426088f5902736276284fc6", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/fe119832c9f3a582d426088f5902736276284fc6", "committedDate": "2020-04-03T16:24:00Z", "message": "issue #838 Add more metrics for bulkImport java Batch Job\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc16bae641d7da58ce6549b1e5c79639b12f6c4a", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/dc16bae641d7da58ce6549b1e5c79639b12f6c4a", "committedDate": "2020-04-03T18:13:33Z", "message": "issue #838 fix the incorrect first in-fly import rate\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b95b5c23bd99ae9590444188979eb5b5b358447c", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/b95b5c23bd99ae9590444188979eb5b5b358447c", "committedDate": "2020-04-03T23:51:53Z", "message": "issue #838 reduce the number of System.CurrentMillis calls\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c407a3f57cf3160ffa6cf26f5e9b291ea28502ff", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/c407a3f57cf3160ffa6cf26f5e9b291ea28502ff", "committedDate": "2020-04-06T16:34:54Z", "message": "Merge pull request #898 from IBM/issue-838\n\nIssue 838"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTIxODQ2", "url": "https://github.com/IBM/FHIR/pull/894#pullrequestreview-388521846", "createdAt": "2020-04-06T18:44:27Z", "commit": {"oid": "c407a3f57cf3160ffa6cf26f5e9b291ea28502ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo0NDoyN1rOGBlItQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo0NDoyN1rOGBlItQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMDE5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static long getLocallFileSize(String filePath) throws Exception {\n          \n          \n            \n                public static long getLocalFileSize(String filePath) throws Exception {", "url": "https://github.com/IBM/FHIR/pull/894#discussion_r404310197", "createdAt": "2020-04-06T18:44:27Z", "author": {"login": "lmsurpre"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/BulkDataUtils.java", "diffHunk": "@@ -288,6 +297,11 @@ public static int readFhirResourceFromLocalFile(String filePath, int numOfLinesT\n     }\n \n \n+    public static long getLocallFileSize(String filePath) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c407a3f57cf3160ffa6cf26f5e9b291ea28502ff"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTI2MzE3", "url": "https://github.com/IBM/FHIR/pull/894#pullrequestreview-388526317", "createdAt": "2020-04-06T18:50:35Z", "commit": {"oid": "c407a3f57cf3160ffa6cf26f5e9b291ea28502ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo1MDozNVrOGBlWtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo1MDozNVrOGBlWtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMzc4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new Exception (\"Doesn't support data source storage type!\");\n          \n          \n            \n                            throw new Exception(\"Doesn't support data source storage type!\");", "url": "https://github.com/IBM/FHIR/pull/894#discussion_r404313782", "createdAt": "2020-04-06T18:50:35Z", "author": {"login": "lmsurpre"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ChunkReader.java", "diffHunk": "@@ -167,12 +152,46 @@ public Object readItem() throws Exception {\n \n     @Override\n     public void open(Serializable checkpoint) throws Exception {\n+        if (BulkImportDataSourceStorageType.from(dataSourceStorageType).equals(BulkImportDataSourceStorageType.AWSS3)\n+                || BulkImportDataSourceStorageType.from(dataSourceStorageType).equals(BulkImportDataSourceStorageType.IBMCOS)) {\n+            cosClient = BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKeyProperty, cosSrvinstId, cosEndpintUrl, cosLocation);\n+            if (cosClient == null) {\n+                logger.warning(\"open: Failed to get CosClient!\");\n+                throw new Exception(\"Failed to get CosClient!!\");\n+            } else {\n+                logger.finer(\"open: Got CosClient successfully!\");\n+            }\n+        }\n+\n         if (checkpoint != null) {\n             ImportCheckPointData checkPointData = (ImportCheckPointData) checkpoint;\n             importPartitionWorkitem = checkPointData.getImportPartitionWorkitem();\n             numOfLinesToSkip = checkPointData.getNumOfProcessedResources();\n+            checkPointData.setInFlyRateBeginMilliSeconds(System.currentTimeMillis());\n             stepCtx.setTransientUserData(ImportTransientUserData.fromImportCheckPointData(checkPointData));\n+        } else {\n+            ImportTransientUserData chunkData = new ImportTransientUserData(importPartitionWorkitem, numOfLinesToSkip, importPartitionResourceType);\n+            long importFileSize = 0;\n+            switch (BulkImportDataSourceStorageType.from(dataSourceStorageType)) {\n+            case HTTPS:\n+                importFileSize = BulkDataUtils.getHttpsFileSize(importPartitionWorkitem);\n+                break;\n+            case FILE:\n+                importFileSize = BulkDataUtils.getLocallFileSize(importPartitionWorkitem);\n+                break;\n+            case AWSS3:\n+            case IBMCOS:\n+                importFileSize = BulkDataUtils.getCosFileSize(cosClient, cosBucketName, importPartitionWorkitem);\n+                break;\n+            default:\n+                throw new Exception (\"Doesn't support data source storage type!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c407a3f57cf3160ffa6cf26f5e9b291ea28502ff"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTM3NzY4", "url": "https://github.com/IBM/FHIR/pull/894#pullrequestreview-388537768", "createdAt": "2020-04-06T19:06:55Z", "commit": {"oid": "c407a3f57cf3160ffa6cf26f5e9b291ea28502ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4104cd4da5dd91faa8f4d6ba6f4d15f15f05660b", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/4104cd4da5dd91faa8f4d6ba6f4d15f15f05660b", "committedDate": "2020-04-06T19:43:26Z", "message": "issue #838 minor updates per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 580, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}