{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MjI2NDUx", "number": 1066, "title": "Upon Second Schema deployment, VersionHistoryService reports error", "bodyText": "the update-schema is stopped. #1065\nSigned-off-by: Paul Bastide pbastide@us.ibm.com", "createdAt": "2020-05-11T16:59:29Z", "url": "https://github.com/IBM/FHIR/pull/1066", "merged": true, "mergeCommit": {"oid": "82e3a13c74bf627fb55d7755c5ad158df8c1d84a"}, "closed": true, "closedAt": "2020-05-11T19:31:11Z", "author": {"login": "prb112"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgSswRAH2gAyNDE2MjI2NDUxOjcwODhmNWU3YWI5YTlkNTMxYWYzZmE4MTlhYzY3YmRhNmQ3YjJhM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgT74uAH2gAyNDE2MjI2NDUxOjA0YjBkNTdhNTJmYjJiOWY4M2M5ZWJlZTA5YjY0NWUxN2ZiNTkxMmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7088f5e7ab9a9d531af3fa819ac67bda6d7b2a3b", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/7088f5e7ab9a9d531af3fa819ac67bda6d7b2a3b", "committedDate": "2020-05-11T16:58:50Z", "message": "Upon Second Schema deployment, VersionHistoryService reports error and\nthe update-schema is stopped. #1065\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MzY2Mjk2", "url": "https://github.com/IBM/FHIR/pull/1066#pullrequestreview-409366296", "createdAt": "2020-05-11T17:10:54Z", "commit": {"oid": "7088f5e7ab9a9d531af3fa819ac67bda6d7b2a3b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ab183454b1158267934b144b57278b610f27d45", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/4ab183454b1158267934b144b57278b610f27d45", "committedDate": "2020-05-11T17:16:51Z", "message": "Cleanup needless semicolon\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MzczODkx", "url": "https://github.com/IBM/FHIR/pull/1066#pullrequestreview-409373891", "createdAt": "2020-05-11T17:20:54Z", "commit": {"oid": "4ab183454b1158267934b144b57278b610f27d45"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNzoyMDo1NFrOGTl5GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNzoyMDo1NFrOGTl5GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5Njk1Mw==", "bodyText": "DB2 SQL Error: SQLCODE=-104, SQLSTATE=42601, SQLERRMC=;;enant_salt || ?, 2));END-OF-STATEMENT\nPossibly double end of statement problem? maybe only occurs on Windows versus Mac?", "url": "https://github.com/IBM/FHIR/pull/1066#discussion_r423196953", "createdAt": "2020-05-11T17:20:54Z", "author": {"login": "prb112"}, "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -893,7 +893,7 @@ protected void checkIfTenantNameAndTenantKeyExists(Db2Adapter adapter, String te\n                 final String sql =\n                         \"SELECT t.tenant_status FROM fhir_admin.tenants t WHERE t.tenant_name = ? \"\n                                 + \"AND EXISTS (SELECT 1 FROM fhir_admin.tenant_keys tk WHERE tk.mt_id = t.mt_id \"\n-                                + \"AND tk.tenant_hash = sysibm.hash(tk.tenant_salt || ?, 2));\";\n+                                + \"AND tk.tenant_hash = sysibm.hash(tk.tenant_salt || ?, 2))\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ab183454b1158267934b144b57278b610f27d45"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbf63b0cea6ec3f28ce2345f17db7c4486160f2c", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/cbf63b0cea6ec3f28ce2345f17db7c4486160f2c", "committedDate": "2020-05-11T18:15:52Z", "message": "Fix for newDb logic\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NDE1OTkw", "url": "https://github.com/IBM/FHIR/pull/1066#pullrequestreview-409415990", "createdAt": "2020-05-11T18:18:46Z", "commit": {"oid": "cbf63b0cea6ec3f28ce2345f17db7c4486160f2c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NDE3MDcy", "url": "https://github.com/IBM/FHIR/pull/1066#pullrequestreview-409417072", "createdAt": "2020-05-11T18:20:19Z", "commit": {"oid": "cbf63b0cea6ec3f28ce2345f17db7c4486160f2c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxODoyMDoyMFrOGTn9Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxODoyMDoyMFrOGTn9Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIzMDgxOQ==", "bodyText": "should it be newDb = (x == null || x == 0)?", "url": "https://github.com/IBM/FHIR/pull/1066#discussion_r423230819", "createdAt": "2020-05-11T18:20:20Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/DerbyBootstrapper.java", "diffHunk": "@@ -111,12 +111,12 @@ public static void bootstrap(Connection connection, String adminSchemaName, Stri\n         // Current version history for the database. This is used by applyWithHistory\n         // to determine which updates to apply and to record the new changes as they\n         // are applied\n-        VersionHistoryService vhs = new VersionHistoryService(adminSchemaName, dataSchemaName);\n+        VersionHistoryService vhs = new VersionHistoryService(adminSchemaName, dataSchemaName, OAUTH_SCHEMANAME);\n         vhs.setTarget(adapter);\n         vhs.init();\n \n         // Use the version history service to determine if this table existed before we run `applyWithHistory`\n-        boolean newDb = vhs.getVersion(dataSchemaName, DatabaseObjectType.TABLE.name(), \"PARAMETER_NAMES\") == null;\n+        boolean newDb = vhs.getVersion(dataSchemaName, DatabaseObjectType.TABLE.name(), \"PARAMETER_NAMES\") == 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf63b0cea6ec3f28ce2345f17db7c4486160f2c"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04b0d57a52fb2b9f83c9ebee09b645e17fb5912d", "author": {"user": {"login": "prb112", "name": "Paul Bastide"}}, "url": "https://github.com/IBM/FHIR/commit/04b0d57a52fb2b9f83c9ebee09b645e17fb5912d", "committedDate": "2020-05-11T18:25:16Z", "message": "Fix for newDb logic\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 459, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}