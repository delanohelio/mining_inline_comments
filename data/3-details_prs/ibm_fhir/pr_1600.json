{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MzEyMDM5", "number": 1600, "title": "issue #1351 - Check _include and _revinclude values are supported", "bodyText": "Update the supported _include values, _revinclude values, and search parameter combinations to be configurable.\nSigned-off-by: Troy Biesterfeld tbieste@us.ibm.com", "createdAt": "2020-10-19T22:16:52Z", "url": "https://github.com/IBM/FHIR/pull/1600", "merged": true, "mergeCommit": {"oid": "d8212bc9a4921bb8c14e698674aee37ff0ca1c70"}, "closed": true, "closedAt": "2020-10-27T12:18:17Z", "author": {"login": "tbieste"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUNyLvAFqTUxMjI1MjM4NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWn9MBAFqTUxNzYzODUyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjUyMzg0", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-512252384", "createdAt": "2020-10-20T00:39:18Z", "commit": {"oid": "63e78559f16727905e6a82acdd42cf80a5f808e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozOToxOFrOHkmckw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozOToxOFrOHkmckw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDY5MQ==", "bodyText": "We probably don't want to recompute this every time, is there a look aside map or structure we could use?\nOr should we cache this for the whole system on startup?", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r508140691", "createdAt": "2020-10-20T00:39:18Z", "author": {"login": "prb112"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -1623,6 +1644,96 @@ private static void parseInclusionParameter(Class<?> resourceType, FHIRSearchCon\n         }\n     }\n \n+    /**\n+     * Retrieves the search include restrictions.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @return list of allowed search _include values, or null if no restrictions\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static List<String> getSearchIncludeRestrictions(String resourceType) throws Exception {\n+\n+        // Retrieve the \"resources\" config property group.\n+        PropertyGroup rsrcsGroup = FHIRConfigHelper.getPropertyGroup(FHIRConfiguration.PROPERTY_RESOURCES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e78559f16727905e6a82acdd42cf80a5f808e6"}, "originalPosition": 192}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34413f3941debdb0ed5841feb51d942c964d4cff", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/34413f3941debdb0ed5841feb51d942c964d4cff", "committedDate": "2020-10-20T16:56:03Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}, "afterCommit": {"oid": "eb4e6820320a83911999acfc18897850bbdd7acd", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/eb4e6820320a83911999acfc18897850bbdd7acd", "committedDate": "2020-10-20T16:57:03Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb4e6820320a83911999acfc18897850bbdd7acd", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/eb4e6820320a83911999acfc18897850bbdd7acd", "committedDate": "2020-10-20T16:57:03Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}, "afterCommit": {"oid": "0e4843cf6b21039562b3e605ba8588f62efa920b", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/0e4843cf6b21039562b3e605ba8588f62efa920b", "committedDate": "2020-10-20T17:40:08Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e4843cf6b21039562b3e605ba8588f62efa920b", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/0e4843cf6b21039562b3e605ba8588f62efa920b", "committedDate": "2020-10-20T17:40:08Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}, "afterCommit": {"oid": "f874f1a9e0c166673b9cd9b65a1869ba155af713", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/f874f1a9e0c166673b9cd9b65a1869ba155af713", "committedDate": "2020-10-20T17:59:54Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f874f1a9e0c166673b9cd9b65a1869ba155af713", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/f874f1a9e0c166673b9cd9b65a1869ba155af713", "committedDate": "2020-10-20T17:59:54Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}, "afterCommit": {"oid": "6b73eb36016dcb19a8b3c2c113d5790fb7f4c029", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/6b73eb36016dcb19a8b3c2c113d5790fb7f4c029", "committedDate": "2020-10-20T18:59:37Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b73eb36016dcb19a8b3c2c113d5790fb7f4c029", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/6b73eb36016dcb19a8b3c2c113d5790fb7f4c029", "committedDate": "2020-10-20T18:59:37Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}, "afterCommit": {"oid": "ef5bbbf16b26b831bf750f560a311ea9a5bd92d0", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/ef5bbbf16b26b831bf750f560a311ea9a5bd92d0", "committedDate": "2020-10-20T19:26:44Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef5bbbf16b26b831bf750f560a311ea9a5bd92d0", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/ef5bbbf16b26b831bf750f560a311ea9a5bd92d0", "committedDate": "2020-10-20T19:26:44Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}, "afterCommit": {"oid": "77a0bfdde26fd87edc7a434c8d792f24862741e2", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/77a0bfdde26fd87edc7a434c8d792f24862741e2", "committedDate": "2020-10-20T19:38:00Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77a0bfdde26fd87edc7a434c8d792f24862741e2", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/77a0bfdde26fd87edc7a434c8d792f24862741e2", "committedDate": "2020-10-20T19:38:00Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}, "afterCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/d88baae89897ed6d2009019236960b69d92f2702", "committedDate": "2020-10-20T20:27:55Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODAxNDE4", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516801418", "createdAt": "2020-10-26T13:56:47Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODEyMTg4", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516812188", "createdAt": "2020-10-26T14:07:31Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowNzozMVrOHoRLMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowNzozMVrOHoRLMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NjQ4MA==", "bodyText": "What do the \\ do or reference?", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511986480", "createdAt": "2020-10-26T14:07:31Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1604,9 +1610,15 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/resources/open`|true|\n |`fhirServer/resources/Resource/interactions`|null (all interactions supported)|\n |`fhirServer/resources/Resource/searchParameters`|null (all global search parameters supported)|\n+|`fhirServer/resources/Resource/searchIncludes`|null (all \\_include values supported)|\n+|`fhirServer/resources/Resource/searchRevIncludes`|null (all \\_revinclude values supported)|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODEyNDgw", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516812480", "createdAt": "2020-10-26T14:07:50Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowNzo1MFrOHoRMDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowNzo1MFrOHoRMDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NjcwMw==", "bodyText": "same question as 1613,1614", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511986703", "createdAt": "2020-10-26T14:07:50Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1520,9 +1520,15 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/resources/Resource/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) supported for resource types. Omitting this property is equivalent to supporting all FHIR interactions for the supported resources. An empty list, `[]`, can be used to indicate that no REST methods are supported. This property can be overridden for specific resource types via the `fhirServer/resources/<resourceType>/interactions` property.|\n |`fhirServer/resources/Resource/searchParameters`|object|The set of search parameters to support for all supported resource types. Omitting this property is equivalent to supporting all search parameters in the server's registry that apply to resource type \"Resource\" (all resources). An empty object, `{}`, can be used to indicate that no global search parameters are supported.|\n |`fhirServer/resources/Resource/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>`. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameters/<code>`|\n+|`fhirServer/resources/Resource/searchIncludes`|string list|A comma-separated list of \\_include values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchIncludes`. Omitting this property is equivalent to supporting all \\_include values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_include values are supported.|\n+|`fhirServer/resources/Resource/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchRevIncludes`. Omitting this property is equivalent to supporting all \\_revinclude values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported.|\n+|`fhirServer/resources/Resource/searchParameterCombinations`|string list|A comma-separated list of search parameter combinations supported for all resource types. Each search parameter combination is a string, where a plus sign, `+`, separates the search parameters that can be used in combination. To indicate that searching without any search parameters is allowed, an empty string must be included in the list. Including an asterisk, `*`, in the list indicates support of any search parameter combination. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameterCombinations`. Omitting this property is equivalent to supporting any search parameter combination.|\n |`fhirServer/resources/<resourceType>/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) to support for this resource type. For resources without the property, the value of `fhirServer/resources/Resource/interactions` is used.|\n |`fhirServer/resources/<resourceType>/searchParameters`|object|The set of search parameters to support for this resource type. Global search parameters defined on the `Resource` resource can be overridden on a per-resourceType basis.|\n |`fhirServer/resources/<resourceType>/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>` on resources of type `<resourceType>`.|\n+|`fhirServer/resources/<resourceType>/searchIncludes`|string list|A comma-separated list of \\_include values supported for this resource type. An empty list, `[]`, can be used to indicate that no \\_include values are supported. For resources without the property, the value of `fhirServer/resources/Resource/searchIncludes` is used.|\n+|`fhirServer/resources/<resourceType>/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for this resource type. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported. For resources without the property, the value of `fhirServer/resources/Resource/searchRevIncludes` is used.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODEzMDM5", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516813039", "createdAt": "2020-10-26T14:08:25Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowODoyNVrOHoRNsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowODoyNVrOHoRNsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NzEyMw==", "bodyText": "Same question as 1613,1614", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511987123", "createdAt": "2020-10-26T14:08:25Z", "author": {"login": "prb112"}, "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1520,9 +1520,15 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/resources/Resource/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) supported for resource types. Omitting this property is equivalent to supporting all FHIR interactions for the supported resources. An empty list, `[]`, can be used to indicate that no REST methods are supported. This property can be overridden for specific resource types via the `fhirServer/resources/<resourceType>/interactions` property.|\n |`fhirServer/resources/Resource/searchParameters`|object|The set of search parameters to support for all supported resource types. Omitting this property is equivalent to supporting all search parameters in the server's registry that apply to resource type \"Resource\" (all resources). An empty object, `{}`, can be used to indicate that no global search parameters are supported.|\n |`fhirServer/resources/Resource/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>`. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameters/<code>`|\n+|`fhirServer/resources/Resource/searchIncludes`|string list|A comma-separated list of \\_include values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchIncludes`. Omitting this property is equivalent to supporting all \\_include values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_include values are supported.|\n+|`fhirServer/resources/Resource/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchRevIncludes`. Omitting this property is equivalent to supporting all \\_revinclude values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODEzNzgx", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516813781", "createdAt": "2020-10-26T14:09:07Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowOTowN1rOHoRPzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowOTowN1rOHoRPzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NzY2MQ==", "bodyText": "Please update the copywrite year.", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511987661", "createdAt": "2020-10-26T14:09:07Z", "author": {"login": "prb112"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/exception/SearchExceptionUtil.java", "diffHunk": "@@ -18,16 +18,17 @@\n     private static final String ILLEGAL_EXCEPTION = \"SearchParameter filter property values must be an array of String.\";\n     private static final String ILLEGAL_ARGUMENT_EXCEPTION = \"No constant with value '%s' found.\";\n     private static final String PARSE_PARAMETER_EXCEPTION = \"An error occurred while parsing parameter '%s'.\";\n+    private static final String PARSE_PARAMETERS_EXCEPTION = \"An error occurred while parsing parameters.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODE0NjIy", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516814622", "createdAt": "2020-10-26T14:09:56Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowOTo1NlrOHoRSSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDowOTo1NlrOHoRSSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4ODI5OA==", "bodyText": "Can we pack in some additional detail in the exception?  e.g. what's the invalid combo?", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511988298", "createdAt": "2020-10-26T14:09:56Z", "author": {"login": "prb112"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -816,6 +820,16 @@ public static FHIRSearchContext parseQueryParameters(Class<?> resourceType,\n             }\n         } // end for\n \n+        try {\n+            // Check for valid search parameter combinations\n+            checkSearchParameterCombinations(resourceType, parameters);\n+\n+        } catch (FHIRSearchException se) {\n+            throw se;\n+        } catch (Exception e) {\n+            throw SearchExceptionUtil.buildNewParseParametersException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODIyMDMx", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516822031", "createdAt": "2020-10-26T14:17:19Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoxNzoxOVrOHoRnjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoxNzoxOVrOHoRnjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5Mzc0Mw==", "bodyText": "Line 20,21 are almost identical, I'd consider pumping in more information in this OperationOutcome so that it's more specific to the failing reason.", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511993743", "createdAt": "2020-10-26T14:17:19Z", "author": {"login": "prb112"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/exception/SearchExceptionUtil.java", "diffHunk": "@@ -49,9 +50,22 @@ public static FHIRSearchException buildNewParseParameterException(final String n\n         return new FHIRSearchException(msg, e).withIssue(ooi);\n     }\n \n+    /**\n+     * creates a new parse parameters exception\n+     *\n+     * @param name\n+     * @param e\n+     * @return\n+     */\n+    public static FHIRSearchException buildNewParseParametersException(Exception e) {\n+        String msg = String.format(PARSE_PARAMETERS_EXCEPTION);\n+        OperationOutcome.Issue ooi = FHIRUtil.buildOperationOutcomeIssue(msg, IssueType.INVALID);\n+        return new FHIRSearchException(msg, e).withIssue(ooi);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODI4MDYy", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516828062", "createdAt": "2020-10-26T14:23:25Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoyMzoyNVrOHoR5eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoyMzoyNVrOHoR5eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5ODMyOQ==", "bodyText": "I think we should be proactive here, and only accept the trimmed codes/combinations.", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511998329", "createdAt": "2020-10-26T14:23:25Z", "author": {"login": "prb112"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -902,6 +916,109 @@ private static void checkSearchParameterRestrictions(String parameterCode, Searc\n         }\n     }\n \n+    /**\n+     * Checks that the combination of search parameters is valid.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @param parameters\n+     *            the query parameters to check\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static void checkSearchParameterCombinations(Class<?> resourceType, List<QueryParameter> parameters)\n+        throws Exception {\n+\n+        List<Set<String>> validCombinations = getSearchParameterCombinations(resourceType.getSimpleName());\n+        if (validCombinations != null) {\n+            Set<String> searchParameterCodes = parameters.stream().map(qp -> qp.getCode()).collect(Collectors.toSet());\n+\n+            // Check that search parameter codes are a valid combinations\n+            if (!validCombinations.contains(searchParameterCodes)) {\n+                String msg;\n+                if (searchParameterCodes.isEmpty()) {\n+                    msg = \"A valid search parameter combination is required\";\n+                } else {\n+                    msg = \"Search parameter combination is not valid\";\n+                }\n+                throw SearchExceptionUtil.buildNewInvalidSearchException(msg);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Retrieves the search parameter combinations.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @return list of allowed search parameter combinations, or null if any search parameter combination is allowed\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static List<Set<String>> getSearchParameterCombinations(String resourceType) throws Exception {\n+\n+        List<Set<String>> spCombinations = null;\n+\n+        // Retrieve the \"resources\" config property group.\n+        PropertyGroup rsrcsGroup = FHIRConfigHelper.getPropertyGroup(FHIRConfiguration.PROPERTY_RESOURCES);\n+        if (rsrcsGroup != null) {\n+            List<PropertyEntry> rsrcsEntries = rsrcsGroup.getProperties();\n+            if (rsrcsEntries != null && !rsrcsEntries.isEmpty()) {\n+                List<String> combinations = null;\n+\n+                // Try to find search parameter combinations property for matching resource type\n+                for (PropertyEntry rsrcsEntry : rsrcsEntries) {\n+                    if (resourceType.equals(rsrcsEntry.getName())) {\n+                        PropertyGroup resourceTypeGroup = (PropertyGroup) rsrcsEntry.getValue();\n+                        if (resourceTypeGroup != null) {\n+                            combinations = resourceTypeGroup.getStringListProperty(FHIRConfiguration.PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_COMBINATIONS);\n+                            break;\n+                        }\n+                    }\n+                }\n+\n+                // Otherwise, try to find search parameter combinations property for \"Resource\" resource type\n+                if (combinations == null) {\n+                    for (PropertyEntry rsrcsEntry : rsrcsEntries) {\n+\n+                        // Check if matching resource type\n+                        if (SearchConstants.RESOURCE_RESOURCE.equals(rsrcsEntry.getName())) {\n+                            PropertyGroup resourceTypeGroup = (PropertyGroup) rsrcsEntry.getValue();\n+                            if (resourceTypeGroup != null) {\n+                                combinations =\n+                                        resourceTypeGroup.getStringListProperty(FHIRConfiguration.PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_COMBINATIONS);\n+                                break;\n+                            }\n+                        }\n+                    }\n+                }\n+\n+                // Convert the delimited combinations to a list of sets\n+                if (combinations != null) {\n+                    spCombinations = new ArrayList<>();\n+                    for (String combination : combinations) {\n+                        Set<String> combinationSet = new HashSet<>();\n+                        if (!combination.isEmpty()) {\n+                            // If any search parameter combination is allowed, return null\n+                            if (SEARCH_PARAM_COMBINATION_ANY.equals(combination)) {\n+                                return null;\n+                            }\n+                            for (String spString : combination.split(SEARCH_PARAM_COMBINATION_DELIMITER)) {\n+                                if (spString.trim().isEmpty()) {\n+                                    throw SearchExceptionUtil.buildNewIllegalStateException();\n+                                }\n+                                combinationSet.add(spString);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 123}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "493e9b810b7cf49e12ed87c63a4c3fe6d4191f17", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/493e9b810b7cf49e12ed87c63a4c3fe6d4191f17", "committedDate": "2020-10-26T14:26:37Z", "message": "issue #1351 - Check _include and _revinclude values are supported\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1feaa611ff458a258d6f8bd66fea3b90bc526c80", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/1feaa611ff458a258d6f8bd66fea3b90bc526c80", "committedDate": "2020-10-26T14:26:39Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODMyNDM2", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516832436", "createdAt": "2020-10-26T14:27:34Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoyNzozNFrOHoSGmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoyNzozNFrOHoSGmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwMTY5MQ==", "bodyText": "Please refactor this method and the prior into one processing logic method, and a new signature, resourceType, String propertyType, and leave the existing methods only pointing to the one logic method.", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512001691", "createdAt": "2020-10-26T14:27:34Z", "author": {"login": "prb112"}, "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -1612,6 +1750,95 @@ private static void parseInclusionParameter(Class<?> resourceType, FHIRSearchCon\n         }\n     }\n \n+    /**\n+     * Retrieves the search include restrictions.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @return list of allowed search _include values, or null if no restrictions\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static List<String> getSearchIncludeRestrictions(String resourceType) throws Exception {\n+\n+        // Retrieve the \"resources\" config property group.\n+        PropertyGroup rsrcsGroup = FHIRConfigHelper.getPropertyGroup(FHIRConfiguration.PROPERTY_RESOURCES);\n+        if (rsrcsGroup != null) {\n+            List<PropertyEntry> rsrcsEntries = rsrcsGroup.getProperties();\n+            if (rsrcsEntries != null && !rsrcsEntries.isEmpty()) {\n+\n+                // Try to find search includes property for matching resource type\n+                for (PropertyEntry rsrcsEntry : rsrcsEntries) {\n+                    if (resourceType.equals(rsrcsEntry.getName())) {\n+                        PropertyGroup resourceTypeGroup = (PropertyGroup) rsrcsEntry.getValue();\n+                        if (resourceTypeGroup != null) {\n+                            return resourceTypeGroup.getStringListProperty(FHIRConfiguration.PROPERTY_FIELD_RESOURCES_SEARCH_INCLUDES);\n+                        }\n+                    }\n+                }\n+\n+                // Otherwise, try to find search includes property for \"Resource\" resource type\n+                for (PropertyEntry rsrcsEntry : rsrcsEntries) {\n+\n+                    // Check if matching resource type\n+                    if (SearchConstants.RESOURCE_RESOURCE.equals(rsrcsEntry.getName())) {\n+                        PropertyGroup resourceTypeGroup = (PropertyGroup) rsrcsEntry.getValue();\n+                        if (resourceTypeGroup != null) {\n+                            return resourceTypeGroup.getStringListProperty(FHIRConfiguration.PROPERTY_FIELD_RESOURCES_SEARCH_INCLUDES);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+        return null;\n+    }\n+\n+    /**\n+     * Retrieves the search revinclude restrictions.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @return list of allowed search _revinclude values, or null if no restrictions\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static List<String> getSearchRevIncludeRestrictions(String resourceType) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 268}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODMzNDc5", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-516833479", "createdAt": "2020-10-26T14:28:30Z", "commit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoyODozMFrOHoSJWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoyODozMFrOHoSJWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwMjM5Mw==", "bodyText": "Change the copyright year to 2020 only", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512002393", "createdAt": "2020-10-26T14:28:30Z", "author": {"login": "prb112"}, "path": "fhir-search/src/test/java/com/ibm/fhir/search/parameters/SearchParameterRestrictionTest.java", "diffHunk": "@@ -17,7 +17,14 @@\n \n import com.ibm.fhir.config.FHIRConfiguration;\n import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.resource.CarePlan;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7d91922ad38010b186f25222580fd3cbf39e11a", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/c7d91922ad38010b186f25222580fd3cbf39e11a", "committedDate": "2020-10-26T16:49:56Z", "message": "issue #1351 - Updates after code review\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d88baae89897ed6d2009019236960b69d92f2702", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/d88baae89897ed6d2009019236960b69d92f2702", "committedDate": "2020-10-20T20:27:55Z", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}, "afterCommit": {"oid": "c7d91922ad38010b186f25222580fd3cbf39e11a", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/c7d91922ad38010b186f25222580fd3cbf39e11a", "committedDate": "2020-10-26T16:49:56Z", "message": "issue #1351 - Updates after code review\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d005cfdac608192393f8368861de2c7a47e977d", "author": {"user": {"login": "tbieste", "name": "Troy Biesterfeld"}}, "url": "https://github.com/IBM/FHIR/commit/6d005cfdac608192393f8368861de2c7a47e977d", "committedDate": "2020-10-26T19:37:27Z", "message": "issue #1351 - Add searchInclude and searchRevInclude to capabilities\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTYzODg4", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-517163888", "createdAt": "2020-10-26T20:49:18Z", "commit": {"oid": "6d005cfdac608192393f8368861de2c7a47e977d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NjM4NTIw", "url": "https://github.com/IBM/FHIR/pull/1600#pullrequestreview-517638520", "createdAt": "2020-10-27T12:16:42Z", "commit": {"oid": "6d005cfdac608192393f8368861de2c7a47e977d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 898, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}