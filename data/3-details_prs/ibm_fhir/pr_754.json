{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMjM4NTY1", "number": 754, "title": "issue #749 #755 FHIR transaction inside JavaBatch and fix for large COS file imports", "bodyText": "Signed-off-by: Albert Wang xuwang@us.ibm.com", "createdAt": "2020-03-03T22:59:50Z", "url": "https://github.com/IBM/FHIR/pull/754", "merged": true, "mergeCommit": {"oid": "9d18f0ae8cd4a20f4882cb701c6ec6a63642f0c5"}, "closed": true, "closedAt": "2020-03-04T21:44:56Z", "author": {"login": "albertwang-ibm"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKKf4gAH2gAyMzgzMjM4NTY1OjMyYzc4MjBhZTA5ZTQ3YTI3Y2RhMzgyODQyZmQxOWRiNzUzMzEwYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKdzR7gFqTM2OTEzNjA4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32c7820ae09e47a27cda382842fd19db753310a7", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/32c7820ae09e47a27cda382842fd19db753310a7", "committedDate": "2020-03-03T22:59:12Z", "message": "issue #749 FHIR transaction inside JavaBatch\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf1d5aa9e2b7bed4c3d22323a643d34f1d4c3b6a", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/cf1d5aa9e2b7bed4c3d22323a643d34f1d4c3b6a", "committedDate": "2020-03-03T23:03:58Z", "message": "Merge branch 'master' into Albert-Master-New"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da76dea4dd80bcca2cac7f92a5c6d61382feafa5", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/da76dea4dd80bcca2cac7f92a5c6d61382feafa5", "committedDate": "2020-03-03T23:09:57Z", "message": "issue #749 remove debugging messages\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89da29594063a30129fef85002845a4f1934f20c", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/89da29594063a30129fef85002845a4f1934f20c", "committedDate": "2020-03-04T03:19:52Z", "message": "issue #755 fix for importing large COS file\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/72c43c512b21bc20c8044ddd86b6756a82308f5c", "committedDate": "2020-03-04T03:23:21Z", "message": "Merge branch 'Albert-Master-New' of git@github.com:IBM/FHIR.git into Albert-Master-New"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzU5NDAw", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368759400", "createdAt": "2020-03-04T13:05:27Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzowNToyN1rOFxsctQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzowNToyN1rOFxsctQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1Mjc4OQ==", "bodyText": "This should be changed so the logic is expressed as part of the loops condition.\nConvert to a do-while if necessary...\nAlso - FYI - https://wiki.sei.cmu.edu/confluence/display/java/MSC01-J.+Do+not+use+an+empty+infinite+loop\nit's something to avoid", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387652789", "createdAt": "2020-03-04T13:05:27Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/BulkDataUtils.java", "diffHunk": "@@ -137,7 +137,7 @@ public static void listBuckets(AmazonS3 cosClient) {\n     private static int getFhirResourceFromBufferReader(BufferedReader resReader, int numOfLinesToSkip, List<Resource> fhirResources) throws Exception {\n         int exported = 0;\n         int lineRed = 0;\n-        while (resReader.ready()) {\n+        while (true) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzYwNTky", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368760592", "createdAt": "2020-03-04T13:07:24Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzowNzoyNFrOFxsgbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzowNzoyNFrOFxsgbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1Mzc0Mg==", "bodyText": "At the top of this class, please remove the comment above the package declaration.\n/**\n * Constants for the JavaBatch Jobs.\n */", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387653742", "createdAt": "2020-03-04T13:07:24Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/Constants.java", "diffHunk": "@@ -30,7 +30,9 @@\n     public static final byte[] NDJSON_LINESEPERATOR = \"\\r\\n\".getBytes();\n \n     public static final int IMPORT_MAX_PARTITIONPROCESSING_THREADNUMBER = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzYyODY4", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368762868", "createdAt": "2020-03-04T13:10:53Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMDo1M1rOFxsnXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMDo1M1rOFxsnXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NTUxOQ==", "bodyText": "I don't think this is the right approach.", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387655519", "createdAt": "2020-03-04T13:10:53Z", "author": {"login": "prb112"}, "path": "fhir-persistence/src/main/java/com/ibm/fhir/persistence/helper/FHIRTransactionHelper.java", "diffHunk": "@@ -88,4 +89,14 @@ public void rollback() {\n             }\n         }\n     }\n+\n+    /**\n+     * Use this only if the transaction is not started and managed by us, e.g, by JavaBatch framework.\n+     */\n+    public void commit2() throws FHIRPersistenceException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzYzOTk4", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368763998", "createdAt": "2020-03-04T13:12:24Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMjoyNVrOFxsrDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMjoyNVrOFxsrDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NjQ2MA==", "bodyText": "Copyright header", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387656460", "createdAt": "2020-03-04T13:12:25Z", "author": {"login": "prb112"}, "path": "fhir-persistence/src/main/java/com/ibm/fhir/persistence/helper/FHIRTransactionHelper.java", "diffHunk": "@@ -17,16 +17,16 @@\n  */\n public class FHIRTransactionHelper {\n     private static final Logger log = Logger.getLogger(FHIRTransactionHelper.class.getName());\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY0Mjc4", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368764278", "createdAt": "2020-03-04T13:12:47Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMjo0N1rOFxsr4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMjo0N1rOFxsr4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NjY3Mg==", "bodyText": "I don't think this is the right approach.", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387656672", "createdAt": "2020-03-04T13:12:47Z", "author": {"login": "prb112"}, "path": "fhir-persistence/src/main/java/com/ibm/fhir/persistence/helper/FHIRTransactionHelper.java", "diffHunk": "@@ -38,12 +38,13 @@ public void begin() throws FHIRPersistenceException {\n                 txn.begin();\n                 txnStarted = true;\n             } else {\n-                log.fine(\"Transaction is already active on current thread...\");\n+                log.fine(\"Transaction is already active on current thread, get Db connection only ...\");\n+                txn.begin();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY0NTU2", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368764556", "createdAt": "2020-03-04T13:13:13Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMzoxM1rOFxsssw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMzoxM1rOFxsssw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1Njg4Mw==", "bodyText": "I don't think close Connection should be in the FHIRPersistenceTransaction", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387656883", "createdAt": "2020-03-04T13:13:13Z", "author": {"login": "prb112"}, "path": "fhir-persistence/src/main/java/com/ibm/fhir/persistence/FHIRPersistenceTransaction.java", "diffHunk": "@@ -12,33 +12,36 @@\n  * This interface represents a transaction within the FHIR persistence layer.\n  */\n public interface FHIRPersistenceTransaction {\n-    \n+\n     /**\n      * Returns true iff an active transaction exists within the current thread's context.\n      */\n     boolean isActive() throws FHIRPersistenceException;\n-    \n+\n     /**\n      * Begin a new transaction on the current thread.\n      * @throws Exception\n      */\n     void begin() throws FHIRPersistenceException;\n-    \n+\n     /**\n      * Commit the current thread's transaction.\n      * @throws Exception\n      */\n     void commit() throws FHIRPersistenceException;\n-    \n+\n+\n+    void closeConnection() throws FHIRPersistenceException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY0NzM5", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368764739", "createdAt": "2020-03-04T13:13:31Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMzozMVrOFxstPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMzozMVrOFxstPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NzAyMA==", "bodyText": "Copyright header", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387657020", "createdAt": "2020-03-04T13:13:31Z", "author": {"login": "prb112"}, "path": "fhir-persistence/src/main/java/com/ibm/fhir/persistence/FHIRPersistenceTransaction.java", "diffHunk": "@@ -12,33 +12,36 @@\n  * This interface represents a transaction within the FHIR persistence layer.\n  */\n public interface FHIRPersistenceTransaction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY1MTQw", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368765140", "createdAt": "2020-03-04T13:14:05Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxNDowNVrOFxsujA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxNDowNVrOFxsujA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NzM1Ng==", "bodyText": "It should use only txn.commit\nif a behavior needs to change, then change in txn.commit", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387657356", "createdAt": "2020-03-04T13:14:05Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ChunkWriter.java", "diffHunk": "@@ -149,16 +148,19 @@ public void writeItems(List<java.lang.Object> arg0) throws Exception {\n                             chunkData.getBufferStream4Import().write(Constants.NDJSON_LINESEPERATOR);\n                         }\n                     }\n-                } catch (FHIRPersistenceException e) {\n+                } catch (Exception e) {\n                     logger.warning(\"Failed to import due to error: \" + e.getMessage());\n                     failedNum++;\n                     if (Constants.IMPORT_IS_COLLECT_OPERATIONOUTCOMES) {\n                         FHIRGenerator.generator(Format.JSON).generate(FHIRUtil.buildOperationOutcome(e, false), chunkData.getBufferStream4ImportError());\n                         chunkData.getBufferStream4ImportError().write(Constants.NDJSON_LINESEPERATOR);\n                     }\n                 }\n-\n             }\n+            // Release the DB connection.\n+            // This doesn't really commit the transaction, because the transaction was started and will be committed\n+            // by the JavaBatch framework.\n+            txn.commit2();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY1MzA3", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368765307", "createdAt": "2020-03-04T13:14:20Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxNDoyMFrOFxsvDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxNDoyMFrOFxsvDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NzQ4Ng==", "bodyText": "Why the conversion to Exception?", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387657486", "createdAt": "2020-03-04T13:14:20Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ChunkWriter.java", "diffHunk": "@@ -149,16 +148,19 @@ public void writeItems(List<java.lang.Object> arg0) throws Exception {\n                             chunkData.getBufferStream4Import().write(Constants.NDJSON_LINESEPERATOR);\n                         }\n                     }\n-                } catch (FHIRPersistenceException e) {\n+                } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY3MzEy", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368767312", "createdAt": "2020-03-04T13:17:13Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxNzoxM1rOFxs1Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxNzoxM1rOFxs1Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1OTA3OA==", "bodyText": "any particular reason for this change? 421/422 can now be on one line", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387659078", "createdAt": "2020-03-04T13:17:13Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -418,8 +418,8 @@ public FHIRPersistenceJDBCImpl(Properties configProps, IConnectionProvider cp) t\n \n         try {\n             checkModifiers(searchContext);\n-            queryBuilder = new JDBCQueryBuilder((ParameterDAO) this.getParameterDao(),\n-                                                (ResourceDAO) this.getResourceDao());\n+            queryBuilder = new JDBCQueryBuilder(this.getParameterDao(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 316}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY4Mjcz", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368768273", "createdAt": "2020-03-04T13:18:40Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxODo0MFrOFxs4Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxODo0MFrOFxs4Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1OTgwNw==", "bodyText": "I personally don't think this is the right place or the correct change.  If you are getting it from a pool, the pool should manage the closing of the connection in this case.  In particular, this is coming from the jdbc/fhirProxyDataSource ... I think this has unintended consequences.", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387659807", "createdAt": "2020-03-04T13:18:40Z", "author": {"login": "prb112"}, "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -1522,33 +1526,49 @@ public FHIRPersistenceTransaction getTransaction() {\n     public boolean isDeleteSupported() {\n         return true;\n     }\n-    \n+\n     private FHIRDbDAO getBaseDao() {\n         return baseDao;\n     }\n-    \n+\n     private void setBaseDao(FHIRDbDAO baseDao) {\n         this.baseDao = baseDao;\n     }\n-    \n+\n     private Connection getManagedConnection() {\n         return managedConnection;\n     }\n \n     private void setManagedConnection(Connection managedConnection) {\n         this.managedConnection = managedConnection;\n     }\n-    \n+\n     private OperationOutcome buildOKOperationOutcome() {\n         return FHIRUtil.buildOperationOutcome(\"All OK\", IssueType.INFORMATIONAL, IssueSeverity.INFORMATION);\n     }\n \n     private OperationOutcome buildErrorOperationOutcome() {\n         return FHIRUtil.buildOperationOutcome(\"The database connection was not valid\", IssueType.NO_STORE, IssueSeverity.ERROR);\n     }\n-    \n+\n     private Connection createConnection() throws FHIRPersistenceDBConnectException {\n         FHIRDbDAOImpl dao = new FHIRDbDAOImpl();\n         return dao.getConnection();\n     }\n+\n+    @Override\n+    public void closeConnection() throws FHIRPersistenceException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "originalPosition": 1157}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY5NTg4", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368769588", "createdAt": "2020-03-04T13:20:35Z", "commit": {"oid": "72c43c512b21bc20c8044ddd86b6756a82308f5c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e876ce1923fc7fd15bbd1f506718485cfc104681", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/e876ce1923fc7fd15bbd1f506718485cfc104681", "committedDate": "2020-03-04T14:13:30Z", "message": "issue #749 minor changes per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e9f44656b617ad1812b4cbc37ad17c3c8ffb1fe", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/8e9f44656b617ad1812b4cbc37ad17c3c8ffb1fe", "committedDate": "2020-03-04T15:58:54Z", "message": "issue #749 change to use existing commit method instead of commit2\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4OTA3ODAx", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-368907801", "createdAt": "2020-03-04T16:03:38Z", "commit": {"oid": "8e9f44656b617ad1812b4cbc37ad17c3c8ffb1fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjowMzozOFrOFxzYJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjowMzozOFrOFxzYJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2NjMxMQ==", "bodyText": "remind me why we're skipping lines again?", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387766311", "createdAt": "2020-03-04T16:03:38Z", "author": {"login": "lmsurpre"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/BulkDataUtils.java", "diffHunk": "@@ -137,21 +137,21 @@ public static void listBuckets(AmazonS3 cosClient) {\n     private static int getFhirResourceFromBufferReader(BufferedReader resReader, int numOfLinesToSkip, List<Resource> fhirResources) throws Exception {\n         int exported = 0;\n         int lineRed = 0;\n-        while (resReader.ready()) {\n-            String resLine = resReader.readLine();\n-            lineRed++;\n-            if (resLine == null) {\n-                break;\n-            }\n-            if (lineRed <= numOfLinesToSkip) {\n-                continue;\n-            }\n-            fhirResources.add(FHIRParser.parser(Format.JSON).parse(new StringReader(resLine)));\n-            exported++;\n-            if (exported == Constants.IMPORT_NUMOFFHIRRESOURCES_PERREAD) {\n-                break;\n+        String resLine = null;\n+        do {\n+            resLine = resReader.readLine();\n+            if (resLine != null) {\n+                lineRed++;\n+                if (lineRed <= numOfLinesToSkip) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e9f44656b617ad1812b4cbc37ad17c3c8ffb1fe"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0beed8561a47aa16d419ce7e2d58cd270bba944", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/e0beed8561a47aa16d419ce7e2d58cd270bba944", "committedDate": "2020-03-04T16:17:33Z", "message": "issue #749 change comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acfb8a8130139d168e27551c28320cbf9fd1789d", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/acfb8a8130139d168e27551c28320cbf9fd1789d", "committedDate": "2020-03-04T16:21:30Z", "message": "issue #749 update copy right\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea1df164c7200208663d57025f5d318e0d95fd13", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/ea1df164c7200208663d57025f5d318e0d95fd13", "committedDate": "2020-03-04T16:30:01Z", "message": "issue #745 update javadoc for begin method of FhirPersistenceTransaction\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d93dad1bf7b89b4f95b6d9c645165ad60070306", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/3d93dad1bf7b89b4f95b6d9c645165ad60070306", "committedDate": "2020-03-04T16:46:12Z", "message": "issue #745 minor change\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e47fb7f4881385ba8e327a285a67de40fc02313", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/2e47fb7f4881385ba8e327a285a67de40fc02313", "committedDate": "2020-03-04T17:11:44Z", "message": "issue #749 minor adjustment\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f366893dee8f7d026f0399d23bff0b80dfad052", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/1f366893dee8f7d026f0399d23bff0b80dfad052", "committedDate": "2020-03-04T17:21:52Z", "message": "issue #749 rollback exception handling in chunkwritter\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9875c532b0c3a930b4bec1cb827848469549fc8f", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/9875c532b0c3a930b4bec1cb827848469549fc8f", "committedDate": "2020-03-04T19:48:49Z", "message": "issue #749 updates per team discuss results\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "431d3a997d319bf85bb46c17b750a6c9ed7de5d8", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/431d3a997d319bf85bb46c17b750a6c9ed7de5d8", "committedDate": "2020-03-04T19:53:14Z", "message": "issue #749 minor change for comment\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb429628bc97ec67b63f308ed6f5636a028fed2f", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/eb429628bc97ec67b63f308ed6f5636a028fed2f", "committedDate": "2020-03-04T19:55:40Z", "message": "issue #749 minor update\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDg5MDYz", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-369089063", "createdAt": "2020-03-04T20:12:31Z", "commit": {"oid": "eb429628bc97ec67b63f308ed6f5636a028fed2f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDoxMjozMVrOFx8Dow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDoxMjozMVrOFx8Dow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwODUxNQ==", "bodyText": "maybe unenroll ?", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387908515", "createdAt": "2020-03-04T20:12:31Z", "author": {"login": "prb112"}, "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkimport/ChunkWriter.java", "diffHunk": "@@ -157,9 +158,13 @@ public void writeItems(List<java.lang.Object> arg0) throws Exception {\n                         chunkData.getBufferStream4ImportError().write(Constants.NDJSON_LINESEPERATOR);\n                     }\n                 }\n-\n             }\n         }\n+        // Release the DB connection.\n+        // This doesn't really commit the transaction, because the transaction was started and will be committed\n+        // by the JavaBatch framework.\n+        txn.unEnroll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb429628bc97ec67b63f308ed6f5636a028fed2f"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDkwMDIy", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-369090022", "createdAt": "2020-03-04T20:14:05Z", "commit": {"oid": "eb429628bc97ec67b63f308ed6f5636a028fed2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6418c17b9caa4e5777cfc5cea097f067490a539", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/d6418c17b9caa4e5777cfc5cea097f067490a539", "committedDate": "2020-03-04T20:22:31Z", "message": "issue #749 change unEnroll to unenroll\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e02c3ce9ddb9415fc9a50512950b03add218fe8", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/3e02c3ce9ddb9415fc9a50512950b03add218fe8", "committedDate": "2020-03-04T20:26:20Z", "message": "issue #749 change to unenroll for log messages\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTA4OTg2", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-369108986", "createdAt": "2020-03-04T20:45:32Z", "commit": {"oid": "3e02c3ce9ddb9415fc9a50512950b03add218fe8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0NTozMlrOFx8_uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0NTozMlrOFx8_uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzg5Nw==", "bodyText": "javadoc?", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387923897", "createdAt": "2020-03-04T20:45:32Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence/src/main/java/com/ibm/fhir/persistence/helper/FHIRTransactionHelper.java", "diffHunk": "@@ -88,4 +88,17 @@ public void rollback() {\n             }\n         }\n     }\n+\n+    public void enroll() throws FHIRPersistenceException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e02c3ce9ddb9415fc9a50512950b03add218fe8"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTA5MDU4", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-369109058", "createdAt": "2020-03-04T20:45:39Z", "commit": {"oid": "3e02c3ce9ddb9415fc9a50512950b03add218fe8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0NTozOVrOFx8__A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0NTozOVrOFx8__A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzk2NA==", "bodyText": "javadoc?", "url": "https://github.com/IBM/FHIR/pull/754#discussion_r387923964", "createdAt": "2020-03-04T20:45:39Z", "author": {"login": "lmsurpre"}, "path": "fhir-persistence/src/main/java/com/ibm/fhir/persistence/helper/FHIRTransactionHelper.java", "diffHunk": "@@ -88,4 +88,17 @@ public void rollback() {\n             }\n         }\n     }\n+\n+    public void enroll() throws FHIRPersistenceException {\n+        if (txn != null) {\n+            txn.enroll();\n+        }\n+    }\n+\n+    public void unenroll() throws FHIRPersistenceException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e02c3ce9ddb9415fc9a50512950b03add218fe8"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa29f9df6d39322178ae20d39da249fb333ea4c6", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/aa29f9df6d39322178ae20d39da249fb333ea4c6", "committedDate": "2020-03-04T21:04:25Z", "message": "issue #749 update comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ac1b75c3936a1d6f300fb314c4cb06dfebb6be4", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/0ac1b75c3936a1d6f300fb314c4cb06dfebb6be4", "committedDate": "2020-03-04T21:19:21Z", "message": "issue #749 updated comments per review\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad008813d2b0035024e2aaa86f790c6711608fac", "author": {"user": {"login": "albertwang-ibm", "name": "Albert(Xu) Wang"}}, "url": "https://github.com/IBM/FHIR/commit/ad008813d2b0035024e2aaa86f790c6711608fac", "committedDate": "2020-03-04T21:24:39Z", "message": "issue #749 update comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTM2MDgy", "url": "https://github.com/IBM/FHIR/pull/754#pullrequestreview-369136082", "createdAt": "2020-03-04T21:28:35Z", "commit": {"oid": "ad008813d2b0035024e2aaa86f790c6711608fac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 477, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}