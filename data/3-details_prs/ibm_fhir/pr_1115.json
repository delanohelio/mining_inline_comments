{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzExMzYy", "number": 1115, "title": "Issue #1107 - add support for Identifier pattern value constraints", "bodyText": "Signed-off-by: John T.E. Timm johntimm@us.ibm.com", "createdAt": "2020-05-18T19:58:13Z", "url": "https://github.com/IBM/FHIR/pull/1115", "merged": true, "mergeCommit": {"oid": "8e7575bd8295f035064ea7a04dd0c37d691c0f7a"}, "closed": true, "closedAt": "2020-05-18T20:21:00Z", "author": {"login": "JohnTimm"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcildJjAH2gAyNDE5NzExMzYyOjlkYjBmNzRjNTM5YjA0ZDlkYmNhYzBkMWQzNjk0Nzg2ZGEyMWQyNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABciltO2AFqTQxMzkwODU0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b", "author": {"user": {"login": "JohnTimm", "name": "John T.E. Timm"}}, "url": "https://github.com/IBM/FHIR/commit/9db0f74c539b04d9dbcac0d1d3694786da21d26b", "committedDate": "2020-05-18T19:57:50Z", "message": "Issue #1107 - add support for Identifier pattern value constraints\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTAwNDU5", "url": "https://github.com/IBM/FHIR/pull/1115#pullrequestreview-413900459", "createdAt": "2020-05-18T20:01:48Z", "commit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowMTo0OFrOGXFqfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowMTo0OFrOGXFqfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2MzIzMA==", "bodyText": "is this change related?", "url": "https://github.com/IBM/FHIR/pull/1115#discussion_r426863230", "createdAt": "2020-05-18T20:01:48Z", "author": {"login": "lmsurpre"}, "path": "fhir-path/src/main/java/com/ibm/fhir/path/function/MemberOfFunction.java", "diffHunk": "@@ -150,7 +148,7 @@ public int getMaxArity() {\n \n     private boolean contains(Map<String, Set<String>> codeSetMap, Coding coding) {\n         String system = (coding.getSystem() != null) ? coding.getSystem().getValue() : null;\n-        String version = (coding.getVersion() != null) ? coding.getVersion().getValue() : FHIRRegistry.getInstance().getLatestVersion(system, CodeSystem.class);\n+        String version = (coding.getVersion() != null) ? coding.getVersion().getValue() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTAxNTQ5", "url": "https://github.com/IBM/FHIR/pull/1115#pullrequestreview-413901549", "createdAt": "2020-05-18T20:03:36Z", "commit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowMzozNlrOGXFtuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDowMzozNlrOGXFtuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2NDA1OQ==", "bodyText": "any way to format this to make it a little simpler to see whats going on?", "url": "https://github.com/IBM/FHIR/pull/1115#discussion_r426864059", "createdAt": "2020-05-18T20:03:36Z", "author": {"login": "lmsurpre"}, "path": "fhir-profile/src/main/java/com/ibm/fhir/profile/ConstraintGenerator.java", "diffHunk": "@@ -304,13 +313,38 @@ private String generatePatternValueConstraint(ElementDefinition elementDefinitio\n             CodeableConcept codeableConcept = pattern.as(CodeableConcept.class);\n             Coding coding = codeableConcept.getCoding().get(0);\n             String system = (coding.getSystem() != null) ? coding.getSystem().getValue() : null;\n+\n             sb.append(\".where(coding.where(\");\n+\n             if (system != null) {\n                 sb.append(\"system = '\").append(system).append(\"' and \");\n             }\n-            sb.append(\"code = '\")\n-                .append(coding.getCode().getValue())\n-                .append(\"').exists()).exists()\");\n+\n+            sb.append(\"code = '\").append(coding.getCode().getValue()).append(\"').exists()).exists()\");\n+        } else if (pattern.is(Identifier.class)) {\n+            Identifier _identifier = pattern.as(Identifier.class);\n+            String system = _identifier.getSystem().getValue();\n+\n+            sb.append(\".where(system = '\").append(system).append(\"').count()\");\n+\n+            Integer min = elementDefinition.getMin().getValue();\n+            String max = elementDefinition.getMax().getValue();\n+\n+            if (\"*\".equals(max)) {\n+                sb.append(\" >= \").append(min);\n+            } else if (\"1\".equals(max)) {\n+                if (min == 0) {\n+                    sb.append(\" <= 1\");\n+                } else {\n+                    sb.append(\" = 1\");\n+                }\n+            } else {\n+                sb.append(\" >= \").append(min).append(\" and \").append(identifier).append(\".where(system = '\").append(system).append(\"').count() <= \").append(max);\n+            }\n+\n+            if (!node.children.isEmpty()) {\n+                sb.append(\" and (\").append(identifier).append(\".where(system = '\").append(system).append(\"').exists()\").append(\" implies (\").append(identifier).append(\".where(system = '\").append(system).append(\"' and \").append(generate(node.children)).append(\")))\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTA4MzQ4", "url": "https://github.com/IBM/FHIR/pull/1115#pullrequestreview-413908348", "createdAt": "2020-05-18T20:15:04Z", "commit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTA4NTQw", "url": "https://github.com/IBM/FHIR/pull/1115#pullrequestreview-413908540", "createdAt": "2020-05-18T20:15:24Z", "commit": {"oid": "9db0f74c539b04d9dbcac0d1d3694786da21d26b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1443, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}