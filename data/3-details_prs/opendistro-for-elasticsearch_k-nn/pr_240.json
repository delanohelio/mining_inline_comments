{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxOTU3NTY4", "number": 240, "title": "Refactor KNNVectorFieldMapper", "bodyText": "Issue #, if available:\n#239\nDescription of changes:\nPR refactors KNNVectorFieldMapper in a variety of ways.\nFirst, it refactors KNNVectorFieldMapper to utilize ParametrizedFieldMapper. This way, we do not need to parse the field parameters manually.\nSecond, it refactors KNNVectorFieldMapper to build a new fieldType in parseCreateField, as opposed to updating Defaults.FIELD_TYPE inside the builder logic. This will prevent race condition bugs seen in #239.\nThird, it refactors the ordering of the logic inside of KNNVectorFieldMapper to follow the convention of other Elasticsearch field mappers.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-13T03:45:00Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/240", "merged": true, "mergeCommit": {"oid": "6d6a961195ae7139a2bf0dffed378748096404e9"}, "closed": true, "closedAt": "2020-10-13T23:11:38Z", "author": {"login": "jmazanec15"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR6zDGAH2gAyNTAxOTU3NTY4OjAzOTdkZDljYTZmNGRjMGJjMDg2NzQxYmYxYzcxNjA2ZTllZGQ2NGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSQ2gGgFqTUwNzg4ODg0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0397dd9ca6f4dc0bc086741bf1c71606e9edd64a", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0397dd9ca6f4dc0bc086741bf1c71606e9edd64a", "committedDate": "2020-10-12T21:24:12Z", "message": "converting field mapper to parametrized field mapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e7b40d2899559c0eebda8d23f6f6813d6fabf3d", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1e7b40d2899559c0eebda8d23f6f6813d6fabf3d", "committedDate": "2020-10-13T03:22:30Z", "message": "make KNNVectorFieldMapper extend ParametrizedFieldMapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3Nzc4MTQ2", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/240#pullrequestreview-507778146", "createdAt": "2020-10-13T19:53:47Z", "commit": {"oid": "1e7b40d2899559c0eebda8d23f6f6813d6fabf3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxOTo1Mzo0N1rOHg2-HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxOTo1Mzo0N1rOHg2-HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIxNzExNw==", "bodyText": "How about reading these algo params from the indexSettings here? Idea is to lazy load these settings to ensure the settings are available to read from IndexSettings.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/240#discussion_r504217117", "createdAt": "2020-10-13T19:53:47Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -344,6 +312,12 @@ public void parse(ParseContext context) throws IOException {\n             array[i++] = f;\n         }\n \n+        FieldType fieldType = new FieldType(Defaults.FIELD_TYPE);\n+        fieldType.putAttribute(KNNConstants.SPACE_TYPE, spaceType);\n+        fieldType.putAttribute(KNNConstants.HNSW_ALGO_M, String.valueOf(m));\n+        fieldType.putAttribute(KNNConstants.HNSW_ALGO_EF_CONSTRUCTION, String.valueOf(efConstruction));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e7b40d2899559c0eebda8d23f6f6813d6fabf3d"}, "originalPosition": 375}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73716cdcf1933d2883f42205c441949013ae5694", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/73716cdcf1933d2883f42205c441949013ae5694", "committedDate": "2020-10-13T20:38:09Z", "message": "add endline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d13caba7843db6844cc496b01f5a0044195d8a1", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3d13caba7843db6844cc496b01f5a0044195d8a1", "committedDate": "2020-10-13T20:38:29Z", "message": "create fieldType in constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "147af71c1b92bca88850e922d8f29fe9f8825d2e", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/147af71c1b92bca88850e922d8f29fe9f8825d2e", "committedDate": "2020-10-13T21:36:13Z", "message": "refactor where algo params are retrieved from settings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODY0MzEw", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/240#pullrequestreview-507864310", "createdAt": "2020-10-13T22:10:39Z", "commit": {"oid": "147af71c1b92bca88850e922d8f29fe9f8825d2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjoxMDozOVrOHg7Rsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjoxMDozOVrOHg7Rsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NzY2Ng==", "bodyText": "Why are we storing state in Builder class? Why not get a fresh copy every time by reading from indexSettings?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/240#discussion_r504287666", "createdAt": "2020-10-13T22:10:39Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -122,59 +131,69 @@ public Builder(String name, String spaceType, int m, int efConstruction) {\n \n         @Override\n         public KNNVectorFieldMapper build(BuilderContext context) {\n-            return new KNNVectorFieldMapper(name, new KNNVectorFieldType(buildFullName(context), meta.getValue(),\n-                    dimension.getValue()), multiFieldsBuilder.build(this, context),\n-                    ignoreMalformed(context), spaceType, m, efConstruction, copyTo.build(), this);\n-        }\n-    }\n+            if (spaceType == null) {\n+                spaceType = getSpaceType(context.indexSettings());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147af71c1b92bca88850e922d8f29fe9f8825d2e"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9f6431f1424f5c3bc7de345afc2f073ae24004d", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/a9f6431f1424f5c3bc7de345afc2f073ae24004d", "committedDate": "2020-10-13T22:36:57Z", "message": "remove state from builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef548a52b42c989b1b5063e48df10efa77d5145a", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ef548a52b42c989b1b5063e48df10efa77d5145a", "committedDate": "2020-10-13T22:41:31Z", "message": "fix typo in test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODg4ODQ1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/240#pullrequestreview-507888845", "createdAt": "2020-10-13T23:05:53Z", "commit": {"oid": "ef548a52b42c989b1b5063e48df10efa77d5145a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1278, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}