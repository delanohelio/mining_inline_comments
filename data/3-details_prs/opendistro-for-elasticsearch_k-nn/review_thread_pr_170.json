{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNDM1OTk3", "number": 170, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMDo0MDoyMVrOEPq1iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMDo0MDoyMVrOEPq1iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0ODY1OTMxOnYy", "diffSide": "RIGHT", "path": ".github/workflows/CD.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMDo0MDoyMVrOGzgkJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMDo1NDowOFrOGzg5VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2NDEwMg==", "bodyText": "As we discussed @jmazanec15 since CentOS have the lowest version of glibc, it would make sense to compile all distros of knnlib (zip/deb/rpm) in CentOS.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170#discussion_r456664102", "createdAt": "2020-07-17T20:40:21Z", "author": {"login": "peterzhuamazon"}, "path": ".github/workflows/CD.yml", "diffHunk": "@@ -68,3 +39,105 @@ jobs:\n           aws s3 cp $rpm_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/rpms/opendistro-knn/\n           aws s3 cp $deb_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/debs/opendistro-knn/\n           aws cloudfront create-invalidation --distribution-id E1VG5HMIWI4SA2 --paths \"/*\"\n+\n+  library-build-and-ship-zip-and-rpm:\n+    name: Build k-NN JNI Library for Zip and RPM\n+    runs-on: ubuntu-latest\n+    container:\n+      image: centos:7\n+    strategy:\n+      matrix:\n+        java: [14]\n+        compiler: [g++]\n+    steps:\n+      - name: Checkout k-NN\n+        uses: actions/checkout@v1\n+        with:\n+          submodules: true\n+\n+      - name: Configure AWS Credentials\n+        uses: aws-actions/configure-aws-credentials@v1\n+        with:\n+          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n+          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n+          aws-region: us-east-1\n+\n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+\n+      - name: Install dependencies\n+        run: |\n+          yum update -y\n+          yum install -y cmake rpm-build gcc-c++ make\n+\n+      - name: Build and ship library RPM and ZIP\n+        env:\n+          CXX: ${{ matrix.compiler }}\n+        run: |\n+          cd jni\n+          sed -i 's/-march=native/-march=x86-64/g' external/nmslib/similarity_search/CMakeLists.txt\n+          cmake .\n+          make package\n+\n+          cd packages\n+          folder_name=`ls ./*.rpm | sed 's|\\(.*\\)\\..*|\\1|'`\n+          zip_name=$folder_name\".zip\"\n+          mkdir $folder_name\n+          cp ../release/*.so $folder_name\n+          zip -r $zip_name $folder_name/*\n+          cd ..\n+\n+          zip_artifact=`ls packages/*.zip`\n+          rpm_artifact=`ls packages/*.rpm`\n+\n+          aws s3 cp $zip_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/opendistro-libs/opendistro-knnlib/\n+          aws s3 cp $rpm_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/rpms/opendistro-knnlib/\n+          aws cloudfront create-invalidation --distribution-id E1VG5HMIWI4SA2 --paths \"/*\"\n+\n+  library-build-and-ship-deb:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "527e0097ddc0a3be327a1914f33a20818cf5c4aa"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2OTUyNQ==", "bodyText": "Yes, I believe that makes sense. Will test artifacts built there on other systems.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170#discussion_r456669525", "createdAt": "2020-07-17T20:54:08Z", "author": {"login": "jmazanec15"}, "path": ".github/workflows/CD.yml", "diffHunk": "@@ -68,3 +39,105 @@ jobs:\n           aws s3 cp $rpm_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/rpms/opendistro-knn/\n           aws s3 cp $deb_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/debs/opendistro-knn/\n           aws cloudfront create-invalidation --distribution-id E1VG5HMIWI4SA2 --paths \"/*\"\n+\n+  library-build-and-ship-zip-and-rpm:\n+    name: Build k-NN JNI Library for Zip and RPM\n+    runs-on: ubuntu-latest\n+    container:\n+      image: centos:7\n+    strategy:\n+      matrix:\n+        java: [14]\n+        compiler: [g++]\n+    steps:\n+      - name: Checkout k-NN\n+        uses: actions/checkout@v1\n+        with:\n+          submodules: true\n+\n+      - name: Configure AWS Credentials\n+        uses: aws-actions/configure-aws-credentials@v1\n+        with:\n+          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n+          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n+          aws-region: us-east-1\n+\n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+\n+      - name: Install dependencies\n+        run: |\n+          yum update -y\n+          yum install -y cmake rpm-build gcc-c++ make\n+\n+      - name: Build and ship library RPM and ZIP\n+        env:\n+          CXX: ${{ matrix.compiler }}\n+        run: |\n+          cd jni\n+          sed -i 's/-march=native/-march=x86-64/g' external/nmslib/similarity_search/CMakeLists.txt\n+          cmake .\n+          make package\n+\n+          cd packages\n+          folder_name=`ls ./*.rpm | sed 's|\\(.*\\)\\..*|\\1|'`\n+          zip_name=$folder_name\".zip\"\n+          mkdir $folder_name\n+          cp ../release/*.so $folder_name\n+          zip -r $zip_name $folder_name/*\n+          cd ..\n+\n+          zip_artifact=`ls packages/*.zip`\n+          rpm_artifact=`ls packages/*.rpm`\n+\n+          aws s3 cp $zip_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/opendistro-libs/opendistro-knnlib/\n+          aws s3 cp $rpm_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/rpms/opendistro-knnlib/\n+          aws cloudfront create-invalidation --distribution-id E1VG5HMIWI4SA2 --paths \"/*\"\n+\n+  library-build-and-ship-deb:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2NDEwMg=="}, "originalCommit": {"oid": "527e0097ddc0a3be327a1914f33a20818cf5c4aa"}, "originalPosition": 113}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2647, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}