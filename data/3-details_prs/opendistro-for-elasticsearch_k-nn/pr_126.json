{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMTE0NjYx", "number": 126, "title": "ENH: ability to dynamically update efSearch setting", "bodyText": "Issue #, if available:\n#116\nDescription of changes:\n\nAdd ef_search field into KNNQueryBuilder and KNNQuery and modified the relevant APIs\nPass in ef_search from query when getting/loading index for query\nModified both UnitTest and IntegrationTests to cover the enhancement\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-22T19:48:30Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126", "merged": true, "mergeCommit": {"oid": "41d176e8b625ac808f71921f8352df5995791200"}, "closed": true, "closedAt": "2020-06-15T01:55:14Z", "author": {"login": "chenqi0805"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjzEBbgH2gAyNDIyMTE0NjYxOjFhZDAwOTEyYzkwOGIwYzhmMWE0ZGM1MzA1MTE3ZTU1MTY5MGY5NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqcqwugFqTQyOTQ4NTU2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ad00912c908b0c8f1a4dc5305117e551690f971", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1ad00912c908b0c8f1a4dc5305117e551690f971", "committedDate": "2020-05-22T14:22:59Z", "message": "add ef_search into query and query builder; adapt loadIndex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cf5ab0b221759a72cde473f830e5cdc55037d27", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/8cf5ab0b221759a72cde473f830e5cdc55037d27", "committedDate": "2020-05-22T18:37:31Z", "message": "FIX: integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "756f4874a4c6c49b760accc7b57f7153ab735c8d", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/756f4874a4c6c49b760accc7b57f7153ab735c8d", "committedDate": "2020-05-22T19:39:32Z", "message": "FIX: @param in docstring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3f0b06e9f1cab21d0fb3338cd004c7431f66029", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/e3f0b06e9f1cab21d0fb3338cd004c7431f66029", "committedDate": "2020-05-22T19:40:35Z", "message": "FIX: query builder on efsearch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f0a41e01ed251c2f1f3686b3f12f73426173989", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/7f0a41e01ed251c2f1f3686b3f12f73426173989", "committedDate": "2020-05-22T19:41:01Z", "message": "Adapt test case to cover efsearch in query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb5f407b059cd46844c7f3ef338ee02f194031a", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/4fb5f407b059cd46844c7f3ef338ee02f194031a", "committedDate": "2020-05-22T19:55:01Z", "message": "FIX: validity check and test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/7e06873aef0afee53afbe02ea8f905d8fb982696", "committedDate": "2020-05-22T20:01:20Z", "message": "RMV: unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODM2ODE5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#pullrequestreview-418836819", "createdAt": "2020-05-27T03:44:07Z", "commit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0NDowN1rOGa4bVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0NjoyMlrOGa4dVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MDY2Mg==", "bodyText": "This method would be called only once when there is cache miss. The efsearch value passed is stored in the\nIndexWrapper as part of init call. So ef_search passed in subsequent queries would not be reflected.\nIdeal way is to plumb the ef_search through queryIndex function from KNNWeight. As part of this function in the jni, we could set the  ef_search usingsetQueryTimeParams if ef_search is not null otherwise just use the existing value.\nWe need to be careful while calling setQueryTimeParams because at the same time it is possible some query is already referencing this object and could cause segmentation faults. We need to kind of ensure only one thread is setting/getting ef_search .", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r430840662", "createdAt": "2020-05-27T03:44:07Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -273,11 +275,12 @@ public void evictAllGraphsFromCache() {\n      *\n      * @param indexPathUrl path for serialized hnsw graph\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"\n      * @return KNNIndex holding the heap pointer of the loaded graph\n      * @throws Exception Exception could occur when registering the index path\n      * to Resource watcher or if the JNI call throws\n      */\n-    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throws Exception {\n+    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName, int efSearch) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MTE3Mw==", "bodyText": "We do not have to change this method.  This method can always read the default setting so that IndexWrapper can refer it when ef_search is null.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r430841173", "createdAt": "2020-05-27T03:46:22Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -290,7 +293,8 @@ public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throw\n         // the entry\n         fileWatcher.init();\n \n-        final KNNIndex knnIndex = KNNIndex.loadIndex(indexPathUrl, getQueryParams(indexName), KNNSettings.getSpaceType(indexName));\n+        final KNNIndex knnIndex = KNNIndex.loadIndex(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abed522998fd90ff265750c7d56bbfafed5bfe68", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/abed522998fd90ff265750c7d56bbfafed5bfe68", "committedDate": "2020-06-09T03:15:00Z", "message": "Make ef_search dynamic and register setting update consumer for the parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e478ee8a95f259ebc395471f7b5434d840de1ea6", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/e478ee8a95f259ebc395471f7b5434d840de1ea6", "committedDate": "2020-06-09T03:18:36Z", "message": "Revert query structure and relevant tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e15043612b4df97f0e88cfb265ea54a536edcab0", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/e15043612b4df97f0e88cfb265ea54a536edcab0", "committedDate": "2020-06-09T03:19:13Z", "message": "Merge branch 'master' into enh/ability-to-pass-ef-search-in-query\n\n* master:\n  added github action to build library artifacts (#132)\n  FIX: buildDir->rootDir\n  Build separate artifacts for library using CPack (#123)\n  Fix test structure (#125)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b84085771ae4075c7e4c5ebab1acd3720c1efbe4", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b84085771ae4075c7e4c5ebab1acd3720c1efbe4", "committedDate": "2020-06-09T15:04:12Z", "message": "TST: update ef_search after index creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/498b4bf02c68e90860059b5df82ab0ef64dd1ed5", "committedDate": "2020-06-09T15:29:18Z", "message": "checkStyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NzA4ODg5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#pullrequestreview-427708889", "createdAt": "2020-06-10T04:51:40Z", "commit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNDo1MTo0MVrOGhkxuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNDo1MzozNFrOGhkzjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1ODc0Nw==", "bodyText": "we could remove this comment. Cache rebuild already seem to happen in a dedicated thread", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r437858747", "createdAt": "2020-06-10T04:51:41Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {\n+                    logger.debug(\"The value of setting [{}] changed to [{}]\", KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    latestSettings.put(KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    // spawn a thread", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1OTIxNQ==", "bodyText": "rebuild whole cache might not be necessary as we could lose graphs of other indices. Once we have the clear cache api #68 , we could selectively evict entries of a particular index. We could leave a TODO  to fix after clear cache api is built. Would be great to create an issue as well to just track the fix?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r437859215", "createdAt": "2020-06-10T04:53:34Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {\n+                    logger.debug(\"The value of setting [{}] changed to [{}]\", KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    latestSettings.put(KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    // spawn a thread\n+                    KNNWeight.knnIndexCache.rebuild();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTgzNjQx", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#pullrequestreview-421183641", "createdAt": "2020-05-29T18:18:36Z", "commit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxODoxODozNlrOGcnWVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjozMDo1NVrOGh9JCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1ODAwNQ==", "bodyText": "I would say if you include quotes include the source. Also, I think this description can be expanded, or a link to the NMSLIB documentation that discusses it would be helpful. Here is a link", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r432658005", "createdAt": "2020-05-29T18:18:36Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -144,11 +144,12 @@ private void onRemoval(RemovalNotification<String, KNNIndexCacheEntry> removalNo\n      *\n      * @param key indexPath where the serialized hnsw graph is stored\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NDM2OQ==", "bodyText": "Yes, I agree once we have functionality to manually remove and load an index's graphs, we should implement a reload function that operates at the index level. For now, a TODO will be fine.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438254369", "createdAt": "2020-06-10T16:25:13Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {\n+                    logger.debug(\"The value of setting [{}] changed to [{}]\", KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    latestSettings.put(KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    // spawn a thread\n+                    KNNWeight.knnIndexCache.rebuild();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1OTIxNQ=="}, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NjI5Mg==", "bodyText": "Nit: Can you prepend log statement with \"[KNN] \" so that it is easier to identify when going through logs?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438256292", "createdAt": "2020-06-10T16:28:19Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {\n+                    logger.debug(\"The value of setting [{}] changed to [{}]\", KNN_ALGO_PARAM_EF_SEARCH, newVal);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NzkzMA==", "bodyText": "Just curious, what happens if a invalid parameter is passed in? Does it fail gracefully?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438257930", "createdAt": "2020-06-10T16:30:55Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a6a269f31d67862cd4b7bac5509ff86ec161c79", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6a6a269f31d67862cd4b7bac5509ff86ec161c79", "committedDate": "2020-06-10T21:53:58Z", "message": "MNT: comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "235683b92fb3e6a6ce8db37bdec1150a87f0d09c", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/235683b92fb3e6a6ce8db37bdec1150a87f0d09c", "committedDate": "2020-06-10T21:56:23Z", "message": "MNT: log statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c56d966cfef0dc57a9f682a0c76429a2ef59b41", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0c56d966cfef0dc57a9f682a0c76429a2ef59b41", "committedDate": "2020-06-10T22:03:05Z", "message": "TST: include invalid update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80b5dd0e468fbac2cba259e2a1d68beabd2fdaf1", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/80b5dd0e468fbac2cba259e2a1d68beabd2fdaf1", "committedDate": "2020-06-10T23:05:08Z", "message": "TST: cache miss for search after update setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c313fa08b5bd465c851136cd59f22e5e9c0d38e1", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/c313fa08b5bd465c851136cd59f22e5e9c0d38e1", "committedDate": "2020-06-10T23:17:22Z", "message": "FIX: old artifact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2424d7a4a3363bfb911cf93fc87f0ce75cf73717", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2424d7a4a3363bfb911cf93fc87f0ce75cf73717", "committedDate": "2020-06-10T23:25:57Z", "message": "RMV: unused setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "211c245c062e1a98a8c679b2e6cc245b457b3f57", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/211c245c062e1a98a8c679b2e6cc245b457b3f57", "committedDate": "2020-06-10T23:34:27Z", "message": "FIX: test logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aa1dc3c608afdd1c7580b814e3758d39ba3328b", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0aa1dc3c608afdd1c7580b814e3758d39ba3328b", "committedDate": "2020-06-10T23:36:06Z", "message": "MNT: comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTAwNDI3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#pullrequestreview-428500427", "createdAt": "2020-06-10T23:43:32Z", "commit": {"oid": "0aa1dc3c608afdd1c7580b814e3758d39ba3328b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMzo0MzozMlrOGiJ0fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDowMzozMlrOGiKLYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ2NTY2Mg==", "bodyText": "Great thanks", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438465662", "createdAt": "2020-06-10T23:43:32Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NzkzMA=="}, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3MTUyMw==", "bodyText": "I think the purpose of this test case is to confirm that the Index is evicted from the cache after the settings are updated. That being said, I think the test should be renamed testCacheRebuiltAfterUpdateIndexSettings.\nFurther more, instead of comparing deltas of hit and miss count, you can check that the cache is empty with the indices_in_cache stat. Then, you can just\n\nCreate index\nIndex sample docs\nSearch index\nConfirm index is present in cache\nUpdate index settings\nConfirm there are no indices in the cache.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438471523", "createdAt": "2020-06-11T00:03:32Z", "author": {"login": "jmazanec15"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNESSettingsTestIT.java", "diffHunk": "@@ -87,5 +91,73 @@ public void testCreateIndexWithInvalidSpaceType() throws IOException {\n             () -> createKnnIndex(INDEX_NAME, invalidSettings, createKnnIndexMapping(FIELD_NAME, 2)));\n         assertThat(ex.getMessage(), containsString(String.format(\"Unsupported space type: %s\", invalidSpaceType)));\n     }\n+\n+    public void testUpdateIndexSetting() throws IOException {\n+        Settings settings = Settings.builder()\n+                .put(\"index.knn\", true)\n+                .put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 512)\n+                .build();\n+        createKnnIndex(INDEX_NAME, settings, createKnnIndexMapping(FIELD_NAME, 2));\n+        assertEquals(\"512\", getIndexSettingByName(INDEX_NAME, KNNSettings.KNN_ALGO_PARAM_EF_SEARCH));\n+\n+        updateIndexSettings(INDEX_NAME, Settings.builder().put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 400));\n+        assertEquals(\"400\", getIndexSettingByName(INDEX_NAME, KNNSettings.KNN_ALGO_PARAM_EF_SEARCH));\n+\n+        Exception ex = expectThrows(ResponseException.class,\n+                () -> updateIndexSettings(INDEX_NAME,\n+                        Settings.builder().put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 1)));\n+        assertThat(ex.getMessage(),\n+                containsString(\"Failed to parse value [1] for setting [index.knn.algo_param.ef_search] must be >= 2\"));\n+    }\n+\n+    public void testKNNStatsAfterUpdateIndexSetting() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0aa1dc3c608afdd1c7580b814e3758d39ba3328b"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21f10c384ae1a96a0f15f31a800496ea6044d864", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/21f10c384ae1a96a0f15f31a800496ea6044d864", "committedDate": "2020-06-11T01:57:51Z", "message": "MAINT: simplify test logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTc1NDQ5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#pullrequestreview-428575449", "createdAt": "2020-06-11T03:55:48Z", "commit": {"oid": "21f10c384ae1a96a0f15f31a800496ea6044d864"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDg1NTYz", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#pullrequestreview-429485563", "createdAt": "2020-06-12T06:14:57Z", "commit": {"oid": "21f10c384ae1a96a0f15f31a800496ea6044d864"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1370, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}