{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNDM1OTk3", "number": 170, "title": "Add Github action to build library artifacts", "bodyText": "Issue #, if available:\n#169\nDescription of changes:\nThis PR changes how the ODFE library artifacts are compiled and shipped. Now, we use a CentOS 7 container to build the RPM and ZIP and an Ubuntu 16.04 container to build the DEB.\nIn order to test, I created a subset of the action in my own repository and confirmed the artifacts build for each container.\nTODO: Test artifacts that are built from containers.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-07-17T20:26:46Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170", "merged": true, "mergeCommit": {"oid": "62ea02a5e00a7617fc2fdd68740e8b190822d6a9"}, "closed": true, "closedAt": "2020-07-22T17:51:29Z", "author": {"login": "jmazanec15"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc12b3rgH2gAyNDUxNDM1OTk3OjEwZDczZTE2NzQzNmJmNjRiMWUzNzg5MmY2NmQ0YjMwMDViNTRjNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3dJ4_AFqTQ1MzQ2OTIwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "10d73e167436bf64b1e37892f66d4b3005b54c47", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/10d73e167436bf64b1e37892f66d4b3005b54c47", "committedDate": "2020-07-17T16:29:23Z", "message": "build libraries in containers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed5a3704fbc5f980de01194d8658b679dce78e3f", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ed5a3704fbc5f980de01194d8658b679dce78e3f", "committedDate": "2020-07-17T16:32:17Z", "message": "fix library artifact builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd8fde231ca9dead21ea3c446cdc5c56d3cea458", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/dd8fde231ca9dead21ea3c446cdc5c56d3cea458", "committedDate": "2020-07-17T19:33:47Z", "message": "fixed RPM/DEB/ZIP build and release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0584bd5dc12c9d11e15e6eaa063ba24640fc881", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f0584bd5dc12c9d11e15e6eaa063ba24640fc881", "committedDate": "2020-07-17T19:36:46Z", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into library-artifact-actions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "527e0097ddc0a3be327a1914f33a20818cf5c4aa", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/527e0097ddc0a3be327a1914f33a20818cf5c4aa", "committedDate": "2020-07-17T19:38:54Z", "message": "Update README with information about library artifacts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwOTQ0NTU4", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170#pullrequestreview-450944558", "createdAt": "2020-07-17T20:40:21Z", "commit": {"oid": "527e0097ddc0a3be327a1914f33a20818cf5c4aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMDo0MDoyMVrOGzgkJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMDo0MDoyMVrOGzgkJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2NDEwMg==", "bodyText": "As we discussed @jmazanec15 since CentOS have the lowest version of glibc, it would make sense to compile all distros of knnlib (zip/deb/rpm) in CentOS.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170#discussion_r456664102", "createdAt": "2020-07-17T20:40:21Z", "author": {"login": "peterzhuamazon"}, "path": ".github/workflows/CD.yml", "diffHunk": "@@ -68,3 +39,105 @@ jobs:\n           aws s3 cp $rpm_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/rpms/opendistro-knn/\n           aws s3 cp $deb_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/debs/opendistro-knn/\n           aws cloudfront create-invalidation --distribution-id E1VG5HMIWI4SA2 --paths \"/*\"\n+\n+  library-build-and-ship-zip-and-rpm:\n+    name: Build k-NN JNI Library for Zip and RPM\n+    runs-on: ubuntu-latest\n+    container:\n+      image: centos:7\n+    strategy:\n+      matrix:\n+        java: [14]\n+        compiler: [g++]\n+    steps:\n+      - name: Checkout k-NN\n+        uses: actions/checkout@v1\n+        with:\n+          submodules: true\n+\n+      - name: Configure AWS Credentials\n+        uses: aws-actions/configure-aws-credentials@v1\n+        with:\n+          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n+          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n+          aws-region: us-east-1\n+\n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+\n+      - name: Install dependencies\n+        run: |\n+          yum update -y\n+          yum install -y cmake rpm-build gcc-c++ make\n+\n+      - name: Build and ship library RPM and ZIP\n+        env:\n+          CXX: ${{ matrix.compiler }}\n+        run: |\n+          cd jni\n+          sed -i 's/-march=native/-march=x86-64/g' external/nmslib/similarity_search/CMakeLists.txt\n+          cmake .\n+          make package\n+\n+          cd packages\n+          folder_name=`ls ./*.rpm | sed 's|\\(.*\\)\\..*|\\1|'`\n+          zip_name=$folder_name\".zip\"\n+          mkdir $folder_name\n+          cp ../release/*.so $folder_name\n+          zip -r $zip_name $folder_name/*\n+          cd ..\n+\n+          zip_artifact=`ls packages/*.zip`\n+          rpm_artifact=`ls packages/*.rpm`\n+\n+          aws s3 cp $zip_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/opendistro-libs/opendistro-knnlib/\n+          aws s3 cp $rpm_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/rpms/opendistro-knnlib/\n+          aws cloudfront create-invalidation --distribution-id E1VG5HMIWI4SA2 --paths \"/*\"\n+\n+  library-build-and-ship-deb:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "527e0097ddc0a3be327a1914f33a20818cf5c4aa"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0688c5df0c661b5795eb02bf78e36ac50d394ca", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d0688c5df0c661b5795eb02bf78e36ac50d394ca", "committedDate": "2020-07-17T21:13:07Z", "message": "switch to centos for DEB"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab411494846dd359a511befc9fe5c39a337627dc", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ab411494846dd359a511befc9fe5c39a337627dc", "committedDate": "2020-07-17T22:46:56Z", "message": "updated centos to install dpkg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2284e4f15a09452dc883bf894af2cc66c4b86276", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2284e4f15a09452dc883bf894af2cc66c4b86276", "committedDate": "2020-07-17T22:48:33Z", "message": "add refresh repolist"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTg5MTEx", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170#pullrequestreview-452989111", "createdAt": "2020-07-22T04:40:10Z", "commit": {"oid": "2284e4f15a09452dc883bf894af2cc66c4b86276"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNDY5MjAz", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170#pullrequestreview-453469203", "createdAt": "2020-07-22T16:09:58Z", "commit": {"oid": "2284e4f15a09452dc883bf894af2cc66c4b86276"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1251, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}