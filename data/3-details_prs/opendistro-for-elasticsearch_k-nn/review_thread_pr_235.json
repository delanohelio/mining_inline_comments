{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjYwODg5", "number": 235, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzowMTozMVrOEl6A5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzoyNToyNVrOEmMKNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTgzMjY4OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzowMTozMVrOHVoyIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjoxOToyMVrOHWCQjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1MDMzOQ==", "bodyText": "Why we need OR condition why not just\n(int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == initialScriptCompilations + 1)", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492450339", "createdAt": "2020-09-22T03:01:31Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java", "diffHunk": "@@ -205,7 +207,8 @@ public void testScriptStats_singleShard() throws Exception {\n                 StatNames.SCRIPT_QUERY_REQUESTS.getName())\n         );\n         nodeStats = parseNodeStatsResponse(EntityUtils.toString(response.getEntity()));\n-        assertEquals(1, (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())));\n+        assertTrue((int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == 1 ||\n+                (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == initialScriptCompilations + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b052c70e82ffe8dad1bf143874d1fa03050f4bb7"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg2NzcyNA==", "bodyText": "Yes, this was an attempted workaround. SCRIPT_COMPILATIONS will only be incremented if the script has yet to be compiled.\nA better solution would be to clear the script cache before running the tests so that it is guaranteed that the script gets recompiled and SCRIPT_COMPILATIONS gets incremented by 1. I will update the PR.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492867724", "createdAt": "2020-09-22T16:19:21Z", "author": {"login": "jmazanec15"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java", "diffHunk": "@@ -205,7 +207,8 @@ public void testScriptStats_singleShard() throws Exception {\n                 StatNames.SCRIPT_QUERY_REQUESTS.getName())\n         );\n         nodeStats = parseNodeStatsResponse(EntityUtils.toString(response.getEntity()));\n-        assertEquals(1, (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())));\n+        assertTrue((int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == 1 ||\n+                (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == initialScriptCompilations + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1MDMzOQ=="}, "originalCommit": {"oid": "b052c70e82ffe8dad1bf143874d1fa03050f4bb7"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDgwNTY3OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzoyNToyNVrOHWEz_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo0MTo0M1rOHWHm5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwOTU2Nw==", "bodyText": "Is this line required?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492909567", "createdAt": "2020-09-22T17:25:25Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -543,6 +543,16 @@ protected void clearCache() throws Exception {\n         updateClusterSettings(KNNSettings.KNN_CACHE_ITEM_EXPIRY_TIME_MINUTES, null);\n     }\n \n+    /**\n+     * Clear script cache\n+     *\n+     * Remove k-NN script from script cache so that it has to be recompiled\n+     */\n+    protected void clearScriptCache() throws Exception {\n+        updateClusterSettings(\"script.context.score.cache_expire\", \"0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk0OTUwNA==", "bodyText": "Yes, this is what causes cache to evict the script. Here is documentation: https://www.elastic.co/guide/en/elasticsearch/reference/7.x/modules-scripting-using.html#modules-scripting-using-caching", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492949504", "createdAt": "2020-09-22T18:31:45Z", "author": {"login": "jmazanec15"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -543,6 +543,16 @@ protected void clearCache() throws Exception {\n         updateClusterSettings(KNNSettings.KNN_CACHE_ITEM_EXPIRY_TIME_MINUTES, null);\n     }\n \n+    /**\n+     * Clear script cache\n+     *\n+     * Remove k-NN script from script cache so that it has to be recompiled\n+     */\n+    protected void clearScriptCache() throws Exception {\n+        updateClusterSettings(\"script.context.score.cache_expire\", \"0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwOTU2Nw=="}, "originalCommit": {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1NTM2NA==", "bodyText": "Got it. Thanks", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492955364", "createdAt": "2020-09-22T18:41:43Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -543,6 +543,16 @@ protected void clearCache() throws Exception {\n         updateClusterSettings(KNNSettings.KNN_CACHE_ITEM_EXPIRY_TIME_MINUTES, null);\n     }\n \n+    /**\n+     * Clear script cache\n+     *\n+     * Remove k-NN script from script cache so that it has to be recompiled\n+     */\n+    protected void clearScriptCache() throws Exception {\n+        updateClusterSettings(\"script.context.score.cache_expire\", \"0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwOTU2Nw=="}, "originalCommit": {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2670, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}