{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MDIzODA5", "number": 162, "title": "Add Warmup API to load indices graphs into memory", "bodyText": "Issue #, if available:\n#135\nDescription of changes:\nThis PR adds a warmup API so that users can explicitly load graphs for their indices into memory.\nThe API looks like this:\nGET /_opendistro/_knn/warmup/<index 1>,<index 2>,\n{\n  \"_shards\" : {\n    \"total\" : 6,\n    \"successful\" : 6,\n    \"failed\" : 0\n  }\n}\n\nThis API uses TransportBroadcastByNodeAction to broadcast the request to all shards for the specified indices. In order to load a shard's graphs, we wrap IndexShard in KNNIndexShard to look up the HNSW files for that shard. Then, we take those HNSW files and load them into the cache.\nAdded integration and unit tests for the added components. Additionally, I created a ODFE 1.9 cluster with RPM and installed this plugin and ran tests against a larger data set.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-07-09T18:27:38Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162", "merged": true, "mergeCommit": {"oid": "af419ae82737ea6689b13f8d1ed253b7cdf9e20a"}, "closed": true, "closedAt": "2020-07-21T20:18:16Z", "author": {"login": "jmazanec15"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqc_g2gH2gAyNDQ3MDIzODA5OmFjZWM1ZDA2OGQyOTNmNDM5NTgyZDNhMWU3MWFmZjUzODI5NzE0ZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2_fQSgH2gAyNDQ3MDIzODA5OmI0NjVlMTAxMGIxMGNkZmMyYjMxOWJjNjZjZjRlZDY5ZTdiMWM5Zjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "acec5d068d293f439582d3a1e71aff53829714d4", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/acec5d068d293f439582d3a1e71aff53829714d4", "committedDate": "2020-06-12T06:37:37Z", "message": "PoC for warmup api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2435a51adc0a2505108c9783007e432fd65a9b84", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2435a51adc0a2505108c9783007e432fd65a9b84", "committedDate": "2020-06-24T17:21:30Z", "message": "warmup API enhancement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e41fdfc9c5141716c79b4b113479b8c760a312fb", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/e41fdfc9c5141716c79b4b113479b8c760a312fb", "committedDate": "2020-06-29T01:09:17Z", "message": "refactored transport layer for warmup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8f081461028aead63555e7e0fede64bd51b2dff", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f8f081461028aead63555e7e0fede64bd51b2dff", "committedDate": "2020-07-08T21:15:34Z", "message": "changed to use searcher for getting index reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a2df2f931f8d5d3e9655fa2ccb64e824adea794", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/7a2df2f931f8d5d3e9655fa2ccb64e824adea794", "committedDate": "2020-07-08T21:16:03Z", "message": "changed interace for loading multiple hnsw segments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78d8847d07c3876ca5c722ad2c528b5f3c696e1c", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/78d8847d07c3876ca5c722ad2c528b5f3c696e1c", "committedDate": "2020-07-08T21:16:34Z", "message": "minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "539314f13ffcf716f50dc300214be30c2b0e34f5", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/539314f13ffcf716f50dc300214be30c2b0e34f5", "committedDate": "2020-07-08T21:17:27Z", "message": "minor change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24a9840fd400c1ee805cfbdfd05881c9fb463b8", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f24a9840fd400c1ee805cfbdfd05881c9fb463b8", "committedDate": "2020-07-08T21:18:25Z", "message": "added test cases for warmup api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c41ba138f33940a4b947b111f4944b8e7da051f", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5c41ba138f33940a4b947b111f4944b8e7da051f", "committedDate": "2020-07-08T21:19:10Z", "message": "WIP: rest test cases for Warmup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f8eb5441a172d24a9b945e4d8d166bdd7025583", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0f8eb5441a172d24a9b945e4d8d166bdd7025583", "committedDate": "2020-07-08T21:24:13Z", "message": "remove unnecessary code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d24f0fcb261a6adec0dc64750adac1c9016a9c7a", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d24f0fcb261a6adec0dc64750adac1c9016a9c7a", "committedDate": "2020-07-08T21:24:23Z", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into warmup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "660ac1d4f106ba3c0fceed01d57971771510d23a", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/660ac1d4f106ba3c0fceed01d57971771510d23a", "committedDate": "2020-07-09T16:15:12Z", "message": "adding not k-NN index exception handling in rest layer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06c95dc18dbf36298547ebb1728ded9012bf04c1", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/06c95dc18dbf36298547ebb1728ded9012bf04c1", "committedDate": "2020-07-09T17:22:59Z", "message": "added rest test cases for warmup API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2812f87314f7c4e6d27a1b8db5185f02e23c1973", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2812f87314f7c4e6d27a1b8db5185f02e23c1973", "committedDate": "2020-07-09T17:45:59Z", "message": "added comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6b592b78dbacddd2f787fd1d2da9d791ae19724a", "committedDate": "2020-07-09T17:50:58Z", "message": "clean up comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NTYwNzM3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#pullrequestreview-446560737", "createdAt": "2020-07-10T17:06:07Z", "commit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzowNjowN1rOGv-4XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoxMDoyNFrOGv_ARw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NjQ5Mw==", "bodyText": "remove \"the Index\" and just leave \"the IndexShard\"?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r452966493", "createdAt": "2020-07-10T17:06:07Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexShard.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.codec.KNNCodecUtil;\n+import com.amazon.opendistroforelasticsearch.knn.index.v1736.KNNIndex;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.index.FilterLeafReader;\n+import org.apache.lucene.index.IndexReader;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SegmentInfo;\n+import org.apache.lucene.index.SegmentReader;\n+import org.elasticsearch.index.engine.Engine;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.index.shard.ShardPath;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * KNNIndexShard wraps IndexShard and adds methods to perform k-NN related operations against the shard\n+ */\n+public class KNNIndexShard {\n+    private IndexShard indexShard;\n+    private KNNIndexCache knnIndexCache;\n+\n+    private static Logger logger = LogManager.getLogger(KNNIndexShard.class);\n+\n+    /**\n+     * Constructor to generate KNNIndexShard. We do not perform validation that the Index the IndexShard is from", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODUxOQ==", "bodyText": "What if resolve(fileName) returns null?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r452968519", "createdAt": "2020-07-10T17:10:24Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexShard.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.codec.KNNCodecUtil;\n+import com.amazon.opendistroforelasticsearch.knn.index.v1736.KNNIndex;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.index.FilterLeafReader;\n+import org.apache.lucene.index.IndexReader;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SegmentInfo;\n+import org.apache.lucene.index.SegmentReader;\n+import org.elasticsearch.index.engine.Engine;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.index.shard.ShardPath;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * KNNIndexShard wraps IndexShard and adds methods to perform k-NN related operations against the shard\n+ */\n+public class KNNIndexShard {\n+    private IndexShard indexShard;\n+    private KNNIndexCache knnIndexCache;\n+\n+    private static Logger logger = LogManager.getLogger(KNNIndexShard.class);\n+\n+    /**\n+     * Constructor to generate KNNIndexShard. We do not perform validation that the Index the IndexShard is from\n+     * is in fact a k-NN Index (index.knn = true). This may make sense to add later, but for now the operations for\n+     * KNNIndexShards that are not from a k-NN index should be no-ops.\n+     *\n+     * @param indexShard IndexShard to be wrapped.\n+     */\n+    public KNNIndexShard(IndexShard indexShard) {\n+        this.indexShard = indexShard;\n+        this.knnIndexCache = KNNIndexCache.getInstance();\n+    }\n+\n+    /**\n+     * Return the underlying IndexShard\n+     *\n+     * @return IndexShard\n+     */\n+    public IndexShard getIndexShard() {\n+        return indexShard;\n+    }\n+\n+    /**\n+     * Return the name of the shards index\n+     *\n+     * @return Name of shard's index\n+     */\n+    public String getIndexName() {\n+        return indexShard.shardId().getIndexName();\n+    }\n+\n+    /**\n+     * Load all of the HNSW graphs for this shard into the cache. Note that getIndices is called to prevent loading\n+     * in duplicates.\n+     *\n+     * @return a List of KNNIndex's from this shard that are in the cache after this operation.\n+     * @throws IOException Thrown when getting the HNSW Paths to be loaded in\n+     */\n+    public List<KNNIndex> warmup() throws IOException {\n+        logger.info(\"[KNN] Warming up index: \" + getIndexName());\n+        Engine.Searcher searcher = indexShard.acquireSearcher(\"knn-warmup\");\n+        List<KNNIndex> indices;\n+        try {\n+            indices = knnIndexCache.getIndices(getHNSWPaths(searcher.getIndexReader()), getIndexName());\n+            searcher.close();\n+        } catch (IOException ex) {\n+            searcher.close();\n+            throw ex;\n+        }\n+        return indices;\n+    }\n+\n+    /**\n+     * For the given shard, get all of its HNSW paths\n+     *\n+     * @param indexReader IndexReader to read the file paths for the shard\n+     * @return List of HNSW Paths\n+     * @throws IOException Thrown when the SegmentReader is attempting to read the segments files\n+     */\n+    public List<String> getHNSWPaths(IndexReader indexReader) throws IOException {\n+        List<String> hnswFiles = new ArrayList<>();\n+        for (LeafReaderContext leafReaderContext : indexReader.leaves()) {\n+            SegmentReader reader = (SegmentReader) FilterLeafReader.unwrap(leafReaderContext.reader());\n+            hnswFiles.addAll(reader.getSegmentInfo().files().stream()\n+                    .filter(fileName -> fileName.endsWith(getHNSWFileExtension(reader.getSegmentInfo().info)))\n+                    .map(fileName -> shardPath().resolveIndex().resolve(fileName).toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 110}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODA3MzMy", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#pullrequestreview-447807332", "createdAt": "2020-07-14T05:56:13Z", "commit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNTo1NjoxM1rOGxFPKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNjoxODoyOVrOGxFuhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExOTIxMA==", "bodyText": "class doc missing", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454119210", "createdAt": "2020-07-14T05:56:13Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/transport/KNNWarmupResponse.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.transport;\n+\n+import org.elasticsearch.action.support.DefaultShardOperationFailedException;\n+import org.elasticsearch.action.support.broadcast.BroadcastResponse;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+public class KNNWarmupResponse extends BroadcastResponse implements ToXContentObject {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExOTI3OA==", "bodyText": "class doc missing. You might want to take care in other places as wel", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454119278", "createdAt": "2020-07-14T05:56:26Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/transport/KNNWarmupRequest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.transport;\n+\n+import org.elasticsearch.action.support.broadcast.BroadcastRequest;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+\n+import java.io.IOException;\n+\n+public class KNNWarmupRequest extends BroadcastRequest<KNNWarmupRequest> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMDEyMQ==", "bodyText": "+1 for making it async.\nwe could log here saying that warm up initiated. Should we capture the number of warmup requests in the knn stats?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454120121", "createdAt": "2020-07-14T05:59:02Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/rest/RestKNNWarmupHandler.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.rest;\n+\n+import com.amazon.opendistroforelasticsearch.knn.common.exception.KNNInvalidIndexException;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.KNNPlugin;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupAction;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupRequest;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.amazon.opendistroforelasticsearch.knn.index.KNNSettings.KNN_INDEX;\n+import static org.elasticsearch.action.support.IndicesOptions.strictExpandOpen;\n+\n+/**\n+ * RestHandler for k-NN index warmup API. API provides the ability for a user to load specific indices' k-NN graphs\n+ * into memory.\n+ */\n+public class RestKNNWarmupHandler extends BaseRestHandler {\n+    public static String NAME = \"knn_warmup_action\";\n+\n+    private IndexNameExpressionResolver indexNameExpressionResolver;\n+    private ClusterService clusterService;\n+\n+    public RestKNNWarmupHandler(Settings settings, RestController controller, ClusterService clusterService,\n+                                IndexNameExpressionResolver indexNameExpressionResolver) {\n+        this.clusterService = clusterService;\n+        this.indexNameExpressionResolver = indexNameExpressionResolver;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return ImmutableList.of(\n+                new Route(RestRequest.Method.GET, KNNPlugin.KNN_BASE_URI + \"/warmup/{index}\")\n+        );\n+    }\n+\n+    @Override\n+    protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) {\n+        KNNWarmupRequest knnWarmupRequest = createKNNWarmupRequest(request);\n+        return channel -> client.execute(KNNWarmupAction.INSTANCE, knnWarmupRequest, new RestToXContentListener<>(channel));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMTI2Ng==", "bodyText": "We could update log to tell the exact setting name. How about below message\n\nthrow new KNNInvalidIndexException(index.getName(),\n\"Warmup request rejected as one of the index has 'index.knn' setting set to false\");\n\n\nShould we loop through the indices and mention full list of indices that are invalid instead of exiting on the first error?\n\n\nHow about making indexNames from String array to set and pass this as a ImmutableSet to KNNWarmupRequest. This was we could avoid duplicates.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454121266", "createdAt": "2020-07-14T06:02:16Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/rest/RestKNNWarmupHandler.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.rest;\n+\n+import com.amazon.opendistroforelasticsearch.knn.common.exception.KNNInvalidIndexException;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.KNNPlugin;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupAction;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupRequest;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.amazon.opendistroforelasticsearch.knn.index.KNNSettings.KNN_INDEX;\n+import static org.elasticsearch.action.support.IndicesOptions.strictExpandOpen;\n+\n+/**\n+ * RestHandler for k-NN index warmup API. API provides the ability for a user to load specific indices' k-NN graphs\n+ * into memory.\n+ */\n+public class RestKNNWarmupHandler extends BaseRestHandler {\n+    public static String NAME = \"knn_warmup_action\";\n+\n+    private IndexNameExpressionResolver indexNameExpressionResolver;\n+    private ClusterService clusterService;\n+\n+    public RestKNNWarmupHandler(Settings settings, RestController controller, ClusterService clusterService,\n+                                IndexNameExpressionResolver indexNameExpressionResolver) {\n+        this.clusterService = clusterService;\n+        this.indexNameExpressionResolver = indexNameExpressionResolver;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return ImmutableList.of(\n+                new Route(RestRequest.Method.GET, KNNPlugin.KNN_BASE_URI + \"/warmup/{index}\")\n+        );\n+    }\n+\n+    @Override\n+    protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) {\n+        KNNWarmupRequest knnWarmupRequest = createKNNWarmupRequest(request);\n+        return channel -> client.execute(KNNWarmupAction.INSTANCE, knnWarmupRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    private KNNWarmupRequest createKNNWarmupRequest(RestRequest request) {\n+        String[] indexNames = Strings.splitStringByCommaToArray(request.param(\"index\"));\n+        Index[] indices =  indexNameExpressionResolver.concreteIndices(clusterService.state(), strictExpandOpen(),\n+                indexNames);\n+\n+        Arrays.stream(indices).forEach(index -> {\n+            if (!\"true\".equals(clusterService.state().metadata().getIndexSafe(index).getSettings().get(KNN_INDEX))) {\n+                throw new KNNInvalidIndexException(index.getName(),\n+                        \"Unable to create warmup index that has 'knn' setting set to false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMjY5OQ==", "bodyText": "if indexNames empty, return from here with proper log message?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454122699", "createdAt": "2020-07-14T06:06:21Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/rest/RestKNNWarmupHandler.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.rest;\n+\n+import com.amazon.opendistroforelasticsearch.knn.common.exception.KNNInvalidIndexException;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.KNNPlugin;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupAction;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupRequest;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.amazon.opendistroforelasticsearch.knn.index.KNNSettings.KNN_INDEX;\n+import static org.elasticsearch.action.support.IndicesOptions.strictExpandOpen;\n+\n+/**\n+ * RestHandler for k-NN index warmup API. API provides the ability for a user to load specific indices' k-NN graphs\n+ * into memory.\n+ */\n+public class RestKNNWarmupHandler extends BaseRestHandler {\n+    public static String NAME = \"knn_warmup_action\";\n+\n+    private IndexNameExpressionResolver indexNameExpressionResolver;\n+    private ClusterService clusterService;\n+\n+    public RestKNNWarmupHandler(Settings settings, RestController controller, ClusterService clusterService,\n+                                IndexNameExpressionResolver indexNameExpressionResolver) {\n+        this.clusterService = clusterService;\n+        this.indexNameExpressionResolver = indexNameExpressionResolver;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return ImmutableList.of(\n+                new Route(RestRequest.Method.GET, KNNPlugin.KNN_BASE_URI + \"/warmup/{index}\")\n+        );\n+    }\n+\n+    @Override\n+    protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) {\n+        KNNWarmupRequest knnWarmupRequest = createKNNWarmupRequest(request);\n+        return channel -> client.execute(KNNWarmupAction.INSTANCE, knnWarmupRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    private KNNWarmupRequest createKNNWarmupRequest(RestRequest request) {\n+        String[] indexNames = Strings.splitStringByCommaToArray(request.param(\"index\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNDMxNQ==", "bodyText": "is getRestHandlers always called after getMappers? Making sure clusterService is not null.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454124315", "createdAt": "2020-07-14T06:10:49Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/KNNPlugin.java", "diffHunk": "@@ -143,8 +148,10 @@\n                                              Supplier<DiscoveryNodes> nodesInCluster) {\n \n         RestKNNStatsHandler restKNNStatsHandler = new RestKNNStatsHandler(settings, restController, knnStats);\n+        RestKNNWarmupHandler restKNNWarmupHandler = new RestKNNWarmupHandler(settings, restController, clusterService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNzIzOA==", "bodyText": "move searcher.close() to finally block and you could remove from catch", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454127238", "createdAt": "2020-07-14T06:18:29Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexShard.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.codec.KNNCodecUtil;\n+import com.amazon.opendistroforelasticsearch.knn.index.v1736.KNNIndex;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.index.FilterLeafReader;\n+import org.apache.lucene.index.IndexReader;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SegmentInfo;\n+import org.apache.lucene.index.SegmentReader;\n+import org.elasticsearch.index.engine.Engine;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.index.shard.ShardPath;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * KNNIndexShard wraps IndexShard and adds methods to perform k-NN related operations against the shard\n+ */\n+public class KNNIndexShard {\n+    private IndexShard indexShard;\n+    private KNNIndexCache knnIndexCache;\n+\n+    private static Logger logger = LogManager.getLogger(KNNIndexShard.class);\n+\n+    /**\n+     * Constructor to generate KNNIndexShard. We do not perform validation that the Index the IndexShard is from\n+     * is in fact a k-NN Index (index.knn = true). This may make sense to add later, but for now the operations for\n+     * KNNIndexShards that are not from a k-NN index should be no-ops.\n+     *\n+     * @param indexShard IndexShard to be wrapped.\n+     */\n+    public KNNIndexShard(IndexShard indexShard) {\n+        this.indexShard = indexShard;\n+        this.knnIndexCache = KNNIndexCache.getInstance();\n+    }\n+\n+    /**\n+     * Return the underlying IndexShard\n+     *\n+     * @return IndexShard\n+     */\n+    public IndexShard getIndexShard() {\n+        return indexShard;\n+    }\n+\n+    /**\n+     * Return the name of the shards index\n+     *\n+     * @return Name of shard's index\n+     */\n+    public String getIndexName() {\n+        return indexShard.shardId().getIndexName();\n+    }\n+\n+    /**\n+     * Load all of the HNSW graphs for this shard into the cache. Note that getIndices is called to prevent loading\n+     * in duplicates.\n+     *\n+     * @return a List of KNNIndex's from this shard that are in the cache after this operation.\n+     * @throws IOException Thrown when getting the HNSW Paths to be loaded in\n+     */\n+    public List<KNNIndex> warmup() throws IOException {\n+        logger.info(\"[KNN] Warming up index: \" + getIndexName());\n+        Engine.Searcher searcher = indexShard.acquireSearcher(\"knn-warmup\");\n+        List<KNNIndex> indices;\n+        try {\n+            indices = knnIndexCache.getIndices(getHNSWPaths(searcher.getIndexReader()), getIndexName());\n+            searcher.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd541947f88aca92c0a759bc8bae300f589922ae", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/bd541947f88aca92c0a759bc8bae300f589922ae", "committedDate": "2020-07-15T21:19:18Z", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into warmup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c60cd080a5be02c531c10f3bfc0d1401a303d5dc", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/c60cd080a5be02c531c10f3bfc0d1401a303d5dc", "committedDate": "2020-07-15T22:56:38Z", "message": "add end line to file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5859f19bbafc6e89e2987d08e8a2eef66065211b", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5859f19bbafc6e89e2987d08e8a2eef66065211b", "committedDate": "2020-07-15T23:05:47Z", "message": "minor style/comment fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a29b1eec81ae90e845259260c7d58ac2afa508", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f9a29b1eec81ae90e845259260c7d58ac2afa508", "committedDate": "2020-07-15T23:42:37Z", "message": "added class doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e01bcf9176c04348eb96683068617e7250c8726", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5e01bcf9176c04348eb96683068617e7250c8726", "committedDate": "2020-07-15T23:45:17Z", "message": "added end lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "219fe2fed478ebc1be583a994a89bd9b7ad8e7de", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/219fe2fed478ebc1be583a994a89bd9b7ad8e7de", "committedDate": "2020-07-16T17:21:38Z", "message": "enhanced logging and exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "477f35781bb1f92a0ab3ef5257906dde3aecea32", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/477f35781bb1f92a0ab3ef5257906dde3aecea32", "committedDate": "2020-07-16T17:21:49Z", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into warmup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5aa1e6f0d44511b2bd71b6e4170199d3d59b9af", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b5aa1e6f0d44511b2bd71b6e4170199d3d59b9af", "committedDate": "2020-07-16T18:01:32Z", "message": "update NMSLIB version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMTEzMjE1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#pullrequestreview-450113215", "createdAt": "2020-07-16T18:37:26Z", "commit": {"oid": "b5aa1e6f0d44511b2bd71b6e4170199d3d59b9af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "843527ee357161bad89ee96c24ba925d33baff26", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/843527ee357161bad89ee96c24ba925d33baff26", "committedDate": "2020-07-16T21:16:48Z", "message": "updated README with warmup API info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMjI3MTY4", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#pullrequestreview-450227168", "createdAt": "2020-07-16T21:24:41Z", "commit": {"oid": "843527ee357161bad89ee96c24ba925d33baff26"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMToyNDo0MVrOGy9UFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMToyNDo0MVrOGy9UFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NjU1MQ==", "bodyText": "Minor: In places where we mention memory should we be explicit calling native memory or off-heap to set context where the graphs are actually loaded?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r456086551", "createdAt": "2020-07-16T21:24:41Z", "author": {"login": "vamshin"}, "path": "README.md", "diffHunk": "@@ -404,6 +404,35 @@ GET /_opendistro/_knn/HYMrXXsBSamUkcAjhjeN0w/stats/circuit_breaker_triggered,gra\n }\n ```\n \n+## Warmup API\n+### Overview\n+The HNSW graphs used to perform k-Approximate Nearest Neighbor Search are stored as `.hnsw` files with the other Lucene segment files. In order to perform search on these graphs, they need to be loaded into memory. If the graphs have not yet been loaded into memory, upon search, they will first be loaded and then searched. This can cause high latency during initial queries. To avoid this, users will often run random queries during a warmup period. After this warmup period, the graphs will be loaded into memory and their production workloads can begin. This process is indirect and requires extra effort. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "843527ee357161bad89ee96c24ba925d33baff26"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "379bd4e04ceddd6c3c16dece8bd0b16f2727ce34", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/379bd4e04ceddd6c3c16dece8bd0b16f2727ce34", "committedDate": "2020-07-16T21:28:25Z", "message": "minor change to warmup API documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMjMyNTQy", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#pullrequestreview-450232542", "createdAt": "2020-07-16T21:34:18Z", "commit": {"oid": "379bd4e04ceddd6c3c16dece8bd0b16f2727ce34"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMTozNDoxOFrOGy9lPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMTozNDoxOFrOGy9lPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA5MDk0Mg==", "bodyText": "Should we also call out Idempotency with the warmup api? warmup api ensures only the graphs belonging to the segments that did not get loaded are loaded to memory. Existing graphs would be untouched?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r456090942", "createdAt": "2020-07-16T21:34:18Z", "author": {"login": "vamshin"}, "path": "README.md", "diffHunk": "@@ -404,6 +404,35 @@ GET /_opendistro/_knn/HYMrXXsBSamUkcAjhjeN0w/stats/circuit_breaker_triggered,gra\n }\n ```\n \n+## Warmup API\n+### Overview\n+The HNSW graphs used to perform k-Approximate Nearest Neighbor Search are stored as `.hnsw` files with the other Lucene segment files. In order to perform search on these graphs, they need to be loaded into native memory. If the graphs have not yet been loaded into native memory, upon search, they will first be loaded and then searched. This can cause high latency during initial queries. To avoid this, users will often run random queries during a warmup period. After this warmup period, the graphs will be loaded into native memory and their production workloads can begin. This process is indirect and requires extra effort. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "379bd4e04ceddd6c3c16dece8bd0b16f2727ce34"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b08b20cb7db4ef855a06780ce0c962a19a6be61", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/4b08b20cb7db4ef855a06780ce0c962a19a6be61", "committedDate": "2020-07-16T22:09:42Z", "message": "update warmup api docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODg0ODI0", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#pullrequestreview-451884824", "createdAt": "2020-07-20T19:10:58Z", "commit": {"oid": "4b08b20cb7db4ef855a06780ce0c962a19a6be61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ce10088574171b4a6d6213f21be48039754921a", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6ce10088574171b4a6d6213f21be48039754921a", "committedDate": "2020-07-20T20:57:42Z", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into warmup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b465e1010b10cdfc2b319bc66cf4ed69e7b1c9f8", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b465e1010b10cdfc2b319bc66cf4ed69e7b1c9f8", "committedDate": "2020-07-21T05:36:09Z", "message": "clean up loadIndex"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1247, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}