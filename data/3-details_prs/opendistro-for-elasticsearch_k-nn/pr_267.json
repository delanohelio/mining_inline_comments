{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NjcyMzky", "number": 267, "title": "Support for hamming bit distance in custom scoring", "bodyText": "Issue #, if available:\n#264\nDescription of changes:\nThis PR extends custom scoring to support hamming distance on binary data. The PR allows hamming distance to be applied to Long and Binary Elasticsearch fields. With the Long fieldType, a user will be able to encode up to 64 bits of data as a signed long using Elasticsearch's Long fieldtype. Here is an example query:\nPOST /myindex/_search\n{\n \"size\": 4,\n \"query\": {\n   \"script_score\": {\n     \"query\": {\n       \"match_all\": {}\n     },\n     \"script\": {\n       \"source\": \"knn_score\",\n       \"lang\": \"knn\",\n       \"params\": {\n         \"field\": \"my_long\",\n         \"query_value\": 170,\n         \"space_type\": \"hammingbit\"\n       }\n     }\n   }\n }\n}\n\nI experimented with using long arrays to extend the number of bits a user can encode past 64 bits. However, because Elasticsearch doc values are not guaranteed to be in the order they were ingested in, we would have to use the \"_source\" field to accomplish this, which would add performance penalties.\nIn addition to supporting the Long type, a user can also run hamming distance k-NN search with Elasticsearch's binary field type on arbitrarily sized data. The binary field type uses Base64 encoding scheme. An example query would look like this:\nPOST /myindex2/_search\n{\n \"size\": 2,\n \"query\": {\n   \"script_score\": {\n     \"query\": {\n       \"match_all\": {}\n     },\n     \"script\": {\n       \"source\": \"knn_score\",\n       \"lang\": \"knn\",\n       \"params\": {\n         \"field\": \"my_binary\",\n         \"query_value\": \"q83vQUI=\",\n         \"space_type\": \"hammingbit\"\n       }\n     }\n   }\n }\n}\n\nA third possibility would be for a user to provide a hex encoded string as the binary representation of their data. However, because it would be difficult to validate this format during indexing, it could prove difficult for usage. For that reason, I did not include it in this PR. However, if there is community interest in that, I could look into it further.\nI changed several other components of the custom scoring implementation in order to support types other than KNNVectors. Additionally, I moved as much of the query validation/parsing out of the execute portion of the scripts as I could to improve performance.\nLastly, I changed the parameter for passing the query value from \"vector\" to \"query_value\" in order to generalize parsing. I was hoping to get some thoughts/opinions on this.\nIf a user wants to perform an r-NN search, where results are only returned if they meet a certain score, they can use Elasticsearch's min_score parameter.\nFor testing, I created a single node cluster based off of ODFE 1.11, and installed my changes onto it. I ran the testing script attached to the PR a few times to validate recall and performance (hamming_test.txt). Additionally, I added several unit and integration tests.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-12T07:07:36Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267", "merged": true, "mergeCommit": {"oid": "a174fc7e492988519e73861f98c6037e21680ff0"}, "closed": true, "closedAt": "2020-11-25T23:53:43Z", "author": {"login": "jmazanec15"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQWep0gH2gAyNTE5NjcyMzkyOmNmNDIzMDEyNTZlODNjOGVjY2EzZGUyN2Q4MTZiODBlZTlhNzM3NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgHRt9AFqTUzODkwOTc1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf42301256e83c8ecca3de27d816b80ee9a73766", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/cf42301256e83c8ecca3de27d816b80ee9a73766", "committedDate": "2020-10-08T00:31:25Z", "message": "initial changes to support hamming distance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "891a1705da026689644e6053ca6c30af49e3f6bf", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/891a1705da026689644e6053ca6c30af49e3f6bf", "committedDate": "2020-10-08T16:42:18Z", "message": "Rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af70594585896fbbaf12b4759c6ae7e7ddff1407", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/af70594585896fbbaf12b4759c6ae7e7ddff1407", "committedDate": "2020-10-08T16:43:33Z", "message": "update hamming distance to use BigInteger and hex_embeddings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dccd9dede3afc8521f1a2ca20867be48accd9b4e", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/dccd9dede3afc8521f1a2ca20867be48accd9b4e", "committedDate": "2020-10-19T16:57:18Z", "message": "update hamming distance of base64 and long types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1510bf076afed39aab3c1e5712f4b991ea41e9aa", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1510bf076afed39aab3c1e5712f4b991ea41e9aa", "committedDate": "2020-10-19T20:46:10Z", "message": "a bit of refactoring of hamming distance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96a2065366f3a46dc47748ffca1ba21df6015f94", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/96a2065366f3a46dc47748ffca1ba21df6015f94", "committedDate": "2020-10-23T17:43:42Z", "message": "cast to correct ScriptDocValues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44f8036024094cb51e1f6b4c4a42add8e8fa2c53", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/44f8036024094cb51e1f6b4c4a42add8e8fa2c53", "committedDate": "2020-10-23T17:47:18Z", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/k-NN into hamming-support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ea4288752a74622407630b02d13a2f0b573ed3e", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/9ea4288752a74622407630b02d13a2f0b573ed3e", "committedDate": "2020-11-05T22:50:10Z", "message": "refactor scoring for hamming distance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01611e17a1d850c2bc38e032d6410d93a6402406", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/01611e17a1d850c2bc38e032d6410d93a6402406", "committedDate": "2020-11-07T00:12:54Z", "message": "Refactor scoring logic to couple script logic only with doc values type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174f38762a69ad3c4e9a48c7fa645298de4bfbbd", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/174f38762a69ad3c4e9a48c7fa645298de4bfbbd", "committedDate": "2020-11-07T00:51:05Z", "message": "add back binary encoding for hamming distance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7647c40a79e304a951f62a0880d52b88b5fbf396", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/7647c40a79e304a951f62a0880d52b88b5fbf396", "committedDate": "2020-11-10T19:22:29Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd78da58432a59757fbc746170f5b5a59c05a15", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ffd78da58432a59757fbc746170f5b5a59c05a15", "committedDate": "2020-11-11T19:24:55Z", "message": "revert list long to long"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89d28c53208c4c0d3e0669f3c62627d844bafda2", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/89d28c53208c4c0d3e0669f3c62627d844bafda2", "committedDate": "2020-11-11T19:35:54Z", "message": "remove log statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1db15a66ed45b8738cc5c92070ef833335e5418", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/a1db15a66ed45b8738cc5c92070ef833335e5418", "committedDate": "2020-11-11T21:16:52Z", "message": "rename classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700f4939bce93a04a6b3eecc303055e9c9f31f6e", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/700f4939bce93a04a6b3eecc303055e9c9f31f6e", "committedDate": "2020-11-12T00:29:27Z", "message": "rename scripts -> script for tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f189991feeed9bfe6edbe9a6cd416785fbf95ba", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1f189991feeed9bfe6edbe9a6cd416785fbf95ba", "committedDate": "2020-11-12T00:30:07Z", "message": "intial commit for testing hamming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4069e966ab3356f407d7ae7b0ba776e64d411be6", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/4069e966ab3356f407d7ae7b0ba776e64d411be6", "committedDate": "2020-11-12T04:01:31Z", "message": "minor formatting change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfca4cf1580a2c23a1b2f16697d1b8ea3579187a", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/bfca4cf1580a2c23a1b2f16697d1b8ea3579187a", "committedDate": "2020-11-12T06:34:55Z", "message": "add more test cases for hamming distance support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "413c3272c31d4344ea0c16ea1b209fe1e3222259", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/413c3272c31d4344ea0c16ea1b209fe1e3222259", "committedDate": "2020-11-12T17:40:09Z", "message": "remove unused constants"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/9cb28bf738d1512357ba7af09c46f66d064689c9", "committedDate": "2020-11-12T17:40:37Z", "message": "stylistic fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MzYzNjcy", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-529363672", "createdAt": "2020-11-12T18:17:24Z", "commit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODoxNzoyNFrOHyHthg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTo0NzozMVrOHyLa2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxNzE5MA==", "bodyText": "may be LongType?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522317190", "createdAt": "2020-11-12T18:17:24Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoreScript.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.BitSet;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+/**\n+ * KNNScoreScript is used for adjusting the score of query results based on similarity distance methods. Scripts\n+ * operate on a per document basis. Because the scoring method is passed in during construction, KNNScoreScripts are\n+ * only concerned with the types of the query and docs being processed.\n+ */\n+public abstract class KNNScoreScript<T> extends ScoreScript {\n+    protected final T queryValue;\n+    protected final String field;\n+    protected final BiFunction<T, T, Float> scoringMethod;\n+\n+    public KNNScoreScript(Map<String, Object> params, T queryValue, String field,\n+                          BiFunction<T, T, Float> scoringMethod, SearchLookup lookup, LeafReaderContext leafContext) {\n+        super(params, lookup, leafContext);\n+        this.queryValue = queryValue;\n+        this.field = field;\n+        this.scoringMethod = scoringMethod;\n+    }\n+\n+    /**\n+     * KNNScoreScript with Long type. The query value passed in as well as the DocValues being searched over are\n+     * expected to be Longs.\n+     */\n+    public static class Longs extends KNNScoreScript<Long> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxNzIzMw==", "bodyText": "Q: cosinesimil is one word without underscore while bit_hamming is not, so any reason why it is different from cosinesimil?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522317233", "createdAt": "2020-11-12T18:17:28Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/util/KNNConstants.java", "diffHunk": "@@ -23,5 +23,6 @@\n     public static final String HNSW_ALGO_INDEX_THREAD_QTY = \"indexThreadQty\";\n     public static final String L2 = \"l2\";\n     public static final String COSINESIMIL = \"cosinesimil\";\n+    public static final String BIT_HAMMING = \"bit_hamming\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxODIwOQ==", "bodyText": "same as above", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522318209", "createdAt": "2020-11-12T18:19:01Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoreScript.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.util.BitSet;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+/**\n+ * KNNScoreScript is used for adjusting the score of query results based on similarity distance methods. Scripts\n+ * operate on a per document basis. Because the scoring method is passed in during construction, KNNScoreScripts are\n+ * only concerned with the types of the query and docs being processed.\n+ */\n+public abstract class KNNScoreScript<T> extends ScoreScript {\n+    protected final T queryValue;\n+    protected final String field;\n+    protected final BiFunction<T, T, Float> scoringMethod;\n+\n+    public KNNScoreScript(Map<String, Object> params, T queryValue, String field,\n+                          BiFunction<T, T, Float> scoringMethod, SearchLookup lookup, LeafReaderContext leafContext) {\n+        super(params, lookup, leafContext);\n+        this.queryValue = queryValue;\n+        this.field = field;\n+        this.scoringMethod = scoringMethod;\n+    }\n+\n+    /**\n+     * KNNScoreScript with Long type. The query value passed in as well as the DocValues being searched over are\n+     * expected to be Longs.\n+     */\n+    public static class Longs extends KNNScoreScript<Long> {\n+        /**\n+         * This function calculates the similarity score for each doc in the segment.\n+         *\n+         * @param explanationHolder A helper to take in an explanation from a script and turn\n+         *                          it into an {@link org.apache.lucene.search.Explanation}\n+         * @return score for the provided space between the doc and the query\n+         */\n+        @Override\n+        public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+            ScriptDocValues.Longs scriptDocValues = (ScriptDocValues.Longs) getDoc().get(this.field);\n+            if (scriptDocValues.size() == 0) {\n+                return Float.MIN_VALUE;\n+            }\n+            return this.scoringMethod.apply(this.queryValue, scriptDocValues.getValue());\n+        }\n+\n+        public Longs(Map<String, Object> params, Long queryValue, String field,\n+                    BiFunction<Long, Long, Float> scoringMethod, SearchLookup lookup, LeafReaderContext leafContext) {\n+            super(params, queryValue, field, scoringMethod, lookup, leafContext);\n+        }\n+    }\n+\n+    /**\n+     * KNNScoreScript with BitSet type. The query value passed in as well as the DocValues being searched over\n+     * are expected to be BitSets.\n+     */\n+    public static class BitSets extends KNNScoreScript<BitSet> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMDEyMQ==", "bodyText": "It is always better to  do constant.equalsIgnoreCase(variable) to avoid null pointer exception.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522330121", "createdAt": "2020-11-12T18:38:20Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringSpaceFactory.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+/**\n+ * Factory to create correct KNNScoringSpace based on the spaceType passed in.\n+ */\n+public class KNNScoringSpaceFactory {\n+    public static KNNScoringSpace getSpace(String spaceType, Object query, MappedFieldType mappedFieldType) {\n+        if (spaceType.equalsIgnoreCase(KNNConstants.BIT_HAMMING)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMDY4MA==", "bodyText": "Also you don't need else if, since you are returning inside if.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522330680", "createdAt": "2020-11-12T18:39:17Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringSpaceFactory.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+/**\n+ * Factory to create correct KNNScoringSpace based on the spaceType passed in.\n+ */\n+public class KNNScoringSpaceFactory {\n+    public static KNNScoringSpace getSpace(String spaceType, Object query, MappedFieldType mappedFieldType) {\n+        if (spaceType.equalsIgnoreCase(KNNConstants.BIT_HAMMING)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzNDE4Nw==", "bodyText": "calculateHammingDistance?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522334187", "createdAt": "2020-11-12T18:44:56Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -73,6 +89,30 @@ public static float cosinesimil(float[] queryVector, float[] inputVector) {\n         return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n     }\n \n+\n+    /**\n+     * This method calculates hamming distance on 2 BitSets\n+     *\n+     * @param queryBits query BitSet\n+     * @param inputBits input BitSet\n+     * @return hamming distance\n+     */\n+    public static float bitHamming(BitSet queryBits, BitSet inputBits) {\n+        inputBits.xor(queryBits);\n+        return inputBits.cardinality();\n+    }\n+\n+    /**\n+     * This method calculates hamming distance on 2 longs\n+     *\n+     * @param queryLong query Long\n+     * @param inputLong input Long\n+     * @return hamming distance\n+     */\n+    public static float bitHamming(Long queryLong, Long inputLong) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzNTcxMg==", "bodyText": "do we need assert here? method says Add a single numeric field Doc to an index. If it is part of test method, may be we can assert inside actual test method instead of helper method. What do you think?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522335712", "createdAt": "2020-11-12T18:47:28Z", "author": {"login": "VijayanB"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -356,6 +356,28 @@ protected void addDocWithNumericField(String index, String docId, String fieldNa\n                 RestStatus.fromCode(response.getStatusLine().getStatusCode()));\n     }\n \n+    /**\n+     * Add a single numeric field Doc to an index\n+     */\n+    protected void addDocWithBinaryField(String index, String docId, String fieldName, String base64String)\n+            throws IOException {\n+        Request request = new Request(\n+                \"POST\",\n+                \"/\" + index + \"/_doc/\" + docId + \"?refresh=true\"\n+        );\n+\n+        XContentBuilder builder = XContentFactory.jsonBuilder().startObject()\n+                .field(fieldName, base64String)\n+                .endObject();\n+\n+        request.setJsonEntity(Strings.toString(builder));\n+\n+        Response response = client().performRequest(request);\n+\n+        assertEquals(request.getEndpoint() + \": failed\", RestStatus.CREATED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzNzg5Mg==", "bodyText": "is it possible to refer from constant?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522337892", "createdAt": "2020-11-12T18:51:04Z", "author": {"login": "VijayanB"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -572,4 +594,26 @@ protected Request constructKNNScriptQueryRequest(String indexName, QueryBuilder\n         request.setJsonEntity(Strings.toString(builder));\n         return request;\n     }\n+\n+    protected Request constructKNNScriptQueryRequest(String indexName, QueryBuilder qb, Map<String, Object> params,\n+                                                     int size) throws Exception {\n+        Script script = new Script(Script.DEFAULT_SCRIPT_TYPE, KNNScoringScriptEngine.NAME, KNNScoringScriptEngine.SCRIPT_SOURCE, params);\n+        ScriptScoreQueryBuilder sc = new ScriptScoreQueryBuilder(qb, script);\n+        XContentBuilder builder = XContentFactory.jsonBuilder().startObject()\n+                .field(\"size\", size)\n+                .startObject(\"query\");\n+        builder.startObject(\"script_score\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0MjAxOA==", "bodyText": "no need of else if since you are returning inside if.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522342018", "createdAt": "2020-11-12T18:57:54Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringSpace.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.KNNVectorFieldMapper;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.index.mapper.BinaryFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.NumberFieldMapper;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.BitSet;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+import static org.elasticsearch.index.mapper.NumberFieldMapper.NumberType.LONG;\n+\n+/**\n+ * KNNScoringSpace is used to validate/prepare a user provided query and similarity space for knn scripting execution\n+ * and provide the correct KNNScoringScript.\n+ */\n+public abstract class KNNScoringSpace {\n+\n+    protected Object processedQuery;\n+    protected BiFunction<?, ?, Float> scoringMethod;\n+    protected MappedFieldType fieldType;\n+\n+    public KNNScoringSpace(Object query, MappedFieldType fieldType) {\n+        this.fieldType = fieldType;\n+        prepareQuery(query);\n+    }\n+\n+    /**\n+     * Prepare the query and the scoring method for the given FieldType and similarity space. When preparing these\n+     * properties, the fieldType and the spaceType will dictate if they are validated and how they are processed. This\n+     * method has the responsibility of ensuring that the query and scoring method that will be used when scoring the\n+     * docs in an index is compatible.\n+     *\n+     * @param query Raw query object passed in to be validated and processed for the given similarity space\n+     */\n+    protected abstract void prepareQuery(Object query);\n+\n+    protected boolean isLongFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof NumberFieldMapper.NumberFieldType\n+                && ((NumberFieldMapper.NumberFieldType) fieldType).numericType() == LONG.numericType();\n+    }\n+\n+    protected boolean isBinaryFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof BinaryFieldMapper.BinaryFieldType;\n+    }\n+\n+    protected boolean isKNNVectorFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof KNNVectorFieldMapper.KNNVectorFieldType;\n+    }\n+\n+    protected Long parseLongQuery(Object query) {\n+        /*\n+         * Because there is no way to specify the type of integral that is passed in during query, it is necessary to\n+         * cast it to a Long here.\n+         */\n+        Long processedQueryLong;\n+        if (query instanceof Integer) {\n+            processedQueryLong = Long.valueOf((Integer) query);\n+        } else if (query instanceof Long) {\n+            processedQueryLong = (Long) query;\n+        } else {\n+            throw new IllegalArgumentException(\"Incompatible query_value for hamming space. query_value must \" +\n+                    \"be either a Long or an Integer.\");\n+        }\n+\n+        return processedQueryLong;\n+    }\n+\n+    protected BitSet parseBinaryQuery(Object query) {\n+        return BitSet.valueOf(Base64.getDecoder().decode((String) query));\n+    }\n+\n+    protected float[] parseKNNVectorQuery(Object query) {\n+        float[] parsedQuery = KNNScoringUtil.convertVectorToPrimitive(query);\n+        if (((KNNVectorFieldMapper.KNNVectorFieldType) fieldType).getDimension() != parsedQuery.length) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalStateException(\"[KNN] query vector and field vector dimensions mismatch. \" +\n+                    \"query vector: \" + parsedQuery.length + \", stored vector: \" +\n+                    ((KNNVectorFieldMapper.KNNVectorFieldType) fieldType).getDimension());\n+        }\n+        return parsedQuery;\n+    }\n+\n+    /**\n+     * Return the correct scoring script for a given query. The scoring script\n+     *\n+     * @param params Map of parameters\n+     * @param field Fieldname\n+     * @param lookup SearchLookup\n+     * @param ctx ctx LeafReaderContext to be used for scoring documents\n+     * @return ScoreScript for this query\n+     * @throws IOException throws IOException if ScoreScript cannot be constructed\n+     */\n+    public abstract ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                               LeafReaderContext ctx) throws IOException;\n+\n+    public static class L2 extends KNNScoringSpace {\n+\n+        public L2(Object query, MappedFieldType fieldType) {\n+            super(query, fieldType);\n+        }\n+\n+        @Override\n+        protected void prepareQuery(Object query) {\n+            if (!isKNNVectorFieldType(fieldType)) {\n+                throw new IllegalArgumentException(\"Incompatible field_type for l2 space. The field type must \" +\n+                        \"be knn_vector.\");\n+            }\n+\n+            this.processedQuery = parseKNNVectorQuery(query);\n+            this.scoringMethod = (float[] q, float[] v) -> 1 / (1 + KNNScoringUtil.l2Squared(q, v));\n+        }\n+\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                          LeafReaderContext ctx) throws IOException {\n+            return new KNNScoreScript.KNNVectors(params, (float[]) processedQuery, field,\n+                    (BiFunction<float[], float[], Float>) this.scoringMethod, lookup, ctx);\n+\n+        }\n+    }\n+\n+    public static class CosineSimilarity extends KNNScoringSpace {\n+\n+        public CosineSimilarity(Object query, MappedFieldType fieldType) {\n+            super(query, fieldType);\n+        }\n+\n+        @Override\n+        protected void prepareQuery(Object query) {\n+            if (!(fieldType instanceof KNNVectorFieldMapper.KNNVectorFieldType)) {\n+                throw new IllegalArgumentException(\"Incompatible field_type for cosine space. The field type must \" +\n+                        \"be knn_vector.\");\n+            }\n+\n+            this.processedQuery = parseKNNVectorQuery(query);\n+            float qVectorSquaredMagnitude = KNNScoringUtil.getVectorMagnitudeSquared((float[]) this.processedQuery);\n+            this.scoringMethod = (float[] q, float[] v) -> 1 + KNNScoringUtil.cosinesimilOptimized(q, v,\n+                    qVectorSquaredMagnitude);\n+        }\n+\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                          LeafReaderContext ctx) throws IOException {\n+                return new KNNScoreScript.KNNVectors(params, (float[]) processedQuery, field,\n+                        (BiFunction<float[], float[], Float>) this.scoringMethod, lookup, ctx);\n+        }\n+    }\n+\n+    public static class HammingBit extends KNNScoringSpace {\n+        public HammingBit(Object query, MappedFieldType fieldType) {\n+            super(query, fieldType);\n+        }\n+\n+        @Override\n+        protected void prepareQuery(Object query) {\n+            if (isLongFieldType(fieldType)) {\n+                this.processedQuery = parseLongQuery(query);\n+                this.scoringMethod = (Long q, Long v) -> 1.0f / (1 + KNNScoringUtil.bitHamming(q, v));\n+            } else if (isBinaryFieldType(fieldType)) {\n+                this.processedQuery = parseBinaryQuery(query);\n+                this.scoringMethod = (BitSet q, BitSet v) -> 1.0f / (1 + KNNScoringUtil.bitHamming(q, v));\n+            } else {\n+                throw new IllegalArgumentException(\"Incompatible field_type for hamming space. The field type must \" +\n+                        \"of type long or binary.\");\n+            }\n+        }\n+\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                          LeafReaderContext ctx) throws IOException {\n+            if (isLongFieldType(fieldType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 197}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0MzY0NA==", "bodyText": "I believe L2 is Euclidean distance, may be name class as Euclidean?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522343644", "createdAt": "2020-11-12T19:00:37Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringSpace.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.KNNVectorFieldMapper;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.index.mapper.BinaryFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.NumberFieldMapper;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.BitSet;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+import static org.elasticsearch.index.mapper.NumberFieldMapper.NumberType.LONG;\n+\n+/**\n+ * KNNScoringSpace is used to validate/prepare a user provided query and similarity space for knn scripting execution\n+ * and provide the correct KNNScoringScript.\n+ */\n+public abstract class KNNScoringSpace {\n+\n+    protected Object processedQuery;\n+    protected BiFunction<?, ?, Float> scoringMethod;\n+    protected MappedFieldType fieldType;\n+\n+    public KNNScoringSpace(Object query, MappedFieldType fieldType) {\n+        this.fieldType = fieldType;\n+        prepareQuery(query);\n+    }\n+\n+    /**\n+     * Prepare the query and the scoring method for the given FieldType and similarity space. When preparing these\n+     * properties, the fieldType and the spaceType will dictate if they are validated and how they are processed. This\n+     * method has the responsibility of ensuring that the query and scoring method that will be used when scoring the\n+     * docs in an index is compatible.\n+     *\n+     * @param query Raw query object passed in to be validated and processed for the given similarity space\n+     */\n+    protected abstract void prepareQuery(Object query);\n+\n+    protected boolean isLongFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof NumberFieldMapper.NumberFieldType\n+                && ((NumberFieldMapper.NumberFieldType) fieldType).numericType() == LONG.numericType();\n+    }\n+\n+    protected boolean isBinaryFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof BinaryFieldMapper.BinaryFieldType;\n+    }\n+\n+    protected boolean isKNNVectorFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof KNNVectorFieldMapper.KNNVectorFieldType;\n+    }\n+\n+    protected Long parseLongQuery(Object query) {\n+        /*\n+         * Because there is no way to specify the type of integral that is passed in during query, it is necessary to\n+         * cast it to a Long here.\n+         */\n+        Long processedQueryLong;\n+        if (query instanceof Integer) {\n+            processedQueryLong = Long.valueOf((Integer) query);\n+        } else if (query instanceof Long) {\n+            processedQueryLong = (Long) query;\n+        } else {\n+            throw new IllegalArgumentException(\"Incompatible query_value for hamming space. query_value must \" +\n+                    \"be either a Long or an Integer.\");\n+        }\n+\n+        return processedQueryLong;\n+    }\n+\n+    protected BitSet parseBinaryQuery(Object query) {\n+        return BitSet.valueOf(Base64.getDecoder().decode((String) query));\n+    }\n+\n+    protected float[] parseKNNVectorQuery(Object query) {\n+        float[] parsedQuery = KNNScoringUtil.convertVectorToPrimitive(query);\n+        if (((KNNVectorFieldMapper.KNNVectorFieldType) fieldType).getDimension() != parsedQuery.length) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalStateException(\"[KNN] query vector and field vector dimensions mismatch. \" +\n+                    \"query vector: \" + parsedQuery.length + \", stored vector: \" +\n+                    ((KNNVectorFieldMapper.KNNVectorFieldType) fieldType).getDimension());\n+        }\n+        return parsedQuery;\n+    }\n+\n+    /**\n+     * Return the correct scoring script for a given query. The scoring script\n+     *\n+     * @param params Map of parameters\n+     * @param field Fieldname\n+     * @param lookup SearchLookup\n+     * @param ctx ctx LeafReaderContext to be used for scoring documents\n+     * @return ScoreScript for this query\n+     * @throws IOException throws IOException if ScoreScript cannot be constructed\n+     */\n+    public abstract ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                               LeafReaderContext ctx) throws IOException;\n+\n+    public static class L2 extends KNNScoringSpace {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3Mzk3Mw==", "bodyText": "why isLongFieldType/isBinaryFieldType/isKNNVectorFieldType are protected?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522373973", "createdAt": "2020-11-12T19:40:54Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringSpace.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.KNNVectorFieldMapper;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.index.mapper.BinaryFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.NumberFieldMapper;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.BitSet;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+import static org.elasticsearch.index.mapper.NumberFieldMapper.NumberType.LONG;\n+\n+/**\n+ * KNNScoringSpace is used to validate/prepare a user provided query and similarity space for knn scripting execution\n+ * and provide the correct KNNScoringScript.\n+ */\n+public abstract class KNNScoringSpace {\n+\n+    protected Object processedQuery;\n+    protected BiFunction<?, ?, Float> scoringMethod;\n+    protected MappedFieldType fieldType;\n+\n+    public KNNScoringSpace(Object query, MappedFieldType fieldType) {\n+        this.fieldType = fieldType;\n+        prepareQuery(query);\n+    }\n+\n+    /**\n+     * Prepare the query and the scoring method for the given FieldType and similarity space. When preparing these\n+     * properties, the fieldType and the spaceType will dictate if they are validated and how they are processed. This\n+     * method has the responsibility of ensuring that the query and scoring method that will be used when scoring the\n+     * docs in an index is compatible.\n+     *\n+     * @param query Raw query object passed in to be validated and processed for the given similarity space\n+     */\n+    protected abstract void prepareQuery(Object query);\n+\n+    protected boolean isLongFieldType(MappedFieldType fieldType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3Nzk0Nw==", "bodyText": "why not make processedQuery as method and do validation inside it? it is kind of dangerous to call protected method inside constructor because you are calling an instance method before creating an instance.\nIMO, KNNScoringSpace can be made interface and make helper method in a different class.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522377947", "createdAt": "2020-11-12T19:47:31Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringSpace.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.KNNVectorFieldMapper;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.index.mapper.BinaryFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.NumberFieldMapper;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.BitSet;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+import static org.elasticsearch.index.mapper.NumberFieldMapper.NumberType.LONG;\n+\n+/**\n+ * KNNScoringSpace is used to validate/prepare a user provided query and similarity space for knn scripting execution\n+ * and provide the correct KNNScoringScript.\n+ */\n+public abstract class KNNScoringSpace {\n+\n+    protected Object processedQuery;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDQ2ODY2", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-529446866", "createdAt": "2020-11-12T19:58:43Z", "commit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTo1ODo0M1rOHyL0dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTo1ODo0M1rOHyL0dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4NDUwMw==", "bodyText": "may be createScoringSpace or create instead of get?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522384503", "createdAt": "2020-11-12T19:58:43Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringSpaceFactory.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.util.KNNConstants;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+/**\n+ * Factory to create correct KNNScoringSpace based on the spaceType passed in.\n+ */\n+public class KNNScoringSpaceFactory {\n+    public static KNNScoringSpace getSpace(String spaceType, Object query, MappedFieldType mappedFieldType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDQ5MDcz", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-529449073", "createdAt": "2020-11-12T20:01:23Z", "commit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDowMToyM1rOHyL7YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDowMToyM1rOHyL7YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4NjI3Mg==", "bodyText": "is this even required since the fieldType is already tested in parseQuery?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r522386272", "createdAt": "2020-11-12T20:01:23Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringSpace.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.KNNVectorFieldMapper;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.index.mapper.BinaryFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.NumberFieldMapper;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.BitSet;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+import static org.elasticsearch.index.mapper.NumberFieldMapper.NumberType.LONG;\n+\n+/**\n+ * KNNScoringSpace is used to validate/prepare a user provided query and similarity space for knn scripting execution\n+ * and provide the correct KNNScoringScript.\n+ */\n+public abstract class KNNScoringSpace {\n+\n+    protected Object processedQuery;\n+    protected BiFunction<?, ?, Float> scoringMethod;\n+    protected MappedFieldType fieldType;\n+\n+    public KNNScoringSpace(Object query, MappedFieldType fieldType) {\n+        this.fieldType = fieldType;\n+        prepareQuery(query);\n+    }\n+\n+    /**\n+     * Prepare the query and the scoring method for the given FieldType and similarity space. When preparing these\n+     * properties, the fieldType and the spaceType will dictate if they are validated and how they are processed. This\n+     * method has the responsibility of ensuring that the query and scoring method that will be used when scoring the\n+     * docs in an index is compatible.\n+     *\n+     * @param query Raw query object passed in to be validated and processed for the given similarity space\n+     */\n+    protected abstract void prepareQuery(Object query);\n+\n+    protected boolean isLongFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof NumberFieldMapper.NumberFieldType\n+                && ((NumberFieldMapper.NumberFieldType) fieldType).numericType() == LONG.numericType();\n+    }\n+\n+    protected boolean isBinaryFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof BinaryFieldMapper.BinaryFieldType;\n+    }\n+\n+    protected boolean isKNNVectorFieldType(MappedFieldType fieldType) {\n+        return fieldType instanceof KNNVectorFieldMapper.KNNVectorFieldType;\n+    }\n+\n+    protected Long parseLongQuery(Object query) {\n+        /*\n+         * Because there is no way to specify the type of integral that is passed in during query, it is necessary to\n+         * cast it to a Long here.\n+         */\n+        Long processedQueryLong;\n+        if (query instanceof Integer) {\n+            processedQueryLong = Long.valueOf((Integer) query);\n+        } else if (query instanceof Long) {\n+            processedQueryLong = (Long) query;\n+        } else {\n+            throw new IllegalArgumentException(\"Incompatible query_value for hamming space. query_value must \" +\n+                    \"be either a Long or an Integer.\");\n+        }\n+\n+        return processedQueryLong;\n+    }\n+\n+    protected BitSet parseBinaryQuery(Object query) {\n+        return BitSet.valueOf(Base64.getDecoder().decode((String) query));\n+    }\n+\n+    protected float[] parseKNNVectorQuery(Object query) {\n+        float[] parsedQuery = KNNScoringUtil.convertVectorToPrimitive(query);\n+        if (((KNNVectorFieldMapper.KNNVectorFieldType) fieldType).getDimension() != parsedQuery.length) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalStateException(\"[KNN] query vector and field vector dimensions mismatch. \" +\n+                    \"query vector: \" + parsedQuery.length + \", stored vector: \" +\n+                    ((KNNVectorFieldMapper.KNNVectorFieldType) fieldType).getDimension());\n+        }\n+        return parsedQuery;\n+    }\n+\n+    /**\n+     * Return the correct scoring script for a given query. The scoring script\n+     *\n+     * @param params Map of parameters\n+     * @param field Fieldname\n+     * @param lookup SearchLookup\n+     * @param ctx ctx LeafReaderContext to be used for scoring documents\n+     * @return ScoreScript for this query\n+     * @throws IOException throws IOException if ScoreScript cannot be constructed\n+     */\n+    public abstract ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                               LeafReaderContext ctx) throws IOException;\n+\n+    public static class L2 extends KNNScoringSpace {\n+\n+        public L2(Object query, MappedFieldType fieldType) {\n+            super(query, fieldType);\n+        }\n+\n+        @Override\n+        protected void prepareQuery(Object query) {\n+            if (!isKNNVectorFieldType(fieldType)) {\n+                throw new IllegalArgumentException(\"Incompatible field_type for l2 space. The field type must \" +\n+                        \"be knn_vector.\");\n+            }\n+\n+            this.processedQuery = parseKNNVectorQuery(query);\n+            this.scoringMethod = (float[] q, float[] v) -> 1 / (1 + KNNScoringUtil.l2Squared(q, v));\n+        }\n+\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                          LeafReaderContext ctx) throws IOException {\n+            return new KNNScoreScript.KNNVectors(params, (float[]) processedQuery, field,\n+                    (BiFunction<float[], float[], Float>) this.scoringMethod, lookup, ctx);\n+\n+        }\n+    }\n+\n+    public static class CosineSimilarity extends KNNScoringSpace {\n+\n+        public CosineSimilarity(Object query, MappedFieldType fieldType) {\n+            super(query, fieldType);\n+        }\n+\n+        @Override\n+        protected void prepareQuery(Object query) {\n+            if (!(fieldType instanceof KNNVectorFieldMapper.KNNVectorFieldType)) {\n+                throw new IllegalArgumentException(\"Incompatible field_type for cosine space. The field type must \" +\n+                        \"be knn_vector.\");\n+            }\n+\n+            this.processedQuery = parseKNNVectorQuery(query);\n+            float qVectorSquaredMagnitude = KNNScoringUtil.getVectorMagnitudeSquared((float[]) this.processedQuery);\n+            this.scoringMethod = (float[] q, float[] v) -> 1 + KNNScoringUtil.cosinesimilOptimized(q, v,\n+                    qVectorSquaredMagnitude);\n+        }\n+\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                          LeafReaderContext ctx) throws IOException {\n+                return new KNNScoreScript.KNNVectors(params, (float[]) processedQuery, field,\n+                        (BiFunction<float[], float[], Float>) this.scoringMethod, lookup, ctx);\n+        }\n+    }\n+\n+    public static class HammingBit extends KNNScoringSpace {\n+        public HammingBit(Object query, MappedFieldType fieldType) {\n+            super(query, fieldType);\n+        }\n+\n+        @Override\n+        protected void prepareQuery(Object query) {\n+            if (isLongFieldType(fieldType)) {\n+                this.processedQuery = parseLongQuery(query);\n+                this.scoringMethod = (Long q, Long v) -> 1.0f / (1 + KNNScoringUtil.bitHamming(q, v));\n+            } else if (isBinaryFieldType(fieldType)) {\n+                this.processedQuery = parseBinaryQuery(query);\n+                this.scoringMethod = (BitSet q, BitSet v) -> 1.0f / (1 + KNNScoringUtil.bitHamming(q, v));\n+            } else {\n+                throw new IllegalArgumentException(\"Incompatible field_type for hamming space. The field type must \" +\n+                        \"of type long or binary.\");\n+            }\n+        }\n+\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public ScoreScript getScoreScript(Map<String, Object> params, String field, SearchLookup lookup,\n+                                          LeafReaderContext ctx) throws IOException {\n+            if (isLongFieldType(fieldType)) {\n+                return new KNNScoreScript.Longs(params, (Long) this.processedQuery, field,\n+                        (BiFunction<Long, Long, Float>) this.scoringMethod, lookup, ctx);\n+            } else if (isBinaryFieldType(fieldType)) {\n+                return new KNNScoreScript.BitSets(params, (BitSet) this.processedQuery, field,\n+                        (BiFunction<BitSet, BitSet, Float>) this.scoringMethod, lookup, ctx);\n+            } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cb28bf738d1512357ba7af09c46f66d064689c9"}, "originalPosition": 203}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65d5644445963faf08ed36920aba358189704992", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/65d5644445963faf08ed36920aba358189704992", "committedDate": "2020-11-13T02:16:56Z", "message": "switch hamming binary to use BigInteger instead of BitSet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/86f1f388ee8e1894fb6e7a27e45101ecb21f741c", "committedDate": "2020-11-13T02:48:42Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMzM4NjA3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-530338607", "createdAt": "2020-11-13T19:15:18Z", "commit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOToxNToxOFrOHy7zGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOToxNToxOFrOHy7zGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE3MDU4Ng==", "bodyText": "nit: can we move this close to class?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r523170586", "createdAt": "2020-11-13T19:15:18Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoreScript.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.math.BigInteger;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+/**\n+ * KNNScoreScript is used for adjusting the score of query results based on similarity distance methods. Scripts\n+ * operate on a per document basis. Because the scoring method is passed in during construction, KNNScoreScripts are\n+ * only concerned with the types of the query and docs being processed.\n+ */\n+public abstract class KNNScoreScript<T> extends ScoreScript {\n+    protected final T queryValue;\n+    protected final String field;\n+    protected final BiFunction<T, T, Float> scoringMethod;\n+\n+    public KNNScoreScript(Map<String, Object> params, T queryValue, String field,\n+                          BiFunction<T, T, Float> scoringMethod, SearchLookup lookup, LeafReaderContext leafContext) {\n+        super(params, lookup, leafContext);\n+        this.queryValue = queryValue;\n+        this.field = field;\n+        this.scoringMethod = scoringMethod;\n+    }\n+\n+    /**\n+     * KNNScoreScript with Long type. The query value passed in as well as the DocValues being searched over are\n+     * expected to be Longs.\n+     */\n+    public static class LongType extends KNNScoreScript<Long> {\n+        /**\n+         * This function calculates the similarity score for each doc in the segment.\n+         *\n+         * @param explanationHolder A helper to take in an explanation from a script and turn\n+         *                          it into an {@link org.apache.lucene.search.Explanation}\n+         * @return score for the provided space between the doc and the query\n+         */\n+        @Override\n+        public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+            ScriptDocValues.Longs scriptDocValues = (ScriptDocValues.Longs) getDoc().get(this.field);\n+            if (scriptDocValues.size() == 0) {\n+                return Float.MIN_VALUE;\n+            }\n+            return this.scoringMethod.apply(this.queryValue, scriptDocValues.getValue());\n+        }\n+\n+        public LongType(Map<String, Object> params, Long queryValue, String field,\n+                    BiFunction<Long, Long, Float> scoringMethod, SearchLookup lookup, LeafReaderContext leafContext) {\n+            super(params, queryValue, field, scoringMethod, lookup, leafContext);\n+        }\n+    }\n+\n+    /**\n+     * KNNScoreScript with BigInteger type. The query value passed in as well as the DocValues being searched over\n+     * are expected to be BigInteger.\n+     */\n+    public static class BigIntegerType extends KNNScoreScript<BigInteger> {\n+        /**\n+         * This function calculates the similarity score for each doc in the segment.\n+         *\n+         * @param explanationHolder A helper to take in an explanation from a script and turn\n+         *                          it into an {@link org.apache.lucene.search.Explanation}\n+         * @return score for the provided space between the doc and the query\n+         */\n+        @Override\n+        public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+            ScriptDocValues.BytesRefs scriptDocValues = (ScriptDocValues.BytesRefs) getDoc().get(this.field);\n+            if (scriptDocValues.size() == 0) {\n+                return Float.MIN_VALUE;\n+            }\n+            return this.scoringMethod.apply(this.queryValue, new BigInteger(1, scriptDocValues.getValue().bytes));\n+        }\n+\n+        public BigIntegerType(Map<String, Object> params, BigInteger queryValue, String field,\n+                           BiFunction<BigInteger, BigInteger, Float> scoringMethod, SearchLookup lookup,\n+                           LeafReaderContext leafContext) {\n+            super(params, queryValue, field, scoringMethod, lookup, leafContext);\n+        }\n+    }\n+\n+    /**\n+     * KNNVectors with float[] type. The query value passed in is expected to be float[]. The fieldType of the docs\n+     * being searched over are expected to be KNNVector type.\n+     */\n+    public static class KNNVectorType extends KNNScoreScript<float[]> {\n+        private BinaryDocValues binaryDocValuesReader;\n+        private boolean vectorExist = true;\n+\n+        /**\n+         * This function called for each doc in the segment. We evaluate the score of the vector in the doc\n+         *\n+         * @param explanationHolder A helper to take in an explanation from a script and turn\n+         *                          it into an {@link org.apache.lucene.search.Explanation}\n+         * @return score of the vector to the query vector\n+         */\n+        @Override\n+        public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+            // If this document does not contain the vector, push it to end of the results.\n+            if (!vectorExist) {\n+                return Float.MIN_VALUE;\n+            }\n+\n+            try {\n+                float[] docVector;\n+                BytesRef bytesref = binaryDocValuesReader.binaryValue();\n+                try (ByteArrayInputStream byteStream = new ByteArrayInputStream(bytesref.bytes, bytesref.offset,\n+                        bytesref.length); ObjectInputStream objectStream = new ObjectInputStream(byteStream)) {\n+                    docVector = (float[]) objectStream.readObject();\n+                } catch (ClassNotFoundException e) {\n+                    KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+                    throw new RuntimeException(e);\n+                }\n+\n+                return this.scoringMethod.apply(queryValue, docVector);\n+            } catch (IOException e) {\n+                KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+                throw new UncheckedIOException(e);\n+            }\n+        }\n+\n+        @Override\n+        public void setDocument(int docId) {\n+            try {\n+                this.vectorExist = this.binaryDocValuesReader.advanceExact(docId);\n+            } catch (IOException e) {\n+                throw new UncheckedIOException(e);\n+            }\n+        }\n+\n+        public KNNVectorType(Map<String, Object> params, float[] queryValue, String field,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "originalPosition": 156}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDYxMzQ3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-530461347", "createdAt": "2020-11-13T22:38:28Z", "commit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMjozODoyOFrOHzB03g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMjozODoyOFrOHzB03g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2OTM0Mg==", "bodyText": "What do you think about following format?\n    public KNNScoreScriptFactory(Map<String, Object> params, SearchLookup lookup) {\n     KNNCounter.SCRIPT_QUERY_REQUESTS.increment();\n     this.params = params;\n     this.lookup = lookup;\n     this.field = getValue(params, \"field\")\n     similaritySpace = getValue(params, \"space_type\")\n     this.knnScoringSpace = KNNScoringSpaceFactory.create(similaritySpace, this.query,\n            lookup.doc().mapperService().fieldType(this.field));\n\n}\n\n private Object getValue(Map<String, Object> params, String fieldName) {\n    final Object value = params.get(fieldName);\n    if (value != null) \n     return value.toString();\n   KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n   throw new IllegalArgumentException(\"Missing parameter [\"+ fieldName +\"]\");\n  }", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r523269342", "createdAt": "2020-11-13T22:38:28Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoreScriptFactory.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+public class KNNScoreScriptFactory implements ScoreScript.LeafFactory {\n+    private final Map<String, Object> params;\n+    private final SearchLookup lookup;\n+    private String similaritySpace;\n+    private String field;\n+    private Object query;\n+    private KNNScoringSpace knnScoringSpace;\n+\n+    public KNNScoreScriptFactory(Map<String, Object> params, SearchLookup lookup) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTQ4NDQx", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-530548441", "createdAt": "2020-11-14T02:56:13Z", "commit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMjo1NjoxM1rOHzHtpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMjo1NjoxM1rOHzHtpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM2NTc5OQ==", "bodyText": "needsScore", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r523365799", "createdAt": "2020-11-14T02:56:13Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoreScriptFactory.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+public class KNNScoreScriptFactory implements ScoreScript.LeafFactory {\n+    private final Map<String, Object> params;\n+    private final SearchLookup lookup;\n+    private String similaritySpace;\n+    private String field;\n+    private Object query;\n+    private KNNScoringSpace knnScoringSpace;\n+\n+    public KNNScoreScriptFactory(Map<String, Object> params, SearchLookup lookup) {\n+        KNNCounter.SCRIPT_QUERY_REQUESTS.increment();\n+        this.params = params;\n+        this.lookup = lookup;\n+\n+        parseParameters();\n+\n+        this.knnScoringSpace = KNNScoringSpaceFactory.create(this.similaritySpace, this.query,\n+                lookup.doc().mapperService().fieldType(this.field));\n+\n+    }\n+\n+    private void parseParameters() {\n+        final Object field = params.get(\"field\");\n+        if (field == null) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalArgumentException(\"Missing parameter [field]\");\n+        }\n+\n+        this.field = field.toString();\n+\n+        final Object space = params.get(\"space_type\");\n+        if (space == null) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalArgumentException(\"Missing parameter [space_type]\");\n+        }\n+\n+        this.similaritySpace = space.toString();\n+\n+        final Object queryValue = params.get(\"query_value\");\n+        if (queryValue == null) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalArgumentException(\"Missing parameter [query_value]\");\n+        }\n+        this.query = queryValue;\n+    }\n+\n+    public boolean needs_score() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTQ4NzQ1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-530548745", "createdAt": "2020-11-14T03:00:53Z", "commit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMzowMDo1NFrOHzHvWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMzowMDo1NFrOHzHvWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM2NjIzNQ==", "bodyText": "nit: does scriptDocValues has isEmpty method?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r523366235", "createdAt": "2020-11-14T03:00:54Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoreScript.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.UncheckedIOException;\n+import java.math.BigInteger;\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+/**\n+ * KNNScoreScript is used for adjusting the score of query results based on similarity distance methods. Scripts\n+ * operate on a per document basis. Because the scoring method is passed in during construction, KNNScoreScripts are\n+ * only concerned with the types of the query and docs being processed.\n+ */\n+public abstract class KNNScoreScript<T> extends ScoreScript {\n+    protected final T queryValue;\n+    protected final String field;\n+    protected final BiFunction<T, T, Float> scoringMethod;\n+\n+    public KNNScoreScript(Map<String, Object> params, T queryValue, String field,\n+                          BiFunction<T, T, Float> scoringMethod, SearchLookup lookup, LeafReaderContext leafContext) {\n+        super(params, lookup, leafContext);\n+        this.queryValue = queryValue;\n+        this.field = field;\n+        this.scoringMethod = scoringMethod;\n+    }\n+\n+    /**\n+     * KNNScoreScript with Long type. The query value passed in as well as the DocValues being searched over are\n+     * expected to be Longs.\n+     */\n+    public static class LongType extends KNNScoreScript<Long> {\n+        /**\n+         * This function calculates the similarity score for each doc in the segment.\n+         *\n+         * @param explanationHolder A helper to take in an explanation from a script and turn\n+         *                          it into an {@link org.apache.lucene.search.Explanation}\n+         * @return score for the provided space between the doc and the query\n+         */\n+        @Override\n+        public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+            ScriptDocValues.Longs scriptDocValues = (ScriptDocValues.Longs) getDoc().get(this.field);\n+            if (scriptDocValues.size() == 0) {\n+                return Float.MIN_VALUE;\n+            }\n+            return this.scoringMethod.apply(this.queryValue, scriptDocValues.getValue());\n+        }\n+\n+        public LongType(Map<String, Object> params, Long queryValue, String field,\n+                    BiFunction<Long, Long, Float> scoringMethod, SearchLookup lookup, LeafReaderContext leafContext) {\n+            super(params, queryValue, field, scoringMethod, lookup, leafContext);\n+        }\n+    }\n+\n+    /**\n+     * KNNScoreScript with BigInteger type. The query value passed in as well as the DocValues being searched over\n+     * are expected to be BigInteger.\n+     */\n+    public static class BigIntegerType extends KNNScoreScript<BigInteger> {\n+        /**\n+         * This function calculates the similarity score for each doc in the segment.\n+         *\n+         * @param explanationHolder A helper to take in an explanation from a script and turn\n+         *                          it into an {@link org.apache.lucene.search.Explanation}\n+         * @return score for the provided space between the doc and the query\n+         */\n+        @Override\n+        public double execute(ScoreScript.ExplanationHolder explanationHolder) {\n+            ScriptDocValues.BytesRefs scriptDocValues = (ScriptDocValues.BytesRefs) getDoc().get(this.field);\n+            if (scriptDocValues.size() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTQ4ODY3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-530548867", "createdAt": "2020-11-14T03:03:00Z", "commit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMzowMzowMFrOHzHwCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMzowMzowMFrOHzHwCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM2NjQxMA==", "bodyText": "nit: is this required? if so, can we move to block comment?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r523366410", "createdAt": "2020-11-14T03:03:00Z", "author": {"login": "VijayanB"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoreScriptFactory.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.plugin.stats.KNNCounter;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+public class KNNScoreScriptFactory implements ScoreScript.LeafFactory {\n+    private final Map<String, Object> params;\n+    private final SearchLookup lookup;\n+    private String similaritySpace;\n+    private String field;\n+    private Object query;\n+    private KNNScoringSpace knnScoringSpace;\n+\n+    public KNNScoreScriptFactory(Map<String, Object> params, SearchLookup lookup) {\n+        KNNCounter.SCRIPT_QUERY_REQUESTS.increment();\n+        this.params = params;\n+        this.lookup = lookup;\n+\n+        parseParameters();\n+\n+        this.knnScoringSpace = KNNScoringSpaceFactory.create(this.similaritySpace, this.query,\n+                lookup.doc().mapperService().fieldType(this.field));\n+\n+    }\n+\n+    private void parseParameters() {\n+        final Object field = params.get(\"field\");\n+        if (field == null) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalArgumentException(\"Missing parameter [field]\");\n+        }\n+\n+        this.field = field.toString();\n+\n+        final Object space = params.get(\"space_type\");\n+        if (space == null) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalArgumentException(\"Missing parameter [space_type]\");\n+        }\n+\n+        this.similaritySpace = space.toString();\n+\n+        final Object queryValue = params.get(\"query_value\");\n+        if (queryValue == null) {\n+            KNNCounter.SCRIPT_QUERY_ERRORS.increment();\n+            throw new IllegalArgumentException(\"Missing parameter [query_value]\");\n+        }\n+        this.query = queryValue;\n+    }\n+\n+    public boolean needs_score() {\n+        return false;\n+    }\n+\n+    /**\n+     * For each segment, supply the KNNScoreScript that should be run on the values returned from the fetch phase.\n+     * Because the method to score the documents was set during Factory construction, the scripts are agnostic of\n+     * the similarity space. The KNNScoringSpace will return the correct script, given the query, the field type, and\n+     * the similarity space.\n+     *\n+     * @param ctx LeafReaderContext for the segment\n+     * @return ScoreScript to be executed\n+     */\n+    @Override // called number of segments times", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86f1f388ee8e1894fb6e7a27e45101ecb21f741c"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d44514bcda5522f82bec5a26bce60bae1c41238", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6d44514bcda5522f82bec5a26bce60bae1c41238", "committedDate": "2020-11-16T19:25:47Z", "message": "Refactor to address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66e940f87c8cd208d0ed5f9b635a8ef3a9a5ba9d", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/66e940f87c8cd208d0ed5f9b635a8ef3a9a5ba9d", "committedDate": "2020-11-16T21:36:10Z", "message": "Add Override annotation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODcyNDEy", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-532872412", "createdAt": "2020-11-17T22:39:39Z", "commit": {"oid": "66e940f87c8cd208d0ed5f9b635a8ef3a9a5ba9d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMjozOTo0MFrOH1OaXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMjo1Mzo0MFrOH1O0Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU3MjcwMQ==", "bodyText": "Should we merge this class with KNNScoringSpaceUtil?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r525572701", "createdAt": "2020-11-17T22:39:40Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -1,9 +1,24 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n \n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n-import java.util.ArrayList;\n+import java.math.BigInteger;\n \n public class KNNScoringUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66e940f87c8cd208d0ed5f9b635a8ef3a9a5ba9d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU3OTMwMg==", "bodyText": "How about we add a testcase in such a way a segment contains docs with field name and with out the field name.   This would test how the scoring is handled for the segments with the above combination.\nWe could try forcemerge and then assert that docs with out the similarity field are not in the top hits. One test for long and one test for base64 should be good?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#discussion_r525579302", "createdAt": "2020-11-17T22:53:40Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScriptScoringIT.java", "diffHunk": "@@ -308,4 +322,169 @@ public void testKNNScoreforNonVectorDocument() throws Exception {\n         assertEquals(0.33333, scores.get(0), 0.001);\n         assertEquals(Float.MIN_VALUE, scores.get(1), 0.001);\n     }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public void testHammingScriptScore_Long() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66e940f87c8cd208d0ed5f9b635a8ef3a9a5ba9d"}, "originalPosition": 160}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecdfe06bab99b841382081b8e5be7de03031350c", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ecdfe06bab99b841382081b8e5be7de03031350c", "committedDate": "2020-11-18T18:37:59Z", "message": "update test case to include single segment test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4Nzg3OTE3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-538787917", "createdAt": "2020-11-25T19:19:18Z", "commit": {"oid": "ecdfe06bab99b841382081b8e5be7de03031350c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4OTA5NzU1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/267#pullrequestreview-538909755", "createdAt": "2020-11-25T23:51:30Z", "commit": {"oid": "ecdfe06bab99b841382081b8e5be7de03031350c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1282, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}