{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NTQ0NzMw", "number": 285, "title": "Adding support for FAISS JNI", "bodyText": "*As Issue #225 mentioned. It is possible to support faiss as future.\nBut i do not implement the codec services, because i want to ask for your opinions about this part.\nI prefer to use the same interface(saveIndex, init, queryIndex) as same as nmslib's code with the same input parameter, this would i have more compatibility for knn plugin. so i PR this using the same JNI interface.\ni think with the same interface we can support nmslib and faiss in knn plugin at the same time.\nDescription of changes:\n\nThis PR is support Faiss index and Query with the same interface in jni code.\nAdd index.knn.knnEngine to distinguish faiss and nmslib.\nWhen Write an Index in DocValuesConsumer, using index.knn.knnEngine to load the explicit Library.\nWhen Query an Index in KNNWeigh, using index.knn.knnEngine to load the explicit Library.\nIn KNNJNIFaissTests tests, it can do the same logic as KNNIndex and KNNJNITests\nIt almost PASS all integTest when using Faiss as Library\nWe can modified interface code as less as mush.\nTo build this, we need to build faiss firstly which depends on some external Libs like OpenMP,BLAS etc.\n\nI think this PR, there is a lot of details need to be discussion.\nPS. Is there any possible to open a faiss branch?\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-25T07:51:55Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285", "merged": true, "mergeCommit": {"oid": "2fa551cdddf743e2219d6552bc28e41b42724853"}, "closed": true, "closedAt": "2021-01-26T23:02:20Z", "author": {"login": "luyuncheng"}, "timelineItems": {"totalCount": 69, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpi12JgH2gAyNTQ1NTQ0NzMwOjFjM2QzNzMxYTJkOWRhZTkwYjAyZDc2YWYzMTRiMDI2Yjg4NDc1NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd0DpQ4gFqTU3NjgzMjU1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c3d3731a2d9dae90b02d76af314b026b8847572", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1c3d3731a2d9dae90b02d76af314b026b8847572", "committedDate": "2020-12-25T07:03:43Z", "message": "1. New Branch Support Faiss\n2. Right Now Only Support JNI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6066a658a8681a28216741c6614e7e2ae9ab4ac9", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6066a658a8681a28216741c6614e7e2ae9ab4ac9", "committedDate": "2020-12-25T07:28:13Z", "message": "1. add submmodule faiss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5165e70bf618244e57ac0079f831cacd266fd948", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5165e70bf618244e57ac0079f831cacd266fd948", "committedDate": "2020-12-25T07:30:12Z", "message": "1. External Submodule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb10190e89783dbd8faaa169af6b01608b5084df", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/fb10190e89783dbd8faaa169af6b01608b5084df", "committedDate": "2020-12-25T08:04:18Z", "message": "Update CMakeLists.txt\n\nmodified make without clang"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54cf6a52e1511d7679bdcbdf3055c6f09c2752d9", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/54cf6a52e1511d7679bdcbdf3055c6f09c2752d9", "committedDate": "2020-12-25T08:13:25Z", "message": "Update CMakeLists.txt\n\nmodified OPENMP build in CMakeLists.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f4bdf0fd57cbfa733dd4934da75628bfad895ca", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0f4bdf0fd57cbfa733dd4934da75628bfad895ca", "committedDate": "2020-12-25T11:03:21Z", "message": "1. add knnEngine as a Settings\n2. When Write index and query index, we use knnEngine to verify search in faiss or nmslib"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab8e950dc2752871e2020125d311d6fbc8ed4dd5", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ab8e950dc2752871e2020125d311d6fbc8ed4dd5", "committedDate": "2020-12-25T11:06:27Z", "message": "1. Modified some FIXME"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "950e46012de9f67d6830ae2960cf5e70dcededd3", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/950e46012de9f67d6830ae2960cf5e70dcededd3", "committedDate": "2020-12-25T11:11:25Z", "message": "Merge pull request #1 from luyuncheng/faiss_withIT\n\nAdd index.knn.knnEngine in the ES Settings. When Write a Segment OR Query Index. It would use this settings to find the knn lib"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ce60540e4a7eecdc3baae2d03f7ec9f4970cbd", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/22ce60540e4a7eecdc3baae2d03f7ec9f4970cbd", "committedDate": "2020-12-25T12:35:30Z", "message": "1. gradle build jni and jniFaiss\n2. almost integTest and unitest PASSED"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1a44194c9439c15bf073e62a0e61137ab5b9a301", "committedDate": "2020-12-25T12:37:40Z", "message": "Merge pull request #2 from luyuncheng/faiss_withIT\n\nGradle build jni and jniFaiss"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzODAxNzcz", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#pullrequestreview-563801773", "createdAt": "2021-01-07T20:25:34Z", "commit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QyMDoyNTozNFrOIP7Law==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QyMDozODo0M1rOIP7iuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU2OTEzMQ==", "bodyText": "Design question: Should we have separate JNI libraries for FAISS and nmslib, or should they be contained in one?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r553569131", "createdAt": "2021-01-07T20:25:34Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/CMakeLists.txt", "diffHunk": "@@ -0,0 +1,144 @@\n+cmake_minimum_required(VERSION 2.8)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU3NDQwNQ==", "bodyText": "What do you mean by this?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r553574405", "createdAt": "2021-01-07T20:37:01Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -151,12 +153,22 @@ private void onRemoval(RemovalNotification<String, KNNIndexCacheEntry> removalNo\n      */\n     public KNNIndex getIndex(String key, final String indexName) {\n         try {\n+            //TODO if Type Not consistent", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU3NTA5OQ==", "bodyText": "I think we should keep nmslib as the default engine.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r553575099", "createdAt": "2021-01-07T20:38:43Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -83,6 +85,7 @@\n     /**\n      * Default setting values\n      */\n+    public static final String INDEX_KNN_DEFAULT_ENGINE = \"Faiss\"; // nmslib, faiss", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d13a7b158352b2be042e011a29dd31233f4c8dd", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3d13a7b158352b2be042e011a29dd31233f4c8dd", "committedDate": "2021-01-11T10:29:28Z", "message": "Merge pull request #6 from opendistro-for-elasticsearch/master\n\nupstream master merge into local master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f7094b5a863adc990875190499d307a31f254bf", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6f7094b5a863adc990875190499d307a31f254bf", "committedDate": "2021-01-11T12:29:33Z", "message": "1. FIXED SpaceType Get From IndexSettings may be EMPTY when a anonymous field create."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d94881c21e9b6ec5e8855072477f23c24a24d810", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d94881c21e9b6ec5e8855072477f23c24a24d810", "committedDate": "2021-01-11T12:33:45Z", "message": "Update CI.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dfb7146b168a2a1e62cdda8b7566fcb82c5db81", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3dfb7146b168a2a1e62cdda8b7566fcb82c5db81", "committedDate": "2021-01-11T12:35:02Z", "message": "1. Add CI branches for faiss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3834ea0f56356c4c34571c4a06c3cc21a64fda7e", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3834ea0f56356c4c34571c4a06c3cc21a64fda7e", "committedDate": "2021-01-11T13:47:32Z", "message": "1. Update Cmake Files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a775a3dcb220b34e660ee9f3caf45e8ed7f3c498", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/a775a3dcb220b34e660ee9f3caf45e8ed7f3c498", "committedDate": "2021-01-11T13:54:05Z", "message": "OFF GPU"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "051a54b1d1452313e74267e93089dab5a200badb", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/051a54b1d1452313e74267e93089dab5a200badb", "committedDate": "2021-01-11T13:59:55Z", "message": "OFF PYTHON"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cd57a7c502f69ac420c878265e33297102f62ba", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/8cd57a7c502f69ac420c878265e33297102f62ba", "committedDate": "2021-01-11T14:05:42Z", "message": "delete COMPILER"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1ODg5MjI0", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#pullrequestreview-565889224", "createdAt": "2021-01-12T02:20:10Z", "commit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQwMjoyMDoxMFrOIRvFhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQwMzoyNDoyMFrOIRwMTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ2ODE2NA==", "bodyText": "You could remove  dependsOn cmakeJniLib and just rely on dependsOn buildJniNmsLib dependsOn buildJniFaissLib as they internally depends on cmakeJniNmsLib and cmakeJniFaissLib", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555468164", "createdAt": "2021-01-12T02:20:10Z", "author": {"login": "vamshin"}, "path": "build.gradle", "diffHunk": "@@ -120,21 +120,37 @@ loggerUsageCheck.enabled = false\n def es_tmp_dir = rootProject.file('build/private/es_tmp').absoluteFile\n es_tmp_dir.mkdirs()\n \n-task cmakeJniLib(type:Exec) {\n+task cmakeJniNmsLib(type:Exec) {\n     workingDir 'jni'\n     commandLine 'cmake', '.'\n }\n-\n-task buildJniLib(type:Exec) {\n-    dependsOn cmakeJniLib\n+task cmakeJniFaissLib(type:Exec) {\n+    workingDir 'jniFaiss'\n+    commandLine 'cmake', '.'\n+}\n+task cmakeJniLib() {\n+    dependsOn cmakeJniNmsLib\n+    dependsOn cmakeJniFaissLib\n+}\n+task buildJniNmsLib(type:Exec) {\n+    dependsOn cmakeJniNmsLib\n     workingDir 'jni'\n     commandLine 'make'\n }\n-\n+task buildJniFaissLib(type:Exec) {\n+    dependsOn cmakeJniFaissLib\n+    workingDir 'jniFaiss'\n+    commandLine 'make'\n+}\n+task buildJniLib() {\n+    dependsOn cmakeJniLib\n+    dependsOn buildJniNmsLib\n+    dependsOn buildJniFaissLib\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ2ODkzNA==", "bodyText": "Is faiss library backward compatible?\nWe should have faiss library version in the function names to support backward compatibility issues if any arises in the future? You could refer nmslib apis.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555468934", "createdAt": "2021-01-12T02:23:05Z", "author": {"login": "vamshin"}, "path": "jniFaiss/include/com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex.h", "diffHunk": "@@ -0,0 +1,53 @@\n+/* DO NOT EDIT THIS FILE - it is machine generated */\n+#include <jni.h>\n+/* Header for class com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex */\n+\n+#ifndef _Included_com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex\n+#define _Included_com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex\n+#ifdef __cplusplus\n+extern \"C\" {\n+#endif\n+/*\n+ * Class:     com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex\n+ * Method:    saveIndex\n+ * Signature: ([I[[FLjava/lang/String;[Ljava/lang/String;Ljava/lang/String;)V\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex_saveIndex", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ3MDY0NA==", "bodyText": "We should run memory leak tests for faiss jni code. @jmazanec15 ran some memory leak tests for nmslib, we could probably ran it on the faiss branch once we create. Lets see if we can test it as part of this PR or atleast we can create an issue to track all TODOs later.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555470644", "createdAt": "2021-01-12T02:28:36Z", "author": {"login": "vamshin"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}\n+};\n+\n+extern \"C\"\n+\n+struct JavaException {\n+    JavaException(JNIEnv* env, const char* type = \"\", const char* message = \"\")\n+    {\n+        jclass newExcCls = env->FindClass(type);\n+        if (newExcCls != NULL)\n+            env->ThrowNew(newExcCls, message);\n+    }\n+};\n+\n+inline void has_exception_in_stack(JNIEnv* env)\n+{\n+    if (env->ExceptionCheck() == JNI_TRUE)\n+        throw std::runtime_error(\"Exception Occured\");\n+}\n+\n+void catch_cpp_exception_and_throw_java(JNIEnv* env)\n+{\n+    try {\n+        throw;\n+    }\n+    catch (const std::bad_alloc& rhs) {\n+        JavaException(env, \"java/io/IOException\", rhs.what());\n+    }\n+    catch (const std::runtime_error& re) {\n+        JavaException(env, \"java/lang/Exception\", re.what());\n+    }\n+    catch (const std::exception& e) {\n+        JavaException(env, \"java/lang/Exception\", e.what());\n+    }\n+    catch (...) {\n+        JavaException(env, \"java/lang/Exception\", \"Unknown exception occured\");\n+    }\n+}\n+\n+/**\n+ * Method: saveIndex\n+ *\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex_saveIndex\n+(JNIEnv* env, jclass cls, jintArray ids, jobjectArray vectors, jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\tvector<int64_t> idVector;\n+\tvector<float>   dataset;\n+\tvector<string> paramsList;\n+\tstring indexDescription = \"HNSW32\";\n+\tfaiss::MetricType metric = faiss::METRIC_L2;\n+\tstd::unique_ptr<faiss::Index> indexWriter;\n+\tint dim = 0;\n+\ttry {\n+\t\t//---- ids\n+\t\tint* object_ids = NULL;\n+\t\tobject_ids = env->GetIntArrayElements(ids, 0);\n+\t\tfor(int i = 0; i < env->GetArrayLength(ids); ++i) {\n+\t\t\tidVector.push_back(object_ids[i]);\n+\t\t}\n+\t\tenv->ReleaseIntArrayElements(ids, object_ids, 0);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- vectors\n+\t\tfor (int i = 0; i < env->GetArrayLength(vectors); ++i) {\n+\t\t\tjfloatArray vectorArray = (jfloatArray)env->GetObjectArrayElement(vectors, i);\n+\t\t\tfloat* vector = env->GetFloatArrayElements(vectorArray, 0);\n+\t\t\tdim = env->GetArrayLength(vectorArray);\n+\t\t\tfor(int j = 0; j < dim; ++j) {\n+\t\t\t\tdataset.push_back(vector[j]);\n+\t\t\t}\n+\t\t\tenv->ReleaseFloatArrayElements(vectorArray, vector, 0);\n+\t\t}\n+\t\thas_exception_in_stack(env);\n+\n+\t\t//---- indexPath\n+\t\tconst char *indexString = env->GetStringUTFChars(indexPath, 0);\n+        string indexPathString(indexString);\n+        env->ReleaseStringUTFChars(indexPath, indexString);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- algoParams\n+\t\tint paramsCount = env->GetArrayLength(algoParams);\n+        for (int i=0; i<paramsCount; i++) {\n+            jstring param = (jstring) (env->GetObjectArrayElement(algoParams, i));\n+            const char *rawString = env->GetStringUTFChars(param, 0);\n+            paramsList.push_back(rawString);\n+\n+            int M = 32;\n+            if (sscanf(rawString, \"M=%d\", &M) == 1) {\n+                indexDescription=\"HNSW\"+std::to_string(M);\n+            }\n+            env->ReleaseStringUTFChars(param, rawString);\n+\n+        }\n+\t\thas_exception_in_stack(env);\n+\n+\n+\t\t//---- space\n+\t\tconst char *spaceTypeCStr = env->GetStringUTFChars(spaceType, 0);\n+        string spaceTypeString(spaceTypeCStr);\n+        env->ReleaseStringUTFChars(spaceType, spaceTypeCStr);\n+        has_exception_in_stack(env);\n+\t\t// space mapping faiss::MetricType\n+\t\tif(mapMetric.find(spaceTypeString) != mapMetric.end()) {\n+\t\t\tmetric = mapMetric[spaceTypeString];\n+\t\t}\n+\n+\t\t//---- Create IndexWriter from faiss index_factory\n+\t\tindexWriter.reset(faiss::index_factory(dim, indexDescription.data(), metric));\n+\n+\t\t//Preparation And TODO Verify IndexWriter\n+\t\t//Some Param Can not Create from IndexFactory, Like HNSW efSearch and efCOnstruction\n+\t\t//----FOR HNSW 1st PARAM: M(HNSW32->M=32), efConstruction, efSearch\n+\t\tif(indexDescription.find(\"HNSW\") != std::string::npos) {\n+\t\t    for(int i = 0; i < paramsCount; ++i) {\n+\t\t        const string& param = paramsList[i];\n+\t\t        int efConstruction = 40; //default\n+\t\t        int efSearch = 16;//default\n+\t\t        if(param.find(\"efConstruction\") != std::string::npos &&\n+\t\t            sscanf(param.data(), \"efConstruction=%d\", &efConstruction) == 1) {\n+                        faiss::IndexHNSW* ihp = reinterpret_cast<faiss::IndexHNSW*>(indexWriter.get());\n+                        ihp->hnsw.efConstruction = efConstruction;\n+\t\t        } else if (param.find(\"efSearch\") != std::string::npos &&\n+                            sscanf(param.data(), \"efSearch=%d\", &efSearch) == 1){\n+                        faiss::IndexHNSW* ihp = reinterpret_cast<faiss::IndexHNSW*>(indexWriter.get());\n+                        ihp->hnsw.efSearch = efSearch;\n+\t\t        }\n+\t\t    }\n+\t\t}\n+\n+\t\t//---- Do Index\n+\t\t//----- 1. Train\n+        if(!indexWriter->is_trained) {\n+\t\t\t//TODO if we use like PQ, we have to train dataset\n+\t\t\t// but when a lucene segment only one document, it\n+\t\t\t// can not train the data.\n+\t\t}\n+\t\t//----- 2. Add IDMap\n+\t\t// default all use self defined IndexIDMap cause some class no add_with_ids\n+\t\tfaiss::IndexIDMap idMap =  faiss::IndexIDMap(indexWriter.get());\n+\t\tidMap.add_with_ids(idVector.size(), dataset.data(), idVector.data());\n+\n+\t\t//----- 3. WriteIndex\n+\t\tfaiss::write_index(&idMap, indexPathString.c_str());\n+\t\t\n+\t\t//Explicit delete object\n+\t\tfaiss::Index* indexPointer = indexWriter.release();\n+\t\tif(indexPointer) delete indexPointer;\n+\n+\t}\n+\tcatch(...) {\n+\t\tfaiss::Index* indexPointer = indexWriter.release();\n+\t\tif(indexPointer) delete indexPointer;\n+\t\tcatch_cpp_exception_and_throw_java(env);\n+\t}\n+}\n+\n+\n+JNIEXPORT jobjectArray JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex_queryIndex\n+(JNIEnv* env, jclass cls, jlong indexPointer, jfloatArray queryVector, jint k)\n+{\n+\tfaiss::Index *indexReader = nullptr;\n+\ttry {\n+\t\tindexReader = reinterpret_cast<faiss::Index*>(indexPointer);\n+\t\tfloat* rawQueryvector = env->GetFloatArrayElements(queryVector, 0);\n+\t\tint dim\t= env->GetArrayLength(queryVector);\n+\n+\t\tstd::vector<float> dis(k * dim);\n+\t\tstd::vector<faiss::Index::idx_t> ids( k * dim);\n+\t\tindexReader->search(1, rawQueryvector, k, dis.data(), ids.data());\n+\t\tenv->ReleaseFloatArrayElements(queryVector, rawQueryvector, 0);\n+\t\thas_exception_in_stack(env);\n+\n+\t\tint resultSize = k;\n+\t\t//if result is not enough, padded with -1s\n+\t\tfor(int i = 0; i < k; i++) {\n+\t\t\tif(ids[i] == -1) {\n+\t\t\t\tresultSize = i;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\n+\t\tjclass resultClass = env->FindClass(\"com/amazon/opendistroforelasticsearch/knn/index/KNNQueryResult\");\n+\t\tjmethodID allArgs = env->GetMethodID(resultClass, \"<init>\", \"(IF)V\");\n+\t\tjobjectArray results = env->NewObjectArray(resultSize, resultClass, NULL);\n+\t\tfor(int i = 0; i < resultSize; ++i) {\n+\t\t\tfloat distance = dis[i];\n+\t\t\tlong  id = ids[i];\n+\t\t\tenv->SetObjectArrayElement(results, i, env->NewObject(resultClass, allArgs, id, distance));\n+\t\t}\n+\t\thas_exception_in_stack(env);\n+        return results;\n+\n+\t}\n+\tcatch(...) {\n+\t\tif(indexReader) delete indexReader;\n+\t\tcatch_cpp_exception_and_throw_java(env);\t\n+\t}\n+\treturn NULL;\n+}\n+\n+JNIEXPORT jlong JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex_init\n+(JNIEnv* env, jclass cls,  jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\n+\tfaiss::Index* indexReader = nullptr;\n+\ttry {\n+        const char *indexPathCStr = env->GetStringUTFChars(indexPath, 0);\n+        string indexPathString(indexPathCStr);\n+        env->ReleaseStringUTFChars(indexPath, indexPathCStr);\n+        has_exception_in_stack(env);\n+\t\t//whether set IO_FLAGS = 0 or IO_FLAG_READ_ONLYfaiss::IO_FLAG_READ_ONLY\n+\t\tindexReader = faiss::read_index(indexPathString.c_str(), faiss::IO_FLAG_READ_ONLY);\n+\t\treturn (jlong) indexReader;\n+\t} \n+\tcatch(...) {\n+        if (indexReader) delete indexReader;\n+        catch_cpp_exception_and_throw_java(env);\t\n+\t}\n+\treturn NULL;\n+}\n+\n+/**\n+ * When autoclose class do close, then delete the pointer\n+ * Method GC pointer\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex_gc", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 249}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ3MzMyNg==", "bodyText": "Having Faiss part of NmsLibVersion class would add confusion. We should probably have dedicated enum class for Faiss versions? Intension of this class is to hold different versions of same library and refer them from this class incase we happen to maintain more than one version of the library because of compatability issues.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555473326", "createdAt": "2021-01-12T02:37:48Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/util/NmsLibVersion.java", "diffHunk": "@@ -25,9 +28,17 @@\n         public String indexLibraryVersion() {\n             return \"KNNIndexV2_0_6\";\n         }\n+    },\n+    VFaiss(\"Faiss\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ3NDI0Mg==", "bodyText": "We should also have some tests that create both nmslib and faiss indices and perform search in the same test and assert right values are retrieved. This is to verify we are not mixing up between library calls.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555474242", "createdAt": "2021-01-12T02:41:05Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNJNIFaissTests.java", "diffHunk": "@@ -0,0 +1,177 @@\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.KNNTestCase;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.faiss.KNNFIndex;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.store.Directory;\n+import org.apache.lucene.store.FSDirectory;\n+import org.apache.lucene.store.FilterDirectory;\n+\n+import java.nio.file.Paths;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class KNNJNIFaissTests extends KNNTestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ3NjAzOA==", "bodyText": "We should add version information similar to NMSlib to keep it consistent and provides ability to load certain version of the library.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555476038", "createdAt": "2021-01-12T02:47:18Z", "author": {"login": "vamshin"}, "path": "src/main/plugin-metadata/plugin-security.policy", "diffHunk": "@@ -1,3 +1,4 @@\n grant {\n     permission java.lang.RuntimePermission \"loadLibrary.KNNIndexV2_0_6\";\n+    permission java.lang.RuntimePermission \"loadLibrary.KNNIndexVFaiss\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ3NjgxNA==", "bodyText": "package name should have version information similar to nmslib.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555476814", "createdAt": "2021-01-12T02:50:02Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/faiss/KNNFIndex.java", "diffHunk": "@@ -0,0 +1,138 @@\n+package com.amazon.opendistroforelasticsearch.knn.index.faiss;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4MTMwOQ==", "bodyText": "How about we move if else check inside the AccessController.doPrivileged. Something like below example\n                AccessController.doPrivileged(\n                        new PrivilegedAction<Void>() {\n                            public Void run() {\n                                if(knnindex)\n                                      KNNIndex.saveIndex(pair.docs, pair.vectors, tempIndexPath, algoParams, spaceType);\n                                if(faissindex)\n                                     KNNFIndex.saveIndex(pair.docs, pair.vectors, tempIndexPath, algoParams, spaceType);      \n                               return null;\n                            }\n      ```", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555481309", "createdAt": "2021-01-12T03:05:45Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/codec/KNN80Codec/KNN80DocValuesConsumer.java", "diffHunk": "@@ -98,16 +99,29 @@ public void addKNNBinaryField(FieldInfo field, DocValuesProducer valuesProducer)\n             // Pass the path for the nms library to save the file\n             String tempIndexPath = indexPath + TEMP_SUFFIX;\n             Map<String, String> fieldAttributes = field.attributes();\n+            String knnEngine = fieldAttributes.getOrDefault(KNNConstants.KNNEngine, KNNSettings.INDEX_KNN_DEFAULT_ENGINE);\n             String spaceType = fieldAttributes.getOrDefault(KNNConstants.SPACE_TYPE, SpaceTypes.l2.getValue());\n             String[] algoParams = getKNNIndexParams(fieldAttributes);\n-            AccessController.doPrivileged(\n-                    new PrivilegedAction<Void>() {\n-                        public Void run() {\n-                            KNNIndex.saveIndex(pair.docs, pair.vectors, tempIndexPath, algoParams, spaceType);\n-                            return null;\n+\n+            if(knnEngine.contains(NmsLibVersion.VFaiss.getBuildVersion())) {\n+                AccessController.doPrivileged(\n+                        new PrivilegedAction<Void>() {\n+                            public Void run() {\n+                                KNNFIndex.saveIndex(pair.docs, pair.vectors, tempIndexPath, algoParams, spaceType);\n+                                return null;\n+                            }\n+                        }\n+                );\n+            } else {\n+                AccessController.doPrivileged(\n+                        new PrivilegedAction<Void>() {\n+                            public Void run() {\n+                                KNNIndex.saveIndex(pair.docs, pair.vectors, tempIndexPath, algoParams, spaceType);\n+                                return null;\n+                            }\n                         }\n-                    }\n-            );\n+                );\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4NTU2NA==", "bodyText": "How about we pull out the methods in KNNFIndex and KNNIndex to interface so that we could refer with one object to keep it more cleaner? Something like\nKNNIndex index;\nif (fieldAttributes.containsValue(NmsLibVersion.V206.getBuildVersion())) {\n       index = knnIndexCache.getIndex(indexPath.toString(), knnQuery.getIndexName());\n} else {\n       index = knnIndexCache.getFIndex(indexPath.toString(), knnQuery.getIndexName());\n}\nresults = index.queryIndex(knnQuery.getQueryVector(), knnQuery.getK());", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555485564", "createdAt": "2021-01-12T03:21:30Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNWeight.java", "diffHunk": "@@ -97,11 +100,21 @@ public Scorer scorer(LeafReaderContext context) throws IOException {\n              */\n \n             Path indexPath = PathUtils.get(directory, hnswFiles.get(0));\n-            final KNNIndex index = knnIndexCache.getIndex(indexPath.toString(), knnQuery.getIndexName());\n-            final KNNQueryResult[] results = index.queryIndex(\n-                    knnQuery.getQueryVector(),\n-                    knnQuery.getK()\n-            );\n+            final KNNQueryResult[] results;\n+\n+            if (fieldAttributes.containsValue(NmsLibVersion.V206.getBuildVersion())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4NTg3MA==", "bodyText": "This class has core logic and would need some insights into way faiss library operates to review the code. I plan to visit this code once I have understanding of faiss interface.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555485870", "createdAt": "2021-01-12T03:22:46Z", "author": {"login": "vamshin"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex.h\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4NjI4Nw==", "bodyText": "I feel having seperate JNI would be more cleaner and easy to abstract out the underlying business logic to dedicated files.  I like the current approach.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r555486287", "createdAt": "2021-01-12T03:24:20Z", "author": {"login": "vamshin"}, "path": "jniFaiss/CMakeLists.txt", "diffHunk": "@@ -0,0 +1,144 @@\n+cmake_minimum_required(VERSION 2.8)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU2OTEzMQ=="}, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff99c4c486cb9c6cc5e4971876130da5022fc3c7", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ff99c4c486cb9c6cc5e4971876130da5022fc3c7", "committedDate": "2021-01-12T09:21:13Z", "message": "Update CMakeLists.txt\n\nupdate CMakeLists.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3d9baac6cb0c49b26255df095e7f69ba28c1f68", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d3d9baac6cb0c49b26255df095e7f69ba28c1f68", "committedDate": "2021-01-12T09:24:37Z", "message": "Update CMakeLists.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afa1b5c517576ffb786bd31d035d57549f342fa3", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/afa1b5c517576ffb786bd31d035d57549f342fa3", "committedDate": "2021-01-12T09:37:21Z", "message": "Update build.gradle\n\nFixed depends On in gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce389f45d8a546b960e3dba2bf5fe8f116eb60a9", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ce389f45d8a546b960e3dba2bf5fe8f116eb60a9", "committedDate": "2021-01-12T09:49:45Z", "message": "Update com_amazon_opendistroforelasticsearch_knn_index_faiss_KNNFIndex.cpp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "716557464a362c5784d98ef5d8c09f8f5e10b175", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/716557464a362c5784d98ef5d8c09f8f5e10b175", "committedDate": "2021-01-12T10:43:01Z", "message": "Update CMakeLists.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d1670d48e029e1dde1187d79dd84d511933c22c", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3d1670d48e029e1dde1187d79dd84d511933c22c", "committedDate": "2021-01-12T11:00:09Z", "message": "Merge branch 'faiss' into faiss_dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d0a2de094f2bfb6a69c1a9075c00d31cca843e1", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3d0a2de094f2bfb6a69c1a9075c00d31cca843e1", "committedDate": "2021-01-12T12:04:37Z", "message": "Update KNNCircuitBreakerIT.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "698fbeaf8cdac40bb7f23eb3a0038aec06e22515", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/698fbeaf8cdac40bb7f23eb3a0038aec06e22515", "committedDate": "2021-01-12T12:07:30Z", "message": "Update KNNCircuitBreakerIT.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "890d6f75ea7c5f0fa3d4f9f6da1b031ef86a0334", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/890d6f75ea7c5f0fa3d4f9f6da1b031ef86a0334", "committedDate": "2021-01-12T12:07:47Z", "message": "Update KNNCircuitBreakerIT.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b08b4eb1efdb624c9ea3e79ce825fcd2121c2f0", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/8b08b4eb1efdb624c9ea3e79ce825fcd2121c2f0", "committedDate": "2021-01-12T12:33:02Z", "message": "Update KNNCodecTestCase.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fd12205bc17f3a3e28d05ef6921c8f6899dfb9d", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/8fd12205bc17f3a3e28d05ef6921c8f6899dfb9d", "committedDate": "2021-01-12T12:42:32Z", "message": "Merge pull request #7 from luyuncheng/faiss_dev\n\nFixed using CI run  integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "381dd58821e40fdc21f3510310d669d6d0c96d64", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/381dd58821e40fdc21f3510310d669d6d0c96d64", "committedDate": "2021-01-12T12:46:07Z", "message": "Merge branch 'master' into faiss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20672dfa243e65b7245f1dcf820904eba3146f9c", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/20672dfa243e65b7245f1dcf820904eba3146f9c", "committedDate": "2021-01-12T13:23:27Z", "message": "Update test-workflow.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deeefeb81098132d05828af15ea31071f8f9c99a", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/deeefeb81098132d05828af15ea31071f8f9c99a", "committedDate": "2021-01-12T13:34:03Z", "message": "Merge pull request #8 from luyuncheng/faiss_dev\n\nUpdate test-workflow.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdeca84996659452b41ff44f27aeee4c4185cb38", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/fdeca84996659452b41ff44f27aeee4c4185cb38", "committedDate": "2021-01-12T14:16:29Z", "message": "Merge branch 'master' into faiss_dev\n\n# Conflicts:\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNWeight.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/util/NmsLibVersion.java\n#\tsrc/main/plugin-metadata/plugin-security.policy\n#\tsrc/test/java/com/amazon/opendistroforelasticsearch/knn/index/codec/KNNCodecTestCase.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0423466cf09e6747b26141ddfc581903c806fdff", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0423466cf09e6747b26141ddfc581903c806fdff", "committedDate": "2021-01-12T14:23:09Z", "message": "Merge Master Into Faiss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d2960d275dc0bb61f5fef8c28a7407e14b97ceb", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/4d2960d275dc0bb61f5fef8c28a7407e14b97ceb", "committedDate": "2021-01-12T15:09:39Z", "message": "Merge Master Into Faiss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "654cb52e17296562182ece3bcffc80b4258fa552", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/654cb52e17296562182ece3bcffc80b4258fa552", "committedDate": "2021-01-12T15:43:18Z", "message": "Merge Master Into Faiss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f549e3ef56c60bd32d6d0b5a79ab1020b2c047a1", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f549e3ef56c60bd32d6d0b5a79ab1020b2c047a1", "committedDate": "2021-01-12T15:50:11Z", "message": "Merge branch 'faiss' into faiss_dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d44d1e91818216dc31c7eb4e3df210f5c25906", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/98d44d1e91818216dc31c7eb4e3df210f5c25906", "committedDate": "2021-01-12T16:09:39Z", "message": "Merge pull request #10 from luyuncheng/faiss_dev\n\nMerge Upstream Maser into faiss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "243eb81c1928828a0b897d1ab3d17c76a4a11acc", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/243eb81c1928828a0b897d1ab3d17c76a4a11acc", "committedDate": "2021-01-13T08:45:23Z", "message": "move IndexClass check inside the AccessController.doPrivileged"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c2e397dfa6a6cdb6371e7f7e00f881f0b4ae854", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3c2e397dfa6a6cdb6371e7f7e00f881f0b4ae854", "committedDate": "2021-01-18T12:39:59Z", "message": "Add Tests for Circuit breaker test with different engine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f23196502a4705636c6d4040f181fcb83521be6a", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f23196502a4705636c6d4040f181fcb83521be6a", "committedDate": "2021-01-20T12:39:13Z", "message": "1. Add NmsLib Version And Faiss Version into KNN Plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bdbc436164e3eb288343ad292951ae29e8f346a", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3bdbc436164e3eb288343ad292951ae29e8f346a", "committedDate": "2021-01-20T12:41:15Z", "message": "Update CMakeLists.txt\n\nupdate Lib Version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce141a3b1a68ecf6be737a73f3c64f6863509075", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ce141a3b1a68ecf6be737a73f3c64f6863509075", "committedDate": "2021-01-20T12:48:23Z", "message": "Update CMakeLists.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "652c329f06e2b14f2c769162a0546cee52b1d250", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/652c329f06e2b14f2c769162a0546cee52b1d250", "committedDate": "2021-01-20T13:05:42Z", "message": "Update CMakeLists.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "667281433fb2da253e00d4250f6b11f22b75a5ee", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/667281433fb2da253e00d4250f6b11f22b75a5ee", "committedDate": "2021-01-20T13:21:29Z", "message": "Update KNNWeight.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b08d2d996c8ca47613181c13154484569831098f", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b08d2d996c8ca47613181c13154484569831098f", "committedDate": "2021-01-20T13:23:57Z", "message": "Update CMakeLists.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4ebd79541a83db4c0fa898d60218ba314277a88", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f4ebd79541a83db4c0fa898d60218ba314277a88", "committedDate": "2021-01-20T13:30:23Z", "message": "1. Add NmsLib Version And Faiss Version into KNN Plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df4c2185019a1df1d86d74cbb04ed6f6017ba8af", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/df4c2185019a1df1d86d74cbb04ed6f6017ba8af", "committedDate": "2021-01-20T13:31:03Z", "message": "Merge remote-tracking branch 'origin/faiss_dev_libversion' into faiss_dev_libversion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1777bd14ab9e8dc5982b28a09351b82b26e2bf4a", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1777bd14ab9e8dc5982b28a09351b82b26e2bf4a", "committedDate": "2021-01-20T13:39:23Z", "message": "1. Add NmsLib Version And Faiss Version into KNN Plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "576a8eb0ae2c12e64e2e4026630e100f6cc0ef4c", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/576a8eb0ae2c12e64e2e4026630e100f6cc0ef4c", "committedDate": "2021-01-20T13:50:18Z", "message": "Merge pull request #11 from luyuncheng/faiss_dev_libversion\n\nAdd Faiss and nmslib LibVersion into knn plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d37a523a778eaed5959175fbe8d1e202721eafac", "committedDate": "2021-01-20T14:12:06Z", "message": "Add NmsLib Version And Faiss Version into KNN Plugin\n\n1. Add NmsLib Version And Faiss Version into KNN Plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c83e70d4d9da5e406f12c8f49735a9583b529a8", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/7c83e70d4d9da5e406f12c8f49735a9583b529a8", "committedDate": "2021-01-22T15:32:29Z", "message": "Merge pull request #13 from opendistro-for-elasticsearch/master\n\nUpdate Upstream Master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd179b571fc218c4ee3d1386d015b83615f4e3de", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/dd179b571fc218c4ee3d1386d015b83615f4e3de", "committedDate": "2021-01-22T16:01:20Z", "message": "1. Add NmsLib Version And Faiss Version into KNN Plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd7e3e8545304f713ef67e33c8093d9f77ecb6c1", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/cd7e3e8545304f713ef67e33c8093d9f77ecb6c1", "committedDate": "2021-01-22T16:38:39Z", "message": "1. Merge remote-tracking branch 'origin/master' into faiss_dev\n2. Make Faiss Version into code\n3. Update Hnswlib to 2.0.10\n\n# Conflicts:\n#\tjni/CMakeLists.txt\n#\tjni/include/com_amazon_opendistroforelasticsearch_knn_index_nmslib_v208_KNNIndex.h\n#\tjni/include/com_amazon_opendistroforelasticsearch_knn_index_v2011_KNNIndex.h\n#\tjni/include/com_amazon_opendistroforelasticsearch_knn_index_v208_KNNIndex.h\n#\tjni/src/com_amazon_opendistroforelasticsearch_knn_index_nmslib_v208_KNNIndex.cpp\n#\tjni/src/com_amazon_opendistroforelasticsearch_knn_index_v2011_KNNIndex.cpp\n#\tjni/src/com_amazon_opendistroforelasticsearch_knn_index_v208_KNNIndex.cpp\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexShard.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNWeight.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/codec/KNN80Codec/KNN80DocValuesConsumer.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/nmslib/v208/KNNIndex.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/util/NmsLibVersion.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/v2011/KNNIndex.java\n#\tsrc/main/java/com/amazon/opendistroforelasticsearch/knn/index/v208/KNNIndex.java\n#\tsrc/main/plugin-metadata/plugin-security.policy\n#\tsrc/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCacheTests.java\n#\tsrc/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNJNITests.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczODEzNDI5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#pullrequestreview-573813429", "createdAt": "2021-01-21T23:14:02Z", "commit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "state": "COMMENTED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQyMzoxNDowM1rOIYNkqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQyMjoyNToyMlrOIY3mBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI1OTExMg==", "bodyText": "I dont think we need to add this branch to CI action, given that it is a development branch. Please remove. Once review finishes, we will check into faiss branch and develop/test from there. Then, once we are ready, we can create another PR to master.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562259112", "createdAt": "2021-01-21T23:14:03Z", "author": {"login": "jmazanec15"}, "path": ".github/workflows/CI.yml", "diffHunk": "@@ -4,6 +4,7 @@ on:\n     branches:\n       - master\n       - opendistro-*\n+      - faiss*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI1OTkzOQ==", "bodyText": "Same as above. Please remove.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562259939", "createdAt": "2021-01-21T23:16:01Z", "author": {"login": "jmazanec15"}, "path": ".github/workflows/test-workflow.yml", "diffHunk": "@@ -5,10 +5,12 @@ on:\n     branches:\n       - master\n       - opendistro-*\n+      - faiss*\n   push:\n     branches:\n       - master\n       - opendistro-*\n+      - faiss*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjgxNzc5Mw==", "bodyText": "I think having 2 separate libraries is okay.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562817793", "createdAt": "2021-01-22T18:12:47Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/CMakeLists.txt", "diffHunk": "@@ -0,0 +1,144 @@\n+cmake_minimum_required(VERSION 2.8)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU2OTEzMQ=="}, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0MTg2Mg==", "bodyText": "I think this might be better for CMakeLists.txt: https://gist.github.com/jmazanec15/da1e68aed9073c7d4706597ba8ef2087.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562941862", "createdAt": "2021-01-22T22:09:42Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/CMakeLists.txt", "diffHunk": "@@ -0,0 +1,108 @@\n+cmake_minimum_required(VERSION 2.8)\n+\n+project(KNNIndex_FAISS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0MjY0Mg==", "bodyText": "Doesn't FAISS also have cosine space?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562942642", "createdAt": "2021-01-22T22:11:36Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0MzA5Mg==", "bodyText": "Can you add a TODO for future to abstract out common logic from JNI levels? This does not have to be completed in this PR, but we should do it in the future.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562943092", "createdAt": "2021-01-22T22:12:50Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}\n+};\n+\n+extern \"C\"\n+\n+struct JavaException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0MzY5Nw==", "bodyText": "I think instead of setting L2 as default, we should just make sure that spaceType is passed in and is valid. Setting L2 as default here could lead to silent failures.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562943697", "createdAt": "2021-01-22T22:14:36Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}\n+};\n+\n+extern \"C\"\n+\n+struct JavaException {\n+    JavaException(JNIEnv* env, const char* type = \"\", const char* message = \"\")\n+    {\n+        jclass newExcCls = env->FindClass(type);\n+        if (newExcCls != NULL)\n+            env->ThrowNew(newExcCls, message);\n+    }\n+};\n+\n+inline void has_exception_in_stack(JNIEnv* env)\n+{\n+    if (env->ExceptionCheck() == JNI_TRUE)\n+        throw std::runtime_error(\"Exception Occured\");\n+}\n+\n+void catch_cpp_exception_and_throw_java(JNIEnv* env)\n+{\n+    try {\n+        throw;\n+    }\n+    catch (const std::bad_alloc& rhs) {\n+        JavaException(env, \"java/io/IOException\", rhs.what());\n+    }\n+    catch (const std::runtime_error& re) {\n+        JavaException(env, \"java/lang/Exception\", re.what());\n+    }\n+    catch (const std::exception& e) {\n+        JavaException(env, \"java/lang/Exception\", e.what());\n+    }\n+    catch (...) {\n+        JavaException(env, \"java/lang/Exception\", \"Unknown exception occured\");\n+    }\n+}\n+\n+/**\n+ * Method: saveIndex\n+ *\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_saveIndex\n+(JNIEnv* env, jclass cls, jintArray ids, jobjectArray vectors, jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\tvector<int64_t> idVector;\n+\tvector<float>   dataset;\n+\tvector<string> paramsList;\n+\tstring indexDescription = \"HNSW32\";\n+\tfaiss::MetricType metric = faiss::METRIC_L2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0Mzg5Mw==", "bodyText": "Indentation in this file looks off. Could you please fix?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562943893", "createdAt": "2021-01-22T22:15:10Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}\n+};\n+\n+extern \"C\"\n+\n+struct JavaException {\n+    JavaException(JNIEnv* env, const char* type = \"\", const char* message = \"\")\n+    {\n+        jclass newExcCls = env->FindClass(type);\n+        if (newExcCls != NULL)\n+            env->ThrowNew(newExcCls, message);\n+    }\n+};\n+\n+inline void has_exception_in_stack(JNIEnv* env)\n+{\n+    if (env->ExceptionCheck() == JNI_TRUE)\n+        throw std::runtime_error(\"Exception Occured\");\n+}\n+\n+void catch_cpp_exception_and_throw_java(JNIEnv* env)\n+{\n+    try {\n+        throw;\n+    }\n+    catch (const std::bad_alloc& rhs) {\n+        JavaException(env, \"java/io/IOException\", rhs.what());\n+    }\n+    catch (const std::runtime_error& re) {\n+        JavaException(env, \"java/lang/Exception\", re.what());\n+    }\n+    catch (const std::exception& e) {\n+        JavaException(env, \"java/lang/Exception\", e.what());\n+    }\n+    catch (...) {\n+        JavaException(env, \"java/lang/Exception\", \"Unknown exception occured\");\n+    }\n+}\n+\n+/**\n+ * Method: saveIndex\n+ *\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_saveIndex\n+(JNIEnv* env, jclass cls, jintArray ids, jobjectArray vectors, jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\tvector<int64_t> idVector;\n+\tvector<float>   dataset;\n+\tvector<string> paramsList;\n+\tstring indexDescription = \"HNSW32\";\n+\tfaiss::MetricType metric = faiss::METRIC_L2;\n+\tstd::unique_ptr<faiss::Index> indexWriter;\n+\tint dim = 0;\n+\ttry {\n+\t\t//---- ids\n+\t\tint* object_ids = NULL;\n+\t\tobject_ids = env->GetIntArrayElements(ids, 0);\n+\t\tfor(int i = 0; i < env->GetArrayLength(ids); ++i) {\n+\t\t\tidVector.push_back(object_ids[i]);\n+\t\t}\n+\t\tenv->ReleaseIntArrayElements(ids, object_ids, 0);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- vectors\n+\t\tfor (int i = 0; i < env->GetArrayLength(vectors); ++i) {\n+\t\t\tjfloatArray vectorArray = (jfloatArray)env->GetObjectArrayElement(vectors, i);\n+\t\t\tfloat* vector = env->GetFloatArrayElements(vectorArray, 0);\n+\t\t\tdim = env->GetArrayLength(vectorArray);\n+\t\t\tfor(int j = 0; j < dim; ++j) {\n+\t\t\t\tdataset.push_back(vector[j]);\n+\t\t\t}\n+\t\t\tenv->ReleaseFloatArrayElements(vectorArray, vector, 0);\n+\t\t}\n+\t\thas_exception_in_stack(env);\n+\n+\t\t//---- indexPath\n+\t\tconst char *indexString = env->GetStringUTFChars(indexPath, 0);\n+        string indexPathString(indexString);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0NDQ1MQ==", "bodyText": "Could you add a TODO here to eventually parametrize this? I think we should be able to support any Faiss index in the future.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562944451", "createdAt": "2021-01-22T22:16:35Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}\n+};\n+\n+extern \"C\"\n+\n+struct JavaException {\n+    JavaException(JNIEnv* env, const char* type = \"\", const char* message = \"\")\n+    {\n+        jclass newExcCls = env->FindClass(type);\n+        if (newExcCls != NULL)\n+            env->ThrowNew(newExcCls, message);\n+    }\n+};\n+\n+inline void has_exception_in_stack(JNIEnv* env)\n+{\n+    if (env->ExceptionCheck() == JNI_TRUE)\n+        throw std::runtime_error(\"Exception Occured\");\n+}\n+\n+void catch_cpp_exception_and_throw_java(JNIEnv* env)\n+{\n+    try {\n+        throw;\n+    }\n+    catch (const std::bad_alloc& rhs) {\n+        JavaException(env, \"java/io/IOException\", rhs.what());\n+    }\n+    catch (const std::runtime_error& re) {\n+        JavaException(env, \"java/lang/Exception\", re.what());\n+    }\n+    catch (const std::exception& e) {\n+        JavaException(env, \"java/lang/Exception\", e.what());\n+    }\n+    catch (...) {\n+        JavaException(env, \"java/lang/Exception\", \"Unknown exception occured\");\n+    }\n+}\n+\n+/**\n+ * Method: saveIndex\n+ *\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_saveIndex\n+(JNIEnv* env, jclass cls, jintArray ids, jobjectArray vectors, jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\tvector<int64_t> idVector;\n+\tvector<float>   dataset;\n+\tvector<string> paramsList;\n+\tstring indexDescription = \"HNSW32\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0NTA2NQ==", "bodyText": "Why do we need to sscanf here?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562945065", "createdAt": "2021-01-22T22:18:10Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}\n+};\n+\n+extern \"C\"\n+\n+struct JavaException {\n+    JavaException(JNIEnv* env, const char* type = \"\", const char* message = \"\")\n+    {\n+        jclass newExcCls = env->FindClass(type);\n+        if (newExcCls != NULL)\n+            env->ThrowNew(newExcCls, message);\n+    }\n+};\n+\n+inline void has_exception_in_stack(JNIEnv* env)\n+{\n+    if (env->ExceptionCheck() == JNI_TRUE)\n+        throw std::runtime_error(\"Exception Occured\");\n+}\n+\n+void catch_cpp_exception_and_throw_java(JNIEnv* env)\n+{\n+    try {\n+        throw;\n+    }\n+    catch (const std::bad_alloc& rhs) {\n+        JavaException(env, \"java/io/IOException\", rhs.what());\n+    }\n+    catch (const std::runtime_error& re) {\n+        JavaException(env, \"java/lang/Exception\", re.what());\n+    }\n+    catch (const std::exception& e) {\n+        JavaException(env, \"java/lang/Exception\", e.what());\n+    }\n+    catch (...) {\n+        JavaException(env, \"java/lang/Exception\", \"Unknown exception occured\");\n+    }\n+}\n+\n+/**\n+ * Method: saveIndex\n+ *\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_saveIndex\n+(JNIEnv* env, jclass cls, jintArray ids, jobjectArray vectors, jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\tvector<int64_t> idVector;\n+\tvector<float>   dataset;\n+\tvector<string> paramsList;\n+\tstring indexDescription = \"HNSW32\";\n+\tfaiss::MetricType metric = faiss::METRIC_L2;\n+\tstd::unique_ptr<faiss::Index> indexWriter;\n+\tint dim = 0;\n+\ttry {\n+\t\t//---- ids\n+\t\tint* object_ids = NULL;\n+\t\tobject_ids = env->GetIntArrayElements(ids, 0);\n+\t\tfor(int i = 0; i < env->GetArrayLength(ids); ++i) {\n+\t\t\tidVector.push_back(object_ids[i]);\n+\t\t}\n+\t\tenv->ReleaseIntArrayElements(ids, object_ids, 0);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- vectors\n+\t\tfor (int i = 0; i < env->GetArrayLength(vectors); ++i) {\n+\t\t\tjfloatArray vectorArray = (jfloatArray)env->GetObjectArrayElement(vectors, i);\n+\t\t\tfloat* vector = env->GetFloatArrayElements(vectorArray, 0);\n+\t\t\tdim = env->GetArrayLength(vectorArray);\n+\t\t\tfor(int j = 0; j < dim; ++j) {\n+\t\t\t\tdataset.push_back(vector[j]);\n+\t\t\t}\n+\t\t\tenv->ReleaseFloatArrayElements(vectorArray, vector, 0);\n+\t\t}\n+\t\thas_exception_in_stack(env);\n+\n+\t\t//---- indexPath\n+\t\tconst char *indexString = env->GetStringUTFChars(indexPath, 0);\n+        string indexPathString(indexString);\n+        env->ReleaseStringUTFChars(indexPath, indexString);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- algoParams\n+\t\tint paramsCount = env->GetArrayLength(algoParams);\n+        for (int i=0; i<paramsCount; i++) {\n+            jstring param = (jstring) (env->GetObjectArrayElement(algoParams, i));\n+            const char *rawString = env->GetStringUTFChars(param, 0);\n+            paramsList.push_back(rawString);\n+\n+            int M = 32;\n+            if (sscanf(rawString, \"M=%d\", &M) == 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0NTU0OQ==", "bodyText": "Yeah I was thinking about this a little bit. It seems like it might make sense to fall back to a flat index if we do not have enough points to train. But we can think about this later.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562945549", "createdAt": "2021-01-22T22:19:18Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}\n+};\n+\n+extern \"C\"\n+\n+struct JavaException {\n+    JavaException(JNIEnv* env, const char* type = \"\", const char* message = \"\")\n+    {\n+        jclass newExcCls = env->FindClass(type);\n+        if (newExcCls != NULL)\n+            env->ThrowNew(newExcCls, message);\n+    }\n+};\n+\n+inline void has_exception_in_stack(JNIEnv* env)\n+{\n+    if (env->ExceptionCheck() == JNI_TRUE)\n+        throw std::runtime_error(\"Exception Occured\");\n+}\n+\n+void catch_cpp_exception_and_throw_java(JNIEnv* env)\n+{\n+    try {\n+        throw;\n+    }\n+    catch (const std::bad_alloc& rhs) {\n+        JavaException(env, \"java/io/IOException\", rhs.what());\n+    }\n+    catch (const std::runtime_error& re) {\n+        JavaException(env, \"java/lang/Exception\", re.what());\n+    }\n+    catch (const std::exception& e) {\n+        JavaException(env, \"java/lang/Exception\", e.what());\n+    }\n+    catch (...) {\n+        JavaException(env, \"java/lang/Exception\", \"Unknown exception occured\");\n+    }\n+}\n+\n+/**\n+ * Method: saveIndex\n+ *\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_saveIndex\n+(JNIEnv* env, jclass cls, jintArray ids, jobjectArray vectors, jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\tvector<int64_t> idVector;\n+\tvector<float>   dataset;\n+\tvector<string> paramsList;\n+\tstring indexDescription = \"HNSW32\";\n+\tfaiss::MetricType metric = faiss::METRIC_L2;\n+\tstd::unique_ptr<faiss::Index> indexWriter;\n+\tint dim = 0;\n+\ttry {\n+\t\t//---- ids\n+\t\tint* object_ids = NULL;\n+\t\tobject_ids = env->GetIntArrayElements(ids, 0);\n+\t\tfor(int i = 0; i < env->GetArrayLength(ids); ++i) {\n+\t\t\tidVector.push_back(object_ids[i]);\n+\t\t}\n+\t\tenv->ReleaseIntArrayElements(ids, object_ids, 0);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- vectors\n+\t\tfor (int i = 0; i < env->GetArrayLength(vectors); ++i) {\n+\t\t\tjfloatArray vectorArray = (jfloatArray)env->GetObjectArrayElement(vectors, i);\n+\t\t\tfloat* vector = env->GetFloatArrayElements(vectorArray, 0);\n+\t\t\tdim = env->GetArrayLength(vectorArray);\n+\t\t\tfor(int j = 0; j < dim; ++j) {\n+\t\t\t\tdataset.push_back(vector[j]);\n+\t\t\t}\n+\t\t\tenv->ReleaseFloatArrayElements(vectorArray, vector, 0);\n+\t\t}\n+\t\thas_exception_in_stack(env);\n+\n+\t\t//---- indexPath\n+\t\tconst char *indexString = env->GetStringUTFChars(indexPath, 0);\n+        string indexPathString(indexString);\n+        env->ReleaseStringUTFChars(indexPath, indexString);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- algoParams\n+\t\tint paramsCount = env->GetArrayLength(algoParams);\n+        for (int i=0; i<paramsCount; i++) {\n+            jstring param = (jstring) (env->GetObjectArrayElement(algoParams, i));\n+            const char *rawString = env->GetStringUTFChars(param, 0);\n+            paramsList.push_back(rawString);\n+\n+            int M = 32;\n+            if (sscanf(rawString, \"M=%d\", &M) == 1) {\n+                indexDescription=\"HNSW\"+std::to_string(M);\n+            }\n+            env->ReleaseStringUTFChars(param, rawString);\n+\n+        }\n+\t\thas_exception_in_stack(env);\n+\n+\n+\t\t//---- space\n+\t\tconst char *spaceTypeCStr = env->GetStringUTFChars(spaceType, 0);\n+        string spaceTypeString(spaceTypeCStr);\n+        env->ReleaseStringUTFChars(spaceType, spaceTypeCStr);\n+        has_exception_in_stack(env);\n+\t\t// space mapping faiss::MetricType\n+\t\tif(mapMetric.find(spaceTypeString) != mapMetric.end()) {\n+\t\t\tmetric = mapMetric[spaceTypeString];\n+\t\t}\n+\n+\t\t//---- Create IndexWriter from faiss index_factory\n+\t\tindexWriter.reset(faiss::index_factory(dim, indexDescription.data(), metric));\n+\n+\t\t//Preparation And TODO Verify IndexWriter\n+\t\t//Some Param Can not Create from IndexFactory, Like HNSW efSearch and efCOnstruction\n+\t\t//----FOR HNSW 1st PARAM: M(HNSW32->M=32), efConstruction, efSearch\n+\t\tif(indexDescription.find(\"HNSW\") != std::string::npos) {\n+\t\t    for(int i = 0; i < paramsCount; ++i) {\n+\t\t        const string& param = paramsList[i];\n+\t\t        int efConstruction = 40; //default\n+\t\t        int efSearch = 16;//default\n+\t\t        if(param.find(\"efConstruction\") != std::string::npos &&\n+\t\t            sscanf(param.data(), \"efConstruction=%d\", &efConstruction) == 1) {\n+                        faiss::IndexHNSW* ihp = reinterpret_cast<faiss::IndexHNSW*>(indexWriter.get());\n+                        ihp->hnsw.efConstruction = efConstruction;\n+\t\t        } else if (param.find(\"efSearch\") != std::string::npos &&\n+                            sscanf(param.data(), \"efSearch=%d\", &efSearch) == 1){\n+                        faiss::IndexHNSW* ihp = reinterpret_cast<faiss::IndexHNSW*>(indexWriter.get());\n+                        ihp->hnsw.efSearch = efSearch;\n+\t\t        }\n+\t\t    }\n+\t\t}\n+\n+\t\t//---- Do Index\n+\t\t//----- 1. Train\n+        if(!indexWriter->is_trained) {\n+\t\t\t//TODO if we use like PQ, we have to train dataset", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0NTcyMA==", "bodyText": "Why is this commented out?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562945720", "createdAt": "2021-01-22T22:19:46Z", "author": {"login": "jmazanec15"}, "path": "jniFaiss/src/com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.cpp", "diffHunk": "@@ -0,0 +1,272 @@\n+#include \"com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex.h\"\n+\n+#include <cmath>\n+#include <cstdio>\n+#include <cstdlib>\n+#include <string>\n+#include <vector>\n+#include <sys/time.h>\n+#include <omp.h>\n+\n+#include \"faiss/index_factory.h\"\n+#include \"faiss/MetaIndexes.h\"\n+#include \"faiss/index_io.h\"\n+#include \"faiss/IndexHNSW.h\"\n+\n+\n+using std::string;\n+using std::vector;\n+\n+std::unordered_map<string, faiss::MetricType> mapMetric = {\n+        {\"l2\", faiss::METRIC_L2},\n+        {\"innerproduct\", faiss::METRIC_INNER_PRODUCT}\n+};\n+\n+extern \"C\"\n+\n+struct JavaException {\n+    JavaException(JNIEnv* env, const char* type = \"\", const char* message = \"\")\n+    {\n+        jclass newExcCls = env->FindClass(type);\n+        if (newExcCls != NULL)\n+            env->ThrowNew(newExcCls, message);\n+    }\n+};\n+\n+inline void has_exception_in_stack(JNIEnv* env)\n+{\n+    if (env->ExceptionCheck() == JNI_TRUE)\n+        throw std::runtime_error(\"Exception Occured\");\n+}\n+\n+void catch_cpp_exception_and_throw_java(JNIEnv* env)\n+{\n+    try {\n+        throw;\n+    }\n+    catch (const std::bad_alloc& rhs) {\n+        JavaException(env, \"java/io/IOException\", rhs.what());\n+    }\n+    catch (const std::runtime_error& re) {\n+        JavaException(env, \"java/lang/Exception\", re.what());\n+    }\n+    catch (const std::exception& e) {\n+        JavaException(env, \"java/lang/Exception\", e.what());\n+    }\n+    catch (...) {\n+        JavaException(env, \"java/lang/Exception\", \"Unknown exception occured\");\n+    }\n+}\n+\n+/**\n+ * Method: saveIndex\n+ *\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_saveIndex\n+(JNIEnv* env, jclass cls, jintArray ids, jobjectArray vectors, jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\tvector<int64_t> idVector;\n+\tvector<float>   dataset;\n+\tvector<string> paramsList;\n+\tstring indexDescription = \"HNSW32\";\n+\tfaiss::MetricType metric = faiss::METRIC_L2;\n+\tstd::unique_ptr<faiss::Index> indexWriter;\n+\tint dim = 0;\n+\ttry {\n+\t\t//---- ids\n+\t\tint* object_ids = NULL;\n+\t\tobject_ids = env->GetIntArrayElements(ids, 0);\n+\t\tfor(int i = 0; i < env->GetArrayLength(ids); ++i) {\n+\t\t\tidVector.push_back(object_ids[i]);\n+\t\t}\n+\t\tenv->ReleaseIntArrayElements(ids, object_ids, 0);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- vectors\n+\t\tfor (int i = 0; i < env->GetArrayLength(vectors); ++i) {\n+\t\t\tjfloatArray vectorArray = (jfloatArray)env->GetObjectArrayElement(vectors, i);\n+\t\t\tfloat* vector = env->GetFloatArrayElements(vectorArray, 0);\n+\t\t\tdim = env->GetArrayLength(vectorArray);\n+\t\t\tfor(int j = 0; j < dim; ++j) {\n+\t\t\t\tdataset.push_back(vector[j]);\n+\t\t\t}\n+\t\t\tenv->ReleaseFloatArrayElements(vectorArray, vector, 0);\n+\t\t}\n+\t\thas_exception_in_stack(env);\n+\n+\t\t//---- indexPath\n+\t\tconst char *indexString = env->GetStringUTFChars(indexPath, 0);\n+        string indexPathString(indexString);\n+        env->ReleaseStringUTFChars(indexPath, indexString);\n+        has_exception_in_stack(env);\n+\n+\t\t//---- algoParams\n+\t\tint paramsCount = env->GetArrayLength(algoParams);\n+        for (int i=0; i<paramsCount; i++) {\n+            jstring param = (jstring) (env->GetObjectArrayElement(algoParams, i));\n+            const char *rawString = env->GetStringUTFChars(param, 0);\n+            paramsList.push_back(rawString);\n+\n+            int M = 32;\n+            if (sscanf(rawString, \"M=%d\", &M) == 1) {\n+                indexDescription=\"HNSW\"+std::to_string(M);\n+            }\n+            env->ReleaseStringUTFChars(param, rawString);\n+\n+        }\n+\t\thas_exception_in_stack(env);\n+\n+\n+\t\t//---- space\n+\t\tconst char *spaceTypeCStr = env->GetStringUTFChars(spaceType, 0);\n+        string spaceTypeString(spaceTypeCStr);\n+        env->ReleaseStringUTFChars(spaceType, spaceTypeCStr);\n+        has_exception_in_stack(env);\n+\t\t// space mapping faiss::MetricType\n+\t\tif(mapMetric.find(spaceTypeString) != mapMetric.end()) {\n+\t\t\tmetric = mapMetric[spaceTypeString];\n+\t\t}\n+\n+\t\t//---- Create IndexWriter from faiss index_factory\n+\t\tindexWriter.reset(faiss::index_factory(dim, indexDescription.data(), metric));\n+\n+\t\t//Preparation And TODO Verify IndexWriter\n+\t\t//Some Param Can not Create from IndexFactory, Like HNSW efSearch and efCOnstruction\n+\t\t//----FOR HNSW 1st PARAM: M(HNSW32->M=32), efConstruction, efSearch\n+\t\tif(indexDescription.find(\"HNSW\") != std::string::npos) {\n+\t\t    for(int i = 0; i < paramsCount; ++i) {\n+\t\t        const string& param = paramsList[i];\n+\t\t        int efConstruction = 40; //default\n+\t\t        int efSearch = 16;//default\n+\t\t        if(param.find(\"efConstruction\") != std::string::npos &&\n+\t\t            sscanf(param.data(), \"efConstruction=%d\", &efConstruction) == 1) {\n+                        faiss::IndexHNSW* ihp = reinterpret_cast<faiss::IndexHNSW*>(indexWriter.get());\n+                        ihp->hnsw.efConstruction = efConstruction;\n+\t\t        } else if (param.find(\"efSearch\") != std::string::npos &&\n+                            sscanf(param.data(), \"efSearch=%d\", &efSearch) == 1){\n+                        faiss::IndexHNSW* ihp = reinterpret_cast<faiss::IndexHNSW*>(indexWriter.get());\n+                        ihp->hnsw.efSearch = efSearch;\n+\t\t        }\n+\t\t    }\n+\t\t}\n+\n+\t\t//---- Do Index\n+\t\t//----- 1. Train\n+        if(!indexWriter->is_trained) {\n+\t\t\t//TODO if we use like PQ, we have to train dataset\n+\t\t\t// but when a lucene segment only one document, it\n+\t\t\t// can not train the data.\n+\t\t}\n+\t\t//----- 2. Add IDMap\n+\t\t// default all use self defined IndexIDMap cause some class no add_with_ids\n+\t\tfaiss::IndexIDMap idMap =  faiss::IndexIDMap(indexWriter.get());\n+\t\tidMap.add_with_ids(idVector.size(), dataset.data(), idVector.data());\n+\n+\t\t//----- 3. WriteIndex\n+\t\tfaiss::write_index(&idMap, indexPathString.c_str());\n+\t\t\n+\t\t//Explicit delete object\n+\t\tfaiss::Index* indexPointer = indexWriter.release();\n+\t\tif(indexPointer) delete indexPointer;\n+\n+\t}\n+\tcatch(...) {\n+\t\tfaiss::Index* indexPointer = indexWriter.release();\n+\t\tif(indexPointer) delete indexPointer;\n+\t\tcatch_cpp_exception_and_throw_java(env);\n+\t}\n+}\n+\n+\n+JNIEXPORT jobjectArray JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_queryIndex\n+(JNIEnv* env, jclass cls, jlong indexPointer, jfloatArray queryVector, jint k)\n+{\n+\tfaiss::Index *indexReader = nullptr;\n+\ttry {\n+\t\tindexReader = reinterpret_cast<faiss::Index*>(indexPointer);\n+\t\tfloat* rawQueryvector = env->GetFloatArrayElements(queryVector, 0);\n+\t\tint dim\t= env->GetArrayLength(queryVector);\n+\n+\t\tstd::vector<float> dis(k * dim);\n+\t\tstd::vector<faiss::Index::idx_t> ids( k * dim);\n+\t\tindexReader->search(1, rawQueryvector, k, dis.data(), ids.data());\n+\t\tenv->ReleaseFloatArrayElements(queryVector, rawQueryvector, 0);\n+\t\thas_exception_in_stack(env);\n+\n+\t\tint resultSize = k;\n+\t\t//if result is not enough, padded with -1s\n+\t\tfor(int i = 0; i < k; i++) {\n+\t\t\tif(ids[i] == -1) {\n+\t\t\t\tresultSize = i;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\n+\t\tjclass resultClass = env->FindClass(\"com/amazon/opendistroforelasticsearch/knn/index/KNNQueryResult\");\n+\t\tjmethodID allArgs = env->GetMethodID(resultClass, \"<init>\", \"(IF)V\");\n+\t\tjobjectArray results = env->NewObjectArray(resultSize, resultClass, NULL);\n+\t\tfor(int i = 0; i < resultSize; ++i) {\n+\t\t\tfloat distance = dis[i];\n+\t\t\tlong  id = ids[i];\n+\t\t\tenv->SetObjectArrayElement(results, i, env->NewObject(resultClass, allArgs, id, distance));\n+\t\t}\n+\t\thas_exception_in_stack(env);\n+        return results;\n+\n+\t}\n+\tcatch(...) {\n+\t\tif(indexReader) delete indexReader;\n+\t\tcatch_cpp_exception_and_throw_java(env);\t\n+\t}\n+\treturn NULL;\n+}\n+\n+JNIEXPORT jlong JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_init\n+(JNIEnv* env, jclass cls,  jstring indexPath, jobjectArray algoParams, jstring spaceType)\n+{\n+\n+\tfaiss::Index* indexReader = nullptr;\n+\ttry {\n+        const char *indexPathCStr = env->GetStringUTFChars(indexPath, 0);\n+        string indexPathString(indexPathCStr);\n+        env->ReleaseStringUTFChars(indexPath, indexPathCStr);\n+        has_exception_in_stack(env);\n+\t\t//whether set IO_FLAGS = 0 or IO_FLAG_READ_ONLYfaiss::IO_FLAG_READ_ONLY\n+\t\tindexReader = faiss::read_index(indexPathString.c_str(), faiss::IO_FLAG_READ_ONLY);\n+\t\treturn (jlong) indexReader;\n+\t} \n+\tcatch(...) {\n+        if (indexReader) delete indexReader;\n+        catch_cpp_exception_and_throw_java(env);\t\n+\t}\n+\treturn NULL;\n+}\n+\n+/**\n+ * When autoclose class do close, then delete the pointer\n+ * Method GC pointer\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_gc\n+(JNIEnv* env, jclass cls,  jlong indexPointer)\n+{\n+\ttry {\n+\t\tfaiss::Index *indexWrapper = reinterpret_cast<faiss::Index*>(indexPointer);\n+        has_exception_in_stack(env);\n+        delete indexWrapper;\n+        has_exception_in_stack(env);\n+    }\n+    catch (...) {\n+        catch_cpp_exception_and_throw_java(env);\n+    }\n+}\n+\n+/**\n+ * Method: Global Init\n+ *\n+ */\n+JNIEXPORT void JNICALL Java_com_amazon_opendistroforelasticsearch_knn_index_faiss_v164_KNNFIndex_initLibrary(JNIEnv *, jclass)\n+{\n+\t//set thread 1 cause ES has Search thread\n+\t//TODO make it different at search and write\n+//\tomp_set_num_threads(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 271}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0Njk3MQ==", "bodyText": "I see. I think we should add a different file extension for faiss graphs as opposed to nmslib graphs. Maybe .faiss_hnsw.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562946971", "createdAt": "2021-01-22T22:23:36Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -151,12 +153,22 @@ private void onRemoval(RemovalNotification<String, KNNIndexCacheEntry> removalNo\n      */\n     public KNNIndex getIndex(String key, final String indexName) {\n         try {\n+            //TODO if Type Not consistent", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU3NDQwNQ=="}, "originalCommit": {"oid": "1a44194c9439c15bf073e62a0e61137ab5b9a301"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0NzU4OA==", "bodyText": "Seems to me that knnIndex and knnFindex should inherit from some kind of abstract class.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#discussion_r562947588", "createdAt": "2021-01-22T22:25:22Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -320,22 +339,52 @@ public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throw\n      * upon expiration of the cache.\n      */\n     private static class KNNIndexCacheEntry {\n+\n         private final KNNIndex knnIndex;\n+        private final KNNFIndex knnFindex;\n         private final String indexPathUrl;\n         private final String esIndexName;\n         private final WatcherHandle<FileWatcher> fileWatcherHandle;\n \n         private KNNIndexCacheEntry(final KNNIndex knnIndex, final String indexPathUrl, final String esIndexName,\n                                    final WatcherHandle<FileWatcher> fileWatcherHandle) {\n             this.knnIndex = knnIndex;\n+            this.knnFindex = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37a523a778eaed5959175fbe8d1e202721eafac"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9056b858d7f2fab56fdb885a7184c9d3a6316b60", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/9056b858d7f2fab56fdb885a7184c9d3a6316b60", "committedDate": "2021-01-24T13:04:27Z", "message": "1. Update Submodule FAISS to new version\n2. Remove no useful libfaiss.a\n3. Update JniFaiss CmakeLists.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a33625cbe034be7b04f19c638bb46724d6384ff1", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/a33625cbe034be7b04f19c638bb46724d6384ff1", "committedDate": "2021-01-24T13:38:05Z", "message": "1. Update Submodule FAISS to new version V1.6.5(HASH:88eabe9)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee0a3fe92a72855c6177627bca1a6c103991615b", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ee0a3fe92a72855c6177627bca1a6c103991615b", "committedDate": "2021-01-24T13:41:58Z", "message": "1. Update Submodule FAISS to new version V1.6.5(HASH:88eabe9)\n2. Remove no use comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d613095a3a418c76dde0f8020c2334eaad1b2c8a", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d613095a3a418c76dde0f8020c2334eaad1b2c8a", "committedDate": "2021-01-24T13:52:49Z", "message": "1. Remove nouse CI branches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7715563c70b2850b86bff2fe4358791d7b636008", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/7715563c70b2850b86bff2fe4358791d7b636008", "committedDate": "2021-01-24T14:04:20Z", "message": "Merge pull request #14 from luyuncheng/faiss_dev\n\nAdd NmsLib Version And Faiss Version into KNN Plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82671ad0d0818d3b69ee42de62f671cb78ba1d48", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/82671ad0d0818d3b69ee42de62f671cb78ba1d48", "committedDate": "2021-01-25T05:10:13Z", "message": "1. Fixed Indentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bea16d6d5b6c8c48f8b44991c7335e21ed04465e", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/bea16d6d5b6c8c48f8b44991c7335e21ed04465e", "committedDate": "2021-01-25T07:01:14Z", "message": "1. Make KNNIndex as abstract class\n2. Add KNNNmsLibIndex and KNNFaissIndex inherit the KNNIndex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dc4f1fa6786f004a603e1853fddfd666c431594", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3dc4f1fa6786f004a603e1853fddfd666c431594", "committedDate": "2021-01-25T08:01:56Z", "message": "1. Make KNNIndex as abstract class\n2. Add KNNNmsLibIndex and KNNFaissIndex inherit the KNNIndex\n3. Move JNITests into JNINmsLibTests\n4. Add New JNITests which would mixed knnEngine, and test with exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1207bac03b2a5d097bdb59684b273dbb525b6d8e", "author": {"user": {"login": "luyuncheng", "name": null}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1207bac03b2a5d097bdb59684b273dbb525b6d8e", "committedDate": "2021-01-25T08:15:07Z", "message": "Merge pull request #15 from luyuncheng/opendistro-faiss_dev\n\nMake KNNIndex as abstract class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc1ODg2MjQ1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#pullrequestreview-575886245", "createdAt": "2021-01-25T23:15:03Z", "commit": {"oid": "1207bac03b2a5d097bdb59684b273dbb525b6d8e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2NTk1Njk0", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#pullrequestreview-576595694", "createdAt": "2021-01-26T17:36:52Z", "commit": {"oid": "1207bac03b2a5d097bdb59684b273dbb525b6d8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2ODMyNTUz", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/285#pullrequestreview-576832553", "createdAt": "2021-01-26T22:56:05Z", "commit": {"oid": "1207bac03b2a5d097bdb59684b273dbb525b6d8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1295, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}