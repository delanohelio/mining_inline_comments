{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MjEzNjc0", "number": 97, "title": "Added index cache information in stats", "bodyText": "Issue #, if available:\n#69\nDescription of changes:\nIncreasing cache visibility by adding a node stat, indices_in_cache, that maps index names to the number of graphs they have in the cache and the total graph_memory_usage that they are taking up in the cache (in KB).\nFor example,\n\"indices_in_cache\" : {\n    \"myindex\" : {\n        \"graph_memory_usage\" : 2,\n        \"graph_count\" : 2\n    }\n},\n\nIn order to implement this, a few changes had to be made to the KNNIndexCache.\n\nIn KNNIndexCacheEntry, the EsIndexName and the indexPathUrl were added as members\nKNNIndexCache implements Closeable so that when the cache is finished being used in tests, the executor gets properly shutdown so that no threads leak\nThe following get functions were added: getWeightInKilobytes(String indexName), getGraphNamesForIndex(String indexName), getIndicesCacheStats()\n2 eviction methods were added as well: 1 to evict based on graph name (segment path), 1 evicts all entries from the cache. These were needed to test functionality related to the indices_in_cache stat, however, they will be needed for the clear cache API in the future.\n\nIn order to test, I created a ESSingleNodeTestCase test case for KNNIndexCache.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-23T21:38:13Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/97", "merged": true, "mergeCommit": {"oid": "58e2c22eb5807be31cffb5844a52e58fc4f1e3dc"}, "closed": true, "closedAt": "2020-05-01T20:15:49Z", "author": {"login": "jmazanec15"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcajqrCAH2gAyNDA4MjEzNjc0OmFiOWJjMTczZTliZmYwNDBmNjMxOTc0ZTY4MzdmMDEwY2VkMzhjZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdEd9nAFqTQwNDI2NDA5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab9bc173e9bff040f631974e6837f010ced38cef", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ab9bc173e9bff040f631974e6837f010ced38cef", "committedDate": "2020-04-23T21:21:24Z", "message": "added index cache information in stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82b5db0a1610b15cacf524c77faa83350a760139", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/82b5db0a1610b15cacf524c77faa83350a760139", "committedDate": "2020-04-23T21:38:00Z", "message": "updated readme"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NjY4MDY2", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/97#pullrequestreview-399668066", "createdAt": "2020-04-24T06:20:16Z", "commit": {"oid": "82b5db0a1610b15cacf524c77faa83350a760139"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNjoyMDoxNlrOGLISzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNjo0NjoyMFrOGLJAIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyMzQwNA==", "bodyText": "returns Map of index stats?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/97#discussion_r414323404", "createdAt": "2020-04-24T06:20:16Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -147,6 +162,35 @@ public CacheStats getStats() {\n         return cache.stats();\n     }\n \n+    /**\n+     * Get the Elasticsearch indices currently loaded into the Cache\n+     *\n+     * @return Set containing all of the Elasticsearch indices in the cache", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82b5db0a1610b15cacf524c77faa83350a760139"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyOTA2MQ==", "bodyText": "Let us add info log here to help in debugging something like manually evicted all graphs from cache", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/97#discussion_r414329061", "createdAt": "2020-04-24T06:33:15Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -174,6 +230,22 @@ public void setCacheCapacityReached(Boolean value) {\n         cacheCapacityReached.set(value);\n     }\n \n+    /**\n+     * Evict a graph in the cache manually\n+     *\n+     * @param indexFilePath path to segment file. Also, key in cache\n+     */\n+    public void evictGraphFromCache(String indexFilePath) {\n+        cache.invalidate(indexFilePath);\n+    }\n+\n+    /**\n+     * Evict all graphs in the cache manually\n+     */\n+    public void evictAllGraphsFromCache() {\n+        cache.invalidateAll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82b5db0a1610b15cacf524c77faa83350a760139"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzMDEyMQ==", "bodyText": "lets add info log here Manually evicted graph from cache, indexFilePath, indexname", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/97#discussion_r414330121", "createdAt": "2020-04-24T06:35:42Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -174,6 +230,22 @@ public void setCacheCapacityReached(Boolean value) {\n         cacheCapacityReached.set(value);\n     }\n \n+    /**\n+     * Evict a graph in the cache manually\n+     *\n+     * @param indexFilePath path to segment file. Also, key in cache\n+     */\n+    public void evictGraphFromCache(String indexFilePath) {\n+        cache.invalidate(indexFilePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82b5db0a1610b15cacf524c77faa83350a760139"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzMDc1OQ==", "bodyText": "nit: final String indexName", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/97#discussion_r414330759", "createdAt": "2020-04-24T06:37:04Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -156,6 +200,18 @@ public Long getWeightInKilobytes() {\n         return cache.asMap().values().stream().map(KNNIndexCacheEntry::getKnnIndex).mapToLong(KNNIndex::getIndexSize).sum();\n     }\n \n+    /**\n+     * Returns the current weight of an index in the cache in KiloBytes\n+     *\n+     * @param indexName Name if index to get the weight for\n+     * @return Weight of the index in the cache in kilobytes\n+     */\n+    public Long getWeightInKilobytes(String indexName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82b5db0a1610b15cacf524c77faa83350a760139"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzNTAwOA==", "bodyText": "statValues.get(indexName).put(GRAPH_COUNT, ((Integer) statValues.get(indexName).getorDefault(GRAPH_COUNT, 0)) + 1)", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/97#discussion_r414335008", "createdAt": "2020-04-24T06:46:20Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -147,6 +162,35 @@ public CacheStats getStats() {\n         return cache.stats();\n     }\n \n+    /**\n+     * Get the Elasticsearch indices currently loaded into the Cache\n+     *\n+     * @return Set containing all of the Elasticsearch indices in the cache\n+     */\n+    public Map<String, Map<String, Object>> getIndicesCacheStats() {\n+        Map<String, Map<String, Object>> statValues = new HashMap<>();\n+        String indexName;\n+        for (Map.Entry<String, KNNIndexCacheEntry> index : cache.asMap().entrySet()) {\n+            indexName = index.getValue().getEsIndexName();\n+            statValues.putIfAbsent(indexName, new HashMap<>());\n+\n+            statValues.get(indexName).putIfAbsent(GRAPH_COUNT, 0);\n+            statValues.get(indexName).put(GRAPH_COUNT, ((Integer) statValues.get(indexName).get(GRAPH_COUNT)) + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82b5db0a1610b15cacf524c77faa83350a760139"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4584b8333cf134b5c9b105283d3b8b21b5aa327", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/e4584b8333cf134b5c9b105283d3b8b21b5aa327", "committedDate": "2020-04-27T18:02:12Z", "message": "Add graph memory usage as a percentage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58692f48cde5258f147f9441f636e54a890c8749", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/58692f48cde5258f147f9441f636e54a890c8749", "committedDate": "2020-04-27T18:03:23Z", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into index-cache-stats"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjY0MDkx", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/97#pullrequestreview-404264091", "createdAt": "2020-05-01T16:42:14Z", "commit": {"oid": "58692f48cde5258f147f9441f636e54a890c8749"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1351, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}