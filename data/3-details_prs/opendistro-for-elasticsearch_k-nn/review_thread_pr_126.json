{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMTE0NjYx", "number": 126, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0NDowN1rOD_7NKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDowMzozMlrOEEf3kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzU2OTA0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0NDowN1rOGa4bVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMjowOToxMVrOGiMIqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MDY2Mg==", "bodyText": "This method would be called only once when there is cache miss. The efsearch value passed is stored in the\nIndexWrapper as part of init call. So ef_search passed in subsequent queries would not be reflected.\nIdeal way is to plumb the ef_search through queryIndex function from KNNWeight. As part of this function in the jni, we could set the  ef_search usingsetQueryTimeParams if ef_search is not null otherwise just use the existing value.\nWe need to be careful while calling setQueryTimeParams because at the same time it is possible some query is already referencing this object and could cause segmentation faults. We need to kind of ensure only one thread is setting/getting ef_search .", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r430840662", "createdAt": "2020-05-27T03:44:07Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -273,11 +275,12 @@ public void evictAllGraphsFromCache() {\n      *\n      * @param indexPathUrl path for serialized hnsw graph\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"\n      * @return KNNIndex holding the heap pointer of the loaded graph\n      * @throws Exception Exception could occur when registering the index path\n      * to Resource watcher or if the JNI call throws\n      */\n-    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throws Exception {\n+    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName, int efSearch) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMDc5MA==", "bodyText": "Ideal way is to plumb the ef_search through queryIndex function from KNNWeight. As part of this function in the jni, we could set the ef_search using setQueryTimeParams if ef_search is not null otherwise just use the existing value.\n\nThanks for pointing that out. I need to renew license on CLion for getting this part done.\n\nWe need to be careful while calling setQueryTimeParams because at the same time it is possible some query is already referencing this object and could cause segmentation faults. We need to kind of ensure only one thread is setting/getting ef_search .\n\nThanks for reminder. My first thought is to use writeLock in queryIndex if ef_search is not null. Might need to put some thought into this. Suggestion is welcome.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r431530790", "createdAt": "2020-05-28T01:21:56Z", "author": {"login": "chenqi0805"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -273,11 +275,12 @@ public void evictAllGraphsFromCache() {\n      *\n      * @param indexPathUrl path for serialized hnsw graph\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"\n      * @return KNNIndex holding the heap pointer of the loaded graph\n      * @throws Exception Exception could occur when registering the index path\n      * to Resource watcher or if the JNI call throws\n      */\n-    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throws Exception {\n+    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName, int efSearch) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MDY2Mg=="}, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5MDQxMg==", "bodyText": "I suspect that supporting a dynamic efSearch parameter would either require:\n\nSynchronizing search queries from multiple threads onto a shared index (which would likely hurt query performance significantly)\nRequire changes to the KNN library dependency to make the efSearch parameter a local parameter of the KNN query structure rather than a member of the index. It's currently a class member of the HNSW index, which is why the opendistro plugin is setting it once on index load rather than supporting per query, since mutations within queries would affect unrelated queries (see here for one example usage of the member variable).", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r431990412", "createdAt": "2020-05-28T17:04:45Z", "author": {"login": "jschmitz28"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -273,11 +275,12 @@ public void evictAllGraphsFromCache() {\n      *\n      * @param indexPathUrl path for serialized hnsw graph\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"\n      * @return KNNIndex holding the heap pointer of the loaded graph\n      * @throws Exception Exception could occur when registering the index path\n      * to Resource watcher or if the JNI call throws\n      */\n-    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throws Exception {\n+    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName, int efSearch) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MDY2Mg=="}, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1MjY1NQ==", "bodyText": "Agree. Synchronizing could hurt performance because of locking. At this point to me, Approach 2 mentioned by @jschmitz28  seems to be best way to achieve this.\nOther solution i could think of is, make ef_search setting dynamic Elasticsearch index setting(currently its static index setting, once define cannot be changed). On the change of this setting, we could evict the graphs from memory and load freshly with the new ef_search.  We already do this eviction when we change few settings. Example here\n\nThis removes the indexing cost to rebuild the whole index which is a pain point today and on next query graphs should be available for search.\nAvoid errors possible from mutation.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r433052655", "createdAt": "2020-06-01T05:50:36Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -273,11 +275,12 @@ public void evictAllGraphsFromCache() {\n      *\n      * @param indexPathUrl path for serialized hnsw graph\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"\n      * @return KNNIndex holding the heap pointer of the loaded graph\n      * @throws Exception Exception could occur when registering the index path\n      * to Resource watcher or if the JNI call throws\n      */\n-    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throws Exception {\n+    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName, int efSearch) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MDY2Mg=="}, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0MjQwMg==", "bodyText": "@vamshin I have two more points to clarify regarding your solution, first UX and second implementation:\n(1) dynamical setting still needs to be updated through index settings API: https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-update-settings.html\nso I think UX is going to be different from #116 . Is that OK? Otherwise I will return to approach 2 by @jschmitz28 .\n(2) On trying to implemnt your solution by defining ef_search to be index scope and dynamic. As you mentioned, we also need to add custom setting update consumer for that ef_search. Now the issue is that IndexModule has not yet been passed into KNNSettings so we do not have way to add the consumer for index scope settings.\nFrom my observation, we can implement\nhttps://github.com/elastic/elasticsearch/blob/853dd1b873d02d04231c32722d4784c9da1068dc/server/src/main/java/org/elasticsearch/plugins/Plugin.java#L131\nin KNNPlugin, then we add an accept index module API in KNNSetting. Thought?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r436442402", "createdAt": "2020-06-08T03:36:02Z", "author": {"login": "chenqi0805"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -273,11 +275,12 @@ public void evictAllGraphsFromCache() {\n      *\n      * @param indexPathUrl path for serialized hnsw graph\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"\n      * @return KNNIndex holding the heap pointer of the loaded graph\n      * @throws Exception Exception could occur when registering the index path\n      * to Resource watcher or if the JNI call throws\n      */\n-    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throws Exception {\n+    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName, int efSearch) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MDY2Mg=="}, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk1OTg0Mg==", "bodyText": "@chenqi0805\n(1) Seems to be perfectly ok to change that.\nRegarding the approach mentioned by @jschmitz28  we could create an issue in the nmslib and ask their opinion about this change? Not sure if they had to do this way for some optimizations.\n(2) Makes sense.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r436959842", "createdAt": "2020-06-08T19:47:59Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -273,11 +275,12 @@ public void evictAllGraphsFromCache() {\n      *\n      * @param indexPathUrl path for serialized hnsw graph\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"\n      * @return KNNIndex holding the heap pointer of the loaded graph\n      * @throws Exception Exception could occur when registering the index path\n      * to Resource watcher or if the JNI call throws\n      */\n-    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throws Exception {\n+    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName, int efSearch) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MDY2Mg=="}, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUwMzU5NA==", "bodyText": "nmslib/nmslib#442", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438503594", "createdAt": "2020-06-11T02:09:11Z", "author": {"login": "chenqi0805"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -273,11 +275,12 @@ public void evictAllGraphsFromCache() {\n      *\n      * @param indexPathUrl path for serialized hnsw graph\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"\n      * @return KNNIndex holding the heap pointer of the loaded graph\n      * @throws Exception Exception could occur when registering the index path\n      * to Resource watcher or if the JNI call throws\n      */\n-    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throws Exception {\n+    public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName, int efSearch) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MDY2Mg=="}, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzU3MjI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0NjoyMlrOGa4dVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0NjoyMlrOGa4dVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MTE3Mw==", "bodyText": "We do not have to change this method.  This method can always read the default setting so that IndexWrapper can refer it when ef_search is null.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r430841173", "createdAt": "2020-05-27T03:46:22Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -290,7 +293,8 @@ public KNNIndexCacheEntry loadIndex(String indexPathUrl, String indexName) throw\n         // the entry\n         fileWatcher.init();\n \n-        final KNNIndex knnIndex = KNNIndex.loadIndex(indexPathUrl, getQueryParams(indexName), KNNSettings.getSpaceType(indexName));\n+        final KNNIndex knnIndex = KNNIndex.loadIndex(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDc1NjI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxODoxODozNlrOGcnWVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMTo1MjoxMlrOGiHkcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1ODAwNQ==", "bodyText": "I would say if you include quotes include the source. Also, I think this description can be expanded, or a link to the NMSLIB documentation that discusses it would be helpful. Here is a link", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r432658005", "createdAt": "2020-05-29T18:18:36Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -144,11 +144,12 @@ private void onRemoval(RemovalNotification<String, KNNIndexCacheEntry> removalNo\n      *\n      * @param key indexPath where the serialized hnsw graph is stored\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyODc4Ng==", "bodyText": "Thank you for comment. Good to remember that although the current line is outdated.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438428786", "createdAt": "2020-06-10T21:52:12Z", "author": {"login": "chenqi0805"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexCache.java", "diffHunk": "@@ -144,11 +144,12 @@ private void onRemoval(RemovalNotification<String, KNNIndexCacheEntry> removalNo\n      *\n      * @param key indexPath where the serialized hnsw graph is stored\n      * @param indexName index name\n+     * @param efSearch HNSW parameter that represents \"the size of the dynamic list for the nearest neighbors\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1ODAwNQ=="}, "originalCommit": {"oid": "7e06873aef0afee53afbe02ea8f905d8fb982696"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNzc2MDc3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNDo1MTo0MVrOGhkxuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNDo1MTo0MVrOGhkxuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1ODc0Nw==", "bodyText": "we could remove this comment. Cache rebuild already seem to happen in a dedicated thread", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r437858747", "createdAt": "2020-06-10T04:51:41Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {\n+                    logger.debug(\"The value of setting [{}] changed to [{}]\", KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    latestSettings.put(KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    // spawn a thread", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNzc2Mzg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNDo1MzozNFrOGhkzjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoyNToxM1rOGh87IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1OTIxNQ==", "bodyText": "rebuild whole cache might not be necessary as we could lose graphs of other indices. Once we have the clear cache api #68 , we could selectively evict entries of a particular index. We could leave a TODO  to fix after clear cache api is built. Would be great to create an issue as well to just track the fix?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r437859215", "createdAt": "2020-06-10T04:53:34Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {\n+                    logger.debug(\"The value of setting [{}] changed to [{}]\", KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    latestSettings.put(KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    // spawn a thread\n+                    KNNWeight.knnIndexCache.rebuild();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NDM2OQ==", "bodyText": "Yes, I agree once we have functionality to manually remove and load an index's graphs, we should implement a reload function that operates at the index level. For now, a TODO will be fine.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438254369", "createdAt": "2020-06-10T16:25:13Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {\n+                    logger.debug(\"The value of setting [{}] changed to [{}]\", KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    latestSettings.put(KNN_ALGO_PARAM_EF_SEARCH, newVal);\n+                    // spawn a thread\n+                    KNNWeight.knnIndexCache.rebuild();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1OTIxNQ=="}, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMDIwOTg0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoyODoxOVrOGh9CpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoyODoxOVrOGh9CpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NjI5Mg==", "bodyText": "Nit: Can you prepend log statement with \"[KNN] \" so that it is easier to identify when going through logs?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438256292", "createdAt": "2020-06-10T16:28:19Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {\n+                    logger.debug(\"The value of setting [{}] changed to [{}]\", KNN_ALGO_PARAM_EF_SEARCH, newVal);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMDIxOTQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjozMDo1NVrOGh9JCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMzo0MzozMlrOGiJ0fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NzkzMA==", "bodyText": "Just curious, what happens if a invalid parameter is passed in? Does it fail gracefully?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438257930", "createdAt": "2020-06-10T16:30:55Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4NDc3Mw==", "bodyText": "Good point to check. I expect the validator in INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING should handle it.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438284773", "createdAt": "2020-06-10T17:15:54Z", "author": {"login": "chenqi0805"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NzkzMA=="}, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NDg3Mw==", "bodyText": "I have expanded testUpdateIndexSetting to cover invalid update now.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438454873", "createdAt": "2020-06-10T23:06:58Z", "author": {"login": "chenqi0805"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NzkzMA=="}, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ2NTY2Mg==", "bodyText": "Great thanks", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438465662", "createdAt": "2020-06-10T23:43:32Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNSettings.java", "diffHunk": "@@ -396,4 +398,15 @@ public void setClusterService(ClusterService clusterService) {\n             }\n         }\n     }\n+\n+    public void onIndexModule(IndexModule module) {\n+        module.addSettingsUpdateConsumer(\n+                INDEX_KNN_ALGO_PARAM_EF_SEARCH_SETTING,\n+                newVal -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NzkzMA=="}, "originalCommit": {"oid": "498b4bf02c68e90860059b5df82ab0ef64dd1ed5"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMTUxODkwOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNESSettingsTestIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDowMzozMlrOGiKLYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMTo1NzowNVrOGiL9Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3MTUyMw==", "bodyText": "I think the purpose of this test case is to confirm that the Index is evicted from the cache after the settings are updated. That being said, I think the test should be renamed testCacheRebuiltAfterUpdateIndexSettings.\nFurther more, instead of comparing deltas of hit and miss count, you can check that the cache is empty with the indices_in_cache stat. Then, you can just\n\nCreate index\nIndex sample docs\nSearch index\nConfirm index is present in cache\nUpdate index settings\nConfirm there are no indices in the cache.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438471523", "createdAt": "2020-06-11T00:03:32Z", "author": {"login": "jmazanec15"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNESSettingsTestIT.java", "diffHunk": "@@ -87,5 +91,73 @@ public void testCreateIndexWithInvalidSpaceType() throws IOException {\n             () -> createKnnIndex(INDEX_NAME, invalidSettings, createKnnIndexMapping(FIELD_NAME, 2)));\n         assertThat(ex.getMessage(), containsString(String.format(\"Unsupported space type: %s\", invalidSpaceType)));\n     }\n+\n+    public void testUpdateIndexSetting() throws IOException {\n+        Settings settings = Settings.builder()\n+                .put(\"index.knn\", true)\n+                .put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 512)\n+                .build();\n+        createKnnIndex(INDEX_NAME, settings, createKnnIndexMapping(FIELD_NAME, 2));\n+        assertEquals(\"512\", getIndexSettingByName(INDEX_NAME, KNNSettings.KNN_ALGO_PARAM_EF_SEARCH));\n+\n+        updateIndexSettings(INDEX_NAME, Settings.builder().put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 400));\n+        assertEquals(\"400\", getIndexSettingByName(INDEX_NAME, KNNSettings.KNN_ALGO_PARAM_EF_SEARCH));\n+\n+        Exception ex = expectThrows(ResponseException.class,\n+                () -> updateIndexSettings(INDEX_NAME,\n+                        Settings.builder().put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 1)));\n+        assertThat(ex.getMessage(),\n+                containsString(\"Failed to parse value [1] for setting [index.knn.algo_param.ef_search] must be >= 2\"));\n+    }\n+\n+    public void testKNNStatsAfterUpdateIndexSetting() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0aa1dc3c608afdd1c7580b814e3758d39ba3328b"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUwMDY1NA==", "bodyText": "Cool. Fixed.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/126#discussion_r438500654", "createdAt": "2020-06-11T01:57:05Z", "author": {"login": "chenqi0805"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNESSettingsTestIT.java", "diffHunk": "@@ -87,5 +91,73 @@ public void testCreateIndexWithInvalidSpaceType() throws IOException {\n             () -> createKnnIndex(INDEX_NAME, invalidSettings, createKnnIndexMapping(FIELD_NAME, 2)));\n         assertThat(ex.getMessage(), containsString(String.format(\"Unsupported space type: %s\", invalidSpaceType)));\n     }\n+\n+    public void testUpdateIndexSetting() throws IOException {\n+        Settings settings = Settings.builder()\n+                .put(\"index.knn\", true)\n+                .put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 512)\n+                .build();\n+        createKnnIndex(INDEX_NAME, settings, createKnnIndexMapping(FIELD_NAME, 2));\n+        assertEquals(\"512\", getIndexSettingByName(INDEX_NAME, KNNSettings.KNN_ALGO_PARAM_EF_SEARCH));\n+\n+        updateIndexSettings(INDEX_NAME, Settings.builder().put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 400));\n+        assertEquals(\"400\", getIndexSettingByName(INDEX_NAME, KNNSettings.KNN_ALGO_PARAM_EF_SEARCH));\n+\n+        Exception ex = expectThrows(ResponseException.class,\n+                () -> updateIndexSettings(INDEX_NAME,\n+                        Settings.builder().put(KNNSettings.KNN_ALGO_PARAM_EF_SEARCH, 1)));\n+        assertThat(ex.getMessage(),\n+                containsString(\"Failed to parse value [1] for setting [index.knn.algo_param.ef_search] must be >= 2\"));\n+    }\n+\n+    public void testKNNStatsAfterUpdateIndexSetting() throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3MTUyMw=="}, "originalCommit": {"oid": "0aa1dc3c608afdd1c7580b814e3758d39ba3328b"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2765, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}