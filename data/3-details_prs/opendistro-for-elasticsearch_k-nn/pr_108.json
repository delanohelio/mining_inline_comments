{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NzkwMjEz", "number": 108, "title": "ENH: throws Exception in KNNVectorFieldMapper.parse API when circuit breaker trips", "bodyText": "Issue #, if available:\n#96\nDescription of changes:\n\nThrows exception before parsing knn vector if the circuit breaker trips\nAdded two integration test cases\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-10T22:22:20Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108", "merged": true, "mergeCommit": {"oid": "7d42de926225bc01e703f41b3c9a40140e343f2b"}, "closed": true, "closedAt": "2020-05-19T19:22:10Z", "author": {"login": "chenqi0805"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgCrOegH2gAyNDE1NzkwMjEzOjA1YTg4NGE1ZjU1NjA4ZjQzYTJhZWE4YzQwNWQ3ZjU2MzdjMjI0MzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchpc3OgFqTQxMjk5MjY3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "05a884a5f55608f43a2aea8c405d7f5637c22432", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/05a884a5f55608f43a2aea8c405d7f5637c22432", "committedDate": "2020-05-10T22:18:41Z", "message": "ENH: Throws exception in KNNVectorFieldMapper.parse API when circuit trips and add IT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTk4NjM2", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#pullrequestreview-409598636", "createdAt": "2020-05-11T23:26:17Z", "commit": {"oid": "05a884a5f55608f43a2aea8c405d7f5637c22432"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMzoyNjoxOFrOGTw0Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMzoyNjoxOFrOGTw0Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NTg3OA==", "bodyText": "Should there also be a cluster setting like \"CircuitBreakerOnTripEnableWriteBlock\" so that users have the ability to opt out of the write block?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r423375878", "createdAt": "2020-05-11T23:26:18Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -242,6 +242,10 @@ public void parse(ParseContext context) throws IOException {\n                                                     \"update knn.plugin.enabled setting to true\");\n         }\n \n+        if (KNNSettings.isCircuitBreakerTriggered()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05a884a5f55608f43a2aea8c405d7f5637c22432"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzEzMzM3", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#pullrequestreview-409713337", "createdAt": "2020-05-12T05:43:47Z", "commit": {"oid": "05a884a5f55608f43a2aea8c405d7f5637c22432"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNTo0Mzo0N1rOGT21Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNTo0NToyNlrOGT23Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NDUxMQ==", "bodyText": "can we change message on the following lines \"Indexing knn vector fields is rejected as circuit breaker triggered. Check _opendistro/_knn/stats for detailed state\"", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r423474511", "createdAt": "2020-05-12T05:43:47Z", "author": {"login": "vamshin"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -242,6 +242,10 @@ public void parse(ParseContext context) throws IOException {\n                                                     \"update knn.plugin.enabled setting to true\");\n         }\n \n+        if (KNNSettings.isCircuitBreakerTriggered()) {\n+            throw new IllegalStateException(\"Cannot update KNN vector field when circuit breaker is triggered.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05a884a5f55608f43a2aea8c405d7f5637c22432"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTAwNw==", "bodyText": "As an extension to this same test case, can we unset knn.circuit_breaker.triggered flag and assert new doc could be added? Same with below test case.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r423475007", "createdAt": "2020-05-12T05:45:26Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNESIT.java", "diffHunk": "@@ -35,6 +35,20 @@ public void testAddKNNDoc() throws Exception {\n         addKnnDoc(INDEX_NAME, \"1\", FIELD_NAME, vector);\n     }\n \n+    /**\n+     * Block adding new docs to KNN index when circuit breaker trips\n+     */\n+    public void testAddKNNDocBlockedWhenCbTrips() throws Exception {\n+        createKnnIndex(INDEX_NAME, createKnnIndexMapping(FIELD_NAME, 2));\n+        updateClusterSettings(\"knn.circuit_breaker.triggered\", \"true\");\n+\n+        Float[] vector  = {6.0f, 6.0f};\n+        ResponseException ex = expectThrows(\n+                ResponseException.class, () -> addKnnDoc(INDEX_NAME, \"1\", FIELD_NAME, vector));\n+        assertThat(EntityUtils.toString(ex.getResponse().getEntity()),\n+                containsString(\"Cannot update KNN vector field when circuit breaker is triggered.\"));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05a884a5f55608f43a2aea8c405d7f5637c22432"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b69f89495a8f464500230d974633f671b074be9d", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b69f89495a8f464500230d974633f671b074be9d", "committedDate": "2020-05-14T16:13:56Z", "message": "Modify error message and enhance test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDAxNDAy", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#pullrequestreview-412001402", "createdAt": "2020-05-14T16:55:32Z", "commit": {"oid": "b69f89495a8f464500230d974633f671b074be9d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo1NTozMlrOGVll1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo1NTozMlrOGVll1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4OTE3Mg==", "bodyText": "That makes sense.", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r425289172", "createdAt": "2020-05-14T16:55:32Z", "author": {"login": "jmazanec15"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -242,6 +242,10 @@ public void parse(ParseContext context) throws IOException {\n                                                     \"update knn.plugin.enabled setting to true\");\n         }\n \n+        if (KNNSettings.isCircuitBreakerTriggered()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NTg3OA=="}, "originalCommit": {"oid": "05a884a5f55608f43a2aea8c405d7f5637c22432"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f09e6681361f20358e245ff1bc501179c006b86", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1f09e6681361f20358e245ff1bc501179c006b86", "committedDate": "2020-05-15T20:36:02Z", "message": "TST: add and search when CB trips"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTkyNjc5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#pullrequestreview-412992679", "createdAt": "2020-05-15T22:03:13Z", "commit": {"oid": "1f09e6681361f20358e245ff1bc501179c006b86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1359, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}