{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjYwODg5", "number": 235, "title": "Fix script statistics flaky test case", "bodyText": "Issue #, if available:\nDescription of changes:\nScript compilation count statistic in tests should be one. However, there are some cases where it may be 2. This change allows the test case to pass when compilation count is either 1 or 1 greater than what it was before a given query.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-22T02:58:01Z", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235", "merged": true, "mergeCommit": {"oid": "76bdfaa711f7f1623862ed2888ee9c58c372a647"}, "closed": true, "closedAt": "2020-09-22T18:42:45Z", "author": {"login": "jmazanec15"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLJvvzAH2gAyNDkwNjYwODg5OmNiNDFhMWJhZjMzMGMyMTlmODE0N2NlMDlkZTQwYTM2MmMwNjAwNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLcfTSAFqTQ5Mzc0Njc2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cb41a1baf330c219f8147ce09de40a362c060043", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/cb41a1baf330c219f8147ce09de40a362c060043", "committedDate": "2020-09-21T20:51:42Z", "message": "change space -> space_type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2290135f32eb270e3da76b36677992897e67a993", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2290135f32eb270e3da76b36677992897e67a993", "committedDate": "2020-09-22T02:43:55Z", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/k-NN"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b052c70e82ffe8dad1bf143874d1fa03050f4bb7", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b052c70e82ffe8dad1bf143874d1fa03050f4bb7", "committedDate": "2020-09-22T02:55:55Z", "message": "fix flaky test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTAwMzAz", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#pullrequestreview-493100303", "createdAt": "2020-09-22T03:01:31Z", "commit": {"oid": "b052c70e82ffe8dad1bf143874d1fa03050f4bb7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzowMTozMVrOHVoyIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzowMTozMVrOHVoyIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1MDMzOQ==", "bodyText": "Why we need OR condition why not just\n(int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == initialScriptCompilations + 1)", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492450339", "createdAt": "2020-09-22T03:01:31Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java", "diffHunk": "@@ -205,7 +207,8 @@ public void testScriptStats_singleShard() throws Exception {\n                 StatNames.SCRIPT_QUERY_REQUESTS.getName())\n         );\n         nodeStats = parseNodeStatsResponse(EntityUtils.toString(response.getEntity()));\n-        assertEquals(1, (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())));\n+        assertTrue((int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == 1 ||\n+                (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == initialScriptCompilations + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b052c70e82ffe8dad1bf143874d1fa03050f4bb7"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9", "author": {"user": {"login": "jmazanec15", "name": "Jack Mazanec"}}, "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/03b1f9802146d8c9faa401cf12f8fe75365a97a9", "committedDate": "2020-09-22T16:24:08Z", "message": "add cache clear"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjg4Nzk5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#pullrequestreview-493688799", "createdAt": "2020-09-22T17:25:25Z", "commit": {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzoyNToyNVrOHWEz_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzoyNToyNVrOHWEz_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwOTU2Nw==", "bodyText": "Is this line required?", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492909567", "createdAt": "2020-09-22T17:25:25Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -543,6 +543,16 @@ protected void clearCache() throws Exception {\n         updateClusterSettings(KNNSettings.KNN_CACHE_ITEM_EXPIRY_TIME_MINUTES, null);\n     }\n \n+    /**\n+     * Clear script cache\n+     *\n+     * Remove k-NN script from script cache so that it has to be recompiled\n+     */\n+    protected void clearScriptCache() throws Exception {\n+        updateClusterSettings(\"script.context.score.cache_expire\", \"0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzQ2NzYx", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#pullrequestreview-493746761", "createdAt": "2020-09-22T18:41:43Z", "commit": {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo0MTo0M1rOHWHm5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo0MTo0M1rOHWHm5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1NTM2NA==", "bodyText": "Got it. Thanks", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492955364", "createdAt": "2020-09-22T18:41:43Z", "author": {"login": "vamshin"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -543,6 +543,16 @@ protected void clearCache() throws Exception {\n         updateClusterSettings(KNNSettings.KNN_CACHE_ITEM_EXPIRY_TIME_MINUTES, null);\n     }\n \n+    /**\n+     * Clear script cache\n+     *\n+     * Remove k-NN script from script cache so that it has to be recompiled\n+     */\n+    protected void clearScriptCache() throws Exception {\n+        updateClusterSettings(\"script.context.score.cache_expire\", \"0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwOTU2Nw=="}, "originalCommit": {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1272, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}