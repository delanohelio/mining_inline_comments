{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2ODQzNTY0", "number": 767, "title": "Handle odd job names that do not match DNS_SUBDOMAIN", "bodyText": "https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#dns-subdomain-names is a bit vague but I found insufficient sanitization here.", "createdAt": "2020-04-21T18:50:34Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/767", "merged": true, "mergeCommit": {"oid": "0fbb16c0382c781a3a337f97ae156926eabb5bb9"}, "closed": true, "closedAt": "2020-04-22T07:23:42Z", "author": {"login": "jglick"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZ4RZ6gH2gAyNDA2ODQzNTY0OjE2OWYwZTI4MWMzNTIwMGYyOThiMjFmYmE0ZjVjYTExYjFmNGZhMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaDbdIgFqTM5NzkyNzk3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "169f0e281c35200f298b21fba4f5ca11b1f4fa10", "author": {"user": {"login": "jglick", "name": "Jesse Glick"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/169f0e281c35200f298b21fba4f5ca11b1f4fa10", "committedDate": "2020-04-21T18:47:53Z", "message": "Handle odd job names that do not match DNS_SUBDOMAIN"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTg0MTg0", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/767#pullrequestreview-397584184", "createdAt": "2020-04-21T18:52:22Z", "commit": {"oid": "169f0e281c35200f298b21fba4f5ca11b1f4fa10"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODo1MjoyMlrOGJTbcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODo1Mjo0N1rOGJTccQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQwODY4OQ==", "bodyText": "Without fix:\n\u2026 WARNING\to.c.j.p.k.KubernetesLauncher#launch: Error in provisioning; agent=KubernetesSlave name: whatever...-1-hn921-fcjl9-m6w34, template=PodTemplate{, name='whatever..._1-hn921-fcjl9', \u2026}\nio.fabric8.kubernetes.client.KubernetesClientException: Failure executing: POST at: https://\u2026/api/v1/namespaces/kubernetes-plugin-test/pods. Message: Pod \"whatever...-1-hn921-fcjl9-m6w34\" is invalid: metadata.name: Invalid value: \"whatever...-1-hn921-fcjl9-m6w34\": a DNS-1123 subdomain must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character (e.g. 'example.com', regex used for validation is '[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*'). Received status: Status(apiVersion=v1, code=422, details=\u2026, reason=Invalid, status=Failure, additionalProperties={}).\n\tat io.fabric8.kubernetes.client.dsl.base.OperationSupport.requestFailure(OperationSupport.java:568)\n\tat io.fabric8.kubernetes.client.dsl.base.OperationSupport.assertResponseCode(OperationSupport.java:507)\n\tat io.fabric8.kubernetes.client.dsl.base.OperationSupport.handleResponse(OperationSupport.java:471)\n\tat io.fabric8.kubernetes.client.dsl.base.OperationSupport.handleResponse(OperationSupport.java:430)\n\tat io.fabric8.kubernetes.client.dsl.base.OperationSupport.handleCreate(OperationSupport.java:251)\n\tat io.fabric8.kubernetes.client.dsl.base.BaseOperation.handleCreate(BaseOperation.java:802)\n\tat io.fabric8.kubernetes.client.dsl.base.BaseOperation.create(BaseOperation.java:322)\n\tat io.fabric8.kubernetes.client.dsl.base.BaseOperation.create(BaseOperation.java:318)\n\tat org.csanchez.jenkins.plugins.kubernetes.KubernetesLauncher.launch(KubernetesLauncher.java:125)\n\tat hudson.slaves.SlaveComputer.lambda$_connect$0(SlaveComputer.java:292)\n\tat \u2026", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/767#discussion_r412408689", "createdAt": "2020-04-21T18:52:22Z", "author": {"login": "jglick"}, "path": "src/test/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodNameTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.csanchez.jenkins.plugins.kubernetes.pipeline;\n+\n+import static org.csanchez.jenkins.plugins.kubernetes.KubernetesTestUtil.deletePods;\n+import static org.csanchez.jenkins.plugins.kubernetes.KubernetesTestUtil.getLabels;\n+import org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition;\n+import org.jenkinsci.plugins.workflow.job.WorkflowJob;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class PodNameTest extends AbstractKubernetesPipelineTest {\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        deletePods(cloud.connect(), getLabels(cloud, this, name), false);\n+    }\n+\n+    @Test\n+    public void trailingDots() throws Exception {\n+        WorkflowJob p = r.createProject(WorkflowJob.class, \"whatever...\");\n+        p.setDefinition(new CpsFlowDefinition(\"podTemplate {node(POD_LABEL) {sh 'echo ok'}}\", true));\n+        r.buildAndAssertSuccess(p);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "169f0e281c35200f298b21fba4f5ca11b1f4fa10"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQwODk0NQ==", "bodyText": "copied directly from error message", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/767#discussion_r412408945", "createdAt": "2020-04-21T18:52:47Z", "author": {"login": "jglick"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesSlave.java", "diffHunk": "@@ -227,7 +227,11 @@ static String getSlaveName(PodTemplate template) {\n         name = name.replaceAll(\"[ _]\", \"-\").toLowerCase();\n         // keep it under 63 chars (62 is used to account for the '-')\n         name = name.substring(0, Math.min(name.length(), 62 - randString.length()));\n-        return String.format(\"%s-%s\", name, randString);\n+        String slaveName = String.format(\"%s-%s\", name, randString);\n+        if (!slaveName.matches(\"[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "169f0e281c35200f298b21fba4f5ca11b1f4fa10"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjA4MTk2", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/767#pullrequestreview-397608196", "createdAt": "2020-04-21T19:26:04Z", "commit": {"oid": "169f0e281c35200f298b21fba4f5ca11b1f4fa10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3OTEwMjA5", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/767#pullrequestreview-397910209", "createdAt": "2020-04-22T07:22:51Z", "commit": {"oid": "169f0e281c35200f298b21fba4f5ca11b1f4fa10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3OTI3OTc4", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/767#pullrequestreview-397927978", "createdAt": "2020-04-22T07:47:49Z", "commit": {"oid": "169f0e281c35200f298b21fba4f5ca11b1f4fa10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 109, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}