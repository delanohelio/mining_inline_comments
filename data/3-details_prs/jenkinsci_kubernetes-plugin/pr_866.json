{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODMwMDc5", "number": 866, "title": "Fix: Concurrency limit 0 must mean unlimited for upgradeability", "bodyText": "Reverts the logical part of #828, improves the help text, and amends the test which proves that 0 means unlimited.\nI tried hard in #864 and #865 to have 0 become \"disabled,\" because that's what made sense to me when #828 was filed, but for upgradeability reasons 0 must keep its original meaning of \"unlimited.\"", "createdAt": "2020-10-09T21:31:07Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866", "merged": true, "mergeCommit": {"oid": "a3227ae0df8310edfe2fbb4273d68ca7e6191678"}, "closed": true, "closedAt": "2020-10-13T08:14:45Z", "author": {"login": "schottsfired"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ8waAAH2gAyNTAwODMwMDc5OjdiZDJiYzE2MTJkNTdhODYyYzYzNWFmMDQyYjkzZmU2OWQyN2MxYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdedIpHgFqTUzNTc0NDkwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7bd2bc1612d57a862c635af042b93fe69d27c1b9", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/7bd2bc1612d57a862c635af042b93fe69d27c1b9", "committedDate": "2020-10-09T21:07:12Z", "message": "Revert \"don't provision when containerCap is 0\"\n\nThis reverts commit d5e5b42ef2d55d955264076d255388dcf2ddc406."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23e40caa021679adc1de7f43eed7317cd094742f", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/23e40caa021679adc1de7f43eed7317cd094742f", "committedDate": "2020-10-09T21:22:32Z", "message": "concurrency limit 0 means unlimited"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDA1MzQ1", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#pullrequestreview-506005345", "createdAt": "2020-10-09T21:45:12Z", "commit": {"oid": "23e40caa021679adc1de7f43eed7317cd094742f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96e48d2155d6965fdcd671f544749bf86c8e059d", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/96e48d2155d6965fdcd671f544749bf86c8e059d", "committedDate": "2020-10-12T13:29:49Z", "message": "refactor setter and getter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NjIyMTQz", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#pullrequestreview-506622143", "createdAt": "2020-10-12T13:32:03Z", "commit": {"oid": "96e48d2155d6965fdcd671f544749bf86c8e059d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzozMjowM1rOHf-40w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzozMjowM1rOHf-40w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5ODI1OQ==", "bodyText": "kubernetes-plugin/src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java\n    \n    \n        Lines 383 to 384\n      in\n      23e40ca\n    \n    \n    \n    \n\n        \n          \n           public int getContainerCap() { \n        \n\n        \n          \n               return containerCap != null ? containerCap : Integer.MAX_VALUE;", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#discussion_r503298259", "createdAt": "2020-10-12T13:32:03Z", "author": {"login": "schottsfired"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -575,8 +575,8 @@ public KubernetesClient connect() throws KubernetesAuthException, IOException {\n      */\n     private boolean addProvisionedSlave(@Nonnull PodTemplate template, @CheckForNull Label label, int scheduledCount) throws Exception {\n         int containerCap = getContainerCap();\n-        if (containerCap == 0) {\n-            return false;\n+        if (containerCap == Integer.MAX_VALUE) { // don't check concurrency limits when set to \"unlimited.\"\n+            return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96e48d2155d6965fdcd671f544749bf86c8e059d"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff141430ab60419397517e22232a390436c584f9", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/ff141430ab60419397517e22232a390436c584f9", "committedDate": "2020-10-12T13:49:45Z", "message": "test for negative to mean unlimited"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NjM1Njcy", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#pullrequestreview-506635672", "createdAt": "2020-10-12T13:48:30Z", "commit": {"oid": "96e48d2155d6965fdcd671f544749bf86c8e059d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzo0ODozMVrOHf_hsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzo0OTo0MlrOHf_klA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMwODcyMA==", "bodyText": "Or rather than calling the getter you could just check containerCap == null.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#discussion_r503308720", "createdAt": "2020-10-12T13:48:31Z", "author": {"login": "jglick"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -575,8 +575,8 @@ public KubernetesClient connect() throws KubernetesAuthException, IOException {\n      */\n     private boolean addProvisionedSlave(@Nonnull PodTemplate template, @CheckForNull Label label, int scheduledCount) throws Exception {\n         int containerCap = getContainerCap();\n-        if (containerCap == 0) {\n-            return false;\n+        if (containerCap == Integer.MAX_VALUE) { // don't check concurrency limits when set to \"unlimited.\"\n+            return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5ODI1OQ=="}, "originalCommit": {"oid": "96e48d2155d6965fdcd671f544749bf86c8e059d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMwOTQ2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                If set to empty or 0 it means no limit.\n          \n          \n            \n                If set to empty it means no limit.\n          \n      \n    \n    \n  \n\nNo reason to confuse people by offering something to type in which would just be changed to blank on save.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#discussion_r503309460", "createdAt": "2020-10-12T13:49:42Z", "author": {"login": "jglick"}, "path": "src/main/resources/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud/help-containerCapStr.html", "diffHunk": "@@ -1,4 +1,4 @@\n <div>\n     The maximum number of concurrently running agent pods that are permitted in this Kubernetes Cloud.\n-    If set to empty it means no limit. Set to 0 means no pod will ever be started.\n-</div>\n+    If set to empty or 0 it means no limit.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96e48d2155d6965fdcd671f544749bf86c8e059d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "424e0bb2594549fd6c568fc9c1c6c000245d82ed", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/424e0bb2594549fd6c568fc9c1c6c000245d82ed", "committedDate": "2020-10-12T13:52:08Z", "message": "Update src/main/resources/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud/help-containerCapStr.html\n\nCo-authored-by: Jesse Glick <jglick@cloudbees.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "464b64261c3bba254d51b009f228453e3a8130cc", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/464b64261c3bba254d51b009f228453e3a8130cc", "committedDate": "2020-10-12T15:36:59Z", "message": "remove the if statement entirely"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ece75d089bcb682912a9584c44afd9cae9894a7", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/6ece75d089bcb682912a9584c44afd9cae9894a7", "committedDate": "2020-10-12T15:37:08Z", "message": "Merge branch 'zero-must-be-unlimited' of https://github.com/schottsfired/kubernetes-plugin into zero-must-be-unlimited"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b8cfb78b3d0abbdf54cf34f60fc3de5926e82fa", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/1b8cfb78b3d0abbdf54cf34f60fc3de5926e82fa", "committedDate": "2020-10-12T15:45:52Z", "message": "remove unnecessary asserts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzQ3NTcz", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#pullrequestreview-506747573", "createdAt": "2020-10-12T16:05:40Z", "commit": {"oid": "1b8cfb78b3d0abbdf54cf34f60fc3de5926e82fa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNjowNTo0MFrOHgEwmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNjowNTo0MFrOHgEwmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5NDQ1Ng==", "bodyText": "So this is going beyond reverting #828; now you are making API server calls even when no caps are in place, which would be a performance regression.\nI think this method instead needs to be altered in structure. First, if containerCap is not infinite, compute allPods and check its size. Then, if template.instanceCap is not infinite, compute labelPods and check its size. If neither of those returns false then you return true by default.\nAnd the method should be renamed to clarify that it is not actually adding a provisioned agent, but checking whether we may add a provisioned agent.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#discussion_r503394456", "createdAt": "2020-10-12T16:05:40Z", "author": {"login": "jglick"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -575,9 +575,6 @@ public KubernetesClient connect() throws KubernetesAuthException, IOException {\n      */\n     private boolean addProvisionedSlave(@Nonnull PodTemplate template, @CheckForNull Label label, int scheduledCount) throws Exception {\n         int containerCap = getContainerCap();\n-        if (containerCap == 0) {\n-            return false;\n-        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b8cfb78b3d0abbdf54cf34f60fc3de5926e82fa"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0375b352a1987873b933712bb851331f4459e181", "author": {"user": {"login": "schottsfired", "name": "David B. Schott"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/0375b352a1987873b933712bb851331f4459e181", "committedDate": "2020-10-12T16:30:48Z", "message": "new unlimited checks to avoid hitting k8s api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzcwNDc0", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#pullrequestreview-506770474", "createdAt": "2020-10-12T16:40:12Z", "commit": {"oid": "0375b352a1987873b933712bb851331f4459e181"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MTc4NjUy", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#pullrequestreview-507178652", "createdAt": "2020-10-13T08:14:33Z", "commit": {"oid": "0375b352a1987873b933712bb851331f4459e181"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NzQ0OTAy", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#pullrequestreview-535744902", "createdAt": "2020-11-20T20:11:34Z", "commit": {"oid": "0375b352a1987873b933712bb851331f4459e181"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMDoxMTozNVrOH3fQHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMDoxMTozNVrOH3fQHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk0NTc1OQ==", "bodyText": "Ineffective because mayAddProvisionedSlave is calling getContainerCap, not this method, so it sees 0 and refuses to provision pods.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/866#discussion_r527945759", "createdAt": "2020-11-20T20:11:35Z", "author": {"login": "jglick"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -390,12 +390,12 @@ public void setContainerCapStr(String containerCapStr) {\n     }\n \n     public void setContainerCap(Integer containerCap) {\n-        this.containerCap = (containerCap != null && containerCap >= 0) ? containerCap : null;\n+        this.containerCap = (containerCap != null && containerCap > 0) ? containerCap : null;\n     }\n \n     public String getContainerCapStr() {\n-        // serialized Integer.MAX_VALUE means no limit\n-        return (containerCap == null || containerCap == Integer.MAX_VALUE) ? \"\" : String.valueOf(containerCap);\n+        // null, serialized Integer.MAX_VALUE, or 0 means no limit\n+        return (containerCap == null || containerCap == Integer.MAX_VALUE || containerCap == 0) ? \"\" : String.valueOf(containerCap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0375b352a1987873b933712bb851331f4459e181"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 37, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}