{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MDU1OTM5", "number": 825, "title": "[JENKINS-63518] Cancel job when Kubernetes API returns a HTTP 4xx when scheduling a pod.", "bodyText": "Builds using a pod template that is stopped by the OPA gatekeeper  are canceled to prevent continuous looping with the error message piped to the build console for the end customer to view.", "createdAt": "2020-08-28T02:51:30Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/825", "merged": true, "mergeCommit": {"oid": "45125f1c5a9af299fc4ae5ad5c7a24cc45ae1fb4"}, "closed": true, "closedAt": "2020-09-01T08:23:03Z", "author": {"login": "pyieh"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBMRZEgH2gAyNDc1MDU1OTM5OmE2NjZiMzkyZjdlYWJhYzdkYzliYWU1OWNlNWJiN2RhZTk3MzhlOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEc9m7AH2gAyNDc1MDU1OTM5OjQ1MTI1ZjFjNWE5YWYyOTlmYzRhZTVhZDVjN2EyNGNjNDVhZTFmYjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a666b392f7eabac7dc9bae59ce5bb7dae9738e99", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/a666b392f7eabac7dc9bae59ce5bb7dae9738e99", "committedDate": "2020-08-21T22:09:01Z", "message": "Revert responsibility to cancel jobs with invalid pod templates back to the KubernetesLauncher using thrown InvalidPodTemplateException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd3b805230a6e02b78bd6ec9df182e045562be66", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/fd3b805230a6e02b78bd6ec9df182e045562be66", "committedDate": "2020-08-26T21:11:26Z", "message": "Revert \"Revert responsibility to cancel jobs with invalid pod templates back to the KubernetesLauncher using thrown InvalidPodTemplateException\"\n\nThis reverts commit a666b392f7eabac7dc9bae59ce5bb7dae9738e99."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0318a6f41f301b25cb4b79ad1a90b80389020ab5", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/0318a6f41f301b25cb4b79ad1a90b80389020ab5", "committedDate": "2020-08-26T21:15:26Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f55f9f19cbd8f32ef13ab681a39c07961d86260", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/2f55f9f19cbd8f32ef13ab681a39c07961d86260", "committedDate": "2020-08-27T21:16:52Z", "message": "Merge remote-tracking branch 'upstream/master' into opa"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e14fa704c9cc8b0f1f9cf44b872b6777ee1367b", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/7e14fa704c9cc8b0f1f9cf44b872b6777ee1367b", "committedDate": "2020-08-27T21:32:58Z", "message": "Move job cancellation to PodUtils class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87fbcbaf23ec7d835e7937177882000319bac02c", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/87fbcbaf23ec7d835e7937177882000319bac02c", "committedDate": "2020-08-27T21:50:25Z", "message": "Add check for KubernetesClientException indicating OPA violation, cancels associated build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70c2eba4ac42b9ae5ea45db130800515206fba7b", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/70c2eba4ac42b9ae5ea45db130800515206fba7b", "committedDate": "2020-08-28T02:45:35Z", "message": "changed StringUtils import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b12ae5aed00734b6fe0c426ffe01446ed65ecbb4", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b12ae5aed00734b6fe0c426ffe01446ed65ecbb4", "committedDate": "2020-08-28T02:47:15Z", "message": "update white space check method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NTc5NDUw", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/825#pullrequestreview-477579450", "createdAt": "2020-08-28T09:23:10Z", "commit": {"oid": "b12ae5aed00734b6fe0c426ffe01446ed65ecbb4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOToyMzoxMFrOHI0lTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOToyNjowMVrOHI03Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTAxMjE3NQ==", "bodyText": "OPA is just one reason for potential pod rejection. The code should be refactored to handle any failure to create pod.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/825#discussion_r479012175", "createdAt": "2020-08-28T09:23:10Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesLauncher.java", "diffHunk": "@@ -124,12 +124,22 @@ public synchronized void launch(SlaveComputer computer, TaskListener listener) {\n                     .stream().filter(s -> StringUtils.isNotBlank(s)).findFirst().orElse(null);\n             slave.setNamespace(namespace);\n \n+\n+            TaskListener runListener = template.getListener();\n+\n             LOGGER.log(Level.FINE, \"Creating Pod: {0}/{1}\", new Object[] { namespace, podName });\n-            pod = client.pods().inNamespace(namespace).create(pod);\n+            try {\n+                pod = client.pods().inNamespace(namespace).create(pod);\n+            } catch (KubernetesClientException e) {\n+                if (e.getMessage() != null && e.getMessage().contains(\"pod rejected due to\") && e.getMessage().contains(\"openpolicyagent\")) {\n+                    runListener.getLogger().printf(\"ERROR: Unable to create pod. \" + e.getMessage());\n+                    PodUtils.cancelInvalidPodTemplateJob(pod, \"OPA Violation\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12ae5aed00734b6fe0c426ffe01446ed65ecbb4"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTAxNDk5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static void cancelInvalidPodTemplateJob(Pod pod, String reason) {\n          \n          \n            \n                public static void cancelQueueItemsFor(Pod pod, String reason) {", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/825#discussion_r479014996", "createdAt": "2020-08-28T09:24:33Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodUtils.java", "diffHunk": "@@ -51,4 +56,21 @@\n     public static List<ContainerStatus> getContainers(Pod pod, Predicate<ContainerStatus> predicate) {\n         return getContainerStatus(pod).stream().filter(predicate).collect(Collectors.toList());\n     }\n+\n+    public static void cancelInvalidPodTemplateJob(Pod pod, String reason) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12ae5aed00734b6fe0c426ffe01446ed65ecbb4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTAxNjA1Mg==", "bodyText": "Too verbose\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOGGER.info(cancelMsg);\n          \n          \n            \n                            LOGGER.fine(cancelMsg);", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/825#discussion_r479016052", "createdAt": "2020-08-28T09:25:23Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodUtils.java", "diffHunk": "@@ -51,4 +56,21 @@\n     public static List<ContainerStatus> getContainers(Pod pod, Predicate<ContainerStatus> predicate) {\n         return getContainerStatus(pod).stream().filter(predicate).collect(Collectors.toList());\n     }\n+\n+    public static void cancelInvalidPodTemplateJob(Pod pod, String reason) {\n+        Queue q = Jenkins.get().getQueue();\n+        String runUrl = pod.getMetadata().getAnnotations().get(\"runUrl\");\n+        for (Queue.Item item: q.getItems()) {\n+            if (item.task.getUrl().equals(runUrl)) {\n+                String cancelMsg = \"Canceling queue item: \" + item;\n+                if (reason != null && !StringUtils.isBlank(reason)) {\n+                    cancelMsg += \" due to \" + reason;\n+                }\n+                LOGGER.info(cancelMsg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12ae5aed00734b6fe0c426ffe01446ed65ecbb4"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTAxNjgwMw==", "bodyText": "Too verbose\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOGGER.info(\"Failed to find corresponding queue item to cancel for pod: \" + pod);\n          \n          \n            \n                    LOGGER.fine(\"Failed to find corresponding queue item to cancel for pod: \" + pod);", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/825#discussion_r479016803", "createdAt": "2020-08-28T09:26:01Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodUtils.java", "diffHunk": "@@ -51,4 +56,21 @@\n     public static List<ContainerStatus> getContainers(Pod pod, Predicate<ContainerStatus> predicate) {\n         return getContainerStatus(pod).stream().filter(predicate).collect(Collectors.toList());\n     }\n+\n+    public static void cancelInvalidPodTemplateJob(Pod pod, String reason) {\n+        Queue q = Jenkins.get().getQueue();\n+        String runUrl = pod.getMetadata().getAnnotations().get(\"runUrl\");\n+        for (Queue.Item item: q.getItems()) {\n+            if (item.task.getUrl().equals(runUrl)) {\n+                String cancelMsg = \"Canceling queue item: \" + item;\n+                if (reason != null && !StringUtils.isBlank(reason)) {\n+                    cancelMsg += \" due to \" + reason;\n+                }\n+                LOGGER.info(cancelMsg);\n+                q.cancel(item);\n+                break;\n+            }\n+        }\n+        LOGGER.info(\"Failed to find corresponding queue item to cancel for pod: \" + pod);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12ae5aed00734b6fe0c426ffe01446ed65ecbb4"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa5eda303890268b1b1d077af5567483658fede9", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/aa5eda303890268b1b1d077af5567483658fede9", "committedDate": "2020-08-28T20:51:55Z", "message": "renamed PodUtils' queue item cancel method, changed some logs from info to fine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9bc1fa8c7dfb91dd5411bec703d56cdd4832eec", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/f9bc1fa8c7dfb91dd5411bec703d56cdd4832eec", "committedDate": "2020-08-28T21:31:58Z", "message": "changed Reaper's queue item cancel call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e7c0c374ac53244aabc1a9008aed250c5937ac0", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/6e7c0c374ac53244aabc1a9008aed250c5937ac0", "committedDate": "2020-08-31T21:42:18Z", "message": "Change KubernetesClientException catch to check code instead of message for job cancellation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MDUwMzUx", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/825#pullrequestreview-479050351", "createdAt": "2020-08-31T23:34:50Z", "commit": {"oid": "6e7c0c374ac53244aabc1a9008aed250c5937ac0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzozNDo1MFrOHKNxLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzozNDo1MFrOHKNxLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3MzM4OQ==", "bodyText": "String conversion needed? comparing just against the integer like the following snippet does not work?\nint code = e.getCode();\nif (code >= 400 && code < 500) {\n   // cancel the job\nelse if (code >= 500 && code < 600) {\n   // retry\n} else {\n   // retry\n}", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/825#discussion_r480473389", "createdAt": "2020-08-31T23:34:50Z", "author": {"login": "narayanan"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesLauncher.java", "diffHunk": "@@ -127,13 +130,18 @@ public synchronized void launch(SlaveComputer computer, TaskListener listener) {\n \n             TaskListener runListener = template.getListener();\n \n-            LOGGER.log(Level.FINE, \"Creating Pod: {0}/{1}\", new Object[] { namespace, podName });\n+            LOGGER.log(FINE, \"Creating Pod: {0}/{1}\", new Object[] { namespace, podName });\n             try {\n                 pod = client.pods().inNamespace(namespace).create(pod);\n             } catch (KubernetesClientException e) {\n-                if (e.getMessage() != null && e.getMessage().contains(\"pod rejected due to\") && e.getMessage().contains(\"openpolicyagent\")) {\n+                String k8sCode = Integer.toString(e.getCode());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e7c0c374ac53244aabc1a9008aed250c5937ac0"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45125f1c5a9af299fc4ae5ad5c7a24cc45ae1fb4", "author": {"user": {"login": "pyieh", "name": null}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/45125f1c5a9af299fc4ae5ad5c7a24cc45ae1fb4", "committedDate": "2020-09-01T01:17:34Z", "message": "update code check for ints and not string conversion"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 157, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}