{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NTIxMjk4", "number": 851, "title": "Specify jnlp container limits through system properties", "bodyText": "This allows to specify jnlp container limits through system properties.\norg.csanchez.jenkins.plugins.kubernetes.PodTemplateStepExecution.defaultContainer.defaultMemoryLimit\norg.csanchez.jenkins.plugins.kubernetes.PodTemplateStepExecution.defaultContainer.defaultCpuLimit\nSometime need to set limits for jnlp.\nOtherwise, we get an error", "createdAt": "2020-09-30T13:44:51Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851", "merged": true, "mergeCommit": {"oid": "d19ba981fd4a537d4cc85d02498bb86f569f08b5"}, "closed": true, "closedAt": "2020-12-03T15:49:51Z", "author": {"login": "KrapivinAndrey"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN83XrAH2gAyNDk1NTIxMjk4OjAxOWViOTZhZDFmYTJlYjJkMzhkNWE3OTM2YzZlMTA0ZDYyZTNkNTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdilLWsgFqTU0NDEwMzAxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "019eb96ad1fa2eb2d38d5a7936c6e104d62e3d52", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/019eb96ad1fa2eb2d38d5a7936c6e104d62e3d52", "committedDate": "2020-09-30T13:33:02Z", "message": "fix: set limits for defaults"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c74e2f0c7585581aa58876d805938379e6aeee0c", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/c74e2f0c7585581aa58876d805938379e6aeee0c", "committedDate": "2020-10-07T14:30:41Z", "message": "Merge branch 'master' into jnlp-limits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff007a722bee7f3beea535aba2ed60b1c44f97e1", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/ff007a722bee7f3beea535aba2ed60b1c44f97e1", "committedDate": "2020-10-07T21:11:51Z", "message": "fix(DefualtLimit):"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTE5Mjgx", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#pullrequestreview-504519281", "createdAt": "2020-10-08T07:59:01Z", "commit": {"oid": "ff007a722bee7f3beea535aba2ed60b1c44f97e1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzo1OTowMVrOHeSakQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzo1OToyNlrOHeSbgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMTA0MQ==", "bodyText": "Should use different system property name.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r501521041", "createdAt": "2020-10-08T07:59:01Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -103,6 +103,11 @@\n     static final String DEFAULT_JNLP_CONTAINER_CPU_REQUEST = System\n             .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuRequest\", \"100m\");\n \n+    static final String DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT = System\n+            .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryRequest\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff007a722bee7f3beea535aba2ed60b1c44f97e1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMTI4Mg==", "bodyText": "This is wrong. It is overriding the default request since you're starting from an empty ContainerBuilder.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r501521282", "createdAt": "2020-10-08T07:59:26Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -261,6 +266,14 @@ public Pod build() {\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n             jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST)).endResources().build().getResources());\n+\n+            if (DEFAULT_JNLP_CONTAINER_CPU_LIMIT!=null) {\n+                jnlp.setResources(new ContainerBuilder().editOrNewResources().addToLimits(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_LIMIT)).endResources().build().getResources());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff007a722bee7f3beea535aba2ed60b1c44f97e1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da377eff58105a0d3210ac28e76404ac7275b3b8", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/da377eff58105a0d3210ac28e76404ac7275b3b8", "committedDate": "2020-11-15T16:48:48Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aa4d994aab69d6ab0179c3d78220f087c2ee2f1", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/0aa4d994aab69d6ab0179c3d78220f087c2ee2f1", "committedDate": "2020-11-15T17:24:45Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e936579c4dede0666e1bdc2ef89202f38ecd9be6", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/e936579c4dede0666e1bdc2ef89202f38ecd9be6", "committedDate": "2020-11-15T17:34:54Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODIyMDgx", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#pullrequestreview-530822081", "createdAt": "2020-11-15T18:18:24Z", "commit": {"oid": "e936579c4dede0666e1bdc2ef89202f38ecd9be6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxODoxODoyNFrOHzh0Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxODoxODoyNFrOHzh0Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc5MzQyNg==", "bodyText": "Probably don't need to have a call to editOrNewResources for each request/limit.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        containerBuilder = new ContainerBuilder();\n          \n          \n            \n                        ResourcesNested<ContainerBuilder> containerResources = new ContainerBuilder().editOrNewResources();", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r523793426", "createdAt": "2020-11-15T18:18:24Z", "author": {"login": "cwholmes"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -260,7 +265,20 @@ public Pod build() {\n         envVars.putAll(jnlp.getEnv().stream().collect(Collectors.toMap(EnvVar::getName, Function.identity())));\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n-            jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST)).endResources().build().getResources());\n+\n+            containerBuilder = new ContainerBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e936579c4dede0666e1bdc2ef89202f38ecd9be6"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODIyMTQ2", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#pullrequestreview-530822146", "createdAt": "2020-11-15T18:19:25Z", "commit": {"oid": "e936579c4dede0666e1bdc2ef89202f38ecd9be6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxODoxOToyNVrOHzh0gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQxODoxOToyNVrOHzh0gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc5MzUzOQ==", "bodyText": "The endResourcesMethod is on the ResourcesNested class and not the ContainerBuilerClass. The suggestion above will probably help with what this line is trying to do.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r523793539", "createdAt": "2020-11-15T18:19:25Z", "author": {"login": "cwholmes"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -260,7 +265,20 @@ public Pod build() {\n         envVars.putAll(jnlp.getEnv().stream().collect(Collectors.toMap(EnvVar::getName, Function.identity())));\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n-            jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST)).endResources().build().getResources());\n+\n+            containerBuilder = new ContainerBuilder();\n+            containerBuilder.editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST));\n+\n+            if (DEFAULT_JNLP_CONTAINER_CPU_LIMIT!=null) {\n+                containerBuilder.editOrNewResources().addToLimits(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_LIMIT));\n+            }\n+\n+            if (DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT!=null) {\n+                containerBuilder.editOrNewResources().addToLimits(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT))\n+            }\n+\n+            jnlp.setResources(containerBuilder.endResources().build().getResources());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e936579c4dede0666e1bdc2ef89202f38ecd9be6"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d69d70017186c4d3f5a0a451574383842d6de8f4", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/d69d70017186c4d3f5a0a451574383842d6de8f4", "committedDate": "2020-11-15T18:23:18Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe9c1d243bcba3872f22248c292a7e9e4931c304", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/fe9c1d243bcba3872f22248c292a7e9e4931c304", "committedDate": "2020-11-16T05:11:23Z", "message": "use containerResources instead \u0441ontainerBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4133f4850256c562f63cf9bf62d60f71624a8f4e", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4133f4850256c562f63cf9bf62d60f71624a8f4e", "committedDate": "2020-11-16T05:35:18Z", "message": "Revert \"use containerResources instead \u0441ontainerBuilder\"\n\nThis reverts commit fe9c1d243bcba3872f22248c292a7e9e4931c304."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/7b2ff34a507f8b8c963cd841bddeadc4b1f215c9", "committedDate": "2020-11-16T05:49:27Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MzY3Njc4", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#pullrequestreview-538367678", "createdAt": "2020-11-25T10:44:03Z", "commit": {"oid": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDo0NDowM1rOH5tc4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDo0NzoyOVrOH5tlXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3NTU1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryLimit\", null);\n          \n          \n            \n                        .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryLimit\");", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r530275554", "createdAt": "2020-11-25T10:44:03Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -103,6 +104,11 @@\n     static final String DEFAULT_JNLP_CONTAINER_CPU_REQUEST = System\n             .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuRequest\", \"100m\");\n \n+    static final String DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT = System\n+            .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryLimit\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3NTY0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuLimit\", null);\n          \n          \n            \n                        .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuLimit\");", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r530275646", "createdAt": "2020-11-25T10:44:12Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -103,6 +104,11 @@\n     static final String DEFAULT_JNLP_CONTAINER_CPU_REQUEST = System\n             .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuRequest\", \"100m\");\n \n+    static final String DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT = System\n+            .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryLimit\", null);\n+    static final String DEFAULT_JNLP_CONTAINER_CPU_LIMIT = System\n+            .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuLimit\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3NzcyNQ==", "bodyText": "Can be simplified by using new ResourceRequirementsBuilder()", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r530277725", "createdAt": "2020-11-25T10:47:29Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -260,7 +266,20 @@ public Pod build() {\n         envVars.putAll(jnlp.getEnv().stream().collect(Collectors.toMap(EnvVar::getName, Function.identity())));\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n-            jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST)).endResources().build().getResources());\n+\n+            ResourcesNested<ContainerBuilder> containerBuilder = new ContainerBuilder().withNewResources();\n+            containerBuilder.addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST));\n+\n+            if (DEFAULT_JNLP_CONTAINER_CPU_LIMIT!=null) {\n+                containerBuilder.addToLimits(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_LIMIT));\n+            }\n+\n+            if (DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT!=null) {\n+                containerBuilder.addToLimits(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT));\n+            }\n+\n+            jnlp.setResources(containerBuilder.endResources().build().getResources());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0057219f5ba14fb1caa2719132d8f722dce470c", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/f0057219f5ba14fb1caa2719132d8f722dce470c", "committedDate": "2020-12-02T17:22:31Z", "message": "fix after review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f13e89151f09bce4042913fe0ca989089e3d97ef", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/f13e89151f09bce4042913fe0ca989089e3d97ef", "committedDate": "2020-12-02T18:15:45Z", "message": "check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cbdc280be83b7275a585abd1b26a0e59b7a04d8", "author": {"user": {"login": "KrapivinAndrey", "name": "Krapivin Andrey"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/9cbdc280be83b7275a585abd1b26a0e59b7a04d8", "committedDate": "2020-12-02T18:35:44Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTAzMDEw", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#pullrequestreview-544103010", "createdAt": "2020-12-03T15:49:33Z", "commit": {"oid": "9cbdc280be83b7275a585abd1b26a0e59b7a04d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 27, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}