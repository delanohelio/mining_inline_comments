{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NDE1MTUw", "number": 880, "title": "Resolve cloud when removing dynamic template", "bodyText": "Fixes removal of ephemeral pod templates when they don't specify an explicit cloudName\nReplaces #878", "createdAt": "2020-11-04T14:18:22Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880", "merged": true, "mergeCommit": {"oid": "09bcc70d1c240f6ee6d32b1fdc358e5d3a04c139"}, "closed": true, "closedAt": "2020-11-06T14:41:10Z", "author": {"login": "Vlatombe"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZOesGAH2gAyNTE1NDE1MTUwOjFjYjZkNGE3ZWEyYTk2OGFmOTE3Y2VmZjI5ZTRjZDk0ZWRkN2EzM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ3TwbAFqTUyNTE2NTM5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1cb6d4a7ea2a968af917ceff29e4cd94edd7a33b", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/1cb6d4a7ea2a968af917ceff29e4cd94edd7a33b", "committedDate": "2020-11-04T14:17:32Z", "message": "Resolve cloud when removing dynamic template"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNTc4NDg4", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#pullrequestreview-523578488", "createdAt": "2020-11-04T17:23:44Z", "commit": {"oid": "1cb6d4a7ea2a968af917ceff29e4cd94edd7a33b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNzoyMzo0NFrOHtiOiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNzoyMzo0NFrOHtiOiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwODc0NA==", "bodyText": "Will this fail the build if the cloud is not found? Is that the desired affect? I guess it would alert the user of an issue.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#discussion_r517508744", "createdAt": "2020-11-04T17:23:44Z", "author": {"login": "cwholmes"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java", "diffHunk": "@@ -253,21 +253,10 @@ private PodTemplateCallback(PodTemplate podTemplate) {\n          * Remove the template after step is done\n          */\n         protected void finished(StepContext context) throws Exception {\n-            Cloud cloud = Jenkins.get().getCloud(cloudName);\n-            if (cloud == null) {\n-                LOGGER.log(Level.FINE, \"Cloud {0} no longer exists, cannot delete pod template {1}\",\n-                        new Object[] { cloudName, podTemplate.getName() });\n-                return;\n-            }\n-            if (cloud instanceof KubernetesCloud) {\n-                LOGGER.log(Level.FINE, \"Removing pod template {1} from cloud {0}\",\n-                        new Object[] { cloud.name, podTemplate.getName() });\n-                KubernetesCloud kubernetesCloud = (KubernetesCloud) cloud;\n-                kubernetesCloud.removeDynamicTemplate(podTemplate);\n-            } else {\n-                LOGGER.log(Level.WARNING, \"Cloud is not a KubernetesCloud: {0} {1}\",\n-                        new String[] { cloud.name, cloud.getClass().getName() });\n-            }\n+            KubernetesCloud cloud = resolveCloud();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cb6d4a7ea2a968af917ceff29e4cd94edd7a33b"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5fd2cca51270de2e9339cac0aba917f18b8dea4", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/e5fd2cca51270de2e9339cac0aba917f18b8dea4", "committedDate": "2020-11-06T09:48:31Z", "message": "Don't fail the build, just print a warning if can't remove the cloud"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be75374190b83535094ab3a3d142f868619c4da3", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/be75374190b83535094ab3a3d142f868619c4da3", "committedDate": "2020-11-06T13:23:24Z", "message": "Add exception to log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MTQ1NDc5", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#pullrequestreview-525145479", "createdAt": "2020-11-06T13:25:21Z", "commit": {"oid": "be75374190b83535094ab3a3d142f868619c4da3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MTQ1ODEz", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#pullrequestreview-525145813", "createdAt": "2020-11-06T13:25:47Z", "commit": {"oid": "e5fd2cca51270de2e9339cac0aba917f18b8dea4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMzoyNTo0N1rOHut63w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMzoyNTo0N1rOHut63w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc0ODg5NQ==", "bodyText": "Is it a good idea to mute this exception?", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#discussion_r518748895", "createdAt": "2020-11-06T13:25:47Z", "author": {"login": "twasyl"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java", "diffHunk": "@@ -253,20 +253,13 @@ private PodTemplateCallback(PodTemplate podTemplate) {\n          * Remove the template after step is done\n          */\n         protected void finished(StepContext context) throws Exception {\n-            Cloud cloud = Jenkins.get().getCloud(cloudName);\n-            if (cloud == null) {\n-                LOGGER.log(Level.FINE, \"Cloud {0} no longer exists, cannot delete pod template {1}\",\n-                        new Object[] { cloudName, podTemplate.getName() });\n-                return;\n-            }\n-            if (cloud instanceof KubernetesCloud) {\n-                LOGGER.log(Level.FINE, \"Removing pod template {1} from cloud {0}\",\n-                        new Object[] { cloud.name, podTemplate.getName() });\n-                KubernetesCloud kubernetesCloud = (KubernetesCloud) cloud;\n-                kubernetesCloud.removeDynamicTemplate(podTemplate);\n-            } else {\n-                LOGGER.log(Level.WARNING, \"Cloud is not a KubernetesCloud: {0} {1}\",\n-                        new String[] { cloud.name, cloud.getClass().getName() });\n+            try {\n+                KubernetesCloud cloud = resolveCloud();\n+                LOGGER.log(Level.FINE, () -> \"Removing pod template \" + podTemplate.getName()\n+                        + \" from cloud \" + cloud.name);\n+                cloud.removeDynamicTemplate(podTemplate);\n+            } catch (AbortException e) {\n+                LOGGER.log(Level.WARNING, () -> \"Unable to resolve cloud for \" + podTemplate.getName() + \". Maybe the cloud was removed while running the build?\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5fd2cca51270de2e9339cac0aba917f18b8dea4"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb1aeeff42d274fc0846c691850cf957d3b2726f", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/bb1aeeff42d274fc0846c691850cf957d3b2726f", "committedDate": "2020-11-06T13:42:51Z", "message": "Check that the pod template is indeed removed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MTY1Mzkx", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#pullrequestreview-525165391", "createdAt": "2020-11-06T13:51:42Z", "commit": {"oid": "bb1aeeff42d274fc0846c691850cf957d3b2726f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 55, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}