{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMTU4ODcx", "number": 812, "title": "Suggest NodeProvisioner review after adding new pods", "bodyText": "When the Kubernetes plugin provisions new pods, there is a delay of up to hudson.slaves.NodeProvisioner.recurrencePeriod before the queue is checked and new pods are actually started.\nNodeProvisioner has a method suggestReviewNow to get around this. I'm not sure about the best way to trigger it, so if there's a better way I'm all for it. For now I'm triggering it with a one-off timer with a delay of 1 second.\nFrom my testing, this results in significantly faster pod provisioning, which makes a big difference in short-running jobs.", "createdAt": "2020-08-03T12:50:24Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/812", "merged": true, "mergeCommit": {"oid": "997c715f95718e9369339e90694ebabdac285184"}, "closed": true, "closedAt": "2020-08-17T09:04:22Z", "author": {"login": "Jinxit"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7RYhVgH2gAyNDYyMTU4ODcxOjYzMWU0NTE3MmI0ZmRhZGEwYWM2MmNlMWVhOTkwOTYyZTM1M2UxMGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_unragFqTQ2ODI4OTQ3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "631e45172b4fdada0ac62ce1ea990962e353e10b", "author": {"user": {"login": "Jinxit", "name": "Lucas \u00c5str\u00f6m"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/631e45172b4fdada0ac62ce1ea990962e353e10b", "committedDate": "2020-08-03T12:42:47Z", "message": "suggest NodeProvisioner review after adding new pods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDA3NzIz", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/812#pullrequestreview-464007723", "createdAt": "2020-08-10T07:30:41Z", "commit": {"oid": "631e45172b4fdada0ac62ce1ea990962e353e10b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNzozMDo0MVrOG-D9zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNzozMDo0MVrOG-D9zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyOTg2OA==", "bodyText": "nodeProvisioner is always non-null if label is non-null.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        NodeProvisioner nodeProvisioner = label.nodeProvisioner;\n          \n          \n            \n                        if (availableCapacity > 0 && nodeProvisioner != null) {\n          \n          \n            \n                            LOGGER.log(Level.FINE, \"Suggesting NodeProvisioner review\");\n          \n          \n            \n                            Timer.get().schedule(nodeProvisioner::suggestReviewNow, 1L, TimeUnit.SECONDS);\n          \n          \n            \n                        }\n          \n          \n            \n                        if (availableCapacity > 0 && label != null) {\n          \n          \n            \n                            LOGGER.log(Level.FINE, \"Suggesting NodeProvisioner review\");\n          \n          \n            \n                            Timer.get().schedule(label.nodeProvisioner::suggestReviewNow, 1L, TimeUnit.SECONDS);\n          \n          \n            \n                        }\n          \n      \n    \n    \n  \n\navailableCapacity > 0 is not useful IMO. It would be more relevant to capture the number of nodes provisioned in the current round and check if it is >0.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/812#discussion_r467729868", "createdAt": "2020-08-10T07:30:41Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/io/jenkins/plugins/kubernetes/NoDelayProvisionerStrategy.java", "diffHunk": "@@ -71,6 +73,11 @@\n             }\n         }\n         if (availableCapacity >= currentDemand) {\n+            NodeProvisioner nodeProvisioner = label.nodeProvisioner;\n+            if (availableCapacity > 0 && nodeProvisioner != null) {\n+                LOGGER.log(Level.FINE, \"Suggesting NodeProvisioner review\");\n+                Timer.get().schedule(nodeProvisioner::suggestReviewNow, 1L, TimeUnit.SECONDS);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "631e45172b4fdada0ac62ce1ea990962e353e10b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a3d3d6d8ec0f078e0cb1911b8bf97ce3f0c0243", "author": {"user": {"login": "Jinxit", "name": "Lucas \u00c5str\u00f6m"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/2a3d3d6d8ec0f078e0cb1911b8bf97ce3f0c0243", "committedDate": "2020-08-10T07:47:23Z", "message": "check if any nodes were provisioned in the current round"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4Mjg5NDcy", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/812#pullrequestreview-468289472", "createdAt": "2020-08-17T09:02:17Z", "commit": {"oid": "2a3d3d6d8ec0f078e0cb1911b8bf97ce3f0c0243"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 142, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}