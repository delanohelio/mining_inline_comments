{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MjYxNzM0", "number": 794, "title": "Make default JNLP container resource requests overridable", "bodyText": "We used to use LimitRange to define default resource limits/requests for the jnlp container but since a couple of release, we have to define the limits/request in each pod templates if we want different values from the hardcoded values.\nThis can be an issue as some pipeline stuff can't be executed outside of the JNLP container (like git clone / fetch from the git client) and the limited hardcoded resources make the operations very slow or even fail. See https://issues.jenkins-ci.org/browse/JENKINS-51542 (and also probably https://issues.jenkins-ci.org/browse/JENKINS-30600 as a root cause). See also https://bugs.eclipse.org/bugs/show_bug.cgi?id=560283#c16 for details about performance issue.\nThis PR adds system properties to let the Jenkins instance be started with specific values instead of hardcoded values.\nIt also now sets limits and not only requests.", "createdAt": "2020-06-03T15:00:04Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/794", "merged": true, "mergeCommit": {"oid": "d9cf6a810fce807fe35cd56ebe17ffb343c702f4"}, "closed": true, "closedAt": "2020-06-05T14:01:48Z", "author": {"login": "mbarbero"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnrJgnAFqTQyMzY2NzA0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn6wE0AFqTQyNDI3MDI4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjY3MDQx", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/794#pullrequestreview-423667041", "createdAt": "2020-06-03T15:24:02Z", "commit": {"oid": "19991c46fbb5ec2d0a11d632dd5434ba703dab59"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNToyNDowMlrOGehDeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNToyNDowMlrOGehDeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY1MjAyNA==", "bodyText": "I do not think settings limits is wise. In the case of CPU, this will prevent anything running in the agent container from using more than 10% CPU, arbitrarily slowing down legitimate operations. In the case of memory, this will cause the agent to crash if the JVM happens to use more than 256Mi.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/794#discussion_r434652024", "createdAt": "2020-06-03T15:24:02Z", "author": {"login": "jglick"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -253,7 +262,12 @@ public Pod build() {\n         envVars.putAll(jnlp.getEnv().stream().collect(Collectors.toMap(EnvVar::getName, Function.identity())));\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n-            jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(\"100m\")).addToRequests(\"memory\", new Quantity(\"256Mi\")).endResources().build().getResources());\n+            jnlp.setResources(new ContainerBuilder().editOrNewResources()\n+                .addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST))\n+                .addToLimits(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_LIMIT))\n+                .addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST))\n+                .addToLimits(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19991c46fbb5ec2d0a11d632dd5434ba703dab59"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35af4ff30b5072a5a0f883b42f99d0f60e71e665", "author": {"user": {"login": "mbarbero", "name": "Mika\u00ebl Barbero"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/35af4ff30b5072a5a0f883b42f99d0f60e71e665", "committedDate": "2020-06-03T15:40:54Z", "message": "Make default JNLP container resource requests/limits overridable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNzY5ODg5", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/794#pullrequestreview-423769889", "createdAt": "2020-06-03T17:19:45Z", "commit": {"oid": "35af4ff30b5072a5a0f883b42f99d0f60e71e665"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoxOTo0NlrOGel2kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoxOTo0NlrOGel2kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczMDY0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertEquals(PodTemplateBuilder.DEFAULT_JNLP_CONTAINER_CPU_REQUEST, requests.get(\"cpu\"));\n          \n          \n            \n                    assertEquals(PodTemplateBuilder.DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST, requests.get(\"memory\"));\n          \n          \n            \n                    PodTemplateUtilsTest.assertQuantity(PodTemplateBuilder.DEFAULT_JNLP_CONTAINER_CPU_REQUEST, requests.get(\"cpu\"));\n          \n          \n            \n                    PodTemplateUtilsTest.assertQuantity(PodTemplateBuilder.DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST, requests.get(\"memory\"));", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/794#discussion_r434730640", "createdAt": "2020-06-03T17:19:46Z", "author": {"login": "jglick"}, "path": "src/test/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilderTest.java", "diffHunk": "@@ -344,8 +344,8 @@ public void defaultRequests() throws Exception {\n         assertNotNull(resources);\n         Map<String, Quantity> requests = resources.getRequests();\n         assertNotNull(requests);\n-        assertTrue(requests.containsKey(\"cpu\"));\n-        assertTrue(requests.containsKey(\"memory\"));\n+        assertEquals(PodTemplateBuilder.DEFAULT_JNLP_CONTAINER_CPU_REQUEST, requests.get(\"cpu\"));\n+        assertEquals(PodTemplateBuilder.DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST, requests.get(\"memory\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35af4ff30b5072a5a0f883b42f99d0f60e71e665"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6218f6f5311dc5cc4bb955f85bbe1a2b0643aff2", "author": {"user": {"login": "mbarbero", "name": "Mika\u00ebl Barbero"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/6218f6f5311dc5cc4bb955f85bbe1a2b0643aff2", "committedDate": "2020-06-04T09:10:12Z", "message": "Uses PodTemplateUtilsTest.assertQuantity instead of assertEquals\n\nCo-authored-by: Jesse Glick <jglick@cloudbees.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MjcwMjg1", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/794#pullrequestreview-424270285", "createdAt": "2020-06-04T09:36:08Z", "commit": {"oid": "6218f6f5311dc5cc4bb955f85bbe1a2b0643aff2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 131, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}