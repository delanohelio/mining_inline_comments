{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0NDc4NjI5", "number": 872, "title": "Add dropwizard metrics to track status of pods", "bodyText": "This PR is to add some basic dropwizard metrics to track status of provisioned pods.\nI migrated Jenkins instances from Mesos to Kubernetes recently and noticed that the kube plugin doesn't provide metrics related to builder nodes provisioning like the mesos plugin does.\nThese metrics become useful at scale when the number of Jenkins instance is quite big and they help to spot issues with Jenkins -> cloud provider as early as possible.\nI took the same approach as the mesos plugin and use dropwizard metrics (and the metrics plugin), however, I personally not a big fan of them as they don't have labels like the prometheus metrics client. Micrometer can be an alternative, it's like slf4j for logs. Any help with the metrics and what's the current stance in the jenkins world on them would be great.", "createdAt": "2020-10-16T00:56:16Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/872", "merged": true, "mergeCommit": {"oid": "6467d2acee5f2690757cad98c10e7063ec160fd4"}, "closed": true, "closedAt": "2020-11-12T12:54:45Z", "author": {"login": "angry-cellophane"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS8BRfAH2gAyNTA0NDc4NjI5OjkyNGIwMzE3NzA3NWFkNGIzMzJkMDVhMGZiOGE1NzM2NjUyNmQwMWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda1LfRgFqTUyNjI3OTkxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "924b03177075ad4b332d05a0fb8a57366526d01d", "author": {"user": {"login": "angry-cellophane", "name": "Alexander"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/924b03177075ad4b332d05a0fb8a57366526d01d", "committedDate": "2020-10-16T01:23:34Z", "message": "Add dropwizard metrics to track status of pods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5Nzc4NDM3", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/872#pullrequestreview-519778437", "createdAt": "2020-10-29T15:17:58Z", "commit": {"oid": "924b03177075ad4b332d05a0fb8a57366526d01d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNToxNzo1OFrOHqg68Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNToyMDowOVrOHqhBsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0MTYxNw==", "bodyText": "Should be using requestMetricNameFor method on every call.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/872#discussion_r514341617", "createdAt": "2020-10-29T15:17:58Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -547,12 +550,14 @@ public KubernetesClient connect() throws KubernetesAuthException, IOException {\n                 LOGGER.log(Level.FINEST, \"Planned Kubernetes agents for template \\\"{0}\\\": {1}\",\n                         new Object[] { t.getName(), r.size() });\n                 if (r.size() > 0) {\n+                    Metrics.metricRegistry().counter(\"k8s.cloud.provision.nodes\").inc(r.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924b03177075ad4b332d05a0fb8a57366526d01d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0MTc1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return String.format(\"k8s.cloud.%s.provision.request\", labelText);\n          \n          \n            \n                    return String.format(\"kubernetes.cloud.%s.provision.request\", labelText);", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/872#discussion_r514341753", "createdAt": "2020-10-29T15:18:10Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -1009,4 +1016,9 @@ public static void hpiRunInit() {\n             }\n         }\n     }\n+\n+    private static String requestMetricNameFor(Label label) {\n+        String labelText = (label == null) ? \"nolabel\" : label.getDisplayName();\n+        return String.format(\"k8s.cloud.%s.provision.request\", labelText);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924b03177075ad4b332d05a0fb8a57366526d01d"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0MzM0Nw==", "bodyText": "Should be abstracting the key creation to a method such as requestMetricNameFor. No label here, but needs to be abstracted anyway.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/872#discussion_r514343347", "createdAt": "2020-10-29T15:20:09Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesLauncher.java", "diffHunk": "@@ -132,6 +133,7 @@ public synchronized void launch(SlaveComputer computer, TaskListener listener) {\n             try {\n                 pod = client.pods().inNamespace(namespace).create(pod);\n             } catch (KubernetesClientException e) {\n+                Metrics.metricRegistry().counter(\"k8s.cloud.pods.creation.failed\").inc();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924b03177075ad4b332d05a0fb8a57366526d01d"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eb98901cd6007c679e0f6a41cb78c373ad930f2", "author": {"user": {"login": "angry-cellophane", "name": "Alexander"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/2eb98901cd6007c679e0f6a41cb78c373ad930f2", "committedDate": "2020-11-08T23:32:34Z", "message": "Move all metric names to one class to make easier to track their use"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6467d2acee5f2690757cad98c10e7063ec160fd4", "author": {"user": {"login": "angry-cellophane", "name": "Alexander"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/6467d2acee5f2690757cad98c10e7063ec160fd4", "committedDate": "2020-11-09T00:03:19Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTAzMjgz", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/872#pullrequestreview-526103283", "createdAt": "2020-11-09T10:13:44Z", "commit": {"oid": "6467d2acee5f2690757cad98c10e7063ec160fd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDoxMzo0NFrOHvnlUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDoxMzo0NFrOHvnlUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY5MzY0OQ==", "bodyText": "Revert this hunk", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/872#discussion_r519693649", "createdAt": "2020-11-09T10:13:44Z", "author": {"login": "Vlatombe"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -679,7 +691,6 @@ public PodTemplate getUnwrappedTemplate(PodTemplate podTemplate) {\n     }\n \n     /**\n-     * Add a new template to the cloud", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6467d2acee5f2690757cad98c10e7063ec160fd4"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Mjc5OTEz", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/872#pullrequestreview-526279913", "createdAt": "2020-11-09T13:56:47Z", "commit": {"oid": "6467d2acee5f2690757cad98c10e7063ec160fd4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 46, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}