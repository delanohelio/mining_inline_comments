{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3ODUwMzMw", "number": 835, "title": "Rework concurrency limits using the number provided in Cloud API", "bodyText": "Downstream PR for jenkinsci/jenkins#4922\n\nImproves the KubernetesCloud implementation by using the provided count of planned nodes for the current label. This makes the enforcement of pod template limits exact. Since we don't have access to the number of planned nodes for all node provisioners, the global limit can be affected by an error margin.\nReworked the limits check algorithm to execute exactly one kubernetes api call per KubernetesCloud#provision call. The previous version was executing 2 calls for each potential node to provision.\nIntroduces a launching field on KubernetesComputer. This intends to capture the moment where agents exist in kubernetes but not yet usable so that we can compute more accurately the limits.\nReverts some of the NoDelayProvisionerStategy changes from #824. These changes were trying to avoid the standard strategy to run because this was overprovisioning the cloud by the number of planned nodes.", "createdAt": "2020-09-02T14:13:03Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/835", "merged": true, "mergeCommit": {"oid": "2abb784d113b26c81e88323b191c46772c46849e"}, "closed": true, "closedAt": "2020-11-04T13:41:50Z", "author": {"login": "Vlatombe"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE8jWhgH2gAyNDc3ODUwMzMwOjllMGU5YWJlNmVlMDVjZTM2ZDIwYWYyYmI5MjUwNzFhNDdhMzM3Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZN9zmgH2gAyNDc3ODUwMzMwOmY4YmE2YTJlOTdjNWYzZDdjZmZjZGJmOTBmZWZjMWMwZGUzNjFmYmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e0e9abe6ee05ce36d20af2bb925071a47a33738", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/9e0e9abe6ee05ce36d20af2bb925071a47a33738", "committedDate": "2020-09-02T14:05:51Z", "message": "Rework concurrency limits using the number provided in Cloud API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcb8786a442b7f81a9f4d52aa63a998aff2f1219", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/dcb8786a442b7f81a9f4d52aa63a998aff2f1219", "committedDate": "2020-09-03T15:42:49Z", "message": "Bump core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fa552749b1df967c98ac5ab8760542ccdedca10", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/0fa552749b1df967c98ac5ab8760542ccdedca10", "committedDate": "2020-09-16T11:59:23Z", "message": "Merge branch 'master' into concurrency-limits-core-patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc1558fe81120140b257295243677d27b73d84d", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/8bc1558fe81120140b257295243677d27b73d84d", "committedDate": "2020-09-23T12:25:02Z", "message": "Merge branch 'master' into concurrency-limits-core-patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "646f3c7801e927beb91e56a39d84b58460420b37", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/646f3c7801e927beb91e56a39d84b58460420b37", "committedDate": "2020-09-23T12:52:22Z", "message": "Add some tests and clarify method names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTkxNTI4", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/835#pullrequestreview-495591528", "createdAt": "2020-09-24T13:48:05Z", "commit": {"oid": "646f3c7801e927beb91e56a39d84b58460420b37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32e968f493469cd9e20dcf79e087cdc1ff522e8", "author": {"user": {"login": "jglick", "name": "Jesse Glick"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b32e968f493469cd9e20dcf79e087cdc1ff522e8", "committedDate": "2020-10-23T12:58:14Z", "message": "Bump to next LTS baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a32ced8462799b22a75a71f51b21b7c11d54b772", "author": {"user": {"login": "jglick", "name": "Jesse Glick"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/a32ced8462799b22a75a71f51b21b7c11d54b772", "committedDate": "2020-10-23T13:04:05Z", "message": "Noting https://github.com/jenkinsci/bom/pull/339"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MjgwNjA3", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/835#pullrequestreview-516280607", "createdAt": "2020-10-24T14:10:18Z", "commit": {"oid": "a32ced8462799b22a75a71f51b21b7c11d54b772"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNDoxMDoxOFrOHnxdoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNDoxMDoxOFrOHnxdoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ2NjkxMg==", "bodyText": "New BOM is ready; also see #875.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/835#discussion_r511466912", "createdAt": "2020-10-24T14:10:18Z", "author": {"login": "jglick"}, "path": "pom.xml", "diffHunk": "@@ -252,7 +252,7 @@\n     <dependencies>\n       <dependency>\n         <groupId>io.jenkins.tools.bom</groupId>\n-        <artifactId>bom-2.222.x</artifactId>\n+        <artifactId>bom-2.222.x</artifactId> <!-- TODO https://github.com/jenkinsci/bom/pull/339 -->\n         <version>12</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a32ced8462799b22a75a71f51b21b7c11d54b772"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e1b236a458ea2365ba7e413a6762cbad217dba1", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/2e1b236a458ea2365ba7e413a6762cbad217dba1", "committedDate": "2020-11-03T09:13:36Z", "message": "Merge branch 'master' into concurrency-limits-core-patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6550b53dce3e837d6a1d90d5847660613c1f787", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b6550b53dce3e837d6a1d90d5847660613c1f787", "committedDate": "2020-11-03T09:15:08Z", "message": "Update to LTS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ad650bff0ca8f70416e12a30f3459121b5dbac", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/51ad650bff0ca8f70416e12a30f3459121b5dbac", "committedDate": "2020-11-03T09:16:49Z", "message": "Merge remote-tracking branch 'Vlatombe/concurrency-limits-core-patch' into concurrency-limits-core-patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "944284a1b5d80168bafcef2ba90c2061811bbb43", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/944284a1b5d80168bafcef2ba90c2061811bbb43", "committedDate": "2020-11-03T09:50:42Z", "message": "Use getter instead of direct field access"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjUzMjg4", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/835#pullrequestreview-522653288", "createdAt": "2020-11-03T16:09:59Z", "commit": {"oid": "944284a1b5d80168bafcef2ba90c2061811bbb43"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjowOTo1OVrOHs1-7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjowOTo1OVrOHs1-7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc4Mzg1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                LOGGER.log(Level.FINE, \"Global slots left for \\\"{0}\\\": {1}\", new Object[]{name, remainingGlobalSlots});\n          \n          \n            \n                                LOGGER.fine(() -> \"Global slots left for \" + name + \": \" + remainingGlobalSlots);\n          \n      \n    \n    \n  \n\nif you like", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/835#discussion_r516783854", "createdAt": "2020-11-03T16:09:59Z", "author": {"login": "jglick"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -527,31 +527,49 @@ public KubernetesClient connect() throws KubernetesAuthException, IOException {\n     }\n \n     @Override\n-    public synchronized Collection<NodeProvisioner.PlannedNode> provision(@CheckForNull final Label label, final int excessWorkload) {\n+    public synchronized Collection<NodeProvisioner.PlannedNode> provision(@NonNull final Cloud.CloudState state, final int excessWorkload) {\n         try {\n-            Set<String> allInProvisioning = InProvisioning.getAllInProvisioning(label);\n+            Label label = state.getLabel();\n+            int plannedCapacity = state.getAdditionalPlannedCapacity(); // Planned nodes, will be launched on the next round of NodeProvisioner\n+            Set<String> allInProvisioning = InProvisioning.getAllInProvisioning(label); // Nodes being launched\n             LOGGER.log(Level.FINE, () -> \"In provisioning : \" + allInProvisioning);\n             int toBeProvisioned = Math.max(0, excessWorkload - allInProvisioning.size());\n-            LOGGER.log(Level.INFO, \"Excess workload after pending Kubernetes agents: {0}\", toBeProvisioned);\n-\n-            List<NodeProvisioner.PlannedNode> r = new ArrayList<NodeProvisioner.PlannedNode>();\n-\n-            for (PodTemplate t: getTemplatesFor(label)) {\n-                LOGGER.log(Level.INFO, \"Template for label {0}: {1}\", new Object[] { label, t.getName() });\n-                for (int i = 0; i < toBeProvisioned; i++) {\n-                    if (!mayAddProvisionedSlave(t, label, i)) {\n-                        break;\n+            Set<Node> nodes = getNodes(label);\n+            int currentExecutorsCount = (int) nodes.stream().filter(KubernetesSlave.class::isInstance).map(Node::getNumExecutors).count();\n+            int launchingExecutorsCount = (int) nodes.stream().filter(KubernetesSlave.class::isInstance).filter(n -> n.toComputer() != null && ((KubernetesComputer)n.toComputer()).isLaunching()).map(Node::getNumExecutors).count();\n+            LOGGER.log(Level.INFO, \"Label \\\"{0}\\\" excess workload: {1},\" +\n+                    \" executors: {2},\" +\n+                    \" plannedCapacity: {3},\" +\n+                            \" launching: {4}\",\n+                    new Object[] {label, toBeProvisioned, currentExecutorsCount, plannedCapacity, launchingExecutorsCount});\n+            List<NodeProvisioner.PlannedNode> plannedNodes = new ArrayList<>();\n+            List<Pod> pods = getPodsWithLabels(namespace, getPodLabelsMap());\n+            if (pods != null) {\n+                // Count planned and executors not yet launching (e.g. everything that is not in kubernetes yet)\n+                int plannedCount = plannedCapacity + currentExecutorsCount - launchingExecutorsCount;\n+                int remainingGlobalSlots = getRemainingGlobalSlots(pods, plannedCount);\n+                if (remainingGlobalSlots > 0) {\n+                    LOGGER.log(Level.FINE, \"Global slots left for \\\"{0}\\\": {1}\", new Object[]{name, remainingGlobalSlots});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "944284a1b5d80168bafcef2ba90c2061811bbb43"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ba6a2e97c5f3d7cffcdbf90fefc1c0de361fbb", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/f8ba6a2e97c5f3d7cffcdbf90fefc1c0de361fbb", "committedDate": "2020-11-04T13:41:37Z", "message": "Update src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java\n\nCo-authored-by: Jesse Glick <jglick@cloudbees.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 163, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}