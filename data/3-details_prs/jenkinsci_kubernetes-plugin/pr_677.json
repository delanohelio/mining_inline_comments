{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNTAxMjA1", "number": 677, "title": "[JENKINS-60537] Sanitize label", "bodyText": "JENKINS-60537\nShould fix behaviour when using multiple labels on a single pod template.\nFor a pod template with the labels label1 label2, the pod will be labeled jenkins/label=label1_label2, since spaces are not allowed in kubernetes labels values.\nAmends #666", "createdAt": "2020-01-08T15:01:01Z", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/677", "merged": true, "mergeCommit": {"oid": "bd0b85f619d35ebe2446bc69b2d98532f59a1cdc"}, "closed": true, "closedAt": "2020-01-09T16:13:38Z", "author": {"login": "Vlatombe"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4WrHzAH2gAyMzYwNTAxMjA1OjA0ODA4ZmNiOTE5OGJhYzlmZjIzN2ZlY2JlNWZlNzA1NjdjMWYyZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4q1-DgFqTM0MDU1ODEyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "04808fcb9198bac9ff237fecbe5fe70567c1f2ff", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/04808fcb9198bac9ff237fecbe5fe70567c1f2ff", "committedDate": "2020-01-08T14:59:42Z", "message": "[JENKINS-60537] Sanitize label"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be4b55ffc3f85eca842fbb42cdaa7f8937a8747d", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/be4b55ffc3f85eca842fbb42cdaa7f8937a8747d", "committedDate": "2020-01-08T15:51:34Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNTI5ODg3", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/677#pullrequestreview-340529887", "createdAt": "2020-01-09T13:47:33Z", "commit": {"oid": "be4b55ffc3f85eca842fbb42cdaa7f8937a8747d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzo0NzozM1rOFb2Vfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzo0OTozMFrOFb2Zdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc0NjExMA==", "bodyText": "IIRC there was a similar utility method elsewhere in this plugin.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/677#discussion_r364746110", "createdAt": "2020-01-09T13:47:33Z", "author": {"login": "jglick"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplate.java", "diffHunk": "@@ -379,7 +379,17 @@ public String getActiveDeadlineSecondsStr() {\n     }\n \n     public Map<String, String> getLabelsMap() {\n-        return ImmutableMap.of(\"jenkins/label\", label == null ? DEFAULT_ID : label);\n+        return ImmutableMap.of(\"jenkins/label\", label == null ? DEFAULT_ID : sanitizeLabel(label));\n+    }\n+\n+    private String sanitizeLabel(String input) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be4b55ffc3f85eca842fbb42cdaa7f8937a8747d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc0NjU2MQ==", "bodyText": "A unit test would be in order for this sort of thing I guess.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/677#discussion_r364746561", "createdAt": "2020-01-09T13:48:28Z", "author": {"login": "jglick"}, "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplate.java", "diffHunk": "@@ -379,7 +379,17 @@ public String getActiveDeadlineSecondsStr() {\n     }\n \n     public Map<String, String> getLabelsMap() {\n-        return ImmutableMap.of(\"jenkins/label\", label == null ? DEFAULT_ID : label);\n+        return ImmutableMap.of(\"jenkins/label\", label == null ? DEFAULT_ID : sanitizeLabel(label));\n+    }\n+\n+    private String sanitizeLabel(String input) {\n+        String label = input;\n+        int max = 63; // Kubernetes limit\n+        if (label.length() > max) {\n+            label = label.substring(label.length() - max);\n+        }\n+        label = label.replaceAll(\"[^_.a-zA-Z0-9-]\", \"_\").replaceFirst(\"^[^a-zA-Z0-9]\", \"x\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be4b55ffc3f85eca842fbb42cdaa7f8937a8747d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc0NzEyNw==", "bodyText": "Do we also expect that the Computer has the original labels label1 & label2? I guess \n  \n    \n      kubernetes-plugin/src/test/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/podTemplateWithMultipleLabels.groovy\n    \n    \n         Line 1\n      in\n      be4b55f\n    \n    \n    \n    \n\n        \n          \n           node('label1') { \n        \n    \n  \n\n tests this implicitly but for the benefit of readers it might be good to assert this explicitly.", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/677#discussion_r364747127", "createdAt": "2020-01-09T13:49:30Z", "author": {"login": "jglick"}, "path": "src/test/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/KubernetesPipelineTest.java", "diffHunk": "@@ -382,6 +384,26 @@ public void runInPodWithLivenessProbe() throws Exception {\n         r.assertLogContains(\"Still alive\", b);\n     }\n \n+    @Test\n+    public void podTemplateWithMultipleLabels() throws Exception {\n+        PodTemplate pt = new PodTemplate();\n+        pt.setName(\"podTemplate\");\n+        pt.setLabel(\"label1 label2\");\n+        ContainerTemplate jnlp = new ContainerTemplate(\"jnlp\", \"jenkins/jnlp-slave:3.35-5-alpine\");\n+        pt.setContainers(Collections.singletonList(jnlp));\n+        cloud.addTemplate(pt);\n+        SemaphoreStep.waitForStart(\"pod/1\", b);\n+        Map<String, String> labels = getLabels(cloud, this, name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be4b55ffc3f85eca842fbb42cdaa7f8937a8747d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "288cd2c9ca6cea344c6427513be3720ecbfdf109", "author": {"user": {"login": "Vlatombe", "name": "Vincent Latombe"}}, "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/288cd2c9ca6cea344c6427513be3720ecbfdf109", "committedDate": "2020-01-09T14:08:34Z", "message": "Fix reviews from Jesse\n\n* Add a unit test for sanitizeLabel\n* Assert the node bears the given labels"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNTU4MTI3", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/677#pullrequestreview-340558127", "createdAt": "2020-01-09T14:29:39Z", "commit": {"oid": "288cd2c9ca6cea344c6427513be3720ecbfdf109"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 168, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}