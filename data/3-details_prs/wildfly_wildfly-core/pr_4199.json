{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3ODU2Nzkx", "number": 4199, "title": "WFCORE-4967 fix: RequestController drops queued tasks randomly during server start.", "bodyText": "solves: https://issues.redhat.com/browse/WFCORE-4967\nfindForcedTask method implementation could be improved but synchronization is fine from my point of view when server is paused anyway.", "createdAt": "2020-05-14T09:06:48Z", "url": "https://github.com/wildfly/wildfly-core/pull/4199", "merged": true, "mergeCommit": {"oid": "08d5c82ed8a4dc2b8d77fd453cd4de56ee909994"}, "closed": true, "closedAt": "2020-12-04T17:50:48Z", "author": {"login": "khroolick"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchJSjyAH2gAyNDE3ODU2NzkxOmM4N2NhODFlOTIxZDg4OTBlYjQxZGQ1ZDE0Yzk5MTQzYzgzZGNlMjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOdMZpAFqTUwMDgzODk1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c87ca81e921d8890eb41dd5d14c99143c83dce24", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/c87ca81e921d8890eb41dd5d14c99143c83dce24", "committedDate": "2020-05-14T08:35:00Z", "message": "WFCORE-4967 multithreaded test of paused RequestController"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb573cfc223eb9af9a253dc99933a4cef6ed8ca5", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/bb573cfc223eb9af9a253dc99933a4cef6ed8ca5", "committedDate": "2020-05-14T08:39:10Z", "message": "WFCORE-4967 make findForcedTask method synchronised"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjkxMDA5", "url": "https://github.com/wildfly/wildfly-core/pull/4199#pullrequestreview-412291009", "createdAt": "2020-05-15T01:34:38Z", "commit": {"oid": "bb573cfc223eb9af9a253dc99933a4cef6ed8ca5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMTozNDozOVrOGVzkig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMTozNDozOVrOGVzkig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxODIxOA==", "bodyText": "So AIUI the basic problem is that one or more of the threads that called rc.requestComplete() when paused == true  is executing findForcedTask and has drained some tasks from taskQueue into the 'storage' list. And at the same time rc.resume is called and it therefore finds the queue empty and returns.  When the thread in findForcedTask puts its 'storage' tasks back in the queue there is nothing to execute them.\nIs that a correct summary?", "url": "https://github.com/wildfly/wildfly-core/pull/4199#discussion_r425518218", "createdAt": "2020-05-15T01:34:39Z", "author": {"login": "bstansberry"}, "path": "request-controller/src/test/java/org/wildfly/extension/requestcontroller/WFCORE4967_TestCase.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.wildfly.extension.requestcontroller;\r\n+\r\n+import static org.junit.Assert.assertEquals;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.List;\r\n+import java.util.concurrent.CountDownLatch;\r\n+import java.util.concurrent.atomic.AtomicInteger;\r\n+\r\n+import org.junit.Test;\r\n+\r\n+public class WFCORE4967_TestCase {\r\n+    private static final int TASKS_QTY = 10;\r\n+    private static final int THREADS_QTY = 20;\r\n+\r\n+    @Test\r\n+    public void noQueuedTasksLossWhenRunningRequestCompleteOnSuspendedRC() throws InterruptedException {\r\n+        final AtomicInteger executedTaskCount = new AtomicInteger();\r\n+\r\n+        RequestController rc = suspendedRCWithQueuedTasks(TASKS_QTY, () -> {\r\n+            executedTaskCount.incrementAndGet();\r\n+        });\r\n+\r\n+        CountDownLatch latch = new CountDownLatch(THREADS_QTY);\r\n+        createSynchronisedThreads(latch, () -> {\r\n+            rc.requestComplete();\r\n+        }).forEach(Thread::start);\r\n+        latch.await();\r\n+\r\n+        rc.resume();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb573cfc223eb9af9a253dc99933a4cef6ed8ca5"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16d8e8861ed65ac574eb36dd9ccdff6f61e08e35", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/16d8e8861ed65ac574eb36dd9ccdff6f61e08e35", "committedDate": "2020-05-18T07:52:37Z", "message": "WFCORE-4967 fix NPE potential in findForcedTask\n\nThat makes this method thread safe without locking on RequestController\ninstance but doesn't guarantee that all tasks will be run on resume()\nfrom `Controller Boot Thread`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MjQ1NDcy", "url": "https://github.com/wildfly/wildfly-core/pull/4199#pullrequestreview-418245472", "createdAt": "2020-05-26T12:26:14Z", "commit": {"oid": "16d8e8861ed65ac574eb36dd9ccdff6f61e08e35"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjoyNjoxNFrOGab3BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjoyNjoxNFrOGab3BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM3MjYxMg==", "bodyText": "I'll let @bstansberry review your changes as he already reviewed your PR\nHowever could you please rename this variable? WildFly code convention do not use _ to prefix variables? thanks", "url": "https://github.com/wildfly/wildfly-core/pull/4199#discussion_r430372612", "createdAt": "2020-05-26T12:26:14Z", "author": {"login": "jmesnil"}, "path": "request-controller/src/main/java/org/wildfly/extension/requestcontroller/RequestController.java", "diffHunk": "@@ -397,20 +397,20 @@ private boolean runQueuedTask(boolean hasPermit) {\n     }\n \n     private QueuedTask findForcedTask() {\n-        QueuedTask task = null;\n+        QueuedTask _ret = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d8e8861ed65ac574eb36dd9ccdff6f61e08e35"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57264878bb72b35fa0afd44e4631c76f1e2ed9ed", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/57264878bb72b35fa0afd44e4631c76f1e2ed9ed", "committedDate": "2020-05-26T12:48:19Z", "message": "rename variable as suggested in pr"}, "afterCommit": {"oid": "21f7026a62ab6f0000b5da5ba856f6583e9d56ee", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/21f7026a62ab6f0000b5da5ba856f6583e9d56ee", "committedDate": "2020-07-01T17:34:48Z", "message": "WFCORE-4967 fix problem of dropping forced tasks introduced in previous\ncommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7c3f834389f3947d8495e44c83744f11d9a8b1c", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/b7c3f834389f3947d8495e44c83744f11d9a8b1c", "committedDate": "2020-07-01T17:40:11Z", "message": "WFCORE-4967 fix problem of dropping forced tasks introduced in previous\ncommit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21f7026a62ab6f0000b5da5ba856f6583e9d56ee", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/21f7026a62ab6f0000b5da5ba856f6583e9d56ee", "committedDate": "2020-07-01T17:34:48Z", "message": "WFCORE-4967 fix problem of dropping forced tasks introduced in previous\ncommit"}, "afterCommit": {"oid": "b7c3f834389f3947d8495e44c83744f11d9a8b1c", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/b7c3f834389f3947d8495e44c83744f11d9a8b1c", "committedDate": "2020-07-01T17:40:11Z", "message": "WFCORE-4967 fix problem of dropping forced tasks introduced in previous\ncommit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MzI2NDY2", "url": "https://github.com/wildfly/wildfly-core/pull/4199#pullrequestreview-497326466", "createdAt": "2020-09-28T09:13:05Z", "commit": {"oid": "b7c3f834389f3947d8495e44c83744f11d9a8b1c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwOToxMzowNVrOHY1EcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwOToxMzowNVrOHY1EcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc5NzM2MA==", "bodyText": "could you please rename all _ret variables ? that's the only remaining request before I can merge this PR.\nthanks", "url": "https://github.com/wildfly/wildfly-core/pull/4199#discussion_r495797360", "createdAt": "2020-09-28T09:13:05Z", "author": {"login": "jmesnil"}, "path": "request-controller/src/test/java/org/wildfly/extension/requestcontroller/WFCORE4967_TestCase.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package org.wildfly.extension.requestcontroller;\r\n+\r\n+import static org.junit.Assert.assertEquals;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.List;\r\n+import java.util.concurrent.CountDownLatch;\r\n+import java.util.concurrent.atomic.AtomicInteger;\r\n+\r\n+import org.junit.Test;\r\n+\r\n+public class WFCORE4967_TestCase {\r\n+    private static final int TASKS_QTY = 10;\r\n+    private static final int THREADS_QTY = 20;\r\n+\r\n+    @Test\r\n+    public void noQueuedTasksLossWhenRunningRequestCompleteOnSuspendedRC() throws InterruptedException {\r\n+        final AtomicInteger executedTaskCount = new AtomicInteger();\r\n+\r\n+        RequestController rc = suspendedRCWithQueuedTasks(TASKS_QTY, () -> {\r\n+            executedTaskCount.incrementAndGet();\r\n+        });\r\n+\r\n+        CountDownLatch latch = new CountDownLatch(THREADS_QTY);\r\n+        List<Thread> threads = createSynchronisedThreads(latch, () -> {\r\n+            rc.requestComplete();\r\n+        });\r\n+        threads.forEach(Thread::start);\r\n+        // wait until all above threads ready to fire rc.requestComplete() together with bellow rc.resume()\r\n+        latch.await();\r\n+        rc.resume();\r\n+\r\n+        for (Thread t : threads) {\r\n+            t.join();\r\n+        }\r\n+\r\n+        // simulate just enough requests after server is resumed to drain potential outstanding tasks from taskQueue\r\n+        for (int requestNo = 0; requestNo < TASKS_QTY; requestNo++) {\r\n+            rc.requestComplete();\r\n+        }\r\n+\r\n+        assertEquals(TASKS_QTY, executedTaskCount.intValue());\r\n+    }\r\n+\r\n+    private RequestController suspendedRCWithQueuedTasks(int i, Runnable whenExecuted) {\r\n+        RequestController _ret = new RequestController(false);\r\n+        _ret.suspended(() -> {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3f834389f3947d8495e44c83744f11d9a8b1c"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48a1eb12cba448860e0d194a521bc2a14e3c4e4a", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly-core/commit/48a1eb12cba448860e0d194a521bc2a14e3c4e4a", "committedDate": "2020-10-01T07:01:48Z", "message": "WFCORE4967 avoid _ret variable name (test code)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwODM4OTU5", "url": "https://github.com/wildfly/wildfly-core/pull/4199#pullrequestreview-500838959", "createdAt": "2020-10-02T03:12:58Z", "commit": {"oid": "48a1eb12cba448860e0d194a521bc2a14e3c4e4a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3400, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}