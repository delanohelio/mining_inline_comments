{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNjI3NjU4", "number": 4082, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOTowNTowN1rOD0pdOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNjowNjo1NlrOEQsatw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NTMxNzcxOnYy", "diffSide": "RIGHT", "path": "elytron/src/main/java/org/wildfly/extension/elytron/FailoverRealmDefinition.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOTowNTowN1rOGJrtww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOTowNTowN1rOGJrtww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgwNjU5NQ==", "bodyText": "The description seems confusing to me a bit since the wrapped realm is delegate-realm and delegated realm is failover-realm.", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r412806595", "createdAt": "2020-04-22T09:05:07Z", "author": {"login": "OndrejKotek"}, "path": "elytron/src/main/java/org/wildfly/extension/elytron/FailoverRealmDefinition.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2019 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.wildfly.extension.elytron;\n+\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_CAPABILITY;\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_RUNTIME_CAPABILITY;\n+import static org.wildfly.extension.elytron.ElytronDefinition.commonDependencies;\n+\n+\n+import org.jboss.as.controller.AbstractAddStepHandler;\n+import org.jboss.as.controller.AbstractWriteAttributeHandler;\n+import org.jboss.as.controller.AttributeDefinition;\n+import org.jboss.as.controller.OperationContext;\n+import org.jboss.as.controller.OperationFailedException;\n+import org.jboss.as.controller.OperationStepHandler;\n+import org.jboss.as.controller.PathElement;\n+import org.jboss.as.controller.ResourceDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinitionBuilder;\n+import org.jboss.as.controller.SimpleResourceDefinition;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n+import org.jboss.as.controller.registry.AttributeAccess;\n+import org.jboss.as.controller.registry.ManagementResourceRegistration;\n+import org.jboss.as.controller.registry.OperationEntry;\n+import org.jboss.dmr.ModelNode;\n+import org.jboss.dmr.ModelType;\n+import org.jboss.msc.inject.Injector;\n+import org.jboss.msc.service.ServiceBuilder;\n+import org.jboss.msc.service.ServiceController.Mode;\n+import org.jboss.msc.service.ServiceName;\n+import org.jboss.msc.service.ServiceTarget;\n+import org.jboss.msc.value.InjectedValue;\n+\n+import org.wildfly.security.auth.realm.FailoverModifiableSecurityRealm;\n+import org.wildfly.security.auth.realm.FailoverSecurityRealm;\n+import org.wildfly.security.auth.server.ModifiableSecurityRealm;\n+import org.wildfly.security.auth.server.RealmUnavailableException;\n+import org.wildfly.security.auth.server.SecurityDomain;\n+import org.wildfly.security.auth.server.SecurityRealm;\n+import org.wildfly.security.auth.server.event.SecurityRealmUnavailableEvent;\n+\n+import java.util.function.Consumer;\n+\n+/**\n+ * A {@link ResourceDefinition} for a {@link SecurityRealm} which wraps one realm and delegates to another in case the first is unavailable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e078436b1ba54f7c65d67a6a1f60783054dc7d4c"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NTYyODM3OnYy", "diffSide": "RIGHT", "path": "elytron/src/main/resources/schema/wildfly-elytron_10_0.xsd", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMDoxNDoxMFrOGJupXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMDoxNDoxMFrOGJupXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg1NDYyMw==", "bodyText": "The description seems confusing to me a bit since the wrapped realm is delegate-realm and delegated realm is failover-realm.", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r412854623", "createdAt": "2020-04-22T10:14:10Z", "author": {"login": "OndrejKotek"}, "path": "elytron/src/main/resources/schema/wildfly-elytron_10_0.xsd", "diffHunk": "@@ -1136,6 +1137,32 @@\n \t\t</xs:complexContent>\n \t</xs:complexType>\n \n+    <xs:complexType name=\"failoverRealmType\">\n+        <xs:annotation>\n+            <xs:documentation>\n+                A realm definition which wraps one realm and delegates to another in case the first is unavailable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e078436b1ba54f7c65d67a6a1f60783054dc7d4c"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODQ5Mjc3OnYy", "diffSide": "RIGHT", "path": "elytron/src/main/java/org/wildfly/extension/elytron/FailoverRealmDefinition.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjoyNzoxMlrOGUEG7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjozMToxM1rOGUEQnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5MjAxNA==", "bodyText": "The realm should offer operations with identity (add-identity, read-identity, ...).", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r423692014", "createdAt": "2020-05-12T12:27:12Z", "author": {"login": "OndrejKotek"}, "path": "elytron/src/main/java/org/wildfly/extension/elytron/FailoverRealmDefinition.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2019 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.wildfly.extension.elytron;\n+\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_CAPABILITY;\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_RUNTIME_CAPABILITY;\n+import static org.wildfly.extension.elytron.ElytronDefinition.commonDependencies;\n+\n+\n+import org.jboss.as.controller.AbstractAddStepHandler;\n+import org.jboss.as.controller.AbstractWriteAttributeHandler;\n+import org.jboss.as.controller.AttributeDefinition;\n+import org.jboss.as.controller.OperationContext;\n+import org.jboss.as.controller.OperationFailedException;\n+import org.jboss.as.controller.OperationStepHandler;\n+import org.jboss.as.controller.PathElement;\n+import org.jboss.as.controller.ResourceDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinitionBuilder;\n+import org.jboss.as.controller.SimpleResourceDefinition;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n+import org.jboss.as.controller.registry.AttributeAccess;\n+import org.jboss.as.controller.registry.ManagementResourceRegistration;\n+import org.jboss.as.controller.registry.OperationEntry;\n+import org.jboss.dmr.ModelNode;\n+import org.jboss.dmr.ModelType;\n+import org.jboss.msc.inject.Injector;\n+import org.jboss.msc.service.ServiceBuilder;\n+import org.jboss.msc.service.ServiceController.Mode;\n+import org.jboss.msc.service.ServiceName;\n+import org.jboss.msc.service.ServiceTarget;\n+import org.jboss.msc.value.InjectedValue;\n+\n+import org.wildfly.security.auth.realm.FailoverModifiableSecurityRealm;\n+import org.wildfly.security.auth.realm.FailoverSecurityRealm;\n+import org.wildfly.security.auth.server.ModifiableSecurityRealm;\n+import org.wildfly.security.auth.server.RealmUnavailableException;\n+import org.wildfly.security.auth.server.SecurityDomain;\n+import org.wildfly.security.auth.server.SecurityRealm;\n+import org.wildfly.security.auth.server.event.SecurityRealmUnavailableEvent;\n+\n+import java.util.function.Consumer;\n+\n+/**\n+ * A {@link ResourceDefinition} for a {@link SecurityRealm} which wraps one realm and fails over to another in case the first is unavailable.\n+ *\n+ * @author <a href=\"mailto:mmazanek@jboss.com\">Martin Mazanek</a>\n+ */\n+class FailoverRealmDefinition extends SimpleResourceDefinition {\n+\n+    static final ServiceUtil<SecurityRealm> REALM_SERVICE_UTIL = ServiceUtil.newInstance(SECURITY_REALM_RUNTIME_CAPABILITY, ElytronDescriptionConstants.AGGREGATE_REALM, SecurityRealm.class);\n+\n+    static final SimpleAttributeDefinition DELEGATE_REALM = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.DELEGATE_REALM, ModelType.STRING, false)\n+            .setMinSize(1)\n+            .setCapabilityReference(SECURITY_REALM_CAPABILITY, SECURITY_REALM_CAPABILITY)\n+            .setRestartAllServices()\n+            .build();\n+\n+    static final SimpleAttributeDefinition FAILOVER_REALM = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.FAILOVER_REALM, ModelType.STRING, false)\n+            .setMinSize(1)\n+            .setCapabilityReference(SECURITY_REALM_CAPABILITY, SECURITY_REALM_CAPABILITY)\n+            .setRestartAllServices()\n+            .build();\n+\n+    static final SimpleAttributeDefinition EMIT_EVENTS = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.EMIT_EVENTS, ModelType.BOOLEAN, true)\n+            .setAllowExpression(true)\n+            .setMinSize(1)\n+            .setFlags(AttributeAccess.Flag.RESTART_RESOURCE_SERVICES)\n+            .setDefaultValue(ModelNode.TRUE)\n+            .build();\n+\n+    static final AttributeDefinition[] ATTRIBUTES = new AttributeDefinition[] { DELEGATE_REALM, FAILOVER_REALM, EMIT_EVENTS};\n+\n+    private static final AbstractAddStepHandler ADD = new RealmAddHandler();\n+    private static final OperationStepHandler REMOVE = new TrivialCapabilityServiceRemoveHandler(ADD, SECURITY_REALM_RUNTIME_CAPABILITY);\n+\n+    FailoverRealmDefinition() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7e95b04cb6582920d92482f67d373bcb5aafb8"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5NDQ5NQ==", "bodyText": "I would only expect a realm to expose those operations if it exposes the modifiable realm capability, it wouldn't make sense to be able to support failing over things like an add-identity operation.", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r423694495", "createdAt": "2020-05-12T12:31:13Z", "author": {"login": "darranl"}, "path": "elytron/src/main/java/org/wildfly/extension/elytron/FailoverRealmDefinition.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2019 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.wildfly.extension.elytron;\n+\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_CAPABILITY;\n+import static org.wildfly.extension.elytron.Capabilities.SECURITY_REALM_RUNTIME_CAPABILITY;\n+import static org.wildfly.extension.elytron.ElytronDefinition.commonDependencies;\n+\n+\n+import org.jboss.as.controller.AbstractAddStepHandler;\n+import org.jboss.as.controller.AbstractWriteAttributeHandler;\n+import org.jboss.as.controller.AttributeDefinition;\n+import org.jboss.as.controller.OperationContext;\n+import org.jboss.as.controller.OperationFailedException;\n+import org.jboss.as.controller.OperationStepHandler;\n+import org.jboss.as.controller.PathElement;\n+import org.jboss.as.controller.ResourceDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinition;\n+import org.jboss.as.controller.SimpleAttributeDefinitionBuilder;\n+import org.jboss.as.controller.SimpleResourceDefinition;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n+import org.jboss.as.controller.registry.AttributeAccess;\n+import org.jboss.as.controller.registry.ManagementResourceRegistration;\n+import org.jboss.as.controller.registry.OperationEntry;\n+import org.jboss.dmr.ModelNode;\n+import org.jboss.dmr.ModelType;\n+import org.jboss.msc.inject.Injector;\n+import org.jboss.msc.service.ServiceBuilder;\n+import org.jboss.msc.service.ServiceController.Mode;\n+import org.jboss.msc.service.ServiceName;\n+import org.jboss.msc.service.ServiceTarget;\n+import org.jboss.msc.value.InjectedValue;\n+\n+import org.wildfly.security.auth.realm.FailoverModifiableSecurityRealm;\n+import org.wildfly.security.auth.realm.FailoverSecurityRealm;\n+import org.wildfly.security.auth.server.ModifiableSecurityRealm;\n+import org.wildfly.security.auth.server.RealmUnavailableException;\n+import org.wildfly.security.auth.server.SecurityDomain;\n+import org.wildfly.security.auth.server.SecurityRealm;\n+import org.wildfly.security.auth.server.event.SecurityRealmUnavailableEvent;\n+\n+import java.util.function.Consumer;\n+\n+/**\n+ * A {@link ResourceDefinition} for a {@link SecurityRealm} which wraps one realm and fails over to another in case the first is unavailable.\n+ *\n+ * @author <a href=\"mailto:mmazanek@jboss.com\">Martin Mazanek</a>\n+ */\n+class FailoverRealmDefinition extends SimpleResourceDefinition {\n+\n+    static final ServiceUtil<SecurityRealm> REALM_SERVICE_UTIL = ServiceUtil.newInstance(SECURITY_REALM_RUNTIME_CAPABILITY, ElytronDescriptionConstants.AGGREGATE_REALM, SecurityRealm.class);\n+\n+    static final SimpleAttributeDefinition DELEGATE_REALM = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.DELEGATE_REALM, ModelType.STRING, false)\n+            .setMinSize(1)\n+            .setCapabilityReference(SECURITY_REALM_CAPABILITY, SECURITY_REALM_CAPABILITY)\n+            .setRestartAllServices()\n+            .build();\n+\n+    static final SimpleAttributeDefinition FAILOVER_REALM = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.FAILOVER_REALM, ModelType.STRING, false)\n+            .setMinSize(1)\n+            .setCapabilityReference(SECURITY_REALM_CAPABILITY, SECURITY_REALM_CAPABILITY)\n+            .setRestartAllServices()\n+            .build();\n+\n+    static final SimpleAttributeDefinition EMIT_EVENTS = new SimpleAttributeDefinitionBuilder(ElytronDescriptionConstants.EMIT_EVENTS, ModelType.BOOLEAN, true)\n+            .setAllowExpression(true)\n+            .setMinSize(1)\n+            .setFlags(AttributeAccess.Flag.RESTART_RESOURCE_SERVICES)\n+            .setDefaultValue(ModelNode.TRUE)\n+            .build();\n+\n+    static final AttributeDefinition[] ATTRIBUTES = new AttributeDefinition[] { DELEGATE_REALM, FAILOVER_REALM, EMIT_EVENTS};\n+\n+    private static final AbstractAddStepHandler ADD = new RealmAddHandler();\n+    private static final OperationStepHandler REMOVE = new TrivialCapabilityServiceRemoveHandler(ADD, SECURITY_REALM_RUNTIME_CAPABILITY);\n+\n+    FailoverRealmDefinition() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5MjAxNA=="}, "originalCommit": {"oid": "8d7e95b04cb6582920d92482f67d373bcb5aafb8"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1OTQwNDA3OnYy", "diffSide": "RIGHT", "path": "elytron/src/main/resources/schema/wildfly-elytron_11_0.xsd", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNjowNjo1NlrOG0_QWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxOTozNzoxM1rOG9Bk5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNTUxMg==", "bodyText": "Looks like emit-events is missing here.", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r458215512", "createdAt": "2020-07-21T16:06:56Z", "author": {"login": "fjuma"}, "path": "elytron/src/main/resources/schema/wildfly-elytron_11_0.xsd", "diffHunk": "@@ -1164,6 +1165,33 @@\n         </xs:complexContent>\n     </xs:complexType>\n \n+\n+    <xs:complexType name=\"failoverRealmType\">\n+        <xs:annotation>\n+            <xs:documentation>\n+                A realm definition which wraps one realm and delegates to another in case the first is unavailable.\n+            </xs:documentation>\n+        </xs:annotation>\n+        <xs:complexContent>\n+            <xs:extension base=\"realmType\">\n+                <xs:attribute name=\"delegate-realm\" type=\"xs:string\" use=\"required\">\n+                    <xs:annotation>\n+                        <xs:documentation>\n+                            The name of the realm to use as a default.\n+                        </xs:documentation>\n+                    </xs:annotation>\n+                </xs:attribute>\n+                <xs:attribute name=\"failover-realm\" type=\"xs:string\" use=\"required\">\n+                    <xs:annotation>\n+                        <xs:documentation>\n+                            The name of the realm to use in case the default realm is unavailable.\n+                        </xs:documentation>\n+                    </xs:annotation>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9b12c7671f7ffa6099fc5e7b307fe312f7cfb1"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0MjE0OA==", "bodyText": "fixed", "url": "https://github.com/wildfly/wildfly-core/pull/4082#discussion_r466642148", "createdAt": "2020-08-06T19:37:13Z", "author": {"login": "nekdozjam"}, "path": "elytron/src/main/resources/schema/wildfly-elytron_11_0.xsd", "diffHunk": "@@ -1164,6 +1165,33 @@\n         </xs:complexContent>\n     </xs:complexType>\n \n+\n+    <xs:complexType name=\"failoverRealmType\">\n+        <xs:annotation>\n+            <xs:documentation>\n+                A realm definition which wraps one realm and delegates to another in case the first is unavailable.\n+            </xs:documentation>\n+        </xs:annotation>\n+        <xs:complexContent>\n+            <xs:extension base=\"realmType\">\n+                <xs:attribute name=\"delegate-realm\" type=\"xs:string\" use=\"required\">\n+                    <xs:annotation>\n+                        <xs:documentation>\n+                            The name of the realm to use as a default.\n+                        </xs:documentation>\n+                    </xs:annotation>\n+                </xs:attribute>\n+                <xs:attribute name=\"failover-realm\" type=\"xs:string\" use=\"required\">\n+                    <xs:annotation>\n+                        <xs:documentation>\n+                            The name of the realm to use in case the default realm is unavailable.\n+                        </xs:documentation>\n+                    </xs:annotation>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNTUxMg=="}, "originalCommit": {"oid": "fb9b12c7671f7ffa6099fc5e7b307fe312f7cfb1"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3838, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}