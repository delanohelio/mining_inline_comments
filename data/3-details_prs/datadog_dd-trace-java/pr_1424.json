{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyMjg4MzA5", "number": 1424, "title": "[Breaking change for dd-trace-api] Deprecate scope finishOnClose and continuation close", "bodyText": "Note: These deprecated methods will be removed in the following release.\nThe finishOnClose functionality will remain in the OpenTracing compatibility layer, but behavior may change if utilizing on continuations.\nMigrating usage can impact the way span duration is calculated. For example given the following code:\n@Trace\ndef someMethod() {\n  executor.execute {\n    // Assume this executes after someMethod() already returned.\n    httpClient.request(url)\n  }\n}\nHistorically, the Java Tracer prevented the top level span from finishing until the child work finished, resulting in a trace like this:\n[-------------- someMethod --------------------]\n                       [---clientRequest-----]\n\nAfter this change, it will produce a trace more like this, which more accurately depicts the duration of the method execution.\n[---someMethod---]   (likely even shorter)\n                       [----clientRequest---]\n\nSince trace duration is based on the parent/top level span, this change can impact the trace duration calculation.", "createdAt": "2020-05-01T20:28:18Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1424", "merged": true, "mergeCommit": {"oid": "4d2d55f179a3d6fb57e639b9cea22c522b471c19"}, "closed": true, "closedAt": "2020-05-05T20:02:03Z", "author": {"login": "tylerbenson"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdIPYyABqjMyOTQ0NzA0MTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceYgVbgFqTQwNjA1NDgyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5dd5be772fc23c58a7eba0c7c075e268d3651f31", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5dd5be772fc23c58a7eba0c7c075e268d3651f31", "committedDate": "2020-05-01T20:27:52Z", "message": "[Breaking change] Deprecate scope finishOnClose and continuation close\n\nThese deprecated methods will be removed in the following release."}, "afterCommit": {"oid": "32c5add892f9466ee77f001776768d29be6ed19e", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/32c5add892f9466ee77f001776768d29be6ed19e", "committedDate": "2020-05-01T21:05:44Z", "message": "Update the easy cases..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32c5add892f9466ee77f001776768d29be6ed19e", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/32c5add892f9466ee77f001776768d29be6ed19e", "committedDate": "2020-05-01T21:05:44Z", "message": "Update the easy cases..."}, "afterCommit": {"oid": "b823c7273ebe8b8ed9c4567796ef584ce2413de7", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b823c7273ebe8b8ed9c4567796ef584ce2413de7", "committedDate": "2020-05-01T21:17:42Z", "message": "Update the easy cases..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c4958fbffd6ea1f6054dea6ccf583987b769464a", "committedDate": "2020-05-04T17:35:56Z", "message": "[Breaking change] Deprecate scope finishOnClose and continuation close\n\nThese deprecated methods will be removed in the following release."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b823c7273ebe8b8ed9c4567796ef584ce2413de7", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b823c7273ebe8b8ed9c4567796ef584ce2413de7", "committedDate": "2020-05-01T21:17:42Z", "message": "Update the easy cases..."}, "afterCommit": {"oid": "cf8bea6b90fb8a233cf12de79ad2ece0b43d3945", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cf8bea6b90fb8a233cf12de79ad2ece0b43d3945", "committedDate": "2020-05-04T17:35:56Z", "message": "Remove usage of deprecated methods\n\nFrom internal instrumentation and tests.\n\nStill have problematic usage in Hibernate and Lettuce instrumentation that needs to be fixed."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf8bea6b90fb8a233cf12de79ad2ece0b43d3945", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cf8bea6b90fb8a233cf12de79ad2ece0b43d3945", "committedDate": "2020-05-04T17:35:56Z", "message": "Remove usage of deprecated methods\n\nFrom internal instrumentation and tests.\n\nStill have problematic usage in Hibernate and Lettuce instrumentation that needs to be fixed."}, "afterCommit": {"oid": "dcc17637319f951c18433b033c5e61d2895af75a", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/dcc17637319f951c18433b033c5e61d2895af75a", "committedDate": "2020-05-04T18:54:47Z", "message": "Remove usage of deprecated methods\n\nFrom internal instrumentation and tests.\n\nStill have problematic usage in Hibernate and Lettuce instrumentation that needs to be fixed."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb6b76aec513beefcd94cfc6982d094de1f850cf", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bb6b76aec513beefcd94cfc6982d094de1f850cf", "committedDate": "2020-05-04T22:26:38Z", "message": "Fix span ordering inconsistencies in the tests\n\nAlso add comments for various scope closures."}, "afterCommit": {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c4958fbffd6ea1f6054dea6ccf583987b769464a", "committedDate": "2020-05-04T17:35:56Z", "message": "[Breaking change] Deprecate scope finishOnClose and continuation close\n\nThese deprecated methods will be removed in the following release."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MDEyMzUz", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#pullrequestreview-406012353", "createdAt": "2020-05-05T17:39:22Z", "commit": {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzozOToyMlrOGQ0bog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzozOToyMlrOGQ0bog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4OTQ0Mg==", "bodyText": "Is this code exposed by dd-trace-api to our users?", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#discussion_r420289442", "createdAt": "2020-05-05T17:39:22Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScope.java", "diffHunk": "@@ -183,11 +183,24 @@ public ContinuableScope activate() {\n       }\n     }\n \n+    public void cancel() {\n+      assert !finishOnClose : \"cancel() should not be used with finishOnClose=true\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MDQzNzQz", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#pullrequestreview-406043743", "createdAt": "2020-05-05T18:21:25Z", "commit": {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MDU0ODI3", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#pullrequestreview-406054827", "createdAt": "2020-05-05T18:36:50Z", "commit": {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxODozNjo1MFrOGQ2kCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxODozNjo1MFrOGQ2kCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNDM2MA==", "bodyText": "@devinsba yes... right here.", "url": "https://github.com/DataDog/dd-trace-java/pull/1424#discussion_r420324360", "createdAt": "2020-05-05T18:36:50Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-api/src/main/java/datadog/trace/context/TraceScope.java", "diffHunk": "@@ -26,28 +26,40 @@\n    */\n   void setAsyncPropagation(boolean value);\n \n-  /** Used to pass async context between workers. */\n+  /**\n+   * Used to pass async context between workers. Either activate or cancel must be called on each\n+   * continuation instance to allow the trace to be reported.\n+   */\n   interface Continuation {\n+\n     /**\n      * Activate the continuation.\n      *\n      * <p>Should be called on the child thread.\n+     *\n+     * <p>Consider calling this in a try-with-resources initialization block to ensure the returned\n+     * scope is closed properly.\n      */\n     TraceScope activate();\n \n+    /** Allow trace to stop waiting on this continuation for reporting. */\n+    void cancel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4958fbffd6ea1f6054dea6ccf583987b769464a"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2462, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}