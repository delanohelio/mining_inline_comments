{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MTMyNTcx", "number": 1866, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOToyMjoyMVrOEjgHrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOToyNzo1M1rOEjgQ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjYxODcwOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/JmxSystemProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOToyMjoyMVrOHR4viw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMDowMDo1NFrOHR6ULw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxNzUxNQ==", "bodyText": "A nit - would be good to have the specific implementations being final to encourage composition over inheritance (and make the whole API more evolvable by providing fewer potentially moving parts).", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488517515", "createdAt": "2020-09-15T09:22:21Z", "author": {"login": "jbachorik"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/JmxSystemProvider.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package datadog.trace.core.util;\n+\n+import java.lang.management.ManagementFactory;\n+import java.lang.management.RuntimeMXBean;\n+import java.lang.management.ThreadMXBean;\n+\n+/** System provider based on JMX MXbeans */\n+public class JmxSystemProvider implements SystemProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUzNTA0Mw==", "bodyText": "I don't like to prevent any further modifications with final because it's always difficult to foresee any evolutions that we may need in the future. that's also an internal API here not critical.", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488535043", "createdAt": "2020-09-15T09:47:15Z", "author": {"login": "jpbempel"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/JmxSystemProvider.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package datadog.trace.core.util;\n+\n+import java.lang.management.ManagementFactory;\n+import java.lang.management.RuntimeMXBean;\n+import java.lang.management.ThreadMXBean;\n+\n+/** System provider based on JMX MXbeans */\n+public class JmxSystemProvider implements SystemProvider {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxNzUxNQ=="}, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU0MzI3OQ==", "bodyText": "Why would you extend this class to evolve the API? On the contrary, allowing uncontrolled inheritance may make it quite difficult to do the evolution without touching all the child types.", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488543279", "createdAt": "2020-09-15T10:00:54Z", "author": {"login": "jbachorik"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/JmxSystemProvider.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package datadog.trace.core.util;\n+\n+import java.lang.management.ManagementFactory;\n+import java.lang.management.RuntimeMXBean;\n+import java.lang.management.ThreadMXBean;\n+\n+/** System provider based on JMX MXbeans */\n+public class JmxSystemProvider implements SystemProvider {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxNzUxNQ=="}, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjYyMzgyOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOToyMzozMVrOHR4ykg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMToyODoyNFrOHR9Pkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxODI5MA==", "bodyText": "This one should really be final. It is an API entry point and we don't really want its subclasses floating around when we keep on evolving this entry point.", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488518290", "createdAt": "2020-09-15T09:23:31Z", "author": {"login": "jbachorik"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "diffHunk": "@@ -3,47 +3,43 @@\n import datadog.trace.api.Config;\n import lombok.extern.slf4j.Slf4j;\n \n-/**\n- * Thread CPU time accessor.<br>\n- * This class abstracts away the actual method used to get the current thread CPU time.\n- */\n @Slf4j\n-public final class ThreadCpuTimeAccess {\n-  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+public class SystemAccess {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUzNjE0Mg==", "bodyText": "This one is IMHO the less required to be final, there are only static methods. What would be the point to extend it?", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488536142", "createdAt": "2020-09-15T09:49:11Z", "author": {"login": "jpbempel"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "diffHunk": "@@ -3,47 +3,43 @@\n import datadog.trace.api.Config;\n import lombok.extern.slf4j.Slf4j;\n \n-/**\n- * Thread CPU time accessor.<br>\n- * This class abstracts away the actual method used to get the current thread CPU time.\n- */\n @Slf4j\n-public final class ThreadCpuTimeAccess {\n-  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+public class SystemAccess {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxODI5MA=="}, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU0NDIwOA==", "bodyText": "Exactly. What would be the point? Yet, if someone decides to extend it for whatever strange reason you are for a surprise when evolving this class.\nThere is literally no downside to having this class final - it is an entry point to your API and there should never be any subclasses of this class.", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488544208", "createdAt": "2020-09-15T10:02:29Z", "author": {"login": "jbachorik"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "diffHunk": "@@ -3,47 +3,43 @@\n import datadog.trace.api.Config;\n import lombok.extern.slf4j.Slf4j;\n \n-/**\n- * Thread CPU time accessor.<br>\n- * This class abstracts away the actual method used to get the current thread CPU time.\n- */\n @Slf4j\n-public final class ThreadCpuTimeAccess {\n-  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+public class SystemAccess {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxODI5MA=="}, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU3OTI2NA==", "bodyText": "If someone try to extend this class, it will not get what he thinks. it's a dumb mistake. On my side I will not have issue to evolve this class as there is not instance methods so not direct interactions with inherited classes.", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488579264", "createdAt": "2020-09-15T11:06:23Z", "author": {"login": "jpbempel"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "diffHunk": "@@ -3,47 +3,43 @@\n import datadog.trace.api.Config;\n import lombok.extern.slf4j.Slf4j;\n \n-/**\n- * Thread CPU time accessor.<br>\n- * This class abstracts away the actual method used to get the current thread CPU time.\n- */\n @Slf4j\n-public final class ThreadCpuTimeAccess {\n-  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+public class SystemAccess {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxODI5MA=="}, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5MTI1MA==", "bodyText": "Ok. I hear you. It is up to you. I will stop bike-shedding here.", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488591250", "createdAt": "2020-09-15T11:28:24Z", "author": {"login": "jbachorik"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "diffHunk": "@@ -3,47 +3,43 @@\n import datadog.trace.api.Config;\n import lombok.extern.slf4j.Slf4j;\n \n-/**\n- * Thread CPU time accessor.<br>\n- * This class abstracts away the actual method used to get the current thread CPU time.\n- */\n @Slf4j\n-public final class ThreadCpuTimeAccess {\n-  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+public class SystemAccess {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxODI5MA=="}, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjYzMjAyOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOToyNToyMlrOHR43SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOTo1MToxMlrOHR59dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxOTQ5Ng==", "bodyText": "This makes me wonder - do we really need the SystemAccess tied to profiling?\nNot critical request but would be good to think about it.", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488519496", "createdAt": "2020-09-15T09:25:22Z", "author": {"login": "jbachorik"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "diffHunk": "@@ -3,47 +3,43 @@\n import datadog.trace.api.Config;\n import lombok.extern.slf4j.Slf4j;\n \n-/**\n- * Thread CPU time accessor.<br>\n- * This class abstracts away the actual method used to get the current thread CPU time.\n- */\n @Slf4j\n-public final class ThreadCpuTimeAccess {\n-  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+public class SystemAccess {\n+  private static volatile SystemProvider systemProvider = SystemProvider.NONE;\n \n   /**\n-   * Disable JMX based thread CPU time. Will flip back to the {@linkplain\n-   * ThreadCpuTimeProvider#NONE} implementation.\n+   * Disable JMX based thread CPU time. Will flip back to the {@linkplain SystemProvider#NONE}\n+   * implementation.\n    */\n   public static void disableJmx() {\n     log.debug(\"Disabling JMX thread CPU time provider\");\n-    cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+    systemProvider = SystemProvider.NONE;\n   }\n \n-  /** Enable JMX based thread CPU time */\n+  /** Enable JMX accesses */\n   public static void enableJmx() {\n     if (!Config.get().isProfilingEnabled()) {\n-      log.info(\"Will not enable thread CPU time access. Profiling is disabled.\");\n+      log.info(\"Will not enable JMX access. Profiling is disabled.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUzNzQ2Mw==", "bodyText": "I also don't see the need to be tied to profiling, but right now, only profiling is using it.\nThis could test could be removed if we want to expose to a broad scope of the tracer.", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488537463", "createdAt": "2020-09-15T09:51:12Z", "author": {"login": "jpbempel"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemAccess.java", "diffHunk": "@@ -3,47 +3,43 @@\n import datadog.trace.api.Config;\n import lombok.extern.slf4j.Slf4j;\n \n-/**\n- * Thread CPU time accessor.<br>\n- * This class abstracts away the actual method used to get the current thread CPU time.\n- */\n @Slf4j\n-public final class ThreadCpuTimeAccess {\n-  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+public class SystemAccess {\n+  private static volatile SystemProvider systemProvider = SystemProvider.NONE;\n \n   /**\n-   * Disable JMX based thread CPU time. Will flip back to the {@linkplain\n-   * ThreadCpuTimeProvider#NONE} implementation.\n+   * Disable JMX based thread CPU time. Will flip back to the {@linkplain SystemProvider#NONE}\n+   * implementation.\n    */\n   public static void disableJmx() {\n     log.debug(\"Disabling JMX thread CPU time provider\");\n-    cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n+    systemProvider = SystemProvider.NONE;\n   }\n \n-  /** Enable JMX based thread CPU time */\n+  /** Enable JMX accesses */\n   public static void enableJmx() {\n     if (!Config.get().isProfilingEnabled()) {\n-      log.info(\"Will not enable thread CPU time access. Profiling is disabled.\");\n+      log.info(\"Will not enable JMX access. Profiling is disabled.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxOTQ5Ng=="}, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjY0MjM4OnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOToyNzo1M1rOHR49oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOToyNzo1M1rOHR49oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyMTEyMA==", "bodyText": "This provider is providing for SystemAccess - hence SystemAccessProvider would convey the intention better, IMO.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public interface SystemProvider {\n          \n          \n            \n            public interface SystemAccessProvider {", "url": "https://github.com/DataDog/dd-trace-java/pull/1866#discussion_r488521120", "createdAt": "2020-09-15T09:27:53Z", "author": {"login": "jbachorik"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/SystemProvider.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package datadog.trace.core.util;\n+\n+/**\n+ * A pluggable system provider used by {@linkplain SystemAccess}. {@linkplain SystemAccess} may not\n+ * use JMX classes (even via transitive dependencies) due to potential race in j.u.l initialization.\n+ * Therefore it uses an abstract {@linkplain SystemProvider} type to hold the actual implementation\n+ * which may be switched between the {@linkplain SystemProvider#NONE} and {@linkplain\n+ * JmxSystemProvider} on-the-fly once JMX is safe to use.\n+ */\n+public interface SystemProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eefcc044202b708de5812813bfc2d417a2d1bc7"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4807, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}