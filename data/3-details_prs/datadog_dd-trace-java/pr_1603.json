{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NTgwMzAz", "number": 1603, "title": "Cache Strings in DBTypeTagInterceptor", "bodyText": "It may not look like much, but it gets called often enough to account for ~4.5% of all char[] memory during pet-clinic steady state.", "createdAt": "2020-06-18T15:58:00Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1603", "merged": true, "mergeCommit": {"oid": "703f089f75b02588bed95876f63a863db931aff3"}, "closed": true, "closedAt": "2020-06-22T14:47:27Z", "author": {"login": "bantonsson"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsgofGAFqTQzMzQyODg4NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABctx4tjAFqTQzNDk5MDE4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDI4ODg1", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#pullrequestreview-433428885", "createdAt": "2020-06-18T15:59:56Z", "commit": {"oid": "3fd20e4cffadcf300d010996b9d41b6cab5663de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNTo1OTo1NlrOGl1_Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNTo1OTo1NlrOGl1_Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNTAyMw==", "bodyText": "I think a data structure of this complexity needs a different testing strategy - PBT or similar.", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#discussion_r442335023", "createdAt": "2020-06-18T15:59:56Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/util/FixedSizeCacheTest.groovy", "diffHunk": "@@ -0,0 +1,79 @@\n+package datadog.trace.core.util\n+\n+import datadog.trace.util.test.DDSpecification\n+\n+import java.util.concurrent.atomic.AtomicInteger\n+\n+class FixedSizeCacheTest extends DDSpecification {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd20e4cffadcf300d010996b9d41b6cab5663de"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDMzMDM2", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#pullrequestreview-433433036", "createdAt": "2020-06-18T16:04:48Z", "commit": {"oid": "3fd20e4cffadcf300d010996b9d41b6cab5663de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjowNDo0OFrOGl2Llw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjowNDo0OFrOGl2Llw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzODE5OQ==", "bodyText": "Agreed.", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#discussion_r442338199", "createdAt": "2020-06-18T16:04:48Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/util/FixedSizeCache.java", "diffHunk": "@@ -0,0 +1,115 @@\n+package datadog.trace.core.util;\n+\n+/**\n+ * This is a fixed size cache that only has one operation <code>computeIfAbsent</code>, that is used\n+ * to retrieve, or store and compute the cached value.\n+ *\n+ * <p>If there is a hash collision, the cache uses double hashing two more times to try to find a\n+ * match or an unused slot.\n+ *\n+ * <p>The cache is thread safe, and assumes that the <code>Creator</code> passed into <code>\n+ * computeIfAbsent</code> is idempotent or otherwise you might not get back the value you expect\n+ * from a cache lookup.\n+ *\n+ * @param <K> key type\n+ * @param <V> value type\n+ */\n+public class FixedSizeCache<K, V> {\n+\n+  public interface Creator<K, V> {\n+    V create(K key);\n+  }\n+\n+  static final int MAXIMUM_CAPACITY = 1 << 30;\n+\n+  private static final class Node<K, V> {\n+    private final K key;\n+    private final V value;\n+\n+    private Node(K key, V value) {\n+      this.key = key;\n+      this.value = value;\n+    }\n+  }\n+\n+  private final int mask;\n+  // This is a cache, so there is no need for volatile, atomics or synchronized.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd20e4cffadcf300d010996b9d41b6cab5663de"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fd20e4cffadcf300d010996b9d41b6cab5663de", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3fd20e4cffadcf300d010996b9d41b6cab5663de", "committedDate": "2020-06-18T15:53:36Z", "message": "Cache Strings in DBTypeTagInterceptor"}, "afterCommit": {"oid": "72d1275bc003a0a5ca75447e66222c25f7dd8cdd", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/72d1275bc003a0a5ca75447e66222c25f7dd8cdd", "committedDate": "2020-06-22T10:45:41Z", "message": "Cache Strings in DBTypeTagInterceptor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72d1275bc003a0a5ca75447e66222c25f7dd8cdd", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/72d1275bc003a0a5ca75447e66222c25f7dd8cdd", "committedDate": "2020-06-22T10:45:41Z", "message": "Cache Strings in DBTypeTagInterceptor"}, "afterCommit": {"oid": "150898683d8e4fe1b4249ffd85cdfb469fbb61ff", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/150898683d8e4fe1b4249ffd85cdfb469fbb61ff", "committedDate": "2020-06-22T11:00:17Z", "message": "Cache Strings in DBTypeTagInterceptor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96f4007acdd4042cde6043f81c8ba7eb257705b2", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/96f4007acdd4042cde6043f81c8ba7eb257705b2", "committedDate": "2020-06-22T11:23:13Z", "message": "Create a FixedSizeCache that uses double hashing on collisions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d56c563db0218d10743644aba53f2326df5a9acb", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d56c563db0218d10743644aba53f2326df5a9acb", "committedDate": "2020-06-22T11:23:23Z", "message": "Cache Strings in DBTypeTagInterceptor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "150898683d8e4fe1b4249ffd85cdfb469fbb61ff", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/150898683d8e4fe1b4249ffd85cdfb469fbb61ff", "committedDate": "2020-06-22T11:00:17Z", "message": "Cache Strings in DBTypeTagInterceptor"}, "afterCommit": {"oid": "d56c563db0218d10743644aba53f2326df5a9acb", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d56c563db0218d10743644aba53f2326df5a9acb", "committedDate": "2020-06-22T11:23:23Z", "message": "Cache Strings in DBTypeTagInterceptor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0OTY5MTUy", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#pullrequestreview-434969152", "createdAt": "2020-06-22T14:19:10Z", "commit": {"oid": "d56c563db0218d10743644aba53f2326df5a9acb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0OTkwMTgz", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#pullrequestreview-434990183", "createdAt": "2020-06-22T14:39:58Z", "commit": {"oid": "d56c563db0218d10743644aba53f2326df5a9acb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2188, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}