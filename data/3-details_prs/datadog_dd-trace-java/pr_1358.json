{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNTUzMjY2", "number": 1358, "title": "PROF-1037: Capture thread CPU time elapsed in scope", "bodyText": "Add thread CPU time elapsed while the scope was active to the Scope event.\nThread CPU time is comparatively cheap to obtain (~300ns per inocation) so we should be able to enhance the Scope event with the amount of CPU time spent in each recorded scope.", "createdAt": "2020-04-09T17:30:31Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1358", "merged": true, "mergeCommit": {"oid": "185ad185dec35848b22053bb670faf6dd467ab8d"}, "closed": true, "closedAt": "2020-04-17T16:14:55Z", "author": {"login": "jbachorik"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV_xOugH2gAyNDAxNTUzMjY2OjRkMGQzNmUyOWViZDA2M2I2OTM4YjhhZTQxYjAyNWY3YTgyZjlkYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYjvP6gFqTM5NTU5Mjc1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d0d36e29ebd063b6938b8ae41b025f7a82f9da8", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4d0d36e29ebd063b6938b8ae41b025f7a82f9da8", "committedDate": "2020-04-09T17:16:17Z", "message": "Initial implementation of thread cpu time per scope"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDAxNDY0", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-391001464", "createdAt": "2020-04-09T17:43:47Z", "commit": {"oid": "4d0d36e29ebd063b6938b8ae41b025f7a82f9da8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzo0Mzo0N1rOGDi4_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzo0Mzo0N1rOGDi4_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3MDU1Ng==", "bodyText": "nit this should either be before end, or startCpuTime should be before begin", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r406370556", "createdAt": "2020-04-09T17:43:47Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/jfr-openjdk/src/main/java/datadog/opentracing/jfr/openjdk/ScopeEvent.java", "diffHunk": "@@ -46,12 +53,16 @@\n   public void start() {\n     if (isEnabled()) {\n       begin();\n+      startCpuTime = ThreadCpuTime.get();\n     }\n   }\n \n   @Override\n   public void finish() {\n     end();\n+    if (startCpuTime > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d0d36e29ebd063b6938b8ae41b025f7a82f9da8"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bd8d1499b048f8e5dc9b34068e261406f670f9f", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9bd8d1499b048f8e5dc9b34068e261406f670f9f", "committedDate": "2020-04-09T18:55:21Z", "message": "Play nicely also with JVMs eagerly resolving constant pool symbols"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9dad48a893bb758e9f6feb8535d76e42aa35611", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c9dad48a893bb758e9f6feb8535d76e42aa35611", "committedDate": "2020-04-14T12:16:50Z", "message": "Do not include the time spent in handling ThreadCpuTime in event duration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1511296fec73d5d367dcd6ad0ea13af25e63db90", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1511296fec73d5d367dcd6ad0ea13af25e63db90", "committedDate": "2020-04-14T12:45:44Z", "message": "Do not use extra field in event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7597450f8a740d1da45b6806fd365530ae23e951", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7597450f8a740d1da45b6806fd365530ae23e951", "committedDate": "2020-04-14T13:39:41Z", "message": "Fix formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "551e3319817ce8e7e5a2ffdf8de26bfe14a89ec6", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/551e3319817ce8e7e5a2ffdf8de26bfe14a89ec6", "committedDate": "2020-04-15T16:35:38Z", "message": "Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d283b3ed7e748caad9f1346b9426f61c49608d90", "committedDate": "2020-04-15T16:36:09Z", "message": "Capture thread CPU time diff only when the event is about to commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDQ2MTk5", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-394046199", "createdAt": "2020-04-15T18:52:42Z", "commit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDcwMDI4", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-394070028", "createdAt": "2020-04-15T19:26:31Z", "commit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOToyNjozMVrOGGIVqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOToyNjozMVrOGGIVqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4MTI1Ng==", "bodyText": "My impression is that scopes are locked to given thread - is there any point in this being volatile?", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r409081256", "createdAt": "2020-04-15T19:26:31Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/jfr-openjdk/src/main/java/datadog/opentracing/jfr/openjdk/ScopeEvent.java", "diffHunk": "@@ -38,13 +39,18 @@\n   @Label(\"Operation Name\")\n   private String operationName;\n \n+  @Label(\"Thread CPU Time\")\n+  @Timespan\n+  private volatile long cpuTime = 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDcyNjYw", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-394072660", "createdAt": "2020-04-15T19:30:24Z", "commit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTozMDoyNVrOGGId_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTozMDoyNVrOGGId_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4MzM4OA==", "bodyText": "Please move this code into separate package/class like we have for jmx, profiling and the agent - or maybe reuse something existing.\nIn fact maybe this whole thing can go into initialize method.\nThis class is already way overloaded and no need for odd jmx interactions here", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r409083388", "createdAt": "2020-04-15T19:30:25Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -262,6 +265,36 @@ private static synchronized void installDatadogTracer() {\n     }\n   }\n \n+  private static synchronized void initializeScopeThreadCpuTime() {\n+    if (AGENT_CLASSLOADER == null) {\n+      throw new IllegalStateException(\"Datadog agent should have been started already\");\n+    }\n+    try {\n+      final Class<?> threadCpuTimeClass =\n+          AGENT_CLASSLOADER.loadClass(\"datadog.trace.agent.ot.jfr.openjdk.ThreadCpuTime\");\n+      final Method initializeMethod =\n+          threadCpuTimeClass.getDeclaredMethod(\"initialize\", Callable.class);\n+      final ThreadMXBean mxBean = ManagementFactory.getThreadMXBean();\n+      initializeMethod.setAccessible(true);\n+      initializeMethod.invoke(\n+          null,\n+          new Callable<Long>() {\n+            @Override\n+            public Long call() throws Exception {\n+              return mxBean.getCurrentThreadCpuTime();\n+            }\n+          });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDczMzgw", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-394073380", "createdAt": "2020-04-15T19:31:29Z", "commit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTozMToyOVrOGGIgJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTozMTo1MlrOGGIg-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4Mzk0MA==", "bodyText": "Please add tests for this, especially considering that we already have ScopeEventTest", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r409083940", "createdAt": "2020-04-15T19:31:29Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/jfr-openjdk/src/main/java/datadog/opentracing/jfr/openjdk/ScopeEvent.java", "diffHunk": "@@ -53,6 +59,9 @@ public void start() {\n   public void finish() {\n     end();\n     if (shouldCommit()) {\n+      if (cpuTime > 0) {\n+        cpuTime = ThreadCpuTime.get() - cpuTime;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4NDE1Mw==", "bodyText": "This class should be unit-tested", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r409084153", "createdAt": "2020-04-15T19:31:52Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/jfr-openjdk/src/main/java/datadog/opentracing/jfr/openjdk/ThreadCpuTime.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package datadog.opentracing.jfr.openjdk;\n+\n+import java.util.concurrent.Callable;\n+\n+public class ThreadCpuTime {\n+  private static volatile Callable<Long> CPU_TIME_PROVIDER =\n+      new Callable<Long>() {\n+        @Override\n+        public Long call() throws Exception {\n+          return Long.MIN_VALUE;\n+        }\n+      };\n+\n+  // must use Callable here since initialization is invoked from Agent which needs to be Java 7\n+  // compatible\n+  static void initialize(Callable<Long> provider) {\n+    CPU_TIME_PROVIDER = provider;\n+  }\n+\n+  static long get() {\n+    try {\n+      return CPU_TIME_PROVIDER.call();\n+    } catch (Exception ignored) {\n+    }\n+    return Long.MIN_VALUE;\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDc1NjA1", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-394075605", "createdAt": "2020-04-15T19:34:52Z", "commit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTozNDo1MlrOGGInUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTozNDo1MlrOGGInUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4NTc3Ng==", "bodyText": "nit: I think convention is to use ALL_CAPS only for constants.", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r409085776", "createdAt": "2020-04-15T19:34:52Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/jfr-openjdk/src/main/java/datadog/opentracing/jfr/openjdk/ThreadCpuTime.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package datadog.opentracing.jfr.openjdk;\n+\n+import java.util.concurrent.Callable;\n+\n+public class ThreadCpuTime {\n+  private static volatile Callable<Long> CPU_TIME_PROVIDER =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDgxMzg2", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-394081386", "createdAt": "2020-04-15T19:43:51Z", "commit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo0Mzo1MVrOGGI6DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo0Mzo1MVrOGGI6DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MDU3Mw==", "bodyText": "The whole datadog.trace.agent.ot.jfr.openjdk is compiled for java8 - so this will throw some form of ClassFormatError on java7 - please consider catching it separately like we do for profiling startup to provide more specific error message.\nAlternatively you could move whole datadog.trace.agent.ot.jfr.openjdk.ThreadCpuTime into java7 compatible module since it in of itself doesn't need java8.", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r409090573", "createdAt": "2020-04-15T19:43:51Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -262,6 +265,36 @@ private static synchronized void installDatadogTracer() {\n     }\n   }\n \n+  private static synchronized void initializeScopeThreadCpuTime() {\n+    if (AGENT_CLASSLOADER == null) {\n+      throw new IllegalStateException(\"Datadog agent should have been started already\");\n+    }\n+    try {\n+      final Class<?> threadCpuTimeClass =\n+          AGENT_CLASSLOADER.loadClass(\"datadog.trace.agent.ot.jfr.openjdk.ThreadCpuTime\");\n+      final Method initializeMethod =\n+          threadCpuTimeClass.getDeclaredMethod(\"initialize\", Callable.class);\n+      final ThreadMXBean mxBean = ManagementFactory.getThreadMXBean();\n+      initializeMethod.setAccessible(true);\n+      initializeMethod.invoke(\n+          null,\n+          new Callable<Long>() {\n+            @Override\n+            public Long call() throws Exception {\n+              return mxBean.getCurrentThreadCpuTime();\n+            }\n+          });\n+      log.debug(\"Thread CPU time provider enabled\");\n+    } catch (final Throwable ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d579738a7704af951a9305649ba025870029dea6", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d579738a7704af951a9305649ba025870029dea6", "committedDate": "2020-04-16T08:30:27Z", "message": "cpuTime field does not need to be volatile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91a4146ab6fea04cd8b34608a5506d2be515d85b", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/91a4146ab6fea04cd8b34608a5506d2be515d85b", "committedDate": "2020-04-16T08:36:24Z", "message": "Improve test coverage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f59cf0e53bf5358eed041da53abe4e39db15cf4c", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f59cf0e53bf5358eed041da53abe4e39db15cf4c", "committedDate": "2020-04-16T09:02:25Z", "message": "Move ThreadCpuTime to Java 7 only location"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTYwNzk3", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-394560797", "createdAt": "2020-04-16T11:59:30Z", "commit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMTo1OTozMFrOGGh2wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMTo1OTozMFrOGGh2wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5OTMzMA==", "bodyText": "If we are not expecting something happening here all the time maybe we should consider logging it on debug level?", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r409499330", "createdAt": "2020-04-16T11:59:30Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/jfr-openjdk/src/main/java/datadog/opentracing/jfr/openjdk/ThreadCpuTime.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package datadog.opentracing.jfr.openjdk;\n+\n+import java.util.concurrent.Callable;\n+\n+public class ThreadCpuTime {\n+  private static volatile Callable<Long> CPU_TIME_PROVIDER =\n+      new Callable<Long>() {\n+        @Override\n+        public Long call() throws Exception {\n+          return Long.MIN_VALUE;\n+        }\n+      };\n+\n+  // must use Callable here since initialization is invoked from Agent which needs to be Java 7\n+  // compatible\n+  static void initialize(Callable<Long> provider) {\n+    CPU_TIME_PROVIDER = provider;\n+  }\n+\n+  static long get() {\n+    try {\n+      return CPU_TIME_PROVIDER.call();\n+    } catch (Exception ignored) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d283b3ed7e748caad9f1346b9426f61c49608d90"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1350c25e23b81f32138a23ad9f2c78c6570934a", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e1350c25e23b81f32138a23ad9f2c78c6570934a", "committedDate": "2020-04-16T14:32:21Z", "message": "Modify the mode of the CPU time provider initialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e41bafc32c7f6774db434e176dfc7d43d1d45ffa", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e41bafc32c7f6774db434e176dfc7d43d1d45ffa", "committedDate": "2020-04-16T14:52:52Z", "message": "Do not initialize the thread if profiling is not enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e43088e5bd10adf737873bd1d64252296a0c6f87", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e43088e5bd10adf737873bd1d64252296a0c6f87", "committedDate": "2020-04-16T14:58:07Z", "message": "Make the cpu time assertion more lenient - some events might not have cpu time at all"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzcwMzM0", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-394770334", "createdAt": "2020-04-16T15:50:44Z", "commit": {"oid": "e43088e5bd10adf737873bd1d64252296a0c6f87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo1MDo0NFrOGGr7Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo1MDo0NFrOGGr7Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY2NDI5NA==", "bodyText": "any chance to have something like a sum here and then making sure that it is greater than zero (at least)?", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r409664294", "createdAt": "2020-04-16T15:50:44Z", "author": {"login": "mar-kolya"}, "path": "dd-smoke-tests/profiling-integration-tests/src/test/groovy/datadog/smoketest/ProfilingIntegrationContinuousProfilesTest.groovy", "diffHunk": "@@ -101,6 +104,30 @@ class ProfilingIntegrationContinuousProfilesTest extends AbstractSmokeTest {\n     IItemCollection scopeEvents = events.apply(ItemFilters.type(\"datadog.Scope\"))\n \n     scopeEvents.size() > 0\n+    // only one event type in filtered collection - can just grab the first item from iterator\n+    def scopeEventIterable = scopeEvents.iterator().next()\n+    def attribute = findCpuTimeAttribute(scopeEventIterable.type)\n+    attribute != null\n+\n+    def accessor = scopeEventIterable.type.getAccessor(attribute)\n+    def hasCpuTime = false\n+    scopeEventIterable.every {\n+      scopeEvent ->\n+      hasCpuTime = hasCpuTime || accessor.getMember(scopeEvent).toLong()\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e43088e5bd10adf737873bd1d64252296a0c6f87"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a992b167d053c565066d79a13be176b2c2e1795f", "committedDate": "2020-04-16T17:23:39Z", "message": "Allow more predictable cpu time check in the integration test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Mzg2MjM0", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-395386234", "createdAt": "2020-04-17T11:49:11Z", "commit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMTo0OToxMVrOGHK3LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMTo0OToxMVrOGHK3LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE3MTE4MQ==", "bodyText": "We do not use Config here - and IIRC there are awkward implications for doing that. Could you please move this check into datadog.trace.common.util.ThreadCpuTimeAccess#enableJmx?", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r410171181", "createdAt": "2020-04-17T11:49:11Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -262,6 +263,33 @@ private static synchronized void installDatadogTracer() {\n     }\n   }\n \n+  private static synchronized void startJmx(final URL bootstrapURL) {\n+    startJmxFetch(bootstrapURL);\n+    /*\n+     * Initialize the thread cpu time provider only if profiling is enabled.\n+     * ATTENTION! If ever is the thread cpu time provider used outside of profiler this check should be revisited.\n+     */\n+    if (Config.get().isProfilingEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NDAyNjE1", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-395402615", "createdAt": "2020-04-17T12:17:30Z", "commit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoxNzozMFrOGHLodg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoxNzozMFrOGHLodg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4Mzc5OA==", "bodyText": "Would def accessor = Attribute.attr(\"cpuTime\", UnitLookup.TIMESPAN).getAccessor(scopeEventIterable.type) work instead of this?", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r410183798", "createdAt": "2020-04-17T12:17:30Z", "author": {"login": "mar-kolya"}, "path": "dd-smoke-tests/profiling-integration-tests/src/test/groovy/datadog/smoketest/ProfilingIntegrationContinuousProfilesTest.groovy", "diffHunk": "@@ -101,6 +104,29 @@ class ProfilingIntegrationContinuousProfilesTest extends AbstractSmokeTest {\n     IItemCollection scopeEvents = events.apply(ItemFilters.type(\"datadog.Scope\"))\n \n     scopeEvents.size() > 0\n+    // only one event type in filtered collection - can just grab the first item from iterator\n+    def scopeEventIterable = scopeEvents.iterator().next()\n+    def attribute = findCpuTimeAttribute(scopeEventIterable.type)\n+    attribute != null\n+\n+    def accessor = scopeEventIterable.type.getAccessor(attribute)\n+    scopeEventIterable.every {\n+      scopeEvent ->\n+      def cpuTime = accessor.getMember(scopeEvent).toLong()\n+      // cpu time is either not provided or must be >=100ms\n+      cpuTime == Long.MIN_VALUE || cpuTime >= 100_000_000L\n+    }\n+  }\n+\n+  private static Attribute<?> findCpuTimeAttribute(IType<IItem> type) {\n+    def attribute = null\n+    type.accessorKeys.forEach {\n+      k, v ->\n+        if (k.identifier == \"cpuTime\") {\n+          attribute = k\n+        }\n+    }\n+    return attribute", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NDE3MTk4", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-395417198", "createdAt": "2020-04-17T12:40:13Z", "commit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjo0MDoxM1rOGHMT7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjo0MDoxM1rOGHMT7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5NDkyNA==", "bodyText": "Nit: you do not really need instance there, instead you can call constructor here", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r410194924", "createdAt": "2020-04-17T12:40:13Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/src/main/java/datadog/trace/common/util/ThreadCpuTimeAccess.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package datadog.trace.common.util;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * Thread CPU time accessor.<br>\n+ * This class abstracts away the actual method used to get the current thread CPU time.\n+ */\n+@Slf4j\n+public final class ThreadCpuTimeAccess {\n+  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.DEFAULT;\n+\n+  /**\n+   * Disable JMX based thread CPU time. Will flip back to the {@linkplain\n+   * ThreadCpuTimeProvider#DEFAULT} implementation.\n+   */\n+  public static void disableJmx() {\n+    log.debug(\"Disabling JMX thread CPU time provider\");\n+    cpuTimeProvider = ThreadCpuTimeProvider.DEFAULT;\n+  }\n+\n+  /** Enable JMX based thread CPU time */\n+  public static void enableJmx() {\n+    try {\n+      log.debug(\"Enabling JMX thread CPU time provider\");\n+      /*\n+       * Can not use direct class reference to JmxThreadCpuTimeProvider since on some rare JVM implementations\n+       * using eager class resolution that class could be resolved at the moment when ThreadCpuTime is being loaded,\n+       * potentially triggering j.u.l initialization which is potentially dangerous and can be done only at certain\n+       * point in time.\n+       * Using reflection should alleviate this problem - no class constant to resolve during class load. The JMX\n+       * thread cpu time provider will be loaded at exact moment when the reflection code is executed. Then it is up\n+       * to the caller to ensure that it is safe to use JMX.\n+       */\n+      cpuTimeProvider =\n+          (ThreadCpuTimeProvider)\n+              Class.forName(\"datadog.trace.common.util.JmxThreadCpuTimeProvider\")\n+                  .getField(\"INSTANCE\")\n+                  .get(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NDE4MjEx", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-395418211", "createdAt": "2020-04-17T12:41:37Z", "commit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjo0MTozOFrOGHMW6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjo0MTozOFrOGHMW6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5NTY4OA==", "bodyText": "You are creating instance of an abstract class: I think it is not so abstract then... I think this abstract can be dropped.", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r410195688", "createdAt": "2020-04-17T12:41:38Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/src/main/java/datadog/trace/common/util/ThreadCpuTimeProvider.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package datadog.trace.common.util;\n+\n+/**\n+ * A pluggable thread CPU time provider used by {@linkplain ThreadCpuTimeAccess}. {@linkplain\n+ * ThreadCpuTimeAccess} may not use JMX classes (even via transitive dependencies) due to potential\n+ * race in j.u.l initialization. Therefore it uses an abstract {@linkplain ThreadCpuTimeProvider}\n+ * type to hold the actual implementation which may be switched between the {@linkplain\n+ * ThreadCpuTimeProvider#DEFAULT} and {@linkplain JmxThreadCpuTimeProvider} on-the-fly once JMX is\n+ * safe to use.\n+ */\n+abstract class ThreadCpuTimeProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a992b167d053c565066d79a13be176b2c2e1795f"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17c01c64b76a644bb9c41fdb6f9b08bacf986362", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/17c01c64b76a644bb9c41fdb6f9b08bacf986362", "committedDate": "2020-04-17T14:02:32Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTA0Mjg3", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-395504287", "createdAt": "2020-04-17T14:29:03Z", "commit": {"oid": "17c01c64b76a644bb9c41fdb6f9b08bacf986362"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDoyOTowM1rOGHQVbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDoyOTowM1rOGHQVbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2MDg0NA==", "bodyText": "Let's do this on debug level, please - this seems irrelevant for clients that have profiling disabled.", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r410260844", "createdAt": "2020-04-17T14:29:03Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-ot/src/main/java/datadog/trace/common/util/ThreadCpuTimeAccess.java", "diffHunk": "@@ -8,19 +9,23 @@\n  */\n @Slf4j\n public final class ThreadCpuTimeAccess {\n-  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.DEFAULT;\n+  private static volatile ThreadCpuTimeProvider cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n \n   /**\n    * Disable JMX based thread CPU time. Will flip back to the {@linkplain\n-   * ThreadCpuTimeProvider#DEFAULT} implementation.\n+   * ThreadCpuTimeProvider#NONE} implementation.\n    */\n   public static void disableJmx() {\n     log.debug(\"Disabling JMX thread CPU time provider\");\n-    cpuTimeProvider = ThreadCpuTimeProvider.DEFAULT;\n+    cpuTimeProvider = ThreadCpuTimeProvider.NONE;\n   }\n \n   /** Enable JMX based thread CPU time */\n   public static void enableJmx() {\n+    if (!Config.get().isProfilingEnabled()) {\n+      log.info(\"Will not enable thread CPU time access. Profiling is disabled.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17c01c64b76a644bb9c41fdb6f9b08bacf986362"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25155204fa5fddbeac5d1d60c7d59a4f2cfadedf", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/25155204fa5fddbeac5d1d60c7d59a4f2cfadedf", "committedDate": "2020-04-17T15:01:15Z", "message": "Change log level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac70cad2041d8e545302e1b242165801ee625ed1", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ac70cad2041d8e545302e1b242165801ee625ed1", "committedDate": "2020-04-17T15:01:35Z", "message": "Simplification in the integration smoke test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTM4NTEy", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-395538512", "createdAt": "2020-04-17T15:09:16Z", "commit": {"oid": "ac70cad2041d8e545302e1b242165801ee625ed1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea821f0e763db75c72907fd00ba3f54e2399cb2d", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ea821f0e763db75c72907fd00ba3f54e2399cb2d", "committedDate": "2020-04-17T15:54:15Z", "message": "Fix failing tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTgwOTQx", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-395580941", "createdAt": "2020-04-17T16:01:46Z", "commit": {"oid": "ea821f0e763db75c72907fd00ba3f54e2399cb2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTkyNzU0", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#pullrequestreview-395592754", "createdAt": "2020-04-17T16:17:36Z", "commit": {"oid": "ea821f0e763db75c72907fd00ba3f54e2399cb2d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjoxNzozNlrOGHUdwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjoxNzozNlrOGHUdwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyODUxNA==", "bodyText": "Any risk of finish() being called more than once?", "url": "https://github.com/DataDog/dd-trace-java/pull/1358#discussion_r410328514", "createdAt": "2020-04-17T16:17:36Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/jfr-openjdk/src/main/java/datadog/opentracing/jfr/openjdk/ScopeEvent.java", "diffHunk": "@@ -53,6 +61,9 @@ public void start() {\n   public void finish() {\n     end();\n     if (shouldCommit()) {\n+      if (cpuTime > 0) {\n+        cpuTime = ThreadCpuTimeAccess.getCurrentThreadCpuTime() - cpuTime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea821f0e763db75c72907fd00ba3f54e2399cb2d"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2636, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}