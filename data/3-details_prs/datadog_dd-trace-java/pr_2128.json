{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NjUxMjE5", "number": 2128, "title": "Delay starting metric aggregation, reduce DDSketch relative accuracy, pick up changes from sketches-java 0.5.0", "bodyText": "This makes a few changes\n\nAdd a random delay to starting metrics, to stop applications starting at the same time synchronising.\nUpdate the DDSketch library, which now has a more memory efficient storage implementation, and a method to clear sketches, so they don't need to be reallocated\nReduce the relative accuracy of the sketch - we are recording latencies accurate to at best microseconds in nanosecond units", "createdAt": "2020-11-27T14:43:19Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2128", "merged": true, "mergeCommit": {"oid": "06376256f93890d979e9ed2e9f9ffd7ae5194995"}, "closed": true, "closedAt": "2020-11-30T13:29:53Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgorUmABqjQwNDY0MjA4NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhlSyugFqTU0MDkwMjcyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00aed16de8113a2d729d7747e7159d812d497dd8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/00aed16de8113a2d729d7747e7159d812d497dd8", "committedDate": "2020-11-27T14:42:28Z", "message": "change DDSketch index mapping"}, "afterCommit": {"oid": "2238d836fafe426ce8e3b99ae19354323cb302ba", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2238d836fafe426ce8e3b99ae19354323cb302ba", "committedDate": "2020-11-27T14:46:11Z", "message": "change DDSketch index mapping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2238d836fafe426ce8e3b99ae19354323cb302ba", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2238d836fafe426ce8e3b99ae19354323cb302ba", "committedDate": "2020-11-27T14:46:11Z", "message": "change DDSketch index mapping"}, "afterCommit": {"oid": "96afd93c33e3ccc3ef6b40ebf699c7d1226d70ca", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/96afd93c33e3ccc3ef6b40ebf699c7d1226d70ca", "committedDate": "2020-11-27T14:47:14Z", "message": "change DDSketch index mapping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96afd93c33e3ccc3ef6b40ebf699c7d1226d70ca", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/96afd93c33e3ccc3ef6b40ebf699c7d1226d70ca", "committedDate": "2020-11-27T14:47:14Z", "message": "change DDSketch index mapping"}, "afterCommit": {"oid": "190cad866fa2ec38587058237f02619f2b5d099e", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/190cad866fa2ec38587058237f02619f2b5d099e", "committedDate": "2020-11-27T14:49:36Z", "message": "change DDSketch index mapping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "190cad866fa2ec38587058237f02619f2b5d099e", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/190cad866fa2ec38587058237f02619f2b5d099e", "committedDate": "2020-11-27T14:49:36Z", "message": "change DDSketch index mapping"}, "afterCommit": {"oid": "aac467411531aff8b30111751ae6b1f2bfb77c0c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/aac467411531aff8b30111751ae6b1f2bfb77c0c", "committedDate": "2020-11-27T14:52:08Z", "message": "change DDSketch index mapping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aac467411531aff8b30111751ae6b1f2bfb77c0c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/aac467411531aff8b30111751ae6b1f2bfb77c0c", "committedDate": "2020-11-27T14:52:08Z", "message": "change DDSketch index mapping"}, "afterCommit": {"oid": "7d21de03ad0b2964fd4cae82379f32ad40073d46", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7d21de03ad0b2964fd4cae82379f32ad40073d46", "committedDate": "2020-11-27T15:18:57Z", "message": "change DDSketch index mapping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d21de03ad0b2964fd4cae82379f32ad40073d46", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7d21de03ad0b2964fd4cae82379f32ad40073d46", "committedDate": "2020-11-27T15:18:57Z", "message": "change DDSketch index mapping"}, "afterCommit": {"oid": "08e394b19ab0a0f50016c54d65698d5077de69ac", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/08e394b19ab0a0f50016c54d65698d5077de69ac", "committedDate": "2020-11-27T15:29:10Z", "message": "change DDSketch index mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a247826041762f227e44c7c5f9a31eecdbba13bf", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a247826041762f227e44c7c5f9a31eecdbba13bf", "committedDate": "2020-11-30T10:37:04Z", "message": "mitigate risk of tracers synchronising metrics delivery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "640bba6ba511aecfbb1bd2b50da22a8c2fada093", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/640bba6ba511aecfbb1bd2b50da22a8c2fada093", "committedDate": "2020-11-30T10:46:59Z", "message": "upgrade and change DDSketch storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bc8215605e26d168a6d36c32a94594538c29d1c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2bc8215605e26d168a6d36c32a94594538c29d1c", "committedDate": "2020-11-30T10:52:44Z", "message": "clear sketches instead of reinitialising"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08e394b19ab0a0f50016c54d65698d5077de69ac", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/08e394b19ab0a0f50016c54d65698d5077de69ac", "committedDate": "2020-11-27T15:29:10Z", "message": "change DDSketch index mapping"}, "afterCommit": {"oid": "2bc8215605e26d168a6d36c32a94594538c29d1c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2bc8215605e26d168a6d36c32a94594538c29d1c", "committedDate": "2020-11-30T10:52:44Z", "message": "clear sketches instead of reinitialising"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODE2MTQ5", "url": "https://github.com/DataDog/dd-trace-java/pull/2128#pullrequestreview-540816149", "createdAt": "2020-11-30T11:21:42Z", "commit": {"oid": "2bc8215605e26d168a6d36c32a94594538c29d1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMToyMTo0MlrOH72sSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMToyMTo0MlrOH72sSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUyNDEwNQ==", "bodyText": "I can't stand the Google formatting", "url": "https://github.com/DataDog/dd-trace-java/pull/2128#discussion_r532524105", "createdAt": "2020-11-30T11:21:42Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/CoreTracer.java", "diffHunk": "@@ -244,7 +246,28 @@ private CoreTracer(\n     this.writer.start();\n \n     metricsAggregator = createMetricsAggregator(config);\n-    metricsAggregator.start();\n+    // schedule to start after geometrically distributed number of seconds expressed in\n+    // milliseconds, with p = 0.25, meaning the probability that the aggregator will not\n+    // have started by the nth second is 0.25(0.75)^n-1 (or a 1% chance of not having\n+    // started within 10 seconds, where a cap is applied) This avoids a fleet of traced\n+    // applications starting at the same time and sending metrics in sync\n+    long delayMillis =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bc8215605e26d168a6d36c32a94594538c29d1c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODI0NjU4", "url": "https://github.com/DataDog/dd-trace-java/pull/2128#pullrequestreview-540824658", "createdAt": "2020-11-30T11:34:26Z", "commit": {"oid": "2bc8215605e26d168a6d36c32a94594538c29d1c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMTozNDoyNlrOH73Hsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMTozNDoyNlrOH73Hsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUzMTEyMg==", "bodyText": "\ud83d\udc4d for the comment in the code and \ud83d\udcaf for disliking the auto formatting...", "url": "https://github.com/DataDog/dd-trace-java/pull/2128#discussion_r532531122", "createdAt": "2020-11-30T11:34:26Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/CoreTracer.java", "diffHunk": "@@ -244,7 +246,28 @@ private CoreTracer(\n     this.writer.start();\n \n     metricsAggregator = createMetricsAggregator(config);\n-    metricsAggregator.start();\n+    // schedule to start after geometrically distributed number of seconds expressed in\n+    // milliseconds, with p = 0.25, meaning the probability that the aggregator will not\n+    // have started by the nth second is 0.25(0.75)^n-1 (or a 1% chance of not having\n+    // started within 10 seconds, where a cap is applied) This avoids a fleet of traced\n+    // applications starting at the same time and sending metrics in sync\n+    long delayMillis =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUyNDEwNQ=="}, "originalCommit": {"oid": "2bc8215605e26d168a6d36c32a94594538c29d1c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTAyNzI5", "url": "https://github.com/DataDog/dd-trace-java/pull/2128#pullrequestreview-540902729", "createdAt": "2020-11-30T13:23:45Z", "commit": {"oid": "2bc8215605e26d168a6d36c32a94594538c29d1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2883, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}