{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMTAyODk1", "number": 1845, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNzozMTowMFrOEhiwQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNzozNDozMFrOEhi0og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNjA3ODc0OnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/monitor/Monitor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNzozMTowMFrOHO6UWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoxMjoyOVrOHO7zMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5NzU5Mg==", "bodyText": "So if this is starting to show up, then we should seriously entertain the idea of fixing the statsd client.", "url": "https://github.com/DataDog/dd-trace-java/pull/1845#discussion_r485397592", "createdAt": "2020-09-09T07:31:00Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/monitor/Monitor.java", "diffHunk": "@@ -52,14 +66,14 @@ public Monitor(final StatsDClient statsd) {\n   }\n \n   public void onStart(final int queueCapacity) {\n-    statsd.recordGaugeValue(\"queue.max_length\", queueCapacity);\n+    statsd.recordGaugeValue(\"queue.max_length\", queueCapacity, NO_TAGS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7914f1870daf6e71f472c8fb32d239c3738672b"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyMTg3NA==", "bodyText": "I started doing that yesterday, but I'm coordinating with the team who are doing a big refactoring. So it's going to be a few weeks before we can actually get 0, 1, 2 tag overloads on. I want this as a stopgap for enabling health metrics by default.", "url": "https://github.com/DataDog/dd-trace-java/pull/1845#discussion_r485421874", "createdAt": "2020-09-09T08:12:29Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/monitor/Monitor.java", "diffHunk": "@@ -52,14 +66,14 @@ public Monitor(final StatsDClient statsd) {\n   }\n \n   public void onStart(final int queueCapacity) {\n-    statsd.recordGaugeValue(\"queue.max_length\", queueCapacity);\n+    statsd.recordGaugeValue(\"queue.max_length\", queueCapacity, NO_TAGS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5NzU5Mg=="}, "originalCommit": {"oid": "c7914f1870daf6e71f472c8fb32d239c3738672b"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNjA4MjAwOnYy", "diffSide": "RIGHT", "path": "internal-api/src/test/groovy/datadog/trace/ThreadUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNzozMjowNFrOHO6Wdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoxMjozMlrOHO7zUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5ODEzNA==", "bodyText": "What a wonderful piece of code \ud83d\ude09", "url": "https://github.com/DataDog/dd-trace-java/pull/1845#discussion_r485398134", "createdAt": "2020-09-09T07:32:04Z", "author": {"login": "bantonsson"}, "path": "internal-api/src/test/groovy/datadog/trace/ThreadUtils.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package datadog.trace;\n+\n+import groovy.lang.Closure;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class ThreadUtils {\n+\n+  /**\n+   * Utility to easily run a Closure in parallel, i.e. in spock like this:\n+   *\n+   * <pre>{@code\n+   * def \"some test\"() {\n+   *   expect:\n+   *   runConcurrently(10, 100, {\n+   *     def something = ...\n+   *     def other = ...\n+   *     assert something == other\n+   *   })\n+   * }\n+   * }</pre>\n+   *\n+   * Writing a spock extension was investigated, but it is not possible to run an Invocation\n+   * multiple times concurrently since a lot of the spock internal state and mock scoping is not\n+   * thread safe.\n+   *\n+   * @param concurrency the number of concurrent invocations\n+   * @param totalInvocations the total number of invocations\n+   * @param closure the closure to run\n+   * @return true if everything went well\n+   * @throws Throwable if anything went wrong\n+   */\n+  public static boolean runConcurrently(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9859aba08f333ee6195377d316a1d2280b58d023"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyMTkwNg==", "bodyText": "I tried to import the module but it caused build problems.", "url": "https://github.com/DataDog/dd-trace-java/pull/1845#discussion_r485421906", "createdAt": "2020-09-09T08:12:32Z", "author": {"login": "richardstartin"}, "path": "internal-api/src/test/groovy/datadog/trace/ThreadUtils.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package datadog.trace;\n+\n+import groovy.lang.Closure;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class ThreadUtils {\n+\n+  /**\n+   * Utility to easily run a Closure in parallel, i.e. in spock like this:\n+   *\n+   * <pre>{@code\n+   * def \"some test\"() {\n+   *   expect:\n+   *   runConcurrently(10, 100, {\n+   *     def something = ...\n+   *     def other = ...\n+   *     assert something == other\n+   *   })\n+   * }\n+   * }</pre>\n+   *\n+   * Writing a spock extension was investigated, but it is not possible to run an Invocation\n+   * multiple times concurrently since a lot of the spock internal state and mock scoping is not\n+   * thread safe.\n+   *\n+   * @param concurrency the number of concurrent invocations\n+   * @param totalInvocations the total number of invocations\n+   * @param closure the closure to run\n+   * @return true if everything went well\n+   * @throws Throwable if anything went wrong\n+   */\n+  public static boolean runConcurrently(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5ODEzNA=="}, "originalCommit": {"oid": "9859aba08f333ee6195377d316a1d2280b58d023"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNjA4OTk0OnYy", "diffSide": "LEFT", "path": "internal-api/src/main/java/datadog/trace/api/cache/RadixTreeCache.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNzozNDozMFrOHO6bYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoxNTowMFrOHO75Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5OTM5Mg==", "bodyText": "Why was this assert removed?", "url": "https://github.com/DataDog/dd-trace-java/pull/1845#discussion_r485399392", "createdAt": "2020-09-09T07:34:30Z", "author": {"login": "bantonsson"}, "path": "internal-api/src/main/java/datadog/trace/api/cache/RadixTreeCache.java", "diffHunk": "@@ -33,10 +33,6 @@ public Integer apply(int value) {\n   private final IntFunction<T> mapper;\n \n   public RadixTreeCache(int level1, int level2, IntFunction<T> mapper, int... commonValues) {\n-    assert Integer.bitCount(level1) == 1\n-        && Integer.bitCount(level2) == 1\n-        && level1 > 0\n-        && level2 > 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ade00a3a16da855016efaaab0308be99387539bc"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyMzQyNg==", "bodyText": "Because the test suite never gives the constructor a case which violates the assert, and some of the branches cannot be guaranteed to be covered even with concurrent testing (one branch handles being beaten in a CAS) this actually brings the branch coverage down to a point where the build will fail sometimes. I could give it 3, 5 or -1, 2 just to prove asserts work, or exclude from coverage tracking (which I think would be far, far worse than removing the assert).", "url": "https://github.com/DataDog/dd-trace-java/pull/1845#discussion_r485423426", "createdAt": "2020-09-09T08:15:00Z", "author": {"login": "richardstartin"}, "path": "internal-api/src/main/java/datadog/trace/api/cache/RadixTreeCache.java", "diffHunk": "@@ -33,10 +33,6 @@ public Integer apply(int value) {\n   private final IntFunction<T> mapper;\n \n   public RadixTreeCache(int level1, int level2, IntFunction<T> mapper, int... commonValues) {\n-    assert Integer.bitCount(level1) == 1\n-        && Integer.bitCount(level2) == 1\n-        && level1 > 0\n-        && level2 > 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5OTM5Mg=="}, "originalCommit": {"oid": "ade00a3a16da855016efaaab0308be99387539bc"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4943, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}