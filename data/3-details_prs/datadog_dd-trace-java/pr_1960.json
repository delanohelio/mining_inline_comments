{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NDk4NTc4", "number": 1960, "title": "refactor FieldBackedProvider", "bodyText": "FieldBackedProvider is a very large class and it's very hard to understand what's going on, with ASM mixed in with ByteBuddy, field injection and access mixed in with context store reads, lots of anonymous classes where it's hard to see dependencies, or which state is used where.\nThis is an attempt to break the class down into smaller units of responsibility. This is mostly a mechanical refactor, moving anonymous classes to top level, extracting static helpers where necessary, and limiting the data dependencies between classes, but also aims to separate context store and field accessors from the field backed provider as coherent submodules.", "createdAt": "2020-10-07T20:28:01Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1960", "merged": true, "mergeCommit": {"oid": "765819a793611d5d08fad23600e861ccc7b04c29"}, "closed": true, "closedAt": "2020-10-08T15:53:20Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQTCBtABqjM4NTIzODYwMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQjicDgFqTUwNDkyMTE1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f97c2da960cddbe49f79e206b9897900f71c0f19", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f97c2da960cddbe49f79e206b9897900f71c0f19", "committedDate": "2020-10-07T20:21:22Z", "message": "refactor FieldBackedProvider"}, "afterCommit": {"oid": "a9ef5930ee4af2ddb4f522b18de7241d83c6e681", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a9ef5930ee4af2ddb4f522b18de7241d83c6e681", "committedDate": "2020-10-07T20:30:16Z", "message": "refactor FieldBackedProvider"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9ef5930ee4af2ddb4f522b18de7241d83c6e681", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a9ef5930ee4af2ddb4f522b18de7241d83c6e681", "committedDate": "2020-10-07T20:30:16Z", "message": "refactor FieldBackedProvider"}, "afterCommit": {"oid": "cb1d772c5053e63fc26b15303eb2862b8f22e3e7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cb1d772c5053e63fc26b15303eb2862b8f22e3e7", "committedDate": "2020-10-07T21:09:54Z", "message": "refactor FieldBackedProvider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc01a446939b0c5094662744edb1d47361acbed6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fc01a446939b0c5094662744edb1d47361acbed6", "committedDate": "2020-10-07T21:46:10Z", "message": "refactor FieldBackedProvider"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb1d772c5053e63fc26b15303eb2862b8f22e3e7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cb1d772c5053e63fc26b15303eb2862b8f22e3e7", "committedDate": "2020-10-07T21:09:54Z", "message": "refactor FieldBackedProvider"}, "afterCommit": {"oid": "fc01a446939b0c5094662744edb1d47361acbed6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fc01a446939b0c5094662744edb1d47361acbed6", "committedDate": "2020-10-07T21:46:10Z", "message": "refactor FieldBackedProvider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDgzMTA2", "url": "https://github.com/DataDog/dd-trace-java/pull/1960#pullrequestreview-504483106", "createdAt": "2020-10-08T07:07:25Z", "commit": {"oid": "fc01a446939b0c5094662744edb1d47361acbed6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzowNzoyNlrOHeQsgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzowNzoyNlrOHeQsgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5Mjg2Ng==", "bodyText": "Sneaky...", "url": "https://github.com/DataDog/dd-trace-java/pull/1960#discussion_r501492866", "createdAt": "2020-10-08T07:07:26Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/context/ContextStoreUtils.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package datadog.trace.agent.tooling.context;\n+\n+import static datadog.trace.agent.tooling.ClassLoaderMatcher.BOOTSTRAP_CLASSLOADER;\n+\n+import datadog.trace.agent.tooling.HelperInjector;\n+import datadog.trace.agent.tooling.Utils;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import net.bytebuddy.agent.builder.AgentBuilder;\n+import net.bytebuddy.asm.AsmVisitorWrapper;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.dynamic.DynamicType;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import net.bytebuddy.utility.JavaModule;\n+\n+final class ContextStoreUtils {\n+\n+  static AgentBuilder.Transformer wrapVisitor(final AsmVisitorWrapper visitor) {\n+    return new AgentBuilder.Transformer() {\n+      @Override\n+      public DynamicType.Builder<?> transform(\n+          final DynamicType.Builder<?> builder,\n+          final TypeDescription typeDescription,\n+          final ClassLoader classLoader,\n+          final JavaModule module) {\n+        return builder.visit(visitor);\n+      }\n+    };\n+  }\n+\n+  static Map<String, String> unpackContextStore(\n+      Map<ElementMatcher<ClassLoader>, Map<String, String>> matchedContextStores) {\n+    if (matchedContextStores.isEmpty()) {\n+      return Collections.emptyMap();\n+    } else if (matchedContextStores.size() == 1) {\n+      return matchedContextStores.entrySet().iterator().next().getValue();\n+    } else {\n+      Map<String, String> contextStore = new HashMap<>();\n+      for (Map.Entry<ElementMatcher<ClassLoader>, Map<String, String>> matcherAndStores :\n+          matchedContextStores.entrySet()) {\n+        contextStore.putAll(matcherAndStores.getValue());\n+      }\n+      return contextStore;\n+    }\n+  }\n+\n+  /** Get transformer that forces helper injection onto bootstrap classloader. */\n+  static AgentBuilder.Transformer bootstrapHelperInjector(\n+      final Collection<DynamicType.Unloaded<?>> types) {\n+    // TODO: Better to pass through the context of the Instrumenter\n+    return new AgentBuilder.Transformer() {\n+      // historical quirk - this used to be an anonymous class\n+      // in FieldBackedProvider and was called with getClass().getSimpleName()\n+      // which (unintentionally?) evaluated to an empty string - maintain this\n+      // behaviour", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc01a446939b0c5094662744edb1d47361acbed6"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTc2Mzg0", "url": "https://github.com/DataDog/dd-trace-java/pull/1960#pullrequestreview-504576384", "createdAt": "2020-10-08T09:06:20Z", "commit": {"oid": "fc01a446939b0c5094662744edb1d47361acbed6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTgzNzM4", "url": "https://github.com/DataDog/dd-trace-java/pull/1960#pullrequestreview-504583738", "createdAt": "2020-10-08T09:15:14Z", "commit": {"oid": "fc01a446939b0c5094662744edb1d47361acbed6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0OTIxMTUw", "url": "https://github.com/DataDog/dd-trace-java/pull/1960#pullrequestreview-504921150", "createdAt": "2020-10-08T15:44:19Z", "commit": {"oid": "fc01a446939b0c5094662744edb1d47361acbed6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2939, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}