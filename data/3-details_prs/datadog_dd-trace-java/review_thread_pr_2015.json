{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MDA4OTAz", "number": 2015, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo1MjozMVrOEv7nWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo1MjozMVrOEv7nWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4Njk1MjU2OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo1MjozMVrOHlMhLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwOTo1OTo1NlrOHlkCqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2NDQ2Mg==", "bodyText": "It seems like callbacks could be either Transformation or ManyCallbacks.  Would this still work if multiple callbacks were added to a single promise?", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#discussion_r508764462", "createdAt": "2020-10-20T18:52:31Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -77,6 +80,28 @@ private static void muzzleCheck(final Transformation callback) {\n     }\n   }\n \n+  public static final class Transfer {\n+    @SuppressWarnings(\"rawtypes\")\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static <F, T> void transfer(\n+        @Advice.This Transformation<F, T> task,\n+        @Advice.Argument(0) Object doNotUse,\n+        @Advice.Argument(1) Object callbacks) {\n+      if (callbacks instanceof Transformation && task != callbacks) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAyMzA0NQ==", "bodyText": "Nope, it won't work for multiple callbacks. Or rather I'm not sure what it's supposed to do since this will afaics, take the existing State for the this Transformation and transfer it to the first Transformation that is added to this Transformation. So if you add multiple Transformations only the first one added will get the State. There is a race here as well since adding Transformations can be done concurrently, there is no telling which Transformation actually gets the State.", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#discussion_r509023045", "createdAt": "2020-10-21T06:37:27Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -77,6 +80,28 @@ private static void muzzleCheck(final Transformation callback) {\n     }\n   }\n \n+  public static final class Transfer {\n+    @SuppressWarnings(\"rawtypes\")\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static <F, T> void transfer(\n+        @Advice.This Transformation<F, T> task,\n+        @Advice.Argument(0) Object doNotUse,\n+        @Advice.Argument(1) Object callbacks) {\n+      if (callbacks instanceof Transformation && task != callbacks) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2NDQ2Mg=="}, "originalCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAzNDYxMw==", "bodyText": "I don't think it's actually necessary to set the state in the first Transformation to null, and yes, it was racy.", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#discussion_r509034613", "createdAt": "2020-10-21T07:01:57Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -77,6 +80,28 @@ private static void muzzleCheck(final Transformation callback) {\n     }\n   }\n \n+  public static final class Transfer {\n+    @SuppressWarnings(\"rawtypes\")\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static <F, T> void transfer(\n+        @Advice.This Transformation<F, T> task,\n+        @Advice.Argument(0) Object doNotUse,\n+        @Advice.Argument(1) Object callbacks) {\n+      if (callbacks instanceof Transformation && task != callbacks) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2NDQ2Mg=="}, "originalCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA0NjAwOQ==", "bodyText": "It doesn't need to work with ManyCallbacks - see Promise$Transformation.", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#discussion_r509046009", "createdAt": "2020-10-21T07:23:23Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -77,6 +80,28 @@ private static void muzzleCheck(final Transformation callback) {\n     }\n   }\n \n+  public static final class Transfer {\n+    @SuppressWarnings(\"rawtypes\")\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static <F, T> void transfer(\n+        @Advice.This Transformation<F, T> task,\n+        @Advice.Argument(0) Object doNotUse,\n+        @Advice.Argument(1) Object callbacks) {\n+      if (callbacks instanceof Transformation && task != callbacks) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2NDQ2Mg=="}, "originalCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0OTg2Nw==", "bodyText": "This instrumentation no longer exists", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#discussion_r509149867", "createdAt": "2020-10-21T09:59:56Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -77,6 +80,28 @@ private static void muzzleCheck(final Transformation callback) {\n     }\n   }\n \n+  public static final class Transfer {\n+    @SuppressWarnings(\"rawtypes\")\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static <F, T> void transfer(\n+        @Advice.This Transformation<F, T> task,\n+        @Advice.Argument(0) Object doNotUse,\n+        @Advice.Argument(1) Object callbacks) {\n+      if (callbacks instanceof Transformation && task != callbacks) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2NDQ2Mg=="}, "originalCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4736, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}