{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MzkxNzY3", "number": 1246, "title": "improve hash calculation cache pool", "bodyText": "", "createdAt": "2020-02-21T17:29:45Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1246", "merged": true, "mergeCommit": {"oid": "338f517db21f0017c4d014e589a2e70bd24db164"}, "closed": true, "closedAt": "2020-02-26T15:22:39Z", "author": {"login": "mar-kolya"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGjF_fgH2gAyMzc4MzkxNzY3OjlkNzY4MmY3NzY0ZTExNzZhMGVlNzcwMjE0NzU0ZTAwNTFiNWM1NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIITUUgFqTM2NDk4NTQyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d7682f7764e1176a0ee770214754e0051b5c546", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9d7682f7764e1176a0ee770214754e0051b5c546", "committedDate": "2020-02-21T17:22:51Z", "message": "Fix hashcode calculation in TypeCacheKey\n\nUsing potentially very large number for a mod is probably not very effective"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f736c425ffebef3cd02d25eb702108802120cfcf", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f736c425ffebef3cd02d25eb702108802120cfcf", "committedDate": "2020-02-21T17:23:41Z", "message": "TypeCacheKey are different if hash codes are different\n\nAnd this is very easy to check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4c6d86e6d74c575ed71433d9c955715266e01c6", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d4c6d86e6d74c575ed71433d9c955715266e01c6", "committedDate": "2020-02-21T17:24:09Z", "message": "Do not use zero for hashcode\n\nSeems like this may have odd sideeffects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00c268e6d8acf642f0810f25a3d9e64b7f639543", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/00c268e6d8acf642f0810f25a3d9e64b7f639543", "committedDate": "2020-02-21T17:24:53Z", "message": "Add equivalence check to TypeCacheKey"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODE2MzY2", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#pullrequestreview-362816366", "createdAt": "2020-02-21T18:07:35Z", "commit": {"oid": "00c268e6d8acf642f0810f25a3d9e64b7f639543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODowNzozNVrOFs_00A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODowNzozNVrOFs_00A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcyNzM3Ng==", "bodyText": "Nice -- did these two changes reduce the collision rate?\nMostly just curious", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#discussion_r382727376", "createdAt": "2020-02-21T18:07:35Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/DDCachingPoolStrategy.java", "diffHunk": "@@ -140,7 +140,7 @@ final long approximateSize() {\n       this.loaderRef = loaderRef;\n       this.className = className;\n \n-      hashCode = (int) (31 * this.loaderHash) ^ className.hashCode();\n+      hashCode = 31 * this.loaderHash + className.hashCode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00c268e6d8acf642f0810f25a3d9e64b7f639543"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODE4Mjgy", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#pullrequestreview-362818282", "createdAt": "2020-02-21T18:11:03Z", "commit": {"oid": "00c268e6d8acf642f0810f25a3d9e64b7f639543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoxMTowM1rOFs_61g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoxMTowM1rOFs_61g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcyODkxOA==", "bodyText": "Does this case get exercised?  I believe the outer layer always creates a new TypeCacheKey, so this probably doesn't get exercised much.\nI did try a separate branch where I used ImmutableTypeCacheKeys for put and used a thread local MutableTypeCacheKey for look-up.  That did slightly reduce allocation but the allocation from evicting and then rematerializing still dominated and there was no measurable reduction in GCs or impact on start-up.", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#discussion_r382728918", "createdAt": "2020-02-21T18:11:03Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/DDCachingPoolStrategy.java", "diffHunk": "@@ -150,11 +150,19 @@ public final int hashCode() {\n \n     @Override\n     public boolean equals(final Object obj) {\n-      if (!(obj instanceof TypeCacheKey)) return false;\n+      if (!(obj instanceof TypeCacheKey)) {\n+        return false;\n+      }\n \n-      TypeCacheKey that = (TypeCacheKey) obj;\n+      if (this == obj) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00c268e6d8acf642f0810f25a3d9e64b7f639543"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41db97ea0fb43ef2c2906126b350dc6a54e46b2f", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/41db97ea0fb43ef2c2906126b350dc6a54e46b2f", "committedDate": "2020-02-25T09:18:25Z", "message": "Merge branch 'master' into mar-kolya/improve-hash-calclulation-cache-pool"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b5652d104545a44d781666c4ae07acc0f87f17", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/31b5652d104545a44d781666c4ae07acc0f87f17", "committedDate": "2020-02-25T09:19:47Z", "message": "Remove reference check from TypeCacheKey"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aefcc477cbb8058849e1f8234c77dfe9936964d3", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/aefcc477cbb8058849e1f8234c77dfe9936964d3", "committedDate": "2020-02-25T10:58:18Z", "message": "Simplify TypePoolCacheKey equals\n\nWe have to check string equivalence regardless of classloader state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50793e524485e6a3b48136d3f4f4e852e76236b9", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/50793e524485e6a3b48136d3f4f4e852e76236b9", "committedDate": "2020-02-25T13:32:35Z", "message": "Make sure that same classloaders get same weak ref"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzY5Njkz", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#pullrequestreview-364369693", "createdAt": "2020-02-25T19:01:40Z", "commit": {"oid": "50793e524485e6a3b48136d3f4f4e852e76236b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTowMTo0MVrOFuRWCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTowMTo0MVrOFuRWCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2Mjk4Ng==", "bodyText": "I was mostly assuming that hashCode comparisons had already been done.\nThe idea behind the loaderHash comparison was that it provides a fast exit for some hash collisions.", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#discussion_r384062986", "createdAt": "2020-02-25T19:01:41Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/DDCachingPoolStrategy.java", "diffHunk": "@@ -150,18 +153,23 @@ public final int hashCode() {\n \n     @Override\n     public boolean equals(final Object obj) {\n-      if (!(obj instanceof TypeCacheKey)) return false;\n+      if (!(obj instanceof TypeCacheKey)) {\n+        return false;\n+      }\n \n-      TypeCacheKey that = (TypeCacheKey) obj;\n+      final TypeCacheKey that = (TypeCacheKey) obj;\n \n-      if (loaderHash != that.loaderHash) return false;\n+      if (hashCode != that.hashCode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50793e524485e6a3b48136d3f4f4e852e76236b9"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0Mzc3MTA3", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#pullrequestreview-364377107", "createdAt": "2020-02-25T19:12:55Z", "commit": {"oid": "50793e524485e6a3b48136d3f4f4e852e76236b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOToxMjo1NlrOFuRsyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOToxMjo1NlrOFuRsyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2ODgxMQ==", "bodyText": "Yes, this part is debatable but still quite deliberate.\nThe loaderRef reference equivalence check was placed before the className.equals check because it is faster.\nThe order is reversed for the slow path because I want to avoid calling Reference.get whenever possible.\nThe reason being that concurrency GCs will \"strengthen\" the reference on a get call.\nhttps://github.com/real-logic/agrona/blob/master/agrona/src/main/java/org/agrona/References.java has a nice explanation.", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#discussion_r384068811", "createdAt": "2020-02-25T19:12:56Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/DDCachingPoolStrategy.java", "diffHunk": "@@ -150,18 +153,23 @@ public final int hashCode() {\n \n     @Override\n     public boolean equals(final Object obj) {\n-      if (!(obj instanceof TypeCacheKey)) return false;\n+      if (!(obj instanceof TypeCacheKey)) {\n+        return false;\n+      }\n \n-      TypeCacheKey that = (TypeCacheKey) obj;\n+      final TypeCacheKey that = (TypeCacheKey) obj;\n \n-      if (loaderHash != that.loaderHash) return false;\n+      if (hashCode != that.hashCode) {\n+        return false;\n+      }\n+\n+      if (className.equals(that.className)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50793e524485e6a3b48136d3f4f4e852e76236b9"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82dd2aa1b3970695901e72fb8eed7199179ed882", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/82dd2aa1b3970695901e72fb8eed7199179ed882", "committedDate": "2020-02-25T20:47:42Z", "message": "Revert \"Make sure that same classloaders get same weak ref\"\n\nThis reverts commit 50793e524485e6a3b48136d3f4f4e852e76236b9."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57ba9df39dd856797818e2dc581149bd21ec2e39", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/57ba9df39dd856797818e2dc581149bd21ec2e39", "committedDate": "2020-02-25T17:45:22Z", "message": "Revert \"Simplify TypePoolCacheKey equals\"\n\nThis reverts commit aefcc477cbb8058849e1f8234c77dfe9936964d3."}, "afterCommit": {"oid": "82dd2aa1b3970695901e72fb8eed7199179ed882", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/82dd2aa1b3970695901e72fb8eed7199179ed882", "committedDate": "2020-02-25T20:47:42Z", "message": "Revert \"Make sure that same classloaders get same weak ref\"\n\nThis reverts commit 50793e524485e6a3b48136d3f4f4e852e76236b9."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96f74d0fef36dd689ae4dd745bdf3b3be6a1dc60", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/96f74d0fef36dd689ae4dd745bdf3b3be6a1dc60", "committedDate": "2020-02-25T20:53:12Z", "message": "Compare loader hashes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTg1NDIw", "url": "https://github.com/DataDog/dd-trace-java/pull/1246#pullrequestreview-364985420", "createdAt": "2020-02-26T15:17:50Z", "commit": {"oid": "96f74d0fef36dd689ae4dd745bdf3b3be6a1dc60"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2746, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}