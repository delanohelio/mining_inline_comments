{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MzAzMjAz", "number": 1521, "title": "Update play-2.6 instrumentation to support Play version 2.8.x", "bodyText": "Possible fix for the problem shown in #1138.\nplay.api.libs.TypedKey.underlying was deprecated in 2.7 and removed in 2.8 (playframework/playframework@be442e2#diff-0cdc3904ffe7ccdcc86d04337cf912d9), play.api.libs.TypedKey.asScala was added in Play 26 instead.", "createdAt": "2020-06-02T01:55:00Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1521", "merged": true, "mergeCommit": {"oid": "e1d0b56ba4e159094c6361367a71d55afe06612f"}, "closed": true, "closedAt": "2020-06-05T20:35:51Z", "author": {"login": "keki"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnKs4UAH2gAyNDI2MzAzMjAzOjA1OWFjNGI1NmM4NGRhNjQxZDUyMThkNTk5NjVjYzNjYmEyODE0YTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoYa4QAFqTQyNTU5NTgwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "059ac4b56c84da641d5218d59965cc3cba2814a3", "author": {"user": {"login": "keki", "name": "Bal\u00e1zs K\u00e9ki"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/059ac4b56c84da641d5218d59965cc3cba2814a3", "committedDate": "2020-06-02T01:37:12Z", "message": "Fix Play2.8 instrumentation\n\nplay.api.libs.TypedKey.asScala was added in Play 26. play.api.libs.TypedKey.underlying was deprecated in 2.7 and removed in 2.8."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87814acd1f1cfc966537fccecdc89a84b106ba96", "author": {"user": {"login": "keki", "name": "Bal\u00e1zs K\u00e9ki"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/87814acd1f1cfc966537fccecdc89a84b106ba96", "committedDate": "2020-06-02T01:56:46Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNzg1ODMy", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#pullrequestreview-422785832", "createdAt": "2020-06-02T15:19:20Z", "commit": {"oid": "87814acd1f1cfc966537fccecdc89a84b106ba96"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNToxOToyMFrOGd2sGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNToxOToyMFrOGd2sGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk1NzkxNA==", "bodyText": "Unfortunately this method was not added until 2.6.8: https://github.com/playframework/playframework/blob/2.6.8/framework/src/play/src/main/java/play/libs/typedmap/TypedKey.java#L31\nMaking this change while good would break support of some play 2.6 versions. Given the size of this change, can you make this call with reflection to the appropriate method instead? (make asScala the default path)\nI don't think this is a place where creating a whole new version makes sense", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#discussion_r433957914", "createdAt": "2020-06-02T15:19:20Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/play-2.6/src/main/java8/datadog/trace/instrumentation/play26/PlayHttpServerDecorator.java", "diffHunk": "@@ -61,7 +61,7 @@ public AgentSpan onRequest(final AgentSpan span, final Request request) {\n       // more about routes here:\n       // https://github.com/playframework/playframework/blob/master/documentation/manual/releases/release26/migration26/Migration26.md\n       final Option<HandlerDef> defOption =\n-          request.attrs().get(Router.Attrs.HANDLER_DEF.underlying());\n+          request.attrs().get(Router.Attrs.HANDLER_DEF.asScala());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87814acd1f1cfc966537fccecdc89a84b106ba96"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f20bf9c031744bd8ec99335ca93faaacc4c197d8", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f20bf9c031744bd8ec99335ca93faaacc4c197d8", "committedDate": "2020-06-05T18:16:20Z", "message": "Use reflection to resolve method to get underlying handler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTQ1OTE2", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#pullrequestreview-425545916", "createdAt": "2020-06-05T18:51:20Z", "commit": {"oid": "f20bf9c031744bd8ec99335ca93faaacc4c197d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTk1ODA3", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#pullrequestreview-425595807", "createdAt": "2020-06-05T20:10:02Z", "commit": {"oid": "f20bf9c031744bd8ec99335ca93faaacc4c197d8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMDoxMDowMlrOGf7-AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMDoxMDowMlrOGf7-AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0MTU2OQ==", "bodyText": "This is probably subverting the muzzle check... so if they change this in the future, we might not detect it properly.  Lightbend will likely break our instrumentation in the next \"minor\" version anyway so we should be sure to split it out as a separate module at that point.", "url": "https://github.com/DataDog/dd-trace-java/pull/1521#discussion_r436141569", "createdAt": "2020-06-05T20:10:02Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/play-2.6/src/main/java8/datadog/trace/instrumentation/play26/PlayHttpServerDecorator.java", "diffHunk": "@@ -5,20 +5,41 @@\n import datadog.trace.bootstrap.instrumentation.api.Tags;\n import datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator;\n import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n import java.lang.reflect.UndeclaredThrowableException;\n import java.net.URI;\n import java.net.URISyntaxException;\n import lombok.extern.slf4j.Slf4j;\n import play.api.mvc.Request;\n import play.api.mvc.Result;\n import play.api.routing.HandlerDef;\n+import play.libs.typedmap.TypedKey;\n import play.routing.Router;\n import scala.Option;\n \n @Slf4j\n public class PlayHttpServerDecorator extends HttpServerDecorator<Request, Request, Result> {\n   public static final PlayHttpServerDecorator DECORATE = new PlayHttpServerDecorator();\n \n+  private static final Method typedKeyGetUnderlying;\n+\n+  static {\n+    Method typedKeyGetUnderlyingCheck = null;\n+    try {\n+      // This method was added in Play 2.6.8\n+      typedKeyGetUnderlyingCheck = TypedKey.class.getMethod(\"asScala\");\n+    } catch (final NoSuchMethodException ignored) {\n+    }\n+    // Fallback\n+    if (typedKeyGetUnderlyingCheck == null) {\n+      try {\n+        typedKeyGetUnderlyingCheck = TypedKey.class.getMethod(\"underlying\");\n+      } catch (final NoSuchMethodException ignored) {\n+      }\n+    }\n+    typedKeyGetUnderlying = typedKeyGetUnderlyingCheck;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20bf9c031744bd8ec99335ca93faaacc4c197d8"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2332, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}