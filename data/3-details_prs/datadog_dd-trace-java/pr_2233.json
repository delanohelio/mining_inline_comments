{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0MTcxNTQx", "number": 2233, "title": "Allow for the span completing a Scala Promise to be reactivated", "bodyText": "This makes it possible to have the activeSpan that completes a Scala Promise to be reactivated as the active span during any computations that has been added to the associated Future, and take priority over any span that was captured while the computation was added.\nTo enable, set the following property dd.trace.integration.scala_promise_completion_priority.enabled=true or environment variable DD_TRACE_INTEGRATION_SCALA_PROMISE_COMPLETION_PRIORITY.ENABLED=true", "createdAt": "2020-12-22T14:51:32Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2233", "merged": true, "mergeCommit": {"oid": "ac978e3895f89ccf12c271f649e49de517153636"}, "closed": true, "closedAt": "2021-01-14T15:57:19Z", "author": {"login": "bantonsson"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdostw-gBqjQxNDA3NDY4NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdwFB2ogFqTU2ODI3MzEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fe1c2b6b3bbb54eb45cd40047a0aba374c5f49a", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5fe1c2b6b3bbb54eb45cd40047a0aba374c5f49a", "committedDate": "2020-12-22T15:48:02Z", "message": "Move jcenter after maven central"}, "afterCommit": {"oid": "ac3f0baf2372fff8a08e937a77031d3e906e655c", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ac3f0baf2372fff8a08e937a77031d3e906e655c", "committedDate": "2020-12-22T15:59:44Z", "message": "Move jcenter after maven central"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac3f0baf2372fff8a08e937a77031d3e906e655c", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ac3f0baf2372fff8a08e937a77031d3e906e655c", "committedDate": "2020-12-22T15:59:44Z", "message": "Move jcenter after maven central"}, "afterCommit": {"oid": "9f548df0f7e8463653414c4c32467f56173bf4b7", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9f548df0f7e8463653414c4c32467f56173bf4b7", "committedDate": "2020-12-22T16:58:05Z", "message": "Move jcenter after maven central"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f548df0f7e8463653414c4c32467f56173bf4b7", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9f548df0f7e8463653414c4c32467f56173bf4b7", "committedDate": "2020-12-22T16:58:05Z", "message": "Move jcenter after maven central"}, "afterCommit": {"oid": "12cdbec990bc0c95a3bb3a6d9f61364dff280531", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/12cdbec990bc0c95a3bb3a6d9f61364dff280531", "committedDate": "2021-01-11T10:58:36Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12cdbec990bc0c95a3bb3a6d9f61364dff280531", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/12cdbec990bc0c95a3bb3a6d9f61364dff280531", "committedDate": "2021-01-11T10:58:36Z", "message": "Allow for the span completing a Scala promise to be reactivated"}, "afterCommit": {"oid": "ec4231e3f7b3defc0a2df82e7fa9daabfabd391c", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ec4231e3f7b3defc0a2df82e7fa9daabfabd391c", "committedDate": "2021-01-11T12:51:47Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec4231e3f7b3defc0a2df82e7fa9daabfabd391c", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ec4231e3f7b3defc0a2df82e7fa9daabfabd391c", "committedDate": "2021-01-11T12:51:47Z", "message": "Allow for the span completing a Scala promise to be reactivated"}, "afterCommit": {"oid": "cc08b4a4d78e1004225224aa54a7fcd226bb50cf", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cc08b4a4d78e1004225224aa54a7fcd226bb50cf", "committedDate": "2021-01-11T13:26:39Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc08b4a4d78e1004225224aa54a7fcd226bb50cf", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cc08b4a4d78e1004225224aa54a7fcd226bb50cf", "committedDate": "2021-01-11T13:26:39Z", "message": "Allow for the span completing a Scala promise to be reactivated"}, "afterCommit": {"oid": "852eb69209893b102561f284ec32801fd6ace597", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/852eb69209893b102561f284ec32801fd6ace597", "committedDate": "2021-01-12T13:18:45Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "852eb69209893b102561f284ec32801fd6ace597", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/852eb69209893b102561f284ec32801fd6ace597", "committedDate": "2021-01-12T13:18:45Z", "message": "Allow for the span completing a Scala promise to be reactivated"}, "afterCommit": {"oid": "e2b0a91684f0b2a9d61263fafb236318cae39d24", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e2b0a91684f0b2a9d61263fafb236318cae39d24", "committedDate": "2021-01-12T16:14:48Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2b0a91684f0b2a9d61263fafb236318cae39d24", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e2b0a91684f0b2a9d61263fafb236318cae39d24", "committedDate": "2021-01-12T16:14:48Z", "message": "Allow for the span completing a Scala promise to be reactivated"}, "afterCommit": {"oid": "685405a0112e245e3b5eb5a2ad6590c18aa0144e", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/685405a0112e245e3b5eb5a2ad6590c18aa0144e", "committedDate": "2021-01-13T15:06:36Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "685405a0112e245e3b5eb5a2ad6590c18aa0144e", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/685405a0112e245e3b5eb5a2ad6590c18aa0144e", "committedDate": "2021-01-13T15:06:36Z", "message": "Allow for the span completing a Scala promise to be reactivated"}, "afterCommit": {"oid": "dc96f1de95c44f3bda273ee8c06cf92cd616c109", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/dc96f1de95c44f3bda273ee8c06cf92cd616c109", "committedDate": "2021-01-13T15:47:00Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc96f1de95c44f3bda273ee8c06cf92cd616c109", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/dc96f1de95c44f3bda273ee8c06cf92cd616c109", "committedDate": "2021-01-13T15:47:00Z", "message": "Allow for the span completing a Scala promise to be reactivated"}, "afterCommit": {"oid": "244b5560dcfae6bb74eb727089b22f4676298e10", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/244b5560dcfae6bb74eb727089b22f4676298e10", "committedDate": "2021-01-14T09:21:33Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d9a8c43af3fe4924294e6e7fdee9849ffbc35879", "committedDate": "2021-01-14T10:21:06Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "244b5560dcfae6bb74eb727089b22f4676298e10", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/244b5560dcfae6bb74eb727089b22f4676298e10", "committedDate": "2021-01-14T09:21:33Z", "message": "Allow for the span completing a Scala promise to be reactivated"}, "afterCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d9a8c43af3fe4924294e6e7fdee9849ffbc35879", "committedDate": "2021-01-14T10:21:06Z", "message": "Allow for the span completing a Scala promise to be reactivated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTIyNTg0", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568122584", "createdAt": "2021-01-14T10:55:38Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTQ5NzI0", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568149724", "createdAt": "2021-01-14T11:33:34Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTozMzozNVrOITgv5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTozMzozNVrOITgv5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzMzMDQwNA==", "bodyText": "there are a few remaining references to SortedSet in Config which should be updated for consistency, but that can be done in a follow-up PR", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557330404", "createdAt": "2021-01-14T11:33:35Z", "author": {"login": "mcculls"}, "path": "internal-api/src/main/java/datadog/trace/api/Config.java", "diffHunk": "@@ -877,12 +877,12 @@ public String getFinalProfilingUrl() {\n   }\n \n   public boolean isIntegrationEnabled(\n-      final SortedSet<String> integrationNames, final boolean defaultEnabled) {\n+      final Iterable<String> integrationNames, final boolean defaultEnabled) {\n     return isEnabled(integrationNames, \"integration.\", \".enabled\", defaultEnabled);\n   }\n \n   public boolean isJmxFetchIntegrationEnabled(\n-      final SortedSet<String> integrationNames, final boolean defaultEnabled) {\n+      final Iterable<String> integrationNames, final boolean defaultEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTUxOTA0", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568151904", "createdAt": "2021-01-14T11:36:38Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTozNjozOFrOITg17g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTozNjozOFrOITg17g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzMzMTk1MA==", "bodyText": "could use try-with-resources for scope", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557331950", "createdAt": "2021-01-14T11:36:38Z", "author": {"login": "mcculls"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/CustomScopeManagerWrapper.java", "diffHunk": "@@ -63,6 +63,15 @@ public AgentSpan activeSpan() {\n     return converter.toAgentSpan(delegate.activeSpan());\n   }\n \n+  @Override\n+  public TraceScope.Continuation captureSpan(final AgentSpan span, ScopeSource source) {\n+    // I can't see a better way to do this, and I don't know if this even makes sense.\n+    AgentScope scope = this.activate(span, source);\n+    TraceScope.Continuation continuation = scope.capture();\n+    scope.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTU0NDk2", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568154496", "createdAt": "2021-01-14T11:40:24Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo0MDoyNFrOITg96g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo0MDoyNFrOITg96g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzMzMzk5NA==", "bodyText": "maybe pull the 5s out into a constant so it's easier to maintain", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557333994", "createdAt": "2021-01-14T11:40:24Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/src/test/scala/PromiseUtils.scala", "diffHunk": "@@ -1,7 +1,12 @@\n import groovy.lang.Closure\n-import scala.concurrent.{ExecutionContext, Future, Promise}\n+import scala.concurrent.duration.Duration\n+import scala.concurrent.{Await, ExecutionContext, Future, Promise}\n \n class PromiseUtils(implicit ec: ExecutionContext) {\n+  // This code is only here to ensure that we in the unit promise tests do the\n+  // first apply inside a trace during the initialization of the PromiseUtils,\n+  // so that we initialize the unit field if it exists with a context\n+  Await.result(Future.apply(\"unused\"), Duration(\"5s\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTU1MDU1", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568155055", "createdAt": "2021-01-14T11:41:12Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo0MToxMlrOITg_ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo0MToxMlrOITg_ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzMzNDM3Mw==", "bodyText": "can re-use the 5s constant here", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557334373", "createdAt": "2021-01-14T11:41:12Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/src/test/scala/PromiseUtils.scala", "diffHunk": "@@ -12,4 +17,16 @@ class PromiseUtils(implicit ec: ExecutionContext) {\n   def onComplete[T](future: Future[T], callable: Closure[T]): Unit = {\n     future.onComplete(v => callable.call(v.get))\n   }\n+\n+  def apply[T](callable: Closure[T]): Future[T] = {\n+    Future(callable.call())\n+  }\n+\n+  def await[T](future: Future[T]): T = {\n+    Await.result(future, Duration(\"5s\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTU3MDY5", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568157069", "createdAt": "2021-01-14T11:44:17Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo0NDoxN1rOIThFUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo0NDoxN1rOIThFUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzMzNTg4OA==", "bodyText": "s/assoicated/associated/", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557335888", "createdAt": "2021-01-14T11:44:17Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/src/main/java/datadog/trace/instrumentation/scala/PromiseHelper.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package datadog.trace.instrumentation.scala;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activeScope;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activeSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.captureSpan;\n+\n+import datadog.trace.api.Config;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.java.concurrent.State;\n+import datadog.trace.context.TraceScope;\n+import java.util.Collections;\n+import scala.util.Failure;\n+import scala.util.Success;\n+import scala.util.Try;\n+\n+public class PromiseHelper {\n+  public static final boolean completionPriority =\n+      Config.get()\n+          .isIntegrationEnabled(\n+              Collections.singletonList(\"scala_promise_completion_priority\"), false);\n+\n+  /**\n+   * Get the {@code Span} that should be associated with the {@code Try} completing this {@code\n+   * Promise}.\n+   *\n+   * @return the Span or null\n+   */\n+  public static AgentSpan getSpan() {\n+    AgentSpan span = null;\n+    final TraceScope scope = activeScope();\n+    if (null != scope && scope.isAsyncPropagating()) {\n+      if (scope instanceof AgentScope) {\n+        span = ((AgentScope) scope).span();\n+      } else {\n+        span = activeSpan();\n+      }\n+    }\n+    return span;\n+  }\n+\n+  /**\n+   * Get the {@code Try} that should be associated with the {@code Span}. Will create a new copy of\n+   * the {@code Try} if the existing one already has a different {@code Span} associated.\n+   *\n+   * @param resolved the current Try\n+   * @param span the current Span\n+   * @param existing the currently stored Span for the Try\n+   * @return the Try that should be assoicated with the Span", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTYyNjcz", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568162673", "createdAt": "2021-01-14T11:52:43Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo1Mjo0M1rOIThW4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo1Mjo0M1rOIThW4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM0MDM4Nw==", "bodyText": "is this dangling $ a quirk of scala?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557340387", "createdAt": "2021-01-14T11:52:43Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseObjectInstrumentation213.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package datadog.trace.instrumentation.scala.concurrent;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static scala.concurrent.impl.Promise.Transformation;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.api.Config;\n+import datadog.trace.bootstrap.ContextStore;\n+import datadog.trace.bootstrap.InstrumentationContext;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.instrumentation.scala.PromiseHelper;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import scala.util.Try;\n+\n+/**\n+ * A Scala {@code Promise} is always completed with a {@code Try}, so if we want the completing span\n+ * to take priority over any spans captured while adding computations to a {@code Future} associated\n+ * with a {@code Promise}, then we capture the active span when the {@code Try} is resolved.\n+ */\n+@AutoService(Instrumenter.class)\n+public class PromiseObjectInstrumentation213 extends Instrumenter.Tracing {\n+\n+  public PromiseObjectInstrumentation213() {\n+    super(\"scala_promise_resolve\", \"scala_concurrent\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"scala.concurrent.impl.Promise$\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTYzNjYy", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568163662", "createdAt": "2021-01-14T11:54:08Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo1NDowOFrOIThZyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo1NDowOFrOIThZyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM0MTEzMQ==", "bodyText": "same question - is this dangling $ a quirk of scala?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557341131", "createdAt": "2021-01-14T11:54:08Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.10/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseObjectInstrumentation210.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package datadog.trace.instrumentation.scala.concurrent;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.api.Config;\n+import datadog.trace.bootstrap.ContextStore;\n+import datadog.trace.bootstrap.InstrumentationContext;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.instrumentation.scala.PromiseHelper;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import scala.concurrent.impl.CallbackRunnable;\n+import scala.util.Try;\n+\n+/**\n+ * A Scala {@code Promise} is always completed with a {@code Try}, so if we want the completing span\n+ * to take priority over any spans captured while adding computations to a {@code Future} associated\n+ * with a {@code Promise}, then we capture the active span when the {@code Try} is resolved.\n+ */\n+@AutoService(Instrumenter.class)\n+public class PromiseObjectInstrumentation210 extends Instrumenter.Tracing {\n+\n+  public PromiseObjectInstrumentation210() {\n+    super(\"scala_promise_resolve\", \"scala_concurrent\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"scala.concurrent.impl.Promise$\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTY2OTIy", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568166922", "createdAt": "2021-01-14T11:59:06Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo1OTowNlrOIThkeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMTo1OTowNlrOIThkeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM0Mzg2NQ==", "bodyText": "I assume these muzzle checks weren't needed because the instrumentation already refers to Promise.Transformation and will be muzzled when that's not available", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557343865", "createdAt": "2021-01-14T11:59:06Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -111,34 +112,36 @@ private static void muzzleCheck(final Transformation callback) {\n         state.closeContinuation();\n       }\n     }\n-\n-    /** Promise.Transformation was introduced in scala 2.13 */\n-    private static void muzzleCheck(final Transformation callback) {\n-      callback.submitWithValue(null);\n-    }\n   }\n \n   public static final class SubmitWithValue {\n     @Advice.OnMethodEnter\n-    public static <F, T> void beforeExecute(@Advice.This Transformation<F, T> task) {\n+    public static <F, T> void beforeExecute(\n+        @Advice.This Transformation<F, T> task, @Advice.Argument(value = 0) Try<T> resolved) {\n       // about to enter an ExecutionContext so capture the scope if necessary\n       // (this used to happen automatically when the RunnableInstrumentation\n       // was relied on, and happens anyway if the ExecutionContext is backed\n       // by a wrapping Executor (e.g. FJP, ScheduledThreadPoolExecutor)\n-      State state = InstrumentationContext.get(Transformation.class, State.class).get(task);\n+      ContextStore<Transformation, State> tStore =\n+          InstrumentationContext.get(Transformation.class, State.class);\n+      State state = tStore.get(task);\n+      if (PromiseHelper.completionPriority) {\n+        final AgentSpan span = InstrumentationContext.get(Try.class, AgentSpan.class).get(resolved);\n+        State oState = state;\n+        state = PromiseHelper.handleSpan(span, state);\n+        if (state != oState) {\n+          tStore.put(task, state);\n+        }\n+      }\n+      // If nothing else has been picked up, then try to pick up the current Scope\n       if (null == state) {\n         final TraceScope scope = activeScope();\n         if (scope != null) {\n           state = State.FACTORY.create();\n           state.captureAndSetContinuation(scope);\n-          InstrumentationContext.get(Transformation.class, State.class).put(task, state);\n+          tStore.put(task, state);\n         }\n       }\n     }\n-\n-    /** Promise.Transformation was introduced in scala 2.13 */\n-    private static void muzzleCheck(final Transformation callback) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTcxMjIw", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568171220", "createdAt": "2021-01-14T12:05:31Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowNTozMVrOIThyPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowNTozMVrOIThyPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM0NzM5MQ==", "bodyText": "I'm not sure about this change because it replaces something that was clear (enabled) with something less clear - ie. defaultEnabled is not the same as defaultEnabled() and is not actually the \"default\" , but a combination of the default with a configuration override.\nAFAICT this change is just so the scala instrumentations can see if the instrumentation is enabled from the POV of the base class - is there a reason they can't use super.enabled() to do that?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557347391", "createdAt": "2021-01-14T12:05:31Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/Instrumenter.java", "diffHunk": "@@ -86,7 +86,7 @@\n     private final String instrumentationPrimaryName;\n     private InstrumentationContextProvider contextProvider;\n     private boolean initialized;\n-    private final boolean enabled;\n+    protected final boolean defaultEnabled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTczMDQy", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568173042", "createdAt": "2021-01-14T12:08:21Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowODoyMlrOITh4cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowODoyMlrOITh4cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM0ODk3Nw==", "bodyText": "this change is fine, but I think the other changes in this file are unnecessary given subclasses can call super.isEnabled() to get the enabled state of the base class which they can then override in their isEnabled method", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557348977", "createdAt": "2021-01-14T12:08:22Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/Instrumenter.java", "diffHunk": "@@ -135,7 +135,7 @@ private void lazyInit() {\n \n     @Override\n     public final AgentBuilder instrument(final AgentBuilder parentAgentBuilder) {\n-      if (!enabled) {\n+      if (!isEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTczNTU1", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568173555", "createdAt": "2021-01-14T12:09:03Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowOTowM1rOITh56Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowOTowM1rOITh56Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM0OTM1Mw==", "bodyText": "super.isEnabled() ?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557349353", "createdAt": "2021-01-14T12:09:03Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseObjectInstrumentation213.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package datadog.trace.instrumentation.scala.concurrent;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static scala.concurrent.impl.Promise.Transformation;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.api.Config;\n+import datadog.trace.bootstrap.ContextStore;\n+import datadog.trace.bootstrap.InstrumentationContext;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.instrumentation.scala.PromiseHelper;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import scala.util.Try;\n+\n+/**\n+ * A Scala {@code Promise} is always completed with a {@code Try}, so if we want the completing span\n+ * to take priority over any spans captured while adding computations to a {@code Future} associated\n+ * with a {@code Promise}, then we capture the active span when the {@code Try} is resolved.\n+ */\n+@AutoService(Instrumenter.class)\n+public class PromiseObjectInstrumentation213 extends Instrumenter.Tracing {\n+\n+  public PromiseObjectInstrumentation213() {\n+    super(\"scala_promise_resolve\", \"scala_concurrent\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"scala.concurrent.impl.Promise$\");\n+  }\n+\n+  @Override\n+  public Map<String, String> contextStore() {\n+    return singletonMap(\"scala.util.Try\", AgentSpan.class.getName());\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return Collections.singletonMap(\n+        isMethod().and(named(\"scala$concurrent$impl$Promise$$resolve\")),\n+        getClass().getName() + \"$Resolve\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\"datadog.trace.instrumentation.scala.PromiseHelper\"};\n+  }\n+\n+  @Override\n+  public boolean isEnabled() {\n+    // Only enable this if integrations have been enabled and the extra \"integration\"\n+    // scala_promise_completion_priority has been enabled specifically\n+    return defaultEnabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTc0MDIx", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568174021", "createdAt": "2021-01-14T12:09:38Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowOTozOVrOITh7SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowOTozOVrOITh7SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM0OTcwNA==", "bodyText": "contextStore ?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557349704", "createdAt": "2021-01-14T12:09:39Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -111,34 +112,36 @@ private static void muzzleCheck(final Transformation callback) {\n         state.closeContinuation();\n       }\n     }\n-\n-    /** Promise.Transformation was introduced in scala 2.13 */\n-    private static void muzzleCheck(final Transformation callback) {\n-      callback.submitWithValue(null);\n-    }\n   }\n \n   public static final class SubmitWithValue {\n     @Advice.OnMethodEnter\n-    public static <F, T> void beforeExecute(@Advice.This Transformation<F, T> task) {\n+    public static <F, T> void beforeExecute(\n+        @Advice.This Transformation<F, T> task, @Advice.Argument(value = 0) Try<T> resolved) {\n       // about to enter an ExecutionContext so capture the scope if necessary\n       // (this used to happen automatically when the RunnableInstrumentation\n       // was relied on, and happens anyway if the ExecutionContext is backed\n       // by a wrapping Executor (e.g. FJP, ScheduledThreadPoolExecutor)\n-      State state = InstrumentationContext.get(Transformation.class, State.class).get(task);\n+      ContextStore<Transformation, State> tStore =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTc0MTg0", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568174184", "createdAt": "2021-01-14T12:09:53Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowOTo1M1rOITh70w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjowOTo1M1rOITh70w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM0OTg0Mw==", "bodyText": "oldState ?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557349843", "createdAt": "2021-01-14T12:09:53Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -111,34 +112,36 @@ private static void muzzleCheck(final Transformation callback) {\n         state.closeContinuation();\n       }\n     }\n-\n-    /** Promise.Transformation was introduced in scala 2.13 */\n-    private static void muzzleCheck(final Transformation callback) {\n-      callback.submitWithValue(null);\n-    }\n   }\n \n   public static final class SubmitWithValue {\n     @Advice.OnMethodEnter\n-    public static <F, T> void beforeExecute(@Advice.This Transformation<F, T> task) {\n+    public static <F, T> void beforeExecute(\n+        @Advice.This Transformation<F, T> task, @Advice.Argument(value = 0) Try<T> resolved) {\n       // about to enter an ExecutionContext so capture the scope if necessary\n       // (this used to happen automatically when the RunnableInstrumentation\n       // was relied on, and happens anyway if the ExecutionContext is backed\n       // by a wrapping Executor (e.g. FJP, ScheduledThreadPoolExecutor)\n-      State state = InstrumentationContext.get(Transformation.class, State.class).get(task);\n+      ContextStore<Transformation, State> tStore =\n+          InstrumentationContext.get(Transformation.class, State.class);\n+      State state = tStore.get(task);\n+      if (PromiseHelper.completionPriority) {\n+        final AgentSpan span = InstrumentationContext.get(Try.class, AgentSpan.class).get(resolved);\n+        State oState = state;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTc1NDY5", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568175469", "createdAt": "2021-01-14T12:11:43Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjoxMTo0M1rOITh_ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjoxMTo0M1rOITh_ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM1MDgxOQ==", "bodyText": "super.isEnabled() ?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557350819", "createdAt": "2021-01-14T12:11:43Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/DefaultPromiseInstrumentation.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package datadog.trace.instrumentation.scala.concurrent;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static scala.concurrent.impl.Promise.Transformation;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.api.Config;\n+import datadog.trace.bootstrap.ContextStore;\n+import datadog.trace.bootstrap.InstrumentationContext;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.instrumentation.scala.PromiseHelper;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import scala.util.Try;\n+\n+/**\n+ * In Scala 2.13+ there is shortcut that bypass the call to {@code resolve} for a {@code Try} when\n+ * we know that the value is already resolved, i.e. for some transformations like {@code map}, so\n+ * only pick up the completing span if the resolved {@code Try} doesn't have a an existing span set\n+ * from the {@code resolve} method.\n+ */\n+@AutoService(Instrumenter.class)\n+public class DefaultPromiseInstrumentation extends Instrumenter.Tracing {\n+\n+  public DefaultPromiseInstrumentation() {\n+    super(\"scala_promise_complete\", \"scala_concurrent\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"scala.concurrent.impl.Promise$DefaultPromise\");\n+  }\n+\n+  @Override\n+  public Map<String, String> contextStore() {\n+    return singletonMap(\"scala.util.Try\", AgentSpan.class.getName());\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return Collections.singletonMap(\n+        isMethod().and(named(\"tryComplete0\")), getClass().getName() + \"$TryComplete\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\"datadog.trace.instrumentation.scala.PromiseHelper\"};\n+  }\n+\n+  @Override\n+  public boolean isEnabled() {\n+    // Only enable this if integrations have been enabled and the extra \"integration\"\n+    // scala_promise_completion_priority has been enabled specifically\n+    return defaultEnabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTc2MDUx", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568176051", "createdAt": "2021-01-14T12:12:35Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjoxMjozNlrOITiBVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjoxMjozNlrOITiBVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM1MTI1NQ==", "bodyText": "super.isEnabled() ?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557351255", "createdAt": "2021-01-14T12:12:36Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.10/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseObjectInstrumentation210.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package datadog.trace.instrumentation.scala.concurrent;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.api.Config;\n+import datadog.trace.bootstrap.ContextStore;\n+import datadog.trace.bootstrap.InstrumentationContext;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.instrumentation.scala.PromiseHelper;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import scala.concurrent.impl.CallbackRunnable;\n+import scala.util.Try;\n+\n+/**\n+ * A Scala {@code Promise} is always completed with a {@code Try}, so if we want the completing span\n+ * to take priority over any spans captured while adding computations to a {@code Future} associated\n+ * with a {@code Promise}, then we capture the active span when the {@code Try} is resolved.\n+ */\n+@AutoService(Instrumenter.class)\n+public class PromiseObjectInstrumentation210 extends Instrumenter.Tracing {\n+\n+  public PromiseObjectInstrumentation210() {\n+    super(\"scala_promise_resolve\", \"scala_concurrent\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"scala.concurrent.impl.Promise$\");\n+  }\n+\n+  @Override\n+  public Map<String, String> contextStore() {\n+    return singletonMap(\"scala.util.Try\", AgentSpan.class.getName());\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return Collections.singletonMap(\n+        isMethod().and(named(\"scala$concurrent$impl$Promise$$resolveTry\")),\n+        getClass().getName() + \"$ResolveTry\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\"datadog.trace.instrumentation.scala.PromiseHelper\"};\n+  }\n+\n+  @Override\n+  public boolean isEnabled() {\n+    // Only enable this if integrations have been enabled and the extra \"integration\"\n+    // scala_promise_completion_priority has been enabled specifically\n+    return defaultEnabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTc2OTgw", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568176980", "createdAt": "2021-01-14T12:13:56Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjoxMzo1N1rOITiEDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjoxMzo1N1rOITiEDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM1MTk1MA==", "bodyText": "contextStore ?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557351950", "createdAt": "2021-01-14T12:13:57Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.10/src/main/java/datadog/trace/instrumentation/scala/concurrent/CallbackRunnableInstrumentation.java", "diffHunk": "@@ -93,18 +104,30 @@ public static void after(@Advice.Enter TraceScope scope) {\n \n   public static final class ExecuteWithValue {\n     @Advice.OnMethodEnter\n-    public static <T> void beforeExecute(@Advice.This CallbackRunnable<T> task) {\n+    public static <T> void beforeExecute(\n+        @Advice.This CallbackRunnable<T> task, @Advice.Argument(value = 0) Try<T> resolved) {\n       // about to enter an ExecutionContext so capture the scope if necessary\n       // (this used to happen automatically when the RunnableInstrumentation\n       // was relied on, and happens anyway if the ExecutionContext is backed\n       // by a wrapping Executor (e.g. FJP, ScheduledThreadPoolExecutor)\n-      State state = InstrumentationContext.get(CallbackRunnable.class, State.class).get(task);\n+      ContextStore<CallbackRunnable, State> rStore =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTc3Mzc1", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568177375", "createdAt": "2021-01-14T12:14:34Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjoxNDozNFrOITiFQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMjoxNDozNFrOITiFQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM1MjI1Ng==", "bodyText": "oldState ?", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#discussion_r557352256", "createdAt": "2021-01-14T12:14:34Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/scala-promise/scala-promise-2.10/src/main/java/datadog/trace/instrumentation/scala/concurrent/CallbackRunnableInstrumentation.java", "diffHunk": "@@ -93,18 +104,30 @@ public static void after(@Advice.Enter TraceScope scope) {\n \n   public static final class ExecuteWithValue {\n     @Advice.OnMethodEnter\n-    public static <T> void beforeExecute(@Advice.This CallbackRunnable<T> task) {\n+    public static <T> void beforeExecute(\n+        @Advice.This CallbackRunnable<T> task, @Advice.Argument(value = 0) Try<T> resolved) {\n       // about to enter an ExecutionContext so capture the scope if necessary\n       // (this used to happen automatically when the RunnableInstrumentation\n       // was relied on, and happens anyway if the ExecutionContext is backed\n       // by a wrapping Executor (e.g. FJP, ScheduledThreadPoolExecutor)\n-      State state = InstrumentationContext.get(CallbackRunnable.class, State.class).get(task);\n+      ContextStore<CallbackRunnable, State> rStore =\n+          InstrumentationContext.get(CallbackRunnable.class, State.class);\n+      State state = rStore.get(task);\n+      if (PromiseHelper.completionPriority) {\n+        final AgentSpan span = InstrumentationContext.get(Try.class, AgentSpan.class).get(resolved);\n+        State oState = state;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MTc5Mjk2", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568179296", "createdAt": "2021-01-14T12:17:27Z", "commit": {"oid": "d9a8c43af3fe4924294e6e7fdee9849ffbc35879"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d4b4ec31e34bb7cc8a8799529c1e620fb57e61a", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9d4b4ec31e34bb7cc8a8799529c1e620fb57e61a", "committedDate": "2021-01-14T13:27:03Z", "message": "Changes based on PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MjczMTA5", "url": "https://github.com/DataDog/dd-trace-java/pull/2233#pullrequestreview-568273109", "createdAt": "2021-01-14T14:17:09Z", "commit": {"oid": "9d4b4ec31e34bb7cc8a8799529c1e620fb57e61a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2798, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}