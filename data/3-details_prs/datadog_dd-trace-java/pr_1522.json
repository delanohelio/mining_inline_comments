{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NTU4ODIw", "number": 1522, "title": "add record.queue_time_ms to rabbitmq consumer span tags", "bodyText": "Adds the time between sending the message and starting the consumer span to the tags of consumer spans.", "createdAt": "2020-06-02T12:41:36Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1522", "merged": true, "mergeCommit": {"oid": "763ddfb58a8c5c4111533a89c10366678c96c72b"}, "closed": true, "closedAt": "2020-06-02T16:36:32Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnUOwigBqjMzOTc0NzIxMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnWOiRgBqjMzOTgxMTQwNTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "766d74eb06b6d764e8eb750a5f40cdef362d67c3", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/766d74eb06b6d764e8eb750a5f40cdef362d67c3", "committedDate": "2020-06-02T12:39:13Z", "message": "add record.queue_time_ms to rabbitmq consumer span tags"}, "afterCommit": {"oid": "5769e4c8b139d0c9da56051e28e0effd0e7e175b", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5769e4c8b139d0c9da56051e28e0effd0e7e175b", "committedDate": "2020-06-02T12:43:12Z", "message": "add record.queue_time_ms to rabbitmq consumer span tags"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5769e4c8b139d0c9da56051e28e0effd0e7e175b", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5769e4c8b139d0c9da56051e28e0effd0e7e175b", "committedDate": "2020-06-02T12:43:12Z", "message": "add record.queue_time_ms to rabbitmq consumer span tags"}, "afterCommit": {"oid": "f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499", "committedDate": "2020-06-02T13:37:26Z", "message": "add record.queue_time_ms to rabbitmq consumer span tags"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNzM4ODIz", "url": "https://github.com/DataDog/dd-trace-java/pull/1522#pullrequestreview-422738823", "createdAt": "2020-06-02T14:30:40Z", "commit": {"oid": "f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDozMDo0MFrOGd0hwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDozMTozM1rOGd0kIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyMjQ5Ng==", "bodyText": "So this will only work if the timestamp is set on their message when it is published?", "url": "https://github.com/DataDog/dd-trace-java/pull/1522#discussion_r433922496", "createdAt": "2020-06-02T14:30:40Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/rabbitmq-amqp-2.7/src/test/groovy/RabbitMQTest.groovy", "diffHunk": "@@ -174,7 +170,13 @@ class RabbitMQTest extends AgentTestRunner {\n \n     (1..messageCount).each {\n       TEST_WRITER.waitForTraces(2 + (it * 2))\n-      channel.basicPublish(exchangeName, \"\", null, \"msg $it\".getBytes())\n+      if (setTimestamp) {\n+        channel.basicPublish(exchangeName, \"\",\n+          new AMQP.BasicProperties.Builder().timestamp(new Date()).build(),\n+          \"msg $it\".getBytes())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyMzEwNA==", "bodyText": "Please add a comment describing when this would be null or how the timestamp gets populated.", "url": "https://github.com/DataDog/dd-trace-java/pull/1522#discussion_r433923104", "createdAt": "2020-06-02T14:31:33Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/rabbitmq-amqp-2.7/src/main/java/datadog/trace/instrumentation/rabbitmq/amqp/TracedDelegatingConsumer.java", "diffHunk": "@@ -70,13 +75,19 @@ public void handleDelivery(\n       final Context context = headers == null ? null : propagate().extract(headers, GETTER);\n \n       final AgentSpan span =\n-          startSpan(\"amqp.command\", context)\n-              .setTag(\"message.size\", body == null ? 0 : body.length)\n-              .setTag(\"span.origin.type\", delegate.getClass().getName())\n-              .setTag(InstrumentationTags.DD_MEASURED, true);\n+          startSpan(AMQP_COMMAND, context)\n+              .setTag(MESSAGE_SIZE, body == null ? 0 : body.length)\n+              .setTag(SPAN_ORIGIN_TYPE, delegate.getClass().getName())\n+              .setTag(DD_MEASURED, true);\n       CONSUMER_DECORATE.afterStart(span);\n       CONSUMER_DECORATE.onDeliver(span, queue, envelope);\n \n+      if (properties.getTimestamp() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e784bfcc88029aba81c58b1efd7e2d89a1b393d2", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e784bfcc88029aba81c58b1efd7e2d89a1b393d2", "committedDate": "2020-06-02T15:02:15Z", "message": "see what happens if we let elastic find a port to bind to and get the port back from the client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee33c2d343b1117504d58c005cc1ce620cb65279", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ee33c2d343b1117504d58c005cc1ce620cb65279", "committedDate": "2020-06-02T15:02:47Z", "message": "add record.queue_time_ms to rabbitmq consumer span tags"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499", "committedDate": "2020-06-02T13:37:26Z", "message": "add record.queue_time_ms to rabbitmq consumer span tags"}, "afterCommit": {"oid": "ee33c2d343b1117504d58c005cc1ce620cb65279", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ee33c2d343b1117504d58c005cc1ce620cb65279", "committedDate": "2020-06-02T15:02:47Z", "message": "add record.queue_time_ms to rabbitmq consumer span tags"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2334, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}