{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2ODcyNDg1", "number": 2192, "title": "metrics testing and quality improvements", "bodyText": "", "createdAt": "2020-12-11T12:50:30Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2192", "merged": true, "mergeCommit": {"oid": "8db1060d3ad8a6abe283d944c10890239fc954cf"}, "closed": true, "closedAt": "2020-12-11T16:48:41Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlGEhQAH2gAyNTM2ODcyNDg1OmI0YTgxYjUzOGVkZTViMzdhNDgzNDNhNmMxNjJhMzI5ODJlNjMyYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlJ0X1gFqTU1MDIwNzg2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b4a81b538ede5b37a48343a6c162a32982e632b9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b4a81b538ede5b37a48343a6c162a32982e632b9", "committedDate": "2020-12-11T11:16:48Z", "message": "verify LRU cache expires aggregates when limit is exceeded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39578d76ce1373c533f4963fb7620b91762416c1", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/39578d76ce1373c533f4963fb7620b91762416c1", "committedDate": "2020-12-11T11:19:24Z", "message": "make histograms final"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10a44f337e4a111cd0b7c34aece5b3d07ab6b555", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/10a44f337e4a111cd0b7c34aece5b3d07ab6b555", "committedDate": "2020-12-11T11:41:24Z", "message": "test hit counts include errors, but ok latencies exclude errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "838afaed3dbb061e39cd6deb6484fe0ec37ce4ba", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/838afaed3dbb061e39cd6deb6484fe0ec37ce4ba", "committedDate": "2020-12-11T11:49:52Z", "message": "verify unmeasured top level spans have metrics calculated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5292e06f405f1bae3e12c3a1fe358ff44a246433", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5292e06f405f1bae3e12c3a1fe358ff44a246433", "committedDate": "2020-12-11T11:52:16Z", "message": "repair dormant integration test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMDcwNjgw", "url": "https://github.com/DataDog/dd-trace-java/pull/2192#pullrequestreview-550070680", "createdAt": "2020-12-11T12:51:19Z", "commit": {"oid": "11155a8d9f13b631cecada13f7c7c6928f5adab4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMjo1MToyMFrOID3cdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMjo1MToyMFrOID3cdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkyNTA0NQ==", "bodyText": "Within the context of writer.format buffer resizes can be managed", "url": "https://github.com/DataDog/dd-trace-java/pull/2192#discussion_r540925045", "createdAt": "2020-12-11T12:51:20Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/metrics/SerializingMetricWriter.java", "diffHunk": "@@ -71,41 +73,58 @@ public void startBucket(int metricCount, long start, long duration) {\n \n   @Override\n   public void add(MetricKey key, AggregateMetric aggregate) {\n-    writer.startMap(10);\n+    writer.format(\n+        new Metric(key, aggregate),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11155a8d9f13b631cecada13f7c7c6928f5adab4"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f8bbeb1c366a21739a251e71364bc396332d631", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5f8bbeb1c366a21739a251e71364bc396332d631", "committedDate": "2020-12-11T13:16:46Z", "message": "add footprint test for aggregates storage, fix bug uncovered in SerializingMetricWriter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11155a8d9f13b631cecada13f7c7c6928f5adab4", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/11155a8d9f13b631cecada13f7c7c6928f5adab4", "committedDate": "2020-12-11T12:49:24Z", "message": "add footprint test for aggregates storage, fix bug uncovered in SerializingMetricWriter"}, "afterCommit": {"oid": "5f8bbeb1c366a21739a251e71364bc396332d631", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5f8bbeb1c366a21739a251e71364bc396332d631", "committedDate": "2020-12-11T13:16:46Z", "message": "add footprint test for aggregates storage, fix bug uncovered in SerializingMetricWriter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMTcxNTIx", "url": "https://github.com/DataDog/dd-trace-java/pull/2192#pullrequestreview-550171521", "createdAt": "2020-12-11T14:58:25Z", "commit": {"oid": "b4a81b538ede5b37a48343a6c162a32982e632b9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNDo1ODoyNVrOID8avg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNDo1ODoyNVrOID8avg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAwNjUyNg==", "bodyText": "Oh, sneaky.", "url": "https://github.com/DataDog/dd-trace-java/pull/2192#discussion_r541006526", "createdAt": "2020-12-11T14:58:25Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/metrics/Aggregator.java", "diffHunk": "@@ -36,7 +36,7 @@\n     this.writer = writer;\n     this.batchPool = batchPool;\n     this.inbox = inbox;\n-    this.aggregates = new LRUCache<>(maxAggregates, 0.75f, maxAggregates * 4 / 3);\n+    this.aggregates = new LRUCache<>(maxAggregates * 4 / 3, 0.75f, maxAggregates);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4a81b538ede5b37a48343a6c162a32982e632b9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMjA3ODY5", "url": "https://github.com/DataDog/dd-trace-java/pull/2192#pullrequestreview-550207869", "createdAt": "2020-12-11T15:38:47Z", "commit": {"oid": "5f8bbeb1c366a21739a251e71364bc396332d631"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2742, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}