{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MTQzMjQy", "number": 1952, "title": "Remove WeakReference tracking from PendingTrace", "bodyText": "This means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required.", "createdAt": "2020-10-05T22:03:38Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1952", "merged": true, "mergeCommit": {"oid": "f0f7bdc757e53786a13846fdf5218e4fce9b902a"}, "closed": true, "closedAt": "2020-10-07T16:19:16Z", "author": {"login": "tylerbenson"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPsM0-ABqjM4NDI3ODU0MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQO9PRgH2gAyNDk4MTQzMjQyOmY0ZGY0YjYyYTVmMDE5NDYyN2UzOWNkMzE1MzdhMTQ4ZjY0MGExYTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e1b311dbd3c7bb9a97a1f438878ad448a1cc4d8", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0e1b311dbd3c7bb9a97a1f438878ad448a1cc4d8", "committedDate": "2020-10-05T21:54:25Z", "message": "Remove WeakReference tracking from PendingTrace\n\nThis means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required."}, "afterCommit": {"oid": "808b2a23536c620f351c135ee2bcbccab1029c17", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/808b2a23536c620f351c135ee2bcbccab1029c17", "committedDate": "2020-10-05T23:14:42Z", "message": "Remove WeakReference tracking from PendingTrace\n\nThis means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "committedDate": "2020-10-06T14:44:51Z", "message": "Remove WeakReference tracking from PendingTrace\n\nThis means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "808b2a23536c620f351c135ee2bcbccab1029c17", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/808b2a23536c620f351c135ee2bcbccab1029c17", "committedDate": "2020-10-05T23:14:42Z", "message": "Remove WeakReference tracking from PendingTrace\n\nThis means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required."}, "afterCommit": {"oid": "06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/06e4c04897938ff56d8d3c5cbceeec67ba2eff76", "committedDate": "2020-10-06T14:44:51Z", "message": "Remove WeakReference tracking from PendingTrace\n\nThis means we rely on the delay from PendingTraceBuffer to report traces where the root span is finished but the pendingReference count is not 0. No more cleaning required."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDc3OTEy", "url": "https://github.com/DataDog/dd-trace-java/pull/1952#pullrequestreview-503077912", "createdAt": "2020-10-06T15:15:15Z", "commit": {"oid": "06e4c04897938ff56d8d3c5cbceeec67ba2eff76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxNToxNVrOHdMpOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxNToxNVrOHdMpOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NzkxMw==", "bodyText": "Now that there is no reference, should we change the name of expiredReference?", "url": "https://github.com/DataDog/dd-trace-java/pull/1952#discussion_r500377913", "createdAt": "2020-10-06T15:15:15Z", "author": {"login": "dougqh"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -250,30 +201,16 @@ long oldestFinishedTime() {\n    */\n   @Override\n   public void registerContinuation(final AgentScope.Continuation continuation) {\n-    synchronized (continuation) {\n-      if (!continuation.isRegistered()) {\n-        weakContinuations.add(continuation.register(continuationReferenceQueue));\n-        final int count = pendingReferenceCount.incrementAndGet();\n-        if (log.isDebugEnabled()) {\n-          log.debug(\n-              \"t_id={} -> registered continuation {} -- count = {}\", traceId, continuation, count);\n-        }\n-      } else {\n-        log.debug(\"continuation {} already registered in trace {}\", continuation, traceId);\n-      }\n+    final int count = pendingReferenceCount.incrementAndGet();\n+    if (log.isDebugEnabled()) {\n+      log.debug(\n+          \"t_id={} -> registered continuation {} -- count = {}\", traceId, continuation, count);\n     }\n   }\n \n   @Override\n   public void cancelContinuation(final AgentScope.Continuation continuation) {\n-    synchronized (continuation) {\n-      if (continuation.isRegistered()) {\n-        continuation.cancel(weakContinuations);\n-        expireReference(false);\n-      } else {\n-        log.debug(\"t_id={} -> not registered in trace: {}\", traceId, continuation);\n-      }\n-    }\n+    expireReference(false);\n   }\n \n   private void expireReference(boolean isRootSpan) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e4c04897938ff56d8d3c5cbceeec67ba2eff76"}, "originalPosition": 167}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3361392a9b80dc3f222bb8c708abb84540191084", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3361392a9b80dc3f222bb8c708abb84540191084", "committedDate": "2020-10-06T15:47:59Z", "message": "Update method name and revapi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTkwOTYy", "url": "https://github.com/DataDog/dd-trace-java/pull/1952#pullrequestreview-503990962", "createdAt": "2020-10-07T15:14:43Z", "commit": {"oid": "3361392a9b80dc3f222bb8c708abb84540191084"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxNDo0M1rOHd4bYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxNDo0M1rOHd4bYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA5NTI2NA==", "bodyText": "let's bin revapi already", "url": "https://github.com/DataDog/dd-trace-java/pull/1952#discussion_r501095264", "createdAt": "2020-10-07T15:14:43Z", "author": {"login": "richardstartin"}, "path": ".palantir/revapi.yml", "diffHunk": "@@ -759,6 +759,12 @@ acceptedBreaks:\n       old: \"method E java.util.concurrent.ConcurrentLinkedDeque<E>::removeLast() @\\\n         \\ datadog.trace.core.PendingTrace\"\n       justification: \"encapsulate PendingTrace better\"\n+    - code: \"java.method.removed\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3361392a9b80dc3f222bb8c708abb84540191084"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTkxNTIx", "url": "https://github.com/DataDog/dd-trace-java/pull/1952#pullrequestreview-503991521", "createdAt": "2020-10-07T15:15:19Z", "commit": {"oid": "3361392a9b80dc3f222bb8c708abb84540191084"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDE0NTM3", "url": "https://github.com/DataDog/dd-trace-java/pull/1952#pullrequestreview-504014537", "createdAt": "2020-10-07T15:38:11Z", "commit": {"oid": "3361392a9b80dc3f222bb8c708abb84540191084"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4df4b62a5f0194627e39cd31537a148f640a1a4", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f4df4b62a5f0194627e39cd31537a148f640a1a4", "committedDate": "2020-10-07T15:45:35Z", "message": "Merge branch 'master' into tyler/remove-weakref-pendingtrace\n\n# Conflicts:\n#\tdd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2927, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}