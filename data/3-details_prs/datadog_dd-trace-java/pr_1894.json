{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTkzOTYx", "number": 1894, "title": "More ContinuableScopeManager fixes", "bodyText": "Followup to #1889 :\n\nReplaced Array with ArrayDeque to simplify code\ncontinuation.cancel() could throw (via a TraceInterceptor) leaving the stack in a bad state\nClosing a multi-activated scope out of order with strict mode enabled could leave the stack in a bad state", "createdAt": "2020-09-21T22:31:22Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1894", "merged": true, "mergeCommit": {"oid": "c731182ec25ede0308660f288458109d31f7162a"}, "closed": true, "closedAt": "2020-09-22T15:14:41Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLLB5nAH2gAyNDkwNTkzOTYxOjE2NjEyODY2Zjg1OWZmNjAwYWNiYTA1YzhjODY1MTAxOTI5NTM0NmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLXwH9gFqTQ5MzQ0MTU1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16612866f859ff600acba05c8c8651019295346a", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/16612866f859ff600acba05c8c8651019295346a", "committedDate": "2020-09-21T22:21:26Z", "message": "Change array to ArrayDeque"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7e31720153734d25cb33f03d90327a5235ffbce4", "committedDate": "2020-09-21T22:22:16Z", "message": "More fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDQwNTIw", "url": "https://github.com/DataDog/dd-trace-java/pull/1894#pullrequestreview-493040520", "createdAt": "2020-09-21T23:08:53Z", "commit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMzowODo1M1rOHVlcUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMzowODo1M1rOHVlcUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM5NTYwMQ==", "bodyText": "So now, we're reporting even when the ref count isn't zero and the item isn't on top.\nGood, I left that alone originally to keep the change minimal, but I always thought that was wrong.", "url": "https://github.com/DataDog/dd-trace-java/pull/1894#discussion_r492395601", "createdAt": "2020-09-21T23:08:53Z", "author": {"login": "dougqh"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -170,15 +168,16 @@ public void close() {\n         }\n       }\n \n+      final boolean alive = decrementReferences();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDQxMTUx", "url": "https://github.com/DataDog/dd-trace-java/pull/1894#pullrequestreview-493041151", "createdAt": "2020-09-21T23:10:36Z", "commit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTU3Mjg5", "url": "https://github.com/DataDog/dd-trace-java/pull/1894#pullrequestreview-493157289", "createdAt": "2020-09-22T06:31:50Z", "commit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjozMTo1MFrOHVr0bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjozMTo1MFrOHVr0bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwMDA3OQ==", "bodyText": "Nice doing the cleanup before we potentially call the code that is not under our control.", "url": "https://github.com/DataDog/dd-trace-java/pull/1894#discussion_r492500079", "createdAt": "2020-09-22T06:31:50Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -170,15 +168,16 @@ public void close() {\n         }\n       }\n \n+      final boolean alive = decrementReferences();\n       if (alive) {\n         return;\n       }\n \n+      scopeStack.cleanup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDIyNTUx", "url": "https://github.com/DataDog/dd-trace-java/pull/1894#pullrequestreview-493422551", "createdAt": "2020-09-22T12:49:36Z", "commit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMjo0OTozNlrOHV4YOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMjo0OTozNlrOHV4YOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwNTg0OA==", "bodyText": "+1, hiding all that list management complexity makes every usage of this clearer.", "url": "https://github.com/DataDog/dd-trace-java/pull/1894#discussion_r492705848", "createdAt": "2020-09-22T12:49:36Z", "author": {"login": "arkban"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -258,27 +257,17 @@ public void afterActivated() {\n    * cleanup() is called to ensure the invariant\n    */\n   static final class ScopeStack {\n-    private static final int MIN_STACK_LENGTH = 16;\n-\n-    ContinuableScope[] stack = new ContinuableScope[MIN_STACK_LENGTH];\n-    // The position of the top-most scope guaranteed to be active\n-    // 0 if empty\n-    int topPos = 0;\n+    private final ArrayDeque<ContinuableScope> stack = new ArrayDeque<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDQxNTU3", "url": "https://github.com/DataDog/dd-trace-java/pull/1894#pullrequestreview-493441557", "createdAt": "2020-09-22T13:10:47Z", "commit": {"oid": "7e31720153734d25cb33f03d90327a5235ffbce4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3143, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}