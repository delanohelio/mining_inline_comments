{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MzU3MTU3", "number": 1595, "title": "Fix Spring handler mapping affecting character encoding", "bodyText": "Problem\nHandlerMappingResourceNameFilter was injected before the entire FilterChain.  This was so that if a filter handled a request instead of a controller, the correctly tagged spans were still generated.\nOne unintended side effect was that in certain configurations, HMRNF set the character encoding to the servlet container default.   SetCharacterEncodingFilter is responsible for setting the character encoding but HMRNF ran before all filters.  HMRNF's use of mapping.getHandler() forced the lazy evaluation.\nThis is highlighted in the test character encoding of #testPassword test\nSolution\nInstead of running specially, HandlerMappingResourceNameFilter is injected into the WebApplicationContext and loaded as any other filter.  It has a a precedence of HIGHEST_PRECEDENCE + 1 so it will run directly after all items with highest precedence.  The dispatcher servlet injection is still used to set the handler mappings on the filter.", "createdAt": "2020-06-16T17:15:17Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1595", "merged": true, "mergeCommit": {"oid": "c452b7b858ee316b4fdd7ba44f9afd8a9b143de4"}, "closed": true, "closedAt": "2020-06-19T15:21:05Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr4IahAH2gAyNDM1MzU3MTU3OmY4NzE1ZjA0NTEzZTRmMTQyZWM1MzM5YjI2OGVmNTk1ZDc2MDhlOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsljSjgFqTQzMzY2ODYwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f8715f04513e4f142ec5339b268ef595d7608e92", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f8715f04513e4f142ec5339b268ef595d7608e92", "committedDate": "2020-06-16T16:48:42Z", "message": "Add failing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe5c4674d56f1322ba467606b6a3c6aadcae26db", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fe5c4674d56f1322ba467606b6a3c6aadcae26db", "committedDate": "2020-06-16T16:48:42Z", "message": "Inject HandlerMappingResourceNameFilter as a real filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c9c8d97f651166099c0b2f4d03c176b425ab7f", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/22c9c8d97f651166099c0b2f4d03c176b425ab7f", "committedDate": "2020-06-16T16:48:42Z", "message": "Exclude context from ignores"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODAwOTc4", "url": "https://github.com/DataDog/dd-trace-java/pull/1595#pullrequestreview-431800978", "createdAt": "2020-06-16T18:51:59Z", "commit": {"oid": "22c9c8d97f651166099c0b2f4d03c176b425ab7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODo1MTo1OVrOGko4gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODo1MTo1OVrOGko4gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MTc0Ng==", "bodyText": "Can we put the equals matchers into a set and replace the conditions with set.contains(name) when they grow long like this??", "url": "https://github.com/DataDog/dd-trace-java/pull/1595#discussion_r441071746", "createdAt": "2020-06-16T18:51:59Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/AdditionalLibraryIgnoresMatcher.java", "diffHunk": "@@ -100,7 +100,11 @@ public boolean matches(final T target) {\n             || name.startsWith(\n                 \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer$\")\n             || name.equals(\n-                \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")) {\n+                \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22c9c8d97f651166099c0b2f4d03c176b425ab7f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODA0NzAw", "url": "https://github.com/DataDog/dd-trace-java/pull/1595#pullrequestreview-431804700", "createdAt": "2020-06-16T18:57:21Z", "commit": {"oid": "22c9c8d97f651166099c0b2f4d03c176b425ab7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODo1NzoyMVrOGkpDjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODo1NzoyMVrOGkpDjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NDU3Mw==", "bodyText": "safeHasSuperType(namedOneOf(\"org.springframework.context.support.AbstractApplicationContext\", \"org.springframework.web.context.WebApplicationContext\"))?", "url": "https://github.com/DataDog/dd-trace-java/pull/1595#discussion_r441074573", "createdAt": "2020-06-16T18:57:21Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/spring-webmvc-3.1/src/main/java/datadog/trace/instrumentation/springweb/WebApplicationContextInstrumentation.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package datadog.trace.instrumentation.springweb;\n+\n+import static datadog.trace.agent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.DDElementMatchers.extendsClass;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.DDElementMatchers.implementsInterface;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;\n+\n+@AutoService(Instrumenter.class)\n+public class WebApplicationContextInstrumentation extends Instrumenter.Default {\n+  public WebApplicationContextInstrumentation() {\n+    super(\"spring-web\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    // Optimization for expensive typeMatcher.\n+    return hasClassesNamed(\n+        \"org.springframework.context.support.AbstractApplicationContext\",\n+        \"org.springframework.web.context.WebApplicationContext\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return extendsClass(named(\"org.springframework.context.support.AbstractApplicationContext\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22c9c8d97f651166099c0b2f4d03c176b425ab7f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "043b87d1e72b6146f63bd0e6a429b4b1ccb30ff3", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/043b87d1e72b6146f63bd0e6a429b4b1ccb30ff3", "committedDate": "2020-06-17T18:17:59Z", "message": "Check for existence of the filter because getBean() throws"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83ac439581fed6d6e612dd01d4f8dad8c6e6cb07", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/83ac439581fed6d6e612dd01d4f8dad8c6e6cb07", "committedDate": "2020-06-17T18:18:19Z", "message": "Add helper classes to injection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e693c4ecc2ea069c77f780db1388ac91e45fac4", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5e693c4ecc2ea069c77f780db1388ac91e45fac4", "committedDate": "2020-06-18T21:09:11Z", "message": "Register HMRNF via bean definition instead of singleton bean"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjY4NjAy", "url": "https://github.com/DataDog/dd-trace-java/pull/1595#pullrequestreview-433668602", "createdAt": "2020-06-18T21:43:47Z", "commit": {"oid": "5e693c4ecc2ea069c77f780db1388ac91e45fac4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2178, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}