{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMTExODAy", "number": 1493, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MTo1MVrOD_De0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMDoyMDo1MlrOD_D8CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDQzOTIwOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MTo1MVrOGZiDRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MTo1MVrOGZiDRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyNTQ3OQ==", "bodyText": "This is the main change.", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r429425479", "createdAt": "2020-05-22T19:41:51Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -249,8 +260,18 @@ private synchronized void write() {\n   public synchronized boolean clean() {\n     Reference ref;\n     int count = 0;\n-    while ((ref = referenceQueue.poll()) != null) {\n-      weakReferences.remove(ref);\n+    while ((ref = continuationReferenceQueue.poll()) != null) {\n+      weakContinuations.remove(ref);\n+      count++;\n+      expireReference();\n+    }\n+    if (count > 0) {\n+      log.debug(\"t_id={} -> {} unfinished continuations garbage collected.\", traceId, count);\n+    }\n+\n+    count = 0;\n+    while ((ref = spanReferenceQueue.poll()) != null) {\n+      weakSpans.remove(ref);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a5e58ea4e40b7ea6b5f6774ca09efeae8d67b30"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDQ0MDMzOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/test/groovy/datadog/trace/core/PendingTraceTest.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MjoyMFrOGZiD9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MjoyMFrOGZiD9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyNTY1Mg==", "bodyText": "I did confirm this test failed without my change.", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r429425652", "createdAt": "2020-05-22T19:42:20Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/PendingTraceTest.groovy", "diffHunk": "@@ -119,20 +121,51 @@ class PendingTraceTest extends DDSpecification {\n \n     then:\n     trace.pendingReferenceCount.get() == 0\n-    trace.weakReferences.size() == 0\n+    trace.weakSpans.size() == 0\n     trace.asList() == [rootSpan]\n     writer == []\n     writer.traceCount.get() == 1\n     !PendingTrace.SPAN_CLEANER.get().pendingTraces.contains(trace)\n   }\n \n+  @Timeout(value = 60, unit = TimeUnit.SECONDS)\n+  def \"trace is still reported when unfinished continuation discarded\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a5e58ea4e40b7ea6b5f6774ca09efeae8d67b30"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDUxNDAwOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMDoyMDo1MlrOGZiyDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNToxOTozN1rOGajRoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzNzQ1NA==", "bodyText": "Instead of using a second reference queue, could we write the trace when all spans are finished?", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r429437454", "createdAt": "2020-05-22T20:20:52Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -44,9 +44,13 @@ static PendingTrace create(final CoreTracer tracer, final BigInteger traceId) {\n   /** Nano second ticks value at trace start */\n   private final long startNanoTicks;\n \n-  private final ReferenceQueue referenceQueue = new ReferenceQueue();\n-  private final Set<WeakReference<?>> weakReferences =\n-      Collections.newSetFromMap(new ConcurrentHashMap<WeakReference<?>, Boolean>());\n+  private final ReferenceQueue spanReferenceQueue = new ReferenceQueue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85a3bd61cc0fb446404edf67e79eff4919c53c08"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MTkwNQ==", "bodyText": "Yes, that would be simpler.  That's effectively our current semantic guarantee anyway.", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r429451905", "createdAt": "2020-05-22T21:08:31Z", "author": {"login": "dougqh"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -44,9 +44,13 @@ static PendingTrace create(final CoreTracer tracer, final BigInteger traceId) {\n   /** Nano second ticks value at trace start */\n   private final long startNanoTicks;\n \n-  private final ReferenceQueue referenceQueue = new ReferenceQueue();\n-  private final Set<WeakReference<?>> weakReferences =\n-      Collections.newSetFromMap(new ConcurrentHashMap<WeakReference<?>, Boolean>());\n+  private final ReferenceQueue spanReferenceQueue = new ReferenceQueue();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzNzQ1NA=="}, "originalCommit": {"oid": "85a3bd61cc0fb446404edf67e79eff4919c53c08"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1NTQ3NQ==", "bodyText": "The problem is, we may have spans added to an existing trace even after all other spans are complete.", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r429455475", "createdAt": "2020-05-22T21:20:30Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -44,9 +44,13 @@ static PendingTrace create(final CoreTracer tracer, final BigInteger traceId) {\n   /** Nano second ticks value at trace start */\n   private final long startNanoTicks;\n \n-  private final ReferenceQueue referenceQueue = new ReferenceQueue();\n-  private final Set<WeakReference<?>> weakReferences =\n-      Collections.newSetFromMap(new ConcurrentHashMap<WeakReference<?>, Boolean>());\n+  private final ReferenceQueue spanReferenceQueue = new ReferenceQueue();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzNzQ1NA=="}, "originalCommit": {"oid": "85a3bd61cc0fb446404edf67e79eff4919c53c08"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5NDExMw==", "bodyText": "I know this is already merged but I don't think that any spans that start after the root span tree has finished should semantically block reporting of the trace. Its possible there are cases that this isn't true, queue consumption maybe, but I think in the case of http/rpc once the root span tree is finished we should be ok to report", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r430494113", "createdAt": "2020-05-26T15:19:37Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -44,9 +44,13 @@ static PendingTrace create(final CoreTracer tracer, final BigInteger traceId) {\n   /** Nano second ticks value at trace start */\n   private final long startNanoTicks;\n \n-  private final ReferenceQueue referenceQueue = new ReferenceQueue();\n-  private final Set<WeakReference<?>> weakReferences =\n-      Collections.newSetFromMap(new ConcurrentHashMap<WeakReference<?>, Boolean>());\n+  private final ReferenceQueue spanReferenceQueue = new ReferenceQueue();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzNzQ1NA=="}, "originalCommit": {"oid": "85a3bd61cc0fb446404edf67e79eff4919c53c08"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 168, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}