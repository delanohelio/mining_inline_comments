{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MDI0OTY0", "number": 2113, "title": "simplify tag interceptors", "bodyText": "", "createdAt": "2020-11-23T22:08:49Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2113", "merged": true, "mergeCommit": {"oid": "1176f7edb0210c8000a24334157267f9dcd61c09"}, "closed": true, "closedAt": "2020-11-30T18:23:28Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfnedHgFqTUzNzM2NzY3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhpbiFgFqTU0MTE2ODcyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MzY3Njc4", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-537367678", "createdAt": "2020-11-24T10:48:27Z", "commit": {"oid": "fd96b76cbaa94d5786135e6f5a62330a9cdf2da6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODY3MTk1", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-537867195", "createdAt": "2020-11-24T20:10:55Z", "commit": {"oid": "fd96b76cbaa94d5786135e6f5a62330a9cdf2da6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd96b76cbaa94d5786135e6f5a62330a9cdf2da6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fd96b76cbaa94d5786135e6f5a62330a9cdf2da6", "committedDate": "2020-11-23T22:08:25Z", "message": "simplify tag interceptors"}, "afterCommit": {"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cfc4a253ed73ea18ac0aa927eefca613a8ba787a", "committedDate": "2020-11-26T16:43:04Z", "message": "simplify tag interceptors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDU5NjQ0", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539459644", "createdAt": "2020-11-26T16:46:50Z", "commit": {"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo0Njo1MFrOH6ibtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo0Njo1MFrOH6ibtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE0MzYwNg==", "bodyText": "this use case no longer exists, and hasn't existed since April/May", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531143606", "createdAt": "2020-11-26T16:46:50Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/taginterceptor/TagInterceptorTest.groovy", "diffHunk": "@@ -31,23 +31,6 @@ class TagInterceptorTest extends DDSpecification {\n     span = SpanFactory.newSpanOf(tracer)\n   }\n \n-  def \"adding span personalisation using Decorators\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDU5ODEy", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539459812", "createdAt": "2020-11-26T16:47:08Z", "commit": {"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo0NzowOFrOH6icMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo0NzowOFrOH6icMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE0MzczMA==", "bodyText": "now we add the splitting tag into a set", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531143730", "createdAt": "2020-11-26T16:47:08Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/taginterceptor/TagInterceptorTest.groovy", "diffHunk": "@@ -174,16 +157,14 @@ class TagInterceptorTest extends DDSpecification {\n   }\n \n   static createSplittingTracer(tag) {\n-    def tracer = CoreTracer.builder()\n+    return CoreTracer.builder()\n       .serviceName(\"my-service\")\n       .writer(new LoggingWriter())\n       .sampler(new AllSampler())\n-      .build()\n-\n     // equivalent to split-by-tags: tag\n-    tracer.addTagInterceptor(new ServiceNameTagInterceptor(tag, true))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDYwMDk5", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539460099", "createdAt": "2020-11-26T16:47:38Z", "commit": {"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo0NzozOFrOH6idIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo0NzozOFrOH6idIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE0Mzk2OQ==", "bodyText": "maintain legacy names (difficult to respect the old names now though)", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531143969", "createdAt": "2020-11-26T16:47:38Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/taginterceptor/TagInterceptorTest.groovy", "diffHunk": "@@ -434,16 +415,16 @@ class TagInterceptorTest extends DDSpecification {\n     span.getServiceName() == enabled ? \"other-service\" : \"some-service\"\n \n     where:\n-    decorator                                               | enabled\n-    ServiceNameTagInterceptor.getSimpleName().toLowerCase() | true\n-    ServiceNameTagInterceptor.getSimpleName()               | true\n-    ServiceNameTagInterceptor.getSimpleName().toLowerCase() | false\n-    ServiceNameTagInterceptor.getSimpleName()               | false\n+    decorator                   | enabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfc4a253ed73ea18ac0aa927eefca613a8ba787a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cfc4a253ed73ea18ac0aa927eefca613a8ba787a", "committedDate": "2020-11-26T16:43:04Z", "message": "simplify tag interceptors"}, "afterCommit": {"oid": "5b89db6439c9f3c92aa54f5a1b8b23f105a9f8fc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5b89db6439c9f3c92aa54f5a1b8b23f105a9f8fc", "committedDate": "2020-11-26T16:59:49Z", "message": "simplify tag interceptors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b89db6439c9f3c92aa54f5a1b8b23f105a9f8fc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5b89db6439c9f3c92aa54f5a1b8b23f105a9f8fc", "committedDate": "2020-11-26T16:59:49Z", "message": "simplify tag interceptors"}, "afterCommit": {"oid": "0a9d40c613f3faf79fd43ff6477e9b0188acb4f4", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0a9d40c613f3faf79fd43ff6477e9b0188acb4f4", "committedDate": "2020-11-26T18:43:35Z", "message": "dodge the unsafeTags lock where possible"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4390e29471b10b7d4b25a2fea38c3dd259d7e5ad", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4390e29471b10b7d4b25a2fea38c3dd259d7e5ad", "committedDate": "2020-11-26T19:10:18Z", "message": "replace DBResourceNameRule with tag interception, refactor mongo instrumentation not to set db.statement (which duplicates its resource name)"}, "afterCommit": {"oid": "f5a360408739a9af75430e492c7cf12cf3e44c8d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f5a360408739a9af75430e492c7cf12cf3e44c8d", "committedDate": "2020-11-26T19:17:01Z", "message": "move ResourceNameRule to tag interception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTE5ODc5", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539519879", "createdAt": "2020-11-26T19:18:23Z", "commit": {"oid": "f5a360408739a9af75430e492c7cf12cf3e44c8d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToxODoyNFrOH6lq7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToxODoyNFrOH6lq7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5NjY1NA==", "bodyText": "This just duplicates data and mongo queries can be very large", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531196654", "createdAt": "2020-11-26T19:18:24Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/mongo/driver-3.1/src/test/groovy/MongoClientTest.groovy", "diffHunk": "@@ -251,9 +251,6 @@ class MongoClientTest extends MongoBaseTest {\n         \"$Tags.PEER_HOSTNAME\" \"localhost\"\n         \"$Tags.PEER_HOST_IPV4\" \"127.0.0.1\"\n         \"$Tags.PEER_PORT\" port\n-        \"$Tags.DB_STATEMENT\" {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5a360408739a9af75430e492c7cf12cf3e44c8d"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5a360408739a9af75430e492c7cf12cf3e44c8d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f5a360408739a9af75430e492c7cf12cf3e44c8d", "committedDate": "2020-11-26T19:17:01Z", "message": "move ResourceNameRule to tag interception"}, "afterCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d6e5757396a57497426d8e3ec9c430082fbcafbd", "committedDate": "2020-11-26T19:19:22Z", "message": "move ResourceNameRule to tag interception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTIwMzM3", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539520337", "createdAt": "2020-11-26T19:19:50Z", "commit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToxOTo1MVrOH6lsyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToxOTo1MVrOH6lsyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5NzEyOA==", "bodyText": "Removing data duplication", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531197128", "createdAt": "2020-11-26T19:19:51Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/mongo/driver-4/src/test/groovy/Mongo4ClientTest.groovy", "diffHunk": "@@ -246,9 +246,6 @@ class Mongo4ClientTest extends MongoBaseTest {\n         \"$Tags.PEER_HOSTNAME\" \"localhost\"\n         \"$Tags.PEER_HOST_IPV4\" \"127.0.0.1\"\n         \"$Tags.PEER_PORT\" port\n-        \"$Tags.DB_STATEMENT\" {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTIwODA2", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539520806", "createdAt": "2020-11-26T19:21:20Z", "commit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyMToyMFrOH6luhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyMToyMFrOH6luhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5NzU3NA==", "bodyText": "These names all derive from the simple class names which were used as config at some point in the past. As to whether these are really used, we'll never know, but the names have been changed without notice or mention in release notes in the past, so this configurability may or may not be important to maintain.", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531197574", "createdAt": "2020-11-26T19:21:20Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/taginterceptor/RuleFlags.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package datadog.trace.core.taginterceptor;\n+\n+import datadog.trace.api.Config;\n+\n+public class RuleFlags {\n+\n+  public enum Feature {\n+    RESOURCE_NAME(\"ResourceNameRule\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTIxMTEx", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539521111", "createdAt": "2020-11-26T19:22:20Z", "commit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyMjoyMFrOH6lvlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyMjoyMFrOH6lvlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5Nzg0Ng==", "bodyText": "All tag interception logic is now encapsulated in this class. If you want to know what will happen to a tag, step away from the debugger and just look here...", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531197846", "createdAt": "2020-11-26T19:22:20Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/taginterceptor/TagInterceptor.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package datadog.trace.core.taginterceptor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTIxMjcx", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539521271", "createdAt": "2020-11-26T19:22:51Z", "commit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyMjo1MVrOH6lwJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyMjo1MVrOH6lwJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5Nzk4OA==", "bodyText": "This is now handled by the mongo decorators", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531197988", "createdAt": "2020-11-26T19:22:51Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/taginterceptor/TagInterceptorTest.groovy", "diffHunk": "@@ -336,23 +316,6 @@ class TagInterceptorTest extends DDSpecification {\n     DDTags.MANUAL_DROP | \"asdf\"  | null\n   }\n \n-  def \"DBStatementAsResource should not interact on Mongo queries\"() {\n-    when:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTIyMDI1", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539522025", "createdAt": "2020-11-26T19:25:14Z", "commit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyNToxNFrOH6ly4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyNToxNFrOH6ly4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5ODY5MQ==", "bodyText": "This will probably have a decent impact on performance, because a lot of the time no lock needs to be acquired. Previously, with the hybrid tag interceptor and rules based approach, we would have to contend for the locks, possibly find some space in the map to temporarily store the tag value, and only then decide that the tag value should really have been a field all along, or that the tag value is useless.", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531198691", "createdAt": "2020-11-26T19:25:14Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -357,26 +351,14 @@ public void setMetric(final CharSequence key, final Number value) {\n    * @param value the value of the tag. tags with null values are ignored.\n    */\n   public void setTag(final String tag, final Object value) {\n-    // intercept tags we represent as fields but used to store in a weakly typed map\n-    switch (tag) {\n-      case SPAN_TYPE:\n-        if (value instanceof CharSequence) {\n-          this.spanType = (CharSequence) value;\n-        }\n-        break;\n-      case ANALYTICS_SAMPLE_RATE:\n-        Number analyticsSampleRate = getOrTryParse(value);\n-        if (null != analyticsSampleRate) {\n-          setMetric(ANALYTICS_SAMPLE_RATE, analyticsSampleRate);\n-        }\n-        break;\n-      case Tags.ERROR:\n-        setErrorFlag(Boolean.TRUE.equals(value) || Boolean.parseBoolean(String.valueOf(value)));\n-        break;\n-      default:\n-        synchronized (unsafeTags) {\n-          unsafeSetTag(tag, value);\n-        }\n+    if (null == value || \"\".equals(value)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTIyNzEw", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539522710", "createdAt": "2020-11-26T19:27:19Z", "commit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyNzoxOVrOH6l1dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxOToyNzoxOVrOH6l1dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5OTM1MA==", "bodyText": "Unrelated to this PR, but what's below is incredibly wasteful:\n      context.setAllTags(defaultSpanTags);\n      context.setAllTags(tags);\n      context.setAllTags(coreTags);\n      context.setAllTags(rootSpanTags);\nWe're passing effectively constant values through tag interceptors over and over again here.", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531199350", "createdAt": "2020-11-26T19:27:19Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/CoreTracer.java", "diffHunk": "@@ -674,30 +646,14 @@ public CoreSpanBuilder asChildOf(final AgentSpan agentSpan) {\n \n     @Override\n     public CoreSpanBuilder withTag(final String tag, final Object value) {\n-      switch (tag) {\n-        case DDTags.ANALYTICS_SAMPLE_RATE:\n-          analyticsSampleRate = getOrTryParse(value);\n-          break;\n-        case Tags.ERROR:\n-          if (Boolean.TRUE.equals(value) || Boolean.parseBoolean(String.valueOf(value))) {\n-            return withErrorFlag();\n-          }\n-          break;\n-        case DDTags.SPAN_TYPE:\n-          if (value instanceof CharSequence) {\n-            return withSpanType((CharSequence) value);\n-          }\n-          break;\n-        default:\n-          Map<String, Object> tagMap = tags;\n-          if (tagMap == null) {\n-            tags = tagMap = new LinkedHashMap<>(); // Insertion order is important\n-          }\n-          if (value == null || (value instanceof String && ((String) value).isEmpty())) {\n-            tagMap.remove(tag);\n-          } else {\n-            tagMap.put(tag, value);\n-          }\n+      Map<String, Object> tagMap = tags;\n+      if (tagMap == null) {\n+        tags = tagMap = new LinkedHashMap<>(); // Insertion order is important\n+      }\n+      if (value == null || (value instanceof String && ((String) value).isEmpty())) {\n+        tagMap.remove(tag);\n+      } else {\n+        tagMap.put(tag, value);\n       }\n       return this;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 151}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d6e5757396a57497426d8e3ec9c430082fbcafbd", "committedDate": "2020-11-26T19:19:22Z", "message": "move ResourceNameRule to tag interception"}, "afterCommit": {"oid": "27d5ba0aaa18d6ca55884b8b48eff1a1fc8e7c8f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/27d5ba0aaa18d6ca55884b8b48eff1a1fc8e7c8f", "committedDate": "2020-11-26T20:13:16Z", "message": "move ResourceNameRule to tag interception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NzUxMDIw", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-539751020", "createdAt": "2020-11-27T07:18:07Z", "commit": {"oid": "27d5ba0aaa18d6ca55884b8b48eff1a1fc8e7c8f"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzoxODowOFrOH6zSFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzoyNjozMlrOH6zczg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQxOTY3MA==", "bodyText": "Yes indeed. The whole builder mechanism needs more cleanup.", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531419670", "createdAt": "2020-11-27T07:18:08Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/CoreTracer.java", "diffHunk": "@@ -674,30 +646,14 @@ public CoreSpanBuilder asChildOf(final AgentSpan agentSpan) {\n \n     @Override\n     public CoreSpanBuilder withTag(final String tag, final Object value) {\n-      switch (tag) {\n-        case DDTags.ANALYTICS_SAMPLE_RATE:\n-          analyticsSampleRate = getOrTryParse(value);\n-          break;\n-        case Tags.ERROR:\n-          if (Boolean.TRUE.equals(value) || Boolean.parseBoolean(String.valueOf(value))) {\n-            return withErrorFlag();\n-          }\n-          break;\n-        case DDTags.SPAN_TYPE:\n-          if (value instanceof CharSequence) {\n-            return withSpanType((CharSequence) value);\n-          }\n-          break;\n-        default:\n-          Map<String, Object> tagMap = tags;\n-          if (tagMap == null) {\n-            tags = tagMap = new LinkedHashMap<>(); // Insertion order is important\n-          }\n-          if (value == null || (value instanceof String && ((String) value).isEmpty())) {\n-            tagMap.remove(tag);\n-          } else {\n-            tagMap.put(tag, value);\n-          }\n+      Map<String, Object> tagMap = tags;\n+      if (tagMap == null) {\n+        tags = tagMap = new LinkedHashMap<>(); // Insertion order is important\n+      }\n+      if (value == null || (value instanceof String && ((String) value).isEmpty())) {\n+        tagMap.remove(tag);\n+      } else {\n+        tagMap.put(tag, value);\n       }\n       return this;\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5OTM1MA=="}, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMDk5Mw==", "bodyText": "Add a comment explaining that in the file?", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531420993", "createdAt": "2020-11-27T07:22:18Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/taginterceptor/RuleFlags.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package datadog.trace.core.taginterceptor;\n+\n+import datadog.trace.api.Config;\n+\n+public class RuleFlags {\n+\n+  public enum Feature {\n+    RESOURCE_NAME(\"ResourceNameRule\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5NzU3NA=="}, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMTM1NA==", "bodyText": "Nice", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531421354", "createdAt": "2020-11-27T07:23:24Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/taginterceptor/TagInterceptor.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package datadog.trace.core.taginterceptor;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5Nzg0Ng=="}, "originalCommit": {"oid": "d6e5757396a57497426d8e3ec9c430082fbcafbd"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMjQxNA==", "bodyText": "Is there anything in the backend that relies on this tag being set?", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531422414", "createdAt": "2020-11-27T07:26:32Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/DatabaseClientDecorator.java", "diffHunk": "@@ -56,7 +56,7 @@ public AgentSpan onConnection(final AgentSpan span, final CONNECTION connection)\n \n   public AgentSpan onStatement(final AgentSpan span, final CharSequence statement) {\n     assert span != null;\n-    span.setTag(Tags.DB_STATEMENT, statement);\n+    span.setResourceName(statement);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d5ba0aaa18d6ca55884b8b48eff1a1fc8e7c8f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzQ2Mzkw", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-540346390", "createdAt": "2020-11-28T06:23:57Z", "commit": {"oid": "e6cb0f89ed5d1c7d1657b62defd9ac0a47d8f852"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQwNjoyMzo1N1rOH7SxeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQwNjoyMzo1N1rOH7SxeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTkzNTYwOA==", "bodyText": "BitSet or even just byte with masks, since we have only 7 legacy names", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#discussion_r531935608", "createdAt": "2020-11-28T06:23:57Z", "author": {"login": "lpriima"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/taginterceptor/RuleFlags.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package datadog.trace.core.taginterceptor;\n+\n+import datadog.trace.api.Config;\n+\n+public class RuleFlags {\n+\n+  public enum Feature {\n+    // These names all derive from the simple class names which\n+    // were exposed as config at some point in the past.\n+    RESOURCE_NAME(\"ResourceNameRule\"),\n+    DB_STATEMENT(\"DBStatementRule\"),\n+    FORCE_MANUAL_DROP(\"ForceManualDropTagInterceptor\"),\n+    FORCE_MANUAL_KEEP(\"ForceManualKeepTagInterceptor\"),\n+    PEER_SERVICE(\"PeerServiceTagInterceptor\"),\n+    SERVICE_NAME(\"ServiceNameTagInterceptor\"),\n+    SERVLET_CONTEXT(\"ServletContextTagInterceptor\");\n+\n+    private final String name;\n+\n+    Feature(String name) {\n+      this.name = name;\n+    }\n+  }\n+\n+  private final boolean[] flags;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6cb0f89ed5d1c7d1657b62defd9ac0a47d8f852"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93da61b5599ce96130c4b573f1fb3820703401a2", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/93da61b5599ce96130c4b573f1fb3820703401a2", "committedDate": "2020-11-30T15:40:37Z", "message": "simplify tag interceptors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb3a4e7331e5aa7874e17e0d72065ef3f67d293d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/eb3a4e7331e5aa7874e17e0d72065ef3f67d293d", "committedDate": "2020-11-30T15:40:44Z", "message": "dodge the unsafeTags lock where possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9f26d6b8a7ff64789456b243e09d7e7ccda2bb8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f9f26d6b8a7ff64789456b243e09d7e7ccda2bb8", "committedDate": "2020-11-30T15:40:45Z", "message": "replace DBResourceNameRule with tag interception, refactor mongo instrumentation not to set db.statement (which duplicates its resource name)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dddfeb75cd721c5676109a3b136430901d5bdcc0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/dddfeb75cd721c5676109a3b136430901d5bdcc0", "committedDate": "2020-11-30T15:40:45Z", "message": "move ResourceNameRule to tag interception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e73aa86da63482eea44d1aad675ab6cb24385721", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e73aa86da63482eea44d1aad675ab6cb24385721", "committedDate": "2020-11-30T15:40:45Z", "message": "add comment about provenance of config names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6cb0f89ed5d1c7d1657b62defd9ac0a47d8f852", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e6cb0f89ed5d1c7d1657b62defd9ac0a47d8f852", "committedDate": "2020-11-27T10:10:37Z", "message": "add comment about provenance of config names"}, "afterCommit": {"oid": "e73aa86da63482eea44d1aad675ab6cb24385721", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e73aa86da63482eea44d1aad675ab6cb24385721", "committedDate": "2020-11-30T15:40:45Z", "message": "add comment about provenance of config names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTQ2MDk1", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-541146095", "createdAt": "2020-11-30T17:44:03Z", "commit": {"oid": "e73aa86da63482eea44d1aad675ab6cb24385721"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTY4NzI5", "url": "https://github.com/DataDog/dd-trace-java/pull/2113#pullrequestreview-541168729", "createdAt": "2020-11-30T18:12:55Z", "commit": {"oid": "e73aa86da63482eea44d1aad675ab6cb24385721"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2872, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}