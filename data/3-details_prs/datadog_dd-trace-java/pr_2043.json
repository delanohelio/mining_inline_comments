{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMDA0NTA5", "number": 2043, "title": "MongoDB 4 driver instrumentation", "bodyText": "Covers both mongodb-driver-sync and mongodb-driver-reactivestreams clients", "createdAt": "2020-10-30T13:35:45Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2043", "merged": true, "mergeCommit": {"oid": "04c5796058f3ebf555803291e48077e7382d0141"}, "closed": true, "closedAt": "2020-11-02T09:43:13Z", "author": {"login": "mcculls"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXo4hbAFqTUyMDgwNjgyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYgzHsgFqTUyMTQ0MDAwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODA2ODIx", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#pullrequestreview-520806821", "createdAt": "2020-10-30T15:55:26Z", "commit": {"oid": "1f53b31723cf1d70bec9966330955d63bb06ec09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNTo1NToyNlrOHrVdOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNTo1NToyNlrOHrVdOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwMjM2MA==", "bodyText": "I know we do this elsewhere, but I know from experience with this driver  thatBsonDocument (having maintained a private fork) is quite heavy - every value is wrapped in a BsonValue. What we could be doing here is piping the document into a BsonWriter which writes the scrubbed value into a StringBuilder:\nScrubbingBsonWriter scrubber = new ScrubbingBsonWriter(new StringBuilder()); // implements org.bson.BsonWriter\nscrubber.pipe(new BsonDocumentReader(statement));\nCharSequence scrubbed = scrubber.getOutput()\nI have an example of how to do this sort of thing (which just prints out the attributed weight of a BSON document) here. This will be quite handy for getting the overhead of this instrumentation down.", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#discussion_r515202360", "createdAt": "2020-10-30T15:55:26Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/mongo/driver-4/src/main/java/datadog/trace/instrumentation/mongo4/Mongo4ClientDecorator.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package datadog.trace.instrumentation.mongo4;\n+\n+import com.mongodb.connection.ConnectionDescription;\n+import com.mongodb.event.CommandStartedEvent;\n+import datadog.trace.api.DDSpanTypes;\n+import datadog.trace.api.DDTags;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.DBTypeProcessingDatabaseClientDecorator;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import org.bson.BsonArray;\n+import org.bson.BsonDocument;\n+import org.bson.BsonString;\n+import org.bson.BsonValue;\n+\n+public class Mongo4ClientDecorator\n+    extends DBTypeProcessingDatabaseClientDecorator<CommandStartedEvent> {\n+\n+  public static final UTF8BytesString MONGO_QUERY = UTF8BytesString.createConstant(\"mongo.query\");\n+\n+  public static final Mongo4ClientDecorator DECORATE = new Mongo4ClientDecorator();\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"mongo\"};\n+  }\n+\n+  @Override\n+  protected String service() {\n+    return \"mongo\";\n+  }\n+\n+  @Override\n+  protected CharSequence component() {\n+    return \"java-mongo\";\n+  }\n+\n+  @Override\n+  protected CharSequence spanType() {\n+    return DDSpanTypes.MONGO;\n+  }\n+\n+  @Override\n+  protected String dbType() {\n+    return \"mongo\";\n+  }\n+\n+  @Override\n+  protected String dbUser(final CommandStartedEvent event) {\n+    return null;\n+  }\n+\n+  @Override\n+  protected String dbInstance(final CommandStartedEvent event) {\n+    return event.getDatabaseName();\n+  }\n+\n+  @Override\n+  protected String dbHostname(CommandStartedEvent event) {\n+    final ConnectionDescription connectionDescription = event.getConnectionDescription();\n+    if (connectionDescription != null) {\n+      return connectionDescription.getServerAddress().getHost();\n+    }\n+\n+    return null;\n+  }\n+\n+  public AgentSpan onStatement(final AgentSpan span, final BsonDocument statement) {\n+\n+    // scrub the Mongo command so that parameters are removed from the string\n+    final BsonDocument scrubbed = scrub(statement);\n+    final String mongoCmd = scrubbed.toString();\n+\n+    span.setTag(DDTags.RESOURCE_NAME, mongoCmd);\n+    return onStatement(span, mongoCmd);\n+  }\n+\n+  /**\n+   * The values of these mongo fields will not be scrubbed out. This allows the non-sensitive\n+   * collection names to be captured.\n+   */\n+  private static final List<String> UNSCRUBBED_FIELDS =\n+      Arrays.asList(\"ordered\", \"insert\", \"count\", \"find\", \"create\");\n+\n+  private static final BsonValue HIDDEN_CHAR = new BsonString(\"?\");\n+\n+  private static BsonDocument scrub(final BsonDocument origin) {\n+    final BsonDocument scrub = new BsonDocument();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f53b31723cf1d70bec9966330955d63bb06ec09"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODA5MDE1", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#pullrequestreview-520809015", "createdAt": "2020-10-30T15:57:52Z", "commit": {"oid": "1f53b31723cf1d70bec9966330955d63bb06ec09"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "author": {"user": {"login": "mcculls", "name": "Stuart McCulloch"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "committedDate": "2020-10-30T16:23:57Z", "message": "MongoDB 4 driver instrumentation\n\nCovers both sync and reactivestreams clients"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f53b31723cf1d70bec9966330955d63bb06ec09", "author": {"user": {"login": "mcculls", "name": "Stuart McCulloch"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1f53b31723cf1d70bec9966330955d63bb06ec09", "committedDate": "2020-10-30T14:05:17Z", "message": "Mongo4 driver requires Java 8 minimum when testing"}, "afterCommit": {"oid": "0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "author": {"user": {"login": "mcculls", "name": "Stuart McCulloch"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "committedDate": "2020-10-30T16:23:57Z", "message": "MongoDB 4 driver instrumentation\n\nCovers both sync and reactivestreams clients"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODc1MTEw", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#pullrequestreview-520875110", "createdAt": "2020-10-30T17:16:04Z", "commit": {"oid": "0f4f768654ad23eaf6ebd5bb448440d1f47e5007"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNzoxNjowNFrOHrYjvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNzoxNjowNFrOHrYjvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1MzE4MQ==", "bodyText": "This version number ideally should align with the project name.  Any reason for the mismatch?", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#discussion_r515253181", "createdAt": "2020-10-30T17:16:04Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/mongo/driver-4/driver-4.gradle", "diffHunk": "@@ -0,0 +1,36 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  // Mongo4 driver requires Java 8 minimum\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.mongodb\"\n+    module = \"mongodb-driver-core\"\n+    versions = \"[3.7,)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f4f768654ad23eaf6ebd5bb448440d1f47e5007"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDQwMDAw", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#pullrequestreview-521440000", "createdAt": "2020-11-02T09:04:13Z", "commit": {"oid": "0f4f768654ad23eaf6ebd5bb448440d1f47e5007"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3066, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}