{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5OTk2Njgy", "number": 2069, "title": "Add a routing span to vertx 3.4", "bodyText": "This supports adding a routing span to simple vertx handlers.\nVertx supports chaining of handlers for a single request. I will iterate on this in a second PR", "createdAt": "2020-11-12T16:18:29Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2069", "merged": true, "mergeCommit": {"oid": "6e4d65ff54b79fd5af196f4846b9f3670661cf39"}, "closed": true, "closedAt": "2020-11-19T18:11:47Z", "author": {"login": "devinsba"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb1AsZgBqjM5ODk1MDk4OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeFcsnABqjQwMTY3OTIzMjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a88ea2c115717034c2bab38ac5c980300ed2533", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8a88ea2c115717034c2bab38ac5c980300ed2533", "committedDate": "2020-11-12T16:15:47Z", "message": "Get most vertx tests working with a routing span in the middle"}, "afterCommit": {"oid": "3cc83465414a8d88f58376dffa798ea7a352331b", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3cc83465414a8d88f58376dffa798ea7a352331b", "committedDate": "2020-11-12T16:18:39Z", "message": "Add a routing span to vertx 3.5"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cc83465414a8d88f58376dffa798ea7a352331b", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3cc83465414a8d88f58376dffa798ea7a352331b", "committedDate": "2020-11-12T16:18:39Z", "message": "Add a routing span to vertx 3.5"}, "afterCommit": {"oid": "a59b697c9cdf3c8c0d5c8ea686442eed557a9f23", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a59b697c9cdf3c8c0d5c8ea686442eed557a9f23", "committedDate": "2020-11-12T16:44:56Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a59b697c9cdf3c8c0d5c8ea686442eed557a9f23", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a59b697c9cdf3c8c0d5c8ea686442eed557a9f23", "committedDate": "2020-11-12T16:44:56Z", "message": "Add a routing span to vertx 3.4"}, "afterCommit": {"oid": "b1ddef41f8421c4a421962196ff03982bbc92f1c", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b1ddef41f8421c4a421962196ff03982bbc92f1c", "committedDate": "2020-11-12T16:54:27Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1ddef41f8421c4a421962196ff03982bbc92f1c", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b1ddef41f8421c4a421962196ff03982bbc92f1c", "committedDate": "2020-11-12T16:54:27Z", "message": "Add a routing span to vertx 3.4"}, "afterCommit": {"oid": "e4bf4f2a6a4e40b481fb070da5a3f3f11a15d65b", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e4bf4f2a6a4e40b481fb070da5a3f3f11a15d65b", "committedDate": "2020-11-12T16:57:24Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4bf4f2a6a4e40b481fb070da5a3f3f11a15d65b", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e4bf4f2a6a4e40b481fb070da5a3f3f11a15d65b", "committedDate": "2020-11-12T16:57:24Z", "message": "Add a routing span to vertx 3.4"}, "afterCommit": {"oid": "0632e0c10b5d4c7e404108ef34e68ea6bad9848b", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0632e0c10b5d4c7e404108ef34e68ea6bad9848b", "committedDate": "2020-11-12T17:02:03Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0632e0c10b5d4c7e404108ef34e68ea6bad9848b", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0632e0c10b5d4c7e404108ef34e68ea6bad9848b", "committedDate": "2020-11-12T17:02:03Z", "message": "Add a routing span to vertx 3.4"}, "afterCommit": {"oid": "4bc3ebbcbfeee25e8950b514df2435994258d3cb", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4bc3ebbcbfeee25e8950b514df2435994258d3cb", "committedDate": "2020-11-12T17:06:42Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4bc3ebbcbfeee25e8950b514df2435994258d3cb", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4bc3ebbcbfeee25e8950b514df2435994258d3cb", "committedDate": "2020-11-12T17:06:42Z", "message": "Add a routing span to vertx 3.4"}, "afterCommit": {"oid": "38c8428f1da4405c56d9fa26535d7321d507010f", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/38c8428f1da4405c56d9fa26535d7321d507010f", "committedDate": "2020-11-12T17:52:44Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38c8428f1da4405c56d9fa26535d7321d507010f", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/38c8428f1da4405c56d9fa26535d7321d507010f", "committedDate": "2020-11-12T17:52:44Z", "message": "Add a routing span to vertx 3.4"}, "afterCommit": {"oid": "7fe71128688b0ca3cfa99850021be5da5dea69d7", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7fe71128688b0ca3cfa99850021be5da5dea69d7", "committedDate": "2020-11-12T17:58:14Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fe71128688b0ca3cfa99850021be5da5dea69d7", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7fe71128688b0ca3cfa99850021be5da5dea69d7", "committedDate": "2020-11-12T17:58:14Z", "message": "Add a routing span to vertx 3.4"}, "afterCommit": {"oid": "d1bf8488bdf4642a7a5b1c7b471032781f205c1a", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d1bf8488bdf4642a7a5b1c7b471032781f205c1a", "committedDate": "2020-11-12T17:59:36Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1bf8488bdf4642a7a5b1c7b471032781f205c1a", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d1bf8488bdf4642a7a5b1c7b471032781f205c1a", "committedDate": "2020-11-12T17:59:36Z", "message": "Add a routing span to vertx 3.4"}, "afterCommit": {"oid": "74086f35abd5d004781eafb92ca6b0d44739f325", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/74086f35abd5d004781eafb92ca6b0d44739f325", "committedDate": "2020-11-12T19:05:20Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTYxMDg1", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#pullrequestreview-530161085", "createdAt": "2020-11-13T15:32:39Z", "commit": {"oid": "74086f35abd5d004781eafb92ca6b0d44739f325"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTozMjozOVrOHyy_Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTozMjozOVrOHyy_Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAyNjI2Nw==", "bodyText": "I'm not sure what the right way to use the routing path/regex is in this case. I don't really like the pattern of modifying one span just to start another. It's also not clear to me what the correct methods to call are", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r523026267", "createdAt": "2020-11-13T15:32:39Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package datadog.trace.instrumentation.vertx_3_4.server;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.vertx_3_4.server.VertxRouterDecorator.DECORATE;\n+import static datadog.trace.instrumentation.vertx_3_4.server.VertxRouterDecorator.INSTRUMENTATION_NAME;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.vertx.core.Handler;\n+import io.vertx.ext.web.RoutingContext;\n+\n+public class RouteHandlerWrapper implements Handler<RoutingContext> {\n+  private final Handler<RoutingContext> actual;\n+\n+  public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n+    actual = handler;\n+  }\n+\n+  @Override\n+  public void handle(final RoutingContext routingContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74086f35abd5d004781eafb92ca6b0d44739f325"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjExMzI4", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#pullrequestreview-530211328", "createdAt": "2020-11-13T16:32:43Z", "commit": {"oid": "74086f35abd5d004781eafb92ca6b0d44739f325"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjE2NDMw", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#pullrequestreview-530216430", "createdAt": "2020-11-13T16:38:18Z", "commit": {"oid": "74086f35abd5d004781eafb92ca6b0d44739f325"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "295583324b495af44f866c934d7e4611f8bad461", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/295583324b495af44f866c934d7e4611f8bad461", "committedDate": "2020-11-16T20:47:31Z", "message": "Add a routing span to vertx 3.4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c41e2a177b9bef929e919907242ce172204b05d", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5c41e2a177b9bef929e919907242ce172204b05d", "committedDate": "2020-11-16T18:26:57Z", "message": "Add path to parent span"}, "afterCommit": {"oid": "a80b1c461617ad61b583d497fbcf19974cb6dfb7", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a80b1c461617ad61b583d497fbcf19974cb6dfb7", "committedDate": "2020-11-16T20:47:31Z", "message": "Add path to parent span"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a80b1c461617ad61b583d497fbcf19974cb6dfb7", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a80b1c461617ad61b583d497fbcf19974cb6dfb7", "committedDate": "2020-11-16T20:47:31Z", "message": "Add path to parent span"}, "afterCommit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4b826545d7d2da6836c081d61bd3c96a4928eedd", "committedDate": "2020-11-17T16:55:36Z", "message": "Add path to parent span"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjc5ODYy", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#pullrequestreview-532679862", "createdAt": "2020-11-17T18:42:12Z", "commit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODo0MjoxMlrOH1D2IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODo1NDoxNlrOH1ET3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM5OTU4NA==", "bodyText": "Should this be wrapped in a scope?", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r525399584", "createdAt": "2020-11-17T18:42:12Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/EndHandlerWrapper.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package datadog.trace.instrumentation.vertx_3_4.server;\n+\n+import static datadog.trace.instrumentation.vertx_3_4.server.VertxRouterDecorator.DECORATE;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpServerResponse;\n+\n+public class EndHandlerWrapper implements Handler<Void> {\n+  private final AgentSpan span;\n+  private final HttpServerResponse response;\n+\n+  Handler<Void> actual;\n+\n+  EndHandlerWrapper(final AgentSpan span, final HttpServerResponse response) {\n+    this.span = span;\n+    this.response = response;\n+  }\n+\n+  @Override\n+  public void handle(final Void event) {\n+    if (actual != null) {\n+      actual.handle(event);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMDUxOQ==", "bodyText": "I think some comments here would be helpful.", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r525400519", "createdAt": "2020-11-17T18:43:44Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/EndHandlerWrapperAdvice.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package datadog.trace.instrumentation.vertx_3_4.server;\n+\n+import io.vertx.core.Handler;\n+import net.bytebuddy.asm.Advice;\n+\n+public class EndHandlerWrapperAdvice {\n+  @Advice.OnMethodEnter(suppress = Throwable.class)\n+  public static void wrapHandler(\n+      @Advice.FieldValue(value = \"endHandler\", readOnly = false) final Handler<Void> endHandler,\n+      @Advice.Argument(value = 0, readOnly = false) final Handler<Void> handler) {\n+    if (endHandler instanceof EndHandlerWrapper && handler instanceof EndHandlerWrapper) {\n+      return;\n+    }\n+    if (handler instanceof EndHandlerWrapper && endHandler != null) {\n+      ((EndHandlerWrapper) handler).actual = endHandler;\n+    } else if (endHandler instanceof EndHandlerWrapper) {\n+      ((EndHandlerWrapper) endHandler).actual = handler;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMjYzNQ==", "bodyText": "Is the rx project only for testing?  If so, consider putting it as a sub project to web.", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r525402635", "createdAt": "2020-11-17T18:46:55Z", "author": {"login": "tylerbenson"}, "path": "settings.gradle", "diffHunk": "@@ -184,7 +184,8 @@ include ':dd-java-agent:instrumentation:spymemcached-2.12'\n include ':dd-java-agent:instrumentation:testng-6.4'\n include ':dd-java-agent:instrumentation:trace-annotation'\n include ':dd-java-agent:instrumentation:twilio'\n-include ':dd-java-agent:instrumentation:vertx'\n+include ':dd-java-agent:instrumentation:vertx-rx-3.5'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDExOA==", "bodyText": "I don't think vertx.router is the right name here.  I think it should be something like vertx.controller or vertx.action instead.", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r525404118", "createdAt": "2020-11-17T18:49:22Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/test/groovy/server/VertxHttpServerTest.groovy", "diffHunk": "@@ -72,6 +76,40 @@ class VertxHttpServerTest extends HttpServerTest<Vertx> {\n     true\n   }\n \n+  @Override\n+  int spanCount(ServerEndpoint endpoint) {\n+    if (endpoint == NOT_FOUND) {\n+      return super.spanCount(endpoint) - 1\n+    }\n+    return super.spanCount(endpoint)\n+  }\n+\n+  @Override\n+  boolean hasHandlerSpan() {\n+    true\n+  }\n+\n+  @Override\n+  void handlerSpan(TraceAssert trace, ServerEndpoint endpoint = SUCCESS) {\n+    if (endpoint == NOT_FOUND) {\n+      return\n+    }\n+    trace.span {\n+      serviceName expectedServiceName()\n+      operationName \"vertx.router\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNjUzOA==", "bodyText": "I think it would be useful to set the span's resource name to actual's class name.", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r525406538", "createdAt": "2020-11-17T18:53:14Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package datadog.trace.instrumentation.vertx_3_4.server;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activeSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.vertx_3_4.server.VertxRouterDecorator.DECORATE;\n+import static datadog.trace.instrumentation.vertx_3_4.server.VertxRouterDecorator.INSTRUMENTATION_NAME;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.vertx.core.Handler;\n+import io.vertx.ext.web.RoutingContext;\n+\n+public class RouteHandlerWrapper implements Handler<RoutingContext> {\n+  private final Handler<RoutingContext> actual;\n+\n+  public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n+    actual = handler;\n+  }\n+\n+  @Override\n+  public void handle(final RoutingContext routingContext) {\n+    final AgentSpan parentSpan = activeSpan();\n+    DECORATE.onRequest(parentSpan, routingContext);\n+\n+    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n+    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+    DECORATE.afterStart(span);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNzE5OQ==", "bodyText": "If there's any chance of this throwing an exception, you should catch and add it to the span.", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r525407199", "createdAt": "2020-11-17T18:54:16Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package datadog.trace.instrumentation.vertx_3_4.server;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activeSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.vertx_3_4.server.VertxRouterDecorator.DECORATE;\n+import static datadog.trace.instrumentation.vertx_3_4.server.VertxRouterDecorator.INSTRUMENTATION_NAME;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.vertx.core.Handler;\n+import io.vertx.ext.web.RoutingContext;\n+\n+public class RouteHandlerWrapper implements Handler<RoutingContext> {\n+  private final Handler<RoutingContext> actual;\n+\n+  public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n+    actual = handler;\n+  }\n+\n+  @Override\n+  public void handle(final RoutingContext routingContext) {\n+    final AgentSpan parentSpan = activeSpan();\n+    DECORATE.onRequest(parentSpan, routingContext);\n+\n+    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n+    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+    DECORATE.afterStart(span);\n+\n+    try (final AgentScope scope = activateSpan(span)) {\n+      scope.setAsyncPropagation(true);\n+      actual.handle(routingContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d207584b96b4b9369d35e03eaf8c16ae35040098", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d207584b96b4b9369d35e03eaf8c16ae35040098", "committedDate": "2020-11-18T16:01:58Z", "message": "Add path to parent span"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b826545d7d2da6836c081d61bd3c96a4928eedd", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4b826545d7d2da6836c081d61bd3c96a4928eedd", "committedDate": "2020-11-17T16:55:36Z", "message": "Add path to parent span"}, "afterCommit": {"oid": "d207584b96b4b9369d35e03eaf8c16ae35040098", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d207584b96b4b9369d35e03eaf8c16ae35040098", "committedDate": "2020-11-18T16:01:58Z", "message": "Add path to parent span"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4483b9470fba8c84359425907656f61023b8d437", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4483b9470fba8c84359425907656f61023b8d437", "committedDate": "2020-11-18T18:47:59Z", "message": "Address pr comments"}, "afterCommit": {"oid": "93858a1a3d63ec6a6425b23fd39794a076e28e54", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/93858a1a3d63ec6a6425b23fd39794a076e28e54", "committedDate": "2020-11-18T18:58:40Z", "message": "Address pr comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93858a1a3d63ec6a6425b23fd39794a076e28e54", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/93858a1a3d63ec6a6425b23fd39794a076e28e54", "committedDate": "2020-11-18T18:58:40Z", "message": "Address pr comments"}, "afterCommit": {"oid": "484129d84c6fdd4c493f0a4e6531c8af7d081a06", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/484129d84c6fdd4c493f0a4e6531c8af7d081a06", "committedDate": "2020-11-18T19:23:30Z", "message": "Address pr comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODE2NzI5", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#pullrequestreview-533816729", "createdAt": "2020-11-18T19:46:36Z", "commit": {"oid": "484129d84c6fdd4c493f0a4e6531c8af7d081a06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTo0NjozNlrOH1_TAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTo0NjozNlrOH1_TAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3MzYzMg==", "bodyText": "The test was not behaving correctly when this server was written in Groovy with regards to the exception", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r526373632", "createdAt": "2020-11-18T19:46:36Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/test/java/server/VertxTestServer.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package server;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "484129d84c6fdd4c493f0a4e6531c8af7d081a06"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NTQxNDcx", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#pullrequestreview-534541471", "createdAt": "2020-11-19T15:07:32Z", "commit": {"oid": "484129d84c6fdd4c493f0a4e6531c8af7d081a06"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNTowNzozM1rOH2jFMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNTowNzozM1rOH2jFMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1OTkyMQ==", "bodyText": "you might want to put the span.finish() in a try/finally in case the handle throws an exception.", "url": "https://github.com/DataDog/dd-trace-java/pull/2069#discussion_r526959921", "createdAt": "2020-11-19T15:07:33Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/EndHandlerWrapper.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package datadog.trace.instrumentation.vertx_3_4.server;\n+\n+import static datadog.trace.instrumentation.vertx_3_4.server.VertxRouterDecorator.DECORATE;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpServerResponse;\n+\n+public class EndHandlerWrapper implements Handler<Void> {\n+  private final AgentSpan span;\n+  private final HttpServerResponse response;\n+\n+  Handler<Void> actual;\n+\n+  EndHandlerWrapper(final AgentSpan span, final HttpServerResponse response) {\n+    this.span = span;\n+    this.response = response;\n+  }\n+\n+  @Override\n+  public void handle(final Void event) {\n+    if (actual != null) {\n+      actual.handle(event);\n+    }\n+    DECORATE.onResponse(span, response);\n+    span.finish();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "484129d84c6fdd4c493f0a4e6531c8af7d081a06"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "484129d84c6fdd4c493f0a4e6531c8af7d081a06", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/484129d84c6fdd4c493f0a4e6531c8af7d081a06", "committedDate": "2020-11-18T19:23:30Z", "message": "Address pr comments"}, "afterCommit": {"oid": "d7c07049fccc0c7d642c4ea53c2dd1e3d85977c3", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d7c07049fccc0c7d642c4ea53c2dd1e3d85977c3", "committedDate": "2020-11-19T15:14:46Z", "message": "Address pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "389128b57fc804a66b3502a20261ba758b7878ea", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/389128b57fc804a66b3502a20261ba758b7878ea", "committedDate": "2020-11-19T16:17:38Z", "message": "Address pr comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7c07049fccc0c7d642c4ea53c2dd1e3d85977c3", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d7c07049fccc0c7d642c4ea53c2dd1e3d85977c3", "committedDate": "2020-11-19T15:14:46Z", "message": "Address pr comments"}, "afterCommit": {"oid": "389128b57fc804a66b3502a20261ba758b7878ea", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/389128b57fc804a66b3502a20261ba758b7878ea", "committedDate": "2020-11-19T16:17:38Z", "message": "Address pr comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2820, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}