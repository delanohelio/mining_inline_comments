{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNTU2NDE0", "number": 1569, "title": "Add container id header to profile uploads", "bodyText": "If available, we want to include the container ID as an HTTP header in the profile upload.\nContainerInfo was only used and accessible in dd-trace-core, but now we need to access it in dd-java-agent. To allow this, I've moved the ContainerInfo class to a new module (:utils:container-info).\nI didn't want to drop the coverage check on the new module, so I made a minor change to the original class and added a few tests.", "createdAt": "2020-06-10T16:03:42Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1569", "merged": true, "mergeCommit": {"oid": "b3563919101e69708fd3d94d74fa63e640084c84"}, "closed": true, "closedAt": "2020-06-12T16:57:03Z", "author": {"login": "cimi"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqe-EdgH2gAyNDMyNTU2NDE0OmYxNjJkMzFmYzkxODE4YmViYTk3ZTA4M2E5NjgwZTkxNGZhYTEzM2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqlmLCgFqTQyOTg4Njg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f162d31fc91818beba97e083a9680e914faa133d", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f162d31fc91818beba97e083a9680e914faa133d", "committedDate": "2020-06-12T08:55:51Z", "message": "Add container id header to profile uploads"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "543df0e469f4dda2f97fb215a43c6eef08c494a7", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/543df0e469f4dda2f97fb215a43c6eef08c494a7", "committedDate": "2020-06-10T15:59:07Z", "message": "Add container id header to profile uploads"}, "afterCommit": {"oid": "f162d31fc91818beba97e083a9680e914faa133d", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f162d31fc91818beba97e083a9680e914faa133d", "committedDate": "2020-06-12T08:55:51Z", "message": "Add container id header to profile uploads"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8513b0f151462a41cbbc5291dd3f03b4f44960c5", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8513b0f151462a41cbbc5291dd3f03b4f44960c5", "committedDate": "2020-06-12T10:12:05Z", "message": "Extract ContainerInfo in shared :utils:container-utils module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e703e7d680f24d493bd47ccfb674a310280ef82", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6e703e7d680f24d493bd47ccfb674a310280ef82", "committedDate": "2020-06-12T11:06:04Z", "message": "Improve ContainerInfo coverage to enable check on new module"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82c685fc36a2b48020e78627153c3ac02792c918", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/82c685fc36a2b48020e78627153c3ac02792c918", "committedDate": "2020-06-12T10:58:19Z", "message": "Improve ContainerInfo coverage to enable check on new module"}, "afterCommit": {"oid": "6e703e7d680f24d493bd47ccfb674a310280ef82", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6e703e7d680f24d493bd47ccfb674a310280ef82", "committedDate": "2020-06-12T11:06:04Z", "message": "Improve ContainerInfo coverage to enable check on new module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b2f4b20207da4b61fffa71419f9c84c2c9d47ec8", "committedDate": "2020-06-12T11:19:09Z", "message": "Add exception for API/ABI break due to ContainerInfo move"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5Njk2NDI3", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#pullrequestreview-429696427", "createdAt": "2020-06-12T12:23:24Z", "commit": {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxMjoyMzoyNFrOGjCATg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxMjoyMzoyNFrOGjCATg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM4NjE5MA==", "bodyText": "Unless I'm very much mistaken this will not get called.\nYou may want to consider moving these things into cleanup: block", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#discussion_r439386190", "createdAt": "2020-06-12T12:23:24Z", "author": {"login": "mar-kolya"}, "path": "utils/container-utils/src/test/groovy/ContainerInfoTest.groovy", "diffHunk": "@@ -144,4 +149,46 @@ class ContainerInfoTest extends DDSpecification {\n 2:memory:/ecs/55091c13-b8cf-4801-b527-f4601742204d/432624d2150b349fe35ba397284dea788c2bf66b885d14dfc1569b01890ca7da\n 1:name=systemd:/ecs/55091c13-b8cf-4801-b527-f4601742204d/432624d2150b349fe35ba397284dea788c2bf66b885d14dfc1569b01890ca7da\"\"\"\n   }\n+\n+  def \"ContainerInfo from empty file is empty\"() {\n+    when:\n+    File f = File.createTempFile(\"container-info-test-\", \"-empty-file\")\n+    f.deleteOnExit()\n+    Path p = Paths.get(f.path)\n+    ContainerInfo containerInfo = ContainerInfo.fromProcFile(p)\n+\n+\n+    then:\n+    containerInfo.getContainerId() == null\n+    containerInfo.getPodId() == null\n+    containerInfo.getCGroups().size() == 0\n+  }\n+\n+  def \"ContainerInfo throws java.text.ParseException when given malformed procfile\"() {\n+    when:\n+    File f = File.createTempFile(\"container-info-test-\", \"-malformed-file\")\n+    f.deleteOnExit()\n+    f.write(\"This is not valid\")\n+    Path p = Paths.get(f.path)\n+    ContainerInfo.fromProcFile(p)\n+    f.deleteOnExit()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NzAwNTQ1", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#pullrequestreview-429700545", "createdAt": "2020-06-12T12:30:26Z", "commit": {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxMjozMDoyNlrOGjCMLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxMjozMDoyNlrOGjCMLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM4OTIzMA==", "bodyText": "Would you be able to use a constant for header name here?", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#discussion_r439389230", "createdAt": "2020-06-12T12:30:26Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -192,6 +192,30 @@ public void testRequestParameters(final String compression)\n     assertArrayEquals(expectedBytes, uploadedBytes);\n   }\n \n+  @Test\n+  public void testRequestWithoutContainerID() throws IOException, InterruptedException {\n+    uploader = new ProfileUploader(config, null);\n+\n+    server.enqueue(new MockResponse().setResponseCode(200));\n+    uploader.upload(RECORDING_TYPE, mockRecordingData(RECORDING_RESOURCE));\n+\n+    final RecordedRequest request = server.takeRequest(5, TimeUnit.SECONDS);\n+    assertNotNull(request);\n+    assertNull(request.getHeader(\"Datadog-Container-ID\"));\n+  }\n+\n+  @Test\n+  public void testRequestWithContainerId() throws IOException, InterruptedException {\n+    uploader = new ProfileUploader(config, \"container-id\");\n+\n+    server.enqueue(new MockResponse().setResponseCode(200));\n+    uploader.upload(RECORDING_TYPE, mockRecordingData(RECORDING_RESOURCE));\n+\n+    final RecordedRequest request = server.takeRequest(5, TimeUnit.SECONDS);\n+    assertNotNull(request);\n+    assertEquals(request.getHeader(\"Datadog-Container-ID\"), \"container-id\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NzAwODY3", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#pullrequestreview-429700867", "createdAt": "2020-06-12T12:30:54Z", "commit": {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxMjozMDo1NFrOGjCNDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxMjozMDo1NFrOGjCNDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM4OTQ1Mw==", "bodyText": "I think you can fold one of these tests into testRequestParameters - which is sort of our 'happy path' test.", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#discussion_r439389453", "createdAt": "2020-06-12T12:30:54Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -192,6 +192,30 @@ public void testRequestParameters(final String compression)\n     assertArrayEquals(expectedBytes, uploadedBytes);\n   }\n \n+  @Test\n+  public void testRequestWithoutContainerID() throws IOException, InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NzAxNTY5", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#pullrequestreview-429701569", "createdAt": "2020-06-12T12:32:03Z", "commit": {"oid": "b2f4b20207da4b61fffa71419f9c84c2c9d47ec8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8d19bf70f99b0d576e3c6bc6a10c907f4484d9f", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c8d19bf70f99b0d576e3c6bc6a10c907f4484d9f", "committedDate": "2020-06-12T13:47:35Z", "message": "Replace hardcoded strings with constants in ProfileUploaderTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee8974aac6ef5f59cd3caf1a6a8c491e3ab23497", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ee8974aac6ef5f59cd3caf1a6a8c491e3ab23497", "committedDate": "2020-06-12T13:57:26Z", "message": "Remove redundant test code for container IDs in headers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5ODI4OTE0", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#pullrequestreview-429828914", "createdAt": "2020-06-12T15:19:21Z", "commit": {"oid": "ee8974aac6ef5f59cd3caf1a6a8c491e3ab23497"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNToxOToyMVrOGjH8bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNToxOToyMVrOGjH8bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MzUwMQ==", "bodyText": "This is an indication of a problem... The new module needs to be bundled in with dd-trace-ot like was done here: https://github.com/DataDog/dd-trace-java/blob/master/dd-trace-ot/dd-trace-ot.gradle#L89.\nThat should make the revapi break go away.", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#discussion_r439483501", "createdAt": "2020-06-12T15:19:21Z", "author": {"login": "tylerbenson"}, "path": ".palantir/revapi.yml", "diffHunk": "@@ -420,6 +420,9 @@ acceptedBreaks:\n       justification: \"Builder constructor was never meant to be public\"\n   \"0.54.0\":\n     com.datadoghq:dd-trace-ot:\n+    - code: \"java.class.removed\"\n+      old: \"class datadog.trace.core.ContainerInfo\"\n+      justification: \"ContainerInfo was moved to a shared module\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee8974aac6ef5f59cd3caf1a6a8c491e3ab23497"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b30dc26a525962aee760d410ed9db4afd0e1821", "author": {"user": {"login": "cimi", "name": "Alex Ciminian"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1b30dc26a525962aee760d410ed9db4afd0e1821", "committedDate": "2020-06-12T15:33:19Z", "message": "Add container-utils to dd-trace-ot, remove revapi exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5ODg2ODk2", "url": "https://github.com/DataDog/dd-trace-java/pull/1569#pullrequestreview-429886896", "createdAt": "2020-06-12T16:39:05Z", "commit": {"oid": "1b30dc26a525962aee760d410ed9db4afd0e1821"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2395, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}