{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MjM5NTY5", "number": 1994, "title": "Fail-fast manual tracer creation in presence of java agent", "bodyText": "Historically, we would allow the creation of DDTracer even when the java agent was installed.  The failure to register was noted in the logs and the application continued normally.\nRecently, creating DDTracer when the agent was installed causes java.lang.NoSuchMethodError because of class renaming.\nIn both cases, the newly created DDTracer can't be used.  This pull request changes the behavior to fail fast by throwing an exception immediately.", "createdAt": "2020-10-15T16:45:28Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1994", "merged": true, "mergeCommit": {"oid": "38e4b33c5c9aba2b225f325465ad6de571eb63db"}, "closed": true, "closedAt": "2020-10-15T19:49:44Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS0eqxAH2gAyNTA0MjM5NTY5OmQ1YWE3ZmYxZTA3ZTg5N2MzMzIyMDI2MTRhNDI3NTlhNTcyMmM5ODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS2YwPgH2gAyNTA0MjM5NTY5OmRlZTFmZTg5MDIzNjIyMjM5MTYzNzJjOGE5ZWIzMGQ1Y2MxNjY5Y2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d5aa7ff1e07e897c332202614a42759a5722c985", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d5aa7ff1e07e897c332202614a42759a5722c985", "committedDate": "2020-10-15T16:36:26Z", "message": "Fail-fast manual tracer creation in presence of agent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTc4NTA5", "url": "https://github.com/DataDog/dd-trace-java/pull/1994#pullrequestreview-509578509", "createdAt": "2020-10-15T16:49:17Z", "commit": {"oid": "d5aa7ff1e07e897c332202614a42759a5722c985"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjY2MDYx", "url": "https://github.com/DataDog/dd-trace-java/pull/1994#pullrequestreview-509666061", "createdAt": "2020-10-15T18:39:29Z", "commit": {"oid": "d5aa7ff1e07e897c332202614a42759a5722c985"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxODozOToyOVrOHiVM4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxODo0NDo0NFrOHiVY1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2MDk5NQ==", "bodyText": "Do you want to throw an assertion error after this in case it doesn't fail as expected?", "url": "https://github.com/DataDog/dd-trace-java/pull/1994#discussion_r505760995", "createdAt": "2020-10-15T18:39:29Z", "author": {"login": "tylerbenson"}, "path": "dd-smoke-tests/opentracing/src/main/java/datadog/smoketest/opentracing/IncorrectSetupWithAgentApplication.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package datadog.smoketest.opentracing;\n+\n+import datadog.opentracing.DDTracer;\n+\n+public class IncorrectSetupWithAgentApplication {\n+  public static void main(final String[] args) {\n+    try {\n+      DDTracer.builder().build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa7ff1e07e897c332202614a42759a5722c985"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2Mjg3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"Datadog Tracer already installed. NOTE: Manually creating the tracer while using the java agent is not supported\");\n          \n          \n            \n                      \"Datadog Tracer already installed by `dd-java-agent`. NOTE: Manually creating the tracer while using `dd-java-agent` is not supported\");", "url": "https://github.com/DataDog/dd-trace-java/pull/1994#discussion_r505762870", "createdAt": "2020-10-15T18:42:34Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -197,6 +198,14 @@ private DDTracer(\n       final LogHandler logHandler,\n       final StatsDClient statsDClient) {\n \n+    // Check if the tracer is already installed by the agent\n+    // Unable to use \"instanceof\" because of class renaming\n+    if (GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n+      log.warn(\n+          \"Datadog Tracer already installed. NOTE: Manually creating the tracer while using the java agent is not supported\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa7ff1e07e897c332202614a42759a5722c985"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2MzIxMw==", "bodyText": "Since we're throwing an exception, perhaps this should be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.warn(\n          \n          \n            \n                  log.error(", "url": "https://github.com/DataDog/dd-trace-java/pull/1994#discussion_r505763213", "createdAt": "2020-10-15T18:43:03Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -197,6 +198,14 @@ private DDTracer(\n       final LogHandler logHandler,\n       final StatsDClient statsDClient) {\n \n+    // Check if the tracer is already installed by the agent\n+    // Unable to use \"instanceof\" because of class renaming\n+    if (GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n+      log.warn(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa7ff1e07e897c332202614a42759a5722c985"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2Mzg5NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new RuntimeException(\"Datadog Tracer already installed\");\n          \n          \n            \n                  throw new IllegalStateException(\"Datadog Tracer already installed\");", "url": "https://github.com/DataDog/dd-trace-java/pull/1994#discussion_r505763895", "createdAt": "2020-10-15T18:44:24Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -197,6 +198,14 @@ private DDTracer(\n       final LogHandler logHandler,\n       final StatsDClient statsDClient) {\n \n+    // Check if the tracer is already installed by the agent\n+    // Unable to use \"instanceof\" because of class renaming\n+    if (GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n+      log.warn(\n+          \"Datadog Tracer already installed. NOTE: Manually creating the tracer while using the java agent is not supported\");\n+      throw new RuntimeException(\"Datadog Tracer already installed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa7ff1e07e897c332202614a42759a5722c985"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2NDA1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } catch (RuntimeException e) {\n          \n          \n            \n                } catch (IllegalStateException e) {", "url": "https://github.com/DataDog/dd-trace-java/pull/1994#discussion_r505764052", "createdAt": "2020-10-15T18:44:44Z", "author": {"login": "tylerbenson"}, "path": "dd-smoke-tests/opentracing/src/main/java/datadog/smoketest/opentracing/IncorrectSetupWithAgentApplication.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package datadog.smoketest.opentracing;\n+\n+import datadog.opentracing.DDTracer;\n+\n+public class IncorrectSetupWithAgentApplication {\n+  public static void main(final String[] args) {\n+    try {\n+      DDTracer.builder().build();\n+    } catch (RuntimeException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa7ff1e07e897c332202614a42759a5722c985"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dee1fe8902362223916372c8a9eb30d5cc1669cf", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/dee1fe8902362223916372c8a9eb30d5cc1669cf", "committedDate": "2020-10-15T18:49:47Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Tyler Benson <tyler.benson@datadoghq.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2988, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}