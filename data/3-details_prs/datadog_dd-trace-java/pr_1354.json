{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NzAyNzQw", "number": 1354, "title": "OpenTracing Split", "bodyText": "Overview\nThis pull request almost completely removes OpenTracing as a dependency for the tracer.  After this pull request is merged, the only remaining OpenTracing references are in TracerInstaller, tests related to installing the tracer, and some benchmarks.\nMethodology\ndd-trace-ot was split into 2 projects: dd-trace-ot and dd-trace-core.\ndd-trace-core: Contains all of the mechanics of span creation and publishing including sampling, propagation,.  DDSpan and others implement the agent interfaces like AgentSpan.\ndd-trace-ot: Contains the OpenTracing specific interface implementations.  Classes in dd-trace-ot implement OpenTracing interfaces by wrapping and delegating to core classes.\nAdditionally, the internal-api project was created.  This project houses the Agent* interfaces.  At build time, these interfaces are copied into the bootstrap and also built into the dd-trace-core jar.\nSince this change touches everything, I tried to keep every commit reasonably self-contained.\nBreaking Changes\nI considered the \"public api\" to be:\n\nAll code in DD documentation: OpenTracing, manual instrumentation, and custom method\nEverything in dd-trace-api\nConstructors and the builder for DDTracer\nAny class used as an argument to the constructors or builder for DDTracer (eg Writer)\nPublic methods on DDTracer that belonged to the io.opentracing.Tracer or datadog.trace.api.Tracer interfaces\n\nWith that in mind, the breaking changes are:\n\nPackage change and interface changes for HttpCode.Injector and HttpCode.Extractor.  We only allowed custom Injectors/Extractors recently so the impact should be minimal\nRemoval of ScopeContext.  (It would have been a real pain to get this working and it's been deprecated for a year)\nSome small changes to DDSpanBuilder (if someone casted from SpanBuilder to the implementation)\n\nSee: Full api changes here\nFuture work\n\nMaking OpenTracing become an integration to completely remove any direct dependency\nLots of API changes.  Where I thought the current API was lacking, I added // FIXME [API]\nDDTracer and CoreTracer implement everything.  Their scopes need to be reduced and users should only be dealing with interfaces\nNon-OpenTracing manual instrumentation", "createdAt": "2020-04-06T14:53:06Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1354", "merged": true, "mergeCommit": {"oid": "bd73b33074cd15923f48fb54bdcf98289748a364"}, "closed": true, "closedAt": "2020-04-30T18:38:58Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 74, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVHBGrABqjMyMDc1NTM3Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccxfhAAFqTQwMzc3NzA3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "312d24686b835baed9c6ab2cfeaab12773e6eff9", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/312d24686b835baed9c6ab2cfeaab12773e6eff9", "committedDate": "2020-04-06T14:25:17Z", "message": "SetAsyncPropagation no longer returns AgentScope"}, "afterCommit": {"oid": "34bae10e0e50c8b851ef7b564d59be3426b4d829", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/34bae10e0e50c8b851ef7b564d59be3426b4d829", "committedDate": "2020-04-06T23:08:43Z", "message": "Rename DDTraceOTInfo -> DDTraceCoreInfo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MjI1MzAx", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-389225301", "createdAt": "2020-04-07T15:21:00Z", "commit": {"oid": "447c83e7baefb6112990754666a00773f1ffdc04"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNToyMTowMFrOGCI1Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNToyMTowMFrOGCI1Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg5NTA2Mw==", "bodyText": "There should probably be a new package datadog.trace.core that all these (DDSpan, DDTracer, etc) classes should be put into.", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r404895063", "createdAt": "2020-04-07T15:21:00Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/dd-java-agent.gradle", "diffHunk": "@@ -39,6 +39,8 @@ ext.generalShadowJarConfig = {\n   if (!project.hasProperty(\"disableShadowRelocate\") || !disableShadowRelocate) {\n     // shadow OT impl to prevent casts to implementation\n     relocate 'datadog.trace.common', 'datadog.trace.agent.common'\n+\n+    // FIXME figure out the best way to keep doing this\n     relocate 'datadog.opentracing', 'datadog.trace.agent.ot'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "447c83e7baefb6112990754666a00773f1ffdc04"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34bae10e0e50c8b851ef7b564d59be3426b4d829", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/34bae10e0e50c8b851ef7b564d59be3426b4d829", "committedDate": "2020-04-06T23:08:43Z", "message": "Rename DDTraceOTInfo -> DDTraceCoreInfo"}, "afterCommit": {"oid": "bbddee426bc97a86e30f04e6032155913de640b5", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bbddee426bc97a86e30f04e6032155913de640b5", "committedDate": "2020-04-07T15:42:14Z", "message": "Add equals() and hashcode() to wrappers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzM2NDcx", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-389336471", "createdAt": "2020-04-07T17:28:17Z", "commit": {"oid": "bbddee426bc97a86e30f04e6032155913de640b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoyODoxN1rOGCOYjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoyODoxN1rOGCOYjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NTk5Nw==", "bodyText": "I don't think core should depend on agent-bootstrap...", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r404985997", "createdAt": "2020-04-07T17:28:17Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/dd-trace-core.gradle", "diffHunk": "@@ -0,0 +1,73 @@\n+plugins {\n+  id \"com.github.johnrengelman.shadow\" version \"5.2.0\"\n+  id \"me.champeau.gradle.jmh\" version \"0.5.0\"\n+}\n+\n+description = 'dd-trace-ot'\n+\n+apply from: \"${rootDir}/gradle/java.gradle\"\n+apply from: \"${rootDir}/gradle/publish.gradle\"\n+\n+minimumBranchCoverage = 0.5\n+minimumInstructionCoverage = 0.6\n+excludedClassesCoverage += [\n+  'datadog.trace.common.writer.ListWriter',\n+  'datadog.trace.common.writer.LoggingWriter',\n+  'datadog.trace.common.writer.DDAgentWriter.DDAgentWriterBuilder',\n+  'datadog.trace.common.sampling.PrioritySampling',\n+  // This code is copied from okHttp samples and we have integration tests to verify that it works.\n+  'datadog.trace.common.writer.unixdomainsockets.TunnelingUnixSocket',\n+  'datadog.trace.common.writer.unixdomainsockets.UnixDomainSocketFactory',\n+  'datadog.trace.StringCachingBigInteger'\n+]\n+\n+apply plugin: 'org.unbroken-dome.test-sets'\n+\n+testSets {\n+  traceAgentTest\n+}\n+\n+dependencies {\n+  annotationProcessor deps.autoservice\n+  implementation deps.autoservice\n+\n+  compile project(':dd-trace-api')\n+  compile project(':utils:thread-utils')\n+  compileOnly project(':dd-java-agent:agent-bootstrap')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbddee426bc97a86e30f04e6032155913de640b5"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzM3MzY1", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-389337365", "createdAt": "2020-04-07T17:29:25Z", "commit": {"oid": "43338c1a21ecc381cf2147087da3bdeb1a3ffd5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoyOToyNVrOGCObrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoyOToyNVrOGCObrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4Njc5Nw==", "bodyText": "See my fix here: #1356", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r404986797", "createdAt": "2020-04-07T17:29:25Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/propagation/HttpCodec.java", "diffHunk": "@@ -148,4 +146,13 @@ static String decode(final String value) {\n     }\n     return decoded;\n   }\n+\n+  static String firstHeaderValue(final String value) {\n+    if (value == null || value.isEmpty()) {\n+      return value;\n+    }\n+\n+    // in case of multiple values in the header, need to parse\n+    return value.split(\",\")[0].trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43338c1a21ecc381cf2147087da3bdeb1a3ffd5a"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzUxNTQ1", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-389351545", "createdAt": "2020-04-07T17:47:51Z", "commit": {"oid": "5a0db05b2fc2ad1c8d1260d38bbd8d31cc751e44"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo0Nzo1MVrOGCPJDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo0Nzo1MVrOGCPJDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5ODQxNQ==", "bodyText": "This isn't \"unused\"... I used this for benchmarking various perf changes recently.  I'd appreciate if we could keep this.", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r404998415", "createdAt": "2020-04-07T17:47:51Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/dd-trace-ot.gradle", "diffHunk": "@@ -91,56 +91,4 @@ jar {\n \n shadowJar {\n   archiveClassifier = ''\n-\n-  dependencies {\n-    include(project(':utils:thread-utils'))\n-  }\n-}\n-\n-// We don't want bundled dependencies to show up in the pom.\n-modifyPom {\n-  dependencies.removeAll { it.artifactId == \"thread-utils\" }\n-}\n-\n-jmh {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a0db05b2fc2ad1c8d1260d38bbd8d31cc751e44"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzU0MjQx", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-389354241", "createdAt": "2020-04-07T17:51:25Z", "commit": {"oid": "056d530de21c1ecefeef20305afe750b072d6aca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1MToyNlrOGCPRng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1MToyNlrOGCPRng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMDYwNg==", "bodyText": "Suggestion: leave this class as DDTracer and rename the other to CoreTracer", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r405000606", "createdAt": "2020-04-07T17:51:26Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracerOT.java", "diffHunk": "@@ -0,0 +1,224 @@\n+package datadog.opentracing;\n+\n+import datadog.trace.DDTracer;\n+import datadog.trace.api.Config;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.common.sampling.Sampler;\n+import datadog.trace.common.writer.Writer;\n+import datadog.trace.propagation.HttpCodec;\n+import datadog.trace.scopemanager.DDScopeManager;\n+import io.opentracing.ScopeManager;\n+import io.opentracing.Tracer;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public class DDTracerOT implements Tracer {\n+  private final DDTracer coreTracer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "056d530de21c1ecefeef20305afe750b072d6aca"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzU5NjI2", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-389359626", "createdAt": "2020-04-07T17:58:20Z", "commit": {"oid": "5b20b74cbe6e5533ccb3bc28c269830d3fb3982c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1ODoyMFrOGCPizw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1ODoyMFrOGCPizw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwNTAwNw==", "bodyText": "Why does this need to depend on the agent-bootstrap?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r405005007", "createdAt": "2020-04-07T17:58:20Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/jfr-openjdk/jfr-openjdk.gradle", "diffHunk": "@@ -9,7 +9,7 @@ apply plugin: 'idea'\n dependencies {\n   compile deps.slf4j\n   compile project(':dd-trace-core')\n-  compileOnly project(':dd-java-agent:agent-bootstrap')\n+  compile project(':dd-java-agent:agent-bootstrap')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b20b74cbe6e5533ccb3bc28c269830d3fb3982c"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bbddee426bc97a86e30f04e6032155913de640b5", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bbddee426bc97a86e30f04e6032155913de640b5", "committedDate": "2020-04-07T15:42:14Z", "message": "Add equals() and hashcode() to wrappers"}, "afterCommit": {"oid": "a8c9f4796b59566d7e888f687f9efd721e8e2238", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a8c9f4796b59566d7e888f687f9efd721e8e2238", "committedDate": "2020-04-07T22:38:15Z", "message": "Create internal-api project for Agent* classes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8c9f4796b59566d7e888f687f9efd721e8e2238", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a8c9f4796b59566d7e888f687f9efd721e8e2238", "committedDate": "2020-04-07T22:38:15Z", "message": "Create internal-api project for Agent* classes"}, "afterCommit": {"oid": "cac9c319969d6b9de1469401329009eb70972fa8", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cac9c319969d6b9de1469401329009eb70972fa8", "committedDate": "2020-04-08T17:56:59Z", "message": "Fix formatting drift from core move rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cac9c319969d6b9de1469401329009eb70972fa8", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cac9c319969d6b9de1469401329009eb70972fa8", "committedDate": "2020-04-08T17:56:59Z", "message": "Fix formatting drift from core move rebase"}, "afterCommit": {"oid": "15b65b1f26934ea10507417ba93a9f7d429a211c", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/15b65b1f26934ea10507417ba93a9f7d429a211c", "committedDate": "2020-04-08T19:04:21Z", "message": "shadow rename core package"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15b65b1f26934ea10507417ba93a9f7d429a211c", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/15b65b1f26934ea10507417ba93a9f7d429a211c", "committedDate": "2020-04-08T19:04:21Z", "message": "shadow rename core package"}, "afterCommit": {"oid": "fa73dc035037d4306dd672fe4cdd83bdc3672324", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fa73dc035037d4306dd672fe4cdd83bdc3672324", "committedDate": "2020-04-08T21:44:26Z", "message": "Add core to ignores matcher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDgzMDY1", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-391083065", "createdAt": "2020-04-09T19:46:33Z", "commit": {"oid": "4f1fa8f00ceeb0206d884d9078a15b0b1603fef6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTo0NjozM1rOGDm9KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTo0NjozM1rOGDm9KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzNzE2MQ==", "bodyText": "I would expect to see a constructor here that takes a CoreTracer so we don't have to create multiple copies", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r406437161", "createdAt": "2020-04-09T19:46:33Z", "author": {"login": "devinsba"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -109,100 +53,66 @@ public DDTracerBuilder() {\n     public DDTracerBuilder withProperties(final Properties properties) {\n       return config(Config.get(properties));\n     }\n-\n-    public DDTracerBuilder config(final Config config) {\n-      this.config = config;\n-      serviceName(config.getServiceName());\n-      // Explicitly skip setting writer to avoid allocating resources prematurely.\n-      sampler(Sampler.Builder.forConfig(config));\n-      injector(HttpCodec.createInjector(config));\n-      extractor(HttpCodec.createExtractor(config, config.getHeaderTags()));\n-      scopeManager(\n-          new ContextualScopeManager(config.getScopeDepthLimit(), createScopeEventFactory()));\n-      localRootSpanTags(config.getLocalRootSpanTags());\n-      defaultSpanTags(config.getMergedSpanTags());\n-      serviceNameMappings(config.getServiceMapping());\n-      taggedHeaders(config.getHeaderTags());\n-      partialFlushMinSpans(config.getPartialFlushMinSpans());\n-      return this;\n-    }\n   }\n \n-  /** By default, report to local agent and collect all traces. */\n   @Deprecated\n   public DDTracer() {\n-    this(Config.get());\n+    coreTracer = CoreTracer.builder().build();\n+    scopeManager = new OTScopeManager();\n   }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1fa8f00ceeb0206d884d9078a15b0b1603fef6"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDk1MDkw", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-391095090", "createdAt": "2020-04-09T20:05:20Z", "commit": {"oid": "4f1fa8f00ceeb0206d884d9078a15b0b1603fef6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDowNToyMFrOGDnjQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDowNToyMFrOGDnjQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0NjkxMg==", "bodyText": "Is it possible to only have one scope type?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r406446912", "createdAt": "2020-04-09T20:05:20Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/CoreTracer.java", "diffHunk": "@@ -0,0 +1,711 @@\n+package datadog.trace.core;\n+\n+import datadog.trace.api.Config;\n+import datadog.trace.api.interceptor.MutableSpan;\n+import datadog.trace.api.interceptor.TraceInterceptor;\n+import datadog.trace.api.sampling.PrioritySampling;\n+import datadog.trace.bootstrap.instrumentation.api.AgentPropagation;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import datadog.trace.common.sampling.PrioritySampler;\n+import datadog.trace.common.sampling.Sampler;\n+import datadog.trace.common.writer.DDAgentWriter;\n+import datadog.trace.common.writer.Writer;\n+import datadog.trace.common.writer.ddagent.DDAgentResponseListener;\n+import datadog.trace.context.ScopeListener;\n+import datadog.trace.context.TraceScope;\n+import datadog.trace.core.decorators.AbstractDecorator;\n+import datadog.trace.core.decorators.DDDecoratorsFactory;\n+import datadog.trace.core.jfr.DDNoopScopeEventFactory;\n+import datadog.trace.core.jfr.DDScopeEventFactory;\n+import datadog.trace.core.propagation.ExtractedContext;\n+import datadog.trace.core.propagation.HttpCodec;\n+import datadog.trace.core.propagation.TagContext;\n+import datadog.trace.core.scopemanager.ContextualScopeManager;\n+import datadog.trace.core.scopemanager.DDScopeManager;\n+import java.io.Closeable;\n+import java.lang.ref.WeakReference;\n+import java.math.BigInteger;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Comparator;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.ServiceConfigurationError;\n+import java.util.ServiceLoader;\n+import java.util.SortedSet;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentSkipListSet;\n+import java.util.concurrent.ThreadLocalRandom;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/** DDTracer makes it easy to send traces and span to DD using the OpenTracing API. */\n+@Slf4j\n+public class CoreTracer\n+    implements Closeable, datadog.trace.api.Tracer, AgentTracer.TracerAPI, AgentPropagation {\n+  // UINT64 max value\n+  public static final BigInteger TRACE_ID_MAX =\n+      BigInteger.valueOf(2).pow(64).subtract(BigInteger.ONE);\n+  public static final BigInteger TRACE_ID_MIN = BigInteger.ZERO;\n+\n+  /** Default service name if none provided on the trace or span */\n+  final String serviceName;\n+  /** Writer is an charge of reporting traces and spans to the desired endpoint */\n+  final Writer writer;\n+  /** Sampler defines the sampling policy in order to reduce the number of traces for instance */\n+  final Sampler sampler;\n+  /** Scope manager is in charge of managing the scopes from which spans are created */\n+  final DDScopeManager scopeManager;\n+\n+  /** A set of tags that are added only to the application's root span */\n+  private final Map<String, String> localRootSpanTags;\n+  /** A set of tags that are added to every span */\n+  private final Map<String, String> defaultSpanTags;\n+  /** A configured mapping of service names to update with new values */\n+  private final Map<String, String> serviceNameMappings;\n+\n+  /** number of spans in a pending trace before they get flushed */\n+  @lombok.Getter private final int partialFlushMinSpans;\n+\n+  /**\n+   * JVM shutdown callback, keeping a reference to it to remove this if DDTracer gets destroyed\n+   * earlier\n+   */\n+  private final Thread shutdownCallback;\n+\n+  /** Span context decorators */\n+  private final Map<String, List<AbstractDecorator>> spanContextDecorators =\n+      new ConcurrentHashMap<>();\n+\n+  private final SortedSet<TraceInterceptor> interceptors =\n+      new ConcurrentSkipListSet<>(\n+          new Comparator<TraceInterceptor>() {\n+            @Override\n+            public int compare(final TraceInterceptor o1, final TraceInterceptor o2) {\n+              return Integer.compare(o1.priority(), o2.priority());\n+            }\n+          });\n+\n+  private final HttpCodec.Injector injector;\n+  private final HttpCodec.Extractor extractor;\n+\n+  @Override\n+  public TraceScope.Continuation capture() {\n+    final TraceScope activeScope = activeScope();\n+\n+    return activeScope == null ? null : activeScope.capture();\n+  }\n+\n+  public static class CoreTracerBuilder {\n+\n+    public CoreTracerBuilder() {\n+      // Apply the default values from config.\n+      config(Config.get());\n+    }\n+\n+    public CoreTracerBuilder withProperties(final Properties properties) {\n+      return config(Config.get(properties));\n+    }\n+\n+    public CoreTracerBuilder config(final Config config) {\n+      this.config = config;\n+      serviceName(config.getServiceName());\n+      // Explicitly skip setting writer to avoid allocating resources prematurely.\n+      sampler(Sampler.Builder.forConfig(config));\n+      injector(HttpCodec.createInjector(config));\n+      extractor(HttpCodec.createExtractor(config, config.getHeaderTags()));\n+      scopeManager(\n+          new ContextualScopeManager(config.getScopeDepthLimit(), createScopeEventFactory()));\n+      localRootSpanTags(config.getLocalRootSpanTags());\n+      defaultSpanTags(config.getMergedSpanTags());\n+      serviceNameMappings(config.getServiceMapping());\n+      taggedHeaders(config.getHeaderTags());\n+      partialFlushMinSpans(config.getPartialFlushMinSpans());\n+      return this;\n+    }\n+  }\n+\n+  @Builder\n+  // These field names must be stable to ensure the builder api is stable.\n+  private CoreTracer(\n+      final Config config,\n+      final String serviceName,\n+      final Writer writer,\n+      final Sampler sampler,\n+      final HttpCodec.Injector injector,\n+      final HttpCodec.Extractor extractor,\n+      final DDScopeManager scopeManager,\n+      final Map<String, String> localRootSpanTags,\n+      final Map<String, String> defaultSpanTags,\n+      final Map<String, String> serviceNameMappings,\n+      final Map<String, String> taggedHeaders,\n+      final int partialFlushMinSpans) {\n+\n+    assert localRootSpanTags != null;\n+    assert defaultSpanTags != null;\n+    assert serviceNameMappings != null;\n+    assert taggedHeaders != null;\n+\n+    this.serviceName = serviceName;\n+    if (writer == null) {\n+      this.writer = Writer.Builder.forConfig(config);\n+    } else {\n+      this.writer = writer;\n+    }\n+    this.sampler = sampler;\n+    this.injector = injector;\n+    this.extractor = extractor;\n+    this.scopeManager = scopeManager;\n+    this.localRootSpanTags = localRootSpanTags;\n+    this.defaultSpanTags = defaultSpanTags;\n+    this.serviceNameMappings = serviceNameMappings;\n+    this.partialFlushMinSpans = partialFlushMinSpans;\n+\n+    this.writer.start();\n+\n+    shutdownCallback = new ShutdownHook(this);\n+    try {\n+      Runtime.getRuntime().addShutdownHook(shutdownCallback);\n+    } catch (final IllegalStateException ex) {\n+      // The JVM is already shutting down.\n+    }\n+\n+    if (this.writer instanceof DDAgentWriter && sampler instanceof DDAgentResponseListener) {\n+      ((DDAgentWriter) this.writer).addResponseListener((DDAgentResponseListener) this.sampler);\n+    }\n+\n+    log.info(\"New instance: {}\", this);\n+\n+    final List<AbstractDecorator> decorators = DDDecoratorsFactory.createBuiltinDecorators();\n+    for (final AbstractDecorator decorator : decorators) {\n+      addDecorator(decorator);\n+    }\n+\n+    registerClassLoader(ClassLoader.getSystemClassLoader());\n+\n+    // Ensure that PendingTrace.SPAN_CLEANER is initialized in this thread:\n+    // FIXME: add test to verify the span cleaner thread is started with this call.\n+    PendingTrace.initialize();\n+  }\n+\n+  @Override\n+  public void finalize() {\n+    try {\n+      Runtime.getRuntime().removeShutdownHook(shutdownCallback);\n+      shutdownCallback.run();\n+    } catch (final Exception e) {\n+      log.error(\"Error while finalizing DDTracer.\", e);\n+    }\n+  }\n+\n+  /**\n+   * Returns the list of span context decorators\n+   *\n+   * @return the list of span context decorators\n+   */\n+  public List<AbstractDecorator> getSpanContextDecorators(final String tag) {\n+    return spanContextDecorators.get(tag);\n+  }\n+\n+  /**\n+   * Add a new decorator in the list ({@link AbstractDecorator})\n+   *\n+   * @param decorator The decorator in the list\n+   */\n+  public void addDecorator(final AbstractDecorator decorator) {\n+\n+    List<AbstractDecorator> list = spanContextDecorators.get(decorator.getMatchingTag());\n+    if (list == null) {\n+      list = new ArrayList<>();\n+    }\n+    list.add(decorator);\n+\n+    spanContextDecorators.put(decorator.getMatchingTag(), list);\n+    log.debug(\n+        \"Decorator added: '{}' -> {}\", decorator.getMatchingTag(), decorator.getClass().getName());\n+  }\n+\n+  /**\n+   * If an application is using a non-system classloader, that classloader should be registered\n+   * here. Due to the way Spring Boot structures its' executable jar, this might log some warnings.\n+   *\n+   * @param classLoader to register.\n+   */\n+  public void registerClassLoader(final ClassLoader classLoader) {\n+    try {\n+      for (final TraceInterceptor interceptor :\n+          ServiceLoader.load(TraceInterceptor.class, classLoader)) {\n+        addTraceInterceptor(interceptor);\n+      }\n+    } catch (final ServiceConfigurationError e) {\n+      log.warn(\"Problem loading TraceInterceptor for classLoader: \" + classLoader, e);\n+    }\n+  }\n+\n+  public CoreSpanBuilder buildSpan(final String operationName) {\n+    return new CoreSpanBuilder(operationName);\n+  }\n+\n+  @Override\n+  public AgentSpan startSpan(final String spanName) {\n+    return buildSpan(spanName).start();\n+  }\n+\n+  @Override\n+  public AgentSpan startSpan(final String spanName, final long startTimeMicros) {\n+    return buildSpan(spanName).withStartTimestamp(startTimeMicros).start();\n+  }\n+\n+  @Override\n+  public AgentSpan startSpan(final String spanName, final AgentSpan.Context parent) {\n+    return buildSpan(spanName).ignoreActiveSpan().asChildOf(parent).start();\n+  }\n+\n+  @Override\n+  public AgentSpan startSpan(\n+      final String spanName, final AgentSpan.Context parent, final long startTimeMicros) {\n+    return buildSpan(spanName)\n+        .ignoreActiveSpan()\n+        .asChildOf(parent)\n+        .withStartTimestamp(startTimeMicros)\n+        .start();\n+  }\n+\n+  @Override\n+  public AgentScope activateSpan(final AgentSpan span, final boolean finishSpanOnClose) {\n+    return scopeManager.activate(span, finishSpanOnClose);\n+  }\n+\n+  @Override\n+  public AgentSpan activeSpan() {\n+    return scopeManager.activeSpan();\n+  }\n+\n+  @Override\n+  public TraceScope activeScope() {\n+    // FIXME: [API] the fact that this returns null for SimpleScope is problematic\n+    final AgentScope scope = scopeManager.active();\n+    if (scope instanceof TraceScope) {\n+      return (TraceScope) scope;\n+    }\n+\n+    return null;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1fa8f00ceeb0206d884d9078a15b0b1603fef6"}, "originalPosition": 297}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDYyNDc1", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-393062475", "createdAt": "2020-04-14T15:49:34Z", "commit": {"oid": "88aa33c115f6999ec5add9e88a0e284e25a66710"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo0OTozNFrOGFVQwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo0OTozNFrOGFVQwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0NDQxOA==", "bodyText": "I think we still need this, otherwise it shadows all the dependencies, including opentracing-api.  If you prefer, you can move thread-utils into the internal-api project.", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r408244418", "createdAt": "2020-04-14T15:49:34Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/dd-trace-ot.gradle", "diffHunk": "@@ -91,15 +70,6 @@ jar {\n \n shadowJar {\n   archiveClassifier = ''\n-\n-  dependencies {\n-    include(project(':utils:thread-utils'))\n-  }\n-}\n-\n-// We don't want bundled dependencies to show up in the pom.\n-modifyPom {\n-  dependencies.removeAll { it.artifactId == \"thread-utils\" }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88aa33c115f6999ec5add9e88a0e284e25a66710"}, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88aa33c115f6999ec5add9e88a0e284e25a66710", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/88aa33c115f6999ec5add9e88a0e284e25a66710", "committedDate": "2020-04-10T17:00:18Z", "message": "Annoyingly, DDTracer needs to delegate api.Tracer as well"}, "afterCommit": {"oid": "0184f5d22e7acc41067892ec10995ad7068afebb", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0184f5d22e7acc41067892ec10995ad7068afebb", "committedDate": "2020-04-15T18:46:09Z", "message": "Add api checker"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0184f5d22e7acc41067892ec10995ad7068afebb", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0184f5d22e7acc41067892ec10995ad7068afebb", "committedDate": "2020-04-15T18:46:09Z", "message": "Add api checker"}, "afterCommit": {"oid": "e261483ca383a64c394d243cc4492c3236edd909", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e261483ca383a64c394d243cc4492c3236edd909", "committedDate": "2020-04-15T19:03:38Z", "message": "Add api checker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzQyOTg4", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-395742988", "createdAt": "2020-04-17T20:11:33Z", "commit": {"oid": "e261483ca383a64c394d243cc4492c3236edd909"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDoxMTozNFrOGHbqFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDoxMTozNFrOGHbqFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ0NjM1OQ==", "bodyText": "Maybe this class and implementations of it should be made to work with a generic Span class instead?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r410446359", "createdAt": "2020-04-17T20:11:34Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/LogHandler.java", "diffHunk": "@@ -1,5 +1,6 @@\n package datadog.opentracing;\n \n+import datadog.trace.core.DDSpan;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e261483ca383a64c394d243cc4492c3236edd909"}, "originalPosition": 3}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e261483ca383a64c394d243cc4492c3236edd909", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e261483ca383a64c394d243cc4492c3236edd909", "committedDate": "2020-04-15T19:03:38Z", "message": "Add api checker"}, "afterCommit": {"oid": "e55d49acfc4230f242e7a7c2c3eee1b4b8d5732f", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e55d49acfc4230f242e7a7c2c3eee1b4b8d5732f", "committedDate": "2020-04-22T23:05:17Z", "message": "#1377 changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8c5b7ea461f08d1bd5524a62105c2feab392d0f", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b8c5b7ea461f08d1bd5524a62105c2feab392d0f", "committedDate": "2020-04-22T23:23:43Z", "message": "Fix issues from rebase"}, "afterCommit": {"oid": "7f27ca3e4b6dbdcce14f1cdea82c93e10c4ac26d", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7f27ca3e4b6dbdcce14f1cdea82c93e10c4ac26d", "committedDate": "2020-04-23T22:50:54Z", "message": "Update revapi justifications with newer changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f27ca3e4b6dbdcce14f1cdea82c93e10c4ac26d", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7f27ca3e4b6dbdcce14f1cdea82c93e10c4ac26d", "committedDate": "2020-04-23T22:50:54Z", "message": "Update revapi justifications with newer changes"}, "afterCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/eb33b99af7d6399fda77a877f8e7e0372d9ce4bf", "committedDate": "2020-04-24T15:33:38Z", "message": "Manually add core transitive dependencies to OT pom"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMTQ0NzUy", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-400144752", "createdAt": "2020-04-24T17:37:37Z", "commit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzozNzozN1rOGLiN0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzo0Mjo0OVrOGLiaYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODExMw==", "bodyText": "Maybe a comment for why this module is here would be good", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414748113", "createdAt": "2020-04-24T17:37:37Z", "author": {"login": "devinsba"}, "path": "internal-api/internal-api.gradle", "diffHunk": "@@ -0,0 +1,5 @@\n+apply from: \"${rootDir}/gradle/java.gradle\"\n+\n+dependencies {\n+  compile project(':dd-trace-api')\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1MTMyOQ==", "bodyText": "I wonder if this is needed in the core or not. Could we put a noop interface here and provide this in the agent jar instead?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414751329", "createdAt": "2020-04-24T17:42:49Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/dd-trace-core.gradle", "diffHunk": "@@ -0,0 +1,51 @@\n+description = 'dd-trace-core'\n+\n+apply from: \"${rootDir}/gradle/java.gradle\"\n+apply from: \"${rootDir}/gradle/publish.gradle\"\n+\n+minimumBranchCoverage = 0.5\n+minimumInstructionCoverage = 0.6\n+excludedClassesCoverage += [\n+  'datadog.trace.common.writer.ListWriter',\n+  'datadog.trace.common.writer.LoggingWriter',\n+  'datadog.trace.common.writer.DDAgentWriter.DDAgentWriterBuilder',\n+  'datadog.trace.common.sampling.PrioritySampling',\n+  // This code is copied from okHttp samples and we have integration tests to verify that it works.\n+  'datadog.trace.common.writer.unixdomainsockets.TunnelingUnixSocket',\n+  'datadog.trace.common.writer.unixdomainsockets.UnixDomainSocketFactory',\n+  'datadog.trace.core.StringCachingBigInteger'\n+]\n+\n+apply plugin: 'org.unbroken-dome.test-sets'\n+\n+testSets {\n+  traceAgentTest\n+}\n+\n+dependencies {\n+  annotationProcessor deps.autoservice\n+  implementation deps.autoservice\n+\n+  compile project(':dd-trace-api')\n+  compile project(':internal-api')\n+  compile project(':utils:thread-utils')\n+\n+  compile group: 'com.datadoghq', name: 'java-dogstatsd-client', version: \"${versions.dogstatsd}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMTE2NjU2", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-400116656", "createdAt": "2020-04-24T16:57:04Z", "commit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNjo1NzowNVrOGLgtgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxODowNTo0OFrOGLjQ6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyMzQ1OA==", "bodyText": "Do we still have datadog.opentracing packages?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414723458", "createdAt": "2020-04-24T16:57:05Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/dd-java-agent.gradle", "diffHunk": "@@ -39,6 +39,7 @@ ext.generalShadowJarConfig = {\n   if (!project.hasProperty(\"disableShadowRelocate\") || !disableShadowRelocate) {\n     // shadow OT impl to prevent casts to implementation\n     relocate 'datadog.trace.common', 'datadog.trace.agent.common'\n+    relocate 'datadog.trace.core', 'datadog.trace.agent.core'\n     relocate 'datadog.opentracing', 'datadog.trace.agent.ot'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjUyMw==", "bodyText": "Why this change?  Maybe we should have an internal interface for span?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414726523", "createdAt": "2020-04-24T17:01:59Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/servlet/src/test/groovy/RequestDispatcherTest.groovy", "diffHunk": "@@ -1,22 +1,22 @@\n-import datadog.opentracing.DDSpan\n import datadog.trace.agent.test.AgentTestRunner\n+import datadog.trace.core.DDSpan\n \n import javax.servlet.ServletException\n import javax.servlet.http.HttpServletRequest\n import javax.servlet.http.HttpServletResponse\n \n-import static datadog.opentracing.propagation.DatadogHttpCodec.SAMPLING_PRIORITY_KEY\n-import static datadog.opentracing.propagation.DatadogHttpCodec.SPAN_ID_KEY\n-import static datadog.opentracing.propagation.DatadogHttpCodec.TRACE_ID_KEY\n import static datadog.trace.agent.test.utils.TraceUtils.basicSpan\n import static datadog.trace.agent.test.utils.TraceUtils.runUnderTrace\n import static datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator.DD_SPAN_ATTRIBUTE\n+import static datadog.trace.core.propagation.DatadogHttpCodec.SAMPLING_PRIORITY_KEY\n+import static datadog.trace.core.propagation.DatadogHttpCodec.SPAN_ID_KEY\n+import static datadog.trace.core.propagation.DatadogHttpCodec.TRACE_ID_KEY\n \n class RequestDispatcherTest extends AgentTestRunner {\n \n   def request = Mock(HttpServletRequest)\n   def response = Mock(HttpServletResponse)\n-  def mockSpan = Mock(DDSpan)\n+  def mockSpan = Stub(DDSpan)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMTAyMQ==", "bodyText": "Updated javadoc?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414731021", "createdAt": "2020-04-24T17:09:36Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/CoreTracer.java", "diffHunk": "@@ -0,0 +1,700 @@\n+package datadog.trace.core;\n+\n+import datadog.trace.api.Config;\n+import datadog.trace.api.interceptor.MutableSpan;\n+import datadog.trace.api.interceptor.TraceInterceptor;\n+import datadog.trace.api.sampling.PrioritySampling;\n+import datadog.trace.bootstrap.instrumentation.api.AgentPropagation;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import datadog.trace.common.sampling.PrioritySampler;\n+import datadog.trace.common.sampling.Sampler;\n+import datadog.trace.common.writer.DDAgentWriter;\n+import datadog.trace.common.writer.Writer;\n+import datadog.trace.common.writer.ddagent.DDAgentResponseListener;\n+import datadog.trace.context.ScopeListener;\n+import datadog.trace.context.TraceScope;\n+import datadog.trace.core.decorators.AbstractDecorator;\n+import datadog.trace.core.decorators.DDDecoratorsFactory;\n+import datadog.trace.core.jfr.DDNoopScopeEventFactory;\n+import datadog.trace.core.jfr.DDScopeEventFactory;\n+import datadog.trace.core.propagation.ExtractedContext;\n+import datadog.trace.core.propagation.HttpCodec;\n+import datadog.trace.core.propagation.TagContext;\n+import datadog.trace.core.scopemanager.ContextualScopeManager;\n+import datadog.trace.core.scopemanager.DDScopeManager;\n+import java.io.Closeable;\n+import java.lang.ref.WeakReference;\n+import java.math.BigInteger;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Comparator;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.ServiceConfigurationError;\n+import java.util.ServiceLoader;\n+import java.util.SortedSet;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentSkipListSet;\n+import java.util.concurrent.ThreadLocalRandom;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/** DDTracer makes it easy to send traces and span to DD using the OpenTracing API. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMTg5Mg==", "bodyText": "Should we rename this as CoreSpan to be consistent in naming?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414731892", "createdAt": "2020-04-24T17:11:07Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpan.java", "diffHunk": "@@ -19,11 +18,11 @@\n /**\n  * Represents a period of time. Associated information is stored in the SpanContext.\n  *\n- * <p>Spans are created by the {@link DDTracer#buildSpan}. This implementation adds some features\n+ * <p>Spans are created by the {@link CoreTracer#buildSpan}. This implementation adds some features\n  * according to the DD agent.\n  */\n @Slf4j\n-public class DDSpan implements Span, MutableSpan {\n+public class DDSpan implements MutableSpan, AgentSpan {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczNzk0NA==", "bodyText": "What if the tag isn't actually set?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414737944", "createdAt": "2020-04-24T17:21:03Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpan.java", "diffHunk": "@@ -153,120 +153,87 @@ public void setErrorMeta(final Throwable error) {\n     final StringWriter errorString = new StringWriter();\n     error.printStackTrace(new PrintWriter(errorString));\n     setTag(DDTags.ERROR_STACK, errorString.toString());\n+\n+    return this;\n   }\n \n-  /* (non-Javadoc)\n-   * @see io.opentracing.BaseSpan#setTag(java.lang.String, java.lang.String)\n-   */\n   @Override\n   public final DDSpan setTag(final String tag, final String value) {\n-    context().setTag(tag, (Object) value);\n+    context.setTag(tag, value);\n     return this;\n   }\n \n-  /* (non-Javadoc)\n-   * @see io.opentracing.BaseSpan#setTag(java.lang.String, boolean)\n-   */\n   @Override\n   public final DDSpan setTag(final String tag, final boolean value) {\n-    context().setTag(tag, (Object) value);\n+    context.setTag(tag, value);\n     return this;\n   }\n \n-  /* (non-Javadoc)\n-   * @see io.opentracing.BaseSpan#setTag(java.lang.String, java.lang.Number)\n-   */\n   @Override\n-  public final DDSpan setTag(final String tag, final Number value) {\n-    context().setTag(tag, (Object) value);\n+  public AgentSpan setTag(final String tag, final int value) {\n+    context.setTag(tag, value);\n     return this;\n   }\n \n   @Override\n-  public <T> Span setTag(final Tag<T> tag, final T value) {\n-    context().setTag(tag.getKey(), value);\n+  public AgentSpan setTag(final String tag, final long value) {\n+    context.setTag(tag, value);\n     return this;\n   }\n \n-  /* (non-Javadoc)\n-   * @see io.opentracing.BaseSpan#context()\n-   */\n   @Override\n-  public final DDSpanContext context() {\n-    return context;\n+  public AgentSpan setTag(final String tag, final double value) {\n+    context.setTag(tag, value);\n+    return this;\n   }\n \n-  /* (non-Javadoc)\n-   * @see io.opentracing.BaseSpan#getBaggageItem(java.lang.String)\n-   */\n   @Override\n-  public final String getBaggageItem(final String key) {\n-    return context.getBaggageItem(key);\n+  public DDSpan setTag(final String tag, final Number value) {\n+    context.setTag(tag, value);\n+    return this;\n   }\n \n-  /* (non-Javadoc)\n-   * @see io.opentracing.BaseSpan#setBaggageItem(java.lang.String, java.lang.String)\n-   */\n-  @Override\n-  public final DDSpan setBaggageItem(final String key, final String value) {\n-    context.setBaggageItem(key, value);\n+  // FIXME [API] this is not on AgentSpan or MutableSpan\n+  public DDSpan setTag(final String tag, final Object value) {\n+    context.setTag(tag, value);\n     return this;\n   }\n \n-  /* (non-Javadoc)\n-   * @see io.opentracing.BaseSpan#setOperationName(java.lang.String)\n-   */\n-  @Override\n-  public final DDSpan setOperationName(final String operationName) {\n-    context().setOperationName(operationName);\n+  // FIXME [API] this is not on AgentSpan or MutableSpan\n+  public AgentSpan removeTag(final String tag) {\n+    context.setTag(tag, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 188}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0Mjc3OQ==", "bodyText": "why an interface?  Should we use the concrete type directly instead?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414742779", "createdAt": "2020-04-24T17:28:42Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/DDScopeManager.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package datadog.trace.core.scopemanager;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.context.TraceScope;\n+\n+public interface DDScopeManager {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0OTgzNQ==", "bodyText": "This got reverted...", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414749835", "createdAt": "2020-04-24T17:40:28Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/DDSpanTest.groovy", "diffHunk": "@@ -169,6 +171,29 @@ class DDSpanTest extends DDSpecification {\n     span.durationNano == 1\n   }\n \n+  @Ignore\n+  def \"stacktrace captured when duration exceeds average + configured threshold\"() {\n+    setup:\n+    // Get the part of the stack before this test is called.\n+    def acceptRemaining = false\n+    def originalStack = Thread.currentThread().stackTrace\n+    def stackTraceElements = originalStack.dropWhile {\n+      if (it.className == ReflectionUtil.name) {\n+        acceptRemaining = true\n+      }\n+      return !acceptRemaining\n+    }\n+    def stack = \"\\tat \" + stackTraceElements.join(\"\\n\\tat \") + \"\\n\"\n+\n+    def span = tracer.buildSpan(\"test\").start()\n+    span.finish(span.startTimeMicro + DDSpan.AVG_DURATION.get() + TimeUnit.NANOSECONDS.toMicros(Config.get().spanDurationAboveAverageStacktraceNanos) + 1)\n+    def actual = span.tags[\"slow.stack\"].toString()\n+\n+    expect:\n+    !stack.isEmpty()\n+    actual.endsWith(stack)\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1NTYyOQ==", "bodyText": "Not really sure how this works, but it seems ok... I assume you've reviewed a diff of the resulting pom to be sure?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414755629", "createdAt": "2020-04-24T17:49:56Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/dd-trace-ot.gradle", "diffHunk": "@@ -93,13 +73,36 @@ shadowJar {\n   archiveClassifier = ''\n \n   dependencies {\n+    include(project(':dd-trace-core'))\n+    include(project(':internal-api'))\n     include(project(':utils:thread-utils'))\n   }\n }\n \n-// We don't want bundled dependencies to show up in the pom.\n modifyPom {\n-  dependencies.removeAll { it.artifactId == \"thread-utils\" }\n+  // We're bundling the internal dependencies.  So we need to add the transitive dependencies\n+  // of those projects. Directly adding to the XML is the only way to prevent the shadowJar plugin\n+  // from removing them", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1NjgxOA==", "bodyText": "The problem with this is it breaks backwards compatibility of the test.  We can't test older versions.  Not a deal breaker, just something to consider.", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414756818", "createdAt": "2020-04-24T17:51:52Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/jmh/java/datadog/trace/DDTraceBenchmark.java", "diffHunk": "@@ -13,7 +13,7 @@\n   @State(org.openjdk.jmh.annotations.Scope.Thread)\n   public static class TraceState {\n     public ListWriter traceCollector = new ListWriter();\n-    public Tracer tracer = new DDTracer(traceCollector);\n+    public Tracer tracer = DDTracer.builder().writer(traceCollector).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2MTY1NQ==", "bodyText": "Why remove this?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414761655", "createdAt": "2020-04-24T17:59:44Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -109,100 +55,57 @@ public DDTracerBuilder() {\n     public DDTracerBuilder withProperties(final Properties properties) {\n       return config(Config.get(properties));\n     }\n-\n-    public DDTracerBuilder config(final Config config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2NTI4OA==", "bodyText": "DDTracer is a pretty large file.  Do these need to be nested classes?  It might make sense to split some of them out into separate files (but still package private).", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r414765288", "createdAt": "2020-04-24T18:05:48Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -411,466 +305,668 @@ public Scope activateSpan(final Span span) {\n   }\n \n   @Override\n-  public SpanBuilder buildSpan(final String operationName) {\n-    return new DDSpanBuilder(operationName, scopeManager);\n+  public DDSpanBuilder buildSpan(final String operationName) {\n+    return new DDSpanBuilder(operationName);\n   }\n \n   @Override\n-  public <T> void inject(final SpanContext spanContext, final Format<T> format, final T carrier) {\n+  public <C> void inject(final SpanContext spanContext, final Format<C> format, final C carrier) {\n     if (carrier instanceof TextMapInject) {\n-      final DDSpanContext ddSpanContext = (DDSpanContext) spanContext;\n+      final AgentSpan.Context context = converter.toContext(spanContext);\n \n-      final DDSpan rootSpan = ddSpanContext.getTrace().getRootSpan();\n-      setSamplingPriorityIfNecessary(rootSpan);\n-\n-      injector.inject(ddSpanContext, (TextMapInject) carrier);\n+      coreTracer.inject(context, (TextMapInject) carrier, TextMapInjectSetter.INSTANCE);\n     } else {\n       log.debug(\"Unsupported format for propagation - {}\", format.getClass().getName());\n     }\n   }\n \n   @Override\n-  public <T> SpanContext extract(final Format<T> format, final T carrier) {\n+  public <C> SpanContext extract(final Format<C> format, final C carrier) {\n     if (carrier instanceof TextMapExtract) {\n-      return extractor.extract((TextMapExtract) carrier);\n+      final TagContext tagContext =\n+          coreTracer.extract(\n+              (TextMapExtract) carrier, new TextMapExtractGetter((TextMapExtract) carrier));\n+\n+      return converter.toSpanContext(tagContext);\n     } else {\n       log.debug(\"Unsupported format for propagation - {}\", format.getClass().getName());\n       return null;\n     }\n   }\n \n-  /**\n-   * We use the sampler to know if the trace has to be reported/written. The sampler is called on\n-   * the first span (root span) of the trace. If the trace is marked as a sample, we report it.\n-   *\n-   * @param trace a list of the spans related to the same trace\n-   */\n-  void write(final Collection<DDSpan> trace) {\n-    if (trace.isEmpty()) {\n-      return;\n-    }\n-    final ArrayList<DDSpan> writtenTrace;\n-    if (interceptors.isEmpty()) {\n-      writtenTrace = new ArrayList<>(trace);\n-    } else {\n-      Collection<? extends MutableSpan> interceptedTrace = new ArrayList<>(trace);\n-      for (final TraceInterceptor interceptor : interceptors) {\n-        interceptedTrace = interceptor.onTraceComplete(interceptedTrace);\n-      }\n-      writtenTrace = new ArrayList<>(interceptedTrace.size());\n-      for (final MutableSpan span : interceptedTrace) {\n-        if (span instanceof DDSpan) {\n-          writtenTrace.add((DDSpan) span);\n-        }\n-      }\n-    }\n-    incrementTraceCount();\n+  @Override\n+  public void close() {\n+    coreTracer.close();\n+  }\n \n-    if (!writtenTrace.isEmpty()) {\n-      final DDSpan rootSpan = (DDSpan) writtenTrace.get(0).getLocalRootSpan();\n-      setSamplingPriorityIfNecessary(rootSpan);\n+  private static class TextMapInjectSetter implements AgentPropagation.Setter<TextMapInject> {\n+    static final TextMapInjectSetter INSTANCE = new TextMapInjectSetter();\n \n-      final DDSpan spanToSample = rootSpan == null ? writtenTrace.get(0) : rootSpan;\n-      if (sampler.sample(spanToSample)) {\n-        writer.write(writtenTrace);\n-      }\n+    @Override\n+    public void set(final TextMapInject carrier, final String key, final String value) {\n+      carrier.put(key, value);\n     }\n   }\n \n-  void setSamplingPriorityIfNecessary(final DDSpan rootSpan) {\n-    // There's a race where multiple threads can see PrioritySampling.UNSET here\n-    // This check skips potential complex sampling priority logic when we know its redundant\n-    // Locks inside DDSpanContext ensure the correct behavior in the race case\n+  private static class TextMapExtractGetter implements AgentPropagation.Getter<TextMapExtract> {\n+    private final Map<String, String> extracted = new HashMap<>();\n \n-    if (sampler instanceof PrioritySampler\n-        && rootSpan != null\n-        && rootSpan.context().getSamplingPriority() == PrioritySampling.UNSET) {\n+    private TextMapExtractGetter(final TextMapExtract carrier) {\n+      for (final Entry<String, String> entry : carrier) {\n+        extracted.put(entry.getKey(), entry.getValue());\n+      }\n+    }\n \n-      ((PrioritySampler) sampler).setSamplingPriority(rootSpan);\n+    @Override\n+    public Iterable<String> keys(final TextMapExtract carrier) {\n+      return extracted.keySet();\n     }\n-  }\n \n-  /** Increment the reported trace count, but do not write a trace. */\n-  void incrementTraceCount() {\n-    writer.incrementTraceCount();\n+    @Override\n+    public String get(final TextMapExtract carrier, final String key) {\n+      // This is the same as the one passed into the constructor\n+      // So using \"extracted\" is valid\n+      return extracted.get(key);\n+    }\n   }\n \n-  @Override\n-  public String getTraceId() {\n-    final Span activeSpan = activeSpan();\n-    if (activeSpan instanceof DDSpan) {\n-      return ((DDSpan) activeSpan).getTraceId().toString();\n+  // Centralized place to do conversions\n+  private class Converter {\n+    // TODO maybe add caching to reduce new objects being created\n+\n+    public AgentSpan toAgentSpan(final Span span) {\n+      if (span instanceof OTSpan) {\n+        return ((OTSpan) span).delegate;\n+      } else {\n+        // NOOP Span\n+        return NoopAgentSpan.INSTANCE;\n+      }\n     }\n-    return \"0\";\n-  }\n \n-  @Override\n-  public String getSpanId() {\n-    final Span activeSpan = activeSpan();\n-    if (activeSpan instanceof DDSpan) {\n-      return ((DDSpan) activeSpan).getSpanId().toString();\n+    public Span toSpan(final AgentSpan agentSpan) {\n+      if (agentSpan instanceof DDSpan) {\n+        return new OTSpan((DDSpan) agentSpan);\n+      } else {\n+        // NOOP AgentSpans\n+        return NoopSpan.INSTANCE;\n+      }\n     }\n-    return \"0\";\n-  }\n \n-  @Override\n-  public boolean addTraceInterceptor(final TraceInterceptor interceptor) {\n-    return interceptors.add(interceptor);\n-  }\n+    // FIXME [API] Need to use the runtime type not compile-time type so \"Object\" is used\n+    // That fact that some methods return AgentScope and other TraceScope even though its the same\n+    // underlying object needs to be cleaned up\n+    public Scope toScope(final Object scope) {\n+      if (scope instanceof CustomScopeManagerScope) {\n+        return ((CustomScopeManagerScope) scope).delegate;\n+      } else if (scope instanceof TraceScope) {\n+        return new OTTraceScope((TraceScope) scope);\n+      } else {\n+        return new OTScope((AgentScope) scope);\n+      }\n+    }\n \n-  @Override\n-  public void addScopeListener(final ScopeListener listener) {\n-    if (scopeManager instanceof ContextualScopeManager) {\n-      ((ContextualScopeManager) scopeManager).addScopeListener(listener);\n+    public SpanContext toSpanContext(final DDSpanContext context) {\n+      return new OTGenericContext(context);\n     }\n-  }\n \n-  @Override\n-  public void close() {\n-    PendingTrace.close();\n-    writer.close();\n-  }\n+    public SpanContext toSpanContext(final TagContext tagContext) {\n+      if (tagContext instanceof ExtractedContext) {\n+        return new OTExtractedContext((ExtractedContext) tagContext);\n+      } else {\n+        return new OTTagContext(tagContext);\n+      }\n+    }\n \n-  @Override\n-  public String toString() {\n-    return \"DDTracer-\"\n-        + Integer.toHexString(hashCode())\n-        + \"{ serviceName=\"\n-        + serviceName\n-        + \", writer=\"\n-        + writer\n-        + \", sampler=\"\n-        + sampler\n-        + \", defaultSpanTags=\"\n-        + defaultSpanTags\n-        + '}';\n+    public AgentSpan.Context toContext(final SpanContext spanContext) {\n+      // FIXME: [API] DDSpanContext, ExtractedContext, TagContext, AgentSpan.Context\n+      // don't share a meaningful hierarchy\n+      if (spanContext instanceof OTGenericContext) {\n+        return ((OTGenericContext) spanContext).delegate;\n+      } else if (spanContext instanceof OTExtractedContext) {\n+        return ((OTExtractedContext) spanContext).extractedContext;\n+      } else if (spanContext instanceof OTTagContext) {\n+        return ((OTTagContext) spanContext).delegate;\n+      } else {\n+        return AgentTracer.NoopContext.INSTANCE;\n+      }\n+    }\n   }\n \n-  @Deprecated\n-  private static Map<String, String> customRuntimeTags(\n-      final String runtimeId, final Map<String, String> applicationRootSpanTags) {\n-    final Map<String, String> runtimeTags = new HashMap<>(applicationRootSpanTags);\n-    runtimeTags.put(Config.RUNTIME_ID_TAG, runtimeId);\n-    return Collections.unmodifiableMap(runtimeTags);\n-  }\n+  public class DDSpanBuilder implements SpanBuilder {\n+    private final CoreSpanBuilder delegate;\n \n-  private static DDScopeEventFactory createScopeEventFactory() {\n-    try {\n-      return (DDScopeEventFactory)\n-          Class.forName(\"datadog.opentracing.jfr.openjdk.ScopeEventFactory\").newInstance();\n-    } catch (final ClassFormatError | ReflectiveOperationException | NoClassDefFoundError e) {\n-      log.debug(\"Cannot create Openjdk JFR scope event factory\", e);\n+    public DDSpanBuilder(final String operationName) {\n+      delegate = coreTracer.buildSpan(operationName);\n     }\n-    return new DDNoopScopeEventFactory();\n-  }\n \n-  /** Spans are built using this builder */\n-  public class DDSpanBuilder implements SpanBuilder {\n-    private final ScopeManager scopeManager;\n-\n-    /** Each span must have an operationName according to the opentracing specification */\n-    private final String operationName;\n-\n-    // Builder attributes\n-    private final Map<String, Object> tags = new LinkedHashMap<String, Object>(defaultSpanTags);\n-    private long timestampMicro;\n-    private SpanContext parent;\n-    private String serviceName;\n-    private String resourceName;\n-    private boolean errorFlag;\n-    private String spanType;\n-    private boolean ignoreScope = false;\n-    private LogHandler logHandler = new DefaultLogHandler();\n-\n-    public DDSpanBuilder(final String operationName, final ScopeManager scopeManager) {\n-      this.operationName = operationName;\n-      this.scopeManager = scopeManager;\n+    @Override\n+    public DDSpanBuilder asChildOf(final SpanContext parent) {\n+      delegate.asChildOf(converter.toContext(parent));\n+      return this;\n     }\n \n     @Override\n-    public SpanBuilder ignoreActiveSpan() {\n-      ignoreScope = true;\n+    public DDSpanBuilder asChildOf(final Span parent) {\n+      if (parent != null) {\n+        delegate.asChildOf(converter.toAgentSpan(parent).context());\n+      }\n       return this;\n     }\n \n-    private Span startSpan() {\n-      return new DDSpan(timestampMicro, buildSpanContext(), logHandler);\n+    @Override\n+    public DDSpanBuilder addReference(\n+        final String referenceType, final SpanContext referencedContext) {\n+      if (referencedContext == null) {\n+        return this;\n+      }\n+\n+      final AgentSpan.Context context = converter.toContext(referencedContext);\n+      if (!(context instanceof ExtractedContext) && !(context instanceof DDSpanContext)) {\n+        log.debug(\n+            \"Expected to have a DDSpanContext or ExtractedContext but got \"\n+                + context.getClass().getName());\n+        return this;\n+      }\n+\n+      if (References.CHILD_OF.equals(referenceType)\n+          || References.FOLLOWS_FROM.equals(referenceType)) {\n+        delegate.asChildOf(context);\n+      } else {\n+        log.debug(\"Only support reference type of CHILD_OF and FOLLOWS_FROM\");\n+      }\n+\n+      return this;\n     }\n \n     @Override\n-    public Scope startActive(final boolean finishSpanOnClose) {\n-      final Span span = startSpan();\n-      final Scope scope = scopeManager.activate(span, finishSpanOnClose);\n-      log.debug(\"Starting a new active span: {}\", span);\n-      return scope;\n+    public DDSpanBuilder ignoreActiveSpan() {\n+      delegate.ignoreActiveSpan();\n+      return this;\n     }\n \n     @Override\n-    @Deprecated\n-    public Span startManual() {\n-      return start();\n+    public DDSpanBuilder withTag(final String key, final String value) {\n+      delegate.withTag(key, value);\n+      return this;\n     }\n \n     @Override\n-    public Span start() {\n-      final Span span = startSpan();\n-      log.debug(\"Starting a new span: {}\", span);\n-      return span;\n+    public DDSpanBuilder withTag(final String key, final boolean value) {\n+      delegate.withTag(key, value);\n+      return this;\n     }\n \n     @Override\n-    public DDSpanBuilder withTag(final String tag, final Number number) {\n-      return withTag(tag, (Object) number);\n+    public DDSpanBuilder withTag(final String key, final Number value) {\n+      delegate.withTag(key, value);\n+      return this;\n     }\n \n     @Override\n-    public DDSpanBuilder withTag(final String tag, final String string) {\n-      return withTag(tag, (Object) string);\n+    public <T> DDSpanBuilder withTag(final Tag<T> tag, final T value) {\n+      delegate.withTag(tag.getKey(), value);\n+      return this;\n     }\n \n     @Override\n-    public DDSpanBuilder withTag(final String tag, final boolean bool) {\n-      return withTag(tag, (Object) bool);\n+    public DDSpanBuilder withStartTimestamp(final long microseconds) {\n+      delegate.withStartTimestamp(microseconds);\n+      return this;\n     }\n \n     @Override\n-    public <T> SpanBuilder withTag(final Tag<T> tag, final T value) {\n-      return withTag(tag.getKey(), value);\n+    public Span startManual() {\n+      return start();\n     }\n \n     @Override\n-    public DDSpanBuilder withStartTimestamp(final long timestampMicroseconds) {\n-      timestampMicro = timestampMicroseconds;\n-      return this;\n+    public Span start() {\n+      final AgentSpan agentSpan = delegate.start();\n+      return converter.toSpan(agentSpan);\n+    }\n+\n+    @Override\n+    public Scope startActive(final boolean finishSpanOnClose) {\n+      final AgentScope agentScope = delegate.startActive(finishSpanOnClose);\n+      return converter.toScope(agentScope);\n     }\n \n     public DDSpanBuilder withServiceName(final String serviceName) {\n-      this.serviceName = serviceName;\n+      delegate.withServiceName(serviceName);\n       return this;\n     }\n \n     public DDSpanBuilder withResourceName(final String resourceName) {\n-      this.resourceName = resourceName;\n+      delegate.withResourceName(resourceName);\n       return this;\n     }\n \n     public DDSpanBuilder withErrorFlag() {\n-      errorFlag = true;\n+      delegate.withErrorFlag();\n       return this;\n     }\n \n     public DDSpanBuilder withSpanType(final String spanType) {\n-      this.spanType = spanType;\n+      delegate.withSpanType(spanType);\n       return this;\n     }\n \n-    public Iterable<Map.Entry<String, String>> baggageItems() {\n-      if (parent == null) {\n-        return Collections.emptyList();\n-      }\n-      return parent.baggageItems();\n-    }\n-\n     public DDSpanBuilder withLogHandler(final LogHandler logHandler) {\n       if (logHandler != null) {\n-        this.logHandler = logHandler;\n+        DDTracer.this.logHandler = logHandler;\n       }\n       return this;\n     }\n+  }\n+\n+  /** Allows custom scope managers to be passed in to constructor */\n+  private class CustomScopeManager implements DDScopeManager {\n+    private final ScopeManager delegate;\n+\n+    private CustomScopeManager(final ScopeManager scopeManager) {\n+      this.delegate = scopeManager;\n+    }\n \n     @Override\n-    public DDSpanBuilder asChildOf(final Span span) {\n-      return asChildOf(span == null ? null : span.context());\n+    public AgentScope activate(final AgentSpan agentSpan, final boolean finishOnClose) {\n+      final Span span = converter.toSpan(agentSpan);\n+      final Scope scope = delegate.activate(span, finishOnClose);\n+\n+      return new CustomScopeManagerScope(scope);\n     }\n \n     @Override\n-    public DDSpanBuilder asChildOf(final SpanContext spanContext) {\n-      parent = spanContext;\n-      return this;\n+    public TraceScope active() {\n+      return new CustomScopeManagerScope(delegate.active());\n     }\n \n     @Override\n-    public DDSpanBuilder addReference(final String referenceType, final SpanContext spanContext) {\n-      if (spanContext == null) {\n-        return this;\n-      }\n-      if (!(spanContext instanceof ExtractedContext) && !(spanContext instanceof DDSpanContext)) {\n-        log.debug(\n-            \"Expected to have a DDSpanContext or ExtractedContext but got \"\n-                + spanContext.getClass().getName());\n-        return this;\n+    public AgentSpan activeSpan() {\n+      return converter.toAgentSpan(delegate.activeSpan());\n+    }\n+  }\n+\n+  private class CustomScopeManagerScope implements AgentScope, TraceScope {\n+    private final Scope delegate;\n+    private final boolean traceScope;\n+\n+    private CustomScopeManagerScope(final Scope delegate) {\n+      this.delegate = delegate;\n+\n+      // Handle case where the custom scope manager returns TraceScopes\n+      traceScope = delegate instanceof TraceScope;\n+    }\n+\n+    @Override\n+    public AgentSpan span() {\n+      return converter.toAgentSpan(delegate.span());\n+    }\n+\n+    @Override\n+    public void setAsyncPropagation(final boolean value) {\n+      if (traceScope) {\n+        ((TraceScope) delegate).setAsyncPropagation(value);\n       }\n-      if (References.CHILD_OF.equals(referenceType)\n-          || References.FOLLOWS_FROM.equals(referenceType)) {\n-        return asChildOf(spanContext);\n+    }\n+\n+    @Override\n+    public boolean isAsyncPropagating() {\n+      return traceScope && ((TraceScope) delegate).isAsyncPropagating();\n+    }\n+\n+    @Override\n+    public Continuation capture() {\n+      if (traceScope) {\n+        return ((TraceScope) delegate).capture();\n       } else {\n-        log.debug(\"Only support reference type of CHILD_OF and FOLLOWS_FROM\");\n+        return null;\n       }\n-      return this;\n     }\n \n-    // Private methods\n-    private DDSpanBuilder withTag(final String tag, final Object value) {\n-      if (value == null || (value instanceof String && ((String) value).isEmpty())) {\n-        tags.remove(tag);\n-      } else {\n-        tags.put(tag, value);\n+    @Override\n+    public void close() {\n+      delegate.close();\n+    }\n+\n+    @Override\n+    public boolean equals(final Object o) {\n+      if (this == o) {\n+        return true;\n       }\n-      return this;\n+      if (o == null || getClass() != o.getClass()) {\n+        return false;\n+      }\n+      final CustomScopeManagerScope that = (CustomScopeManagerScope) o;\n+      return delegate.equals(that.delegate);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(delegate);\n+    }\n+  }\n+\n+  private class OTScopeManager implements ScopeManager {\n+    @Override\n+    public Scope activate(final Span span) {\n+      return activate(span, false);\n+    }\n+\n+    @Override\n+    public Scope activate(final Span span, final boolean finishSpanOnClose) {\n+      final AgentSpan agentSpan = converter.toAgentSpan(span);\n+      final AgentScope agentScope = coreTracer.activateSpan(agentSpan, finishSpanOnClose);\n+\n+      return converter.toScope(agentScope);\n+    }\n+\n+    @Override\n+    public Scope active() {\n+      return converter.toScope(coreTracer.activeScope());\n+    }\n+\n+    @Override\n+    public Span activeSpan() {\n+      return converter.toSpan(coreTracer.activeSpan());\n+    }\n+  }\n+\n+  private class OTGenericContext implements SpanContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb33b99af7d6399fda77a877f8e7e0372d9ce4bf"}, "originalPosition": 1082}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTE3ODg1", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-401117885", "createdAt": "2020-04-27T16:23:39Z", "commit": {"oid": "f2152ba920f1326d17f2b7b513dfac1a2ca03582"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoyMzozOVrOGMsHqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjozNjo0MFrOGMsvkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1ODk1NA==", "bodyText": "TypeConversions?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r415958954", "createdAt": "2020-04-27T16:23:39Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/Converter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package datadog.opentracing;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.AgentTracer;\n+import datadog.trace.context.TraceScope;\n+import datadog.trace.core.DDSpan;\n+import datadog.trace.core.DDSpanContext;\n+import datadog.trace.core.propagation.ExtractedContext;\n+import datadog.trace.core.propagation.TagContext;\n+import io.opentracing.Scope;\n+import io.opentracing.Span;\n+import io.opentracing.SpanContext;\n+import io.opentracing.noop.NoopSpan;\n+\n+// Centralized place to do conversions\n+class Converter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2152ba920f1326d17f2b7b513dfac1a2ca03582"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk2MDY3Ng==", "bodyText": "I'm not sure I understand why we need both OTScopeManager and CustomScopeManager... What do they do differently?", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r415960676", "createdAt": "2020-04-27T16:25:56Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/CustomScopeManager.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package datadog.opentracing;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.context.TraceScope;\n+import datadog.trace.core.scopemanager.DDScopeManager;\n+import io.opentracing.Scope;\n+import io.opentracing.ScopeManager;\n+import io.opentracing.Span;\n+import java.util.Objects;\n+\n+/**\n+ * Allows custom OpenTracing scope managers used by CoreTracer\n+ *\n+ * <p>Normal case:\n+ *\n+ * <p>CoreTracer.scopeManager = ContextualScopeManager\n+ *\n+ * <p>DDTracer.scopeManager = OTScopeManager wrapping CoreTracer.scopeManager\n+ *\n+ * <p>Custom case:\n+ *\n+ * <p>CoreTracer.scopeManager = CustomScopeManager wrapping passed in scopemanager\n+ *\n+ * <p>DDTracer.scopeManager = passed in scopemanager\n+ */\n+class CustomScopeManager implements DDScopeManager {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2152ba920f1326d17f2b7b513dfac1a2ca03582"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk2NDA4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * DDTracer implements the implements io.opentracing.Tracer API to make it easy to send traces and\n          \n          \n            \n             * DDTracer implements the io.opentracing.Tracer API to make it easy to send traces and", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r415964089", "createdAt": "2020-04-27T16:30:17Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -34,17 +28,23 @@\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Map.Entry;\n-import java.util.Objects;\n import java.util.Properties;\n import lombok.Builder;\n import lombok.extern.slf4j.Slf4j;\n \n+/**\n+ * DDTracer implements the implements io.opentracing.Tracer API to make it easy to send traces and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2152ba920f1326d17f2b7b513dfac1a2ca03582"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk2OTE3MQ==", "bodyText": "It's good that we're teasing this out... I think this is a good thing to follow up on.", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r415969171", "createdAt": "2020-04-27T16:36:40Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -260,6 +261,13 @@ private DDTracer(\n     }\n \n     coreTracer = builder.build();\n+\n+    // FIXME [API] There's an unfortunate cycle between OTScopeManager and CoreTracer where they\n+    // each depend on eachother so CoreTracer cant be a constructor parameter\n+    // Perhaps api can change so that CoreTracer doesn't need to implement scope methods directly\n+    if (scopeManager == null) {\n+      this.scopeManager = new OTScopeManager(coreTracer, converter);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2152ba920f1326d17f2b7b513dfac1a2ca03582"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c6f7945e50e037a7b27901dfdc9ee11786b2696", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4c6f7945e50e037a7b27901dfdc9ee11786b2696", "committedDate": "2020-04-30T14:37:26Z", "message": "Move to core project and datadog.trace.core packages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab89e2d745484738f750ee0845d6a9ba4d790bf7", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ab89e2d745484738f750ee0845d6a9ba4d790bf7", "committedDate": "2020-04-30T14:37:26Z", "message": "Codecs using Carrier and AgentPropagation.Setter/Getter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "355404760e731e7dcc38bb0079507a4bc726d4e0", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/355404760e731e7dcc38bb0079507a4bc726d4e0", "committedDate": "2020-04-30T14:43:45Z", "message": "Compilable dd-trace-core:main using Agent* classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "812c1d7c85bd3b18e8b73c609904c352fbeab308", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/812c1d7c85bd3b18e8b73c609904c352fbeab308", "committedDate": "2020-04-30T14:43:45Z", "message": "Remove last bits of OT Tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd0d6fc797a21589e0cf5c3842b0e2d46502a5fb", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fd0d6fc797a21589e0cf5c3842b0e2d46502a5fb", "committedDate": "2020-04-30T14:43:45Z", "message": "DDTracerOT with constructors and builders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11d95f4e5ad47e841019691baff7ab915862d8bc", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/11d95f4e5ad47e841019691baff7ab915862d8bc", "committedDate": "2020-04-30T14:43:45Z", "message": "Move LogHandler to OT project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5681ef1ff928b693831d51a3778ae99726cba862", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5681ef1ff928b693831d51a3778ae99726cba862", "committedDate": "2020-04-30T14:43:45Z", "message": "All OpenTracing<->Agent* wrappers implemented"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47f9cbfa5713c27142d787b1cf1f1678902a4a49", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/47f9cbfa5713c27142d787b1cf1f1678902a4a49", "committedDate": "2020-04-30T14:43:45Z", "message": "Fix tracer installers for agent and tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a10181c6852d0e2cbf7a11340aecc5df9f3be2f", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4a10181c6852d0e2cbf7a11340aecc5df9f3be2f", "committedDate": "2020-04-30T14:43:45Z", "message": "Remove OpenTracing32 class. It's unused"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd80fd760f19fc951bb4aaa2a253021eb2c1be06", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bd80fd760f19fc951bb4aaa2a253021eb2c1be06", "committedDate": "2020-04-30T14:43:45Z", "message": "Split SpanBuilderTest into two and fix issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86f88b3b9998981b6231dc4e1dbf500074958edd", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/86f88b3b9998981b6231dc4e1dbf500074958edd", "committedDate": "2020-04-30T14:45:01Z", "message": "core tests compiling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78479001ebc97232e720696c78f761748daa09f8", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/78479001ebc97232e720696c78f761748daa09f8", "committedDate": "2020-04-30T14:45:01Z", "message": "SetAsyncPropagation no longer returns AgentScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ef409535f4ee1c5f28766c02757ad147241ae7a", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8ef409535f4ee1c5f28766c02757ad147241ae7a", "committedDate": "2020-04-30T14:45:01Z", "message": "Passing tests in core and ot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae1307029ead5a11361aeb58d463d128c5dc7013", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ae1307029ead5a11361aeb58d463d128c5dc7013", "committedDate": "2020-04-30T14:45:01Z", "message": "Fix OT31 and OT33 tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4da2680707f7dc3deb12fc0dd5522dd1f8d334c", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c4da2680707f7dc3deb12fc0dd5522dd1f8d334c", "committedDate": "2020-04-30T14:45:01Z", "message": "Rename DDTraceOTInfo -> DDTraceCoreInfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd3866416d95a5c723a8fb5b4f0c7c7b7ed23bfc", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fd3866416d95a5c723a8fb5b4f0c7c7b7ed23bfc", "committedDate": "2020-04-30T14:45:01Z", "message": "More fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "076970d78596ff3f3539727f639ac47fbc3a0710", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/076970d78596ff3f3539727f639ac47fbc3a0710", "committedDate": "2020-04-30T14:45:01Z", "message": "Add equals() and hashcode() to wrappers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5272ac5fd4f6f9dad254e487f3d61287f8e3151c", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5272ac5fd4f6f9dad254e487f3d61287f8e3151c", "committedDate": "2020-04-30T14:45:01Z", "message": "Create internal-api project for Agent* classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7729f6dbe4ac69eee8593c6560da222c8c9e59a7", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7729f6dbe4ac69eee8593c6560da222c8c9e59a7", "committedDate": "2020-04-30T14:45:01Z", "message": "Fix formatting drift from core move rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2092edf56a5527a25b8c7fe1dd8dc4aa8da38682", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2092edf56a5527a25b8c7fe1dd8dc4aa8da38682", "committedDate": "2020-04-30T14:45:01Z", "message": "DDTracer->CoreTracer; DDTracerOT -> DDTracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92965acf39684179a93b5795970fe418632d16c5", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/92965acf39684179a93b5795970fe418632d16c5", "committedDate": "2020-04-30T14:45:01Z", "message": "shadow rename core package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0a513e7c625b4a299363a2da11443d3ae262ff7", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d0a513e7c625b4a299363a2da11443d3ae262ff7", "committedDate": "2020-04-30T14:45:01Z", "message": "Add core to ignores matcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa863274f4867d56c548f1086b3028f36f54c3e2", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/aa863274f4867d56c548f1086b3028f36f54c3e2", "committedDate": "2020-04-30T14:45:01Z", "message": "Fix opentracing gradle dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e65a3d629a55f768b81ee935a75d84dd74d8d764", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e65a3d629a55f768b81ee935a75d84dd74d8d764", "committedDate": "2020-04-30T14:45:01Z", "message": "Fix GRPC test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8eebff9657820dbdd060285b027ac6340ecc246e", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8eebff9657820dbdd060285b027ac6340ecc246e", "committedDate": "2020-04-30T14:45:01Z", "message": "FIx RequestDispatcherTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1701d2889008d0a7a459b2e38557ef4d798ef43b", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1701d2889008d0a7a459b2e38557ef4d798ef43b", "committedDate": "2020-04-30T14:45:01Z", "message": "Have SimpleScope implement TraceScope to some fix weirdness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07f3276e71322a201418fb2489638bdd8617ae0f", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/07f3276e71322a201418fb2489638bdd8617ae0f", "committedDate": "2020-04-30T14:45:01Z", "message": "Delegate DDTracer constructors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70900cefa84725aaaf96490027d7a2a93181bd8f", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/70900cefa84725aaaf96490027d7a2a93181bd8f", "committedDate": "2020-04-30T14:45:01Z", "message": "Copy updated string split behavior for headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78bf3dcb651c34581d907caef5f06f67af5cc899", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/78bf3dcb651c34581d907caef5f06f67af5cc899", "committedDate": "2020-04-30T14:45:01Z", "message": "Annoyingly, DDTracer needs to delegate api.Tracer as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3848486f598fb0993cab4dace713b7eaff2a9442", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3848486f598fb0993cab4dace713b7eaff2a9442", "committedDate": "2020-04-30T14:45:01Z", "message": "Add \"isSameTrace()\" from spring-dispatcher pull"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b86991c6a00f84da8a421be144dc77040a4fc81", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1b86991c6a00f84da8a421be144dc77040a4fc81", "committedDate": "2020-04-30T14:45:01Z", "message": "Fix rebase issues and use removeTag() in rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4d4a3b0c20cc94166065a04b58fe4c29d73da54", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b4d4a3b0c20cc94166065a04b58fe4c29d73da54", "committedDate": "2020-04-30T14:45:01Z", "message": "Add api checker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f43b86fb65822374ee017e127cf529ef29a81a", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/51f43b86fb65822374ee017e127cf529ef29a81a", "committedDate": "2020-04-30T14:45:01Z", "message": "#1377 changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d7e77c831e5ebb53bff74395bea9d49642bd7b9", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0d7e77c831e5ebb53bff74395bea9d49642bd7b9", "committedDate": "2020-04-30T14:45:01Z", "message": "Fix issues from rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8b2426b95734f9c21fb3f9313cb780262be7242", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a8b2426b95734f9c21fb3f9313cb780262be7242", "committedDate": "2020-04-30T14:45:01Z", "message": "Update revapi justifications with newer changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a1e709f93ecb098c11ef37e47ffc170c2d581be", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7a1e709f93ecb098c11ef37e47ffc170c2d581be", "committedDate": "2020-04-30T14:45:01Z", "message": "Manually add core transitive dependencies to OT pom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87b33c70dd58e4d971e85b94ba76ab575a7184c9", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/87b33c70dd58e4d971e85b94ba76ab575a7184c9", "committedDate": "2020-04-30T14:45:01Z", "message": "Remove reverted test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "201cd4e664b9d4de9254b93404e7509aa6b0d4d4", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/201cd4e664b9d4de9254b93404e7509aa6b0d4d4", "committedDate": "2020-04-30T14:45:01Z", "message": "Update some javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4d11bb7bd2fd421a6b2240be21e66ebce109c22", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d4d11bb7bd2fd421a6b2240be21e66ebce109c22", "committedDate": "2020-04-30T14:45:02Z", "message": "Add dependency comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc2d2f1f28f3acda3f8dec6ae3f3ee70ada0b22c", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bc2d2f1f28f3acda3f8dec6ae3f3ee70ada0b22c", "committedDate": "2020-04-30T14:45:02Z", "message": "Make a bunch of classes toplevel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73b2a50d2259b64d5d192141a21f16ae6135e65d", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/73b2a50d2259b64d5d192141a21f16ae6135e65d", "committedDate": "2020-04-30T14:45:02Z", "message": "Minor text changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3e0a7bfd5f35e1f9ad746555e69830e837f87d7", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d3e0a7bfd5f35e1f9ad746555e69830e837f87d7", "committedDate": "2020-04-30T14:45:02Z", "message": "A couple class name changes to make things slight clearer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1aa60797d801e4f0d4009f483dd7c866cf5a5b", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ca1aa60797d801e4f0d4009f483dd7c866cf5a5b", "committedDate": "2020-04-30T14:45:02Z", "message": "A bunch of tests to increase coverage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f4637279ab99885212569b79f25c44ac3dc0229", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1f4637279ab99885212569b79f25c44ac3dc0229", "committedDate": "2020-04-29T23:03:51Z", "message": "Add OpenTracing smoke tests"}, "afterCommit": {"oid": "ae57a699fa99d879c1271562d31b3e15fc12c728", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ae57a699fa99d879c1271562d31b3e15fc12c728", "committedDate": "2020-04-30T15:19:57Z", "message": "Rebase fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37823ec2191a0479175cece438ab98ea270bb66", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e37823ec2191a0479175cece438ab98ea270bb66", "committedDate": "2020-04-30T16:16:42Z", "message": "Add OpenTracing smoke tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae57a699fa99d879c1271562d31b3e15fc12c728", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ae57a699fa99d879c1271562d31b3e15fc12c728", "committedDate": "2020-04-30T15:19:57Z", "message": "Rebase fixup"}, "afterCommit": {"oid": "66560629ce3699bdfb8ae8e83376d867f1a91f20", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/66560629ce3699bdfb8ae8e83376d867f1a91f20", "committedDate": "2020-04-30T16:16:42Z", "message": "Rebase fixup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66560629ce3699bdfb8ae8e83376d867f1a91f20", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/66560629ce3699bdfb8ae8e83376d867f1a91f20", "committedDate": "2020-04-30T16:16:42Z", "message": "Rebase fixup"}, "afterCommit": {"oid": "82179324e76a4a37f2dde53bd1c559bab6db1b51", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/82179324e76a4a37f2dde53bd1c559bab6db1b51", "committedDate": "2020-04-30T17:03:12Z", "message": "Rebase fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faa3063b1928623eb469989c044df3fb64bb9642", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/faa3063b1928623eb469989c044df3fb64bb9642", "committedDate": "2020-04-30T17:37:18Z", "message": "Rebase fixup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82179324e76a4a37f2dde53bd1c559bab6db1b51", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/82179324e76a4a37f2dde53bd1c559bab6db1b51", "committedDate": "2020-04-30T17:03:12Z", "message": "Rebase fixup"}, "afterCommit": {"oid": "faa3063b1928623eb469989c044df3fb64bb9642", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/faa3063b1928623eb469989c044df3fb64bb9642", "committedDate": "2020-04-30T17:37:18Z", "message": "Rebase fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNzc3MDcw", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#pullrequestreview-403777070", "createdAt": "2020-04-30T18:33:46Z", "commit": {"oid": "faa3063b1928623eb469989c044df3fb64bb9642"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODozMzo0NlrOGO1gpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODozMzo0NlrOGO1gpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwOTk1OA==", "bodyText": "Nice.  The lack of reporting validation was one of the causes for the classloader issue.", "url": "https://github.com/DataDog/dd-trace-java/pull/1354#discussion_r418209958", "createdAt": "2020-04-30T18:33:46Z", "author": {"login": "tylerbenson"}, "path": "dd-smoke-tests/src/main/groovy/datadog/smoketest/AbstractSmokeTest.groovy", "diffHunk": "@@ -26,6 +33,28 @@ abstract class AbstractSmokeTest extends Specification {\n   @Shared\n   protected Process serverProcess\n \n+  @Shared\n+  protected BlockingQueue<TestHttpServer.HandlerApi.RequestApi> traceRequests = new LinkedBlockingQueue<>()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faa3063b1928623eb469989c044df3fb64bb9642"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2628, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}