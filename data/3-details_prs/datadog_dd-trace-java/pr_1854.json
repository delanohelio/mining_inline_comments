{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzOTA3NTg1", "number": 1854, "title": "Trace processing pipeline timing", "bodyText": "Renames Monitor (the thing we refer to as \"health metrics\" internally) HealthMetrics\nCreates a Monitoring class which is essentially a factory for timers and, in the future, gauges\nImplements a parsimonious thread local Timer based on a packed HdrHistogram\nAdds timing to various scopes int he trace processing timeline\n\nduty cycles\nbuffer fill ups (may become a gauge in the future)\nagent discovery time\nagent response time (may become a gauge in the future)\npending trace write lock time", "createdAt": "2020-09-10T14:11:16Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1854", "merged": true, "mergeCommit": {"oid": "a1a05e8ac40c8bdf7a736a6e0a206e3bddd40cea"}, "closed": true, "closedAt": "2020-09-11T08:15:36Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHhixQgBqjM3NTEzMzY0Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHwrYeAFqTQ4NjU0OTIxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d25ce24bf776af7e94cd39cff5e3e0ae71182dc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0d25ce24bf776af7e94cd39cff5e3e0ae71182dc", "committedDate": "2020-09-10T14:10:04Z", "message": "rename Monitoring to HealthMetrics, introduce Monitoring as a factory for timers, add timing in important places"}, "afterCommit": {"oid": "e161d3786a689c76cf9af153a0b0602e3a1f65bd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e161d3786a689c76cf9af153a0b0602e3a1f65bd", "committedDate": "2020-09-10T14:19:24Z", "message": "rename Monitoring to HealthMetrics, introduce Monitoring as a factory for timers, add timing in important places"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99e7c022765605205de99751d80830b709ed6f6c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/99e7c022765605205de99751d80830b709ed6f6c", "committedDate": "2020-09-10T14:48:35Z", "message": "revapi"}, "afterCommit": {"oid": "9d749641cbdf61bd885ac810a053fd2b0ffa1b43", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9d749641cbdf61bd885ac810a053fd2b0ffa1b43", "committedDate": "2020-09-10T14:52:04Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d749641cbdf61bd885ac810a053fd2b0ffa1b43", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9d749641cbdf61bd885ac810a053fd2b0ffa1b43", "committedDate": "2020-09-10T14:52:04Z", "message": "revapi"}, "afterCommit": {"oid": "c90c538f4398f959afc9bff425c1ac054afd92e8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c90c538f4398f959afc9bff425c1ac054afd92e8", "committedDate": "2020-09-10T15:06:39Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c90c538f4398f959afc9bff425c1ac054afd92e8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c90c538f4398f959afc9bff425c1ac054afd92e8", "committedDate": "2020-09-10T15:06:39Z", "message": "revapi"}, "afterCommit": {"oid": "5599c8f8745ba928021ffe1d58dbb23b3378fa74", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5599c8f8745ba928021ffe1d58dbb23b3378fa74", "committedDate": "2020-09-10T15:36:48Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5599c8f8745ba928021ffe1d58dbb23b3378fa74", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5599c8f8745ba928021ffe1d58dbb23b3378fa74", "committedDate": "2020-09-10T15:36:48Z", "message": "revapi"}, "afterCommit": {"oid": "a1e4503a07834b41ab77f368d27c5e05b125bd33", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a1e4503a07834b41ab77f368d27c5e05b125bd33", "committedDate": "2020-09-10T15:58:32Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1e4503a07834b41ab77f368d27c5e05b125bd33", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a1e4503a07834b41ab77f368d27c5e05b125bd33", "committedDate": "2020-09-10T15:58:32Z", "message": "revapi"}, "afterCommit": {"oid": "1bb00609554f898b9fc27a2a73e10a42069b88d8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1bb00609554f898b9fc27a2a73e10a42069b88d8", "committedDate": "2020-09-10T16:44:34Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bb00609554f898b9fc27a2a73e10a42069b88d8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1bb00609554f898b9fc27a2a73e10a42069b88d8", "committedDate": "2020-09-10T16:44:34Z", "message": "revapi"}, "afterCommit": {"oid": "0be594757960154016a231a12be4f9ce83d98dc3", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0be594757960154016a231a12be4f9ce83d98dc3", "committedDate": "2020-09-10T17:01:30Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b44fe1089000eddd715229f47b72f02feb085e9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9b44fe1089000eddd715229f47b72f02feb085e9", "committedDate": "2020-09-10T17:28:16Z", "message": "time pending trace writer lock"}, "afterCommit": {"oid": "f70e42c0f0dd39e40f7fc2da68ba21c43f220986", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f70e42c0f0dd39e40f7fc2da68ba21c43f220986", "committedDate": "2020-09-10T18:05:16Z", "message": "time pending trace writer lock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTg1MDMw", "url": "https://github.com/DataDog/dd-trace-java/pull/1854#pullrequestreview-486185030", "createdAt": "2020-09-10T18:06:53Z", "commit": {"oid": "9b44fe1089000eddd715229f47b72f02feb085e9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODowNzo0NVrOHP_z6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODowNzo0NVrOHP_z6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzNjE2OA==", "bodyText": "I think you need a name change for monitor here and several other places in this PR... I won't repeat the comment over again.", "url": "https://github.com/DataDog/dd-trace-java/pull/1854#discussion_r486536168", "createdAt": "2020-09-10T18:07:45Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/common/writer/PayloadDispatcherTest.groovy", "diffHunk": "@@ -10,19 +11,25 @@ import datadog.trace.core.CoreTracer\n import datadog.trace.core.DDSpan\n import datadog.trace.core.DDSpanContext\n import datadog.trace.core.PendingTrace\n-import datadog.trace.core.monitor.Monitor\n+import datadog.trace.core.monitor.HealthMetrics\n+import datadog.trace.core.monitor.Monitoring\n import datadog.trace.util.test.DDSpecification\n+import spock.lang.Shared\n import spock.lang.Timeout\n \n+import java.util.concurrent.TimeUnit\n import java.util.concurrent.atomic.AtomicBoolean\n \n class PayloadDispatcherTest extends DDSpecification {\n \n+  @Shared\n+  Monitoring monitoring = new Monitoring(new NoOpStatsDClient(), 1, TimeUnit.SECONDS)\n+\n   def \"dropped traces should be reported in the representativeCount\"() {\n     setup:\n-    Monitor monitor = Mock(Monitor)\n+    HealthMetrics monitor = Mock(HealthMetrics)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f70e42c0f0dd39e40f7fc2da68ba21c43f220986"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f70e42c0f0dd39e40f7fc2da68ba21c43f220986", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f70e42c0f0dd39e40f7fc2da68ba21c43f220986", "committedDate": "2020-09-10T18:05:16Z", "message": "time pending trace writer lock"}, "afterCommit": {"oid": "a5d88f5e12d5a2a062567a58976da70a55a7bc9f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a5d88f5e12d5a2a062567a58976da70a55a7bc9f", "committedDate": "2020-09-10T18:14:45Z", "message": "time pending trace writer lock"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5d88f5e12d5a2a062567a58976da70a55a7bc9f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a5d88f5e12d5a2a062567a58976da70a55a7bc9f", "committedDate": "2020-09-10T18:14:45Z", "message": "time pending trace writer lock"}, "afterCommit": {"oid": "a726753d84d051d8b21de8aedaa56a6a2660e7ed", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a726753d84d051d8b21de8aedaa56a6a2660e7ed", "committedDate": "2020-09-10T18:22:39Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a726753d84d051d8b21de8aedaa56a6a2660e7ed", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a726753d84d051d8b21de8aedaa56a6a2660e7ed", "committedDate": "2020-09-10T18:22:39Z", "message": "revapi"}, "afterCommit": {"oid": "1317d4d70e68c3c329e33dfc3a7f5db53d8349cf", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1317d4d70e68c3c329e33dfc3a7f5db53d8349cf", "committedDate": "2020-09-10T18:40:17Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1317d4d70e68c3c329e33dfc3a7f5db53d8349cf", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1317d4d70e68c3c329e33dfc3a7f5db53d8349cf", "committedDate": "2020-09-10T18:40:17Z", "message": "revapi"}, "afterCommit": {"oid": "f8f2c64e6baec0d3029ab5501be6d6a95bfa97ab", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f8f2c64e6baec0d3029ab5501be6d6a95bfa97ab", "committedDate": "2020-09-10T18:51:38Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8f2c64e6baec0d3029ab5501be6d6a95bfa97ab", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f8f2c64e6baec0d3029ab5501be6d6a95bfa97ab", "committedDate": "2020-09-10T18:51:38Z", "message": "revapi"}, "afterCommit": {"oid": "b6b7398c63e20c7a247eb9e33f1f8329aa689b29", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b6b7398c63e20c7a247eb9e33f1f8329aa689b29", "committedDate": "2020-09-10T19:26:41Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6b7398c63e20c7a247eb9e33f1f8329aa689b29", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b6b7398c63e20c7a247eb9e33f1f8329aa689b29", "committedDate": "2020-09-10T19:26:41Z", "message": "revapi"}, "afterCommit": {"oid": "67394f5d76d2dc6a5bef43a807734d029eae6acd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/67394f5d76d2dc6a5bef43a807734d029eae6acd", "committedDate": "2020-09-10T19:35:15Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67394f5d76d2dc6a5bef43a807734d029eae6acd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/67394f5d76d2dc6a5bef43a807734d029eae6acd", "committedDate": "2020-09-10T19:35:15Z", "message": "revapi"}, "afterCommit": {"oid": "ceaffb601dcaee278d2ef0f2ab27821589e2df96", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ceaffb601dcaee278d2ef0f2ab27821589e2df96", "committedDate": "2020-09-10T19:51:03Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ceaffb601dcaee278d2ef0f2ab27821589e2df96", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ceaffb601dcaee278d2ef0f2ab27821589e2df96", "committedDate": "2020-09-10T19:51:03Z", "message": "revapi"}, "afterCommit": {"oid": "6774516d64a458c968d15a639cfedec2158a2bb9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6774516d64a458c968d15a639cfedec2158a2bb9", "committedDate": "2020-09-10T20:06:03Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6774516d64a458c968d15a639cfedec2158a2bb9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6774516d64a458c968d15a639cfedec2158a2bb9", "committedDate": "2020-09-10T20:06:03Z", "message": "revapi"}, "afterCommit": {"oid": "972e000ba7aba37e98e3e5283e1f80619fe57868", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/972e000ba7aba37e98e3e5283e1f80619fe57868", "committedDate": "2020-09-10T20:09:27Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "972e000ba7aba37e98e3e5283e1f80619fe57868", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/972e000ba7aba37e98e3e5283e1f80619fe57868", "committedDate": "2020-09-10T20:09:27Z", "message": "revapi"}, "afterCommit": {"oid": "7dc89617b9556481fd99353a0452404eb18c1018", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7dc89617b9556481fd99353a0452404eb18c1018", "committedDate": "2020-09-10T20:19:00Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7dc89617b9556481fd99353a0452404eb18c1018", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7dc89617b9556481fd99353a0452404eb18c1018", "committedDate": "2020-09-10T20:19:00Z", "message": "revapi"}, "afterCommit": {"oid": "ecb9087a9a0fe3f027b70a37b621e4ac7897653c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ecb9087a9a0fe3f027b70a37b621e4ac7897653c", "committedDate": "2020-09-10T20:29:41Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ecb9087a9a0fe3f027b70a37b621e4ac7897653c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ecb9087a9a0fe3f027b70a37b621e4ac7897653c", "committedDate": "2020-09-10T20:29:41Z", "message": "revapi"}, "afterCommit": {"oid": "a7bf56ce95611a5565e280ead253d29ae55255aa", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a7bf56ce95611a5565e280ead253d29ae55255aa", "committedDate": "2020-09-10T20:36:04Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7bf56ce95611a5565e280ead253d29ae55255aa", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a7bf56ce95611a5565e280ead253d29ae55255aa", "committedDate": "2020-09-10T20:36:04Z", "message": "revapi"}, "afterCommit": {"oid": "b33350b2d34eedc7981676735e00936a78c5b61d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b33350b2d34eedc7981676735e00936a78c5b61d", "committedDate": "2020-09-10T20:38:41Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b33350b2d34eedc7981676735e00936a78c5b61d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b33350b2d34eedc7981676735e00936a78c5b61d", "committedDate": "2020-09-10T20:38:41Z", "message": "revapi"}, "afterCommit": {"oid": "089fecad2434eaf539d732fa738fba8260cf37fd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/089fecad2434eaf539d732fa738fba8260cf37fd", "committedDate": "2020-09-10T20:51:08Z", "message": "revapi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b2035bc10c18949be275d951361bd3562d10c6f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2b2035bc10c18949be275d951361bd3562d10c6f", "committedDate": "2020-09-10T21:04:28Z", "message": "rename Monitoring to HealthMetrics, introduce Monitoring as a factory for timers, add timing in important places"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fce432fb757ea6266058403577e6b667f1786670", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fce432fb757ea6266058403577e6b667f1786670", "committedDate": "2020-09-10T21:04:28Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "089fecad2434eaf539d732fa738fba8260cf37fd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/089fecad2434eaf539d732fa738fba8260cf37fd", "committedDate": "2020-09-10T20:51:08Z", "message": "revapi"}, "afterCommit": {"oid": "fce432fb757ea6266058403577e6b667f1786670", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fce432fb757ea6266058403577e6b667f1786670", "committedDate": "2020-09-10T21:04:28Z", "message": "revapi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTQ5MjE5", "url": "https://github.com/DataDog/dd-trace-java/pull/1854#pullrequestreview-486549219", "createdAt": "2020-09-11T07:45:58Z", "commit": {"oid": "2b2035bc10c18949be275d951361bd3562d10c6f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNzo0NTo1OFrOHQSD4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNzo1NTozM1rOHQSX8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzNTE2OA==", "bodyText": "So how does this compare in the backend as opposed to a normal histogram that the agent has computed? I would love for statsd/dogstatsd to have a way to send a histogram in a compact way as one metric.", "url": "https://github.com/DataDog/dd-trace-java/pull/1854#discussion_r486835168", "createdAt": "2020-09-11T07:45:58Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/monitor/Timer.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package datadog.trace.core.monitor;\n+\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+\n+import com.timgroup.statsd.StatsDClient;\n+import java.util.Arrays;\n+import org.HdrHistogram.PackedHistogram;\n+\n+/**\n+ * A timer which records times in a histogram, and flushes stats from the histogram after a\n+ * configurable period of time.\n+ */\n+public class Timer extends Recording {\n+\n+  private static final long THIRTY_SECONDS_AS_NANOS = SECONDS.toNanos(30);\n+\n+  private static final String[] MEAN = new String[] {\"stat:avg\"};\n+  private static final String[] P_50 = new String[] {\"stat:p50\"};\n+  private static final String[] P_99 = new String[] {\"stat:p99\"};\n+  private static final String[] MAX = new String[] {\"stat:max\"};\n+\n+  private final String name;\n+  private final StatsDClient statsd;\n+  private final PackedHistogram histogram;\n+  private final long flushAfterNanos;\n+\n+  private final String[] meanTags;\n+  private final String[] p50Tags;\n+  private final String[] p99Tags;\n+  private final String[] maxTags;\n+\n+  private long start;\n+  private long lastFlush = 0;\n+\n+  Timer(final String name, final String[] tags, final StatsDClient statsd, long flushAfterNanos) {\n+    this.name = name;\n+    this.statsd = statsd;\n+    this.flushAfterNanos = flushAfterNanos;\n+    this.histogram = new PackedHistogram(THIRTY_SECONDS_AS_NANOS, 3);\n+    this.meanTags = mergeTags(MEAN, tags);\n+    this.p50Tags = mergeTags(P_50, tags);\n+    this.p99Tags = mergeTags(P_99, tags);\n+    this.maxTags = mergeTags(MAX, tags);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b2035bc10c18949be275d951361bd3562d10c6f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0MDMwNg==", "bodyText": "This is nice. Using AutoCloseable makes the code less cluttered.", "url": "https://github.com/DataDog/dd-trace-java/pull/1854#discussion_r486840306", "createdAt": "2020-09-11T07:55:33Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/monitor/Recording.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package datadog.trace.core.monitor;\n+\n+public abstract class Recording implements AutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b2035bc10c18949be275d951361bd3562d10c6f"}, "originalPosition": 3}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3099, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}