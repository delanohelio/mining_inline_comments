{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MjI5NjA3", "number": 1821, "title": "add writer to print trace structure", "bodyText": "", "createdAt": "2020-09-01T17:30:29Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1821", "merged": true, "mergeCommit": {"oid": "cd45390f70a4903a443660edca2484e3614d7f19"}, "closed": true, "closedAt": "2020-09-02T08:28:01Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEq_EbABqjM3MTYwOTI4MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE279jAFqTQ4MDU1NTg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9600cd5224d346fdcdd55280098ed0a84f0c8c79", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9600cd5224d346fdcdd55280098ed0a84f0c8c79", "committedDate": "2020-09-01T17:28:18Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}, "afterCommit": {"oid": "fbc07478856d7cc6cd385c4f55c33de6e98d3952", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fbc07478856d7cc6cd385c4f55c33de6e98d3952", "committedDate": "2020-09-01T17:37:41Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fbc07478856d7cc6cd385c4f55c33de6e98d3952", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fbc07478856d7cc6cd385c4f55c33de6e98d3952", "committedDate": "2020-09-01T17:37:41Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}, "afterCommit": {"oid": "84d3c2cf425607ddad663487a1d4fa658d04d186", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/84d3c2cf425607ddad663487a1d4fa658d04d186", "committedDate": "2020-09-01T17:59:01Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8982d75ae715e9683b959375c504dba6df93dd0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d8982d75ae715e9683b959375c504dba6df93dd0", "committedDate": "2020-09-01T18:25:52Z", "message": "make spring boot/grpc test fail when tracing fails"}, "afterCommit": {"oid": "6e53d3deb3e60cb3d1401ef23808e5c9f258dfc9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6e53d3deb3e60cb3d1401ef23808e5c9f258dfc9", "committedDate": "2020-09-01T19:48:54Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e53d3deb3e60cb3d1401ef23808e5c9f258dfc9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6e53d3deb3e60cb3d1401ef23808e5c9f258dfc9", "committedDate": "2020-09-01T19:48:54Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}, "afterCommit": {"oid": "529eb592b7b209c896b0429820b7512b215aa0fe", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/529eb592b7b209c896b0429820b7512b215aa0fe", "committedDate": "2020-09-01T20:02:04Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "249bbd7a56c7ee3feb53d25365d9b7714ba237a5", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/249bbd7a56c7ee3feb53d25365d9b7714ba237a5", "committedDate": "2020-09-01T20:20:56Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "529eb592b7b209c896b0429820b7512b215aa0fe", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/529eb592b7b209c896b0429820b7512b215aa0fe", "committedDate": "2020-09-01T20:02:04Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}, "afterCommit": {"oid": "249bbd7a56c7ee3feb53d25365d9b7714ba237a5", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/249bbd7a56c7ee3feb53d25365d9b7714ba237a5", "committedDate": "2020-09-01T20:20:56Z", "message": "add writer to print trace structure, optionally to a file, to enable verification of smoke test traces"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTMzODUz", "url": "https://github.com/DataDog/dd-trace-java/pull/1821#pullrequestreview-480533853", "createdAt": "2020-09-02T06:58:49Z", "commit": {"oid": "249bbd7a56c7ee3feb53d25365d9b7714ba237a5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNjo1ODo1MFrOHLfJDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNjo1ODo1MFrOHLfJDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgwNjYwNw==", "bodyText": "Could we add a check for a broken traceId as well? I know it shouldn't happen, but who knows...", "url": "https://github.com/DataDog/dd-trace-java/pull/1821#discussion_r481806607", "createdAt": "2020-09-02T06:58:50Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/TraceStructureWriter.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package datadog.trace.common.writer;\n+\n+import datadog.trace.api.DDId;\n+import datadog.trace.core.DDSpan;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.PrintStream;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class TraceStructureWriter implements Writer {\n+\n+  private final PrintStream out;\n+\n+  public TraceStructureWriter() {\n+    this(\"\");\n+  }\n+\n+  public TraceStructureWriter(String outputFile) {\n+    try {\n+      this.out =\n+          outputFile.isEmpty() || outputFile.equals(\":\")\n+              ? System.err\n+              : new PrintStream(new FileOutputStream(new File(outputFile.replace(\":\", \"\"))));\n+    } catch (IOException e) {\n+      throw new RuntimeException(\"Failed to create trace structure writer from \" + outputFile, e);\n+    }\n+  }\n+\n+  @Override\n+  public void write(List<DDSpan> trace) {\n+    if (trace.isEmpty()) {\n+      out.println(\"[]\");\n+    } else {\n+      DDId traceId = trace.get(0).getTraceId();\n+      DDId rootSpanId = trace.get(0).getSpanId();\n+      Map<DDId, Node> nodesById = new HashMap<>();\n+      // index the tree\n+      for (DDSpan span : trace) {\n+        if (DDId.ZERO.equals(span.getParentId())) {\n+          rootSpanId = span.getSpanId();\n+        }\n+        nodesById.put(span.getSpanId(), new Node(span));\n+      }\n+      // build the tree\n+      for (DDSpan span : trace) {\n+        if (!rootSpanId.equals(span.getSpanId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "249bbd7a56c7ee3feb53d25365d9b7714ba237a5"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12fa93c4e75781270d81d8a6c08a6fbdb98ed442", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/12fa93c4e75781270d81d8a6c08a6fbdb98ed442", "committedDate": "2020-09-02T07:32:27Z", "message": "cap opentelemetry instrumentation at 0.8.0 owing to API breaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTU1ODk2", "url": "https://github.com/DataDog/dd-trace-java/pull/1821#pullrequestreview-480555896", "createdAt": "2020-09-02T07:33:17Z", "commit": {"oid": "12fa93c4e75781270d81d8a6c08a6fbdb98ed442"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNzozMzoxN1rOHLg2Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNzozMzoxN1rOHLg2Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgzNDU3OA==", "bodyText": "Looks like they broke API and muzzle started failing :(", "url": "https://github.com/DataDog/dd-trace-java/pull/1821#discussion_r481834578", "createdAt": "2020-09-02T07:33:17Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/opentelemetry/opentelemetry.gradle", "diffHunk": "@@ -5,7 +5,7 @@ muzzle {\n   pass {\n     module = 'opentelemetry-api'\n     group = 'io.opentelemetry'\n-    versions = \"[$otelVersion,]\"\n+    versions = \"[$otelVersion,0.8.0)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12fa93c4e75781270d81d8a6c08a6fbdb98ed442"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1989, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}