{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMTExODAy", "number": 1493, "title": "Allow traces to be reported if continuations are GC'd before activation.", "bodyText": "Split up tracking between spans and continuations for better logging.\nRestructure the logs for better consistency.", "createdAt": "2020-05-22T19:39:03Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1493", "merged": true, "mergeCommit": {"oid": "47e9c9a052aaf2e08b97ca4fb1541b43870deeba"}, "closed": true, "closedAt": "2020-05-22T21:20:38Z", "author": {"login": "tylerbenson"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcj3k7qgH2gAyNDIyMTExODAyOjdhNWU1OGVhNGU0MGI3ZWE2YjVmNjc3NGNhMDllZmVhZThkNjdiMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj44TmgFqTQxNzE4NDA5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a5e58ea4e40b7ea6b5f6774ca09efeae8d67b30", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7a5e58ea4e40b7ea6b5f6774ca09efeae8d67b30", "committedDate": "2020-05-22T19:38:33Z", "message": "Allow traces to be reported if continuations are GC'd before activation.\n\nSplit up tracking between spans and continuations for better logging.\nRestructure the logs for better consistency."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTQ5NjA4", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#pullrequestreview-417149608", "createdAt": "2020-05-22T19:41:51Z", "commit": {"oid": "7a5e58ea4e40b7ea6b5f6774ca09efeae8d67b30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MTo1MVrOGZiDRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MTo1MVrOGZiDRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyNTQ3OQ==", "bodyText": "This is the main change.", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r429425479", "createdAt": "2020-05-22T19:41:51Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -249,8 +260,18 @@ private synchronized void write() {\n   public synchronized boolean clean() {\n     Reference ref;\n     int count = 0;\n-    while ((ref = referenceQueue.poll()) != null) {\n-      weakReferences.remove(ref);\n+    while ((ref = continuationReferenceQueue.poll()) != null) {\n+      weakContinuations.remove(ref);\n+      count++;\n+      expireReference();\n+    }\n+    if (count > 0) {\n+      log.debug(\"t_id={} -> {} unfinished continuations garbage collected.\", traceId, count);\n+    }\n+\n+    count = 0;\n+    while ((ref = spanReferenceQueue.poll()) != null) {\n+      weakSpans.remove(ref);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a5e58ea4e40b7ea6b5f6774ca09efeae8d67b30"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTQ5ODMy", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#pullrequestreview-417149832", "createdAt": "2020-05-22T19:42:20Z", "commit": {"oid": "7a5e58ea4e40b7ea6b5f6774ca09efeae8d67b30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MjoyMFrOGZiD9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTo0MjoyMFrOGZiD9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyNTY1Mg==", "bodyText": "I did confirm this test failed without my change.", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r429425652", "createdAt": "2020-05-22T19:42:20Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/PendingTraceTest.groovy", "diffHunk": "@@ -119,20 +121,51 @@ class PendingTraceTest extends DDSpecification {\n \n     then:\n     trace.pendingReferenceCount.get() == 0\n-    trace.weakReferences.size() == 0\n+    trace.weakSpans.size() == 0\n     trace.asList() == [rootSpan]\n     writer == []\n     writer.traceCount.get() == 1\n     !PendingTrace.SPAN_CLEANER.get().pendingTraces.contains(trace)\n   }\n \n+  @Timeout(value = 60, unit = TimeUnit.SECONDS)\n+  def \"trace is still reported when unfinished continuation discarded\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a5e58ea4e40b7ea6b5f6774ca09efeae8d67b30"}, "originalPosition": 93}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85a3bd61cc0fb446404edf67e79eff4919c53c08", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/85a3bd61cc0fb446404edf67e79eff4919c53c08", "committedDate": "2020-05-22T20:02:57Z", "message": "More logging improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTY0ODYw", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#pullrequestreview-417164860", "createdAt": "2020-05-22T20:20:52Z", "commit": {"oid": "85a3bd61cc0fb446404edf67e79eff4919c53c08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMDoyMDo1MlrOGZiyDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMDoyMDo1MlrOGZiyDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzNzQ1NA==", "bodyText": "Instead of using a second reference queue, could we write the trace when all spans are finished?", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#discussion_r429437454", "createdAt": "2020-05-22T20:20:52Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -44,9 +44,13 @@ static PendingTrace create(final CoreTracer tracer, final BigInteger traceId) {\n   /** Nano second ticks value at trace start */\n   private final long startNanoTicks;\n \n-  private final ReferenceQueue referenceQueue = new ReferenceQueue();\n-  private final Set<WeakReference<?>> weakReferences =\n-      Collections.newSetFromMap(new ConcurrentHashMap<WeakReference<?>, Boolean>());\n+  private final ReferenceQueue spanReferenceQueue = new ReferenceQueue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85a3bd61cc0fb446404edf67e79eff4919c53c08"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTg0MDk1", "url": "https://github.com/DataDog/dd-trace-java/pull/1493#pullrequestreview-417184095", "createdAt": "2020-05-22T21:09:37Z", "commit": {"oid": "85a3bd61cc0fb446404edf67e79eff4919c53c08"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2297, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}