{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NjkxNTE1", "number": 2052, "title": "Unwrapped java.sql PreparedStatement and Connection", "bodyText": "java.sql.PreparedStatement and java.sql.Connection are wrappers to delegates when they implement the Wrapper interface.  When this happens, our previous instrumentation was unable to find the saved sql statements in the ContextStore.  This pull request unwraps these objects to do lookups on the delegates instead of the wrappers.\nThe one complication is older drivers like h2 implementing an older version of the interface.  This throws AbstractMethodError at runtime.  I cached which classes throw the error for efficiency.  I added a couple methods to DDCache so it can be used in the implementation.", "createdAt": "2020-11-04T23:14:29Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2052", "merged": true, "mergeCommit": {"oid": "f62609eec82c019096afd29d5332d49f7f5b37fe"}, "closed": true, "closedAt": "2020-11-11T17:01:47Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZV-q2AH2gAyNTE1NjkxNTE1OmM1YzZkNGNjNWYwZmIxMTBiYjgyMzQ4MjQyYThhZWM1NzAxNzQ5ZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbbhsnAFqTUyODA1MzkxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5c6d4cc5f0fb110bb82348242a8aec5701749d7", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c5c6d4cc5f0fb110bb82348242a8aec5701749d7", "committedDate": "2020-11-04T23:01:48Z", "message": "add put() and getIfPresent() to DDCache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b", "committedDate": "2020-11-04T23:35:28Z", "message": "Unwrap PreparedStatement and Connection"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc3ea36c84d1926971fcd5f6936b6b1904b0b2a7", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bc3ea36c84d1926971fcd5f6936b6b1904b0b2a7", "committedDate": "2020-11-04T23:01:48Z", "message": "Unwrap PreparedStatement and Connection"}, "afterCommit": {"oid": "b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b", "committedDate": "2020-11-04T23:35:28Z", "message": "Unwrap PreparedStatement and Connection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDQxMzg3", "url": "https://github.com/DataDog/dd-trace-java/pull/2052#pullrequestreview-524041387", "createdAt": "2020-11-05T08:53:32Z", "commit": {"oid": "b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo1MzozMlrOHt5KkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo1MzozMlrOHt5KkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg4NDU2MA==", "bodyText": "Could we use ClassValue here instead? (which have weak keys)", "url": "https://github.com/DataDog/dd-trace-java/pull/2052#discussion_r517884560", "createdAt": "2020-11-05T08:53:32Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/jdbc/src/main/java/datadog/trace/instrumentation/jdbc/JDBCUtils.java", "diffHunk": "@@ -1,13 +1,49 @@\n package datadog.trace.instrumentation.jdbc;\n \n+import datadog.trace.api.cache.DDCache;\n+import datadog.trace.api.cache.DDCaches;\n import datadog.trace.bootstrap.ExceptionLogger;\n import java.lang.reflect.Field;\n import java.sql.Connection;\n+import java.sql.PreparedStatement;\n import java.sql.Statement;\n \n public abstract class JDBCUtils {\n   private static Field c3poField = null;\n \n+  // Cache if the class's isWrapperFor() or unwrap() methods are abstract\n+  // Using classnames to avoid the need for a WeakMap\n+  public static final DDCache<String, Boolean> ABSTRACT_UNWRAP = DDCaches.newFixedSizeCache(64);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDQ0MjYy", "url": "https://github.com/DataDog/dd-trace-java/pull/2052#pullrequestreview-524044262", "createdAt": "2020-11-05T08:55:23Z", "commit": {"oid": "b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo1NToyNFrOHt5PAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo1NToyNFrOHt5PAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg4NTY5OA==", "bodyText": "These changes aren't necessary if we, ahem, wrap the unwrapping logic in a ClassValue<Boolean>", "url": "https://github.com/DataDog/dd-trace-java/pull/2052#discussion_r517885698", "createdAt": "2020-11-05T08:55:24Z", "author": {"login": "richardstartin"}, "path": "internal-api/src/main/java/datadog/trace/api/cache/CHMCache.java", "diffHunk": "@@ -11,6 +11,24 @@ public CHMCache(final int initialCapacity) {\n     this.chm = new ConcurrentHashMap<>(initialCapacity);\n   }\n \n+  @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDQ1NTc4", "url": "https://github.com/DataDog/dd-trace-java/pull/2052#pullrequestreview-524045578", "createdAt": "2020-11-05T08:56:50Z", "commit": {"oid": "b6cf741d9e3ec98b6f3dd44aeeddfd3f4480c79b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9a0fb2db8a2b1980d699b1d4696bb4bb7b2cbaa", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e9a0fb2db8a2b1980d699b1d4696bb4bb7b2cbaa", "committedDate": "2020-11-06T22:47:31Z", "message": "Revert \"add put() and getIfPresent() to DDCache\"\n\nThis reverts commit c5c6d4cc5f0fb110bb82348242a8aec5701749d7."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03738b04617f849495768c0d33b75384987dc092", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/03738b04617f849495768c0d33b75384987dc092", "committedDate": "2020-11-10T22:21:24Z", "message": "Implement cache using ClassValue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjcwMzI2", "url": "https://github.com/DataDog/dd-trace-java/pull/2052#pullrequestreview-527670326", "createdAt": "2020-11-10T22:48:13Z", "commit": {"oid": "03738b04617f849495768c0d33b75384987dc092"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MDUzOTEy", "url": "https://github.com/DataDog/dd-trace-java/pull/2052#pullrequestreview-528053912", "createdAt": "2020-11-11T10:37:26Z", "commit": {"oid": "03738b04617f849495768c0d33b75384987dc092"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3081, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}