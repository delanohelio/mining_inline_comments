{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1ODc1MzMy", "number": 1598, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTowODoxNVrOEGZLdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzo1NzoyMFrOEGwz4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MTM5NDQ0OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTowODoxNVrOGlKV_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxOToxMzowM1rOGlTz-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxOTk2NQ==", "bodyText": "are we sure this is the case for all JVMs?", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r441619965", "createdAt": "2020-06-17T15:08:15Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -59,12 +83,26 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      final JarEntry entry = filenameToEntry.get(filename);\n+      if (null != entry) { // jar live\n+        pair = Pair.of(filename, entry);\n+        // this mechanism intentionally does not ensure visibility of this write, because it doesn't\n+        // matter\n+        this.cache = new WeakReference<>(pair);\n+      } else {\n+        log.debug(\"{} not found in {}\", filename, name);\n+        throw notFound;\n+      }\n     } else {\n-      throw new NoSuchFileException(url.getFile(), null, url.getFile() + \" not in internal jar\");\n+      // hack: just happen to know this only ever happens twice,\n+      // so dismiss cache after a hit\n+      this.cache = NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7031cb13374dcbf7fe061c7fb6524d58767ad686"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3MTkxMg==", "bodyText": "Do you think that on some JVMs we have been looking up each class more than twice?", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r441771912", "createdAt": "2020-06-17T19:06:56Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -59,12 +83,26 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      final JarEntry entry = filenameToEntry.get(filename);\n+      if (null != entry) { // jar live\n+        pair = Pair.of(filename, entry);\n+        // this mechanism intentionally does not ensure visibility of this write, because it doesn't\n+        // matter\n+        this.cache = new WeakReference<>(pair);\n+      } else {\n+        log.debug(\"{} not found in {}\", filename, name);\n+        throw notFound;\n+      }\n     } else {\n-      throw new NoSuchFileException(url.getFile(), null, url.getFile() + \" not in internal jar\");\n+      // hack: just happen to know this only ever happens twice,\n+      // so dismiss cache after a hit\n+      this.cache = NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxOTk2NQ=="}, "originalCommit": {"oid": "7031cb13374dcbf7fe061c7fb6524d58767ad686"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3MzAwOQ==", "bodyText": "I have no idea.  It was just a question based on the code.", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r441773009", "createdAt": "2020-06-17T19:09:04Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -59,12 +83,26 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      final JarEntry entry = filenameToEntry.get(filename);\n+      if (null != entry) { // jar live\n+        pair = Pair.of(filename, entry);\n+        // this mechanism intentionally does not ensure visibility of this write, because it doesn't\n+        // matter\n+        this.cache = new WeakReference<>(pair);\n+      } else {\n+        log.debug(\"{} not found in {}\", filename, name);\n+        throw notFound;\n+      }\n     } else {\n-      throw new NoSuchFileException(url.getFile(), null, url.getFile() + \" not in internal jar\");\n+      // hack: just happen to know this only ever happens twice,\n+      // so dismiss cache after a hit\n+      this.cache = NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxOTk2NQ=="}, "originalCommit": {"oid": "7031cb13374dcbf7fe061c7fb6524d58767ad686"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3NTA5OA==", "bodyText": "Let's say that it's different on some JVM - so what? Let's assume that on the other JVM we only try to load once, then we never reach this condition. If we try to load three or more times every odd load after the second will be a bit slower and end up doing a lookup, but we probably have bigger problems in that case.", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r441775098", "createdAt": "2020-06-17T19:13:03Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -59,12 +83,26 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      final JarEntry entry = filenameToEntry.get(filename);\n+      if (null != entry) { // jar live\n+        pair = Pair.of(filename, entry);\n+        // this mechanism intentionally does not ensure visibility of this write, because it doesn't\n+        // matter\n+        this.cache = new WeakReference<>(pair);\n+      } else {\n+        log.debug(\"{} not found in {}\", filename, name);\n+        throw notFound;\n+      }\n     } else {\n-      throw new NoSuchFileException(url.getFile(), null, url.getFile() + \" not in internal jar\");\n+      // hack: just happen to know this only ever happens twice,\n+      // so dismiss cache after a hit\n+      this.cache = NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxOTk2NQ=="}, "originalCommit": {"oid": "7031cb13374dcbf7fe061c7fb6524d58767ad686"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MTcwOTUxOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjoyMzo1M1rOGlNcew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjozMTowNlrOGlNt1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3MDc3OQ==", "bodyText": "So, cache is caching the last requested packageName?", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r441670779", "createdAt": "2020-06-17T16:23:53Z", "author": {"login": "jbachorik"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java", "diffHunk": "@@ -77,6 +67,24 @@ public boolean hasLoadedClass(final String className) {\n     return findLoadedClass(className) != null;\n   }\n \n+  Class<?> loadFromPackage(String packageName, String name) throws ClassNotFoundException {\n+    if (internalJarURLHandler.getPackages().contains(packageName)) {\n+      Class<?> loaded = findLoadedClass(name);\n+      return null == loaded ? findClass(name) : loaded;\n+    }\n+    return super.loadClass(name);\n+  }\n+\n+  String getPackageName(final String className) {\n+    // intentionally not thread-safe: the worst case scenario is excess allocation/lookups\n+    String packageName = this.cache.get();\n+    if (null == packageName || !className.startsWith(packageName)) {\n+      packageName = className.substring(0, className.lastIndexOf('.'));\n+      this.cache = new WeakReference<>(packageName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46e79fd2271c55996eb91143b2675396f8afb0fa"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3NTIyMA==", "bodyText": "yes, it could probably do with a rename and probably doesn't need to to be a weak reference any more (this contained a Pair<String, ClassLoader> at some point today)", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r441675220", "createdAt": "2020-06-17T16:31:06Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java", "diffHunk": "@@ -77,6 +67,24 @@ public boolean hasLoadedClass(final String className) {\n     return findLoadedClass(className) != null;\n   }\n \n+  Class<?> loadFromPackage(String packageName, String name) throws ClassNotFoundException {\n+    if (internalJarURLHandler.getPackages().contains(packageName)) {\n+      Class<?> loaded = findLoadedClass(name);\n+      return null == loaded ? findClass(name) : loaded;\n+    }\n+    return super.loadClass(name);\n+  }\n+\n+  String getPackageName(final String className) {\n+    // intentionally not thread-safe: the worst case scenario is excess allocation/lookups\n+    String packageName = this.cache.get();\n+    if (null == packageName || !className.startsWith(packageName)) {\n+      packageName = className.substring(0, className.lastIndexOf('.'));\n+      this.cache = new WeakReference<>(packageName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3MDc3OQ=="}, "originalCommit": {"oid": "46e79fd2271c55996eb91143b2675396f8afb0fa"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MTc0NjQyOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjozMzo1N1rOGlN0Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjozNzozOFrOGlN85g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3Njg1NA==", "bodyText": "This should probably account for 'no-package' classes as well - eg. lastIndexOf('/') == -1", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r441676854", "createdAt": "2020-06-17T16:33:57Z", "author": {"login": "jbachorik"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -1,42 +1,61 @@\n package datadog.trace.bootstrap;\n \n+import datadog.trace.bootstrap.instrumentation.api.Pair;\n import java.io.ByteArrayInputStream;\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.ref.WeakReference;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.net.URLConnection;\n import java.net.URLStreamHandler;\n-import java.nio.file.NoSuchFileException;\n import java.security.Permission;\n import java.util.Enumeration;\n import java.util.HashMap;\n+import java.util.HashSet;\n import java.util.Map;\n+import java.util.Set;\n import java.util.jar.JarEntry;\n import java.util.jar.JarFile;\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n public class InternalJarURLHandler extends URLStreamHandler {\n+\n+  private static final WeakReference<Pair<String, JarEntry>> NULL = new WeakReference<>(null);\n+\n+  private final String name;\n+  private final FileNotInInternalJar notFound;\n   private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n-  private JarFile bootstrapJarFile;\n+  private final Set<String> packages = new HashSet<>();\n+  private final JarFile bootstrapJarFile;\n+\n+  private WeakReference<Pair<String, JarEntry>> cache = NULL;\n \n   InternalJarURLHandler(final String internalJarFileName, final URL bootstrapJarLocation) {\n+    this.name = internalJarFileName;\n+    this.notFound = new FileNotInInternalJar(internalJarFileName);\n     final String filePrefix = internalJarFileName + \"/\";\n-\n+    JarFile jarFile = null;\n+    String currentDir = \"$\";\n     try {\n       if (bootstrapJarLocation != null) {\n-        bootstrapJarFile = new JarFile(new File(bootstrapJarLocation.toURI()), false);\n-        final Enumeration<JarEntry> entries = bootstrapJarFile.entries();\n+        jarFile = new JarFile(new File(bootstrapJarLocation.toURI()), false);\n+        final Enumeration<JarEntry> entries = jarFile.entries();\n         while (entries.hasMoreElements()) {\n           final JarEntry entry = entries.nextElement();\n-\n           if (!entry.isDirectory() && entry.getName().startsWith(filePrefix)) {\n             String name = entry.getName();\n             // remove data suffix\n             int end = name.endsWith(\".classdata\") ? name.length() - 4 : name.length();\n-            filenameToEntry.put(name.substring(internalJarFileName.length(), end), entry);\n+            String fileName = name.substring(internalJarFileName.length(), end);\n+            filenameToEntry.put(fileName, entry);\n+            if (fileName.endsWith(\".class\") && !fileName.startsWith(currentDir)) {\n+              currentDir = fileName.substring(1, fileName.lastIndexOf('/'));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46e79fd2271c55996eb91143b2675396f8afb0fa"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3OTA3OA==", "bodyText": "yes, in several places, I'll handle these cases in the next commit.", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r441679078", "createdAt": "2020-06-17T16:37:38Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -1,42 +1,61 @@\n package datadog.trace.bootstrap;\n \n+import datadog.trace.bootstrap.instrumentation.api.Pair;\n import java.io.ByteArrayInputStream;\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.ref.WeakReference;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.net.URLConnection;\n import java.net.URLStreamHandler;\n-import java.nio.file.NoSuchFileException;\n import java.security.Permission;\n import java.util.Enumeration;\n import java.util.HashMap;\n+import java.util.HashSet;\n import java.util.Map;\n+import java.util.Set;\n import java.util.jar.JarEntry;\n import java.util.jar.JarFile;\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n public class InternalJarURLHandler extends URLStreamHandler {\n+\n+  private static final WeakReference<Pair<String, JarEntry>> NULL = new WeakReference<>(null);\n+\n+  private final String name;\n+  private final FileNotInInternalJar notFound;\n   private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n-  private JarFile bootstrapJarFile;\n+  private final Set<String> packages = new HashSet<>();\n+  private final JarFile bootstrapJarFile;\n+\n+  private WeakReference<Pair<String, JarEntry>> cache = NULL;\n \n   InternalJarURLHandler(final String internalJarFileName, final URL bootstrapJarLocation) {\n+    this.name = internalJarFileName;\n+    this.notFound = new FileNotInInternalJar(internalJarFileName);\n     final String filePrefix = internalJarFileName + \"/\";\n-\n+    JarFile jarFile = null;\n+    String currentDir = \"$\";\n     try {\n       if (bootstrapJarLocation != null) {\n-        bootstrapJarFile = new JarFile(new File(bootstrapJarLocation.toURI()), false);\n-        final Enumeration<JarEntry> entries = bootstrapJarFile.entries();\n+        jarFile = new JarFile(new File(bootstrapJarLocation.toURI()), false);\n+        final Enumeration<JarEntry> entries = jarFile.entries();\n         while (entries.hasMoreElements()) {\n           final JarEntry entry = entries.nextElement();\n-\n           if (!entry.isDirectory() && entry.getName().startsWith(filePrefix)) {\n             String name = entry.getName();\n             // remove data suffix\n             int end = name.endsWith(\".classdata\") ? name.length() - 4 : name.length();\n-            filenameToEntry.put(name.substring(internalJarFileName.length(), end), entry);\n+            String fileName = name.substring(internalJarFileName.length(), end);\n+            filenameToEntry.put(fileName, entry);\n+            if (fileName.endsWith(\".class\") && !fileName.startsWith(currentDir)) {\n+              currentDir = fileName.substring(1, fileName.lastIndexOf('/'));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3Njg1NA=="}, "originalCommit": {"oid": "46e79fd2271c55996eb91143b2675396f8afb0fa"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NTI2NjI3OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/agent-bootstrap/src/test/groovy/datadog/trace/bootstrap/DatadogClassLoaderTest.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzo1NzoyMVrOGlwk1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzo1NzoyMVrOGlwk1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI0NjM1Nw==", "bodyText": "A bit confusing that it's named parent in the jar and the test name, but shared in the code.", "url": "https://github.com/DataDog/dd-trace-java/pull/1598#discussion_r442246357", "createdAt": "2020-06-18T13:57:21Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/agent-bootstrap/src/test/groovy/datadog/trace/bootstrap/DatadogClassLoaderTest.groovy", "diffHunk": "@@ -49,4 +53,50 @@ class DatadogClassLoaderTest extends Specification {\n     then:\n     applicationDidNotDeadlock\n   }\n+\n+\n+  def \"test delegate class load to parent\"() {\n+    setup:\n+    DatadogClassLoader.BootstrapClassLoaderProxy bootstrapProxy =\n+      new DatadogClassLoader.BootstrapClassLoaderProxy()\n+    DatadogClassLoader shared = new DatadogClassLoader(testJarLocation, \"parent\", bootstrapProxy, null)\n+    DatadogClassLoader.DelegateClassLoader child = new DatadogClassLoader.DelegateClassLoader(testJarLocation,\n+      \"child\", bootstrapProxy, null, shared)\n+\n+    when:\n+    Class<?> c = child.loadClass(\"a.b.c.C\")\n+\n+    then:\n+    c.getClassLoader() == shared", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13ff7ef72a3c777362100e55d4e395bbdda77e60"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 76, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}