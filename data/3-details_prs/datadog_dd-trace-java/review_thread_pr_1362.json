{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMDM3NjU5", "number": 1362, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDo1Mjo0MFrOD096ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDoyMzoyNFrOEAh8kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODY2OTE2OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/ServerDecorator.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDo1Mjo0MFrOGKLU2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMTo0MTo0NFrOGKNEgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMyNDUwNQ==", "bodyText": "this ServerDecorator is only used for spans handling http requests correct?\ne.g. Spring, Struts, Play, etc?", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r413324505", "createdAt": "2020-04-22T20:52:40Z", "author": {"login": "brettlangdon"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/ServerDecorator.java", "diffHunk": "@@ -11,6 +11,7 @@ public AgentSpan afterStart(final AgentSpan span) {\n     assert span != null;\n     span.setTag(Tags.SPAN_KIND, Tags.SPAN_KIND_SERVER);\n     span.setTag(Config.LANGUAGE_TAG_KEY, Config.LANGUAGE_TAG_VALUE);\n+    span.setTag(\"_dd.measured\", \"1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee5ec1b4c4e300f6288c70bde9aa32c774d7e8a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0MDM0NA==", "bodyText": "I'm a bit concerned by some of the decorators where this would have effect.\nFor example, a standard spring boot app, we would see potentially 2 spans with this added, the top level servlet span, plus the handler/controller span.  The first one makes sense, but I'm not sure the second one does.  Before we merge this, we'd need to review all the decorators that extend this class to confirm we want the metric added.", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r413340344", "createdAt": "2020-04-22T21:19:00Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/ServerDecorator.java", "diffHunk": "@@ -11,6 +11,7 @@ public AgentSpan afterStart(final AgentSpan span) {\n     assert span != null;\n     span.setTag(Tags.SPAN_KIND, Tags.SPAN_KIND_SERVER);\n     span.setTag(Config.LANGUAGE_TAG_KEY, Config.LANGUAGE_TAG_VALUE);\n+    span.setTag(\"_dd.measured\", \"1\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMyNDUwNQ=="}, "originalCommit": {"oid": "ee5ec1b4c4e300f6288c70bde9aa32c774d7e8a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0NzA2Mg==", "bodyText": "So, should we do this on an instrumentation by instrumentation basis instead?\nIs there a rule of thumb as to which server spans should have \"measured\"?", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r413347062", "createdAt": "2020-04-22T21:30:45Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/ServerDecorator.java", "diffHunk": "@@ -11,6 +11,7 @@ public AgentSpan afterStart(final AgentSpan span) {\n     assert span != null;\n     span.setTag(Tags.SPAN_KIND, Tags.SPAN_KIND_SERVER);\n     span.setTag(Config.LANGUAGE_TAG_KEY, Config.LANGUAGE_TAG_VALUE);\n+    span.setTag(\"_dd.measured\", \"1\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMyNDUwNQ=="}, "originalCommit": {"oid": "ee5ec1b4c4e300f6288c70bde9aa32c774d7e8a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1MzA5MA==", "bodyText": "Integration root spans should be marked for measured.\nThe main goal behind manually marking spans to be measured is as we move towards unifying the service name used by an application (e.g. all spans regardless of integration share the same service name), we want to be sure that people do not lose access to metrics that get generated today automatically by having unique service names for integrations.", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r413353090", "createdAt": "2020-04-22T21:41:44Z", "author": {"login": "brettlangdon"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/ServerDecorator.java", "diffHunk": "@@ -11,6 +11,7 @@ public AgentSpan afterStart(final AgentSpan span) {\n     assert span != null;\n     span.setTag(Tags.SPAN_KIND, Tags.SPAN_KIND_SERVER);\n     span.setTag(Config.LANGUAGE_TAG_KEY, Config.LANGUAGE_TAG_VALUE);\n+    span.setTag(\"_dd.measured\", \"1\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMyNDUwNQ=="}, "originalCommit": {"oid": "ee5ec1b4c4e300f6288c70bde9aa32c774d7e8a5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Mzk3NTYwOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/akka-http-10.0/src/main/java/datadog/trace/instrumentation/akkahttp/AkkaHttpClientInstrumentation.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzoxNjo0N1rOGa8WgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzoxNjo0N1rOGa8WgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwNDk2MA==", "bodyText": "Is there a reason we're making this a string? Ultimately, it would be beneficial for all numeric tags to be numeric, because the vast majority of our allocation overhead is in UTF-8 encoding of strings. As things stand, this will get converted to a string anyway, but when we find a reasonable way to pass numerics through as numerics, it would be nice if this code didn't need alteration.", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r430904960", "createdAt": "2020-05-27T07:16:47Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/akka-http-10.0/src/main/java/datadog/trace/instrumentation/akkahttp/AkkaHttpClientInstrumentation.java", "diffHunk": "@@ -80,6 +81,7 @@ public static AgentScope methodEnter(\n       }\n \n       final AgentSpan span = startSpan(\"akka-http.request\");\n+      span.setTag(DD_MEASURED, \"1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a73ade71b1f56a272a2cc0bd5beb40d29adfb7c"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NjE4ODg1OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/testing/src/main/groovy/datadog/trace/agent/test/asserts/TagsAssert.groovy", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNjoxNjo0MVrOGbSpaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDoyMjozMVrOGb3dvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3MDI0OA==", "bodyText": "This should be a metric, not a tag.", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r431270248", "createdAt": "2020-05-27T16:16:41Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/testing/src/main/groovy/datadog/trace/agent/test/asserts/TagsAssert.groovy", "diffHunk": "@@ -37,6 +37,7 @@ class TagsAssert {\n     assertedTags.add(\"thread.id\")\n     assertedTags.add(Config.RUNTIME_ID_TAG)\n     assertedTags.add(Config.LANGUAGE_TAG_KEY)\n+    assertedTags.add(\"_dd.measured\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a73ade71b1f56a272a2cc0bd5beb40d29adfb7c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2NTc2MA==", "bodyText": "Is it worth splitting the stuff I did to allow assertions about metrics on #1484 into a separate PR without modifying tags handling?", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r431365760", "createdAt": "2020-05-27T18:47:10Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/testing/src/main/groovy/datadog/trace/agent/test/asserts/TagsAssert.groovy", "diffHunk": "@@ -37,6 +37,7 @@ class TagsAssert {\n     assertedTags.add(\"thread.id\")\n     assertedTags.add(Config.RUNTIME_ID_TAG)\n     assertedTags.add(Config.LANGUAGE_TAG_KEY)\n+    assertedTags.add(\"_dd.measured\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3MDI0OA=="}, "originalCommit": {"oid": "7a73ade71b1f56a272a2cc0bd5beb40d29adfb7c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ3MzIxNQ==", "bodyText": "@richardstartin I think that'd be great!", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r431473215", "createdAt": "2020-05-27T22:14:23Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/testing/src/main/groovy/datadog/trace/agent/test/asserts/TagsAssert.groovy", "diffHunk": "@@ -37,6 +37,7 @@ class TagsAssert {\n     assertedTags.add(\"thread.id\")\n     assertedTags.add(Config.RUNTIME_ID_TAG)\n     assertedTags.add(Config.LANGUAGE_TAG_KEY)\n+    assertedTags.add(\"_dd.measured\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3MDI0OA=="}, "originalCommit": {"oid": "7a73ade71b1f56a272a2cc0bd5beb40d29adfb7c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3MzQ2OA==", "bodyText": "@lpriima I think you can remove this line now.", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r431873468", "createdAt": "2020-05-28T14:22:31Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/testing/src/main/groovy/datadog/trace/agent/test/asserts/TagsAssert.groovy", "diffHunk": "@@ -37,6 +37,7 @@ class TagsAssert {\n     assertedTags.add(\"thread.id\")\n     assertedTags.add(Config.RUNTIME_ID_TAG)\n     assertedTags.add(Config.LANGUAGE_TAG_KEY)\n+    assertedTags.add(\"_dd.measured\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3MDI0OA=="}, "originalCommit": {"oid": "7a73ade71b1f56a272a2cc0bd5beb40d29adfb7c"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTkxNjMzOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/processor/rule/MarkSpanForMetricCalculationRule.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDoyMzoyNFrOGb3gcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDoyMzoyNFrOGb3gcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3NDE2MA==", "bodyText": "See Richard's work in #1504", "url": "https://github.com/DataDog/dd-trace-java/pull/1362#discussion_r431874160", "createdAt": "2020-05-28T14:23:24Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/processor/rule/MarkSpanForMetricCalculationRule.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package datadog.trace.core.processor.rule;\n+\n+import datadog.trace.bootstrap.instrumentation.api.InstrumentationTags;\n+import datadog.trace.core.DDSpan;\n+import datadog.trace.core.processor.TraceProcessor;\n+import java.util.Collection;\n+import java.util.Map;\n+\n+public class MarkSpanForMetricCalculationRule implements TraceProcessor.Rule {\n+  @Override\n+  public String[] aliases() {\n+    return new String[] {};\n+  }\n+\n+  @Override\n+  public void processSpan(DDSpan span, Map<String, Object> tags, Collection<DDSpan> trace) {\n+    final Object val = tags.get(InstrumentationTags.DD_MEASURED);\n+    if (val instanceof Boolean && (Boolean) val) {\n+      span.context().setMetric(InstrumentationTags.DD_MEASURED, 1);\n+      span.removeTag(InstrumentationTags.DD_MEASURED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6ab7dd7ff77c8d5e9f54aa42324ca0ff81db63b"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 453, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}