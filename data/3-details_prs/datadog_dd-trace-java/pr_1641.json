{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxOTkxNTAw", "number": 1641, "title": "don't block when there are no buffers left", "bodyText": "", "createdAt": "2020-06-30T12:23:34Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1641", "merged": true, "mergeCommit": {"oid": "9ed929b7a7c0a02ffeb6efa7dbe6c37666412823"}, "closed": true, "closedAt": "2020-06-30T18:25:35Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwVFnLgFqTQzOTk3NzI2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwZBbZABqjM0OTg4NTU4MDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTc3MjY5", "url": "https://github.com/DataDog/dd-trace-java/pull/1641#pullrequestreview-439977269", "createdAt": "2020-06-30T12:47:22Z", "commit": {"oid": "5b6a7728abf73eb22c97a00faa8eb1cf255bb480"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjo0NzoyMlrOGq6qhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjo0NzoyMlrOGq6qhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1NDUzNQ==", "bodyText": "Definitely good to know. Maybe we should add some metrics for these things as well?", "url": "https://github.com/DataDog/dd-trace-java/pull/1641#discussion_r447654535", "createdAt": "2020-06-30T12:47:22Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DispatchingDisruptor.java", "diffHunk": "@@ -46,7 +47,25 @@ public void close() {\n   }\n \n   long beginTransaction() {\n-    return disruptor.getRingBuffer().next();\n+    long backoffMillis = 1;\n+    long nextLogTime = 0;\n+    while (true) {\n+      try {\n+        return disruptor.getRingBuffer().tryNext();\n+      } catch (InsufficientCapacityException insufficientCapacity) {\n+        long now = System.currentTimeMillis();\n+        backoffMillis = Math.min(backoffMillis * 2, 1000);\n+        if (now > nextLogTime) { // log every 20 seconds\n+          log.debug(\"no buffer available, sleeping for {}ms\", backoffMillis);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b6a7728abf73eb22c97a00faa8eb1cf255bb480"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b6a7728abf73eb22c97a00faa8eb1cf255bb480", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5b6a7728abf73eb22c97a00faa8eb1cf255bb480", "committedDate": "2020-06-30T12:21:23Z", "message": "don't block when there are no buffers left"}, "afterCommit": {"oid": "e2c085975424e777abbdafc67416d5f965795402", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e2c085975424e777abbdafc67416d5f965795402", "committedDate": "2020-06-30T12:27:15Z", "message": "don't block when there are no buffers left"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d79f438146a91da702a1bc80d71942d8d1698d4", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1d79f438146a91da702a1bc80d71942d8d1698d4", "committedDate": "2020-06-30T13:02:58Z", "message": "don't block when there are no buffers left"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2c085975424e777abbdafc67416d5f965795402", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e2c085975424e777abbdafc67416d5f965795402", "committedDate": "2020-06-30T12:27:15Z", "message": "don't block when there are no buffers left"}, "afterCommit": {"oid": "1d79f438146a91da702a1bc80d71942d8d1698d4", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1d79f438146a91da702a1bc80d71942d8d1698d4", "committedDate": "2020-06-30T13:02:58Z", "message": "don't block when there are no buffers left"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dc0378a16d51f63f0c492867062ef9678b3e996", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9dc0378a16d51f63f0c492867062ef9678b3e996", "committedDate": "2020-06-30T13:35:37Z", "message": "add monitoring for backups"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMDIzNjAy", "url": "https://github.com/DataDog/dd-trace-java/pull/1641#pullrequestreview-440023602", "createdAt": "2020-06-30T13:38:56Z", "commit": {"oid": "9dc0378a16d51f63f0c492867062ef9678b3e996"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMzozODo1NlrOGq8zSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMzozODo1NlrOGq8zSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY4OTU0Ng==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/DataDog/dd-trace-java/pull/1641#discussion_r447689546", "createdAt": "2020-06-30T13:38:56Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/Monitor.java", "diffHunk": "@@ -114,6 +116,11 @@ public void onScheduleFlush(final DDAgentWriter agentWriter, final boolean previ\n       // not recorded\n     }\n \n+    @Override\n+    public void onBackedUpTraceBuffer() {\n+      statsd.incrementCounter(\"trace.buffer.backlog\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dc0378a16d51f63f0c492867062ef9678b3e996"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTA0MzAw", "url": "https://github.com/DataDog/dd-trace-java/pull/1641#pullrequestreview-440104300", "createdAt": "2020-06-30T14:58:21Z", "commit": {"oid": "9dc0378a16d51f63f0c492867062ef9678b3e996"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa9513eea3063ce607b734de0f8eaec5ee7b4c79", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fa9513eea3063ce607b734de0f8eaec5ee7b4c79", "committedDate": "2020-06-30T16:44:16Z", "message": "more stable testing strategy"}, "afterCommit": {"oid": "25551ca319166fd0057b6e54227fe5ff625bd865", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/25551ca319166fd0057b6e54227fe5ff625bd865", "committedDate": "2020-06-30T16:44:57Z", "message": "more stable testing strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2f46a96f892bffc09c8d1ec6ecde861dfcda96c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e2f46a96f892bffc09c8d1ec6ecde861dfcda96c", "committedDate": "2020-06-30T17:23:25Z", "message": "add a test for backoff behaviour"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f39e025ed3aa7ecac38640058b6620ccdae39367", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f39e025ed3aa7ecac38640058b6620ccdae39367", "committedDate": "2020-06-30T17:14:08Z", "message": "more stable testing strategy"}, "afterCommit": {"oid": "e2f46a96f892bffc09c8d1ec6ecde861dfcda96c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e2f46a96f892bffc09c8d1ec6ecde861dfcda96c", "committedDate": "2020-06-30T17:23:25Z", "message": "add a test for backoff behaviour"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2221, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}