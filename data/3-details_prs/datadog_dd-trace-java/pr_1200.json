{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMDM3NTE4", "number": 1200, "title": "Reduce tracer thread count by combining scheduled executors into a single executor.", "bodyText": "Pulls out utility classes for reuse by other projects.\nThis also meant the dependency had to be bundled with dd-trace-ot since it isn't published as a separate dependency.", "createdAt": "2020-02-04T20:33:54Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1200", "merged": true, "mergeCommit": {"oid": "032f22f5a6a55752ab32b7b7401c0f4ee858b47f"}, "closed": true, "closedAt": "2020-02-11T16:18:59Z", "author": {"login": "tylerbenson"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBI1BvABqjMwMDc4NTc3OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDULaGgFqTM1Njc5NTEzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ceee26b888de2de51b001dfac1100761d5a68f4", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2ceee26b888de2de51b001dfac1100761d5a68f4", "committedDate": "2020-02-04T21:45:14Z", "message": "Fix muzzle"}, "afterCommit": {"oid": "9348ab8c57ea514b5f8d47505bbae81eabed17b3", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9348ab8c57ea514b5f8d47505bbae81eabed17b3", "committedDate": "2020-02-04T21:57:00Z", "message": "Fix muzzle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9348ab8c57ea514b5f8d47505bbae81eabed17b3", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9348ab8c57ea514b5f8d47505bbae81eabed17b3", "committedDate": "2020-02-04T21:57:00Z", "message": "Fix muzzle"}, "afterCommit": {"oid": "425a7df0b816829cc9b4ec9cad264fdd3127657c", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/425a7df0b816829cc9b4ec9cad264fdd3127657c", "committedDate": "2020-02-04T23:12:46Z", "message": "Fix muzzle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "425a7df0b816829cc9b4ec9cad264fdd3127657c", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/425a7df0b816829cc9b4ec9cad264fdd3127657c", "committedDate": "2020-02-04T23:12:46Z", "message": "Fix muzzle"}, "afterCommit": {"oid": "e829ec1d8e1f22909cfe01f68548e8cb0533bb43", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e829ec1d8e1f22909cfe01f68548e8cb0533bb43", "committedDate": "2020-02-04T23:54:12Z", "message": "Fix muzzle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e829ec1d8e1f22909cfe01f68548e8cb0533bb43", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e829ec1d8e1f22909cfe01f68548e8cb0533bb43", "committedDate": "2020-02-04T23:54:12Z", "message": "Fix muzzle"}, "afterCommit": {"oid": "08515857a7cfd9998975e2a7a2932d20e1f6dc76", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/08515857a7cfd9998975e2a7a2932d20e1f6dc76", "committedDate": "2020-02-05T01:09:06Z", "message": "Fix muzzle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDMyMjI3", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-353432227", "createdAt": "2020-02-05T02:26:31Z", "commit": {"oid": "08515857a7cfd9998975e2a7a2932d20e1f6dc76"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNTI0NDAw", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-353524400", "createdAt": "2020-02-05T08:06:09Z", "commit": {"oid": "08515857a7cfd9998975e2a7a2932d20e1f6dc76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODowNjowOVrOFlus4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODowNjowOVrOFlus4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEwNjc4Ng==", "bodyText": "executorService.shutdownNow() ?", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#discussion_r375106786", "createdAt": "2020-02-05T08:06:09Z", "author": {"login": "jpbempel"}, "path": "utils/thread-utils/src/main/java/datadog/common/exec/SharedExecutors.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package datadog.common.exec;\n+\n+import static datadog.common.exec.DaemonThreadFactory.TASK_SCHEDULER;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+public final class SharedExecutors {\n+  private static final long SHUTDOWN_WAIT_SECONDS = 5;\n+\n+  private static final ScheduledExecutorService TASK_SCHEDULER_EXECUTOR_SERVICE =\n+      Executors.newSingleThreadScheduledExecutor(TASK_SCHEDULER);\n+\n+  static {\n+    try {\n+      Runtime.getRuntime().addShutdownHook(new ShutdownCallback(TASK_SCHEDULER_EXECUTOR_SERVICE));\n+    } catch (final IllegalStateException ex) {\n+      // The JVM is already shutting down.\n+    }\n+  }\n+\n+  public static ScheduledExecutorService taskScheduler() {\n+    return TASK_SCHEDULER_EXECUTOR_SERVICE;\n+  }\n+\n+  public static ScheduledFuture<?> scheduleTaskAtFixedRate(\n+      final Runnable command, final long initialDelay, final long period, final TimeUnit unit) {\n+    return TASK_SCHEDULER_EXECUTOR_SERVICE.scheduleAtFixedRate(command, initialDelay, period, unit);\n+  }\n+\n+  public static boolean isTaskSchedulerShutdown() {\n+    return TASK_SCHEDULER_EXECUTOR_SERVICE.isShutdown();\n+  }\n+\n+  private static final class ShutdownCallback extends Thread {\n+\n+    private final ScheduledExecutorService executorService;\n+\n+    private ShutdownCallback(final ScheduledExecutorService executorService) {\n+      super(\"dd-exec-shutdown-hook\");\n+      this.executorService = executorService;\n+    }\n+\n+    @Override\n+    public void run() {\n+      try {\n+        executorService.shutdown();\n+        executorService.awaitTermination(SHUTDOWN_WAIT_SECONDS, TimeUnit.SECONDS);\n+      } catch (final InterruptedException e) {\n+        // Don't bother waiting then...", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08515857a7cfd9998975e2a7a2932d20e1f6dc76"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTk4MDg2", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-355198086", "createdAt": "2020-02-07T14:37:04Z", "commit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDozNzowNVrOFm_Aww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDozNzowNVrOFm_Aww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyMjU5NQ==", "bodyText": "Without context as to what this is, this looks kind of weird.\nI get that it is the TRACE_PROCESSOR ThreadFactory, but without an affix on the variable name or the class qualifying the static access it still looks strange at first glance.", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#discussion_r376422595", "createdAt": "2020-02-07T14:37:05Z", "author": {"login": "dougqh"}, "path": "dd-trace-ot/src/main/java/datadog/trace/common/writer/ddagent/TraceProcessingDisruptor.java", "diffHunk": "@@ -29,8 +30,8 @@ public TraceProcessingDisruptor(\n   }\n \n   @Override\n-  protected ThreadFactory getThreadFactory() {\n-    return new DaemonThreadFactory(\"dd-trace-processor\");\n+  protected DaemonThreadFactory getThreadFactory() {\n+    return TRACE_PROCESSOR;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTk4NDc1", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-355198475", "createdAt": "2020-02-07T14:37:40Z", "commit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDozNzo0MFrOFm_B4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDozNzo0MFrOFm_B4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyMjg4MQ==", "bodyText": "Logging?", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#discussion_r376422881", "createdAt": "2020-02-07T14:37:40Z", "author": {"login": "dougqh"}, "path": "utils/thread-utils/src/main/java/datadog/common/exec/SharedExecutors.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package datadog.common.exec;\n+\n+import static datadog.common.exec.DaemonThreadFactory.TASK_SCHEDULER;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+public final class SharedExecutors {\n+  private static final long SHUTDOWN_WAIT_SECONDS = 5;\n+\n+  private static final ScheduledExecutorService TASK_SCHEDULER_EXECUTOR_SERVICE =\n+      Executors.newSingleThreadScheduledExecutor(TASK_SCHEDULER);\n+\n+  static {\n+    try {\n+      Runtime.getRuntime().addShutdownHook(new ShutdownCallback(TASK_SCHEDULER_EXECUTOR_SERVICE));\n+    } catch (final IllegalStateException ex) {\n+      // The JVM is already shutting down.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTk5NTgz", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-355199583", "createdAt": "2020-02-07T14:39:18Z", "commit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDozOToxOVrOFm_FXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDozOToxOVrOFm_FXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyMzc3NQ==", "bodyText": "I'd personally prefer a singleton object without the static wrapper methods, but I'll leave it to the group to decide.", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#discussion_r376423775", "createdAt": "2020-02-07T14:39:19Z", "author": {"login": "dougqh"}, "path": "utils/thread-utils/src/main/java/datadog/common/exec/SharedExecutors.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package datadog.common.exec;\n+\n+import static datadog.common.exec.DaemonThreadFactory.TASK_SCHEDULER;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+public final class SharedExecutors {\n+  private static final long SHUTDOWN_WAIT_SECONDS = 5;\n+\n+  private static final ScheduledExecutorService TASK_SCHEDULER_EXECUTOR_SERVICE =\n+      Executors.newSingleThreadScheduledExecutor(TASK_SCHEDULER);\n+\n+  static {\n+    try {\n+      Runtime.getRuntime().addShutdownHook(new ShutdownCallback(TASK_SCHEDULER_EXECUTOR_SERVICE));\n+    } catch (final IllegalStateException ex) {\n+      // The JVM is already shutting down.\n+    }\n+  }\n+\n+  public static ScheduledExecutorService taskScheduler() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MjAwNTMx", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-355200531", "createdAt": "2020-02-07T14:40:40Z", "commit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDo0MDo0MFrOFm_IGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDo0MDo0MFrOFm_IGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyNDQ3NQ==", "bodyText": "At some point, we should revisit whether we really need the shutdown hooks.\nThey aren't guaranteed to work and they cause problems with SecurityManagers.\nBut this PR is probably not the right place to make such a change.", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#discussion_r376424475", "createdAt": "2020-02-07T14:40:40Z", "author": {"login": "dougqh"}, "path": "utils/thread-utils/src/main/java/datadog/common/exec/SharedExecutors.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package datadog.common.exec;\n+\n+import static datadog.common.exec.DaemonThreadFactory.TASK_SCHEDULER;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+public final class SharedExecutors {\n+  private static final long SHUTDOWN_WAIT_SECONDS = 5;\n+\n+  private static final ScheduledExecutorService TASK_SCHEDULER_EXECUTOR_SERVICE =\n+      Executors.newSingleThreadScheduledExecutor(TASK_SCHEDULER);\n+\n+  static {\n+    try {\n+      Runtime.getRuntime().addShutdownHook(new ShutdownCallback(TASK_SCHEDULER_EXECUTOR_SERVICE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MjAxNjYz", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-355201663", "createdAt": "2020-02-07T14:42:11Z", "commit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75c77691923935db9c23718619e92d2fc03facb5", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/75c77691923935db9c23718619e92d2fc03facb5", "committedDate": "2020-02-10T18:45:58Z", "message": "Reduce tracer thread count by combining scheduled executors into a single executor.\n\nPulls out utility classes for reuse by other projects.\n\nThis also meant the dependency had to be bundled with dd-trace-ot since it isn't published as a separate dependency."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5980d481206a84cddbe3682ae43fd50d2d0c8ae", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e5980d481206a84cddbe3682ae43fd50d2d0c8ae", "committedDate": "2020-02-10T18:45:58Z", "message": "Fix muzzle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c6cfbe359f3209d8ea375527264e1bfd15e8208", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9c6cfbe359f3209d8ea375527264e1bfd15e8208", "committedDate": "2020-02-10T18:45:58Z", "message": "Fix shutdown hook."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "486d98135eabdae3fe511a944bfab85a1d0c6363", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/486d98135eabdae3fe511a944bfab85a1d0c6363", "committedDate": "2020-02-10T19:37:36Z", "message": "Code review changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1c6e3e685a6ecfd4b4b91ebb4e07e62386f350cf", "committedDate": "2020-02-05T17:43:50Z", "message": "Fix shutdown hook."}, "afterCommit": {"oid": "486d98135eabdae3fe511a944bfab85a1d0c6363", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/486d98135eabdae3fe511a944bfab85a1d0c6363", "committedDate": "2020-02-10T19:37:36Z", "message": "Code review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NDYyNjUx", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-356462651", "createdAt": "2020-02-11T07:58:23Z", "commit": {"oid": "486d98135eabdae3fe511a944bfab85a1d0c6363"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Nzk1MTM4", "url": "https://github.com/DataDog/dd-trace-java/pull/1200#pullrequestreview-356795138", "createdAt": "2020-02-11T16:18:25Z", "commit": {"oid": "486d98135eabdae3fe511a944bfab85a1d0c6363"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2696, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}