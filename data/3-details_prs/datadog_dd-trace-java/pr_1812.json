{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NTA1OTA1", "number": 1812, "title": "Use alternative weak-keyed map implementations to reduce work done in CommonTaskExecutor", "bodyText": "", "createdAt": "2020-08-28T16:26:24Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1812", "merged": true, "mergeCommit": {"oid": "389f26900bf4682ab3e6b6265c5ef2f6339c2c5c"}, "closed": true, "closedAt": "2020-09-01T12:24:14Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDXpAigFqTQ3Nzg2OTgwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEkEfOgFqTQ3OTU2MzYyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3ODY5ODA1", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#pullrequestreview-477869805", "createdAt": "2020-08-28T16:31:37Z", "commit": {"oid": "6c129dd82129c7607fb2e074cd4e6b1d3c6dff54"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c129dd82129c7607fb2e074cd4e6b1d3c6dff54", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6c129dd82129c7607fb2e074cd4e6b1d3c6dff54", "committedDate": "2020-08-28T16:25:42Z", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map"}, "afterCommit": {"oid": "171ad4cf5b9b747797252b949d8dafaff57a08fc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/171ad4cf5b9b747797252b949d8dafaff57a08fc", "committedDate": "2020-08-28T16:53:40Z", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "171ad4cf5b9b747797252b949d8dafaff57a08fc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/171ad4cf5b9b747797252b949d8dafaff57a08fc", "committedDate": "2020-08-28T16:53:40Z", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map"}, "afterCommit": {"oid": "bd0e874556a05073e56b87eaac05b176f26801e9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bd0e874556a05073e56b87eaac05b176f26801e9", "committedDate": "2020-08-28T17:03:43Z", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd0e874556a05073e56b87eaac05b176f26801e9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bd0e874556a05073e56b87eaac05b176f26801e9", "committedDate": "2020-08-28T17:03:43Z", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map"}, "afterCommit": {"oid": "29dc20d868a73c0c218e33388990361df42bdc1b", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/29dc20d868a73c0c218e33388990361df42bdc1b", "committedDate": "2020-08-28T17:34:53Z", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a44a10fa5133dcb40c000b3a69575cc8e20d45c8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a44a10fa5133dcb40c000b3a69575cc8e20d45c8", "committedDate": "2020-08-28T18:21:12Z", "message": "expunge on background threads"}, "afterCommit": {"oid": "f094977b2d70b527ee4d661ae458c33095d7e8ef", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f094977b2d70b527ee4d661ae458c33095d7e8ef", "committedDate": "2020-08-28T18:35:27Z", "message": "expunge on background threads"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f094977b2d70b527ee4d661ae458c33095d7e8ef", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f094977b2d70b527ee4d661ae458c33095d7e8ef", "committedDate": "2020-08-28T18:35:27Z", "message": "expunge on background threads"}, "afterCommit": {"oid": "f42745481efe535bd3cbeed48f63f094abba66b0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f42745481efe535bd3cbeed48f63f094abba66b0", "committedDate": "2020-08-28T18:40:12Z", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ead09a55a1964520bafd96b1892ed49e31ea3ee0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ead09a55a1964520bafd96b1892ed49e31ea3ee0", "committedDate": "2020-08-28T21:25:43Z", "message": "use synchronized wrapper around WeakHashMap in HelperInjector to avoid background cleaning of WeakConcurrentHashMap which persists beyond the usage of the map, use ClassValue instead of WeakMap in JAX-RS instrumentations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f42745481efe535bd3cbeed48f63f094abba66b0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f42745481efe535bd3cbeed48f63f094abba66b0", "committedDate": "2020-08-28T18:40:12Z", "message": "allow inlining of weak map expunging to avoid background cleaning which persists beyond the usage of the map"}, "afterCommit": {"oid": "ead09a55a1964520bafd96b1892ed49e31ea3ee0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ead09a55a1964520bafd96b1892ed49e31ea3ee0", "committedDate": "2020-08-28T21:25:43Z", "message": "use synchronized wrapper around WeakHashMap in HelperInjector to avoid background cleaning of WeakConcurrentHashMap which persists beyond the usage of the map, use ClassValue instead of WeakMap in JAX-RS instrumentations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjkwMjg3", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#pullrequestreview-478690287", "createdAt": "2020-08-31T14:57:56Z", "commit": {"oid": "ead09a55a1964520bafd96b1892ed49e31ea3ee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNDo1Nzo1NlrOHJ8VNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNDo1Nzo1NlrOHJ8VNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NzcwMw==", "bodyText": "I believe that WeakHashMap is still doing expungeStaleEntries() inline.  If that's the case, is it still better to use that instead of WeakConcurrentMap?", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#discussion_r480187703", "createdAt": "2020-08-31T14:57:56Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -44,7 +43,8 @@ public String toString() {\n   private final Set<String> helperClassNames;\n   private final Map<String, byte[]> dynamicTypeMap = new LinkedHashMap<>();\n \n-  private final WeakMap<ClassLoader, Boolean> injectedClassLoaders = newWeakMap();\n+  private final Map<ClassLoader, Boolean> injectedClassLoaders =\n+      Collections.synchronizedMap(new WeakHashMap<ClassLoader, Boolean>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead09a55a1964520bafd96b1892ed49e31ea3ee0"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a4b59386aa8a917bd480b60c7f38308dd61e05e", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2a4b59386aa8a917bd480b60c7f38308dd61e05e", "committedDate": "2020-08-31T21:21:53Z", "message": "Prevent PendingTrace.initialize From Hanging With This One Weird Trick"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTkwNDE0", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#pullrequestreview-478990414", "createdAt": "2020-08-31T22:12:55Z", "commit": {"oid": "2a4b59386aa8a917bd480b60c7f38308dd61e05e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTYzNjI4", "url": "https://github.com/DataDog/dd-trace-java/pull/1812#pullrequestreview-479563628", "createdAt": "2020-09-01T09:34:25Z", "commit": {"oid": "2a4b59386aa8a917bd480b60c7f38308dd61e05e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1977, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}