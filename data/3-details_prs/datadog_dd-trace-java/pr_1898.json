{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMTE5NTg2", "number": 1898, "title": " Sort traces within ListWriter by start time before asserting", "bodyText": "Uses the PendingTrace.startNanoTicks to provide the greatest precision.\nAlso remove the indexes from trace/span assertion and use just the declaration order instead.", "createdAt": "2020-09-22T18:30:06Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1898", "merged": true, "mergeCommit": {"oid": "b69bd9f94371332354c42b4fe585025d60560b8c"}, "closed": true, "closedAt": "2020-09-25T14:33:46Z", "author": {"login": "tylerbenson"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLt2K_AH2gAyNDkxMTE5NTg2OmM1MDYyYzRiMjMyMjc4MGZmMTE4NjYyYjUyYjc3YWFhM2IzOWViZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMBAWkgFqTQ5NTU1NjM2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5062c4b2322780ff118662b52b77aaa3b39ebe6", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c5062c4b2322780ff118662b52b77aaa3b39ebe6", "committedDate": "2020-09-23T14:55:18Z", "message": "Sort traces within ListWriter by start time before asserting\n\nUses the `PendingTrace.startNanoTicks` to provide the greatest precision."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df04e09c0521b591132fd2824251b13ab71acefc", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/df04e09c0521b591132fd2824251b13ab71acefc", "committedDate": "2020-09-23T14:55:18Z", "message": "Remove indexes from trace and span assert declaration\n\nInstead rely strictly on declaration order."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc93defac2cdebda9c9e1d06a0a47b86c32fc5cc", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cc93defac2cdebda9c9e1d06a0a47b86c32fc5cc", "committedDate": "2020-09-23T14:55:18Z", "message": "Apply Idea formatting to various groovy files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d613eab18796850fb8d38576272d83a03a17f166", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d613eab18796850fb8d38576272d83a03a17f166", "committedDate": "2020-09-23T14:55:18Z", "message": "Apply reordering and index removal to tests\n\nIncluding removal of various methods attempting to resort the trace list."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "142dd79d98bc4353cc87b2297c5797227d116b5a", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/142dd79d98bc4353cc87b2297c5797227d116b5a", "committedDate": "2020-09-23T14:55:18Z", "message": "Improve Couchbase test cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb538427a7917a85fcebdda53c98871d53dcd838", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/eb538427a7917a85fcebdda53c98871d53dcd838", "committedDate": "2020-09-22T18:28:47Z", "message": "Apply reordering and index removal to tests\n\nIncluding removal of various methods attempting to resort the trace list."}, "afterCommit": {"oid": "142dd79d98bc4353cc87b2297c5797227d116b5a", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/142dd79d98bc4353cc87b2297c5797227d116b5a", "committedDate": "2020-09-23T14:55:18Z", "message": "Improve Couchbase test cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aca31b6f572ce41efc5630ecdfbae3635a833e1", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9aca31b6f572ce41efc5630ecdfbae3635a833e1", "committedDate": "2020-09-23T15:44:03Z", "message": "Fix for Java 7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b211260cb296660e9b69fee0fd5ee181fcd22b47", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b211260cb296660e9b69fee0fd5ee181fcd22b47", "committedDate": "2020-09-23T16:00:49Z", "message": "Increase test timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49859a02adf948b237659eab3d92ede2022d7f80", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/49859a02adf948b237659eab3d92ede2022d7f80", "committedDate": "2020-09-23T16:06:40Z", "message": "jacoco should ignore new test assert classes\n\nWe should probably add proper tests for these at some point."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08d489f8c3833644f4ba0c3d644abe7242b0f0e6", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/08d489f8c3833644f4ba0c3d644abe7242b0f0e6", "committedDate": "2020-09-23T17:04:26Z", "message": "Ignore additional traces from Spring JMS Listener test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89425ac977054113e26630255b54d5ae50e1a2e3", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/89425ac977054113e26630255b54d5ae50e1a2e3", "committedDate": "2020-09-23T18:29:16Z", "message": "Make elasticsearch cleanup more reliable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "088d08cb3ad9f060bea9f456fd0efd95070c6037", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/088d08cb3ad9f060bea9f456fd0efd95070c6037", "committedDate": "2020-09-23T17:35:30Z", "message": "Make elasticsearch cleanup more reliable"}, "afterCommit": {"oid": "89425ac977054113e26630255b54d5ae50e1a2e3", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/89425ac977054113e26630255b54d5ae50e1a2e3", "committedDate": "2020-09-23T18:29:16Z", "message": "Make elasticsearch cleanup more reliable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "373f7a333cdc5e1cf3648c0951d5c74dd765e796", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/373f7a333cdc5e1cf3648c0951d5c74dd765e796", "committedDate": "2020-09-23T19:41:19Z", "message": "Add couchbase span sorting"}, "afterCommit": {"oid": "70cad5b47a23cfb0ebe257568539a353535b0d90", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/70cad5b47a23cfb0ebe257568539a353535b0d90", "committedDate": "2020-09-23T20:24:47Z", "message": "Don't reference specific traces in TEST_WRITER\n\nSince the traces are sorted before asserting, but the change isn't reflected in the TEST_WRITER, we should reference the sorted traces instead."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70cad5b47a23cfb0ebe257568539a353535b0d90", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/70cad5b47a23cfb0ebe257568539a353535b0d90", "committedDate": "2020-09-23T20:24:47Z", "message": "Don't reference specific traces in TEST_WRITER\n\nSince the traces are sorted before asserting, but the change isn't reflected in the TEST_WRITER, we should reference the sorted traces instead."}, "afterCommit": {"oid": "c514b5699bcd908cf4f54c550e12625da1c63479", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c514b5699bcd908cf4f54c550e12625da1c63479", "committedDate": "2020-09-23T20:48:21Z", "message": "Add couchbase span sorting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39163d7e4b2e4dc46f2b63e331698d1f927fd290", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/39163d7e4b2e4dc46f2b63e331698d1f927fd290", "committedDate": "2020-09-23T21:10:01Z", "message": "Add couchbase span sorting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c514b5699bcd908cf4f54c550e12625da1c63479", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c514b5699bcd908cf4f54c550e12625da1c63479", "committedDate": "2020-09-23T20:48:21Z", "message": "Add couchbase span sorting"}, "afterCommit": {"oid": "97c8d6285b0b5d49936ce9cb19961a1263cbfd14", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/97c8d6285b0b5d49936ce9cb19961a1263cbfd14", "committedDate": "2020-09-23T21:11:53Z", "message": "Don't reference specific traces in TEST_WRITER\n\nSince the traces are sorted before asserting, but the change isn't reflected in the TEST_WRITER, we should reference the sorted traces instead."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e2f4e19ea63f887fde1f99c737b575b1d8d0d38", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8e2f4e19ea63f887fde1f99c737b575b1d8d0d38", "committedDate": "2020-09-23T21:38:22Z", "message": "Don't reference specific traces in TEST_WRITER\n\nSince the traces are sorted before asserting, but the change isn't reflected in the TEST_WRITER, we should reference the sorted traces instead."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf6de4d7cb6b1d23697004530dee08ad3d48480d", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bf6de4d7cb6b1d23697004530dee08ad3d48480d", "committedDate": "2020-09-23T22:41:20Z", "message": "Fix index of a couple reordered spans"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97c8d6285b0b5d49936ce9cb19961a1263cbfd14", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/97c8d6285b0b5d49936ce9cb19961a1263cbfd14", "committedDate": "2020-09-23T21:11:53Z", "message": "Don't reference specific traces in TEST_WRITER\n\nSince the traces are sorted before asserting, but the change isn't reflected in the TEST_WRITER, we should reference the sorted traces instead."}, "afterCommit": {"oid": "bf6de4d7cb6b1d23697004530dee08ad3d48480d", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bf6de4d7cb6b1d23697004530dee08ad3d48480d", "committedDate": "2020-09-23T22:41:20Z", "message": "Fix index of a couple reordered spans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab417cf00d677dec350f62800f78e7538de5e041", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ab417cf00d677dec350f62800f78e7538de5e041", "committedDate": "2020-09-24T02:54:27Z", "message": "More ES test fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NDM0MzY1", "url": "https://github.com/DataDog/dd-trace-java/pull/1898#pullrequestreview-495434365", "createdAt": "2020-09-24T10:33:53Z", "commit": {"oid": "ab417cf00d677dec350f62800f78e7538de5e041"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTQ5NTA3", "url": "https://github.com/DataDog/dd-trace-java/pull/1898#pullrequestreview-495549507", "createdAt": "2020-09-24T13:07:07Z", "commit": {"oid": "ab417cf00d677dec350f62800f78e7538de5e041"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzowNzowN1rOHXZv2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzowNzowN1rOHXZv2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMTE0NQ==", "bodyText": "should we check this before adding the latch?  maybe even move it into the while condition, ie.\nwhile (!isReported(span)) {\n  // ... add latch and wait...", "url": "https://github.com/DataDog/dd-trace-java/pull/1898#discussion_r494301145", "createdAt": "2020-09-24T13:07:07Z", "author": {"login": "mcculls"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ListWriter.java", "diffHunk": "@@ -52,6 +52,32 @@ public void waitForTraces(final int number) throws InterruptedException, Timeout\n     }\n   }\n \n+  public void waitUntilReported(final DDSpan span) throws InterruptedException, TimeoutException {\n+    while (true) {\n+      final CountDownLatch latch = new CountDownLatch(size() + 1);\n+      synchronized (latches) {\n+        latches.add(latch);\n+      }\n+      if (isReported(span)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab417cf00d677dec350f62800f78e7538de5e041"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTU2MzY5", "url": "https://github.com/DataDog/dd-trace-java/pull/1898#pullrequestreview-495556369", "createdAt": "2020-09-24T13:14:37Z", "commit": {"oid": "ab417cf00d677dec350f62800f78e7538de5e041"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3146, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}