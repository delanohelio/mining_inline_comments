{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MDUyNjY2", "number": 1876, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MDozNVrOEv7RxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTozNzowN1rOEwUKYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4Njg5NzMyOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MDozNVrOHlL-rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MDozNVrOHlL-rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NTYyOA==", "bodyText": "Reverting changes here. Auto-formatter changed this when I was adding debug logging", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508755628", "createdAt": "2020-10-20T18:40:35Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -40,7 +40,7 @@\n     private final CoreTracer tracer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4Njg5ODIzOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MDo0M1rOHlL_Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MDo0M1rOHlL_Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NTc3OQ==", "bodyText": "Reverting changes here. Auto-formatter changed this when I was adding debug logging", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508755779", "createdAt": "2020-10-20T18:40:43Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -79,7 +79,7 @@ public AgentScope activate(final AgentSpan span, final ScopeSource source) {\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NjkwMDY4OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/dd/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientBase.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MTowOFrOHlMBBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MTowOFrOHlMBBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NjIyOQ==", "bodyText": "This changes the behavior of the test to pass. Will fix in follow up", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508756229", "createdAt": "2020-10-20T18:41:08Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/dd/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientBase.groovy", "diffHunk": "@@ -31,11 +31,10 @@ abstract class SpringWebfluxHttpClientBase extends HttpClientTest {\n       .uri(uri)\n       .headers { h -> headers.forEach({ key, value -> h.add(key, value) }) }\n       .exchange()\n-      .doAfterSuccessOrError { res, ex ->\n-        callback?.call()\n-      }\n       .block()\n \n+    callback?.call()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NjkwMjAyOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/dd/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientBase.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MToyOFrOHlMB2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MToyOFrOHlMB2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NjQ0MA==", "bodyText": "This disables a test that should pass. Will fix in follow up", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508756440", "createdAt": "2020-10-20T18:41:28Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/dd/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientBase.groovy", "diffHunk": "@@ -109,6 +108,10 @@ abstract class SpringWebfluxHttpClientBase extends HttpClientTest {\n     false\n   }\n \n+  boolean testCallbackWithParent() {\n+    false\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NjkwODIwOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MjozOFrOHlMFvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTowNjoxM1rOHlxXxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NzQzNw==", "bodyText": "This is another modeling issue but I don't feel as strongly about this one to fix it in a follow-up", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508757437", "createdAt": "2020-10-20T18:42:38Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "diffHunk": "@@ -176,7 +176,7 @@ class SpringWebfluxTest extends AgentTestRunner {\n             resourceName \"TestController.tracedMethod\"\n             operationName \"trace.annotation\"\n           }\n-          childOf(span(1))\n+          childOf(span(0)) // FIXME this is wrong", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMDk1OQ==", "bodyText": "Logically this seems like it should be a child of 1, not 0, right?  Might be worth understanding what's going on here.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508820959", "createdAt": "2020-10-20T20:33:22Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "diffHunk": "@@ -176,7 +176,7 @@ class SpringWebfluxTest extends AgentTestRunner {\n             resourceName \"TestController.tracedMethod\"\n             operationName \"trace.annotation\"\n           }\n-          childOf(span(1))\n+          childOf(span(0)) // FIXME this is wrong", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NzQzNw=="}, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM2ODI2Mg==", "bodyText": "The parent is the one at the time of the subscribe call, which is the root span, since it creates the stream that ends up calling the controller. So it ends up a sibling instead of child because the handler span doesn't exist yet at the time of stream construction", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509368262", "createdAt": "2020-10-21T15:06:13Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "diffHunk": "@@ -176,7 +176,7 @@ class SpringWebfluxTest extends AgentTestRunner {\n             resourceName \"TestController.tracedMethod\"\n             operationName \"trace.annotation\"\n           }\n-          childOf(span(1))\n+          childOf(span(0)) // FIXME this is wrong", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NzQzNw=="}, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzI0MzIyOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/netty-4.1/src/test/groovy/ReactorNettyTest.groovy", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoxNDozOVrOHlPStw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDo0ODo1OFrOHnRKBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwOTkxMQ==", "bodyText": "Can this extend HttpClientTest instead?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508809911", "createdAt": "2020-10-20T20:14:39Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/netty-4.1/src/test/groovy/ReactorNettyTest.groovy", "diffHunk": "@@ -0,0 +1,84 @@\n+import datadog.trace.agent.test.AgentTestRunner\n+import datadog.trace.agent.test.asserts.TraceAssert\n+import datadog.trace.api.DDSpanTypes\n+import datadog.trace.bootstrap.instrumentation.api.Tags\n+import datadog.trace.core.DDSpan\n+import reactor.netty.http.client.HttpClient\n+import reactor.netty.http.client.HttpClientResponse\n+import spock.lang.AutoCleanup\n+import spock.lang.Shared\n+\n+import static datadog.trace.agent.test.server.http.TestHttpServer.httpServer\n+import static datadog.trace.agent.test.utils.TraceUtils.basicSpan\n+import static datadog.trace.agent.test.utils.TraceUtils.runUnderTrace\n+\n+class ReactorNettyTest extends AgentTestRunner {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM3MTE2Mg==", "bodyText": "Maybe, I considered this test slightly redundant so just ported as is", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509371162", "createdAt": "2020-10-21T15:09:43Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/netty-4.1/src/test/groovy/ReactorNettyTest.groovy", "diffHunk": "@@ -0,0 +1,84 @@\n+import datadog.trace.agent.test.AgentTestRunner\n+import datadog.trace.agent.test.asserts.TraceAssert\n+import datadog.trace.api.DDSpanTypes\n+import datadog.trace.bootstrap.instrumentation.api.Tags\n+import datadog.trace.core.DDSpan\n+import reactor.netty.http.client.HttpClient\n+import reactor.netty.http.client.HttpClientResponse\n+import spock.lang.AutoCleanup\n+import spock.lang.Shared\n+\n+import static datadog.trace.agent.test.server.http.TestHttpServer.httpServer\n+import static datadog.trace.agent.test.utils.TraceUtils.basicSpan\n+import static datadog.trace.agent.test.utils.TraceUtils.runUnderTrace\n+\n+class ReactorNettyTest extends AgentTestRunner {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwOTkxMQ=="}, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIzMjQ5NA==", "bodyText": "By redundant I mean that both of these clients are already covered by client tests. These are more like additional tests", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r510232494", "createdAt": "2020-10-22T14:58:46Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/netty-4.1/src/test/groovy/ReactorNettyTest.groovy", "diffHunk": "@@ -0,0 +1,84 @@\n+import datadog.trace.agent.test.AgentTestRunner\n+import datadog.trace.agent.test.asserts.TraceAssert\n+import datadog.trace.api.DDSpanTypes\n+import datadog.trace.bootstrap.instrumentation.api.Tags\n+import datadog.trace.core.DDSpan\n+import reactor.netty.http.client.HttpClient\n+import reactor.netty.http.client.HttpClientResponse\n+import spock.lang.AutoCleanup\n+import spock.lang.Shared\n+\n+import static datadog.trace.agent.test.server.http.TestHttpServer.httpServer\n+import static datadog.trace.agent.test.utils.TraceUtils.basicSpan\n+import static datadog.trace.agent.test.utils.TraceUtils.runUnderTrace\n+\n+class ReactorNettyTest extends AgentTestRunner {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwOTkxMQ=="}, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkzNDc5Ng==", "bodyText": "Do we have reactor netty client tests elsewhere?  I don't see any usage of reactor.netty.http.client in our codebase.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r510934796", "createdAt": "2020-10-23T14:44:54Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/netty-4.1/src/test/groovy/ReactorNettyTest.groovy", "diffHunk": "@@ -0,0 +1,84 @@\n+import datadog.trace.agent.test.AgentTestRunner\n+import datadog.trace.agent.test.asserts.TraceAssert\n+import datadog.trace.api.DDSpanTypes\n+import datadog.trace.bootstrap.instrumentation.api.Tags\n+import datadog.trace.core.DDSpan\n+import reactor.netty.http.client.HttpClient\n+import reactor.netty.http.client.HttpClientResponse\n+import spock.lang.AutoCleanup\n+import spock.lang.Shared\n+\n+import static datadog.trace.agent.test.server.http.TestHttpServer.httpServer\n+import static datadog.trace.agent.test.utils.TraceUtils.basicSpan\n+import static datadog.trace.agent.test.utils.TraceUtils.runUnderTrace\n+\n+class ReactorNettyTest extends AgentTestRunner {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwOTkxMQ=="}, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkzNzYwNQ==", "bodyText": "reactor-netty is just the glue that wires netty to reactor. The client is covered by the netty and webflux client tests", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r510937605", "createdAt": "2020-10-23T14:48:58Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/netty-4.1/src/test/groovy/ReactorNettyTest.groovy", "diffHunk": "@@ -0,0 +1,84 @@\n+import datadog.trace.agent.test.AgentTestRunner\n+import datadog.trace.agent.test.asserts.TraceAssert\n+import datadog.trace.api.DDSpanTypes\n+import datadog.trace.bootstrap.instrumentation.api.Tags\n+import datadog.trace.core.DDSpan\n+import reactor.netty.http.client.HttpClient\n+import reactor.netty.http.client.HttpClientResponse\n+import spock.lang.AutoCleanup\n+import spock.lang.Shared\n+\n+import static datadog.trace.agent.test.server.http.TestHttpServer.httpServer\n+import static datadog.trace.agent.test.utils.TraceUtils.basicSpan\n+import static datadog.trace.agent.test.utils.TraceUtils.runUnderTrace\n+\n+class ReactorNettyTest extends AgentTestRunner {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwOTkxMQ=="}, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzI3MjI5OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoyMzowNFrOHlPkUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTowODo0NVrOHlxfkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxNDQxNw==", "bodyText": "Why should this result in two different traces?  from the input above, I would expect a single trace.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508814417", "createdAt": "2020-10-20T20:23:04Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "diffHunk": "@@ -383,14 +384,16 @@ class Lettuce5ReactiveClientTest extends AgentTestRunner {\n     when:\n     runUnderTrace(\"test-parent\") {\n       reactiveCommands.set(\"a\", \"1\")\n-        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n+        .then(reactiveCommands.get(\"a\")) // The get here is reported separately\n         .subscribe()\n     }\n \n     then:\n-    assertTraces(1) {\n+    assertTraces(2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM3MDI1OA==", "bodyText": "When doing .subscribe() the flow executes in a non blocking manner. So the parent and the set are in the first trace, but when the set finishes the trace reports and then the get will end up in it's own trace", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509370258", "createdAt": "2020-10-21T15:08:45Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "diffHunk": "@@ -383,14 +384,16 @@ class Lettuce5ReactiveClientTest extends AgentTestRunner {\n     when:\n     runUnderTrace(\"test-parent\") {\n       reactiveCommands.set(\"a\", \"1\")\n-        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n+        .then(reactiveCommands.get(\"a\")) // The get here is reported separately\n         .subscribe()\n     }\n \n     then:\n-    assertTraces(1) {\n+    assertTraces(2) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxNDQxNw=="}, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzI3NzE4OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoyNDoxNlrOHlPnbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoyNDoxNlrOHlPnbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxNTIxMg==", "bodyText": "Doesn't look like this is used.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508815212", "createdAt": "2020-10-20T20:24:16Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "diffHunk": "@@ -438,14 +443,15 @@ class Lettuce5ReactiveClientTest extends AgentTestRunner {\n     when:\n     runUnderTrace(\"test-parent\") {\n       reactiveCommands.set(\"a\", \"1\")\n-        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n-        .subscribeOn(Schedulers.elastic())\n+        .then(reactiveCommands.get(\"a\"))\n+        .subscribeOn(Schedulers.newParallel(\"test\"))\n         .subscribe()\n     }\n \n     then:\n     assertTraces(1) {\n       sortSpansByStart()\n+      DDSpan parentSpan", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzI4MjIwOnYy", "diffSide": "LEFT", "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/test/groovy/ReactorCoreTest.groovy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoyNToyMlrOHlPqVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoyNToyMlrOHlPqVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxNTk1Ng==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508815956", "createdAt": "2020-10-20T20:25:22Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/test/groovy/ReactorCoreTest.groovy", "diffHunk": "@@ -23,24 +24,22 @@ class ReactorCoreTest extends AgentTestRunner {\n \n   @Shared\n   def addOne = { i ->\n-    // FIXME: Our clock implementation doesn't guarantee that start times are monotonic across\n-    //  traces, we base span start times on a millisecond time from the start of the trace and\n-    //  offset a number of nanos, this does not guarantee that the start times are monotonic. Thus\n-    //  2 traces started during the same millisecond might have the span start times wrong relative\n-    //  to each other. IE: TraceA and TraceB start at the same millisecond, SpanA1 starts, then\n-    //  SpanB1 starts. SpanB1 can have an earlier startTimeNano than SpanA1\n-    sleep(1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzMwMzY3OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDozMDoyMFrOHlP3Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDozMDoyMFrOHlP3Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxOTI5MA==", "bodyText": "These are no longer needed... (same comment below)", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508819290", "createdAt": "2020-10-20T20:30:20Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "diffHunk": "@@ -122,7 +122,7 @@ class SpringWebfluxTest extends AgentTestRunner {\n     assertTraces(1) {\n       sortSpansByStart()\n       trace(3) {\n-        span {\n+        span(0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDkyMTcyOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/lettuce-5/src/main/java8/datadog/trace/instrumentation/lettuce5/rx/LettuceMonoDualConsumer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyNjowNVrOHlyWIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyNjowNVrOHlyWIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NDIyNw==", "bodyText": "Can we put REDIS_QUERY back in as the span name here?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509384227", "createdAt": "2020-10-21T15:26:05Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/main/java8/datadog/trace/instrumentation/lettuce5/rx/LettuceMonoDualConsumer.java", "diffHunk": "@@ -17,20 +19,32 @@\n   private AgentSpan span = null;\n   private final RedisCommand command;\n   private final boolean finishSpanOnClose;\n+  private final AgentSpan parentSpan;\n \n   public LettuceMonoDualConsumer(final RedisCommand command, final boolean finishSpanOnClose) {\n     this.command = command;\n     this.finishSpanOnClose = finishSpanOnClose;\n+    parentSpan = activeSpan();\n   }\n \n   @Override\n   public void accept(final R r) {\n-    span = startSpan(REDIS_QUERY);\n-    DECORATE.afterStart(span);\n-    DECORATE.onCommand(span, command);\n-    if (finishSpanOnClose) {\n-      DECORATE.beforeFinish(span);\n-      span.finish();\n+    TraceScope parentScope = null;\n+    try {\n+      if (parentSpan != null) {\n+        parentScope = activateSpan(parentSpan);\n+      }\n+      span = startSpan(\"redis.query\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDkyNjQ0OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyNzowNFrOHlyZMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNDo1NzowMFrOHmmCQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NTAxMQ==", "bodyText": "Can we also test on the elastic scheduler? Does this still work if you change the scheduler back?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509385011", "createdAt": "2020-10-21T15:27:04Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "diffHunk": "@@ -438,8 +443,8 @@ class Lettuce5ReactiveClientTest extends AgentTestRunner {\n     when:\n     runUnderTrace(\"test-parent\") {\n       reactiveCommands.set(\"a\", \"1\")\n-        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n-        .subscribeOn(Schedulers.elastic())\n+        .then(reactiveCommands.get(\"a\"))\n+        .subscribeOn(Schedulers.newParallel(\"test\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIzMTEwNA==", "bodyText": "The test becomes flaky with the other scheduler. I'll make a mental note to update this test in my followup", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r510231104", "createdAt": "2020-10-22T14:57:00Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "diffHunk": "@@ -438,8 +443,8 @@ class Lettuce5ReactiveClientTest extends AgentTestRunner {\n     when:\n     runUnderTrace(\"test-parent\") {\n       reactiveCommands.set(\"a\", \"1\")\n-        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n-        .subscribeOn(Schedulers.elastic())\n+        .then(reactiveCommands.get(\"a\"))\n+        .subscribeOn(Schedulers.newParallel(\"test\"))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NTAxMQ=="}, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDkzMDY2OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/reactor-core-3.1/NOTICE.txt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyNzo1OFrOHlyb6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNDowNjoxNFrOHmjirQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NTcwNA==", "bodyText": "Is it OpenTracing or OpenTelemetry?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509385704", "createdAt": "2020-10-21T15:27:58Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/NOTICE.txt", "diffHunk": "@@ -0,0 +1,17 @@\n+This product contains a modified part of OpenTracing:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE5MDI1Mw==", "bodyText": "This NOTICE was copied from OTel, but their code was copied from opentracing", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r510190253", "createdAt": "2020-10-22T14:06:14Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/NOTICE.txt", "diffHunk": "@@ -0,0 +1,17 @@\n+This product contains a modified part of OpenTracing:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NTcwNA=="}, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDkzNzIzOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/main/java8/datadog/trace/instrumentation/reactor/core/TracingOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyOToxNFrOHlyf0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNDozODoxN1rOHmlH9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NjcwNg==", "bodyText": "Since this will happen a lot with few distinct inputs can we wrap this string comparison in a ClassValue?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509386706", "createdAt": "2020-10-21T15:29:14Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/main/java8/datadog/trace/instrumentation/reactor/core/TracingOperator.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package datadog.trace.instrumentation.reactor.core;\n+\n+import java.util.function.BiFunction;\n+import java.util.function.Function;\n+import org.reactivestreams.Publisher;\n+import reactor.core.CoreSubscriber;\n+import reactor.core.Fuseable;\n+import reactor.core.Scannable;\n+import reactor.core.publisher.Hooks;\n+import reactor.core.publisher.Operators;\n+\n+/** Based on Spring Sleuth's Reactor instrumentation. */\n+public class TracingOperator {\n+\n+  /**\n+   * Registers a hook that applies to every operator, propagating {@link Context} to downstream\n+   * callbacks to ensure spans in the {@link Context} are available throughout the lifetime of a\n+   * reactive stream. This should generally be called in a static initializer block in your\n+   * application.\n+   */\n+  public static void registerOnEachOperator() {\n+    Hooks.onEachOperator(TracingSubscriber.class.getName(), tracingLift());\n+  }\n+\n+  private static <T> Function<? super Publisher<T>, ? extends Publisher<T>> tracingLift() {\n+    return Operators.lift(new Lifter<>());\n+  }\n+\n+  public static class Lifter<T>\n+      implements BiFunction<Scannable, CoreSubscriber<? super T>, CoreSubscriber<? super T>> {\n+\n+    @Override\n+    public CoreSubscriber<? super T> apply(\n+        final Scannable publisher, final CoreSubscriber<? super T> sub) {\n+      // if Flux/Mono #just, #empty, #error\n+      if (publisher instanceof Fuseable.ScalarCallable\n+          || publisher.getClass().getName().startsWith(\"reactor.core.Scannable$Attr$\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIxNjE4Mg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r510216182", "createdAt": "2020-10-22T14:38:17Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/main/java8/datadog/trace/instrumentation/reactor/core/TracingOperator.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package datadog.trace.instrumentation.reactor.core;\n+\n+import java.util.function.BiFunction;\n+import java.util.function.Function;\n+import org.reactivestreams.Publisher;\n+import reactor.core.CoreSubscriber;\n+import reactor.core.Fuseable;\n+import reactor.core.Scannable;\n+import reactor.core.publisher.Hooks;\n+import reactor.core.publisher.Operators;\n+\n+/** Based on Spring Sleuth's Reactor instrumentation. */\n+public class TracingOperator {\n+\n+  /**\n+   * Registers a hook that applies to every operator, propagating {@link Context} to downstream\n+   * callbacks to ensure spans in the {@link Context} are available throughout the lifetime of a\n+   * reactive stream. This should generally be called in a static initializer block in your\n+   * application.\n+   */\n+  public static void registerOnEachOperator() {\n+    Hooks.onEachOperator(TracingSubscriber.class.getName(), tracingLift());\n+  }\n+\n+  private static <T> Function<? super Publisher<T>, ? extends Publisher<T>> tracingLift() {\n+    return Operators.lift(new Lifter<>());\n+  }\n+\n+  public static class Lifter<T>\n+      implements BiFunction<Scannable, CoreSubscriber<? super T>, CoreSubscriber<? super T>> {\n+\n+    @Override\n+    public CoreSubscriber<? super T> apply(\n+        final Scannable publisher, final CoreSubscriber<? super T> sub) {\n+      // if Flux/Mono #just, #empty, #error\n+      if (publisher instanceof Fuseable.ScalarCallable\n+          || publisher.getClass().getName().startsWith(\"reactor.core.Scannable$Attr$\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NjcwNg=="}, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDk1NzcwOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/test/groovy/ReactorCoreTest.groovy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTozMzozMVrOHlysrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTozMzozMVrOHlysrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4OTk5Nw==", "bodyText": "I think parameterising the scheduler would be really helpful.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509389997", "createdAt": "2020-10-21T15:33:31Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/test/groovy/ReactorCoreTest.groovy", "diffHunk": "@@ -375,15 +350,30 @@ class ReactorCoreTest extends AgentTestRunner {\n     \"basic flux\" | 2         | { -> Flux.fromIterable([1, 2]).map(addOne) }\n   }\n \n+  def \"Fluxes produce the right number of results\"() {\n+    when:\n+    List<String> values = Flux.fromIterable(Arrays.asList(1, 2, 3, 4))\n+      .parallel()\n+      .runOn(Schedulers.parallel())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 233}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDk3NDQzOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/spring-webflux-5/src/main/java8/datadog/trace/instrumentation/springwebflux/client/WebClientTracingFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTozNzowN1rOHly3YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTozNzowN1rOHly3YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM5MjczNg==", "bodyText": "Can we change the span names back to the way they were - this improves serialisation performance.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509392736", "createdAt": "2020-10-21T15:37:07Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/main/java8/datadog/trace/instrumentation/springwebflux/client/WebClientTracingFilter.java", "diffHunk": "@@ -2,77 +2,67 @@\n \n import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activeSpan;\n-import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.propagate;\n import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n-import static datadog.trace.instrumentation.springwebflux.client.HttpHeadersInjectAdapter.SETTER;\n import static datadog.trace.instrumentation.springwebflux.client.SpringWebfluxHttpClientDecorator.DECORATE;\n-import static datadog.trace.instrumentation.springwebflux.client.SpringWebfluxHttpClientDecorator.HTTP_REQUEST;\n \n import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n-import datadog.trace.bootstrap.instrumentation.api.InstrumentationTags;\n-import datadog.trace.bootstrap.instrumentation.api.Tags;\n import java.util.List;\n import org.springframework.web.reactive.function.client.ClientRequest;\n import org.springframework.web.reactive.function.client.ClientResponse;\n import org.springframework.web.reactive.function.client.ExchangeFilterFunction;\n import org.springframework.web.reactive.function.client.ExchangeFunction;\n+import reactor.core.CoreSubscriber;\n import reactor.core.publisher.Mono;\n \n+/**\n+ * Based on Spring Sleuth's Reactor instrumentation.\n+ * https://github.com/spring-cloud/spring-cloud-sleuth/blob/master/spring-cloud-sleuth-core/src/main/java/org/springframework/cloud/sleuth/instrument/web/client/TraceWebClientBeanPostProcessor.java\n+ */\n public class WebClientTracingFilter implements ExchangeFilterFunction {\n-  private static final WebClientTracingFilter INSTANCE = new WebClientTracingFilter();\n-\n   public static void addFilter(final List<ExchangeFilterFunction> exchangeFilterFunctions) {\n     // Since the builder where we instrument the build function can be reused, we need\n     // to only add the filter once\n-    int index = exchangeFilterFunctions.indexOf(INSTANCE);\n-    if (index == 0) {\n-      return;\n-    }\n-    if (index > 0) {\n-      exchangeFilterFunctions.remove(index);\n-    }\n-    exchangeFilterFunctions.add(0, INSTANCE);\n+    exchangeFilterFunctions.removeIf(\n+        filterFunction -> filterFunction instanceof WebClientTracingFilter);\n+    exchangeFilterFunctions.add(0, new WebClientTracingFilter());\n   }\n \n   @Override\n   public Mono<ClientResponse> filter(final ClientRequest request, final ExchangeFunction next) {\n-    final AgentSpan span;\n-    if (activeSpan() != null) {\n-      span = startSpan(HTTP_REQUEST, activeSpan().context());\n-    } else {\n-      span = startSpan(HTTP_REQUEST);\n-    }\n-    span.setTag(Tags.SPAN_KIND, Tags.SPAN_KIND_CLIENT);\n-    span.setTag(InstrumentationTags.DD_MEASURED, true);\n-    DECORATE.afterStart(span);\n+    return new MonoWebClientTrace(request, next);\n+  }\n+\n+  public static final class MonoWebClientTrace extends Mono<ClientResponse> {\n+    final ExchangeFunction next;\n+    final ClientRequest request;\n \n-    try (final AgentScope scope = activateSpan(span)) {\n-      scope.setAsyncPropagation(true);\n-      final ClientRequest mutatedRequest =\n-          ClientRequest.from(request)\n-              .attribute(AgentSpan.class.getName(), span)\n-              .headers(httpHeaders -> propagate().inject(span, httpHeaders, SETTER))\n-              .build();\n-      DECORATE.onRequest(span, mutatedRequest);\n+    public MonoWebClientTrace(final ClientRequest request, final ExchangeFunction next) {\n+      this.next = next;\n+      this.request = request;\n+    }\n \n-      return next.exchange(mutatedRequest)\n-          .doOnSuccessOrError(\n-              (clientResponse, throwable) -> {\n-                if (throwable != null) {\n-                  DECORATE.onError(span, throwable);\n-                } else {\n-                  DECORATE.onResponse(span, clientResponse);\n-                }\n-                DECORATE.beforeFinish(span);\n-                span.finish();\n-              })\n-          .doOnCancel(\n-              () -> {\n-                DECORATE.onCancel(span);\n-                DECORATE.beforeFinish(span);\n-                span.finish();\n-              });\n+    @Override\n+    public void subscribe(final CoreSubscriber<? super ClientResponse> subscriber) {\n+      final AgentSpan span;\n+      if (activeSpan() != null) {\n+        span = startSpan(\"http.request\", activeSpan().context());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 97}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4821, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}