{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNTg5NDc0", "number": 2033, "title": "Fail-fast on DDTracer.build when writer is null or DDAgentWriter", "bodyText": "After #1994, it's not possible to use the DDTracer with the ListWriter for tests and using the dd-java-agent in the test phase to report tests using the JUnit4 instrumentation.\nThis PR modifies the logic to fail-fast only when the writer is null or DDAgentWriter.", "createdAt": "2020-10-27T09:04:09Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2033", "merged": true, "mergeCommit": {"oid": "6fd4cc2c6ae17bee332375fb9d34f2d239111bb3"}, "closed": true, "closedAt": "2020-10-29T14:32:50Z", "author": {"login": "drodriguezhdez"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW-yyAgH2gAyNTEwNTg5NDc0OmM3N2U4M2ZiOTMyOThjNDNjZGU2YjBjMTNkNTY5YjY5ZTU0MDcxNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXPaTcAFqTUxOTUxNDkwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c77e83fb93298c43cde6b0c13d569b69e5407175", "author": {"user": {"login": "drodriguezhdez", "name": "Daniel Rodriguez Hernandez"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c77e83fb93298c43cde6b0c13d569b69e5407175", "committedDate": "2020-10-28T14:53:09Z", "message": "Fail-fast on DDTracer.build() when writer is null or DDAgentWriter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a799aae18831f51cdd86770c87d29eb7d65c09cc", "author": {"user": {"login": "drodriguezhdez", "name": "Daniel Rodriguez Hernandez"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a799aae18831f51cdd86770c87d29eb7d65c09cc", "committedDate": "2020-10-27T09:02:38Z", "message": "Fail-fast on DDTracer.build() when writer is null or DDAgentWriter"}, "afterCommit": {"oid": "c77e83fb93298c43cde6b0c13d569b69e5407175", "author": {"user": {"login": "drodriguezhdez", "name": "Daniel Rodriguez Hernandez"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c77e83fb93298c43cde6b0c13d569b69e5407175", "committedDate": "2020-10-28T14:53:09Z", "message": "Fail-fast on DDTracer.build() when writer is null or DDAgentWriter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4OTI4MDU1", "url": "https://github.com/DataDog/dd-trace-java/pull/2033#pullrequestreview-518928055", "createdAt": "2020-10-28T17:41:38Z", "commit": {"oid": "c77e83fb93298c43cde6b0c13d569b69e5407175"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNzo0MTozOFrOHp2JQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNzo0MjoyNVrOHp2LUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY0MDc3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (writer == null\n          \n          \n            \n                    || writer.getClass().getName().equals(\"datadog.trace.common.writer.DDAgentWriter\")) {\n          \n          \n            \n                  if (GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n          \n          \n            \n                    log.error(\n          \n          \n            \n                        \"Datadog Tracer already installed by `dd-java-agent`. NOTE: Manually creating the tracer while using `dd-java-agent` is not supported\");\n          \n          \n            \n                    throw new IllegalStateException(\"Datadog Tracer already installed\");\n          \n          \n            \n                  }\n          \n          \n            \n                }\n          \n          \n            \n                if ((writer == null\n          \n          \n            \n                    || writer.getClass().getName().equals(\"datadog.trace.common.writer.DDAgentWriter\")) &&\n          \n          \n            \n                  GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n          \n          \n            \n                    log.error(\n          \n          \n            \n                        \"Datadog Tracer already installed by `dd-java-agent`. NOTE: Manually creating the tracer while using `dd-java-agent` is not supported\");\n          \n          \n            \n                    throw new IllegalStateException(\"Datadog Tracer already installed\");\n          \n          \n            \n                }", "url": "https://github.com/DataDog/dd-trace-java/pull/2033#discussion_r513640771", "createdAt": "2020-10-28T17:41:38Z", "author": {"login": "randomanderson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -200,10 +200,13 @@ private DDTracer(\n \n     // Check if the tracer is already installed by the agent\n     // Unable to use \"instanceof\" because of class renaming\n-    if (GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n-      log.error(\n-          \"Datadog Tracer already installed by `dd-java-agent`. NOTE: Manually creating the tracer while using `dd-java-agent` is not supported\");\n-      throw new IllegalStateException(\"Datadog Tracer already installed\");\n+    if (writer == null\n+        || writer.getClass().getName().equals(\"datadog.trace.common.writer.DDAgentWriter\")) {\n+      if (GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n+        log.error(\n+            \"Datadog Tracer already installed by `dd-java-agent`. NOTE: Manually creating the tracer while using `dd-java-agent` is not supported\");\n+        throw new IllegalStateException(\"Datadog Tracer already installed\");\n+      }\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c77e83fb93298c43cde6b0c13d569b69e5407175"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY0MTI5OA==", "bodyText": "These if statements can be combined.  I probably messed up the indentation using the Github web editor", "url": "https://github.com/DataDog/dd-trace-java/pull/2033#discussion_r513641298", "createdAt": "2020-10-28T17:42:25Z", "author": {"login": "randomanderson"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -200,10 +200,13 @@ private DDTracer(\n \n     // Check if the tracer is already installed by the agent\n     // Unable to use \"instanceof\" because of class renaming\n-    if (GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n-      log.error(\n-          \"Datadog Tracer already installed by `dd-java-agent`. NOTE: Manually creating the tracer while using `dd-java-agent` is not supported\");\n-      throw new IllegalStateException(\"Datadog Tracer already installed\");\n+    if (writer == null\n+        || writer.getClass().getName().equals(\"datadog.trace.common.writer.DDAgentWriter\")) {\n+      if (GlobalTracer.get().getClass().getName().equals(\"datadog.trace.agent.core.CoreTracer\")) {\n+        log.error(\n+            \"Datadog Tracer already installed by `dd-java-agent`. NOTE: Manually creating the tracer while using `dd-java-agent` is not supported\");\n+        throw new IllegalStateException(\"Datadog Tracer already installed\");\n+      }\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY0MDc3MQ=="}, "originalCommit": {"oid": "c77e83fb93298c43cde6b0c13d569b69e5407175"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc24e9c18880e231ad30bfeeae042abacc3c3e7e", "author": {"user": {"login": "drodriguezhdez", "name": "Daniel Rodriguez Hernandez"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cc24e9c18880e231ad30bfeeae042abacc3c3e7e", "committedDate": "2020-10-29T08:00:47Z", "message": "Combined clauses"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NTE0OTA1", "url": "https://github.com/DataDog/dd-trace-java/pull/2033#pullrequestreview-519514905", "createdAt": "2020-10-29T10:14:48Z", "commit": {"oid": "cc24e9c18880e231ad30bfeeae042abacc3c3e7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3054, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}