{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzgwNzQ2", "number": 1740, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODoyODoyMFrOEU5jCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODoyOTozNlrOEU5k-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzQ5ODM1OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/hibernate/src/main/java/datadog/trace/instrumentation/hibernate/SessionMethodUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODoyODoyMFrOG7WbCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMzo0Nzo0MFrOG7hJ4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjUzOA==", "bodyText": "Any particular reason to pass along this, even though it's not used?", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r464886538", "createdAt": "2020-08-04T08:28:20Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/hibernate/src/main/java/datadog/trace/instrumentation/hibernate/SessionMethodUtils.java", "diffHunk": "@@ -24,6 +25,7 @@\n   public static <TARGET, ENTITY> SessionState startScopeFrom(\n       final ContextStore<TARGET, SessionState> contextStore,\n       final TARGET spanKey,\n+      final Method origin,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MjM3MA==", "bodyText": "This is related to another PR I'm working on... which inspired this change.", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465062370", "createdAt": "2020-08-04T13:47:40Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/hibernate/src/main/java/datadog/trace/instrumentation/hibernate/SessionMethodUtils.java", "diffHunk": "@@ -24,6 +25,7 @@\n   public static <TARGET, ENTITY> SessionState startScopeFrom(\n       final ContextStore<TARGET, SessionState> contextStore,\n       final TARGET spanKey,\n+      final Method origin,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjUzOA=="}, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzUwMDYzOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/api/Pair.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODoyODo1NlrOG7WcgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNDoxMzowMVrOG7iSAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjkxMg==", "bodyText": "This seems unrelated to the change.", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r464886912", "createdAt": "2020-08-04T08:28:56Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/api/Pair.java", "diffHunk": "@@ -1,5 +1,8 @@\n package datadog.trace.bootstrap.instrumentation.api;\n \n+import lombok.EqualsAndHashCode;\n+\n+@EqualsAndHashCode", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MzUwOQ==", "bodyText": "yeah, unrelated now.  I originally was caching with a pair as the key, but then I figured out the call site caching option and decided to do that instead.  I left this in here because it seemed like an oversight that might be missed later.  Would you prefer I pull it out?", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465063509", "createdAt": "2020-08-04T13:49:20Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/api/Pair.java", "diffHunk": "@@ -1,5 +1,8 @@\n package datadog.trace.bootstrap.instrumentation.api;\n \n+import lombok.EqualsAndHashCode;\n+\n+@EqualsAndHashCode", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjkxMg=="}, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA4MDgzMw==", "bodyText": "Not sure it's an oversight, do we have any Pairs as keys in maps where this would be relevant? Not opposed to adding it though.", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465080833", "createdAt": "2020-08-04T14:13:01Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/api/Pair.java", "diffHunk": "@@ -1,5 +1,8 @@\n package datadog.trace.bootstrap.instrumentation.api;\n \n+import lombok.EqualsAndHashCode;\n+\n+@EqualsAndHashCode", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjkxMg=="}, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzUwMzI4OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/hibernate/core-3.3/src/main/java/datadog/trace/instrumentation/hibernate/core/v3_3/CriteriaInstrumentation.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODoyOTozNlrOG7WeGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNDoyNjoyOVrOG7i8gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA==", "bodyText": "Ah, nice. I assume that this is cached at the call site.", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r464887320", "createdAt": "2020-08-04T08:29:36Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/hibernate/core-3.3/src/main/java/datadog/trace/instrumentation/hibernate/core/v3_3/CriteriaInstrumentation.java", "diffHunk": "@@ -44,13 +45,15 @@\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SessionState startMethod(\n-        @Advice.This final Criteria criteria, @Advice.Origin(\"#m\") final String name) {\n+        @Advice.This final Criteria criteria,\n+        @Advice.Origin(\"hibernate.criteria.#m\") final String operationName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5MjM0MQ==", "bodyText": "Is 16 a good guess for the size of the hash map? That would imply an expected cardinality of operationName of about 8. It might be reasonable, but I'd want to know why.", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r464892341", "createdAt": "2020-08-04T08:37:55Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/hibernate/core-3.3/src/main/java/datadog/trace/instrumentation/hibernate/core/v3_3/CriteriaInstrumentation.java", "diffHunk": "@@ -44,13 +45,15 @@\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SessionState startMethod(\n-        @Advice.This final Criteria criteria, @Advice.Origin(\"#m\") final String name) {\n+        @Advice.This final Criteria criteria,\n+        @Advice.Origin(\"hibernate.criteria.#m\") final String operationName,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA=="}, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2NTQyOA==", "bodyText": "I'm assuming that this avoids repeat concatenation by creating a constant in the byte code.  I didn't actually verify that though.", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465065428", "createdAt": "2020-08-04T13:52:01Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/hibernate/core-3.3/src/main/java/datadog/trace/instrumentation/hibernate/core/v3_3/CriteriaInstrumentation.java", "diffHunk": "@@ -44,13 +45,15 @@\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SessionState startMethod(\n-        @Advice.This final Criteria criteria, @Advice.Origin(\"#m\") final String name) {\n+        @Advice.This final Criteria criteria,\n+        @Advice.Origin(\"hibernate.criteria.#m\") final String operationName,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA=="}, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3OTk1MA==", "bodyText": "But the question was why the guess of the size of 16? What's the rationale for choosing 16?", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465079950", "createdAt": "2020-08-04T14:11:48Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/hibernate/core-3.3/src/main/java/datadog/trace/instrumentation/hibernate/core/v3_3/CriteriaInstrumentation.java", "diffHunk": "@@ -44,13 +45,15 @@\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SessionState startMethod(\n-        @Advice.This final Criteria criteria, @Advice.Origin(\"#m\") final String name) {\n+        @Advice.This final Criteria criteria,\n+        @Advice.Origin(\"hibernate.criteria.#m\") final String operationName,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA=="}, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA5MTcxNQ==", "bodyText": "Ok, I ran it in a debugger and verified that the object instance is reused, where on master it creates a new one each time.", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465091715", "createdAt": "2020-08-04T14:26:29Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/hibernate/core-3.3/src/main/java/datadog/trace/instrumentation/hibernate/core/v3_3/CriteriaInstrumentation.java", "diffHunk": "@@ -44,13 +45,15 @@\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SessionState startMethod(\n-        @Advice.This final Criteria criteria, @Advice.Origin(\"#m\") final String name) {\n+        @Advice.This final Criteria criteria,\n+        @Advice.Origin(\"hibernate.criteria.#m\") final String operationName,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA=="}, "originalCommit": {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4986, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}