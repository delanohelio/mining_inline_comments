{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NTM1MzM2", "number": 1552, "title": "Fix sampling", "bodyText": "made threadIds in JMXSampler a set, so you cannot add duplicates now\nskip stacks dispatching when no scope found", "createdAt": "2020-06-05T15:36:26Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1552", "merged": true, "mergeCommit": {"oid": "1a4108e68401080608cc162c3099335aaf51c949"}, "closed": true, "closedAt": "2020-06-10T15:43:17Z", "author": {"login": "jpbempel"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoUfiUAH2gAyNDI4NTM1MzM2OjVkZWE0ODMzODE2MTMzYzE2ZGY4OTkzMjUyNWU0MDY1YmJlYTU1OGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp7gMAAFqTQyODE4MjQyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5dea4833816133c16df89932525e4065bbea558c", "author": {"user": {"login": "jpbempel", "name": "Jean-Philippe Bempel"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5dea4833816133c16df89932525e4065bbea558c", "committedDate": "2020-06-05T15:35:36Z", "message": "Fix sampling\n\nmade threadIds in JMXsampler a set, so you cannot add dumplicates now\nskip stacks dispatching when no scope found"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTAzNTc5", "url": "https://github.com/DataDog/dd-trace-java/pull/1552#pullrequestreview-426503579", "createdAt": "2020-06-08T18:27:20Z", "commit": {"oid": "5dea4833816133c16df89932525e4065bbea558c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3ODg2ODk3", "url": "https://github.com/DataDog/dd-trace-java/pull/1552#pullrequestreview-427886897", "createdAt": "2020-06-10T09:40:28Z", "commit": {"oid": "5dea4833816133c16df89932525e4065bbea558c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOTo0MDoyOFrOGhtHew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOTo0Mzo0N1rOGhtPpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk5NTM4Nw==", "bodyText": "compute() does not seem to be strictly necessary here - simple jmxSessions.put(threadId, createNewSession(id, threadId, scopeStackCollector) should be enough and would avoid creating a lambda capture.", "url": "https://github.com/DataDog/dd-trace-java/pull/1552#discussion_r437995387", "createdAt": "2020-06-10T09:40:28Z", "author": {"login": "jbachorik"}, "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/mlt/JMXSessionFactory.java", "diffHunk": "@@ -20,11 +20,9 @@ public JMXSessionFactory() {\n   public Session createSession(String id, Thread thread) {\n     ScopeManager scopeManager = threadScopeMapper.forThread(thread);\n     ScopeStackCollector scopeStackCollector = scopeManager.startScope(id);\n-\n     long threadId = thread.getId();\n-    JMXSession session = createNewSession(id, threadId, scopeStackCollector);\n-    jmxSessions.put(threadId, session);\n-    return session;\n+    return jmxSessions.compute(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dea4833816133c16df89932525e4065bbea558c"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk5NzQ3Nw==", "bodyText": "What about using Arrays.binarySearch() instead - and if the key is not present inserting it at the position indicated by binarySearch() result to maintain sorted array. Would be beneficial for >10 tracked threads.", "url": "https://github.com/DataDog/dd-trace-java/pull/1552#discussion_r437997477", "createdAt": "2020-06-10T09:43:47Z", "author": {"login": "jbachorik"}, "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/mlt/JMXSampler.java", "diffHunk": "@@ -48,6 +47,10 @@ public void addThreadId(long threadId) {\n     }\n     do {\n       prev = threadIds.get();\n+      // check if already exists\n+      for (int i = 0; i < prev.length; i++) {\n+        if (prev[i] == threadId) return;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dea4833816133c16df89932525e4065bbea558c"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f85307b2eb97c0ff6745f2ee272dd80db9b20118", "author": {"user": {"login": "jpbempel", "name": "Jean-Philippe Bempel"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f85307b2eb97c0ff6745f2ee272dd80db9b20118", "committedDate": "2020-06-10T10:32:36Z", "message": "add binarySearch & replace compute by put"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3f4a3e24b8631166284a90dc622b1fa255143f3", "author": {"user": {"login": "jpbempel", "name": "Jean-Philippe Bempel"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f3f4a3e24b8631166284a90dc622b1fa255143f3", "committedDate": "2020-06-10T10:50:41Z", "message": "revert to compute"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9a8ca4e6f106974839f7f9dd180e7eec8e93e52", "author": {"user": {"login": "jpbempel", "name": "Jean-Philippe Bempel"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e9a8ca4e6f106974839f7f9dd180e7eec8e93e52", "committedDate": "2020-06-10T13:35:46Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4228945a2e87d7492468ada880bc5a46c9ea70df", "author": {"user": {"login": "jpbempel", "name": "Jean-Philippe Bempel"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4228945a2e87d7492468ada880bc5a46c9ea70df", "committedDate": "2020-06-10T13:46:23Z", "message": "fix formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MTgyNDI3", "url": "https://github.com/DataDog/dd-trace-java/pull/1552#pullrequestreview-428182427", "createdAt": "2020-06-10T15:36:33Z", "commit": {"oid": "4228945a2e87d7492468ada880bc5a46c9ea70df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2373, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}