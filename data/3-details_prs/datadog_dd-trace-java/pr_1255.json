{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NzU5ODc4", "number": 1255, "title": "Add list of blacklisted spring classes", "bodyText": "This pull request adds a mechanism for an instrumentation to blacklist a set of packages that will be ignored by all instrumentations.  For minimal applications, where the number of library classes far outweigh user classes, this may result in some speedup.  For larger applications, the speedup is probably minimal.\nIn testing, this reduced the number of calls to SafeHasSuperType.match() from 322,214 to 226,286 and saved ~.3 seconds in gs-spring startup.  For full benefits, we'll have to add blacklists to all of the major instrumentations.\nThe danger is over-blacklisting: blacklisting a package that another instrumentation instruments under different circumstances.\nI'm only 75% \ud83d\udc4d on whether we should merge this functionality in.  Open to other opinions.", "createdAt": "2020-02-25T19:30:48Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1255", "merged": true, "mergeCommit": {"oid": "6ed5f56bb76588334991d2bf5ed00aa4152df5f6"}, "closed": true, "closedAt": "2020-02-27T19:07:43Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcH4jL0AFqTM2NDQ0MTU4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIKGM3AFqTM2NTA5MzM5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDQxNTg5", "url": "https://github.com/DataDog/dd-trace-java/pull/1255#pullrequestreview-364441589", "createdAt": "2020-02-25T20:56:40Z", "commit": {"oid": "f250b44a601293b01e993b4651736f8d07a83acf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDo1Njo0MFrOFuU5zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDo1Njo0MFrOFuU5zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEyMTI5NQ==", "bodyText": "Should there be just default implementation instead of these repeats?", "url": "https://github.com/DataDog/dd-trace-java/pull/1255#discussion_r384121295", "createdAt": "2020-02-25T20:56:40Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/instrumentation/dropwizard/src/test/groovy/JettyTestInstrumentation.java", "diffHunk": "@@ -24,4 +26,9 @@ public AgentBuilder instrument(final AgentBuilder agentBuilder) {\n             new AgentBuilder.Transformer.ForAdvice()\n                 .advice(named(\"handle\"), HttpServerTestAdvice.ServerEntryAdvice.class.getName()));\n   }\n+\n+  @Override\n+  public Collection<String> getLibraryBlacklistedPrefixes() {\n+    return Collections.emptySet();\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f250b44a601293b01e993b4651736f8d07a83acf"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDQ0NDI5", "url": "https://github.com/DataDog/dd-trace-java/pull/1255#pullrequestreview-364444429", "createdAt": "2020-02-25T21:01:14Z", "commit": {"oid": "f250b44a601293b01e993b4651736f8d07a83acf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMTowMToxNFrOFuVCDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMTowMToxNFrOFuVCDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEyMzQwNQ==", "bodyText": "Personally I would say that mutable matcher goes heavily against BBs design intentions and may lead to awkward and hard to debug errors.\nAlso: having list of ignores classes in instrumentation is counterintuitive: we probably want that list to apply even if instrumentation is disabled for some reason. Or, for that matter, if for some reason we could not load it.\nI think keeping list of ignores here is actually less confusing (since we keep some here anyway).", "url": "https://github.com/DataDog/dd-trace-java/pull/1255#discussion_r384123405", "createdAt": "2020-02-25T21:01:14Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/GlobalIgnoresMatcher.java", "diffHunk": "@@ -9,11 +12,13 @@\n public class GlobalIgnoresMatcher<T extends TypeDescription>\n     extends ElementMatcher.Junction.AbstractBase<T> {\n \n+  private final Set<String> blacklistedPrefixes = new HashSet<>();\n+\n   private static final Pattern COM_MCHANGE_PROXY =\n       Pattern.compile(\"com\\\\.mchange\\\\.v2\\\\.c3p0\\\\..*Proxy\");\n \n-  public static <T extends TypeDescription> ElementMatcher.Junction<T> globalIgnoresMatcher() {\n-    return new GlobalIgnoresMatcher<>();\n+  public void addBlacklistedPrefixes(final Collection<String> prefixes) {\n+    blacklistedPrefixes.addAll(prefixes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f250b44a601293b01e993b4651736f8d07a83acf"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa3f449ec444281bd8fcee222c8ea6cd3b3461e0", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fa3f449ec444281bd8fcee222c8ea6cd3b3461e0", "committedDate": "2020-02-25T21:33:39Z", "message": "Add list of blacklisted spring classes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f250b44a601293b01e993b4651736f8d07a83acf", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f250b44a601293b01e993b4651736f8d07a83acf", "committedDate": "2020-02-25T17:37:53Z", "message": "Add list of blacklisted spring classes"}, "afterCommit": {"oid": "fa3f449ec444281bd8fcee222c8ea6cd3b3461e0", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fa3f449ec444281bd8fcee222c8ea6cd3b3461e0", "committedDate": "2020-02-25T21:33:39Z", "message": "Add list of blacklisted spring classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84c7be64b512962fd43f701f3954f772b8a62f22", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/84c7be64b512962fd43f701f3954f772b8a62f22", "committedDate": "2020-02-26T16:59:21Z", "message": "Add blacklist directly to global ignores"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDkzMzk1", "url": "https://github.com/DataDog/dd-trace-java/pull/1255#pullrequestreview-365093395", "createdAt": "2020-02-26T17:23:18Z", "commit": {"oid": "84c7be64b512962fd43f701f3954f772b8a62f22"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2516, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}