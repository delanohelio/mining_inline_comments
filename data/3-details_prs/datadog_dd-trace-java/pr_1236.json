{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NzI2NDU4", "number": 1236, "title": "Determine agent URL version on first upload call", "bodyText": "This should remove http request from critical path during app load", "createdAt": "2020-02-20T12:24:44Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1236", "merged": true, "mergeCommit": {"oid": "e92d326052b9c07bfb5c0c1f660eba19793b4e2e"}, "closed": true, "closedAt": "2020-02-21T12:04:50Z", "author": {"login": "mar-kolya"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGKKfMAH2gAyMzc3NzI2NDU4OjgyMDlhODgzMGMwZDJmODJjNDUwMzZmNTA4MmM1NzY2MGFiZTIwNjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGUdcCgFqTM2MjMyNzU1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8209a8830c0d2f82c45036f5082c57660abe2061", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8209a8830c0d2f82c45036f5082c57660abe2061", "committedDate": "2020-02-20T12:20:08Z", "message": "Determine agent URL version on first upload call\n\nThis should remove http request from critical path during app load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0445676179755f16a4f60e8a4d134334a33d69e", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e0445676179755f16a4f60e8a4d134334a33d69e", "committedDate": "2020-02-20T13:06:13Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxODg1OTY5", "url": "https://github.com/DataDog/dd-trace-java/pull/1236#pullrequestreview-361885969", "createdAt": "2020-02-20T13:09:24Z", "commit": {"oid": "8209a8830c0d2f82c45036f5082c57660abe2061"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowOToyNFrOFsSp9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowOToyNFrOFsSp9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4NzMxNw==", "bodyText": "You would need to make tracesUrl volatile or better yet do the if (tracesUrl == null) check inside the synchronized detectEndpoint() method which would then be called unconditionally from here.\nOtherwise you are risking data races.", "url": "https://github.com/DataDog/dd-trace-java/pull/1236#discussion_r381987317", "createdAt": "2020-02-20T13:09:24Z", "author": {"login": "jbachorik"}, "path": "dd-trace-ot/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -128,6 +116,10 @@ Response sendTraces(final List<List<DDSpan>> traces) {\n \n   Response sendSerializedTraces(\n       final int representativeCount, final Integer sizeInBytes, final List<byte[]> traces) {\n+    if (tracesUrl == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8209a8830c0d2f82c45036f5082c57660abe2061"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0a11d4aff87a41abeae507e218aa3091db04306", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f0a11d4aff87a41abeae507e218aa3091db04306", "committedDate": "2020-02-20T13:18:54Z", "message": "Make sure traceUrl is null before detecting agent url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "102c0feb5d6c7ea9d74de19dd1c7c737e349f52b", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/102c0feb5d6c7ea9d74de19dd1c7c737e349f52b", "committedDate": "2020-02-20T13:33:55Z", "message": "Merge branch 'master' into mar-kolya/determine-agent-url-on-first-call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8bbce054920970b991bf2b2f4dd1f3e303f81fd", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c8bbce054920970b991bf2b2f4dd1f3e303f81fd", "committedDate": "2020-02-20T13:48:48Z", "message": "Fix more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cddd368fc0315d181179935b2c968df0f8d2118f", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cddd368fc0315d181179935b2c968df0f8d2118f", "committedDate": "2020-02-20T14:26:33Z", "message": "Fix integration test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTQ2ODc1", "url": "https://github.com/DataDog/dd-trace-java/pull/1236#pullrequestreview-361946875", "createdAt": "2020-02-20T14:31:33Z", "commit": {"oid": "cddd368fc0315d181179935b2c968df0f8d2118f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDozMTozM1rOFsVivg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDozMTozM1rOFsVivg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzNDYyMg==", "bodyText": "This is probably a separate change but we probably want to lazy load this too. I seem to remember someone mentioning that this starts an executor at construction time", "url": "https://github.com/DataDog/dd-trace-java/pull/1236#discussion_r382034622", "createdAt": "2020-02-20T14:31:33Z", "author": {"login": "devinsba"}, "path": "dd-trace-ot/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -60,30 +60,18 @@\n                   Types.newParameterizedType(Map.class, String.class, Double.class)));\n   private static final MediaType MSGPACK = MediaType.get(\"application/msgpack\");\n \n+  private final String host;\n+  private final int port;\n+  private final String unixDomainSocketPath;\n   private final OkHttpClient httpClient;\n-  private final HttpUrl tracesUrl;\n+  private HttpUrl tracesUrl;\n \n   public DDAgentApi(final String host, final int port, final String unixDomainSocketPath) {\n-    this(\n-        host,\n-        port,\n-        endpointAvailable(getUrl(host, port, TRACES_ENDPOINT_V4), unixDomainSocketPath, true),\n-        unixDomainSocketPath);\n-  }\n+    this.host = host;\n+    this.port = port;\n+    this.unixDomainSocketPath = unixDomainSocketPath;\n \n-  DDAgentApi(\n-      final String host,\n-      final int port,\n-      final boolean v4EndpointsAvailable,\n-      final String unixDomainSocketPath) {\n     httpClient = buildHttpClient(unixDomainSocketPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cddd368fc0315d181179935b2c968df0f8d2118f"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTU4MTI1", "url": "https://github.com/DataDog/dd-trace-java/pull/1236#pullrequestreview-361958125", "createdAt": "2020-02-20T14:44:40Z", "commit": {"oid": "8209a8830c0d2f82c45036f5082c57660abe2061"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDo0NDo0MFrOFsWEvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDo0NDo0MFrOFsWEvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0MzMyNg==", "bodyText": "Maybe not for this PR, but a better overall approach might be to eliminate the endpoint sniffing as separate step.\nWe could simply wait until the first send.  If the first send fails with a 404, then we fallback to v3.  Then we remember whichever one succeeded.\nThis would require a fair amount of changes to the tests.", "url": "https://github.com/DataDog/dd-trace-java/pull/1236#discussion_r382043326", "createdAt": "2020-02-20T14:44:40Z", "author": {"login": "dougqh"}, "path": "dd-trace-ot/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -298,6 +290,16 @@ private static HttpUrl getUrl(final String host, final int port, final String en\n     }\n   }\n \n+  private synchronized void detectEndpoint() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8209a8830c0d2f82c45036f5082c57660abe2061"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4071ca7685b43265bceb5ac97a4e27be57bc463", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a4071ca7685b43265bceb5ac97a4e27be57bc463", "committedDate": "2020-02-20T15:07:53Z", "message": "Fix some typos in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c14aecd5af43e3b5691668c8ca5a57a650cbe00", "author": {"user": {"login": "mar-kolya", "name": "Nikolay Martynov"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2c14aecd5af43e3b5691668c8ca5a57a650cbe00", "committedDate": "2020-02-20T15:11:25Z", "message": "Create http client laizily"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzI3NTUx", "url": "https://github.com/DataDog/dd-trace-java/pull/1236#pullrequestreview-362327551", "createdAt": "2020-02-21T00:19:53Z", "commit": {"oid": "2c14aecd5af43e3b5691668c8ca5a57a650cbe00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2734, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}