{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMTQzOTQy", "number": 1785, "title": "Don't instrument well behaved spring class loaders", "bodyText": "As part of #1293 we started instrumenting a couple of spring class loaders that all delegate class loading properly. This can have a big impact on application startup time in some cases.", "createdAt": "2020-08-19T12:51:44Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1785", "merged": true, "mergeCommit": {"oid": "47310f2ce705ee52f1aeeef2c92b7fc32e5d162d"}, "closed": true, "closedAt": "2020-08-24T09:09:08Z", "author": {"login": "bantonsson"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAdc1xgBqjM2NzE0NTY2MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdB-NTKABqjM2ODQyOTA4MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f2637c70562cb1fbd0774536281e04e295a6860", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1f2637c70562cb1fbd0774536281e04e295a6860", "committedDate": "2020-08-19T14:55:00Z", "message": "and don't instrument them either"}, "afterCommit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "committedDate": "2020-08-19T15:35:48Z", "message": "Don't instrument well behaved spring class loaders"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjEzMzIw", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#pullrequestreview-470613320", "createdAt": "2020-08-19T16:11:24Z", "commit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjEzNTMz", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#pullrequestreview-470613533", "createdAt": "2020-08-19T16:11:41Z", "commit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjoxMTo0MVrOHDOjvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjoxMTo0MVrOHDOjvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NjMwMw==", "bodyText": "Nice.", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473146303", "createdAt": "2020-08-19T16:11:41Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/classloading/src/main/java/datadog/trace/instrumentation/classloading/ClassloadingInstrumentation.java", "diffHunk": "@@ -45,7 +45,12 @@ public ClassloadingInstrumentation() {\n     return namedNoneOf(\n             \"java.lang.ClassLoader\",\n             \"com.ibm.oti.vm.BootstrapClassLoader\",\n-            \"datadog.trace.bootstrap.AgentClassLoader\")\n+            \"datadog.trace.bootstrap.AgentClassLoader\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjEzOTA3", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#pullrequestreview-470613907", "createdAt": "2020-08-19T16:12:08Z", "commit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjoxMjowOFrOHDOkyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjoxMjowOFrOHDOkyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NjU3MA==", "bodyText": "It's not new but this bugs me, I think we could implement a trie without much effort and probably do better here.", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473146570", "createdAt": "2020-08-19T16:12:08Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/AdditionalLibraryIgnoresMatcher.java", "diffHunk": "@@ -122,27 +122,20 @@ public boolean matches(final T target) {\n \n       if (name.startsWith(\"org.springframework.context.\")) {\n         // More runnables to deal with\n-        if (name.startsWith(\"org.springframework.context.support.AbstractApplicationContext$\")\n-            || name.equals(\"org.springframework.context.support.ContextTypeMatchClassLoader\")) {\n+        if (name.startsWith(\"org.springframework.context.support.AbstractApplicationContext$\")) {\n           return false;\n         }\n         return true;\n       }\n \n       if (name.startsWith(\"org.springframework.core.\")) {\n-        if (name.startsWith(\"org.springframework.core.task.\")\n-            || name.equals(\"org.springframework.core.DecoratingClassLoader\")\n-            || name.equals(\"org.springframework.core.OverridingClassLoader\")) {\n+        if (name.startsWith(\"org.springframework.core.task.\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjMyMDI5", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#pullrequestreview-470632029", "createdAt": "2020-08-19T16:22:24Z", "commit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjoyMjoyNFrOHDPD_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjoyMjoyNFrOHDPD_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA==", "bodyText": "datadog.trace.bootstrap.AgentClassLoader no longer exists. I wonder how long this has been like this for?", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473154558", "createdAt": "2020-08-19T16:22:24Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/classloading/src/main/java/datadog/trace/instrumentation/classloading/ClassloadingInstrumentation.java", "diffHunk": "@@ -45,7 +45,12 @@ public ClassloadingInstrumentation() {\n     return namedNoneOf(\n             \"java.lang.ClassLoader\",\n             \"com.ibm.oti.vm.BootstrapClassLoader\",\n-            \"datadog.trace.bootstrap.AgentClassLoader\")\n+            \"datadog.trace.bootstrap.AgentClassLoader\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "committedDate": "2020-08-19T15:35:48Z", "message": "Don't instrument well behaved spring class loaders"}, "afterCommit": {"oid": "fdb54828d60a5a4cc7dc3add17f29c343b857317", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fdb54828d60a5a4cc7dc3add17f29c343b857317", "committedDate": "2020-08-20T13:31:26Z", "message": "Don't instrument well behaved spring class loaders"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNjQ1MDQz", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#pullrequestreview-471645043", "createdAt": "2020-08-20T14:01:21Z", "commit": {"oid": "fdb54828d60a5a4cc7dc3add17f29c343b857317"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDowMToyMlrOHEDEZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDowMToyMlrOHEDEZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNjYzMQ==", "bodyText": "Isn't it generally more efficient to ignore the class before it's loaded by byte buddy?", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474006631", "createdAt": "2020-08-20T14:01:22Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/classloading/src/main/java/datadog/trace/instrumentation/classloading/ClassloadingInstrumentation.java", "diffHunk": "@@ -45,7 +45,11 @@ public ClassloadingInstrumentation() {\n     return namedNoneOf(\n             \"java.lang.ClassLoader\",\n             \"com.ibm.oti.vm.BootstrapClassLoader\",\n-            \"datadog.trace.bootstrap.AgentClassLoader\")\n+            \"org.springframework.context.support.ContextTypeMatchClassLoader\",\n+            \"org.springframework.core.OverridingClassLoader\",\n+            \"org.springframework.core.DecoratingClassLoader\",\n+            \"org.springframework.instrument.classloading.SimpleThrowawayClassLoader\",\n+            \"org.springframework.instrument.classloading.ShadowingClassLoader\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdb54828d60a5a4cc7dc3add17f29c343b857317"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNzc0MzMx", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#pullrequestreview-471774331", "createdAt": "2020-08-20T16:14:09Z", "commit": {"oid": "6c6b7b51a1356b8d7be2ef68ccf753d873e84865"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjoxNDowOVrOHEJC5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjoxNDowOVrOHEJC5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEwNDU1MA==", "bodyText": "Can we not do this just because we'll want to take the entire strings and build a trie from them at some point, and the painstaking deconstruction will make that migration harder.\n(I actually tried it before and didn't observe a positive effect)", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474104550", "createdAt": "2020-08-20T16:14:09Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/GlobalIgnoresMatcher.java", "diffHunk": "@@ -143,19 +147,39 @@ public boolean matches(final T target) {\n         break;\n       case 'o' - 'a':\n         if (name.startsWith(\"org.\")) {\n-          if (name.startsWith(\"org.aspectj.\") || name.startsWith(\"org.jinspired.\")) {\n+          int oOffset = \"org.\".length();\n+          if (name.startsWith(\"aspectj.\", oOffset) || name.startsWith(\"jinspired.\", oOffset)) {\n             return true;\n           }\n           // groovy\n-          if (name.startsWith(\"org.groovy.\") || name.startsWith(\"org.apache.groovy.\")) {\n+          if (name.startsWith(\"groovy.\", oOffset) || name.startsWith(\"apache.groovy.\", oOffset)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6b7b51a1356b8d7be2ef68ccf753d873e84865"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMjYzNTkx", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#pullrequestreview-472263591", "createdAt": "2020-08-21T07:25:29Z", "commit": {"oid": "6c6b7b51a1356b8d7be2ef68ccf753d873e84865"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84b006f131c7f5bb7e55d2f61aeead68a5e08c36", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/84b006f131c7f5bb7e55d2f61aeead68a5e08c36", "committedDate": "2020-08-24T08:19:33Z", "message": "Don't instrument well behaved spring class loaders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d46d7accccfce362efba67e6c361a2435bdd5725", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d46d7accccfce362efba67e6c361a2435bdd5725", "committedDate": "2020-08-24T08:19:33Z", "message": "Move spring classloader checks to GlobalIgnoresMatcher"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c6b7b51a1356b8d7be2ef68ccf753d873e84865", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6c6b7b51a1356b8d7be2ef68ccf753d873e84865", "committedDate": "2020-08-20T14:58:14Z", "message": "Move spring classloader checks to GlobalIgnoresMatcher"}, "afterCommit": {"oid": "d46d7accccfce362efba67e6c361a2435bdd5725", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d46d7accccfce362efba67e6c361a2435bdd5725", "committedDate": "2020-08-24T08:19:33Z", "message": "Move spring classloader checks to GlobalIgnoresMatcher"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2145, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}