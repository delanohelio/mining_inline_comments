{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MTM1MjUz", "number": 1244, "title": "ClassLoaderMatcher put to Guava Cache outside critical section", "bodyText": "move to Guava Cache with weak references\nsplit cache supplier(loader) and matcher\n\npetclinic 100 runs avg start time:\nbefore: 51ca429 avgTime : 18.49126000000000000000\nafter: 01b32d8 avgTime : 17.60960000000000000000", "createdAt": "2020-02-21T07:05:28Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1244", "merged": true, "mergeCommit": {"oid": "5317597e4d147613e14c9fc085350db131b356e5"}, "closed": true, "closedAt": "2020-02-28T00:04:56Z", "author": {"login": "lpriima"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGeGu4ABqjMwNjAxODMxMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIi8p7AFqTM2NjA0MTIyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01b32d814fdcf1de9df46a7185ed78daf981434d", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/01b32d814fdcf1de9df46a7185ed78daf981434d", "committedDate": "2020-02-21T07:03:25Z", "message": "ClassLoaderMatcher switch to Guava Cache"}, "afterCommit": {"oid": "e8a916eedadb6414298a8e438c8755619818a619", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e8a916eedadb6414298a8e438c8755619818a619", "committedDate": "2020-02-21T11:32:51Z", "message": "ClassLoaderMatcher switch to Guava Cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8a916eedadb6414298a8e438c8755619818a619", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e8a916eedadb6414298a8e438c8755619818a619", "committedDate": "2020-02-21T11:32:51Z", "message": "ClassLoaderMatcher switch to Guava Cache"}, "afterCommit": {"oid": "37bcb4e288b0c501d3df3b44048b2f50847236d3", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/37bcb4e288b0c501d3df3b44048b2f50847236d3", "committedDate": "2020-02-21T11:58:02Z", "message": "ClassLoaderMatcher switch to Guava Cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODEzNjgy", "url": "https://github.com/DataDog/dd-trace-java/pull/1244#pullrequestreview-362813682", "createdAt": "2020-02-21T18:02:31Z", "commit": {"oid": "37bcb4e288b0c501d3df3b44048b2f50847236d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODowMjozMlrOFs_sag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODowMjozMlrOFs_sag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcyNTIyNg==", "bodyText": "It might be better to allow some redundant work outside the critical section then do a put -- rather than using get with CacheLoader.  But we'd definitely have to measure.", "url": "https://github.com/DataDog/dd-trace-java/pull/1244#discussion_r382725226", "createdAt": "2020-02-21T18:02:32Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/ClassLoaderMatcher.java", "diffHunk": "@@ -104,10 +108,23 @@ private boolean loadsExpectedClass(final ClassLoader loader, final Class<?> expe\n   }\n \n   public static class ClassLoaderHasClassMatcher\n-      extends ElementMatcher.Junction.AbstractBase<ClassLoader>\n-      implements WeakMap.ValueSupplier<ClassLoader, Boolean> {\n-\n-    private final WeakMap<ClassLoader, Boolean> cache = newWeakMap();\n+      extends ElementMatcher.Junction.AbstractBase<ClassLoader> {\n+\n+    private final LoadingCache<ClassLoader, Boolean> cache =\n+        CacheBuilder.newBuilder()\n+            .weakKeys()\n+            .build(\n+                new CacheLoader<ClassLoader, Boolean>() {\n+                  @Override\n+                  public Boolean load(ClassLoader cl) {\n+                    for (final String name : names) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37bcb4e288b0c501d3df3b44048b2f50847236d3"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODE0MTc1", "url": "https://github.com/DataDog/dd-trace-java/pull/1244#pullrequestreview-362814175", "createdAt": "2020-02-21T18:03:26Z", "commit": {"oid": "37bcb4e288b0c501d3df3b44048b2f50847236d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODowMzoyNlrOFs_t6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODowMzoyNlrOFs_t6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcyNTYxMQ==", "bodyText": "I think this should probably be an error.", "url": "https://github.com/DataDog/dd-trace-java/pull/1244#discussion_r382725611", "createdAt": "2020-02-21T18:03:26Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/ClassLoaderMatcher.java", "diffHunk": "@@ -60,19 +69,13 @@ private boolean shouldSkipClass(final ClassLoader loader) {\n       return false;\n     }\n \n-    private boolean shouldSkipInstance(final ClassLoader loader) {\n-      return SKIP_CACHE.computeIfAbsent(loader, this);\n-    }\n-\n-    @Override\n-    public Boolean get(final ClassLoader loader) {\n-      final boolean skip = !delegatesToBootstrap(loader);\n-      if (skip) {\n-        log.debug(\n-            \"skipping classloader instance {} of type {}\", loader, loader.getClass().getName());\n+    private static boolean shouldSkipInstance(final ClassLoader loader) {\n+      try {\n+        return skipCache.get(loader);\n+      } catch (ExecutionException e) {\n+        log.warn(\"Exception while getting from cache\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37bcb4e288b0c501d3df3b44048b2f50847236d3"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODI3MDE5", "url": "https://github.com/DataDog/dd-trace-java/pull/1244#pullrequestreview-362827019", "createdAt": "2020-02-21T18:25:52Z", "commit": {"oid": "37bcb4e288b0c501d3df3b44048b2f50847236d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoyNTo1MlrOFtAVxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoyNTo1MlrOFtAVxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNTgxMw==", "bodyText": "We might also want to set the concurrency level.  I picked 8 for the type cache.\nAlthough, we should add a configuration option in a separate PR -- and maybe auto-select by availableProcessors.", "url": "https://github.com/DataDog/dd-trace-java/pull/1244#discussion_r382735813", "createdAt": "2020-02-21T18:25:52Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/ClassLoaderMatcher.java", "diffHunk": "@@ -104,10 +108,23 @@ private boolean loadsExpectedClass(final ClassLoader loader, final Class<?> expe\n   }\n \n   public static class ClassLoaderHasClassMatcher\n-      extends ElementMatcher.Junction.AbstractBase<ClassLoader>\n-      implements WeakMap.ValueSupplier<ClassLoader, Boolean> {\n-\n-    private final WeakMap<ClassLoader, Boolean> cache = newWeakMap();\n+      extends ElementMatcher.Junction.AbstractBase<ClassLoader> {\n+\n+    private final LoadingCache<ClassLoader, Boolean> cache =\n+        CacheBuilder.newBuilder()\n+            .weakKeys()\n+            .build(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37bcb4e288b0c501d3df3b44048b2f50847236d3"}, "originalPosition": 107}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce2d6cbc38b6903bbb6a4572ee97b1f22a549d8f", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ce2d6cbc38b6903bbb6a4572ee97b1f22a549d8f", "committedDate": "2020-02-23T08:38:06Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}, "afterCommit": {"oid": "97d93294431c719ae54e81d9ebb210a7649e0b3e", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/97d93294431c719ae54e81d9ebb210a7649e0b3e", "committedDate": "2020-02-23T08:52:55Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97d93294431c719ae54e81d9ebb210a7649e0b3e", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/97d93294431c719ae54e81d9ebb210a7649e0b3e", "committedDate": "2020-02-23T08:52:55Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}, "afterCommit": {"oid": "2232486a5431d3c027d2957ff2cdf5834b0cca3d", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2232486a5431d3c027d2957ff2cdf5834b0cca3d", "committedDate": "2020-02-25T05:04:14Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2232486a5431d3c027d2957ff2cdf5834b0cca3d", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2232486a5431d3c027d2957ff2cdf5834b0cca3d", "committedDate": "2020-02-25T05:04:14Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}, "afterCommit": {"oid": "b1a371d02161c67a010c3592ce45fd3ac34d6a9d", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b1a371d02161c67a010c3592ce45fd3ac34d6a9d", "committedDate": "2020-02-25T05:58:10Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1a371d02161c67a010c3592ce45fd3ac34d6a9d", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b1a371d02161c67a010c3592ce45fd3ac34d6a9d", "committedDate": "2020-02-25T05:58:10Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}, "afterCommit": {"oid": "57d3b373c318f376676c67ef3ff575f4feba43c4", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/57d3b373c318f376676c67ef3ff575f4feba43c4", "committedDate": "2020-02-25T19:48:08Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57d3b373c318f376676c67ef3ff575f4feba43c4", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/57d3b373c318f376676c67ef3ff575f4feba43c4", "committedDate": "2020-02-25T19:48:08Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}, "afterCommit": {"oid": "23f97c0544f5598ff63b4ce99955209daecfb78a", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/23f97c0544f5598ff63b4ce99955209daecfb78a", "committedDate": "2020-02-25T19:50:12Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23f97c0544f5598ff63b4ce99955209daecfb78a", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/23f97c0544f5598ff63b4ce99955209daecfb78a", "committedDate": "2020-02-25T19:50:12Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}, "afterCommit": {"oid": "fc0444650d75b546762696f053b269ec4756667c", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fc0444650d75b546762696f053b269ec4756667c", "committedDate": "2020-02-25T19:56:24Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc0444650d75b546762696f053b269ec4756667c", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fc0444650d75b546762696f053b269ec4756667c", "committedDate": "2020-02-25T19:56:24Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}, "afterCommit": {"oid": "464d71eb1e9ce266fb612ad041487222ecb935cc", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/464d71eb1e9ce266fb612ad041487222ecb935cc", "committedDate": "2020-02-25T21:54:36Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "885212ee3630e14c75f399f82f32f2e4a6e618c7", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/885212ee3630e14c75f399f82f32f2e4a6e618c7", "committedDate": "2020-02-27T21:12:23Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "464d71eb1e9ce266fb612ad041487222ecb935cc", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/464d71eb1e9ce266fb612ad041487222ecb935cc", "committedDate": "2020-02-25T21:54:36Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}, "afterCommit": {"oid": "885212ee3630e14c75f399f82f32f2e4a6e618c7", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/885212ee3630e14c75f399f82f32f2e4a6e618c7", "committedDate": "2020-02-27T21:12:23Z", "message": "ClassLoaderHasNoResourceMatcher: put to cache outside critical section"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDQxMjI5", "url": "https://github.com/DataDog/dd-trace-java/pull/1244#pullrequestreview-366041229", "createdAt": "2020-02-27T22:20:30Z", "commit": {"oid": "885212ee3630e14c75f399f82f32f2e4a6e618c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2743, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}