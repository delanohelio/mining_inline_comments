{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMDI3NzA0", "number": 1573, "title": "Enable propagation of trace start time and recording of e2e durations on message spans", "bodyText": "", "createdAt": "2020-06-11T11:57:34Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1573", "merged": true, "mergeCommit": {"oid": "4b378fc1b7bfdc31076e9dd562021638a78955a9"}, "closed": true, "closedAt": "2020-06-11T17:29:01Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqKkhxgH2gAyNDMzMDI3NzA0OmM0OWFiN2Y5ZGY1MDZjM2FiMmNjZDU0ZDA5YWY3OTI2ZjMyNzBlMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqRn9YAFqTQyOTEyNTYxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c49ab7f9df506c3ab2ccd54d09af7926f3270e30", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c49ab7f9df506c3ab2ccd54d09af7926f3270e30", "committedDate": "2020-06-11T09:09:51Z", "message": "add span start time to baggage if it doesn't already exist, plus enabling config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42dc073b9f7a1aecdf50457a6958951fa4f97575", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/42dc073b9f7a1aecdf50457a6958951fa4f97575", "committedDate": "2020-06-11T09:22:17Z", "message": "only need one class for KafkaDecorator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODQ3Mjk3", "url": "https://github.com/DataDog/dd-trace-java/pull/1573#pullrequestreview-428847297", "createdAt": "2020-06-11T12:11:10Z", "commit": {"oid": "5bf68fe35ff97e0294a8f9d236e9444278876bc6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8dd779f3bfed5e9821706b6732a8cb830f47c12", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a8dd779f3bfed5e9821706b6732a8cb830f47c12", "committedDate": "2020-06-11T12:11:33Z", "message": "add e2e duration to kafka consumer spans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "651017cbe6446d8f9b896561112076e77a152cd4", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/651017cbe6446d8f9b896561112076e77a152cd4", "committedDate": "2020-06-11T12:11:33Z", "message": "remove unnecessary rabbitmq decorator classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8162821606018c9db07a1edb672dec24d58bd68", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b8162821606018c9db07a1edb672dec24d58bd68", "committedDate": "2020-06-11T12:11:33Z", "message": "record duration since trace start in rabbit consumer spans"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bf68fe35ff97e0294a8f9d236e9444278876bc6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5bf68fe35ff97e0294a8f9d236e9444278876bc6", "committedDate": "2020-06-11T11:56:33Z", "message": "record duration since trace start in rabbit consumer spans"}, "afterCommit": {"oid": "b8162821606018c9db07a1edb672dec24d58bd68", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b8162821606018c9db07a1edb672dec24d58bd68", "committedDate": "2020-06-11T12:11:33Z", "message": "record duration since trace start in rabbit consumer spans"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTkyNjI5", "url": "https://github.com/DataDog/dd-trace-java/pull/1573#pullrequestreview-428992629", "createdAt": "2020-06-11T14:53:44Z", "commit": {"oid": "b8162821606018c9db07a1edb672dec24d58bd68"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDI0NDc3", "url": "https://github.com/DataDog/dd-trace-java/pull/1573#pullrequestreview-429024477", "createdAt": "2020-06-11T15:24:38Z", "commit": {"oid": "b8162821606018c9db07a1edb672dec24d58bd68"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDM3MjA2", "url": "https://github.com/DataDog/dd-trace-java/pull/1573#pullrequestreview-429037206", "createdAt": "2020-06-11T15:37:03Z", "commit": {"oid": "b8162821606018c9db07a1edb672dec24d58bd68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozNzowM1rOGijEXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozNzowM1rOGijEXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg3OTMyNQ==", "bodyText": "Do we want this to be span_end - trace_start?", "url": "https://github.com/DataDog/dd-trace-java/pull/1573#discussion_r438879325", "createdAt": "2020-06-11T15:37:03Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/kafka-clients-0.11/src/main/java/datadog/trace/instrumentation/kafka_clients/KafkaDecorator.java", "diffHunk": "@@ -69,11 +65,21 @@ public void onConsume(final AgentSpan span, final ConsumerRecord record) {\n       span.setTag(PARTITION, record.partition());\n       span.setTag(OFFSET, record.offset());\n       span.setTag(InstrumentationTags.DD_MEASURED, true);\n-      // don't record a duration if the message was sent from an old Kafka client\n+      long spanStartTime = TimeUnit.NANOSECONDS.toMillis(span.getStartTime());\n+      if (endToEndDurationsEnabled) {\n+        String traceStartTime = span.getBaggageItem(DDTags.TRACE_START_TIME);\n+        if (null != traceStartTime) {\n+          // not being defensive here because we own the lifecycle of this value\n+          span.setTag(\n+              RECORD_END_TO_END_DURATION_MS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8162821606018c9db07a1edb672dec24d58bd68"}, "originalPosition": 79}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6942a2648e9b7c564eea5ff52adcd67e64955afd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6942a2648e9b7c564eea5ff52adcd67e64955afd", "committedDate": "2020-06-11T16:19:59Z", "message": "use span end time for e2e transaction duration"}, "afterCommit": {"oid": "30d1dee2035fb9f8d45a2f41a68ba9fbc9daa641", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/30d1dee2035fb9f8d45a2f41a68ba9fbc9daa641", "committedDate": "2020-06-11T16:21:15Z", "message": "use span end time for e2e transaction duration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30d1dee2035fb9f8d45a2f41a68ba9fbc9daa641", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/30d1dee2035fb9f8d45a2f41a68ba9fbc9daa641", "committedDate": "2020-06-11T16:21:15Z", "message": "use span end time for e2e transaction duration"}, "afterCommit": {"oid": "d545ff9420dad68d43728a4cdfb7694a250f012a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d545ff9420dad68d43728a4cdfb7694a250f012a", "committedDate": "2020-06-11T16:40:43Z", "message": "use span end time for e2e transaction duration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b62b4244fffcdece4b0f9506591729dc19a4bb78", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b62b4244fffcdece4b0f9506591729dc19a4bb78", "committedDate": "2020-06-11T16:50:12Z", "message": "use span end time for e2e transaction duration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d545ff9420dad68d43728a4cdfb7694a250f012a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d545ff9420dad68d43728a4cdfb7694a250f012a", "committedDate": "2020-06-11T16:40:43Z", "message": "use span end time for e2e transaction duration"}, "afterCommit": {"oid": "b62b4244fffcdece4b0f9506591729dc19a4bb78", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b62b4244fffcdece4b0f9506591729dc19a4bb78", "committedDate": "2020-06-11T16:50:12Z", "message": "use span end time for e2e transaction duration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTI1NjEw", "url": "https://github.com/DataDog/dd-trace-java/pull/1573#pullrequestreview-429125610", "createdAt": "2020-06-11T17:22:57Z", "commit": {"oid": "b62b4244fffcdece4b0f9506591729dc19a4bb78"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2398, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}