{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NjM5ODIx", "number": 1765, "title": "mapadapter tweaks", "bodyText": "The main effort here is to prevent the WeakMaps created by the hundreds of HelperInjector instances we create from creating a background chore, each of which executes for the entire application's life, since there's only one executor (second commit). This way we push the cost of expunging entries to when these maps are in use, i.e. early on.\nThe tweaks to MapAdapter are of secondary importance.", "createdAt": "2020-08-12T09:22:10Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1765", "merged": true, "mergeCommit": {"oid": "322c39596b7a5b5373915a067c5f83d9e8490440"}, "closed": true, "closedAt": "2020-08-12T14:44:04Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-H_bQABqjM2NDY4MTk1Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-MCeWgFqTQ2NTk1NDgxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edd6fec467e1a317c16901d0d5d61c251893f1ca", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/edd6fec467e1a317c16901d0d5d61c251893f1ca", "committedDate": "2020-08-12T09:17:09Z", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground"}, "afterCommit": {"oid": "231e17ba33b8085d5da0c9d5394d438822710b77", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/231e17ba33b8085d5da0c9d5394d438822710b77", "committedDate": "2020-08-12T09:27:48Z", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "231e17ba33b8085d5da0c9d5394d438822710b77", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/231e17ba33b8085d5da0c9d5394d438822710b77", "committedDate": "2020-08-12T09:27:48Z", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground"}, "afterCommit": {"oid": "7f7cc0912ebd778f83df2a170c2013607cf8f752", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7f7cc0912ebd778f83df2a170c2013607cf8f752", "committedDate": "2020-08-12T09:36:24Z", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f7cc0912ebd778f83df2a170c2013607cf8f752", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7f7cc0912ebd778f83df2a170c2013607cf8f752", "committedDate": "2020-08-12T09:36:24Z", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground"}, "afterCommit": {"oid": "32f29a4c2214934be76975b41a2d702c53fb6ec4", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/32f29a4c2214934be76975b41a2d702c53fb6ec4", "committedDate": "2020-08-12T09:50:48Z", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Nzk2NTc3", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#pullrequestreview-465796577", "createdAt": "2020-08-12T10:44:11Z", "commit": {"oid": "32f29a4c2214934be76975b41a2d702c53fb6ec4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMDo0NDoxMlrOG_b1Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMTowMjo1MVrOG_cYDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE2OTQ0Mg==", "bodyText": "Spreading the synchronized. Nice.\nMaybe a comment about the & only working as expected since locks.length is a power of 2.\nOh, and looking at the WeakConcurrentMap it uses System.identityHashCode(key) and not key.hashCode(). I don't think that should cause any issues, since equality is also reference equality.", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469169442", "createdAt": "2020-08-12T10:44:12Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/WeakMapSuppliers.java", "diffHunk": "@@ -92,36 +100,28 @@ public void putIfAbsent(final K key, final V value) {\n \n       @Override\n       public V computeIfAbsent(final K key, final ValueSupplier<? super K, ? extends V> supplier) {\n-        if (map.containsKey(key)) {\n-          return map.get(key);\n-        }\n-\n-        synchronized (this) {\n-          if (map.containsKey(key)) {\n-            return map.get(key);\n-          } else {\n-            final V value = supplier.get(key);\n-\n-            map.put(key, value);\n-            return value;\n+        // We can't use computeIfAbsent since it was added in 1.8.\n+        V value = map.get(key);\n+        if (null == value) {\n+          int bucket = key.hashCode() & (locks.length - 1);\n+          synchronized (locks[bucket]) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32f29a4c2214934be76975b41a2d702c53fb6ec4"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE3ODM4MQ==", "bodyText": "I'm not sure that I follow this comment. This is a WeakMap from ClassLoader to ConcurrentHashMap. What is synchronized in this?", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#discussion_r469178381", "createdAt": "2020-08-12T11:02:51Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/netty-4.0/src/main/java/datadog/trace/instrumentation/netty40/AttributeKeys.java", "diffHunk": "@@ -10,8 +10,9 @@\n import java.util.concurrent.ConcurrentMap;\n \n public class AttributeKeys {\n+  // TODO why are we using what is essentially a synchronized hashmap here?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32f29a4c2214934be76975b41a2d702c53fb6ec4"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "394b25657e3b9af7ab60392f312677b78ab0a882", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/394b25657e3b9af7ab60392f312677b78ab0a882", "committedDate": "2020-08-12T12:29:12Z", "message": "coarser synchronisation"}, "afterCommit": {"oid": "f07ef1e23afec1cebe7cdd330ad2ab1d56342bf8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f07ef1e23afec1cebe7cdd330ad2ab1d56342bf8", "committedDate": "2020-08-12T12:40:49Z", "message": "select whether to expunge weakmaps in foreground or background on a use case by use case basis, expunge helperinjector weakmap in the foreground"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a918019e87476b350a95a19ced8e593716d09c10", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a918019e87476b350a95a19ced8e593716d09c10", "committedDate": "2020-08-12T14:03:23Z", "message": "finer grained synchronisation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39baa0317070a2b5140fd91de61cc1678bb96bf0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/39baa0317070a2b5140fd91de61cc1678bb96bf0", "committedDate": "2020-08-12T13:45:42Z", "message": "test hypothesis"}, "afterCommit": {"oid": "a918019e87476b350a95a19ced8e593716d09c10", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a918019e87476b350a95a19ced8e593716d09c10", "committedDate": "2020-08-12T14:03:23Z", "message": "finer grained synchronisation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1OTU0ODE2", "url": "https://github.com/DataDog/dd-trace-java/pull/1765#pullrequestreview-465954816", "createdAt": "2020-08-12T14:10:57Z", "commit": {"oid": "a918019e87476b350a95a19ced8e593716d09c10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2118, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}