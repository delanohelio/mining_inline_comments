{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5ODMzMTMy", "number": 1688, "title": "Add DD tags to log instrumentations", "bodyText": "revert of this revert : https://github.com/DataDog/dd-trace-java/pull/1662revert of this revert : #1662\nfix for #1654 and test for it:\n\nThe issue #1654 was introduced after instrumentation of log4j2. Original instrumentation assumed that interface ThreadContextMap always contains threadlocal field with instance of Map in generic parameter.\nThreadLocal<Map<?, ?>> localMap\n\nIn fact, log4j2 has 2 other implementations ( CopyOnWriteSortedArrayThreadContextMap , GarbageFreeSortedArrayThreadContextMap  ) which contains  StringMap in generic parameter:\nThreadLocal<org.apache.logging.log4j.util.StringMap> localMap\n\nAnd this org.apache.logging.log4j.util.StringMap is not instance of java.util.Map. And It was causing ClassCastException in #1654 .\nAs a solution in this changeset class ThreadLocalWithDDTagsInitValue extends ThreadLocal has also generic parameter, which will contain \"Map-like\" type of instrumented implementation. \"Map-like\" property means method  ThreadLocalWithDDTagsInitValue#putToMap looks for the way how to \"put\" datadog key/values in the instance of this type by following  duck typing scenario:\n\nif this type is instance of Map, then use Map#put(String,String) method. If Not\nif this type has put(String, ?) method then use it. If not\nif this type has putValue(String, ?) method then use it. If not\nskip insertion of DD tags with WARN log message\n\nRegression test Log4jThreadContextWithEnableThreadLocalsTest for this issue, modifies static final field to ensure log4j2 uses org.apache.logging.log4j.util.StringMap.", "createdAt": "2020-07-16T01:28:36Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1688", "merged": true, "mergeCommit": {"oid": "1086145d0106f3d0b0879adb8ceed155b056ec03"}, "closed": true, "closedAt": "2020-07-22T03:56:57Z", "author": {"login": "lpriima"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1VhWTABqjM1NTEwMzkwNjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3L0XOAFqTQ1Mjc4NDE1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b39de765e27f30b80efe38529d8caf686b40b99", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7b39de765e27f30b80efe38529d8caf686b40b99", "committedDate": "2020-07-16T01:26:53Z", "message": "Add DD tags to log instrumentations"}, "afterCommit": {"oid": "0b305ca28626208efb96915201e872d30948ca66", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0b305ca28626208efb96915201e872d30948ca66", "committedDate": "2020-07-16T02:08:20Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b305ca28626208efb96915201e872d30948ca66", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0b305ca28626208efb96915201e872d30948ca66", "committedDate": "2020-07-16T02:08:20Z", "message": "Add DD tags to log instrumentations"}, "afterCommit": {"oid": "efa9a386cadc7bb46da1e57791bdfd4ec24bece9", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/efa9a386cadc7bb46da1e57791bdfd4ec24bece9", "committedDate": "2020-07-16T02:51:51Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efa9a386cadc7bb46da1e57791bdfd4ec24bece9", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/efa9a386cadc7bb46da1e57791bdfd4ec24bece9", "committedDate": "2020-07-16T02:51:51Z", "message": "Add DD tags to log instrumentations"}, "afterCommit": {"oid": "2a255ea585499a652c86e5cc8ed8996148c27573", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2a255ea585499a652c86e5cc8ed8996148c27573", "committedDate": "2020-07-16T03:53:06Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a255ea585499a652c86e5cc8ed8996148c27573", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2a255ea585499a652c86e5cc8ed8996148c27573", "committedDate": "2020-07-16T03:53:06Z", "message": "Add DD tags to log instrumentations"}, "afterCommit": {"oid": "057d2916c0b20f2a6e248e104bc485e3361c5e71", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/057d2916c0b20f2a6e248e104bc485e3361c5e71", "committedDate": "2020-07-16T05:07:07Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "057d2916c0b20f2a6e248e104bc485e3361c5e71", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/057d2916c0b20f2a6e248e104bc485e3361c5e71", "committedDate": "2020-07-16T05:07:07Z", "message": "Add DD tags to log instrumentations"}, "afterCommit": {"oid": "2a2d21ae374866aa10058cc6061372a2ecbd918f", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2a2d21ae374866aa10058cc6061372a2ecbd918f", "committedDate": "2020-07-16T05:17:08Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a2d21ae374866aa10058cc6061372a2ecbd918f", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2a2d21ae374866aa10058cc6061372a2ecbd918f", "committedDate": "2020-07-16T05:17:08Z", "message": "Add DD tags to log instrumentations"}, "afterCommit": {"oid": "7ff119b6cd87ae37e01072a9b3951fd126ecb158", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7ff119b6cd87ae37e01072a9b3951fd126ecb158", "committedDate": "2020-07-16T05:45:29Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ff119b6cd87ae37e01072a9b3951fd126ecb158", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7ff119b6cd87ae37e01072a9b3951fd126ecb158", "committedDate": "2020-07-16T05:45:29Z", "message": "Add DD tags to log instrumentations"}, "afterCommit": {"oid": "f99c506149a301c7946457ceb9660bb44e256920", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f99c506149a301c7946457ceb9660bb44e256920", "committedDate": "2020-07-17T00:00:45Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzM5ODA3", "url": "https://github.com/DataDog/dd-trace-java/pull/1688#pullrequestreview-450339807", "createdAt": "2020-07-17T02:48:24Z", "commit": {"oid": "f99c506149a301c7946457ceb9660bb44e256920"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMjo0ODoyNFrOGzDiUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMjo0ODoyNFrOGzDiUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4ODQ5Nw==", "bodyText": "This is just more debug logging not really related to this change", "url": "https://github.com/DataDog/dd-trace-java/pull/1688#discussion_r456188497", "createdAt": "2020-07-17T02:48:24Z", "author": {"login": "lpriima"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -204,6 +204,9 @@ private static void deleteTempDir(final File file) {\n     final boolean deleted = file.delete();\n     if (!deleted) {\n       file.deleteOnExit();\n+      log.debug(\"file '{}' added to shutdown delete hook\", file);\n+    } else {\n+      log.debug(\"file '{}' deleted\", file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f99c506149a301c7946457ceb9660bb44e256920"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aa02256a8d9f60ce58f467ef2730a072eed27b1", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7aa02256a8d9f60ce58f467ef2730a072eed27b1", "committedDate": "2020-07-17T04:27:31Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f99c506149a301c7946457ceb9660bb44e256920", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f99c506149a301c7946457ceb9660bb44e256920", "committedDate": "2020-07-17T00:00:45Z", "message": "Add DD tags to log instrumentations"}, "afterCommit": {"oid": "7aa02256a8d9f60ce58f467ef2730a072eed27b1", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7aa02256a8d9f60ce58f467ef2730a072eed27b1", "committedDate": "2020-07-17T04:27:31Z", "message": "Add DD tags to log instrumentations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNzc4MDM0", "url": "https://github.com/DataDog/dd-trace-java/pull/1688#pullrequestreview-451778034", "createdAt": "2020-07-20T16:40:20Z", "commit": {"oid": "7aa02256a8d9f60ce58f467ef2730a072eed27b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNjo0MDoyMFrOG0Wctg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNjo0MDoyMFrOG0Wctg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NjkzNA==", "bodyText": "I don't understand the point of this test.  Why would you want to assert the full name of these classes?", "url": "https://github.com/DataDog/dd-trace-java/pull/1688#discussion_r457546934", "createdAt": "2020-07-20T16:40:20Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-tooling/src/test/groovy/datadog/trace/agent/test/ClassLoaderMatcherTest.groovy", "diffHunk": "@@ -38,6 +40,12 @@ class ClassLoaderMatcherTest extends DDSpecification {\n     DatadogClassLoader.name == \"datadog.trace.bootstrap.DatadogClassLoader\"\n   }\n \n+  def \"helper class names are hardcoded in Log Instrumentations\"() {\n+    expect:\n+    LogContextScopeListener.name == \"datadog.trace.agent.tooling.log.LogContextScopeListener\"\n+    ThreadLocalWithDDTagsInitValue.name == \"datadog.trace.agent.tooling.log.ThreadLocalWithDDTagsInitValue\"\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aa02256a8d9f60ce58f467ef2730a072eed27b1"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzg0MTU1", "url": "https://github.com/DataDog/dd-trace-java/pull/1688#pullrequestreview-452784155", "createdAt": "2020-07-21T19:58:04Z", "commit": {"oid": "7aa02256a8d9f60ce58f467ef2730a072eed27b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2267, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}