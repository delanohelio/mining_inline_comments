{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MDg1NzU2", "number": 1755, "title": "Add Invocation Caller API to internal-api", "bodyText": "Adding a unified API to get the invocation caller which will dispatch to the appropriate runtime implementation.\nFor Java 7 and 8 we need to use a security manager based hack while for Java 9+ we can use StackWalker API to achieve the same effect (and provide even more information).", "createdAt": "2020-08-06T15:04:01Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1755", "merged": true, "mergeCommit": {"oid": "c46b5f1b153f3e2cefd572542334149889cd6cff"}, "closed": true, "closedAt": "2020-08-17T09:40:17Z", "author": {"login": "jbachorik"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8RJQVAH2gAyNDY0MDg1NzU2OmM2YmFiMmQ5YjhkNWJjMWI1YzMzMWI2YjgzMTc2ODgxZDhkMzRmNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8mNmRgFqTQ2MzQwNzgyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c6bab2d9b8d5bc1b5c331b6b83176881d8d34f5f", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c6bab2d9b8d5bc1b5c331b6b83176881d8d34f5f", "committedDate": "2020-08-06T15:00:02Z", "message": "Add Invocation Caller API to internal-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3187d1449c64630d600ceb5cffe0ebc047f2cf31", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3187d1449c64630d600ceb5cffe0ebc047f2cf31", "committedDate": "2020-08-06T15:46:44Z", "message": "Allow impl-classes of different bytecode level in bootstrap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efa9d48e8a490f72534260a33374080cb6868b06", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/efa9d48e8a490f72534260a33374080cb6868b06", "committedDate": "2020-08-06T16:00:56Z", "message": "Allow impl-classes of different bytecode level in bootstrap"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjc2Nzkz", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#pullrequestreview-462676793", "createdAt": "2020-08-06T16:23:56Z", "commit": {"oid": "efa9d48e8a490f72534260a33374080cb6868b06"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNjoyMzo1NlrOG866kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNjoyODowMFrOG87D3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzMzAwOQ==", "bodyText": "It seems that's incorrect, it will return null, no?", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#discussion_r466533009", "createdAt": "2020-08-06T16:23:56Z", "author": {"login": "jpbempel"}, "path": "internal-api/src/main/java/datadog/trace/mlt/Invocation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package datadog.trace.mlt;\n+\n+import java.lang.reflect.Constructor;\n+import java.util.List;\n+import java.util.Objects;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public final class Invocation {\n+  static final int INVOCATION_OFFSET = 3;\n+\n+  /**\n+   * A simple data class representing an invocation caller. Provides the caller class and method\n+   * name.\n+   */\n+  public static final class Caller {\n+    public final String className;\n+    public final String methodName;\n+\n+    Caller(String className, String methodName) {\n+      this.className = className;\n+      this.methodName = methodName;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+      if (this == o) {\n+        return true;\n+      }\n+      if (o == null || getClass() != o.getClass()) {\n+        return false;\n+      }\n+      Caller caller = (Caller) o;\n+      return className.equals(caller.className) && Objects.equals(methodName, caller.methodName);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(className, methodName);\n+    }\n+  }\n+\n+  /**\n+   * Invocation caller detection can use StackWalker API which available in Java 9+ only. Therefore\n+   * abstracting the common interface which can be implemented by the default (pre Java 9)\n+   * implementation and the post Java 9 one as well.\n+   */\n+  public interface Impl {\n+    @NonNull\n+    Caller getCaller(int offset);\n+\n+    @NonNull\n+    List<Caller> getCallers();\n+  }\n+\n+  private static final Invocation.Impl impl;\n+\n+  static {\n+    Invocation.Impl rtImpl = new InvocationImplDefault();\n+    try {\n+      Runtime.class.getMethod(\"version\");\n+      Constructor<?> constructor =\n+          Class.forName(Invocation.class.getPackage().getName() + \".InvocationImpl9\")\n+              .getDeclaredConstructor();\n+      constructor.setAccessible(true);\n+      rtImpl = (Invocation.Impl) constructor.newInstance();\n+    } catch (NoSuchMethodException ignored) {\n+      // running on pre-9 Java; silently ignore and use the default impl\n+    } catch (Throwable t) {\n+      log.info(\n+          \"Unable to instantiate StackWalker API based invocation caller impl. Using the default one.\",\n+          t);\n+    }\n+\n+    impl = rtImpl;\n+  }\n+\n+  /**\n+   * Get the method {@linkplain Caller} adjusted by offset. An offset of 0 will return the immediate\n+   * caller.\n+   *\n+   * @param offset the offset to adjust the caller stackframe by\n+   * @return the {@linkplain Caller} located {@literal offset} stackframes above the called method;\n+   *     if the offset is bigger than the current stack depth the callstack root will be returned\n+   *     instead", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efa9d48e8a490f72534260a33374080cb6868b06"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzNTM5MA==", "bodyText": "nit: why not directly creating an ArrayList with the right capacity (based on callerLength) and add Callers inside the list and returning it directly?", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#discussion_r466535390", "createdAt": "2020-08-06T16:28:00Z", "author": {"login": "jpbempel"}, "path": "internal-api/src/main/java/datadog/trace/mlt/InvocationImplDefault.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package datadog.trace.mlt;\n+\n+import static datadog.trace.mlt.Invocation.INVOCATION_OFFSET;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * Default implementation of the invocation caller detection. Works for all Java versions from 7\n+ * till the latest current one. The downside is a slight performance hit and the inability to report\n+ * the caller method name.\n+ */\n+@Slf4j\n+final class InvocationImplDefault implements Invocation.Impl {\n+  private static final class WhoCalledSM extends SecurityManager {\n+    @Override\n+    public Class<?>[] getClassContext() {\n+      return super.getClassContext();\n+    }\n+  }\n+\n+  private static final WhoCalledSM ACCESSOR = new WhoCalledSM();\n+\n+  @Override\n+  @NonNull\n+  public Invocation.Caller getCaller(int offset) {\n+    if (offset < 0) {\n+      throw new IllegalArgumentException();\n+    }\n+\n+    offset += INVOCATION_OFFSET;\n+\n+    Class<?>[] list = ACCESSOR.getClassContext();\n+\n+    if (list.length <= offset) {\n+      return null;\n+    }\n+\n+    return new Invocation.Caller(list[offset].getName(), null);\n+  }\n+\n+  @Override\n+  @NonNull\n+  public List<Invocation.Caller> getCallers() {\n+    Class<?>[] list = ACCESSOR.getClassContext();\n+    int callerLength = Math.max(list.length - INVOCATION_OFFSET, 0);\n+    Invocation.Caller[] callers = new Invocation.Caller[callerLength];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efa9d48e8a490f72534260a33374080cb6868b06"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e3bfaeb699ebb526221a3e7c0f9db1d3e99f948", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9e3bfaeb699ebb526221a3e7c0f9db1d3e99f948", "committedDate": "2020-08-07T08:50:43Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTUyNzY4", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#pullrequestreview-463152768", "createdAt": "2020-08-07T09:02:54Z", "commit": {"oid": "9e3bfaeb699ebb526221a3e7c0f9db1d3e99f948"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c33dc7dca3b30c53c8c4429a22079693c56e055", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1c33dc7dca3b30c53c8c4429a22079693c56e055", "committedDate": "2020-08-07T09:05:38Z", "message": "Formatting!"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b30fd8fd4030dc6a2fb7da0e057598cb4638fe24", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b30fd8fd4030dc6a2fb7da0e057598cb4638fe24", "committedDate": "2020-08-07T10:35:34Z", "message": "No need for junit platform.\nIt just makes Java 7 tests fail."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "725b479429e607aa6cf7b24ffdfa9440c1e57e3e", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/725b479429e607aa6cf7b24ffdfa9440c1e57e3e", "committedDate": "2020-08-07T10:56:48Z", "message": "Add jacoco exclude"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f26574c58b70ef78a7239798268e67d22ebc9612", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f26574c58b70ef78a7239798268e67d22ebc9612", "committedDate": "2020-08-07T12:16:42Z", "message": "Add jacoco exclude"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDA3ODI1", "url": "https://github.com/DataDog/dd-trace-java/pull/1755#pullrequestreview-463407825", "createdAt": "2020-08-07T15:32:47Z", "commit": {"oid": "f26574c58b70ef78a7239798268e67d22ebc9612"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2098, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}