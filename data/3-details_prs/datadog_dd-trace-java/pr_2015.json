{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MDA4OTAz", "number": 2015, "title": "Capture scope if necessary before Scala 2.13 Transformation enters an ExecutionContext", "bodyText": "", "createdAt": "2020-10-20T18:28:09Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2015", "merged": true, "mergeCommit": {"oid": "acd520f26cfeb82ffdd66ca75c7db11058d0c2b2"}, "closed": true, "closedAt": "2020-10-21T15:31:30Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUdGSTABqjM5MDAxOTk4MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUtHasgFqTUxMzY1NzUwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d6b6f635b2a4dc12280372e2fd6fac7324c0515", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3d6b6f635b2a4dc12280372e2fd6fac7324c0515", "committedDate": "2020-10-20T18:27:24Z", "message": "transfer state when scala 2.13 transformation is mapped"}, "afterCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/58c002b884d3780a0856bf0030e0c685acc25e7a", "committedDate": "2020-10-20T18:29:42Z", "message": "transfer state when scala 2.13 transformation is mapped"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDM4Mzc4", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#pullrequestreview-513038378", "createdAt": "2020-10-20T18:52:31Z", "commit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo1MjozMVrOHlMhLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo1MjozMVrOHlMhLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2NDQ2Mg==", "bodyText": "It seems like callbacks could be either Transformation or ManyCallbacks.  Would this still work if multiple callbacks were added to a single promise?", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#discussion_r508764462", "createdAt": "2020-10-20T18:52:31Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -77,6 +80,28 @@ private static void muzzleCheck(final Transformation callback) {\n     }\n   }\n \n+  public static final class Transfer {\n+    @SuppressWarnings(\"rawtypes\")\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static <F, T> void transfer(\n+        @Advice.This Transformation<F, T> task,\n+        @Advice.Argument(0) Object doNotUse,\n+        @Advice.Argument(1) Object callbacks) {\n+      if (callbacks instanceof Transformation && task != callbacks) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzQ3MzUw", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#pullrequestreview-513347350", "createdAt": "2020-10-21T06:37:27Z", "commit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjozNzoyN1rOHlcTRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjozNzoyN1rOHlcTRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAyMzA0NQ==", "bodyText": "Nope, it won't work for multiple callbacks. Or rather I'm not sure what it's supposed to do since this will afaics, take the existing State for the this Transformation and transfer it to the first Transformation that is added to this Transformation. So if you add multiple Transformations only the first one added will get the State. There is a race here as well since adding Transformations can be done concurrently, there is no telling which Transformation actually gets the State.", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#discussion_r509023045", "createdAt": "2020-10-21T06:37:27Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/scala-promise-2.13/src/main/java/datadog/trace/instrumentation/scala/concurrent/PromiseTransformationInstrumentation.java", "diffHunk": "@@ -77,6 +80,28 @@ private static void muzzleCheck(final Transformation callback) {\n     }\n   }\n \n+  public static final class Transfer {\n+    @SuppressWarnings(\"rawtypes\")\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static <F, T> void transfer(\n+        @Advice.This Transformation<F, T> task,\n+        @Advice.Argument(0) Object doNotUse,\n+        @Advice.Argument(1) Object callbacks) {\n+      if (callbacks instanceof Transformation && task != callbacks) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2NDQ2Mg=="}, "originalCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58c002b884d3780a0856bf0030e0c685acc25e7a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/58c002b884d3780a0856bf0030e0c685acc25e7a", "committedDate": "2020-10-20T18:29:42Z", "message": "transfer state when scala 2.13 transformation is mapped"}, "afterCommit": {"oid": "83571f3e5f7ba322d553a1d67cca3abd494beb34", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/83571f3e5f7ba322d553a1d67cca3abd494beb34", "committedDate": "2020-10-21T07:00:30Z", "message": "transfer state when scala 2.13 transformation is mapped"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83571f3e5f7ba322d553a1d67cca3abd494beb34", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/83571f3e5f7ba322d553a1d67cca3abd494beb34", "committedDate": "2020-10-21T07:00:30Z", "message": "transfer state when scala 2.13 transformation is mapped"}, "afterCommit": {"oid": "6ad52a5fdd40ba2aaa705d162fb8085cd044f513", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6ad52a5fdd40ba2aaa705d162fb8085cd044f513", "committedDate": "2020-10-21T07:46:06Z", "message": "transfer state when scala 2.13 transformation is mapped"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "257cd156799dabab8914ef1319a4d8055d2c12cf", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/257cd156799dabab8914ef1319a4d8055d2c12cf", "committedDate": "2020-10-21T09:50:27Z", "message": "test scala 2.13 promises with specified execution context"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91c65115b63bedcc0507a140df635465ea792802", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/91c65115b63bedcc0507a140df635465ea792802", "committedDate": "2020-10-21T08:04:01Z", "message": "test scala 2.13 promises with specified execution context"}, "afterCommit": {"oid": "257cd156799dabab8914ef1319a4d8055d2c12cf", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/257cd156799dabab8914ef1319a4d8055d2c12cf", "committedDate": "2020-10-21T09:50:27Z", "message": "test scala 2.13 promises with specified execution context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15135fa1ffc4b220f0b481ab6c68dbbdd3501e6e", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/15135fa1ffc4b220f0b481ab6c68dbbdd3501e6e", "committedDate": "2020-10-21T09:57:08Z", "message": "Capture scope if necessary before Scala 2.13 Transformation enters an ExecutionContext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNTUxMjE0", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#pullrequestreview-513551214", "createdAt": "2020-10-21T10:56:32Z", "commit": {"oid": "15135fa1ffc4b220f0b481ab6c68dbbdd3501e6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjU3NTA1", "url": "https://github.com/DataDog/dd-trace-java/pull/2015#pullrequestreview-513657505", "createdAt": "2020-10-21T13:09:33Z", "commit": {"oid": "15135fa1ffc4b220f0b481ab6c68dbbdd3501e6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3020, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}