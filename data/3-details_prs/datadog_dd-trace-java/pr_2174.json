{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0NDI1Nzc3", "number": 2174, "title": "Try to create a type description by loading a class if the pool fails", "bodyText": "This is a way to try to create a type description for classes that are injected via defineClass while we are instrumenting (usually by another java agent), so that we can instrument classes referring to those types.\nThis new behavior can be switched off with -Ddd.resolver.use.loadclass=false or DD_RESOLVER_USE_LOADCLASS=false", "createdAt": "2020-12-08T12:44:10Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2174", "merged": true, "mergeCommit": {"oid": "a11dc7011f64e8557a1e1494dacd8e3e765954d2"}, "closed": true, "closedAt": "2020-12-09T16:28:02Z", "author": {"login": "bantonsson"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkJtthgFqTU0NzIwODIwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkgys3gFqTU0ODMyNjIzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjA4MjAz", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#pullrequestreview-547208203", "createdAt": "2020-12-08T12:57:35Z", "commit": {"oid": "591b430243fa6668cf3f1666c6bbda8faa864f3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo1NzozNVrOIBZgyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo1NzozNVrOIBZgyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzNzQ4Mg==", "bodyText": "Shouldn't this be klass = classLoader.loadClass(className.replace('.', '/')); ?", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#discussion_r538337482", "createdAt": "2020-12-08T12:57:35Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/DDCachingPoolStrategy.java", "diffHunk": "@@ -248,12 +256,52 @@ public void clear() {\n     }\n   }\n \n+  private static class CachingResolutionForMaybeLoadableType implements TypePool.Resolution {\n+    private final WeakReference<ClassLoader> loaderRef;\n+    private final String className;\n+    private volatile TypeDescription typeDescription = null;\n+    private volatile boolean isResolved = false;\n+\n+    public CachingResolutionForMaybeLoadableType(\n+        WeakReference<ClassLoader> loaderRef, String className) {\n+      this.loaderRef = loaderRef;\n+      this.className = className;\n+    }\n+\n+    @Override\n+    public boolean isResolved() {\n+      return isResolved;\n+    }\n+\n+    @Override\n+    public TypeDescription resolve() {\n+      // Intentionally not \"thread safe\". Duplicate work deemed an acceptable trade-off.\n+      if (!isResolved) {\n+        Class<?> klass = null;\n+        ClassLoader classLoader = loaderRef.get();\n+        if (classLoader != null) {\n+          try {\n+            klass = classLoader.loadClass(className.replace('.', '\\\\'));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "591b430243fa6668cf3f1666c6bbda8faa864f3b"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "591b430243fa6668cf3f1666c6bbda8faa864f3b", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/591b430243fa6668cf3f1666c6bbda8faa864f3b", "committedDate": "2020-12-08T12:41:35Z", "message": "Try to create a type description by loading a class if the pool fails"}, "afterCommit": {"oid": "97a880c7d3f1740509bfc8136ae8d929e94ea186", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/97a880c7d3f1740509bfc8136ae8d929e94ea186", "committedDate": "2020-12-08T13:29:47Z", "message": "Try to create a type description by loading a class if the pool fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjU5MTM1", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#pullrequestreview-547259135", "createdAt": "2020-12-08T14:00:14Z", "commit": {"oid": "97a880c7d3f1740509bfc8136ae8d929e94ea186"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjI5OTI5", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#pullrequestreview-547629929", "createdAt": "2020-12-08T21:03:25Z", "commit": {"oid": "97a880c7d3f1740509bfc8136ae8d929e94ea186"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMTowMzoyNVrOIB2GPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMTowMzoyNVrOIB2GPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwNTgyMg==", "bodyText": "Should we log a debug message when this happens?", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#discussion_r538805822", "createdAt": "2020-12-08T21:03:25Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/DDCachingPoolStrategy.java", "diffHunk": "@@ -248,12 +256,52 @@ public void clear() {\n     }\n   }\n \n+  private static class CachingResolutionForMaybeLoadableType implements TypePool.Resolution {\n+    private final WeakReference<ClassLoader> loaderRef;\n+    private final String className;\n+    private volatile TypeDescription typeDescription = null;\n+    private volatile boolean isResolved = false;\n+\n+    public CachingResolutionForMaybeLoadableType(\n+        WeakReference<ClassLoader> loaderRef, String className) {\n+      this.loaderRef = loaderRef;\n+      this.className = className;\n+    }\n+\n+    @Override\n+    public boolean isResolved() {\n+      return isResolved;\n+    }\n+\n+    @Override\n+    public TypeDescription resolve() {\n+      // Intentionally not \"thread safe\". Duplicate work deemed an acceptable trade-off.\n+      if (!isResolved) {\n+        Class<?> klass = null;\n+        ClassLoader classLoader = loaderRef.get();\n+        if (classLoader != null) {\n+          try {\n+            klass = classLoader.loadClass(className);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97a880c7d3f1740509bfc8136ae8d929e94ea186"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97a880c7d3f1740509bfc8136ae8d929e94ea186", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/97a880c7d3f1740509bfc8136ae8d929e94ea186", "committedDate": "2020-12-08T13:29:47Z", "message": "Try to create a type description by loading a class if the pool fails"}, "afterCommit": {"oid": "fb14ab1cddb4a5e68a7f5cd98283fdbe33a20624", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fb14ab1cddb4a5e68a7f5cd98283fdbe33a20624", "committedDate": "2020-12-09T07:08:42Z", "message": "Try to create a type description by loading a class if the pool fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4994716fcd534ba6abea41df0d1c4f110c802a19", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4994716fcd534ba6abea41df0d1c4f110c802a19", "committedDate": "2020-12-09T11:41:57Z", "message": "Try to create a type description using loadClass if the pool fails"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb14ab1cddb4a5e68a7f5cd98283fdbe33a20624", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fb14ab1cddb4a5e68a7f5cd98283fdbe33a20624", "committedDate": "2020-12-09T07:08:42Z", "message": "Try to create a type description by loading a class if the pool fails"}, "afterCommit": {"oid": "4994716fcd534ba6abea41df0d1c4f110c802a19", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4994716fcd534ba6abea41df0d1c4f110c802a19", "committedDate": "2020-12-09T11:41:57Z", "message": "Try to create a type description using loadClass if the pool fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MzI2MjMy", "url": "https://github.com/DataDog/dd-trace-java/pull/2174#pullrequestreview-548326232", "createdAt": "2020-12-09T15:50:51Z", "commit": {"oid": "4994716fcd534ba6abea41df0d1c4f110c802a19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2715, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}