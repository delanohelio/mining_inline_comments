{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MzQ3NDQ0", "number": 1717, "title": "Move Spring Scheduling RunnableWrapper to separate class", "bodyText": "This works around an edge case where Spring Sleuth tries to load the RunnableWrapper's enclosing class:\nhttps://github.com/spring-projects/spring-framework/blob/v5.2.2.RELEASE/spring-core/src/main/java/org/springframework/core/annotation/AnnotationsScanner.java#L233\nSince the enclosing class is on a separate class loader, this fails and results in an exception.", "createdAt": "2020-07-27T19:07:43Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1717", "merged": true, "mergeCommit": {"oid": "77afd06d45499436b7830a1e05a4ad53a76d8f3f"}, "closed": true, "closedAt": "2020-07-27T21:05:55Z", "author": {"login": "tylerbenson"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5GoSYAH2gAyNDU3MzQ3NDQ0OmNjNmM1ZDViZTIyZDAxOGNlMmFkZDE0MjE2NmE0ZTIzMjRkNDYyMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5RXf0gFqTQ1NjM3MzU2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cc6c5d5be22d018ce2add142166a4e2324d46239", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cc6c5d5be22d018ce2add142166a4e2324d46239", "committedDate": "2020-07-27T19:03:12Z", "message": "Move Spring Scheduling RunnableWrapper to separate class\n\nThis works around an edge case where Spring Sleuth tries to load the RunnableWrapper's enclosing class:\nhttps://github.com/spring-projects/spring-framework/blob/v5.2.2.RELEASE/spring-core/src/main/java/org/springframework/core/annotation/AnnotationsScanner.java#L233\n\nSince the enclosing class is on a separate class loader, this fails and results in an exception."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDYwNDgx", "url": "https://github.com/DataDog/dd-trace-java/pull/1717#pullrequestreview-456060481", "createdAt": "2020-07-27T19:11:17Z", "commit": {"oid": "cc6c5d5be22d018ce2add142166a4e2324d46239"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cf7c5f882359d8d0bcce5e3c4b18ab34d68c88e", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3cf7c5f882359d8d0bcce5e3c4b18ab34d68c88e", "committedDate": "2020-07-27T19:39:44Z", "message": "Forgot the period..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MzczNTY2", "url": "https://github.com/DataDog/dd-trace-java/pull/1717#pullrequestreview-456373566", "createdAt": "2020-07-28T07:33:49Z", "commit": {"oid": "3cf7c5f882359d8d0bcce5e3c4b18ab34d68c88e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzozMzo0OVrOG4APBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzozMzo0OVrOG4APBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM3NzI4NA==", "bodyText": "So this comment is completely unrelated AFAICS, and just utterly confusing.", "url": "https://github.com/DataDog/dd-trace-java/pull/1717#discussion_r461377284", "createdAt": "2020-07-28T07:33:49Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/spring-scheduling-3.1/src/main/java/datadog/trace/instrumentation/springscheduling/SpringSchedulingRunnableWrapper.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package datadog.trace.instrumentation.springscheduling;\n+\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n+import static datadog.trace.instrumentation.springscheduling.SpringSchedulingDecorator.DECORATE;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+\n+public class SpringSchedulingRunnableWrapper implements Runnable {\n+  private final Runnable runnable;\n+\n+  private SpringSchedulingRunnableWrapper(final Runnable runnable) {\n+    this.runnable = runnable;\n+  }\n+\n+  @Override\n+  public void run() {\n+    final AgentSpan span = startSpan(\"scheduled.call\");\n+    DECORATE.afterStart(span);\n+\n+    try (final AgentScope scope = activateSpan(span)) {\n+      DECORATE.onRun(span, runnable);\n+      scope.setAsyncPropagation(true);\n+\n+      try {\n+        runnable.run();\n+      } catch (final Throwable throwable) {\n+        DECORATE.onError(span, throwable);\n+        throw throwable;\n+      }\n+    } finally {\n+      DECORATE.beforeFinish(span);\n+      span.finish();\n+    }\n+  }\n+\n+  public static Runnable wrapIfNeeded(final Runnable task) {\n+    // We wrap only lambdas' anonymous classes and if given object has not already been wrapped.\n+    // Anonymous classes have '/' in class name which is not allowed in 'normal' classes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cf7c5f882359d8d0bcce5e3c4b18ab34d68c88e"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2045, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}