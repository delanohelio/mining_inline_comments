{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5Nzk3ODgz", "number": 2201, "title": "Reduce DDSpanContext footprint", "bodyText": "Access CoreTracer via PendingTrace\nStore thread name and id as fields\nDon't store metrics in AtomicReference - still lazily initialised but uses synchronized access to a plan HashMap\nOnly need to construct ExclusiveSpan at the end when the span is reported - this class has now been removed because it is hardly used and was relying on indirect test coverage, which would now fail the build.\nDon't duplicate serviceNameMappings - move mapping logic to CoreTracer where the data originates\n\nThese changes are motivated by this allocation profile\n\nafter:", "createdAt": "2020-12-14T21:04:25Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2201", "merged": true, "mergeCommit": {"oid": "a6a5931f3f52f03291bd913dd4089fa11f9bda82"}, "closed": true, "closedAt": "2020-12-15T16:32:53Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmM0D8gBqjQxMTE0NzMyOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmckXMgFqTU1MjYxNDkyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f3b154a66957eaebcdae34dff7643f85f04cf03", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4f3b154a66957eaebcdae34dff7643f85f04cf03", "committedDate": "2020-12-14T21:03:20Z", "message": "don't store direct reference to CoreTracer in DDSpanContext"}, "afterCommit": {"oid": "6e91da97259acfc12e556f5f372776976a304972", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6e91da97259acfc12e556f5f372776976a304972", "committedDate": "2020-12-14T21:41:55Z", "message": "don't store direct reference to CoreTracer in DDSpanContext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxOTI3NzQ0", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#pullrequestreview-551927744", "createdAt": "2020-12-14T21:58:34Z", "commit": {"oid": "6e91da97259acfc12e556f5f372776976a304972"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37fbfa22c5fda838f95fc4fdee9bcce46a10a2b7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/37fbfa22c5fda838f95fc4fdee9bcce46a10a2b7", "committedDate": "2020-12-14T22:38:53Z", "message": "don't store direct reference to CoreTracer in DDSpanContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d6f43cf29e2391f47cdd48bce3dbd51fa00f873", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1d6f43cf29e2391f47cdd48bce3dbd51fa00f873", "committedDate": "2020-12-14T22:38:53Z", "message": "don't store thread attributes in the tags map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e91da97259acfc12e556f5f372776976a304972", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6e91da97259acfc12e556f5f372776976a304972", "committedDate": "2020-12-14T21:41:55Z", "message": "don't store direct reference to CoreTracer in DDSpanContext"}, "afterCommit": {"oid": "1d6f43cf29e2391f47cdd48bce3dbd51fa00f873", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1d6f43cf29e2391f47cdd48bce3dbd51fa00f873", "committedDate": "2020-12-14T22:38:53Z", "message": "don't store thread attributes in the tags map"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxOTU1Mjg1", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#pullrequestreview-551955285", "createdAt": "2020-12-14T22:41:56Z", "commit": {"oid": "1d6f43cf29e2391f47cdd48bce3dbd51fa00f873"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMjo0MTo1NlrOIFvN2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMjo0MTo1NlrOIFvN2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg4NzM4Ng==", "bodyText": "this was an arithmetic error which just happened to work before", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#discussion_r542887386", "createdAt": "2020-12-14T22:41:56Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/common/writer/ddagent/TraceMapperV05PayloadTest.groovy", "diffHunk": "@@ -98,7 +98,7 @@ class TraceMapperV05PayloadTest extends DDSpecification {\n       UUID.randomUUID().toString(),\n       false))\n     int traceSize = calculateSize(repeatedTrace)\n-    int tracesRequiredToOverflowBody = traceMapper.messageBufferSize() / traceSize\n+    int tracesRequiredToOverflowBody = (traceMapper.messageBufferSize() + traceSize - 1) / traceSize", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d6f43cf29e2391f47cdd48bce3dbd51fa00f873"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "065534c568d8e6a6cc360e1dc4aaf50a1cb73df5", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/065534c568d8e6a6cc360e1dc4aaf50a1cb73df5", "committedDate": "2020-12-14T23:18:36Z", "message": "lighter-weight metrics in DDSpanContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcaef74909465018bc959b98e7e828442b8de343", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bcaef74909465018bc959b98e7e828442b8de343", "committedDate": "2020-12-14T23:36:16Z", "message": "remove unnecessary ExclusiveSpan field from DDSpanContext"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c7f31b456623c5752ab4636c0f6e46ee2a4f5cb", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5c7f31b456623c5752ab4636c0f6e46ee2a4f5cb", "committedDate": "2020-12-14T23:44:11Z", "message": "get rid of unnecessary serviceNameMappings duplicated on each DDSpanContext instance"}, "afterCommit": {"oid": "57618dae5da74c3799178e471b156861ba75a6c8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/57618dae5da74c3799178e471b156861ba75a6c8", "committedDate": "2020-12-15T00:10:08Z", "message": "get rid of unnecessary serviceNameMappings duplicated on each DDSpanContext instance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57618dae5da74c3799178e471b156861ba75a6c8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/57618dae5da74c3799178e471b156861ba75a6c8", "committedDate": "2020-12-15T00:10:08Z", "message": "get rid of unnecessary serviceNameMappings duplicated on each DDSpanContext instance"}, "afterCommit": {"oid": "de3889cac5cda04025c6bbb221f8bbdacaa2b927", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/de3889cac5cda04025c6bbb221f8bbdacaa2b927", "committedDate": "2020-12-15T00:18:14Z", "message": "get rid of unnecessary serviceNameMappings duplicated on each DDSpanContext instance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de3889cac5cda04025c6bbb221f8bbdacaa2b927", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/de3889cac5cda04025c6bbb221f8bbdacaa2b927", "committedDate": "2020-12-15T00:18:14Z", "message": "get rid of unnecessary serviceNameMappings duplicated on each DDSpanContext instance"}, "afterCommit": {"oid": "451e246774b6f7b1ad3a02080a44f8acf104f4f2", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/451e246774b6f7b1ad3a02080a44f8acf104f4f2", "committedDate": "2020-12-15T00:44:57Z", "message": "get rid of unnecessary serviceNameMappings duplicated on each DDSpanContext instance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjE2NDU4", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#pullrequestreview-552216458", "createdAt": "2020-12-15T08:39:57Z", "commit": {"oid": "37fbfa22c5fda838f95fc4fdee9bcce46a10a2b7"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwODozOTo1N1rOIF_Jtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwODo1MzozOVrOIF_tmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE0ODQ3MA==", "bodyText": "Not directly related to the change, but maybe hoist this access out of the loop?", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#discussion_r543148470", "createdAt": "2020-12-15T08:39:57Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -386,7 +379,10 @@ void setAllTags(final Map<String, ? extends Object> map) {\n \n     synchronized (unsafeTags) {\n       for (final Map.Entry<String, ? extends Object> tag : map.entrySet()) {\n-        if (!tracer.getTagInterceptor().interceptTag(exclusiveSpan, tag.getKey(), tag.getValue())) {\n+        if (!trace\n+            .getTracer()\n+            .getTagInterceptor()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37fbfa22c5fda838f95fc4fdee9bcce46a10a2b7"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE1NzY1Ng==", "bodyText": "Nice find.", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#discussion_r543157656", "createdAt": "2020-12-15T08:53:39Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -89,8 +89,6 @@\n \n   private final Map<String, String> serviceNameMappings;\n \n-  private final ExclusiveSpan exclusiveSpan;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcaef74909465018bc959b98e7e828442b8de343"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dabffbf018e012a1d81a8f91ecf2c91974da5d95", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/dabffbf018e012a1d81a8f91ecf2c91974da5d95", "committedDate": "2020-12-15T09:16:50Z", "message": "hoist taginterceptor access out of loop"}, "afterCommit": {"oid": "86c7d7c2029ca787770734a929138653cddd412e", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/86c7d7c2029ca787770734a929138653cddd412e", "committedDate": "2020-12-15T09:33:57Z", "message": "hoist taginterceptor access out of loop"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66574cf97e64109655d9fdcbc394e8bd1909d976", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/66574cf97e64109655d9fdcbc394e8bd1909d976", "committedDate": "2020-12-15T10:01:43Z", "message": "fix hashmap sizing to avoid resizes"}, "afterCommit": {"oid": "b0c8c6c7d49893fdd48d318aedb42807ef2af468", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b0c8c6c7d49893fdd48d318aedb42807ef2af468", "committedDate": "2020-12-15T10:28:30Z", "message": "fix hashmap sizing to avoid resizes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e22e1a148962b80d110b58f2835886c92855f58", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9e22e1a148962b80d110b58f2835886c92855f58", "committedDate": "2020-12-15T14:38:08Z", "message": "get rid of unnecessary serviceNameMappings duplicated on each DDSpanContext instance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "661557a66e2cc2f85b97ab993a5f53d49bc6dafd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/661557a66e2cc2f85b97ab993a5f53d49bc6dafd", "committedDate": "2020-12-15T14:38:08Z", "message": "remove now hardly used ExclusiveSpan"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6b883c6f06fdc16db356d1f660eefe76613ac6e", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e6b883c6f06fdc16db356d1f660eefe76613ac6e", "committedDate": "2020-12-15T14:38:08Z", "message": "hoist taginterceptor access out of loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e83a162999b32e87502653049a911d337ec6dd5", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9e83a162999b32e87502653049a911d337ec6dd5", "committedDate": "2020-12-15T14:38:08Z", "message": "fix hashmap sizing to avoid resizes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba6c3d7d1b662685f7b2b53fa891585d1985986f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ba6c3d7d1b662685f7b2b53fa891585d1985986f", "committedDate": "2020-12-15T14:38:08Z", "message": "fix missing baggage check and initialise baggage lazily if it's used"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c4c2274c2d54104399612dd058b6627203e8232", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9c4c2274c2d54104399612dd058b6627203e8232", "committedDate": "2020-12-15T10:56:28Z", "message": "fix missing baggage check and initialise baggage lazily if it's used"}, "afterCommit": {"oid": "ba6c3d7d1b662685f7b2b53fa891585d1985986f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ba6c3d7d1b662685f7b2b53fa891585d1985986f", "committedDate": "2020-12-15T14:38:08Z", "message": "fix missing baggage check and initialise baggage lazily if it's used"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTM2NDk2", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#pullrequestreview-552536496", "createdAt": "2020-12-15T14:49:40Z", "commit": {"oid": "ba6c3d7d1b662685f7b2b53fa891585d1985986f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNDo0OTo0MFrOIGPMiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNDo0OTo0MFrOIGPMiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQxMTMzNg==", "bodyText": "Needs some sort of GuardedBy comment.", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#discussion_r543411336", "createdAt": "2020-12-15T14:49:40Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -80,11 +87,7 @@\n   /** The origin of the trace. (eg. Synthetics) */\n   private final String origin;\n   /** Metrics on the span */\n-  private final AtomicReference<Map<CharSequence, Number>> metrics = new AtomicReference<>();\n-\n-  private final Map<String, String> serviceNameMappings;\n-\n-  private final ExclusiveSpan exclusiveSpan;\n+  private volatile Map<CharSequence, Number> metrics = EMPTY_METRICS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba6c3d7d1b662685f7b2b53fa891585d1985986f"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f0d1da9ec54b1602fc62215d6d7ac2cea33a69b", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1f0d1da9ec54b1602fc62215d6d7ac2cea33a69b", "committedDate": "2020-12-15T15:15:36Z", "message": "add synchronized internal utility method for getting metric values"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTcxMjIz", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#pullrequestreview-552571223", "createdAt": "2020-12-15T15:21:41Z", "commit": {"oid": "1f0d1da9ec54b1602fc62215d6d7ac2cea33a69b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNToyMTo0MVrOIGQ38A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNToyMTo0MVrOIGQ38A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQzODgzMg==", "bodyText": "This method should probably be removed since access to the map is no longer thread safe and the guarding lock is private. How widely is it used?", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#discussion_r543438832", "createdAt": "2020-12-15T15:21:41Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -342,22 +340,32 @@ public PendingTrace getTrace() {\n \n   @Deprecated\n   public CoreTracer getTracer() {\n-    return tracer;\n+    return trace.getTracer();\n   }\n \n   public Map<CharSequence, Number> getMetrics() {\n-    final Map<CharSequence, Number> metrics = this.metrics.get();\n-    return metrics == null ? EMPTY_METRICS : metrics;\n+    return metrics;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0d1da9ec54b1602fc62215d6d7ac2cea33a69b"}, "originalPosition": 198}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51006634a1a4a1000c441031f5686a9bee509fac", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/51006634a1a4a1000c441031f5686a9bee509fac", "committedDate": "2020-12-15T15:50:53Z", "message": "rename internal API getMetrics() to getUnsafeMetrics()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjE0OTIx", "url": "https://github.com/DataDog/dd-trace-java/pull/2201#pullrequestreview-552614921", "createdAt": "2020-12-15T16:03:25Z", "commit": {"oid": "51006634a1a4a1000c441031f5686a9bee509fac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2755, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}