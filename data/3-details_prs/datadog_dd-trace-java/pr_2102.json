{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NjMxMDAx", "number": 2102, "title": "Change context store to use Boolean values in servlet instrumentations", "bodyText": "The context stores in the servlet instrumentations only serve the purpose of being certain that the response object is the one previously associated with the instrumented request, but this association is costly in memory, and when the association falls back to a weak map, it will not be cleared deterministically leading to unbounded memory consumption.\nIt doesn't seem to be possible to entirely remove this context store, but setting a boolean value mitigates the impact when field injection fails.", "createdAt": "2020-11-20T11:09:27Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2102", "merged": true, "mergeCommit": {"oid": "b78a11a7d480969193cb9bb9124d1f26bb1a5906"}, "closed": true, "closedAt": "2020-11-20T15:59:03Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeVl7kABqjQwMjA0NDM3MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeY-lxgFqTUzNTUyMDU0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7eab0e50000d934455dece842bb6d7e0191db87c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7eab0e50000d934455dece842bb6d7e0191db87c", "committedDate": "2020-11-20T11:01:49Z", "message": "make it possible to ignore types of HttpServletResponse to avoid need for context store in servlet instrumentation"}, "afterCommit": {"oid": "67c0be7598adb8ab1d354d03dd670ec458431b29", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/67c0be7598adb8ab1d354d03dd670ec458431b29", "committedDate": "2020-11-20T11:24:15Z", "message": "make it possible to ignore types of HttpServletResponse to avoid need for context store in servlet instrumentation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67c0be7598adb8ab1d354d03dd670ec458431b29", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/67c0be7598adb8ab1d354d03dd670ec458431b29", "committedDate": "2020-11-20T11:24:15Z", "message": "make it possible to ignore types of HttpServletResponse to avoid need for context store in servlet instrumentation"}, "afterCommit": {"oid": "07f8683699ef8b87ba367436bca9c890a4f0e14b", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/07f8683699ef8b87ba367436bca9c890a4f0e14b", "committedDate": "2020-11-20T11:46:05Z", "message": "make it possible to ignore types of HttpServletResponse to avoid need for context store in servlet instrumentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzU5MTAy", "url": "https://github.com/DataDog/dd-trace-java/pull/2102#pullrequestreview-535359102", "createdAt": "2020-11-20T11:47:05Z", "commit": {"oid": "07f8683699ef8b87ba367436bca9c890a4f0e14b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzY0NzU2", "url": "https://github.com/DataDog/dd-trace-java/pull/2102#pullrequestreview-535364756", "createdAt": "2020-11-20T11:56:02Z", "commit": {"oid": "07f8683699ef8b87ba367436bca9c890a4f0e14b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84df3d8c12f055c112c2aaa66bda716369121e99", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/84df3d8c12f055c112c2aaa66bda716369121e99", "committedDate": "2020-11-20T11:59:48Z", "message": "more general wrapper detection"}, "afterCommit": {"oid": "d8ebae49cdddc970c308a6bd462633bcf21b2e09", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d8ebae49cdddc970c308a6bd462633bcf21b2e09", "committedDate": "2020-11-20T12:17:00Z", "message": "more general wrapper detection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Mzc5NjU1", "url": "https://github.com/DataDog/dd-trace-java/pull/2102#pullrequestreview-535379655", "createdAt": "2020-11-20T12:17:46Z", "commit": {"oid": "84df3d8c12f055c112c2aaa66bda716369121e99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8ebae49cdddc970c308a6bd462633bcf21b2e09", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d8ebae49cdddc970c308a6bd462633bcf21b2e09", "committedDate": "2020-11-20T12:17:00Z", "message": "more general wrapper detection"}, "afterCommit": {"oid": "cc46c9553d3f691a8d6cea45a7c2d8d1a52fd4d6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cc46c9553d3f691a8d6cea45a7c2d8d1a52fd4d6", "committedDate": "2020-11-20T12:17:00Z", "message": "make it possible to ignore types of HttpServletResponse to avoid need for context store in servlet instrumentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDY2NTY2", "url": "https://github.com/DataDog/dd-trace-java/pull/2102#pullrequestreview-535466566", "createdAt": "2020-11-20T14:19:50Z", "commit": {"oid": "cc46c9553d3f691a8d6cea45a7c2d8d1a52fd4d6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDoxOTo1MFrOH3RnxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDoxOTo1MFrOH3RnxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcyMjQzNw==", "bodyText": "This class name can now be switched to javax.servlet.http.HttpServletResponse", "url": "https://github.com/DataDog/dd-trace-java/pull/2102#discussion_r527722437", "createdAt": "2020-11-20T14:19:50Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/servlet/request-2/src/main/java/datadog/trace/instrumentation/servlet2/Servlet2Instrumentation.java", "diffHunk": "@@ -53,11 +52,7 @@ public Servlet2Instrumentation() {\n \n   @Override\n   public Map<String, String> contextStore() {\n-    final Map<String, String> contextStores = new HashMap<>();\n-    contextStores.put(\n-        \"javax.servlet.http.HttpServletResponse\", \"javax.servlet.http.HttpServletRequest\");\n-    contextStores.put(\"javax.servlet.ServletResponse\", Integer.class.getName());\n-    return Collections.unmodifiableMap(contextStores);\n+    return Collections.singletonMap(\"javax.servlet.ServletResponse\", Integer.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc46c9553d3f691a8d6cea45a7c2d8d1a52fd4d6"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81c884fb49179838d37aea785904742c84a10be7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/81c884fb49179838d37aea785904742c84a10be7", "committedDate": "2020-11-20T15:11:53Z", "message": "inject boolean instead of HttpServletRequest to reduce impact of when field injection fails"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc46c9553d3f691a8d6cea45a7c2d8d1a52fd4d6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cc46c9553d3f691a8d6cea45a7c2d8d1a52fd4d6", "committedDate": "2020-11-20T12:17:00Z", "message": "make it possible to ignore types of HttpServletResponse to avoid need for context store in servlet instrumentation"}, "afterCommit": {"oid": "81c884fb49179838d37aea785904742c84a10be7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/81c884fb49179838d37aea785904742c84a10be7", "committedDate": "2020-11-20T15:11:53Z", "message": "inject boolean instead of HttpServletRequest to reduce impact of when field injection fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NTE0Mzk2", "url": "https://github.com/DataDog/dd-trace-java/pull/2102#pullrequestreview-535514396", "createdAt": "2020-11-20T15:14:02Z", "commit": {"oid": "81c884fb49179838d37aea785904742c84a10be7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NTIwNTQ2", "url": "https://github.com/DataDog/dd-trace-java/pull/2102#pullrequestreview-535520546", "createdAt": "2020-11-20T15:21:03Z", "commit": {"oid": "81c884fb49179838d37aea785904742c84a10be7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2852, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}