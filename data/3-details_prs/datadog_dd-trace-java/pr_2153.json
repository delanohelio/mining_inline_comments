{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMTQ1ODQ2", "number": 2153, "title": "Support vertx chained handlers", "bodyText": "I was able to rip out my custom test by copying ratpack", "createdAt": "2020-12-02T16:42:25Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2153", "merged": true, "mergeCommit": {"oid": "8587af1dbe4931231e89c399c77b7091280a3c40"}, "closed": true, "closedAt": "2020-12-02T21:40:35Z", "author": {"login": "devinsba"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiTT7AgFqTU0MzE0NzQwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiU3tugBqjQwNjQzMjU0OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTQ3NDA3", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#pullrequestreview-543147407", "createdAt": "2020-12-02T19:00:37Z", "commit": {"oid": "369315a6e3082cb1b1206c84fda3526357accfe1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTUzMzU1", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#pullrequestreview-543153355", "createdAt": "2020-12-02T19:08:35Z", "commit": {"oid": "369315a6e3082cb1b1206c84fda3526357accfe1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowODozNVrOH9qENQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowODozNVrOH9qENQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNDM4OQ==", "bodyText": "Does this really need to be the fully qualified name?", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#discussion_r534414389", "createdAt": "2020-12-02T19:08:35Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -20,13 +20,18 @@ public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n \n   @Override\n   public void handle(final RoutingContext routingContext) {\n-    final AgentSpan parentSpan = activeSpan();\n-    DECORATE.onRequest(parentSpan, routingContext);\n+    AgentSpan span = routingContext.get(AgentSpan.class.getName());\n+    if (span == null) {\n+      final AgentSpan parentSpan = activeSpan();\n+      DECORATE.onRequest(parentSpan, routingContext);\n \n-    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n-    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n-    DECORATE.afterStart(span);\n-    span.setResourceName(actual.getClass().getName());\n+      span = startSpan(INSTRUMENTATION_NAME);\n+      routingContext.put(AgentSpan.class.getName(), span);\n+\n+      routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+      DECORATE.afterStart(span);\n+      span.setResourceName(actual.getClass().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "369315a6e3082cb1b1206c84fda3526357accfe1"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "369315a6e3082cb1b1206c84fda3526357accfe1", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/369315a6e3082cb1b1206c84fda3526357accfe1", "committedDate": "2020-12-02T16:40:01Z", "message": "Support chained handlers"}, "afterCommit": {"oid": "d00df5da6ee289571a02ab95b88dfb262acfeffe", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d00df5da6ee289571a02ab95b88dfb262acfeffe", "committedDate": "2020-12-02T19:13:33Z", "message": "Support chained handlers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTY1NTI4", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#pullrequestreview-543165528", "createdAt": "2020-12-02T19:25:03Z", "commit": {"oid": "d00df5da6ee289571a02ab95b88dfb262acfeffe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTY4Mzgx", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#pullrequestreview-543168381", "createdAt": "2020-12-02T19:28:41Z", "commit": {"oid": "d00df5da6ee289571a02ab95b88dfb262acfeffe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOToyODo0MlrOH9qyyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOToyODo0MlrOH9qyyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQyNjMxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  DECORATE.className(actual.getClass());\n          \n          \n            \n            span.setResourceName(DECORATE.className(actual.getClass()));", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#discussion_r534426315", "createdAt": "2020-12-02T19:28:42Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -20,13 +20,18 @@ public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n \n   @Override\n   public void handle(final RoutingContext routingContext) {\n-    final AgentSpan parentSpan = activeSpan();\n-    DECORATE.onRequest(parentSpan, routingContext);\n+    AgentSpan span = routingContext.get(AgentSpan.class.getName());\n+    if (span == null) {\n+      final AgentSpan parentSpan = activeSpan();\n+      DECORATE.onRequest(parentSpan, routingContext);\n \n-    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n-    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n-    DECORATE.afterStart(span);\n-    span.setResourceName(actual.getClass().getName());\n+      span = startSpan(INSTRUMENTATION_NAME);\n+      routingContext.put(AgentSpan.class.getName(), span);\n+\n+      routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+      DECORATE.afterStart(span);\n+      DECORATE.className(actual.getClass());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d00df5da6ee289571a02ab95b88dfb262acfeffe"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4f7d3c3307fdcd2aa481a2377eecf2ca37cf696", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a4f7d3c3307fdcd2aa481a2377eecf2ca37cf696", "committedDate": "2020-12-02T20:49:08Z", "message": "Support chained handlers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d00df5da6ee289571a02ab95b88dfb262acfeffe", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d00df5da6ee289571a02ab95b88dfb262acfeffe", "committedDate": "2020-12-02T19:13:33Z", "message": "Support chained handlers"}, "afterCommit": {"oid": "a4f7d3c3307fdcd2aa481a2377eecf2ca37cf696", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a4f7d3c3307fdcd2aa481a2377eecf2ca37cf696", "committedDate": "2020-12-02T20:49:08Z", "message": "Support chained handlers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2918, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}