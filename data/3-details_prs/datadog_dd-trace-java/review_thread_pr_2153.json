{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMTQ1ODQ2", "number": 2153, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowODozNVrOE_xMxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOToyODo0MlrOE_xqeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzAxODMxOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowODozNVrOH9qENQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOToxMzo1NFrOH9qQdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNDM4OQ==", "bodyText": "Does this really need to be the fully qualified name?", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#discussion_r534414389", "createdAt": "2020-12-02T19:08:35Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -20,13 +20,18 @@ public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n \n   @Override\n   public void handle(final RoutingContext routingContext) {\n-    final AgentSpan parentSpan = activeSpan();\n-    DECORATE.onRequest(parentSpan, routingContext);\n+    AgentSpan span = routingContext.get(AgentSpan.class.getName());\n+    if (span == null) {\n+      final AgentSpan parentSpan = activeSpan();\n+      DECORATE.onRequest(parentSpan, routingContext);\n \n-    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n-    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n-    DECORATE.afterStart(span);\n-    span.setResourceName(actual.getClass().getName());\n+      span = startSpan(INSTRUMENTATION_NAME);\n+      routingContext.put(AgentSpan.class.getName(), span);\n+\n+      routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+      DECORATE.afterStart(span);\n+      span.setResourceName(actual.getClass().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "369315a6e3082cb1b1206c84fda3526357accfe1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNTQyOA==", "bodyText": "Awesome, I'll do that", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#discussion_r534415428", "createdAt": "2020-12-02T19:10:15Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -20,13 +20,18 @@ public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n \n   @Override\n   public void handle(final RoutingContext routingContext) {\n-    final AgentSpan parentSpan = activeSpan();\n-    DECORATE.onRequest(parentSpan, routingContext);\n+    AgentSpan span = routingContext.get(AgentSpan.class.getName());\n+    if (span == null) {\n+      final AgentSpan parentSpan = activeSpan();\n+      DECORATE.onRequest(parentSpan, routingContext);\n \n-    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n-    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n-    DECORATE.afterStart(span);\n-    span.setResourceName(actual.getClass().getName());\n+      span = startSpan(INSTRUMENTATION_NAME);\n+      routingContext.put(AgentSpan.class.getName(), span);\n+\n+      routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+      DECORATE.afterStart(span);\n+      span.setResourceName(actual.getClass().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNDM4OQ=="}, "originalCommit": {"oid": "369315a6e3082cb1b1206c84fda3526357accfe1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNjA4Nw==", "bodyText": "It actually doesn't do what I just said, if the class has a simple name it just returns it. It might be worth changing it since we need those UTF-8 bytes so often, but I wouldn't do that in this PR", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#discussion_r534416087", "createdAt": "2020-12-02T19:11:26Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -20,13 +20,18 @@ public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n \n   @Override\n   public void handle(final RoutingContext routingContext) {\n-    final AgentSpan parentSpan = activeSpan();\n-    DECORATE.onRequest(parentSpan, routingContext);\n+    AgentSpan span = routingContext.get(AgentSpan.class.getName());\n+    if (span == null) {\n+      final AgentSpan parentSpan = activeSpan();\n+      DECORATE.onRequest(parentSpan, routingContext);\n \n-    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n-    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n-    DECORATE.afterStart(span);\n-    span.setResourceName(actual.getClass().getName());\n+      span = startSpan(INSTRUMENTATION_NAME);\n+      routingContext.put(AgentSpan.class.getName(), span);\n+\n+      routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+      DECORATE.afterStart(span);\n+      span.setResourceName(actual.getClass().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNDM4OQ=="}, "originalCommit": {"oid": "369315a6e3082cb1b1206c84fda3526357accfe1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNzUyNg==", "bodyText": "OK, switched to that method since simple name is fine for this use case", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#discussion_r534417526", "createdAt": "2020-12-02T19:13:54Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -20,13 +20,18 @@ public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n \n   @Override\n   public void handle(final RoutingContext routingContext) {\n-    final AgentSpan parentSpan = activeSpan();\n-    DECORATE.onRequest(parentSpan, routingContext);\n+    AgentSpan span = routingContext.get(AgentSpan.class.getName());\n+    if (span == null) {\n+      final AgentSpan parentSpan = activeSpan();\n+      DECORATE.onRequest(parentSpan, routingContext);\n \n-    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n-    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n-    DECORATE.afterStart(span);\n-    span.setResourceName(actual.getClass().getName());\n+      span = startSpan(INSTRUMENTATION_NAME);\n+      routingContext.put(AgentSpan.class.getName(), span);\n+\n+      routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+      DECORATE.afterStart(span);\n+      span.setResourceName(actual.getClass().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNDM4OQ=="}, "originalCommit": {"oid": "369315a6e3082cb1b1206c84fda3526357accfe1"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzA5NDMzOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOToyODo0MlrOH9qyyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDo0NzozNFrOH9tgUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQyNjMxNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  DECORATE.className(actual.getClass());\n          \n          \n            \n            span.setResourceName(DECORATE.className(actual.getClass()));", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#discussion_r534426315", "createdAt": "2020-12-02T19:28:42Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -20,13 +20,18 @@ public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n \n   @Override\n   public void handle(final RoutingContext routingContext) {\n-    final AgentSpan parentSpan = activeSpan();\n-    DECORATE.onRequest(parentSpan, routingContext);\n+    AgentSpan span = routingContext.get(AgentSpan.class.getName());\n+    if (span == null) {\n+      final AgentSpan parentSpan = activeSpan();\n+      DECORATE.onRequest(parentSpan, routingContext);\n \n-    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n-    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n-    DECORATE.afterStart(span);\n-    span.setResourceName(actual.getClass().getName());\n+      span = startSpan(INSTRUMENTATION_NAME);\n+      routingContext.put(AgentSpan.class.getName(), span);\n+\n+      routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+      DECORATE.afterStart(span);\n+      DECORATE.className(actual.getClass());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d00df5da6ee289571a02ab95b88dfb262acfeffe"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ3MDczOQ==", "bodyText": "doh \ud83e\udd26", "url": "https://github.com/DataDog/dd-trace-java/pull/2153#discussion_r534470739", "createdAt": "2020-12-02T20:47:34Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/vertx-web-3.4/src/main/java8/datadog/trace/instrumentation/vertx_3_4/server/RouteHandlerWrapper.java", "diffHunk": "@@ -20,13 +20,18 @@ public RouteHandlerWrapper(final Handler<RoutingContext> handler) {\n \n   @Override\n   public void handle(final RoutingContext routingContext) {\n-    final AgentSpan parentSpan = activeSpan();\n-    DECORATE.onRequest(parentSpan, routingContext);\n+    AgentSpan span = routingContext.get(AgentSpan.class.getName());\n+    if (span == null) {\n+      final AgentSpan parentSpan = activeSpan();\n+      DECORATE.onRequest(parentSpan, routingContext);\n \n-    final AgentSpan span = startSpan(INSTRUMENTATION_NAME);\n-    routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n-    DECORATE.afterStart(span);\n-    span.setResourceName(actual.getClass().getName());\n+      span = startSpan(INSTRUMENTATION_NAME);\n+      routingContext.put(AgentSpan.class.getName(), span);\n+\n+      routingContext.response().endHandler(new EndHandlerWrapper(span, routingContext.response()));\n+      DECORATE.afterStart(span);\n+      DECORATE.className(actual.getClass());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQyNjMxNQ=="}, "originalCommit": {"oid": "d00df5da6ee289571a02ab95b88dfb262acfeffe"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4664, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}