{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMjg1ODc0", "number": 1891, "title": "Make it possible to switch log level during runtime", "bodyText": "The code is fully functional and tested, but it is not hooked up to e.g. JMX yet, so right now it can't be activated from the outside.", "createdAt": "2020-09-21T13:10:31Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1891", "merged": true, "mergeCommit": {"oid": "93902cac8e406c7657cdd756f7867664408b85a8"}, "closed": true, "closedAt": "2020-09-22T14:51:12Z", "author": {"login": "bantonsson"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLDkf5gFqTQ5MjYxMDcxMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLYqx3gBqjM3OTM1MDEyOTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNjEwNzEw", "url": "https://github.com/DataDog/dd-trace-java/pull/1891#pullrequestreview-492610710", "createdAt": "2020-09-21T13:39:58Z", "commit": {"oid": "5518a4e077372468432ad4815ce349d7a5ff151b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzozOTo1OVrOHVQgZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzozOTo1OVrOHVQgZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1MjU4MQ==", "bodyText": "I'm not sure if this will justify its complexity. Firstly, setting the log level is going to be very rare, certainly rare enough for a volatile write. Secondly, I'd wager a bet that over 99% of users run on x86, where I don't think there's any benefit of getOpaque over get", "url": "https://github.com/DataDog/dd-trace-java/pull/1891#discussion_r492052581", "createdAt": "2020-09-21T13:39:59Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-logging/src/main/java/datadog/trace/logging/ddlogger/SwitchableLogLevelFactory.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package datadog.trace.logging.ddlogger;\n+\n+import datadog.trace.logging.LogLevel;\n+import datadog.trace.logging.LogLevelSwitcher;\n+import datadog.trace.logging.LoggerHelper;\n+import datadog.trace.logging.LoggerHelperFactory;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.util.concurrent.atomic.AtomicReference;\n+import org.slf4j.Marker;\n+\n+public final class SwitchableLogLevelFactory extends LoggerHelperFactory\n+    implements LogLevelSwitcher {\n+  private final LoggerHelperFactory delegate;\n+  private final AtomicReference<LogLevel> override;\n+\n+  public SwitchableLogLevelFactory(LoggerHelperFactory delegate) {\n+    this(new AtomicReference<LogLevel>(), delegate);\n+  }\n+\n+  public SwitchableLogLevelFactory(\n+      AtomicReference<LogLevel> override, LoggerHelperFactory delegate) {\n+    this.delegate = delegate;\n+    this.override = override;\n+  }\n+\n+  @Override\n+  public void switchLevel(LogLevel level) {\n+    Opaque.setLevel(override, level);\n+  }\n+\n+  @Override\n+  public void restore() {\n+    Opaque.setLevel(override, null);\n+  }\n+\n+  private static final class Opaque {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5518a4e077372468432ad4815ce349d7a5ff151b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNjEyNjQz", "url": "https://github.com/DataDog/dd-trace-java/pull/1891#pullrequestreview-492612643", "createdAt": "2020-09-21T13:41:52Z", "commit": {"oid": "5518a4e077372468432ad4815ce349d7a5ff151b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo0MTo1M1rOHVQmFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo0MTo1M1rOHVQmFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1NDAzNg==", "bodyText": "I think this could just be volatile LogLevel override without appreciable overhead, in fact it might be a little bit faster in the overwhelmingly common case (reads on x86) by removing indirection.", "url": "https://github.com/DataDog/dd-trace-java/pull/1891#discussion_r492054036", "createdAt": "2020-09-21T13:41:53Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/agent-logging/src/main/java/datadog/trace/logging/ddlogger/SwitchableLogLevelFactory.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package datadog.trace.logging.ddlogger;\n+\n+import datadog.trace.logging.LogLevel;\n+import datadog.trace.logging.LogLevelSwitcher;\n+import datadog.trace.logging.LoggerHelper;\n+import datadog.trace.logging.LoggerHelperFactory;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.util.concurrent.atomic.AtomicReference;\n+import org.slf4j.Marker;\n+\n+public final class SwitchableLogLevelFactory extends LoggerHelperFactory\n+    implements LogLevelSwitcher {\n+  private final LoggerHelperFactory delegate;\n+  private final AtomicReference<LogLevel> override;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5518a4e077372468432ad4815ce349d7a5ff151b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNjk1OTYy", "url": "https://github.com/DataDog/dd-trace-java/pull/1891#pullrequestreview-492695962", "createdAt": "2020-09-21T14:51:30Z", "commit": {"oid": "838d8a2a41081e8e6c024738d8e2ffb0e95b10c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzAwMDkx", "url": "https://github.com/DataDog/dd-trace-java/pull/1891#pullrequestreview-493300091", "createdAt": "2020-09-22T09:56:27Z", "commit": {"oid": "838d8a2a41081e8e6c024738d8e2ffb0e95b10c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7fd5396ab63fbe54ce7cb8a6d9bd138e35e9359", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a7fd5396ab63fbe54ce7cb8a6d9bd138e35e9359", "committedDate": "2020-09-22T14:14:25Z", "message": "Make it possible to switch log level during runtime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cfe4fe3ee824e7f658d3492a5043674464d8926", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8cfe4fe3ee824e7f658d3492a5043674464d8926", "committedDate": "2020-09-22T14:14:34Z", "message": "Simplification based on review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "838d8a2a41081e8e6c024738d8e2ffb0e95b10c0", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/838d8a2a41081e8e6c024738d8e2ffb0e95b10c0", "committedDate": "2020-09-21T14:20:55Z", "message": "Simplification based on review"}, "afterCommit": {"oid": "8cfe4fe3ee824e7f658d3492a5043674464d8926", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8cfe4fe3ee824e7f658d3492a5043674464d8926", "committedDate": "2020-09-22T14:14:34Z", "message": "Simplification based on review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3141, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}