{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NDMwMjUw", "number": 1777, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDowMToxMVrOEZDwng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNDo1MDoxOVrOEaA6Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzExNDU0OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/jdbc/src/main/java/datadog/trace/instrumentation/jdbc/PreparedStatementInstrumentation.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDowMToxMVrOHBqC4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjoxMjozNFrOHBvZZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5OTQ4OQ==", "bodyText": "@orekyuu This seems to be the only functional change. Can you better explain how this solves the problem?", "url": "https://github.com/DataDog/dd-trace-java/pull/1777#discussion_r471499489", "createdAt": "2020-08-17T14:01:11Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/jdbc/src/main/java/datadog/trace/instrumentation/jdbc/PreparedStatementInstrumentation.java", "diffHunk": "@@ -39,7 +40,8 @@ public PreparedStatementInstrumentation() {\n \n   @Override\n   public ElementMatcher<TypeDescription> typeMatcher() {\n-    return implementsInterface(named(\"java.sql.PreparedStatement\"));\n+    return implementsInterface(named(\"java.sql.PreparedStatement\"))\n+        .and(not(named(\"scalikejdbc.DBConnectionAttributesWiredPreparedStatement\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e650ea1dccb31cb2bb2773dafa3f7f669a6a9f5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNzkzMg==", "bodyText": "Before the change, the following was executed.\n\nCall prepareStatement method in scalikejdbc.DBSession#createStatementExecutor. (https://github.com/scalikejdbc/scalikejdbc/blob/3f24bdb57af36eeb2ea636710e8845773fad19f1/scalikejdbc-core/src/main/scala/scalikejdbc/DBSession.scala#L87 )\nIn JDBCMaps.preparedStatements, save SQL with raw PreparedStatement as key.\nDBSession wraps PreparedStatement with DBConnectionAttributesWiredPreparedStatement ( https://github.com/scalikejdbc/scalikejdbc/blob/3f24bdb57af36eeb2ea636710e8845773fad19f1/scalikejdbc-core/src/main/scala/scalikejdbc/DBSession.scala#L93 )\nGet SQL using JDBCConnectionAttributesWiredPreparedStatement from JDBCMaps.preparedStatements but no value exists.\n\nIgnoring the DBConnectionAttributesWiredPreparedStatement and using the raw PreparedStatement should work as expected. \ud83e\udd14", "url": "https://github.com/DataDog/dd-trace-java/pull/1777#discussion_r471537932", "createdAt": "2020-08-17T14:58:24Z", "author": {"login": "orekyuu"}, "path": "dd-java-agent/instrumentation/jdbc/src/main/java/datadog/trace/instrumentation/jdbc/PreparedStatementInstrumentation.java", "diffHunk": "@@ -39,7 +40,8 @@ public PreparedStatementInstrumentation() {\n \n   @Override\n   public ElementMatcher<TypeDescription> typeMatcher() {\n-    return implementsInterface(named(\"java.sql.PreparedStatement\"));\n+    return implementsInterface(named(\"java.sql.PreparedStatement\"))\n+        .and(not(named(\"scalikejdbc.DBConnectionAttributesWiredPreparedStatement\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5OTQ4OQ=="}, "originalCommit": {"oid": "3e650ea1dccb31cb2bb2773dafa3f7f669a6a9f5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3MDM2MQ==", "bodyText": "Ok, so ignoring the wrapped one allows the instrumentation to be properly applied on the \"underlying\" one?", "url": "https://github.com/DataDog/dd-trace-java/pull/1777#discussion_r471570361", "createdAt": "2020-08-17T15:46:16Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/jdbc/src/main/java/datadog/trace/instrumentation/jdbc/PreparedStatementInstrumentation.java", "diffHunk": "@@ -39,7 +40,8 @@ public PreparedStatementInstrumentation() {\n \n   @Override\n   public ElementMatcher<TypeDescription> typeMatcher() {\n-    return implementsInterface(named(\"java.sql.PreparedStatement\"));\n+    return implementsInterface(named(\"java.sql.PreparedStatement\"))\n+        .and(not(named(\"scalikejdbc.DBConnectionAttributesWiredPreparedStatement\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5OTQ4OQ=="}, "originalCommit": {"oid": "3e650ea1dccb31cb2bb2773dafa3f7f669a6a9f5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4NzE3NA==", "bodyText": "When JDBCConnectionAttributesWiredPreparedStatement#execute was called, span was recorded there. However, if JDBCConnectionAttributesWiredPreparedStatement is ignored, the span will be recorded by the execute of another PreparedStatement (for example, HikariProxyPreparedStatement), so it looks like the expected behavior.", "url": "https://github.com/DataDog/dd-trace-java/pull/1777#discussion_r471587174", "createdAt": "2020-08-17T16:12:34Z", "author": {"login": "orekyuu"}, "path": "dd-java-agent/instrumentation/jdbc/src/main/java/datadog/trace/instrumentation/jdbc/PreparedStatementInstrumentation.java", "diffHunk": "@@ -39,7 +40,8 @@ public PreparedStatementInstrumentation() {\n \n   @Override\n   public ElementMatcher<TypeDescription> typeMatcher() {\n-    return implementsInterface(named(\"java.sql.PreparedStatement\"));\n+    return implementsInterface(named(\"java.sql.PreparedStatement\"))\n+        .and(not(named(\"scalikejdbc.DBConnectionAttributesWiredPreparedStatement\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5OTQ4OQ=="}, "originalCommit": {"oid": "3e650ea1dccb31cb2bb2773dafa3f7f669a6a9f5"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NzEzMzA3OnYy", "diffSide": "RIGHT", "path": "settings.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNDo1MDoxOVrOHDLFog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNDo1MDoxOVrOHDLFog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4OTQ0Mg==", "bodyText": "One last request... please move this to :dd-java-agent:instrumentation:jdbc:scalikejdbc then we'll be good to go.", "url": "https://github.com/DataDog/dd-trace-java/pull/1777#discussion_r473089442", "createdAt": "2020-08-19T14:50:19Z", "author": {"login": "tylerbenson"}, "path": "settings.gradle", "diffHunk": "@@ -145,6 +145,7 @@ include ':dd-java-agent:instrumentation:reactor-core-3.1'\n include ':dd-java-agent:instrumentation:rmi'\n include ':dd-java-agent:instrumentation:rxjava-1'\n include ':dd-java-agent:instrumentation:scala-concurrent'\n+include ':dd-java-agent:instrumentation:scalikejdbc'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6936606b328fe0bfe962f2f9597af48003731140"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 31, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}