{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MjA5MjIw", "number": 1387, "title": "Rework servlet 2 to not wrap HttpServletResponse objects", "bodyText": "Some applications cast to their HttpServletResponse type without doing a type check for the wrapper type and unwrapping.", "createdAt": "2020-04-20T17:50:31Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1387", "merged": true, "mergeCommit": {"oid": "f908859442f0e488f5b5fa1860d0aa5568eed079"}, "closed": true, "closedAt": "2020-04-21T18:39:49Z", "author": {"login": "devinsba"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZjaNxABqjMyNTMwMzYwOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ4Dx2AFqTM5NzU3MDI3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "829b21baec0fd076a1d7ee94296e56c35eb6d61a", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/829b21baec0fd076a1d7ee94296e56c35eb6d61a", "committedDate": "2020-04-20T18:08:57Z", "message": "Test with working docker image"}, "afterCommit": {"oid": "9849dd7aea39839c289798c8ea376b9f221b4550", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9849dd7aea39839c289798c8ea376b9f221b4550", "committedDate": "2020-04-20T17:49:18Z", "message": "Rework servlet 2 to not wrap HttpServletResponse objects"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9849dd7aea39839c289798c8ea376b9f221b4550", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9849dd7aea39839c289798c8ea376b9f221b4550", "committedDate": "2020-04-20T17:49:18Z", "message": "Rework servlet 2 to not wrap HttpServletResponse objects"}, "afterCommit": {"oid": "88b9efe64f03efa202affe24b9743eed2811d40d", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/88b9efe64f03efa202affe24b9743eed2811d40d", "committedDate": "2020-04-20T18:29:36Z", "message": "Rework servlet 2 to not wrap HttpServletResponse objects"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NzQ2OTM5", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#pullrequestreview-396746939", "createdAt": "2020-04-20T19:26:42Z", "commit": {"oid": "5a6f455168c8beeb46dfa102514dbec87ad67e58"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxOToyNjo0MlrOGIkFEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxOToyOTozOFrOGIkL9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMjkxMw==", "bodyText": "Since you don't want to wrap it, can you instead instrument HttpServletResponse.setStatus (and other relevant methods) to capture the status in the contextStore directly instead of putting it into the request?", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411632913", "createdAt": "2020-04-20T19:26:42Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/servlet/request-2/src/main/java/datadog/trace/instrumentation/servlet2/Servlet2ResponseStatusInstrumentation.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package datadog.trace.instrumentation.servlet2;\n+\n+import static datadog.trace.agent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.DDElementMatchers.safeHasSuperType;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.HashMap;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public final class Servlet2ResponseStatusInstrumentation extends Instrumenter.Default {\n+  public Servlet2ResponseStatusInstrumentation() {\n+    super(\"servlet\", \"servlet-2\");\n+  }\n+\n+  // this is required to make sure servlet 2 instrumentation won't apply to servlet 3\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"javax.servlet.AsyncEvent\", \"javax.servlet.AsyncListener\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return safeHasSuperType(named(\"javax.servlet.http.HttpServletResponse\"));\n+  }\n+\n+  @Override\n+  public Map<String, String> contextStore() {\n+    return singletonMap(\n+        \"javax.servlet.http.HttpServletResponse\", \"javax.servlet.http.HttpServletRequest\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a6f455168c8beeb46dfa102514dbec87ad67e58"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzNDY3OQ==", "bodyText": "with the other change, this would likely need to be changed to just Integer and pass in the status code.", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411634679", "createdAt": "2020-04-20T19:29:38Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/servlet/request-2/src/main/java/datadog/trace/instrumentation/servlet2/Servlet2Decorator.java", "diffHunk": "@@ -50,11 +49,10 @@ protected Integer peerPort(final HttpServletRequest httpServletRequest) {\n   }\n \n   @Override\n-  protected Integer status(final ServletResponse httpServletResponse) {\n-    if (httpServletResponse instanceof StatusSavingHttpServletResponseWrapper) {\n-      return ((StatusSavingHttpServletResponseWrapper) httpServletResponse).status;\n+  protected Integer status(final HttpServletRequest httpServletRequest) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a6f455168c8beeb46dfa102514dbec87ad67e58"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2ODE0NTA0", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#pullrequestreview-396814504", "createdAt": "2020-04-20T21:09:15Z", "commit": {"oid": "5a6f455168c8beeb46dfa102514dbec87ad67e58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMTowOToxNVrOGInzBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMTowOToxNVrOGInzBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY5MzgzMA==", "bodyText": "I'm assuming HttpServletResponse.SC_OK is typed as int, but this did look strange at first.\nLittle known Java detail starting in Java 7, you can cast from Object directly to int.  That might make this a bit more clear.\nif ( (int)request.getAttribute(\"dd.http-status\") == HttpServletResponse.SC_OK ) { ... }", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411693830", "createdAt": "2020-04-20T21:09:15Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/instrumentation/servlet/request-2/src/main/java/datadog/trace/instrumentation/servlet2/Servlet2Advice.java", "diffHunk": "@@ -89,11 +87,11 @@ public static void stopSpan(\n       return;\n     }\n     final AgentSpan span = scope.span();\n-    DECORATE.onResponse(span, response);\n+    if (request instanceof HttpServletRequest) {\n+      DECORATE.onResponse(span, (HttpServletRequest) request);\n+    }\n     if (throwable != null) {\n-      if (response instanceof StatusSavingHttpServletResponseWrapper\n-          && ((StatusSavingHttpServletResponseWrapper) response).status\n-              == HttpServletResponse.SC_OK) {\n+      if ((Integer) request.getAttribute(\"dd.http-status\") == HttpServletResponse.SC_OK) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a6f455168c8beeb46dfa102514dbec87ad67e58"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94750a83c9b164d9b787c2358209e12f9392ae18", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/94750a83c9b164d9b787c2358209e12f9392ae18", "committedDate": "2020-04-21T13:59:12Z", "message": "Rework servlet 2 to not wrap HttpServletResponse objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc43f3f54c5b0ed2f074d2052549f87047bd3b7a", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/dc43f3f54c5b0ed2f074d2052549f87047bd3b7a", "committedDate": "2020-04-21T13:59:12Z", "message": "We don't depend on a 2.3 type anymore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aec2fad9db6f78775f7e10ed17d96b87bcd7ce67", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/aec2fad9db6f78775f7e10ed17d96b87bcd7ce67", "committedDate": "2020-04-21T13:59:12Z", "message": "Use the parent interface"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03c3fc0846b9920482eb94304d4953ce4891283c", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/03c3fc0846b9920482eb94304d4953ce4891283c", "committedDate": "2020-04-20T22:19:42Z", "message": "Use the parent interface"}, "afterCommit": {"oid": "aec2fad9db6f78775f7e10ed17d96b87bcd7ce67", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/aec2fad9db6f78775f7e10ed17d96b87bcd7ce67", "committedDate": "2020-04-21T13:59:12Z", "message": "Use the parent interface"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTcwMjc1", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#pullrequestreview-397570275", "createdAt": "2020-04-21T18:33:00Z", "commit": {"oid": "aec2fad9db6f78775f7e10ed17d96b87bcd7ce67"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2423, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}