{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyODQ3NTU1", "number": 1173, "title": "Synchronized audit: WeakMap computeIfAbsent", "bodyText": "As part of the audit of synchronized blocks, I noticed a repeated pattern around WeakMap caches:\nsynchronized (cache) {\n  value = cache.get(key);\n  if (value == null) {\n    value = .......\n    cache.put(key, value);\n  }\n  return value;\n}\nWe had getOrCreate() but ValueSupplier.get() didn't take the key as an argument.  This pull request:\n\nRenames getOrCreate() to computeIfAbsent() (the Java 8 name for this method)\nChanges ValueSupplier.get() to take a key\nSimplifies the code wherever this pattern was used\n\nIn the future, adjusting or improving WeakMap locking will benefit all callers.\nAdditionally, I removed the unused ClassLoaderMatchers of classLaderHasClassWithMethod and classLoaderHasClassWithField", "createdAt": "2020-01-14T21:28:32Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1173", "merged": true, "mergeCommit": {"oid": "6766e12597330a9d0db91aacd90eec289f49af5f"}, "closed": true, "closedAt": "2020-01-15T19:51:30Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6n_degFqTM0MzM0MzAzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6q7FSgFqTM0MzQ3Mzg5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMzQzMDM5", "url": "https://github.com/DataDog/dd-trace-java/pull/1173#pullrequestreview-343343039", "createdAt": "2020-01-15T16:18:08Z", "commit": {"oid": "9bbe9de320b68dbba663644d4a2744fdf70785f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjoxODowOVrOFd-DIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjoxODowOVrOFd-DIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk2OTYzMg==", "bodyText": "What is the benefit in having this class (and others in this PR) implement the ValueSupplier interface when they didn't previously?  Not really understanding the motivation for this change.", "url": "https://github.com/DataDog/dd-trace-java/pull/1173#discussion_r366969632", "createdAt": "2020-01-15T16:18:09Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/DDCachingPoolStrategy.java", "diffHunk": "@@ -28,7 +29,13 @@\n  *\n  * <p>See eviction policy below.\n  */\n-public class DDCachingPoolStrategy implements PoolStrategy {\n+public class DDCachingPoolStrategy\n+    implements PoolStrategy, WeakMap.ValueSupplier<ClassLoader, TypePool.CacheProvider> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bbe9de320b68dbba663644d4a2744fdf70785f4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0b1cd4a75c8c6448a75a582f1dec48354ff7510", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a0b1cd4a75c8c6448a75a582f1dec48354ff7510", "committedDate": "2020-01-15T17:26:15Z", "message": "WeakMap computeIfAbsent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68ed1da9c61f7c457bd42182b86c7ca92a161be4", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/68ed1da9c61f7c457bd42182b86c7ca92a161be4", "committedDate": "2020-01-15T17:41:01Z", "message": "Don't call `map.get()` in the `put(..)` case"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9bbe9de320b68dbba663644d4a2744fdf70785f4", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9bbe9de320b68dbba663644d4a2744fdf70785f4", "committedDate": "2020-01-14T21:06:07Z", "message": "WeakMap computeIfAbsent"}, "afterCommit": {"oid": "68ed1da9c61f7c457bd42182b86c7ca92a161be4", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/68ed1da9c61f7c457bd42182b86c7ca92a161be4", "committedDate": "2020-01-15T17:41:01Z", "message": "Don't call `map.get()` in the `put(..)` case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNDcwMzUx", "url": "https://github.com/DataDog/dd-trace-java/pull/1173#pullrequestreview-343470351", "createdAt": "2020-01-15T19:37:19Z", "commit": {"oid": "68ed1da9c61f7c457bd42182b86c7ca92a161be4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxOTozNzoyMFrOFeEDuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxOTozNzoyMFrOFeEDuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA2ODA4OA==", "bodyText": "These are what we had to use before muzzle...  I assume they're no longer used anywhere?", "url": "https://github.com/DataDog/dd-trace-java/pull/1173#discussion_r367068088", "createdAt": "2020-01-15T19:37:20Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/ClassLoaderMatcher.java", "diffHunk": "@@ -30,18 +30,9 @@ private ClassLoaderMatcher() {\n     return new ClassLoaderHasClassMatcher(names);\n   }\n \n-  public static ElementMatcher.Junction.AbstractBase<ClassLoader> classLoaderHasClassWithField(\n-      final String className, final String fieldName) {\n-    return new ClassLoaderHasClassWithFieldMatcher(className, fieldName);\n-  }\n-\n-  public static ElementMatcher.Junction.AbstractBase<ClassLoader> classLoaderHasClassWithMethod(\n-      final String className, final String methodName, final String... methodArgs) {\n-    return new ClassLoaderHasClassWithMethodMatcher(className, methodName, methodArgs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68ed1da9c61f7c457bd42182b86c7ca92a161be4"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNDczODkz", "url": "https://github.com/DataDog/dd-trace-java/pull/1173#pullrequestreview-343473893", "createdAt": "2020-01-15T19:43:05Z", "commit": {"oid": "68ed1da9c61f7c457bd42182b86c7ca92a161be4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2675, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}