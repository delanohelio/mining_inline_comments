{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyODM2NTc4", "number": 1850, "title": "Enable OpenTracing to inherit the async propagation from enclosing scope", "bodyText": "This is a real issue where a customer is using OT in an async application and it breaks up the customers spans.", "createdAt": "2020-09-09T13:15:46Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1850", "merged": true, "mergeCommit": {"oid": "8fd3b818c177a25c729ac70b0ec60f2392bcbca7"}, "closed": true, "closedAt": "2020-09-29T13:55:35Z", "author": {"login": "bantonsson"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHM4RnAFqTQ4NTA1NDk1MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNocOcgFqTQ5ODQ4NTQ2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MDU0OTUx", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#pullrequestreview-485054951", "createdAt": "2020-09-09T14:15:01Z", "commit": {"oid": "9b853ac6458e7c2541d25f15ef0050d3c2038a33"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNDoxNTowMVrOHPJgaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNDoxNTowMVrOHPJgaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NjQ0MQ==", "bodyText": "do we even CAS this anywhere? Can it be volatile boolean?", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#discussion_r485646441", "createdAt": "2020-09-09T14:15:01Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -124,7 +133,7 @@ protected ScopeStack scopeStack() {\n     /** Continuation that created this scope. May be null. */\n     private final ContinuableScopeManager.Continuation continuation;\n     /** Flag to propagate this scope across async boundaries. */\n-    private final AtomicBoolean isAsyncPropagating = new AtomicBoolean(false);\n+    private final AtomicBoolean isAsyncPropagating;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b853ac6458e7c2541d25f15ef0050d3c2038a33"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "832b20a6a5e0a8636886b0b065a40c94f1cf6194", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/832b20a6a5e0a8636886b0b065a40c94f1cf6194", "committedDate": "2020-09-10T06:49:57Z", "message": "Make instrumentations be explicit about async propagation"}, "afterCommit": {"oid": "5d6fcd3e02f8e277f986e69a77d28ee96e202ec7", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5d6fcd3e02f8e277f986e69a77d28ee96e202ec7", "committedDate": "2020-09-10T09:09:56Z", "message": "Inherit async propagation from active scope for OT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d6fcd3e02f8e277f986e69a77d28ee96e202ec7", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5d6fcd3e02f8e277f986e69a77d28ee96e202ec7", "committedDate": "2020-09-10T09:09:56Z", "message": "Inherit async propagation from active scope for OT"}, "afterCommit": {"oid": "bdd8b9a0aac473563384a03334c7cf443ea7f206", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bdd8b9a0aac473563384a03334c7cf443ea7f206", "committedDate": "2020-09-10T09:49:43Z", "message": "Inherit async propagation from active scope for OT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdd8b9a0aac473563384a03334c7cf443ea7f206", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bdd8b9a0aac473563384a03334c7cf443ea7f206", "committedDate": "2020-09-10T09:49:43Z", "message": "Inherit async propagation from active scope for OT"}, "afterCommit": {"oid": "a817fc0ba3195901cf9fe6deae419a7a64850f47", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a817fc0ba3195901cf9fe6deae419a7a64850f47", "committedDate": "2020-09-10T10:37:21Z", "message": "Inherit async propagation from active scope for OT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a817fc0ba3195901cf9fe6deae419a7a64850f47", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a817fc0ba3195901cf9fe6deae419a7a64850f47", "committedDate": "2020-09-10T10:37:21Z", "message": "Inherit async propagation from active scope for OT"}, "afterCommit": {"oid": "525b3f7c8c4ad37eb080a776cedc2685e20f0769", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/525b3f7c8c4ad37eb080a776cedc2685e20f0769", "committedDate": "2020-09-14T13:33:20Z", "message": "Make all scope activation inherit async propagation by default"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "525b3f7c8c4ad37eb080a776cedc2685e20f0769", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/525b3f7c8c4ad37eb080a776cedc2685e20f0769", "committedDate": "2020-09-14T13:33:20Z", "message": "Make all scope activation inherit async propagation by default"}, "afterCommit": {"oid": "86da37f3227b4891d6dfac3aa9ebb9bcad20fbe6", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/86da37f3227b4891d6dfac3aa9ebb9bcad20fbe6", "committedDate": "2020-09-14T12:06:02Z", "message": "Inherit async propagation from active scope for OT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86da37f3227b4891d6dfac3aa9ebb9bcad20fbe6", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/86da37f3227b4891d6dfac3aa9ebb9bcad20fbe6", "committedDate": "2020-09-14T12:06:02Z", "message": "Inherit async propagation from active scope for OT"}, "afterCommit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54", "committedDate": "2020-09-28T15:56:27Z", "message": "Inherit async propagation from active scope for OT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzI0Mjkz", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#pullrequestreview-497724293", "createdAt": "2020-09-28T16:57:05Z", "commit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1NzowNVrOHZHapA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1NzowNVrOHZHapA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5Nzk1Ng==", "bodyText": "I hate the convention of adding final to all parameters - I find it adds it adds at least six characters of noise to every line - but I don't like the inconsistency here either, and because some people use an IDE plugin which applies rules on file save this will result in style diffs when they change this file.", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#discussion_r496097956", "createdAt": "2020-09-28T16:57:05Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -87,12 +106,40 @@ public AgentScope activate(final AgentSpan span, final ScopeSource source) {\n       return AgentTracer.NoopAgentScope.INSTANCE;\n     }\n \n-    return handleSpan(null, span, source);\n+    return handleSpan(\n+        inheritAsyncPropagation ? active : null,\n+        null,\n+        span,\n+        source,\n+        overrideAsyncPropagation,\n+        isAsyncPropagating);\n   }\n \n   private ContinuableScope handleSpan(\n-      final Continuation continuation, final AgentSpan span, final ScopeSource source) {\n-    final ContinuableScope scope = new ContinuableScope(this, continuation, span, source);\n+      final Continuation continuation,\n+      final AgentSpan span,\n+      final ScopeSource source,\n+      boolean overrideAsyncPropagation,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzI0ODQ1", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#pullrequestreview-497724845", "createdAt": "2020-09-28T16:57:23Z", "commit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1NzoyM1rOHZHbYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1NzoyM1rOHZHbYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5ODE0NA==", "bodyText": "\ud83e\udd47", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#discussion_r496098144", "createdAt": "2020-09-28T16:57:23Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -124,7 +171,7 @@ protected ScopeStack scopeStack() {\n     /** Continuation that created this scope. May be null. */\n     private final ContinuableScopeManager.Continuation continuation;\n     /** Flag to propagate this scope across async boundaries. */\n-    private final AtomicBoolean isAsyncPropagating = new AtomicBoolean(false);\n+    private volatile boolean isAsyncPropagating;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzI3MTMy", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#pullrequestreview-497727132", "createdAt": "2020-09-28T16:59:13Z", "commit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1OToxM1rOHZHhYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1OToxM1rOHZHhYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTY4MA==", "bodyText": "What do true and false correspond to here? I know I can go and look at the signature but it's a context switch. Can we hoist them out into named variables to make the code self-documenting?", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#discussion_r496099680", "createdAt": "2020-09-28T16:59:13Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -337,13 +386,13 @@ private Continuation register() {\n     @Override\n     public AgentScope activate() {\n       if (used.compareAndSet(false, true)) {\n-        final AgentScope scope = scopeManager.handleSpan(this, spanUnderScope, source);\n+        final AgentScope scope = scopeManager.handleSpan(this, spanUnderScope, source, true, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzI3NjUw", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#pullrequestreview-497727650", "createdAt": "2020-09-28T16:59:53Z", "commit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "914720f60d34c16a511704f87c9463a550185f25", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/914720f60d34c16a511704f87c9463a550185f25", "committedDate": "2020-09-29T07:48:36Z", "message": "Inherit async propagation from active scope for OT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/541ae4a998e8dc6219a2cd2e5c6aa5d8e3e5fa54", "committedDate": "2020-09-28T15:56:27Z", "message": "Inherit async propagation from active scope for OT"}, "afterCommit": {"oid": "914720f60d34c16a511704f87c9463a550185f25", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/914720f60d34c16a511704f87c9463a550185f25", "committedDate": "2020-09-29T07:48:36Z", "message": "Inherit async propagation from active scope for OT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NDg1NDY0", "url": "https://github.com/DataDog/dd-trace-java/pull/1850#pullrequestreview-498485464", "createdAt": "2020-09-29T13:45:17Z", "commit": {"oid": "914720f60d34c16a511704f87c9463a550185f25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3092, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}