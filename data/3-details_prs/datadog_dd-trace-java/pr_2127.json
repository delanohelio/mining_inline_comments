{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NTQyNjY2", "number": 2127, "title": "remove representative count tracking, and tie trace agent rate limiting to actual trace count ", "bodyText": "We go to great lengths to track the number of traces dropped in order to maintain a \"representative count\" which we send to the trace agent as an HTTP header... where it apparently serves no purpose! This PR removes this and results in simpler code, and we lose an atomic. We report dropped traces via statsd anyway.\n/cc @gbbr", "createdAt": "2020-11-27T10:55:51Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2127", "merged": true, "mergeCommit": {"oid": "55e6d3ea183ac996d53abb94ac296acb665585a5"}, "closed": true, "closedAt": "2020-11-30T17:44:19Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdglkoxgFqTUzOTg5NjgzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdho1VwAFqTU0MTEzNDg4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODk2ODMw", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#pullrequestreview-539896830", "createdAt": "2020-11-27T11:09:18Z", "commit": {"oid": "b0e90e9ba36edcaad415e36a2a354f5edcc3536c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMTowOToxOFrOH66ZnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMTowOToxOFrOH66ZnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUzNjI4NQ==", "bodyText": "tweak the log message to be \"{}. Dropping trace: {}\" if we're no longer counting them?", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#discussion_r531536285", "createdAt": "2020-11-27T11:09:18Z", "author": {"login": "mcculls"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/DDAgentWriter.java", "diffHunk": "@@ -143,14 +143,12 @@ public void write(final List<DDSpan> trace) {\n   }\n \n   private void handleDroppedTrace(final String reason, final List<DDSpan> trace) {\n-    incrementTraceCount();\n     log.debug(\"{}. Counted but dropping trace: {}\", reason, trace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0e90e9ba36edcaad415e36a2a354f5edcc3536c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODk3MjMz", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#pullrequestreview-539897233", "createdAt": "2020-11-27T11:09:58Z", "commit": {"oid": "b0e90e9ba36edcaad415e36a2a354f5edcc3536c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMTowOTo1OVrOH66a8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMTowOTo1OVrOH66a8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUzNjYyNg==", "bodyText": "as above, tweak log message to reflect we're not counting dropped traces any more", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#discussion_r531536626", "createdAt": "2020-11-27T11:09:59Z", "author": {"login": "mcculls"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/DDAgentWriter.java", "diffHunk": "@@ -143,14 +143,12 @@ public void write(final List<DDSpan> trace) {\n   }\n \n   private void handleDroppedTrace(final String reason, final List<DDSpan> trace) {\n-    incrementTraceCount();\n     log.debug(\"{}. Counted but dropping trace: {}\", reason, trace);\n     healthMetrics.onFailedPublish(UNSET);\n   }\n \n   private void handleDroppedTrace(\n       final String reason, final List<DDSpan> trace, final int samplingPriority) {\n-    incrementTraceCount();\n     log.debug(\"{}. Counted but dropping trace: {}\", reason, trace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0e90e9ba36edcaad415e36a2a354f5edcc3536c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c0c7c9d9c6a5460193b8840e182127a9c96387c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7c0c7c9d9c6a5460193b8840e182127a9c96387c", "committedDate": "2020-11-27T11:13:39Z", "message": "remove representative count tracking"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0e90e9ba36edcaad415e36a2a354f5edcc3536c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b0e90e9ba36edcaad415e36a2a354f5edcc3536c", "committedDate": "2020-11-27T10:53:15Z", "message": "remove representative count tracking"}, "afterCommit": {"oid": "7c0c7c9d9c6a5460193b8840e182127a9c96387c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7c0c7c9d9c6a5460193b8840e182127a9c96387c", "committedDate": "2020-11-27T11:13:39Z", "message": "remove representative count tracking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5OTA0NjI3", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#pullrequestreview-539904627", "createdAt": "2020-11-27T11:22:24Z", "commit": {"oid": "7c0c7c9d9c6a5460193b8840e182127a9c96387c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5OTkyMDg0", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#pullrequestreview-539992084", "createdAt": "2020-11-27T13:47:16Z", "commit": {"oid": "7c0c7c9d9c6a5460193b8840e182127a9c96387c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjU2MzMx", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#pullrequestreview-540656331", "createdAt": "2020-11-30T07:40:43Z", "commit": {"oid": "7c0c7c9d9c6a5460193b8840e182127a9c96387c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzo0MDo0NFrOH7u3iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzo0MDo0NFrOH7u3iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM5NTkxMw==", "bodyText": "Not \"LoggingWritier\" anymore?", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#discussion_r532395913", "createdAt": "2020-11-30T07:40:44Z", "author": {"login": "lpriima"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/LoggingWriter.java", "diffHunk": "@@ -49,6 +44,9 @@ public void close() {\n     log.info(\"close()\");\n   }\n \n+  @Override\n+  public void incrementTraceCount() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c0c7c9d9c6a5460193b8840e182127a9c96387c"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTM0ODg5", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#pullrequestreview-541134889", "createdAt": "2020-11-30T17:30:19Z", "commit": {"oid": "7c0c7c9d9c6a5460193b8840e182127a9c96387c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozMDoxOVrOH8F3Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozMDoxOVrOH8F3Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3MjYzMQ==", "bodyText": "Since these are now no-ops, I suggest we should either keep the API calls or remove the method entirely.", "url": "https://github.com/DataDog/dd-trace-java/pull/2127#discussion_r532772631", "createdAt": "2020-11-30T17:30:19Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/DDAgentWriter.java", "diffHunk": "@@ -143,14 +143,12 @@ public void write(final List<DDSpan> trace) {\n   }\n \n   private void handleDroppedTrace(final String reason, final List<DDSpan> trace) {\n-    incrementTraceCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c0c7c9d9c6a5460193b8840e182127a9c96387c"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2880, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}