{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MTk4NDU5", "number": 2021, "title": "pass executed Runnables through AbstractExecutorService.newTaskFor to get free context propagation", "bodyText": "This will work for any subclass of AbstractExecutorService and makes the RunnableInstrumentation otherwise unnecessary once Kotlin coroutines are moved out of this module.", "createdAt": "2020-10-22T10:50:25Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2021", "merged": true, "mergeCommit": {"oid": "e3ba4ba4b0ba0261aa0d852b4be6045e61200e4e"}, "closed": true, "closedAt": "2020-10-23T06:57:11Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVAQEoABqjM5MDg1NDgwMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVIb3FgFqTUxNTEwMjE2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d58415b8dc443a1c8cc9003d168e37b0c2ed8683", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d58415b8dc443a1c8cc9003d168e37b0c2ed8683", "committedDate": "2020-10-22T10:49:11Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "e4d1a8feaa70c20967ac9dc69d59e8d242cc4928", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e4d1a8feaa70c20967ac9dc69d59e8d242cc4928", "committedDate": "2020-10-22T11:26:59Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4d1a8feaa70c20967ac9dc69d59e8d242cc4928", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e4d1a8feaa70c20967ac9dc69d59e8d242cc4928", "committedDate": "2020-10-22T11:26:59Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "bfd7f28677733623a72e7dc3403d15259b44d970", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bfd7f28677733623a72e7dc3403d15259b44d970", "committedDate": "2020-10-22T11:41:20Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bfd7f28677733623a72e7dc3403d15259b44d970", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bfd7f28677733623a72e7dc3403d15259b44d970", "committedDate": "2020-10-22T11:41:20Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "e182673e9a4c23a60eccd15a8370a7b1c44b6748", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e182673e9a4c23a60eccd15a8370a7b1c44b6748", "committedDate": "2020-10-22T12:27:10Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e182673e9a4c23a60eccd15a8370a7b1c44b6748", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e182673e9a4c23a60eccd15a8370a7b1c44b6748", "committedDate": "2020-10-22T12:27:10Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "577040a459fca81bc29073c210e62fbec2d5b95d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/577040a459fca81bc29073c210e62fbec2d5b95d", "committedDate": "2020-10-22T13:56:36Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "577040a459fca81bc29073c210e62fbec2d5b95d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/577040a459fca81bc29073c210e62fbec2d5b95d", "committedDate": "2020-10-22T13:56:36Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "e9889de877b2e1895830079e7901421e6bbcc3fe", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e9889de877b2e1895830079e7901421e6bbcc3fe", "committedDate": "2020-10-22T14:59:44Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9889de877b2e1895830079e7901421e6bbcc3fe", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e9889de877b2e1895830079e7901421e6bbcc3fe", "committedDate": "2020-10-22T14:59:44Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8db05f62bd6e11536febcf5d6c912abaa480a8c3", "committedDate": "2020-10-22T15:29:46Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODc5MDk1", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#pullrequestreview-514879095", "createdAt": "2020-10-22T15:52:58Z", "commit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo1Mjo1OFrOHmonhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo1Mjo1OFrOHmonhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MzQxMg==", "bodyText": "Excellent!", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#discussion_r510273412", "createdAt": "2020-10-22T15:52:58Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/WrapRunnableAsNewTaskInstrumentation.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package datadog.trace.instrumentation.java.concurrent;\n+\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.NameMatchers.namedOneOf;\n+import static datadog.trace.instrumentation.java.concurrent.NewTaskFor.newTaskFor;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.Map;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.RunnableFuture;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import net.bytebuddy.matcher.ElementMatchers;\n+\n+@AutoService(Instrumenter.class)\n+public final class WrapRunnableAsNewTaskInstrumentation extends Instrumenter.Default {\n+  public WrapRunnableAsNewTaskInstrumentation() {\n+    super(\"java_concurrent\", \"new-task-for\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return namedOneOf(\n+        \"io.netty.channel.epoll.EpollEventLoop\",\n+        \"io.netty.channel.epoll.EpollEventLoopGroup\",\n+        \"io.netty.channel.MultithreadEventLoopGroup\",\n+        \"io.netty.channel.nio.NioEventLoop\",\n+        \"io.netty.channel.nio.NioEventLoopGroup\",\n+        \"io.netty.channel.SingleThreadEventLoop\",\n+        \"io.netty.util.concurrent.AbstractEventExecutor\",\n+        \"io.netty.util.concurrent.AbstractEventExecutorGroup\",\n+        \"io.netty.util.concurrent.AbstractScheduledEventExecutor\",\n+        \"io.netty.util.concurrent.DefaultEventExecutor\",\n+        \"io.netty.util.concurrent.DefaultEventExecutorGroup\",\n+        \"io.netty.util.concurrent.GlobalEventExecutor\",\n+        \"io.netty.util.concurrent.MultithreadEventExecutorGroup\",\n+        \"io.netty.util.concurrent.SingleThreadEventExecutor\",\n+        \"java.util.concurrent.AbstractExecutorService\",\n+        \"java.util.concurrent.CompletableFuture$ThreadPerTaskExecutor\",\n+        \"java.util.concurrent.SubmissionPublisher$ThreadPerTaskExecutor\",\n+        \"java.util.concurrent.ThreadPoolExecutor\",\n+        \"org.glassfish.grizzly.threadpool.GrizzlyExecutorService\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {packageName + \".NewTaskFor\"};\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        isMethod()\n+            .and(\n+                named(\"execute\")\n+                    .and(ElementMatchers.takesArgument(0, named(Runnable.class.getName())))),\n+        getClass().getName() + \"$Wrap\");\n+  }\n+\n+  public static final class Wrap {\n+    @Advice.OnMethodEnter\n+    public static void execute(\n+        @Advice.This Executor executor,\n+        @Advice.Argument(value = 0, readOnly = false) Runnable task) {\n+      task = newTaskFor(executor, task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODg0NTE2", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#pullrequestreview-514884516", "createdAt": "2020-10-22T15:58:25Z", "commit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo1ODoyNVrOHmo3cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo1ODoyNVrOHmo3cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3NzQ4OQ==", "bodyText": "Returning the favor, this looks like the same pattern that you suggested ClassValue for", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#discussion_r510277489", "createdAt": "2020-10-22T15:58:25Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/NewTaskFor.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package datadog.trace.instrumentation.java.concurrent;\n+\n+import static datadog.trace.bootstrap.instrumentation.java.concurrent.ExcludeFilter.ExcludeType.RUNNABLE;\n+import static datadog.trace.bootstrap.instrumentation.java.concurrent.ExcludeFilter.exclude;\n+\n+import java.lang.reflect.Method;\n+import java.util.concurrent.AbstractExecutorService;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.FutureTask;\n+import java.util.concurrent.RunnableFuture;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public final class NewTaskFor {\n+\n+  private static final Method NEW_TASK_FOR_RUNNABLE = lookupNewTaskForRunnable();\n+\n+  @SuppressWarnings(\"unchecked\")\n+  public static Runnable newTaskFor(Executor executor, Runnable runnable) {\n+    // TODO write a slick instrumentation and instrument these types directly\n+    if (runnable instanceof RunnableFuture\n+        || exclude(RUNNABLE, runnable)\n+        || runnable.getClass().getName().startsWith(\"slick.\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODg3MDcw", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#pullrequestreview-514887070", "createdAt": "2020-10-22T16:01:04Z", "commit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjowMTowNFrOHmo_WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjowMTowNFrOHmo_WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3OTUxMg==", "bodyText": "getDeclaredMethod and setAccessible can also throw SecurityException so I'd include that in the catch", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#discussion_r510279512", "createdAt": "2020-10-22T16:01:04Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/NewTaskFor.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package datadog.trace.instrumentation.java.concurrent;\n+\n+import static datadog.trace.bootstrap.instrumentation.java.concurrent.ExcludeFilter.ExcludeType.RUNNABLE;\n+import static datadog.trace.bootstrap.instrumentation.java.concurrent.ExcludeFilter.exclude;\n+\n+import java.lang.reflect.Method;\n+import java.util.concurrent.AbstractExecutorService;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.FutureTask;\n+import java.util.concurrent.RunnableFuture;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public final class NewTaskFor {\n+\n+  private static final Method NEW_TASK_FOR_RUNNABLE = lookupNewTaskForRunnable();\n+\n+  @SuppressWarnings(\"unchecked\")\n+  public static Runnable newTaskFor(Executor executor, Runnable runnable) {\n+    // TODO write a slick instrumentation and instrument these types directly\n+    if (runnable instanceof RunnableFuture\n+        || exclude(RUNNABLE, runnable)\n+        || runnable.getClass().getName().startsWith(\"slick.\")) {\n+      return runnable;\n+    }\n+    if (null != NEW_TASK_FOR_RUNNABLE && executor instanceof AbstractExecutorService) {\n+      try {\n+        return (RunnableFuture<Void>) NEW_TASK_FOR_RUNNABLE.invoke(executor, runnable, null);\n+      } catch (Throwable t) {\n+        log.debug(\"failed to invoke newTaskFor on {}\", executor, t);\n+      }\n+    }\n+    return new FutureTask<>(runnable, null);\n+  }\n+\n+  private static Method lookupNewTaskForRunnable() {\n+    try {\n+      Method newTaskFor =\n+          AbstractExecutorService.class.getDeclaredMethod(\n+              \"newTaskFor\", Runnable.class, Object.class);\n+      newTaskFor.setAccessible(true);\n+      return newTaskFor;\n+    } catch (NoSuchMethodException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODg5NTk2", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#pullrequestreview-514889596", "createdAt": "2020-10-22T16:03:45Z", "commit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8db05f62bd6e11536febcf5d6c912abaa480a8c3", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8db05f62bd6e11536febcf5d6c912abaa480a8c3", "committedDate": "2020-10-22T15:29:46Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "20d65da5cb280c34ef31627561160883c6a32cc1", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/20d65da5cb280c34ef31627561160883c6a32cc1", "committedDate": "2020-10-22T16:09:15Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20d65da5cb280c34ef31627561160883c6a32cc1", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/20d65da5cb280c34ef31627561160883c6a32cc1", "committedDate": "2020-10-22T16:09:15Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "fb45dc21105146a489f7fe23dd6f7ccd543c73e7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fb45dc21105146a489f7fe23dd6f7ccd543c73e7", "committedDate": "2020-10-22T16:43:46Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb45dc21105146a489f7fe23dd6f7ccd543c73e7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fb45dc21105146a489f7fe23dd6f7ccd543c73e7", "committedDate": "2020-10-22T16:43:46Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "de02353661ea32ca4d0e7298ca17c6977958fd88", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/de02353661ea32ca4d0e7298ca17c6977958fd88", "committedDate": "2020-10-22T17:34:05Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca78561ec061a839207cb37b8f01a91ac58809c6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ca78561ec061a839207cb37b8f01a91ac58809c6", "committedDate": "2020-10-22T18:23:23Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de02353661ea32ca4d0e7298ca17c6977958fd88", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/de02353661ea32ca4d0e7298ca17c6977958fd88", "committedDate": "2020-10-22T17:34:05Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}, "afterCommit": {"oid": "ca78561ec061a839207cb37b8f01a91ac58809c6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ca78561ec061a839207cb37b8f01a91ac58809c6", "committedDate": "2020-10-22T18:23:23Z", "message": "wrap executed Runnables in FutureTask to get free context-propagation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDgyMDgz", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#pullrequestreview-515082083", "createdAt": "2020-10-22T20:11:42Z", "commit": {"oid": "ca78561ec061a839207cb37b8f01a91ac58809c6"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoxMTo0MlrOHmyEiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoxNDowNlrOHmyJyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyODI5Nw==", "bodyText": "I'm having a hard time understanding when to use Method and when to use Method Handles.  Why use one over the other?", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#discussion_r510428297", "createdAt": "2020-10-22T20:11:42Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/NewTaskFor.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package datadog.trace.instrumentation.java.concurrent;\n+\n+import static datadog.trace.bootstrap.instrumentation.java.concurrent.ExcludeFilter.ExcludeType.RUNNABLE;\n+import static datadog.trace.bootstrap.instrumentation.java.concurrent.ExcludeFilter.exclude;\n+\n+import java.lang.reflect.Method;\n+import java.util.concurrent.AbstractExecutorService;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.FutureTask;\n+import java.util.concurrent.RunnableFuture;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public final class NewTaskFor {\n+\n+  private static final boolean SAFE_TO_PROPAGATE;\n+  private static final Method NEW_TASK_FOR_RUNNABLE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca78561ec061a839207cb37b8f01a91ac58809c6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyOTY0MQ==", "bodyText": "Ah, I think I get it... Here you must use reflection because newTaskFor is not accessible, so you can't use Method Handles or call it directly.", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#discussion_r510429641", "createdAt": "2020-10-22T20:14:06Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/NewTaskFor.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package datadog.trace.instrumentation.java.concurrent;\n+\n+import static datadog.trace.bootstrap.instrumentation.java.concurrent.ExcludeFilter.ExcludeType.RUNNABLE;\n+import static datadog.trace.bootstrap.instrumentation.java.concurrent.ExcludeFilter.exclude;\n+\n+import java.lang.reflect.Method;\n+import java.util.concurrent.AbstractExecutorService;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.FutureTask;\n+import java.util.concurrent.RunnableFuture;\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+public final class NewTaskFor {\n+\n+  private static final boolean SAFE_TO_PROPAGATE;\n+  private static final Method NEW_TASK_FOR_RUNNABLE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyODI5Nw=="}, "originalCommit": {"oid": "ca78561ec061a839207cb37b8f01a91ac58809c6"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTAyMTY2", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#pullrequestreview-515102166", "createdAt": "2020-10-22T20:41:15Z", "commit": {"oid": "ca78561ec061a839207cb37b8f01a91ac58809c6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0MToxNVrOHmzAtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo1ODo1MlrOHmzl1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MzcwMA==", "bodyText": "I think a class comment describing the benefits of this approach would be useful for posterity.", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#discussion_r510443700", "createdAt": "2020-10-22T20:41:15Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/WrapRunnableAsNewTaskInstrumentation.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package datadog.trace.instrumentation.java.concurrent;\n+\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.NameMatchers.namedOneOf;\n+import static datadog.trace.instrumentation.java.concurrent.NewTaskFor.newTaskFor;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.Map;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.RunnableFuture;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import net.bytebuddy.matcher.ElementMatchers;\n+\n+@AutoService(Instrumenter.class)\n+public final class WrapRunnableAsNewTaskInstrumentation extends Instrumenter.Default {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca78561ec061a839207cb37b8f01a91ac58809c6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1MzIwNQ==", "bodyText": "In the future, it might be possible to replace this with a direct method call:\nraphw/byte-buddy#484\nMeanwhile, you may be able to avoid the reflection with MemberSubstitution raphw/byte-buddy#483", "url": "https://github.com/DataDog/dd-trace-java/pull/2021#discussion_r510453205", "createdAt": "2020-10-22T20:58:52Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/WrapRunnableAsNewTaskInstrumentation.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package datadog.trace.instrumentation.java.concurrent;\n+\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.NameMatchers.namedOneOf;\n+import static datadog.trace.instrumentation.java.concurrent.NewTaskFor.newTaskFor;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.Map;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.RunnableFuture;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import net.bytebuddy.matcher.ElementMatchers;\n+\n+@AutoService(Instrumenter.class)\n+public final class WrapRunnableAsNewTaskInstrumentation extends Instrumenter.Default {\n+  public WrapRunnableAsNewTaskInstrumentation() {\n+    super(\"java_concurrent\", \"new-task-for\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return namedOneOf(\n+        \"io.netty.channel.epoll.EpollEventLoop\",\n+        \"io.netty.channel.epoll.EpollEventLoopGroup\",\n+        \"io.netty.channel.MultithreadEventLoopGroup\",\n+        \"io.netty.channel.nio.NioEventLoop\",\n+        \"io.netty.channel.nio.NioEventLoopGroup\",\n+        \"io.netty.channel.SingleThreadEventLoop\",\n+        \"io.netty.util.concurrent.AbstractEventExecutor\",\n+        \"io.netty.util.concurrent.AbstractEventExecutorGroup\",\n+        \"io.netty.util.concurrent.AbstractScheduledEventExecutor\",\n+        \"io.netty.util.concurrent.DefaultEventExecutor\",\n+        \"io.netty.util.concurrent.DefaultEventExecutorGroup\",\n+        \"io.netty.util.concurrent.GlobalEventExecutor\",\n+        \"io.netty.util.concurrent.MultithreadEventExecutorGroup\",\n+        \"io.netty.util.concurrent.SingleThreadEventExecutor\",\n+        \"java.util.concurrent.AbstractExecutorService\",\n+        \"java.util.concurrent.CompletableFuture$ThreadPerTaskExecutor\",\n+        \"java.util.concurrent.SubmissionPublisher$ThreadPerTaskExecutor\",\n+        \"java.util.concurrent.ThreadPoolExecutor\",\n+        \"org.glassfish.grizzly.threadpool.GrizzlyExecutorService\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {packageName + \".NewTaskFor\"};\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        isMethod()\n+            .and(\n+                named(\"execute\")\n+                    .and(ElementMatchers.takesArgument(0, named(Runnable.class.getName())))),\n+        getClass().getName() + \"$Wrap\");\n+  }\n+\n+  public static final class Wrap {\n+    @Advice.OnMethodEnter\n+    public static void execute(\n+        @Advice.This Executor executor,\n+        @Advice.Argument(value = 0, readOnly = false) Runnable task) {\n+      task = newTaskFor(executor, task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca78561ec061a839207cb37b8f01a91ac58809c6"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3032, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}