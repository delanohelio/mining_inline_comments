{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNTMzMzgw", "number": 1199, "title": "Shared classloader for agent and jmx-fetch", "bodyText": "With this pull request, the agent classloader and jmx-fetch classloader share a common parent.  Added to the parent classloader are the libraries shared between them (currently only dogstatsd and guava).\nThe main changes are:\n\nAdding the parent in Agent.java\nChanging the packaging in gradle fo another internal jar\n\nThe benefits are:\n\n\n\n\n0.43.0-SNAPSHOT (post jackson removal)\nThis Pull\n\n\n\n\ndd-java-agent.jar file size\n20.8\n15.2\n\n\nOld used (memcheck)\n16.26\n14.27\n\n\nOld comm (memcheck)\n156\n152\n\n\n\nplus minor decreases across other memory metrics.\nFollow on work may include integrating BootstrapProxy into the hierarchy and changing the DatadogClassloaders not to inherit from URLClassloader", "createdAt": "2020-02-03T21:33:09Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1199", "merged": true, "mergeCommit": {"oid": "c28bf2180ed54fef8dce18bc26b4a23512c91279"}, "closed": true, "closedAt": "2020-02-11T18:48:02Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA0VdTgBqjMwMDM5NzE3MjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDWQJOAFqTM1NjkwMTI1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2deea42080b4012c156567a326f3301513ad4278", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2deea42080b4012c156567a326f3301513ad4278", "committedDate": "2020-02-03T21:53:57Z", "message": "Fix a couple tests using the wrong arguments"}, "afterCommit": {"oid": "42fb30385b3d3627766d4790940baa762ba012a0", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/42fb30385b3d3627766d4790940baa762ba012a0", "committedDate": "2020-02-03T22:04:03Z", "message": "Fix a couple tests using the wrong arguments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyOTY1NTYy", "url": "https://github.com/DataDog/dd-trace-java/pull/1199#pullrequestreview-352965562", "createdAt": "2020-02-04T13:17:54Z", "commit": {"oid": "42fb30385b3d3627766d4790940baa762ba012a0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMzoxNzo1NFrOFlTplg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMzoxNzo1NFrOFlTplg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY2MzU3NA==", "bodyText": "This seems to be a lot of manual dependency management that is very easy to get wrong. Instead maybe you would consider just somehow including jmxfetch into existing agent jar?", "url": "https://github.com/DataDog/dd-trace-java/pull/1199#discussion_r374663574", "createdAt": "2020-02-04T13:17:54Z", "author": {"login": "mar-kolya"}, "path": "gradle/dependencies.gradle", "diffHunk": "@@ -60,5 +60,31 @@ ext {\n     scala          : dependencies.create(group: 'org.scala-lang', name: 'scala-library', version: \"${versions.scala}\"),\n     kotlin         : dependencies.create(group: 'org.jetbrains.kotlin', name: 'kotlin-stdlib', version: \"${versions.kotlin}\"),\n     coroutines     : dependencies.create(group: 'org.jetbrains.kotlinx', name: 'kotlinx-coroutines-core', version: \"${versions.coroutines}\"),\n+\n+    // Shared between agent tooling and instrumentation and JMXFetch\n+    shared         : [\n+      dependencies.create(group: 'com.datadoghq', name: 'java-dogstatsd-client', version: '2.8'),\n+      // \"Explicit override jnr version because .22 caused issues\" - mar-kolya\n+      dependencies.create(group: 'com.github.jnr', name: 'jnr-unixsocket', version: '0.23'),\n+      dependencies.create(group: 'com.google.guava', name: 'guava', version: \"${versions.guava}\")\n+    ],\n+\n+    // Inverse of \"shared\".  These exclude directives are part of shadowJar's DSL\n+    // which is similar but not exactly the same as the regular gradle dependency{} block\n+    // Also, transitive dependencies have to be explicitly listed\n+    sharedInverse  : (Closure) {\n+      // dogstatsd and its transitives\n+      exclude(dependency('com.datadoghq:java-dogstatsd-client'))\n+      exclude(dependency('com.github.jnr::'))\n+      exclude(dependency('org.ow2.asm::'))\n+\n+      // Guava and its transitives\n+      exclude(dependency('com.google.guava::'))\n+      exclude(dependency('com.google.code.findbugs::'))\n+      exclude(dependency('com.google.errorprone::'))\n+      exclude(dependency('com.google.j2objc::'))\n+      exclude(dependency('org.codehaus.mojo::'))\n+      exclude(dependency('org.checkerframework::'))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42fb30385b3d3627766d4790940baa762ba012a0"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDI5OTQ1", "url": "https://github.com/DataDog/dd-trace-java/pull/1199#pullrequestreview-355429945", "createdAt": "2020-02-07T20:53:03Z", "commit": {"oid": "42fb30385b3d3627766d4790940baa762ba012a0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDo1MzowNFrOFnJ-NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMToxNToxN1rOFnOVFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwMjE2NA==", "bodyText": "I've merged change #1204 in this method to master. Will be small merge conflict :)", "url": "https://github.com/DataDog/dd-trace-java/pull/1199#discussion_r376602164", "createdAt": "2020-02-07T20:53:04Z", "author": {"login": "lpriima"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -160,13 +163,38 @@ public void execute() {\n     }\n   }\n \n+  private static synchronized void createParentClassloader(final URL bootstrapURL) {\n+    if (PARENT_CLASSLOADER == null) {\n+      try {\n+        final Class<?> bootstrapProxyClass =\n+            ClassLoader.getSystemClassLoader()\n+                .loadClass(\"datadog.trace.bootstrap.DatadogClassLoader$BootstrapClassLoaderProxy\");\n+        final Constructor constructor = bootstrapProxyClass.getDeclaredConstructor(URL.class);\n+        BOOTSTRAP_PROXY = (ClassLoader) constructor.newInstance(bootstrapURL);\n+\n+        final ClassLoader grandParent;\n+        if (isJavaBefore9()) {\n+          grandParent = null; // bootstrap\n+        } else {\n+          // platform classloader is parent of system in java 9+\n+          grandParent = getPlatformClassLoader();\n+        }\n+\n+        PARENT_CLASSLOADER = createDatadogClassLoader(\"shared.isolated\", bootstrapURL, grandParent);\n+      } catch (final Throwable ex) {\n+        log.error(\"Throwable thrown creating parent classloader\", ex);\n+      }\n+    }\n+  }\n+\n   private static synchronized void startDatadogAgent(\n       final Instrumentation inst, final URL bootstrapURL) {\n     if (AGENT_CLASSLOADER == null) {\n       final ClassLoader contextLoader = Thread.currentThread().getContextClassLoader();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42fb30385b3d3627766d4790940baa762ba012a0"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY3MzU1OQ==", "bodyText": "Is synchronized needed for this method ? And AGENT_CLASSLOADER not volatile at the same time?", "url": "https://github.com/DataDog/dd-trace-java/pull/1199#discussion_r376673559", "createdAt": "2020-02-08T01:15:17Z", "author": {"login": "lpriima"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -160,13 +163,38 @@ public void execute() {\n     }\n   }\n \n+  private static synchronized void createParentClassloader(final URL bootstrapURL) {\n+    if (PARENT_CLASSLOADER == null) {\n+      try {\n+        final Class<?> bootstrapProxyClass =\n+            ClassLoader.getSystemClassLoader()\n+                .loadClass(\"datadog.trace.bootstrap.DatadogClassLoader$BootstrapClassLoaderProxy\");\n+        final Constructor constructor = bootstrapProxyClass.getDeclaredConstructor(URL.class);\n+        BOOTSTRAP_PROXY = (ClassLoader) constructor.newInstance(bootstrapURL);\n+\n+        final ClassLoader grandParent;\n+        if (isJavaBefore9()) {\n+          grandParent = null; // bootstrap\n+        } else {\n+          // platform classloader is parent of system in java 9+\n+          grandParent = getPlatformClassLoader();\n+        }\n+\n+        PARENT_CLASSLOADER = createDatadogClassLoader(\"shared.isolated\", bootstrapURL, grandParent);\n+      } catch (final Throwable ex) {\n+        log.error(\"Throwable thrown creating parent classloader\", ex);\n+      }\n+    }\n+  }\n+\n   private static synchronized void startDatadogAgent(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42fb30385b3d3627766d4790940baa762ba012a0"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c0877e38a84d3ddb3ed96568341686dd463e35e", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3c0877e38a84d3ddb3ed96568341686dd463e35e", "committedDate": "2020-02-11T16:42:39Z", "message": "Create a shared parent classloader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c79fe3a45991892e8c8c23336668840a32422a1b", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c79fe3a45991892e8c8c23336668840a32422a1b", "committedDate": "2020-02-11T16:44:46Z", "message": "Create shared internal jar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cb0ae0a485add2461d437090830b32a1a0b1ab4", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0cb0ae0a485add2461d437090830b32a1a0b1ab4", "committedDate": "2020-02-11T16:44:46Z", "message": "Less repetition in gradle files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01b0bebc93e984f32257616b8538b7d3f32039b1", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/01b0bebc93e984f32257616b8538b7d3f32039b1", "committedDate": "2020-02-11T16:44:46Z", "message": "minor formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9023c6e1c7ee77602c968f64be87d265c093bd8a", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9023c6e1c7ee77602c968f64be87d265c093bd8a", "committedDate": "2020-02-11T16:44:46Z", "message": "Fix a couple tests using the wrong arguments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42fb30385b3d3627766d4790940baa762ba012a0", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/42fb30385b3d3627766d4790940baa762ba012a0", "committedDate": "2020-02-03T22:04:03Z", "message": "Fix a couple tests using the wrong arguments"}, "afterCommit": {"oid": "9023c6e1c7ee77602c968f64be87d265c093bd8a", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9023c6e1c7ee77602c968f64be87d265c093bd8a", "committedDate": "2020-02-11T16:44:46Z", "message": "Fix a couple tests using the wrong arguments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTAxMjU2", "url": "https://github.com/DataDog/dd-trace-java/pull/1199#pullrequestreview-356901256", "createdAt": "2020-02-11T18:43:24Z", "commit": {"oid": "9023c6e1c7ee77602c968f64be87d265c093bd8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2694, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}