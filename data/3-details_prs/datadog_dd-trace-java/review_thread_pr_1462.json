{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MjQ3MjEx", "number": 1462, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzowNzo0NFrOD8wdnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzoyMDoxMFrOD8wrMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDM1MTY1OnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScope.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzowNzo0NFrOGV5AbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzowNzo0NFrOGV5AbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYwNzI3Ng==", "bodyText": "Wasn't introduced in this PR but this is common throughout this code base. this must not escape constructors because there are no guarantees about what state the object is in until the constructor exits. IMO a clean up of this class should address this problem.", "url": "https://github.com/DataDog/dd-trace-java/pull/1462#discussion_r425607276", "createdAt": "2020-05-15T07:07:44Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScope.java", "diffHunk": "@@ -145,25 +146,25 @@ public String toString() {\n    * maintain private constructor access.\n    */\n   @Slf4j // This is important to prevent the log messages below from referencing the super class.\n-  public static class Continuation implements TraceScope.Continuation {\n-    public WeakReference<Continuation> ref;\n+  public static class Continuation implements AgentScope.Continuation {\n+    public WeakReference<AgentScope.Continuation> ref;\n \n-    private final DDSpan spanUnderScope;\n+    private final AgentSpan spanUnderScope;\n     private final ContextualScopeManager scopeManager;\n     private final DDScopeEventFactory eventFactory;\n \n-    private final PendingTrace trace;\n+    private final AgentTrace trace;\n     private final AtomicBoolean used = new AtomicBoolean(false);\n \n     private Continuation(\n-        final DDSpan spanUnderScope,\n+        final AgentSpan spanUnderScope,\n         final ContextualScopeManager scopeManager,\n         final DDScopeEventFactory eventFactory) {\n \n       this.spanUnderScope = spanUnderScope;\n       this.scopeManager = scopeManager;\n       this.eventFactory = eventFactory;\n-      final DDSpanContext context = this.spanUnderScope.context();\n+      final AgentSpan.Context context = this.spanUnderScope.context();\n       trace = context.getTrace();\n       trace.registerContinuation(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16936cd729f709c74f41097bac5b42037d9ba9fd"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDM1NDkxOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScope.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzowOTowNVrOGV5CfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzowOTowNVrOGV5CfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYwNzgwNQ==", "bodyText": "this should not escape.", "url": "https://github.com/DataDog/dd-trace-java/pull/1462#discussion_r425607805", "createdAt": "2020-05-15T07:09:05Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScope.java", "diffHunk": "@@ -190,5 +191,23 @@ public void cancel() {\n         log.debug(\"Failed to close continuation {}. Already used.\", this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16936cd729f709c74f41097bac5b42037d9ba9fd"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDM4NTcwOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzoxOTo1OFrOGV5U_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzoyNjozMlrOGWNoQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYxMjU0Mw==", "bodyText": "Should be wrapped in log.isDebugEnabled() because this hits a vararg overload and allocates an Object[]", "url": "https://github.com/DataDog/dd-trace-java/pull/1462#discussion_r425612543", "createdAt": "2020-05-15T07:19:58Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -174,12 +175,11 @@ public DDSpan getRootSpan() {\n    * When using continuations, it's possible one may be used after all existing spans are otherwise\n    * completed, so we need to wait till continuations are de-referenced before reporting.\n    */\n-  public void registerContinuation(final ContinuableScope.Continuation continuation) {\n+  @Override\n+  public void registerContinuation(final AgentScope.Continuation continuation) {\n     synchronized (continuation) {\n-      if (continuation.ref == null) {\n-        continuation.ref =\n-            new WeakReference<ContinuableScope.Continuation>(continuation, referenceQueue);\n-        weakReferences.add(continuation.ref);\n+      if (!continuation.isRegistered()) {\n+        weakReferences.add(continuation.register(referenceQueue));\n         final int count = pendingReferenceCount.incrementAndGet();\n         log.debug(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16936cd729f709c74f41097bac5b42037d9ba9fd"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk0NTE1Mw==", "bodyText": "Resolved in #1466", "url": "https://github.com/DataDog/dd-trace-java/pull/1462#discussion_r425945153", "createdAt": "2020-05-15T17:26:32Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -174,12 +175,11 @@ public DDSpan getRootSpan() {\n    * When using continuations, it's possible one may be used after all existing spans are otherwise\n    * completed, so we need to wait till continuations are de-referenced before reporting.\n    */\n-  public void registerContinuation(final ContinuableScope.Continuation continuation) {\n+  @Override\n+  public void registerContinuation(final AgentScope.Continuation continuation) {\n     synchronized (continuation) {\n-      if (continuation.ref == null) {\n-        continuation.ref =\n-            new WeakReference<ContinuableScope.Continuation>(continuation, referenceQueue);\n-        weakReferences.add(continuation.ref);\n+      if (!continuation.isRegistered()) {\n+        weakReferences.add(continuation.register(referenceQueue));\n         final int count = pendingReferenceCount.incrementAndGet();\n         log.debug(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYxMjU0Mw=="}, "originalCommit": {"oid": "16936cd729f709c74f41097bac5b42037d9ba9fd"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDM4NjQzOnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzoyMDoxMFrOGV5VaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzoyMDoxMFrOGV5VaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYxMjY0OQ==", "bodyText": "It's good to know this reference won't be reassigned in the next two lines of the method!", "url": "https://github.com/DataDog/dd-trace-java/pull/1462#discussion_r425612649", "createdAt": "2020-05-15T07:20:10Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -23,10 +24,10 @@\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n-public class PendingTrace extends ConcurrentLinkedDeque<DDSpan> {\n+public class PendingTrace extends ConcurrentLinkedDeque<DDSpan> implements AgentTrace {\n \n   static PendingTrace create(final CoreTracer tracer, final BigInteger traceId) {\n-    PendingTrace pendingTrace = new PendingTrace(tracer, traceId);\n+    final PendingTrace pendingTrace = new PendingTrace(tracer, traceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16936cd729f709c74f41097bac5b42037d9ba9fd"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 324, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}