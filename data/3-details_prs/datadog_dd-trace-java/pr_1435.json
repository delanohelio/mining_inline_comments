{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NTg3OTM2", "number": 1435, "title": "avoid allocation of byte[] in MessagePacker.writeString", "bodyText": "", "createdAt": "2020-05-07T10:10:23Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1435", "merged": true, "mergeCommit": {"oid": "7e7559dbd26b5ec2cfb7d0256fcc7df66dace7c5"}, "closed": true, "closedAt": "2020-05-07T17:12:01Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce67G-ABqjMzMTIyOTUyMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfAfP8AFqTQwNzY3MjkzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6a7fc08b860285b88169bc4db01ead3ddd295bf", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b6a7fc08b860285b88169bc4db01ead3ddd295bf", "committedDate": "2020-05-07T10:09:15Z", "message": "avoid allocation of byte[] in MessagePacker.writeString"}, "afterCommit": {"oid": "38a24a0de2570c1a5bd2e54a5b946cfc33a71dd6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/38a24a0de2570c1a5bd2e54a5b946cfc33a71dd6", "committedDate": "2020-05-07T10:42:29Z", "message": "avoid allocation of byte[] in MessagePacker.writeString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb98cc955939cc2ea1472c204b33cc721d910c32", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bb98cc955939cc2ea1472c204b33cc721d910c32", "committedDate": "2020-05-07T10:55:52Z", "message": "avoid allocation of byte[] in MessagePacker.writeString"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38a24a0de2570c1a5bd2e54a5b946cfc33a71dd6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/38a24a0de2570c1a5bd2e54a5b946cfc33a71dd6", "committedDate": "2020-05-07T10:42:29Z", "message": "avoid allocation of byte[] in MessagePacker.writeString"}, "afterCommit": {"oid": "bb98cc955939cc2ea1472c204b33cc721d910c32", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bb98cc955939cc2ea1472c204b33cc721d910c32", "committedDate": "2020-05-07T10:55:52Z", "message": "avoid allocation of byte[] in MessagePacker.writeString"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTE5MzA4", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#pullrequestreview-407519308", "createdAt": "2020-05-07T14:19:09Z", "commit": {"oid": "bb98cc955939cc2ea1472c204b33cc721d910c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoxOTowOVrOGSA1FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoxOTowOVrOGSA1FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0MTE0MQ==", "bodyText": "clone():\nMessagePack.DEFAULT_PACKER_CONFIG.clone().withSmallStringOptimizationThreshold(16)", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#discussion_r421541141", "createdAt": "2020-05-07T14:19:09Z", "author": {"login": "lpriima"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -46,6 +46,9 @@\n   private static final String TRACES_ENDPOINT_V4 = \"v0.4/traces\";\n   private static final long MILLISECONDS_BETWEEN_ERROR_LOG = TimeUnit.MINUTES.toMillis(5);\n \n+  private static final MessagePack.PackerConfig MESSAGE_PACKER_CONFIG =\n+      MessagePack.DEFAULT_PACKER_CONFIG.withSmallStringOptimizationThreshold(16);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb98cc955939cc2ea1472c204b33cc721d910c32"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTQ2MTcx", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#pullrequestreview-407546171", "createdAt": "2020-05-07T14:45:33Z", "commit": {"oid": "bb98cc955939cc2ea1472c204b33cc721d910c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDo0NTozM1rOGSCJTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDo0NTozM1rOGSCJTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2MjcwMA==", "bodyText": "So it wasn't directly obvious to me what this did, and I had to check the code. I think a comment about why this is done would be great. AFAICS, this limits the size of Strings that are considered for this optimization from 512 chars to 16 chars, and so the number of calls to String.getBytes get fewer, and hence fewer allocations of byte[].", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#discussion_r421562700", "createdAt": "2020-05-07T14:45:33Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -46,6 +46,9 @@\n   private static final String TRACES_ENDPOINT_V4 = \"v0.4/traces\";\n   private static final long MILLISECONDS_BETWEEN_ERROR_LOG = TimeUnit.MINUTES.toMillis(5);\n \n+  private static final MessagePack.PackerConfig MESSAGE_PACKER_CONFIG =\n+      MessagePack.DEFAULT_PACKER_CONFIG.withSmallStringOptimizationThreshold(16);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb98cc955939cc2ea1472c204b33cc721d910c32"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a62f6bc5a5792f39f10534faff5830d76d452ba4", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a62f6bc5a5792f39f10534faff5830d76d452ba4", "committedDate": "2020-05-07T15:27:47Z", "message": "add explanatory comment for MessagePacker configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTkwMTcx", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#pullrequestreview-407590171", "createdAt": "2020-05-07T15:31:10Z", "commit": {"oid": "a62f6bc5a5792f39f10534faff5830d76d452ba4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NjcyOTM0", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#pullrequestreview-407672934", "createdAt": "2020-05-07T17:11:52Z", "commit": {"oid": "a62f6bc5a5792f39f10534faff5830d76d452ba4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2474, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}