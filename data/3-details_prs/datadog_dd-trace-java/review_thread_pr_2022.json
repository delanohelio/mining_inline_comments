{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MjE4Njk4", "number": 2022, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo0MjozMFrOEwv01w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1NTozN1rOExW1kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NTUwNjc5OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo0MjozMFrOHmfx0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDowODoyM1rOHndB6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyODU5NA==", "bodyText": "I'm a bit confused about this (to be honest about muzzle in general), but this seems to say that it should fail for no versions, since (,) is non inclusive, and then pass for all versions, because of the assertInverse = true. Is this correct, and if so, is there no clearer way to write it?", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r510128594", "createdAt": "2020-10-22T12:42:30Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "diffHunk": "@@ -0,0 +1,51 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"elasticsearch-rest-client\"\n+    versions = \"[7,)\"\n+    assertInverse = true\n+  }\n+\n+  fail {\n+    group = \"org.elasticsearch.client\"\n+    module = \"rest\"\n+    versions = \"(,)\"\n+    assertInverse = true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e23acadaa06995e369636ac40c79a47d017add"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE0NTYyMQ==", "bodyText": "I'm still cleaning up the muzzle specs for ES7 so ignore this as it will likely change (it comes from the ES6 muzzle spec)", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r510145621", "createdAt": "2020-10-22T13:06:54Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "diffHunk": "@@ -0,0 +1,51 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"elasticsearch-rest-client\"\n+    versions = \"[7,)\"\n+    assertInverse = true\n+  }\n+\n+  fail {\n+    group = \"org.elasticsearch.client\"\n+    module = \"rest\"\n+    versions = \"(,)\"\n+    assertInverse = true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyODU5NA=="}, "originalCommit": {"oid": "f5e23acadaa06995e369636ac40c79a47d017add"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg5NjM3NQ==", "bodyText": "Turns out that (,) is treated just like [,] or + (ie. all versions) in the version resolver code because it doesn't have any upper or lower bound - so this was saying it should fail for all versions of the legacy rest artifact. This is correct given the compatibility of that artifact.\nThe use of assertInverse is suspect, since the inverse shouldn't match any version and therefore become a no-op - but I wonder if it was added as a precaution, maybe because of a doubt that the version range really meant \"all versions\"?\nI did find a couple of places that set the range to all-versions and use assertInverse=true - one uses (,) and the other uses [,]. Of all the places that just set the range to all-versions there's a 40/60 split between (,) and [,].\nIMHO we should use [,] (or maybe +?) everywhere to consistently declare \"all versions\" - and also remove assertInverse whenever we set \"all versions\".\nThoughts?", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r510896375", "createdAt": "2020-10-23T13:48:37Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "diffHunk": "@@ -0,0 +1,51 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"elasticsearch-rest-client\"\n+    versions = \"[7,)\"\n+    assertInverse = true\n+  }\n+\n+  fail {\n+    group = \"org.elasticsearch.client\"\n+    module = \"rest\"\n+    versions = \"(,)\"\n+    assertInverse = true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyODU5NA=="}, "originalCommit": {"oid": "f5e23acadaa06995e369636ac40c79a47d017add"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4MDUwNA==", "bodyText": "This is really an abuse of set theoretic range notation. I interpreted (,) as the empty set, i.e. the set has equal open upper and lower bounds. So I'm surprised this meant \"everything\" and not \"nothing\". I say we go for + to mean everything, but I'd prefer * or anything else which would differentiate make the notation less pseudo-set-theoretic.", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r510980504", "createdAt": "2020-10-23T15:52:40Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "diffHunk": "@@ -0,0 +1,51 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"elasticsearch-rest-client\"\n+    versions = \"[7,)\"\n+    assertInverse = true\n+  }\n+\n+  fail {\n+    group = \"org.elasticsearch.client\"\n+    module = \"rest\"\n+    versions = \"(,)\"\n+    assertInverse = true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyODU5NA=="}, "originalCommit": {"oid": "f5e23acadaa06995e369636ac40c79a47d017add"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3NDI1Mw==", "bodyText": "I don't think we can use + here... (IIRC, that's a gradle specific syntax).  I think we have to rely on the maven range syntax rules. (+ is also generally a notation for the latest version, not defining a range.)\nI would support standardizing on [,], and not using assertInverse when the range is \"all inclusive\".", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r511074253", "createdAt": "2020-10-23T18:39:44Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "diffHunk": "@@ -0,0 +1,51 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"elasticsearch-rest-client\"\n+    versions = \"[7,)\"\n+    assertInverse = true\n+  }\n+\n+  fail {\n+    group = \"org.elasticsearch.client\"\n+    module = \"rest\"\n+    versions = \"(,)\"\n+    assertInverse = true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyODU5NA=="}, "originalCommit": {"oid": "f5e23acadaa06995e369636ac40c79a47d017add"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3ODg4NA==", "bodyText": "Yes, I think there might be alternatives to assertInverse in general.  But for now, it sounds like we've settled on a good solution.", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r511078884", "createdAt": "2020-10-23T18:45:09Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "diffHunk": "@@ -0,0 +1,51 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"elasticsearch-rest-client\"\n+    versions = \"[7,)\"\n+    assertInverse = true\n+  }\n+\n+  fail {\n+    group = \"org.elasticsearch.client\"\n+    module = \"rest\"\n+    versions = \"(,)\"\n+    assertInverse = true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyODU5NA=="}, "originalCommit": {"oid": "f5e23acadaa06995e369636ac40c79a47d017add"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEzMjEzNg==", "bodyText": "as @tylerbenson thought [,] is the one that works, and most clearly states \"all versions\" - I tried both * and + and they're not supported by the maven dependency resolver used by muzzle", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r511132136", "createdAt": "2020-10-23T20:08:23Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "diffHunk": "@@ -0,0 +1,51 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"elasticsearch-rest-client\"\n+    versions = \"[7,)\"\n+    assertInverse = true\n+  }\n+\n+  fail {\n+    group = \"org.elasticsearch.client\"\n+    module = \"rest\"\n+    versions = \"(,)\"\n+    assertInverse = true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyODU5NA=="}, "originalCommit": {"oid": "f5e23acadaa06995e369636ac40c79a47d017add"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMDk4OTE3OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjowODoyOVrOHnUWhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjowODoyOVrOHnUWhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4OTk1OA==", "bodyText": "General comment, I would love for us to use testcontainers or something else off-jvm so don't have to worry about things like this", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r510989958", "createdAt": "2020-10-23T16:08:29Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/rest-7.gradle", "diffHunk": "@@ -0,0 +1,52 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"elasticsearch-rest-client\"\n+    versions = \"[7,)\"\n+    assertInverse = true\n+  }\n+\n+  fail {\n+    group = \"org.elasticsearch.client\"\n+    module = \"rest\"\n+    versions = \"[,]\" // legacy artifact, all versions should fail\n+  }\n+}\n+\n+apply from: \"$rootDir/gradle/java.gradle\"\n+\n+apply plugin: 'org.unbroken-dome.test-sets'\n+\n+testSets {\n+  latestDepTest {\n+    dirName = 'test'\n+  }\n+}\n+\n+dependencies {\n+  compileOnly group: 'org.elasticsearch.client', name: 'elasticsearch-rest-client', version: '7.0.0'\n+\n+  compile project(':dd-java-agent:instrumentation:elasticsearch')\n+\n+  testCompile project(':dd-java-agent:instrumentation:apache-httpclient-4')\n+  testCompile project(':dd-java-agent:instrumentation:apache-httpasyncclient-4')\n+  // Netty is used, but it adds complexity to the tests since we're using embedded ES.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01eeba6f39673d75e5522f8130eed048213c7ffb"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTAxNjU5OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/elasticsearch/transport-7.3/transport-7.3.gradle", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjoxNTo1MVrOHnUnQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjozNTozOFrOHnVSJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk5NDI0MQ==", "bodyText": "Is there another version of the transport instrumentation that covers the earlier 7.x versions?", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r510994241", "createdAt": "2020-10-23T16:15:51Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/elasticsearch/transport-7.3/transport-7.3.gradle", "diffHunk": "@@ -0,0 +1,50 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"transport\"\n+    versions = \"[7.3,]\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01eeba6f39673d75e5522f8130eed048213c7ffb"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAwNTIyMA==", "bodyText": "So ES only changed Action to ActionType in 7.3 - before that it was still Action, which means the previous transport-6 instrumentation will work for versions before 7.3 (at least for transport traces - the REST instrumentation has a different breaking change that came in in 7.0.)\nThe transport 7.0 scenario isn't covered by our automated tests because other ES7 changes means it needs different test bootstrapping (another reason to consider using testcontainers) and that would conflict with ES6 where the old compatible transport is defined. But local testing of those early versions (ES is already up to 7.10) show it works.", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r511005220", "createdAt": "2020-10-23T16:35:38Z", "author": {"login": "mcculls"}, "path": "dd-java-agent/instrumentation/elasticsearch/transport-7.3/transport-7.3.gradle", "diffHunk": "@@ -0,0 +1,50 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.elasticsearch.client\"\n+    module = \"transport\"\n+    versions = \"[7.3,]\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk5NDI0MQ=="}, "originalCommit": {"oid": "01eeba6f39673d75e5522f8130eed048213c7ffb"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTg5ODQyOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/src/main/java/datadog/trace/instrumentation/elasticsearch7/RestResponseListener.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1NTozN1rOHnctOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1NTozN1rOHnctOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNjg0MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/DataDog/dd-trace-java/pull/2022#discussion_r511126841", "createdAt": "2020-10-23T19:55:37Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/elasticsearch/rest-7/src/main/java/datadog/trace/instrumentation/elasticsearch7/RestResponseListener.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package datadog.trace.instrumentation.elasticsearch7;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.instrumentation.elasticsearch.ElasticsearchRestClientDecorator;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseListener;\n+\n+/** This class is identical to version 6's instrumentation. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01eeba6f39673d75e5522f8130eed048213c7ffb"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4750, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}