{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyODg1MDI3", "number": 1336, "title": "add ...\"metrics\":{\"_dd.measured\":1}... to every span", "bodyText": "Today the agent/backend computes stats for service top level spans. This means that any time a child span\u2019s service name is different from its parent\u2019s, that span will be marked as \u201ctop level\u201d and stats will be computed.\nWe are moving towards a model where we will only allow a single service name per-process/tracer. However, this will break existing functionality. It will no longer be possible to get stats for child spans in services.\nSolution\nIn order to continue giving access to calculate stats for custom spans we will be adding in a mechanism to mark (tag) spans for stats computation.\nAdding the metric _dd.measured: 1 to any span will indicate to the agent/backend that stats should be computed on that span.\nImplementation details\nMetric name: _dd.measured\nMetric value: 0 or 1\nThe metric must be the numeric values of either 0 or 1.\n0 means to explicitly not compute metrics.\n1 means to explicitly compute metrics.\nThis metric is not be defined by default, meaning the only reason you could have the value of 0 is if the user explicitly sets the tag to indicate that metrics should not be computed.", "createdAt": "2020-03-24T09:49:07Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1336", "merged": true, "mergeCommit": {"oid": "cda39adf50bc5ec9b74117292dc0e67332b4777a"}, "closed": true, "closedAt": "2020-03-25T18:17:48Z", "author": {"login": "lpriima"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ3rVfgFqTM4MDYxMjA2OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRJAtfgFqTM4MTI0NjM3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjEyMDY4", "url": "https://github.com/DataDog/dd-trace-java/pull/1336#pullrequestreview-380612068", "createdAt": "2020-03-24T19:00:59Z", "commit": {"oid": "d0ae50004e82b248e9579d7c808d194396b5387d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTowMDo1OVrOF6-5jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTowMDo1OVrOF6-5jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5MjI2OA==", "bodyText": "I'd prefer to avoid double-brace initialization, since it will create another class.\nI think we could just addAll the default metrics.  That would also avoid repeating a bit code.", "url": "https://github.com/DataDog/dd-trace-java/pull/1336#discussion_r397392268", "createdAt": "2020-03-24T19:00:59Z", "author": {"login": "dougqh"}, "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDSpanContext.java", "diffHunk": "@@ -308,12 +311,18 @@ public DDTracer getTracer() {\n \n   public Map<String, Number> getMetrics() {\n     final Map<String, Number> metrics = this.metrics.get();\n-    return metrics == null ? EMPTY_METRICS : metrics;\n+    return metrics == null ? DEFAULT_METRICS : metrics;\n   }\n \n   public void setMetric(final String key, final Number value) {\n     if (metrics.get() == null) {\n-      metrics.compareAndSet(null, new ConcurrentHashMap<String, Number>());\n+      metrics.compareAndSet(\n+          null,\n+          new ConcurrentHashMap<String, Number>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0ae50004e82b248e9579d7c808d194396b5387d"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjE0NzM3", "url": "https://github.com/DataDog/dd-trace-java/pull/1336#pullrequestreview-380614737", "createdAt": "2020-03-24T19:04:45Z", "commit": {"oid": "d0ae50004e82b248e9579d7c808d194396b5387d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTowNDo0NVrOF6_Bnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTowNDo0NVrOF6_Bnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5NDMzNQ==", "bodyText": "Generally, I think this bit of clean-up is good.\nHowever, we're working on changing the OpenTelemetry split right now, so this might create merge conflicts.", "url": "https://github.com/DataDog/dd-trace-java/pull/1336#discussion_r397394335", "createdAt": "2020-03-24T19:04:45Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/OpenTracing32.java", "diffHunk": "@@ -34,6 +34,10 @@\n \n   private final OT32Span NOOP_SPAN = new OT32Span(\"\", NoopSpan.INSTANCE);\n \n+  private Tracer.SpanBuilder buildSpan(final String spanName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0ae50004e82b248e9579d7c808d194396b5387d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97a8cedc6f0f36fe24eb89c4e45f906087524354", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/97a8cedc6f0f36fe24eb89c4e45f906087524354", "committedDate": "2020-03-24T22:09:26Z", "message": "add ...\"metrics\":{\"_dd.measured\":1}... to every span"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04bac3be2d8f97d0aff1c04bc7b698058df8fa8e", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/04bac3be2d8f97d0aff1c04bc7b698058df8fa8e", "committedDate": "2020-03-24T22:09:26Z", "message": "update tests to always have \"metrics\":{\"_dd.measured\":1} in every span"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d8f66e0800fe5a6d4801bcee0071b26722fa740", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4d8f66e0800fe5a6d4801bcee0071b26722fa740", "committedDate": "2020-03-24T21:39:30Z", "message": "update tests to always have \"metrics\":{\"_dd.measured\":1} in every span"}, "afterCommit": {"oid": "04bac3be2d8f97d0aff1c04bc7b698058df8fa8e", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/04bac3be2d8f97d0aff1c04bc7b698058df8fa8e", "committedDate": "2020-03-24T22:09:26Z", "message": "update tests to always have \"metrics\":{\"_dd.measured\":1} in every span"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjQ2Mzcz", "url": "https://github.com/DataDog/dd-trace-java/pull/1336#pullrequestreview-381246373", "createdAt": "2020-03-25T15:12:43Z", "commit": {"oid": "04bac3be2d8f97d0aff1c04bc7b698058df8fa8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2600, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}