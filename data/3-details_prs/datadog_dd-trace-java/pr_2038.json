{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjk3ODYw", "number": 2038, "title": "rework setting _dd.measured", "bodyText": "Bypasses the metrics map for the _dd.measured flag\nAdds AgentSpan.setMeasured(boolean), removes cases of setting this via a tag\nWrites the flag out to the metrics part of the span as if it were in the map\nFixes some tests which assume the map contains the flag\nRemoves the rule which moved the flag from tags to metrics", "createdAt": "2020-10-28T16:56:51Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2038", "merged": true, "mergeCommit": {"oid": "9daf9ffe60ddbe1462e6c31302dd8a9afde3f7fa"}, "closed": true, "closedAt": "2020-10-29T08:40:49Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXApIOgBqjM5MzIzOTg2NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXNXL1gFqTUxOTQwNDYzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9da96bf80c171b973a06e0485624175f17b12b83", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9da96bf80c171b973a06e0485624175f17b12b83", "committedDate": "2020-10-28T16:55:58Z", "message": "don't put _dd.measured in the metrics or tags maps, remove rule processing"}, "afterCommit": {"oid": "54f70e1fe72e688c6c1f1cb910ea8b731ace9a32", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/54f70e1fe72e688c6c1f1cb910ea8b731ace9a32", "committedDate": "2020-10-28T17:02:10Z", "message": "don't put _dd.measured in the metrics or tags maps, remove rule processing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54f70e1fe72e688c6c1f1cb910ea8b731ace9a32", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/54f70e1fe72e688c6c1f1cb910ea8b731ace9a32", "committedDate": "2020-10-28T17:02:10Z", "message": "don't put _dd.measured in the metrics or tags maps, remove rule processing"}, "afterCommit": {"oid": "40b3e63c586273e216ccd76b36a40915a6f4d764", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/40b3e63c586273e216ccd76b36a40915a6f4d764", "committedDate": "2020-10-28T17:07:32Z", "message": "don't put _dd.measured in the metrics or tags maps, remove rule processing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddc6b936abac90638cf1d997fc2d73b8bb5e0826", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ddc6b936abac90638cf1d997fc2d73b8bb5e0826", "committedDate": "2020-10-28T17:42:10Z", "message": "don't put _dd.measured in the metrics or tags maps, remove rule processing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40b3e63c586273e216ccd76b36a40915a6f4d764", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/40b3e63c586273e216ccd76b36a40915a6f4d764", "committedDate": "2020-10-28T17:07:32Z", "message": "don't put _dd.measured in the metrics or tags maps, remove rule processing"}, "afterCommit": {"oid": "ddc6b936abac90638cf1d997fc2d73b8bb5e0826", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ddc6b936abac90638cf1d997fc2d73b8bb5e0826", "committedDate": "2020-10-28T17:42:10Z", "message": "don't put _dd.measured in the metrics or tags maps, remove rule processing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4OTk1ODk5", "url": "https://github.com/DataDog/dd-trace-java/pull/2038#pullrequestreview-518995899", "createdAt": "2020-10-28T19:03:50Z", "commit": {"oid": "ddc6b936abac90638cf1d997fc2d73b8bb5e0826"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTowMzo1MFrOHp5UJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTowMzo1MFrOHp5UJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY5MjcwOQ==", "bodyText": "Is this good practice when writing to a volatile?  I assume to avoid the cache invalidation...", "url": "https://github.com/DataDog/dd-trace-java/pull/2038#discussion_r513692709", "createdAt": "2020-10-28T19:03:50Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -202,7 +204,19 @@ public boolean getErrorFlag() {\n   }\n \n   public void setErrorFlag(final boolean errorFlag) {\n-    this.errorFlag = errorFlag;\n+    if (errorFlag != this.errorFlag) {\n+      this.errorFlag = errorFlag;\n+    }\n+  }\n+\n+  public boolean isMeasured() {\n+    return measuredFlag;\n+  }\n+\n+  public void setMeasured(boolean measured) {\n+    if (measured != measuredFlag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddc6b936abac90638cf1d997fc2d73b8bb5e0826"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDA0NjM1", "url": "https://github.com/DataDog/dd-trace-java/pull/2038#pullrequestreview-519404635", "createdAt": "2020-10-29T07:51:03Z", "commit": {"oid": "ddc6b936abac90638cf1d997fc2d73b8bb5e0826"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNzo1MTowNFrOHqP10A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNzo1MTowNFrOHqP10A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2MTc3Ng==", "bodyText": "I agree that it makes sense in this case, where the expected behavior is to set the volatile to the value once, but you might accidentally (due to the current code structure) set it multiple times to the same value. It's not a general solution as far as I can see.\nBy the way, isn't the StoreLoad barrier after the volatile store?", "url": "https://github.com/DataDog/dd-trace-java/pull/2038#discussion_r514061776", "createdAt": "2020-10-29T07:51:04Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/DDSpanContext.java", "diffHunk": "@@ -202,7 +204,19 @@ public boolean getErrorFlag() {\n   }\n \n   public void setErrorFlag(final boolean errorFlag) {\n-    this.errorFlag = errorFlag;\n+    if (errorFlag != this.errorFlag) {\n+      this.errorFlag = errorFlag;\n+    }\n+  }\n+\n+  public boolean isMeasured() {\n+    return measuredFlag;\n+  }\n+\n+  public void setMeasured(boolean measured) {\n+    if (measured != measuredFlag) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY5MjcwOQ=="}, "originalCommit": {"oid": "ddc6b936abac90638cf1d997fc2d73b8bb5e0826"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3057, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}