{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NDEyNTYz", "number": 1719, "title": "UnsafeUtils::setStaticFieldViaUnsafe should use putBooleanVolatile", "bodyText": "log4j2:testJava14Generated crashes in VM G1 code after setting static final field by Unsafe. This change tries to fix this test problem", "createdAt": "2020-07-27T21:29:37Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1719", "merged": true, "mergeCommit": {"oid": "06c76521ea93c6e31835a645b458e998babe80e1"}, "closed": true, "closedAt": "2020-07-28T14:57:35Z", "author": {"login": "lpriima"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5JFApgH2gAyNDU3NDEyNTYzOmE5MTJiMDllYzgzNGFjYjljNDcyN2Q5NjM3YWYyMzEzYWNiZWI5MjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5WyZ-AFqTQ1NjY1MjkwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a912b09ec834acb9c4727d9637af2313acbeb925", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a912b09ec834acb9c4727d9637af2313acbeb925", "committedDate": "2020-07-27T21:54:23Z", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putObjectVolatile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3d4364e4ecda4805b245c7122c93cff83b39deb", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b3d4364e4ecda4805b245c7122c93cff83b39deb", "committedDate": "2020-07-27T21:28:08Z", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putObjectVolatile"}, "afterCommit": {"oid": "a912b09ec834acb9c4727d9637af2313acbeb925", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a912b09ec834acb9c4727d9637af2313acbeb925", "committedDate": "2020-07-27T21:54:23Z", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putObjectVolatile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "143fc943edb5ce6eef850639f8ea19788387a2fc", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/143fc943edb5ce6eef850639f8ea19788387a2fc", "committedDate": "2020-07-28T00:50:26Z", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putBooleanVolatile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70a0b9137f79a125b894e389adf000a09f3c6d38", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/70a0b9137f79a125b894e389adf000a09f3c6d38", "committedDate": "2020-07-28T00:27:16Z", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putBooleanVolatile"}, "afterCommit": {"oid": "143fc943edb5ce6eef850639f8ea19788387a2fc", "author": {"user": {"login": "lpriima", "name": "Lev"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/143fc943edb5ce6eef850639f8ea19788387a2fc", "committedDate": "2020-07-28T00:50:26Z", "message": "UnsafeUtils::setStaticFieldViaUnsafe use putBooleanVolatile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MzQ2Mzgz", "url": "https://github.com/DataDog/dd-trace-java/pull/1719#pullrequestreview-456346383", "createdAt": "2020-07-28T06:49:07Z", "commit": {"oid": "143fc943edb5ce6eef850639f8ea19788387a2fc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNjo0OTowOFrOG3-7XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNjo0OTowOFrOG3-7XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM1NTg2OQ==", "bodyText": "Yup, so much better...", "url": "https://github.com/DataDog/dd-trace-java/pull/1719#discussion_r461355869", "createdAt": "2020-07-28T06:49:08Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/testing/src/main/java/datadog/trace/agent/test/utils/UnsafeUtils.java", "diffHunk": "@@ -15,15 +15,17 @@ private static int getJavaVersion() {\n     return Integer.parseInt(javaVersion.substring(beg, end));\n   }\n \n-  private static void setStaticFieldViaUnsafe(final Field field, final Object newValue)\n+  private static void setStaticBooleanFieldViaUnsafe(final Field field, final boolean newValue)\n       throws Exception {\n     final Field unsafeField = sun.misc.Unsafe.class.getDeclaredField(\"theUnsafe\");\n     unsafeField.setAccessible(true);\n     final sun.misc.Unsafe unsafe = (sun.misc.Unsafe) unsafeField.get(null);\n \n+    unsafe.ensureClassInitialized(field.getDeclaringClass());\n+\n     final Object staticFieldBase = unsafe.staticFieldBase(field);\n     final long staticFieldOffset = unsafe.staticFieldOffset(field);\n-    unsafe.putObject(staticFieldBase, staticFieldOffset, newValue);\n+    unsafe.putBooleanVolatile(staticFieldBase, staticFieldOffset, newValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "143fc943edb5ce6eef850639f8ea19788387a2fc"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjUyOTA0", "url": "https://github.com/DataDog/dd-trace-java/pull/1719#pullrequestreview-456652904", "createdAt": "2020-07-28T13:52:44Z", "commit": {"oid": "143fc943edb5ce6eef850639f8ea19788387a2fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2048, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}