{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwODQ0ODE1", "number": 1789, "title": "CI-App: TestNG instrumentation", "bodyText": "Description\n\nAdded instrumentation to trace TestNG v6.4+ test executions.\n\nThe instrumentation is applied to the method initializeDefaultListeners of the class org.testng.TestNG which will be executed during the TestNG test framework launching.\nOnce the method is executed, the datadog.trace.instrumentation.testng.TracingListener is registered in that TestNG instance.\nA datadog.trace.instrumentation.testng.TestNGDecorator instance is used in the listener methods to report the traces.\nThe instrumentation will be disabled by default. This can be enabled configuring the following:\n\nEnvironment Variable: DD_INTEGRATION_TESTNG_ENABLED=true\nSystem Property: -Ddd.integration.testng.enabled=true\n\nAdditionally, some test java classes are created to be used in the tests of this instrumentation. As these classes contain executable tests, it's necessary to exclude them explicitly in the java.gradle file to avoid being executed as part of the dd-java-agent build.", "createdAt": "2020-08-20T11:26:10Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1789", "merged": true, "mergeCommit": {"oid": "4a9ebdae8ca08739143adda6764f1e27a561f96a"}, "closed": true, "closedAt": "2020-08-24T09:24:10Z", "author": {"login": "drodriguezhdez"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAudXygH2gAyNDcwODQ0ODE1OmJiYzlhNmQxYTZhZTM1M2EyNjFhM2RlODAxZjU0ZmQxNDBmZDU2YmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdB-0DoAH2gAyNDcwODQ0ODE1OmNkMWUxNDI4ZjEzNmIxOGEyZTdkZmQ2NzI1NzdmZDQ5ZTg3ZGE5YjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bbc9a6d1a6ae353a261a3de801f54fd140fd56be", "author": {"user": {"login": "drodriguezhdez", "name": "Daniel Rodriguez Hernandez"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bbc9a6d1a6ae353a261a3de801f54fd140fd56be", "committedDate": "2020-08-20T11:24:57Z", "message": "Added TestNG instrumentation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNjIzMDMz", "url": "https://github.com/DataDog/dd-trace-java/pull/1789#pullrequestreview-471623033", "createdAt": "2020-08-20T13:38:39Z", "commit": {"oid": "bbc9a6d1a6ae353a261a3de801f54fd140fd56be"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMzozODo0MFrOHEBojw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMzozODo0MFrOHEBojw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk4MzExOQ==", "bodyText": "Would it be possible to setOutputDirectory to build/tmp/test-output? Then you wouldn't need to add the line in .gitignore.", "url": "https://github.com/DataDog/dd-trace-java/pull/1789#discussion_r473983119", "createdAt": "2020-08-20T13:38:40Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/testng-6.4/src/test/groovy/TestNGTest.groovy", "diffHunk": "@@ -0,0 +1,141 @@\n+import datadog.trace.agent.test.base.TestFrameworkTest\n+import datadog.trace.bootstrap.instrumentation.decorator.TestDecorator\n+import datadog.trace.instrumentation.testng.TestNGDecorator\n+import org.example.TestError\n+import org.example.TestFailed\n+import org.example.TestFailedWithSuccessPercentage\n+import org.example.TestInheritance\n+import org.example.TestSkipped\n+import org.example.TestSucceed\n+import org.testng.TestNG\n+\n+class TestNGTest extends TestFrameworkTest {\n+\n+  def \"test success generates spans\"() {\n+    setup:\n+    def testNG = new TestNG()\n+    testNG.setTestClasses(TestSucceed)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbc9a6d1a6ae353a261a3de801f54fd140fd56be"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNjcwMDI0", "url": "https://github.com/DataDog/dd-trace-java/pull/1789#pullrequestreview-471670024", "createdAt": "2020-08-20T14:27:06Z", "commit": {"oid": "bbc9a6d1a6ae353a261a3de801f54fd140fd56be"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDoyNzo0MlrOHEEOeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDozOTo0MVrOHEEyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyNTU5Mw==", "bodyText": "lol... every time I see this it looks like a typo for testing.", "url": "https://github.com/DataDog/dd-trace-java/pull/1789#discussion_r474025593", "createdAt": "2020-08-20T14:27:42Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/testng-6.4/src/main/java/datadog/trace/instrumentation/testng/TestNGDecorator.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package datadog.trace.instrumentation.testng;\n+\n+import datadog.trace.api.DDTags;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.decorator.TestDecorator;\n+import lombok.extern.slf4j.Slf4j;\n+import org.testng.ITestResult;\n+\n+@Slf4j\n+public class TestNGDecorator extends TestDecorator {\n+  public static final TestNGDecorator DECORATE = new TestNGDecorator();\n+\n+  @Override\n+  public String testFramework() {\n+    return \"testng\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbc9a6d1a6ae353a261a3de801f54fd140fd56be"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzNDM5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              return project.name == \"junit-4.10\" || project.name == \"testng-6.4\"\n          \n          \n            \n              return [ \"junit-4.10\", \"testng-6.4\" ].contains(project.name)\n          \n      \n    \n    \n  \n\n(or something like this... I assume there will be more testing projects.)", "url": "https://github.com/DataDog/dd-trace-java/pull/1789#discussion_r474034393", "createdAt": "2020-08-20T14:39:12Z", "author": {"login": "tylerbenson"}, "path": "gradle/java.gradle", "diffHunk": "@@ -278,7 +278,7 @@ def isJdkForced(String javaName) {\n }\n \n def isTestingInstrumentation(Project project) {\n-  return project.name == \"junit-4.10\"\n+  return project.name == \"junit-4.10\" || project.name == \"testng-6.4\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbc9a6d1a6ae353a261a3de801f54fd140fd56be"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzNDc0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            include 'dd-java-agent:instrumentation:testng-6.4'\n          \n          \n            \n            include ':dd-java-agent:instrumentation:testng-6.4'", "url": "https://github.com/DataDog/dd-trace-java/pull/1789#discussion_r474034742", "createdAt": "2020-08-20T14:39:41Z", "author": {"login": "tylerbenson"}, "path": "settings.gradle", "diffHunk": "@@ -156,6 +156,7 @@ include ':dd-java-agent:instrumentation:spring-scheduling-3.1'\n include ':dd-java-agent:instrumentation:spring-webmvc-3.1'\n include ':dd-java-agent:instrumentation:spring-webflux-5'\n include ':dd-java-agent:instrumentation:spymemcached-2.12'\n+include 'dd-java-agent:instrumentation:testng-6.4'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbc9a6d1a6ae353a261a3de801f54fd140fd56be"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8151071aa7f7ae97d08a3ac9ac3078d66f04ff76", "author": {"user": {"login": "drodriguezhdez", "name": "Daniel Rodriguez Hernandez"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8151071aa7f7ae97d08a3ac9ac3078d66f04ff76", "committedDate": "2020-08-24T08:37:15Z", "message": "Apply feedback suggestions from the review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd1e1428f136b18a2e7dfd672577fd49e87da9b2", "author": {"user": {"login": "drodriguezhdez", "name": "Daniel Rodriguez Hernandez"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cd1e1428f136b18a2e7dfd672577fd49e87da9b2", "committedDate": "2020-08-24T09:02:08Z", "message": "Apply feedback suggestions from code review."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2152, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}