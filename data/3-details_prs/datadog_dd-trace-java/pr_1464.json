{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTcyNzU0", "number": 1464, "title": "Change LZ4 config to reduce allocation rate during decompression", "bodyText": "Currently, our LZ4 compression is using LZ4 Frame format with default block size which is 4MB. The decompressor will then pre-allocated 4MB byte array for each chunk of data although it almost never needed. This is driving the increased allocation pressure in our backend without any other benefits.\nThe block size is controlled by the creator of the compressed data so the change must be in agent.", "createdAt": "2020-05-15T12:48:08Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1464", "merged": true, "mergeCommit": {"oid": "7c340907447d4795a0fd8919a94fd4ec53f36ef2"}, "closed": true, "closedAt": "2020-06-25T15:18:17Z", "author": {"login": "jbachorik"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuF_m4ABqjM0NzMxMjgyNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuviVFABqjM0ODI2NzE0ODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0d928ea8c9b2f295184dd4c0574d0ed1e498409", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f0d928ea8c9b2f295184dd4c0574d0ed1e498409", "committedDate": "2020-05-15T12:47:31Z", "message": "Modify LZ4 blocksize and set expected size"}, "afterCommit": {"oid": "49aa269a952f315f69dea9c7d93400fcd4169243", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/49aa269a952f315f69dea9c7d93400fcd4169243", "committedDate": "2020-06-23T14:04:02Z", "message": "Modify LZ4 blocksize and set expected size"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5e5f9451d434ad47319699b4db9ccf32848688e", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b5e5f9451d434ad47319699b4db9ccf32848688e", "committedDate": "2020-06-23T15:47:07Z", "message": "Blockstream anyone?"}, "afterCommit": {"oid": "4ff8d469d82989aed8ac6666341246df84b2bcf9", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4ff8d469d82989aed8ac6666341246df84b2bcf9", "committedDate": "2020-06-25T10:55:30Z", "message": "Modify LZ4 blocksize"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDA4ODIz", "url": "https://github.com/DataDog/dd-trace-java/pull/1464#pullrequestreview-437408823", "createdAt": "2020-06-25T11:37:41Z", "commit": {"oid": "4ff8d469d82989aed8ac6666341246df84b2bcf9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMTozNzo0MVrOGo2y4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMTozNzo0MVrOGo2y4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5Mzk4Ng==", "bodyText": "It may be nice to leave some comment here explaining what is going on and what all other values mean or where there are coming from.", "url": "https://github.com/DataDog/dd-trace-java/pull/1464#discussion_r445493986", "createdAt": "2020-06-25T11:37:41Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/util/StreamUtils.java", "diffHunk": "@@ -73,7 +73,13 @@\n       return readStream(is, expectedSize, consumer);\n     } else {\n       final FastByteArrayOutputStream baos = new FastByteArrayOutputStream(expectedSize);\n-      try (final OutputStream zipped = new LZ4FrameOutputStream(baos)) {\n+      try (final OutputStream zipped =\n+          new LZ4FrameOutputStream(\n+              baos,\n+              LZ4FrameOutputStream.BLOCKSIZE.SIZE_64KB,\n+              LZ4FrameOutputStream.FLG.Bits.BLOCK_CHECKSUM,\n+              LZ4FrameOutputStream.FLG.Bits.CONTENT_CHECKSUM,\n+              LZ4FrameOutputStream.FLG.Bits.BLOCK_INDEPENDENCE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff8d469d82989aed8ac6666341246df84b2bcf9"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDMyODcz", "url": "https://github.com/DataDog/dd-trace-java/pull/1464#pullrequestreview-437432873", "createdAt": "2020-06-25T12:14:53Z", "commit": {"oid": "8755f3db5fb9d25778104d56bcc4d6dfc0db454a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13931aadc6d91a4fdfe9ef57721fc3e88db267aa", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/13931aadc6d91a4fdfe9ef57721fc3e88db267aa", "committedDate": "2020-06-25T14:28:29Z", "message": "Modify LZ4 blocksize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebdffd219161284b1bfa601a71ef6cf9ada1faa4", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ebdffd219161284b1bfa601a71ef6cf9ada1faa4", "committedDate": "2020-06-25T14:28:29Z", "message": "Revert back to the default bits and add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9385ec1b2773056601c4d89f2bfb76a01f8a6693", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9385ec1b2773056601c4d89f2bfb76a01f8a6693", "committedDate": "2020-06-25T14:28:29Z", "message": "Format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8755f3db5fb9d25778104d56bcc4d6dfc0db454a", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8755f3db5fb9d25778104d56bcc4d6dfc0db454a", "committedDate": "2020-06-25T11:47:29Z", "message": "Revert back to the default bits and add comment"}, "afterCommit": {"oid": "9385ec1b2773056601c4d89f2bfb76a01f8a6693", "author": {"user": {"login": "jbachorik", "name": "Jaroslav Bachorik"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9385ec1b2773056601c4d89f2bfb76a01f8a6693", "committedDate": "2020-06-25T14:28:29Z", "message": "Format"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2505, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}