{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMTA3NDQz", "number": 1283, "title": "Add Classloader precheck to expensive matchers.", "bodyText": "Benchmark results:\nBenchmark                                                             Mode  Cnt   Score   Error  Units\nClassRetransformingBenchmark.WithAgent.testTracedRetransform          avgt       21.933          ms/op\nClassRetransformingBenchmark.WithAgent.testUntracedRetransform        avgt        6.171          ms/op\nClassRetransformingBenchmark.WithAgentMaster.testTracedRetransform    avgt       22.129          ms/op\nClassRetransformingBenchmark.WithAgentMaster.testUntracedRetransform  avgt        6.517          ms/op\nClassRetransformingBenchmark.testTracedRetransform                    avgt        0.876          ms/op\nClassRetransformingBenchmark.testUntracedRetransform                  avgt        0.867          ms/op\n\nI also saw a small improvement in application startup time.", "createdAt": "2020-03-03T18:30:13Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1283", "merged": true, "mergeCommit": {"oid": "95534b7bb86fd7c498f04df80056463b3713989b"}, "closed": true, "closedAt": "2020-03-04T04:39:40Z", "author": {"login": "tylerbenson"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKGoqPAH2gAyMzgzMTA3NDQzOjc3MDJiMDU4NWI4Yzk4YjA4YTQ4OWI0MGQ5ZjJkZTRhNjgxODZhNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKWJaXgFqTM2ODczOTMxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7702b0585b8c98b08a489b40d9f2de4a68186a4a", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7702b0585b8c98b08a489b40d9f2de4a68186a4a", "committedDate": "2020-03-03T18:29:10Z", "message": "Add Classloader precheck to expensive matchers.\n\nBenchmark results:\n```\nBenchmark                                                             Mode  Cnt   Score   Error  Units\nClassRetransformingBenchmark.WithAgent.testTracedRetransform          avgt       21.933          ms/op\nClassRetransformingBenchmark.WithAgent.testUntracedRetransform        avgt        6.171          ms/op\nClassRetransformingBenchmark.WithAgentMaster.testTracedRetransform    avgt       22.129          ms/op\nClassRetransformingBenchmark.WithAgentMaster.testUntracedRetransform  avgt        6.517          ms/op\nClassRetransformingBenchmark.testTracedRetransform                    avgt        0.876          ms/op\nClassRetransformingBenchmark.testUntracedRetransform                  avgt        0.867          ms/op\n```\n\nI also saw a small improvement in application startup time."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/042f49d800b4ea60ad8c27ae43925e1ac218f41d", "committedDate": "2020-03-03T19:03:01Z", "message": "fix muzzle and retry tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDAwMjAx", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#pullrequestreview-368400201", "createdAt": "2020-03-03T23:26:06Z", "commit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDU1NTg1", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#pullrequestreview-368455585", "createdAt": "2020-03-04T01:55:45Z", "commit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMTo1NTo0NVrOFxdfFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMTo1NTo0NVrOFxdfFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwNzYzNg==", "bodyText": "The double negative is a bit hard to read.  I think a utility method would help clarity greatly.", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#discussion_r387407636", "createdAt": "2020-03-04T01:55:45Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/instrumentation/aws-java-sdk-1.11.0/src/main/java/datadog/trace/instrumentation/aws/v0/RequestInstrumentation.java", "diffHunk": "@@ -25,6 +27,12 @@ public RequestInstrumentation() {\n     super(\"aws-sdk\");\n   }\n \n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    // Optimization for expensive typeMatcher.\n+    return not(classLoaderHasNoResources(\"com/amazonaws/AmazonWebServiceRequest.class\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDU2MTY5", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#pullrequestreview-368456169", "createdAt": "2020-03-04T01:57:56Z", "commit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMTo1Nzo1NlrOFxdhBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMTo1Nzo1NlrOFxdhBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwODEzMw==", "bodyText": "One observation from the field injection optimization.  Often our classLoaderMatchers are really more aim at matching a library or an API, but we don't really have that as a concept in the code.\nI think this change also suggest that we should have some notion of a Library go which Instrumenters refer.", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#discussion_r387408133", "createdAt": "2020-03-04T01:57:56Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/instrumentation/hibernate/core-4.3/src/main/java/datadog/trace/instrumentation/hibernate/core/v4_3/ProcedureCallInstrumentation.java", "diffHunk": "@@ -43,6 +45,12 @@ public ProcedureCallInstrumentation() {\n     };\n   }\n \n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    // Optimization for expensive typeMatcher.\n+    return not(classLoaderHasNoResources(\"org/hibernate/Session.class\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDU2NTgw", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#pullrequestreview-368456580", "createdAt": "2020-03-04T01:59:27Z", "commit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMTo1OToyN1rOFxdiSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMTo1OToyN1rOFxdiSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwODQ1OA==", "bodyText": "I think this speaks to the fact that we should make a classLoaderHasResources.  Then this could be a single matcher.", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#discussion_r387408458", "createdAt": "2020-03-04T01:59:27Z", "author": {"login": "dougqh"}, "path": "dd-java-agent/instrumentation/jedis-1.4/src/main/java/datadog/trace/instrumentation/jedis/JedisInstrumentation.java", "diffHunk": "@@ -33,7 +34,9 @@ public JedisInstrumentation() {\n \n   @Override\n   public ElementMatcher<ClassLoader> classLoaderMatcher() {\n-    return classLoaderHasNoResources(\"redis/clients/jedis/commands/ProtocolCommand.class\");\n+    return classLoaderHasNoResources(\"redis/clients/jedis/commands/ProtocolCommand.class\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDU4MzU0", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#pullrequestreview-368458354", "createdAt": "2020-03-04T02:05:38Z", "commit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzM5MzE2", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#pullrequestreview-368739316", "createdAt": "2020-03-04T12:33:30Z", "commit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMjozMzozMVrOFxreBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMjozMzozMVrOFxreBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzNjc0MA==", "bodyText": "Double negatives are somewhat hard to read", "url": "https://github.com/DataDog/dd-trace-java/pull/1283#discussion_r387636740", "createdAt": "2020-03-04T12:33:31Z", "author": {"login": "mar-kolya"}, "path": "dd-java-agent/instrumentation/apache-httpasyncclient-4/src/main/java/datadog/trace/instrumentation/apachehttpasyncclient/ApacheHttpAsyncClientInstrumentation.java", "diffHunk": "@@ -38,6 +40,12 @@ public ApacheHttpAsyncClientInstrumentation() {\n     super(\"httpasyncclient\", \"apache-httpasyncclient\");\n   }\n \n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    // Optimization for expensive typeMatcher.\n+    return not(classLoaderHasNoResources(\"org/apache/http/nio/client/HttpAsyncClient.class\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "042f49d800b4ea60ad8c27ae43925e1ac218f41d"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2543, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}