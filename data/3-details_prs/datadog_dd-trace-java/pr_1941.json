{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NDkwMDAz", "number": 1941, "title": "Don't treat dispatch servlet spans as top level", "bodyText": "Previously, when using dispatch, propagation information was passed from the dispatching servlet to the dispatched servlet through HTTP headers.  Using this mechanism, the new servlet span was a \"top level\" span creating 2 toplevel spans in the trace.  This treatment was incorrect as the new servlet request is just a continuation of the same local trace.\nTo change the behavior, I use DD_DISPATCH_SPAN_ATTRIBUTE to pass the span from the dispatching servlet to the dispatched servlet.\nFor the tests, things are simplified somewhat.  The dispatching servlet is the serverSpan and the dispatched servlet is the handlerSpan.\nI'll create another pull request to make span sorting the default.  For this pull request, I made minimal additions to get these tests to pass.", "createdAt": "2020-10-01T19:16:55Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1941", "merged": true, "mergeCommit": {"oid": "54caccfc3a9077f57b1984be5775dd516dd83ff1"}, "closed": true, "closedAt": "2020-10-05T18:14:26Z", "author": {"login": "randomanderson"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOB57OgH2gAyNDk2NDkwMDAzOjVlMWIyOTI2MzJjMmI4NDdhNGM0OGM5ZTcyMjA2NmRkZDU1NTY4NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOpqKSAFqTUwMTMyODEwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5e1b292632c2b847a4c48c9e722066ddd5556860", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5e1b292632c2b847a4c48c9e722066ddd5556860", "committedDate": "2020-09-30T19:25:21Z", "message": "Have dispatched servlet spans belong to the same chunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77a067974519219702e269b90ead187a2d77ef72", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/77a067974519219702e269b90ead187a2d77ef72", "committedDate": "2020-10-01T19:04:47Z", "message": "adjust tests\n\nFix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb", "author": {"user": {"login": "randomanderson", "name": "Laplie Anderson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5cda215725cb453547176de2a7bec4bf2bf56efb", "committedDate": "2020-10-01T19:36:57Z", "message": "Codenarc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTc3OTcx", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#pullrequestreview-500977971", "createdAt": "2020-10-02T09:12:36Z", "commit": {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwOToxMjozNlrOHbmpUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwOToxMjozNlrOHbmpUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwNjc2OQ==", "bodyText": "Just as a case in point, this is one of the reasons I think inheritance hierarchies aren't suitable for tests.", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#discussion_r498706769", "createdAt": "2020-10-02T09:12:36Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/servlet/request-3/src/test/groovy/AbstractServlet3Test.groovy", "diffHunk": "@@ -74,8 +87,52 @@ abstract class AbstractServlet3Test<SERVER, CONTEXT> extends HttpServerTest<SERV\n     super.request(uri, method, body)\n   }\n \n+  // Almost identical to serverSpan()\n+  @Override\n+  void handlerSpan(TraceAssert trace, Object parent, ServerEndpoint endpoint = SUCCESS) {\n+    if (!isDispatch()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTc4Njk2", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#pullrequestreview-500978696", "createdAt": "2020-10-02T09:13:43Z", "commit": {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwOToxMzo0M1rOHbmrVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwOToxMzo0M1rOHbmrVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwNzI4Nw==", "bodyText": "Can we uncomment this and @Ignore it instead?", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#discussion_r498707287", "createdAt": "2020-10-02T09:13:43Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/servlet/request-3/src/test/groovy/JettyServlet3Test.groovy", "diffHunk": "@@ -124,12 +115,15 @@ class JettyServlet3TestFakeAsync extends JettyServlet3Test {\n }\n \n // FIXME: not working right now...\n-//class JettyServlet3TestForward extends JettyDispatchTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjY3OTEx", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#pullrequestreview-501267911", "createdAt": "2020-10-02T16:11:36Z", "commit": {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMzI4MTA3", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#pullrequestreview-501328107", "createdAt": "2020-10-02T17:42:59Z", "commit": {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzo0Mjo1OVrOHb2LaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzo0Mjo1OVrOHb2LaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2MTI1Ng==", "bodyText": "I don't think we still need to inject anymore, right?", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#discussion_r498961256", "createdAt": "2020-10-02T17:42:59Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/servlet/request-3/src/main/java/datadog/trace/instrumentation/servlet3/AsyncContextInstrumentation.java", "diffHunk": "@@ -78,6 +79,8 @@ public static boolean enter(\n         if (request instanceof HttpServletRequest) {\n           propagate().inject(span, (HttpServletRequest) request, SETTER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3190, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}