{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwMzg5NDgx", "number": 2141, "title": "Use same logging logic for APM and profile uploaders.", "bodyText": "We have 2 uploaders in dd-trace-java. The trace one has a lot of logic to prevent it from becoming too verbose if logger level is info or above while still keeping track of the most important info. The profiling uploader did a poorer job of this and actually printed stacktraces on every IOException.\nInstead of just copying more behaviour from one uploader to the other, this PR attempts to standardize logging around uploading so both trace and profile uploading logs follow the same structure and behaviour (and test it).", "createdAt": "2020-12-01T15:35:09Z", "url": "https://github.com/DataDog/dd-trace-java/pull/2141", "merged": true, "mergeCommit": {"oid": "4791e3db2fcc0b06390ee9f5b11a479178bcdc28"}, "closed": true, "closedAt": "2020-12-04T17:46:34Z", "author": {"login": "AlexJF"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh70UigFqTU0MjAyNjUxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdikkRuABqjQwNjc5OTUzODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDI2NTEx", "url": "https://github.com/DataDog/dd-trace-java/pull/2141#pullrequestreview-542026511", "createdAt": "2020-12-01T15:38:17Z", "commit": {"oid": "69a7c59f3367ec830b70afbf42da8d3f8ee741e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDU4NTgw", "url": "https://github.com/DataDog/dd-trace-java/pull/2141#pullrequestreview-542058580", "createdAt": "2020-12-01T16:08:54Z", "commit": {"oid": "69a7c59f3367ec830b70afbf42da8d3f8ee741e4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjowODo1NFrOH80UuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjowODo1NFrOH80UuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUzMzg4MA==", "bodyText": "Feels weird that this formatting would change.", "url": "https://github.com/DataDog/dd-trace-java/pull/2141#discussion_r533533880", "createdAt": "2020-12-01T16:08:54Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -200,41 +189,20 @@ private void countAndLogFailedSend(\n     this.failedTraces += traceCount;\n     // these are used to catch and log if there is a failure in debug logging the response body\n     String agentError = getResponseBody(response);\n-    if (log.isDebugEnabled()) {\n-      String sendErrorString =\n-          createSendLogMessage(\n-              traceCount, sizeInBytes, agentError.isEmpty() ? \"Error\" : agentError);\n-      if (response != null) {\n-        log.debug(\n-            \"{} Status: {}, Response: {}, Body: {}\",\n-            sendErrorString,\n-            response.code(),\n-            response.message(),\n-            agentError);\n-      } else if (outer != null) {\n-        log.debug(sendErrorString, outer);\n-      } else {\n-        log.debug(sendErrorString);\n-      }\n-      return;\n-    }\n     String sendErrorString =\n-        createSendLogMessage(traceCount, sizeInBytes, agentError.isEmpty() ? \"Error\" : agentError);\n-    boolean hasLogged;\n-    if (response != null) {\n-      hasLogged =\n-          ratelimitedLogger.warn(\n-              \"{} Status: {} {}\", sendErrorString, response.code(), response.message());\n-    } else if (outer != null) {\n-      hasLogged =\n-          ratelimitedLogger.warn(\n-              \"{} {}: {}\", sendErrorString, outer.getClass().getName(), outer.getMessage());\n-    } else {\n-      hasLogged = ratelimitedLogger.warn(sendErrorString);\n-    }\n-    if (hasLogged) {\n-      this.logNextSuccess = true;\n+      createSendLogMessage(\n+        traceCount,\n+        sizeInBytes,\n+        agentError.isEmpty() ? \"Error\" : agentError);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69a7c59f3367ec830b70afbf42da8d3f8ee741e4"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMjkyNjM1", "url": "https://github.com/DataDog/dd-trace-java/pull/2141#pullrequestreview-542292635", "createdAt": "2020-12-01T21:01:38Z", "commit": {"oid": "d0a8829acaa21a3aa35e503d7e10575331346f9f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMTowMTozOFrOH8_nUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMTowMTozOFrOH8_nUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcxODg2Ng==", "bodyText": "Perhaps IOLogger instead?  We don't really deem writing traces to the agent as \"uploading\".", "url": "https://github.com/DataDog/dd-trace-java/pull/2141#discussion_r533718866", "createdAt": "2020-12-01T21:01:38Z", "author": {"login": "tylerbenson"}, "path": "internal-api/src/main/java/datadog/trace/api/UploadLogger.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package datadog.trace.api;\n+\n+import java.util.concurrent.TimeUnit;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+import org.slf4j.Logger;\n+\n+/** Logger specialized on logging upload-related activity */\n+public class UploadLogger {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0a8829acaa21a3aa35e503d7e10575331346f9f"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0a8829acaa21a3aa35e503d7e10575331346f9f", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d0a8829acaa21a3aa35e503d7e10575331346f9f", "committedDate": "2020-12-01T16:50:25Z", "message": "[PROF-2396] Fix style & codenarc warnings."}, "afterCommit": {"oid": "52b77da66ebe69f2733f43835485886c97b1ce5a", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/52b77da66ebe69f2733f43835485886c97b1ce5a", "committedDate": "2020-12-02T16:43:10Z", "message": "Use same logging logic for APM and profile uploaders."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52b77da66ebe69f2733f43835485886c97b1ce5a", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/52b77da66ebe69f2733f43835485886c97b1ce5a", "committedDate": "2020-12-02T16:43:10Z", "message": "Use same logging logic for APM and profile uploaders."}, "afterCommit": {"oid": "82ba723f800de0ca2b7fd554aae6ea0d23409520", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/82ba723f800de0ca2b7fd554aae6ea0d23409520", "committedDate": "2020-12-03T11:16:07Z", "message": "Use same logging logic for APM and profile uploaders."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82ba723f800de0ca2b7fd554aae6ea0d23409520", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/82ba723f800de0ca2b7fd554aae6ea0d23409520", "committedDate": "2020-12-03T11:16:07Z", "message": "Use same logging logic for APM and profile uploaders."}, "afterCommit": {"oid": "6a80202f2e11ef4676ac43d727a143eedcf9e2ad", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6a80202f2e11ef4676ac43d727a143eedcf9e2ad", "committedDate": "2020-12-03T11:52:02Z", "message": "Use same logging logic for APM and profile uploaders."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f90997bb50b4451b229871ba7b80dd8d0b766fe3", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f90997bb50b4451b229871ba7b80dd8d0b766fe3", "committedDate": "2020-12-03T15:05:30Z", "message": "Use same logging logic for APM and profile uploaders."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a80202f2e11ef4676ac43d727a143eedcf9e2ad", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6a80202f2e11ef4676ac43d727a143eedcf9e2ad", "committedDate": "2020-12-03T11:52:02Z", "message": "Use same logging logic for APM and profile uploaders."}, "afterCommit": {"oid": "f90997bb50b4451b229871ba7b80dd8d0b766fe3", "author": {"user": {"login": "AlexJF", "name": "Alexandre Fonseca"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f90997bb50b4451b229871ba7b80dd8d0b766fe3", "committedDate": "2020-12-03T15:05:30Z", "message": "Use same logging logic for APM and profile uploaders."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2895, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}