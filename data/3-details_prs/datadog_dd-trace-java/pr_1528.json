{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MTk3Mzgx", "number": 1528, "title": "Use ClassValue to store ThreadLocal call depth", "bodyText": "@bantonsson can you try this?", "createdAt": "2020-06-03T13:20:24Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1528", "merged": true, "mergeCommit": {"oid": "198e7db23ce2601c2bcf5b205ca4c1ca356102fc"}, "closed": true, "closedAt": "2020-06-03T15:49:59Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnnHNXAH2gAyNDI3MTk3MzgxOmUzYjAxNDViMWFmNTBhNmM2ODQ1MjdmNmUwM2M3OTdiYWJmM2M0ZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnrJbugH2gAyNDI3MTk3MzgxOjQyYzQ4OGEwYjI4YjM5NzhhOWYyNTg2MDI0NzcyYzc3ZTllMjQ3MjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3b0145b1af50a6c684527f6e03c797babf3c4da", "author": {"user": {"login": "bantonsson", "name": "Bj\u00f6rn Antonsson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e3b0145b1af50a6c684527f6e03c797babf3c4da", "committedDate": "2020-06-03T10:43:18Z", "message": "Reuse CallDepth HasMap nodes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99ed45d9073427881ce9a4c2d3cd045402d03fe0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/99ed45d9073427881ce9a4c2d3cd045402d03fe0", "committedDate": "2020-06-03T14:33:05Z", "message": "make codenarc happy"}, "afterCommit": {"oid": "be73bf9ca46d412ed8a115fdbc93928dc6f8c636", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/be73bf9ca46d412ed8a115fdbc93928dc6f8c636", "committedDate": "2020-06-03T14:45:41Z", "message": "store ThreadLocal per-class depths in a ClassValue map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be73bf9ca46d412ed8a115fdbc93928dc6f8c636", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/be73bf9ca46d412ed8a115fdbc93928dc6f8c636", "committedDate": "2020-06-03T14:45:41Z", "message": "store ThreadLocal per-class depths in a ClassValue map"}, "afterCommit": {"oid": "f183719eddfa86afcdacef5bcf31f003693878e1", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f183719eddfa86afcdacef5bcf31f003693878e1", "committedDate": "2020-06-03T14:49:57Z", "message": "store ThreadLocal per-class depths in a ClassValue map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f69a124432c26e5a8fc679cba2af0d598a471f5", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5f69a124432c26e5a8fc679cba2af0d598a471f5", "committedDate": "2020-06-03T14:54:48Z", "message": "store ThreadLocal per-class depths in a ClassValue map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f183719eddfa86afcdacef5bcf31f003693878e1", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f183719eddfa86afcdacef5bcf31f003693878e1", "committedDate": "2020-06-03T14:49:57Z", "message": "store ThreadLocal per-class depths in a ClassValue map"}, "afterCommit": {"oid": "5f69a124432c26e5a8fc679cba2af0d598a471f5", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5f69a124432c26e5a8fc679cba2af0d598a471f5", "committedDate": "2020-06-03T14:54:48Z", "message": "store ThreadLocal per-class depths in a ClassValue map"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjM4NDU0", "url": "https://github.com/DataDog/dd-trace-java/pull/1528#pullrequestreview-423638454", "createdAt": "2020-06-03T14:55:05Z", "commit": {"oid": "f183719eddfa86afcdacef5bcf31f003693878e1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDo1NToyM1rOGefwRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDo1NToyM1rOGefwRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYzMDcyNA==", "bodyText": "Crazy idea, but instead of removing, should we just reset the depth to 0?", "url": "https://github.com/DataDog/dd-trace-java/pull/1528#discussion_r434630724", "createdAt": "2020-06-03T14:55:23Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/CallDepthThreadLocalMap.java", "diffHunk": "@@ -1,36 +1,45 @@\n package datadog.trace.bootstrap;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-\n /**\n  * Utility to track nested instrumentation.\n  *\n  * <p>For example, this can be used to track nested calls to super() in constructors by calling\n  * #incrementCallDepth at the beginning of each constructor.\n  */\n public class CallDepthThreadLocalMap {\n-  private static final ThreadLocal<Map<Object, Integer>> TLS =\n-      new ThreadLocal<Map<Object, Integer>>() {\n+\n+  private static final ClassValue<ThreadLocalDepth> TLS =\n+      new ClassValue<ThreadLocalDepth>() {\n         @Override\n-        public Map<Object, Integer> initialValue() {\n-          return new HashMap<>();\n+        protected ThreadLocalDepth computeValue(Class<?> type) {\n+          return new ThreadLocalDepth();\n         }\n       };\n \n-  public static int incrementCallDepth(final Object k) {\n-    final Map<Object, Integer> map = TLS.get();\n-    Integer depth = map.get(k);\n-    if (depth == null) {\n-      depth = 0;\n-    } else {\n-      depth += 1;\n+  public static int incrementCallDepth(final Class<?> k) {\n+    return TLS.get(k).get().increment();\n+  }\n+\n+  public static void reset(final Class<?> k) {\n+    TLS.get(k).remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f69a124432c26e5a8fc679cba2af0d598a471f5"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjY1ODIy", "url": "https://github.com/DataDog/dd-trace-java/pull/1528#pullrequestreview-423665822", "createdAt": "2020-06-03T15:22:46Z", "commit": {"oid": "5f69a124432c26e5a8fc679cba2af0d598a471f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42c488a0b28b3978a9f2586024772c77e9e24721", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/42c488a0b28b3978a9f2586024772c77e9e24721", "committedDate": "2020-06-03T15:25:21Z", "message": "reinitialise Depth rather than removing ThreadLocal"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2344, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}