{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MjAxODI1", "number": 1711, "title": "use spring-webflux-5.1+ ClientResponse.rawStatusCode when available", "bodyText": "Allows support for non-standard HTTP status codes which webflux allows access to from 5.1.0+ via method handles. Still works with older webflux versions but the absence of ClientResponse.rawStatusCode will raise an error and default to the strict mode of webflux 5.0.0, which is all we can really do.\nI muzzle all combinations of spring-webflux/reactor-netty except for webflux 5.0.0/reactor-netty 0.8.0 which can't exist.\nI ruled out cloning the instrumentation for webflux 5.1.0+ because it would lead to too much duplication, and I found no good way to detect which webflux version was present. I also ruled out dropping support for webflux 5.0.0.", "createdAt": "2020-07-24T10:14:40Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1711", "merged": true, "mergeCommit": {"oid": "a0bc119d5b9b03434411686a420f904c20b1311c"}, "closed": true, "closedAt": "2020-07-27T16:54:41Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4Bi-ggBqjM1ODM0MjkxOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5EzrfAFqTQ1NTk2NDk4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3571d300ee32dafe32b2a6001cd83298cbc81ed", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b3571d300ee32dafe32b2a6001cd83298cbc81ed", "committedDate": "2020-07-24T10:14:08Z", "message": "use spring-webflux-5.1+ when available"}, "afterCommit": {"oid": "5b37fbeb6aaa62afd395fc5047f08217411d1aeb", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5b37fbeb6aaa62afd395fc5047f08217411d1aeb", "committedDate": "2020-07-24T10:33:47Z", "message": "use spring-webflux-5.1+ when available"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0OTEzOTM0", "url": "https://github.com/DataDog/dd-trace-java/pull/1711#pullrequestreview-454913934", "createdAt": "2020-07-24T14:05:04Z", "commit": {"oid": "5b37fbeb6aaa62afd395fc5047f08217411d1aeb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDowNTowNFrOG2wpfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDowNTowNFrOG2wpfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3MzM0MA==", "bodyText": "I think muzzle will cause problems here... it will prevent the instrumentation from loading on any classloader that doesn't have the new method.  You'll likely need to split/copy the instrumentation to handle this properly.", "url": "https://github.com/DataDog/dd-trace-java/pull/1711#discussion_r460073340", "createdAt": "2020-07-24T14:05:04Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/main/java8/datadog/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientDecorator.java", "diffHunk": "@@ -41,6 +41,10 @@ protected URI url(final ClientRequest httpRequest) {\n \n   @Override\n   protected Integer status(final ClientResponse httpResponse) {\n-    return httpResponse.statusCode().value();\n+    try {\n+      return httpResponse.rawStatusCode();\n+    } catch (NoSuchMethodError mustBeUsingWebfluxV5_0) { // method not available in 5.0.0\n+      return httpResponse.statusCode().value();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b37fbeb6aaa62afd395fc5047f08217411d1aeb"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05d5560139e2aa071951057412e224f12fd5115f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/05d5560139e2aa071951057412e224f12fd5115f", "committedDate": "2020-07-24T15:35:32Z", "message": "roll tests back to spring boot 2.0"}, "afterCommit": {"oid": "5b37fbeb6aaa62afd395fc5047f08217411d1aeb", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5b37fbeb6aaa62afd395fc5047f08217411d1aeb", "committedDate": "2020-07-24T10:33:47Z", "message": "use spring-webflux-5.1+ when available"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b37fbeb6aaa62afd395fc5047f08217411d1aeb", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5b37fbeb6aaa62afd395fc5047f08217411d1aeb", "committedDate": "2020-07-24T10:33:47Z", "message": "use spring-webflux-5.1+ when available"}, "afterCommit": {"oid": "1781029b9f80910fff24ce4816779509bc601955", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1781029b9f80910fff24ce4816779509bc601955", "committedDate": "2020-07-24T18:46:00Z", "message": "use spring-webflux-5.1+ when available"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1781029b9f80910fff24ce4816779509bc601955", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1781029b9f80910fff24ce4816779509bc601955", "committedDate": "2020-07-24T18:46:00Z", "message": "use spring-webflux-5.1+ when available"}, "afterCommit": {"oid": "017b268d7245cd716105b6e1ca415795319b309f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/017b268d7245cd716105b6e1ca415795319b309f", "committedDate": "2020-07-24T19:10:35Z", "message": "use spring-webflux-5.1+ when available"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjY1ODY3", "url": "https://github.com/DataDog/dd-trace-java/pull/1711#pullrequestreview-455265867", "createdAt": "2020-07-25T06:31:50Z", "commit": {"oid": "017b268d7245cd716105b6e1ca415795319b309f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQwNjozMTo1MFrOG3C6sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQwNjozMjo1MVrOG3C68Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM3MjY1Nw==", "bodyText": "This var is mutable and we can't guarantee no side effects here. That's why it's better to be lower case (same as log):\nhttps://google.github.io/styleguide/javaguide.html#s5.2.4-constant-names", "url": "https://github.com/DataDog/dd-trace-java/pull/1711#discussion_r460372657", "createdAt": "2020-07-25T06:31:50Z", "author": {"login": "lpriima"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/main/java8/datadog/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientDecorator.java", "diffHunk": "@@ -11,6 +14,8 @@\n public class SpringWebfluxHttpClientDecorator\n     extends HttpClientDecorator<ClientRequest, ClientResponse> {\n \n+  private static final MethodHandle RAW_STATUS_CODE = findRawStatusCode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017b268d7245cd716105b6e1ca415795319b309f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM3MjcyMQ==", "bodyText": "maybe log.debug()", "url": "https://github.com/DataDog/dd-trace-java/pull/1711#discussion_r460372721", "createdAt": "2020-07-25T06:32:51Z", "author": {"login": "lpriima"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/main/java8/datadog/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientDecorator.java", "diffHunk": "@@ -41,6 +46,21 @@ protected URI url(final ClientRequest httpRequest) {\n \n   @Override\n   protected Integer status(final ClientResponse httpResponse) {\n+    if (null != RAW_STATUS_CODE) {\n+      try {\n+        return (int) RAW_STATUS_CODE.invokeExact(httpResponse);\n+      } catch (Throwable ignored) {\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017b268d7245cd716105b6e1ca415795319b309f"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d04226669b71e97e74461394847849ab3c5a6fc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0d04226669b71e97e74461394847849ab3c5a6fc", "committedDate": "2020-07-27T16:26:45Z", "message": "use spring-webflux-5.1+ when available"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "017b268d7245cd716105b6e1ca415795319b309f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/017b268d7245cd716105b6e1ca415795319b309f", "committedDate": "2020-07-24T19:10:35Z", "message": "use spring-webflux-5.1+ when available"}, "afterCommit": {"oid": "0d04226669b71e97e74461394847849ab3c5a6fc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0d04226669b71e97e74461394847849ab3c5a6fc", "committedDate": "2020-07-27T16:26:45Z", "message": "use spring-webflux-5.1+ when available"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTY0OTg4", "url": "https://github.com/DataDog/dd-trace-java/pull/1711#pullrequestreview-455964988", "createdAt": "2020-07-27T16:55:50Z", "commit": {"oid": "0d04226669b71e97e74461394847849ab3c5a6fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2032, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}