{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NjE0MzE3", "number": 1759, "title": "refactor class and name based resource name caching", "bodyText": "", "createdAt": "2020-08-07T13:45:27Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1759", "merged": true, "mergeCommit": {"oid": "de523f4d786ca381b78a34089e9e547ecdc95f44"}, "closed": true, "closedAt": "2020-08-07T16:53:49Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8kuEBAFqTQ2MzMyNzEyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9w9gMgFqTQ2NDc4NTQ0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMzI3MTI2", "url": "https://github.com/DataDog/dd-trace-java/pull/1759#pullrequestreview-463327126", "createdAt": "2020-08-07T13:48:26Z", "commit": {"oid": "71406e734589995bd59e850aeff6af1aff6c6fb4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0ODoyNlrOG9aldw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0ODoyNlrOG9aldw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1MTg5NQ==", "bodyText": "I noticed based on the contents of serviceNames and operationNames in a customer heap dump, and afterwards consulting the AWS SDK, that caching the resource name would be very low cardinality and a quick win.", "url": "https://github.com/DataDog/dd-trace-java/pull/1759#discussion_r467051895", "createdAt": "2020-08-07T13:48:26Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/aws-java-sdk-1.11.0/src/main/java/datadog/trace/instrumentation/aws/v0/AwsSdkClientDecorator.java", "diffHunk": "@@ -7,18 +7,34 @@\n import datadog.trace.api.DDTags;\n import datadog.trace.bootstrap.ContextStore;\n import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Function;\n+import datadog.trace.bootstrap.instrumentation.api.Functions;\n import datadog.trace.bootstrap.instrumentation.api.InstrumentationTags;\n+import datadog.trace.bootstrap.instrumentation.api.QualifiedClassNameCache;\n import datadog.trace.bootstrap.instrumentation.decorator.HttpClientDecorator;\n import java.net.URI;\n-import java.util.Map;\n-import java.util.concurrent.ConcurrentHashMap;\n \n public class AwsSdkClientDecorator extends HttpClientDecorator<Request, Response> {\n \n   static final String COMPONENT_NAME = \"java-aws-sdk\";\n \n-  private final Map<String, String> serviceNames = new ConcurrentHashMap<>();\n-  private final Map<Class, String> operationNames = new ConcurrentHashMap<>();\n+  private final QualifiedClassNameCache cache =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71406e734589995bd59e850aeff6af1aff6c6fb4"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3797bc773551636f41566435a6ad281feea9df50", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3797bc773551636f41566435a6ad281feea9df50", "committedDate": "2020-08-07T14:07:00Z", "message": "refactor class and name based resource name caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71406e734589995bd59e850aeff6af1aff6c6fb4", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/71406e734589995bd59e850aeff6af1aff6c6fb4", "committedDate": "2020-08-07T13:44:41Z", "message": "refactor class and name based resource name caching"}, "afterCommit": {"oid": "3797bc773551636f41566435a6ad281feea9df50", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3797bc773551636f41566435a6ad281feea9df50", "committedDate": "2020-08-07T14:07:00Z", "message": "refactor class and name based resource name caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDA1OTA4", "url": "https://github.com/DataDog/dd-trace-java/pull/1759#pullrequestreview-463405908", "createdAt": "2020-08-07T15:30:07Z", "commit": {"oid": "3797bc773551636f41566435a6ad281feea9df50"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNTozMDowN1rOG9eTCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNTozMDowN1rOG9eTCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzExMjcxMw==", "bodyText": "Nice catch!", "url": "https://github.com/DataDog/dd-trace-java/pull/1759#discussion_r467112713", "createdAt": "2020-08-07T15:30:07Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/aws-java-sdk-1.11.0/src/main/java/datadog/trace/instrumentation/aws/v0/AwsSdkClientDecorator.java", "diffHunk": "@@ -7,18 +7,34 @@\n import datadog.trace.api.DDTags;\n import datadog.trace.bootstrap.ContextStore;\n import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Function;\n+import datadog.trace.bootstrap.instrumentation.api.Functions;\n import datadog.trace.bootstrap.instrumentation.api.InstrumentationTags;\n+import datadog.trace.bootstrap.instrumentation.api.QualifiedClassNameCache;\n import datadog.trace.bootstrap.instrumentation.decorator.HttpClientDecorator;\n import java.net.URI;\n-import java.util.Map;\n-import java.util.concurrent.ConcurrentHashMap;\n \n public class AwsSdkClientDecorator extends HttpClientDecorator<Request, Response> {\n \n   static final String COMPONENT_NAME = \"java-aws-sdk\";\n \n-  private final Map<String, String> serviceNames = new ConcurrentHashMap<>();\n-  private final Map<Class, String> operationNames = new ConcurrentHashMap<>();\n+  private final QualifiedClassNameCache cache =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1MTg5NQ=="}, "originalCommit": {"oid": "71406e734589995bd59e850aeff6af1aff6c6fb4"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42caccc6ef83a23dc545edb5a290a08f022b51ed", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/42caccc6ef83a23dc545edb5a290a08f022b51ed", "committedDate": "2020-08-07T15:36:53Z", "message": "use CharSequence for cacheable values, which saves a lot of UTF-8 conversions"}, "afterCommit": {"oid": "e9f4865eba8070d5932859c805c9aa9008abfbe6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e9f4865eba8070d5932859c805c9aa9008abfbe6", "committedDate": "2020-08-07T16:07:05Z", "message": "use CharSequence for cacheable values, which saves a lot of UTF-8 conversions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "564e510e5983ee4a2943a3be92a090670bb1d8bf", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/564e510e5983ee4a2943a3be92a090670bb1d8bf", "committedDate": "2020-08-07T16:15:47Z", "message": "foo"}, "afterCommit": {"oid": "8ab01a4ffa134a61098b3db8333eb9cbdd621dfe", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8ab01a4ffa134a61098b3db8333eb9cbdd621dfe", "committedDate": "2020-08-07T16:21:15Z", "message": "formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a78f9600353d4995c4fd6c104ca66494dc67a98", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1a78f9600353d4995c4fd6c104ca66494dc67a98", "committedDate": "2020-08-07T16:22:26Z", "message": "use CharSequence for cacheable values, which saves a lot of UTF-8 conversions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ab01a4ffa134a61098b3db8333eb9cbdd621dfe", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8ab01a4ffa134a61098b3db8333eb9cbdd621dfe", "committedDate": "2020-08-07T16:21:15Z", "message": "formatting"}, "afterCommit": {"oid": "1a78f9600353d4995c4fd6c104ca66494dc67a98", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1a78f9600353d4995c4fd6c104ca66494dc67a98", "committedDate": "2020-08-07T16:22:26Z", "message": "use CharSequence for cacheable values, which saves a lot of UTF-8 conversions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1adaa7480ba3e51e45868ac7d24168e8c7859da9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1adaa7480ba3e51e45868ac7d24168e8c7859da9", "committedDate": "2020-08-07T16:26:06Z", "message": "no longer expect the operation name to be a string during serialisation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDQ0NDk1", "url": "https://github.com/DataDog/dd-trace-java/pull/1759#pullrequestreview-463444495", "createdAt": "2020-08-07T16:26:29Z", "commit": {"oid": "1a78f9600353d4995c4fd6c104ca66494dc67a98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbbf72aa498814883561bfd1532fb1c5123cbf89", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bbbf72aa498814883561bfd1532fb1c5123cbf89", "committedDate": "2020-08-07T16:37:59Z", "message": "address more tests which assumed resourceName was a string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDQ3OTEx", "url": "https://github.com/DataDog/dd-trace-java/pull/1759#pullrequestreview-463447911", "createdAt": "2020-08-07T16:31:57Z", "commit": {"oid": "1adaa7480ba3e51e45868ac7d24168e8c7859da9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNjozMTo1N1rOG9gVig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNjozMTo1N1rOG9gVig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0NjEyMg==", "bodyText": "why you called this just Function ?\nIn disregard your comment:\nhttps://github.com/DataDog/dd-trace-java/pull/1759/files#diff-3438fdfbe14e3ba1c3a3e78ef37f7637R3", "url": "https://github.com/DataDog/dd-trace-java/pull/1759#discussion_r467146122", "createdAt": "2020-08-07T16:31:57Z", "author": {"login": "lpriima"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/api/Function.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package datadog.trace.bootstrap.instrumentation.api;\n+\n+public interface Function<T, U> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1adaa7480ba3e51e45868ac7d24168e8c7859da9"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0Nzg1NDQz", "url": "https://github.com/DataDog/dd-trace-java/pull/1759#pullrequestreview-464785443", "createdAt": "2020-08-11T06:38:05Z", "commit": {"oid": "bbbf72aa498814883561bfd1532fb1c5123cbf89"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2104, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}