{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MDUyNjY2", "number": 1876, "title": "Port Reactor fixes from OTel", "bodyText": "Porting PR by @iNikem open-telemetry/opentelemetry-java-instrumentation#1189\nIncludes ignoring/breaking 2 tests that do not result in correct parent child relationships. Will address in follow up PR. The benefit here outweighs this modeling bug so we should get this merged for the next release even with the modeling issue", "createdAt": "2020-09-16T15:00:59Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1876", "merged": true, "mergeCommit": {"oid": "01a8b2f68bcb609689f62aaadb3e6ea222b6e669"}, "closed": true, "closedAt": "2020-10-23T14:56:06Z", "author": {"login": "devinsba"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJhfbegBqjM3NzQ3MTUzMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVXvkQgFqTUxNTczOTkxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bf4a2057f34f0205cfc6c7525d192b7f5328e1a", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3bf4a2057f34f0205cfc6c7525d192b7f5328e1a", "committedDate": "2020-09-16T18:50:42Z", "message": "Finish the port"}, "afterCommit": {"oid": "3e85a2f53ed0a45cfc043333cb644d40e556677e", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3e85a2f53ed0a45cfc043333cb644d40e556677e", "committedDate": "2020-09-16T19:23:35Z", "message": "Finish the port"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54926a742169777af4bfc88a93bd9e5430c6e917", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/54926a742169777af4bfc88a93bd9e5430c6e917", "committedDate": "2020-09-23T18:44:53Z", "message": "not sure why java 8 requires this....."}, "afterCommit": {"oid": "9a4d875d184c7f4dcf452e46ae2e29593b032a09", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9a4d875d184c7f4dcf452e46ae2e29593b032a09", "committedDate": "2020-09-23T19:19:46Z", "message": "not sure why java 8 requires this....."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a4d875d184c7f4dcf452e46ae2e29593b032a09", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9a4d875d184c7f4dcf452e46ae2e29593b032a09", "committedDate": "2020-09-23T19:19:46Z", "message": "not sure why java 8 requires this....."}, "afterCommit": {"oid": "5fd7700299d28d9e807d097fe3ec268e5cd7e04f", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5fd7700299d28d9e807d097fe3ec268e5cd7e04f", "committedDate": "2020-09-23T19:36:51Z", "message": "not sure why java 8 requires this....."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "393b75f4341c352964d67b97bff0b8fd0cc11e5f", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/393b75f4341c352964d67b97bff0b8fd0cc11e5f", "committedDate": "2020-09-24T13:30:29Z", "message": "Test won't work"}, "afterCommit": {"oid": "d622b6555febd89940259ebfed947af07f3648bb", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d622b6555febd89940259ebfed947af07f3648bb", "committedDate": "2020-09-24T13:45:19Z", "message": "Test won't work"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdd00c1cad11ed92ffd27b19f5260e4acd97b89b", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/fdd00c1cad11ed92ffd27b19f5260e4acd97b89b", "committedDate": "2020-09-29T18:38:43Z", "message": "hmmmmmm"}, "afterCommit": {"oid": "400da2d065d60eea3fc79dc386bc66c7bcc826d7", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/400da2d065d60eea3fc79dc386bc66c7bcc826d7", "committedDate": "2020-09-29T19:23:37Z", "message": "hmmmmmm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15323124d6c3e9451c51ac3e644e7c1f7f0d996c", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/15323124d6c3e9451c51ac3e644e7c1f7f0d996c", "committedDate": "2020-10-01T15:21:45Z", "message": "Fix merge/rebase"}, "afterCommit": {"oid": "d5c344d68007435a06f3470e007b3ee2d5a6e5da", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d5c344d68007435a06f3470e007b3ee2d5a6e5da", "committedDate": "2020-10-01T15:41:50Z", "message": "Fix merge/rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b301a72d5ac50c21b3fcd71c82ced0043159f05", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/2b301a72d5ac50c21b3fcd71c82ced0043159f05", "committedDate": "2020-10-06T14:31:40Z", "message": "Start from no continuations. Fix other things from here"}, "afterCommit": {"oid": "d04013407b67ceb7bd01ac9b0629445d0e36b41c", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d04013407b67ceb7bd01ac9b0629445d0e36b41c", "committedDate": "2020-10-06T15:04:02Z", "message": "Start from no continuations. Fix other things from here"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d04013407b67ceb7bd01ac9b0629445d0e36b41c", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d04013407b67ceb7bd01ac9b0629445d0e36b41c", "committedDate": "2020-10-06T15:04:02Z", "message": "Start from no continuations. Fix other things from here"}, "afterCommit": {"oid": "baf105de8223d306f621214d1a414f4bbf2dff7b", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/baf105de8223d306f621214d1a414f4bbf2dff7b", "committedDate": "2020-10-06T15:16:06Z", "message": "Start from no continuations. Fix other things from here"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDI5MjIy", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#pullrequestreview-513029222", "createdAt": "2020-10-20T18:40:35Z", "commit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MDozNVrOHlL-rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0MjozOFrOHlMFvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NTYyOA==", "bodyText": "Reverting changes here. Auto-formatter changed this when I was adding debug logging", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508755628", "createdAt": "2020-10-20T18:40:35Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -40,7 +40,7 @@\n     private final CoreTracer tracer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NTc3OQ==", "bodyText": "Reverting changes here. Auto-formatter changed this when I was adding debug logging", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508755779", "createdAt": "2020-10-20T18:40:43Z", "author": {"login": "devinsba"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/ContinuableScopeManager.java", "diffHunk": "@@ -79,7 +79,7 @@ public AgentScope activate(final AgentSpan span, final ScopeSource source) {\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NjIyOQ==", "bodyText": "This changes the behavior of the test to pass. Will fix in follow up", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508756229", "createdAt": "2020-10-20T18:41:08Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/dd/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientBase.groovy", "diffHunk": "@@ -31,11 +31,10 @@ abstract class SpringWebfluxHttpClientBase extends HttpClientTest {\n       .uri(uri)\n       .headers { h -> headers.forEach({ key, value -> h.add(key, value) }) }\n       .exchange()\n-      .doAfterSuccessOrError { res, ex ->\n-        callback?.call()\n-      }\n       .block()\n \n+    callback?.call()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NjQ0MA==", "bodyText": "This disables a test that should pass. Will fix in follow up", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508756440", "createdAt": "2020-10-20T18:41:28Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/dd/trace/instrumentation/springwebflux/client/SpringWebfluxHttpClientBase.groovy", "diffHunk": "@@ -109,6 +108,10 @@ abstract class SpringWebfluxHttpClientBase extends HttpClientTest {\n     false\n   }\n \n+  boolean testCallbackWithParent() {\n+    false\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NzQzNw==", "bodyText": "This is another modeling issue but I don't feel as strongly about this one to fix it in a follow-up", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508757437", "createdAt": "2020-10-20T18:42:38Z", "author": {"login": "devinsba"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "diffHunk": "@@ -176,7 +176,7 @@ class SpringWebfluxTest extends AgentTestRunner {\n             resourceName \"TestController.tracedMethod\"\n             operationName \"trace.annotation\"\n           }\n-          childOf(span(1))\n+          childOf(span(0)) // FIXME this is wrong", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab4fd34b7b9735b3b262868ebe5ed53161c7ab8c", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ab4fd34b7b9735b3b262868ebe5ed53161c7ab8c", "committedDate": "2020-10-20T18:47:54Z", "message": "Put test back"}, "afterCommit": {"oid": "5750d3b3836d8bab290ec2dc1174f8f165fb6043", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5750d3b3836d8bab290ec2dc1174f8f165fb6043", "committedDate": "2020-10-20T18:52:19Z", "message": "Put test back"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDk2MDk1", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#pullrequestreview-513096095", "createdAt": "2020-10-20T20:14:39Z", "commit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoxNDozOVrOHlPStw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDozMzoyMlrOHlP93w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwOTkxMQ==", "bodyText": "Can this extend HttpClientTest instead?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508809911", "createdAt": "2020-10-20T20:14:39Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/netty-4.1/src/test/groovy/ReactorNettyTest.groovy", "diffHunk": "@@ -0,0 +1,84 @@\n+import datadog.trace.agent.test.AgentTestRunner\n+import datadog.trace.agent.test.asserts.TraceAssert\n+import datadog.trace.api.DDSpanTypes\n+import datadog.trace.bootstrap.instrumentation.api.Tags\n+import datadog.trace.core.DDSpan\n+import reactor.netty.http.client.HttpClient\n+import reactor.netty.http.client.HttpClientResponse\n+import spock.lang.AutoCleanup\n+import spock.lang.Shared\n+\n+import static datadog.trace.agent.test.server.http.TestHttpServer.httpServer\n+import static datadog.trace.agent.test.utils.TraceUtils.basicSpan\n+import static datadog.trace.agent.test.utils.TraceUtils.runUnderTrace\n+\n+class ReactorNettyTest extends AgentTestRunner {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxNDQxNw==", "bodyText": "Why should this result in two different traces?  from the input above, I would expect a single trace.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508814417", "createdAt": "2020-10-20T20:23:04Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "diffHunk": "@@ -383,14 +384,16 @@ class Lettuce5ReactiveClientTest extends AgentTestRunner {\n     when:\n     runUnderTrace(\"test-parent\") {\n       reactiveCommands.set(\"a\", \"1\")\n-        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n+        .then(reactiveCommands.get(\"a\")) // The get here is reported separately\n         .subscribe()\n     }\n \n     then:\n-    assertTraces(1) {\n+    assertTraces(2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxNTIxMg==", "bodyText": "Doesn't look like this is used.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508815212", "createdAt": "2020-10-20T20:24:16Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "diffHunk": "@@ -438,14 +443,15 @@ class Lettuce5ReactiveClientTest extends AgentTestRunner {\n     when:\n     runUnderTrace(\"test-parent\") {\n       reactiveCommands.set(\"a\", \"1\")\n-        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n-        .subscribeOn(Schedulers.elastic())\n+        .then(reactiveCommands.get(\"a\"))\n+        .subscribeOn(Schedulers.newParallel(\"test\"))\n         .subscribe()\n     }\n \n     then:\n     assertTraces(1) {\n       sortSpansByStart()\n+      DDSpan parentSpan", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxNTk1Ng==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508815956", "createdAt": "2020-10-20T20:25:22Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/test/groovy/ReactorCoreTest.groovy", "diffHunk": "@@ -23,24 +24,22 @@ class ReactorCoreTest extends AgentTestRunner {\n \n   @Shared\n   def addOne = { i ->\n-    // FIXME: Our clock implementation doesn't guarantee that start times are monotonic across\n-    //  traces, we base span start times on a millisecond time from the start of the trace and\n-    //  offset a number of nanos, this does not guarantee that the start times are monotonic. Thus\n-    //  2 traces started during the same millisecond might have the span start times wrong relative\n-    //  to each other. IE: TraceA and TraceB start at the same millisecond, SpanA1 starts, then\n-    //  SpanB1 starts. SpanB1 can have an earlier startTimeNano than SpanA1\n-    sleep(1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxOTI5MA==", "bodyText": "These are no longer needed... (same comment below)", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508819290", "createdAt": "2020-10-20T20:30:20Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "diffHunk": "@@ -122,7 +122,7 @@ class SpringWebfluxTest extends AgentTestRunner {\n     assertTraces(1) {\n       sortSpansByStart()\n       trace(3) {\n-        span {\n+        span(0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e80455836f636258e538484823259b4d5e3d359"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMDk1OQ==", "bodyText": "Logically this seems like it should be a child of 1, not 0, right?  Might be worth understanding what's going on here.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r508820959", "createdAt": "2020-10-20T20:33:22Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/test/groovy/SpringWebfluxTest.groovy", "diffHunk": "@@ -176,7 +176,7 @@ class SpringWebfluxTest extends AgentTestRunner {\n             resourceName \"TestController.tracedMethod\"\n             operationName \"trace.annotation\"\n           }\n-          childOf(span(1))\n+          childOf(span(0)) // FIXME this is wrong", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1NzQzNw=="}, "originalCommit": {"oid": "a796b7192d04f15b678629faf62629b858ca834e"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3449f63a8a8a9fe2f2891e820f50e748df667d7", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f3449f63a8a8a9fe2f2891e820f50e748df667d7", "committedDate": "2020-10-21T13:41:29Z", "message": "unused var"}, "afterCommit": {"oid": "cd7aa317a736c468b4877e3d12bc7dd3875084b9", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cd7aa317a736c468b4877e3d12bc7dd3875084b9", "committedDate": "2020-10-21T14:06:16Z", "message": "unused var"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODEzODQ4", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#pullrequestreview-513813848", "createdAt": "2020-10-21T15:26:05Z", "commit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyNjowNVrOHlyWIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTozNzowN1rOHly3YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NDIyNw==", "bodyText": "Can we put REDIS_QUERY back in as the span name here?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509384227", "createdAt": "2020-10-21T15:26:05Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/main/java8/datadog/trace/instrumentation/lettuce5/rx/LettuceMonoDualConsumer.java", "diffHunk": "@@ -17,20 +19,32 @@\n   private AgentSpan span = null;\n   private final RedisCommand command;\n   private final boolean finishSpanOnClose;\n+  private final AgentSpan parentSpan;\n \n   public LettuceMonoDualConsumer(final RedisCommand command, final boolean finishSpanOnClose) {\n     this.command = command;\n     this.finishSpanOnClose = finishSpanOnClose;\n+    parentSpan = activeSpan();\n   }\n \n   @Override\n   public void accept(final R r) {\n-    span = startSpan(REDIS_QUERY);\n-    DECORATE.afterStart(span);\n-    DECORATE.onCommand(span, command);\n-    if (finishSpanOnClose) {\n-      DECORATE.beforeFinish(span);\n-      span.finish();\n+    TraceScope parentScope = null;\n+    try {\n+      if (parentSpan != null) {\n+        parentScope = activateSpan(parentSpan);\n+      }\n+      span = startSpan(\"redis.query\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NTAxMQ==", "bodyText": "Can we also test on the elastic scheduler? Does this still work if you change the scheduler back?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509385011", "createdAt": "2020-10-21T15:27:04Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/lettuce-5/src/test/groovy/Lettuce5ReactiveClientTest.groovy", "diffHunk": "@@ -438,8 +443,8 @@ class Lettuce5ReactiveClientTest extends AgentTestRunner {\n     when:\n     runUnderTrace(\"test-parent\") {\n       reactiveCommands.set(\"a\", \"1\")\n-        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n-        .subscribeOn(Schedulers.elastic())\n+        .then(reactiveCommands.get(\"a\"))\n+        .subscribeOn(Schedulers.newParallel(\"test\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NTcwNA==", "bodyText": "Is it OpenTracing or OpenTelemetry?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509385704", "createdAt": "2020-10-21T15:27:58Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/NOTICE.txt", "diffHunk": "@@ -0,0 +1,17 @@\n+This product contains a modified part of OpenTracing:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NjcwNg==", "bodyText": "Since this will happen a lot with few distinct inputs can we wrap this string comparison in a ClassValue?", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509386706", "createdAt": "2020-10-21T15:29:14Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/main/java8/datadog/trace/instrumentation/reactor/core/TracingOperator.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package datadog.trace.instrumentation.reactor.core;\n+\n+import java.util.function.BiFunction;\n+import java.util.function.Function;\n+import org.reactivestreams.Publisher;\n+import reactor.core.CoreSubscriber;\n+import reactor.core.Fuseable;\n+import reactor.core.Scannable;\n+import reactor.core.publisher.Hooks;\n+import reactor.core.publisher.Operators;\n+\n+/** Based on Spring Sleuth's Reactor instrumentation. */\n+public class TracingOperator {\n+\n+  /**\n+   * Registers a hook that applies to every operator, propagating {@link Context} to downstream\n+   * callbacks to ensure spans in the {@link Context} are available throughout the lifetime of a\n+   * reactive stream. This should generally be called in a static initializer block in your\n+   * application.\n+   */\n+  public static void registerOnEachOperator() {\n+    Hooks.onEachOperator(TracingSubscriber.class.getName(), tracingLift());\n+  }\n+\n+  private static <T> Function<? super Publisher<T>, ? extends Publisher<T>> tracingLift() {\n+    return Operators.lift(new Lifter<>());\n+  }\n+\n+  public static class Lifter<T>\n+      implements BiFunction<Scannable, CoreSubscriber<? super T>, CoreSubscriber<? super T>> {\n+\n+    @Override\n+    public CoreSubscriber<? super T> apply(\n+        final Scannable publisher, final CoreSubscriber<? super T> sub) {\n+      // if Flux/Mono #just, #empty, #error\n+      if (publisher instanceof Fuseable.ScalarCallable\n+          || publisher.getClass().getName().startsWith(\"reactor.core.Scannable$Attr$\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4OTk5Nw==", "bodyText": "I think parameterising the scheduler would be really helpful.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509389997", "createdAt": "2020-10-21T15:33:31Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/reactor-core-3.1/src/test/groovy/ReactorCoreTest.groovy", "diffHunk": "@@ -375,15 +350,30 @@ class ReactorCoreTest extends AgentTestRunner {\n     \"basic flux\" | 2         | { -> Flux.fromIterable([1, 2]).map(addOne) }\n   }\n \n+  def \"Fluxes produce the right number of results\"() {\n+    when:\n+    List<String> values = Flux.fromIterable(Arrays.asList(1, 2, 3, 4))\n+      .parallel()\n+      .runOn(Schedulers.parallel())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 233}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM5MjczNg==", "bodyText": "Can we change the span names back to the way they were - this improves serialisation performance.", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#discussion_r509392736", "createdAt": "2020-10-21T15:37:07Z", "author": {"login": "richardstartin"}, "path": "dd-java-agent/instrumentation/spring-webflux-5/src/main/java8/datadog/trace/instrumentation/springwebflux/client/WebClientTracingFilter.java", "diffHunk": "@@ -2,77 +2,67 @@\n \n import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activeSpan;\n-import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.propagate;\n import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.startSpan;\n-import static datadog.trace.instrumentation.springwebflux.client.HttpHeadersInjectAdapter.SETTER;\n import static datadog.trace.instrumentation.springwebflux.client.SpringWebfluxHttpClientDecorator.DECORATE;\n-import static datadog.trace.instrumentation.springwebflux.client.SpringWebfluxHttpClientDecorator.HTTP_REQUEST;\n \n import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n-import datadog.trace.bootstrap.instrumentation.api.InstrumentationTags;\n-import datadog.trace.bootstrap.instrumentation.api.Tags;\n import java.util.List;\n import org.springframework.web.reactive.function.client.ClientRequest;\n import org.springframework.web.reactive.function.client.ClientResponse;\n import org.springframework.web.reactive.function.client.ExchangeFilterFunction;\n import org.springframework.web.reactive.function.client.ExchangeFunction;\n+import reactor.core.CoreSubscriber;\n import reactor.core.publisher.Mono;\n \n+/**\n+ * Based on Spring Sleuth's Reactor instrumentation.\n+ * https://github.com/spring-cloud/spring-cloud-sleuth/blob/master/spring-cloud-sleuth-core/src/main/java/org/springframework/cloud/sleuth/instrument/web/client/TraceWebClientBeanPostProcessor.java\n+ */\n public class WebClientTracingFilter implements ExchangeFilterFunction {\n-  private static final WebClientTracingFilter INSTANCE = new WebClientTracingFilter();\n-\n   public static void addFilter(final List<ExchangeFilterFunction> exchangeFilterFunctions) {\n     // Since the builder where we instrument the build function can be reused, we need\n     // to only add the filter once\n-    int index = exchangeFilterFunctions.indexOf(INSTANCE);\n-    if (index == 0) {\n-      return;\n-    }\n-    if (index > 0) {\n-      exchangeFilterFunctions.remove(index);\n-    }\n-    exchangeFilterFunctions.add(0, INSTANCE);\n+    exchangeFilterFunctions.removeIf(\n+        filterFunction -> filterFunction instanceof WebClientTracingFilter);\n+    exchangeFilterFunctions.add(0, new WebClientTracingFilter());\n   }\n \n   @Override\n   public Mono<ClientResponse> filter(final ClientRequest request, final ExchangeFunction next) {\n-    final AgentSpan span;\n-    if (activeSpan() != null) {\n-      span = startSpan(HTTP_REQUEST, activeSpan().context());\n-    } else {\n-      span = startSpan(HTTP_REQUEST);\n-    }\n-    span.setTag(Tags.SPAN_KIND, Tags.SPAN_KIND_CLIENT);\n-    span.setTag(InstrumentationTags.DD_MEASURED, true);\n-    DECORATE.afterStart(span);\n+    return new MonoWebClientTrace(request, next);\n+  }\n+\n+  public static final class MonoWebClientTrace extends Mono<ClientResponse> {\n+    final ExchangeFunction next;\n+    final ClientRequest request;\n \n-    try (final AgentScope scope = activateSpan(span)) {\n-      scope.setAsyncPropagation(true);\n-      final ClientRequest mutatedRequest =\n-          ClientRequest.from(request)\n-              .attribute(AgentSpan.class.getName(), span)\n-              .headers(httpHeaders -> propagate().inject(span, httpHeaders, SETTER))\n-              .build();\n-      DECORATE.onRequest(span, mutatedRequest);\n+    public MonoWebClientTrace(final ClientRequest request, final ExchangeFunction next) {\n+      this.next = next;\n+      this.request = request;\n+    }\n \n-      return next.exchange(mutatedRequest)\n-          .doOnSuccessOrError(\n-              (clientResponse, throwable) -> {\n-                if (throwable != null) {\n-                  DECORATE.onError(span, throwable);\n-                } else {\n-                  DECORATE.onResponse(span, clientResponse);\n-                }\n-                DECORATE.beforeFinish(span);\n-                span.finish();\n-              })\n-          .doOnCancel(\n-              () -> {\n-                DECORATE.onCancel(span);\n-                DECORATE.beforeFinish(span);\n-                span.finish();\n-              });\n+    @Override\n+    public void subscribe(final CoreSubscriber<? super ClientResponse> subscriber) {\n+      final AgentSpan span;\n+      if (activeSpan() != null) {\n+        span = startSpan(\"http.request\", activeSpan().context());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29d33311e0b0105cab65e1ef409eb41193c0ce57"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODY2MDI1", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#pullrequestreview-514866025", "createdAt": "2020-10-22T15:40:22Z", "commit": {"oid": "02feef7df10491e431b5b85695dd1ab57cf2c745"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec6105e6743995dd0a42687ec84e4632cb8693dd", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ec6105e6743995dd0a42687ec84e4632cb8693dd", "committedDate": "2020-10-23T13:49:25Z", "message": "Port reactor instrumentation updates from OTel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02feef7df10491e431b5b85695dd1ab57cf2c745", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/02feef7df10491e431b5b85695dd1ab57cf2c745", "committedDate": "2020-10-22T14:41:34Z", "message": "Parameterize scheduler test"}, "afterCommit": {"oid": "ec6105e6743995dd0a42687ec84e4632cb8693dd", "author": {"user": {"login": "devinsba", "name": "Brian Devins-Suresh"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/ec6105e6743995dd0a42687ec84e4632cb8693dd", "committedDate": "2020-10-23T13:49:25Z", "message": "Port reactor instrumentation updates from OTel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzM5OTE1", "url": "https://github.com/DataDog/dd-trace-java/pull/1876#pullrequestreview-515739915", "createdAt": "2020-10-23T14:49:25Z", "commit": {"oid": "ec6105e6743995dd0a42687ec84e4632cb8693dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3122, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}