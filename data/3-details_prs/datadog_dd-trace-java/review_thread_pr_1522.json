{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NTU4ODIw", "number": 1522, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDozMDo0MFrOEBxcNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDozMTozM1rOEBxdnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjk0MDY5OnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/rabbitmq-amqp-2.7/src/test/groovy/RabbitMQTest.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDozMDo0MFrOGd0hwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDozMDo0MFrOGd0hwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyMjQ5Ng==", "bodyText": "So this will only work if the timestamp is set on their message when it is published?", "url": "https://github.com/DataDog/dd-trace-java/pull/1522#discussion_r433922496", "createdAt": "2020-06-02T14:30:40Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/rabbitmq-amqp-2.7/src/test/groovy/RabbitMQTest.groovy", "diffHunk": "@@ -174,7 +170,13 @@ class RabbitMQTest extends AgentTestRunner {\n \n     (1..messageCount).each {\n       TEST_WRITER.waitForTraces(2 + (it * 2))\n-      channel.basicPublish(exchangeName, \"\", null, \"msg $it\".getBytes())\n+      if (setTimestamp) {\n+        channel.basicPublish(exchangeName, \"\",\n+          new AMQP.BasicProperties.Builder().timestamp(new Date()).build(),\n+          \"msg $it\".getBytes())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjk0NDMxOnYy", "diffSide": "RIGHT", "path": "dd-java-agent/instrumentation/rabbitmq-amqp-2.7/src/main/java/datadog/trace/instrumentation/rabbitmq/amqp/TracedDelegatingConsumer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDozMTozM1rOGd0kIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDozMTozM1rOGd0kIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyMzEwNA==", "bodyText": "Please add a comment describing when this would be null or how the timestamp gets populated.", "url": "https://github.com/DataDog/dd-trace-java/pull/1522#discussion_r433923104", "createdAt": "2020-06-02T14:31:33Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/rabbitmq-amqp-2.7/src/main/java/datadog/trace/instrumentation/rabbitmq/amqp/TracedDelegatingConsumer.java", "diffHunk": "@@ -70,13 +75,19 @@ public void handleDelivery(\n       final Context context = headers == null ? null : propagate().extract(headers, GETTER);\n \n       final AgentSpan span =\n-          startSpan(\"amqp.command\", context)\n-              .setTag(\"message.size\", body == null ? 0 : body.length)\n-              .setTag(\"span.origin.type\", delegate.getClass().getName())\n-              .setTag(InstrumentationTags.DD_MEASURED, true);\n+          startSpan(AMQP_COMMAND, context)\n+              .setTag(MESSAGE_SIZE, body == null ? 0 : body.length)\n+              .setTag(SPAN_ORIGIN_TYPE, delegate.getClass().getName())\n+              .setTag(DD_MEASURED, true);\n       CONSUMER_DECORATE.afterStart(span);\n       CONSUMER_DECORATE.onDeliver(span, queue, envelope);\n \n+      if (properties.getTimestamp() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f14e9b46eb4c8937ec75d7a5eba0e6a7605c7499"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 191, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}