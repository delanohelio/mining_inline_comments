{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMzUyMTUx", "number": 1496, "title": "replace Set<Integer> with BitSet for HTTP statuses", "bodyText": "Replaces the HTTP statuses with a more compact data structure, because they're static final and surprisingly large:\njava.util.HashSet@65ab7765d footprint:\n     COUNT       AVG       SUM   DESCRIPTION\n         1      1040      1040   [Ljava.util.HashMap$Node;\n       100        16      1600   java.lang.Integer\n         1        16        16   java.lang.Object\n         1        48        48   java.util.HashMap\n       100        32      3200   java.util.HashMap$Node\n         1        16        16   java.util.HashSet\n       204                5920   (total)\n\nWe have between 2 and 4 of the above. This means we could have overhead between 12 and 24KB (if there is an override with a lot of status codes) depending on what configuration overrides are in place.\nUsing a BitSet we have:\nserver errors:\njava.util.BitSet@1b28cdfad footprint:\n     COUNT       AVG       SUM   DESCRIPTION\n         1        96        96   [J\n         1        24        24   java.util.BitSet\n         2                 120   (total)\n\nand client errors\njava.util.BitSet@1b28cdfad footprint:\n     COUNT       AVG       SUM   DESCRIPTION\n         1        80        80   [J\n         1        24        24   java.util.BitSet\n         2                 104   (total)\n\nThe worst case size overhead with BitSet is ~0.5KB.\nThis also means we can avoid wrapping status codes if we represent them with primitive types in the future.", "createdAt": "2020-05-26T17:39:52Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1496", "merged": true, "mergeCommit": {"oid": "07163978c88a06f629e3a374501eed8bc4848a2b"}, "closed": true, "closedAt": "2020-05-27T17:01:28Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclIKZygH2gAyNDIzMzUyMTUxOjBhMTI4OTdkOGViZWFiMjFlNWY0OWI3NDU1Yzg2NWE3ZjEwZjMwM2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclbKybAH2gAyNDIzMzUyMTUxOjQ0MDYyYTk1NzI1M2YwODNkNDYwYjUxODcwNWViZDUxZGU5NjIwNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a12897d8ebeab21e5f49b7455c865a7f10f303f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0a12897d8ebeab21e5f49b7455c865a7f10f303f", "committedDate": "2020-05-26T17:31:53Z", "message": "replace Set<Integer> with BitSet for HTTP statuses"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODE3ODc1", "url": "https://github.com/DataDog/dd-trace-java/pull/1496#pullrequestreview-418817875", "createdAt": "2020-05-27T02:36:25Z", "commit": {"oid": "0a12897d8ebeab21e5f49b7455c865a7f10f303f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37bb891ac819f5e14ceff766bcfddc97c273bc1", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e37bb891ac819f5e14ceff766bcfddc97c273bc1", "committedDate": "2020-05-27T07:52:54Z", "message": "Merge branch 'master' into richardstartin/bitset-http-statuses"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDI2MDcz", "url": "https://github.com/DataDog/dd-trace-java/pull/1496#pullrequestreview-419026073", "createdAt": "2020-05-27T09:40:52Z", "commit": {"oid": "e37bb891ac819f5e14ceff766bcfddc97c273bc1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b27ddbc9b4f072a51afd7113699ba1105c71c378", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b27ddbc9b4f072a51afd7113699ba1105c71c378", "committedDate": "2020-05-27T14:43:03Z", "message": "Merge branch 'master' into richardstartin/bitset-http-statuses"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MzQxNzk0", "url": "https://github.com/DataDog/dd-trace-java/pull/1496#pullrequestreview-419341794", "createdAt": "2020-05-27T15:28:04Z", "commit": {"oid": "b27ddbc9b4f072a51afd7113699ba1105c71c378"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNToyODowNVrOGbQUMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNToyODowNVrOGbQUMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIzMjA1MA==", "bodyText": "Since these don't need to be sets anymore, consider removing the toSet() and updating toBitSet", "url": "https://github.com/DataDog/dd-trace-java/pull/1496#discussion_r431232050", "createdAt": "2020-05-27T15:28:05Z", "author": {"login": "tylerbenson"}, "path": "dd-trace-api/src/test/groovy/datadog/trace/api/ConfigTest.groovy", "diffHunk": "@@ -859,10 +859,10 @@ class ConfigTest extends DDSpecification {\n \n     then:\n     if (expected) {\n-      assert config.httpServerErrorStatuses == expected.toSet()\n-      assert config.httpClientErrorStatuses == expected.toSet()\n-      assert propConfig.httpServerErrorStatuses == expected.toSet()\n-      assert propConfig.httpClientErrorStatuses == expected.toSet()\n+      assert config.httpServerErrorStatuses == toBitSet(expected.toSet())\n+      assert config.httpClientErrorStatuses == toBitSet(expected.toSet())\n+      assert propConfig.httpServerErrorStatuses == toBitSet(expected.toSet())\n+      assert propConfig.httpClientErrorStatuses == toBitSet(expected.toSet())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b27ddbc9b4f072a51afd7113699ba1105c71c378"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "825786892d2d3b977830843f8c997ad99355ef94", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/825786892d2d3b977830843f8c997ad99355ef94", "committedDate": "2020-05-27T15:39:54Z", "message": "remove unnecessary toSet() calls from  ConfigTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44062a957253f083d460b518705ebd51de962046", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/44062a957253f083d460b518705ebd51de962046", "committedDate": "2020-05-27T15:40:30Z", "message": "Merge branch 'richardstartin/bitset-http-statuses' of github.com:DataDog/dd-trace-java into richardstartin/bitset-http-statuses"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2300, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}