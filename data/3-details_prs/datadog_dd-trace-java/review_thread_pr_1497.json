{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNjkxMzUz", "number": 1497, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTozNToxNFrOEADEKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTozODoxNVrOEADHdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDg1Njc0OnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTozNToxNFrOGbFNRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjoxNzoxNlrOGbGiSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1MDA1Mg==", "bodyText": "I can't find where this is used", "url": "https://github.com/DataDog/dd-trace-java/pull/1497#discussion_r431050052", "createdAt": "2020-05-27T11:35:14Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "diffHunk": "@@ -13,6 +13,7 @@\n import java.nio.charset.Charset;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.Set;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58fdde92ee3527f0f75be883d042fb668883d177"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1MzAyNA==", "bodyText": "maxKeyLength takes a set as a parameter.", "url": "https://github.com/DataDog/dd-trace-java/pull/1497#discussion_r431053024", "createdAt": "2020-05-27T11:41:37Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "diffHunk": "@@ -13,6 +13,7 @@\n import java.nio.charset.Charset;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.Set;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1MDA1Mg=="}, "originalCommit": {"oid": "58fdde92ee3527f0f75be883d042fb668883d177"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA3MTgxNw==", "bodyText": "Doh!  I blame dizziness from new glasses \ud83d\ude09", "url": "https://github.com/DataDog/dd-trace-java/pull/1497#discussion_r431071817", "createdAt": "2020-05-27T12:17:16Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "diffHunk": "@@ -13,6 +13,7 @@\n import java.nio.charset.Charset;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.Set;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1MDA1Mg=="}, "originalCommit": {"oid": "58fdde92ee3527f0f75be883d042fb668883d177"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDg1ODA1OnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTozNTo0NlrOGbFOEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTozNTo0NlrOGbFOEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1MDI1OQ==", "bodyText": "Nice. Interning the empty String.", "url": "https://github.com/DataDog/dd-trace-java/pull/1497#discussion_r431050259", "createdAt": "2020-05-27T11:35:46Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "diffHunk": "@@ -34,39 +35,72 @@\n   // startup\n   private static final Map<String, byte[]> UTF8_INTERN_KEYS_TABLE = new HashMap<>(256);\n   private static final Map<String, byte[]> UTF8_INTERN_TAGS_TABLE = new HashMap<>(256);\n+  private static final int MAX_TAGS_LENGTH;\n+  private static final long[] TAGS_FIRST_CHAR_IS_PRESENT = new long[4];\n \n   static {\n-    internConstantsUTF8(Tags.class, UTF8_INTERN_KEYS_TABLE);\n-    internConstantsUTF8(InstrumentationTags.class, UTF8_INTERN_KEYS_TABLE);\n-    internConstantsUTF8(DDSpanTypes.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(DDComponents.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(DDSpanNames.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(CommonTagValues.class, UTF8_INTERN_TAGS_TABLE);\n+    internConstantsUTF8(Tags.class, UTF8_INTERN_KEYS_TABLE, null);\n+    internConstantsUTF8(InstrumentationTags.class, UTF8_INTERN_KEYS_TABLE, null);\n+    internConstantsUTF8(DDSpanTypes.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(DDComponents.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(DDSpanNames.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(CommonTagValues.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    UTF8_INTERN_TAGS_TABLE.put(\"\", new byte[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58fdde92ee3527f0f75be883d042fb668883d177"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDg2NTE3OnYy", "diffSide": "RIGHT", "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTozODoxNVrOGbFSkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTo0NjozMFrOGbFiuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1MTQwOA==", "bodyText": "Maybe it would be easier to read if the empty tag always returned true here?", "url": "https://github.com/DataDog/dd-trace-java/pull/1497#discussion_r431051408", "createdAt": "2020-05-27T11:38:15Z", "author": {"login": "bantonsson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "diffHunk": "@@ -34,39 +35,72 @@\n   // startup\n   private static final Map<String, byte[]> UTF8_INTERN_KEYS_TABLE = new HashMap<>(256);\n   private static final Map<String, byte[]> UTF8_INTERN_TAGS_TABLE = new HashMap<>(256);\n+  private static final int MAX_TAGS_LENGTH;\n+  private static final long[] TAGS_FIRST_CHAR_IS_PRESENT = new long[4];\n \n   static {\n-    internConstantsUTF8(Tags.class, UTF8_INTERN_KEYS_TABLE);\n-    internConstantsUTF8(InstrumentationTags.class, UTF8_INTERN_KEYS_TABLE);\n-    internConstantsUTF8(DDSpanTypes.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(DDComponents.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(DDSpanNames.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(CommonTagValues.class, UTF8_INTERN_TAGS_TABLE);\n+    internConstantsUTF8(Tags.class, UTF8_INTERN_KEYS_TABLE, null);\n+    internConstantsUTF8(InstrumentationTags.class, UTF8_INTERN_KEYS_TABLE, null);\n+    internConstantsUTF8(DDSpanTypes.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(DDComponents.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(DDSpanNames.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(CommonTagValues.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    UTF8_INTERN_TAGS_TABLE.put(\"\", new byte[0]);\n+    MAX_TAGS_LENGTH = maxKeyLength(UTF8_INTERN_TAGS_TABLE.keySet());\n   }\n \n   public static byte[] getKeyBytesUTF8(String value) {\n     return UTF8_INTERN_KEYS_TABLE.get(value);\n   }\n \n   public static byte[] getTagBytesUTF8(String value) {\n-    return UTF8_INTERN_TAGS_TABLE.get(value);\n+    return tagMaybeInterned(value) ? UTF8_INTERN_TAGS_TABLE.get(value) : null;\n   }\n \n-  private static void internConstantsUTF8(Class<?> clazz, Map<String, byte[]> map) {\n+  private static void internConstantsUTF8(\n+      Class<?> clazz, Map<String, byte[]> map, long[] firstByteBitmap) {\n     for (Field field : clazz.getDeclaredFields()) {\n       if (Modifier.isStatic(field.getModifiers())\n           && Modifier.isPublic(field.getModifiers())\n           && field.getType() == String.class) {\n         try {\n-          intern(map, (String) field.get(null), UTF_8);\n+          intern(map, (String) field.get(null), UTF_8, firstByteBitmap);\n         } catch (IllegalAccessException e) {\n           // won't happen\n         }\n       }\n     }\n   }\n \n-  private static void intern(Map<String, byte[]> table, String value, Charset encoding) {\n-    table.put(value, value.getBytes(encoding));\n+  private static void intern(\n+      Map<String, byte[]> table, String value, Charset encoding, long[] firstByteBitmap) {\n+    byte[] bytes = value.getBytes(encoding);\n+    if (null != firstByteBitmap && bytes.length > 0) {\n+      int bit = bytes[0] & 0xFF;\n+      firstByteBitmap[bit >>> 6] |= 1L << bit;\n+    }\n+    table.put(value, bytes);\n+  }\n+\n+  private static boolean tagMaybeInterned(final String tag) {\n+    if (null == tag || tag.length() > MAX_TAGS_LENGTH) {\n+      return false;\n+    }\n+    if (!tag.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58fdde92ee3527f0f75be883d042fb668883d177"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1NTU0NQ==", "bodyText": "you might be right.", "url": "https://github.com/DataDog/dd-trace-java/pull/1497#discussion_r431055545", "createdAt": "2020-05-27T11:46:30Z", "author": {"login": "richardstartin"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/StringTables.java", "diffHunk": "@@ -34,39 +35,72 @@\n   // startup\n   private static final Map<String, byte[]> UTF8_INTERN_KEYS_TABLE = new HashMap<>(256);\n   private static final Map<String, byte[]> UTF8_INTERN_TAGS_TABLE = new HashMap<>(256);\n+  private static final int MAX_TAGS_LENGTH;\n+  private static final long[] TAGS_FIRST_CHAR_IS_PRESENT = new long[4];\n \n   static {\n-    internConstantsUTF8(Tags.class, UTF8_INTERN_KEYS_TABLE);\n-    internConstantsUTF8(InstrumentationTags.class, UTF8_INTERN_KEYS_TABLE);\n-    internConstantsUTF8(DDSpanTypes.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(DDComponents.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(DDSpanNames.class, UTF8_INTERN_TAGS_TABLE);\n-    internConstantsUTF8(CommonTagValues.class, UTF8_INTERN_TAGS_TABLE);\n+    internConstantsUTF8(Tags.class, UTF8_INTERN_KEYS_TABLE, null);\n+    internConstantsUTF8(InstrumentationTags.class, UTF8_INTERN_KEYS_TABLE, null);\n+    internConstantsUTF8(DDSpanTypes.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(DDComponents.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(DDSpanNames.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    internConstantsUTF8(CommonTagValues.class, UTF8_INTERN_TAGS_TABLE, TAGS_FIRST_CHAR_IS_PRESENT);\n+    UTF8_INTERN_TAGS_TABLE.put(\"\", new byte[0]);\n+    MAX_TAGS_LENGTH = maxKeyLength(UTF8_INTERN_TAGS_TABLE.keySet());\n   }\n \n   public static byte[] getKeyBytesUTF8(String value) {\n     return UTF8_INTERN_KEYS_TABLE.get(value);\n   }\n \n   public static byte[] getTagBytesUTF8(String value) {\n-    return UTF8_INTERN_TAGS_TABLE.get(value);\n+    return tagMaybeInterned(value) ? UTF8_INTERN_TAGS_TABLE.get(value) : null;\n   }\n \n-  private static void internConstantsUTF8(Class<?> clazz, Map<String, byte[]> map) {\n+  private static void internConstantsUTF8(\n+      Class<?> clazz, Map<String, byte[]> map, long[] firstByteBitmap) {\n     for (Field field : clazz.getDeclaredFields()) {\n       if (Modifier.isStatic(field.getModifiers())\n           && Modifier.isPublic(field.getModifiers())\n           && field.getType() == String.class) {\n         try {\n-          intern(map, (String) field.get(null), UTF_8);\n+          intern(map, (String) field.get(null), UTF_8, firstByteBitmap);\n         } catch (IllegalAccessException e) {\n           // won't happen\n         }\n       }\n     }\n   }\n \n-  private static void intern(Map<String, byte[]> table, String value, Charset encoding) {\n-    table.put(value, value.getBytes(encoding));\n+  private static void intern(\n+      Map<String, byte[]> table, String value, Charset encoding, long[] firstByteBitmap) {\n+    byte[] bytes = value.getBytes(encoding);\n+    if (null != firstByteBitmap && bytes.length > 0) {\n+      int bit = bytes[0] & 0xFF;\n+      firstByteBitmap[bit >>> 6] |= 1L << bit;\n+    }\n+    table.put(value, bytes);\n+  }\n+\n+  private static boolean tagMaybeInterned(final String tag) {\n+    if (null == tag || tag.length() > MAX_TAGS_LENGTH) {\n+      return false;\n+    }\n+    if (!tag.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1MTQwOA=="}, "originalCommit": {"oid": "58fdde92ee3527f0f75be883d042fb668883d177"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 173, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}