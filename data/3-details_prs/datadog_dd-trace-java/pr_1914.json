{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMTY2MjM2", "number": 1914, "title": "precompute more utf8", "bodyText": "The next chapter in the endless story of precomputing all the UTF8 encoding we have to do.\n\ncreates a fast path for UTF8ByteString in Packer\nremove cache lookups for tags entirely\nremove the tags map in StringTables\nadd an overload to MutableSpan to accept CharSequence tags\nmake component and type CharSequence - convert type to String externally to maintain compatibility, use CharSequence internally\nMake UTF8ByteString copy the input string only for its original use case in JDBCMaps where it is used as a weak key (I would have opted for WeakReference here but working around that.)\n\nIgnores test instrumentations.", "createdAt": "2020-09-25T15:55:34Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1914", "merged": true, "mergeCommit": {"oid": "c51ccad9144ecac96047bccd4e9bb903e3680499"}, "closed": true, "closedAt": "2020-09-28T11:57:14Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMYI0kgBqjM4MDg0MzMzNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNR_0wgFqTQ5NzQxOTQ5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e608617efc5c3fe314456d37ff865106b345a31d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e608617efc5c3fe314456d37ff865106b345a31d", "committedDate": "2020-09-25T15:54:37Z", "message": "ignore constants file for coverage metrics"}, "afterCommit": {"oid": "8d4b8fb8b56d03e7e34574d7791a64b73b7256c2", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8d4b8fb8b56d03e7e34574d7791a64b73b7256c2", "committedDate": "2020-09-25T16:11:27Z", "message": "ignore constants file for coverage metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ef6e41df2b705da49e7dd2d058b5b95c085d362", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6ef6e41df2b705da49e7dd2d058b5b95c085d362", "committedDate": "2020-09-25T16:12:07Z", "message": "no cache lookups for type, it's always set internally"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ef15a60d1d54438e6f3d405ee62a40c9bf29590", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/5ef15a60d1d54438e6f3d405ee62a40c9bf29590", "committedDate": "2020-09-25T16:12:07Z", "message": "create fast path for UTF8ByteStrings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a10fb2186cb553b1436215463f07362faa5b68", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c1a10fb2186cb553b1436215463f07362faa5b68", "committedDate": "2020-09-25T16:12:07Z", "message": "add CharSequence setTag overload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aff8f76715f71218cfb4db4206319c9ee2d6215", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1aff8f76715f71218cfb4db4206319c9ee2d6215", "committedDate": "2020-09-25T16:12:07Z", "message": "make span types UTF8ByteString"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d4b8fb8b56d03e7e34574d7791a64b73b7256c2", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8d4b8fb8b56d03e7e34574d7791a64b73b7256c2", "committedDate": "2020-09-25T16:11:27Z", "message": "ignore constants file for coverage metrics"}, "afterCommit": {"oid": "7e7af390160da02faaa656251b65c96f49b58e20", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7e7af390160da02faaa656251b65c96f49b58e20", "committedDate": "2020-09-25T16:12:08Z", "message": "ignore constants file for coverage metrics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d211311a36714d4d827be552b3d364aa8a4bcf3", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/1d211311a36714d4d827be552b3d364aa8a4bcf3", "committedDate": "2020-09-25T16:40:49Z", "message": "tweak tests to handle CharSequence component and type"}, "afterCommit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3d08b5b08afe0ac070fb5e3f2c61f03115f038f7", "committedDate": "2020-09-25T16:57:28Z", "message": "tweak tests to handle CharSequence component and type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NjAwNDc4", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#pullrequestreview-496600478", "createdAt": "2020-09-25T17:09:14Z", "commit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzowOToxNFrOHYL3tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzowOToxNFrOHYL3tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyMjM1Ng==", "bodyText": "Should we change all the keys here to also be CharSequence?  (Perhaps this is already planned for a future pass?)", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#discussion_r495122356", "createdAt": "2020-09-25T17:09:14Z", "author": {"login": "tylerbenson"}, "path": "internal-api/src/main/java/datadog/trace/bootstrap/instrumentation/api/AgentSpan.java", "diffHunk": "@@ -20,6 +20,8 @@\n   @Override\n   AgentSpan setTag(String key, String value);\n \n+  AgentSpan setTag(String key, CharSequence value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NjA3MTk0", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#pullrequestreview-496607194", "createdAt": "2020-09-25T17:19:28Z", "commit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzoxOToyOFrOHYMLgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzoyNDo0N1rOHYMWDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyNzQyNQ==", "bodyText": "nit: I think it would have been equivalent to do this inside the constructor instead.", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#discussion_r495127425", "createdAt": "2020-09-25T17:19:28Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/spring-webmvc-3.1/src/main/java/datadog/trace/instrumentation/springweb/SpringWebHttpServerDecorator.java", "diffHunk": "@@ -39,14 +39,14 @@ public CharSequence apply(Pair<String, Object> input) {\n   private static final DDCache<Pair<String, Object>, CharSequence> RESOURCE_NAME_CACHE =\n       DDCaches.newFixedSizeCache(64);\n \n-  private final String component;\n+  private final CharSequence component;\n \n   public static final SpringWebHttpServerDecorator DECORATE =\n-      new SpringWebHttpServerDecorator(\"spring-web-controller\");\n+      new SpringWebHttpServerDecorator(UTF8BytesString.createConstant(\"spring-web-controller\"));\n   public static final SpringWebHttpServerDecorator DECORATE_RENDER =\n-      new SpringWebHttpServerDecorator(\"spring-webmvc\");\n+      new SpringWebHttpServerDecorator(UTF8BytesString.createConstant(\"spring-webmvc\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMDEyNQ==", "bodyText": "Are these handled in some other fashion now?", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#discussion_r495130125", "createdAt": "2020-09-25T17:24:47Z", "author": {"login": "tylerbenson"}, "path": "internal-api/src/main/java/datadog/trace/bootstrap/instrumentation/api/CommonTagValues.java", "diffHunk": "@@ -1,12 +0,0 @@\n-package datadog.trace.bootstrap.instrumentation.api;\n-\n-public class CommonTagValues {\n-\n-  public static final String GET = \"GET\";\n-  public static final String PUT = \"PUT\";\n-  public static final String POST = \"POST\";\n-  public static final String DELETE = \"DELETE\";\n-\n-  public static final String TRUE = \"true\";\n-  public static final String FALSE = \"false\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NjE0MjU2", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#pullrequestreview-496614256", "createdAt": "2020-09-25T17:29:46Z", "commit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzoyOTo0NlrOHYMgPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzoyOTo0NlrOHYMgPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMjczMw==", "bodyText": "Do the toStrings here make this counter productive?", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#discussion_r495132733", "createdAt": "2020-09-25T17:29:46Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/instrumentation/twilio/src/main/java/datadog/trace/instrumentation/twilio/TwilioClientDecorator.java", "diffHunk": "@@ -20,26 +20,26 @@\n \n   public static final TwilioClientDecorator DECORATE = new TwilioClientDecorator();\n \n-  static final String COMPONENT_NAME = \"twilio-sdk\";\n+  static final CharSequence COMPONENT_NAME = UTF8BytesString.createConstant(\"twilio-sdk\");\n \n   @Override\n-  protected String spanType() {\n-    return DDSpanTypes.HTTP_CLIENT;\n+  protected CharSequence spanType() {\n+    return InternalSpanTypes.HTTP_CLIENT;\n   }\n \n   @Override\n   protected String[] instrumentationNames() {\n-    return new String[] {COMPONENT_NAME};\n+    return new String[] {COMPONENT_NAME.toString()};\n   }\n \n   @Override\n-  protected String component() {\n+  protected CharSequence component() {\n     return COMPONENT_NAME;\n   }\n \n   @Override\n   protected String service() {\n-    return COMPONENT_NAME;\n+    return COMPONENT_NAME.toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d88f6e2dbdde19a559d526e765fd98596d5ba7c", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0d88f6e2dbdde19a559d526e765fd98596d5ba7c", "committedDate": "2020-09-25T17:32:04Z", "message": "make component a CharSequence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8db0ca8d254275f9d59d6f15d44e78d976ed0c79", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8db0ca8d254275f9d59d6f15d44e78d976ed0c79", "committedDate": "2020-09-25T17:32:04Z", "message": "only copy the string when it's need for weak keys"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d08b5b08afe0ac070fb5e3f2c61f03115f038f7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3d08b5b08afe0ac070fb5e3f2c61f03115f038f7", "committedDate": "2020-09-25T16:57:28Z", "message": "tweak tests to handle CharSequence component and type"}, "afterCommit": {"oid": "bab9316f0ea060a002c58a71151d28f72b260f28", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bab9316f0ea060a002c58a71151d28f72b260f28", "committedDate": "2020-09-25T17:32:04Z", "message": "revapi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NjIyNTkw", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#pullrequestreview-496622590", "createdAt": "2020-09-25T17:42:24Z", "commit": {"oid": "bab9316f0ea060a002c58a71151d28f72b260f28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85605056683368897716eba0a5d02a59c49e0ef6", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/85605056683368897716eba0a5d02a59c49e0ef6", "committedDate": "2020-09-25T19:17:32Z", "message": "remove tags string table in preference of UTF8ByteString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "946345edd8109ef87480f93c2a4a5a7e9e3943a7", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/946345edd8109ef87480f93c2a4a5a7e9e3943a7", "committedDate": "2020-09-25T19:17:32Z", "message": "ignore constants file for coverage metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4853c182a51b50b39edaea4c4fbcd65aab95f9f8", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/4853c182a51b50b39edaea4c4fbcd65aab95f9f8", "committedDate": "2020-09-25T19:17:32Z", "message": "tweak tests to handle CharSequence component and type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f83039adf11159cff8c9f2e19f6cb443dda02cd0", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/f83039adf11159cff8c9f2e19f6cb443dda02cd0", "committedDate": "2020-09-25T19:17:32Z", "message": "revapi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f8bc6a7b98fa834a3b89a211cba8a4092d9fafd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6f8bc6a7b98fa834a3b89a211cba8a4092d9fafd", "committedDate": "2020-09-25T19:17:55Z", "message": "don't precompute UTF-8 for mongo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bab9316f0ea060a002c58a71151d28f72b260f28", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bab9316f0ea060a002c58a71151d28f72b260f28", "committedDate": "2020-09-25T17:32:04Z", "message": "revapi"}, "afterCommit": {"oid": "6f8bc6a7b98fa834a3b89a211cba8a4092d9fafd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6f8bc6a7b98fa834a3b89a211cba8a4092d9fafd", "committedDate": "2020-09-25T19:17:55Z", "message": "don't precompute UTF-8 for mongo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1f31eb4802eb92c7425dd8d44da7f22d60903cf", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a1f31eb4802eb92c7425dd8d44da7f22d60903cf", "committedDate": "2020-09-28T09:45:33Z", "message": "improvements to trace mappers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NDE5NDkz", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#pullrequestreview-497419493", "createdAt": "2020-09-28T11:26:04Z", "commit": {"oid": "8db0ca8d254275f9d59d6f15d44e78d976ed0c79"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMToyNjowNVrOHY5bEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTozMzo1MVrOHY5piw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg2ODY5MA==", "bodyText": "Yes, my original code was a bit defensive.", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#discussion_r495868690", "createdAt": "2020-09-28T11:26:05Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/jdbc/src/main/java/datadog/trace/instrumentation/jdbc/ConnectionInstrumentation.java", "diffHunk": "@@ -61,7 +61,7 @@ public static void addDBInfo(\n       // check if we have seen this String before\n       UTF8BytesString utf8Sql = JDBCMaps.preparedStatementsSql.get(sql);\n       if (utf8Sql == null) {\n-        utf8Sql = UTF8BytesString.create(sql);\n+        utf8Sql = UTF8BytesString.createWeak(sql);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db0ca8d254275f9d59d6f15d44e78d976ed0c79"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3MjM5NQ==", "bodyText": "Why is this not using the InternalSpanTypes.MONGO?", "url": "https://github.com/DataDog/dd-trace-java/pull/1914#discussion_r495872395", "createdAt": "2020-09-28T11:33:51Z", "author": {"login": "bantonsson"}, "path": "dd-java-agent/instrumentation/mongo/driver-3.1/src/main/java/datadog/trace/instrumentation/mongo/MongoClientDecorator.java", "diffHunk": "@@ -37,12 +37,12 @@ protected String service() {\n \n   @Override\n   protected CharSequence component() {\n-    return JAVA_MONGO;\n+    return \"java-mongo\";\n   }\n \n   @Override\n   protected CharSequence spanType() {\n-    return InternalSpanTypes.MONGO;\n+    return DDSpanTypes.MONGO;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f8bc6a7b98fa834a3b89a211cba8a4092d9fafd"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3157, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}