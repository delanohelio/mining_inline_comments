{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5OTYzNjA5", "number": 1630, "title": "remove deprecated dbtagtypeinterceptor", "bodyText": "This aims to move logic specific to certain instrumentations (e.g. why does the tag interceptor need to special case elasticsearch or memcached?) by adding another decorator type into the hierarchy. Almost all DatabaseClientDecorators now inherit default behaviour in afterStart. There are a few special cases:\n\nelasticsearch and couchbase decorators just set the service name and database type tag\nJDBC waits until there is db info available\n\nThis also leads to saving some work: setting the service name could happen multiple times previously, and it isn't free (there's a service name mapping lookup) and putting tags into a ConcurrentHashMap isn't free either, we should strive not to do things like this more than once where possible.", "createdAt": "2020-06-25T11:39:14Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1630", "merged": true, "mergeCommit": {"oid": "e0c18ce5d84c2a90358705640da00f7b5c878e6a"}, "closed": true, "closedAt": "2020-06-25T22:29:31Z", "author": {"login": "richardstartin"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuuIZOABqjM0ODIyMzQzNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcu2AUMgFqTQzNzg4OTkxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9524fa9849e81d520e8af50496d23c794bf77409", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9524fa9849e81d520e8af50496d23c794bf77409", "committedDate": "2020-06-25T11:36:19Z", "message": "remove DBTagTypeInterceptor"}, "afterCommit": {"oid": "23602bf773af4aadabfb2339b73e50fa0fbf68bc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/23602bf773af4aadabfb2339b73e50fa0fbf68bc", "committedDate": "2020-06-25T12:51:06Z", "message": "remove DBTagTypeInterceptor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23602bf773af4aadabfb2339b73e50fa0fbf68bc", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/23602bf773af4aadabfb2339b73e50fa0fbf68bc", "committedDate": "2020-06-25T12:51:06Z", "message": "remove DBTagTypeInterceptor"}, "afterCommit": {"oid": "567159229e2809ae5a9fcc923291e6f609c5a79a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/567159229e2809ae5a9fcc923291e6f609c5a79a", "committedDate": "2020-06-25T13:16:10Z", "message": "remove DBTagTypeInterceptor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "567159229e2809ae5a9fcc923291e6f609c5a79a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/567159229e2809ae5a9fcc923291e6f609c5a79a", "committedDate": "2020-06-25T13:16:10Z", "message": "remove DBTagTypeInterceptor"}, "afterCommit": {"oid": "bc99da0c90e8a7b9ef75d31e45b6f76369978fce", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bc99da0c90e8a7b9ef75d31e45b6f76369978fce", "committedDate": "2020-06-25T14:20:31Z", "message": "remove DBTagTypeInterceptor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NjIwNTEx", "url": "https://github.com/DataDog/dd-trace-java/pull/1630#pullrequestreview-437620511", "createdAt": "2020-06-25T15:40:03Z", "commit": {"oid": "bc99da0c90e8a7b9ef75d31e45b6f76369978fce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNTo0MDowM1rOGpAhbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNTo0MDowM1rOGpAhbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1MzM1OQ==", "bodyText": "By default a hard coded service name is set to the result of service() implemented by subclasses of this decorator.", "url": "https://github.com/DataDog/dd-trace-java/pull/1630#discussion_r445653359", "createdAt": "2020-06-25T15:40:03Z", "author": {"login": "tylerbenson"}, "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/decorator/DatabaseClientDecorator.java", "diffHunk": "@@ -33,14 +40,27 @@ public AgentSpan onConnection(final AgentSpan span, final CONNECTION connection)\n       span.setTag(Tags.DB_USER, dbUser(connection));\n       final String instanceName = dbInstance(connection);\n       span.setTag(Tags.DB_INSTANCE, instanceName);\n-\n+      // TODO - what happens when isDbClientSplitByInstance() returns false?\n+      //  No tag would have been set anyway - is there a test?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc99da0c90e8a7b9ef75d31e45b6f76369978fce"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc99da0c90e8a7b9ef75d31e45b6f76369978fce", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/bc99da0c90e8a7b9ef75d31e45b6f76369978fce", "committedDate": "2020-06-25T14:20:31Z", "message": "remove DBTagTypeInterceptor"}, "afterCommit": {"oid": "00a52990e1588e4334342bfe48022289da7ebd5e", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/00a52990e1588e4334342bfe48022289da7ebd5e", "committedDate": "2020-06-25T16:20:06Z", "message": "move FixedSizeCache to agent-bootstrap, remove DBTagTypeInterceptor, move logic to DB decorator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c261af20b3b37e7216c8ab435a53b446e19c1cdb", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c261af20b3b37e7216c8ab435a53b446e19c1cdb", "committedDate": "2020-06-25T19:18:12Z", "message": "remove inefficient hashmap access idiom in setting service name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00a52990e1588e4334342bfe48022289da7ebd5e", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/00a52990e1588e4334342bfe48022289da7ebd5e", "committedDate": "2020-06-25T16:20:06Z", "message": "move FixedSizeCache to agent-bootstrap, remove DBTagTypeInterceptor, move logic to DB decorator"}, "afterCommit": {"oid": "0773e08e69b98303eef55049975d62e8fbaeeadd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0773e08e69b98303eef55049975d62e8fbaeeadd", "committedDate": "2020-06-25T20:24:08Z", "message": "remove DBTagTypeInterceptor and move logic into DatabaseClientDecorator hierarchy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0773e08e69b98303eef55049975d62e8fbaeeadd", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/0773e08e69b98303eef55049975d62e8fbaeeadd", "committedDate": "2020-06-25T20:24:08Z", "message": "remove DBTagTypeInterceptor and move logic into DatabaseClientDecorator hierarchy"}, "afterCommit": {"oid": "e027fe431adb4a666a0b6105c26b52d852011d4d", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e027fe431adb4a666a0b6105c26b52d852011d4d", "committedDate": "2020-06-25T20:35:55Z", "message": "remove DBTagTypeInterceptor and move logic into DatabaseClientDecorator hierarchy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3ODQzODkx", "url": "https://github.com/DataDog/dd-trace-java/pull/1630#pullrequestreview-437843891", "createdAt": "2020-06-25T20:43:15Z", "commit": {"oid": "e027fe431adb4a666a0b6105c26b52d852011d4d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ec76cc7d3cb5af1208161aee94b36ef47903ec9", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7ec76cc7d3cb5af1208161aee94b36ef47903ec9", "committedDate": "2020-06-25T21:02:31Z", "message": "no need to set span type twice"}, "afterCommit": {"oid": "7b8ea6fbcca8bc4d2c99f6cc33c97dbf8395d383", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7b8ea6fbcca8bc4d2c99f6cc33c97dbf8395d383", "committedDate": "2020-06-25T21:33:35Z", "message": "no need to set span type twice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a237c1abc7df4565edfa44a5907c99aebcb1d8f", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7a237c1abc7df4565edfa44a5907c99aebcb1d8f", "committedDate": "2020-06-25T21:34:42Z", "message": "remove DBTagTypeInterceptor and move logic into DatabaseClientDecorator hierarchy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdaf87ea7e2e964bde37fd19fa8311511f34654a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cdaf87ea7e2e964bde37fd19fa8311511f34654a", "committedDate": "2020-06-25T21:34:42Z", "message": "revapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b8ea6fbcca8bc4d2c99f6cc33c97dbf8395d383", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/7b8ea6fbcca8bc4d2c99f6cc33c97dbf8395d383", "committedDate": "2020-06-25T21:33:35Z", "message": "no need to set span type twice"}, "afterCommit": {"oid": "cdaf87ea7e2e964bde37fd19fa8311511f34654a", "author": {"user": {"login": "richardstartin", "name": "Richard Startin"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cdaf87ea7e2e964bde37fd19fa8311511f34654a", "committedDate": "2020-06-25T21:34:42Z", "message": "revapi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3ODg5OTE5", "url": "https://github.com/DataDog/dd-trace-java/pull/1630#pullrequestreview-437889919", "createdAt": "2020-06-25T22:01:41Z", "commit": {"oid": "cdaf87ea7e2e964bde37fd19fa8311511f34654a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMjowMTo0MVrOGpNVkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMjowMTo0MVrOGpNVkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2MzMxNQ==", "bodyText": "maybe 0.57.0 already", "url": "https://github.com/DataDog/dd-trace-java/pull/1630#discussion_r445863315", "createdAt": "2020-06-25T22:01:41Z", "author": {"login": "lpriima"}, "path": ".palantir/revapi.yml", "diffHunk": "@@ -457,3 +457,9 @@ acceptedBreaks:\n     - code: \"java.method.removed\"\n       old: \"method void datadog.trace.core.CoreTracer::addDecorator(datadog.trace.core.decorators.AbstractDecorator)\"\n       justification: \"rename legacy decorator to tag interceptor\"\n+  \"0.56.0\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdaf87ea7e2e964bde37fd19fa8311511f34654a"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2212, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}