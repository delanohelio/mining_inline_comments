{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4ODQ5NzEx", "number": 1467, "title": "More refactoring for ScopeManager", "bodyText": "The main goal here is to enable better modularity in how scopes are managed. A ScopeInterceptor can be added to enable wrapping of the scope to support various behaviors.  This process also allowed splitting up existing logic to more cohesive parts.  It might be easier to follow to view individual commits.", "createdAt": "2020-05-15T22:06:16Z", "url": "https://github.com/DataDog/dd-trace-java/pull/1467", "merged": true, "mergeCommit": {"oid": "3ec11704d7bfa50c827ce077f3aae42d891636a7"}, "closed": true, "closedAt": "2020-05-19T01:17:39Z", "author": {"login": "tylerbenson"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciOnDVAFqTQxMzE4MTg4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABciozPsgBqjMzNDk1MTUwMjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTgxODg2", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#pullrequestreview-413181886", "createdAt": "2020-05-17T17:20:49Z", "commit": {"oid": "ef4b34ff9f6a921527c3a42c2f9e6e57b1b145ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNzoyMDo0OVrOGWiWAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNzoyMDo0OVrOGWiWAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI4NDU0Ng==", "bodyText": "Is this essentially for chaining and not really for 'delegate' in a 'wrap and change behaviour'? It would be nice to have some comments into intent of this design.", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#discussion_r426284546", "createdAt": "2020-05-17T17:20:49Z", "author": {"login": "mar-kolya"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/scopemanager/DelegateScopeInterceptor.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package datadog.trace.core.scopemanager;\n+\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.context.TraceScope;\n+\n+abstract class DelegateScopeInterceptor implements ScopeInterceptor {\n+  protected final ScopeInterceptor delegate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef4b34ff9f6a921527c3a42c2f9e6e57b1b145ea"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2f1095131a9f796314d83c1efba3be33dda851f", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e2f1095131a9f796314d83c1efba3be33dda851f", "committedDate": "2020-05-18T19:34:41Z", "message": "Separate out JFR event management from ContextualScopeManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5acc3e6a24084a7cc0beb26eeb3812ae76c94f6", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/b5acc3e6a24084a7cc0beb26eeb3812ae76c94f6", "committedDate": "2020-05-18T19:34:41Z", "message": "Separate out ScopeListener notification from ContextualScopeManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d655a287183a43e774bebf442dbc2959148423", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/49d655a287183a43e774bebf442dbc2959148423", "committedDate": "2020-05-18T19:34:41Z", "message": "Rename ContextualScopeManager->ContinuableScopeManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b248f2244aac58f212c5366671dfc289faf434f", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8b248f2244aac58f212c5366671dfc289faf434f", "committedDate": "2020-05-18T19:34:42Z", "message": "Move ContinuableScope and Continuation inside ContinuableScopeManager\n\nAnd make private."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a110966731831b7fb4bd9945a32eba6b71cd41ed", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/a110966731831b7fb4bd9945a32eba6b71cd41ed", "committedDate": "2020-05-18T19:34:42Z", "message": "Reduce visibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e84078dcac49841155fdc4623df6e517b911136b", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/e84078dcac49841155fdc4623df6e517b911136b", "committedDate": "2020-05-18T19:37:14Z", "message": "More refactoring and revapi updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e3b38106b23958fff064bf104599657d4144931", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/3e3b38106b23958fff064bf104599657d4144931", "committedDate": "2020-05-18T19:37:14Z", "message": "Avoid duplicate ScopeListener for slf4j"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06c565af2cc99e2d7a431ca38e865743eae70f5a", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/06c565af2cc99e2d7a431ca38e865743eae70f5a", "committedDate": "2020-05-18T19:30:29Z", "message": "Avoid duplicate ScopeListener for slf4j"}, "afterCommit": {"oid": "17f86816c5935f5a747c77dd1bcf6ee7bf30c771", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/17f86816c5935f5a747c77dd1bcf6ee7bf30c771", "committedDate": "2020-05-18T19:59:50Z", "message": "Remove unused method and add coverage ignore."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6c007f18bdd32bfc244efe56292ed0160b8fa63", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d6c007f18bdd32bfc244efe56292ed0160b8fa63", "committedDate": "2020-05-18T20:51:51Z", "message": "Remove unused method and add coverage ignore."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17f86816c5935f5a747c77dd1bcf6ee7bf30c771", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/17f86816c5935f5a747c77dd1bcf6ee7bf30c771", "committedDate": "2020-05-18T19:59:50Z", "message": "Remove unused method and add coverage ignore."}, "afterCommit": {"oid": "d6c007f18bdd32bfc244efe56292ed0160b8fa63", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/d6c007f18bdd32bfc244efe56292ed0160b8fa63", "committedDate": "2020-05-18T20:51:51Z", "message": "Remove unused method and add coverage ignore."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec7a222768dba5f84a42e56f136cce09b82751c", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/9ec7a222768dba5f84a42e56f136cce09b82751c", "committedDate": "2020-05-18T21:29:24Z", "message": "Add comments and additional refactoring."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTQxMzcw", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#pullrequestreview-413941370", "createdAt": "2020-05-18T21:10:23Z", "commit": {"oid": "d6c007f18bdd32bfc244efe56292ed0160b8fa63"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMToxMDoyM1rOGXHm5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMToyNDoxMVrOGXH-Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5NTA3Nw==", "bodyText": "Isn't this assuming a continuable scope? depth() isn't on DDScope anymore.", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#discussion_r426895077", "createdAt": "2020-05-18T21:10:23Z", "author": {"login": "randomanderson"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/scopemanager/ScopeManagerTest.groovy", "diffHunk": "@@ -138,11 +138,11 @@ class ScopeManagerTest extends DDSpecification {\n     for (int i = 0; i <= depth; i++) {\n       def span = tracer.buildSpan(\"test\").start()\n       scope = tracer.activateSpan(span)\n-      assert scope instanceof ContinuableScope\n+      assert scope instanceof DDScope\n     }\n \n     then: \"last scope is still valid\"\n-    (scope as ContinuableScope).depth() == depth\n+    (scope as DDScope).depth() == depth", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c007f18bdd32bfc244efe56292ed0160b8fa63"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5NTI4MQ==", "bodyText": "See previous comment about depth()", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#discussion_r426895281", "createdAt": "2020-05-18T21:10:47Z", "author": {"login": "randomanderson"}, "path": "dd-trace-core/src/test/groovy/datadog/trace/core/scopemanager/ScopeManagerTest.groovy", "diffHunk": "@@ -157,16 +157,16 @@ class ScopeManagerTest extends DDSpecification {\n     scope instanceof NoopAgentScope\n \n     and: \"scope stack not effected.\"\n-    (scopeManager.active() as ContinuableScope).depth() == depth\n+    (scopeManager.active() as DDScope).depth() == depth", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c007f18bdd32bfc244efe56292ed0160b8fa63"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwMTA3OQ==", "bodyText": "This whole file seems unrelated to the PR", "url": "https://github.com/DataDog/dd-trace-java/pull/1467#discussion_r426901079", "createdAt": "2020-05-18T21:24:11Z", "author": {"login": "randomanderson"}, "path": "dd-trace-core/src/main/java/datadog/trace/core/serialization/MsgpackFormatWriter.java", "diffHunk": "@@ -86,16 +93,4 @@ public void writeBigInteger(byte[] key, BigInteger value, MessagePacker destinat\n       destination.packBigInteger(value);\n     }\n   }\n-\n-  private static void writeStringUTF8(String value, MessagePacker destination) throws IOException {\n-    if (value.length() < 256) {\n-      byte[] interned = StringTables.getBytesUTF8(value);\n-      if (null != interned) {\n-        destination.packRawStringHeader(interned.length);\n-        destination.addPayload(interned);\n-        return;\n-      }\n-    }\n-    destination.packString(value);\n-  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c007f18bdd32bfc244efe56292ed0160b8fa63"}, "originalPosition": 99}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bdde93c3d8285487e4e9d7a992b346a86f657ac", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/8bdde93c3d8285487e4e9d7a992b346a86f657ac", "committedDate": "2020-05-18T22:41:28Z", "message": "Remove type weirdness from refactor in test"}, "afterCommit": {"oid": "6b09fc4cdae163d4bc28fa7cd44f950177b36a22", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6b09fc4cdae163d4bc28fa7cd44f950177b36a22", "committedDate": "2020-05-18T22:42:52Z", "message": "Remove type weirdness from refactor in test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b09fc4cdae163d4bc28fa7cd44f950177b36a22", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/6b09fc4cdae163d4bc28fa7cd44f950177b36a22", "committedDate": "2020-05-18T22:42:52Z", "message": "Remove type weirdness from refactor in test"}, "afterCommit": {"oid": "c4d6698a81ee6dd6ed352d1753af725f9ffc10c6", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c4d6698a81ee6dd6ed352d1753af725f9ffc10c6", "committedDate": "2020-05-18T23:30:59Z", "message": "Remove type weirdness from refactor in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb44882ce7ed3830852adf59732ee1dd38e61c46", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cb44882ce7ed3830852adf59732ee1dd38e61c46", "committedDate": "2020-05-18T23:51:18Z", "message": "Remove type weirdness from refactor in test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4d6698a81ee6dd6ed352d1753af725f9ffc10c6", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/c4d6698a81ee6dd6ed352d1753af725f9ffc10c6", "committedDate": "2020-05-18T23:30:59Z", "message": "Remove type weirdness from refactor in test"}, "afterCommit": {"oid": "cb44882ce7ed3830852adf59732ee1dd38e61c46", "author": {"user": {"login": "tylerbenson", "name": "Tyler Benson"}}, "url": "https://github.com/DataDog/dd-trace-java/commit/cb44882ce7ed3830852adf59732ee1dd38e61c46", "committedDate": "2020-05-18T23:51:18Z", "message": "Remove type weirdness from refactor in test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2508, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}