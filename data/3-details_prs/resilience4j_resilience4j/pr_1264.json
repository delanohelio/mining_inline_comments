{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMDUwNTM5", "number": 1264, "title": "rate limiter - drain permissions on result config option", "bodyText": "rest of the code outlined in #1228", "createdAt": "2020-12-05T17:07:25Z", "url": "https://github.com/resilience4j/resilience4j/pull/1264", "merged": true, "mergeCommit": {"oid": "4387316387ba6e1776688ad0a212be90edd68fe4"}, "closed": true, "closedAt": "2021-01-11T07:57:24Z", "author": {"login": "walec51"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjPdqzAH2gAyNTMzMDUwNTM5Ojg5YjQ5ODZhZWQ2N2Y2ODA5NmY0MTBjOWU5NjU4Y2YyNjA4MmU1ZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvBxcNgFqTU2NTEyMjM3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89b4986aed67f68096f410c9e9658cf26082e5fa", "author": {"user": null}, "url": "https://github.com/resilience4j/resilience4j/commit/89b4986aed67f68096f410c9e9658cf26082e5fa", "committedDate": "2020-12-05T17:05:34Z", "message": "rate limiter - drain permissions on result config option"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MDEyNjYy", "url": "https://github.com/resilience4j/resilience4j/pull/1264#pullrequestreview-546012662", "createdAt": "2020-12-07T10:25:43Z", "commit": {"oid": "89b4986aed67f68096f410c9e9658cf26082e5fa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDoyNTo0M1rOIAf2XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDoyNjo1OFrOIAf5jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5MjczMg==", "bodyText": "Please introduce and use an onResult hook", "url": "https://github.com/resilience4j/resilience4j/pull/1264#discussion_r537392732", "createdAt": "2020-12-07T10:25:43Z", "author": {"login": "RobWin"}, "path": "resilience4j-ratelimiter/src/main/java/io/github/resilience4j/ratelimiter/RateLimiter.java", "diffHunk": "@@ -185,7 +191,14 @@ static RateLimiter ofDefaults(String name) {\n     ) {\n         return () -> {\n             waitForPermission(rateLimiter, permits);\n-            return supplier.get();\n+            try {\n+                F result = supplier.get();\n+                drainIfNeeded(rateLimiter, CallsResult.success(result));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89b4986aed67f68096f410c9e9658cf26082e5fa"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5Mjk5MA==", "bodyText": "Please introduce and use an onError hook", "url": "https://github.com/resilience4j/resilience4j/pull/1264#discussion_r537392990", "createdAt": "2020-12-07T10:26:08Z", "author": {"login": "RobWin"}, "path": "resilience4j-ratelimiter/src/main/java/io/github/resilience4j/ratelimiter/RateLimiter.java", "diffHunk": "@@ -185,7 +191,14 @@ static RateLimiter ofDefaults(String name) {\n     ) {\n         return () -> {\n             waitForPermission(rateLimiter, permits);\n-            return supplier.get();\n+            try {\n+                F result = supplier.get();\n+                drainIfNeeded(rateLimiter, CallsResult.success(result));\n+                return result;\n+            } catch (Exception exception) {\n+                drainIfNeeded(rateLimiter, CallsResult.failure(exception));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89b4986aed67f68096f410c9e9658cf26082e5fa"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5MzU0OQ==", "bodyText": "Please use Either<Throwable, Object> instead of CallsResult", "url": "https://github.com/resilience4j/resilience4j/pull/1264#discussion_r537393549", "createdAt": "2020-12-07T10:26:58Z", "author": {"login": "RobWin"}, "path": "resilience4j-ratelimiter/src/main/java/io/github/resilience4j/ratelimiter/RateLimiterConfig.java", "diffHunk": "@@ -161,6 +173,21 @@ public Builder writableStackTraceEnabled(boolean writableStackTraceEnabled) {\n             return this;\n         }\n \n+        /**\n+         * Allows you to check the result of a call decorated by this rate limiter and make a decision\n+         * should we drain all the permissions left it the current period. Useful in situations when\n+         * despite using a RateLimiter the underlining called service will say that you passed the maximum number of calls for a given period.\n+         *\n+         * @param drainPermissionsOnResult your function should return true when the permissions drain\n+         *                                 should happen\n+         * @return the RateLimiterConfig.Builder\n+         * @see RateLimiter#drainPermissions()\n+         */\n+        public Builder drainPermissionsOnResult(Function<CallsResult, Boolean> drainPermissionsOnResult) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89b4986aed67f68096f410c9e9658cf26082e5fa"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fee707e81a22a60f31b2632443c9455e16d5da2", "author": {"user": null}, "url": "https://github.com/resilience4j/resilience4j/commit/0fee707e81a22a60f31b2632443c9455e16d5da2", "committedDate": "2021-01-06T21:23:45Z", "message": "Merge remote-tracking branch 'upstream/master' into ratelimiter-drain-on-exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e41b75315e1bce4267ec32c95c2f79a2ac26db0", "author": {"user": null}, "url": "https://github.com/resilience4j/resilience4j/commit/0e41b75315e1bce4267ec32c95c2f79a2ac26db0", "committedDate": "2021-01-06T22:14:05Z", "message": "review fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMjc0MzY0", "url": "https://github.com/resilience4j/resilience4j/pull/1264#pullrequestreview-563274364", "createdAt": "2021-01-07T07:57:11Z", "commit": {"oid": "0e41b75315e1bce4267ec32c95c2f79a2ac26db0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNzo1NzoxMlrOIPiYGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNzo1NzoxMlrOIPiYGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE2Mjc3Nw==", "bodyText": "Please add the Apache Licence Header", "url": "https://github.com/resilience4j/resilience4j/pull/1264#discussion_r553162777", "createdAt": "2021-01-07T07:57:12Z", "author": {"login": "RobWin"}, "path": "resilience4j-core/src/main/java/io/github/resilience4j/core/ResultUtils.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package io.github.resilience4j.core;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e41b75315e1bce4267ec32c95c2f79a2ac26db0"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e644d1dbe1b02a0d499df87a9fb4772c6551608f", "author": {"user": null}, "url": "https://github.com/resilience4j/resilience4j/commit/e644d1dbe1b02a0d499df87a9fb4772c6551608f", "committedDate": "2021-01-09T11:31:14Z", "message": "license header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1MTIyMzcy", "url": "https://github.com/resilience4j/resilience4j/pull/1264#pullrequestreview-565122372", "createdAt": "2021-01-11T07:55:35Z", "commit": {"oid": "e644d1dbe1b02a0d499df87a9fb4772c6551608f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1740, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}