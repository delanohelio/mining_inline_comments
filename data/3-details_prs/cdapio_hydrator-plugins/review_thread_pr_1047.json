{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMjcxNzcy", "number": 1047, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTo1MDowNVrODq--ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTo1MTowOFrODq-_iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Mzk4NTY1OnYy", "diffSide": "RIGHT", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTo1MDowNVrOF7EbxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjoxMDoxM1rOF7E__w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4Mjk0OQ==", "bodyText": "nit: indentation", "url": "https://github.com/cdapio/hydrator-plugins/pull/1047#discussion_r397482949", "createdAt": "2020-03-24T21:50:05Z", "author": {"login": "CuriousVini"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -194,29 +195,37 @@ public void initialize(BatchJoinerRuntimeContext context) {\n \n   @Override\n   public StructuredRecord joinOn(String stageName, StructuredRecord record) {\n-    List<Schema.Field> fields = new ArrayList<>();\n-    Schema schema = record.getSchema();\n+    Schema keySchema;\n+    List<String> joinKeys = perStageJoinKeys.get(stageName);\n \n+    if (keySchemas.containsKey(stageName)) {\n+      keySchema = keySchemas.get(stageName);\n+    } else {\n+      List<Schema.Field> fields = new ArrayList<>();\n+      Schema schema = record.getSchema();\n \n-    List<String> joinKeys = perStageJoinKeys.get(stageName);\n-    int i = 1;\n-    for (String joinKey : joinKeys) {\n-      Schema.Field field = schema.getField(joinKey);\n-      if (field == null) {\n-        throw new IllegalArgumentException(String.format(\"Join key field '%s' does not exist in schema from '%s'.\",\n-                                                         joinKey, stageName));\n+      int i = 1;\n+      for (String joinKey : joinKeys) {\n+        Schema.Field field = schema.getField(joinKey);\n+        if (field == null) {\n+          throw new IllegalArgumentException(String.format(\"Join key field '%s' does not exist in schema from '%s'.\",\n+                  joinKey, stageName));\n+        }\n+        Schema.Field joinField = Schema.Field.of(String.valueOf(i++), field.getSchema());\n+        fields.add(joinField);\n       }\n-      Schema.Field joinField = Schema.Field.of(String.valueOf(i++), field.getSchema());\n-      fields.add(joinField);\n-    }\n-    Schema keySchema = Schema.recordOf(\"join.key\", fields);\n-    StructuredRecord.Builder keyRecordBuilder = StructuredRecord.builder(keySchema);\n-    i = 1;\n-    for (String joinKey : joinKeys) {\n-      keyRecordBuilder.set(String.valueOf(i++), record.get(joinKey));\n+      keySchema = Schema.recordOf(\"join.key\", fields);\n+      keySchemas.put(stageName, keySchema);\n     }\n+      StructuredRecord.Builder keyRecordBuilder = StructuredRecord.builder(keySchema);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0299ab0472841373e9140186c4a356f1f0fb7a1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MjIyMw==", "bodyText": "fixed.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1047#discussion_r397492223", "createdAt": "2020-03-24T22:10:13Z", "author": {"login": "rmstar"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -194,29 +195,37 @@ public void initialize(BatchJoinerRuntimeContext context) {\n \n   @Override\n   public StructuredRecord joinOn(String stageName, StructuredRecord record) {\n-    List<Schema.Field> fields = new ArrayList<>();\n-    Schema schema = record.getSchema();\n+    Schema keySchema;\n+    List<String> joinKeys = perStageJoinKeys.get(stageName);\n \n+    if (keySchemas.containsKey(stageName)) {\n+      keySchema = keySchemas.get(stageName);\n+    } else {\n+      List<Schema.Field> fields = new ArrayList<>();\n+      Schema schema = record.getSchema();\n \n-    List<String> joinKeys = perStageJoinKeys.get(stageName);\n-    int i = 1;\n-    for (String joinKey : joinKeys) {\n-      Schema.Field field = schema.getField(joinKey);\n-      if (field == null) {\n-        throw new IllegalArgumentException(String.format(\"Join key field '%s' does not exist in schema from '%s'.\",\n-                                                         joinKey, stageName));\n+      int i = 1;\n+      for (String joinKey : joinKeys) {\n+        Schema.Field field = schema.getField(joinKey);\n+        if (field == null) {\n+          throw new IllegalArgumentException(String.format(\"Join key field '%s' does not exist in schema from '%s'.\",\n+                  joinKey, stageName));\n+        }\n+        Schema.Field joinField = Schema.Field.of(String.valueOf(i++), field.getSchema());\n+        fields.add(joinField);\n       }\n-      Schema.Field joinField = Schema.Field.of(String.valueOf(i++), field.getSchema());\n-      fields.add(joinField);\n-    }\n-    Schema keySchema = Schema.recordOf(\"join.key\", fields);\n-    StructuredRecord.Builder keyRecordBuilder = StructuredRecord.builder(keySchema);\n-    i = 1;\n-    for (String joinKey : joinKeys) {\n-      keyRecordBuilder.set(String.valueOf(i++), record.get(joinKey));\n+      keySchema = Schema.recordOf(\"join.key\", fields);\n+      keySchemas.put(stageName, keySchema);\n     }\n+      StructuredRecord.Builder keyRecordBuilder = StructuredRecord.builder(keySchema);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4Mjk0OQ=="}, "originalCommit": {"oid": "a0299ab0472841373e9140186c4a356f1f0fb7a1"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Mzk4NzM4OnYy", "diffSide": "RIGHT", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTo1MDozOVrOF7Ec2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjoxMDowN1rOF7E_2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MzIyNQ==", "bodyText": "nit: return keyRecordBuilder.build();", "url": "https://github.com/cdapio/hydrator-plugins/pull/1047#discussion_r397483225", "createdAt": "2020-03-24T21:50:39Z", "author": {"login": "CuriousVini"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -194,29 +195,37 @@ public void initialize(BatchJoinerRuntimeContext context) {\n \n   @Override\n   public StructuredRecord joinOn(String stageName, StructuredRecord record) {\n-    List<Schema.Field> fields = new ArrayList<>();\n-    Schema schema = record.getSchema();\n+    Schema keySchema;\n+    List<String> joinKeys = perStageJoinKeys.get(stageName);\n \n+    if (keySchemas.containsKey(stageName)) {\n+      keySchema = keySchemas.get(stageName);\n+    } else {\n+      List<Schema.Field> fields = new ArrayList<>();\n+      Schema schema = record.getSchema();\n \n-    List<String> joinKeys = perStageJoinKeys.get(stageName);\n-    int i = 1;\n-    for (String joinKey : joinKeys) {\n-      Schema.Field field = schema.getField(joinKey);\n-      if (field == null) {\n-        throw new IllegalArgumentException(String.format(\"Join key field '%s' does not exist in schema from '%s'.\",\n-                                                         joinKey, stageName));\n+      int i = 1;\n+      for (String joinKey : joinKeys) {\n+        Schema.Field field = schema.getField(joinKey);\n+        if (field == null) {\n+          throw new IllegalArgumentException(String.format(\"Join key field '%s' does not exist in schema from '%s'.\",\n+                  joinKey, stageName));\n+        }\n+        Schema.Field joinField = Schema.Field.of(String.valueOf(i++), field.getSchema());\n+        fields.add(joinField);\n       }\n-      Schema.Field joinField = Schema.Field.of(String.valueOf(i++), field.getSchema());\n-      fields.add(joinField);\n-    }\n-    Schema keySchema = Schema.recordOf(\"join.key\", fields);\n-    StructuredRecord.Builder keyRecordBuilder = StructuredRecord.builder(keySchema);\n-    i = 1;\n-    for (String joinKey : joinKeys) {\n-      keyRecordBuilder.set(String.valueOf(i++), record.get(joinKey));\n+      keySchema = Schema.recordOf(\"join.key\", fields);\n+      keySchemas.put(stageName, keySchema);\n     }\n+      StructuredRecord.Builder keyRecordBuilder = StructuredRecord.builder(keySchema);\n+      int i = 1;\n+      for (String joinKey : joinKeys) {\n+        keyRecordBuilder.set(String.valueOf(i++), record.get(joinKey));\n+      }\n+\n+      StructuredRecord keyRecord = keyRecordBuilder.build();\n+      return keyRecord;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0299ab0472841373e9140186c4a356f1f0fb7a1"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MjE4Nw==", "bodyText": "fixed.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1047#discussion_r397492187", "createdAt": "2020-03-24T22:10:07Z", "author": {"login": "rmstar"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -194,29 +195,37 @@ public void initialize(BatchJoinerRuntimeContext context) {\n \n   @Override\n   public StructuredRecord joinOn(String stageName, StructuredRecord record) {\n-    List<Schema.Field> fields = new ArrayList<>();\n-    Schema schema = record.getSchema();\n+    Schema keySchema;\n+    List<String> joinKeys = perStageJoinKeys.get(stageName);\n \n+    if (keySchemas.containsKey(stageName)) {\n+      keySchema = keySchemas.get(stageName);\n+    } else {\n+      List<Schema.Field> fields = new ArrayList<>();\n+      Schema schema = record.getSchema();\n \n-    List<String> joinKeys = perStageJoinKeys.get(stageName);\n-    int i = 1;\n-    for (String joinKey : joinKeys) {\n-      Schema.Field field = schema.getField(joinKey);\n-      if (field == null) {\n-        throw new IllegalArgumentException(String.format(\"Join key field '%s' does not exist in schema from '%s'.\",\n-                                                         joinKey, stageName));\n+      int i = 1;\n+      for (String joinKey : joinKeys) {\n+        Schema.Field field = schema.getField(joinKey);\n+        if (field == null) {\n+          throw new IllegalArgumentException(String.format(\"Join key field '%s' does not exist in schema from '%s'.\",\n+                  joinKey, stageName));\n+        }\n+        Schema.Field joinField = Schema.Field.of(String.valueOf(i++), field.getSchema());\n+        fields.add(joinField);\n       }\n-      Schema.Field joinField = Schema.Field.of(String.valueOf(i++), field.getSchema());\n-      fields.add(joinField);\n-    }\n-    Schema keySchema = Schema.recordOf(\"join.key\", fields);\n-    StructuredRecord.Builder keyRecordBuilder = StructuredRecord.builder(keySchema);\n-    i = 1;\n-    for (String joinKey : joinKeys) {\n-      keyRecordBuilder.set(String.valueOf(i++), record.get(joinKey));\n+      keySchema = Schema.recordOf(\"join.key\", fields);\n+      keySchemas.put(stageName, keySchema);\n     }\n+      StructuredRecord.Builder keyRecordBuilder = StructuredRecord.builder(keySchema);\n+      int i = 1;\n+      for (String joinKey : joinKeys) {\n+        keyRecordBuilder.set(String.valueOf(i++), record.get(joinKey));\n+      }\n+\n+      StructuredRecord keyRecord = keyRecordBuilder.build();\n+      return keyRecord;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MzIyNQ=="}, "originalCommit": {"oid": "a0299ab0472841373e9140186c4a356f1f0fb7a1"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Mzk4ODU3OnYy", "diffSide": "LEFT", "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTo1MTowOFrOF7EdqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowMjozMVrOF7Eygg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MzQzMg==", "bodyText": "why do we need to remove this? we still need this in case inputschemas are non-null right?", "url": "https://github.com/cdapio/hydrator-plugins/pull/1047#discussion_r397483432", "createdAt": "2020-03-24T21:51:08Z", "author": {"login": "CuriousVini"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -291,7 +300,6 @@ void validateJoinKeySchemas(Map<String, Schema> inputSchemas, Map<String, List<S\n   }\n \n   Schema getOutputSchema(Map<String, Schema> inputSchemas, FailureCollector collector) {\n-    validateJoinKeySchemas(inputSchemas, conf.getPerStageJoinKeys(), collector);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0299ab0472841373e9140186c4a356f1f0fb7a1"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4ODc3MA==", "bodyText": "getOutputSchema() is called from a couple of places:\n\nconfigurePipeline()\ninitialize()\nIn both of these functions, init(), which calls validateJoinKeySchemas(),  is called before getOuputSchema().", "url": "https://github.com/cdapio/hydrator-plugins/pull/1047#discussion_r397488770", "createdAt": "2020-03-24T22:02:31Z", "author": {"login": "rmstar"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/joiner/Joiner.java", "diffHunk": "@@ -291,7 +300,6 @@ void validateJoinKeySchemas(Map<String, Schema> inputSchemas, Map<String, List<S\n   }\n \n   Schema getOutputSchema(Map<String, Schema> inputSchemas, FailureCollector collector) {\n-    validateJoinKeySchemas(inputSchemas, conf.getPerStageJoinKeys(), collector);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MzQzMg=="}, "originalCommit": {"oid": "a0299ab0472841373e9140186c4a356f1f0fb7a1"}, "originalPosition": 68}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2503, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}