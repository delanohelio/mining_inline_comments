{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5MjYxMDU0", "number": 1070, "title": "[CDAP-16532] multi-level input schema serialization as csv, tsv or delimited validation errors", "bodyText": "This PR adds a validation check to make sure that when user has multi-level or nested input structure and are serializing it as CSV, TSV or DELIMITED there is a appropriate error message as well as limiting that combination.", "createdAt": "2020-04-05T21:46:47Z", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070", "merged": true, "mergeCommit": {"oid": "3da04f4367c9e5f5ec8ae1c1d86c0d600ff3e4ab"}, "closed": true, "closedAt": "2020-04-07T03:19:47Z", "author": {"login": "nitinmotgi"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUxNt_AH2gAyMzk5MjYxMDU0OmQzYjVhOWMyNjhhMWQ1OTIwZTY4YjdjODlhMzVjNjI0ODg0MmY0MmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVIyYrAFqTM4ODcyMTc0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f", "author": {"user": {"login": "nitinmotgi", "name": "Joltie Root"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/d3b5a9c268a1d5920e68b7c89a35c6248842f42f", "committedDate": "2020-04-05T21:44:54Z", "message": "[CDAP-16532] multi-level input schema serialization as csv, tsv or delimited validation error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODY3MjYw", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#pullrequestreview-387867260", "createdAt": "2020-04-05T22:16:15Z", "commit": {"oid": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQyMjoxNjoxNlrOGBD0gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQyMjoyMTowMlrOGBD2ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NDM1Mw==", "bodyText": "Was the default CSV? Or are we changing it to CSV?", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r403764353", "createdAt": "2020-04-05T22:16:16Z", "author": {"login": "chtyim"}, "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSinkConfig.java", "diffHunk": "@@ -84,13 +84,32 @@ public void validate(FailureCollector collector) {\n           .withConfigProperty(NAME_SUFFIX).withStacktrace(e.getStackTrace());\n       }\n     }\n+\n+    FileFormat format = FileFormat.CSV;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NDg5NA==", "bodyText": "Can be just\nboolean allSimple = schema.getFields().stream().map(Schema.Field::getSchema).allMatch(Schema::isSimpleOrNullableSimple)", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r403764894", "createdAt": "2020-04-05T22:21:02Z", "author": {"login": "chtyim"}, "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSinkConfig.java", "diffHunk": "@@ -84,13 +84,32 @@ public void validate(FailureCollector collector) {\n           .withConfigProperty(NAME_SUFFIX).withStacktrace(e.getStackTrace());\n       }\n     }\n+\n+    FileFormat format = FileFormat.CSV;\n     try {\n-      getFormat();\n+      format = getFormat();\n     } catch (IllegalArgumentException e) {\n       collector.addFailure(e.getMessage(), null).withConfigProperty(NAME_FORMAT).withStacktrace(e.getStackTrace());\n     }\n     try {\n-      getSchema();\n+      Schema schema = getSchema();\n+      // Checks if the output schema has fields that are not simple type.\n+      // If there are non-simple field types, then serializing as CSV might not be appropriate.\n+      // This restriction is on Csv, Delimited and Tab separated files.\n+      if (format == FileFormat.CSV || format == FileFormat.DELIMITED || format == FileFormat.TSV) {\n+        boolean simpleFields = true;\n+        for (Schema.Field field : schema.getFields()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13f63f1686efa91fcb1977fb5bb506d040623a4c", "author": {"user": {"login": "nitinmotgi", "name": "Joltie Root"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/13f63f1686efa91fcb1977fb5bb506d040623a4c", "committedDate": "2020-04-06T15:16:23Z", "message": "[CDAP-16532] Addressed review comments, defaulted format to JSON as in UI as well changed to use streams"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MzU0MTMx", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#pullrequestreview-388354131", "createdAt": "2020-04-06T15:17:33Z", "commit": {"oid": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNToxNzozNFrOGBczPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNToxNzozNFrOGBczPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE3MzYyOQ==", "bodyText": "should we use the word \"nested\" in the message? Also, it would help to add the name of the field that has the problem?", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404173629", "createdAt": "2020-04-06T15:17:34Z", "author": {"login": "bdmogal"}, "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSinkConfig.java", "diffHunk": "@@ -84,13 +84,32 @@ public void validate(FailureCollector collector) {\n           .withConfigProperty(NAME_SUFFIX).withStacktrace(e.getStackTrace());\n       }\n     }\n+\n+    FileFormat format = FileFormat.CSV;\n     try {\n-      getFormat();\n+      format = getFormat();\n     } catch (IllegalArgumentException e) {\n       collector.addFailure(e.getMessage(), null).withConfigProperty(NAME_FORMAT).withStacktrace(e.getStackTrace());\n     }\n     try {\n-      getSchema();\n+      Schema schema = getSchema();\n+      // Checks if the output schema has fields that are not simple type.\n+      // If there are non-simple field types, then serializing as CSV might not be appropriate.\n+      // This restriction is on Csv, Delimited and Tab separated files.\n+      if (format == FileFormat.CSV || format == FileFormat.DELIMITED || format == FileFormat.TSV) {\n+        boolean simpleFields = true;\n+        for (Schema.Field field : schema.getFields()) {\n+          if (!field.getSchema().isSimpleOrNullableSimple()) {\n+            simpleFields = false;\n+            break;\n+          }\n+        }\n+        collector.addFailure(\n+          String.format(\"Input has multi-level structure that cannot be represented appropriately in %s.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTQ2MzA2", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#pullrequestreview-388546306", "createdAt": "2020-04-06T19:19:26Z", "commit": {"oid": "13f63f1686efa91fcb1977fb5bb506d040623a4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToxOToyNlrOGBmWiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToxOToyNlrOGBmWiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMDEyMw==", "bodyText": "this validation should be done in the format (DelimitedOutputFormatProvider's validate method), not in the file sink.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404330123", "createdAt": "2020-04-06T19:19:26Z", "author": {"login": "albertshau"}, "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSinkConfig.java", "diffHunk": "@@ -84,13 +84,30 @@ public void validate(FailureCollector collector) {\n           .withConfigProperty(NAME_SUFFIX).withStacktrace(e.getStackTrace());\n       }\n     }\n+\n+    FileFormat format = FileFormat.JSON;\n     try {\n-      getFormat();\n+      format = getFormat();\n     } catch (IllegalArgumentException e) {\n       collector.addFailure(e.getMessage(), null).withConfigProperty(NAME_FORMAT).withStacktrace(e.getStackTrace());\n     }\n     try {\n-      getSchema();\n+      Schema schema = getSchema();\n+      // Checks if the output schema has fields that are not simple type.\n+      // If there are non-simple field types, then serializing as CSV might not be appropriate.\n+      // This restriction is on Csv, Delimited and Tab separated files.\n+      if (format == FileFormat.CSV || format == FileFormat.DELIMITED || format == FileFormat.TSV) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13f63f1686efa91fcb1977fb5bb506d040623a4c"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzIxNzQy", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#pullrequestreview-388721742", "createdAt": "2020-04-07T01:12:46Z", "commit": {"oid": "13f63f1686efa91fcb1977fb5bb506d040623a4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1642, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}