{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MTgzNjMw", "number": 1034, "title": "(PLUGIN-114) Added COUNTDISTINCT function to count the distinct value\u2026", "bodyText": "\u2026s in a column\nIssue: PLUGIN-114", "createdAt": "2020-03-07T19:19:21Z", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034", "merged": true, "mergeCommit": {"oid": "a62672fe8484da2b1c358b90c3a112f262c42a35"}, "closed": true, "closedAt": "2020-03-12T08:53:10Z", "author": {"login": "bdmogal"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMAT-6AFqTM3MTMyNDY1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMwH0_ABqjMxMjA5NDYwMzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzI0NjU1", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#pullrequestreview-371324655", "createdAt": "2020-03-09T16:15:00Z", "commit": {"oid": "ea1a6691b112b8d0c20a0f0d956945be4b8c0bbc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjoxNTowMFrOFzvZHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjoxNTowMFrOFzvZHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5ODE3NQ==", "bodyText": "this will only work for some field types. Those types should be validated at configure time, and again at prepare time if it couldn't be checked at configure time due to macros. More specifically, this will not \"work\" except on ints, longs, strings, floats, and doubles. And for floats and doubles, it doesn't really make much sense.\nIf it needs to work for other types, it is quite a bit more complex.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r389798175", "createdAt": "2020-03-09T16:15:00Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.plugin.batch.aggregator.function;\n+\n+import io.cdap.cdap.api.data.format.StructuredRecord;\n+import io.cdap.cdap.api.data.schema.Schema;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Count distinct values of a specific column\n+ */\n+public class CountDistinct implements AggregateFunction<Integer> {\n+  private final String fieldName;\n+  private Set<Object> collectSet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea1a6691b112b8d0c20a0f0d956945be4b8c0bbc"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzI2MTcz", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#pullrequestreview-371326173", "createdAt": "2020-03-09T16:16:42Z", "commit": {"oid": "ea1a6691b112b8d0c20a0f0d956945be4b8c0bbc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjoxNjo0MlrOFzvdtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjoxNjo0MlrOFzvdtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5OTM0OA==", "bodyText": "a little better to have the Set as final and create it in the constructor, and clear it here.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r389799348", "createdAt": "2020-03-09T16:16:42Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/CountDistinct.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.plugin.batch.aggregator.function;\n+\n+import io.cdap.cdap.api.data.format.StructuredRecord;\n+import io.cdap.cdap.api.data.schema.Schema;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Count distinct values of a specific column\n+ */\n+public class CountDistinct implements AggregateFunction<Integer> {\n+  private final String fieldName;\n+  private Set<Object> collectSet;\n+\n+  public CountDistinct(String fieldName) {\n+    this.fieldName = fieldName;\n+  }\n+\n+  @Override\n+  public void beginFunction() {\n+    collectSet = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea1a6691b112b8d0c20a0f0d956945be4b8c0bbc"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f87a05371e937a5351e2beb7adabaa824c79fea", "author": {"user": {"login": "bdmogal", "name": "Bhooshan Mogal"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/9f87a05371e937a5351e2beb7adabaa824c79fea", "committedDate": "2020-03-10T04:18:52Z", "message": "Address a comment"}, "afterCommit": {"oid": "d0df39679a70b9486e8b1fb710fc54fb17a249f1", "author": {"user": {"login": "bdmogal", "name": "Bhooshan Mogal"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/d0df39679a70b9486e8b1fb710fc54fb17a249f1", "committedDate": "2020-03-11T03:21:58Z", "message": "Address comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTgyNzc1", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#pullrequestreview-373182775", "createdAt": "2020-03-11T23:00:34Z", "commit": {"oid": "d0df39679a70b9486e8b1fb710fc54fb17a249f1"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzowMDozNVrOF1MJOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzowNjowOVrOF1MQ7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzgxNw==", "bodyText": "is it possible for this to be false at this point? seems like it wouldn't be.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r391317817", "createdAt": "2020-03-11T23:00:35Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java", "diffHunk": "@@ -131,9 +131,29 @@ public void validate(Schema inputSchema, List<String> groupByFields,\n                                            functionInfo.getName(), functionInfo.getField()), null)\n           .withConfigElement(\"aggregates\", collectorFieldName);\n       }\n-    }\n \n+      // TODO: CDAP-16401 - Push down validation to individual aggregate functions\n+      if (GroupByConfig.Function.COUNTDISTINCT == functionInfo.getFunction()) {\n+        if (!conf.containsMacro(\"aggregates\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0df39679a70b9486e8b1fb710fc54fb17a249f1"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxODQwMQ==", "bodyText": "does it really make sense to allow float and double? It could potentially go out of memory easily, with 0.000001 different than 0.00000001, etc.\nIn Java when you check equality of floats and doubles most IDEs will flag it as a warning.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r391318401", "createdAt": "2020-03-11T23:02:11Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java", "diffHunk": "@@ -131,9 +131,29 @@ public void validate(Schema inputSchema, List<String> groupByFields,\n                                            functionInfo.getName(), functionInfo.getField()), null)\n           .withConfigElement(\"aggregates\", collectorFieldName);\n       }\n-    }\n \n+      // TODO: CDAP-16401 - Push down validation to individual aggregate functions\n+      if (GroupByConfig.Function.COUNTDISTINCT == functionInfo.getFunction()) {\n+        if (!conf.containsMacro(\"aggregates\")) {\n+          validateCountDistinct(inputField, collector, collectorFieldName);\n+        }\n+      }\n+    }\n+  }\n \n+  private void validateCountDistinct(Schema.Field inputField, FailureCollector collector, String validationFieldName) {\n+    if (inputField != null) {\n+      Schema.Type type = inputField.getSchema().isNullable() ?\n+        inputField.getSchema().getNonNullable().getType() :\n+        inputField.getSchema().getType();\n+      if (type != Schema.Type.STRING && type != Schema.Type.INT && type != Schema.Type.LONG &&\n+        type != Schema.Type.FLOAT && type != Schema.Type.DOUBLE && type != Schema.Type.BOOLEAN) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0df39679a70b9486e8b1fb710fc54fb17a249f1"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTc4OQ==", "bodyText": "though i guess the same could be set for CollectSet. We probably need a way to collect warnings and failures, with this falling under the warning category.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#discussion_r391319789", "createdAt": "2020-03-11T23:06:09Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java", "diffHunk": "@@ -131,9 +131,29 @@ public void validate(Schema inputSchema, List<String> groupByFields,\n                                            functionInfo.getName(), functionInfo.getField()), null)\n           .withConfigElement(\"aggregates\", collectorFieldName);\n       }\n-    }\n \n+      // TODO: CDAP-16401 - Push down validation to individual aggregate functions\n+      if (GroupByConfig.Function.COUNTDISTINCT == functionInfo.getFunction()) {\n+        if (!conf.containsMacro(\"aggregates\")) {\n+          validateCountDistinct(inputField, collector, collectorFieldName);\n+        }\n+      }\n+    }\n+  }\n \n+  private void validateCountDistinct(Schema.Field inputField, FailureCollector collector, String validationFieldName) {\n+    if (inputField != null) {\n+      Schema.Type type = inputField.getSchema().isNullable() ?\n+        inputField.getSchema().getNonNullable().getType() :\n+        inputField.getSchema().getType();\n+      if (type != Schema.Type.STRING && type != Schema.Type.INT && type != Schema.Type.LONG &&\n+        type != Schema.Type.FLOAT && type != Schema.Type.DOUBLE && type != Schema.Type.BOOLEAN) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxODQwMQ=="}, "originalCommit": {"oid": "d0df39679a70b9486e8b1fb710fc54fb17a249f1"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1ebcff81b8babd0adea8d8223243971a31fe44d", "author": {"user": {"login": "bdmogal", "name": "Bhooshan Mogal"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/a1ebcff81b8babd0adea8d8223243971a31fe44d", "committedDate": "2020-03-11T23:39:55Z", "message": "removed unnecessary condition"}, "afterCommit": {"oid": "251bcd7c2613f49df5f116c8aa71f6ae8aba2a92", "author": {"user": {"login": "bdmogal", "name": "Bhooshan Mogal"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/251bcd7c2613f49df5f116c8aa71f6ae8aba2a92", "committedDate": "2020-03-11T23:40:27Z", "message": "removed unnecessary condition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjAxMzI5", "url": "https://github.com/cdapio/hydrator-plugins/pull/1034#pullrequestreview-373201329", "createdAt": "2020-03-11T23:56:15Z", "commit": {"oid": "50cb8d813b25f1dc950841c8ec204f9b79e36257"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40da3e37a5eee1ddfdffa781ac59f9e9742dde13", "author": {"user": {"login": "bdmogal", "name": "Bhooshan Mogal"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/40da3e37a5eee1ddfdffa781ac59f9e9742dde13", "committedDate": "2020-03-11T23:56:52Z", "message": "(PLUGIN-114) Added COUNTDISTINCT function to count the distinct values in a column"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50cb8d813b25f1dc950841c8ec204f9b79e36257", "author": {"user": {"login": "bdmogal", "name": "Bhooshan Mogal"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/50cb8d813b25f1dc950841c8ec204f9b79e36257", "committedDate": "2020-03-11T23:48:07Z", "message": "Removed support for float and double"}, "afterCommit": {"oid": "40da3e37a5eee1ddfdffa781ac59f9e9742dde13", "author": {"user": {"login": "bdmogal", "name": "Bhooshan Mogal"}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/40da3e37a5eee1ddfdffa781ac59f9e9742dde13", "committedDate": "2020-03-11T23:56:52Z", "message": "(PLUGIN-114) Added COUNTDISTINCT function to count the distinct values in a column"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1609, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}