{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI5OTU2MjY2", "number": 1107, "title": "CDAP-16895 use new aggregator api", "bodyText": "This is taking much longer than expected because of big changes in all the aggregation functions and unit tests in groupBy plugin, still cannot find a good way to compute the population variance based on variance from two groups, so change it to sample variance.", "createdAt": "2020-06-07T10:45:37Z", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107", "merged": true, "mergeCommit": {"oid": "f2fdf8eaeecbf7cf53f38441e5f5378e8bc78f4f"}, "closed": true, "closedAt": "2020-06-09T18:56:35Z", "author": {"login": "yaojiefeng"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABco5jZJABqjM0MTYyNzM3OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcppwsIABqjM0MjYzOTE2NzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74790c686b1d6e017261a59ed3a94021bc115837", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/74790c686b1d6e017261a59ed3a94021bc115837", "committedDate": "2020-06-07T10:37:59Z", "message": "CDAP-16895 use new aggregator api"}, "afterCommit": {"oid": "59c990c12caa7cfa72a9b3e641b8d5a3ffafe239", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/59c990c12caa7cfa72a9b3e641b8d5a3ffafe239", "committedDate": "2020-06-07T10:46:03Z", "message": "CDAP-16895 use new aggregator api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59c990c12caa7cfa72a9b3e641b8d5a3ffafe239", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/59c990c12caa7cfa72a9b3e641b8d5a3ffafe239", "committedDate": "2020-06-07T10:46:03Z", "message": "CDAP-16895 use new aggregator api"}, "afterCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/f03c0eb709c1361a85312b6ff12be0fb8cfadeb2", "committedDate": "2020-06-07T10:50:17Z", "message": "CDAP-16895 use new aggregator api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDk5OTQ1", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#pullrequestreview-426499945", "createdAt": "2020-06-08T18:22:06Z", "commit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxODoyMjowNlrOGgqkYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOToxODozM1rOGgs9Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwNTA1OQ==", "bodyText": "if the input schema is null, moving this check down will cause the validation to be skipped.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r436905059", "createdAt": "2020-06-08T18:22:06Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/DedupAggregator.java", "diffHunk": "@@ -87,6 +84,13 @@ public void configurePipeline(PipelineConfigurer pipelineConfigurer) {\n     Schema outputSchema = getOutputSchema(inputSchema);\n     FailureCollector collector = stageConfigurer.getFailureCollector();\n     validateSchema(outputSchema, uniqueFields, functionInfo, collector);\n+\n+    if (functionInfo != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwODIyNQ==", "bodyText": "I'm confused about what is being put in this Table. Whatever object this is needs to be Serializable right? Does this work properly?", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r436908225", "createdAt": "2020-06-08T18:27:52Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java", "diffHunk": "@@ -174,26 +179,50 @@ public void groupBy(StructuredRecord record, Emitter<StructuredRecord> emitter)\n   }\n \n   @Override\n-  public void aggregate(StructuredRecord groupKey, Iterator<StructuredRecord> iterator,\n-                        Emitter<StructuredRecord> emitter) throws Exception {\n-    if (!iterator.hasNext()) {\n-      return;\n+  public Table<String, String, Object> initializeAggregateValue(StructuredRecord record) {\n+    Table<String, String, Object> table = HashBasedTable.create();\n+    table.put(SCHEMA, \"\", record.getSchema());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwOTI5OQ==", "bodyText": "I'm confused about what is in this Table.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r436909299", "createdAt": "2020-06-08T18:29:58Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/AggregateFunction.java", "diffHunk": "@@ -16,27 +16,46 @@\n \n package io.cdap.plugin.batch.aggregator.function;\n \n+import com.google.common.collect.Table;\n import io.cdap.cdap.api.data.format.StructuredRecord;\n import io.cdap.cdap.api.data.schema.Schema;\n \n+import javax.annotation.Nullable;\n+\n /**\n- * Performs an aggregation. For each group that needs an aggregate to be calculated, the {@link #beginFunction()}\n- * method is called first. After that, one or more calls to {@link #operateOn(StructuredRecord)} are made, one call for\n- * each value in the group. Finally, {@link #getAggregate()} is called to retrieve the aggregate.\n- *\n- * todo: convert this to a plugin\n+ * Performs an aggregation.\n  *\n  * @param <T> type of aggregate value\n  */\n-public interface AggregateFunction<T> extends RecordFunctionLifecycle {\n+public interface AggregateFunction<T> {\n+\n+  /**\n+   * Merge the given record to the aggregated collection. This function is guaranteed to get called at least once\n+   * before {@link #mergeAggregates(Table, Table)} is called.\n+   *\n+   * @param agg the aggregated collection, the merged result should be added to it\n+   * @param record the record to merge\n+   */\n+  void mergeValue(Table<String, String, Object> agg, StructuredRecord record);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxNjk2Nw==", "bodyText": "after reading some more, it seems like a proper object here would be better, would make it more clear what is happening instead of using special keys.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r436916967", "createdAt": "2020-06-08T18:43:44Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/GroupByAggregator.java", "diffHunk": "@@ -174,26 +179,50 @@ public void groupBy(StructuredRecord record, Emitter<StructuredRecord> emitter)\n   }\n \n   @Override\n-  public void aggregate(StructuredRecord groupKey, Iterator<StructuredRecord> iterator,\n-                        Emitter<StructuredRecord> emitter) throws Exception {\n-    if (!iterator.hasNext()) {\n-      return;\n+  public Table<String, String, Object> initializeAggregateValue(StructuredRecord record) {\n+    Table<String, String, Object> table = HashBasedTable.create();\n+    table.put(SCHEMA, \"\", record.getSchema());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwODIyNQ=="}, "originalCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyNjMxMA==", "bodyText": "ok so it looks like Table is used to prevent conflicts between fields in the group key and intermediate data?\nIt seems like it would be better to have a separate class that contains the group key as a field along with any additional fields that are required.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r436926310", "createdAt": "2020-06-08T19:00:48Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/Avg.java", "diffHunk": "@@ -38,32 +43,45 @@ public Avg(String fieldName, Schema fieldSchema) {\n         \"Cannot compute avg on field %s because its type %s is not numeric\", fieldName, fieldType));\n     }\n \n+    // the avg is null only if the field value is always null\n     outputSchema = isNullable ? Schema.nullableOf(Schema.of(Schema.Type.DOUBLE)) : Schema.of(Schema.Type.DOUBLE);\n   }\n \n   @Override\n-  public void beginFunction() {\n-    avg = 0d;\n-    count = 0d;\n+  public void mergeValue(Table<String, String, Object> agg, StructuredRecord record) {\n+    Object val = record.get(fieldName);\n+    if (val == null) {\n+      return;\n+    }\n+    computeAvg(agg, 1L, (Number) val);\n   }\n \n   @Override\n-  public void operateOn(StructuredRecord record) {\n-    Object val = record.get(fieldName);\n+  public void mergeAggregates(Table<String, String, Object> agg1, Table<String, String, Object> agg2) {\n+    Object val = agg2.get(fieldName, AGG_KEY);\n     if (val == null) {\n       return;\n     }\n-    count++;\n-    avg = avg + (((Number) val).doubleValue() - avg) / count;\n+    Long agg2Count = (Long) agg2.get(fieldName, AGG_COUNT_KEY);\n+    computeAvg(agg1, agg2Count, (Number) val);\n   }\n \n-  @Override\n-  public Double getAggregate() {\n-    if (count == 0) {\n-      // only happens if the field value was always null\n-      return null;\n+  private void computeAvg(Table<String, String, Object> table, long deltaCount, Number oldAvg) {\n+    if (!table.contains(fieldName, AGG_KEY)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyNzM5MA==", "bodyText": "After reading some more it seems like it's used to carry intermediate data? Using Table as the intermediate data makes things harder to understand and maintain because it's not clear what is in the Table.\nIt seems like it would be better for each individual function to be able to decide what reduced data it needs to keep track of, using an actual object instead of a Table or a Map with special keys.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r436927390", "createdAt": "2020-06-08T19:01:58Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/AggregateFunction.java", "diffHunk": "@@ -16,27 +16,46 @@\n \n package io.cdap.plugin.batch.aggregator.function;\n \n+import com.google.common.collect.Table;\n import io.cdap.cdap.api.data.format.StructuredRecord;\n import io.cdap.cdap.api.data.schema.Schema;\n \n+import javax.annotation.Nullable;\n+\n /**\n- * Performs an aggregation. For each group that needs an aggregate to be calculated, the {@link #beginFunction()}\n- * method is called first. After that, one or more calls to {@link #operateOn(StructuredRecord)} are made, one call for\n- * each value in the group. Finally, {@link #getAggregate()} is called to retrieve the aggregate.\n- *\n- * todo: convert this to a plugin\n+ * Performs an aggregation.\n  *\n  * @param <T> type of aggregate value\n  */\n-public interface AggregateFunction<T> extends RecordFunctionLifecycle {\n+public interface AggregateFunction<T> {\n+\n+  /**\n+   * Merge the given record to the aggregated collection. This function is guaranteed to get called at least once\n+   * before {@link #mergeAggregates(Table, Table)} is called.\n+   *\n+   * @param agg the aggregated collection, the merged result should be added to it\n+   * @param record the record to merge\n+   */\n+  void mergeValue(Table<String, String, Object> agg, StructuredRecord record);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwOTI5OQ=="}, "originalCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkzNjg4NA==", "bodyText": "typo", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r436936884", "createdAt": "2020-06-08T19:11:51Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/Stddev.java", "diffHunk": "@@ -16,51 +16,50 @@\n \n package io.cdap.plugin.batch.aggregator.function;\n \n+import com.google.common.collect.Table;\n import io.cdap.cdap.api.data.format.StructuredRecord;\n import io.cdap.cdap.api.data.schema.Schema;\n import io.cdap.plugin.batch.aggregator.AggregationUtils;\n \n+import javax.annotation.Nullable;\n+\n /**\n  * Calculates the Standard Deviation\n  */\n public class Stddev implements AggregateFunction<Double> {\n-  private final String fieldName;\n-  private final Schema outputSchema;\n-  private RunningStats stats;\n+  private final AggregateFunction<Double> variance;\n \n   public Stddev(String fieldName, Schema fieldSchema) {\n-    this.fieldName = fieldName;\n-    boolean isNullable = fieldSchema.isNullable();\n-    Schema.Type fieldType = isNullable ? fieldSchema.getNonNullable().getType() : fieldSchema.getType();\n+    Schema.Type fieldType = fieldSchema.isNullable() ? fieldSchema.getNonNullable().getType() : fieldSchema.getType();\n     if (!AggregationUtils.isNumericType(fieldType)) {\n       throw new IllegalArgumentException(String.format(\n-        \"Cannot compute standard deviation on field %s because its type %s is not numeric\", fieldName, fieldType));\n+        \"Cannot compute standard devisation on field %s because its type %s is not numeric\", fieldName, fieldType));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0NDIyNg==", "bodyText": "I thought the difference between population and sample variance is just the denominator, where one divides by n, and the other by n+1? If you're keeping track of the squared mean and count, it seems like it should be straightforward division?", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r436944226", "createdAt": "2020-06-08T19:18:33Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/Variance.java", "diffHunk": "@@ -16,17 +16,28 @@\n \n package io.cdap.plugin.batch.aggregator.function;\n \n+import com.google.common.collect.Table;\n import io.cdap.cdap.api.data.format.StructuredRecord;\n import io.cdap.cdap.api.data.schema.Schema;\n import io.cdap.plugin.batch.aggregator.AggregationUtils;\n \n+import javax.annotation.Nullable;\n+\n /**\n- * Calculates Variance\n+ * Calculates Sample Variance\n+ * TODO: CDAP-16911 figure out a way to compute population variance", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f03c0eb709c1361a85312b6ff12be0fb8cfadeb2"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a7fee876f6a7bf62aa22331f9838e33c14b78a9", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/0a7fee876f6a7bf62aa22331f9838e33c14b78a9", "committedDate": "2020-06-09T17:21:48Z", "message": "get rid of table"}, "afterCommit": {"oid": "6e44efc1e5dd1615a0a78138c20a75dff840d542", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/6e44efc1e5dd1615a0a78138c20a75dff840d542", "committedDate": "2020-06-09T17:28:12Z", "message": "get rid of table"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDM3MDk1", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#pullrequestreview-427437095", "createdAt": "2020-06-09T18:35:55Z", "commit": {"oid": "6e44efc1e5dd1615a0a78138c20a75dff840d542"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODozNTo1NVrOGhXUbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODozODoxMlrOGhXZGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzODI1Mw==", "bodyText": "I think these were originally done so that we don't do an extra comparison on type for every record. I don't think it actually matters much from a performance perspective, don't imagine this was a bottleneck in any way. Are we just changing it for readability?", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r437638253", "createdAt": "2020-06-09T18:35:55Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/Min.java", "diffHunk": "@@ -16,80 +16,54 @@\n \n package io.cdap.plugin.batch.aggregator.function;\n \n+import io.cdap.cdap.api.data.format.StructuredRecord;\n import io.cdap.cdap.api.data.schema.Schema;\n \n-import javax.annotation.Nullable;\n-\n /**\n  * Calculates minimum values of a field in a group.\n  */\n-public class Min extends NumberFunction {\n-  private Integer minInt;\n-  private Long minLong;\n-  private Float minFloat;\n-  private Double minDouble;\n+public class Min extends NumberFunction<Min> {\n \n-  public Min(String fieldName, @Nullable Schema fieldSchema) {\n+  public Min(String fieldName, Schema fieldSchema) {\n     super(fieldName, fieldSchema);\n   }\n \n   @Override\n-  protected void startInt() {\n-    minInt = null;\n-  }\n-\n-  @Override\n-  protected void startLong() {\n-    minLong = null;\n+  public void mergeValue(StructuredRecord record) {\n+    combine(record.get(fieldName));\n   }\n \n   @Override\n-  protected void startFloat() {\n-    minFloat = null;\n+  public void mergeAggregates(Min otherAgg) {\n+    combine(otherAgg.getAggregate());\n   }\n \n-  @Override\n-  protected void startDouble() {\n-    minDouble = null;\n-  }\n-\n-  @Override\n-  protected void updateInt(int val) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e44efc1e5dd1615a0a78138c20a75dff840d542"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzODg5NQ==", "bodyText": "there used to be null handling before, how come it is being removed? Was that actually never supported?", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r437638895", "createdAt": "2020-06-09T18:37:11Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/NumberSelection.java", "diffHunk": "@@ -19,172 +19,57 @@\n import io.cdap.cdap.api.data.format.StructuredRecord;\n import io.cdap.cdap.api.data.schema.Schema;\n \n-import java.util.List;\n-import javax.annotation.Nullable;\n-\n /**\n  * Base class for number based selection functions.\n  * Allows subclasses to implement typed methods instead of implementing their own casting logic.\n  * Guarantees that only methods for one type will be called for each aggregate. For example,\n- * if {@link #operateOn(StructuredRecord)} is called, only {@link #operateOnInt(int, StructuredRecord)} will be called.\n+ * if {@link #select(StructuredRecord, StructuredRecord)} is called,\n+ * only {@link #combineInt(int, int)} will be called.\n  */\n public abstract class NumberSelection implements SelectionFunction {\n-  private final SelectionFunction delegate;\n   private final String fieldName;\n+  private final Schema.Type fieldType;\n \n-  public NumberSelection(final String fieldName, @Nullable Schema fieldSchema) {\n+  public NumberSelection(String fieldName, Schema fieldSchema) {\n     this.fieldName = fieldName;\n-    // if schema is not known before we start getting records, just use doubles.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e44efc1e5dd1615a0a78138c20a75dff840d542"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzOTQ1MQ==", "bodyText": "these methods should be called 'compare' instead of 'combine', and they should all return an int.", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#discussion_r437639451", "createdAt": "2020-06-09T18:38:12Z", "author": {"login": "albertshau"}, "path": "core-plugins/src/main/java/io/cdap/plugin/batch/aggregator/function/NumberSelection.java", "diffHunk": "@@ -19,172 +19,57 @@\n import io.cdap.cdap.api.data.format.StructuredRecord;\n import io.cdap.cdap.api.data.schema.Schema;\n \n-import java.util.List;\n-import javax.annotation.Nullable;\n-\n /**\n  * Base class for number based selection functions.\n  * Allows subclasses to implement typed methods instead of implementing their own casting logic.\n  * Guarantees that only methods for one type will be called for each aggregate. For example,\n- * if {@link #operateOn(StructuredRecord)} is called, only {@link #operateOnInt(int, StructuredRecord)} will be called.\n+ * if {@link #select(StructuredRecord, StructuredRecord)} is called,\n+ * only {@link #combineInt(int, int)} will be called.\n  */\n public abstract class NumberSelection implements SelectionFunction {\n-  private final SelectionFunction delegate;\n   private final String fieldName;\n+  private final Schema.Type fieldType;\n \n-  public NumberSelection(final String fieldName, @Nullable Schema fieldSchema) {\n+  public NumberSelection(String fieldName, Schema fieldSchema) {\n     this.fieldName = fieldName;\n-    // if schema is not known before we start getting records, just use doubles.\n-    if (fieldSchema == null) {\n-      delegate = new SelectionFunction() {\n-        @Override\n-        public List<StructuredRecord> getSelectedRecords() {\n-          return getRecords();\n-        }\n+    this.fieldType = fieldSchema.isNullable() ? fieldSchema.getNonNullable().getType() : fieldSchema.getType();\n+  }\n \n-        @Override\n-        public void beginFunction() {\n-          startDouble();\n-        }\n+  protected abstract int combineInt(int val1, int val2);\n \n-        @Override\n-        public void operateOn(StructuredRecord record) {\n-          Number number = record.get(fieldName);\n-          if (number != null) {\n-            operateOnDouble(number.doubleValue(), record);\n-          }\n-        }\n-      };\n-      return;\n-    }\n+  protected abstract long combineLong(long val1, long val2);\n \n-    final boolean isNullable = fieldSchema.isNullable();\n-    Schema.Type fieldType = isNullable ? fieldSchema.getNonNullable().getType() : fieldSchema.getType();\n-    switch (fieldType) {\n-      case INT:\n-        delegate = new SelectionFunction() {\n-          @Override\n-          public List<StructuredRecord> getSelectedRecords() {\n-            return getRecords();\n-          }\n+  protected abstract float combineFloat(float val1, float val2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e44efc1e5dd1615a0a78138c20a75dff840d542"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDQ4NDQ1", "url": "https://github.com/cdapio/hydrator-plugins/pull/1107#pullrequestreview-427448445", "createdAt": "2020-06-09T18:51:34Z", "commit": {"oid": "8716e982cf18c1462c66ef16d7b9caf2cff40dfe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc9ba6d6edad7efd7822f3dd55e68b962b44ced4", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/bc9ba6d6edad7efd7822f3dd55e68b962b44ced4", "committedDate": "2020-06-09T18:56:00Z", "message": "CDAP-16895 use new aggregator api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8716e982cf18c1462c66ef16d7b9caf2cff40dfe", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/8716e982cf18c1462c66ef16d7b9caf2cff40dfe", "committedDate": "2020-06-09T18:49:44Z", "message": "address comment"}, "afterCommit": {"oid": "bc9ba6d6edad7efd7822f3dd55e68b962b44ced4", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/hydrator-plugins/commit/bc9ba6d6edad7efd7822f3dd55e68b962b44ced4", "committedDate": "2020-06-09T18:56:00Z", "message": "CDAP-16895 use new aggregator api"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1548, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}