{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NTk0ODY4", "number": 631, "title": "Fulltext search optimize", "bodyText": "", "createdAt": "2020-05-07T10:24:15Z", "url": "https://github.com/RIPE-NCC/whois/pull/631", "merged": true, "mergeCommit": {"oid": "c316da6e7c83990b1a7fad150d44b315d29a38cf"}, "closed": true, "closedAt": "2020-05-29T09:11:12Z", "author": {"login": "maggarwal13"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccqaFeAH2gAyNDE0NTk0ODY4OmEwYWIwNmY5YTkyNzMzYzQ5ODI4YTA0ZjBlNTFlZDM5NGJkMmU4Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl9-AagH2gAyNDE0NTk0ODY4OmEzNjAzOWE2ZjRiMTAwNjM1NTllNjQ3NGMwNGVkYzA1OGRjZjllMGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a0ab06f9a92733c49828a04f0e51ed394bd2e837", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/a0ab06f9a92733c49828a04f0e51ed394bd2e837", "committedDate": "2020-04-30T10:20:28Z", "message": "get rpslobject from database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a0ea0e012e97161159c32afeff72e24aad4e4b0", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/7a0ea0e012e97161159c32afeff72e24aad4e4b0", "committedDate": "2020-04-30T14:12:11Z", "message": "highlight string in lucene"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/f3e0696dc89db1882c67e4853cde561703bb52ff", "committedDate": "2020-05-04T08:50:34Z", "message": "fulltext search AutoComplete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4OTYyMjM4", "url": "https://github.com/RIPE-NCC/whois/pull/631#pullrequestreview-418962238", "createdAt": "2020-05-27T08:20:41Z", "commit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyMDo0MVrOGa-gnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo1NDozNFrOGa_xqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MDMxNg==", "bodyText": "Rename to rpslObjectDao for consistency", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430940316", "createdAt": "2020-05-27T08:20:41Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java", "diffHunk": "@@ -52,9 +56,12 @@\n \n     private final FullTextIndex fullTextIndex;\n \n+    private final RpslObjectDao objectDao;\n+\n     @Autowired\n-    public AutocompleteSearch(final FullTextIndex fullTextIndex) {\n+    public AutocompleteSearch(final FullTextIndex fullTextIndex, @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao objectDao) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MTg0MQ==", "bodyText": "Handle EmptyResultDataAccessException here (MariaDB and Lucene may be out of sync)", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430941841", "createdAt": "2020-05-27T08:23:18Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java", "diffHunk": "@@ -88,17 +95,22 @@ public AutocompleteSearch(final FullTextIndex fullTextIndex) {\n                 for (ScoreDoc scoreDoc : topDocs.scoreDocs) {\n                     final Document doc = indexSearcher.doc(scoreDoc.doc);\n                     final Map<String, Object> result = Maps.newLinkedHashMap();\n-                    result.put(\"key\", doc.get(FullTextIndex.LOOKUP_KEY_FIELD_NAME));\n-                    result.put(\"type\", doc.get(FullTextIndex.OBJECT_TYPE_FIELD_NAME));\n+\n+                    final RpslObject rpslObject =   objectDao.getByKey(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MzA3NQ==", "bodyText": "Rename to rpslObjectDao for consistency", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430943075", "createdAt": "2020-05-27T08:25:15Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "diffHunk": "@@ -69,15 +75,18 @@\n     private final AccessControlListManager accessControlListManager;\n     private final Source source;\n     private final Version version;\n+    private final RpslObjectDao objectDao;\n \n     @Autowired\n     public FullTextSearch(final FullTextIndex fullTextIndex,\n+                          @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao objectDao,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjMwNw==", "bodyText": "I would flip this Map around (document with a matching RpslObject) or create a list of \"pairs\"", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430952307", "createdAt": "2020-05-27T08:40:16Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "diffHunk": "@@ -164,23 +173,24 @@ protected SearchResponse doSearch(final IndexReader indexReader, final TaxonomyR\n \n                     indexSearcher.search(query, MultiCollector.wrap(topFieldCollector, facetsCollector));\n \n-                    final List<Document> documents = Lists.newArrayList();\n+                    final Map<RpslObject, Document> rpslObjectToDocument = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MzIzNA==", "bodyText": "If this should never happen, then Throw IllegalStateException", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430953234", "createdAt": "2020-05-27T08:41:50Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/IndexTemplate.java", "diffHunk": "@@ -229,24 +229,17 @@ protected void account(final RpslObject rpslObject) {\n             }\n         }\n \n-        protected RpslObject convertToRpslObject(Document document) {\n-            final List<RpslAttribute> attributes = Lists.newArrayList();\n-            int objectId = 0;\n-\n+        protected int getObjectId(Document document) {\n             for (final IndexableField field : document.getFields()) {\n                 if (SEARCH_INDEX_FIELDS_NOT_MAPPED_TO_RPSL_OBJECT.contains(field.name())) {\n                     if (\"primary-key\".equals(field.name())) {\n-                        objectId = Integer.parseInt(field.stringValue());\n+                        return  Integer.parseInt(field.stringValue());\n                     }\n-                } else {\n-                    attributes.add(new RpslAttribute(AttributeType.getByName(field.name()), field.stringValue()));\n                 }\n             }\n \n-            attributes.add(new RpslAttribute(AttributeType.SOURCE, source.getName()));\n-            return new RpslObject(objectId, attributes);\n+           return 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk2MTA2NQ==", "bodyText": "Remove this commented block altogether?", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430961065", "createdAt": "2020-05-27T08:54:34Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextIndex.java", "diffHunk": "@@ -289,30 +293,54 @@ private void addEntry(final IndexWriter indexWriter, final TaxonomyWriter taxono\n         document.add(new SortedDocValuesField(LOOKUP_KEY_FIELD_NAME, new BytesRef(rpslObject.getKey().toString())));\n         document.add(new StringField(LOOKUP_KEY_FIELD_NAME, rpslObject.getKey().toString(), Field.Store.YES));\n \n-        for (final RpslAttribute attribute : rpslObject.getAttributes()) {\n-            if (FILTERED_ATTRIBUTES.contains(attribute.getType())) {\n-                document.add(new Field(attribute.getKey(), sanitise(filterAttribute(attribute.getValue().trim())), FILTERED_ATTRIBUTE_FIELD_TYPE));\n-\n-            } else if (!SKIPPED_ATTRIBUTES.contains(attribute.getType())) {\n-                document.add(new Field(attribute.getKey(), sanitise(attribute.getValue().trim()), ATTRIBUTE_FIELD_TYPE));\n-            }\n+        for (final RpslAttribute attribute : filterRpslObject(rpslObject).getAttributes()) {\n+            document.add(new Field(attribute.getKey(), attribute.getValue().trim(), FILTERED_ATTRIBUTES.contains(attribute.getType()) ? FILTERED_ATTRIBUTE_FIELD_TYPE : ATTRIBUTE_FIELD_TYPE));\n         }\n \n         document.add(new FacetField(OBJECT_TYPE_FIELD_NAME, rpslObject.getType().getName()));\n \n         indexWriter.addDocument(facetsConfig.build(taxonomyWriter, document));\n     }\n \n+    public RpslObject filterRpslObject(final RpslObject rpslObject) {\n+\n+        List<RpslAttribute> attributes = Lists.newArrayList();\n+\n+        for (final RpslAttribute attribute : rpslObject.getAttributes()) {\n+            if (SKIPPED_ATTRIBUTES.contains(attribute.getType())) {\n+                continue;\n+            }\n+\n+            attributes.add(new RpslAttribute(attribute.getKey(), filterRpslAttribute(attribute.getType(), attribute.getValue())));\n+        }\n+\n+        return new RpslObject(rpslObject.getObjectId(), attributes);\n+    }\n+\n+    //need to filter as list (not set) as two AUTH MD5 after filter will return 1 entry in set", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e49e76220e1ae14c0cf14ca407ace62279dfcd80", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/e49e76220e1ae14c0cf14ca407ace62279dfcd80", "committedDate": "2020-05-28T09:52:33Z", "message": "Ed suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNzIxNzA2", "url": "https://github.com/RIPE-NCC/whois/pull/631#pullrequestreview-420721706", "createdAt": "2020-05-29T07:41:27Z", "commit": {"oid": "e49e76220e1ae14c0cf14ca407ace62279dfcd80"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a36039a6f4b10063559e6474c04edc058dcf9e0c", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/a36039a6f4b10063559e6474c04edc058dcf9e0c", "committedDate": "2020-05-29T08:13:13Z", "message": "Rdap query limit (#632)\n\n* rdap limit query result\r\n\r\n* add test cases and notice banner for rdap\r\n\r\n* correct typo mistake\r\n\r\n* fulltext search limit 100\r\n\r\n* add test\r\n\r\n* implement Ed suggestions\r\n\r\n* change comment text"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 753, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}