{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3ODkzNjE5", "number": 599, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNTo1M1rODgW-9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTo0MzoxMVrODgXGng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU3NTkxOnYy", "diffSide": "RIGHT", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNTo1NFrOFqhZNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMzozNzozM1rOFv1LWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTYzOA==", "bodyText": "I suggest using the built-in wrapper java.util.Collections.unmodifiableSet() instead of guava", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380131638", "createdAt": "2020-02-17T11:35:54Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -1,5 +1,6 @@\n package net.ripe.db.whois.query.planner;\n \n+import com.google.common.collect.ImmutableSet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0MzE1MQ==", "bodyText": "Collections.unmodifiableSet() still can be changed as its a view that's why i usually prefer immutable set", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r385043151", "createdAt": "2020-02-27T10:36:41Z", "author": {"login": "maggarwal13"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -1,5 +1,6 @@\n package net.ripe.db.whois.query.planner;\n \n+import com.google.common.collect.ImmutableSet;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTYzOA=="}, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5ODY0OQ==", "bodyText": "A view is fine, if you don't have any other references to the actual set (i.e. wrap creating the Set in a method, and return the view). We shouldn't have multiple ways to do the same thing in the code. But here it's not a big deal.", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r385698649", "createdAt": "2020-02-28T13:37:33Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -1,5 +1,6 @@\n package net.ripe.db.whois.query.planner;\n \n+import com.google.common.collect.ImmutableSet;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTYzOA=="}, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU3ODI0OnYy", "diffSide": "RIGHT", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNjozOFrOFqhakQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNjozOFrOFqhakQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTk4NQ==", "bodyText": "Return generic Set<> in method signature (the immutable property is a detail)", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380131985", "createdAt": "2020-02-17T11:36:38Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU4MTM0OnYy", "diffSide": "RIGHT", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNzo1NFrOFqhcgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNzo1NFrOFqhcgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMjQ4MQ==", "bodyText": "whois.source is mandatory (although it could be empty it's unlikely!), no need for a check.", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380132481", "createdAt": "2020-02-17T11:37:54Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {\n+        ImmutableSet.Builder<CIString> sourceBuilder  = new ImmutableSet.Builder<>();\n+\n+        if(StringUtils.isNotEmpty(mainSource)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU4MjgwOnYy", "diffSide": "RIGHT", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozODozMFrOFqhdfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozODozMFrOFqhdfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMjczMg==", "bodyText": "I'd just automatically add a GRS source as mainsource + \"GRS\", no need to check if one is configured", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380132732", "createdAt": "2020-02-17T11:38:30Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {\n+        ImmutableSet.Builder<CIString> sourceBuilder  = new ImmutableSet.Builder<>();\n+\n+        if(StringUtils.isNotEmpty(mainSource)) {\n+            sourceBuilder.add(CIString.ciString(mainSource));\n+        }\n+\n+        if(StringUtils.isNotEmpty(nonAuthSource)) {\n+            sourceBuilder.add(CIString.ciString(nonAuthSource));\n+        }\n+\n+        final String matchingGrs = mainSource+ \"-GRS\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU4NDkzOnYy", "diffSide": "RIGHT", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozOToxNVrOFqheug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozOToxNVrOFqheug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzA1MA==", "bodyText": "I'd call this property \"mainSources\" as it's not necessarily called \"ripe\"", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133050", "createdAt": "2020-02-17T11:39:15Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -34,9 +38,13 @@\n     private final Ipv6Tree ipv6Tree;\n     private final Maintainers maintainers;\n     private final AbuseValidationStatusDao abuseValidationStatusDao;\n+    private final ImmutableSet<CIString> ripeSources;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU4NjIxOnYy", "diffSide": "RIGHT", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozOTo0MVrOFqhfeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozOTo0MVrOFqhfeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzI0MQ==", "bodyText": "Also rename method to \"getMainSources...\"", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133241", "createdAt": "2020-02-17T11:39:41Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU4NzQwOnYy", "diffSide": "RIGHT", "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTo0MDoxMVrOFqhgOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTo0MDoxMVrOFqhgOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzQzMw==", "bodyText": "Good pattern (return early)!", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133433", "createdAt": "2020-02-17T11:40:11Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -106,6 +134,10 @@ private boolean isLir(@Nullable final RpslObject rpslObject) {\n     @CheckForNull\n     @Nullable\n     public RpslObject getAbuseContactRole(final RpslObject rpslObject) {\n+        if(!ripeSources.contains(rpslObject.getValueForAttribute(AttributeType.SOURCE))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU5NDcxOnYy", "diffSide": "RIGHT", "path": "whois-query/src/test/java/net/ripe/db/whois/query/integration/AbuseCTestIntegration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTo0Mjo1NFrOFqhknA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTo0Mjo1NFrOFqhknA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDU1Ng==", "bodyText": "Don't make reference to \"RIPE\" as the source, but something like 'NON-TEST' or 'INVALID'", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380134556", "createdAt": "2020-02-17T11:42:54Z", "author": {"login": "eshryane"}, "path": "whois-query/src/test/java/net/ripe/db/whois/query/integration/AbuseCTestIntegration.java", "diffHunk": "@@ -239,4 +240,66 @@ public void brief_query_shows_abusemailbox_twice() {\n         final String briefResponse = TelnetWhoisClient.queryLocalhost(QueryServer.port, \"-b 193.0.0.0\");\n         assertThat(briefResponse, not(containsString(\"notshown@abuse.net\")));\n     }\n+    @Test\n+    public void should_not_lookup_abuseC_if_rpsl_source_do_not_match() {\n+\n+        databaseHelper.updateObject(RpslObject.parse( \"inetnum:       173.0.0.0 - 173.255.255.255\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU5NTUwOnYy", "diffSide": "RIGHT", "path": "whois-query/src/test/java/net/ripe/db/whois/query/planner/AbuseCFinderTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTo0MzoxMVrOFqhlIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMzozODoyMFrOFv1Mvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDY4OA==", "bodyText": "Use Set", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380134688", "createdAt": "2020-02-17T11:43:11Z", "author": {"login": "eshryane"}, "path": "whois-query/src/test/java/net/ripe/db/whois/query/planner/AbuseCFinderTest.java", "diffHunk": "@@ -1,6 +1,7 @@\n package net.ripe.db.whois.query.planner;\n \n \n+import com.google.common.collect.ImmutableSet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5OTAwNg==", "bodyText": "As above, not a big deal.", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r385699006", "createdAt": "2020-02-28T13:38:20Z", "author": {"login": "eshryane"}, "path": "whois-query/src/test/java/net/ripe/db/whois/query/planner/AbuseCFinderTest.java", "diffHunk": "@@ -1,6 +1,7 @@\n package net.ripe.db.whois.query.planner;\n \n \n+import com.google.common.collect.ImmutableSet;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDY4OA=="}, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4690, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}