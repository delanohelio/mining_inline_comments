{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NTk0ODY4", "number": 631, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyMDo0MVrOD__Akw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo1NDozNFrOD__x0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDE5MjE5OnYy", "diffSide": "RIGHT", "path": "whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyMDo0MVrOGa-gnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyMDo0MVrOGa-gnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MDMxNg==", "bodyText": "Rename to rpslObjectDao for consistency", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430940316", "createdAt": "2020-05-27T08:20:41Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java", "diffHunk": "@@ -52,9 +56,12 @@\n \n     private final FullTextIndex fullTextIndex;\n \n+    private final RpslObjectDao objectDao;\n+\n     @Autowired\n-    public AutocompleteSearch(final FullTextIndex fullTextIndex) {\n+    public AutocompleteSearch(final FullTextIndex fullTextIndex, @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao objectDao) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDIwMTcxOnYy", "diffSide": "RIGHT", "path": "whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyMzoxOFrOGa-mkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyMzoxOFrOGa-mkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MTg0MQ==", "bodyText": "Handle EmptyResultDataAccessException here (MariaDB and Lucene may be out of sync)", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430941841", "createdAt": "2020-05-27T08:23:18Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/autocomplete/AutocompleteSearch.java", "diffHunk": "@@ -88,17 +95,22 @@ public AutocompleteSearch(final FullTextIndex fullTextIndex) {\n                 for (ScoreDoc scoreDoc : topDocs.scoreDocs) {\n                     final Document doc = indexSearcher.doc(scoreDoc.doc);\n                     final Map<String, Object> result = Maps.newLinkedHashMap();\n-                    result.put(\"key\", doc.get(FullTextIndex.LOOKUP_KEY_FIELD_NAME));\n-                    result.put(\"type\", doc.get(FullTextIndex.OBJECT_TYPE_FIELD_NAME));\n+\n+                    final RpslObject rpslObject =   objectDao.getByKey(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDIwOTE3OnYy", "diffSide": "RIGHT", "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyNToxNVrOGa-rYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyNToxNVrOGa-rYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MzA3NQ==", "bodyText": "Rename to rpslObjectDao for consistency", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430943075", "createdAt": "2020-05-27T08:25:15Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "diffHunk": "@@ -69,15 +75,18 @@\n     private final AccessControlListManager accessControlListManager;\n     private final Source source;\n     private final Version version;\n+    private final RpslObjectDao objectDao;\n \n     @Autowired\n     public FullTextSearch(final FullTextIndex fullTextIndex,\n+                          @Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao objectDao,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDI2NDgxOnYy", "diffSide": "RIGHT", "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0MDoxNlrOGa_Pcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNzozOTozM1rOGcSCbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjMwNw==", "bodyText": "I would flip this Map around (document with a matching RpslObject) or create a list of \"pairs\"", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430952307", "createdAt": "2020-05-27T08:40:16Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "diffHunk": "@@ -164,23 +173,24 @@ protected SearchResponse doSearch(final IndexReader indexReader, final TaxonomyR\n \n                     indexSearcher.search(query, MultiCollector.wrap(topFieldCollector, facetsCollector));\n \n-                    final List<Document> documents = Lists.newArrayList();\n+                    final Map<RpslObject, Document> rpslObjectToDocument = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxNTAyMg==", "bodyText": "I would rely on Rpslobject as key  rather then luecene document. As Rpslobject have our own implementation of  equals and hashcode", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r431715022", "createdAt": "2020-05-28T09:49:28Z", "author": {"login": "maggarwal13"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "diffHunk": "@@ -164,23 +173,24 @@ protected SearchResponse doSearch(final IndexReader indexReader, final TaxonomyR\n \n                     indexSearcher.search(query, MultiCollector.wrap(topFieldCollector, facetsCollector));\n \n-                    final List<Document> documents = Lists.newArrayList();\n+                    final Map<RpslObject, Document> rpslObjectToDocument = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjMwNw=="}, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMwODg0NA==", "bodyText": "Good point, thanks!", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r432308844", "createdAt": "2020-05-29T07:39:33Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextSearch.java", "diffHunk": "@@ -164,23 +173,24 @@ protected SearchResponse doSearch(final IndexReader indexReader, final TaxonomyR\n \n                     indexSearcher.search(query, MultiCollector.wrap(topFieldCollector, facetsCollector));\n \n-                    final List<Document> documents = Lists.newArrayList();\n+                    final Map<RpslObject, Document> rpslObjectToDocument = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjMwNw=="}, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDI3MDY0OnYy", "diffSide": "RIGHT", "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/IndexTemplate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0MTo1MFrOGa_TEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0MTo1MFrOGa_TEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MzIzNA==", "bodyText": "If this should never happen, then Throw IllegalStateException", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430953234", "createdAt": "2020-05-27T08:41:50Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/IndexTemplate.java", "diffHunk": "@@ -229,24 +229,17 @@ protected void account(final RpslObject rpslObject) {\n             }\n         }\n \n-        protected RpslObject convertToRpslObject(Document document) {\n-            final List<RpslAttribute> attributes = Lists.newArrayList();\n-            int objectId = 0;\n-\n+        protected int getObjectId(Document document) {\n             for (final IndexableField field : document.getFields()) {\n                 if (SEARCH_INDEX_FIELDS_NOT_MAPPED_TO_RPSL_OBJECT.contains(field.name())) {\n                     if (\"primary-key\".equals(field.name())) {\n-                        objectId = Integer.parseInt(field.stringValue());\n+                        return  Integer.parseInt(field.stringValue());\n                     }\n-                } else {\n-                    attributes.add(new RpslAttribute(AttributeType.getByName(field.name()), field.stringValue()));\n                 }\n             }\n \n-            attributes.add(new RpslAttribute(AttributeType.SOURCE, source.getName()));\n-            return new RpslObject(objectId, attributes);\n+           return 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDMxODI0OnYy", "diffSide": "RIGHT", "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextIndex.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo1NDozNFrOGa_xqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo1NDozNFrOGa_xqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk2MTA2NQ==", "bodyText": "Remove this commented block altogether?", "url": "https://github.com/RIPE-NCC/whois/pull/631#discussion_r430961065", "createdAt": "2020-05-27T08:54:34Z", "author": {"login": "eshryane"}, "path": "whois-api/src/main/java/net/ripe/db/whois/api/fulltextsearch/FullTextIndex.java", "diffHunk": "@@ -289,30 +293,54 @@ private void addEntry(final IndexWriter indexWriter, final TaxonomyWriter taxono\n         document.add(new SortedDocValuesField(LOOKUP_KEY_FIELD_NAME, new BytesRef(rpslObject.getKey().toString())));\n         document.add(new StringField(LOOKUP_KEY_FIELD_NAME, rpslObject.getKey().toString(), Field.Store.YES));\n \n-        for (final RpslAttribute attribute : rpslObject.getAttributes()) {\n-            if (FILTERED_ATTRIBUTES.contains(attribute.getType())) {\n-                document.add(new Field(attribute.getKey(), sanitise(filterAttribute(attribute.getValue().trim())), FILTERED_ATTRIBUTE_FIELD_TYPE));\n-\n-            } else if (!SKIPPED_ATTRIBUTES.contains(attribute.getType())) {\n-                document.add(new Field(attribute.getKey(), sanitise(attribute.getValue().trim()), ATTRIBUTE_FIELD_TYPE));\n-            }\n+        for (final RpslAttribute attribute : filterRpslObject(rpslObject).getAttributes()) {\n+            document.add(new Field(attribute.getKey(), attribute.getValue().trim(), FILTERED_ATTRIBUTES.contains(attribute.getType()) ? FILTERED_ATTRIBUTE_FIELD_TYPE : ATTRIBUTE_FIELD_TYPE));\n         }\n \n         document.add(new FacetField(OBJECT_TYPE_FIELD_NAME, rpslObject.getType().getName()));\n \n         indexWriter.addDocument(facetsConfig.build(taxonomyWriter, document));\n     }\n \n+    public RpslObject filterRpslObject(final RpslObject rpslObject) {\n+\n+        List<RpslAttribute> attributes = Lists.newArrayList();\n+\n+        for (final RpslAttribute attribute : rpslObject.getAttributes()) {\n+            if (SKIPPED_ATTRIBUTES.contains(attribute.getType())) {\n+                continue;\n+            }\n+\n+            attributes.add(new RpslAttribute(attribute.getKey(), filterRpslAttribute(attribute.getType(), attribute.getValue())));\n+        }\n+\n+        return new RpslObject(rpslObject.getObjectId(), attributes);\n+    }\n+\n+    //need to filter as list (not set) as two AUTH MD5 after filter will return 1 entry in set", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e0696dc89db1882c67e4853cde561703bb52ff"}, "originalPosition": 91}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4636, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}