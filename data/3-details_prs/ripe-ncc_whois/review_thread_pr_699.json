{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NjgwMTkx", "number": 699, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwNzozODozN1rOE8GLcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMzo0NjoxMVrOE9pGIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDUxMjUwOnYy", "diffSide": "RIGHT", "path": "whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwNzozODozN1rOH4By1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDo0NDoyOFrOH4H6Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw==", "bodyText": "typo: orgnasation -> organisation\nThis test is for testing the validation of country code updating only being allowed by RIPE NCC, not for the attribute being flagged as managed?", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528511703", "createdAt": "2020-11-23T07:38:37Z", "author": {"login": "sbusk"}, "path": "whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java", "diffHunk": "@@ -1563,6 +1563,79 @@ public void lookup_inetnum_managed_attributes_resource_holder_abuse_contact() {\n         assertThat(response.getWhoisObjects().get(0).getAttributes().get(5).getManaged(), is(true));    // source\n     }\n \n+    @Test\n+    public void validate_country_managed_attribute_only_for_organisation() {\n+        databaseHelper.addObject(\n+                \"mntner:       RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+        databaseHelper.addObject(\n+                \"organisation: ORG-TO1-TEST\\n\" +\n+                        \"org-name:     Test Organisation\\n\" +\n+                        \"org-type:     LIR\\n\" +\n+                        \"country:      NL\\n\" +\n+                        \"abuse-c:      TR1-TEST\\n\" +\n+                        \"source:       TEST\");\n+        databaseHelper.addObject(\n+                \"inetnum:       10.0.0.0 - 10.0.0.255\\n\" +\n+                        \"status:   ALLOCATED PA\\n\" +\n+                        \"org:      ORG-TO1-TEST\\n\" +\n+                        \"country:  NL\\n\" +\n+                        \"mnt-by:   OWNER-MNT\\n\" +\n+                        \"mnt-by:   RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+\n+\n+        final WhoisResources searchOrg = RestTest.target(getPort(), \"whois/test/organisation/ORG-TO1-TEST?managed-attributes\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchOrg.getWhoisObjects(), hasSize(1));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"ORG-TO1-TEST\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).isManaged(), is(true));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(true));\n+\n+\n+        final WhoisResources searchinetnum = RestTest.target(getPort(), \"whois/test/inetnum/10.0.0.0%20-%2010.0.0.255?managed-attributes&resource-holder&abuse-contact\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchinetnum.getWhoisObjects(), hasSize(1));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"10.0.0.0 - 10.0.0.255\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(nullValue()));\n+    }\n+\n+    @Test\n+    public void update_orgnasation_country_code_fails() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfde8dccc347f3f3a822a84e2fcfafa38a400361"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMjYyNg==", "bodyText": "I see the test case tests specifically that country code value can only be changed by RIPE NCC.\nCan you add a test also where you do authenticate as RIPE and change the attribute value?", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528512626", "createdAt": "2020-11-23T07:41:11Z", "author": {"login": "sbusk"}, "path": "whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java", "diffHunk": "@@ -1563,6 +1563,79 @@ public void lookup_inetnum_managed_attributes_resource_holder_abuse_contact() {\n         assertThat(response.getWhoisObjects().get(0).getAttributes().get(5).getManaged(), is(true));    // source\n     }\n \n+    @Test\n+    public void validate_country_managed_attribute_only_for_organisation() {\n+        databaseHelper.addObject(\n+                \"mntner:       RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+        databaseHelper.addObject(\n+                \"organisation: ORG-TO1-TEST\\n\" +\n+                        \"org-name:     Test Organisation\\n\" +\n+                        \"org-type:     LIR\\n\" +\n+                        \"country:      NL\\n\" +\n+                        \"abuse-c:      TR1-TEST\\n\" +\n+                        \"source:       TEST\");\n+        databaseHelper.addObject(\n+                \"inetnum:       10.0.0.0 - 10.0.0.255\\n\" +\n+                        \"status:   ALLOCATED PA\\n\" +\n+                        \"org:      ORG-TO1-TEST\\n\" +\n+                        \"country:  NL\\n\" +\n+                        \"mnt-by:   OWNER-MNT\\n\" +\n+                        \"mnt-by:   RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+\n+\n+        final WhoisResources searchOrg = RestTest.target(getPort(), \"whois/test/organisation/ORG-TO1-TEST?managed-attributes\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchOrg.getWhoisObjects(), hasSize(1));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"ORG-TO1-TEST\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).isManaged(), is(true));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(true));\n+\n+\n+        final WhoisResources searchinetnum = RestTest.target(getPort(), \"whois/test/inetnum/10.0.0.0%20-%2010.0.0.255?managed-attributes&resource-holder&abuse-contact\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchinetnum.getWhoisObjects(), hasSize(1));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"10.0.0.0 - 10.0.0.255\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(nullValue()));\n+    }\n+\n+    @Test\n+    public void update_orgnasation_country_code_fails() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw=="}, "originalCommit": {"oid": "cfde8dccc347f3f3a822a84e2fcfafa38a400361"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzNTUxOQ==", "bodyText": "There is separate test case to test that country code is shown as managed attribute  for organisation (validate_country_managed_attribute_only_for_organisation) and not as managed attribute for other object type.", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528535519", "createdAt": "2020-11-23T08:32:42Z", "author": {"login": "maggarwal13"}, "path": "whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java", "diffHunk": "@@ -1563,6 +1563,79 @@ public void lookup_inetnum_managed_attributes_resource_holder_abuse_contact() {\n         assertThat(response.getWhoisObjects().get(0).getAttributes().get(5).getManaged(), is(true));    // source\n     }\n \n+    @Test\n+    public void validate_country_managed_attribute_only_for_organisation() {\n+        databaseHelper.addObject(\n+                \"mntner:       RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+        databaseHelper.addObject(\n+                \"organisation: ORG-TO1-TEST\\n\" +\n+                        \"org-name:     Test Organisation\\n\" +\n+                        \"org-type:     LIR\\n\" +\n+                        \"country:      NL\\n\" +\n+                        \"abuse-c:      TR1-TEST\\n\" +\n+                        \"source:       TEST\");\n+        databaseHelper.addObject(\n+                \"inetnum:       10.0.0.0 - 10.0.0.255\\n\" +\n+                        \"status:   ALLOCATED PA\\n\" +\n+                        \"org:      ORG-TO1-TEST\\n\" +\n+                        \"country:  NL\\n\" +\n+                        \"mnt-by:   OWNER-MNT\\n\" +\n+                        \"mnt-by:   RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+\n+\n+        final WhoisResources searchOrg = RestTest.target(getPort(), \"whois/test/organisation/ORG-TO1-TEST?managed-attributes\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchOrg.getWhoisObjects(), hasSize(1));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"ORG-TO1-TEST\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).isManaged(), is(true));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(true));\n+\n+\n+        final WhoisResources searchinetnum = RestTest.target(getPort(), \"whois/test/inetnum/10.0.0.0%20-%2010.0.0.255?managed-attributes&resource-holder&abuse-contact\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchinetnum.getWhoisObjects(), hasSize(1));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"10.0.0.0 - 10.0.0.255\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(nullValue()));\n+    }\n+\n+    @Test\n+    public void update_orgnasation_country_code_fails() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw=="}, "originalCommit": {"oid": "cfde8dccc347f3f3a822a84e2fcfafa38a400361"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzNTY2NA==", "bodyText": "I will add a test case that country code can be updated using overrides", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528535664", "createdAt": "2020-11-23T08:33:04Z", "author": {"login": "maggarwal13"}, "path": "whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java", "diffHunk": "@@ -1563,6 +1563,79 @@ public void lookup_inetnum_managed_attributes_resource_holder_abuse_contact() {\n         assertThat(response.getWhoisObjects().get(0).getAttributes().get(5).getManaged(), is(true));    // source\n     }\n \n+    @Test\n+    public void validate_country_managed_attribute_only_for_organisation() {\n+        databaseHelper.addObject(\n+                \"mntner:       RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+        databaseHelper.addObject(\n+                \"organisation: ORG-TO1-TEST\\n\" +\n+                        \"org-name:     Test Organisation\\n\" +\n+                        \"org-type:     LIR\\n\" +\n+                        \"country:      NL\\n\" +\n+                        \"abuse-c:      TR1-TEST\\n\" +\n+                        \"source:       TEST\");\n+        databaseHelper.addObject(\n+                \"inetnum:       10.0.0.0 - 10.0.0.255\\n\" +\n+                        \"status:   ALLOCATED PA\\n\" +\n+                        \"org:      ORG-TO1-TEST\\n\" +\n+                        \"country:  NL\\n\" +\n+                        \"mnt-by:   OWNER-MNT\\n\" +\n+                        \"mnt-by:   RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+\n+\n+        final WhoisResources searchOrg = RestTest.target(getPort(), \"whois/test/organisation/ORG-TO1-TEST?managed-attributes\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchOrg.getWhoisObjects(), hasSize(1));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"ORG-TO1-TEST\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).isManaged(), is(true));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(true));\n+\n+\n+        final WhoisResources searchinetnum = RestTest.target(getPort(), \"whois/test/inetnum/10.0.0.0%20-%2010.0.0.255?managed-attributes&resource-holder&abuse-contact\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchinetnum.getWhoisObjects(), hasSize(1));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"10.0.0.0 - 10.0.0.255\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(nullValue()));\n+    }\n+\n+    @Test\n+    public void update_orgnasation_country_code_fails() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw=="}, "originalCommit": {"oid": "cfde8dccc347f3f3a822a84e2fcfafa38a400361"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxMTkxNQ==", "bodyText": "Done", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r528611915", "createdAt": "2020-11-23T10:44:28Z", "author": {"login": "maggarwal13"}, "path": "whois-api/src/test/java/net/ripe/db/whois/api/rest/WhoisRestServiceTestIntegration.java", "diffHunk": "@@ -1563,6 +1563,79 @@ public void lookup_inetnum_managed_attributes_resource_holder_abuse_contact() {\n         assertThat(response.getWhoisObjects().get(0).getAttributes().get(5).getManaged(), is(true));    // source\n     }\n \n+    @Test\n+    public void validate_country_managed_attribute_only_for_organisation() {\n+        databaseHelper.addObject(\n+                \"mntner:       RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+        databaseHelper.addObject(\n+                \"organisation: ORG-TO1-TEST\\n\" +\n+                        \"org-name:     Test Organisation\\n\" +\n+                        \"org-type:     LIR\\n\" +\n+                        \"country:      NL\\n\" +\n+                        \"abuse-c:      TR1-TEST\\n\" +\n+                        \"source:       TEST\");\n+        databaseHelper.addObject(\n+                \"inetnum:       10.0.0.0 - 10.0.0.255\\n\" +\n+                        \"status:   ALLOCATED PA\\n\" +\n+                        \"org:      ORG-TO1-TEST\\n\" +\n+                        \"country:  NL\\n\" +\n+                        \"mnt-by:   OWNER-MNT\\n\" +\n+                        \"mnt-by:   RIPE-NCC-HM-MNT\\n\" +\n+                        \"source:   TEST\");\n+\n+\n+        final WhoisResources searchOrg = RestTest.target(getPort(), \"whois/test/organisation/ORG-TO1-TEST?managed-attributes\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchOrg.getWhoisObjects(), hasSize(1));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"ORG-TO1-TEST\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).isManaged(), is(true));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchOrg.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(true));\n+\n+\n+        final WhoisResources searchinetnum = RestTest.target(getPort(), \"whois/test/inetnum/10.0.0.0%20-%2010.0.0.255?managed-attributes&resource-holder&abuse-contact\")\n+                .request(MediaType.APPLICATION_XML_TYPE)\n+                .get(WhoisResources.class);\n+\n+        assertThat(searchinetnum.getWhoisObjects(), hasSize(1));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getPrimaryKey().get(0).getValue(), is(\"10.0.0.0 - 10.0.0.255\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getName(), is(\"country\"));\n+        assertThat(searchinetnum.getWhoisObjects().get(0).getAttributes().get(3).getManaged(), is(nullValue()));\n+    }\n+\n+    @Test\n+    public void update_orgnasation_country_code_fails() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMTcwMw=="}, "originalCommit": {"oid": "cfde8dccc347f3f3a822a84e2fcfafa38a400361"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDcxOTA1OnYy", "diffSide": "RIGHT", "path": "whois-update/src/main/java/net/ripe/db/whois/update/handler/validator/organisation/LirRipeMaintainedAttributesValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMzo0NjoxMVrOH6cFgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMzo0NjoxMVrOH6cFgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzOTYxOA==", "bodyText": "This validation is already done in CountryRipeMaintainedValidator.java. If you add it here also, there may be duplicate error messages in the response.\nI don't mind if you want to move it here for consistency, but then please delete the other validator.", "url": "https://github.com/RIPE-NCC/whois/pull/699#discussion_r531039618", "createdAt": "2020-11-26T13:46:11Z", "author": {"login": "eshryane"}, "path": "whois-update/src/main/java/net/ripe/db/whois/update/handler/validator/organisation/LirRipeMaintainedAttributesValidator.java", "diffHunk": "@@ -30,7 +30,8 @@\n     private static final List<AttributeType> RIPE_NCC_MANAGED_ATTRIBUTES = ImmutableList.of(\n             AttributeType.MNT_BY,\n             AttributeType.ORG,\n-            AttributeType.ORG_TYPE);\n+            AttributeType.ORG_TYPE,\n+            AttributeType.COUNTRY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef2e0f604919331ea86c362e67f44f706ca7a310"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4687, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}