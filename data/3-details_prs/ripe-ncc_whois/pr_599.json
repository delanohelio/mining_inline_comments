{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3ODkzNjE5", "number": 599, "title": "abusec contact  only for ripe sources", "bodyText": "", "createdAt": "2020-01-28T08:53:39Z", "url": "https://github.com/RIPE-NCC/whois/pull/599", "merged": true, "mergeCommit": {"oid": "0531cf8e9f7825c76685411bc646a58f959262b7"}, "closed": true, "closedAt": "2020-02-28T08:05:10Z", "author": {"login": "maggarwal13"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-ej_lAH2gAyMzY3ODkzNjE5OjUzNGIzYmUwZDJlNTRhYTdhNzRmZDJlM2E0M2MxMmYxNjBkMjFlZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIbxXZAH2gAyMzY3ODkzNjE5OmJmYWJiODVmNDllMmI3MWZlZTFmODE0NWE4MDE0YTM3ZWJmYmQ5ODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/534b3be0d2e54aa7a74fd2e3a43c12f160d21efd", "committedDate": "2020-01-27T15:34:42Z", "message": "abusec contact  only for ripe sources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NjcxNTY0", "url": "https://github.com/RIPE-NCC/whois/pull/599#pullrequestreview-359671564", "createdAt": "2020-02-17T11:35:53Z", "commit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "state": "APPROVED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNTo1NFrOFqhZNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTo0MzoxMVrOFqhlIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTYzOA==", "bodyText": "I suggest using the built-in wrapper java.util.Collections.unmodifiableSet() instead of guava", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380131638", "createdAt": "2020-02-17T11:35:54Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -1,5 +1,6 @@\n package net.ripe.db.whois.query.planner;\n \n+import com.google.common.collect.ImmutableSet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTk4NQ==", "bodyText": "Return generic Set<> in method signature (the immutable property is a detail)", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380131985", "createdAt": "2020-02-17T11:36:38Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMjQ4MQ==", "bodyText": "whois.source is mandatory (although it could be empty it's unlikely!), no need for a check.", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380132481", "createdAt": "2020-02-17T11:37:54Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {\n+        ImmutableSet.Builder<CIString> sourceBuilder  = new ImmutableSet.Builder<>();\n+\n+        if(StringUtils.isNotEmpty(mainSource)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMjczMg==", "bodyText": "I'd just automatically add a GRS source as mainsource + \"GRS\", no need to check if one is configured", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380132732", "createdAt": "2020-02-17T11:38:30Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {\n+        ImmutableSet.Builder<CIString> sourceBuilder  = new ImmutableSet.Builder<>();\n+\n+        if(StringUtils.isNotEmpty(mainSource)) {\n+            sourceBuilder.add(CIString.ciString(mainSource));\n+        }\n+\n+        if(StringUtils.isNotEmpty(nonAuthSource)) {\n+            sourceBuilder.add(CIString.ciString(nonAuthSource));\n+        }\n+\n+        final String matchingGrs = mainSource+ \"-GRS\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzA1MA==", "bodyText": "I'd call this property \"mainSources\" as it's not necessarily called \"ripe\"", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133050", "createdAt": "2020-02-17T11:39:15Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -34,9 +38,13 @@\n     private final Ipv6Tree ipv6Tree;\n     private final Maintainers maintainers;\n     private final AbuseValidationStatusDao abuseValidationStatusDao;\n+    private final ImmutableSet<CIString> ripeSources;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzI0MQ==", "bodyText": "Also rename method to \"getMainSources...\"", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133241", "createdAt": "2020-02-17T11:39:41Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -46,6 +54,26 @@ public AbuseCFinder(@Qualifier(\"jdbcRpslObjectSlaveDao\") final RpslObjectDao obj\n         this.ipv6Tree = ipv6Tree;\n         this.maintainers = maintainers;\n         this.abuseValidationStatusDao = abuseValidationStatusDao;\n+        this.ripeSources = getRipeSources(mainSource, nonAuthSource, grsSource);\n+    }\n+\n+    private ImmutableSet<CIString> getRipeSources(final String mainSource, final String nonAuthSource, final String grsSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMzQzMw==", "bodyText": "Good pattern (return early)!", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380133433", "createdAt": "2020-02-17T11:40:11Z", "author": {"login": "eshryane"}, "path": "whois-query/src/main/java/net/ripe/db/whois/query/planner/AbuseCFinder.java", "diffHunk": "@@ -106,6 +134,10 @@ private boolean isLir(@Nullable final RpslObject rpslObject) {\n     @CheckForNull\n     @Nullable\n     public RpslObject getAbuseContactRole(final RpslObject rpslObject) {\n+        if(!ripeSources.contains(rpslObject.getValueForAttribute(AttributeType.SOURCE))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDU1Ng==", "bodyText": "Don't make reference to \"RIPE\" as the source, but something like 'NON-TEST' or 'INVALID'", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380134556", "createdAt": "2020-02-17T11:42:54Z", "author": {"login": "eshryane"}, "path": "whois-query/src/test/java/net/ripe/db/whois/query/integration/AbuseCTestIntegration.java", "diffHunk": "@@ -239,4 +240,66 @@ public void brief_query_shows_abusemailbox_twice() {\n         final String briefResponse = TelnetWhoisClient.queryLocalhost(QueryServer.port, \"-b 193.0.0.0\");\n         assertThat(briefResponse, not(containsString(\"notshown@abuse.net\")));\n     }\n+    @Test\n+    public void should_not_lookup_abuseC_if_rpsl_source_do_not_match() {\n+\n+        databaseHelper.updateObject(RpslObject.parse( \"inetnum:       173.0.0.0 - 173.255.255.255\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDY4OA==", "bodyText": "Use Set", "url": "https://github.com/RIPE-NCC/whois/pull/599#discussion_r380134688", "createdAt": "2020-02-17T11:43:11Z", "author": {"login": "eshryane"}, "path": "whois-query/src/test/java/net/ripe/db/whois/query/planner/AbuseCFinderTest.java", "diffHunk": "@@ -1,6 +1,7 @@\n package net.ripe.db.whois.query.planner;\n \n \n+import com.google.common.collect.ImmutableSet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "534b3be0d2e54aa7a74fd2e3a43c12f160d21efd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aab12a42da6333a1cb7d8e64ee85031b8345b397", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/aab12a42da6333a1cb7d8e64ee85031b8345b397", "committedDate": "2020-02-27T10:44:03Z", "message": "implement Ed suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c19d1b6a47be992a4fb3ed6d052bc5474ec3563", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/8c19d1b6a47be992a4fb3ed6d052bc5474ec3563", "committedDate": "2020-02-27T12:14:33Z", "message": "Merge branch 'master' into abuseC_only_ripe_source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfabb85f49e2b71fee1f8145a8014a37ebfbd985", "author": {"user": {"login": "maggarwal13", "name": null}}, "url": "https://github.com/RIPE-NCC/whois/commit/bfabb85f49e2b71fee1f8145a8014a37ebfbd985", "committedDate": "2020-02-27T13:58:50Z", "message": "fix junit test cases"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 810, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}