{"pr_number": 1518, "pr_title": "[SCB-1711] support kie", "pr_createdAt": "2020-01-10T02:04:31Z", "pr_url": "https://github.com/apache/servicecomb-java-chassis/pull/1518", "timeline": [{"oid": "082abc557f40cc9daf4de15561a3ff510a1ae2e3", "url": "https://github.com/apache/servicecomb-java-chassis/commit/082abc557f40cc9daf4de15561a3ff510a1ae2e3", "message": "[SCB-1711] add license", "committedDate": "2020-01-10T10:15:30Z", "type": "forcePushed"}, {"oid": "e1b8ad5e9e13d7d09a0f05f7b3be4a677f8d818f", "url": "https://github.com/apache/servicecomb-java-chassis/commit/e1b8ad5e9e13d7d09a0f05f7b3be4a677f8d818f", "message": "[SCB-1711] add license", "committedDate": "2020-01-10T10:28:54Z", "type": "forcePushed"}, {"oid": "85635e1c4dd83308c3f989c5497a27c4247ed591", "url": "https://github.com/apache/servicecomb-java-chassis/commit/85635e1c4dd83308c3f989c5497a27c4247ed591", "message": "[SCB-1711] rename package", "committedDate": "2020-02-06T04:26:27Z", "type": "forcePushed"}, {"oid": "20563c1aabe5997b6eb28c115a8c85ef4a690779", "url": "https://github.com/apache/servicecomb-java-chassis/commit/20563c1aabe5997b6eb28c115a8c85ef4a690779", "message": "[SCB-1711] rename package", "committedDate": "2020-02-06T07:43:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMjA1OQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1518#discussion_r376832059", "bodyText": "It's better to name constant with UPPER case, and add a value of string with LOWER case.", "author": "liubao68", "createdAt": "2020-02-10T00:31:51Z", "path": "dynamic-config/config-kie/src/main/java/org/apache/servicecomb/config/kie/model/ValueType.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.config.kie.model;\n+\n+/**\n+ * @Author GuoYl123\n+ * @Date 2020/1/8\n+ **/\n+public enum ValueType {\n+  yml,", "originalCommit": "20563c1aabe5997b6eb28c115a8c85ef4a690779", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NzY4MQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1518#discussion_r376887681", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-02-10T06:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMjA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMjExMA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1518#discussion_r376832110", "bodyText": "Delete useless code", "author": "liubao68", "createdAt": "2020-02-10T00:32:22Z", "path": "dynamic-config/config-kie/src/test/java/org/apache/servicecomb/config/kie/client/TestKieUtil.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.config.kie.client;\n+\n+import mockit.Expectations;\n+import mockit.Mocked;\n+import org.apache.servicecomb.config.kie.model.KVResponse;\n+import org.junit.Test;\n+\n+public class TestKieUtil {\n+\n+  @Test\n+  public void testGetConfigByLabel(final @Mocked KVResponse resp) {", "originalCommit": "20563c1aabe5997b6eb28c115a8c85ef4a690779", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NzQ2Nw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1518#discussion_r376887467", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-02-10T06:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMjExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMjM1MA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1518#discussion_r376832350", "bodyText": "This TODO does not tell what is going to be done.", "author": "liubao68", "createdAt": "2020-02-10T00:35:03Z", "path": "dynamic-config/config-kie/src/main/java/org/apache/servicecomb/config/kie/client/KieClient.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.config.kie.client;\n+\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.DeploymentOptions;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.VertxOptions;\n+import io.vertx.core.http.HttpClientOptions;\n+import io.vertx.core.http.HttpClientRequest;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.http.HttpStatus;\n+import org.apache.servicecomb.config.kie.archaius.sources.KieConfigurationSourceImpl.UpdateHandler;\n+import org.apache.servicecomb.config.kie.model.KVResponse;\n+import org.apache.servicecomb.foundation.common.event.EventManager;\n+import org.apache.servicecomb.foundation.common.net.IpPort;\n+import org.apache.servicecomb.foundation.common.net.NetUtils;\n+import org.apache.servicecomb.foundation.common.utils.JsonUtils;\n+import org.apache.servicecomb.foundation.vertx.AddressResolverConfig;\n+import org.apache.servicecomb.foundation.vertx.VertxUtils;\n+import org.apache.servicecomb.foundation.vertx.client.ClientPoolManager;\n+import org.apache.servicecomb.foundation.vertx.client.ClientVerticle;\n+import org.apache.servicecomb.foundation.vertx.client.http.HttpClientPoolFactory;\n+import org.apache.servicecomb.foundation.vertx.client.http.HttpClientWithContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * @Author GuoYl123\n+ * @Date 2020/1/9\n+ **/\n+public class KieClient {\n+\n+  private static final Logger LOGGER = LoggerFactory.getLogger(KieClient.class);\n+\n+  private ScheduledExecutorService EXECUTOR = Executors.newScheduledThreadPool(1);\n+\n+  private static final long TIME_OUT = 10000;\n+\n+  private static final KieConfig KIE_CONFIG = KieConfig.INSTANCE;\n+\n+  private final int refreshInterval = KIE_CONFIG.getRefreshInterval();\n+\n+  private final int firstRefreshInterval = KIE_CONFIG.getFirstRefreshInterval();\n+\n+  private final String serviceUri = KIE_CONFIG.getServerUri();\n+\n+  private ClientPoolManager<HttpClientWithContext> clientMgr;\n+\n+  public KieClient(UpdateHandler updateHandler) {\n+    KieWatcher.INSTANCE.setUpdateHandler(updateHandler);\n+  }\n+\n+  public void refreshKieConfig() {\n+    try {\n+      deployConfigClient();\n+    } catch (InterruptedException e) {\n+      throw new IllegalStateException(e);\n+    }\n+    EXECUTOR\n+        .scheduleWithFixedDelay(new ConfigRefresh(serviceUri), firstRefreshInterval,\n+            refreshInterval, TimeUnit.SECONDS);\n+  }\n+\n+  private void deployConfigClient() throws InterruptedException {\n+    VertxOptions vertxOptions = new VertxOptions();\n+    //todo :  how to deal with it", "originalCommit": "20563c1aabe5997b6eb28c115a8c85ef4a690779", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NzQ0MQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1518#discussion_r376887441", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-02-10T06:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMjM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzODY5MA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1518#discussion_r376838690", "bodyText": "Please remove the Author information, as we can look it up from SCM.", "author": "WillemJiang", "createdAt": "2020-02-10T01:35:50Z", "path": "dynamic-config/config-kie/src/main/java/org/apache/servicecomb/config/kie/archaius/sources/KieConfigurationSourceImpl.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.config.kie.archaius.sources;\n+\n+import static com.netflix.config.WatchedUpdateResult.createIncremental;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.netflix.config.ConcurrentCompositeConfiguration;\n+import com.netflix.config.WatchedUpdateListener;\n+import com.netflix.config.WatchedUpdateResult;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.servicecomb.config.ConfigMapping;\n+import org.apache.servicecomb.config.kie.client.KieClient;\n+import org.apache.servicecomb.config.kie.client.KieConfig;\n+import org.apache.servicecomb.config.spi.ConfigCenterConfigurationSource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * @Author GuoYl123", "originalCommit": "20563c1aabe5997b6eb28c115a8c85ef4a690779", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NzQyMg==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1518#discussion_r376887422", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-02-10T06:38:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzODY5MA=="}], "type": "inlineReview"}, {"oid": "c5800c9da41c60f378a8c8b3cbd7cb5a46180ea9", "url": "https://github.com/apache/servicecomb-java-chassis/commit/c5800c9da41c60f378a8c8b3cbd7cb5a46180ea9", "message": "Merge remote-tracking branch 'remotes/origin/master'", "committedDate": "2020-02-10T06:41:45Z", "type": "forcePushed"}, {"oid": "3efa6ebfef2c38924a833d7a61d6c6aebbdc3ceb", "url": "https://github.com/apache/servicecomb-java-chassis/commit/3efa6ebfef2c38924a833d7a61d6c6aebbdc3ceb", "message": "[SCB-1711] modify as comment", "committedDate": "2020-02-10T06:38:30Z", "type": "forcePushed"}, {"oid": "3efa6ebfef2c38924a833d7a61d6c6aebbdc3ceb", "url": "https://github.com/apache/servicecomb-java-chassis/commit/3efa6ebfef2c38924a833d7a61d6c6aebbdc3ceb", "message": "[SCB-1711] modify as comment", "committedDate": "2020-02-10T06:38:30Z", "type": "forcePushed"}, {"oid": "cb19774f1ee1ac900c3d0be6c21b841a1758da0a", "url": "https://github.com/apache/servicecomb-java-chassis/commit/cb19774f1ee1ac900c3d0be6c21b841a1758da0a", "message": "[SCB-1711] support kie\n\n(cherry picked from commit 833af5050ca3e26e75b327b499b0f9534f55d8b6)", "committedDate": "2020-02-10T10:57:59Z", "type": "forcePushed"}, {"oid": "cb19774f1ee1ac900c3d0be6c21b841a1758da0a", "url": "https://github.com/apache/servicecomb-java-chassis/commit/cb19774f1ee1ac900c3d0be6c21b841a1758da0a", "message": "[SCB-1711] support kie\n\n(cherry picked from commit 833af5050ca3e26e75b327b499b0f9534f55d8b6)", "committedDate": "2020-02-10T10:57:59Z", "type": "forcePushed"}, {"oid": "982d38298f7fa660f5e85c79e3d954b938625974", "url": "https://github.com/apache/servicecomb-java-chassis/commit/982d38298f7fa660f5e85c79e3d954b938625974", "message": "[SCB-1711] support kie\n\n(cherry picked from commit 833af5050ca3e26e75b327b499b0f9534f55d8b6)\n(cherry picked from commit cb19774f1ee1ac900c3d0be6c21b841a1758da0a)", "committedDate": "2020-02-12T01:36:36Z", "type": "commit"}, {"oid": "982d38298f7fa660f5e85c79e3d954b938625974", "url": "https://github.com/apache/servicecomb-java-chassis/commit/982d38298f7fa660f5e85c79e3d954b938625974", "message": "[SCB-1711] support kie\n\n(cherry picked from commit 833af5050ca3e26e75b327b499b0f9534f55d8b6)\n(cherry picked from commit cb19774f1ee1ac900c3d0be6c21b841a1758da0a)", "committedDate": "2020-02-12T01:36:36Z", "type": "forcePushed"}, {"oid": "2791e3caf4a7c5d088826e4abf6a6d926f04bebf", "url": "https://github.com/apache/servicecomb-java-chassis/commit/2791e3caf4a7c5d088826e4abf6a6d926f04bebf", "message": "[SCB-1711] optimization code", "committedDate": "2020-02-12T01:59:38Z", "type": "commit"}]}