{"pr_number": 2014, "pr_title": "SCB-2017 Fixed the issue of inconsistent false positives after re-ser\u2026", "pr_createdAt": "2020-10-26T11:23:47Z", "pr_url": "https://github.com/apache/servicecomb-java-chassis/pull/2014", "timeline": [{"oid": "4401075aeb542e8184b6902c466a404cb776ef28", "url": "https://github.com/apache/servicecomb-java-chassis/commit/4401075aeb542e8184b6902c466a404cb776ef28", "message": "SCB-2017 Fixed the issue of inconsistent false positives after re-serialization using swagger to parse different JDK versions.", "committedDate": "2020-10-26T11:22:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2MDc3MQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r511960771", "bodyText": "Difference", "author": "liubao68", "createdAt": "2020-10-26T13:32:03Z", "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/config/ServiceRegistryConfig.java", "diffHunk": "@@ -257,6 +257,14 @@ public boolean isAlwaysOverrideSchema() {\n     return property.get();\n   }\n \n+  public boolean isIgnoreSwaggerDifferent() {\n+    DynamicBooleanProperty property =\n+        DynamicPropertyFactory.getInstance()\n+            .getBooleanProperty(\"servicecomb.service.registry.instance.ignoreSwaggerDifferent\",", "originalCommit": "4401075aeb542e8184b6902c466a404cb776ef28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM1NjAwNg==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512356006", "bodyText": "Thanks for your suggestion.", "author": "develpoerX", "createdAt": "2020-10-27T01:04:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2MDc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2MTY2Ng==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r511961666", "bodyText": "use StringUtils.isEmpty from commons lang 3", "author": "liubao68", "createdAt": "2020-10-26T13:33:23Z", "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/task/MicroserviceRegisterTask.java", "diffHunk": "@@ -337,6 +354,12 @@ private boolean onlineSchemaIsModifiable() {\n         || ServiceRegistryConfig.INSTANCE.isAlwaysOverrideSchema();\n   }\n \n+  private boolean isIllegalValue(String context) {\n+    if (context == null || context == \"\" || context.isEmpty()) {", "originalCommit": "4401075aeb542e8184b6902c466a404cb776ef28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1MjAwOA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512452008", "bodyText": "done", "author": "develpoerX", "createdAt": "2020-10-27T06:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2MTY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2MjM4MQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r511962381", "bodyText": "delete this method because should be  is valid value", "author": "liubao68", "createdAt": "2020-10-26T13:34:23Z", "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/task/MicroserviceRegisterTask.java", "diffHunk": "@@ -337,6 +354,12 @@ private boolean onlineSchemaIsModifiable() {\n         || ServiceRegistryConfig.INSTANCE.isAlwaysOverrideSchema();\n   }\n \n+  private boolean isIllegalValue(String context) {", "originalCommit": "4401075aeb542e8184b6902c466a404cb776ef28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0Njg1Mw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512446853", "bodyText": "done", "author": "develpoerX", "createdAt": "2020-10-27T06:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2MjM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2NTkwMg==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r511965902", "bodyText": "return true", "author": "liubao68", "createdAt": "2020-10-26T13:39:19Z", "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/task/MicroserviceRegisterTask.java", "diffHunk": "@@ -261,6 +263,21 @@ private boolean compareAndReRegisterSchema(Entry<String, String> localSchemaEntr\n       String scSchemaContent = srClient.getSchema(microservice.getServiceId(), scSchema.getSchemaId());\n       String localSchemaContent = localSchemaEntry.getValue();\n \n+      if (isIllegalValue(scSchemaContent) && isIllegalValue(localSchemaContent)) {\n+        Swagger scSwagger = SwaggerUtils.parseSwagger(scSchemaContent);\n+        Swagger localSwagger = SwaggerUtils.parseSwagger(localSchemaContent);\n+        if (scSwagger.equals(localSwagger)) {\n+          if (ServiceRegistryConfig.INSTANCE.isIgnoreSwaggerDifferent()) {\n+            LOGGER.warn(\n+                \"the local schema[{}]'s content is same with the service center schema's content, but the order of some \"\n+                    + \" parameters in the configuration file is inconsistent:\\n service center schema:\\n[{}]\\n local schema:\\n[{}]\",\n+                localSchemaEntry.getKey(),\n+                scSchemaContent,\n+                localSchemaContent);\n+          }\n+          return false;", "originalCommit": "4401075aeb542e8184b6902c466a404cb776ef28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1MjA2MQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512452061", "bodyText": "done", "author": "develpoerX", "createdAt": "2020-10-27T06:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2NTkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2Nzc4Mw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r511967783", "bodyText": "This block should executed when not equals.", "author": "liubao68", "createdAt": "2020-10-26T13:42:00Z", "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/task/MicroserviceRegisterTask.java", "diffHunk": "@@ -261,6 +263,21 @@ private boolean compareAndReRegisterSchema(Entry<String, String> localSchemaEntr\n       String scSchemaContent = srClient.getSchema(microservice.getServiceId(), scSchema.getSchemaId());\n       String localSchemaContent = localSchemaEntry.getValue();\n \n+      if (isIllegalValue(scSchemaContent) && isIllegalValue(localSchemaContent)) {\n+        Swagger scSwagger = SwaggerUtils.parseSwagger(scSchemaContent);\n+        Swagger localSwagger = SwaggerUtils.parseSwagger(localSchemaContent);\n+        if (scSwagger.equals(localSwagger)) {\n+          if (ServiceRegistryConfig.INSTANCE.isIgnoreSwaggerDifferent()) {\n+            LOGGER.warn(\n+                \"the local schema[{}]'s content is same with the service center schema's content, but the order of some \"\n+                    + \" parameters in the configuration file is inconsistent:\\n service center schema:\\n[{}]\\n local schema:\\n[{}]\",\n+                localSchemaEntry.getKey(),\n+                scSchemaContent,\n+                localSchemaContent);\n+          }", "originalCommit": "4401075aeb542e8184b6902c466a404cb776ef28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1MjA4OQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512452089", "bodyText": "done", "author": "develpoerX", "createdAt": "2020-10-27T06:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2Nzc4Mw=="}], "type": "inlineReview"}, {"oid": "54438025b8e8eda579e674e5f04d5c9e8cd02767", "url": "https://github.com/apache/servicecomb-java-chassis/commit/54438025b8e8eda579e674e5f04d5c9e8cd02767", "message": "SCB-2017 Fixed the issue of inconsistent false positives after re-ser\u2026", "committedDate": "2020-10-27T03:50:04Z", "type": "commit"}, {"oid": "cf9f855d83dbb1a23a13eb6c3222b83d9c44d24a", "url": "https://github.com/apache/servicecomb-java-chassis/commit/cf9f855d83dbb1a23a13eb6c3222b83d9c44d24a", "message": "SCB-2017 Fixed the issue of inconsistent false positives after re-ser", "committedDate": "2020-10-27T06:17:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MjM0NA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512442344", "bodyText": "service center schema and local schema both are different:\\n service center schema:\\n[{}]\\n local schema:\\n[{}]\"\n+ \"\\nYou have configured to ignore difference check. It's recommented  to increment microservice version before deploying when shcema change.", "author": "liubao68", "createdAt": "2020-10-27T06:26:37Z", "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/task/MicroserviceRegisterTask.java", "diffHunk": "@@ -261,6 +263,24 @@ private boolean compareAndReRegisterSchema(Entry<String, String> localSchemaEntr\n       String scSchemaContent = srClient.getSchema(microservice.getServiceId(), scSchema.getSchemaId());\n       String localSchemaContent = localSchemaEntry.getValue();\n \n+      if (!StringUtils.isEmpty(scSchemaContent) && !StringUtils.isEmpty(localSchemaContent)) {\n+        Swagger scSwagger = SwaggerUtils.parseSwagger(scSchemaContent);\n+        Swagger localSwagger = SwaggerUtils.parseSwagger(localSchemaContent);\n+        if (scSwagger.equals(localSwagger)) {\n+          return true;\n+        }\n+        if (ServiceRegistryConfig.INSTANCE.isIgnoreSwaggerDifference()) {\n+          LOGGER.warn(\n+              \"service center schema and local schema both are different:\\n service center schema:\\n[{}]\\n local schema:\\n[{}]\"\n+                  + \"\\nYou need to increment microservice version before deploying. \"", "originalCommit": "cf9f855d83dbb1a23a13eb6c3222b83d9c44d24a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0NDkzMg==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512444932", "bodyText": "ok", "author": "develpoerX", "createdAt": "2020-10-27T06:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MjM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MzAzMQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512443031", "bodyText": "put if (ServiceRegistryConfig.INSTANCE.isIgnoreSwaggerDifference()) { outside of\nif (!StringUtils.isEmpty(scSchemaContent) && !StringUtils.isEmpty(localSchemaContent)) {\nblock.", "author": "liubao68", "createdAt": "2020-10-27T06:28:46Z", "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/task/MicroserviceRegisterTask.java", "diffHunk": "@@ -261,6 +263,24 @@ private boolean compareAndReRegisterSchema(Entry<String, String> localSchemaEntr\n       String scSchemaContent = srClient.getSchema(microservice.getServiceId(), scSchema.getSchemaId());\n       String localSchemaContent = localSchemaEntry.getValue();\n \n+      if (!StringUtils.isEmpty(scSchemaContent) && !StringUtils.isEmpty(localSchemaContent)) {\n+        Swagger scSwagger = SwaggerUtils.parseSwagger(scSchemaContent);\n+        Swagger localSwagger = SwaggerUtils.parseSwagger(localSchemaContent);\n+        if (scSwagger.equals(localSwagger)) {\n+          return true;\n+        }\n+        if (ServiceRegistryConfig.INSTANCE.isIgnoreSwaggerDifference()) {", "originalCommit": "cf9f855d83dbb1a23a13eb6c3222b83d9c44d24a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1MzUyNQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/2014#discussion_r512453525", "bodyText": "done. I have put it behind EQUALS block.", "author": "develpoerX", "createdAt": "2020-10-27T06:58:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MzAzMQ=="}], "type": "inlineReview"}, {"oid": "7d9ea6e37252040f96d9e957a63c2085327f18ea", "url": "https://github.com/apache/servicecomb-java-chassis/commit/7d9ea6e37252040f96d9e957a63c2085327f18ea", "message": "SCB-2017 Fixed the issue of inconsistent false positives after re-ser\u2026", "committedDate": "2020-10-27T06:53:22Z", "type": "commit"}, {"oid": "3f69f3ba0867dfd60ef72b956ae514d58bf2d594", "url": "https://github.com/apache/servicecomb-java-chassis/commit/3f69f3ba0867dfd60ef72b956ae514d58bf2d594", "message": "SCB-2017 Fixed the issue of inconsistent false positives after re-ser\u2026", "committedDate": "2020-10-27T08:51:24Z", "type": "commit"}]}