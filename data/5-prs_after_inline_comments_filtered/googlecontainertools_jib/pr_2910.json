{"pr_number": 2910, "pr_title": "Migrate away from Docker Hub in integration tests", "pr_createdAt": "2020-12-02T23:32:18Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2910", "timeline": [{"oid": "211836f64c0473fe4e4495f79243455f0fcbc88a", "url": "https://github.com/GoogleContainerTools/jib/commit/211836f64c0473fe4e4495f79243455f0fcbc88a", "message": "Migrate and clean up integration tests", "committedDate": "2020-12-02T23:17:32Z", "type": "commit"}, {"oid": "ca55c19206e9d48146efe5218cb03689bf02c2b1", "url": "https://github.com/GoogleContainerTools/jib/commit/ca55c19206e9d48146efe5218cb03689bf02c2b1", "message": "cleanups", "committedDate": "2020-12-02T23:29:02Z", "type": "commit"}, {"oid": "4032d494ee3a9e55f8badd08159d49334bb740ad", "url": "https://github.com/GoogleContainerTools/jib/commit/4032d494ee3a9e55f8badd08159d49334bb740ad", "message": "cleanups", "committedDate": "2020-12-02T23:32:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5NjE3NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535296174", "bodyText": "We can remove this?", "author": "mpeddada1", "createdAt": "2020-12-03T14:49:58Z", "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/registry/ManifestPusherIntegrationTest.java", "diffHunk": "@@ -30,19 +30,13 @@\n import java.io.IOException;\n import java.security.DigestException;\n import org.junit.Assert;\n-import org.junit.BeforeClass;\n import org.junit.ClassRule;\n import org.junit.Test;\n \n /** Integration tests for {@link ManifestPusher}. */\n public class ManifestPusherIntegrationTest {\n \n-  @ClassRule public static LocalRegistry localRegistry = new LocalRegistry(5000);\n-\n-  @BeforeClass\n-  public static void setUp() throws IOException, InterruptedException {\n-    localRegistry.pullAndPushToLocal(\"busybox\", \"busybox\");\n-  }\n+  @ClassRule public static final LocalRegistry localRegistry = new LocalRegistry(5000);", "originalCommit": "4032d494ee3a9e55f8badd08159d49334bb740ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM0NTM0Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535345346", "bodyText": "Tests in this class push a blob to this registry. We could use our GCP integration test project, but I think in this case we should use an isolated registry that starts from a clean state.", "author": "chanseokoh", "createdAt": "2020-12-03T15:41:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5NjE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMwNjU5OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535306598", "bodyText": "Can we keep the previous name? Or manifestListSha256", "author": "mpeddada1", "createdAt": "2020-12-03T14:59:41Z", "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/registry/ManifestPullerIntegrationTest.java", "diffHunk": "@@ -74,38 +75,32 @@ public void testPull_v22() throws IOException, RegistryException {\n   @Test\n   public void testPull_v22ManifestList() throws IOException, RegistryException {\n     RegistryClient registryClient =\n-        RegistryClient.factory(\n-                EventHandlers.NONE, \"registry-1.docker.io\", \"library/openjdk\", httpClient)\n+        RegistryClient.factory(EventHandlers.NONE, \"gcr.io\", \"distroless/base\", httpClient)\n             .newRegistryClient();\n-    registryClient.doPullBearerAuth();\n-\n-    // Ensure 11-jre-slim is a manifest list\n-    V22ManifestListTemplate manifestListTemplate =\n-        registryClient.pullManifest(\"11-jre-slim\", V22ManifestListTemplate.class).getManifest();\n-    Assert.assertEquals(2, manifestListTemplate.getSchemaVersion());\n-    Assert.assertTrue(manifestListTemplate.getManifests().size() > 0);\n \n-    // Generic call to 11-jre-slim pulls a manifest list\n-    ManifestTemplate manifestTemplate = registryClient.pullManifest(\"11-jre-slim\").getManifest();\n-    Assert.assertEquals(2, manifestTemplate.getSchemaVersion());\n-    MatcherAssert.assertThat(\n-        manifestTemplate, CoreMatchers.instanceOf(V22ManifestListTemplate.class));\n+    // Ensure \":latest\" is a manifest list\n+    V22ManifestListTemplate manifestList1 =\n+        registryClient.pullManifest(\"latest\", V22ManifestListTemplate.class).getManifest();\n+    Assert.assertEquals(2, manifestList1.getSchemaVersion());\n+    Assert.assertTrue(manifestList1.getManifests().size() > 0);\n \n-    // Make sure we can't cast a v22ManifestTemplate to v22ManifestListTemplate in ManifestPuller\n-    try {\n-      registryClient.pullManifest(KNOWN_MANIFEST_LIST_SHA, V22ManifestTemplate.class);\n-      Assert.fail();\n-    } catch (ClassCastException ex) {\n-      // pass\n-    }\n+    // Generic call to \":latest\" pulls a manifest list\n+    ManifestTemplate manifestList2 = registryClient.pullManifest(\"latest\").getManifest();\n+    Assert.assertEquals(2, manifestList2.getSchemaVersion());\n+    MatcherAssert.assertThat(manifestList2, CoreMatchers.instanceOf(V22ManifestListTemplate.class));\n+    Assert.assertTrue(((V22ManifestListTemplate) manifestList2).getManifests().size() > 0);\n \n     // Referencing a manifest list by sha256, should return a manifest list\n-    ManifestTemplate sha256ManifestList =\n+    ManifestTemplate manifestList3 =", "originalCommit": "4032d494ee3a9e55f8badd08159d49334bb740ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNDMwNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535314304", "bodyText": "Perhaps a more descriptive name- for example, manifestListLatest.", "author": "mpeddada1", "createdAt": "2020-12-03T15:08:38Z", "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/registry/ManifestPullerIntegrationTest.java", "diffHunk": "@@ -74,38 +75,32 @@ public void testPull_v22() throws IOException, RegistryException {\n   @Test\n   public void testPull_v22ManifestList() throws IOException, RegistryException {\n     RegistryClient registryClient =\n-        RegistryClient.factory(\n-                EventHandlers.NONE, \"registry-1.docker.io\", \"library/openjdk\", httpClient)\n+        RegistryClient.factory(EventHandlers.NONE, \"gcr.io\", \"distroless/base\", httpClient)\n             .newRegistryClient();\n-    registryClient.doPullBearerAuth();\n-\n-    // Ensure 11-jre-slim is a manifest list\n-    V22ManifestListTemplate manifestListTemplate =\n-        registryClient.pullManifest(\"11-jre-slim\", V22ManifestListTemplate.class).getManifest();\n-    Assert.assertEquals(2, manifestListTemplate.getSchemaVersion());\n-    Assert.assertTrue(manifestListTemplate.getManifests().size() > 0);\n \n-    // Generic call to 11-jre-slim pulls a manifest list\n-    ManifestTemplate manifestTemplate = registryClient.pullManifest(\"11-jre-slim\").getManifest();\n-    Assert.assertEquals(2, manifestTemplate.getSchemaVersion());\n-    MatcherAssert.assertThat(\n-        manifestTemplate, CoreMatchers.instanceOf(V22ManifestListTemplate.class));\n+    // Ensure \":latest\" is a manifest list\n+    V22ManifestListTemplate manifestList1 =\n+        registryClient.pullManifest(\"latest\", V22ManifestListTemplate.class).getManifest();\n+    Assert.assertEquals(2, manifestList1.getSchemaVersion());\n+    Assert.assertTrue(manifestList1.getManifests().size() > 0);\n \n-    // Make sure we can't cast a v22ManifestTemplate to v22ManifestListTemplate in ManifestPuller\n-    try {\n-      registryClient.pullManifest(KNOWN_MANIFEST_LIST_SHA, V22ManifestTemplate.class);\n-      Assert.fail();\n-    } catch (ClassCastException ex) {\n-      // pass\n-    }\n+    // Generic call to \":latest\" pulls a manifest list\n+    ManifestTemplate manifestList2 = registryClient.pullManifest(\"latest\").getManifest();", "originalCommit": "4032d494ee3a9e55f8badd08159d49334bb740ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTYzOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535315639", "bodyText": "Is this still needed?", "author": "mpeddada1", "createdAt": "2020-12-03T15:10:11Z", "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/registry/BlobPusherIntegrationTest.java", "diffHunk": "@@ -31,14 +31,12 @@\n /** Integration tests for {@link BlobPusher}. */\n public class BlobPusherIntegrationTest {\n \n-  @ClassRule public static LocalRegistry localRegistry = new LocalRegistry(5000);\n+  @ClassRule public static final LocalRegistry localRegistry = new LocalRegistry(5000);", "originalCommit": "4032d494ee3a9e55f8badd08159d49334bb740ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM0NjAwNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535346005", "bodyText": "The test in this class pushes a blob to this registry (line 47). We could use our GCP integration test project, but I think in this case we should use an isolated registry that starts from a clean state.", "author": "chanseokoh", "createdAt": "2020-12-03T15:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM1NjMzOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535356338", "bodyText": "oops I see.", "author": "mpeddada1", "createdAt": "2020-12-03T15:51:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTYzOQ=="}], "type": "inlineReview"}, {"oid": "09c696a846a6a233603e58404aab696fc63355a9", "url": "https://github.com/GoogleContainerTools/jib/commit/09c696a846a6a233603e58404aab696fc63355a9", "message": "Rename variables in test", "committedDate": "2020-12-03T15:46:36Z", "type": "commit"}]}