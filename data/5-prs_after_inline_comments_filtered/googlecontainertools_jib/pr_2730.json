{"pr_number": 2730, "pr_title": "Implement new manifest cache fully capable of multi-platform image building", "pr_createdAt": "2020-08-26T21:08:40Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2730", "timeline": [{"oid": "4f9c1bc536bee93a0f0d3038ca5b981b6d3892c2", "url": "https://github.com/GoogleContainerTools/jib/commit/4f9c1bc536bee93a0f0d3038ca5b981b6d3892c2", "message": "Implement new manifests_configs.json cache", "committedDate": "2020-08-13T19:13:55Z", "type": "commit"}, {"oid": "f480cf1829789d97493b0e05326c409ac0486440", "url": "https://github.com/GoogleContainerTools/jib/commit/f480cf1829789d97493b0e05326c409ac0486440", "message": "Merge branch 'master' into manifest-cache", "committedDate": "2020-08-13T19:18:29Z", "type": "commit"}, {"oid": "abeb080a2f9d0606a7ada30ae15d9a7e8b35d0de", "url": "https://github.com/GoogleContainerTools/jib/commit/abeb080a2f9d0606a7ada30ae15d9a7e8b35d0de", "message": "wip", "committedDate": "2020-08-13T19:30:39Z", "type": "commit"}, {"oid": "e643c543e1604983c46b480e399ef2652abff6f1", "url": "https://github.com/GoogleContainerTools/jib/commit/e643c543e1604983c46b480e399ef2652abff6f1", "message": "Implement new manfiest+container config cache", "committedDate": "2020-08-16T15:45:54Z", "type": "commit"}, {"oid": "1682e3b3bbba37351105ea41755f7e56a4d583f5", "url": "https://github.com/GoogleContainerTools/jib/commit/1682e3b3bbba37351105ea41755f7e56a4d583f5", "message": "Revert unnecessary code", "committedDate": "2020-08-17T13:07:45Z", "type": "commit"}, {"oid": "999125ef6906c4334612496b77f54e16f1f755bc", "url": "https://github.com/GoogleContainerTools/jib/commit/999125ef6906c4334612496b77f54e16f1f755bc", "message": "Revert filter(...) to original code to avoid false NullAway positives", "committedDate": "2020-08-17T16:20:01Z", "type": "commit"}, {"oid": "2166d2bf3b631b71dc2653a0aa93314eea3af668", "url": "https://github.com/GoogleContainerTools/jib/commit/2166d2bf3b631b71dc2653a0aa93314eea3af668", "message": "Convert to polymorphic JSON de-/serialization", "committedDate": "2020-08-18T14:18:55Z", "type": "commit"}, {"oid": "595bd1962921f5b59ea5ecf1049b12a6e5610860", "url": "https://github.com/GoogleContainerTools/jib/commit/595bd1962921f5b59ea5ecf1049b12a6e5610860", "message": "Add manifest+config cache JSON template", "committedDate": "2020-08-18T14:29:48Z", "type": "commit"}, {"oid": "5e2c6bcf688b5df766f6535fd950a7655196a404", "url": "https://github.com/GoogleContainerTools/jib/commit/5e2c6bcf688b5df766f6535fd950a7655196a404", "message": "Fix tests", "committedDate": "2020-08-18T14:44:31Z", "type": "commit"}, {"oid": "a53417dd8f1fc9808d3b0edae23f2b09001582e0", "url": "https://github.com/GoogleContainerTools/jib/commit/a53417dd8f1fc9808d3b0edae23f2b09001582e0", "message": "Update code comment", "committedDate": "2020-08-18T17:36:54Z", "type": "commit"}, {"oid": "126d30d0204d6544c7a58071884f77060cf139f0", "url": "https://github.com/GoogleContainerTools/jib/commit/126d30d0204d6544c7a58071884f77060cf139f0", "message": "Merge branch 'prepare-manifest-cache' into manifest-cache", "committedDate": "2020-08-18T21:55:05Z", "type": "commit"}, {"oid": "be8d91fadc60cb601c3d39d4b699de9d964ef0dd", "url": "https://github.com/GoogleContainerTools/jib/commit/be8d91fadc60cb601c3d39d4b699de9d964ef0dd", "message": "Fix tests", "committedDate": "2020-08-18T22:11:42Z", "type": "commit"}, {"oid": "c6bada415e26d5dd179e7ce663c8575d909bdc5c", "url": "https://github.com/GoogleContainerTools/jib/commit/c6bada415e26d5dd179e7ce663c8575d909bdc5c", "message": "Fix wrong cache validation", "committedDate": "2020-08-19T14:23:53Z", "type": "commit"}, {"oid": "38e00c976b11780285428f5f8393998da6ff52df", "url": "https://github.com/GoogleContainerTools/jib/commit/38e00c976b11780285428f5f8393998da6ff52df", "message": "Simplify test code", "committedDate": "2020-08-19T14:42:12Z", "type": "commit"}, {"oid": "ca69545e40e2adb2cde5fa9cb701ae3b1eca7c51", "url": "https://github.com/GoogleContainerTools/jib/commit/ca69545e40e2adb2cde5fa9cb701ae3b1eca7c51", "message": "Add CacheStorageReader tests", "committedDate": "2020-08-19T15:22:08Z", "type": "commit"}, {"oid": "badb776f62e45c82885e05055657b73bcb95c2bc", "url": "https://github.com/GoogleContainerTools/jib/commit/badb776f62e45c82885e05055657b73bcb95c2bc", "message": "Add tests", "committedDate": "2020-08-19T15:40:55Z", "type": "commit"}, {"oid": "c8ad480f29198f1b5d87a391c84f60192ed4bf26", "url": "https://github.com/GoogleContainerTools/jib/commit/c8ad480f29198f1b5d87a391c84f60192ed4bf26", "message": "Revert unintended debug code", "committedDate": "2020-08-19T15:42:16Z", "type": "commit"}, {"oid": "e20a8367cc8da6e76bad540c994a77dd91e5dfe4", "url": "https://github.com/GoogleContainerTools/jib/commit/e20a8367cc8da6e76bad540c994a77dd91e5dfe4", "message": "Fix bug in writing metadata cache", "committedDate": "2020-08-19T16:21:05Z", "type": "commit"}, {"oid": "4bfe4ef3c58d55393d688b6d2004b4aa77db1560", "url": "https://github.com/GoogleContainerTools/jib/commit/4bfe4ef3c58d55393d688b6d2004b4aa77db1560", "message": "Add tests", "committedDate": "2020-08-19T16:25:28Z", "type": "commit"}, {"oid": "5cadf8c6bd0a25cc45bb929385faf13de8a67f36", "url": "https://github.com/GoogleContainerTools/jib/commit/5cadf8c6bd0a25cc45bb929385faf13de8a67f36", "message": "Add tests", "committedDate": "2020-08-19T17:43:23Z", "type": "commit"}, {"oid": "bcd17f4be005730a6e5b1ba2d737595dee53b867", "url": "https://github.com/GoogleContainerTools/jib/commit/bcd17f4be005730a6e5b1ba2d737595dee53b867", "message": "Update comments", "committedDate": "2020-08-19T18:21:17Z", "type": "commit"}, {"oid": "dfab7ce329f1dc31e152e30c7296b706828fb487", "url": "https://github.com/GoogleContainerTools/jib/commit/dfab7ce329f1dc31e152e30c7296b706828fb487", "message": "Update Javadocs", "committedDate": "2020-08-19T18:39:03Z", "type": "commit"}, {"oid": "c52ebb8523d7cc071c718e2583085ae911ea1df0", "url": "https://github.com/GoogleContainerTools/jib/commit/c52ebb8523d7cc071c718e2583085ae911ea1df0", "message": "Rename variables", "committedDate": "2020-08-19T18:42:49Z", "type": "commit"}, {"oid": "f0a920374f3dac6c50302d1bc8ed477269df2ee2", "url": "https://github.com/GoogleContainerTools/jib/commit/f0a920374f3dac6c50302d1bc8ed477269df2ee2", "message": "Merge branch 'master' of https://github.com/GoogleContainerTools/jib into manifest-cache", "committedDate": "2020-08-20T14:49:08Z", "type": "commit"}, {"oid": "bb0c901c4930a84230800ec17fe5735e6d1c34e8", "url": "https://github.com/GoogleContainerTools/jib/commit/bb0c901c4930a84230800ec17fe5735e6d1c34e8", "message": "Refactor code", "committedDate": "2020-08-21T19:39:12Z", "type": "commit"}, {"oid": "1c5c7a36d4a3df504e466d2e9701fe5c0d238193", "url": "https://github.com/GoogleContainerTools/jib/commit/1c5c7a36d4a3df504e466d2e9701fe5c0d238193", "message": "Refactor code", "committedDate": "2020-08-21T19:59:39Z", "type": "commit"}, {"oid": "0908e25e6c0a384acf5d6d0917b576751b96f372", "url": "https://github.com/GoogleContainerTools/jib/commit/0908e25e6c0a384acf5d6d0917b576751b96f372", "message": "Merge branch 'manifest-cache' of https://github.com/GoogleContainerTools/jib into manifest-cache", "committedDate": "2020-08-21T20:01:52Z", "type": "commit"}, {"oid": "b3a0c893335555a0aeb63c704e24bad4ae192476", "url": "https://github.com/GoogleContainerTools/jib/commit/b3a0c893335555a0aeb63c704e24bad4ae192476", "message": "Decrease log level (lifecycle -> info)", "committedDate": "2020-08-24T14:11:03Z", "type": "commit"}, {"oid": "8a57ce21b8b6a27899220d268c5caab0bddd01a5", "url": "https://github.com/GoogleContainerTools/jib/commit/8a57ce21b8b6a27899220d268c5caab0bddd01a5", "message": "New cache API / refactor code", "committedDate": "2020-08-24T16:12:27Z", "type": "commit"}, {"oid": "783c5bfa005522073574e9b1689dce944b086e9e", "url": "https://github.com/GoogleContainerTools/jib/commit/783c5bfa005522073574e9b1689dce944b086e9e", "message": "Add unlisted manfiest excception", "committedDate": "2020-08-24T19:15:51Z", "type": "commit"}, {"oid": "064bb85e5f8a117bfe35c5529c7a7a32a6e81a0e", "url": "https://github.com/GoogleContainerTools/jib/commit/064bb85e5f8a117bfe35c5529c7a7a32a6e81a0e", "message": "Refactor code", "committedDate": "2020-08-24T19:35:13Z", "type": "commit"}, {"oid": "a1e6b9d3aaf7dff0d48d0013763789ad56c1c824", "url": "https://github.com/GoogleContainerTools/jib/commit/a1e6b9d3aaf7dff0d48d0013763789ad56c1c824", "message": "Merge branch 'master' into manifest-cache-multi-platform-part1", "committedDate": "2020-08-25T01:04:33Z", "type": "commit"}, {"oid": "17282e14c0394346022da8281a6b384eedeb1934", "url": "https://github.com/GoogleContainerTools/jib/commit/17282e14c0394346022da8281a6b384eedeb1934", "message": "Add tests", "committedDate": "2020-08-25T17:24:49Z", "type": "commit"}, {"oid": "3d7ffb8f5d2417cf986818cebac5138bfc01aaf4", "url": "https://github.com/GoogleContainerTools/jib/commit/3d7ffb8f5d2417cf986818cebac5138bfc01aaf4", "message": "Merge branch 'master' into manifest-cache-multi-platform-part1", "committedDate": "2020-08-26T00:23:37Z", "type": "commit"}, {"oid": "a9d44b8ac17cbab6b9131e2df5a8090dbcb3b31c", "url": "https://github.com/GoogleContainerTools/jib/commit/a9d44b8ac17cbab6b9131e2df5a8090dbcb3b31c", "message": "Javadoc placeholder", "committedDate": "2020-08-26T21:10:58Z", "type": "commit"}, {"oid": "1464c0e802d8c8772bc18303261314af816c730f", "url": "https://github.com/GoogleContainerTools/jib/commit/1464c0e802d8c8772bc18303261314af816c730f", "message": "Fix Javadoc", "committedDate": "2020-08-26T21:18:56Z", "type": "commit"}, {"oid": "27e620b1743f8acf355caf1627ef462b099ba042", "url": "https://github.com/GoogleContainerTools/jib/commit/27e620b1743f8acf355caf1627ef462b099ba042", "message": "Add and fix tests", "committedDate": "2020-08-26T22:27:00Z", "type": "commit"}, {"oid": "0cb21d22d0e40dc8cd2ba1dc37d42e5f32aa4ec4", "url": "https://github.com/GoogleContainerTools/jib/commit/0cb21d22d0e40dc8cd2ba1dc37d42e5f32aa4ec4", "message": "Fix tests", "committedDate": "2020-08-26T22:29:41Z", "type": "commit"}, {"oid": "c01c470fcc2106783f163fb9ae23e5573e5ed96d", "url": "https://github.com/GoogleContainerTools/jib/commit/c01c470fcc2106783f163fb9ae23e5573e5ed96d", "message": "Fix tests", "committedDate": "2020-08-26T22:41:33Z", "type": "commit"}, {"oid": "cfeefb24bce181f10ea94b21f143637830fe6163", "url": "https://github.com/GoogleContainerTools/jib/commit/cfeefb24bce181f10ea94b21f143637830fe6163", "message": "Clean up code", "committedDate": "2020-08-27T15:53:09Z", "type": "commit"}, {"oid": "6426994e5e7a5c8a77b7aa6dd39e4f133c51fe16", "url": "https://github.com/GoogleContainerTools/jib/commit/6426994e5e7a5c8a77b7aa6dd39e4f133c51fe16", "message": "Update Javadoc", "committedDate": "2020-08-27T16:23:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ5MDI1NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478490255", "bodyText": "I thought we could still run into an issue where we don't have all the necessary platform information for an image/platform that wasn't previously referenced?\nI assume downloading all the image layers for all the images is impractical?", "author": "loosebazooka", "createdAt": "2020-08-27T15:06:08Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -105,28 +106,21 @@ public ImagesAndRegistryClient call()\n         LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n \n     if (buildContext.isOffline()) {\n-      Optional<Image> image = getCachedBaseImage();\n-      if (image.isPresent()) {\n-        if (!checkImagePlatform(image.get())) {\n-          throw new IllegalStateException(\n-              \"The cached base image manifest does not match the configured platform due to the \"\n-                  + \"current implementation of limited platform support. As a workaround, re-run \"\n-                  + \"Jib online once to re-cache the right image manifest.\");\n-        }\n-        return new ImagesAndRegistryClient(Collections.singletonList(image.get()), null);\n+      List<Image> images = getCachedBaseImages();", "originalCommit": "c01c470fcc2106783f163fb9ae23e5573e5ed96d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyNjg1Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478626856", "bodyText": "where we don't have all the necessary platform information for an image/platform that wasn't previously referenced?\n\nIn this case, the getCachedBaseImages() in this PR returns an empty list (i.e., cache miss). Offline building will fail and suggest to re-run online once. The digest reference case will fall through to normal operation (contacting the base image repository).", "author": "chanseokoh", "createdAt": "2020-08-27T18:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ5MDI1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2OTcwMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478569701", "bodyText": "maybe \"the registry manifest\"?", "author": "loosebazooka", "createdAt": "2020-08-27T17:08:23Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestAndConfigTemplate.java", "diffHunk": "@@ -43,13 +43,36 @@\n   @SuppressWarnings(\"unused\")\n   private ManifestAndConfigTemplate() {}\n \n+  /**\n+   * Creates an instance.\n+   *\n+   * @param manifest the manifest", "originalCommit": "6426994e5e7a5c8a77b7aa6dd39e4f133c51fe16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyNzIwNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478627207", "bodyText": "I think \"the image manifest\" is more suitable.", "author": "chanseokoh", "createdAt": "2020-08-27T18:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2OTcwMQ=="}], "type": "inlineReview"}, {"oid": "e170f76f600c57753f3b19e7cca38c93fa89084a", "url": "https://github.com/GoogleContainerTools/jib/commit/e170f76f600c57753f3b19e7cca38c93fa89084a", "message": "Update Javadocs", "committedDate": "2020-08-27T19:01:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NDk3MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478644971", "bodyText": "So this section is for when the base image reference is a single manifest?", "author": "mpeddada1", "createdAt": "2020-08-27T19:26:06Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -351,35 +330,67 @@ private ContainerConfigurationTemplate pullContainerConfigJson(\n   }\n \n   /**\n-   * Retrieves the cached base image.\n+   * Retrieves the cached base images. If a base image reference is not a manifest list, returns a\n+   * single image (if cached). If a manifest list, returns all the images matching the configured\n+   * platforms in the manifest list but only when all of the images are cached.\n    *\n-   * @return the cached image, if found\n+   * @return the cached images, if found\n    * @throws IOException when an I/O exception occurs\n    * @throws CacheCorruptedException if the cache is corrupted\n    * @throws LayerPropertyNotFoundException if adding image layers fails\n    * @throws BadContainerConfigurationFormatException if the container configuration is in a bad\n    *     format\n+   * @throws UnlistedPlatformInManifestListException if a cached manifest list has no manifests\n+   *     matching the configured platform\n    */\n-  private Optional<Image> getCachedBaseImage()\n+  @VisibleForTesting\n+  List<Image> getCachedBaseImages()\n       throws IOException, CacheCorruptedException, BadContainerConfigurationFormatException,\n-          LayerCountMismatchException {\n+          LayerCountMismatchException, UnlistedPlatformInManifestListException {\n     ImageReference baseImage = buildContext.getBaseImageConfiguration().getImage();\n     Optional<ImageMetadataTemplate> metadata =\n         buildContext.getBaseImageLayersCache().retrieveMetadata(baseImage);\n     if (!metadata.isPresent()) {\n-      return Optional.empty();\n+      return Collections.emptyList();\n     }\n \n+    ManifestTemplate manifestList = metadata.get().getManifestList();\n     List<ManifestAndConfigTemplate> manifestsAndConfigs = metadata.get().getManifestsAndConfigs();\n-    Verify.verify(manifestsAndConfigs.size() == 1);\n-    ManifestTemplate manifest = Verify.verifyNotNull(manifestsAndConfigs.get(0).getManifest());\n-    if (manifest instanceof V21ManifestTemplate) {\n-      return Optional.of(JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n+\n+    if (manifestList == null) {\n+      Verify.verify(manifestsAndConfigs.size() == 1);\n+      ManifestTemplate manifest = manifestsAndConfigs.get(0).getManifest();\n+      if (manifest instanceof V21ManifestTemplate) {\n+        return Collections.singletonList(\n+            JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n+      }\n+      return Collections.singletonList(\n+          JsonToImageTranslator.toImage(\n+              (BuildableManifestTemplate) Verify.verifyNotNull(manifest),\n+              Verify.verifyNotNull(manifestsAndConfigs.get(0).getConfig())));", "originalCommit": "e170f76f600c57753f3b19e7cca38c93fa89084a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY1MzY4NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478653685", "bodyText": "Exactly. When the image reference is an image manifest and not a manifest list. In the cache metadata, manifestList is null in this case.", "author": "chanseokoh", "createdAt": "2020-08-27T19:43:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY1NTM1MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478655350", "bodyText": "Ah gotcha, is there a particular reason why we chose null instead of an empty list for manifestList?", "author": "mpeddada1", "createdAt": "2020-08-27T19:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY1ODczMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478658732", "bodyText": "Good question. A \"manifest list\" is not a List in Java but a class called ManifestTemplate.", "author": "chanseokoh", "createdAt": "2020-08-27T19:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMzNjgzMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r479336831", "bodyText": "Right my bad, thanks for clarifying:)", "author": "mpeddada1", "createdAt": "2020-08-28T14:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NDk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NzI5MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478647291", "bodyText": "Why do we make sure to return the images matching the configured platforms in the manifest list only if all the images are cached?", "author": "mpeddada1", "createdAt": "2020-08-27T19:30:33Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -351,35 +330,67 @@ private ContainerConfigurationTemplate pullContainerConfigJson(\n   }\n \n   /**\n-   * Retrieves the cached base image.\n+   * Retrieves the cached base images. If a base image reference is not a manifest list, returns a\n+   * single image (if cached). If a manifest list, returns all the images matching the configured\n+   * platforms in the manifest list but only when all of the images are cached.", "originalCommit": "e170f76f600c57753f3b19e7cca38c93fa89084a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY1MzAzNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478653035", "bodyText": "If we have cached only a subset of what we really need (i.e., Jib needs to build, say, three Images, but the cache has only two Images), then it's not a cache hit as a whole, thus a cache miss.\nTheoretically you could say, Jib could re-download only the missing Images, but note that performance is not the reason for caching. It's about whether we can completely avoid accessing the Internet or not. So, if any image is missing in the cache, I am saying \"cache miss\" for simplicity.", "author": "chanseokoh", "createdAt": "2020-08-27T19:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NzI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY1MjUzOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478652539", "bodyText": "I may be missing something here but what's the reasoning behind checking if these values are null?/ When would they be null?", "author": "mpeddada1", "createdAt": "2020-08-27T19:40:57Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -351,35 +330,67 @@ private ContainerConfigurationTemplate pullContainerConfigJson(\n   }\n \n   /**\n-   * Retrieves the cached base image.\n+   * Retrieves the cached base images. If a base image reference is not a manifest list, returns a\n+   * single image (if cached). If a manifest list, returns all the images matching the configured\n+   * platforms in the manifest list but only when all of the images are cached.\n    *\n-   * @return the cached image, if found\n+   * @return the cached images, if found\n    * @throws IOException when an I/O exception occurs\n    * @throws CacheCorruptedException if the cache is corrupted\n    * @throws LayerPropertyNotFoundException if adding image layers fails\n    * @throws BadContainerConfigurationFormatException if the container configuration is in a bad\n    *     format\n+   * @throws UnlistedPlatformInManifestListException if a cached manifest list has no manifests\n+   *     matching the configured platform\n    */\n-  private Optional<Image> getCachedBaseImage()\n+  @VisibleForTesting\n+  List<Image> getCachedBaseImages()\n       throws IOException, CacheCorruptedException, BadContainerConfigurationFormatException,\n-          LayerCountMismatchException {\n+          LayerCountMismatchException, UnlistedPlatformInManifestListException {\n     ImageReference baseImage = buildContext.getBaseImageConfiguration().getImage();\n     Optional<ImageMetadataTemplate> metadata =\n         buildContext.getBaseImageLayersCache().retrieveMetadata(baseImage);\n     if (!metadata.isPresent()) {\n-      return Optional.empty();\n+      return Collections.emptyList();\n     }\n \n+    ManifestTemplate manifestList = metadata.get().getManifestList();\n     List<ManifestAndConfigTemplate> manifestsAndConfigs = metadata.get().getManifestsAndConfigs();\n-    Verify.verify(manifestsAndConfigs.size() == 1);\n-    ManifestTemplate manifest = Verify.verifyNotNull(manifestsAndConfigs.get(0).getManifest());\n-    if (manifest instanceof V21ManifestTemplate) {\n-      return Optional.of(JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n+\n+    if (manifestList == null) {\n+      Verify.verify(manifestsAndConfigs.size() == 1);\n+      ManifestTemplate manifest = manifestsAndConfigs.get(0).getManifest();\n+      if (manifest instanceof V21ManifestTemplate) {\n+        return Collections.singletonList(\n+            JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n+      }\n+      return Collections.singletonList(\n+          JsonToImageTranslator.toImage(\n+              (BuildableManifestTemplate) Verify.verifyNotNull(manifest),\n+              Verify.verifyNotNull(manifestsAndConfigs.get(0).getConfig())));\n     }\n \n-    return Optional.of(\n-        JsonToImageTranslator.toImage(\n-            (BuildableManifestTemplate) manifest,\n-            Verify.verifyNotNull(manifestsAndConfigs.get(0).getConfig())));\n+    // Manifest list cached. Identify matching platforms and check if all of them are cached.\n+    ImmutableList.Builder<Image> images = ImmutableList.builder();\n+    for (Platform platform : buildContext.getContainerConfiguration().getPlatforms()) {\n+      String manifestDigest =\n+          lookUpPlatformSpecificImageManifest((V22ManifestListTemplate) manifestList, platform);\n+\n+      Optional<ManifestAndConfigTemplate> manifestAndConfigFound =\n+          manifestsAndConfigs\n+              .stream()\n+              .filter(entry -> manifestDigest.equals(entry.getManifestDigest()))\n+              .findFirst();\n+      if (!manifestAndConfigFound.isPresent()) {\n+        return Collections.emptyList();\n+      }\n+\n+      ManifestTemplate manifest = Verify.verifyNotNull(manifestAndConfigFound.get().getManifest());\n+      ContainerConfigurationTemplate containerConfig =\n+          Verify.verifyNotNull(manifestAndConfigFound.get().getConfig());", "originalCommit": "e170f76f600c57753f3b19e7cca38c93fa89084a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2MTI5MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478661291", "bodyText": "It's our assumption and how we designed the cache to work. If any ManifestAndConfig entry (which is just a pair of a manifest and a config) is saved (cached), their values should never be null; otherwise, something got terribly wrong.\nNow, we then use Verify.verifyNotNull() to signal the NullAway check (it's a check we set up in our repo to catch potential NPE) that manifest and containerConfig are not supposed to be null. Otherwise, because JsonToImageTranslator.toImage() doesn't accept @Nullable parameters, NullAway will complain that you're passing potentially null parameters.", "author": "chanseokoh", "createdAt": "2020-08-27T19:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY1MjUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMzNzQwMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r479337401", "bodyText": "Oh I see! Makes sense", "author": "mpeddada1", "createdAt": "2020-08-28T14:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY1MjUzOQ=="}], "type": "inlineReview"}]}