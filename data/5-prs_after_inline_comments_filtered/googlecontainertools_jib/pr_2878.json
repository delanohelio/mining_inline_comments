{"pr_number": 2878, "pr_title": "Add jar cli sub-command to the jib cli", "pr_createdAt": "2020-11-02T22:27:08Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2878", "timeline": [{"oid": "56dc2c97a8aa26d4159c67571144f179845e0b2b", "url": "https://github.com/GoogleContainerTools/jib/commit/56dc2c97a8aa26d4159c67571144f179845e0b2b", "message": "implement class to convert a jar to a JibContainerBuilder", "committedDate": "2020-10-28T19:38:52Z", "type": "commit"}, {"oid": "35556ef2c1524c58cbca267c2dbf1187e1632eee", "url": "https://github.com/GoogleContainerTools/jib/commit/35556ef2c1524c58cbca267c2dbf1187e1632eee", "message": "update javadoc", "committedDate": "2020-10-28T19:49:11Z", "type": "commit"}, {"oid": "306873afce1b681bf851ec51f53c0d799aade2df", "url": "https://github.com/GoogleContainerTools/jib/commit/306873afce1b681bf851ec51f53c0d799aade2df", "message": "Adding jar subcommand", "committedDate": "2020-10-30T19:56:45Z", "type": "commit"}, {"oid": "fa3025337094bb33fc2fca72397bf1ca43d04a58", "url": "https://github.com/GoogleContainerTools/jib/commit/fa3025337094bb33fc2fca72397bf1ca43d04a58", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into cli-jar-containerize", "committedDate": "2020-10-30T19:56:53Z", "type": "commit"}, {"oid": "61d508211f06bf55c3d0b4ccf0977fb74d20e771", "url": "https://github.com/GoogleContainerTools/jib/commit/61d508211f06bf55c3d0b4ccf0977fb74d20e771", "message": "wip", "committedDate": "2020-10-30T20:55:09Z", "type": "commit"}, {"oid": "e452ba93e4dc39f33e4ef6f58648e40a8f3611a2", "url": "https://github.com/GoogleContainerTools/jib/commit/e452ba93e4dc39f33e4ef6f58648e40a8f3611a2", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into cli-jar-containerize", "committedDate": "2020-10-30T20:55:18Z", "type": "commit"}, {"oid": "2432ab85dc2734c8e737c0d9fa3445c1fa3a788f", "url": "https://github.com/GoogleContainerTools/jib/commit/2432ab85dc2734c8e737c0d9fa3445c1fa3a788f", "message": "add error messaging", "committedDate": "2020-11-02T21:48:11Z", "type": "commit"}, {"oid": "85bd4d8ce43b3b33625222c8fa70f24b9fbc31cc", "url": "https://github.com/GoogleContainerTools/jib/commit/85bd4d8ce43b3b33625222c8fa70f24b9fbc31cc", "message": "cleaning up files that are not part of pr", "committedDate": "2020-11-02T21:50:32Z", "type": "commit"}, {"oid": "7a072c292dfb5861fa6b029ca6bbc342c00eca1c", "url": "https://github.com/GoogleContainerTools/jib/commit/7a072c292dfb5861fa6b029ca6bbc342c00eca1c", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into cli-jar-containerize", "committedDate": "2020-11-02T21:50:41Z", "type": "commit"}, {"oid": "94a1fce85af6b3f0341c4708c71ffb8b02f8cd56", "url": "https://github.com/GoogleContainerTools/jib/commit/94a1fce85af6b3f0341c4708c71ffb8b02f8cd56", "message": "undo edit to build.gradle", "committedDate": "2020-11-02T21:59:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwNzYxNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516707615", "bodyText": "I think we should accept this is an ordinary argument, not through an option, e.g., jib ... jar my.jar.", "author": "chanseokoh", "createdAt": "2020-11-03T14:29:39Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.cli2;\n+\n+import com.google.cloud.tools.jib.api.Containerizer;\n+import com.google.cloud.tools.jib.api.JibContainerBuilder;\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.cli.cli2.logging.CliLogger;\n+import com.google.cloud.tools.jib.cli.jar.JarFiles;\n+import com.google.cloud.tools.jib.plugins.common.logging.ConsoleLogger;\n+import com.google.common.io.MoreFiles;\n+import com.google.common.io.RecursiveDeleteOption;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.Callable;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(name = \"jar\", showAtFileInUsageHelp = true, description = \"Containerize a jar\")\n+public class Jar implements Callable<Integer> {\n+  @CommandLine.ParentCommand\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  protected JibCli globalOptions;\n+\n+  @CommandLine.Option(\n+      names = {\"--jar\"},", "originalCommit": "94a1fce85af6b3f0341c4708c71ffb8b02f8cd56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc5MjI2Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516792267", "bodyText": "Good catch, thanks.", "author": "mpeddada1", "createdAt": "2020-11-03T16:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwNzYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwODI5OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516708298", "bodyText": "Should also print the exception type. Check Build.java. That said, can we explore a way to share code?", "author": "chanseokoh", "createdAt": "2020-11-03T14:30:32Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.cli2;\n+\n+import com.google.cloud.tools.jib.api.Containerizer;\n+import com.google.cloud.tools.jib.api.JibContainerBuilder;\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.cli.cli2.logging.CliLogger;\n+import com.google.cloud.tools.jib.cli.jar.JarFiles;\n+import com.google.cloud.tools.jib.plugins.common.logging.ConsoleLogger;\n+import com.google.common.io.MoreFiles;\n+import com.google.common.io.RecursiveDeleteOption;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.Callable;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(name = \"jar\", showAtFileInUsageHelp = true, description = \"Containerize a jar\")\n+public class Jar implements Callable<Integer> {\n+  @CommandLine.ParentCommand\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  protected JibCli globalOptions;\n+\n+  @CommandLine.Option(\n+      names = {\"--jar\"},\n+      paramLabel = \"<jar-file>\",\n+      description = \"The path to the jar file (ex: path/to/my-jar.jar)\")\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  private Path jarFile;\n+\n+  /**\n+   * Returns a user configured Path to a jar file.\n+   *\n+   * @return a path to a jar file\n+   */\n+  public Path getJarFile() {\n+    return jarFile;\n+  }\n+\n+  @Override\n+  public Integer call() {\n+    globalOptions.validate();\n+    Path jarFile = getJarFile();\n+    try {\n+      ConsoleLogger logger =\n+          CliLogger.newLogger(globalOptions.getVerbosity(), globalOptions.getConsoleOutput());\n+      if (!Files.exists(jarFile)) {\n+        logger.log(LogEvent.Level.ERROR, \"The file path provided does not exist: \" + jarFile);\n+        return 1;\n+      }\n+      if (Files.isDirectory(jarFile)) {\n+        logger.log(\n+            LogEvent.Level.ERROR,\n+            \"The file path provided is for a directory. Please provide a path to a jar file: \"\n+                + jarFile);\n+        return 1;\n+      }\n+      Containerizer containerizer = Containerizers.from(globalOptions, logger);\n+      JibContainerBuilder containerBuilder =\n+          JarFiles.toJibContainerBuilder(getJarFile(), Paths.get(\"build-artifacts\"));\n+      containerBuilder.containerize(containerizer);\n+      MoreFiles.deleteDirectoryContents(\n+          Paths.get(\"build-artifacts\"), RecursiveDeleteOption.ALLOW_INSECURE);\n+    } catch (Exception ex) {\n+      if (globalOptions.isStacktrace()) {\n+        ex.printStackTrace();\n+      }\n+      System.err.println(ex.getMessage());", "originalCommit": "94a1fce85af6b3f0341c4708c71ffb8b02f8cd56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc3MTQ4Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516771483", "bodyText": "Or maybe it's not much worth to share this short block. In any case, let's print the exception type.", "author": "chanseokoh", "createdAt": "2020-11-03T15:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwODI5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc5MjQzOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516792439", "bodyText": "Yeah I was trying to see if there was anything more that I could share but that required me to add some logic as to which sub-command we're using since the steps to containerize are a bit different for both. I'll make the exception more consistent with Build.java though.", "author": "mpeddada1", "createdAt": "2020-11-03T16:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwODI5OA=="}], "type": "inlineReview"}, {"oid": "90d6e1fd965673362ca70805defa75fd4d93de2d", "url": "https://github.com/GoogleContainerTools/jib/commit/90d6e1fd965673362ca70805defa75fd4d93de2d", "message": "make option parameter", "committedDate": "2020-11-03T15:33:48Z", "type": "commit"}, {"oid": "b82ca96f1b1edbab5f98d5ee161e364adf2dfa39", "url": "https://github.com/GoogleContainerTools/jib/commit/b82ca96f1b1edbab5f98d5ee161e364adf2dfa39", "message": "print exception type", "committedDate": "2020-11-03T16:35:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwNDgxNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516804816", "bodyText": "Is this method is required?", "author": "chanseokoh", "createdAt": "2020-11-03T16:39:31Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.cli2;\n+\n+import com.google.cloud.tools.jib.api.Containerizer;\n+import com.google.cloud.tools.jib.api.JibContainerBuilder;\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.cli.cli2.logging.CliLogger;\n+import com.google.cloud.tools.jib.cli.jar.JarFiles;\n+import com.google.cloud.tools.jib.plugins.common.logging.ConsoleLogger;\n+import com.google.common.io.MoreFiles;\n+import com.google.common.io.RecursiveDeleteOption;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.Callable;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(name = \"jar\", showAtFileInUsageHelp = true, description = \"Containerize a jar\")\n+public class Jar implements Callable<Integer> {\n+  @CommandLine.ParentCommand\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  protected JibCli globalOptions;\n+\n+  @CommandLine.Parameters(description = \"The path to the jar file (ex: path/to/my-jar.jar)\")\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  private Path jarFile;\n+\n+  /**\n+   * Returns a user configured Path to a jar file.\n+   *\n+   * @return a path to a jar file\n+   */\n+  public Path getJarFile() {", "originalCommit": "b82ca96f1b1edbab5f98d5ee161e364adf2dfa39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODI0Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516808246", "bodyText": "We need to sort out what we should provide for a temporary staging directory. We may eventually go for a dedicated build output directory, but for now, I think we can provide a system temp directory. Let's talk offline.", "author": "chanseokoh", "createdAt": "2020-11-03T16:44:37Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.cli2;\n+\n+import com.google.cloud.tools.jib.api.Containerizer;\n+import com.google.cloud.tools.jib.api.JibContainerBuilder;\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.cli.cli2.logging.CliLogger;\n+import com.google.cloud.tools.jib.cli.jar.JarFiles;\n+import com.google.cloud.tools.jib.plugins.common.logging.ConsoleLogger;\n+import com.google.common.io.MoreFiles;\n+import com.google.common.io.RecursiveDeleteOption;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.Callable;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(name = \"jar\", showAtFileInUsageHelp = true, description = \"Containerize a jar\")\n+public class Jar implements Callable<Integer> {\n+  @CommandLine.ParentCommand\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  protected JibCli globalOptions;\n+\n+  @CommandLine.Parameters(description = \"The path to the jar file (ex: path/to/my-jar.jar)\")\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  private Path jarFile;\n+\n+  /**\n+   * Returns a user configured Path to a jar file.\n+   *\n+   * @return a path to a jar file\n+   */\n+  public Path getJarFile() {\n+    return jarFile;\n+  }\n+\n+  @Override\n+  public Integer call() {\n+    globalOptions.validate();\n+    Path jarFile = getJarFile();\n+    try {\n+      ConsoleLogger logger =\n+          CliLogger.newLogger(globalOptions.getVerbosity(), globalOptions.getConsoleOutput());\n+      if (!Files.exists(jarFile)) {\n+        logger.log(LogEvent.Level.ERROR, \"The file path provided does not exist: \" + jarFile);\n+        return 1;\n+      }\n+      if (Files.isDirectory(jarFile)) {\n+        logger.log(\n+            LogEvent.Level.ERROR,\n+            \"The file path provided is for a directory. Please provide a path to a jar file: \"\n+                + jarFile);\n+        return 1;\n+      }\n+      Containerizer containerizer = Containerizers.from(globalOptions, logger);\n+      JibContainerBuilder containerBuilder =\n+          JarFiles.toJibContainerBuilder(getJarFile(), Paths.get(\"build-artifacts\"));", "originalCommit": "b82ca96f1b1edbab5f98d5ee161e364adf2dfa39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fcb3c6af9c8f71061faf42f61f9a6d1a43e1917f", "url": "https://github.com/GoogleContainerTools/jib/commit/fcb3c6af9c8f71061faf42f61f9a6d1a43e1917f", "message": "use tempDirectoryProvider and clean up", "committedDate": "2020-11-03T17:47:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1MTU0Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516851543", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                try {\n          \n          \n            \n                try (TempDirectoryProvider tempDirectoryProvider = new TempDirectoryProvider()) {\n          \n      \n    \n    \n  \n\nand remove the field and the finally block.", "author": "chanseokoh", "createdAt": "2020-11-03T17:51:19Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -40,22 +38,15 @@\n   @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n   private Path jarFile;\n \n-  /**\n-   * Returns a user configured Path to a jar file.\n-   *\n-   * @return a path to a jar file\n-   */\n-  public Path getJarFile() {\n-    return jarFile;\n-  }\n+  private final TempDirectoryProvider tempDirectoryProvider = new TempDirectoryProvider();\n \n   @Override\n   public Integer call() {\n     globalOptions.validate();\n-    Path jarFile = getJarFile();\n     try {", "originalCommit": "fcb3c6af9c8f71061faf42f61f9a6d1a43e1917f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg3MDc0Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2878#discussion_r516870742", "bodyText": "oh this is much better", "author": "mpeddada1", "createdAt": "2020-11-03T18:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1MTU0Mw=="}], "type": "inlineReview"}, {"oid": "d862ed3037041b3a4b72494685f83f386d5487f5", "url": "https://github.com/GoogleContainerTools/jib/commit/d862ed3037041b3a4b72494685f83f386d5487f5", "message": "use try-with-resources block instead of finally", "committedDate": "2020-11-03T18:23:27Z", "type": "commit"}]}