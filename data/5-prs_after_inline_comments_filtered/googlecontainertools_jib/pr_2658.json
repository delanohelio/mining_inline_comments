{"pr_number": 2658, "pr_title": "Check if cached manifest matches configured platform", "pr_createdAt": "2020-08-04T16:40:18Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2658", "timeline": [{"oid": "c74e940fe8b34b0d859345d87fd96c3531fe6eb4", "url": "https://github.com/GoogleContainerTools/jib/commit/c74e940fe8b34b0d859345d87fd96c3531fe6eb4", "message": "Guard mismatched cached manifest and show suggestion", "committedDate": "2020-08-04T15:54:24Z", "type": "commit"}, {"oid": "f80cb05d6c189f32aade765987b9d35dc3d7a87c", "url": "https://github.com/GoogleContainerTools/jib/commit/f80cb05d6c189f32aade765987b9d35dc3d7a87c", "message": "Update CHANGELOG", "committedDate": "2020-08-04T16:35:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI3OTI4Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465279282", "bodyText": "thenReturn(ImmutableSet.of(new Platform(\"testArch\", \"testOS\")));", "author": "louismurerwa", "createdAt": "2020-08-04T19:28:05Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStepTest.java", "diffHunk": "@@ -130,6 +137,56 @@ public void testCall_offlineMode_cached()\n     Mockito.verify(buildContext, Mockito.never()).newBaseImageRegistryClientFactory();\n   }\n \n+  @Test\n+  public void testCall_mismatchedPlatformOfCachedManifest_offlineMode()\n+      throws LayerPropertyNotFoundException, IOException, RegistryException,\n+          LayerCountMismatchException, BadContainerConfigurationFormatException,\n+          CacheCorruptedException, CredentialRetrievalException, InvalidImageReferenceException {\n+    ImageReference imageReference = ImageReference.parse(\"cat\");\n+    Mockito.when(imageConfiguration.getImage()).thenReturn(imageReference);\n+    Mockito.when(cache.retrieveMetadata(imageReference)).thenReturn(Optional.of(manifestAndConfig));\n+    Mockito.when(buildContext.isOffline()).thenReturn(true);\n+    Mockito.when(containerConfig.getPlatforms())\n+        .thenReturn(ImmutableSet.of(new Platform(\"foo arch\", \"bar OS\")));", "originalCommit": "f80cb05d6c189f32aade765987b9d35dc3d7a87c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI4MDM5Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465280396", "bodyText": "ditoo", "author": "louismurerwa", "createdAt": "2020-08-04T19:29:23Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStepTest.java", "diffHunk": "@@ -130,6 +137,56 @@ public void testCall_offlineMode_cached()\n     Mockito.verify(buildContext, Mockito.never()).newBaseImageRegistryClientFactory();\n   }\n \n+  @Test\n+  public void testCall_mismatchedPlatformOfCachedManifest_offlineMode()\n+      throws LayerPropertyNotFoundException, IOException, RegistryException,\n+          LayerCountMismatchException, BadContainerConfigurationFormatException,\n+          CacheCorruptedException, CredentialRetrievalException, InvalidImageReferenceException {\n+    ImageReference imageReference = ImageReference.parse(\"cat\");\n+    Mockito.when(imageConfiguration.getImage()).thenReturn(imageReference);\n+    Mockito.when(cache.retrieveMetadata(imageReference)).thenReturn(Optional.of(manifestAndConfig));\n+    Mockito.when(buildContext.isOffline()).thenReturn(true);\n+    Mockito.when(containerConfig.getPlatforms())\n+        .thenReturn(ImmutableSet.of(new Platform(\"foo arch\", \"bar OS\")));\n+\n+    try {\n+      pullBaseImageStep.call();\n+      Assert.fail();\n+    } catch (IllegalStateException ex) {\n+      Assert.assertEquals(\n+          \"The cached base image manifest does not match the configured platform due to the \"\n+              + \"current implementation of limited platform support. As a workaround, re-run Jib \"\n+              + \"online once to re-cache the right image manifest.\",\n+          ex.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void testCall_mismatchedPlatformOfCachedManifest_baseImageDigest()\n+      throws LayerPropertyNotFoundException, IOException, RegistryException,\n+          LayerCountMismatchException, BadContainerConfigurationFormatException,\n+          CacheCorruptedException, CredentialRetrievalException, InvalidImageReferenceException {\n+    ImageReference imageReference =\n+        ImageReference.parse(\n+            \"awesome@sha256:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\");\n+    Mockito.when(imageConfiguration.getImage()).thenReturn(imageReference);\n+    Mockito.when(cache.retrieveMetadata(imageReference)).thenReturn(Optional.of(manifestAndConfig));\n+    Mockito.when(containerConfig.getPlatforms())\n+        .thenReturn(ImmutableSet.of(new Platform(\"foo arch\", \"bar OS\")));", "originalCommit": "f80cb05d6c189f32aade765987b9d35dc3d7a87c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d1d38978b026c251be31d37c859b542cb9244033", "url": "https://github.com/GoogleContainerTools/jib/commit/d1d38978b026c251be31d37c859b542cb9244033", "message": "Remove OCI image indices from CHANGELOG", "committedDate": "2020-08-04T19:30:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTcyMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465291721", "bodyText": "should this just trigger a redownload of the correct manifest?", "author": "loosebazooka", "createdAt": "2020-08-04T19:50:04Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -110,6 +113,7 @@ public ImagesAndRegistryClient call()\n     } else if (imageReference.getDigest().isPresent()) {\n       Optional<Image> image = getCachedBaseImage();\n       if (image.isPresent()) {\n+        verifyPlatformOfCachedManifest(image.get());", "originalCommit": "d1d38978b026c251be31d37c859b542cb9244033", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTk1OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465291958", "bodyText": "I mean we're in online mode, we know the manifest needs to be updated? Or is this just an interim solution to a problem that will be fixed?", "author": "loosebazooka", "createdAt": "2020-08-04T19:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MzY3OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465293679", "bodyText": "Oh! Why haven't I thought about it?", "author": "chanseokoh", "createdAt": "2020-08-04T19:53:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0MTA1Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465341056", "bodyText": "If it's just short term. This is fine probably.", "author": "loosebazooka", "createdAt": "2020-08-04T21:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MzQ3OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465363478", "bodyText": "It's a super easy fix and really nice to have. It's just that I really had hard time making the test work. Done.", "author": "chanseokoh", "createdAt": "2020-08-04T22:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTcyMQ=="}], "type": "inlineReview"}, {"oid": "bc9cae706e2fdb2973445329221d5f5517e3697f", "url": "https://github.com/GoogleContainerTools/jib/commit/bc9cae706e2fdb2973445329221d5f5517e3697f", "message": "Download manifest if cached manifest platform mismatches", "committedDate": "2020-08-04T22:18:28Z", "type": "commit"}]}