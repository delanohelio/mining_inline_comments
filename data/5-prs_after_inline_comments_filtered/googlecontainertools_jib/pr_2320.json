{"pr_number": 2320, "pr_title": "Allow more timezone formats", "pr_createdAt": "2020-03-09T16:11:20Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2320", "timeline": [{"oid": "9141af7fc12bdff12b3050ac14a7fb39255221bc", "url": "https://github.com/GoogleContainerTools/jib/commit/9141af7fc12bdff12b3050ac14a7fb39255221bc", "message": "Allow more timezone formats", "committedDate": "2020-03-09T16:10:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NzEyNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389867127", "bodyText": "Should we support -HHMM and -HH:MM as well? And I am not sure if + in +HH is needed. Or perhaps I misunderstood the meaning of +.\nAnd should we support +hh:mm:ss and -hh:mm:ss as well? I don't expect anyone to set a second for the offset, but a machine may generate, say,  09:00:00 for completeness.\nIt's also worth making a CHANGELOG entry that Jib no longer accepts the non-ISO8601 zone format (e.g., [Europe/Paris])? Or, should we just use this new formatter only when the built-in formatter fails?", "author": "chanseokoh", "createdAt": "2020-03-09T18:03:57Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/PluginConfigurationProcessor.java", "diffHunk": "@@ -730,9 +731,21 @@ static Instant getCreationTime(String configuredCreationTime, ProjectProperties\n           return Instant.now();\n \n         default:\n-          return DateTimeFormatter.ISO_DATE_TIME.parse(configuredCreationTime, Instant::from);\n+          DateTimeFormatter formatter =\n+              new DateTimeFormatterBuilder()\n+                  .append(DateTimeFormatter.ISO_LOCAL_DATE_TIME)\n+                  .optionalStart()\n+                  .appendOffset(\"+HH:MM\", \"+00:00\")\n+                  .optionalEnd()\n+                  .optionalStart()\n+                  .appendOffset(\"+HHMM\", \"+0000\")\n+                  .optionalEnd()\n+                  .optionalStart()\n+                  .appendOffset(\"+HH\", \"Z\")\n+                  .optionalEnd()\n+                  .toFormatter();\n+          return formatter.parse(configuredCreationTime, Instant::from);", "originalCommit": "9141af7fc12bdff12b3050ac14a7fb39255221bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg4MDQ0MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389880441", "bodyText": "That said, it's worth adding tests using -.", "author": "chanseokoh", "createdAt": "2020-03-09T18:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NzEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg5NjYyNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389896626", "bodyText": "Yeah I tested them to see it work, but I'll add them to the tests.", "author": "loosebazooka", "createdAt": "2020-03-09T18:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NzEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg5Njg5Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389896893", "bodyText": "hrmm... maybe I can accept the zone format too. I'll try not to break anything.", "author": "loosebazooka", "createdAt": "2020-03-09T18:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NzEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM1Mzc0NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390353745", "bodyText": "So it seems like the formatter will accept seconds, but just ignore them?", "author": "loosebazooka", "createdAt": "2020-03-10T14:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NzEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwODczOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390408738", "bodyText": "It's not completely ignored. The following code prints 1322842530 and 1322842529 respecively.\n    System.out.println(Instant.from(DateTimeFormatter.ISO_DATE_TIME.parse(\"2011-12-03T01:15:30+09:00:00\")).getEpochSecond());\n    System.out.println(Instant.from(DateTimeFormatter.ISO_DATE_TIME.parse(\"2011-12-03T01:15:30+09:00:01\")).getEpochSecond());\nHowever, I don't really think anyone will really use seconds (other than 00) as part of timezone.", "author": "chanseokoh", "createdAt": "2020-03-10T15:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NzEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MDc1NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390450754", "bodyText": "right because of the ISO_DATE_TIME formatter using HH:MM:ss, but for HHmm seconds is not allowed (I thought it was ignored, but that is untrue). In any case, I can't think of a timezone that is offset by seconds. We could just add HHMMss also", "author": "loosebazooka", "createdAt": "2020-03-10T16:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NzEyNw=="}], "type": "inlineReview"}, {"oid": "38c5577ccac0e05ebd23f8c6dae743ea04cf8c10", "url": "https://github.com/GoogleContainerTools/jib/commit/38c5577ccac0e05ebd23f8c6dae743ea04cf8c10", "message": "Support full iso6801 and increase test coverage", "committedDate": "2020-03-09T19:39:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxOTQwOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389919409", "bodyText": "https://github.com/frohoff/jdk8u-dev-jdk/blob/master/src/share/classes/java/time/format/DateTimeFormatter.java#L992", "author": "loosebazooka", "createdAt": "2020-03-09T19:43:04Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/PluginConfigurationProcessor.java", "diffHunk": "@@ -730,9 +731,31 @@ static Instant getCreationTime(String configuredCreationTime, ProjectProperties\n           return Instant.now();\n \n         default:\n-          return DateTimeFormatter.ISO_DATE_TIME.parse(configuredCreationTime, Instant::from);\n+          DateTimeFormatter formatter =\n+              new DateTimeFormatterBuilder()\n+                  .parseCaseInsensitive()\n+                  .append(DateTimeFormatter.ISO_LOCAL_DATE_TIME)\n+                  // iso 8601 strict", "originalCommit": "38c5577ccac0e05ebd23f8c6dae743ea04cf8c10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MDE3Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389980173", "bodyText": "Aha. Then can't we start with ISO_DATE_TIME? If I'm not mistaken, we only need to add .appendOffset(\"+HHMM\", \"+0000\") for the case without a colon. So, can't we do something like this?\nnew DateTimeFormatterBuilder()\n                .append(ISO_DATE_TIME)\n                .optionalStart()\n                .appendOffset(\"+HHMM\", \"+0000\")\n                .optionalStart()\n                .toFormatter(...)\nIf that doesn't work, at least, I think we can base on .appendOffsetId() and add only .appendOffset(\"+HHMM\", \"+0000\")?", "author": "chanseokoh", "createdAt": "2020-03-09T21:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxOTQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyNDk1Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390024952", "bodyText": "Yeah I think you're right,  I think we want to use +HHmm which covers +09, and +0900", "author": "loosebazooka", "createdAt": "2020-03-09T23:59:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxOTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MDQwNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389980405", "bodyText": "Is this intended? The JDK code you linked doesn't start with this.", "author": "chanseokoh", "createdAt": "2020-03-09T21:47:23Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/PluginConfigurationProcessor.java", "diffHunk": "@@ -730,9 +731,31 @@ static Instant getCreationTime(String configuredCreationTime, ProjectProperties\n           return Instant.now();\n \n         default:\n-          return DateTimeFormatter.ISO_DATE_TIME.parse(configuredCreationTime, Instant::from);\n+          DateTimeFormatter formatter =\n+              new DateTimeFormatterBuilder()\n+                  .parseCaseInsensitive()", "originalCommit": "38c5577ccac0e05ebd23f8c6dae743ea04cf8c10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMDk1NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390000955", "bodyText": "Yeah, I was just playing around with things, mustve left it in there.", "author": "loosebazooka", "createdAt": "2020-03-09T22:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MDQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MTI4Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389981283", "bodyText": "Judging from this Javadoc, shouldn't this be after .appendOffset(\"+HH\", \"Z\")?", "author": "chanseokoh", "createdAt": "2020-03-09T21:49:28Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/PluginConfigurationProcessor.java", "diffHunk": "@@ -730,9 +731,31 @@ static Instant getCreationTime(String configuredCreationTime, ProjectProperties\n           return Instant.now();\n \n         default:\n-          return DateTimeFormatter.ISO_DATE_TIME.parse(configuredCreationTime, Instant::from);\n+          DateTimeFormatter formatter =\n+              new DateTimeFormatterBuilder()\n+                  .parseCaseInsensitive()\n+                  .append(DateTimeFormatter.ISO_LOCAL_DATE_TIME)\n+                  // iso 8601 strict\n+                  .optionalStart()\n+                  .appendOffset(\"+HH:MM\", \"+00:00\")\n+                  .optionalStart()\n+                  .appendLiteral('[')\n+                  .parseCaseSensitive()\n+                  .appendZoneRegionId()\n+                  .appendLiteral(']')\n+                  .optionalEnd()", "originalCommit": "38c5577ccac0e05ebd23f8c6dae743ea04cf8c10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMTA2OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390001069", "bodyText": "I was trying to recreate ISO_DATE_TIME here, but this whole section seems unnecessary.", "author": "loosebazooka", "createdAt": "2020-03-09T22:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MTI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MjQ2OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389982468", "bodyText": "Hmm... is this true with the built-in ISO_DATE_TIME?", "author": "chanseokoh", "createdAt": "2020-03-09T21:52:16Z", "path": "jib-plugins-common/src/test/java/com/google/cloud/tools/jib/plugins/common/PluginConfigurationProcessorTest.java", "diffHunk": "@@ -908,11 +909,48 @@ public void testGetCreationTime_useCurrentTimestamp() throws InvalidCreationTime\n \n   @Test\n   public void testGetCreationTime_isoDateTimeValue() throws InvalidCreationTimeException {\n-    Instant time =\n-        PluginConfigurationProcessor.getCreationTime(\n-            \"2011-12-03T10:15:30+09:00\", projectProperties);\n     Instant expected = DateTimeFormatter.ISO_DATE_TIME.parse(\"2011-12-03T01:15:30Z\", Instant::from);\n-    Assert.assertEquals(expected, time);\n+    List<String> validTimeStamps =\n+        ImmutableList.of(\n+            \"2011-12-03T10:15:30+09:00\",\n+            \"2011-12-03T10:15:30+09:00[Asia/Tokyo]\",\n+            \"2011-12-02T16:15:30-09:00\",\n+            \"2011-12-03T10:15:30+0900\",\n+            \"2011-12-02T16:15:30-0900\",\n+            \"2011-12-03T10:15:30+09\",\n+            \"2011-12-02T16:15:30-09\",\n+            \"2011-12-03T01:15:30Z\");\n+    for (String timeString : validTimeStamps) {\n+      Instant time = PluginConfigurationProcessor.getCreationTime(timeString, projectProperties);\n+      Assert.assertEquals(\"for \" + timeString, expected, time);\n+    }\n+  }\n+\n+  @Test\n+  public void testGetCreationTime_isoDateTimeValueTimeZoneRegionOnlyAllowedForMostStrict8601Mode() {\n+    List<String> invalidTimeStamps =\n+        ImmutableList.of(\n+            \"2011-12-03T01:15:30+0900[Asia/Tokyo]\", \"2011-12-03T01:15:30+09[Asia/Tokyo]\");\n+    for (String timeString : invalidTimeStamps) {\n+      try {\n+        PluginConfigurationProcessor.getCreationTime(timeString, projectProperties);\n+        Assert.fail(\n+            \"creationTime should fail if region specified when zone not in HH:MM mode - \"", "originalCommit": "38c5577ccac0e05ebd23f8c6dae743ea04cf8c10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMDg2Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390000867", "bodyText": "So ISO_DATE_TIME requires you use HH:MM, I don't think we have a reason to add in the code to parse the regionId, and this test just verifies that behavior", "author": "loosebazooka", "createdAt": "2020-03-09T22:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MjQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MzIxOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r389983219", "bodyText": "Looks like the built-in ISO_DATE_TIME allows this? We go against it?\n\nThe ISO-like date-time formatter that formats or parses a date-time with the offset and zone if available, such as '2011-12-03T10:15:30',", "author": "chanseokoh", "createdAt": "2020-03-09T21:54:07Z", "path": "jib-plugins-common/src/test/java/com/google/cloud/tools/jib/plugins/common/PluginConfigurationProcessorTest.java", "diffHunk": "@@ -908,11 +909,48 @@ public void testGetCreationTime_useCurrentTimestamp() throws InvalidCreationTime\n \n   @Test\n   public void testGetCreationTime_isoDateTimeValue() throws InvalidCreationTimeException {\n-    Instant time =\n-        PluginConfigurationProcessor.getCreationTime(\n-            \"2011-12-03T10:15:30+09:00\", projectProperties);\n     Instant expected = DateTimeFormatter.ISO_DATE_TIME.parse(\"2011-12-03T01:15:30Z\", Instant::from);\n-    Assert.assertEquals(expected, time);\n+    List<String> validTimeStamps =\n+        ImmutableList.of(\n+            \"2011-12-03T10:15:30+09:00\",\n+            \"2011-12-03T10:15:30+09:00[Asia/Tokyo]\",\n+            \"2011-12-02T16:15:30-09:00\",\n+            \"2011-12-03T10:15:30+0900\",\n+            \"2011-12-02T16:15:30-0900\",\n+            \"2011-12-03T10:15:30+09\",\n+            \"2011-12-02T16:15:30-09\",\n+            \"2011-12-03T01:15:30Z\");\n+    for (String timeString : validTimeStamps) {\n+      Instant time = PluginConfigurationProcessor.getCreationTime(timeString, projectProperties);\n+      Assert.assertEquals(\"for \" + timeString, expected, time);\n+    }\n+  }\n+\n+  @Test\n+  public void testGetCreationTime_isoDateTimeValueTimeZoneRegionOnlyAllowedForMostStrict8601Mode() {\n+    List<String> invalidTimeStamps =\n+        ImmutableList.of(\n+            \"2011-12-03T01:15:30+0900[Asia/Tokyo]\", \"2011-12-03T01:15:30+09[Asia/Tokyo]\");\n+    for (String timeString : invalidTimeStamps) {\n+      try {\n+        PluginConfigurationProcessor.getCreationTime(timeString, projectProperties);\n+        Assert.fail(\n+            \"creationTime should fail if region specified when zone not in HH:MM mode - \"\n+                + timeString);\n+      } catch (InvalidCreationTimeException ex) {\n+        // pass\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testGetCreationTime_isoDateTimeValueRequiresTimeZone() {\n+    try {\n+      PluginConfigurationProcessor.getCreationTime(\"2011-12-03T01:15:30\", projectProperties);\n+      Assert.fail(\"creationTime should fail if timezone not specified\");", "originalCommit": "38c5577ccac0e05ebd23f8c6dae743ea04cf8c10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMDgzNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390000837", "bodyText": "Yeah I think I misunderstood what was going on. The real issue is that\nInstant.from(DateTimeFormatter.ISO_DATE_TIME(\"2011-12-03T01:15:30\")) throws an exception", "author": "loosebazooka", "createdAt": "2020-03-09T22:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MzIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMTY3NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390001674", "bodyText": "It appears to generate a valid TemporalAccessor intermediary, but that value cannot be converted to Instant.", "author": "loosebazooka", "createdAt": "2020-03-09T22:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MzIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNjEzNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390006136", "bodyText": "Aha, so Instant.from fails because the parsed time has no timezone info?", "author": "chanseokoh", "createdAt": "2020-03-09T22:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MzIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyNjU2NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2320#discussion_r390026564", "bodyText": "right", "author": "loosebazooka", "createdAt": "2020-03-10T00:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MzIxOQ=="}], "type": "inlineReview"}, {"oid": "a1d74145917592fe1029896c9ed096711cb0022f", "url": "https://github.com/GoogleContainerTools/jib/commit/a1d74145917592fe1029896c9ed096711cb0022f", "message": "do a better job of custom parser", "committedDate": "2020-03-10T00:04:19Z", "type": "commit"}, {"oid": "1ded47da8061e040faaf8c4f8a5672093ac1cdba", "url": "https://github.com/GoogleContainerTools/jib/commit/1ded47da8061e040faaf8c4f8a5672093ac1cdba", "message": "cleanup", "committedDate": "2020-03-10T04:03:23Z", "type": "commit"}, {"oid": "6dc5a2e8f384295aa84ec1663517e8d32d4e0711", "url": "https://github.com/GoogleContainerTools/jib/commit/6dc5a2e8f384295aa84ec1663517e8d32d4e0711", "message": "Update CHANGELOG", "committedDate": "2020-03-10T18:21:45Z", "type": "commit"}, {"oid": "9c9dc1bc91a49a3ba4901d5cbfcd8fa60cf681ff", "url": "https://github.com/GoogleContainerTools/jib/commit/9c9dc1bc91a49a3ba4901d5cbfcd8fa60cf681ff", "message": "Update CHANGELOG.md", "committedDate": "2020-03-12T15:36:26Z", "type": "commit"}, {"oid": "cad1fe9bcd40ff3a38f33140549ec9277692985d", "url": "https://github.com/GoogleContainerTools/jib/commit/cad1fe9bcd40ff3a38f33140549ec9277692985d", "message": "Update CHANGELOG.md", "committedDate": "2020-03-12T15:37:14Z", "type": "commit"}]}