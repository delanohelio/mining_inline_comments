{"pr_number": 2261, "pr_title": "Fall back to initial authenticator if bad response", "pr_createdAt": "2020-01-31T22:27:33Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2261", "timeline": [{"oid": "e3b224782015397df9a15782bc9489165168c519", "url": "https://github.com/GoogleContainerTools/jib/commit/e3b224782015397df9a15782bc9489165168c519", "message": "Fall back to initial authenticator if bad response", "committedDate": "2020-01-31T22:23:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMDIzMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2261#discussion_r374920232", "bodyText": "Would it be worth it to pull this out into a function to reduce duplication between here and L374-377?", "author": "TadCordle", "createdAt": "2020-02-04T21:01:20Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java", "diffHunk": "@@ -375,10 +378,13 @@ private Authorization refreshBearerAuth(@Nullable String wwwAuthenticate)\n       }\n     }\n \n-    throw new RegistryAuthenticationFailedException(\n-        registry,\n-        repository,\n-        \"server did not return 'WWW-Authenticate: Bearer' header: \" + wwwAuthenticate);\n+    eventHandlers.dispatch(\n+        LogEvent.debug(\n+            \"server did not return 'WWW-Authenticate: Bearer' header. Actual: \" + wwwAuthenticate));\n+    if (readOnlyBearerAuth) {\n+      return Verify.verifyNotNull(initialBearerAuthenticator.get()).authenticatePull(credential);\n+    }\n+    return Verify.verifyNotNull(initialBearerAuthenticator.get()).authenticatePush(credential);", "originalCommit": "e3b224782015397df9a15782bc9489165168c519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NzQzNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2261#discussion_r374967435", "bodyText": "I think this is fine, considering that there's a difference between authenticator and initialBearerAuthenticator that the latter is nullable.", "author": "chanseokoh", "createdAt": "2020-02-04T22:47:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyMDIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxMTEyOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2261#discussion_r374911128", "bodyText": "Should we worry that we're retaining this authenticator before we've successfully used it?  Or were you setting it here in case it was transient and might work on a subsequent try if attempted?", "author": "briandealwis", "createdAt": "2020-02-04T20:42:04Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/registry/RegistryClient.java", "diffHunk": "@@ -344,6 +346,7 @@ private boolean doBearerAuth(boolean readOnlyBearerAuth) throws IOException, Reg\n       return false; // server returned \"WWW-Authenticate: Basic ...\"\n     }\n \n+    initialBearerAuthenticator.set(authenticator.get());", "originalCommit": "e3b224782015397df9a15782bc9489165168c519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NTkyMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2261#discussion_r374965921", "bodyText": "Should be okay, since refreshBearerAuth is designed in the way that it's called only when authorization is a bearer auth token.", "author": "chanseokoh", "createdAt": "2020-02-04T22:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxMTEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyNDA2Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2261#discussion_r374924063", "bodyText": "Should this be 5? (1 successful, and then 4 attempts)?", "author": "briandealwis", "createdAt": "2020-02-04T21:09:33Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -168,6 +169,71 @@ public void testAutomaticTokenRefresh()\n         .dispatch(logContains(\"refreshing bearer auth token\"));\n   }\n \n+  @Test\n+  public void testAutomaticTokenRefresh_badWwwAuthenticateResponse()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String tokenResponse = \"HTTP/1.1 200 OK\\nContent-Length: 26\\n\\n{\\\"token\\\":\\\"awesome-token!\\\"}\";\n+    authServer = new TestWebServer(false, Arrays.asList(tokenResponse), 3);\n+\n+    List<String> responses =\n+        Arrays.asList(\n+            \"HTTP/1.1 401 Unauthorized\\nContent-Length: 0\\nWWW-Authenticate: Bearer realm=\\\"\"\n+                + authServer.getEndpoint()\n+                + \"\\\"\\n\\n\",\n+            \"HTTP/1.1 401 Unauthorized\\nContent-Length: 0\\nWWW-Authenticate: Basic realm=foo\\n\\n\",\n+            \"HTTP/1.1 401 Unauthorized\\nContent-Length: 0\\n\\n\",\n+            \"HTTP/1.1 200 OK\\nContent-Length: 5678\\n\\n\");\n+    registry = new TestWebServer(false, responses, responses.size(), true);\n+\n+    RegistryClient registryClient = createRegistryClient(null);\n+    Assert.assertTrue(registryClient.doPushBearerAuth());\n+\n+    Optional<BlobDescriptor> digestAndSize = registryClient.checkBlob(digest);\n+    Assert.assertEquals(5678, digestAndSize.get().getSize());\n+\n+    // Verify authServer returned bearer token three times (i.e., refreshed twice)\n+    Assert.assertEquals(3, authServer.getTotalResponsesServed());\n+    Assert.assertEquals(4, registry.getTotalResponsesServed());\n+\n+    Mockito.verify(eventHandlers)\n+        .dispatch(\n+            logContains(\"server did not return 'WWW-Authenticate: Bearer' header. Actual: Basic\"));\n+    Mockito.verify(eventHandlers)\n+        .dispatch(\n+            logContains(\"server did not return 'WWW-Authenticate: Bearer' header. Actual: null\"));\n+  }\n+\n+  @Test\n+  public void testAutomaticTokenRefresh_refreshLimit()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String tokenResponse = \"HTTP/1.1 200 OK\\nContent-Length: 26\\n\\n{\\\"token\\\":\\\"awesome-token!\\\"}\";\n+    authServer = new TestWebServer(false, Arrays.asList(tokenResponse), 5);\n+\n+    String bearerAuth =\n+        \"HTTP/1.1 401 Unauthorized\\nContent-Length: 0\\nWWW-Authenticate: Bearer realm=\\\"\"\n+            + authServer.getEndpoint()\n+            + \"\\\"\\n\\n\";\n+    String unauthorized = \"HTTP/1.1 401 Unauthorized\\nContent-Length: 0\\n\\n\";\n+    List<String> responses =\n+        Arrays.asList(\n+            bearerAuth, unauthorized, unauthorized, unauthorized, unauthorized, unauthorized);\n+    registry = new TestWebServer(false, responses, responses.size(), true);\n+\n+    RegistryClient registryClient = createRegistryClient(null);\n+    Assert.assertTrue(registryClient.doPushBearerAuth());\n+\n+    try {\n+      registryClient.checkBlob(digest);\n+      Assert.fail(\"Should have given up refreshing after 4 attempts\");\n+    } catch (RegistryUnauthorizedException ex) {\n+      Assert.assertEquals(401, ex.getHttpResponseException().getStatusCode());\n+      Assert.assertEquals(5, authServer.getTotalResponsesServed());\n+      Assert.assertEquals(6, registry.getTotalResponsesServed());", "originalCommit": "e3b224782015397df9a15782bc9489165168c519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2OTcwOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2261#discussion_r374969709", "bodyText": "It's 6: 1 response asking to auth + 4 unauth responses for 4 refresh attempts + 1 final unauth response that will be thrown as RegistryUnauthorizedException. I'll put a comment in the code.", "author": "chanseokoh", "createdAt": "2020-02-04T22:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkyNDA2Mw=="}], "type": "inlineReview"}, {"oid": "784c58f682339f37ecd052ce7f5c8f10db5b79b5", "url": "https://github.com/GoogleContainerTools/jib/commit/784c58f682339f37ecd052ce7f5c8f10db5b79b5", "message": "Add comment", "committedDate": "2020-02-04T22:54:04Z", "type": "commit"}, {"oid": "af85980fe2ebba157488e6d27b41b305e3a55b55", "url": "https://github.com/GoogleContainerTools/jib/commit/af85980fe2ebba157488e6d27b41b305e3a55b55", "message": "CHANGELOG", "committedDate": "2020-02-04T23:10:03Z", "type": "commit"}]}