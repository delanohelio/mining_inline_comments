{"pr_number": 2606, "pr_title": "Add validation to required yaml properties", "pr_createdAt": "2020-07-22T01:42:52Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2606", "timeline": [{"oid": "6285ec464e8de5756113d636da52ca0260ca6daf", "url": "https://github.com/GoogleContainerTools/jib/commit/6285ec464e8de5756113d636da52ca0260ca6daf", "message": "Add validation to required yaml properties\n\n- Only check required values\n- Add validator class with standard error messages\n- Add in tests for value validation\n\nWhy not `@JsonInclude`?\nBecause `@JsonCreator` and `@JsonInclude` do not work at all\nwith eachother. We use @JsonCreator since it handles \"required\" fields\nand we can validate non null, non empty at creation time. Using `@JsonInclude`\nwith jackson bean initialized of fields (vs creator) would give us access\nto automatic non-null, non-empty validation, but we would have to push\nour own \"required\" infrastructure. This cannot happen at yaml parse time, and\nwould happen after parsing in some sort of post-parsing step (or there is some\njackson validation framework that I was unable to find). I find the\n`@JsonCreator` workflow slightly cleaner.", "committedDate": "2020-07-22T01:37:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgyNzA4NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2606#discussion_r458827085", "bodyText": "Should we annotate @Nullable on value?\nBTW, Guava checkNotNull returns the input object like the following, although we don't need to follow the same pattern, of course.\nthis.something = Preconditions.checkNotNull(something);", "author": "chanseokoh", "createdAt": "2020-07-22T14:18:04Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/Validator.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.common.base.Preconditions;\n+import java.util.Collection;\n+\n+/**\n+ * Utility helper class to detect errors in parsed yaml values. This class is mostly concerned with\n+ * error message formatting, checking is delegated to guava.\n+ */\n+public class Validator {\n+\n+  /**\n+   * Checks if an object reference is not null.\n+   *\n+   * @param value the object in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   */\n+  public static void checkNotNull(Object value, String propertyName) {\n+    Preconditions.checkNotNull(value, \"Property '\" + propertyName + \"' cannot be null\");", "originalCommit": "6285ec464e8de5756113d636da52ca0260ca6daf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg1NzE2MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2606#discussion_r458857161", "bodyText": "Yeah I thought about that, it doesn't seem necessary here.", "author": "loosebazooka", "createdAt": "2020-07-22T14:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgyNzA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgyODU3OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2606#discussion_r458828578", "bodyText": "@Nullable arg?", "author": "chanseokoh", "createdAt": "2020-07-22T14:20:03Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/Validator.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.common.base.Preconditions;\n+import java.util.Collection;\n+\n+/**\n+ * Utility helper class to detect errors in parsed yaml values. This class is mostly concerned with\n+ * error message formatting, checking is delegated to guava.\n+ */\n+public class Validator {\n+\n+  /**\n+   * Checks if an object reference is not null.\n+   *\n+   * @param value the object in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   */\n+  public static void checkNotNull(Object value, String propertyName) {\n+    Preconditions.checkNotNull(value, \"Property '\" + propertyName + \"' cannot be null\");\n+  }\n+\n+  /**\n+   * Checks if string is null, empty or only whitespace.\n+   *\n+   * @param value the string in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   * @throws IllegalArgumentException if {@code value} is empty or only whitespace\n+   */\n+  public static void checkNotEmpty(String value, String propertyName) {", "originalCommit": "6285ec464e8de5756113d636da52ca0260ca6daf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzMTIwOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2606#discussion_r458831208", "bodyText": "Interesting. So the mapper catches runtime exceptions and wraps it with JsonProcessingException after attaching the underlying runtime exception message?", "author": "chanseokoh", "createdAt": "2020-07-22T14:23:34Z", "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/buildfile/ArchiveLayerSpecTest.java", "diffHunk": "@@ -46,26 +46,78 @@ public void testArchiveLayerSpec_nameRequired() {\n     String data = \"archive: out/archive\";\n \n     try {\n-      archiveLayerSpecMapper.readValue(data, ArchiveLayerSpec.class);\n+      mapper.readValue(data, ArchiveLayerSpec.class);\n       Assert.fail();\n     } catch (JsonProcessingException jpe) {\n       MatcherAssert.assertThat(\n           jpe.getMessage(), CoreMatchers.startsWith(\"Missing required creator property 'name'\"));\n     }\n   }\n \n+  @Test\n+  public void testArchiveLayerSpec_nameNonNull() {\n+    String data = \"name: null\\n\" + \"archive: out/archive\";\n+\n+    try {\n+      mapper.readValue(data, ArchiveLayerSpec.class);\n+      Assert.fail();\n+    } catch (JsonProcessingException jpe) {", "originalCommit": "6285ec464e8de5756113d636da52ca0260ca6daf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg1NzY4Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2606#discussion_r458857683", "bodyText": "Yes, any exception is always wrapped in JsonProcessingException.", "author": "loosebazooka", "createdAt": "2020-07-22T14:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzMTIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzMzY5Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2606#discussion_r458833696", "bodyText": "@Nullable arg?", "author": "chanseokoh", "createdAt": "2020-07-22T14:26:41Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/Validator.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.common.base.Preconditions;\n+import java.util.Collection;\n+\n+/**\n+ * Utility helper class to detect errors in parsed yaml values. This class is mostly concerned with\n+ * error message formatting, checking is delegated to guava.\n+ */\n+public class Validator {\n+\n+  /**\n+   * Checks if an object reference is not null.\n+   *\n+   * @param value the object in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   */\n+  public static void checkNotNull(Object value, String propertyName) {\n+    Preconditions.checkNotNull(value, \"Property '\" + propertyName + \"' cannot be null\");\n+  }\n+\n+  /**\n+   * Checks if string is null, empty or only whitespace.\n+   *\n+   * @param value the string in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   * @throws IllegalArgumentException if {@code value} is empty or only whitespace\n+   */\n+  public static void checkNotEmpty(String value, String propertyName) {\n+    checkNotNull(value, propertyName);\n+    Preconditions.checkArgument(\n+        !value.trim().isEmpty(), \"Property '\" + propertyName + \"' cannot be empty\");\n+  }\n+\n+  /**\n+   * Checks if a collection is null or empty.\n+   *\n+   * @param value the string in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   * @throws IllegalArgumentException if {@code value} is empty\n+   */\n+  public static void checkNotEmpty(Collection<?> value, String propertyName) {", "originalCommit": "6285ec464e8de5756113d636da52ca0260ca6daf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNTE1NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2606#discussion_r458835155", "bodyText": "value.equals(expectedValue) for extra safety since we can't prevent the caller from passing null to expectedValue?", "author": "chanseokoh", "createdAt": "2020-07-22T14:28:42Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/Validator.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.common.base.Preconditions;\n+import java.util.Collection;\n+\n+/**\n+ * Utility helper class to detect errors in parsed yaml values. This class is mostly concerned with\n+ * error message formatting, checking is delegated to guava.\n+ */\n+public class Validator {\n+\n+  /**\n+   * Checks if an object reference is not null.\n+   *\n+   * @param value the object in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   */\n+  public static void checkNotNull(Object value, String propertyName) {\n+    Preconditions.checkNotNull(value, \"Property '\" + propertyName + \"' cannot be null\");\n+  }\n+\n+  /**\n+   * Checks if string is null, empty or only whitespace.\n+   *\n+   * @param value the string in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   * @throws IllegalArgumentException if {@code value} is empty or only whitespace\n+   */\n+  public static void checkNotEmpty(String value, String propertyName) {\n+    checkNotNull(value, propertyName);\n+    Preconditions.checkArgument(\n+        !value.trim().isEmpty(), \"Property '\" + propertyName + \"' cannot be empty\");\n+  }\n+\n+  /**\n+   * Checks if a collection is null or empty.\n+   *\n+   * @param value the string in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @throws NullPointerException if {@code value} is null\n+   * @throws IllegalArgumentException if {@code value} is empty\n+   */\n+  public static void checkNotEmpty(Collection<?> value, String propertyName) {\n+    checkNotNull(value, propertyName);\n+    Preconditions.checkArgument(\n+        !value.isEmpty(), \"Property '\" + propertyName + \"' cannot be an empty collection\");\n+  }\n+\n+  /**\n+   * Checks if string is what is expected.\n+   *\n+   * @param value the string in question\n+   * @param propertyName the equivalent 'yaml' property name\n+   * @param expectedValue the value we expect {@code value} to be\n+   * @throws NullPointerException if {@code value} is null\n+   * @throws IllegalArgumentException if {@code value} is not equal to {@code expectedValue}\n+   */\n+  public static void checkEquals(String value, String propertyName, String expectedValue) {\n+    checkNotNull(value, propertyName);\n+    Preconditions.checkArgument(\n+        expectedValue.equals(value),", "originalCommit": "6285ec464e8de5756113d636da52ca0260ca6daf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e27fb62c65b6ac33a071cb8a0db9e886f8a161d", "url": "https://github.com/GoogleContainerTools/jib/commit/5e27fb62c65b6ac33a071cb8a0db9e886f8a161d", "message": "Remove checkNotNull wrapper, add @Nullable\n\nTurns out nullaway has special code to handle Preconditions\nconditions. Wrapping checkNotNull didn't trigger the correct\nnull analysis. Removing as we don't use it directly. Each\ncheck now does its own nullness check directly.", "committedDate": "2020-07-22T18:38:02Z", "type": "commit"}]}