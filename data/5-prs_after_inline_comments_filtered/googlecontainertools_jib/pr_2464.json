{"pr_number": 2464, "pr_title": "Enable extension-defined custom configuration", "pr_createdAt": "2020-05-13T20:24:43Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2464", "timeline": [{"oid": "30e52b702f5c3a2d589c06171c68ab68bfc890c3", "url": "https://github.com/GoogleContainerTools/jib/commit/30e52b702f5c3a2d589c06171c68ab68bfc890c3", "message": "Add extra config obj to Gradle ext API", "committedDate": "2020-05-08T18:39:08Z", "type": "commit"}, {"oid": "d40f737c357065f89666dcc4097dd67b0ae42122", "url": "https://github.com/GoogleContainerTools/jib/commit/d40f737c357065f89666dcc4097dd67b0ae42122", "message": "Add extra config obj to Maven ext API", "committedDate": "2020-05-08T18:39:35Z", "type": "commit"}, {"oid": "09a021d9ffc469e2ace70340a42f9a0bb960d816", "url": "https://github.com/GoogleContainerTools/jib/commit/09a021d9ffc469e2ace70340a42f9a0bb960d816", "message": "Add Maven util to handle extra config obj", "committedDate": "2020-05-08T18:39:53Z", "type": "commit"}, {"oid": "97d00d324445983dc3310d7a2a717d059bd1032a", "url": "https://github.com/GoogleContainerTools/jib/commit/97d00d324445983dc3310d7a2a717d059bd1032a", "message": "Wire extra config obj", "committedDate": "2020-05-08T18:40:45Z", "type": "commit"}, {"oid": "0b471f4e3003961a44ea640ef63a15c79f2b949f", "url": "https://github.com/GoogleContainerTools/jib/commit/0b471f4e3003961a44ea640ef63a15c79f2b949f", "message": "Fix test compilation errors", "committedDate": "2020-05-08T18:45:13Z", "type": "commit"}, {"oid": "e7037375b4429b8640f7315f5c633cfb03219ba0", "url": "https://github.com/GoogleContainerTools/jib/commit/e7037375b4429b8640f7315f5c633cfb03219ba0", "message": "Fix Javadoc error", "committedDate": "2020-05-08T18:58:33Z", "type": "commit"}, {"oid": "26618e36a5e6ad4fb5ca31d9048206f2a87faa2e", "url": "https://github.com/GoogleContainerTools/jib/commit/26618e36a5e6ad4fb5ca31d9048206f2a87faa2e", "message": "Add extension-defined extra config option", "committedDate": "2020-05-13T18:22:53Z", "type": "commit"}, {"oid": "fa34189f14a0e1aa6da6ff508140a5f9eec49ddb", "url": "https://github.com/GoogleContainerTools/jib/commit/fa34189f14a0e1aa6da6ff508140a5f9eec49ddb", "message": "Merge branch 'master' into extra-extension-config", "committedDate": "2020-05-13T18:51:45Z", "type": "commit"}, {"oid": "50891c73f59b880d26cba188c6c65f483b197f70", "url": "https://github.com/GoogleContainerTools/jib/commit/50891c73f59b880d26cba188c6c65f483b197f70", "message": "Fix compilation errors and style", "committedDate": "2020-05-13T19:21:57Z", "type": "commit"}, {"oid": "73a73c41007d5c8b205f5e157de02eea7ece286f", "url": "https://github.com/GoogleContainerTools/jib/commit/73a73c41007d5c8b205f5e157de02eea7ece286f", "message": "Fix Javadocs", "committedDate": "2020-05-13T19:31:13Z", "type": "commit"}, {"oid": "50df231587f53a291f91171e095e476619d08d64", "url": "https://github.com/GoogleContainerTools/jib/commit/50df231587f53a291f91171e095e476619d08d64", "message": "Fix javadoc", "committedDate": "2020-05-13T20:07:24Z", "type": "commit"}, {"oid": "c77148360bf4cc42ae515e2529c55eb2d4229f9b", "url": "https://github.com/GoogleContainerTools/jib/commit/c77148360bf4cc42ae515e2529c55eb2d4229f9b", "message": "Remove comment", "committedDate": "2020-05-13T20:24:09Z", "type": "commit"}, {"oid": "80e58f142fabe78ae69e7e87a183542bcfebf43e", "url": "https://github.com/GoogleContainerTools/jib/commit/80e58f142fabe78ae69e7e87a183542bcfebf43e", "message": "Remove unnecessary class", "committedDate": "2020-05-13T21:05:13Z", "type": "commit"}, {"oid": "8c30b7b5da9351f8b34ad3b0d3566d810ef2f56f", "url": "https://github.com/GoogleContainerTools/jib/commit/8c30b7b5da9351f8b34ad3b0d3566d810ef2f56f", "message": "Add tests", "committedDate": "2020-05-15T19:46:52Z", "type": "commit"}, {"oid": "4f5326f5eef547d0d97139fc270604fd2926e154", "url": "https://github.com/GoogleContainerTools/jib/commit/4f5326f5eef547d0d97139fc270604fd2926e154", "message": "Fix ErrorProne", "committedDate": "2020-05-15T19:55:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMDc4NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426020784", "bodyText": "I always thought default was designed to be used when extending an interface and maintain backward compatibility. It makes sense here conceptually, but I generally would avoid it?", "author": "loosebazooka", "createdAt": "2020-05-15T20:03:37Z", "path": "jib-gradle-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/gradle/extension/JibGradlePluginExtension.java", "diffHunk": "@@ -29,13 +30,28 @@\n  * the plugin is configured to load the extension class, the Jib plugin extension framework calls\n  * the interface method of the class.\n  */\n-public interface JibGradlePluginExtension extends JibPluginExtension {\n+public interface JibGradlePluginExtension<T> extends JibPluginExtension {\n+\n+  /**\n+   * The type of an custom configuration defined by this extension. The configuration object is\n+   * mapped from {@code <pluginExtensions><pluginExtension><configuration>}. If the extension does\n+   * not wish to define a custom configuration, this method may return {@code Optional#empty()}.\n+   *\n+   * @return type of an extension-specific custom configuration\n+   */\n+  default Optional<Class<T>> getExtraConfigType() {", "originalCommit": "4f5326f5eef547d0d97139fc270604fd2926e154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NjYyMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426056620", "bodyText": "Agreed! Also updated comments.", "author": "chanseokoh", "createdAt": "2020-05-15T21:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMDc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMDk3OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426020979", "bodyText": "maybe this is just config? (vs extraConfig?) I dunno", "author": "loosebazooka", "createdAt": "2020-05-15T20:04:08Z", "path": "jib-gradle-plugin-extension-api/src/main/java/com/google/cloud/tools/jib/gradle/extension/JibGradlePluginExtension.java", "diffHunk": "@@ -44,6 +60,7 @@\n   ContainerBuildPlan extendContainerBuildPlan(\n       ContainerBuildPlan buildPlan,\n       Map<String, String> properties,\n+      Optional<T> extraConfig,", "originalCommit": "4f5326f5eef547d0d97139fc270604fd2926e154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0Njc3OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426046778", "bodyText": "I am fine with config. I think one good effect about saying \"extra\" is to increase the chance of people preferring properties in simple cases? I can always change the name.", "author": "chanseokoh", "createdAt": "2020-05-15T21:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMDk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMTc2NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426021764", "bodyText": "can we add a comment to what's unchecked here?", "author": "loosebazooka", "createdAt": "2020-05-15T20:05:53Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/GradleProjectProperties.java", "diffHunk": "@@ -447,11 +446,46 @@ public JibContainerBuilder runPluginExtensions(\n     }\n   }\n \n-  @Nullable\n-  private JibGradlePluginExtension findConfiguredExtension(\n-      List<JibGradlePluginExtension> extensions, String extensionClass) {\n-    Predicate<JibGradlePluginExtension> matchesClassName =\n-        extension -> extension.getClass().getName().equals(extensionClass);\n-    return extensions.stream().filter(matchesClassName).findFirst().orElse(null);\n+  @SuppressWarnings({\"unchecked\"})", "originalCommit": "4f5326f5eef547d0d97139fc270604fd2926e154", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMjM1Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426022353", "bodyText": "is it possible to find multiple or is findFirst just to speed things up?", "author": "loosebazooka", "createdAt": "2020-05-15T20:07:13Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/GradleProjectProperties.java", "diffHunk": "@@ -447,11 +446,46 @@ public JibContainerBuilder runPluginExtensions(\n     }\n   }\n \n-  @Nullable\n-  private JibGradlePluginExtension findConfiguredExtension(\n-      List<JibGradlePluginExtension> extensions, String extensionClass) {\n-    Predicate<JibGradlePluginExtension> matchesClassName =\n-        extension -> extension.getClass().getName().equals(extensionClass);\n-    return extensions.stream().filter(matchesClassName).findFirst().orElse(null);\n+  @SuppressWarnings({\"unchecked\"})\n+  private <T> ContainerBuildPlan runPluginExtension(\n+      Optional<Class<T>> extraConfigType,\n+      JibGradlePluginExtension<?> extension,\n+      ExtensionConfiguration config,\n+      ContainerBuildPlan buildPlan)\n+      throws JibPluginExtensionException {\n+    T extraConfig = null;\n+    if (extraConfigType.isPresent() && config.getExtraConfiguration().isPresent()) {\n+      try {\n+        Action<T> action = (Action<T>) config.getExtraConfiguration().get();\n+        extraConfig = project.getObjects().newInstance(extraConfigType.get());\n+        action.execute(extraConfig);\n+      } catch (ClassCastException ex) {\n+        throw ex; // TODO(chanseok): provide helpful and actionable message\n+      }\n+    }\n+\n+    return ((JibGradlePluginExtension<T>) extension)\n+        .extendContainerBuildPlan(\n+            buildPlan,\n+            config.getProperties(),\n+            Optional.ofNullable(extraConfig),\n+            () -> project,\n+            new GradleExtensionLogger(this::log));\n+  }\n+\n+  private JibGradlePluginExtension<?> findConfiguredExtension(\n+      List<JibGradlePluginExtension<?>> extensions, ExtensionConfiguration config)\n+      throws JibPluginExtensionException {\n+    Predicate<JibGradlePluginExtension<?>> matchesClassName =\n+        extension -> extension.getClass().getName().equals(config.getExtensionClass());\n+    Optional<JibGradlePluginExtension<?>> found =", "originalCommit": "4f5326f5eef547d0d97139fc270604fd2926e154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0NTk3Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426045976", "bodyText": "It's not possible (or at least it won't happen in practice) to match multiple extensions with the same class name. It means the user has added multiple extension classes of the same name on the classpath. Even if the Service Provider Interface allows that to happen (I am not sure), it's still probably correct to use the first one on the classpath.", "author": "chanseokoh", "createdAt": "2020-05-15T21:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMjM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM5MjQyNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r427392424", "bodyText": "Ah yeah, just wondering if we should detect that and tell the user? or just ignore it.", "author": "loosebazooka", "createdAt": "2020-05-19T15:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMjM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM5ODg3Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r427398873", "bodyText": "Alright, I will check if this is possible and see what to do if so.", "author": "chanseokoh", "createdAt": "2020-05-19T15:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMjk4OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426022988", "bodyText": "as much as I love potato and tomato(and I really really do), maybe these should be more descriptive?\nfooParam barParam", "author": "loosebazooka", "createdAt": "2020-05-15T20:08:37Z", "path": "jib-gradle-plugin/src/test/java/com/google/cloud/tools/jib/gradle/GradleProjectPropertiesExtensionTest.java", "diffHunk": "@@ -101,23 +117,83 @@ private FooExtensionConfig(Map<String, String> properties) {\n     public String getExtensionClass() {\n       return extensionClass;\n     }\n+\n+    @Override\n+    public Optional<Object> getExtraConfiguration() {\n+      return Optional.ofNullable(extraConfig);\n+    }\n+  }\n+\n+  private static class FooExtensionConfig extends BaseExtensionConfig<ExtensionDefinedFooConfig> {\n+\n+    private FooExtensionConfig() {\n+      super(FooExtension.class.getName(), Collections.emptyMap(), null);\n+    }\n+\n+    private FooExtensionConfig(Map<String, String> properties) {\n+      super(FooExtension.class.getName(), properties, null);\n+    }\n+\n+    private FooExtensionConfig(ExtensionDefinedFooConfig extraConfig) {\n+      super(\n+          FooExtension.class.getName(),\n+          Collections.emptyMap(),\n+          new Action<ExtensionDefinedFooConfig>() {\n+            @Override\n+            public void execute(ExtensionDefinedFooConfig instance) {\n+              instance.potato = extraConfig.potato;\n+            }\n+          });\n+    }\n   }\n \n-  private static class BarExtensionConfig extends FooExtensionConfig {\n+  private static class BarExtensionConfig extends BaseExtensionConfig<ExtensionDefinedBarConfig> {\n \n     private BarExtensionConfig() {\n-      super(BarExtension.class.getName());\n+      super(BarExtension.class.getName(), Collections.emptyMap(), null);\n+    }\n+\n+    private BarExtensionConfig(ExtensionDefinedBarConfig extraConfig) {\n+      super(\n+          BarExtension.class.getName(),\n+          Collections.emptyMap(),\n+          new Action<ExtensionDefinedBarConfig>() {\n+            @Override\n+            public void execute(ExtensionDefinedBarConfig instance) {\n+              instance.tomato = extraConfig.tomato;\n+            }\n+          });\n+    }\n+  }\n+\n+  // Not to be confused with Jib's plugin extension config. This class is for an extension-defined\n+  // config specific to a third-party extension.\n+  private static class ExtensionDefinedFooConfig {\n+\n+    private String potato;", "originalCommit": "4f5326f5eef547d0d97139fc270604fd2926e154", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMzIwMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2464#discussion_r426023203", "bodyText": "comment on unchecked?", "author": "loosebazooka", "createdAt": "2020-05-15T20:09:12Z", "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java", "diffHunk": "@@ -580,11 +576,44 @@ public JibContainerBuilder runPluginExtensions(\n     }\n   }\n \n-  @Nullable\n-  private JibMavenPluginExtension findConfiguredExtension(\n-      List<JibMavenPluginExtension> extensions, String extensionClass) {\n-    Predicate<JibMavenPluginExtension> matchesClassName =\n-        extension -> extension.getClass().getName().equals(extensionClass);\n-    return extensions.stream().filter(matchesClassName).findFirst().orElse(null);\n+  @SuppressWarnings({\"unchecked\"})", "originalCommit": "4f5326f5eef547d0d97139fc270604fd2926e154", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aa7c0bd839bcb682e0f87b607004a0ad5dc606c0", "url": "https://github.com/GoogleContainerTools/jib/commit/aa7c0bd839bcb682e0f87b607004a0ad5dc606c0", "message": "potato -> fooParam, tomato -> barParam", "committedDate": "2020-05-15T20:55:47Z", "type": "commit"}, {"oid": "5ef3f360c1656146e708891c39a4217ded3e0f52", "url": "https://github.com/GoogleContainerTools/jib/commit/5ef3f360c1656146e708891c39a4217ded3e0f52", "message": "Add comments about suppressing class cast warnings", "committedDate": "2020-05-15T20:58:37Z", "type": "commit"}, {"oid": "a48ba9f7311d9e99481d42b38c8f8fa675f48518", "url": "https://github.com/GoogleContainerTools/jib/commit/a48ba9f7311d9e99481d42b38c8f8fa675f48518", "message": "No default implementation in interface", "committedDate": "2020-05-15T21:31:10Z", "type": "commit"}, {"oid": "a79c4b8b00b41423c66df2983bb3ba1581a79411", "url": "https://github.com/GoogleContainerTools/jib/commit/a79c4b8b00b41423c66df2983bb3ba1581a79411", "message": "Update Gradle comment", "committedDate": "2020-05-15T21:55:06Z", "type": "commit"}, {"oid": "223cf5fc07cee4782f07e289ed3c8c83e8b7cfe8", "url": "https://github.com/GoogleContainerTools/jib/commit/223cf5fc07cee4782f07e289ed3c8c83e8b7cfe8", "message": "Merge branch 'master' into extra-extension-config", "committedDate": "2020-05-18T15:50:55Z", "type": "commit"}]}