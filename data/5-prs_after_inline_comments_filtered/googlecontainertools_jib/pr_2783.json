{"pr_number": 2783, "pr_title": "Fix platform configuration in Gradle plugin", "pr_createdAt": "2020-09-23T22:17:41Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2783", "timeline": [{"oid": "5eede51c28f42715ba96baf215cf529aabf35902", "url": "https://github.com/GoogleContainerTools/jib/commit/5eede51c28f42715ba96baf215cf529aabf35902", "message": "Fix platform configuration in Gradle plugin", "committedDate": "2020-09-23T22:13:37Z", "type": "commit"}, {"oid": "d97224ce6ff00d9e2b3b969671609dc34dac3e98", "url": "https://github.com/GoogleContainerTools/jib/commit/d97224ce6ff00d9e2b3b969671609dc34dac3e98", "message": "Remove dead code", "committedDate": "2020-09-23T22:16:44Z", "type": "commit"}, {"oid": "1257b11ec821aac1ba963eb824fec5475dfad8af", "url": "https://github.com/GoogleContainerTools/jib/commit/1257b11ec821aac1ba963eb824fec5475dfad8af", "message": "CHANGELOG", "committedDate": "2020-09-23T22:21:37Z", "type": "commit"}, {"oid": "a80b6daeb85f297aba9a5650a9490fe88727e8d4", "url": "https://github.com/GoogleContainerTools/jib/commit/a80b6daeb85f297aba9a5650a9490fe88727e8d4", "message": "code style", "committedDate": "2020-09-23T22:30:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MzQyMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2783#discussion_r493973420", "bodyText": "It does feel a little weird that a getter is mutating things.", "author": "loosebazooka", "createdAt": "2020-09-24T00:34:48Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/BaseImageParameters.java", "diffHunk": "@@ -35,23 +35,32 @@\n   private final PlatformParametersSpec platformParametersSpec;\n   private final ListProperty<PlatformParameters> platforms;\n \n+  private final ObjectFactory objectFactory;\n+\n   @Inject\n   public BaseImageParameters(ObjectFactory objectFactory) {\n+    this.objectFactory = objectFactory;\n     auth = objectFactory.newInstance(AuthParameters.class, \"from.auth\");\n     platforms = objectFactory.listProperty(PlatformParameters.class).empty();\n     platformParametersSpec =\n         objectFactory.newInstance(PlatformParametersSpec.class, objectFactory, platforms);\n-\n-    PlatformParameters platform = new PlatformParameters();\n-    platform.setOs(\"linux\");\n-    platform.setArchitecture(\"amd64\");\n-    platforms.add(platform);\n   }\n \n   @Nested\n   @Optional\n   public ListProperty<PlatformParameters> getPlatforms() {\n-    return platforms;\n+    if (!platforms.get().isEmpty()) {", "originalCommit": "a80b6daeb85f297aba9a5650a9490fe88727e8d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI1NTI1MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2783#discussion_r494255250", "bodyText": "could we just delegate default setting to a lower level of the system?", "author": "loosebazooka", "createdAt": "2020-09-24T11:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3MDE0MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2783#discussion_r494370140", "bodyText": "Technically it doesn't mutate an internal state, but it's true the class is no longer a POJO or bean. I also didn't like it and wondered other solutions yesterday. Setting the default at other levels could be another way, but it also had some cons.\nToday, I think I found a better way than these: start the class with the default value as before, but only reset it when the user specifies platforms {}. This behavior is also more or less similar to how it works in Maven; if nothing is defined, Maven assumes amd64/linux, but as soon as the user specifies <platforms>, it becomes an empty list.. What do you think?", "author": "chanseokoh", "createdAt": "2020-09-24T14:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3NjM1Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2783#discussion_r494376356", "bodyText": "Hrmm, I just realized I don't understand how this affects verifying image compatibility? Do we have code somewhere that verifies and image matches the specified platform?", "author": "loosebazooka", "createdAt": "2020-09-24T14:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4NjA4Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2783#discussion_r494386083", "bodyText": "#2781 and this PR have nothing to do with verifying image platforms. The issue was that defining\njib.from.platforms {\n  platform {\n    architecture = 'non-amd64'\n    os = '...'\n  }\n}\n\nincorrectly resulted in two platforms configured: the configured one plus the default amd64/linux. This was because platform { ...} just called ListProperty.add().", "author": "chanseokoh", "createdAt": "2020-09-24T14:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MzQyMA=="}], "type": "inlineReview"}, {"oid": "d64c1ecb24ac47b3063e2e598334e4bc4ec959a2", "url": "https://github.com/GoogleContainerTools/jib/commit/d64c1ecb24ac47b3063e2e598334e4bc4ec959a2", "message": "Reset default platform when given \"platforms\" action", "committedDate": "2020-09-24T14:27:29Z", "type": "commit"}, {"oid": "939c4ef72eda3489883f7b2116de10847e777276", "url": "https://github.com/GoogleContainerTools/jib/commit/939c4ef72eda3489883f7b2116de10847e777276", "message": "Remove unused variable", "committedDate": "2020-09-24T14:35:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3MTQ2Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2783#discussion_r494371467", "bodyText": "empty() turns out to be unnecessary.", "author": "chanseokoh", "createdAt": "2020-09-24T14:35:54Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/BaseImageParameters.java", "diffHunk": "@@ -38,14 +38,14 @@\n   @Inject\n   public BaseImageParameters(ObjectFactory objectFactory) {\n     auth = objectFactory.newInstance(AuthParameters.class, \"from.auth\");\n-    platforms = objectFactory.listProperty(PlatformParameters.class).empty();\n+    platforms = objectFactory.listProperty(PlatformParameters.class);", "originalCommit": "939c4ef72eda3489883f7b2116de10847e777276", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}