{"pr_number": 2780, "pr_title": "Don't schedule multiple threads downloading same base image layers in StepsRunner", "pr_createdAt": "2020-09-22T20:08:42Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2780", "timeline": [{"oid": "89d764d42548da9fbea69b4143c53048fc939101", "url": "https://github.com/GoogleContainerTools/jib/commit/89d764d42548da9fbea69b4143c53048fc939101", "message": "Switch key and value of builtImagesAndBaseImages", "committedDate": "2020-09-18T14:31:34Z", "type": "commit"}, {"oid": "31a5434f5d8a92a0260d87d6f5a88254a1a38719", "url": "https://github.com/GoogleContainerTools/jib/commit/31a5434f5d8a92a0260d87d6f5a88254a1a38719", "message": "Change key of builtImagesAndContainerConfigurationPushResults", "committedDate": "2020-09-18T14:54:35Z", "type": "commit"}, {"oid": "d1b65186033271436f48ece352a2b615720ac1ce", "url": "https://github.com/GoogleContainerTools/jib/commit/d1b65186033271436f48ece352a2b615720ac1ce", "message": "Switch order of fields in StepResults", "committedDate": "2020-09-18T14:58:47Z", "type": "commit"}, {"oid": "fe9d484500840ad7001332f127f8bf42c7fb588c", "url": "https://github.com/GoogleContainerTools/jib/commit/fe9d484500840ad7001332f127f8bf42c7fb588c", "message": "Refactor StepsRunner for consistent loop pattern", "committedDate": "2020-09-18T15:39:51Z", "type": "commit"}, {"oid": "a1dfffff285e82b01efae24787f61c6e71a9e56f", "url": "https://github.com/GoogleContainerTools/jib/commit/a1dfffff285e82b01efae24787f61c6e71a9e56f", "message": "Assign jib.to.tags to value of type Set to fix failing integration test", "committedDate": "2020-09-18T17:26:52Z", "type": "commit"}, {"oid": "3064f6c6bab376363f523252b4cfd4663f09692d", "url": "https://github.com/GoogleContainerTools/jib/commit/3064f6c6bab376363f523252b4cfd4663f09692d", "message": "Merge branch 'master' into dedup-base-image-layers-refactor4", "committedDate": "2020-09-18T19:19:23Z", "type": "commit"}, {"oid": "55eeb1da853ccb5a677101b2d62ec535bfffe114", "url": "https://github.com/GoogleContainerTools/jib/commit/55eeb1da853ccb5a677101b2d62ec535bfffe114", "message": "Clean up", "committedDate": "2020-09-18T19:23:21Z", "type": "commit"}, {"oid": "549aa27ee111aed7131d1b6671ce40b4040facb5", "url": "https://github.com/GoogleContainerTools/jib/commit/549aa27ee111aed7131d1b6671ce40b4040facb5", "message": "Merge branch 'dedup-base-image-layers-refactor4' of https://github.com/GoogleContainerTools/jib into dedup-base-image-layers-refactor4", "committedDate": "2020-09-18T19:23:28Z", "type": "commit"}, {"oid": "1a6b7c516bed897675c0f726f2f9f9a879813fd3", "url": "https://github.com/GoogleContainerTools/jib/commit/1a6b7c516bed897675c0f726f2f9f9a879813fd3", "message": "Clean up", "committedDate": "2020-09-18T19:58:12Z", "type": "commit"}, {"oid": "dafceccbabbad85e33906ed8a21deaedcf18bb80", "url": "https://github.com/GoogleContainerTools/jib/commit/dafceccbabbad85e33906ed8a21deaedcf18bb80", "message": "Add setTag method that accepts a list", "committedDate": "2020-09-18T20:03:16Z", "type": "commit"}, {"oid": "4e27188b7fa677b5d05c540ddb482b918aeee6de", "url": "https://github.com/GoogleContainerTools/jib/commit/4e27188b7fa677b5d05c540ddb482b918aeee6de", "message": "revert change to build.gradle", "committedDate": "2020-09-18T20:05:11Z", "type": "commit"}, {"oid": "78221951f100aeaa55e20615ea8ad7c2f8fe187c", "url": "https://github.com/GoogleContainerTools/jib/commit/78221951f100aeaa55e20615ea8ad7c2f8fe187c", "message": "Do not push duplicate base image layers", "committedDate": "2020-09-18T20:43:07Z", "type": "commit"}, {"oid": "046a35710df64062628c55c272db055be9be6b59", "url": "https://github.com/GoogleContainerTools/jib/commit/046a35710df64062628c55c272db055be9be6b59", "message": "Merge remote-tracking branch 'origin/fix-tests' into dedup-base-image-layers-new-world", "committedDate": "2020-09-18T20:43:38Z", "type": "commit"}, {"oid": "1bd4a51dd64b4bc1378cf3adcbd07ac4a10dd71f", "url": "https://github.com/GoogleContainerTools/jib/commit/1bd4a51dd64b4bc1378cf3adcbd07ac4a10dd71f", "message": "Fix progress dispatcher", "committedDate": "2020-09-18T21:10:47Z", "type": "commit"}, {"oid": "d81a9961a81e94e7bf6023b5d73c71b7d660bb31", "url": "https://github.com/GoogleContainerTools/jib/commit/d81a9961a81e94e7bf6023b5d73c71b7d660bb31", "message": "Close ProgressEventDispatchers", "committedDate": "2020-09-18T21:18:03Z", "type": "commit"}, {"oid": "bf6c2376465413045e0ac9804a5ea1a7a7991fb8", "url": "https://github.com/GoogleContainerTools/jib/commit/bf6c2376465413045e0ac9804a5ea1a7a7991fb8", "message": "Remove unnecessary Verify.verifyNotNull", "committedDate": "2020-09-21T14:40:03Z", "type": "commit"}, {"oid": "6494c6abd618346a2bdbbe66c95ca34a4986401d", "url": "https://github.com/GoogleContainerTools/jib/commit/6494c6abd618346a2bdbbe66c95ca34a4986401d", "message": "Merge branch 'master' into dedup-base-image-layers-refactor5", "committedDate": "2020-09-21T14:48:14Z", "type": "commit"}, {"oid": "d42f7bcd969fbea37fac47f14886a080534dc1e9", "url": "https://github.com/GoogleContainerTools/jib/commit/d42f7bcd969fbea37fac47f14886a080534dc1e9", "message": "Merge remote-tracking branch 'origin/master' into dedup-base-image-layers-refactor5", "committedDate": "2020-09-21T15:18:03Z", "type": "commit"}, {"oid": "3b99a252e4a8420e6f2143380d36787cec58b488", "url": "https://github.com/GoogleContainerTools/jib/commit/3b99a252e4a8420e6f2143380d36787cec58b488", "message": "Merge branch 'dedup-base-image-layers-refactor5' of https://github.com/GoogleContainerTools/jib into dedup-base-image-layers-refactor5", "committedDate": "2020-09-21T15:18:17Z", "type": "commit"}, {"oid": "b5b774b40459d80c18da90db7af3e732f76b2694", "url": "https://github.com/GoogleContainerTools/jib/commit/b5b774b40459d80c18da90db7af3e732f76b2694", "message": "Merge branch 'dedup-base-image-layers-refactor5' into dedup-base-image-layers-new-world", "committedDate": "2020-09-21T15:36:11Z", "type": "commit"}, {"oid": "0db06daf661695e67754d76527b705a53082e8cb", "url": "https://github.com/GoogleContainerTools/jib/commit/0db06daf661695e67754d76527b705a53082e8cb", "message": "Merge branch 'master' into dedup-base-image-layers-new-world", "committedDate": "2020-09-22T14:41:20Z", "type": "commit"}, {"oid": "f775c51479479ae5b6e7b780dfd8c008688131d8", "url": "https://github.com/GoogleContainerTools/jib/commit/f775c51479479ae5b6e7b780dfd8c008688131d8", "message": "Add test", "committedDate": "2020-09-22T17:36:53Z", "type": "commit"}, {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729", "url": "https://github.com/GoogleContainerTools/jib/commit/ed31e0dcc41d0653a57371ce743816c96a997729", "message": "Refactor to accept progressDispatcherFactory", "committedDate": "2020-09-22T17:57:05Z", "type": "commit"}, {"oid": "f0c34fcdc58ce6f58183e755f37eaa238b7260f0", "url": "https://github.com/GoogleContainerTools/jib/commit/f0c34fcdc58ce6f58183e755f37eaa238b7260f0", "message": "Create a concrete ListeningExecutorService mock", "committedDate": "2020-09-22T19:14:24Z", "type": "commit"}, {"oid": "759233b992d60668dd81581585edc8720651cac0", "url": "https://github.com/GoogleContainerTools/jib/commit/759233b992d60668dd81581585edc8720651cac0", "message": "Merge branch 'dedup-base-image-layers-refactor6' into dedup-base-image-layers-new-world", "committedDate": "2020-09-22T19:15:54Z", "type": "commit"}, {"oid": "db776c218cea02149c93291bd5f2ffba88cf620b", "url": "https://github.com/GoogleContainerTools/jib/commit/db776c218cea02149c93291bd5f2ffba88cf620b", "message": "Enhance test", "committedDate": "2020-09-22T19:25:18Z", "type": "commit"}, {"oid": "75f52fd4e6443e0e1e07dfe57c8bbbc7641d4559", "url": "https://github.com/GoogleContainerTools/jib/commit/75f52fd4e6443e0e1e07dfe57c8bbbc7641d4559", "message": "comment", "committedDate": "2020-09-23T14:04:04Z", "type": "commit"}, {"oid": "b86d4f17cfcc27ab21c965c53c24f8b6200ff51f", "url": "https://github.com/GoogleContainerTools/jib/commit/b86d4f17cfcc27ab21c965c53c24f8b6200ff51f", "message": "Merge branch 'master' into dedup-base-image-layers-new-world", "committedDate": "2020-09-23T14:13:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MDc0NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2780#discussion_r493970745", "bodyText": "The instructions seem to indicate maybe a different approach, but I don't know if you already considered that.\n\nUse TestingExecutors.sameThreadScheduledExecutor, or wrap a real Executor from java.util.concurrent.Executors with MoreExecutors.listeningDecorator", "author": "loosebazooka", "createdAt": "2020-09-24T00:24:58Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/StepsRunnerTest.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.DescriptorDigest;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.steps.PullBaseImageStep.ImagesAndRegistryClient;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.DigestOnlyLayer;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.ForwardingExecutorService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.ListeningExecutorService;\n+import java.security.DigestException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link StepsRunner}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class StepsRunnerTest {\n+\n+  // ListeningExecutorService is annotated with @DoNotMock, so define a concrete class.", "originalCommit": "b86d4f17cfcc27ab21c965c53c24f8b6200ff51f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3OTA1NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2780#discussion_r494379054", "bodyText": "I saw the comment, but I think it cannot apply to what I'm trying to achieve. TestingExecutors.sameThreadScheduledExecutor and MoreExecutors.listeningDecorator actually executes given tasks, whereas here I want to mock it at a higher level to simulate tasks.\nI tried quite a lot of time to find the simplest way to mock ListeningExecutorService.submit(), but this code was the shortest I could get so far.", "author": "chanseokoh", "createdAt": "2020-09-24T14:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MDc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MjI3Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2780#discussion_r493972276", "bodyText": "I thought that maybe this could have threading issues, but we never call this in parallel right? Is there any value in marking this not threadsafe?", "author": "loosebazooka", "createdAt": "2020-09-24T00:30:19Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -306,36 +311,61 @@ private void obtainBaseImagesLayers(\n                       \"scheduling obtaining base images layers\",\n                       results.baseImagesAndRegistryClient.get().images.size())) {\n \n+                Map<DescriptorDigest, Future<PreparedLayer>> preparedLayersCache = new HashMap<>();\n                 Map<Image, List<Future<PreparedLayer>>> baseImagesAndLayers = new HashMap<>();\n                 for (Image baseImage : results.baseImagesAndRegistryClient.get().images) {\n                   List<Future<PreparedLayer>> layers =\n                       obtainBaseImageLayers(\n-                          baseImage, layersRequiredLocally, progressDispatcher.newChildProducer());\n+                          baseImage,\n+                          layersRequiredLocally,\n+                          preparedLayersCache,\n+                          progressDispatcher.newChildProducer());\n                   baseImagesAndLayers.put(baseImage, layers);\n                 }\n                 return baseImagesAndLayers;\n               }\n             });\n   }\n \n-  private List<Future<PreparedLayer>> obtainBaseImageLayers(\n+  @VisibleForTesting\n+  List<Future<PreparedLayer>> obtainBaseImageLayers(", "originalCommit": "b86d4f17cfcc27ab21c965c53c24f8b6200ff51f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3NjM1NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2780#discussion_r494376354", "bodyText": "Added a comment\n// This method updates the given \"preparedLayersCache\" and should not be called concurrently.\n\n. (FYI, @NotThreadSafe can only be applied to a class.)\nThis non-blocking method is called only by a single thread task inside obtainBaseImagesLayers().", "author": "chanseokoh", "createdAt": "2020-09-24T14:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MjI3Ng=="}], "type": "inlineReview"}, {"oid": "eb953516b271cd37a637601ee251f7041b8687a5", "url": "https://github.com/GoogleContainerTools/jib/commit/eb953516b271cd37a637601ee251f7041b8687a5", "message": "Add comment on obtainBaseImageLayers()", "committedDate": "2020-09-24T14:39:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwMzIwMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2780#discussion_r494403203", "bodyText": "Just a thought: we currently check to see if the layer already exists before pushing a new one, but what would we do if we needed to update a layer?/ Can base image layers be updated?", "author": "mpeddada1", "createdAt": "2020-09-24T15:17:21Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -306,36 +311,62 @@ private void obtainBaseImagesLayers(\n                       \"scheduling obtaining base images layers\",\n                       results.baseImagesAndRegistryClient.get().images.size())) {\n \n+                Map<DescriptorDigest, Future<PreparedLayer>> preparedLayersCache = new HashMap<>();\n                 Map<Image, List<Future<PreparedLayer>>> baseImagesAndLayers = new HashMap<>();\n                 for (Image baseImage : results.baseImagesAndRegistryClient.get().images) {\n                   List<Future<PreparedLayer>> layers =\n                       obtainBaseImageLayers(\n-                          baseImage, layersRequiredLocally, progressDispatcher.newChildProducer());\n+                          baseImage,\n+                          layersRequiredLocally,\n+                          preparedLayersCache,\n+                          progressDispatcher.newChildProducer());\n                   baseImagesAndLayers.put(baseImage, layers);\n                 }\n                 return baseImagesAndLayers;\n               }\n             });\n   }\n \n-  private List<Future<PreparedLayer>> obtainBaseImageLayers(\n+  // This method updates the given \"preparedLayersCache\" and should not be called concurrently.\n+  @VisibleForTesting\n+  List<Future<PreparedLayer>> obtainBaseImageLayers(\n       Image baseImage,\n       boolean layersRequiredLocally,\n+      Map<DescriptorDigest, Future<PreparedLayer>> preparedLayersCache,\n       ProgressEventDispatcher.Factory progressDispatcherFactory)\n       throws InterruptedException, ExecutionException {\n-    return scheduleCallables(\n-        layersRequiredLocally\n-            ? ObtainBaseImageLayerStep.makeListForForcedDownload(\n-                buildContext,\n-                progressDispatcherFactory,\n-                baseImage,\n-                results.baseImagesAndRegistryClient.get().registryClient)\n-            : ObtainBaseImageLayerStep.makeListForSelectiveDownload(\n-                buildContext,\n-                progressDispatcherFactory,\n-                baseImage,\n-                results.baseImagesAndRegistryClient.get().registryClient,\n-                results.targetRegistryClient.get()));\n+    List<Future<PreparedLayer>> preparedLayers = new ArrayList<>();\n+\n+    try (ProgressEventDispatcher progressDispatcher =\n+        progressDispatcherFactory.create(\n+            \"launching base image layer pullers\", baseImage.getLayers().size())) {\n+      for (Layer layer : baseImage.getLayers()) {\n+        DescriptorDigest digest = layer.getBlobDescriptor().getDigest();\n+        Future<PreparedLayer> preparedLayer = preparedLayersCache.get(digest);\n+\n+        if (preparedLayer != null) {\n+          progressDispatcher.dispatchProgress(1);", "originalCommit": "eb953516b271cd37a637601ee251f7041b8687a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxMTcyMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2780#discussion_r494411723", "bodyText": "Not sure I understand your point. To clarify a few things,\n\nThis section of code is to download a base image layer.\nIn a later stage, base image layers need to be pushed to a target registry (but only those layers missing in the registry).\nA layer is just a block of bytes (blob) identified and addressed by a SHA digest. And every blob is immutable and content-addressable. There's nothing like \"updating\" a blob or an existing image. If the content of a blob or an \"image\" is different, it is a new blob or a new image with different addresses.", "author": "chanseokoh", "createdAt": "2020-09-24T15:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwMzIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxODQwOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2780#discussion_r494418408", "bodyText": "I see, thanks for clarifying! This really clears up some of the key concepts I was missing:)", "author": "mpeddada1", "createdAt": "2020-09-24T15:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwMzIwMw=="}], "type": "inlineReview"}]}