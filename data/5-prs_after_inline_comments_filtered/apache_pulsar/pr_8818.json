{"pr_number": 8818, "pr_title": "fix get partition metadata problem for a non-existed topic", "pr_createdAt": "2020-12-03T14:49:52Z", "pr_url": "https://github.com/apache/pulsar/pull/8818", "timeline": [{"oid": "78226eeda2f0d11d765ca260c238cc999ad86e47", "url": "https://github.com/apache/pulsar/commit/78226eeda2f0d11d765ca260c238cc999ad86e47", "message": "update invoke", "committedDate": "2020-12-04T02:07:21Z", "type": "forcePushed"}, {"oid": "b93363d41afd9988a6fd1878c1b5b89df1e379fa", "url": "https://github.com/apache/pulsar/commit/b93363d41afd9988a6fd1878c1b5b89df1e379fa", "message": "fix get partitionMeta error for non-exist topic", "committedDate": "2020-12-04T10:56:39Z", "type": "forcePushed"}, {"oid": "784f0ade02f3b6dbd57735f19200d6272e8f0321", "url": "https://github.com/apache/pulsar/commit/784f0ade02f3b6dbd57735f19200d6272e8f0321", "message": "fix get partitionMeta error for non-exist topic", "committedDate": "2020-12-04T11:28:38Z", "type": "forcePushed"}, {"oid": "533e000c961d78dcf82aca459b65076d2f298f35", "url": "https://github.com/apache/pulsar/commit/533e000c961d78dcf82aca459b65076d2f298f35", "message": "fix error when allow auto create topic", "committedDate": "2020-12-07T16:12:56Z", "type": "forcePushed"}, {"oid": "88fd546b02bc37eb8303e87e7af6bdbd8179682d", "url": "https://github.com/apache/pulsar/commit/88fd546b02bc37eb8303e87e7af6bdbd8179682d", "message": "checkstyle fix", "committedDate": "2020-12-16T14:50:04Z", "type": "forcePushed"}, {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361", "url": "https://github.com/apache/pulsar/commit/6e9ab2f97c9e8a05902f93ea440f8297bf604361", "message": "create topic if allow auto create and return related metadata", "committedDate": "2020-12-24T06:28:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyOTg4NA==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548529884", "bodyText": "Could you please clarify why throw (RestException) e.getCause() does not work here? If e.getCause is instance of RestException, I think we can throw it directly. I might be missing something here.", "author": "codelipenghui", "createdAt": "2020-12-24T13:25:18Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -702,6 +702,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadata(PulsarSe\n             return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {\n+                    throw new org.apache.pulsar.broker.web.RestException(Response.Status.NOT_FOUND, \"Topic not exist.\");\n+                }", "originalCommit": "6e9ab2f97c9e8a05902f93ea440f8297bf604361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODgyMzk2Nw==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548823967", "bodyText": "I'll check this PR and push later.", "author": "aloyszhang", "createdAt": "2020-12-25T07:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyOTg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE4MzYzNg==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r549183636", "bodyText": "Thanks @aloyszhang", "author": "codelipenghui", "createdAt": "2020-12-28T00:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyOTg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyOTk2Mw==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548529963", "bodyText": "Same as the above comment.", "author": "codelipenghui", "createdAt": "2020-12-24T13:25:34Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -715,6 +720,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadataCheckAllo\n                     .get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {\n+                    throw new org.apache.pulsar.broker.web.RestException(Response.Status.NOT_FOUND, \"Topic not exist.\");\n+                }", "originalCommit": "6e9ab2f97c9e8a05902f93ea440f8297bf604361", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMTY1Mg==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548531652", "bodyText": "I think it's not correct handling here, If got 404 here, it means the partitioned metadata does not exist right? If the partitioned metadata does exist, why should we prevent the non-partitioned topic creation?", "author": "codelipenghui", "createdAt": "2020-12-24T13:32:44Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -456,10 +456,17 @@ protected void internalCreateNonPartitionedTopic(boolean authoritative) {\n \n         validateTopicOwnership(topicName, authoritative);\n \n-        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n-        if (partitionMetadata.partitions > 0) {\n-            log.warn(\"[{}] Partitioned topic with the same name already exists {}\", clientAppId(), topicName);\n-            throw new RestException(Status.CONFLICT, \"This topic already exists\");\n+        PartitionedTopicMetadata partitionMetadata = null;\n+        try {\n+            partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n+            if (partitionMetadata.partitions > 0) {\n+                log.warn(\"[{}] Partitioned topic with the same name already exists {}\", clientAppId(), topicName);\n+                throw new RestException(Status.CONFLICT, \"This topic already exists\");\n+            }\n+        } catch (RestException restException) {\n+            if (Status.NOT_FOUND.getStatusCode() != restException.getResponse().getStatus()) {\n+                throw restException;", "originalCommit": "6e9ab2f97c9e8a05902f93ea440f8297bf604361", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMjMzNQ==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548532335", "bodyText": "What is the difference between these changes? Why we change the thenCompose to whenComplete?", "author": "codelipenghui", "createdAt": "2020-12-24T13:35:36Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/namespace/NamespaceService.java", "diffHunk": "@@ -1174,13 +1174,19 @@ public ServiceUnitId getServiceUnitId(TopicName topicName) throws Exception {\n     }\n \n     private CompletableFuture<List<String>> getPartitionsForTopic(TopicName topicName) {\n-        return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).thenCompose(meta -> {\n+        CompletableFuture<List<String>> future = new CompletableFuture<>();\n+        pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).whenComplete((meta, t) -> {\n+            if (t != null) {\n+                future.completeExceptionally(t);\n+                return;\n+            }\n             List<String> result = Lists.newArrayList();\n             for (int i = 0; i < meta.partitions; i++) {\n                 result.add(topicName.getPartition(i).toString());\n             }\n-            return CompletableFuture.completedFuture(result);\n+            future.complete(result);\n         });\n+        return future;", "originalCommit": "6e9ab2f97c9e8a05902f93ea440f8297bf604361", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxOTcxNA==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548919714", "bodyText": "Please do not rely on strings, can we test the actual class?", "author": "eolivelli", "createdAt": "2020-12-25T22:57:41Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -702,6 +702,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadata(PulsarSe\n             return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {", "originalCommit": "6e9ab2f97c9e8a05902f93ea440f8297bf604361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2NzkzNQ==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548967935", "bodyText": "Yes, I'll change this PR and push again.", "author": "aloyszhang", "createdAt": "2020-12-26T10:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxOTcxNA=="}], "type": "inlineReview"}, {"oid": "c6196592cf4eb2d59ac6f08caac9ccf56efe2143", "url": "https://github.com/apache/pulsar/commit/c6196592cf4eb2d59ac6f08caac9ccf56efe2143", "message": "add auto create check, only throw exception when not allow topic auto-create", "committedDate": "2021-01-01T10:42:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk0ODcwMA==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r550948700", "bodyText": "Here is not covered by tests? I noticed the tests only cover the checkAllowAutoCreation=false, could you please help add a test for cover checkAllowAutoCreation=true?", "author": "codelipenghui", "createdAt": "2021-01-03T03:06:40Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -376,6 +377,25 @@ protected void validatePartitionedTopicMetadata(String tenant, String namespace,\n         }\n     }\n \n+    protected void validateTopicExistedAndCheckAllowAutoCreation(String tenant, String namespace,\n+                                                                 String encodedTopic, boolean checkAllowAutoCreation) {\n+        try {\n+            PartitionedTopicMetadata partitionedTopicMetadata =\n+                    pulsar().getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n+            if (partitionedTopicMetadata.partitions < 1) {\n+                if (!pulsar().getNamespaceService().checkTopicExists(topicName).get()\n+                        && checkAllowAutoCreation", "originalCommit": "c6196592cf4eb2d59ac6f08caac9ccf56efe2143", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA4MTExMQ==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r551081111", "bodyText": "I'll add test case to protect this part of code.", "author": "aloyszhang", "createdAt": "2021-01-04T01:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk0ODcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM2ODAwMw==", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r551368003", "bodyText": "Thanks", "author": "codelipenghui", "createdAt": "2021-01-04T15:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk0ODcwMA=="}], "type": "inlineReview"}, {"oid": "af52cf38d8e103fe8ec6615bb33bbe1a38bd4b01", "url": "https://github.com/apache/pulsar/commit/af52cf38d8e103fe8ec6615bb33bbe1a38bd4b01", "message": "add method to validate whether topic is exist when get partitioned metadata", "committedDate": "2021-01-04T06:58:48Z", "type": "forcePushed"}, {"oid": "9af1bf3039a58c63736570b858e01e5928b58a3d", "url": "https://github.com/apache/pulsar/commit/9af1bf3039a58c63736570b858e01e5928b58a3d", "message": "add method to validate whether topic is exist when get partitioned metadata", "committedDate": "2021-01-04T07:09:14Z", "type": "commit"}, {"oid": "9af1bf3039a58c63736570b858e01e5928b58a3d", "url": "https://github.com/apache/pulsar/commit/9af1bf3039a58c63736570b858e01e5928b58a3d", "message": "add method to validate whether topic is exist when get partitioned metadata", "committedDate": "2021-01-04T07:09:14Z", "type": "forcePushed"}, {"oid": "1d82d97bdbbcaa52ddca7c161c4473e42e12f553", "url": "https://github.com/apache/pulsar/commit/1d82d97bdbbcaa52ddca7c161c4473e42e12f553", "message": "revoke un-used change for test", "committedDate": "2021-01-04T07:20:26Z", "type": "commit"}, {"oid": "c54c1036a9e86f2d314e0b64220ab6aea5650966", "url": "https://github.com/apache/pulsar/commit/c54c1036a9e86f2d314e0b64220ab6aea5650966", "message": "add process for NotFoundException when unwrap throwable", "committedDate": "2021-01-04T08:13:19Z", "type": "commit"}, {"oid": "72ff04deaf710764cd551673c43d23841d587893", "url": "https://github.com/apache/pulsar/commit/72ff04deaf710764cd551673c43d23841d587893", "message": "Merge remote-tracking branch 'apache/master' into no-exist", "committedDate": "2021-01-04T23:36:21Z", "type": "commit"}, {"oid": "133e1e308bab9375adfca09342fdf4e37a91957d", "url": "https://github.com/apache/pulsar/commit/133e1e308bab9375adfca09342fdf4e37a91957d", "message": "Merge remote-tracking branch 'apache/master' into no-exist", "committedDate": "2021-01-05T23:58:52Z", "type": "commit"}, {"oid": "242f0972d874e110e1b0574ef8edb7e3d525c798", "url": "https://github.com/apache/pulsar/commit/242f0972d874e110e1b0574ef8edb7e3d525c798", "message": "Merge remote-tracking branch 'apache/master' into no-exist", "committedDate": "2021-01-06T03:42:54Z", "type": "commit"}, {"oid": "6d5eeab5fc0f7be923e8ccd2cafaea38fcb261bc", "url": "https://github.com/apache/pulsar/commit/6d5eeab5fc0f7be923e8ccd2cafaea38fcb261bc", "message": "fix test", "committedDate": "2021-01-06T11:20:49Z", "type": "commit"}]}