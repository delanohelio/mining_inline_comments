{"pr_number": 7201, "pr_title": "During Function update, cleanup should only happen for temp files that were generated", "pr_createdAt": "2020-06-08T06:12:15Z", "pr_url": "https://github.com/apache/pulsar/pull/7201", "timeline": [{"oid": "583b6e88bd65a5961aa6377402e816c12b84b702", "url": "https://github.com/apache/pulsar/commit/583b6e88bd65a5961aa6377402e816c12b84b702", "message": "Fix logic while updating functions. Cleanup should only happen for temp files that were generated", "committedDate": "2020-06-08T06:08:14Z", "type": "commit"}, {"oid": "fc75ad9edcc3a04bd8f50dce6237c66ffc88fb1b", "url": "https://github.com/apache/pulsar/commit/fc75ad9edcc3a04bd8f50dce6237c66ffc88fb1b", "message": "Fix integration tests", "committedDate": "2020-06-08T07:07:15Z", "type": "commit"}, {"oid": "baf99f531b7d5acd715715b3d0fef1bed947b4ef", "url": "https://github.com/apache/pulsar/commit/baf99f531b7d5acd715715b3d0fef1bed947b4ef", "message": "Fix test", "committedDate": "2020-06-08T16:12:03Z", "type": "commit"}, {"oid": "4f959c8d8201686622f0776550655283d974e642", "url": "https://github.com/apache/pulsar/commit/4f959c8d8201686622f0776550655283d974e642", "message": "Fix logic for parallelism > 1", "committedDate": "2020-06-08T21:02:44Z", "type": "commit"}, {"oid": "63fa2bf81391d8ac5ff4d6676d62ff63b769dd1c", "url": "https://github.com/apache/pulsar/commit/63fa2bf81391d8ac5ff4d6676d62ff63b769dd1c", "message": "Fix test", "committedDate": "2020-06-08T22:44:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3NDk1Ng==", "url": "https://github.com/apache/pulsar/pull/7201#discussion_r437574956", "bodyText": "Do we also need to exclude \"http\" ?", "author": "jerrypeng", "createdAt": "2020-06-09T16:48:11Z", "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/rest/api/FunctionsImpl.java", "diffHunk": "@@ -419,9 +419,10 @@ public void updateFunction(final String tenant,\n \n             updateRequest(functionMetaDataBuilder.build());\n         } finally {\n-            if (!(functionPkgUrl != null && functionPkgUrl.startsWith(Utils.FILE))\n-                    && componentPackageFile != null && componentPackageFile.exists()) {\n-                componentPackageFile.delete();\n+            if (componentPackageFile != null && componentPackageFile.exists()) {\n+                if ((functionPkgUrl != null && !functionPkgUrl.startsWith(Utils.FILE)) || uploadedInputStream != null) {", "originalCommit": "63fa2bf81391d8ac5ff4d6676d62ff63b769dd1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3NTIyMw==", "url": "https://github.com/apache/pulsar/pull/7201#discussion_r437575223", "bodyText": "Do we need to add this for sources and sinks as well?", "author": "jerrypeng", "createdAt": "2020-06-09T16:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3NDk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5ODMzOA==", "url": "https://github.com/apache/pulsar/pull/7201#discussion_r437598338", "bodyText": "no. Only file. Since for http(or others) we will make a copy and do validation on that copy. We need to cleanup this copy.", "author": "srkukarni", "createdAt": "2020-06-09T17:27:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3NDk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwMjc4Mg==", "url": "https://github.com/apache/pulsar/pull/7201#discussion_r437602782", "bodyText": "good catch about sources/sinks. Will add", "author": "srkukarni", "createdAt": "2020-06-09T17:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3NDk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxNDYyMg==", "url": "https://github.com/apache/pulsar/pull/7201#discussion_r437614622", "bodyText": "Added the same logic for sources/sinks", "author": "srkukarni", "createdAt": "2020-06-09T17:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3NDk1Ng=="}], "type": "inlineReview"}, {"oid": "5371af9660c88237ba819e6df43458d8fd70d7f8", "url": "https://github.com/apache/pulsar/commit/5371af9660c88237ba819e6df43458d8fd70d7f8", "message": "Merge branch 'master' into update_file_fix", "committedDate": "2020-06-09T17:51:30Z", "type": "commit"}, {"oid": "f12de5020ea11937ec7b54d7a8d474592cb155b8", "url": "https://github.com/apache/pulsar/commit/f12de5020ea11937ec7b54d7a8d474592cb155b8", "message": "Address comments", "committedDate": "2020-06-09T17:54:45Z", "type": "commit"}]}