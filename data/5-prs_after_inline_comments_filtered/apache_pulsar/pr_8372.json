{"pr_number": 8372, "pr_title": "[schemaregistry]ProtobufNative Schema Support", "pr_createdAt": "2020-10-26T07:42:32Z", "pr_url": "https://github.com/apache/pulsar/pull/8372", "timeline": [{"oid": "c919588fc041bb683d7670834cb2b2a116494b5e", "url": "https://github.com/apache/pulsar/commit/c919588fc041bb683d7670834cb2b2a116494b5e", "message": "[WIP]ProtobufNative Schema Support", "committedDate": "2020-10-26T07:21:40Z", "type": "commit"}, {"oid": "4bc698b76317dd148e776c5c9df591f40298cc41", "url": "https://github.com/apache/pulsar/commit/4bc698b76317dd148e776c5c9df591f40298cc41", "message": "commit unit test", "committedDate": "2020-10-27T03:02:22Z", "type": "commit"}, {"oid": "9f4a5faebec3b593d2b7a721a1af27c4c605dcf4", "url": "https://github.com/apache/pulsar/commit/9f4a5faebec3b593d2b7a721a1af27c4c605dcf4", "message": "fix bug", "committedDate": "2020-10-28T03:08:56Z", "type": "commit"}, {"oid": "3b6686bc2755f3017648a32a9312b4796aa1d149", "url": "https://github.com/apache/pulsar/commit/3b6686bc2755f3017648a32a9312b4796aa1d149", "message": "Merge branch 'master' into support_protobuf_native_schema", "committedDate": "2020-10-28T06:17:40Z", "type": "commit"}, {"oid": "9f98f5977ad040743e9d9a9838a0f6d090594ad5", "url": "https://github.com/apache/pulsar/commit/9f98f5977ad040743e9d9a9838a0f6d090594ad5", "message": " fix License check error", "committedDate": "2020-10-28T06:53:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE4NTA5OQ==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r521185099", "bodyText": "why there is \"RootRoot\" in the method name CheckRootRootMessageChange?\nAlso, we need to make the first character low case.", "author": "sijie", "createdAt": "2020-11-11T08:12:19Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/schema/ProtobufNativeSchemaCompatibilityCheck.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.broker.service.schema;\n+\n+import org.apache.pulsar.broker.service.schema.exceptions.IncompatibleSchemaException;\n+import org.apache.pulsar.client.impl.schema.ProtobufNativeSchemaUtils;\n+import org.apache.pulsar.common.policies.data.SchemaCompatibilityStrategy;\n+import org.apache.pulsar.common.protocol.schema.SchemaData;\n+import org.apache.pulsar.common.schema.SchemaType;\n+\n+import static com.google.protobuf.Descriptors.Descriptor;\n+\n+/**\n+ * The {@link SchemaCompatibilityCheck} implementation for {@link SchemaType#PROTOBUF_NATIVE}.\n+ */\n+public class ProtobufNativeSchemaCompatibilityCheck implements SchemaCompatibilityCheck {\n+\n+    @Override\n+    public SchemaType getSchemaType() {\n+        return SchemaType.PROTOBUF_NATIVE;\n+    }\n+\n+    @Override\n+    public void checkCompatible(SchemaData from, SchemaData to, SchemaCompatibilityStrategy strategy) throws IncompatibleSchemaException {\n+        Descriptor fromDescriptor = ProtobufNativeSchemaUtils.deserialize(from.getData());\n+        Descriptor toDescriptor = ProtobufNativeSchemaUtils.deserialize(to.getData());\n+        switch (strategy) {\n+            case BACKWARD_TRANSITIVE:\n+            case BACKWARD:\n+            case FORWARD_TRANSITIVE:\n+            case FORWARD:\n+            case FULL_TRANSITIVE:\n+            case FULL:\n+                CheckRootRootMessageChange(fromDescriptor, toDescriptor, strategy);\n+                return;\n+            case ALWAYS_COMPATIBLE:\n+                return;\n+            default:\n+                throw new IncompatibleSchemaException(\"Unknown SchemaCompatibilityStrategy\");\n+        }\n+    }\n+\n+    @Override\n+    public void checkCompatible(Iterable<SchemaData> from, SchemaData to, SchemaCompatibilityStrategy strategy) throws IncompatibleSchemaException {\n+        for (SchemaData schemaData : from) {\n+            checkCompatible(schemaData, to, strategy);\n+        }\n+    }\n+\n+    private void CheckRootRootMessageChange(Descriptor fromDescriptor, Descriptor toDescriptor, SchemaCompatibilityStrategy strategy) throws IncompatibleSchemaException {", "originalCommit": "9f98f5977ad040743e9d9a9838a0f6d090594ad5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjcwNTgzMw==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r522705833", "bodyText": "@sijie thanks for the reminders , it due to my carelessness . this shoud be CheckRootMessageChange , I may need recheck my code details carefully", "author": "hnail", "createdAt": "2020-11-13T07:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE4NTA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE4NTgxMA==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r521185810", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new InvalidSchemaDataException(\"deserialize  ProtobufNative Schema failed\", e);\n          \n          \n            \n                        throw new InvalidSchemaDataException(\"deserialize ProtobufNative Schema failed\", e);", "author": "sijie", "createdAt": "2020-11-11T08:13:54Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/schema/validator/ProtobufNativeSchemaDataValidator.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.broker.service.schema.validator;\n+\n+import com.google.protobuf.Descriptors;\n+import org.apache.pulsar.broker.service.schema.exceptions.InvalidSchemaDataException;\n+import org.apache.pulsar.client.impl.schema.ProtobufNativeSchemaUtils;\n+import org.apache.pulsar.common.protocol.schema.SchemaData;\n+\n+public class ProtobufNativeSchemaDataValidator implements SchemaDataValidator {\n+\n+    @Override\n+    public void validate(SchemaData schemaData) throws InvalidSchemaDataException {\n+        Descriptors.Descriptor descriptor;\n+        try {\n+            descriptor = ProtobufNativeSchemaUtils.deserialize(schemaData.getData());\n+        } catch (Exception e) {\n+            throw new InvalidSchemaDataException(\"deserialize  ProtobufNative Schema failed\", e);", "originalCommit": "9f98f5977ad040743e9d9a9838a0f6d090594ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE4NjAxMg==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r521186012", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new InvalidSchemaDataException(\"protobuf root message Descriptor is null , please recheck rootMessageTypeName or rootFileDescriptorName conf. \");\n          \n          \n            \n                        throw new InvalidSchemaDataException(\"protobuf root message descriptor is null , please recheck rootMessageTypeName or rootFileDescriptorName conf. \");", "author": "sijie", "createdAt": "2020-11-11T08:14:18Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/schema/validator/ProtobufNativeSchemaDataValidator.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.broker.service.schema.validator;\n+\n+import com.google.protobuf.Descriptors;\n+import org.apache.pulsar.broker.service.schema.exceptions.InvalidSchemaDataException;\n+import org.apache.pulsar.client.impl.schema.ProtobufNativeSchemaUtils;\n+import org.apache.pulsar.common.protocol.schema.SchemaData;\n+\n+public class ProtobufNativeSchemaDataValidator implements SchemaDataValidator {\n+\n+    @Override\n+    public void validate(SchemaData schemaData) throws InvalidSchemaDataException {\n+        Descriptors.Descriptor descriptor;\n+        try {\n+            descriptor = ProtobufNativeSchemaUtils.deserialize(schemaData.getData());\n+        } catch (Exception e) {\n+            throw new InvalidSchemaDataException(\"deserialize  ProtobufNative Schema failed\", e);\n+        }\n+        if (descriptor == null) {\n+            throw new InvalidSchemaDataException(\"protobuf root message Descriptor is null , please recheck rootMessageTypeName or rootFileDescriptorName conf. \");", "originalCommit": "9f98f5977ad040743e9d9a9838a0f6d090594ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM2NDQ0Ng==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r521364446", "bodyText": "Avoid use import.* here", "author": "codelipenghui", "createdAt": "2020-11-11T13:40:14Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/ProtobufNativeSchemaUtils.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.client.impl.schema;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.pulsar.client.api.SchemaSerializationException;\n+import org.apache.pulsar.common.protocol.schema.ProtobufNativeSchemaData;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static com.google.protobuf.DescriptorProtos.FileDescriptorProto;\n+import static com.google.protobuf.DescriptorProtos.FileDescriptorSet;\n+import static com.google.protobuf.Descriptors.*;", "originalCommit": "9f98f5977ad040743e9d9a9838a0f6d090594ad5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgxNDE1Nw==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r522814157", "bodyText": "@codelipenghui thanks for review , fixed as Suggestion\u3002", "author": "hnail", "createdAt": "2020-11-13T09:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM2NDQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM2NTIwNw==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r521365207", "bodyText": "Avoid use import.* here", "author": "codelipenghui", "createdAt": "2020-11-11T13:41:26Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/generic/GenericProtobufNativeSchema.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.client.impl.schema.generic;\n+\n+import com.google.protobuf.Descriptors;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.pulsar.client.api.schema.*;", "originalCommit": "9f98f5977ad040743e9d9a9838a0f6d090594ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MjU3Ng==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r521782576", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static <T extends com.google.protobuf.GeneratedMessageV3> Schema<T> PROTOBUFNATIVE(Class<T> clazz) {\n          \n          \n            \n                static <T extends com.google.protobuf.GeneratedMessageV3> Schema<T> PROTOBUF_NATIVE(Class<T> clazz) {", "author": "congbobo184", "createdAt": "2020-11-12T02:44:31Z", "path": "pulsar-client-api/src/main/java/org/apache/pulsar/client/api/Schema.java", "diffHunk": "@@ -251,6 +251,27 @@ default void configureSchemaInfo(String topic, String componentName,\n         return DefaultImplementation.newProtobufSchema(schemaDefinition);\n     }\n \n+    /**\n+     * Create a Protobuf-Native schema type by extracting the fields of the specified class.\n+     *\n+     * @param clazz the Protobuf generated class to be used to extract the schema\n+     * @return a Schema instance\n+     */\n+    static <T extends com.google.protobuf.GeneratedMessageV3> Schema<T> PROTOBUFNATIVE(Class<T> clazz) {", "originalCommit": "9f98f5977ad040743e9d9a9838a0f6d090594ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MjY2Mg==", "url": "https://github.com/apache/pulsar/pull/8372#discussion_r521782662", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static <T extends com.google.protobuf.GeneratedMessageV3> Schema<T> PROTOBUFNATIVE(\n          \n          \n            \n                static <T extends com.google.protobuf.GeneratedMessageV3> Schema<T> PROTOBUF_NATIVE(", "author": "congbobo184", "createdAt": "2020-11-12T02:44:48Z", "path": "pulsar-client-api/src/main/java/org/apache/pulsar/client/api/Schema.java", "diffHunk": "@@ -251,6 +251,27 @@ default void configureSchemaInfo(String topic, String componentName,\n         return DefaultImplementation.newProtobufSchema(schemaDefinition);\n     }\n \n+    /**\n+     * Create a Protobuf-Native schema type by extracting the fields of the specified class.\n+     *\n+     * @param clazz the Protobuf generated class to be used to extract the schema\n+     * @return a Schema instance\n+     */\n+    static <T extends com.google.protobuf.GeneratedMessageV3> Schema<T> PROTOBUFNATIVE(Class<T> clazz) {\n+        return DefaultImplementation.newProtobufNativeSchema(SchemaDefinition.builder().withPojo(clazz).build());\n+    }\n+\n+    /**\n+     * Create a Protobuf-Native schema type with schema definition.\n+     *\n+     * @param schemaDefinition schemaDefinition the definition of the schema\n+     * @return a Schema instance\n+     */\n+    static <T extends com.google.protobuf.GeneratedMessageV3> Schema<T> PROTOBUFNATIVE(", "originalCommit": "9f98f5977ad040743e9d9a9838a0f6d090594ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4378645b78ee977edeb4cd8d299ea93bd78ff0ff", "url": "https://github.com/apache/pulsar/commit/4378645b78ee977edeb4cd8d299ea93bd78ff0ff", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/service/schema/validator/ProtobufNativeSchemaDataValidator.java\n\nCo-authored-by: Sijie Guo <sg@streamnative.io>", "committedDate": "2020-11-13T07:09:57Z", "type": "commit"}, {"oid": "2487bf25ef6a1d2dd24796d963396fcc02aaf46a", "url": "https://github.com/apache/pulsar/commit/2487bf25ef6a1d2dd24796d963396fcc02aaf46a", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/service/schema/validator/ProtobufNativeSchemaDataValidator.java\n\nCo-authored-by: Sijie Guo <sg@streamnative.io>", "committedDate": "2020-11-13T07:10:12Z", "type": "commit"}, {"oid": "bb45c1469ff5bfa004c0d20d5279669cd26277bf", "url": "https://github.com/apache/pulsar/commit/bb45c1469ff5bfa004c0d20d5279669cd26277bf", "message": "Update pulsar-client-api/src/main/java/org/apache/pulsar/client/api/Schema.java\n\nCo-authored-by: congbo <39078850+congbobo184@users.noreply.github.com>", "committedDate": "2020-11-13T07:10:31Z", "type": "commit"}, {"oid": "6a55bcc897ec45cf6ef436254b53e678d7eca36e", "url": "https://github.com/apache/pulsar/commit/6a55bcc897ec45cf6ef436254b53e678d7eca36e", "message": "Update pulsar-client-api/src/main/java/org/apache/pulsar/client/api/Schema.java\n\nCo-authored-by: congbo <39078850+congbobo184@users.noreply.github.com>", "committedDate": "2020-11-13T07:10:40Z", "type": "commit"}, {"oid": "0a5c5737d3e4fb2d6ab65323fa16d1b3d9d0737f", "url": "https://github.com/apache/pulsar/commit/0a5c5737d3e4fb2d6ab65323fa16d1b3d9d0737f", "message": "Merge branch 'master' of https://github.com/apache/pulsar into support_protobuf_native_schema", "committedDate": "2020-11-13T08:13:48Z", "type": "commit"}, {"oid": "38e470f68cf89f4959acb5033397c97099b0d17a", "url": "https://github.com/apache/pulsar/commit/38e470f68cf89f4959acb5033397c97099b0d17a", "message": "codeStyle fix", "committedDate": "2020-11-13T08:50:18Z", "type": "commit"}, {"oid": "2597f2c6287783ba285737a28cb39cf3e058aa37", "url": "https://github.com/apache/pulsar/commit/2597f2c6287783ba285737a28cb39cf3e058aa37", "message": "codeStyle fix v2", "committedDate": "2020-11-16T06:07:43Z", "type": "commit"}]}