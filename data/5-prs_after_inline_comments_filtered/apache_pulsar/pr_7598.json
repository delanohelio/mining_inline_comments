{"pr_number": 7598, "pr_title": "Support configuring DeleteInactiveTopic setting in namespace policy", "pr_createdAt": "2020-07-19T02:34:58Z", "pr_url": "https://github.com/apache/pulsar/pull/7598", "timeline": [{"oid": "8441eed82f31e61af27f6c7a041ff745ed462b50", "url": "https://github.com/apache/pulsar/commit/8441eed82f31e61af27f6c7a041ff745ed462b50", "message": "fix unit test", "committedDate": "2020-07-19T16:01:34Z", "type": "forcePushed"}, {"oid": "60a302f0a137c27114c211d84715b6b65f1b4194", "url": "https://github.com/apache/pulsar/commit/60a302f0a137c27114c211d84715b6b65f1b4194", "message": "support namespaces inactive topic delete policy", "committedDate": "2020-07-21T07:20:55Z", "type": "commit"}, {"oid": "60a302f0a137c27114c211d84715b6b65f1b4194", "url": "https://github.com/apache/pulsar/commit/60a302f0a137c27114c211d84715b6b65f1b4194", "message": "support namespaces inactive topic delete policy", "committedDate": "2020-07-21T07:20:55Z", "type": "forcePushed"}, {"oid": "291b263aedfb5e0435a37064878af6c4093f0149", "url": "https://github.com/apache/pulsar/commit/291b263aedfb5e0435a37064878af6c4093f0149", "message": "add whitespace", "committedDate": "2020-07-21T08:06:17Z", "type": "commit"}, {"oid": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "url": "https://github.com/apache/pulsar/commit/6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "message": "add a period", "committedDate": "2020-07-21T08:27:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1MDk1NQ==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458050955", "bodyText": "If the namespace level policy already specified and then restart the broker, the inactive topic policy should apply the namespace level policy.", "author": "codelipenghui", "createdAt": "2020-07-21T12:16:41Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -98,8 +99,7 @@ public AbstractTopic(String topic, BrokerService brokerService) {\n         this.producers = new ConcurrentHashMap<>();\n         this.isFenced = false;\n         this.replicatorPrefix = brokerService.pulsar().getConfiguration().getReplicatorPrefix();\n-        this.deleteWhileInactive =\n-                brokerService.pulsar().getConfiguration().isBrokerDeleteInactiveTopicsEnabled();\n+        this.inactiveTopicPolicies.setDeleteWhileInactive(brokerService.pulsar().getConfiguration().isBrokerDeleteInactiveTopicsEnabled());", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA5MzU0Mg==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458093542", "bodyText": "I have fixed it. If there is a namespace level policy, the policy will be restored from zk in the subclass construction method.", "author": "315157973", "createdAt": "2020-07-21T13:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1MDk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1MzkxNg==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458053916", "bodyText": "use deleteWhileInactive here is more reasonable because of the command name is set-inactive-topic.", "author": "codelipenghui", "createdAt": "2020-07-21T12:22:25Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -1014,6 +1016,54 @@ void run() throws PulsarAdminException {\n         }\n     }\n \n+    @Parameters(commandDescription = \"Get the inactive topic policy for a namespace\")\n+    private class GetInactiveTopicPolicies extends CliCommand {\n+        @Parameter(description = \"tenant/namespace\\n\", required = true)\n+        private java.util.List<String> params;\n+\n+        @Override\n+        void run() throws PulsarAdminException {\n+            String namespace = validateNamespace(params);\n+            print(admin.namespaces().getInactiveTopicPolicies(namespace));\n+        }\n+    }\n+\n+    @Parameters(commandDescription = \"Set the inactive topic policies on a namespace\")\n+    private class SetInactiveTopicPolicies extends CliCommand {\n+        @Parameter(description = \"tenant/namespace\", required = true)\n+        private java.util.List<String> params;\n+\n+        @Parameter(names = { \"--enable\", \"-e\" }, description = \"Enable inactive topic messages\")\n+        private boolean enable = false;\n+\n+        @Parameter(names = { \"--disable\", \"-d\" }, description = \"Disable inactive topic messages\")\n+        private boolean disable = false;", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1NDQ2Ng==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458054466", "bodyText": "It's better to provide the options of inactiveTopicDeleteMode. So that users can know what to fill in.", "author": "codelipenghui", "createdAt": "2020-07-21T12:23:28Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -1014,6 +1016,54 @@ void run() throws PulsarAdminException {\n         }\n     }\n \n+    @Parameters(commandDescription = \"Get the inactive topic policy for a namespace\")\n+    private class GetInactiveTopicPolicies extends CliCommand {\n+        @Parameter(description = \"tenant/namespace\\n\", required = true)\n+        private java.util.List<String> params;\n+\n+        @Override\n+        void run() throws PulsarAdminException {\n+            String namespace = validateNamespace(params);\n+            print(admin.namespaces().getInactiveTopicPolicies(namespace));\n+        }\n+    }\n+\n+    @Parameters(commandDescription = \"Set the inactive topic policies on a namespace\")\n+    private class SetInactiveTopicPolicies extends CliCommand {\n+        @Parameter(description = \"tenant/namespace\", required = true)\n+        private java.util.List<String> params;\n+\n+        @Parameter(names = { \"--enable\", \"-e\" }, description = \"Enable inactive topic messages\")\n+        private boolean enable = false;\n+\n+        @Parameter(names = { \"--disable\", \"-d\" }, description = \"Disable inactive topic messages\")\n+        private boolean disable = false;\n+\n+        @Parameter(names = {\"--max-inactive-duration\", \"-t\"}, description = \"Max duration of topic inactivity in seconds\" +\n+                \",topics that are inactive for longer than this value will be deleted (eg: 1s, 10s, 1m, 5h, 3d)\", required = true)\n+        private String deleteInactiveTopicsMaxInactiveDuration;\n+\n+        @Parameter(names = { \"--delete-mode\", \"-m\" }, description = \"Disable inactive topic messages\", required = true)\n+        private String inactiveTopicDeleteMode;", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MTU4Mg==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458061582", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    jcommander.addCommand(\"get-inactive-topic\", new GetInactiveTopicPolicies());\n          \n          \n            \n                    jcommander.addCommand(\"get-inactive-topic-policy\", new GetInactiveTopicPolicies());", "author": "codelipenghui", "createdAt": "2020-07-21T12:36:02Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -1696,6 +1746,9 @@ public CmdNamespaces(PulsarAdmin admin) {\n         jcommander.addCommand(\"set-delayed-delivery\", new SetDelayedDelivery());\n         jcommander.addCommand(\"get-delayed-delivery\", new GetDelayedDelivery());\n \n+        jcommander.addCommand(\"get-inactive-topic\", new GetInactiveTopicPolicies());", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA5NDQ5NA==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458094494", "bodyText": "I changed it to Policies", "author": "315157973", "createdAt": "2020-07-21T13:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MTU4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MTY2OQ==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458061669", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    jcommander.addCommand(\"set-inactive-topic\", new SetInactiveTopicPolicies());\n          \n          \n            \n                    jcommander.addCommand(\"set-inactive-topic-policy\", new SetInactiveTopicPolicies());", "author": "codelipenghui", "createdAt": "2020-07-21T12:36:11Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -1696,6 +1746,9 @@ public CmdNamespaces(PulsarAdmin admin) {\n         jcommander.addCommand(\"set-delayed-delivery\", new SetDelayedDelivery());\n         jcommander.addCommand(\"get-delayed-delivery\", new GetDelayedDelivery());\n \n+        jcommander.addCommand(\"get-inactive-topic\", new GetInactiveTopicPolicies());\n+        jcommander.addCommand(\"set-inactive-topic\", new SetInactiveTopicPolicies());", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MjQ5NA==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458062494", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Path(\"/{tenant}/{namespace}/inactiveTopic\")\n          \n          \n            \n                @Path(\"/{tenant}/{namespace}/inactiveTopicPolicy\")", "author": "codelipenghui", "createdAt": "2020-07-21T12:37:36Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/Namespaces.java", "diffHunk": "@@ -859,6 +860,30 @@ public void setDelayedDeliveryPolicies(@PathParam(\"tenant\") String tenant,\n         internalSetDelayedDelivery(deliveryPolicies);\n     }\n \n+    @GET\n+    @Path(\"/{tenant}/{namespace}/inactiveTopic\")", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA5NDYzNw==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458094637", "bodyText": "I changed it to inactiveTopicPolicies", "author": "315157973", "createdAt": "2020-07-21T13:26:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MjQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NjMwMw==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458476303", "bodyText": "Sounds good.", "author": "codelipenghui", "createdAt": "2020-07-22T01:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MjQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MjYwOA==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458062608", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Path(\"/{tenant}/{namespace}/inactiveTopic\")\n          \n          \n            \n                @Path(\"/{tenant}/{namespace}/inactiveTopicPolicy\")", "author": "codelipenghui", "createdAt": "2020-07-21T12:37:47Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/Namespaces.java", "diffHunk": "@@ -859,6 +860,30 @@ public void setDelayedDeliveryPolicies(@PathParam(\"tenant\") String tenant,\n         internalSetDelayedDelivery(deliveryPolicies);\n     }\n \n+    @GET\n+    @Path(\"/{tenant}/{namespace}/inactiveTopic\")\n+    @ApiOperation(value = \"Get inactive topic messages config on a namespace.\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Tenant or cluster or namespace doesn't exist\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\"), })\n+    public InactiveTopicPolicies getInactiveTopicPolicies(@PathParam(\"tenant\") String tenant,\n+                                                              @PathParam(\"namespace\") String namespace) {\n+        validateNamespaceName(tenant, namespace);\n+        return internalGetInactiveTopic();\n+    }\n+\n+    @POST\n+    @Path(\"/{tenant}/{namespace}/inactiveTopic\")", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2NDg4NQ==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458064885", "bodyText": "If we already use InactiveTopicPolicies, I think we don't need to pass maxInactiveDurationSeconds and inactiveTopicDeleteMode in the param list. Of course, if only use InactiveTopicPolicies to maintain the namespace level policy, we still need to pass parameters.", "author": "codelipenghui", "createdAt": "2020-07-21T12:41:40Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/nonpersistent/NonPersistentTopic.java", "diffHunk": "@@ -829,11 +829,14 @@ public boolean isActive() {\n     }\n \n     @Override\n-    public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n-        if (!deleteWhileInactive) {\n+    public void checkGC(int maxInactiveDurationSeconds, InactiveTopicDeleteMode inactiveTopicDeleteMode) {\n+        if (!isDeleteWhileInactive()) {", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2NTEzNQ==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458065135", "bodyText": "Same as the comment that I left in the NonPersistentTopic.", "author": "codelipenghui", "createdAt": "2020-07-21T12:42:04Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1628,11 +1628,17 @@ private boolean hasBacklogs() {\n     }\n \n     @Override\n-    public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n-        if (!deleteWhileInactive) {\n+    public void checkGC(int maxInactiveDurationSeconds, InactiveTopicDeleteMode inactiveTopicDeleteMode) {\n+        if (!isDeleteWhileInactive()) {", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2NjA4OQ==", "url": "https://github.com/apache/pulsar/pull/7598#discussion_r458066089", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private int brokerDeleteInactiveTopicsMaxInactiveDurationSeconds;\n          \n          \n            \n                private int maxInactiveDurationSeconds;", "author": "codelipenghui", "createdAt": "2020-07-21T12:43:44Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/policies/data/InactiveTopicPolicies.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.common.policies.data;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+\n+/**\n+ * Definition of the inactive topic policy.\n+ */\n+@Data\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class InactiveTopicPolicies {\n+    private InactiveTopicDeleteMode inactiveTopicDeleteMode;\n+    private int brokerDeleteInactiveTopicsMaxInactiveDurationSeconds;", "originalCommit": "6be76d47da7974625db311d2c94e0fdc1a9ba3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "145518837716f91192179a1a7c074249209a2cf4", "url": "https://github.com/apache/pulsar/commit/145518837716f91192179a1a7c074249209a2cf4", "message": "add remove policy and so on", "committedDate": "2020-07-22T15:30:46Z", "type": "commit"}, {"oid": "e9c8b83f39af6ab269cb9b5a919d6d9730a08355", "url": "https://github.com/apache/pulsar/commit/e9c8b83f39af6ab269cb9b5a919d6d9730a08355", "message": "Merge branch 'master' into ns-topic", "committedDate": "2020-07-25T14:11:51Z", "type": "commit"}]}