{"pr_number": 7211, "pr_title": "Have metadata tailer use its own thread for processing", "pr_createdAt": "2020-06-08T22:52:25Z", "pr_url": "https://github.com/apache/pulsar/pull/7211", "timeline": [{"oid": "5b85480c7e4780960a3dc3d6c2cb09c98e2d7791", "url": "https://github.com/apache/pulsar/commit/5b85480c7e4780960a3dc3d6c2cb09c98e2d7791", "message": "Have metadata tailer use its own thread for processing", "committedDate": "2020-06-08T22:50:26Z", "type": "commit"}, {"oid": "b9abea6679a59d76070f6dd19ca901e64b51f0ee", "url": "https://github.com/apache/pulsar/commit/b9abea6679a59d76070f6dd19ca901e64b51f0ee", "message": "Merge branch 'master' into metadata_tailer_thread", "committedDate": "2020-06-09T04:08:39Z", "type": "commit"}, {"oid": "4dd8c3ade97bf9436e0d985d57b3c800498f7d79", "url": "https://github.com/apache/pulsar/commit/4dd8c3ade97bf9436e0d985d57b3c800498f7d79", "message": "Merged with master", "committedDate": "2020-06-09T04:20:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5MDU4OQ==", "url": "https://github.com/apache/pulsar/pull/7211#discussion_r437590589", "bodyText": "Should we just remove the try-catch and let the method throw an exception? Everything is caught in the thread anyways.", "author": "jerrypeng", "createdAt": "2020-06-09T17:14:01Z", "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionMetaDataTopicTailer.java", "diffHunk": "@@ -69,28 +106,13 @@ public void processRequest(Message<byte[]> msg) {\n             serviceRequest = ServiceRequest.parseFrom(msg.getData());\n         } catch (IOException e) {\n             log.error(\"Received bad service request at message {}\", msg.getMessageId(), e);\n-            // TODO: find a better way to handle bad request\n-            throw new RuntimeException(e);\n+            errorNotifier.triggerError(e);", "originalCommit": "4dd8c3ade97bf9436e0d985d57b3c800498f7d79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwMDAzMg==", "url": "https://github.com/apache/pulsar/pull/7211#discussion_r437600032", "bodyText": "We would still need to differentiate Interrupted vs others. And if we do encounter some exception isn;'t it better to trigger the errorNotifier and exit perhaps?", "author": "srkukarni", "createdAt": "2020-06-09T17:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5MDU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxMDEwNw==", "url": "https://github.com/apache/pulsar/pull/7211#discussion_r437610107", "bodyText": "We would still need to differentiate Interrupted vs others.\n\nI don't quite follow, the code already differentiates interrupted exceptions vs other exceptions.\nTriggering the error in the catch all block in the thread allows us to exit the thread as well and stop further processing of requests.  While this doesn't hurt but is cleaner in a sense.", "author": "jerrypeng", "createdAt": "2020-06-09T17:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5MDU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MDU4Mw==", "url": "https://github.com/apache/pulsar/pull/7211#discussion_r437650583", "bodyText": "I misunderstood your comments. Yes, that makes sense. Fixed", "author": "srkukarni", "createdAt": "2020-06-09T18:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5MDU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5MTYxMg==", "url": "https://github.com/apache/pulsar/pull/7211#discussion_r437591612", "bodyText": "Can you also set the subscription prefix:\nsubscriptionRolePrefix(workerConfig.getWorkerId() + \"-function-metadata-manager\")", "author": "jerrypeng", "createdAt": "2020-06-09T17:15:48Z", "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionMetaDataTopicTailer.java", "diffHunk": "@@ -19,47 +19,84 @@\n package org.apache.pulsar.functions.worker;\n \n import java.io.IOException;\n-import java.util.function.Function;\n \n+import lombok.Getter;\n import lombok.extern.slf4j.Slf4j;\n import org.apache.pulsar.client.api.Message;\n-import org.apache.pulsar.client.api.PulsarClientException;\n+import org.apache.pulsar.client.api.MessageId;\n import org.apache.pulsar.client.api.Reader;\n+import org.apache.pulsar.client.api.ReaderBuilder;\n+import org.apache.pulsar.client.api.PulsarClientException;\n import org.apache.pulsar.functions.proto.Request.ServiceRequest;\n \n @Slf4j\n public class FunctionMetaDataTopicTailer\n-        implements java.util.function.Consumer<Message<byte[]>>, Function<Throwable, Void>, AutoCloseable {\n+        implements Runnable, AutoCloseable {\n \n     private final FunctionMetaDataManager functionMetaDataManager;\n+    @Getter\n     private final Reader<byte[]> reader;\n+    private final Thread readerThread;\n+    private volatile boolean running;\n+    private ErrorNotifier errorNotifier;\n \n     public FunctionMetaDataTopicTailer(FunctionMetaDataManager functionMetaDataManager,\n-                                       Reader<byte[]> reader)\n+                                       ReaderBuilder readerBuilder, WorkerConfig workerConfig,\n+                                       ErrorNotifier errorNotifier)\n             throws PulsarClientException {\n         this.functionMetaDataManager = functionMetaDataManager;\n-        this.reader = reader;\n+        this.reader = readerBuilder\n+                .topic(workerConfig.getFunctionMetadataTopic())", "originalCommit": "4dd8c3ade97bf9436e0d985d57b3c800498f7d79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwMTQ2MA==", "url": "https://github.com/apache/pulsar/pull/7211#discussion_r437601460", "bodyText": "Added", "author": "srkukarni", "createdAt": "2020-06-09T17:32:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5MTYxMg=="}], "type": "inlineReview"}, {"oid": "7d688da891f3aed76d00677db5bf28d1fac83dfb", "url": "https://github.com/apache/pulsar/commit/7d688da891f3aed76d00677db5bf28d1fac83dfb", "message": "Address comments", "committedDate": "2020-06-09T17:32:14Z", "type": "commit"}, {"oid": "1beab6a25bc90795624b0317bd8490a1a22ae89e", "url": "https://github.com/apache/pulsar/commit/1beab6a25bc90795624b0317bd8490a1a22ae89e", "message": "Merge branch 'master' into metadata_tailer_thread", "committedDate": "2020-06-09T18:52:07Z", "type": "commit"}, {"oid": "d783b87c616152bb53a9b8fed6993b3768985ed2", "url": "https://github.com/apache/pulsar/commit/d783b87c616152bb53a9b8fed6993b3768985ed2", "message": "Address comments", "committedDate": "2020-06-09T18:56:35Z", "type": "commit"}]}