{"pr_number": 6972, "pr_title": "Add Annotations for config validation checking", "pr_createdAt": "2020-05-16T00:44:04Z", "pr_url": "https://github.com/apache/pulsar/pull/6972", "timeline": [{"oid": "d6edf815a07eabf82755fb3b074510e60f79ee87", "url": "https://github.com/apache/pulsar/commit/d6edf815a07eabf82755fb3b074510e60f79ee87", "message": "Add Validator annotation helpers to validate class parameters", "committedDate": "2020-05-15T23:29:18Z", "type": "commit"}, {"oid": "68a21cf08fa96997da1277cfba30eb65c5f62870", "url": "https://github.com/apache/pulsar/commit/68a21cf08fa96997da1277cfba30eb65c5f62870", "message": "Fix build errors", "committedDate": "2020-05-16T00:40:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwMjI2OQ==", "url": "https://github.com/apache/pulsar/pull/6972#discussion_r426102269", "bodyText": "I like the idea of having type checking. The naming is a bit confusing to me something like makes more sense to me.\nclass TestConfig {\n       @NotNull\n        public String stringValue;\n        \n       @PositiveNumber or @Number(positive=true)\n        public Integer positiveNumber;\n        \n       @List(itemType = Integer.class) or @ListType(itemType = Integer.class) or @IntegerList\n        public List integerList;\n        \n       @Map(keyType = String.class, valueType = Integer.class) or @MapType(keyType = String.class, valueType = Integer.class)\n        public Map stringIntegerMap;\n        \n       @List(itemType = String.class) or @StringList\n        public List stringList;\n        \n       @TopicName\n        public String topic;\n        \n       @CustomType(validatorClass = TestValidator.class)\n        public String customString;\n    }\n\nI think annotations should describe what the variable type is as opposed to describing how to test it. The testing is implied.\nAnother thing to think about is how to handle fields that should be required to have a value.\nThoughts?", "author": "cckellogg", "createdAt": "2020-05-16T01:10:29Z", "path": "pulsar-common/src/test/java/org/apache/pulsar/common/validator/ConfigValidationTest.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.common.validator;\n+\n+import org.testng.annotations.Test;\n+\n+import java.util.*;\n+import static org.testng.Assert.*;\n+\n+public class ConfigValidationTest {\n+\n+    private final List<String> testStringList = Arrays.asList(new String[]{\"foo\", \"bar\"});\n+    private final List<Integer> testIntegerList = Arrays.asList(new Integer[]{0, 1});\n+    private final Map<String, Integer> testStringIntegerMap = new HashMap<String, Integer>() {\n+        {\n+            put(\"one\", 1);\n+            put(\"two\", 2);\n+        }\n+    };\n+    private final Map<String, String> testStringStringMap = new HashMap<String, String>() {\n+        {\n+            put(\"one\", \"one\");\n+            put(\"two\", \"two\");\n+        }\n+    };\n+    private final String topic = \"persistent://public/default/topic\";\n+\n+    public static class TestValidator extends Validator {\n+        @Override\n+        public void validateField(String name, Object o) {\n+            if (o instanceof String) {\n+                String value = (String)o;\n+                if (!value.startsWith(\"ABCDE\")) {\n+                    throw new IllegalArgumentException(String.format(\"Field %s does not start with ABCDE\", name));\n+                }\n+            } else {\n+                throw new IllegalArgumentException(String.format(\"Field %s is not a string\", name));\n+            }\n+        }\n+    }\n+\n+    class TestConfig {", "originalCommit": "68a21cf08fa96997da1277cfba30eb65c5f62870", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE4Mzg0Nw==", "url": "https://github.com/apache/pulsar/pull/6972#discussion_r426183847", "bodyText": "I don't fee strongly about it either way.   However, if we feel we can simplify the naming of annotations and still be intuitive to the end user, we should.  The current annotations are borrowed from Storm that I created a while ago:\nhttps://github.com/apache/storm/blob/master/storm-client/src/jvm/org/apache/storm/validation/ConfigValidationAnnotations.java\nOthers have name annotations in a more simplified way:\nhttps://www.baeldung.com/javax-validation", "author": "jerrypeng", "createdAt": "2020-05-16T19:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwMjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE4ODIxNg==", "url": "https://github.com/apache/pulsar/pull/6972#discussion_r426188216", "bodyText": "I have changed the annotations. wrt fields that should have a value, isn't that covered by NotNull?", "author": "srkukarni", "createdAt": "2020-05-16T20:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwMjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTE3OA==", "url": "https://github.com/apache/pulsar/pull/6972#discussion_r426335178", "bodyText": "Can NotNull be applied in combination with another annotation like this? Or does an annotation like @TopicName or @List imply not null?\n@NotNull\n@TopicName\n public String topic;", "author": "cckellogg", "createdAt": "2020-05-18T01:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwMjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM0ODcyMA==", "url": "https://github.com/apache/pulsar/pull/6972#discussion_r426348720", "bodyText": "Multiple annotations are possible on a field.\nThus\n@NotNull\n@TopicName implies that it should be non null and is a topic. However I believe that TopicName already ensures that its not null", "author": "srkukarni", "createdAt": "2020-05-18T03:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwMjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjczNDQwOA==", "url": "https://github.com/apache/pulsar/pull/6972#discussion_r426734408", "bodyText": "Sounds good and LGTM +1", "author": "cckellogg", "createdAt": "2020-05-18T16:02:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwMjI2OQ=="}], "type": "inlineReview"}, {"oid": "64001f84f3b1b38a0f56b51366c6dc13207a1dfb", "url": "https://github.com/apache/pulsar/commit/64001f84f3b1b38a0f56b51366c6dc13207a1dfb", "message": "Take feedback into account", "committedDate": "2020-05-16T20:26:30Z", "type": "commit"}]}