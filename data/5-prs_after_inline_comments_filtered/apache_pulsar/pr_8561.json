{"pr_number": 8561, "pr_title": "[broker] Close topics that remain fenced forcefully", "pr_createdAt": "2020-11-13T09:57:37Z", "pr_url": "https://github.com/apache/pulsar/pull/8561", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3NjMzMw==", "url": "https://github.com/apache/pulsar/pull/8561#discussion_r524476333", "bodyText": "Do we need to put close in the synchronized block?", "author": "sijie", "createdAt": "2020-11-16T18:16:41Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -2384,6 +2387,40 @@ public boolean isSystemTopic() {\n         return false;\n     }\n \n+    private synchronized void fence() {\n+        isFenced = true;\n+        ScheduledFuture<?> monitoringTask = this.fencedTopicMonitoringTask;\n+        if (monitoringTask == null || monitoringTask.isDone()) {\n+            final int timeout = brokerService.pulsar().getConfiguration().getTopicFencingTimeoutSeconds();\n+            if (timeout > 0) {\n+                this.fencedTopicMonitoringTask = brokerService.executor().schedule(this::closeFencedTopicForcefully,\n+                        timeout, TimeUnit.SECONDS);\n+            }\n+        }\n+    }\n+\n+    private synchronized void unfence() {\n+        isFenced = false;\n+        ScheduledFuture<?> monitoringTask = this.fencedTopicMonitoringTask;\n+        if (monitoringTask != null && !monitoringTask.isDone()) {\n+            monitoringTask.cancel(false);\n+        }\n+    }\n+\n+    private synchronized void closeFencedTopicForcefully() {\n+        if (isFenced) {\n+            final int timeout = brokerService.pulsar().getConfiguration().getTopicFencingTimeoutSeconds();\n+            if (isClosingOrDeleting) {\n+                log.warn(\"[{}] Topic remained fenced for {} seconds and is already closed (pendingWriteOps: {})\", topic,\n+                        timeout, pendingWriteOps.get());\n+            } else {\n+                log.error(\"[{}] Topic remained fenced for {} seconds, so close it (pendingWriteOps: {})\", topic,\n+                        timeout, pendingWriteOps.get());\n+                close();", "originalCommit": "ef5b71067709c4ee49da31809fb0c05ce4dfaad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0NjMxOQ==", "url": "https://github.com/apache/pulsar/pull/8561#discussion_r524846319", "bodyText": "I removed \"synchronized\" because there was no clear reason to make this method synchronized.", "author": "massakam", "createdAt": "2020-11-17T02:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3NjMzMw=="}], "type": "inlineReview"}, {"oid": "2255cffc331f49cb13081b8ba82464aa0f0e20b4", "url": "https://github.com/apache/pulsar/commit/2255cffc331f49cb13081b8ba82464aa0f0e20b4", "message": "Close topics that remain fenced forcefully", "committedDate": "2020-11-17T02:12:21Z", "type": "commit"}, {"oid": "5c495685d1028c01bf79cf11ae90e1aef687533b", "url": "https://github.com/apache/pulsar/commit/5c495685d1028c01bf79cf11ae90e1aef687533b", "message": "Fix comments", "committedDate": "2020-11-17T02:12:21Z", "type": "commit"}, {"oid": "2032c994af7ff9d84256c0605a85d42b2ad7c706", "url": "https://github.com/apache/pulsar/commit/2032c994af7ff9d84256c0605a85d42b2ad7c706", "message": "Remove synchronized from closeFencedTopicForcefully method", "committedDate": "2020-11-17T02:33:12Z", "type": "commit"}, {"oid": "2032c994af7ff9d84256c0605a85d42b2ad7c706", "url": "https://github.com/apache/pulsar/commit/2032c994af7ff9d84256c0605a85d42b2ad7c706", "message": "Remove synchronized from closeFencedTopicForcefully method", "committedDate": "2020-11-17T02:33:12Z", "type": "forcePushed"}]}