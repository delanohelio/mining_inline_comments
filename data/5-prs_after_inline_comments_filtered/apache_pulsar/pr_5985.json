{"pr_number": 5985, "pr_title": "[Issue 5935] Support multi pulsar clusters to use the same bk cluster", "pr_createdAt": "2020-01-03T11:22:27Z", "pr_url": "https://github.com/apache/pulsar/pull/5985", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0OTY1Mw==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r368249653", "bodyText": "why do we remove this logic?", "author": "sijie", "createdAt": "2020-01-18T21:32:09Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/PulsarClusterMetadataSetup.java", "diffHunk": "@@ -170,16 +170,11 @@ public static void main(String[] args) throws Exception {\n         ZooKeeper localZk = initZk(arguments.zookeeper, arguments.zkSessionTimeoutMillis);\n         ZooKeeper configStoreZk = initZk(arguments.configurationStore, arguments.zkSessionTimeoutMillis);\n \n-        // Format BookKeeper ledger storage metadata\n+        // Format BookKeeper stream storage metadata\n         ServerConfiguration bkConf = new ServerConfiguration();\n         bkConf.setZkServers(arguments.zookeeper);\n         bkConf.setZkTimeout(arguments.zkSessionTimeoutMillis);\n-        if (localZk.exists(\"/ledgers\", false) == null // only format if /ledgers doesn't exist", "originalCommit": "c45aa699ece48f88dec5dc06134c3524bed83a35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5MDgzMA==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r368290830", "bodyText": "just a mistake, modified.", "author": "murong00", "createdAt": "2020-01-19T12:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0OTY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0OTc1Ng==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r368249756", "bodyText": "in bookkeeper we deprecated using two separate settings. we are encouraging people to use metadata service uri to connect to a zookeeper cluster. we should try to adopt it in Pulsar. Thus if we are adding the support for a separate bookkeeper cluster, let's try to use metadata service uri.", "author": "sijie", "createdAt": "2020-01-18T21:34:06Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -743,6 +743,18 @@\n     private String kinitCommand = \"/usr/bin/kinit\";\n \n     /**** --- BookKeeper Client --- ****/\n+    @FieldContext(\n+        category = CATEGORY_STORAGE_BK,\n+        doc = \"BookKeeper ledgers storage connection string when using a separated BookKeeper cluster.\"\n+            + \" If not set it will use local zookeeper quorum of Pulsar cluster\"\n+    )\n+    private String bookkeeperLedgersStore;", "originalCommit": "c45aa699ece48f88dec5dc06134c3524bed83a35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5MDg0NQ==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r368290845", "bodyText": "done, thanks.", "author": "murong00", "createdAt": "2020-01-19T12:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0OTc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg3ODQ4MQ==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r379878481", "bodyText": "I don't think we should try to construct PulsarService. because the constructor also does a lot of unrelated things.\nI would suggest adding a util function to generate metadata service url from the configuration.", "author": "sijie", "createdAt": "2020-02-16T06:22:38Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/BookKeeperClientFactoryImpl.java", "diffHunk": "@@ -106,6 +106,14 @@ ClientConfiguration createBkClientConfiguration(ServiceConfiguration conf) {\n         bkConf.setNettyMaxFrameSizeBytes(conf.getMaxMessageSize() + Commands.MESSAGE_SIZE_FRAME_PADDING);\n         bkConf.setDiskWeightBasedPlacementEnabled(conf.isBookkeeperDiskWeightBasedPlacementEnabled());\n \n+        if (StringUtils.isNotBlank(conf.getBookkeeperServiceUri())) {\n+            bkConf.setMetadataServiceUri(conf.getBookkeeperServiceUri());\n+        } else {\n+            PulsarService pulsar = new PulsarService(conf);", "originalCommit": "f9acd2592aae9cd7b507fd46003719ff0842c888", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0OTg3Ng==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r383649876", "bodyText": "done.", "author": "murong00", "createdAt": "2020-02-25T04:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg3ODQ4MQ=="}], "type": "inlineReview"}, {"oid": "786b310561ba626a9c41d438ecf00383c9754ae9", "url": "https://github.com/apache/pulsar/commit/786b310561ba626a9c41d438ecf00383c9754ae9", "message": "Add a util function to generate metadata service url", "committedDate": "2020-02-25T04:06:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM5NDQwOA==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r402394408", "bodyText": "It seems ledgersRootPath is much more direct than metadataServiceUri. metadata may lead developer think of \"zookeeper\". How about change this back\uff1f", "author": "jiazhai", "createdAt": "2020-04-02T15:15:16Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/conf/InternalConfigurationData.java", "diffHunk": "@@ -28,19 +28,19 @@\n \n     private String zookeeperServers;\n     private String configurationStoreServers;\n-    private String ledgersRootPath;\n+    private String metadataServiceUri;", "originalCommit": "7de91fa7113dabfbf9ad4213f6f206d41c7cccbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcwOTU1Mw==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r402709553", "bodyText": "@jiazhai In fact, metadataServiceUri here is a uri to connect to a zookeeper cluster, which is used to find bookies. I would prefer to keep it since ledgersRootPath seems more like a path and is using together with zookeeper. As sijie's comment above, we are trying to use a metadata service uri, so how about bkMetadataServiceUri?", "author": "murong00", "createdAt": "2020-04-03T02:57:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM5NDQwOA=="}], "type": "inlineReview"}, {"oid": "e2d7c4b21a2021dbee657dee6bc508ea9c7031a7", "url": "https://github.com/apache/pulsar/commit/e2d7c4b21a2021dbee657dee6bc508ea9c7031a7", "message": "Rename var names and add a test", "committedDate": "2020-04-03T07:10:15Z", "type": "forcePushed"}, {"oid": "4764ebf963627e73d792abedb637111d0f2fd346", "url": "https://github.com/apache/pulsar/commit/4764ebf963627e73d792abedb637111d0f2fd346", "message": "Rename var names and add a test\n\nFix checkstyle", "committedDate": "2020-04-09T02:01:50Z", "type": "forcePushed"}, {"oid": "e4e87bd693df6bd679d699a32fd8e46edd3ae256", "url": "https://github.com/apache/pulsar/commit/e4e87bd693df6bd679d699a32fd8e46edd3ae256", "message": "Support multi pulsar clusters to use the same bk cluster.\n\nRebuild some logic\n\nRebuild some logic\n\nAdded missing changes", "committedDate": "2020-04-14T01:19:20Z", "type": "commit"}, {"oid": "c5062f945f70226121cb40b373a29b5d4ca464f8", "url": "https://github.com/apache/pulsar/commit/c5062f945f70226121cb40b373a29b5d4ca464f8", "message": "Use metadata service uri to init bookkeeper client", "committedDate": "2020-04-14T01:19:20Z", "type": "commit"}, {"oid": "0673e7d4c9f28e75befe8eb3671a13a470f10492", "url": "https://github.com/apache/pulsar/commit/0673e7d4c9f28e75befe8eb3671a13a470f10492", "message": "Add a util function to generate metadata service url\n\nFix a unit test", "committedDate": "2020-04-14T01:19:21Z", "type": "commit"}, {"oid": "b348adfcbe077bc87aa541349b620b5f255f69fd", "url": "https://github.com/apache/pulsar/commit/b348adfcbe077bc87aa541349b620b5f255f69fd", "message": "Rename var names and add a test\n\nFix checkstyle", "committedDate": "2020-04-14T01:19:21Z", "type": "commit"}, {"oid": "b348adfcbe077bc87aa541349b620b5f255f69fd", "url": "https://github.com/apache/pulsar/commit/b348adfcbe077bc87aa541349b620b5f255f69fd", "message": "Rename var names and add a test\n\nFix checkstyle", "committedDate": "2020-04-14T01:19:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MzU4NQ==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r409863585", "bodyText": "I don't think we should add this logic here. We should reply on the logic that bookkeeper already provides. You can do this by using the following code snippet.\nClientConfiguration bkConf = new ClientConfiguration();\nbkConf.setZkServers(config.getZooKeeperServers());\nreturn bkConf.getMetadataServiceUri();", "author": "sijie", "createdAt": "2020-04-16T21:38:12Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -1064,6 +1087,27 @@ public String getSafeBrokerServiceUrl() {\n         return brokerServiceUrl != null ? brokerServiceUrl : brokerServiceUrlTls;\n     }\n \n+    /**\n+     * Get bookkeeper metadata service uri.\n+     *\n+     * @param config broker configuration\n+     * @return the metadata service uri that bookkeeper is used\n+     */\n+    public static String bookieMetadataServiceUri(ServiceConfiguration config) {\n+        ClientConfiguration bkConf = new ClientConfiguration();\n+        // init bookkeeper metadata service uri\n+        String metadataServiceUri = null;\n+        try {", "originalCommit": "b348adfcbe077bc87aa541349b620b5f255f69fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk1MDQ2Mg==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r409950462", "bodyText": "Done.", "author": "murong00", "createdAt": "2020-04-17T02:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MzU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2NDU4NQ==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r409864585", "bodyText": "for backward compatibility, you shouldn't change the field directly.\nYou can add a new field bookkeeperMetadataServiceUri and deprecate the old field ledgersRootPath .", "author": "sijie", "createdAt": "2020-04-16T21:40:04Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/conf/InternalConfigurationData.java", "diffHunk": "@@ -28,19 +28,19 @@\n \n     private String zookeeperServers;\n     private String configurationStoreServers;\n-    private String ledgersRootPath;", "originalCommit": "b348adfcbe077bc87aa541349b620b5f255f69fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk1MDU0NA==", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r409950544", "bodyText": "Thanks for pointing this out, done.", "author": "murong00", "createdAt": "2020-04-17T02:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2NDU4NQ=="}], "type": "inlineReview"}, {"oid": "e8e874851a968c61436d8289e0b34da474cf29e4", "url": "https://github.com/apache/pulsar/commit/e8e874851a968c61436d8289e0b34da474cf29e4", "message": "Deprecated ledgersRootPath and use the logic of bkConf", "committedDate": "2020-04-17T02:00:43Z", "type": "commit"}]}