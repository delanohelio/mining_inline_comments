{"pr_number": 8306, "pr_title": "Support exclude the message when reset cursor by message ID", "pr_createdAt": "2020-10-20T07:16:27Z", "pr_url": "https://github.com/apache/pulsar/pull/8306", "timeline": [{"oid": "382a64400ec93cace0cb24e3a10b0fc07a9bd568", "url": "https://github.com/apache/pulsar/commit/382a64400ec93cace0cb24e3a10b0fc07a9bd568", "message": "Support exclude the message when reset cursor by message ID", "committedDate": "2020-10-20T07:03:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1NDc3MQ==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r508454771", "bodyText": "exclude? I think exclude is more reasonable here.", "author": "codelipenghui", "createdAt": "2020-10-20T12:23:26Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2006,7 +2006,7 @@ private void internalCreateSubscriptionForNonPartitionedTopic(AsyncResponse asyn\n     }\n \n     protected void internalResetCursorOnPosition(AsyncResponse asyncResponse, String subName, boolean authoritative,\n-            MessageIdImpl messageId) {\n+            MessageIdImpl messageId, boolean isExclusive) {", "originalCommit": "382a64400ec93cace0cb24e3a10b0fc07a9bd568", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkzODI4Nw==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r508938287", "bodyText": "I think it might be more appropriate to change to isExclued.I am modifying it.", "author": "315157973", "createdAt": "2020-10-21T01:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1NDc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkzOTgyMw==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r508939823", "bodyText": "I think we'd better do not introduce a new endpoint since we also should support reset to a batchIndex. So it's better to introduce a new construct for the cursor reset request such as ResetCursorData and we and add the isExcluded into the new construct, it looks like\nclass ResetCursorData {\n    ledgerId,\n    entryId,\n    isExcluded\n}\n\nSince we are using the json encoder and decode, I think this will not introduce compatibility issues.", "author": "codelipenghui", "createdAt": "2020-10-21T01:46:12Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/PersistentTopics.java", "diffHunk": "@@ -1219,7 +1219,43 @@ public void resetCursorOnPosition(\n             MessageIdImpl messageId) {\n         try {\n             validateTopicName(tenant, namespace, encodedTopic);\n-            internalResetCursorOnPosition(asyncResponse, decode(encodedSubName), authoritative, messageId);\n+            internalResetCursorOnPosition(asyncResponse, decode(encodedSubName), authoritative, messageId, false);\n+        } catch (Exception e) {\n+            resumeAsyncResponseExceptionally(asyncResponse, e);\n+        }\n+    }\n+    \n+    @POST\n+    @Path(\"/{tenant}/{namespace}/{topic}/subscription/{subName}/resetCursorExclusive\")\n+    @ApiOperation(value = \"Reset subscription to message position closest to given position, \" +\n+            \"and start consume messages from the next position of the reset position.\", notes = \"It fence cursor and disconnects all active consumers before reseting cursor.\")\n+    @ApiResponses(value = {\n+            @ApiResponse(code = 307, message = \"Current broker doesn't serve the namespace of this topic\"),\n+            @ApiResponse(code = 401, message = \"Don't have permission to administrate resources on this tenant or\" +\n+                    \"subscriber is not authorized to access this operation\"),\n+            @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic/Subscription does not exist\"),\n+            @ApiResponse(code = 405, message = \"Not supported for partitioned topics\"),\n+            @ApiResponse(code = 412, message = \"Unable to find position for position specified\"),\n+            @ApiResponse(code = 500, message = \"Internal server error\"),\n+            @ApiResponse(code = 503, message = \"Failed to validate global cluster configuration\") })\n+    public void resetCursorOnPositionExclusive(", "originalCommit": "382a64400ec93cace0cb24e3a10b0fc07a9bd568", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk0MDA3MA==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r508940070", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                CompletableFuture<Void> resetCursorExclusiveAsync(String topic, String subName, MessageId messageId);\n          \n          \n            \n                CompletableFuture<Void> resetCursorAsync(String topic, String subName, MessageId messageId, boolean isExcluded);", "author": "codelipenghui", "createdAt": "2020-10-21T01:47:07Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "diffHunk": "@@ -1314,6 +1325,17 @@ void createSubscription(String topic, String subscriptionName, MessageId message\n      */\n     CompletableFuture<Void> resetCursorAsync(String topic, String subName, long timestamp);\n \n+    /**\n+     * Reset cursor position on a topic subscription.\n+     * <p/>\n+     * and start consume messages from the next position of the reset position.\n+     * @param topic\n+     * @param subName\n+     * @param messageId\n+     * @return\n+     */\n+    CompletableFuture<Void> resetCursorExclusiveAsync(String topic, String subName, MessageId messageId);", "originalCommit": "382a64400ec93cace0cb24e3a10b0fc07a9bd568", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk0MDE1OA==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r508940158", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                void resetCursorExclusive(String topic, String subName, MessageId messageId) throws PulsarAdminException;\n          \n          \n            \n                void resetCursor(String topic, String subName, MessageId messageId, boolean isExcluded) throws PulsarAdminException;", "author": "codelipenghui", "createdAt": "2020-10-21T01:47:29Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "diffHunk": "@@ -1302,6 +1302,17 @@ void createSubscription(String topic, String subscriptionName, MessageId message\n      */\n     void resetCursor(String topic, String subName, long timestamp) throws PulsarAdminException;\n \n+    /**\n+     * Reset cursor position on a topic subscription.\n+     * <p/>\n+     * and start consume messages from the next position of the reset position.\n+     * @param topic\n+     * @param subName\n+     * @param messageId\n+     * @throws PulsarAdminException\n+     */\n+    void resetCursorExclusive(String topic, String subName, MessageId messageId) throws PulsarAdminException;", "originalCommit": "382a64400ec93cace0cb24e3a10b0fc07a9bd568", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd42106164dec3d3e5a03662a5665deb911c1d04", "url": "https://github.com/apache/pulsar/commit/bd42106164dec3d3e5a03662a5665deb911c1d04", "message": "merge api", "committedDate": "2020-10-21T03:45:33Z", "type": "commit"}, {"oid": "3e6c596afac1a7a8b686f8e0b2904ebc3c07e4bb", "url": "https://github.com/apache/pulsar/commit/3e6c596afac1a7a8b686f8e0b2904ebc3c07e4bb", "message": "change style", "committedDate": "2020-10-21T04:03:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk5ODQ5OQ==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r508998499", "bodyText": "How did you maintain backward compatibility on this endpoint?", "author": "sijie", "createdAt": "2020-10-21T05:28:32Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/PersistentTopics.java", "diffHunk": "@@ -1216,15 +1217,17 @@ public void resetCursorOnPosition(\n             @ApiParam(value = \"Is authentication required to perform this operation\")\n             @QueryParam(\"authoritative\") @DefaultValue(\"false\") boolean authoritative,\n             @ApiParam(name = \"messageId\", value = \"messageId to reset back to (ledgerId:entryId)\")\n-            MessageIdImpl messageId) {\n+                    ResetCursorData resetCursorData) {", "originalCommit": "3e6c596afac1a7a8b686f8e0b2904ebc3c07e4bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk5OTM1MA==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r508999350", "bodyText": "How did you maintain backward compatibility on this endpoint?\n\nNow the properties of this object are consistent with the previous MessageId, and there is no problem with Json deserialization.", "author": "315157973", "createdAt": "2020-10-21T05:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk5ODQ5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwMzY0MA==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r509003640", "bodyText": "Can you add an integration test for that?", "author": "sijie", "createdAt": "2020-10-21T05:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk5ODQ5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwODAzNw==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r509008037", "bodyText": "Can you add an integration test for that?\n\nOK", "author": "315157973", "createdAt": "2020-10-21T05:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk5ODQ5OQ=="}], "type": "inlineReview"}, {"oid": "b9ba56d5d1e74c67bb6d36792736fa5033722fda", "url": "https://github.com/apache/pulsar/commit/b9ba56d5d1e74c67bb6d36792736fa5033722fda", "message": "add integration testing", "committedDate": "2020-10-21T07:44:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2NjUzMw==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r509066533", "bodyText": "resetCursorCompatibility is a new method and you are only calling it with 'true' parameter.\nis it expected ?\nwhat about calling also resetCursorCompatibility(serviceUrl, false); ?", "author": "eolivelli", "createdAt": "2020-10-21T07:57:05Z", "path": "tests/integration/src/test/java/org/apache/pulsar/tests/integration/messaging/PersistentTopicMessagingTest.java", "diffHunk": "@@ -63,4 +63,9 @@ public void testNonPartitionedTopicMessagingWithKeyShared(String serviceUrl) thr\n     public void testPartitionedTopicMessagingWithKeyShared(String serviceUrl) throws Exception {\n         partitionedTopicSendAndReceiveWithKeyShared(serviceUrl, true);\n     }\n+\n+    @Test(dataProvider = \"ServiceUrls\")\n+    public void testResetCursorCompatibility(String serviceUrl) throws Exception {\n+        resetCursorCompatibility(serviceUrl, true);", "originalCommit": "b9ba56d5d1e74c67bb6d36792736fa5033722fda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a8c018c67b072657dfa8c01e2c742ef4930d8b26", "url": "https://github.com/apache/pulsar/commit/a8c018c67b072657dfa8c01e2c742ef4930d8b26", "message": "fix unit test", "committedDate": "2020-10-21T08:19:46Z", "type": "commit"}, {"oid": "e5e6cfd76fdafcab72edd9cedaba54855584bc0b", "url": "https://github.com/apache/pulsar/commit/e5e6cfd76fdafcab72edd9cedaba54855584bc0b", "message": "fix unit test", "committedDate": "2020-10-21T09:09:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTIwODU4Mw==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r509208583", "bodyText": "It's need to move the test under the package org.apache.pulsar.tests.integration.backwardscompatibility Otherwise the the test is using the latest broker and latest client, so it can't check the compatibility.", "author": "codelipenghui", "createdAt": "2020-10-21T11:43:07Z", "path": "tests/integration/src/test/java/org/apache/pulsar/tests/integration/messaging/PersistentTopicMessagingTest.java", "diffHunk": "@@ -63,4 +63,9 @@ public void testNonPartitionedTopicMessagingWithKeyShared(String serviceUrl) thr\n     public void testPartitionedTopicMessagingWithKeyShared(String serviceUrl) throws Exception {\n         partitionedTopicSendAndReceiveWithKeyShared(serviceUrl, true);\n     }\n+\n+    @Test(dataProvider = \"ServiceUrls\")\n+    public void testResetCursorCompatibility(String serviceUrl) throws Exception {\n+        resetCursorCompatibility(serviceUrl);", "originalCommit": "e5e6cfd76fdafcab72edd9cedaba54855584bc0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "81aac22068606d4a10d145e564b46cea643cb869", "url": "https://github.com/apache/pulsar/commit/81aac22068606d4a10d145e564b46cea643cb869", "message": "add backwards compatibility", "committedDate": "2020-10-21T12:58:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM1NTI0OA==", "url": "https://github.com/apache/pulsar/pull/8306#discussion_r509355248", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        resetCursorAsync(topic, subName, messageId, true).get(this.readTimeoutMs, TimeUnit.MILLISECONDS);\n          \n          \n            \n                        resetCursorAsync(topic, subName, messageId, isExcluded).get(this.readTimeoutMs, TimeUnit.MILLISECONDS);", "author": "codelipenghui", "createdAt": "2020-10-21T14:50:23Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/internal/TopicsImpl.java", "diffHunk": "@@ -1132,22 +1133,50 @@ public void resetCursor(String topic, String subName, long timestamp) throws Pul\n     @Override\n     public void resetCursor(String topic, String subName, MessageId messageId) throws PulsarAdminException {\n         try {\n-            TopicName tn = validateTopic(topic);\n-            String encodedSubName = Codec.encode(subName);\n-            WebTarget path = topicPath(tn, \"subscription\", encodedSubName, \"resetcursor\");\n-            request(path).post(Entity.entity(messageId, MediaType.APPLICATION_JSON),\n-                            ErrorData.class);\n+            resetCursorAsync(topic, subName, messageId).get(this.readTimeoutMs, TimeUnit.MILLISECONDS);\n+        } catch (ExecutionException e) {\n+            throw (PulsarAdminException) e.getCause();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new PulsarAdminException(e);\n+        } catch (TimeoutException e) {\n+            throw new PulsarAdminException.TimeoutException(e);\n+        } catch (Exception e) {\n+            throw getApiException(e);\n+        }\n+    }\n+\n+    @Override\n+    public void resetCursor(String topic, String subName, MessageId messageId\n+            , boolean isExcluded) throws PulsarAdminException {\n+        try {\n+            resetCursorAsync(topic, subName, messageId, true).get(this.readTimeoutMs, TimeUnit.MILLISECONDS);", "originalCommit": "81aac22068606d4a10d145e564b46cea643cb869", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8db62bb0c2ebd6ced5518c7114d0145edcbc8cc9", "url": "https://github.com/apache/pulsar/commit/8db62bb0c2ebd6ced5518c7114d0145edcbc8cc9", "message": "Update pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/internal/TopicsImpl.java\n\nCo-authored-by: lipenghui <penghui@apache.org>", "committedDate": "2020-10-21T14:51:52Z", "type": "commit"}]}