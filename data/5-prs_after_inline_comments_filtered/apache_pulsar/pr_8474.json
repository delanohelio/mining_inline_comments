{"pr_number": 8474, "pr_title": "Support taking de-duplication snapshots based on time", "pr_createdAt": "2020-11-07T04:38:19Z", "pr_url": "https://github.com/apache/pulsar/pull/8474", "timeline": [{"oid": "b920d0b17f52d63835848688a529154dde4d19a5", "url": "https://github.com/apache/pulsar/commit/b920d0b17f52d63835848688a529154dde4d19a5", "message": "support check deduplication snapshot", "committedDate": "2020-11-07T04:37:47Z", "type": "commit"}, {"oid": "b969a135a47947be86c6f56a508d8696872fa66d", "url": "https://github.com/apache/pulsar/commit/b969a135a47947be86c6f56a508d8696872fa66d", "message": "change spell", "committedDate": "2020-11-07T04:40:43Z", "type": "commit"}, {"oid": "ab07b76d7b48aa47c90f5ea6c6c70c9af2313b7b", "url": "https://github.com/apache/pulsar/commit/ab07b76d7b48aa47c90f5ea6c6c70c9af2313b7b", "message": "add unit test", "committedDate": "2020-11-07T06:38:30Z", "type": "commit"}, {"oid": "1d1b2b2f028b31c3fb94d9663f8dc9b55e9f3bd9", "url": "https://github.com/apache/pulsar/commit/1d1b2b2f028b31c3fb94d9663f8dc9b55e9f3bd9", "message": "use LAC", "committedDate": "2020-11-07T19:28:40Z", "type": "commit"}, {"oid": "b81743f7cb566ddc709ccdd43fbe7e5c088fd23e", "url": "https://github.com/apache/pulsar/commit/b81743f7cb566ddc709ccdd43fbe7e5c088fd23e", "message": "fix npe", "committedDate": "2020-11-08T05:24:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1MzI4NQ==", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519353285", "bodyText": "Can we save creating the pool if the feature is disabled", "author": "eolivelli", "createdAt": "2020-11-08T11:08:46Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -297,6 +298,8 @@ public BrokerService(PulsarService pulsar) throws Exception {\n                 .newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"consumed-Ledgers-monitor\"));\n         this.ledgerFullMonitor =\n                 Executors.newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"ledger-full-monitor\"));\n+        this.deduplicationSnapshotMonitor =", "originalCommit": "b81743f7cb566ddc709ccdd43fbe7e5c088fd23e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1MzczMA==", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519353730", "bodyText": "It looks like we are not shutting down the pool, leaking threads", "author": "eolivelli", "createdAt": "2020-11-08T11:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1MzI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1NjA5Ng==", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519356096", "bodyText": "Oh Yes , I  always forget \ud83d\ude05", "author": "315157973", "createdAt": "2020-11-08T11:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1MzI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1NDUzNw==", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519354537", "bodyText": "Why Integer and not int?", "author": "eolivelli", "createdAt": "2020-11-08T11:12:15Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -413,6 +413,18 @@\n     )\n     private int brokerDeduplicationMaxNumberOfProducers = 10000;\n \n+    @FieldContext(\n+        category = CATEGORY_POLICIES,\n+        doc = \"How often is the thread pool scheduled to check whether a snapshot needs to be taken.(disable with value 0)\"\n+    )\n+    private int brokerDeduplicationSnapshotFrequencyInSeconds = 120;\n+    @FieldContext(\n+        category = CATEGORY_POLICIES,\n+        doc = \"If this time interval is exceeded, a snapshot will be taken.\"\n+            + \"It will run simultaneously with `brokerDeduplicationEntriesInterval`\"\n+    )\n+    private Integer brokerDeduplicationSnapshotIntervalSeconds = 120;", "originalCommit": "b81743f7cb566ddc709ccdd43fbe7e5c088fd23e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1NTYwMA==", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519355600", "bodyText": "Later, we need to support the namespace-level and topic-level. When it is null, it means that this level is not set. Therefore the packaging type is used.", "author": "315157973", "createdAt": "2020-11-08T11:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1NDUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM2Nzk2Mw==", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519367963", "bodyText": "Makes sense.\nOkay.\nThanks for your clarification", "author": "eolivelli", "createdAt": "2020-11-08T11:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1NDUzNw=="}], "type": "inlineReview"}, {"oid": "70a1c83edda4a779785175ada4029b9b58c71a9a", "url": "https://github.com/apache/pulsar/commit/70a1c83edda4a779785175ada4029b9b58c71a9a", "message": "fix npe", "committedDate": "2020-11-08T11:20:43Z", "type": "commit"}]}