{"pr_number": 7605, "pr_title": "Support partitioned topic lookup", "pr_createdAt": "2020-07-20T11:31:27Z", "pr_url": "https://github.com/apache/pulsar/pull/7605", "timeline": [{"oid": "409e3afb60f2cd6d1d466c8fc776e97e205a363e", "url": "https://github.com/apache/pulsar/commit/409e3afb60f2cd6d1d466c8fc776e97e205a363e", "message": "Support partitioned topic lookup", "committedDate": "2020-07-20T11:40:38Z", "type": "forcePushed"}, {"oid": "c212af8cf5e9648a81cfb6f1a4295b281729f6c7", "url": "https://github.com/apache/pulsar/commit/c212af8cf5e9648a81cfb6f1a4295b281729f6c7", "message": "Support partitioned topic lookup", "committedDate": "2020-07-20T12:05:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEzMzc3MA==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r458133770", "bodyText": "If redirect the partitioned topic lookup requests, the target broker will handle the partitioned topic lookup request right? So this may lead to redirect back again, the request can't complete.", "author": "codelipenghui", "createdAt": "2020-07-21T14:19:36Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/lookup/TopicLookupBase.java", "diffHunk": "@@ -127,6 +131,113 @@ protected void internalLookupTopicAsync(TopicName topicName, boolean authoritati\n         });\n     }\n \n+    protected void internalLookupPartitionedTopicAsync(TopicName topicName, boolean authoritative, AsyncResponse asyncResponse) {\n+        if (!pulsar().getBrokerService().getLookupRequestSemaphore().tryAcquire()) {\n+            log.warn(\"No broker was found available for topic {}\", topicName);\n+            asyncResponse.resume(new WebApplicationException(Response.Status.SERVICE_UNAVAILABLE));\n+            return;\n+        }\n+\n+        try {\n+            validateClusterOwnership(topicName.getCluster());\n+            checkConnect(topicName);\n+            validateGlobalNamespaceOwnership(topicName.getNamespaceObject());\n+        } catch (WebApplicationException we) {\n+            // Validation checks failed\n+            log.error(\"Validation check failed: {}\", we.getMessage());\n+            completeLookupResponseExceptionally(asyncResponse, we);\n+            return;\n+        } catch (Throwable t) {\n+            // Validation checks failed with unknown error\n+            log.error(\"Validation check failed: {}\", t.getMessage(), t);\n+            completeLookupResponseExceptionally(asyncResponse, new RestException(t));\n+            return;\n+        }\n+\n+        pulsar().getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).whenComplete(\n+                (metadata, t) -> {\n+                    if (t != null) {\n+                        log.error(\" Can't find partitioned metadata for {}\", topicName);\n+                        completeLookupResponseExceptionally(asyncResponse, new RestException(t));\n+                        return ;\n+                    }\n+\n+                    String domain = topicName.getDomain().value();\n+                    NamespaceName namespace = topicName.getNamespaceObject();\n+                    String topicLocalName = topicName.getLocalName();\n+                    LookupOptions lookupOptions =  LookupOptions.builder().authoritative(authoritative).loadTopicsInBundle(false).build();\n+\n+                    List<CompletableFuture<Optional<LookupResult>>> futureList = new ArrayList<>();\n+                    if (metadata != null && metadata.partitions > 1) {\n+                        for (int i = 0 ; i < metadata.partitions; i ++) {\n+                            TopicName partitionedTopicName = TopicName.get(domain, namespace, topicLocalName + \"-partition-\" + i);\n+                            futureList.add(pulsar().getNamespaceService().getBrokerServiceUrlAsync(partitionedTopicName, lookupOptions));\n+                        }\n+                    } else {\n+                        futureList.add(pulsar().getNamespaceService().getBrokerServiceUrlAsync(topicName, lookupOptions));\n+                    }\n+\n+                    FutureUtil.waitForAll(futureList).whenComplete(\n+                            (ignore, te) -> {\n+                                if (te != null) {\n+                                    log.warn(\"Failed to lookup broker for topic {}: {}\", topicName, te.getMessage(), te);\n+                                    completeLookupResponseExceptionally(asyncResponse, te);\n+                                    return;\n+                                }\n+                                List<LookupData> lookupDataList = new ArrayList<>();\n+                                for (CompletableFuture<Optional<LookupResult>> partitionFuture : futureList) {\n+                                    partitionFuture.thenAccept(optionalResult -> {\n+                                        if (optionalResult == null || !optionalResult.isPresent()) {\n+                                            log.warn(\"No broker was found available for topic {}\", topicName);\n+                                            completeLookupResponseExceptionally(asyncResponse,\n+                                                    new WebApplicationException(Response.Status.SERVICE_UNAVAILABLE));\n+                                            return;\n+                                        }\n+\n+                                        LookupResult result = optionalResult.get();\n+                                        // We have found either a broker that owns the topic, or a broker to which we should redirect the client to\n+                                        if (result.isRedirect()) {\n+                                            boolean newAuthoritative = result.isAuthoritativeRedirect();\n+                                            URI redirect;\n+                                            try {\n+                                                String redirectUrl = isRequestHttps() ? result.getLookupData().getHttpUrlTls()\n+                                                        : result.getLookupData().getHttpUrl();\n+                                                checkNotNull(redirectUrl, \"Redirected cluster's service url is not configured\");\n+                                                String lookupPath = topicName.isV2() ? LOOKUP_PATH_V2 : LOOKUP_PATH_V1;\n+                                                redirect = new URI(String.format(\"%s%s%s?authoritative=%s\", redirectUrl, lookupPath,\n+                                                        topicName.getLookupName(), newAuthoritative));\n+                                            } catch (URISyntaxException | NullPointerException e) {\n+                                                log.error(\"Error in preparing redirect url for {}: {}\", topicName, e.getMessage(), e);\n+                                                completeLookupResponseExceptionally(asyncResponse, e);\n+                                                return;\n+                                            }\n+                                            if (log.isDebugEnabled()) {\n+                                                log.debug(\"Redirect lookup for topic {} to {}\", topicName, redirect);\n+                                            }\n+                                            completeLookupResponseExceptionally(asyncResponse,\n+                                                    new WebApplicationException(Response.temporaryRedirect(redirect).build()));", "originalCommit": "c212af8cf5e9648a81cfb6f1a4295b281729f6c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxODg0OA==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r459918848", "bodyText": "I'll check this later", "author": "aloyszhang", "createdAt": "2020-07-24T08:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEzMzc3MA=="}], "type": "inlineReview"}, {"oid": "a2422b848dd18f9b0a6fa50ad6a539b9a3775a0a", "url": "https://github.com/apache/pulsar/commit/a2422b848dd18f9b0a6fa50ad6a539b9a3775a0a", "message": "Support partitioned topic lookup", "committedDate": "2020-10-04T07:01:34Z", "type": "commit"}, {"oid": "a2422b848dd18f9b0a6fa50ad6a539b9a3775a0a", "url": "https://github.com/apache/pulsar/commit/a2422b848dd18f9b0a6fa50ad6a539b9a3775a0a", "message": "Support partitioned topic lookup", "committedDate": "2020-10-04T07:01:34Z", "type": "forcePushed"}, {"oid": "e714d9decb6acdf3938848256e536cfc0d79c6d6", "url": "https://github.com/apache/pulsar/commit/e714d9decb6acdf3938848256e536cfc0d79c6d6", "message": "fix checkstyle", "committedDate": "2020-10-04T07:57:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA4Mw==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499220083", "bodyText": "This method should return a CompletableFuture as the method above", "author": "eolivelli", "createdAt": "2020-10-04T08:31:30Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Lookup.java", "diffHunk": "@@ -41,6 +42,14 @@\n      */\n     CompletableFuture<String> lookupTopicAsync(String topic);\n \n+    /**\n+     * Lookup a partitioned topic.\n+     *\n+     * @param topic\n+     * @return the broker URL that serves the topic\n+     */", "originalCommit": "e714d9decb6acdf3938848256e536cfc0d79c6d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIzMjAyMg==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499232022", "bodyText": "If a method is async, it should return a  CompletableFuture.\nBut Lookup#llookupPartitionedTopic is not a async method. It just invokes Lookup#lookupTopicAsync internal.", "author": "aloyszhang", "createdAt": "2020-10-04T10:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIzNjM4Mg==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499236382", "bodyText": "I meant that we should provide an async method.\nWhy not?", "author": "eolivelli", "createdAt": "2020-10-04T11:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIzOTEzOA==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499239138", "bodyText": "For the uniform of method name, we should add a aync method for lookupPartitionedTopic.\nBut other method without async  juset  invoke the relative async method.\ne.g.\ngetBundleRange just invoke  getBundleRangeAsync(topic).get(this.readTimeoutMs, TimeUnit.MILLISECONDS)\nBut, lookupPartitionedTopic internal invokes topics.getPartitionedTopicMetadataAsync(topic).get(this.readTimeoutMs, TimeUnit.MILLISECONDS) and\n lookupTopicAsync(partitionTopicName).get(readTimeoutMs, TimeUnit.MILLISECONDS).\nSo it's hard to  tell which is better.", "author": "aloyszhang", "createdAt": "2020-10-04T12:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0Nzk1Mw==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499247953", "bodyText": "Personally I would add lookupPartitionedTopicAsync\nIf the user wants to block it can do it.\nIf we provide only the blocking method it is not possible to turn it into non-blocking", "author": "eolivelli", "createdAt": "2020-10-04T13:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0Nzk2OQ==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499247969", "bodyText": "Personally I would add lookupPartitionedTopicAsync\nIf the user wants to block it can do it.\nIf we provide only the blocking method it is not possible to turn it into non-blocking", "author": "eolivelli", "createdAt": "2020-10-04T13:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwOTQ4NQ==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499309485", "bodyText": "Thanks for your suggenstions @eolivelli .\nI have already add a async method", "author": "aloyszhang", "createdAt": "2020-10-05T01:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA5NA==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499220094", "bodyText": "This method should return a CompletableFuture as the method above", "author": "eolivelli", "createdAt": "2020-10-04T08:31:43Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Lookup.java", "diffHunk": "@@ -41,6 +42,14 @@\n      */\n     CompletableFuture<String> lookupTopicAsync(String topic);\n \n+    /**\n+     * Lookup a partitioned topic.\n+     *\n+     * @param topic\n+     * @return the broker URL that serves the topic\n+     */\n+    Map<String, String> lookupPartitionedTopic(String topic) throws PulsarAdminException;", "originalCommit": "e714d9decb6acdf3938848256e536cfc0d79c6d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "02a4f08613879a916385a37481dca96434a2cf1a", "url": "https://github.com/apache/pulsar/commit/02a4f08613879a916385a37481dca96434a2cf1a", "message": "add async method and test code", "committedDate": "2020-10-05T09:30:54Z", "type": "commit"}, {"oid": "fa544431042700c4dd3c5552c1b368affdd0b9ff", "url": "https://github.com/apache/pulsar/commit/fa544431042700c4dd3c5552c1b368affdd0b9ff", "message": "fix checkstyle", "committedDate": "2020-10-05T09:43:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ3OTY3OA==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499479678", "bodyText": "is this line needed ?", "author": "eolivelli", "createdAt": "2020-10-05T09:55:56Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/lookup/TopicLookupBase.java", "diffHunk": "@@ -26,6 +26,7 @@\n \n import java.net.URI;\n import java.net.URISyntaxException;\n+import java.util.List;", "originalCommit": "fa544431042700c4dd3c5552c1b368affdd0b9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ4MzU1Nw==", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499483557", "bodyText": "removed", "author": "aloyszhang", "createdAt": "2020-10-05T10:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ3OTY3OA=="}], "type": "inlineReview"}, {"oid": "4a403af32bec0264386c3a944683cb9e31255874", "url": "https://github.com/apache/pulsar/commit/4a403af32bec0264386c3a944683cb9e31255874", "message": "remove un-used import", "committedDate": "2020-10-05T10:01:40Z", "type": "commit"}]}