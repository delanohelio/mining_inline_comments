{"pr_number": 8725, "pr_title": "Issue 8677: Cannot get lastMessageId for an empty topic due to message retention", "pr_createdAt": "2020-11-26T16:56:16Z", "pr_url": "https://github.com/apache/pulsar/pull/8725", "timeline": [{"oid": "00f2c5392920fb387085ea346ced3c953e451857", "url": "https://github.com/apache/pulsar/commit/00f2c5392920fb387085ea346ced3c953e451857", "message": "Issue 8677: Cannot get lastMessageId for an empty topic (due to message retention)", "committedDate": "2020-11-25T08:54:27Z", "type": "commit"}, {"oid": "5ef67b865c6ecbe2b6a8420e29277dd5573e66c7", "url": "https://github.com/apache/pulsar/commit/5ef67b865c6ecbe2b6a8420e29277dd5573e66c7", "message": "fix pom", "committedDate": "2020-11-25T09:01:45Z", "type": "commit"}, {"oid": "d4dbb2b82ecc594a3d4ed50d1c17b6ce8f1c477a", "url": "https://github.com/apache/pulsar/commit/d4dbb2b82ecc594a3d4ed50d1c17b6ce8f1c477a", "message": "Issue 8677: Cannot get lastMessageId for an empty topic (due to message retention)", "committedDate": "2020-11-26T16:50:52Z", "type": "commit"}, {"oid": "bce28dcb8caed96447684e3be03c7acd822be4fd", "url": "https://github.com/apache/pulsar/commit/bce28dcb8caed96447684e3be03c7acd822be4fd", "message": "revert", "committedDate": "2020-11-26T16:52:55Z", "type": "commit"}, {"oid": "82f46f724104d35d8b41a3ad4dbe7937d44279b7", "url": "https://github.com/apache/pulsar/commit/82f46f724104d35d8b41a3ad4dbe7937d44279b7", "message": "Fix bug", "committedDate": "2020-11-27T07:43:59Z", "type": "commit"}, {"oid": "9d95a13a591a6616ec28e550d2ff215422b3b432", "url": "https://github.com/apache/pulsar/commit/9d95a13a591a6616ec28e550d2ff215422b3b432", "message": "Merge remote-tracking branch 'origin/master' into fix/lastmessageid-retention", "committedDate": "2020-11-27T07:50:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNzk4Ng==", "url": "https://github.com/apache/pulsar/pull/8725#discussion_r532327986", "bodyText": "I am not sure this is the right fix. It changes the trim behavior which causes a rolled ledger to never be deleted until a new message is produced. I think a correct fix is to fix getLastMessageId behavior to correctly handle an empty ledger case.", "author": "sijie", "createdAt": "2020-11-30T03:22:07Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -2089,6 +2089,10 @@ void internalTrimConsumedLedgers(CompletableFuture<?> promise) {\n                     log.debug(\"[{}] Ledger {} skipped for deletion as it is currently being written to\", name,\n                             ls.getLedgerId());\n                     break;\n+                } else if (currentLastConfirmedEntry != null && ls.getLedgerId() == currentLastConfirmedEntry.getLedgerId()) {", "originalCommit": "9d95a13a591a6616ec28e550d2ff215422b3b432", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQwNjUwMg==", "url": "https://github.com/apache/pulsar/pull/8725#discussion_r532406502", "bodyText": "@sijie thanks for checking\nYes, I don't know what is the expected value for \"lastMessageId\" in this case.\nIt is true that this is a behaviour change in the rollover but my rationale is that if we send an \"empty\" messageId, the consumer (or the \"Reader\" in the case of the user that reported the issue) won't see a consistent sequence of \"lastMessageId\"\nYou can have:\n\ntime 1: last messageId:   X:Y:Z:K\ntime 2 (broker restart): messageId: empty\ntime 3 (after one write): messageId:  X+1:Y:Z:K\nso if you do not restart the broker and everything goes well you do not see that hole in the sequence\n\nIn the case of the user the lastMessageId is used to compute an approximate number of messages to be consumed by the Reader. as the topic is basically \"empty\" the effect is the same, that is: there are no more messages to consume. So your suggestion would make the user happy anyhow.\nRegarding the trim: we are slightly changing the semantics, but as soon as you write a new message, the behavior is the same. Currently (AFAIK but I still have limited knowledge so I may be wrong) there is not strict contract about when a ledger is deleted (and also you won't know when it will be really deleted from the bookies).\nAll in all I would prefer this new behaviour:\n\nthe sequence of lastMessageId does not contain \"holes\"\nthe trim behavior changes but is it already unpredictable\n\nYou point \"data won't ever be deleted if there is no more write to the topic\" is valid, but I am not sure how much impact could have on production users. Is it about privacy laws/data retention rules ?\nbut I am open to change the patch", "author": "eolivelli", "createdAt": "2020-11-30T08:04:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTQ5NA==", "url": "https://github.com/apache/pulsar/pull/8725#discussion_r532411494", "bodyText": "in the case of the user it would be better to have this messageId working as in this patch, although we have strong rules about retention rules due to privacy laws (but you can always have a technical motivation for keeping the data for a while).", "author": "eolivelli", "createdAt": "2020-11-30T08:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwNTQ3NQ==", "url": "https://github.com/apache/pulsar/pull/8725#discussion_r532705475", "bodyText": "but I am not sure how much impact could have on production users. Is it about privacy laws/data retention rules ?\n\nIn a lot of Pulsar user cases, there are topics with relatively low traffic. If there are no writes going to the topic, it will cause accumulating one segment per topic. If there are a lot of such topics, it will cause disk filling up quickly. So I don't think we should change the retention behavior. This is a -1 from me.\nAs I suggested, we should fix getLastMessageId behavior. Because there is one empty message-id. We can still return a messageId with entryId == -1.", "author": "sijie", "createdAt": "2020-11-30T15:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwNjUzMQ==", "url": "https://github.com/apache/pulsar/pull/8725#discussion_r532706531", "bodyText": "@sijie I will adapt the patch as you are requiring.\nThanks for your feedback", "author": "eolivelli", "createdAt": "2020-11-30T16:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNzk4Ng=="}], "type": "inlineReview"}, {"oid": "671f9ee40557cc2bd8758148a117c414633b905e", "url": "https://github.com/apache/pulsar/commit/671f9ee40557cc2bd8758148a117c414633b905e", "message": "address review comments", "committedDate": "2020-11-30T16:28:54Z", "type": "commit"}, {"oid": "f23077495e0595ec67bdb320525ed4f79eb4ee0f", "url": "https://github.com/apache/pulsar/commit/f23077495e0595ec67bdb320525ed4f79eb4ee0f", "message": "Merge remote-tracking branch 'origin/master' into fix/lastmessageid-retention", "committedDate": "2020-11-30T16:29:03Z", "type": "commit"}, {"oid": "fb7d688ac4ca8bd99981a05668af708088b689cc", "url": "https://github.com/apache/pulsar/commit/fb7d688ac4ca8bd99981a05668af708088b689cc", "message": "fix typo", "committedDate": "2020-11-30T16:41:15Z", "type": "commit"}]}