{"pr_number": 7856, "pr_title": "[Transaction] Handle Acknowledge In The Transaction", "pr_createdAt": "2020-08-20T03:01:42Z", "pr_url": "https://github.com/apache/pulsar/pull/7856", "timeline": [{"oid": "40bb0803a3d2c49a0125a821d41f8ae1a88bf172", "url": "https://github.com/apache/pulsar/commit/40bb0803a3d2c49a0125a821d41f8ae1a88bf172", "message": "fix test", "committedDate": "2020-08-20T15:04:46Z", "type": "forcePushed"}, {"oid": "048cf9eceea2be60fa9afe0d823d36e2a780b50e", "url": "https://github.com/apache/pulsar/commit/048cf9eceea2be60fa9afe0d823d36e2a780b50e", "message": "fix", "committedDate": "2020-08-31T13:28:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5NDYwNQ==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482094605", "bodyText": "The method will return before processing the add subscription to the txn, is this an expected behavior?", "author": "codelipenghui", "createdAt": "2020-09-02T14:03:57Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/transaction/TransactionCoordinatorClientImpl.java", "diffHunk": "@@ -176,6 +178,30 @@ public void addPublishPartitionToTxn(TxnID txnID, List<String> partitions) throw\n         return handler.addPublishPartitionToTxnAsync(txnID, partitions);\n     }\n \n+    @Override\n+    public void addSubscriptionToTxn(TxnID txnID, String topic, String subscription)\n+            throws TransactionCoordinatorClientException {\n+        try {\n+            addSubscriptionToTxnAsync(txnID, topic, subscription);", "originalCommit": "7e070703af2a8c713001cae746de50612c42d00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg0ODU2Nw==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482848567", "bodyText": "I miss calling the get().", "author": "gaoran10", "createdAt": "2020-09-03T09:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5NDYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5NTMzMA==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482095330", "bodyText": "The Singleton list is more suitable here. Or maybe you add a thread-local list to avoid introduce many list instance", "author": "codelipenghui", "createdAt": "2020-09-02T14:04:57Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/transaction/TransactionCoordinatorClientImpl.java", "diffHunk": "@@ -176,6 +178,30 @@ public void addPublishPartitionToTxn(TxnID txnID, List<String> partitions) throw\n         return handler.addPublishPartitionToTxnAsync(txnID, partitions);\n     }\n \n+    @Override\n+    public void addSubscriptionToTxn(TxnID txnID, String topic, String subscription)\n+            throws TransactionCoordinatorClientException {\n+        try {\n+            addSubscriptionToTxnAsync(txnID, topic, subscription);\n+        } catch (Exception e) {\n+            throw TransactionCoordinatorClientException.unwrap(e);\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<Void> addSubscriptionToTxnAsync(TxnID txnID, String topic, String subscription) {\n+        TransactionMetaStoreHandler handler = handlerMap.get(txnID.getMostSigBits());\n+        if (handler == null) {\n+            return FutureUtil.failedFuture(\n+                    new TransactionCoordinatorClientException.MetaStoreHandlerNotExistsException(txnID.getMostSigBits()));\n+        }\n+        PulsarApi.Subscription sub = PulsarApi.Subscription.newBuilder()\n+                .setTopic(topic)\n+                .setSubscription(subscription)\n+                .build();\n+        return handler.addSubscriptionToTxn(txnID, Lists.newArrayList(sub));", "originalCommit": "7e070703af2a8c713001cae746de50612c42d00b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5OTc2Ng==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482099766", "bodyText": "Why remove this branch?", "author": "codelipenghui", "createdAt": "2020-09-02T14:10:45Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/TransactionMetadataStoreService.java", "diffHunk": "@@ -207,26 +208,39 @@ public void removeTransactionMetadataStore(TransactionCoordinatorID tcId) {\n \n     private CompletableFuture<Void> endToTB(TxnID txnID, TxnStatus newStatus) {\n         CompletableFuture<Void> resultFuture = new CompletableFuture<>();\n-        List<CompletableFuture<TxnID>> commitFutureList = new ArrayList<>();\n+        List<CompletableFuture<TxnID>> completableFutureList = new ArrayList<>();\n         this.getTxnMeta(txnID).whenComplete((txnMeta, throwable) -> {\n             if (throwable != null) {\n                 resultFuture.completeExceptionally(throwable);\n                 return;\n             }\n+\n+            txnMeta.ackedPartitions().forEach(tbSub -> {\n+                CompletableFuture<TxnID> commitFuture = new CompletableFuture<>();\n+                if (TxnStatus.COMMITTING.equals(newStatus)) {\n+                    commitFuture = tbClient.commitTxnOnSubscription(\n+                            tbSub.getTopic(), tbSub.getSubscription(), txnID.getMostSigBits(), txnID.getLeastSigBits());\n+                } else if (TxnStatus.ABORTING.equals(newStatus)) {\n+                    commitFuture = tbClient.abortTxnOnSubscription(\n+                            tbSub.getTopic(), tbSub.getSubscription(), txnID.getMostSigBits(), txnID.getLeastSigBits());\n+                }\n+                completableFutureList.add(commitFuture);\n+            });\n+\n             txnMeta.producedPartitions().forEach(partition -> {\n                 CompletableFuture<TxnID> commitFuture = new CompletableFuture<>();\n                 if (TxnStatus.COMMITTING.equals(newStatus)) {\n                     commitFuture = tbClient.commitTxnOnTopic(partition, txnID.getMostSigBits(), txnID.getLeastSigBits());\n+                    // TODO commitTxnOnSubscription\n                 } else if (TxnStatus.ABORTING.equals(newStatus)) {\n+                    // TODO abortTxnOnTopic\n                     commitFuture.completeExceptionally(new Throwable(\"Unsupported operation.\"));\n-                } else {\n-                    // Unsupported txnStatus\n-                    commitFuture.completeExceptionally(new Throwable(\"Unsupported txnStatus.\"));", "originalCommit": "7e070703af2a8c713001cae746de50612c42d00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2NzU0NA==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482867544", "bodyText": "I'll revert this.", "author": "gaoran10", "createdAt": "2020-09-03T10:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5OTc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEwNDExMg==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482104112", "bodyText": "Is this a useful change?", "author": "codelipenghui", "createdAt": "2020-09-02T14:16:34Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentSubscription.java", "diffHunk": "@@ -1197,8 +1207,8 @@ public void deleteFailed(ManagedLedgerException exception, Object ctx) {\n         // Reset txdID and position for cumulative ack.\n         PENDING_CUMULATIVE_ACK_TXNID_UPDATER.set(this, null);\n         POSITION_UPDATER.set(this, null);\n-        dispatcher.redeliverUnacknowledgedMessages(consumer, (List<PositionImpl>)\n-                                                                    (List<?>)pendingAckMessageForCurrentTxn.values());\n+//        dispatcher.redeliverUnacknowledgedMessages(consumer, (List<PositionImpl>)\n+//                                                                    (List<?>)pendingAckMessageForCurrentTxn.values());", "originalCommit": "7e070703af2a8c713001cae746de50612c42d00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2NzE5Nw==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482867197", "bodyText": "No, I'll revert this.", "author": "gaoran10", "createdAt": "2020-09-03T10:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEwNDExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjExMDk0Ng==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482110946", "bodyText": "There is the same struct in PulsarApi.proto named Subscription, maybe you can use that one directly.", "author": "codelipenghui", "createdAt": "2020-09-02T14:25:29Z", "path": "pulsar-transaction/coordinator/src/main/java/org/apache/pulsar/transaction/coordinator/TransactionSubscription.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.transaction.coordinator;\n+\n+import com.google.common.base.Objects;\n+import lombok.Builder;\n+import lombok.Data;\n+\n+/**\n+ * A class for representing acked topic subscription info.\n+ */\n+@Data\n+@Builder\n+public class TransactionSubscription implements Comparable<TransactionSubscription> {", "originalCommit": "7e070703af2a8c713001cae746de50612c42d00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2NzI5NA==", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482867294", "bodyText": "There is a problem, I can't override the hashCode method of the Subscription and it can't be used in a Set collection.", "author": "gaoran10", "createdAt": "2020-09-03T10:13:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjExMDk0Ng=="}], "type": "inlineReview"}, {"oid": "8b2bfacca0225c09b36fe690e95a0b16a48dab0a", "url": "https://github.com/apache/pulsar/commit/8b2bfacca0225c09b36fe690e95a0b16a48dab0a", "message": "handle acknowledge in transaction", "committedDate": "2020-09-03T02:35:47Z", "type": "commit"}, {"oid": "1bbefc1178d3eebfa73d8ad310d9a98fee283273", "url": "https://github.com/apache/pulsar/commit/1bbefc1178d3eebfa73d8ad310d9a98fee283273", "message": "fix test", "committedDate": "2020-09-03T02:35:48Z", "type": "commit"}, {"oid": "78d6ccdae776b918590b5f6001e264b112d46d2f", "url": "https://github.com/apache/pulsar/commit/78d6ccdae776b918590b5f6001e264b112d46d2f", "message": "fix test", "committedDate": "2020-09-03T02:35:48Z", "type": "commit"}, {"oid": "e3f6995bdc21989210cb8ef2e73158cdc4c084b0", "url": "https://github.com/apache/pulsar/commit/e3f6995bdc21989210cb8ef2e73158cdc4c084b0", "message": "fix test", "committedDate": "2020-09-03T02:35:48Z", "type": "commit"}, {"oid": "44c2872c86a26c36c4bc5fa2989cd41dfcd507d5", "url": "https://github.com/apache/pulsar/commit/44c2872c86a26c36c4bc5fa2989cd41dfcd507d5", "message": "change ack subscriptions in MetaImpl from `String` to `TransactionSubscription`", "committedDate": "2020-09-03T02:39:30Z", "type": "commit"}, {"oid": "aed77c3a2209f6abfb41759abe1feb72cda5d812", "url": "https://github.com/apache/pulsar/commit/aed77c3a2209f6abfb41759abe1feb72cda5d812", "message": "fix", "committedDate": "2020-09-03T02:40:40Z", "type": "commit"}, {"oid": "abb3fccc992f9c891c80f60c2d03bd69ef4da023", "url": "https://github.com/apache/pulsar/commit/abb3fccc992f9c891c80f60c2d03bd69ef4da023", "message": "fix", "committedDate": "2020-09-03T02:40:40Z", "type": "commit"}, {"oid": "8fee6b363f8ba6a43eb64b3f55ce67806d572626", "url": "https://github.com/apache/pulsar/commit/8fee6b363f8ba6a43eb64b3f55ce67806d572626", "message": "fix check style", "committedDate": "2020-09-03T02:40:40Z", "type": "commit"}, {"oid": "105b064b4737569a82a1591c464b45ef73fd1b9d", "url": "https://github.com/apache/pulsar/commit/105b064b4737569a82a1591c464b45ef73fd1b9d", "message": "fix test", "committedDate": "2020-09-03T02:40:40Z", "type": "commit"}, {"oid": "fb9ddf0f3e48dec97e7035e9478b187ec280b7cf", "url": "https://github.com/apache/pulsar/commit/fb9ddf0f3e48dec97e7035e9478b187ec280b7cf", "message": "fix", "committedDate": "2020-09-03T10:39:51Z", "type": "commit"}, {"oid": "fb9ddf0f3e48dec97e7035e9478b187ec280b7cf", "url": "https://github.com/apache/pulsar/commit/fb9ddf0f3e48dec97e7035e9478b187ec280b7cf", "message": "fix", "committedDate": "2020-09-03T10:39:51Z", "type": "forcePushed"}]}