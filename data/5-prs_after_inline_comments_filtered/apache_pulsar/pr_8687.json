{"pr_number": 8687, "pr_title": "Add timeout to hasMessageAvailable to leader election process in Pulsar Functions", "pr_createdAt": "2020-11-24T18:31:45Z", "pr_url": "https://github.com/apache/pulsar/pull/8687", "timeline": [{"oid": "3d8536e2b2cb6a346669e2c715b8d8749b8fd8c9", "url": "https://github.com/apache/pulsar/commit/3d8536e2b2cb6a346669e2c715b8d8749b8fd8c9", "message": "Add timeout to hasMessageAvailable to leader election process in Pulsar Functions", "committedDate": "2020-11-24T18:28:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUxMzIxMQ==", "url": "https://github.com/apache/pulsar/pull/8687#discussion_r530513211", "bodyText": "It's dangerous to have a timeout here, because we might miss messages. Instead we should rely on the timeout in the GetLastMessageId RPC (which should be already there now)", "author": "merlimat", "createdAt": "2020-11-25T16:47:00Z", "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionAssignmentTailer.java", "diffHunk": "@@ -145,7 +145,7 @@ private Thread getTailerThread() {\n                 try {\n                     Message<byte[]> msg = reader.readNext(1, TimeUnit.SECONDS);\n                     if (msg == null) {\n-                        if (exitOnEndOfTopic && !reader.hasMessageAvailable()) {\n+                        if (exitOnEndOfTopic && !reader.hasMessageAvailableAsync().get(10, TimeUnit.SECONDS)) {", "originalCommit": "3d8536e2b2cb6a346669e2c715b8d8749b8fd8c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4OTI0Mw==", "url": "https://github.com/apache/pulsar/pull/8687#discussion_r530689243", "bodyText": "When the timeout expires, a TimeoutException will be thrown and which will force the worker to shutdown and restart.  Another worker can more process to becoming leader.", "author": "jerrypeng", "createdAt": "2020-11-25T23:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUxMzIxMQ=="}], "type": "inlineReview"}]}