{"pr_number": 6471, "pr_title": "[Issue #5395][broker] Implement AutoTopicCreation by namespace override", "pr_createdAt": "2020-03-04T20:18:26Z", "pr_url": "https://github.com/apache/pulsar/pull/6471", "timeline": [{"oid": "9e6ee252cd0aa1d37570d874b13f25ba2893641c", "url": "https://github.com/apache/pulsar/commit/9e6ee252cd0aa1d37570d874b13f25ba2893641c", "message": "Add allowAutoTopicCreation option to policies and CLI", "committedDate": "2020-02-12T03:24:49Z", "type": "commit"}, {"oid": "f60eeae6a970513f00ba05c96c1170291cd98ef1", "url": "https://github.com/apache/pulsar/commit/f60eeae6a970513f00ba05c96c1170291cd98ef1", "message": "Auto-create by namespace MVP", "committedDate": "2020-02-12T05:46:59Z", "type": "commit"}, {"oid": "e960426c69cf8ea5ee402eecd6baae5d894bd809", "url": "https://github.com/apache/pulsar/commit/e960426c69cf8ea5ee402eecd6baae5d894bd809", "message": "Refactor to allow partitioned topics, added tests", "committedDate": "2020-02-22T02:04:07Z", "type": "commit"}, {"oid": "bb50b3b35817257cb0fbfd10e969d469622193e2", "url": "https://github.com/apache/pulsar/commit/bb50b3b35817257cb0fbfd10e969d469622193e2", "message": "Merge branch 'master' into feature/autocreate-by-namespace", "committedDate": "2020-02-22T02:06:01Z", "type": "commit"}, {"oid": "0a92e59423ce88686ec43056cf377a3f67139182", "url": "https://github.com/apache/pulsar/commit/0a92e59423ce88686ec43056cf377a3f67139182", "message": "Cleanup commented code, imports", "committedDate": "2020-02-22T02:19:52Z", "type": "commit"}, {"oid": "8bd458f2eab3c0b4025e1b2655999c9f144caea4", "url": "https://github.com/apache/pulsar/commit/8bd458f2eab3c0b4025e1b2655999c9f144caea4", "message": "Tweak override validation", "committedDate": "2020-02-22T02:48:10Z", "type": "commit"}, {"oid": "49f443c02565aa5510cfab0395677b71e05fb626", "url": "https://github.com/apache/pulsar/commit/49f443c02565aa5510cfab0395677b71e05fb626", "message": "More cleanup, documentation, tests", "committedDate": "2020-02-22T03:09:03Z", "type": "commit"}, {"oid": "0752ccf2e8da69f13a7bf045e7e679278702fe5d", "url": "https://github.com/apache/pulsar/commit/0752ccf2e8da69f13a7bf045e7e679278702fe5d", "message": "Add default partition type", "committedDate": "2020-02-27T16:53:21Z", "type": "commit"}, {"oid": "ee3a3dc37734bbd8b8243cb31c26f7f3424eac19", "url": "https://github.com/apache/pulsar/commit/ee3a3dc37734bbd8b8243cb31c26f7f3424eac19", "message": "Add license to new pulsar-common files", "committedDate": "2020-02-27T22:03:00Z", "type": "commit"}, {"oid": "454b8c03ca5457a022451f7b28ef16d2387d06eb", "url": "https://github.com/apache/pulsar/commit/454b8c03ca5457a022451f7b28ef16d2387d06eb", "message": "Remove null check that could cause silent failure", "committedDate": "2020-03-03T16:13:25Z", "type": "commit"}, {"oid": "4f31397884a0ba5fc8c671c9cb0b89d61745ecd3", "url": "https://github.com/apache/pulsar/commit/4f31397884a0ba5fc8c671c9cb0b89d61745ecd3", "message": "Switch back to synchronous policy retreival", "committedDate": "2020-03-03T22:57:10Z", "type": "commit"}, {"oid": "d5aa45f870d879e80240be50b0775bbec892d6de", "url": "https://github.com/apache/pulsar/commit/d5aa45f870d879e80240be50b0775bbec892d6de", "message": "Merge branch 'master' into feature/autocreate-by-namespace", "committedDate": "2020-03-04T19:28:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyNDE2OA==", "url": "https://github.com/apache/pulsar/pull/6471#discussion_r389224168", "bodyText": "It's better to leverage with AsyncResponse, you can take a look https://github.com/apache/pulsar/blob/master/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/PersistentTopics.java#L198.", "author": "codelipenghui", "createdAt": "2020-03-07T03:37:43Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/Namespaces.java", "diffHunk": "@@ -298,6 +299,28 @@ public void modifyDeduplication(@PathParam(\"tenant\") String tenant, @PathParam(\"\n         internalModifyDeduplication(enableDeduplication);\n     }\n \n+    @POST\n+    @Path(\"/{tenant}/{namespace}/allowAutoTopicCreationOverride\")\n+    @ApiOperation(value = \"Override broker's allowAutoTopicCreation setting for a namespace\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Tenant or cluster or namespace doesn't exist\"),\n+            @ApiResponse(code = 400, message = \"Invalid autoTopicCreation override\") })\n+    public void setAllowAutoTopicCreationOverride(@PathParam(\"tenant\") String tenant, @PathParam(\"namespace\") String namespace,", "originalCommit": "d5aa45f870d879e80240be50b0775bbec892d6de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyNDE4Mw==", "url": "https://github.com/apache/pulsar/pull/6471#discussion_r389224183", "bodyText": "Same as above comment.", "author": "codelipenghui", "createdAt": "2020-03-07T03:38:00Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/Namespaces.java", "diffHunk": "@@ -298,6 +299,28 @@ public void modifyDeduplication(@PathParam(\"tenant\") String tenant, @PathParam(\"\n         internalModifyDeduplication(enableDeduplication);\n     }\n \n+    @POST\n+    @Path(\"/{tenant}/{namespace}/allowAutoTopicCreationOverride\")\n+    @ApiOperation(value = \"Override broker's allowAutoTopicCreation setting for a namespace\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Tenant or cluster or namespace doesn't exist\"),\n+            @ApiResponse(code = 400, message = \"Invalid autoTopicCreation override\") })\n+    public void setAllowAutoTopicCreationOverride(@PathParam(\"tenant\") String tenant, @PathParam(\"namespace\") String namespace,\n+                                                  AutoTopicCreationOverride autoTopicCreationOverride) {\n+        validateNamespaceName(tenant, namespace);\n+        internalSetAllowAutoTopicCreationOverride(autoTopicCreationOverride);\n+    }\n+\n+    @DELETE\n+    @Path(\"/{tenant}/{namespace}/allowAutoTopicCreationOverride\")\n+    @ApiOperation(value = \"Remove override of broker's allowAutoTopicCreation in a namespace\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Tenant or cluster or namespace doesn't exist\") })\n+    public void removeAllowAutoTopicCreationOverride(@PathParam(\"tenant\") String tenant, @PathParam(\"namespace\") String namespace) {", "originalCommit": "d5aa45f870d879e80240be50b0775bbec892d6de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bee6179510f56e347259e45d2fd07ff67c689325", "url": "https://github.com/apache/pulsar/commit/bee6179510f56e347259e45d2fd07ff67c689325", "message": "Merge branch 'master' into feature/autocreate-by-namespace", "committedDate": "2020-03-09T16:59:24Z", "type": "commit"}, {"oid": "423562b873fd7370756e01c94553311db282646b", "url": "https://github.com/apache/pulsar/commit/423562b873fd7370756e01c94553311db282646b", "message": "Make API async, renaming", "committedDate": "2020-03-10T18:46:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY1NzUzNg==", "url": "https://github.com/apache/pulsar/pull/6471#discussion_r392657536", "bodyText": "We'd better complete the asyncResponse when there are RunTimeException occurs. Otherwise, the client just can get a 500 response but can't get any error messages.", "author": "codelipenghui", "createdAt": "2020-03-15T09:48:09Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -554,6 +555,105 @@ protected void internalSetNamespaceMessageTTL(int messageTTL) {\n         }\n     }\n \n+    protected void internalSetAutoTopicCreationOverride(AsyncResponse asyncResponse, AutoTopicCreationOverride autoTopicCreationOverride) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+\n+        if (!AutoTopicCreationOverride.isValidOverride(autoTopicCreationOverride)) {\n+            throw new RestException(Status.PRECONDITION_FAILED, \"Invalid configuration for autoTopicCreationOverride\");\n+        }", "originalCommit": "423562b873fd7370756e01c94553311db282646b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY1NzU1Nw==", "url": "https://github.com/apache/pulsar/pull/6471#discussion_r392657557", "bodyText": "Same as above comment.", "author": "codelipenghui", "createdAt": "2020-03-15T09:48:26Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -554,6 +555,105 @@ protected void internalSetNamespaceMessageTTL(int messageTTL) {\n         }\n     }\n \n+    protected void internalSetAutoTopicCreationOverride(AsyncResponse asyncResponse, AutoTopicCreationOverride autoTopicCreationOverride) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+\n+        if (!AutoTopicCreationOverride.isValidOverride(autoTopicCreationOverride)) {\n+            throw new RestException(Status.PRECONDITION_FAILED, \"Invalid configuration for autoTopicCreationOverride\");\n+        }\n+\n+        // Force to read the data s.t. the watch to the cache content is setup.\n+        policiesCache().getWithStatAsync(path(POLICIES, namespaceName.toString())).thenApply(\n+                policies -> {\n+                    if (policies.isPresent()) {\n+                        Entry<Policies, Stat> policiesNode = policies.get();\n+                        policiesNode.getKey().autoTopicCreationOverride = autoTopicCreationOverride;\n+                        try {\n+                            // Write back the new policies into zookeeper\n+                            globalZk().setData(path(POLICIES, namespaceName.toString()),\n+                                    jsonMapper().writeValueAsBytes(policiesNode.getKey()), policiesNode.getValue().getVersion());\n+                            policiesCache().invalidate(path(POLICIES, namespaceName.toString()));\n+                            asyncResponse.resume(Response.noContent().build());\n+                            log.info(\"[{}] Successfully {} on namespace {}\", clientAppId(),\n+                                    autoTopicCreationOverride.allowAutoTopicCreation ? \"enabled\" : \"disabled\", namespaceName);\n+                            return null;\n+                        } catch (KeeperException.NoNodeException e) {\n+                            log.error(\"[{}] Failed to modify autoTopicCreation status for namespace {}: does not exist\", clientAppId(),\n+                                    namespaceName);\n+                            asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Namespace does not exist\"));\n+                            return null;\n+                        } catch (KeeperException.BadVersionException e) {\n+                            log.error(\n+                                    \"[{}] Failed to modify autoTopicCreation status on namespace {} expected policy node version={} : concurrent modification\",\n+                                    clientAppId(), namespaceName, policiesNode.getValue().getVersion());\n+\n+                            asyncResponse.resume(new RestException(Status.CONFLICT, \"Concurrent modification\"));\n+                            return null;\n+                        } catch (Exception e) {\n+                            log.error(\"[{}] Failed to modify autoTopicCreation status on namespace {}\", clientAppId(), namespaceName, e);\n+                            asyncResponse.resume(new RestException(e));\n+                            return null;\n+                        }\n+                    } else {\n+                        asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Namespace \" + namespaceName + \" does not exist\"));\n+                        return null;\n+                    }\n+                }\n+        ).exceptionally(e -> {\n+            log.error(\"[{}] Failed to modify autoTopicCreation status on namespace {}\", clientAppId(), namespaceName, e);\n+            asyncResponse.resume(new RestException(e));\n+            return null;\n+        });\n+    }\n+\n+    protected void internalRemoveAutoTopicCreationOverride(AsyncResponse asyncResponse) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();", "originalCommit": "423562b873fd7370756e01c94553311db282646b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "163811add3f869b4e0aca6f820ac0f32eb787961", "url": "https://github.com/apache/pulsar/commit/163811add3f869b4e0aca6f820ac0f32eb787961", "message": "Add clause to resume async response on exceptions", "committedDate": "2020-03-16T16:30:36Z", "type": "commit"}, {"oid": "5897a8dea36bc2556659e3058c30aa0d2e966bb0", "url": "https://github.com/apache/pulsar/commit/5897a8dea36bc2556659e3058c30aa0d2e966bb0", "message": "Merge branch 'master' into feature/autocreate-by-namespace", "committedDate": "2020-03-17T17:22:55Z", "type": "commit"}, {"oid": "9957a3b51ca484693dd553857538c6996e9222a4", "url": "https://github.com/apache/pulsar/commit/9957a3b51ca484693dd553857538c6996e9222a4", "message": "Remove override from method names", "committedDate": "2020-03-17T18:06:43Z", "type": "commit"}, {"oid": "84f4e4a92e9002faffeec9ab780f71445b49a8de", "url": "https://github.com/apache/pulsar/commit/84f4e4a92e9002faffeec9ab780f71445b49a8de", "message": "Merge branch 'master' into feature/autocreate-by-namespace", "committedDate": "2020-03-20T21:28:08Z", "type": "commit"}, {"oid": "102ccfe85239d0b1889a6181fa18501e689e5cc9", "url": "https://github.com/apache/pulsar/commit/102ccfe85239d0b1889a6181fa18501e689e5cc9", "message": "Fix typo", "committedDate": "2020-03-20T21:43:06Z", "type": "commit"}, {"oid": "bafdb7045e344d14de5ffe34ee3e5ca7c9a224a1", "url": "https://github.com/apache/pulsar/commit/bafdb7045e344d14de5ffe34ee3e5ca7c9a224a1", "message": "Merge branch 'master' into feature/autocreate-by-namespace", "committedDate": "2020-03-23T16:58:55Z", "type": "commit"}, {"oid": "221ddabfa8d50b39f0b7375dcfb36593379e8158", "url": "https://github.com/apache/pulsar/commit/221ddabfa8d50b39f0b7375dcfb36593379e8158", "message": "Merge branch 'master' into feature/autocreate-by-namespace", "committedDate": "2020-03-25T01:41:06Z", "type": "commit"}, {"oid": "f237b22104c93c9fdeeeb3a4e9066d6853881748", "url": "https://github.com/apache/pulsar/commit/f237b22104c93c9fdeeeb3a4e9066d6853881748", "message": "Fix pulsar-client-admin style", "committedDate": "2020-03-25T15:38:59Z", "type": "commit"}]}