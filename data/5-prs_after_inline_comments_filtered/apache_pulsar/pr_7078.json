{"pr_number": 7078, "pr_title": "introduce precise topic publish rate limiting", "pr_createdAt": "2020-05-28T05:09:25Z", "pr_url": "https://github.com/apache/pulsar/pull/7078", "timeline": [{"oid": "183766adf6237f8b689f1caf0b674ae9744edc2f", "url": "https://github.com/apache/pulsar/commit/183766adf6237f8b689f1caf0b674ae9744edc2f", "message": "introduce precise topic publish rate limiting", "committedDate": "2020-05-28T05:30:19Z", "type": "forcePushed"}, {"oid": "e124a91c83004085e2e616722f04a509234c1752", "url": "https://github.com/apache/pulsar/commit/e124a91c83004085e2e616722f04a509234c1752", "message": "introduce precise topic publish rate limiting", "committedDate": "2020-05-28T05:34:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI2Mzk2OA==", "url": "https://github.com/apache/pulsar/pull/7078#discussion_r432263968", "bodyText": "I'd say in general to avoid volatile in all cases in which the exact semantic of read after write consistency is required. In this case we can probably just rely on dirty reads", "author": "merlimat", "createdAt": "2020-05-29T05:32:29Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/PublishRateLimiter.java", "diffHunk": "@@ -66,6 +69,83 @@\n      * @param clusterName\n      */\n     void update(PublishRate maxPublishRate);\n+\n+    /**\n+     * try to acquire permit\n+     * @param numbers\n+     * @param bytes\n+     * */\n+    boolean tryAcquire(int numbers, long bytes);\n+}\n+\n+class PrecisPublishLimiter implements PublishRateLimiter {\n+    protected volatile int publishMaxMessageRate = 0;", "originalCommit": "e124a91c83004085e2e616722f04a509234c1752", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQzNTcyNQ==", "url": "https://github.com/apache/pulsar/pull/7078#discussion_r432435725", "bodyText": "@merlimat  There will be barely concurrent update of these fields, so I think volatile here is ok.  Do you suggest to remove it ?", "author": "aloyszhang", "createdAt": "2020-05-29T11:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI2Mzk2OA=="}], "type": "inlineReview"}, {"oid": "b91a9749f13af0d3f40db322d1e8e1d6bf2beffc", "url": "https://github.com/apache/pulsar/commit/b91a9749f13af0d3f40db322d1e8e1d6bf2beffc", "message": "introduce precise topic publish rate limiting", "committedDate": "2020-06-01T02:03:49Z", "type": "commit"}, {"oid": "b91a9749f13af0d3f40db322d1e8e1d6bf2beffc", "url": "https://github.com/apache/pulsar/commit/b91a9749f13af0d3f40db322d1e8e1d6bf2beffc", "message": "introduce precise topic publish rate limiting", "committedDate": "2020-06-01T02:03:49Z", "type": "forcePushed"}, {"oid": "743ae77cc6a3a07c72a1cfcc1079fa677a29a19c", "url": "https://github.com/apache/pulsar/commit/743ae77cc6a3a07c72a1cfcc1079fa677a29a19c", "message": "add license header", "committedDate": "2020-06-01T03:34:38Z", "type": "commit"}]}