{"pr_number": 6034, "pr_title": "[Pulsar IO][Issue 5633]Support avro schema for debezium connector", "pr_createdAt": "2020-01-12T11:55:36Z", "pr_url": "https://github.com/apache/pulsar/pull/6034", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0MjA4OQ==", "url": "https://github.com/apache/pulsar/pull/6034#discussion_r376142089", "bodyText": "I don't think this needs to be a class variable. what method is using this variable except the constructor?", "author": "sijie", "createdAt": "2020-02-06T23:35:08Z", "path": "pulsar-io/kafka-connect-adaptor/src/main/java/org/apache/pulsar/io/kafka/connect/KafkaConnectSource.java", "diffHunk": "@@ -188,15 +198,48 @@ public void close() {\n         @Getter\n         Optional<String> destinationTopic;\n \n+        private final AvroData avroData;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema keyAvroSchema;", "originalCommit": "bde744ddb6abe80850dc4357e0ec1de7ed9e86a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0MjE1Mg==", "url": "https://github.com/apache/pulsar/pull/6034#discussion_r376142152", "bodyText": "same comments as above.", "author": "sijie", "createdAt": "2020-02-06T23:35:20Z", "path": "pulsar-io/kafka-connect-adaptor/src/main/java/org/apache/pulsar/io/kafka/connect/KafkaConnectSource.java", "diffHunk": "@@ -188,15 +198,48 @@ public void close() {\n         @Getter\n         Optional<String> destinationTopic;\n \n+        private final AvroData avroData;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema keyAvroSchema;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema valueAvroSchema;", "originalCommit": "bde744ddb6abe80850dc4357e0ec1de7ed9e86a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0MjYxMA==", "url": "https://github.com/apache/pulsar/pull/6034#discussion_r376142610", "bodyText": "why do we need to make this variable a class variable? it is only used in the constructor.", "author": "sijie", "createdAt": "2020-02-06T23:36:56Z", "path": "pulsar-io/kafka-connect-adaptor/src/main/java/org/apache/pulsar/io/kafka/connect/KafkaConnectSource.java", "diffHunk": "@@ -188,15 +198,48 @@ public void close() {\n         @Getter\n         Optional<String> destinationTopic;\n \n+        private final AvroData avroData;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema keyAvroSchema;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema valueAvroSchema;\n+\n+        private final KafkaSchema keySchema;\n+\n+        private final KafkaSchema valueSchema;\n+\n+        private byte[] keyBytes;", "originalCommit": "bde744ddb6abe80850dc4357e0ec1de7ed9e86a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0MjY2NA==", "url": "https://github.com/apache/pulsar/pull/6034#discussion_r376142664", "bodyText": "same comment as above.", "author": "sijie", "createdAt": "2020-02-06T23:37:06Z", "path": "pulsar-io/kafka-connect-adaptor/src/main/java/org/apache/pulsar/io/kafka/connect/KafkaConnectSource.java", "diffHunk": "@@ -188,15 +198,48 @@ public void close() {\n         @Getter\n         Optional<String> destinationTopic;\n \n+        private final AvroData avroData;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema keyAvroSchema;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema valueAvroSchema;\n+\n+        private final KafkaSchema keySchema;\n+\n+        private final KafkaSchema valueSchema;\n+\n+        private byte[] keyBytes;\n+\n+        private byte[] valueBytes;", "originalCommit": "bde744ddb6abe80850dc4357e0ec1de7ed9e86a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0MzUyMA==", "url": "https://github.com/apache/pulsar/pull/6034#discussion_r376143520", "bodyText": "actually I think the cache here is incorrect. you need a cache from kafka connect schema to pulsar schema.\nCache<org.apache.kafka.connect.data.Schema, KafkaSchema>", "author": "sijie", "createdAt": "2020-02-06T23:39:57Z", "path": "pulsar-io/kafka-connect-adaptor/src/main/java/org/apache/pulsar/io/kafka/connect/KafkaConnectSource.java", "diffHunk": "@@ -188,15 +198,48 @@ public void close() {\n         @Getter\n         Optional<String> destinationTopic;\n \n+        private final AvroData avroData;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema keyAvroSchema;\n+\n+        private org.apache.pulsar.kafka.shade.avro.Schema valueAvroSchema;\n+\n+        private final KafkaSchema keySchema;\n+\n+        private final KafkaSchema valueSchema;\n+\n+        private byte[] keyBytes;\n+\n+        private byte[] valueBytes;\n+\n         KafkaSourceRecord(SourceRecord srcRecord) {\n-            byte[] keyBytes = keyConverter.fromConnectData(\n+            keyBytes = keyConverter.fromConnectData(\n                 srcRecord.topic(), srcRecord.keySchema(), srcRecord.key());\n-            byte[] valueBytes = valueConverter.fromConnectData(\n+            valueBytes = valueConverter.fromConnectData(\n                 srcRecord.topic(), srcRecord.valueSchema(), srcRecord.value());\n+            this.avroData = new AvroData(1000);\n             this.key = keyBytes != null ? Optional.of(Base64.getEncoder().encodeToString(keyBytes)) : Optional.empty();\n             this.value = new KeyValue(keyBytes, valueBytes);\n \n             this.topicName = Optional.of(srcRecord.topic());\n+            String keyName = this.topicName.get() + \"-key\";\n+            String valueName = this.topicName.get() + \"-value\";\n+\n+            if (readerCache.getIfPresent(keyName) == null", "originalCommit": "bde744ddb6abe80850dc4357e0ec1de7ed9e86a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a94785f875bbce78d830f54b221b4b0d4a8b4dd5", "url": "https://github.com/apache/pulsar/commit/a94785f875bbce78d830f54b221b4b0d4a8b4dd5", "message": "debezium connect source support `org.apache.pulsar.kafka.shade.io.confluent.connect.avro.AvroConverter`, add integration test", "committedDate": "2020-04-17T03:10:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcwMTM4Nw==", "url": "https://github.com/apache/pulsar/pull/6034#discussion_r410701387", "bodyText": "There are two properties name definition in the SchemaDefinitionBuilderImpl.  I think you can move all of them to SchemaDefinition and keep the with prefix \"__\".", "author": "codelipenghui", "createdAt": "2020-04-18T13:57:45Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/generic/GenericAvroReader.java", "diffHunk": "@@ -47,6 +47,10 @@\n     private final List<Field> fields;\n     private final Schema schema;\n     private final byte[] schemaVersion;\n+\n+    private int offset;\n+    public final static String OFFSET_PROP = \"AVRO_READ_OFFSET\";", "originalCommit": "a94785f875bbce78d830f54b221b4b0d4a8b4dd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e3c344b71159305a69e9d8a7a3748b2fa0efe153", "url": "https://github.com/apache/pulsar/commit/e3c344b71159305a69e9d8a7a3748b2fa0efe153", "message": "Add avro parse", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "a0699dfc1559484b275eeffade47adf3bb194f08", "url": "https://github.com/apache/pulsar/commit/a0699dfc1559484b275eeffade47adf3bb194f08", "message": "Add Class KafkaSchema", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "9533d3bd84e62fadbaf9f89a9749e0c42c6570fe", "url": "https://github.com/apache/pulsar/commit/9533d3bd84e62fadbaf9f89a9749e0c42c6570fe", "message": "Add cache for key and value schema", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "b84eceabc5c22da3477b377b16a174e39ebf40ad", "url": "https://github.com/apache/pulsar/commit/b84eceabc5c22da3477b377b16a174e39ebf40ad", "message": "Support debezium avro schema", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "f6165625664e87742ec0e695e3322732ca681d49", "url": "https://github.com/apache/pulsar/commit/f6165625664e87742ec0e695e3322732ca681d49", "message": "Delete no used dependency", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "e9a8bc27e8d9e2fa6b49c7d43555e18a6d4e65c8", "url": "https://github.com/apache/pulsar/commit/e9a8bc27e8d9e2fa6b49c7d43555e18a6d4e65c8", "message": "debezium connect source support `org.apache.pulsar.kafka.shade.io.confluent.connect.avro.AvroConverter`, add integration test", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "6675996acc3e81d5a0685cadefea6cdb980ef32f", "url": "https://github.com/apache/pulsar/commit/6675996acc3e81d5a0685cadefea6cdb980ef32f", "message": "fix", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "86d477925681edb76dd64ca75525ec8eea29c74c", "url": "https://github.com/apache/pulsar/commit/86d477925681edb76dd64ca75525ec8eea29c74c", "message": "fix", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "0f041d7ec3a52478a3a62954e62e3d2e898898c6", "url": "https://github.com/apache/pulsar/commit/0f041d7ec3a52478a3a62954e62e3d2e898898c6", "message": "add some test log", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "01eee75a928ca0181885649a74872e3ccdabbee9", "url": "https://github.com/apache/pulsar/commit/01eee75a928ca0181885649a74872e3ccdabbee9", "message": "fix", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "58bfc7de217b7b8ccb25466f8d8dce9bc34476f8", "url": "https://github.com/apache/pulsar/commit/58bfc7de217b7b8ccb25466f8d8dce9bc34476f8", "message": "add some test log", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "78856e0ca0ffe9b8717241f49b67b725d60521b3", "url": "https://github.com/apache/pulsar/commit/78856e0ca0ffe9b8717241f49b67b725d60521b3", "message": "fix", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "ded2cd0e07b5b9d40ff14e8c10e06b55bbf68206", "url": "https://github.com/apache/pulsar/commit/ded2cd0e07b5b9d40ff14e8c10e06b55bbf68206", "message": "fix", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "b15839d8c28da79045fb0f856227bb36c9914e7d", "url": "https://github.com/apache/pulsar/commit/b15839d8c28da79045fb0f856227bb36c9914e7d", "message": "use the ClassLoader of the SourceContext to generate KeyValueSchema", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "dcf920230f9297bdc250371076f43d609ffd6768", "url": "https://github.com/apache/pulsar/commit/dcf920230f9297bdc250371076f43d609ffd6768", "message": "some test", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "2a9de584756f663bbda00f7c5e158c7419dcca01", "url": "https://github.com/apache/pulsar/commit/2a9de584756f663bbda00f7c5e158c7419dcca01", "message": "some test", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "8a77ba888af2475513dbc0d01ee1f15981619608", "url": "https://github.com/apache/pulsar/commit/8a77ba888af2475513dbc0d01ee1f15981619608", "message": "fix", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "56b4d274d4665caef4c960a937c74ab655b59ad3", "url": "https://github.com/apache/pulsar/commit/56b4d274d4665caef4c960a937c74ab655b59ad3", "message": "fix", "committedDate": "2020-04-27T03:55:41Z", "type": "commit"}, {"oid": "54d636e2605cb5d7ae0697b234bd0512f0a2c08d", "url": "https://github.com/apache/pulsar/commit/54d636e2605cb5d7ae0697b234bd0512f0a2c08d", "message": "add test log", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "980ecb8ed3d072c4b89cd5b0ae5e6cfa8d97bbd8", "url": "https://github.com/apache/pulsar/commit/980ecb8ed3d072c4b89cd5b0ae5e6cfa8d97bbd8", "message": "fix test", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "c09e9b426690601f5884ffa7e4c9620af5986ca3", "url": "https://github.com/apache/pulsar/commit/c09e9b426690601f5884ffa7e4c9620af5986ca3", "message": "add test log", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "406d3af20e65d660f7518b9f99c3dc02afc6e90a", "url": "https://github.com/apache/pulsar/commit/406d3af20e65d660f7518b9f99c3dc02afc6e90a", "message": "add test log", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "0057cbb3cebdc8dc5978b3737ee76fb990fd7670", "url": "https://github.com/apache/pulsar/commit/0057cbb3cebdc8dc5978b3737ee76fb990fd7670", "message": "add test log", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "1e19a9aa78a54e87ef7a6ecc52d5f07b9633b9a3", "url": "https://github.com/apache/pulsar/commit/1e19a9aa78a54e87ef7a6ecc52d5f07b9633b9a3", "message": "fix docs", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "39f9f7d07c6ac10829ce12233d1e3d00e44d69f1", "url": "https://github.com/apache/pulsar/commit/39f9f7d07c6ac10829ce12233d1e3d00e44d69f1", "message": "fix test", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "1d54597e1ac6a931e943b30aba622fbdac76ade9", "url": "https://github.com/apache/pulsar/commit/1d54597e1ac6a931e943b30aba622fbdac76ade9", "message": "fix test", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "4e077b5682970e9b04aa9b9ea88af6588743219e", "url": "https://github.com/apache/pulsar/commit/4e077b5682970e9b04aa9b9ea88af6588743219e", "message": "fix test", "committedDate": "2020-04-27T03:55:42Z", "type": "commit"}, {"oid": "4e077b5682970e9b04aa9b9ea88af6588743219e", "url": "https://github.com/apache/pulsar/commit/4e077b5682970e9b04aa9b9ea88af6588743219e", "message": "fix test", "committedDate": "2020-04-27T03:55:42Z", "type": "forcePushed"}, {"oid": "78ef864e92fc7c7d10799af489ad30897d6550d2", "url": "https://github.com/apache/pulsar/commit/78ef864e92fc7c7d10799af489ad30897d6550d2", "message": "fix test", "committedDate": "2020-04-27T06:23:04Z", "type": "commit"}, {"oid": "d45f27a1a4e7b27a962cd5ec3bd4aee23eba0150", "url": "https://github.com/apache/pulsar/commit/d45f27a1a4e7b27a962cd5ec3bd4aee23eba0150", "message": "fix test", "committedDate": "2020-04-27T08:11:02Z", "type": "commit"}, {"oid": "7e91ab0a2a16bdf1c7e4b3e2453b0e33a07fc273", "url": "https://github.com/apache/pulsar/commit/7e91ab0a2a16bdf1c7e4b3e2453b0e33a07fc273", "message": "fix test", "committedDate": "2020-04-27T10:21:02Z", "type": "commit"}, {"oid": "5aa985c51bb73d0a46b64db69557e9e6899b4890", "url": "https://github.com/apache/pulsar/commit/5aa985c51bb73d0a46b64db69557e9e6899b4890", "message": "fix test", "committedDate": "2020-04-27T12:43:45Z", "type": "commit"}, {"oid": "dc83b12d0f9c17373ba60761d92743ae62903b6d", "url": "https://github.com/apache/pulsar/commit/dc83b12d0f9c17373ba60761d92743ae62903b6d", "message": "fix test", "committedDate": "2020-04-27T15:20:39Z", "type": "commit"}, {"oid": "a03f6dce9a574f0395a5704c72eb5b4084e38d3c", "url": "https://github.com/apache/pulsar/commit/a03f6dce9a574f0395a5704c72eb5b4084e38d3c", "message": "fix", "committedDate": "2020-04-27T16:46:33Z", "type": "commit"}, {"oid": "d07394a2e1d90828ad92f05740d407b3c372be4f", "url": "https://github.com/apache/pulsar/commit/d07394a2e1d90828ad92f05740d407b3c372be4f", "message": "fix", "committedDate": "2020-04-27T17:54:29Z", "type": "commit"}, {"oid": "7698bc990b1226b4f88800b0d575b0a0e8d16ecb", "url": "https://github.com/apache/pulsar/commit/7698bc990b1226b4f88800b0d575b0a0e8d16ecb", "message": "delete test log", "committedDate": "2020-04-27T19:28:57Z", "type": "commit"}, {"oid": "6c2f98d92f3aa57b67a6435e57730aa88053d6a9", "url": "https://github.com/apache/pulsar/commit/6c2f98d92f3aa57b67a6435e57730aa88053d6a9", "message": "delete test log", "committedDate": "2020-04-27T19:32:59Z", "type": "commit"}]}