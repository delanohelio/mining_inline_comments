{"pr_number": 8618, "pr_title": "[PIP 70][Issue 8617] Introduce lightweight broker entry metadata", "pr_createdAt": "2020-11-18T18:00:05Z", "pr_url": "https://github.com/apache/pulsar/pull/8618", "timeline": [{"oid": "0c71eb6da12db83b7f5a9def14316a6daf128349", "url": "https://github.com/apache/pulsar/commit/0c71eb6da12db83b7f5a9def14316a6daf128349", "message": "fix cherry-pick problem", "committedDate": "2020-11-19T03:53:04Z", "type": "forcePushed"}, {"oid": "a07504d3dbd009c15c53c36370a6b76aa71249aa", "url": "https://github.com/apache/pulsar/commit/a07504d3dbd009c15c53c36370a6b76aa71249aa", "message": "add backwards test for client with version 2.6.0", "committedDate": "2020-11-27T04:18:57Z", "type": "forcePushed"}, {"oid": "f329ac52887a01816a2ae68e77e796459b387728", "url": "https://github.com/apache/pulsar/commit/f329ac52887a01816a2ae68e77e796459b387728", "message": "fix pom error", "committedDate": "2020-12-02T03:41:53Z", "type": "forcePushed"}, {"oid": "72d4bb6257858c15893e435297d5be52e6af8e52", "url": "https://github.com/apache/pulsar/commit/72d4bb6257858c15893e435297d5be52e6af8e52", "message": "fix pom error", "committedDate": "2020-12-02T03:44:34Z", "type": "forcePushed"}, {"oid": "8e4f9abbf0991b045e9dfa870ce6dff863af8b31", "url": "https://github.com/apache/pulsar/commit/8e4f9abbf0991b045e9dfa870ce6dff863af8b31", "message": "add backwards test for client with version 2.6.0", "committedDate": "2020-12-02T06:11:50Z", "type": "forcePushed"}, {"oid": "3c19bc63e5e9fcbd48190133dfc0721c5989d22a", "url": "https://github.com/apache/pulsar/commit/3c19bc63e5e9fcbd48190133dfc0721c5989d22a", "message": "skip raw meta when skip medtadata", "committedDate": "2020-12-03T03:29:21Z", "type": "forcePushed"}, {"oid": "3b3a73e3136b3d72c19bcb5367bf92438c84138e", "url": "https://github.com/apache/pulsar/commit/3b3a73e3136b3d72c19bcb5367bf92438c84138e", "message": "skip raw metadata before send to consumer", "committedDate": "2020-12-09T03:23:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3NTcwMw==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r539075703", "bodyText": "broker timestamp is a concept on pulsar broker. managed ledger isn't aware of any broker features. I am not sure why we need this flag here or the name of this configuration setting is not appropriate.", "author": "sijie", "createdAt": "2020-12-09T07:42:19Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/ManagedLedgerConfig.java", "diffHunk": "@@ -75,6 +75,7 @@\n     private LedgerOffloader ledgerOffloader = NullLedgerOffloader.INSTANCE;\n     private int newEntriesCheckDelayInMillis = 10;\n     private Clock clock = Clock.systemUTC();\n+    private boolean brokerTimestampForMessageEnable = false;", "originalCommit": "3b3a73e3136b3d72c19bcb5367bf92438c84138e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5MzQxNQ==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r539093415", "bodyText": "Thanks for your reply.\nThis flag here is to indicate that we should add timestamp  in Raw meta from broker side for Entry.\nThis raw meta(broker timstamp) can be added once broker received an Entry or  just before the Entry writen to bookie.  brokerTimestampForMessageEnable  here  is for the future consideration,\n\nHere are some of the use case for raw Message metadata:\n\n\nProvide ordered messages by time(broker side) sequence to make messages seek by the time more accurate. Currently, each message has a publish_time, it uses client-side time, but for different producers in different clients, the time may not align between clients and cause the message order and the message time (publish_time) order may be different. But each topic-partition only has one owner broker, if we append broker side time in the \u201craw Message metadata\u201d, we could make sure the message order is aligned with broker side time. With this feature, we could handle the message seek by the time more accurately.\n\n\nProvide continuous message sequence-Id for messages in one topic-partition. MessageId is a combination of ledgerId+entryId+batchIndex; for a partition that contains more than one ledger, the Ids inside is not continuous. By this solution, we could append a sequence-Id at the end of each Message. This will make the message sequence management earlier.\n\nIn the future, Raw meta can support continuous message sequence-Id for messages in one topic-partition , and for consistency, I think add sequence-Id to Raw meta by ManagedLedger is a good choice.", "author": "aloyszhang", "createdAt": "2020-12-09T08:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3NTcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3NjE5OA==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r539076198", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean brokerTimestampForMessageEnable = false;\n          \n          \n            \n                private boolean brokerTimestampForMessageEnabled = false;", "author": "sijie", "createdAt": "2020-12-09T07:43:21Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -1428,6 +1428,11 @@\n                     + \"Of course, this may degrade consumption throughput. Default is 10ms.\")\n     private int managedLedgerNewEntriesCheckDelayInMillis = 10;\n \n+    @FieldContext(category = CATEGORY_STORAGE_ML,\n+            doc = \"Enable broker side timestamp for message. Default is false.\")\n+    private boolean brokerTimestampForMessageEnable = false;", "originalCommit": "3b3a73e3136b3d72c19bcb5367bf92438c84138e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5Nzc5NQ==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r539097795", "bodyText": "will apply.", "author": "aloyszhang", "createdAt": "2020-12-09T08:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3NjE5OA=="}], "type": "inlineReview"}, {"oid": "4613f1e59c2d2bc82ee4e61db1e71a30b6f591d7", "url": "https://github.com/apache/pulsar/commit/4613f1e59c2d2bc82ee4e61db1e71a30b6f591d7", "message": "add RawMessageMetadata for wire protocol", "committedDate": "2020-12-10T13:14:09Z", "type": "commit"}, {"oid": "4f8f4ce866d5532575548de0bafc1994d68b7578", "url": "https://github.com/apache/pulsar/commit/4f8f4ce866d5532575548de0bafc1994d68b7578", "message": "add brokerTimestampForMessageEnable in configuration", "committedDate": "2020-12-10T13:14:09Z", "type": "commit"}, {"oid": "3ea13d3d1b66018cc6cd95e9c6588884b1ec2d73", "url": "https://github.com/apache/pulsar/commit/3ea13d3d1b66018cc6cd95e9c6588884b1ec2d73", "message": "add raw message metadat before send to bookie", "committedDate": "2020-12-10T13:14:09Z", "type": "commit"}, {"oid": "030306f6f5c6ae03590e4f558991cd6c352a75be", "url": "https://github.com/apache/pulsar/commit/030306f6f5c6ae03590e4f558991cd6c352a75be", "message": "support deserialize raw metadata", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "b8f08bb978e5ab9dedcbd610199d7eac9886d293", "url": "https://github.com/apache/pulsar/commit/b8f08bb978e5ab9dedcbd610199d7eac9886d293", "message": "increase protocol version to 16 to support raw metadata", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "a805586dee8f68c07e5d7f09b59bae48c8f14221", "url": "https://github.com/apache/pulsar/commit/a805586dee8f68c07e5d7f09b59bae48c8f14221", "message": "skip raw message metadata for previous consumer client version", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "f7e5337c524e3ef83fdf5453672fe341db80bf12", "url": "https://github.com/apache/pulsar/commit/f7e5337c524e3ef83fdf5453672fe341db80bf12", "message": "add test for find message based on broker timestamp", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "28d5d610a5d33377ecb476e59a3943ffee7e6e36", "url": "https://github.com/apache/pulsar/commit/28d5d610a5d33377ecb476e59a3943ffee7e6e36", "message": "fix checkstyle problem", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "224e1cc9f51f5af94eabc7a1d9880f626af52085", "url": "https://github.com/apache/pulsar/commit/224e1cc9f51f5af94eabc7a1d9880f626af52085", "message": "fix cherry-pick problem", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "803f70a5ae7980eec5dd6babc8b87c84c298c750", "url": "https://github.com/apache/pulsar/commit/803f70a5ae7980eec5dd6babc8b87c84c298c750", "message": "abstract raw meta enable for ManagedLedgerConfig", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "caf714a3bd94c6eb0ea2bd75b074247bdf4a9db6", "url": "https://github.com/apache/pulsar/commit/caf714a3bd94c6eb0ea2bd75b074247bdf4a9db6", "message": "add backwards test for client with version 2.6.0", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "6af2d7567372f233b4b0b417fcefd1bd694c21cf", "url": "https://github.com/apache/pulsar/commit/6af2d7567372f233b4b0b417fcefd1bd694c21cf", "message": "skip raw meta when skip medtadata", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "a91c7718461e27449b662fcca9e1689b600d3e57", "url": "https://github.com/apache/pulsar/commit/a91c7718461e27449b662fcca9e1689b600d3e57", "message": "skip raw metadata before send to consumer", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "397939b21b075d65cf3aa78847a0c189b4bb325d", "url": "https://github.com/apache/pulsar/commit/397939b21b075d65cf3aa78847a0c189b4bb325d", "message": "introduce broker entry metadta interceptor for adding broker side metadata", "committedDate": "2020-12-10T13:14:10Z", "type": "commit"}, {"oid": "397939b21b075d65cf3aa78847a0c189b4bb325d", "url": "https://github.com/apache/pulsar/commit/397939b21b075d65cf3aa78847a0c189b4bb325d", "message": "introduce broker entry metadta interceptor for adding broker side metadata", "committedDate": "2020-12-10T13:14:10Z", "type": "forcePushed"}, {"oid": "4e64b965e2ec4d51a115840a5ed5680c89aba00f", "url": "https://github.com/apache/pulsar/commit/4e64b965e2ec4d51a115840a5ed5680c89aba00f", "message": "fix checkstyle", "committedDate": "2020-12-10T13:58:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM4NjM4NA==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r540386384", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        doc = \"List of interceptors for broker metadata.\")\n          \n          \n            \n                        doc = \"List of interceptors for entry metadata.\")", "author": "sijie", "createdAt": "2020-12-10T18:07:11Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -865,6 +866,11 @@\n                 \"please enable the system topic first.\")\n     private boolean topicLevelPoliciesEnabled = false;\n \n+    @FieldContext(\n+            category = CATEGORY_SERVER,\n+            doc = \"List of interceptors for broker metadata.\")", "originalCommit": "4e64b965e2ec4d51a115840a5ed5680c89aba00f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYzMTUzMg==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r540631532", "bodyText": "will fix this.", "author": "aloyszhang", "createdAt": "2020-12-11T01:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM4NjM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM5MjY0OQ==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r540392649", "bodyText": "I am still not convinced why do we need to this here. ManagedLedger only handles serialized entry. The entry metadata should be appended at the broker level. I think the right place to add this logic should be done in https://github.com/apache/pulsar/blob/master/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java#L342.", "author": "sijie", "createdAt": "2020-12-10T18:16:42Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java", "diffHunk": "@@ -103,8 +107,13 @@ public void setCloseWhenDone(boolean closeWhenDone) {\n \n     public void initiate() {\n         if (STATE_UPDATER.compareAndSet(OpAddEntry.this, State.OPEN, State.INITIATED)) {\n-            ByteBuf duplicateBuffer = data.retainedDuplicate();\n \n+            ByteBuf duplicateBuffer = data.retainedDuplicate();\n+            if (ml.getConfig().isBrokerEntryMetaEnabled()) {\n+                duplicateBuffer = Commands.addBrokerEntryMetadata(duplicateBuffer,", "originalCommit": "4e64b965e2ec4d51a115840a5ed5680c89aba00f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYyODM1Nw==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r540628357", "bodyText": "As we described in PIP-70, this feature can support continous sequenceId for Pulsar entry in the future, so, I think do these operations here is in favour of the future features.  For this broker-timestamp feature only,  move this logic as you suggested is a good choice. But for further extension,  maybe do this logic by ManagedLedger is better.  What's your opinion about this?", "author": "aloyszhang", "createdAt": "2020-12-11T01:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM5MjY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM5NjczMA==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r540396730", "bodyText": "We should expose the broker metadata in the Message. So this would avoid using Pair and a lot of if-else logic.\nWe can improve msg.isExpired logic. If entry metadata is present, use broker timestamp; otherwise use client timestamp.", "author": "sijie", "createdAt": "2020-12-10T18:22:59Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentMessageExpiryMonitor.java", "diffHunk": "@@ -68,16 +70,22 @@ public void expireMessages(int messageTTLInSeconds) {\n                     messageTTLInSeconds);\n \n             cursor.asyncFindNewestMatching(ManagedCursor.FindPositionConstraint.SearchActiveEntries, entry -> {\n-                MessageImpl<?> msg = null;\n+                Pair<MessageImpl<byte[]>, PulsarApi.BrokerEntryMetadata> pair = null;\n                 try {\n-                    msg = MessageImpl.deserialize(entry.getDataBuffer());\n-                    return msg.isExpired(messageTTLInSeconds);\n+                    pair = MessageImpl.deserializeWithBrokerEntryMetaData(entry.getDataBuffer());", "originalCommit": "4e64b965e2ec4d51a115840a5ed5680c89aba00f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY1NTg2Ng==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r540655866", "bodyText": "Thanks for your suggestion.  I'll optimize the implement as follow steps:\n\nexpose the entry metadata to MessageImpl\nif entry metadata exist, skip the deserialization of MessageMetadata\nif not exist, deserialization the MessageMetadata", "author": "aloyszhang", "createdAt": "2020-12-11T03:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM5NjczMA=="}], "type": "inlineReview"}, {"oid": "6ea94a53a8663f3b8a017c3073d915e667886c37", "url": "https://github.com/apache/pulsar/commit/6ea94a53a8663f3b8a017c3073d915e667886c37", "message": "fix config doc", "committedDate": "2020-12-11T02:32:00Z", "type": "commit"}, {"oid": "48c0b78a3d13795772bdbdf5d141c9c190733247", "url": "https://github.com/apache/pulsar/commit/48c0b78a3d13795772bdbdf5d141c9c190733247", "message": "expose entry meta to MessageImpl and skip deser MessageMeta if has entry meta", "committedDate": "2020-12-11T02:44:41Z", "type": "commit"}, {"oid": "e1a981b19d527ce1314947d7dc3a76b493c055aa", "url": "https://github.com/apache/pulsar/commit/e1a981b19d527ce1314947d7dc3a76b493c055aa", "message": "move add entry metadta logic to topic", "committedDate": "2020-12-11T05:28:42Z", "type": "commit"}, {"oid": "931ea7ce8bbcfb602bddde10184e9752b8bc8963", "url": "https://github.com/apache/pulsar/commit/931ea7ce8bbcfb602bddde10184e9752b8bc8963", "message": "fix checkstyle", "committedDate": "2020-12-11T05:38:52Z", "type": "commit"}, {"oid": "0f2a6e8e9e785eb02193db8c6330f1a2d6874b15", "url": "https://github.com/apache/pulsar/commit/0f2a6e8e9e785eb02193db8c6330f1a2d6874b15", "message": "fix checkstyle", "committedDate": "2020-12-11T05:47:25Z", "type": "commit"}, {"oid": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "url": "https://github.com/apache/pulsar/commit/6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "message": "fix error in PulsarSplitManager.findPosition by roll back the logic of comparation condition", "committedDate": "2020-12-11T08:54:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMjkxNg==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541122916", "bodyText": "I don't think we need these imports here. correct?", "author": "sijie", "createdAt": "2020-12-11T17:52:06Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/ManagedLedgerConfig.java", "diffHunk": "@@ -23,7 +23,9 @@\n import com.google.common.base.Charsets;\n import java.time.Clock;\n import java.util.Arrays;\n+import java.util.HashSet;", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM4MTk4OA==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541381988", "bodyText": "will remove", "author": "aloyszhang", "createdAt": "2020-12-11T22:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMjkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMzA5OA==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541123098", "bodyText": "I  don't think we need this import.", "author": "sijie", "createdAt": "2020-12-11T17:52:23Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java", "diffHunk": "@@ -35,6 +37,7 @@\n import org.apache.bookkeeper.mledger.ManagedLedgerException;\n import org.apache.bookkeeper.mledger.util.SafeRun;\n import org.apache.bookkeeper.util.SafeRunnable;\n+import org.apache.pulsar.common.protocol.Commands;", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMzg2MQ==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541123861", "bodyText": "We don't this method anymore, correct?", "author": "sijie", "createdAt": "2020-12-11T17:53:43Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentMessageExpiryMonitor.java", "diffHunk": "@@ -90,6 +91,11 @@ public void expireMessages(int messageTTLInSeconds) {\n         }\n     }\n \n+    public boolean isExpired(int messageTTLInSeconds, long brokerTimestampForMessage) {", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM4MjUyOA==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541382528", "bodyText": "Yes, this method has no invoke. will rmeove", "author": "aloyszhang", "createdAt": "2020-12-11T22:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMzg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyNjE0NA==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541126144", "bodyText": "Can we add a method in MessageImpl to compare the timestamps?\nboolean publishedEarlierThan(long timestamp)?\n\nLike what you did at https://github.com/apache/pulsar/pull/8618/files#diff-955419b4b0ad976e96f9f7595989e79c391109aeaa304bd286a80fc6eb9360c7R299", "author": "sijie", "createdAt": "2020-12-11T17:57:37Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentMessageFinder.java", "diffHunk": "@@ -61,10 +61,12 @@ public void findMessages(final long timestamp, AsyncCallbacks.FindEntryCallback\n             }\n \n             cursor.asyncFindNewestMatching(ManagedCursor.FindPositionConstraint.SearchAllAvailableEntries, entry -> {\n-                MessageImpl msg = null;\n+                MessageImpl<byte[]> msg = null;\n                 try {\n-                    msg = MessageImpl.deserialize(entry.getDataBuffer());\n-                    return msg.getPublishTime() < timestamp;\n+                    msg = MessageImpl.deserializeBrokerEntryMetaDataFirst(entry.getDataBuffer());\n+                    return msg.getBrokerEntryMetadata() != null", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyNjUyMg==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541126522", "bodyText": "Can we use MessageImpl.isExpired?", "author": "sijie", "createdAt": "2020-12-11T17:58:22Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -2145,15 +2155,21 @@ public void terminateFailed(ManagedLedgerException exception, Object ctx) {\n     }\n \n     public boolean isOldestMessageExpired(ManagedCursor cursor, long messageTTLInSeconds) {\n-        MessageImpl msg = null;\n+        MessageImpl<byte[]> msg = null;\n         Entry entry = null;\n         boolean isOldestMessageExpired = false;\n         try {\n             entry = cursor.getNthEntry(1, IndividualDeletedEntries.Include);\n             if (entry != null) {\n-                msg = MessageImpl.deserialize(entry.getDataBuffer());\n-                isOldestMessageExpired = messageTTLInSeconds != 0 && System.currentTimeMillis() > (msg.getPublishTime()\n-                        + TimeUnit.SECONDS.toMillis((long) (messageTTLInSeconds * MESSAGE_EXPIRY_THRESHOLD)));\n+                msg = MessageImpl.deserializeBrokerEntryMetaDataFirst(entry.getDataBuffer());", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyNjc3NQ==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541126775", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class AppendBrokerTimestampMetadataInterceptor implements BrokerEntryMetadataInterceptor{\n          \n          \n            \n            public class AppendBrokerTimestampMetadataInterceptor implements BrokerEntryMetadataInterceptor {", "author": "sijie", "createdAt": "2020-12-11T17:58:47Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/intercept/AppendBrokerTimestampMetadataInterceptor.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.common.intercept;\n+\n+import org.apache.pulsar.common.api.proto.PulsarApi;\n+\n+/**\n+ * A plugin interface that allows you to intercept the client requests to\n+ *  the Pulsar brokers and add timestamp from broker side metadata for each entry.\n+ */\n+public class AppendBrokerTimestampMetadataInterceptor implements BrokerEntryMetadataInterceptor{", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyNzY1Ng==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541127656", "bodyText": "I think we should throw RuntimeExceptions if we failed to load broker entry metadata interceptors.", "author": "sijie", "createdAt": "2020-12-11T18:00:15Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/intercept/BrokerEntryMetadataUtils.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.common.intercept;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.pulsar.common.util.ClassLoaderUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * A tool class for loading BrokerEntryMetadataInterceptor classes.\n+ */\n+public class BrokerEntryMetadataUtils {\n+\n+    private static final Logger log = LoggerFactory.getLogger(BrokerEntryMetadataUtils.class);\n+\n+    public static Set<BrokerEntryMetadataInterceptor> loadBrokerEntryMetadataInterceptors(\n+            Set<String> interceptorNames, ClassLoader classLoader) {\n+        Set<BrokerEntryMetadataInterceptor> interceptors = new HashSet<>();\n+        if (interceptorNames != null && interceptorNames.size() > 0) {\n+            for (String interceptorName : interceptorNames) {\n+                try {\n+                    Class<BrokerEntryMetadataInterceptor> clz = (Class<BrokerEntryMetadataInterceptor>) ClassLoaderUtils\n+                            .loadClass(interceptorName, classLoader);\n+                    try {\n+                        interceptors.add(clz.newInstance());\n+                    } catch (InstantiationException | IllegalAccessException e) {\n+                        log.error(\"Create new BrokerEntryMetadataInterceptor instance for {} falied.\",", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyOTEzNg==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541129136", "bodyText": "If we failed to serialize entry metadata into a bytebuf, we should throw an exception. The caller of this method should catch this exception and fail the write requests.", "author": "sijie", "createdAt": "2020-12-11T18:02:50Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/protocol/Commands.java", "diffHunk": "@@ -1920,6 +1929,72 @@ private static ByteBufPair serializeCommandSendWithSize(BaseCommand.Builder cmdB\n         return command;\n     }\n \n+    public static ByteBuf addBrokerEntryMetadata(ByteBuf headerAndPayload,\n+                                                 Set<BrokerEntryMetadataInterceptor> interceptors) {\n+        //   | BROKER_ENTRY_METADATA_MAGIC_NUMBER | BROKER_ENTRY_METADATA_SIZE |         BROKER_ENTRY_METADATA         |\n+        //   |         2 bytes                    |       4 bytes              |    BROKER_ENTRY_METADATA_SIZE bytes   |\n+\n+        PulsarApi.BrokerEntryMetadata.Builder brokerMetadataBuilder = PulsarApi.BrokerEntryMetadata.newBuilder();\n+        for (BrokerEntryMetadataInterceptor interceptor : interceptors) {\n+            interceptor.intercept(brokerMetadataBuilder);\n+        }\n+        PulsarApi.BrokerEntryMetadata brokerEntryMetadata = brokerMetadataBuilder.build();\n+        int brokerMetaSize = brokerEntryMetadata.getSerializedSize();\n+        ByteBuf brokerMeta =\n+                PulsarByteBufAllocator.DEFAULT.buffer(brokerMetaSize + 6, brokerMetaSize + 6);\n+        brokerMeta.writeShort(Commands.magicBrokerEntryMetadata);\n+        brokerMeta.writeInt(brokerMetaSize);\n+        ByteBufCodedOutputStream outStream = ByteBufCodedOutputStream.get(brokerMeta);\n+        try {\n+            brokerEntryMetadata.writeTo(outStream);\n+        } catch (IOException e) {\n+            // This is in-memory serialization, should not fail\n+            throw new RuntimeException(e);", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQwODIyNQ==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541408225", "bodyText": "Will catch the exception and faile the write quest", "author": "aloyszhang", "createdAt": "2020-12-11T23:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyOTEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyOTQxMQ==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541129411", "bodyText": "Same question here - we should let the caller catch the exception.", "author": "sijie", "createdAt": "2020-12-11T18:03:15Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/protocol/Commands.java", "diffHunk": "@@ -1920,6 +1929,72 @@ private static ByteBufPair serializeCommandSendWithSize(BaseCommand.Builder cmdB\n         return command;\n     }\n \n+    public static ByteBuf addBrokerEntryMetadata(ByteBuf headerAndPayload,\n+                                                 Set<BrokerEntryMetadataInterceptor> interceptors) {\n+        //   | BROKER_ENTRY_METADATA_MAGIC_NUMBER | BROKER_ENTRY_METADATA_SIZE |         BROKER_ENTRY_METADATA         |\n+        //   |         2 bytes                    |       4 bytes              |    BROKER_ENTRY_METADATA_SIZE bytes   |\n+\n+        PulsarApi.BrokerEntryMetadata.Builder brokerMetadataBuilder = PulsarApi.BrokerEntryMetadata.newBuilder();\n+        for (BrokerEntryMetadataInterceptor interceptor : interceptors) {\n+            interceptor.intercept(brokerMetadataBuilder);\n+        }\n+        PulsarApi.BrokerEntryMetadata brokerEntryMetadata = brokerMetadataBuilder.build();\n+        int brokerMetaSize = brokerEntryMetadata.getSerializedSize();\n+        ByteBuf brokerMeta =\n+                PulsarByteBufAllocator.DEFAULT.buffer(brokerMetaSize + 6, brokerMetaSize + 6);\n+        brokerMeta.writeShort(Commands.magicBrokerEntryMetadata);\n+        brokerMeta.writeInt(brokerMetaSize);\n+        ByteBufCodedOutputStream outStream = ByteBufCodedOutputStream.get(brokerMeta);\n+        try {\n+            brokerEntryMetadata.writeTo(outStream);\n+        } catch (IOException e) {\n+            // This is in-memory serialization, should not fail\n+            throw new RuntimeException(e);\n+        }\n+        outStream.recycle();\n+\n+        CompositeByteBuf compositeByteBuf = PulsarByteBufAllocator.DEFAULT.compositeBuffer();\n+        compositeByteBuf.addComponents(true, brokerMeta, headerAndPayload);\n+        return compositeByteBuf;\n+    }\n+\n+    public static ByteBuf skipBrokerEntryMetadataIfExist(ByteBuf headerAndPayloadWithBrokerEntryMetadata) {\n+        int readerIndex = headerAndPayloadWithBrokerEntryMetadata.readerIndex();\n+        if (headerAndPayloadWithBrokerEntryMetadata.readShort() == magicBrokerEntryMetadata) {\n+            int brokerEntryMetadataSize = headerAndPayloadWithBrokerEntryMetadata.readInt();\n+            headerAndPayloadWithBrokerEntryMetadata.readerIndex(headerAndPayloadWithBrokerEntryMetadata.readerIndex()\n+                    + brokerEntryMetadataSize);\n+        } else {\n+            headerAndPayloadWithBrokerEntryMetadata.readerIndex(readerIndex);\n+        }\n+        return headerAndPayloadWithBrokerEntryMetadata;\n+    }\n+\n+    public static PulsarApi.BrokerEntryMetadata parseBrokerEntryMetadataIfExist(\n+            ByteBuf headerAndPayloadWithBrokerEntryMetadata) {\n+        int readerIndex = headerAndPayloadWithBrokerEntryMetadata.readerIndex();\n+        if (headerAndPayloadWithBrokerEntryMetadata.readShort() == magicBrokerEntryMetadata) {\n+            int brokerEntryMetadataSize = headerAndPayloadWithBrokerEntryMetadata.readInt();\n+            int writerIndex = headerAndPayloadWithBrokerEntryMetadata.writerIndex();\n+            headerAndPayloadWithBrokerEntryMetadata.writerIndex(headerAndPayloadWithBrokerEntryMetadata.readerIndex()\n+                    + brokerEntryMetadataSize);\n+            ByteBufCodedInputStream brokerEntryMetadataInputStream =\n+                    ByteBufCodedInputStream.get(headerAndPayloadWithBrokerEntryMetadata);\n+            PulsarApi.BrokerEntryMetadata.Builder builder =  PulsarApi.BrokerEntryMetadata.newBuilder();\n+            try {\n+                builder.mergeFrom(brokerEntryMetadataInputStream, null).build();\n+            } catch (IOException e) {\n+                throw new RuntimeException(e);", "originalCommit": "6e2d9710f38ac1e1ed16d716bd6537c0b1feeb1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQxNjEyMQ==", "url": "https://github.com/apache/pulsar/pull/8618#discussion_r541416121", "bodyText": "Caller of this method is MessageImpl.deserializeBrokerEntryMetaDataFirst and all callers of MessageImpl.deserializeBrokerEntryMetaDataFirst has a try-catch block already.", "author": "aloyszhang", "createdAt": "2020-12-11T23:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyOTQxMQ=="}], "type": "inlineReview"}, {"oid": "23c9c2c9cf8331cc0455f2b625266b0c26e99fc8", "url": "https://github.com/apache/pulsar/commit/23c9c2c9cf8331cc0455f2b625266b0c26e99fc8", "message": "remove un-used import and method", "committedDate": "2020-12-11T22:53:11Z", "type": "commit"}, {"oid": "43556cb2b71d0fb6cc6493dd5bf2ad4c375ca73f", "url": "https://github.com/apache/pulsar/commit/43556cb2b71d0fb6cc6493dd5bf2ad4c375ca73f", "message": "make all time comparation happended in Messge", "committedDate": "2020-12-11T23:09:35Z", "type": "commit"}, {"oid": "76b6f3fce8a7a9ffc186dc68ad7055d72e47e6c8", "url": "https://github.com/apache/pulsar/commit/76b6f3fce8a7a9ffc186dc68ad7055d72e47e6c8", "message": "throw runtime exception if load BrokerEntryMetadataInterceptor failed", "committedDate": "2020-12-11T23:23:00Z", "type": "commit"}, {"oid": "1e918b542f5497794f36db5a9226449485142e50", "url": "https://github.com/apache/pulsar/commit/1e918b542f5497794f36db5a9226449485142e50", "message": "catch add entry metadata exception and failed write request", "committedDate": "2020-12-12T00:41:33Z", "type": "commit"}, {"oid": "5e237c4e8d25981df630c3f4f72e4fb310c6abd7", "url": "https://github.com/apache/pulsar/commit/5e237c4e8d25981df630c3f4f72e4fb310c6abd7", "message": "remove un-used import", "committedDate": "2020-12-12T00:57:52Z", "type": "commit"}]}