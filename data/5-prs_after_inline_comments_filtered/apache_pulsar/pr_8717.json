{"pr_number": 8717, "pr_title": "Configurable data source for offloaded messages", "pr_createdAt": "2020-11-26T06:43:20Z", "pr_url": "https://github.com/apache/pulsar/pull/8717", "timeline": [{"oid": "6a071f78b96a8e5c6d8cc4410b4f040f5ac6426f", "url": "https://github.com/apache/pulsar/commit/6a071f78b96a8e5c6d8cc4410b4f040f5ac6426f", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-02T03:04:43Z", "type": "forcePushed"}, {"oid": "2b654e80fbb59e3907f41691065c2403585239da", "url": "https://github.com/apache/pulsar/commit/2b654e80fbb59e3907f41691065c2403585239da", "message": "add configuration for read priority\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "7f8ebffa6c35693123e2ed5699e5afbcb4c18ddd", "url": "https://github.com/apache/pulsar/commit/7f8ebffa6c35693123e2ed5699e5afbcb4c18ddd", "message": "add read priority to offload policy\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "7a6942d364a7dbaedcd98c7044a2518fbdc8791e", "url": "https://github.com/apache/pulsar/commit/7a6942d364a7dbaedcd98c7044a2518fbdc8791e", "message": "add read priority to offload policy\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "ec43abe85850b50fc4e808529894267023fd078c", "url": "https://github.com/apache/pulsar/commit/ec43abe85850b50fc4e808529894267023fd078c", "message": "add read priority to offload policy\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "9cd6b87d8bbea515b58da3d51490958c2ccb416e", "url": "https://github.com/apache/pulsar/commit/9cd6b87d8bbea515b58da3d51490958c2ccb416e", "message": "add read priority to offload policy\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "a697370f1568bf7d78387893afaa30ea37239564", "url": "https://github.com/apache/pulsar/commit/a697370f1568bf7d78387893afaa30ea37239564", "message": "for bookkeeper first read priority read bookkeeper first\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "61a9561c0ce0781a67a16cfec2171cc54ed6cde8", "url": "https://github.com/apache/pulsar/commit/61a9561c0ce0781a67a16cfec2171cc54ed6cde8", "message": "nightly commit\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "969d164be01a8ce9414908bd827c5545f12b2461", "url": "https://github.com/apache/pulsar/commit/969d164be01a8ce9414908bd827c5545f12b2461", "message": "drop log pom\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "0ba829c15d4399cb442dd0ca623ba0fe01cbf9df", "url": "https://github.com/apache/pulsar/commit/0ba829c15d4399cb442dd0ca623ba0fe01cbf9df", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "d70bd00dfefc44adc6d4e2055f3457a7cc6c09d0", "url": "https://github.com/apache/pulsar/commit/d70bd00dfefc44adc6d4e2055f3457a7cc6c09d0", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "a1031a675c44b07a5f088fe05e7b70a9a866260d", "url": "https://github.com/apache/pulsar/commit/a1031a675c44b07a5f088fe05e7b70a9a866260d", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "fd224e1b3bb3b9f945e28bfb1cc61b3ba6547c89", "url": "https://github.com/apache/pulsar/commit/fd224e1b3bb3b9f945e28bfb1cc61b3ba6547c89", "message": "add broker conf managedLedgerDataReadPriority\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "1cb61da7f4665b3824cc7fd277a4f054f179074a", "url": "https://github.com/apache/pulsar/commit/1cb61da7f4665b3824cc7fd277a4f054f179074a", "message": "read broker configuration\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "commit"}, {"oid": "1cb61da7f4665b3824cc7fd277a4f054f179074a", "url": "https://github.com/apache/pulsar/commit/1cb61da7f4665b3824cc7fd277a4f054f179074a", "message": "read broker configuration\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T00:30:14Z", "type": "forcePushed"}, {"oid": "d3148f4ec31a9d76952e363505bdf71b0d744b02", "url": "https://github.com/apache/pulsar/commit/d3148f4ec31a9d76952e363505bdf71b0d744b02", "message": "The package management module failed to build\n---\n\n*Motivation*\n\nThe pakcage management module build failed by the spotbugs check.\nThat will block the project build.", "committedDate": "2020-12-03T06:36:06Z", "type": "commit"}, {"oid": "7ee26cbbb0149c9f21193795d34e4c283afabfea", "url": "https://github.com/apache/pulsar/commit/7ee26cbbb0149c9f21193795d34e4c283afabfea", "message": "bug fix\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-03T07:11:44Z", "type": "commit"}, {"oid": "1fe3a3d52f85f300ba9f35bed7c9fc660ef19fdc", "url": "https://github.com/apache/pulsar/commit/1fe3a3d52f85f300ba9f35bed7c9fc660ef19fdc", "message": "Merge branch 'fix-spotbugs-issue' into read_priority_full", "committedDate": "2020-12-03T07:55:57Z", "type": "commit"}, {"oid": "ad5c187b6353b0e51be791abf35a6cb9beeef6e0", "url": "https://github.com/apache/pulsar/commit/ad5c187b6353b0e51be791abf35a6cb9beeef6e0", "message": "Merge branch 'master' into read_priority_full", "committedDate": "2020-12-04T01:57:01Z", "type": "commit"}, {"oid": "5eeafb49e57456d396699b9786daa835bdd25c26", "url": "https://github.com/apache/pulsar/commit/5eeafb49e57456d396699b9786daa835bdd25c26", "message": "Merge branch 'master' into read_priority_full", "committedDate": "2020-12-04T09:56:38Z", "type": "commit"}, {"oid": "0b6a92e60acac97bc838466806f4c820a916fc5e", "url": "https://github.com/apache/pulsar/commit/0b6a92e60acac97bc838466806f4c820a916fc5e", "message": "check null before set\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-05T01:34:22Z", "type": "commit"}, {"oid": "369d48c07bc6879e35d8c3d76411da11c8f48d17", "url": "https://github.com/apache/pulsar/commit/369d48c07bc6879e35d8c3d76411da11c8f48d17", "message": "reduce unnecessary configuration set\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-05T03:37:36Z", "type": "commit"}, {"oid": "52db96e167fb9bf676affd94c157037b01c66432", "url": "https://github.com/apache/pulsar/commit/52db96e167fb9bf676affd94c157037b01c66432", "message": "set with null check\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-05T03:50:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNTUxMA==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r537615510", "bodyText": "The OffloadPolicies you get from config may not be updated as namespace or topic policy update.", "author": "hangc0276", "createdAt": "2020-12-07T15:52:41Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -1536,7 +1537,18 @@ void asyncReadEntries(OpReadEntry opReadEntry) {\n \n             LedgerInfo info = ledgers.get(ledgerId);\n             CompletableFuture<ReadHandle> openFuture = new CompletableFuture<>();\n-            if (info != null && info.hasOffloadContext() && info.getOffloadContext().getComplete()) {\n+\n+            if (config.getLedgerOffloader() != null\n+                    && config.getLedgerOffloader().getOffloadPolicies() != null\n+                    && config.getLedgerOffloader().getOffloadPolicies()", "originalCommit": "52db96e167fb9bf676affd94c157037b01c66432", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3MDA4Ng==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r537970086", "bodyText": "The OffloadPolicies you get from config may not be updated as namespace or topic policy update.\n\nGood question, I will try to figure it out", "author": "Renkai", "createdAt": "2020-12-08T01:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNTUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3MjQ3OA==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r538172478", "bodyText": "@hangc0276\nI think\norg.apache.pulsar.broker.admin.v2.PersistentTopics#setOffloadPolicies\norg.apache.pulsar.broker.admin.impl.PersistentTopicsBase#internalSetOffloadPolicies\norg.apache.pulsar.broker.admin.impl.PersistentTopicsBase#internalUpdateOffloadPolicies\norg.apache.bookkeeper.mledger.impl.ManagedLedgerImpl#setConfig\nand\norg.apache.pulsar.zookeeper.ZooKeeperCache#process(org.apache.zookeeper.WatchedEvent, org.apache.pulsar.zookeeper.ZooKeeperCache.CacheUpdater<T>)\norg.apache.pulsar.zookeeper.ZooKeeperChildrenCache#reloadCache\norg.apache.pulsar.broker.service.BrokerService#onUpdate\norg.apache.pulsar.broker.service.persistent.PersistentTopic#onPoliciesUpdate\norg.apache.pulsar.broker.service.persistent.PersistentTopic#checkPersistencePolicies\norg.apache.bookkeeper.mledger.impl.ManagedLedgerImpl#setConfig\nare assurable chains to keep config up to date", "author": "Renkai", "createdAt": "2020-12-08T09:24:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNTUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNjA3Nw==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r537616077", "bodyText": "not suggest to use var", "author": "hangc0276", "createdAt": "2020-12-07T15:53:28Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -1336,11 +1335,35 @@ void run() throws PulsarAdminException {\n                 , description = \"ManagedLedger offload deletion lag in bytes\")\n         private Long offloadDeletionLagInMillis;\n \n+        @Parameter(\n+                names = {\"--offloadedReadPriority\", \"-orp\"},\n+                description = \"read priority for offloaded messages\",\n+                required = false\n+        )\n+        private String offloadReadPriorityStr;\n+\n         @Override\n         void run() throws PulsarAdminException {\n             String persistentTopic = validatePersistentTopic(params);\n+\n+            var offloadedReadPriority = OffloadPolicies.DEFAULT_OFFLOADED_READ_PRIORITY;", "originalCommit": "52db96e167fb9bf676affd94c157037b01c66432", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3MzM4Nw==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r537973387", "bodyText": "@hangc0276\nThe official support of type inference in Java began at Java 10, I think it's a good feature to keep code base concise, before Java 10, we can use the Lombok version first, just like we use JodaTime before Java8.\nhttps://openjdk.java.net/jeps/286", "author": "Renkai", "createdAt": "2020-12-08T01:56:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNjA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAyOTAwNQ==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r538029005", "bodyText": "Let's avoid using var now.", "author": "sijie", "createdAt": "2020-12-08T04:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNjA3Nw=="}], "type": "inlineReview"}, {"oid": "38d071ff910c0f07d722ac1aa9c729bf4e946f06", "url": "https://github.com/apache/pulsar/commit/38d071ff910c0f07d722ac1aa9c729bf4e946f06", "message": "use explicit type instead of var\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-08T09:15:49Z", "type": "commit"}, {"oid": "a118a203e90b1acccb10c4c2a2d7894ab5edaea4", "url": "https://github.com/apache/pulsar/commit/a118a203e90b1acccb10c4c2a2d7894ab5edaea4", "message": "Merge branch 'master' into read_priority_full\n\n# Conflicts:\n#\tpulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "committedDate": "2020-12-10T02:52:28Z", "type": "commit"}, {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "url": "https://github.com/apache/pulsar/commit/d9f08b2a286de4f915fa12fa7d96815d20f21473", "message": "Merge branch 'master' into read_priority_full\n\n# Conflicts:\n#\tmanaged-ledger/pom.xml", "committedDate": "2020-12-14T01:55:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0ODQ2Nw==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548548467", "bodyText": "please remove this import", "author": "hangc0276", "createdAt": "2020-12-24T14:43:07Z", "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixReadTest.java", "diffHunk": "@@ -39,7 +40,7 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.TimeUnit;\n-\n+import lombok.val;", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0ODYzNA==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548548634", "bodyText": "Assert.assertTrue may sync with assertEquals", "author": "hangc0276", "createdAt": "2020-12-24T14:43:48Z", "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixReadTest.java", "diffHunk": "@@ -69,53 +71,140 @@ public void testOffloadRead() throws Exception {\n         config.setRetentionTime(10, TimeUnit.MINUTES);\n         config.setRetentionSizeInMB(10);\n         config.setLedgerOffloader(offloader);\n-        ManagedLedgerImpl ledger = (ManagedLedgerImpl)factory.open(\"my_test_ledger\", config);\n+        ManagedLedgerImpl ledger = (ManagedLedgerImpl) factory.open(\"my_test_ledger\", config);\n \n         for (int i = 0; i < 25; i++) {\n             String content = \"entry-\" + i;\n             ledger.addEntry(content.getBytes());\n         }\n-        Assert.assertEquals(ledger.getLedgersInfoAsList().size(), 3);\n+        assertEquals(ledger.getLedgersInfoAsList().size(), 3);\n \n         ledger.offloadPrefix(ledger.getLastConfirmedEntry());\n \n-        Assert.assertEquals(ledger.getLedgersInfoAsList().size(), 3);\n-        Assert.assertEquals(ledger.getLedgersInfoAsList().stream()\n-                            .filter(e -> e.getOffloadContext().getComplete()).count(), 2);\n+        assertEquals(ledger.getLedgersInfoAsList().size(), 3);\n+        assertEquals(ledger.getLedgersInfoAsList().stream()\n+                .filter(e -> e.getOffloadContext().getComplete()).count(), 2);\n         Assert.assertTrue(ledger.getLedgersInfoAsList().get(0).getOffloadContext().getComplete());\n         Assert.assertTrue(ledger.getLedgersInfoAsList().get(1).getOffloadContext().getComplete());", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0ODkxMw==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548548913", "bodyText": "the blank line may not delete.", "author": "hangc0276", "createdAt": "2020-12-24T14:45:04Z", "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixTest.java", "diffHunk": "@@ -23,22 +23,19 @@\n import static org.testng.Assert.assertNotEquals;\n import static org.testng.Assert.assertTrue;\n import static org.testng.Assert.fail;\n-", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA3ODgwMQ==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r549078801", "bodyText": "The checkstyle https://github.com/apache/pulsar/blob/cc64889abe94d47f048e2f8e8fb10d6c37e695ec/buildtools/src/main/resources/pulsar/checkstyle.xml need us to leave no blank line between imports, though it's not enabled in all modules yet, but it will. So I think it's better to remove blank lines here.", "author": "Renkai", "createdAt": "2020-12-27T07:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0ODkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTAxNQ==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548549015", "bodyText": "the blank line may not delete.", "author": "hangc0276", "createdAt": "2020-12-24T14:45:19Z", "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixTest.java", "diffHunk": "@@ -23,22 +23,19 @@\n import static org.testng.Assert.assertNotEquals;\n import static org.testng.Assert.assertTrue;\n import static org.testng.Assert.fail;\n-\n import com.google.common.collect.ImmutableSet;\n-", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA3ODgyOA==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r549078828", "bodyText": "ditto", "author": "Renkai", "createdAt": "2020-12-27T07:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTIwOQ==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548549209", "bodyText": "same with upper.", "author": "hangc0276", "createdAt": "2020-12-24T14:45:54Z", "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixTest.java", "diffHunk": "@@ -23,22 +23,19 @@\n import static org.testng.Assert.assertNotEquals;\n import static org.testng.Assert.assertTrue;\n import static org.testng.Assert.fail;\n-\n import com.google.common.collect.ImmutableSet;\n-\n import java.lang.reflect.Field;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Set;\n import java.util.UUID;\n-import java.util.concurrent.CompletionException;\n import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n import java.util.function.BooleanSupplier;\n import java.util.stream.Collectors;\n-", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTM4NQ==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548549385", "bodyText": "may not delete the new line.", "author": "hangc0276", "createdAt": "2020-12-24T14:46:29Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -21,9 +21,7 @@\n \n import com.google.common.collect.Lists;\n import com.google.common.collect.Sets;\n-", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTcwMA==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548549700", "bodyText": "no blank", "author": "hangc0276", "createdAt": "2020-12-24T14:47:38Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -1434,15 +1433,19 @@\n                     + \"Of course, this may degrade consumption throughput. Default is 10ms.\")\n     private int managedLedgerNewEntriesCheckDelayInMillis = 10;\n \n+    @FieldContext(category = CATEGORY_STORAGE_ML,\n+            doc = \"Read priority when ledgers exists in both bookkeeper and the second layer storage.\")\n+    private String managedLedgerDataReadPriority = OffloadPolicies.OffloadedReadPriority.OFFLOADED_FIRST.getValue();\n+\n     /*** --- Load balancer --- ****/\n     @FieldContext(\n-        category = CATEGORY_LOAD_BALANCER,\n-        doc = \"Enable load balancer\"\n+            category = CATEGORY_LOAD_BALANCER,\n+            doc = \"Enable load balancer\"\n     )\n     private boolean loadBalancerEnabled = true;\n     @Deprecated\n     @FieldContext(\n-        category = CATEGORY_LOAD_BALANCER,\n+            category = CATEGORY_LOAD_BALANCER,", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MDkzNQ==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548550935", "bodyText": "add new blank", "author": "hangc0276", "createdAt": "2020-12-24T14:53:08Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -25,13 +25,12 @@\n import com.google.common.base.Strings;\n import com.google.common.collect.Lists;\n import com.google.common.collect.Sets;\n-\n import java.io.IOException;\n import java.util.Arrays;\n import java.util.HashSet;\n import java.util.List;\n import java.util.concurrent.TimeUnit;\n-\n+import java.util.stream.Collectors;\n import org.apache.commons.lang3.StringUtils;", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MzMzMg==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548553332", "bodyText": "Maybe we should check whether offloadPolicies already have ManagedLedgerOffloadedReadPriority value.", "author": "hangc0276", "createdAt": "2020-12-24T15:03:41Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -1262,6 +1263,12 @@ public void openLedgerFailed(ManagedLedgerException exception, Object ctx) {\n                     topicLevelOffloadPolicies,\n                     OffloadPolicies.oldPoliciesCompatible(nsLevelOffloadPolicies, policies.orElse(null)),\n                     getPulsar().getConfig().getProperties());\n+\n+            if (offloadPolicies != null && serviceConfig.getManagedLedgerDataReadPriority() != null) {\n+                offloadPolicies.setManagedLedgerOffloadedReadPriority(", "originalCommit": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA4MDExMw==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r549080113", "bodyText": "I removed these lines since the initialize progress should already be finished by  OffloadPolicies.mergeConfiguration.", "author": "Renkai", "createdAt": "2020-12-27T08:03:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MzMzMg=="}], "type": "inlineReview"}, {"oid": "d0505bf81593b11f76f745a2ba0d065d35057b86", "url": "https://github.com/apache/pulsar/commit/d0505bf81593b11f76f745a2ba0d065d35057b86", "message": "small fix\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-27T07:44:18Z", "type": "commit"}, {"oid": "32658b61d7ab8772bb6f010e2f2953a872d36b5d", "url": "https://github.com/apache/pulsar/commit/32658b61d7ab8772bb6f010e2f2953a872d36b5d", "message": "small fix\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-27T07:50:42Z", "type": "commit"}, {"oid": "a4860800d5c3b08142e16ede27a26aa2566ad6b5", "url": "https://github.com/apache/pulsar/commit/a4860800d5c3b08142e16ede27a26aa2566ad6b5", "message": "small fix\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-12-27T08:01:51Z", "type": "commit"}, {"oid": "4d22a472aecd3634d234cd1958ea4213009da808", "url": "https://github.com/apache/pulsar/commit/4d22a472aecd3634d234cd1958ea4213009da808", "message": "Merge branch 'master' into read_priority_full", "committedDate": "2020-12-27T08:07:47Z", "type": "commit"}, {"oid": "9c99302a8e236c48a7d563deb48c314bb53da5ff", "url": "https://github.com/apache/pulsar/commit/9c99302a8e236c48a7d563deb48c314bb53da5ff", "message": "Merge branch 'master' into read_priority_full\n\n# Conflicts:\n#\tmanaged-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "committedDate": "2021-01-06T01:16:50Z", "type": "commit"}, {"oid": "142e1ed5a77813d7e3014c5fda4da2578511ed72", "url": "https://github.com/apache/pulsar/commit/142e1ed5a77813d7e3014c5fda4da2578511ed72", "message": "fix conflict\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2021-01-06T01:38:20Z", "type": "commit"}, {"oid": "abf10abbc8b44ea63364c023c3e6a99b95a6df94", "url": "https://github.com/apache/pulsar/commit/abf10abbc8b44ea63364c023c3e6a99b95a6df94", "message": "change driver names to immutable for bugspots\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2021-01-06T01:57:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIwNw==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552390207", "bodyText": "@Renkai Can we avoid using System.out.println?", "author": "sijie", "createdAt": "2021-01-06T06:17:02Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -1336,11 +1338,35 @@ void run() throws PulsarAdminException {\n                 , description = \"ManagedLedger offload deletion lag in bytes\")\n         private Long offloadDeletionLagInMillis;\n \n+        @Parameter(\n+                names = {\"--offloadedReadPriority\", \"-orp\"},\n+                description = \"read priority for offloaded messages\",\n+                required = false\n+        )\n+        private String offloadReadPriorityStr;\n+\n         @Override\n         void run() throws PulsarAdminException {\n             String persistentTopic = validatePersistentTopic(params);\n+\n+            OffloadedReadPriority offloadedReadPriority = OffloadPolicies.DEFAULT_OFFLOADED_READ_PRIORITY;\n+\n+            if (this.offloadReadPriorityStr != null) {\n+                try {\n+                    offloadedReadPriority = OffloadedReadPriority.fromString(this.offloadReadPriorityStr);\n+                    System.out.println(\"offloadedReadPriority = \" + offloadedReadPriority);", "originalCommit": "abf10abbc8b44ea63364c023c3e6a99b95a6df94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwOTU0Nw==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552409547", "bodyText": "@sijie This code is in a command-line tool, I think stdout is a good choice for users to get information", "author": "Renkai", "createdAt": "2021-01-06T07:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQxNzAxOA==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552417018", "bodyText": "This is a set command, no?", "author": "sijie", "createdAt": "2021-01-06T07:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQzNzg5NA==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552437894", "bodyText": "@sijie I check the code again, I think it's ok to remove println so we can use mute as success information, if the value which user set is an invalid value, the tool will throw a exception. The println was removed.", "author": "Renkai", "createdAt": "2021-01-06T08:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIxOQ==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552390219", "bodyText": "@Renkai Can we avoid using System.out.println?", "author": "sijie", "createdAt": "2021-01-06T06:17:06Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -1788,10 +1796,25 @@ void run() throws PulsarAdminException {\n                     offloadAfterThresholdInBytes = offloadAfterThreshold;\n                 }\n             }\n+            OffloadedReadPriority offloadedReadPriority = OffloadPolicies.DEFAULT_OFFLOADED_READ_PRIORITY;\n+\n+            if (this.offloadReadPriorityStr != null) {\n+                try {\n+                    offloadedReadPriority = OffloadedReadPriority.fromString(this.offloadReadPriorityStr);\n+                    System.out.println(\"offloadedReadPriority = \" + offloadedReadPriority);", "originalCommit": "abf10abbc8b44ea63364c023c3e6a99b95a6df94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwOTU5NA==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552409594", "bodyText": "ditto", "author": "Renkai", "createdAt": "2021-01-06T07:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQxNjk1MQ==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552416951", "bodyText": "But this is a set command, no? Why people need this information when setting the offloaded priority?", "author": "sijie", "createdAt": "2021-01-06T07:45:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQzODQwNg==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552438406", "bodyText": "ditto", "author": "Renkai", "createdAt": "2021-01-06T08:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDQ2Ng==", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552390466", "bodyText": "I would suggest renaming OFFLOADED_FIRST to TIERED_STORAGE_FIRST.", "author": "sijie", "createdAt": "2021-01-06T06:17:57Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/policies/data/OffloadPolicies.java", "diffHunk": "@@ -42,9 +46,58 @@\n @Data\n public class OffloadPolicies implements Serializable {\n \n+    @InterfaceAudience.Public\n+    @InterfaceStability.Stable\n+    public enum OffloadedReadPriority {\n+        /**\n+         * For offloaded messages, readers will try to read from bookkeeper at first,\n+         * if messages not exist at bookkeeper then read from offloaded storage.\n+         */\n+        BOOKKEEPER_FIRST(\"bookkeeper-first\"),\n+        /**\n+         * For offloaded messages, readers will try to read from offloaded storage first,\n+         * even they are still exist in bookkeeper.\n+         */\n+        OFFLOADED_FIRST(\"offloaded-first\");", "originalCommit": "abf10abbc8b44ea63364c023c3e6a99b95a6df94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bbd54c81b0ffac80bd0cc2b079d046757185f8c2", "url": "https://github.com/apache/pulsar/commit/bbd54c81b0ffac80bd0cc2b079d046757185f8c2", "message": "rename to tiered storage first\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2021-01-06T07:25:53Z", "type": "commit"}, {"oid": "750600026d04f477739742a17b7e4927d37f7ddb", "url": "https://github.com/apache/pulsar/commit/750600026d04f477739742a17b7e4927d37f7ddb", "message": "rename to tiered storage first\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2021-01-06T07:27:29Z", "type": "commit"}, {"oid": "280715ce456ba9faa4ee6d06ba9740f984b07498", "url": "https://github.com/apache/pulsar/commit/280715ce456ba9faa4ee6d06ba9740f984b07498", "message": "rename to tiered storage first\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2021-01-06T08:35:05Z", "type": "commit"}]}