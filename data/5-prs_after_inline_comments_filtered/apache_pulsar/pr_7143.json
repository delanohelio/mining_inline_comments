{"pr_number": 7143, "pr_title": "Add broker interceptor for Intercepting all Pulsar command and REST API requests", "pr_createdAt": "2020-06-02T12:30:19Z", "pr_url": "https://github.com/apache/pulsar/pull/7143", "timeline": [{"oid": "c83dd46dacc23f51475276e557598ca6ec8dc0b3", "url": "https://github.com/apache/pulsar/commit/c83dd46dacc23f51475276e557598ca6ec8dc0b3", "message": "Add interceptor definition", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "d0f7bf19c361408bf1f4a7884a324949b06866c7", "url": "https://github.com/apache/pulsar/commit/d0f7bf19c361408bf1f4a7884a324949b06866c7", "message": "Merge branch 'server_interceptors' of /Users/lipenghui/Github/incubator-pulsar with conflicts.", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "f0513eb4681d257b7d9fc2d94fa60ceeebcc66fa", "url": "https://github.com/apache/pulsar/commit/f0513eb4681d257b7d9fc2d94fa60ceeebcc66fa", "message": "Add broker event listener", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "cdc292df44533bb2bdd3b537bff0b97badce6fad", "url": "https://github.com/apache/pulsar/commit/cdc292df44533bb2bdd3b537bff0b97badce6fad", "message": "Fix merge issue.", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "35d3ebd0d2d142a359cf600e94ace34eb14a38a2", "url": "https://github.com/apache/pulsar/commit/35d3ebd0d2d142a359cf600e94ace34eb14a38a2", "message": "Revert un-related changes.", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "cc88318a1e0ce1c1c98d73f62f5f5a71738f6d48", "url": "https://github.com/apache/pulsar/commit/cc88318a1e0ce1c1c98d73f62f5f5a71738f6d48", "message": "Revert un-related changes.", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "45c201dd72936b89fb6acac7a3b70242bcceb98a", "url": "https://github.com/apache/pulsar/commit/45c201dd72936b89fb6acac7a3b70242bcceb98a", "message": "Fix nar extract directory", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "3f72bef46b0cef747fb85b70199f6a49a4d8a093", "url": "https://github.com/apache/pulsar/commit/3f72bef46b0cef747fb85b70199f6a49a4d8a093", "message": "Listen all commands.", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "bdea8b8627f6fe1538d8c7ae8ba9fc55398ac8f6", "url": "https://github.com/apache/pulsar/commit/bdea8b8627f6fe1538d8c7ae8ba9fc55398ac8f6", "message": "Cleanup", "committedDate": "2020-06-03T15:25:28Z", "type": "commit"}, {"oid": "bdea8b8627f6fe1538d8c7ae8ba9fc55398ac8f6", "url": "https://github.com/apache/pulsar/commit/bdea8b8627f6fe1538d8c7ae8ba9fc55398ac8f6", "message": "Cleanup", "committedDate": "2020-06-03T15:25:28Z", "type": "forcePushed"}, {"oid": "d55d6fc396a793f274dada0a744ae9946eafe13e", "url": "https://github.com/apache/pulsar/commit/d55d6fc396a793f274dada0a744ae9946eafe13e", "message": "Fix check style.", "committedDate": "2020-06-04T00:26:14Z", "type": "commit"}, {"oid": "3dbf1b9b9faac6c6a3b50117c00f899761e9a2f1", "url": "https://github.com/apache/pulsar/commit/3dbf1b9b9faac6c6a3b50117c00f899761e9a2f1", "message": "Merge remote-tracking branch 'apache/master' into server_interceptors", "committedDate": "2020-06-05T07:16:18Z", "type": "commit"}, {"oid": "4f5b87b68e3a89417ae4ad1cc70ea4c04b56465b", "url": "https://github.com/apache/pulsar/commit/4f5b87b68e3a89417ae4ad1cc70ea4c04b56465b", "message": "Add WebService request listener.", "committedDate": "2020-06-05T10:21:33Z", "type": "commit"}, {"oid": "89440cbf507e41b0c3f05e2d6fafca996fda39fd", "url": "https://github.com/apache/pulsar/commit/89440cbf507e41b0c3f05e2d6fafca996fda39fd", "message": "Merge remote-tracking branch 'apache/master' into server_interceptors", "committedDate": "2020-06-06T01:50:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyMjUxNg==", "url": "https://github.com/apache/pulsar/pull/7143#discussion_r436422516", "bodyText": "overall looks good to me. I see there are two sets of settings here, one is for listeners and the other one is for interceptors? I think we should just rename the listener interfaces to Interceptors. So it is consistent with client-side interceptor.", "author": "sijie", "createdAt": "2020-06-08T01:25:30Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -1769,6 +1783,20 @@\n     )\n     private Set<String> brokerClientTlsProtocols = Sets.newTreeSet();\n \n+    /**** --- Interceptor variables --- ****/\n+\n+    @FieldContext(\n+        category = CATEGORY_INTERCEPTORS,\n+        doc = \"The directory to locate interceptors\"\n+    )\n+    private String interceptorDirectory = \"./interceptors\";", "originalCommit": "89440cbf507e41b0c3f05e2d6fafca996fda39fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyMzI2MQ==", "url": "https://github.com/apache/pulsar/pull/7143#discussion_r436423261", "bodyText": "Ok.", "author": "codelipenghui", "createdAt": "2020-06-08T01:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyMjUxNg=="}], "type": "inlineReview"}, {"oid": "afae533551c287e4189ce84ea232d93d66e7a821", "url": "https://github.com/apache/pulsar/commit/afae533551c287e4189ce84ea232d93d66e7a821", "message": "Merge remote-tracking branch 'apache/master' into server_interceptors", "committedDate": "2020-06-08T05:28:23Z", "type": "commit"}, {"oid": "b9a75e0e3cbdafd7509004e1a9ff1a5bc991f3d1", "url": "https://github.com/apache/pulsar/commit/b9a75e0e3cbdafd7509004e1a9ff1a5bc991f3d1", "message": "Rename to broker interceptor.", "committedDate": "2020-06-08T06:42:37Z", "type": "commit"}, {"oid": "d0e776b48f8dcce4251f2da0a375a1afaef1df10", "url": "https://github.com/apache/pulsar/commit/d0e776b48f8dcce4251f2da0a375a1afaef1df10", "message": "remove unused configurations.", "committedDate": "2020-06-08T06:48:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0MjE2OQ==", "url": "https://github.com/apache/pulsar/pull/7143#discussion_r436542169", "bodyText": "We should support multiple broker interceptors.  Can you add a broker interceptor implementation that wraps a list of interceptors into one interceptor?", "author": "sijie", "createdAt": "2020-06-08T08:45:03Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -450,7 +453,9 @@ public void start() throws PulsarServerException {\n \n             this.defaultOffloader = createManagedLedgerOffloader(\n                     OffloadPolicies.create(this.getConfiguration().getProperties()));\n-\n+            this.brokerInterceptor = BrokerInterceptors.load(config);\n+            brokerService.setInterceptor(getBrokerInterceptor());", "originalCommit": "d0e776b48f8dcce4251f2da0a375a1afaef1df10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU4OTQ1Ng==", "url": "https://github.com/apache/pulsar/pull/7143#discussion_r436589456", "bodyText": "The current implementation is supporting multiple broker interceptors, I added BrokerInterceptors.java also implement BrokerInterceptor interface.", "author": "codelipenghui", "createdAt": "2020-06-08T10:09:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0MjE2OQ=="}], "type": "inlineReview"}, {"oid": "72e0d381c315f7d91dc5bd0b6cb9578e42a4f769", "url": "https://github.com/apache/pulsar/commit/72e0d381c315f7d91dc5bd0b6cb9578e42a4f769", "message": "Fix unit test", "committedDate": "2020-06-08T12:09:35Z", "type": "commit"}, {"oid": "5d0177bdfe282a180e59de8462ea3ce508a4f1e5", "url": "https://github.com/apache/pulsar/commit/5d0177bdfe282a180e59de8462ea3ce508a4f1e5", "message": "Add get method for auth related methods.", "committedDate": "2020-06-08T23:13:51Z", "type": "commit"}]}