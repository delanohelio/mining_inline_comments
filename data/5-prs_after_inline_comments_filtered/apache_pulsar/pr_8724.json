{"pr_number": 8724, "pr_title": "[WebSocket] Fix the initial sequence id error", "pr_createdAt": "2020-11-26T14:13:58Z", "pr_url": "https://github.com/apache/pulsar/pull/8724", "timeline": [{"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8", "url": "https://github.com/apache/pulsar/commit/23dc7057730557d574adf4cf4b7e175aef23adc8", "message": "Fix the initial sequence id error", "committedDate": "2020-11-26T14:16:04Z", "type": "commit"}, {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8", "url": "https://github.com/apache/pulsar/commit/23dc7057730557d574adf4cf4b7e175aef23adc8", "message": "Fix the initial sequence id error", "committedDate": "2020-11-26T14:16:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531260745", "bodyText": "Add a test for getProducerBuilder methods? We can verify the producer applied all we gave configurations.", "author": "zymap", "createdAt": "2020-11-27T00:21:23Z", "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "originalCommit": "23dc7057730557d574adf4cf4b7e175aef23adc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0OTY1Mw==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531349653", "bodyText": "The getProducerBuilder cannot be tested simply. The parameter validation happens in ProducerBuilder#create. However the PulsarClient's service url cannot be mocked because it retrieves the url related params from ZK, see WebSocketService#getPulsarClient for details.\nTherefore, it needs an integration test which may be beyond this PR's scope of work. Also I found there's no WebSocket related integration tests. If you think it's proper to add an WebSocket integration test in this PR, I'll take some time to do it.", "author": "BewareMyPower", "createdAt": "2020-11-27T02:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1NjEwNA==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531356104", "bodyText": "We don't need to validate the params. We can simply mock the queryParams which is a hashmap and put the arguments into the map. Then when we can get the values in the getProducerBuilder. We can make sure the ProducerBuilder contains the configurations which we pass to the hashmap.\nCurrently, the getProducerBuilder can not get the right builder with the queryParams, so we can make sure it can get the right builder with the given params.", "author": "zymap", "createdAt": "2020-11-27T02:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1OTE3NA==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531359174", "bodyText": "I mean something like this:\n    @Test\n    public void testGetTheRightBuilder() {\n        HttpServletRequest request = mock(HttpServletRequest.class);\n        when(request.getParameterMap()).thenReturn(mockedmap)\n        ProducerHandler producerHandler = new ProducerHandler(null, request, null);\n        ProducerBuilderImpl<byte[]> builder = (ProducerBuilderImpl<byte[]>) producerHandler.getProducerBuilder(null);\n        builder.getConf().getProducerName();\n    }", "author": "zymap", "createdAt": "2020-11-27T03:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1OTYxMg==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531359612", "bodyText": "But ProducerBuilder just provides getters but not setters. So we need to call create and it will fail if PulsarClient's service url is not correct.", "author": "BewareMyPower", "createdAt": "2020-11-27T03:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MDQ5OQ==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531360499", "bodyText": "In addition, getProducerBuilder is private. Even if change it to public, it must be called after ProducerHandler is constructed. However, the constructor calls getProducerBuilder and ProducerBuilder#create. This behavior cannot be changed even with a mocked WebSocketService and HttpServletRequest.", "author": "BewareMyPower", "createdAt": "2020-11-27T03:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTIzNg==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531361236", "bodyText": "I am not sure can we cast ProduceBuilder to ProducerBuilderImpl to get some properties?\n        ProducerBuilderImpl<byte[]> builder = (ProducerBuilderImpl<byte[]>) producerHandler.getProducerBuilder(null);\n        builder.getConf().getProducerName();", "author": "zymap", "createdAt": "2020-11-27T03:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTU3Mw==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531361573", "bodyText": "Since the exception is thrown by getProducerBuilder, I think I can add a test to check if any NumberFormatException or IllegalArgumentException was thrown by the ProducerHandler's constructor and treat other exceptions as right behavior.", "author": "BewareMyPower", "createdAt": "2020-11-27T03:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTg0OA==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531361848", "bodyText": "You can usemock to get every behavior you want.", "author": "zymap", "createdAt": "2020-11-27T03:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MjM4NQ==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531362385", "bodyText": "If you need to use the getProducerBuilder method, I think it's ok to make it to package private not public.", "author": "zymap", "createdAt": "2020-11-27T03:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM3MjQ5Ng==", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531372496", "bodyText": "Ok, I'll add a test soon.", "author": "BewareMyPower", "createdAt": "2020-11-27T04:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}], "type": "inlineReview"}, {"oid": "5d4c604bf4f9353a72f010a21c73cbe190e3e5cd", "url": "https://github.com/apache/pulsar/commit/5d4c604bf4f9353a72f010a21c73cbe190e3e5cd", "message": "Add test for producer builder", "committedDate": "2020-11-27T04:47:11Z", "type": "commit"}, {"oid": "4dc07c64d70fb7ef05e2971a17510039018915a8", "url": "https://github.com/apache/pulsar/commit/4dc07c64d70fb7ef05e2971a17510039018915a8", "message": "Add test for consumer builder", "committedDate": "2020-11-27T07:30:22Z", "type": "commit"}]}