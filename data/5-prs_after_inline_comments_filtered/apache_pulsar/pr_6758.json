{"pr_number": 6758, "pr_title": "change test case code org.apache.pulsar.io.PulsarFunctionE2ETest#testFunctionAutomaticSubCleanup", "pr_createdAt": "2020-04-18T01:44:44Z", "pr_url": "https://github.com/apache/pulsar/pull/6758", "timeline": [{"oid": "6bcbbf7d744aa68745f69f9186e70f9df0b9f81c", "url": "https://github.com/apache/pulsar/commit/6bcbbf7d744aa68745f69f9186e70f9df0b9f81c", "message": "in testcase org.apache.pulsar.io.PulsarFunctionE2ETest#testFunctionAutomaticSubCleanup:\n1.  there is one test checkpoint, we should not check `admin.functions().getFunction(tenant, namespacePortion, functionName).getCleanupSubscription()`, instead\nwe should check `admin.functions().getFunction(tenant, namespacePortion, functionName)` is not null,\nand `admin.functions().getFunction(tenant, namespacePortion, functionName).getCleanupSubscription()` should not be null\n\n2. we should not check `Parallelism`, because the code here is 1 instead of 2", "committedDate": "2020-04-18T01:43:08Z", "type": "commit"}, {"oid": "d42ee4ceae1fab22f1cf70aa68e45963326d3092", "url": "https://github.com/apache/pulsar/commit/d42ee4ceae1fab22f1cf70aa68e45963326d3092", "message": "when I run testcase `org.apache.pulsar.broker.admin.AdminApiOffloadTest.testOffloadPolicies`, there is an error,\nI debug the code, I found that there is possibility that `offloadPolicies.getManagedLedgerOffloadDeletionLagInMillis()`\nis null. so I change the code.", "committedDate": "2020-04-20T09:18:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ1NDA5Nw==", "url": "https://github.com/apache/pulsar/pull/6758#discussion_r411454097", "bodyText": "Looks not related to this PR right?", "author": "codelipenghui", "createdAt": "2020-04-20T15:05:59Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -2552,9 +2552,10 @@ protected void internalSetOffloadPolicies(AsyncResponse asyncResponse, OffloadPo\n             final String path = path(POLICIES, namespaceName.toString());\n             byte[] content = globalZk().getData(path, null, nodeStat);\n             Policies policies = jsonMapper().readValue(content, Policies.class);\n-\n-            if (offloadPolicies.getManagedLedgerOffloadDeletionLagInMillis()\n-                    .equals(OffloadPolicies.DEFAULT_OFFLOAD_DELETION_LAG_IN_MILLIS)) {\n+            // there is possibility that `offloadPolicies.getManagedLedgerOffloadDeletionLagInMillis()` is null.\n+            if (offloadPolicies.getManagedLedgerOffloadDeletionLagInMillis() == null && OffloadPolicies.DEFAULT_OFFLOAD_DELETION_LAG_IN_MILLIS == null\n+                    || offloadPolicies.getManagedLedgerOffloadDeletionLagInMillis() != null\n+                    && offloadPolicies.getManagedLedgerOffloadDeletionLagInMillis().equals(OffloadPolicies.DEFAULT_OFFLOAD_DELETION_LAG_IN_MILLIS)) {", "originalCommit": "d42ee4ceae1fab22f1cf70aa68e45963326d3092", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNjgyNQ==", "url": "https://github.com/apache/pulsar/pull/6758#discussion_r411826825", "bodyText": "the change of code is pulsar-broker/src/test/java/org/apache/pulsar/io/PulsarFunctionE2ETest.java,\npulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java is another problem, why the code appear here?", "author": "zplinuxlover", "createdAt": "2020-04-21T02:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ1NDA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNzEyNg==", "url": "https://github.com/apache/pulsar/pull/6758#discussion_r411827126", "bodyText": "is another issue 6775", "author": "zplinuxlover", "createdAt": "2020-04-21T02:43:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ1NDA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc5MTIwMA==", "url": "https://github.com/apache/pulsar/pull/6758#discussion_r412791200", "bodyText": "So we can close #6775 as well.", "author": "codelipenghui", "createdAt": "2020-04-22T08:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ1NDA5Nw=="}], "type": "inlineReview"}, {"oid": "9b0ce6c46785f964fac9c9e22f52269fc91688c8", "url": "https://github.com/apache/pulsar/commit/9b0ce6c46785f964fac9c9e22f52269fc91688c8", "message": "Merge branch 'master' into bugfix-testcase-func", "committedDate": "2020-05-05T08:11:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NTE0NQ==", "url": "https://github.com/apache/pulsar/pull/6758#discussion_r421265145", "bodyText": "Shall we need to add this comment? look we already have a null check for deletion lag.", "author": "codelipenghui", "createdAt": "2020-05-07T06:21:54Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -2595,7 +2595,7 @@ protected void internalSetOffloadPolicies(AsyncResponse asyncResponse, OffloadPo\n             final String path = path(POLICIES, namespaceName.toString());\n             byte[] content = globalZk().getData(path, null, nodeStat);\n             Policies policies = jsonMapper().readValue(content, Policies.class);\n-\n+            // there is possibility that `offloadPolicies.getManagedLedgerOffloadDeletionLagInMillis()` is null.", "originalCommit": "9b0ce6c46785f964fac9c9e22f52269fc91688c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjczOTEwNA==", "url": "https://github.com/apache/pulsar/pull/6758#discussion_r422739104", "bodyText": "OK", "author": "zplinuxlover", "createdAt": "2020-05-11T01:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NTE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2OTc4NA==", "url": "https://github.com/apache/pulsar/pull/6758#discussion_r421269784", "bodyText": "You can fix the wrong assert directly.", "author": "codelipenghui", "createdAt": "2020-05-07T06:34:24Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/io/PulsarFunctionE2ETest.java", "diffHunk": "@@ -1509,8 +1513,9 @@ public void testFunctionAutomaticSubCleanup() throws Exception {\n \n         retryStrategically((test) -> {\n             try {\n+                // should remove `result.getParallelism() == 2` because the parallelism here should 1\n                 FunctionConfig result = admin.functions().getFunction(tenant, namespacePortion, functionName);\n-                return result.getParallelism() == 2 && result.getCleanupSubscription() == false;\n+                return /*result.getParallelism() == 2 &&*/ result.getCleanupSubscription() == false;", "originalCommit": "9b0ce6c46785f964fac9c9e22f52269fc91688c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjczOTA0Mw==", "url": "https://github.com/apache/pulsar/pull/6758#discussion_r422739043", "bodyText": "OK", "author": "zplinuxlover", "createdAt": "2020-05-11T01:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2OTc4NA=="}], "type": "inlineReview"}, {"oid": "118e7499de720b23ba756eacee1933bde29493f7", "url": "https://github.com/apache/pulsar/commit/118e7499de720b23ba756eacee1933bde29493f7", "message": "remove unnecessary comment.", "committedDate": "2020-05-12T09:42:12Z", "type": "commit"}]}