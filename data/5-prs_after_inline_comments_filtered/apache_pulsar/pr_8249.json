{"pr_number": 8249, "pr_title": "Nack support in WS", "pr_createdAt": "2020-10-13T17:29:41Z", "pr_url": "https://github.com/apache/pulsar/pull/8249", "timeline": [{"oid": "909fac3ca6e056c4d60f209e58e33dcc2db03b67", "url": "https://github.com/apache/pulsar/commit/909fac3ca6e056c4d60f209e58e33dcc2db03b67", "message": "Negative acknowledging for WS API", "committedDate": "2020-10-13T17:23:36Z", "type": "commit"}, {"oid": "f02c48e3b019ddde8da7216c8f7a998df790be14", "url": "https://github.com/apache/pulsar/commit/f02c48e3b019ddde8da7216c8f7a998df790be14", "message": "Update site2/website/versioned_docs/version-2.2.0/client-libraries-websocket.md\n\nCo-authored-by: HuanliMeng <48120384+Huanli-Meng@users.noreply.github.com>", "committedDate": "2020-10-17T07:26:24Z", "type": "commit"}, {"oid": "be74ad6f5c10098ccebb67fcc92d68947eb0d378", "url": "https://github.com/apache/pulsar/commit/be74ad6f5c10098ccebb67fcc92d68947eb0d378", "message": "WS docs update (only latest)", "committedDate": "2020-10-18T08:26:30Z", "type": "commit"}, {"oid": "d204bd484e0a2f560c26bf696a158a398b02db4d", "url": "https://github.com/apache/pulsar/commit/d204bd484e0a2f560c26bf696a158a398b02db4d", "message": "Update client-libraries-websocket.md\n\ndocs update", "committedDate": "2020-10-18T15:12:47Z", "type": "commit"}, {"oid": "2dd2d260473ff6a4efca7b5dd90e92e89c5e9b7a", "url": "https://github.com/apache/pulsar/commit/2dd2d260473ff6a4efca7b5dd90e92e89c5e9b7a", "message": "functional test for ws nack added", "committedDate": "2020-11-10T11:20:39Z", "type": "commit"}, {"oid": "241629b865c2d66d9f2d34cfdc6ffac2ea0a3da4", "url": "https://github.com/apache/pulsar/commit/241629b865c2d66d9f2d34cfdc6ffac2ea0a3da4", "message": "functional test for ws nack added (additional assert)", "committedDate": "2020-11-10T11:40:45Z", "type": "commit"}, {"oid": "d8320463788b55c03e1999865520221fab30ec04", "url": "https://github.com/apache/pulsar/commit/d8320463788b55c03e1999865520221fab30ec04", "message": "Merge remote-tracking branch 'apache/master' into feature/ws-nack", "committedDate": "2020-11-17T03:12:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg1ODEwMw==", "url": "https://github.com/apache/pulsar/pull/8249#discussion_r524858103", "bodyText": "I think you can refine the test as #8557 does. Sleep also introduces too much flaky tests.", "author": "codelipenghui", "createdAt": "2020-11-17T03:16:01Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/websocket/proxy/ProxyPublishConsumeTest.java", "diffHunk": "@@ -564,6 +566,76 @@ public void socketPullModeTest() throws Exception {\n         }\n     }\n \n+    @Test(timeOut = 10000)\n+    public void nackMessageTest() throws Exception {\n+        final String subscription = \"my-sub\";\n+        final String dlqTopic = \"my-property/my-ns/my-topic10\";\n+        final String consumerTopic = \"my-property/my-ns/my-topic9\";\n+\n+        final String dlqUri = \"ws://localhost:\" + proxyServer.getListenPortHTTP().get() +\n+          \"/ws/v2/consumer/persistent/\" +\n+          dlqTopic + \"/\" + subscription +\n+          \"?subscriptionType=Shared\";\n+\n+        final String consumerUri = \"ws://localhost:\" + proxyServer.getListenPortHTTP().get() +\n+          \"/ws/v2/consumer/persistent/\" +\n+          consumerTopic + \"/\" + subscription +\n+          \"?deadLetterTopic=\" + dlqTopic +\n+          \"&maxRedeliverCount=0&subscriptionType=Shared&ackTimeoutMillis=1000&negativeAckRedeliveryDelay=1000\";\n+\n+        final String producerUri = \"ws://localhost:\" + proxyServer.getListenPortHTTP().get() +\n+          \"/ws/v2/producer/persistent/\" + consumerTopic;\n+\n+        WebSocketClient consumeClient1 = new WebSocketClient();\n+        SimpleConsumerSocket consumeSocket1 = new SimpleConsumerSocket();\n+        WebSocketClient consumeClient2 = new WebSocketClient();\n+        SimpleConsumerSocket consumeSocket2 = new SimpleConsumerSocket();\n+        WebSocketClient produceClient = new WebSocketClient();\n+        SimpleProducerSocket produceSocket = new SimpleProducerSocket();\n+\n+        consumeSocket1.setMessageHandler((id, data) -> {\n+            JsonObject nack = new JsonObject();\n+            nack.add(\"messageId\", new JsonPrimitive(id));\n+            nack.add(\"type\", new JsonPrimitive(\"negativeAcknowledge\"));\n+            return nack.toString();\n+        });\n+\n+        try {\n+            consumeClient1.start();\n+            consumeClient2.start();\n+            ClientUpgradeRequest consumeRequest1 = new ClientUpgradeRequest();\n+            ClientUpgradeRequest consumeRequest2 = new ClientUpgradeRequest();\n+            Future<Session> consumerFuture1 = consumeClient1.connect(consumeSocket1, URI.create(consumerUri), consumeRequest1);\n+            Future<Session> consumerFuture2 = consumeClient2.connect(consumeSocket2, URI.create(dlqUri), consumeRequest2);\n+\n+            assertTrue(consumerFuture1.get().isOpen());\n+            assertTrue(consumerFuture2.get().isOpen());\n+\n+            ClientUpgradeRequest produceRequest = new ClientUpgradeRequest();\n+            produceClient.start();\n+            Future<Session> producerFuture = produceClient.connect(produceSocket, URI.create(producerUri), produceRequest);\n+            assertTrue(producerFuture.get().isOpen());\n+\n+            assertEquals(consumeSocket1.getReceivedMessagesCount(), 0);\n+            assertEquals(consumeSocket2.getReceivedMessagesCount(), 0);\n+\n+            produceSocket.sendMessage(1);\n+\n+            Thread.sleep(500);\n+\n+            //assertEquals(consumeSocket1.getReceivedMessagesCount(), 1);", "originalCommit": "d8320463788b55c03e1999865520221fab30ec04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk2NTQwOQ==", "url": "https://github.com/apache/pulsar/pull/8249#discussion_r560965409", "bodyText": "Miss license header here.", "author": "codelipenghui", "createdAt": "2021-01-20T13:38:41Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/websocket/proxy/SimpleConsumerMessageHandler.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package org.apache.pulsar.websocket.proxy;", "originalCommit": "d8320463788b55c03e1999865520221fab30ec04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c19e1c28d731f68ffa6fc5b9f43df40408c4e2bf", "url": "https://github.com/apache/pulsar/commit/c19e1c28d731f68ffa6fc5b9f43df40408c4e2bf", "message": "license header added", "committedDate": "2021-01-20T14:37:09Z", "type": "commit"}, {"oid": "3fe4c15bc70feb691737f3e271b23ddca5b2ade4", "url": "https://github.com/apache/pulsar/commit/3fe4c15bc70feb691737f3e271b23ddca5b2ade4", "message": "Merge branch 'feature/ws-nack' of github.com:yrsh/pulsar into feature/ws-nack", "committedDate": "2021-01-20T14:37:58Z", "type": "commit"}, {"oid": "7804b03d19c3b78c6f99842c5ab37b67d182d2e2", "url": "https://github.com/apache/pulsar/commit/7804b03d19c3b78c6f99842c5ab37b67d182d2e2", "message": "Merge branch 'master' into feature/ws-nack", "committedDate": "2021-03-12T09:24:19Z", "type": "commit"}, {"oid": "38520fb0e1189ae0efc856f339ba4d7dfc6853d8", "url": "https://github.com/apache/pulsar/commit/38520fb0e1189ae0efc856f339ba4d7dfc6853d8", "message": "Merge branch 'master' into feature/ws-nack", "committedDate": "2021-03-16T10:41:10Z", "type": "commit"}, {"oid": "9f3b54c34057bca122cc36378368dbb19b4605d4", "url": "https://github.com/apache/pulsar/commit/9f3b54c34057bca122cc36378368dbb19b4605d4", "message": "Merge remote-tracking branch 'apache/master' into feature/ws-nack", "committedDate": "2021-05-21T07:15:34Z", "type": "commit"}]}