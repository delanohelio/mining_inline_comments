{"pr_number": 8686, "pr_title": "Support HAProxy proxy protocol for broker and proxy", "pr_createdAt": "2020-11-24T17:45:13Z", "pr_url": "https://github.com/apache/pulsar/pull/8686", "timeline": [{"oid": "1a47b3ca535b4cc41ed6f97e98fd0fbc4f59d8fb", "url": "https://github.com/apache/pulsar/commit/1a47b3ca535b4cc41ed6f97e98fd0fbc4f59d8fb", "message": "Support HAProxy proxy protocol.", "committedDate": "2020-11-24T17:40:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc3NTA3MQ==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r529775071", "bodyText": "remove this?", "author": "sijie", "createdAt": "2020-11-24T18:02:38Z", "path": "pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/ProxyConnection.java", "diffHunk": "@@ -169,6 +171,11 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E\n \n     @Override\n     public void channelRead(final ChannelHandlerContext ctx, Object msg) throws Exception {\n+        System.out.println(haProxyMessage);", "originalCommit": "1a47b3ca535b4cc41ed6f97e98fd0fbc4f59d8fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89532cd2735ead88f180d60c80c47369d9065719", "url": "https://github.com/apache/pulsar/commit/89532cd2735ead88f180d60c80c47369d9065719", "message": "Fix comment", "committedDate": "2020-11-25T00:48:47Z", "type": "commit"}, {"oid": "836beed879856b27be88d3a1059ab9e6c5e2c44d", "url": "https://github.com/apache/pulsar/commit/836beed879856b27be88d3a1059ab9e6c5e2c44d", "message": "Fix license check.", "committedDate": "2020-11-25T02:01:56Z", "type": "commit"}, {"oid": "0dfdfe0bd99ef521744fe535e284729eae65aaf0", "url": "https://github.com/apache/pulsar/commit/0dfdfe0bd99ef521744fe535e284729eae65aaf0", "message": "Change configuration param name.", "committedDate": "2020-11-25T07:16:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5NTM1Ng==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530195356", "bodyText": "Actually maximum record size is 107 by spec:\n\n\nworst case (optional fields set to 0xff) :```\n\"PROXY UNKNOWN ffff:f...f:ffff ffff:f...f:ffff 65535 65535\\r\\n\"\n=> 5 + 1 + 7 + 1 + 39 + 1 + 39 + 1 + 5 + 1 + 5 + 2 = 107 chars\n\n\n[...]\nThe receiver must wait for the CRLF sequence before starting to decode the\naddresses in order to ensure they are complete and properly parsed. If the CRLF\nsequence is not found in the first 107 characters, the receiver should declare\nthe line invalid.", "author": "diegosalvi", "createdAt": "2020-11-25T08:43:35Z", "path": "pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/DirectProxyHandler.java", "diffHunk": "@@ -143,10 +150,56 @@ protected void initChannel(SocketChannel ch) throws Exception {\n                 inboundOutboundChannelMap.put(outboundChannel.id() , inboundChannel.id());\n             }\n \n-\n+            if (config.isHaProxyProtocolEnabled()) {\n+                if (proxyConnection.hasHAProxyMessage()) {\n+                    outboundChannel.writeAndFlush(encodeProxyProtocolMessage(proxyConnection.getHAProxyMessage()));\n+                } else {\n+                    if (inboundChannel.remoteAddress() instanceof InetSocketAddress) {\n+                        InetSocketAddress clientAddress = (InetSocketAddress) inboundChannel.remoteAddress();\n+                        String sourceAddress = clientAddress.getAddress().getHostAddress();\n+                        int sourcePort = clientAddress.getPort();\n+                        if (outboundChannel.localAddress() instanceof InetSocketAddress) {\n+                            InetSocketAddress proxyAddress = (InetSocketAddress) inboundChannel.remoteAddress();\n+                            String destinationAddress = proxyAddress.getAddress().getHostAddress();\n+                            int destinationPort = proxyAddress.getPort();\n+                            HAProxyMessage msg = new HAProxyMessage(HAProxyProtocolVersion.V1, HAProxyCommand.PROXY,\n+                                    HAProxyProxiedProtocol.TCP4, sourceAddress, destinationAddress, sourcePort, destinationPort);\n+                            outboundChannel.writeAndFlush(encodeProxyProtocolMessage(msg));\n+                            msg.release();\n+                        }\n+                    }\n+                }\n+            }\n         });\n     }\n \n+    private ByteBuf encodeProxyProtocolMessage(HAProxyMessage msg) {\n+        // Max length of v1 version proxy protocol message is 108\n+        ByteBuf out = Unpooled.buffer(108);", "originalCommit": "0dfdfe0bd99ef521744fe535e284729eae65aaf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwNzAxMw==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530307013", "bodyText": "I'm using the netty-haproxy-codec directly. I think netty codec already handled this?", "author": "codelipenghui", "createdAt": "2020-11-25T11:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5NTM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMTk1Mw==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530311953", "bodyText": "I just noticed the max length for v1 is 108 https://github.com/netty/netty/blob/4.1/codec-haproxy/src/main/java/io/netty/handler/codec/haproxy/HAProxyMessageDecoder.java#L37", "author": "codelipenghui", "createdAt": "2020-11-25T11:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5NTM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5ODMzMQ==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530198331", "bodyText": "I think we should have the possibilitiy to require proxy headers instead of handle them as optional.\nSpecification itself states:\nThe receiver MUST be configured to only receive the protocol described in this\nspecification and MUST not try to guess whether the protocol header is present\nor not. This means that the protocol explicitly prevents port sharing between\npublic and private access.", "author": "diegosalvi", "createdAt": "2020-11-25T08:48:29Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/PulsarChannelInitializer.java", "diffHunk": "@@ -118,6 +119,9 @@ protected void initChannel(SocketChannel ch) throws Exception {\n             ch.pipeline().addLast(\"ByteBufPairEncoder\", ByteBufPair.ENCODER);\n         }\n \n+        if (pulsar.getConfiguration().isHaProxyProtocolEnabled()) {\n+            ch.pipeline().addLast(OptionalProxyProtocolDecoder.NAME, new OptionalProxyProtocolDecoder());", "originalCommit": "0dfdfe0bd99ef521744fe535e284729eae65aaf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwODg1OQ==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530308859", "bodyText": "This is a flag to control if users want to enable the haproxy protocol support. We must provide a way to disable this feature.", "author": "codelipenghui", "createdAt": "2020-11-25T11:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5ODMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE1MDY0OQ==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r531150649", "bodyText": "Sure! What I was saying is that there isn't a way to REQUIRE proxy header if pulsar.getConfiguration().isHaProxyProtocolEnabled(). Specs states that is MUST expect a proxy header, it isn't optional. There could be another option to handle optional/mandatory", "author": "diegosalvi", "createdAt": "2020-11-26T17:01:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5ODMzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwOTc5OA==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530209798", "bodyText": "netty-haproxy can decode binary v2 version too (but doesn't implements encoding).\nWe could add another encoding method for v2 protocol and let the configurer choose which use.\nFor the encoding implementation I've done one for subethamail if you want take a peek. It has been done for testing purposes (so it permits some strange behaviour to check various edge cases and \"wrong\" headers and can surely be simplified): https://github.com/davidmoten/subethasmtp/blob/master/src/test/java/org/subethamail/smtp/internal/proxy/ProxyProtocolV2HandlerTest.java", "author": "diegosalvi", "createdAt": "2020-11-25T09:06:13Z", "path": "pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/DirectProxyHandler.java", "diffHunk": "@@ -143,10 +150,56 @@ protected void initChannel(SocketChannel ch) throws Exception {\n                 inboundOutboundChannelMap.put(outboundChannel.id() , inboundChannel.id());\n             }\n \n-\n+            if (config.isHaProxyProtocolEnabled()) {\n+                if (proxyConnection.hasHAProxyMessage()) {\n+                    outboundChannel.writeAndFlush(encodeProxyProtocolMessage(proxyConnection.getHAProxyMessage()));\n+                } else {\n+                    if (inboundChannel.remoteAddress() instanceof InetSocketAddress) {\n+                        InetSocketAddress clientAddress = (InetSocketAddress) inboundChannel.remoteAddress();\n+                        String sourceAddress = clientAddress.getAddress().getHostAddress();\n+                        int sourcePort = clientAddress.getPort();\n+                        if (outboundChannel.localAddress() instanceof InetSocketAddress) {\n+                            InetSocketAddress proxyAddress = (InetSocketAddress) inboundChannel.remoteAddress();\n+                            String destinationAddress = proxyAddress.getAddress().getHostAddress();\n+                            int destinationPort = proxyAddress.getPort();\n+                            HAProxyMessage msg = new HAProxyMessage(HAProxyProtocolVersion.V1, HAProxyCommand.PROXY,", "originalCommit": "0dfdfe0bd99ef521744fe535e284729eae65aaf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMDI2Mg==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530310262", "bodyText": "It's not a required for this PR, we can support the proxy set the different protocol version in the following PRs.", "author": "codelipenghui", "createdAt": "2020-11-25T11:40:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwOTc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE0OTY4NA==", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r531149684", "bodyText": "Sounds good", "author": "diegosalvi", "createdAt": "2020-11-26T16:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwOTc5OA=="}], "type": "inlineReview"}]}