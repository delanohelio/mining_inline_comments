{"pr_number": 8871, "pr_title": "Export Prometheus metric for messageTTL", "pr_createdAt": "2020-12-09T05:56:30Z", "pr_url": "https://github.com/apache/pulsar/pull/8871", "timeline": [{"oid": "914a6cdfeaad93684ac047421eec11cde068f816", "url": "https://github.com/apache/pulsar/commit/914a6cdfeaad93684ac047421eec11cde068f816", "message": "Export Prometheus metric for messageTTL", "committedDate": "2020-12-09T05:53:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMTQ5OQ==", "url": "https://github.com/apache/pulsar/pull/8871#discussion_r539031499", "bodyText": "Can we find a different way to trigger message expiry task?\nIt is not a good idea to call Thread.sleep.", "author": "sijie", "createdAt": "2020-12-09T05:59:12Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java", "diffHunk": "@@ -185,6 +192,95 @@ public void testPerTopicStats() throws Exception {\n         c2.close();\n     }\n \n+    @Test\n+    public void testPerTopicExpiredStat() throws Exception {\n+        String ns = \"prop/ns-abc1\";\n+        admin.namespaces().createNamespace(ns);\n+        String topic1 = \"persistent://\" + ns + \"/testPerTopicExpiredStat1\";\n+        String topic2 = \"persistent://\" + ns + \"/testPerTopicExpiredStat2\";\n+        List<String> topicList = Arrays.asList(topic2,topic1);\n+        Producer<byte[]> p1 = pulsarClient.newProducer().topic(topic1).create();\n+        Producer<byte[]> p2 = pulsarClient.newProducer().topic(topic2).create();\n+        admin.namespaces().setNamespaceMessageTTL(ns,1);\n+        final String subName = \"test\";\n+        for (String topic : topicList) {\n+            pulsarClient.newConsumer()\n+                    .topic(topic)\n+                    .subscriptionName(subName)\n+                    .subscribe().close();\n+        }\n+\n+        final int messages = 10;\n+\n+        for (int i = 0; i < messages; i++) {\n+            String message = \"my-message-\" + i;\n+            p1.send(message.getBytes());\n+            p2.send(message.getBytes());\n+        }\n+\n+        p1.close();\n+        p2.close();\n+        // make sure message is expired\n+        Thread.sleep(2000);", "originalCommit": "914a6cdfeaad93684ac047421eec11cde068f816", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "620b887e6e7b4271b213eddc8bebff82651f61b3", "url": "https://github.com/apache/pulsar/commit/620b887e6e7b4271b213eddc8bebff82651f61b3", "message": "Avoid sleep", "committedDate": "2020-12-09T06:36:44Z", "type": "commit"}, {"oid": "adc8c0eb3f046bfd78d74e516dba8ac30f250229", "url": "https://github.com/apache/pulsar/commit/adc8c0eb3f046bfd78d74e516dba8ac30f250229", "message": "Merge branch 'master' into metric", "committedDate": "2020-12-09T08:24:20Z", "type": "commit"}, {"oid": "4b25e25101a9d6705264f0e376868ff573418326", "url": "https://github.com/apache/pulsar/commit/4b25e25101a9d6705264f0e376868ff573418326", "message": "Avoid sleep", "committedDate": "2020-12-09T10:24:23Z", "type": "commit"}, {"oid": "3bc7638275593ccd061ce047fa3d118df0951ee5", "url": "https://github.com/apache/pulsar/commit/3bc7638275593ccd061ce047fa3d118df0951ee5", "message": "restore import", "committedDate": "2020-12-09T10:26:54Z", "type": "commit"}, {"oid": "ec3b2a80399710488211d474bab0bc17d8eda728", "url": "https://github.com/apache/pulsar/commit/ec3b2a80399710488211d474bab0bc17d8eda728", "message": "Merge branch 'master' into metric\n\n# Conflicts:\n#\tpulsar-broker/src/main/java/org/apache/pulsar/broker/stats/prometheus/TopicStats.java", "committedDate": "2020-12-10T04:11:56Z", "type": "commit"}, {"oid": "912fd97a3f71ca6905f966e7a0e7d7ebdfe88b7e", "url": "https://github.com/apache/pulsar/commit/912fd97a3f71ca6905f966e7a0e7d7ebdfe88b7e", "message": "code style", "committedDate": "2020-12-10T04:26:24Z", "type": "commit"}]}