{"pr_number": 1380, "pr_title": "Add SPI to configure additional bootstrap package prefixes", "pr_createdAt": "2020-10-13T13:52:45Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk3NDU5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r503974593", "bodyText": "I could get around without introducing this class. In the AgentInstaller I have set the package prefixes to the config (in the static block) and then used the config in the classloader instrumentation. We could also remove the SPI so vendors would set the packages in the config - I don't like this since it easily opens the config to the consumers.", "author": "pavolloffay", "createdAt": "2020-10-13T13:57:58Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/config/BootstrapPackagePrefixesHolder.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.config;\n+\n+/**\n+ * {@link BootstrapPackagePrefixesHolder} in an utility class that holds package prefixes. The\n+ * classes from these packages are pushed to the bootstrap classloader.\n+ *\n+ * <p>The prefixes are loaded by {@code AgentInstaller} and consumed by classloader instrumentation.\n+ * The instrumentation does not have access to the installer, therefore this utility class is used\n+ * to share package prefixes.\n+ */\n+public class BootstrapPackagePrefixesHolder {", "originalCommit": "e9c94f7a12b5984a41ae809dd085fd7b9a4b24d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MDYyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504370629", "bodyText": "can this go in javaagent-bootstrap near HelperResources which serves somewhat similar purpose?", "author": "trask", "createdAt": "2020-10-14T02:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk3NDU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzMjYxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504532610", "bodyText": "When the class is in javaagent-bootstrap (and added to helper class names in the classloader instrumentation) the set prefixes set by the AgentInstaller are always null - the agent installer has a different instance as the instrumentation.\nLoading the providers from the instrumentation fails at build time on the muzzle size limit.", "author": "pavolloffay", "createdAt": "2020-10-14T09:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk3NDU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNjUyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504536528", "bodyText": "I have moved it to internal package in the same module.", "author": "pavolloffay", "createdAt": "2020-10-14T09:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk3NDU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MDczNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504370734", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * {@link BootstrapPackagePrefixesHolder} in an utility class that holds package prefixes. The\n          \n          \n            \n             * {@link BootstrapPackagePrefixesHolder} is an utility class that holds package prefixes. The", "author": "trask", "createdAt": "2020-10-14T02:58:04Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/config/BootstrapPackagePrefixesHolder.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.config;\n+\n+/**\n+ * {@link BootstrapPackagePrefixesHolder} in an utility class that holds package prefixes. The", "originalCommit": "e9c94f7a12b5984a41ae809dd085fd7b9a4b24d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MTYxOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504371618", "bodyText": "Is Config not available here? If it is, we can just use a config property instead of a separate SPI?", "author": "anuraaga", "createdAt": "2020-10-14T03:01:13Z", "path": "instrumentation/java-classloader/src/main/java/io/opentelemetry/javaagent/instrumentation/javaclassloader/ClassLoaderInstrumentation.java", "diffHunk": "@@ -88,7 +89,7 @@ public ClassLoaderInstrumentation() {\n         return null;\n       }\n       try {\n-        for (String prefix : Constants.BOOTSTRAP_PACKAGE_PREFIXES) {\n+        for (String prefix : BootstrapPackagePrefixesHolder.getBootstrapPrefixes()) {", "originalCommit": "e9c94f7a12b5984a41ae809dd085fd7b9a4b24d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM4ODQzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504388430", "bodyText": "See @pavolloffay's #1380 (comment)\n\nWe could also remove the SPI so vendors would set the packages in the config - I don't like this since it easily opens the config to the consumers.\n\nI think I agree, I think nice to encapsulate vendor extension points in SPI, even if we end up with lots of them(?)", "author": "trask", "createdAt": "2020-10-14T04:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MTYxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM4ODYzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504388631", "bodyText": "Sorry for missing the comment! SGTM", "author": "anuraaga", "createdAt": "2020-10-14T04:07:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3MTYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU3NTgwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504575805", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return bootstrapPackages.toArray(new String[] {});\n          \n          \n            \n                return bootstrapPackages.toArray(new String[0]);", "author": "iNikem", "createdAt": "2020-10-14T10:38:28Z", "path": "javaagent-tooling/src/main/java/io/opentelemetry/javaagent/tooling/AgentInstaller.java", "diffHunk": "@@ -207,6 +211,23 @@ private static void addByteBuddyRawSetting() {\n     return matcher;\n   }\n \n+  private static String[] loadBootstrapPackagesPrefixes() {\n+    List<String> bootstrapPackages =\n+        new ArrayList<>(Arrays.asList(Constants.BOOTSTRAP_PACKAGE_PREFIXES));\n+    Iterable<BootstrapPackagesProvider> bootstrapPackagesProviders =\n+        SafeServiceLoader.load(\n+            BootstrapPackagesProvider.class, AgentInstaller.class.getClassLoader());\n+    for (BootstrapPackagesProvider provider : bootstrapPackagesProviders) {\n+      List<String> packagePrefixes = provider.getPackagePrefixes();\n+      log.debug(\n+          \"Loaded bootstrap package prefixes from {}: {}\",\n+          provider.getClass().getName(),\n+          packagePrefixes);\n+      bootstrapPackages.addAll(packagePrefixes);\n+    }\n+    return bootstrapPackages.toArray(new String[] {});", "originalCommit": "8d72f879f62bb7dacaf7b97356fb5e12eb834b62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU3OTgyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504579827", "bodyText": "Can you make this class more similar to Config/OpenTelemetrySdkAccess? I.e. volatile static field, internal... setter method name, checking that you can only set the value once.", "author": "mateuszrzeszutek", "createdAt": "2020-10-14T10:46:02Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/internal/BootstrapPackagePrefixesHolder.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.internal;\n+\n+/**\n+ * {@link BootstrapPackagePrefixesHolder} is an utility class that holds package prefixes. The\n+ * classes from these packages are pushed to the bootstrap classloader.\n+ *\n+ * <p>The prefixes are loaded by {@code AgentInstaller} and consumed by classloader instrumentation.\n+ * The instrumentation does not have access to the installer, therefore this utility class is used\n+ * to share package prefixes.\n+ */\n+public class BootstrapPackagePrefixesHolder {\n+\n+  private static String[] bootstrapPrefixes;\n+\n+  public static String[] getBootstrapPrefixes() {\n+    return bootstrapPrefixes;\n+  }\n+\n+  public static void setBootstrapPrefixes(String[] prefixes) {", "originalCommit": "8d72f879f62bb7dacaf7b97356fb5e12eb834b62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU4NzAxOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r504587019", "bodyText": "If it's supposed to be available in instrumentation-api consider using a List (and Collections.unmodifiableList() wrapper): arrays are mutable and can be easily changed by anybody.", "author": "mateuszrzeszutek", "createdAt": "2020-10-14T10:59:24Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/internal/BootstrapPackagePrefixesHolder.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.internal;\n+\n+/**\n+ * {@link BootstrapPackagePrefixesHolder} is an utility class that holds package prefixes. The\n+ * classes from these packages are pushed to the bootstrap classloader.\n+ *\n+ * <p>The prefixes are loaded by {@code AgentInstaller} and consumed by classloader instrumentation.\n+ * The instrumentation does not have access to the installer, therefore this utility class is used\n+ * to share package prefixes.\n+ */\n+public class BootstrapPackagePrefixesHolder {\n+\n+  private static String[] bootstrapPrefixes;\n+\n+  public static String[] getBootstrapPrefixes() {\n+    return bootstrapPrefixes;", "originalCommit": "8d72f879f62bb7dacaf7b97356fb5e12eb834b62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cfdc592d8365e97638ad3f6503bcb4e4db1bb47e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cfdc592d8365e97638ad3f6503bcb4e4db1bb47e", "message": "Add SPI to configure additional bootstrap package prefixes\n\nThis feature is useful when a large set of custom instrumentations is\nusing common classes from a custom package.\n\nSigned-off-by: Pavol Loffay <p.loffay@gmail.com>", "committedDate": "2020-10-15T14:46:32Z", "type": "commit"}, {"oid": "4f417d36560cc0a8ae3cd95bac56e7e0b6145600", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4f417d36560cc0a8ae3cd95bac56e7e0b6145600", "message": "Review comments and move holder to internal package\n\nSigned-off-by: Pavol Loffay <p.loffay@gmail.com>", "committedDate": "2020-10-15T14:46:32Z", "type": "commit"}, {"oid": "41848854588be64b148bd671607cfdf63f442092", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/41848854588be64b148bd671607cfdf63f442092", "message": "review comments\n\nSigned-off-by: Pavol Loffay <p.loffay@gmail.com>", "committedDate": "2020-10-15T14:54:25Z", "type": "commit"}, {"oid": "41848854588be64b148bd671607cfdf63f442092", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/41848854588be64b148bd671607cfdf63f442092", "message": "review comments\n\nSigned-off-by: Pavol Loffay <p.loffay@gmail.com>", "committedDate": "2020-10-15T14:54:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzMDM2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1380#discussion_r505630363", "bodyText": "Just a minor comment: how about internalSetBootstrapPackagePrefixes?", "author": "mateuszrzeszutek", "createdAt": "2020-10-15T15:20:10Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/internal/BootstrapPackagePrefixesHolder.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.internal;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * {@link BootstrapPackagePrefixesHolder} is an utility class that holds package prefixes. The\n+ * classes from these packages are pushed to the bootstrap classloader.\n+ *\n+ * <p>The prefixes are loaded by {@code AgentInstaller} and consumed by classloader instrumentation.\n+ * The instrumentation does not have access to the installer, therefore this utility class is used\n+ * to share package prefixes.\n+ */\n+public class BootstrapPackagePrefixesHolder {\n+\n+  private static volatile List<String> BOOSTRAP_PACKAGE_PREFIXES;\n+\n+  public static List<String> getBoostrapPackagePrefixes() {\n+    return BOOSTRAP_PACKAGE_PREFIXES;\n+  }\n+\n+  public static void setBoostrapPackagePrefixes(List<String> prefixes) {", "originalCommit": "41848854588be64b148bd671607cfdf63f442092", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}