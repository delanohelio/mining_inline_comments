{"pr_number": 155, "pr_title": "Add missing null check", "pr_createdAt": "2020-02-11T18:05:56Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155", "timeline": [{"oid": "8113e0f7bd835fd75eb398250cc400726c3608a6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8113e0f7bd835fd75eb398250cc400726c3608a6", "message": "Add missing null check", "committedDate": "2020-02-11T05:10:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377807786", "bodyText": "when do you end up with null here? Should we have a no-op version of the class for those cases?", "author": "jkwatson", "createdAt": "2020-02-11T18:10:32Z", "path": "instrumentation/reactor-core-3.1/src/main/java8/io/opentelemetry/auto/instrumentation/reactor/core/FluxAndMonoSubscribeAdvice.java", "diffHunk": "@@ -33,11 +33,12 @@ public static SpanWithScope methodEnter(\n   @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n   public static void methodExit(\n       @Advice.Enter final SpanWithScope spanWithScope, @Advice.Thrown final Throwable throwable) {\n+    if (spanWithScope == null) {", "originalCommit": "8113e0f7bd835fd75eb398250cc400726c3608a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwOTE5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377809197", "bodyText": "when the Advice.OnMethodEnter method above returns null", "author": "trask", "createdAt": "2020-02-11T18:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxMTE1NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377811155", "bodyText": "maybe that should return a no-op version, rather than null?", "author": "jkwatson", "createdAt": "2020-02-11T18:17:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxMzA0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377813048", "bodyText": "this is the pattern used throughout the code, so that's a bigger discussion, also less efficient because then we end up calling setAttribute a bunch of times on no-op Spans unnecessarily", "author": "trask", "createdAt": "2020-02-11T18:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxMzU3OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377813578", "bodyText": "maybe this discussion can be part of auto/lib instrumentation convergence", "author": "trask", "createdAt": "2020-02-11T18:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxOTg2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377819862", "bodyText": "oh, i forgot, even in auto/lib convergence, this pattern of passing across SpanWithScope will only exist in auto instrumentation, so this discussion doesn't apply to auto/lib instrumentation convergence, and this will stay internal API only (so i think ok to continue using null?)", "author": "trask", "createdAt": "2020-02-11T18:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgyMzEyMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377823123", "bodyText": "Just my opinion, which you are free to ignore, but using null as the contract between these methods seems like a dangerous anti-pattern, because (as you see in this very PR), it's easy to forget to check for nulls. I'm not often a fan of the null object pattern, but this sure seems like a good case for it. no-op methods are very fast and will get inlined quickly by the JIT if they get called much.", "author": "jkwatson", "createdAt": "2020-02-11T18:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgyNTMyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377825327", "bodyText": "the calling of no-op methods will get inlined, but not the calculations of the attribute values, which can be expensive (e.g. calling Throwable.printStackTrace())", "author": "trask", "createdAt": "2020-02-11T18:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgyNjM3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377826370", "bodyText": "If finishSpanIfPresent checked for span.isInvalid() then that call could also be avoided.", "author": "jkwatson", "createdAt": "2020-02-11T18:45:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg5NDI5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/155#discussion_r377894297", "bodyText": "this pattern (passing null from OnMethodEnter to OnMethodExit) is used throughout the existing codebase, so i think better for this PR to stay consistent, and if we want to change the pattern then that belongs to a different PR where we can look at the change in the context of the full codebase", "author": "trask", "createdAt": "2020-02-11T20:58:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwNzc4Ng=="}], "type": "inlineReview"}, {"oid": "258445b69e3c644b67a8aea8dbc029a4e727171b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/258445b69e3c644b67a8aea8dbc029a4e727171b", "message": "Merge branch 'master' into add-missing-null-check", "committedDate": "2020-02-11T20:46:54Z", "type": "commit"}]}