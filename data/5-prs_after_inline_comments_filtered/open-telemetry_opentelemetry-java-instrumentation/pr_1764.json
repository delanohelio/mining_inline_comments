{"pr_number": 1764, "pr_title": "Enable caching of bytebuddy cache.", "pr_createdAt": "2020-11-25T08:32:28Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1764", "timeline": [{"oid": "a4f7ab4334158af4061711ecd5b94e2ae53cef9d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a4f7ab4334158af4061711ecd5b94e2ae53cef9d", "message": "Enable caching of bytebuddy cache.", "committedDate": "2020-11-25T08:29:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM1ODU5NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1764#discussion_r530358594", "bodyText": "It is indeed suspicious. I would assume that better approach would be to have correctly configured inputs and outputs for this task", "author": "iNikem", "createdAt": "2020-11-25T13:04:36Z", "path": "buildSrc/src/main/java/io/opentelemetry/instrumentation/gradle/bytebuddy/ByteBuddyPluginConfigurator.java", "diffHunk": "@@ -68,6 +68,7 @@ public void configure() {\n   private Task createLanguageTask(AbstractCompile compileTask, String name) {\n     ByteBuddySimpleTask task = project.getTasks().create(name, ByteBuddySimpleTask.class);\n     task.setGroup(\"Byte Buddy\");\n+    task.getOutputs().cacheIf(unused -> true);", "originalCommit": "a4f7ab4334158af4061711ecd5b94e2ae53cef9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3MTkwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1764#discussion_r530371905", "bodyText": "Do you mean to enable caching? The task is not a CacheableTask so even with correct input / outputs configured it can't be cached without opting in with this command.\nI'm concerned about the determinism of the task but the outputs inputs seem sane from what I can tell.", "author": "anuraaga", "createdAt": "2020-11-25T13:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM1ODU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3NzQzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1764#discussion_r530377430", "bodyText": "To clarify, UP-TO-DATE seems to be working fine. What doesn't work\n\n\nAfter a clean, this task always reruns since it's not a CacheableTask. We can fix that by adding this line.\n\n\nIf the task reruns after a clean, all downstream tasks also rerun even though we would expect deterministic output meaning this wouldn't happen. That needs more investigation in #1765.\n\n\nI think this change is still worth it even if we fix the determinism issue, and maybe we can survive some risk of cache pollution to get the build sane again. Let me try rerunning the tests in this PR and see", "author": "anuraaga", "createdAt": "2020-11-25T13:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM1ODU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwMzkyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1764#discussion_r530703920", "bodyText": "Reran tests, cache worked fine-ish. Build / Java 8 3min, Java 15 25min - still something obviously strange about Java 15 but this seems to at least help us well.", "author": "anuraaga", "createdAt": "2020-11-26T00:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM1ODU5NA=="}], "type": "inlineReview"}, {"oid": "0c4a3bedd0a3e3c674a2971ac99cf27d22ada4e4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0c4a3bedd0a3e3c674a2971ac99cf27d22ada4e4", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-java-instrumentation into cache-bytebuddy-task", "committedDate": "2020-11-25T13:39:36Z", "type": "commit"}]}