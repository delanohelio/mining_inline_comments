{"pr_number": 1200, "pr_title": "Implement MDC auto-instrumentation for log4j2", "pr_createdAt": "2020-09-14T13:54:17Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzMjk5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488032995", "bodyText": "By the way, what do you think about adding some logging constant class to keep those three strings somewhere in auto-api?", "author": "mateuszrzeszutek", "createdAt": "2020-09-14T15:40:12Z", "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27Instrumentation.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.util.SortedArrayStringMap;\n+import org.apache.logging.log4j.util.StringMap;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27Instrumentation extends Instrumenter.Default {\n+  public Log4j27Instrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j2.7\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.apache.logging.log4j.core.ContextDataInjector\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return Collections.singletonMap(\n+        isMethod()\n+            .and(named(\"injectContextData\"))\n+            .and(returns(named(\"org.apache.logging.log4j.util.StringMap\"))),\n+        Log4j27Instrumentation.class.getName() + \"$InjectContextDataAdvice\");\n+  }\n+\n+  public static class InjectContextDataAdvice {\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static void onExit(\n+        @Advice.Return(typing = Typing.DYNAMIC, readOnly = false) StringMap contextData) {\n+      SpanContext currentContext = TracingContextUtils.getCurrentSpan().getContext();\n+      if (!currentContext.isValid()) {\n+        return;\n+      }\n+\n+      if (contextData.containsKey(\"traceId\")) {\n+        // Assume already instrumented event if traceId is present.\n+        return;\n+      }\n+\n+      StringMap newContextData = new SortedArrayStringMap(contextData);\n+      newContextData.putValue(\"traceId\", currentContext.getTraceId().toLowerBase16());\n+      newContextData.putValue(\"spanId\", currentContext.getSpanId().toLowerBase16());\n+      newContextData.putValue(\"traceFlags\", currentContext.getTraceFlags().toLowerBase16());", "originalCommit": "5687f2ee54a1dca8c3471f4fdf61e54a2fddef36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzNjAwOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488036008", "bodyText": "If they are used in multiple places, why not", "author": "iNikem", "createdAt": "2020-09-14T15:44:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzMjk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU2OTI0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488569245", "bodyText": "Done.", "author": "mateuszrzeszutek", "createdAt": "2020-09-15T10:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzMjk5NQ=="}], "type": "inlineReview"}, {"oid": "004c45e6c31fe6ab381b26bcd37b1626bf438d37", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/004c45e6c31fe6ab381b26bcd37b1626bf438d37", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-15T10:34:07Z", "type": "forcePushed"}, {"oid": "3146643d5348feec28bfeac3391fa5b9b88e841c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3146643d5348feec28bfeac3391fa5b9b88e841c", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-15T10:56:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NjYxNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489086615", "bodyText": "MDC is a name used by slf4j but these are more generic, how about LoggingContextConstants or LoggingTags?", "author": "anuraaga", "createdAt": "2020-09-16T00:11:19Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/log/MdcConstants.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.log;\n+\n+/** This class contains several constants used in logging libraries' MDC instrumentations. */\n+public final class MdcConstants {", "originalCommit": "3146643d5348feec28bfeac3391fa5b9b88e841c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2MTM2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489261362", "bodyText": "Good point, done.", "author": "mateuszrzeszutek", "createdAt": "2020-09-16T08:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NjYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NzQ0Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489087447", "bodyText": "Generally looking good - is there a reason to use bytecode instrumentation here instead of the SPI?", "author": "anuraaga", "createdAt": "2020-09-16T00:14:20Z", "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.SAMPLED;\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.SPAN_ID;\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.TRACE_ID;\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.util.SortedArrayStringMap;\n+import org.apache.logging.log4j.util.StringMap;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j27MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.7\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.apache.logging.log4j.core.ContextDataInjector\"));", "originalCommit": "3146643d5348feec28bfeac3391fa5b9b88e841c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4Nzg3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489087873", "bodyText": "Oops - now I remember this wasn't even SPI >< https://logging.apache.org/log4j/2.x/log4j-core/apidocs/org/apache/logging/log4j/core/impl/ContextDataInjectorFactory.html", "author": "anuraaga", "createdAt": "2020-09-16T00:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2MjExNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489262117", "bodyText": "Yeah, unfortunately it's not an SPI - but it's still a nice, single responsibility interface for context data injection.", "author": "mateuszrzeszutek", "createdAt": "2020-09-16T08:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NzQ0Nw=="}], "type": "inlineReview"}, {"oid": "e323d3c55ef9522d33c0fe3e9462a8f1bac1f626", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e323d3c55ef9522d33c0fe3e9462a8f1bac1f626", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-16T08:33:49Z", "type": "forcePushed"}, {"oid": "9d9b54d1d77cc0b7ef30e2809f8523efcec8be06", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9d9b54d1d77cc0b7ef30e2809f8523efcec8be06", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-16T08:50:58Z", "type": "forcePushed"}, {"oid": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-16T11:35:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY1NTI0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488655248", "bodyText": "This is not MDC specific", "author": "iNikem", "createdAt": "2020-09-15T13:12:56Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/log/MdcConstants.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.log;\n+\n+/** This class contains several constants used in logging libraries' MDC instrumentations. */\n+public final class MdcConstants {\n+  /** Key under which the current trace id will be injected into the context data. */\n+  public static final String TRACE_ID = \"traceId\";\n+  /** Key under which the current span id will be injected into the context data. */\n+  public static final String SPAN_ID = \"spanId\";\n+  /**\n+   * Key under which a boolean indicating whether current span is sampled will be injected into the\n+   * context data.\n+   */\n+  public static final String SAMPLED = \"sampled\";", "originalCommit": "3146643d5348feec28bfeac3391fa5b9b88e841c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3NDE5MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489374190", "bodyText": "This is too broad matcher. The goal of classLoaderMatcher is to filter out as much classloaders as possible and not to match every class in it.\nAdd hasClasssName(\"org.apache.logging.log4j.core.impl.ContextDataInjectorFactory\") or similar.", "author": "iNikem", "createdAt": "2020-09-16T11:47:26Z", "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.isStatic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.core.ContextDataInjector;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j27MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.7\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      \"io.opentelemetry.instrumentation.auto.log4j.v2_7.SpanDecoratingContextDataInjector\"\n+    };\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));", "originalCommit": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMjczMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489402730", "bodyText": "Done.", "author": "mateuszrzeszutek", "createdAt": "2020-09-16T12:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3NDE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489378705", "bodyText": "Change to org.apache.logging.log4j.core.util.ContextDataProvider for consistency?", "author": "iNikem", "createdAt": "2020-09-16T11:55:17Z", "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_13_2;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public final class Log4j2MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j2MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.13.2\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return named(\"org.apache.logging.log4j.core.impl.ThreadContextDataInjector\");", "originalCommit": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMzYwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489403606", "bodyText": "Unfortunately the instrumentation does not work if I use ContextDataProvider here: I suspect that it's because it's an interface.", "author": "mateuszrzeszutek", "createdAt": "2020-09-16T12:39:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwNDkwNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489404904", "bodyText": "Then at least add the comment", "author": "iNikem", "createdAt": "2020-09-16T12:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzMDY3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489830679", "bodyText": "Interfaces are ok.\nThe problem with using org.apache.logging.log4j.core.util.ContextDataProvider is that then helper class injection is performed during the loading (and transformation) of ContextDataProvider, which is a problem because one of the classes that we inject implements this same interface, causing the interface to be loaded while it's being transformed, which leads to duplicate class definition error after the interface is transformed and the triggering class loader tries to load it.\nIt seems this will be a common problem with injecting SPI resources, which is too bad, we'll need to be careful to pick type for the typeMatcher in these cases that we know will get loaded before SPI is triggered", "author": "trask", "createdAt": "2020-09-17T00:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA1MTA4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r490051081", "bodyText": "\ud83d\ude2e Thanks for the explanation, it makes much more sense now!\nI've replaced my comment with your explanation.", "author": "mateuszrzeszutek", "createdAt": "2020-09-17T08:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ=="}], "type": "inlineReview"}, {"oid": "02880de61038b4bbb231c69e23aa331f78068fe9", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/02880de61038b4bbb231c69e23aa331f78068fe9", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-16T12:37:13Z", "type": "forcePushed"}, {"oid": "65d866f07b31bfbd8ef47f021e6c3096e4c05e08", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/65d866f07b31bfbd8ef47f021e6c3096e4c05e08", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-16T12:45:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwODI3NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489408275", "bodyText": "\"match\", not \"instrument\" :) As you say yourself in transformers: \"Nothing to instrument\"", "author": "iNikem", "createdAt": "2020-09-16T12:46:33Z", "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -40,6 +40,8 @@ public Log4j2MdcInstrumentation() {\n \n   @Override\n   public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    // need to instrument a class, not an interface (ContextDataProvider) - otherwise helper classes", "originalCommit": "65d866f07b31bfbd8ef47f021e6c3096e4c05e08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwOTEyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489409122", "bodyText": "That's true \ud83e\udd26\nLittle things like that are the easiest to miss \ud83d\ude04", "author": "mateuszrzeszutek", "createdAt": "2020-09-16T12:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwODI3NQ=="}], "type": "inlineReview"}, {"oid": "3dc072dc6df81d9662eb64b67eafcb32aa2fffe0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3dc072dc6df81d9662eb64b67eafcb32aa2fffe0", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-16T12:48:11Z", "type": "forcePushed"}, {"oid": "695bc9d0bfa7a22d3360ca8a9a068eb810c8d12c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/695bc9d0bfa7a22d3360ca8a9a068eb810c8d12c", "message": "Implement MDC auto-instrumentation for log4j1", "committedDate": "2020-09-17T08:04:58Z", "type": "forcePushed"}, {"oid": "14f4e840de7ee0060a4d1354645c2314a2db9fcf", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/14f4e840de7ee0060a4d1354645c2314a2db9fcf", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-17T09:16:54Z", "type": "commit"}, {"oid": "9c8226af191d6ba8ae3c0fba22f7a5c51a94ee6b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9c8226af191d6ba8ae3c0fba22f7a5c51a94ee6b", "message": "Implement MDC auto-instrumentation for log4j2 2.7", "committedDate": "2020-09-17T09:18:49Z", "type": "commit"}, {"oid": "6e208f85d753fb0e103772fb0e0840593cfe26d9", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6e208f85d753fb0e103772fb0e0840593cfe26d9", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-17T09:18:49Z", "type": "commit"}, {"oid": "cb94a2ebfceb3d1012d142c7265dbacb659b145f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cb94a2ebfceb3d1012d142c7265dbacb659b145f", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-17T09:18:49Z", "type": "commit"}, {"oid": "bb3e7fc77e69ac4ccebfa78e21c2ab497eadafd2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bb3e7fc77e69ac4ccebfa78e21c2ab497eadafd2", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-17T09:18:49Z", "type": "commit"}, {"oid": "d2ce072f73c0149e1fc904e1cf1dac0a2b7c6b01", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d2ce072f73c0149e1fc904e1cf1dac0a2b7c6b01", "message": "Implement MDC auto-instrumentation for log4j1", "committedDate": "2020-09-17T09:18:49Z", "type": "commit"}, {"oid": "049850e581915d4c4fa9f3491332cd130cfc397c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/049850e581915d4c4fa9f3491332cd130cfc397c", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-17T09:20:37Z", "type": "commit"}, {"oid": "049850e581915d4c4fa9f3491332cd130cfc397c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/049850e581915d4c4fa9f3491332cd130cfc397c", "message": "Implement MDC auto-instrumentation for log4j2", "committedDate": "2020-09-17T09:20:37Z", "type": "forcePushed"}]}