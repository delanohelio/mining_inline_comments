{"pr_number": 686, "pr_title": "Move webflux context injection to the decorator", "pr_createdAt": "2020-07-13T22:33:13Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/686", "timeline": [{"oid": "c3f1238102288c1716a8f55f8ff8611afd347bbb", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c3f1238102288c1716a8f55f8ff8611afd347bbb", "message": "move webflux context injection to the decorator", "committedDate": "2020-07-13T22:32:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk4NTE5OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/686#discussion_r453985198", "bodyText": "There's a throwable != null check in DECORATE.onError(). This if statement seems redundant.", "author": "mabdinur", "createdAt": "2020-07-13T22:34:58Z", "path": "instrumentation-core/spring/spring-webflux-5.0/src/main/java/io/opentelemetry/instrumentation/springwebflux/client/WebClientTracingFilter.java", "diffHunk": "@@ -52,29 +49,21 @@ public static void addFilter(\n \n   @Override\n   public Mono<ClientResponse> filter(final ClientRequest request, final ExchangeFunction next) {\n-    final Span span =\n-        tracer.spanBuilder(DECORATE.spanNameForRequest(request)).setSpanKind(CLIENT).startSpan();\n+    final Span span = DECORATE.getOrCreateSpan(request, tracer);\n     DECORATE.afterStart(span);\n \n     try (final Scope scope = TRACER.withSpan(span)) {\n       final ClientRequest mutatedRequest =\n           ClientRequest.from(request)\n-              .headers(\n-                  httpHeaders ->\n-                      OpenTelemetry.getPropagators()\n-                          .getHttpTextFormat()\n-                          .inject(Context.current(), httpHeaders, SETTER))\n+              .headers(httpHeaders -> DECORATE.inject(Context.current(), httpHeaders))\n               .build();\n       DECORATE.onRequest(span, mutatedRequest);\n \n       return next.exchange(mutatedRequest)\n           .doOnSuccessOrError(\n               (clientResponse, throwable) -> {\n-                if (throwable != null) {\n-                  DECORATE.onError(span, throwable);\n-                } else {\n-                  DECORATE.onResponse(span, clientResponse);\n-                }\n+                DECORATE.onError(span, throwable);", "originalCommit": "c3f1238102288c1716a8f55f8ff8611afd347bbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE3MzAwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/686#discussion_r454173006", "bodyText": "I think we have some deep checks like that but would prefer code to read better, rather than be minimum LoC - I'm thinking some day such a deep null check will be gone.\nHere, it doesn't really sound right to call onError when it's not an error, so having the if check makes this code more readable than without it IMO (and if I understood him correctly, @iNikem too :) )", "author": "anuraaga", "createdAt": "2020-07-14T07:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk4NTE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyMjY1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/686#discussion_r454422653", "bodyText": "Decorators usually have null checks inside methods. New Tracers usually has them outside.\nBut in this particular case, you have to decide either call this method or that method. Calling onError always assuming/hoping that it is a no-op if throwable is null does not seem write to me.", "author": "iNikem", "createdAt": "2020-07-14T14:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk4NTE5OA=="}], "type": "inlineReview"}, {"oid": "56be6d4b80d4e056c3db77185d53dcc488fffea3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/56be6d4b80d4e056c3db77185d53dcc488fffea3", "message": "add if statement", "committedDate": "2020-07-14T22:31:03Z", "type": "commit"}]}