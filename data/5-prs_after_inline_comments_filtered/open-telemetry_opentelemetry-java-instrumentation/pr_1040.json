{"pr_number": 1040, "pr_title": "More refactoring", "pr_createdAt": "2020-08-18T01:45:08Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040", "timeline": [{"oid": "8771c92b7c37938e1be4a89d7ea181471bd510b3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8771c92b7c37938e1be4a89d7ea181471bd510b3", "message": "Move common code to a shared super class", "committedDate": "2020-08-17T22:10:19Z", "type": "commit"}, {"oid": "0a80554683171dd80f2861d9e7b98f27422bcab1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0a80554683171dd80f2861d9e7b98f27422bcab1", "message": "Move static metohds in BaseTracer to BaseTracerHelper", "committedDate": "2020-08-17T22:16:05Z", "type": "commit"}, {"oid": "5c14f2912f5ba198324510eb53fd46fd45e67924", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5c14f2912f5ba198324510eb53fd46fd45e67924", "message": "Rename decortor to tracer in PlayTracer", "committedDate": "2020-08-17T22:17:02Z", "type": "commit"}, {"oid": "874969ff602c5facccd6f92e48e734b160f3cf99", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/874969ff602c5facccd6f92e48e734b160f3cf99", "message": "Refactor startSpan(spanName) with a 2nd parameter Kind", "committedDate": "2020-08-17T22:18:05Z", "type": "commit"}, {"oid": "6b4e663d473354d77f7f8a69d0c070b102d15647", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6b4e663d473354d77f7f8a69d0c070b102d15647", "message": "Fix compilation errors", "committedDate": "2020-08-17T22:32:38Z", "type": "commit"}, {"oid": "30a94443bec6c9289bce4cb776e5d25f9a4acf3f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/30a94443bec6c9289bce4cb776e5d25f9a4acf3f", "message": "Fix a merge issue", "committedDate": "2020-08-17T22:46:19Z", "type": "commit"}, {"oid": "36f6953ede5ba3e9c3c7d9ddaeddab6817d59c3d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/36f6953ede5ba3e9c3c7d9ddaeddab6817d59c3d", "message": "Remove final from the input parameters", "committedDate": "2020-08-17T22:57:51Z", "type": "commit"}, {"oid": "9ff591ad485681e03aeaf53de06f4df843557146", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9ff591ad485681e03aeaf53de06f4df843557146", "message": "Fix test failures", "committedDate": "2020-08-18T01:03:39Z", "type": "commit"}, {"oid": "b68a429ba00b1cadedaa078ffa214f83e89c8c85", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b68a429ba00b1cadedaa078ffa214f83e89c8c85", "message": "Rename BaseTracerHelper to NetPeerHelper", "committedDate": "2020-08-18T01:13:56Z", "type": "commit"}, {"oid": "8ecae669c56028628fe369228ad2da364fe1854c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8ecae669c56028628fe369228ad2da364fe1854c", "message": "Remove final", "committedDate": "2020-08-18T01:47:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5MzkzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471893930", "bodyText": "Instead of adding more hierarchy, I think will be better to make a static util method to convert URI to String in the format that http.url semantic convention expects and call that static util method directly from the sub classes\nMaybe in class named HttpUrlUtils to match suggestion below for NetPeerUtils.", "author": "trask", "createdAt": "2020-08-18T03:35:06Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseHttpClientServerTracer.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer;\n+\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Tracer;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+\n+public abstract class BaseHttpClientServerTracer extends BaseTracer {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NDM2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471894362", "bodyText": "I think starting a span based on \"name for the class\" will only ever be called by INTERNAL spans (because span names are more well defined for other types)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public Span startSpan(Class<?> clazz, Kind kind) {\n          \n          \n            \n              public Span startSpan(Class<?> clazz) {", "author": "trask", "createdAt": "2020-08-18T03:36:44Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -49,25 +46,19 @@ public BaseTracer(Tracer tracer) {\n     this.tracer = tracer;\n   }\n \n-  public Span startSpan(Class<?> clazz) {\n+  public Span startSpan(Class<?> clazz, Kind kind) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NTA0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471895040", "bodyText": "we changed convention recently: #921\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              protected void onPeerConnection(final Span span, final CONNECTION connection) {\n          \n          \n            \n              protected void onPeerConnection(Span span, CONNECTION connection) {", "author": "trask", "createdAt": "2020-08-18T03:39:45Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/DatabaseClientTracer.java", "diffHunk": "@@ -116,8 +116,8 @@ protected void onError(Span span, Throwable throwable) {\n     }\n   }\n \n-  protected void onPeerConnection(Span span, CONNECTION connection) {\n-    onPeerConnection(span, peerAddress(connection));\n+  protected void onPeerConnection(final Span span, final CONNECTION connection) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NTM5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471895396", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } catch (final Exception e) {\n          \n          \n            \n                } catch (Exception e) {", "author": "trask", "createdAt": "2020-08-18T03:41:02Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/HttpServerTracer.java", "diffHunk": "@@ -175,45 +174,15 @@ protected void onRequest(Span span, REQUEST request) {\n     if (userAgent != null) {\n       SemanticAttributes.HTTP_USER_AGENT.set(span, userAgent);\n     }\n-    // Copy of HttpClientTracer url handling\n+\n     try {\n       URI url = url(request);\n-      if (url != null) {\n-        StringBuilder urlBuilder = new StringBuilder();\n-        if (url.getScheme() != null) {\n-          urlBuilder.append(url.getScheme());\n-          urlBuilder.append(\"://\");\n-        }\n-        if (url.getHost() != null) {\n-          urlBuilder.append(url.getHost());\n-          if (url.getPort() > 0 && url.getPort() != 80 && url.getPort() != 443) {\n-            urlBuilder.append(\":\");\n-            urlBuilder.append(url.getPort());\n-          }\n-        }\n-        String path = url.getPath();\n-        if (path.isEmpty()) {\n-          urlBuilder.append(\"/\");\n-        } else {\n-          urlBuilder.append(path);\n-        }\n-        String query = url.getQuery();\n-        if (query != null) {\n-          urlBuilder.append(\"?\").append(query);\n-        }\n-        String fragment = url.getFragment();\n-        if (fragment != null) {\n-          urlBuilder.append(\"#\").append(fragment);\n-        }\n-\n-        span.setAttribute(SemanticAttributes.HTTP_URL.key(), urlBuilder.toString());\n-\n-        if (Config.get().isHttpServerTagQueryString()) {\n-          span.setAttribute(MoreAttributes.HTTP_QUERY, url.getQuery());\n-          span.setAttribute(MoreAttributes.HTTP_FRAGMENT, url.getFragment());\n-        }\n+      tagUrl(url, span);\n+      if (Config.get().isHttpServerTagQueryString()) {\n+        span.setAttribute(MoreAttributes.HTTP_QUERY, url.getQuery());\n+        span.setAttribute(MoreAttributes.HTTP_FRAGMENT, url.getFragment());\n       }\n-    } catch (Exception e) {\n+    } catch (final Exception e) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NTg3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471895877", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static void onPeerConnection(Span span, InetSocketAddress remoteConnection) {\n          \n          \n            \n              public static void setAttributes(Span span, InetSocketAddress remoteConnection) {", "author": "trask", "createdAt": "2020-08-18T03:43:31Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/NetPeerHelper.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer;\n+\n+import io.opentelemetry.instrumentation.api.config.Config;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+\n+public class NetPeerHelper {\n+\n+  public static void onPeerConnection(Span span, InetSocketAddress remoteConnection) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NTkzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471895935", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static void onPeerConnection(Span span, InetAddress remoteAddress) {\n          \n          \n            \n              public static void setAttributes(Span span, InetAddress remoteAddress) {", "author": "trask", "createdAt": "2020-08-18T03:43:45Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/NetPeerHelper.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer;\n+\n+import io.opentelemetry.instrumentation.api.config.Config;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+\n+public class NetPeerHelper {\n+\n+  public static void onPeerConnection(Span span, InetSocketAddress remoteConnection) {\n+    if (remoteConnection != null) {\n+      InetAddress remoteAddress = remoteConnection.getAddress();\n+      if (remoteAddress != null) {\n+        onPeerConnection(span, remoteAddress);\n+      } else {\n+        // Failed DNS lookup, the host string is the name.\n+        setPeer(span, remoteConnection.getHostString(), null);\n+      }\n+      span.setAttribute(SemanticAttributes.NET_PEER_PORT.key(), remoteConnection.getPort());\n+    }\n+  }\n+\n+  public static void onPeerConnection(Span span, InetAddress remoteAddress) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NTk3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471895977", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static void setPeer(Span span, String peerName, String peerIp) {\n          \n          \n            \n              public static void setAttributes(Span span, String peerName, String peerIp) {", "author": "trask", "createdAt": "2020-08-18T03:43:54Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/NetPeerHelper.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer;\n+\n+import io.opentelemetry.instrumentation.api.config.Config;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+\n+public class NetPeerHelper {\n+\n+  public static void onPeerConnection(Span span, InetSocketAddress remoteConnection) {\n+    if (remoteConnection != null) {\n+      InetAddress remoteAddress = remoteConnection.getAddress();\n+      if (remoteAddress != null) {\n+        onPeerConnection(span, remoteAddress);\n+      } else {\n+        // Failed DNS lookup, the host string is the name.\n+        setPeer(span, remoteConnection.getHostString(), null);\n+      }\n+      span.setAttribute(SemanticAttributes.NET_PEER_PORT.key(), remoteConnection.getPort());\n+    }\n+  }\n+\n+  public static void onPeerConnection(Span span, InetAddress remoteAddress) {\n+    setPeer(span, remoteAddress.getHostName(), remoteAddress.getHostAddress());\n+  }\n+\n+  public static void setPeer(Span span, String peerName, String peerIp) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjI2MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472352260", "bodyText": "will that be confusing to use the same method name for all 3?", "author": "heyams", "createdAt": "2020-08-18T17:09:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NTk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1NjA0Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472356047", "bodyText": "I don't think so, they all set the same things, just have different inputs", "author": "trask", "createdAt": "2020-08-18T17:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NTk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5Njc2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471896763", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class NetPeerHelper {\n          \n          \n            \n            /**\n          \n          \n            \n             * Utility methods for setting net.peer.* semantic attributes.\n          \n          \n            \n             */\n          \n          \n            \n            public class NetPeerUtils {", "author": "trask", "createdAt": "2020-08-18T03:47:03Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/NetPeerHelper.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer;\n+\n+import io.opentelemetry.instrumentation.api.config.Config;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+\n+public class NetPeerHelper {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5ODU1Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471898552", "bodyText": "@anuraaga @iNikem what do you think of making getCurrentServerSpan() an instance method even though it doesn't need to be (e.g. for DI / testability since this can be used by manual instrumentation)", "author": "trask", "createdAt": "2020-08-18T03:54:29Z", "path": "instrumentation/finatra-2.9/src/main/java/io/opentelemetry/instrumentation/auto/finatra/FinatraInstrumentation.java", "diffHunk": "@@ -84,12 +86,12 @@ public static SpanWithScope nameSpan(\n         @Advice.FieldValue(\"routeInfo\") RouteInfo routeInfo,\n         @Advice.FieldValue(\"clazz\") Class clazz) {\n \n-      Span serverSpan = TRACER.getCurrentServerSpan();\n+      Span serverSpan = BaseTracer.getCurrentServerSpan();", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5ODg5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471898897", "bodyText": "same\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.INTERNAL);\n          \n          \n            \n                  Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.CLIENT);", "author": "trask", "createdAt": "2020-08-18T03:55:48Z", "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/instrumentation/auto/netty/v4_1/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -103,7 +104,7 @@ public static Scope activateScope(@Advice.Argument(0) ChannelFuture future) {\n         return null;\n       }\n       Scope parentScope = currentContextWith(parentSpan);\n-      Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\");\n+      Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.INTERNAL);", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5ODk5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471898993", "bodyText": "Can you change this to Kind.CLIENT and update tests if needed?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.INTERNAL);\n          \n          \n            \n                  Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.CLIENT);", "author": "trask", "createdAt": "2020-08-18T03:56:15Z", "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/instrumentation/auto/netty/v3_8/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -113,7 +114,7 @@ public static Scope activateScope(@Advice.Argument(0) ChannelFuture future) {\n         return null;\n       }\n       Scope parentScope = currentContextWith(continuation);\n-      Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\");\n+      Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.INTERNAL);", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5OTAzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471899033", "bodyText": "same\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Span span = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.INTERNAL);\n          \n          \n            \n                  Span span = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.CLIENT);", "author": "trask", "createdAt": "2020-08-18T03:56:26Z", "path": "instrumentation/netty/netty-4.0/src/main/java/io/opentelemetry/instrumentation/auto/netty/v4_0/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -103,7 +104,7 @@ public static Scope activateScope(@Advice.Argument(0) ChannelFuture future) {\n         return null;\n       }\n       Scope parentScope = currentContextWith(parentSpan);\n-      Span span = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\");\n+      Span span = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.INTERNAL);", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5OTE0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471899141", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static SpanWithScope onEnter(@Advice.Argument(0) final Request<?> req) {\n          \n          \n            \n              public static SpanWithScope onEnter(@Advice.Argument(0) Request<?> req) {", "author": "trask", "createdAt": "2020-08-18T03:56:50Z", "path": "instrumentation/play/play-2.4/src/main/java/io/opentelemetry/instrumentation/auto/play/v2_4/PlayAdvice.java", "diffHunk": "@@ -30,8 +32,8 @@\n \n public class PlayAdvice {\n   @Advice.OnMethodEnter(suppress = Throwable.class)\n-  public static SpanWithScope onEnter(@Advice.Argument(0) Request<?> req) {\n-    Span span = TRACER.startSpan(\"play.request\");\n+  public static SpanWithScope onEnter(@Advice.Argument(0) final Request<?> req) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5OTE3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471899172", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static SpanWithScope onEnter(@Advice.Argument(0) final Request<?> req) {\n          \n          \n            \n              public static SpanWithScope onEnter(@Advice.Argument(0) Request<?> req) {", "author": "trask", "createdAt": "2020-08-18T03:57:01Z", "path": "instrumentation/play/play-2.6/src/main/java/io/opentelemetry/instrumentation/auto/play/v2_6/PlayAdvice.java", "diffHunk": "@@ -29,8 +31,8 @@\n \n public class PlayAdvice {\n   @Advice.OnMethodEnter(suppress = Throwable.class)\n-  public static SpanWithScope onEnter(@Advice.Argument(0) Request<?> req) {\n-    Span span = DECORATE.startSpan(\"play.request\");\n+  public static SpanWithScope onEnter(@Advice.Argument(0) final Request<?> req) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5OTM1Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r471899352", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    @Advice.Argument(0) final HttpServletRequest request,\n          \n          \n            \n                    @Advice.Argument(2) final Object handler) {\n          \n          \n            \n                    @Advice.Argument(0) HttpServletRequest request,\n          \n          \n            \n                    @Advice.Argument(2) Object handler) {", "author": "trask", "createdAt": "2020-08-18T03:57:43Z", "path": "instrumentation/spring-webmvc-3.1/src/main/java/io/opentelemetry/instrumentation/auto/springwebmvc/HandlerAdapterInstrumentation.java", "diffHunk": "@@ -76,8 +77,9 @@ public HandlerAdapterInstrumentation() {\n   public static class ControllerAdvice {\n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope nameResourceAndStartSpan(\n-        @Advice.Argument(0) HttpServletRequest request, @Advice.Argument(2) Object handler) {\n-      Span serverSpan = TRACER.getCurrentServerSpan();\n+        @Advice.Argument(0) final HttpServletRequest request,\n+        @Advice.Argument(2) final Object handler) {", "originalCommit": "8ecae669c56028628fe369228ad2da364fe1854c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8c6a9d65c53b7a03051650e3aedc38e21841901", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f8c6a9d65c53b7a03051650e3aedc38e21841901", "message": "Remove kind from startSpan(Class)", "committedDate": "2020-08-18T17:05:08Z", "type": "commit"}, {"oid": "78ba5dc64049faedad99d9ab51c41543306341ee", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/78ba5dc64049faedad99d9ab51c41543306341ee", "message": "Rename NetPeerHelper to NetPeerUtils", "committedDate": "2020-08-18T17:11:47Z", "type": "commit"}, {"oid": "139fa236cd8e4247623067e852f8b3fa0357b165", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/139fa236cd8e4247623067e852f8b3fa0357b165", "message": "Move NetPeerUtils related tests to a new groovy class", "committedDate": "2020-08-18T17:21:20Z", "type": "commit"}, {"oid": "5f840b27b51df14c31dfd2473db59d5a40509f25", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5f840b27b51df14c31dfd2473db59d5a40509f25", "message": "Use Kind.CLIENT for netty channelfuturelistenerinstrumentation", "committedDate": "2020-08-18T17:22:01Z", "type": "commit"}, {"oid": "afce9ea8253c7ea01327af2e138259f7632a5cd8", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/afce9ea8253c7ea01327af2e138259f7632a5cd8", "message": "Remove final", "committedDate": "2020-08-18T17:24:34Z", "type": "commit"}, {"oid": "c9da77ae3d7c260fa2683c5b329893fc120ed413", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c9da77ae3d7c260fa2683c5b329893fc120ed413", "message": "Put extract method in HttpUrlUtils", "committedDate": "2020-08-18T17:36:31Z", "type": "commit"}, {"oid": "cf896582980df2c5aa5ee75e00921ec1dcd5e3d6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cf896582980df2c5aa5ee75e00921ec1dcd5e3d6", "message": "Move utils class to utils folder", "committedDate": "2020-08-18T17:39:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NTIwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472375203", "bodyText": "I think better to leave this in both HttpClientTracer and HttpServerTracer, since it's only specific to those two subclasses of BaseTracer", "author": "trask", "createdAt": "2020-08-18T17:48:24Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -39,6 +36,8 @@\n   public static final Context.Key<Span> CONTEXT_CLIENT_SPAN_KEY =\n       Context.key(\"opentelemetry-trace-auto-client-span-key\");\n \n+  protected static final String USER_AGENT = \"User-Agent\";", "originalCommit": "cf896582980df2c5aa5ee75e00921ec1dcd5e3d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzMDAwNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472430004", "bodyText": "this is also used by AwsSdkClientTracer.", "author": "heyams", "createdAt": "2020-08-18T19:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzOTc5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472439793", "bodyText": "AwsSdkClientTracer can access USER_AGENT in HttpClientTracer", "author": "trask", "createdAt": "2020-08-18T19:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NTIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5MzQxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472393410", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  } catch (final Exception e) {\n          \n          \n            \n                  } catch (Exception e) {", "author": "trask", "createdAt": "2020-08-18T18:20:20Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/HttpClientTracer.java", "diffHunk": "@@ -139,49 +139,20 @@ protected Span onRequest(Span span, REQUEST request) {\n         SemanticAttributes.HTTP_USER_AGENT.set(span, userAgent);\n       }\n \n-      // Copy of HttpServerDecorator url handling\n       try {\n         URI url = url(request);\n-        if (url != null) {\n-          StringBuilder urlBuilder = new StringBuilder();\n-          if (url.getScheme() != null) {\n-            urlBuilder.append(url.getScheme());\n-            urlBuilder.append(\"://\");\n-          }\n-          if (url.getHost() != null) {\n-            urlBuilder.append(url.getHost());\n-            setPeer(span, url.getHost(), null);\n-            if (url.getPort() > 0) {\n-              span.setAttribute(SemanticAttributes.NET_PEER_PORT.key(), url.getPort());\n-              if (url.getPort() != 80 && url.getPort() != 443) {\n-                urlBuilder.append(\":\");\n-                urlBuilder.append(url.getPort());\n-              }\n-            }\n-          }\n-          String path = url.getPath();\n-          if (path.isEmpty()) {\n-            urlBuilder.append(\"/\");\n-          } else {\n-            urlBuilder.append(path);\n-          }\n-          String query = url.getQuery();\n-          if (query != null) {\n-            urlBuilder.append(\"?\").append(query);\n-          }\n-          String fragment = url.getFragment();\n-          if (fragment != null) {\n-            urlBuilder.append(\"#\").append(fragment);\n-          }\n-\n-          span.setAttribute(SemanticAttributes.HTTP_URL.key(), urlBuilder.toString());\n-\n-          if (Config.get().isHttpClientTagQueryString()) {\n-            span.setAttribute(MoreAttributes.HTTP_QUERY, query);\n-            span.setAttribute(MoreAttributes.HTTP_FRAGMENT, fragment);\n+        if (url != null && url.getHost() != null) {\n+          NetPeerUtils.setAttributes(span, url.getHost(), null);\n+          if (url.getPort() > 0) {\n+            span.setAttribute(SemanticAttributes.NET_PEER_PORT.key(), url.getPort());\n           }\n         }\n-      } catch (Exception e) {\n+        HttpUrlUtils.tagUrl(url, span);\n+        if (Config.get().isHttpClientTagQueryString()) {\n+          span.setAttribute(MoreAttributes.HTTP_QUERY, url.getQuery());\n+          span.setAttribute(MoreAttributes.HTTP_FRAGMENT, url.getFragment());\n+        }\n+      } catch (final Exception e) {", "originalCommit": "da92468f5c059a32f93890d08b2d3519700bc6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5Mzk5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472393995", "bodyText": "to match NetPeerUtils:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static void tagUrl(URI url, Span span) {\n          \n          \n            \n              public static void setHttpUrlAttribute(Span span, URI url) {", "author": "trask", "createdAt": "2020-08-18T18:21:19Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/utils/HttpUrlUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer.utils;\n+\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+\n+public class HttpUrlUtils {\n+\n+  public static void tagUrl(URI url, Span span) {", "originalCommit": "da92468f5c059a32f93890d08b2d3519700bc6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxNzI2MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472417260", "bodyText": "sorry it looks like I was wrong about this, I thought these attributes would get set by HttpClientTracer, but I can see from test changes that they do not. i suggest reverting this change (and remove the unnecessary scope here, because i think that will make it more clear that this is not a normal instrumentation)", "author": "trask", "createdAt": "2020-08-18T19:05:01Z", "path": "instrumentation/http-url-connection/src/main/java/io/opentelemetry/instrumentation/auto/httpurlconnection/UrlInstrumentation.java", "diffHunk": "@@ -83,14 +83,11 @@ public static void errorSpan(\n         String protocol = url.getProtocol();\n         protocol = protocol != null ? protocol : \"url\";\n \n-        Span span = TRACER.startSpan(protocol + \".request\");\n+        Span span = TRACER.startSpan(protocol + \".request\", Kind.CLIENT);\n         try (Scope scope = currentContextWith(span)) {\n-          span.setAttribute(SemanticAttributes.HTTP_URL.key(), url.toString());\n-          span.setAttribute(\n-              SemanticAttributes.NET_PEER_PORT.key(), url.getPort() == -1 ? 80 : url.getPort());", "originalCommit": "9fb917fe539ae5ff07e7ad08423846dbcb54f3b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNDIyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472424222", "bodyText": "url and port are setting inside onRequest.  UrlInstrumentation didn't call onRequest. is that why?", "author": "heyams", "createdAt": "2020-08-18T19:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxNzI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzMjU0OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472432549", "bodyText": "Let's verify it together offline.", "author": "heyams", "createdAt": "2020-08-18T19:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxNzI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3NzQ1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472477457", "bodyText": "Reverted.", "author": "heyams", "createdAt": "2020-08-18T20:35:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxNzI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxOTc3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472419772", "bodyText": "i see we weren't verifying the span kind here in our tests, opened #1044", "author": "trask", "createdAt": "2020-08-18T19:09:50Z", "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/instrumentation/auto/netty/v3_8/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -113,7 +114,7 @@ public static Scope activateScope(@Advice.Argument(0) ChannelFuture future) {\n         return null;\n       }\n       Scope parentScope = currentContextWith(continuation);\n-      Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\");\n+      Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\", Kind.CLIENT);", "originalCommit": "9fb917fe539ae5ff07e7ad08423846dbcb54f3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "94d154ea50388968db7168a1f7d9114b3acef5cb", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/94d154ea50388968db7168a1f7d9114b3acef5cb", "message": "spotless", "committedDate": "2020-08-18T20:25:35Z", "type": "commit"}, {"oid": "b68ed5b8232665300c78972933e29dab9c6adb27", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b68ed5b8232665300c78972933e29dab9c6adb27", "message": "Feedback", "committedDate": "2020-08-18T20:26:37Z", "type": "commit"}, {"oid": "f3e1b39ff20620517beebc78429591d35c92cbaa", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f3e1b39ff20620517beebc78429591d35c92cbaa", "message": "Move user_agent constant to httpcleint/server tracers", "committedDate": "2020-08-18T20:26:44Z", "type": "commit"}, {"oid": "54ae45c8891064b52f4e334920de03ae41e8b2d3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/54ae45c8891064b52f4e334920de03ae41e8b2d3", "message": "Fix missing import", "committedDate": "2020-08-18T20:28:56Z", "type": "commit"}, {"oid": "54ae45c8891064b52f4e334920de03ae41e8b2d3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/54ae45c8891064b52f4e334920de03ae41e8b2d3", "message": "Fix missing import", "committedDate": "2020-08-18T20:28:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4NTQ1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472485450", "bodyText": "may as well keep prior order here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final boolean FAIL_ON_CONTEXT_LEAK =\n          \n          \n            \n                  Boolean.getBoolean(\"otel.internal.failOnContextLeak\");\n          \n          \n            \n            \n          \n          \n            \n              protected static final String USER_AGENT = \"User-Agent\";\n          \n          \n            \n              protected static final String USER_AGENT = \"User-Agent\";\n          \n          \n            \n            \n          \n          \n            \n              private static final boolean FAIL_ON_CONTEXT_LEAK =\n          \n          \n            \n                  Boolean.getBoolean(\"otel.internal.failOnContextLeak\");", "author": "trask", "createdAt": "2020-08-18T20:51:16Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/HttpServerTracer.java", "diffHunk": "@@ -49,11 +50,11 @@\n \n   public static final String CONTEXT_ATTRIBUTE = \"io.opentelemetry.instrumentation.context\";\n \n-  protected static final String USER_AGENT = \"User-Agent\";\n-\n   private static final boolean FAIL_ON_CONTEXT_LEAK =\n       Boolean.getBoolean(\"otel.internal.failOnContextLeak\");\n \n+  protected static final String USER_AGENT = \"User-Agent\";\n+", "originalCommit": "54ae45c8891064b52f4e334920de03ae41e8b2d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDgyNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472500825", "bodyText": "what is the benefit does it gain? I usually put protected behind private.", "author": "heyams", "createdAt": "2020-08-18T21:22:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4NTQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4NTg1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472485850", "bodyText": "to stay consistent with NetPeerUtils:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static void setHttpUrlAttribute(URI url, Span span) {\n          \n          \n            \n              public static void setHttpUrlAttribute(Span span, URI url) {", "author": "trask", "createdAt": "2020-08-18T20:51:59Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/utils/HttpUrlUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer.utils;\n+\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+\n+public class HttpUrlUtils {\n+\n+  public static void setHttpUrlAttribute(URI url, Span span) {", "originalCommit": "54ae45c8891064b52f4e334920de03ae41e8b2d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1552277b5af3ee694ac3bce7545ac4aa099fa31e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1552277b5af3ee694ac3bce7545ac4aa099fa31e", "message": "Feedback", "committedDate": "2020-08-18T21:24:52Z", "type": "commit"}, {"oid": "ac2ccea474adef633306cf0af7a5c6148fd50ed6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ac2ccea474adef633306cf0af7a5c6148fd50ed6", "message": "Merge remote-tracking branch 'upstream/master' into heya/fix-issue-912", "committedDate": "2020-08-19T00:36:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1NTYwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472755603", "bodyText": "\ud83d\udc4d", "author": "anuraaga", "createdAt": "2020-08-19T06:28:13Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -51,23 +48,17 @@ public BaseTracer(Tracer tracer) {\n \n   public Span startSpan(Class<?> clazz) {\n     String spanName = spanNameForClass(clazz);\n-    return startSpan(spanName);\n+    return startSpan(spanName, Kind.INTERNAL);\n   }\n \n-  public Span startSpan(String spanName) {\n-    return tracer.spanBuilder(spanName).startSpan();\n+  public Span startSpan(String spanName, Kind kind) {", "originalCommit": "ac2ccea474adef633306cf0af7a5c6148fd50ed6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1NjQ2MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472756461", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class HttpUrlUtils {\n          \n          \n            \n            public final class HttpUrlUtils {", "author": "anuraaga", "createdAt": "2020-08-19T06:29:29Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/utils/HttpUrlUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer.utils;\n+\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+\n+public class HttpUrlUtils {", "originalCommit": "ac2ccea474adef633306cf0af7a5c6148fd50ed6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1NjYzOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472756638", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            \n          \n          \n            \n              private HttpUrlUtils() {}\n          \n          \n            \n            }", "author": "anuraaga", "createdAt": "2020-08-19T06:29:42Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/utils/HttpUrlUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer.utils;\n+\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+\n+public class HttpUrlUtils {\n+\n+  public static void setHttpUrlAttribute(Span span, URI url) {\n+    if (url != null) {\n+      StringBuilder urlBuilder = new StringBuilder();\n+      if (url.getScheme() != null) {\n+        urlBuilder.append(url.getScheme());\n+        urlBuilder.append(\"://\");\n+      }\n+      if (url.getHost() != null) {\n+        urlBuilder.append(url.getHost());\n+        if (url.getPort() > 0 && url.getPort() != 80 && url.getPort() != 443) {\n+          urlBuilder.append(\":\");\n+          urlBuilder.append(url.getPort());\n+        }\n+      }\n+      String path = url.getPath();\n+      if (path.isEmpty()) {\n+        urlBuilder.append(\"/\");\n+      } else {\n+        urlBuilder.append(path);\n+      }\n+      String query = url.getQuery();\n+      if (query != null) {\n+        urlBuilder.append(\"?\").append(query);\n+      }\n+      String fragment = url.getFragment();\n+      if (fragment != null) {\n+        urlBuilder.append(\"#\").append(fragment);\n+      }\n+\n+      span.setAttribute(SemanticAttributes.HTTP_URL.key(), urlBuilder.toString());\n+    }\n+  }\n+}", "originalCommit": "ac2ccea474adef633306cf0af7a5c6148fd50ed6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1Njc2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472756766", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class NetPeerUtils {\n          \n          \n            \n            public final class NetPeerUtils {", "author": "anuraaga", "createdAt": "2020-08-19T06:29:54Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/utils/NetPeerUtils.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer.utils;\n+\n+import io.opentelemetry.instrumentation.api.config.Config;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+\n+public class NetPeerUtils {", "originalCommit": "ac2ccea474adef633306cf0af7a5c6148fd50ed6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1NjkxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472756917", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            \n          \n          \n            \n              private NetPeerUtils() {}\n          \n          \n            \n            }", "author": "anuraaga", "createdAt": "2020-08-19T06:30:04Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/utils/NetPeerUtils.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer.utils;\n+\n+import io.opentelemetry.instrumentation.api.config.Config;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+\n+public class NetPeerUtils {\n+\n+  public static void setAttributes(Span span, InetSocketAddress remoteConnection) {\n+    if (remoteConnection != null) {\n+      InetAddress remoteAddress = remoteConnection.getAddress();\n+      if (remoteAddress != null) {\n+        setAttributes(span, remoteAddress);\n+      } else {\n+        // Failed DNS lookup, the host string is the name.\n+        setAttributes(span, remoteConnection.getHostString(), null);\n+      }\n+      span.setAttribute(SemanticAttributes.NET_PEER_PORT.key(), remoteConnection.getPort());\n+    }\n+  }\n+\n+  public static void setAttributes(Span span, InetAddress remoteAddress) {\n+    setAttributes(span, remoteAddress.getHostName(), remoteAddress.getHostAddress());\n+  }\n+\n+  public static void setAttributes(Span span, String peerName, String peerIp) {\n+    if (peerName != null && !peerName.equals(peerIp)) {\n+      SemanticAttributes.NET_PEER_NAME.set(span, peerName);\n+    }\n+    if (peerIp != null) {\n+      SemanticAttributes.NET_PEER_IP.set(span, peerIp);\n+    }\n+    String peerService = mapToPeer(peerName);\n+    if (peerService == null) {\n+      peerService = mapToPeer(peerIp);\n+    }\n+    if (peerService != null) {\n+      SemanticAttributes.PEER_SERVICE.set(span, peerService);\n+    }\n+  }\n+\n+  private static String mapToPeer(String endpoint) {\n+    if (endpoint == null) {\n+      return null;\n+    }\n+\n+    return Config.get().getEndpointPeerServiceMapping().get(endpoint);\n+  }\n+}", "originalCommit": "ac2ccea474adef633306cf0af7a5c6148fd50ed6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1NzY3OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472757678", "bodyText": "I don't think we need Attribute in the names, it's sort of an implementation detail. We're mostly concerned with setting the URL into the Span", "author": "anuraaga", "createdAt": "2020-08-19T06:31:05Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/utils/HttpUrlUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer.utils;\n+\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+\n+public class HttpUrlUtils {\n+\n+  public static void setHttpUrlAttribute(Span span, URI url) {", "originalCommit": "ac2ccea474adef633306cf0af7a5c6148fd50ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMTI4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r473201285", "bodyText": "how about setNetPeer for NetPeerUtils to be consistent with setHttpUrl in HttpUrlUtils?", "author": "heyams", "createdAt": "2020-08-19T17:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1NzY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwNTAwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r473205007", "bodyText": "How about?\n\nHttpUrlUtils.setHttpUrl()\nNetPeerUtils.setNetPeerInfo()\n\n(the info because it sets more than one attribute)", "author": "trask", "createdAt": "2020-08-19T17:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1NzY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1ODI4NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1040#discussion_r472758284", "bodyText": "Maybe name it setPeerInfo for all the methods", "author": "anuraaga", "createdAt": "2020-08-19T06:31:49Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/utils/NetPeerUtils.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.tracer.utils;\n+\n+import io.opentelemetry.instrumentation.api.config.Config;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+\n+public class NetPeerUtils {\n+\n+  public static void setAttributes(Span span, InetSocketAddress remoteConnection) {", "originalCommit": "ac2ccea474adef633306cf0af7a5c6148fd50ed6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "203a5295aea982d14380f6c23636b5ebe8546415", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/203a5295aea982d14380f6c23636b5ebe8546415", "message": "Address feedback", "committedDate": "2020-08-19T17:29:05Z", "type": "commit"}, {"oid": "bb43c5556adcc5d925085869e5d1c52069bb2151", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bb43c5556adcc5d925085869e5d1c52069bb2151", "message": "IntelliJ uncool: Rename method failed to update caller classes", "committedDate": "2020-08-19T18:14:55Z", "type": "commit"}, {"oid": "78b47f636beda60ce508ac900c50be87d7876c05", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/78b47f636beda60ce508ac900c50be87d7876c05", "message": "Merge remote-tracking branch 'upstream/master' into heya/fix-issue-912", "committedDate": "2020-08-19T18:18:04Z", "type": "commit"}]}