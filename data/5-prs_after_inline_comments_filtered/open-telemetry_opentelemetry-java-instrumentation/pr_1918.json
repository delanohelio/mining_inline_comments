{"pr_number": 1918, "pr_title": "Muzzle should add SPI classes defined in helperResourceNames as references", "pr_createdAt": "2020-12-16T13:14:58Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1918", "timeline": [{"oid": "87dff7234f4eba4ba1c1a656fa487aa8fcb06a71", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/87dff7234f4eba4ba1c1a656fa487aa8fcb06a71", "message": "Muzzle should add SPI classes defined in helperResourceNames as references", "committedDate": "2020-12-16T13:10:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM0OTQ3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1918#discussion_r544349477", "bodyText": "Thanks a lot for the change!!! Just checking, will muzzle task fail if this class isn't included now?", "author": "anuraaga", "createdAt": "2020-12-16T14:38:41Z", "path": "instrumentation/aws-sdk/aws-sdk-2.2/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/awssdk/v2_2/AwsSdkInstrumentationModule.java", "diffHunk": "@@ -22,17 +22,7 @@ public AwsSdkInstrumentationModule() {\n \n   @Override\n   public String[] additionalHelperClassNames() {\n-    return new String[] {\n-      \"io.opentelemetry.javaagent.instrumentation.awssdk.v2_2.TracingExecutionInterceptor\",\n-      \"io.opentelemetry.instrumentation.awssdk.v2_2.AwsSdk\",\n-      \"io.opentelemetry.instrumentation.awssdk.v2_2.AwsSdkHttpClientTracer\",\n-      \"io.opentelemetry.instrumentation.awssdk.v2_2.AwsSdkInjectAdapter\",\n-      \"io.opentelemetry.instrumentation.awssdk.v2_2.RequestType\",\n-      \"io.opentelemetry.instrumentation.awssdk.v2_2.SdkRequestDecorator\",\n-      \"io.opentelemetry.instrumentation.awssdk.v2_2.DbRequestDecorator\",\n-      \"io.opentelemetry.instrumentation.awssdk.v2_2.TracingExecutionInterceptor\",\n-      \"io.opentelemetry.extension.trace.propagation.AwsXRayPropagator\"\n-    };\n+    return new String[] {\"io.opentelemetry.extension.trace.propagation.AwsXRayPropagator\"};", "originalCommit": "87dff7234f4eba4ba1c1a656fa487aa8fcb06a71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MzYwNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1918#discussion_r544353604", "bodyText": "Yes, it will:\nFAILED MUZZLE VALIDATION: io.opentelemetry.javaagent.instrumentation.awssdk.v2_2.AwsSdkInstrumentationModule mismatches:\n-- io.opentelemetry.instrumentation.awssdk.v2_2.AwsSdkHttpClientTracer:39 Missing class io.opentelemetry.extension.trace.propagation.AwsXRayPropagator", "author": "mateuszrzeszutek", "createdAt": "2020-12-16T14:43:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM0OTQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MDcwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1918#discussion_r544350705", "bodyText": "Is it possible to use Files.lines or Files.readAllLines?", "author": "anuraaga", "createdAt": "2020-12-16T14:40:12Z", "path": "javaagent-tooling/src/main/java/io/opentelemetry/javaagent/tooling/muzzle/collector/ReferenceCollector.java", "diffHunk": "@@ -7,54 +7,103 @@\n \n import static com.google.common.base.Preconditions.checkNotNull;\n import static io.opentelemetry.javaagent.tooling.muzzle.InstrumentationClassPredicate.isInstrumentationClass;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Collections.singleton;\n \n+import com.google.common.base.Strings;\n import com.google.common.graph.Graph;\n import com.google.common.graph.GraphBuilder;\n import com.google.common.graph.Graphs;\n import com.google.common.graph.MutableGraph;\n import io.opentelemetry.javaagent.tooling.Utils;\n import io.opentelemetry.javaagent.tooling.muzzle.Reference;\n+import java.io.BufferedReader;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.io.InputStreamReader;\n import java.net.URLConnection;\n import java.util.ArrayDeque;\n import java.util.ArrayList;\n+import java.util.Collection;\n import java.util.HashSet;\n import java.util.LinkedHashMap;\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n import java.util.Queue;\n import java.util.Set;\n+import java.util.regex.Pattern;\n import net.bytebuddy.jar.asm.ClassReader;\n \n /**\n  * {@link LinkedHashMap} is used for reference map to guarantee a deterministic order of iteration,\n  * so that bytecode generated based on it would also be deterministic.\n+ *\n+ * <p>This class is only called at compile time by the {@link MuzzleCodeGenerationPlugin} ByteBuddy\n+ * plugin.\n  */\n public class ReferenceCollector {\n   private final Map<String, Reference> references = new LinkedHashMap<>();\n   private final MutableGraph<String> helperSuperClassGraph = GraphBuilder.directed().build();\n   private final Set<String> visitedClasses = new HashSet<>();\n \n+  /**\n+   * If passed {@code resource} path points to an SPI file (either Java {@link\n+   * java.util.ServiceLoader} or AWS SDK {@code ExecutionInterceptor}) reads the file and adds every\n+   * implementation as a reference, traversing the graph of classes until a non-instrumentation\n+   * (external) class is encountered.\n+   *\n+   * @param resource path to the resource file, same as in {@link ClassLoader#getResource(String)}\n+   * @see io.opentelemetry.javaagent.tooling.muzzle.InstrumentationClassPredicate\n+   */\n+  public void collectReferencesFromResource(String resource) {\n+    if (!isSpiFile(resource)) {\n+      return;\n+    }\n+\n+    List<String> spiImplementations = new ArrayList<>();\n+    try (InputStream stream = getResourceStream(resource)) {", "originalCommit": "87dff7234f4eba4ba1c1a656fa487aa8fcb06a71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1NDk1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1918#discussion_r544354957", "bodyText": "I wanted to use one of those but they all accept Path - and we pretty much have to use InputStream here because of connection.setUseCaches(false)", "author": "mateuszrzeszutek", "createdAt": "2020-12-16T14:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MDcwNQ=="}], "type": "inlineReview"}]}