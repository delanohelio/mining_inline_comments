{"pr_number": 1850, "pr_title": "Instrument spring batch chunk", "pr_createdAt": "2020-12-08T12:03:14Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1850", "timeline": [{"oid": "69406b8b9c2913d29281db5677f945c3d8dae6b4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/69406b8b9c2913d29281db5677f945c3d8dae6b4", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-08T12:58:44Z", "type": "forcePushed"}, {"oid": "3465e336363b0ae06c92601c450fffd6b789debf", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3465e336363b0ae06c92601c450fffd6b789debf", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-08T14:44:42Z", "type": "forcePushed"}, {"oid": "7f84685dd55a2b9421f730f9df77ed8445257ae4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7f84685dd55a2b9421f730f9df77ed8445257ae4", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-09T11:11:38Z", "type": "forcePushed"}, {"oid": "a411a75e877485c842604c58b9fc4b60946eea52", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a411a75e877485c842604c58b9fc4b60946eea52", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-14T13:06:58Z", "type": "forcePushed"}, {"oid": "45c007fee65f52840d561101bf50539cd7983480", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/45c007fee65f52840d561101bf50539cd7983480", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-14T15:29:57Z", "type": "forcePushed"}, {"oid": "01125dea7d1f48e57a5ee74494e85a3ef0156ecd", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/01125dea7d1f48e57a5ee74494e85a3ef0156ecd", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-15T12:10:29Z", "type": "forcePushed"}, {"oid": "a5cdb1aac2496cf09011d52fb7d56f60e3c8863d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a5cdb1aac2496cf09011d52fb7d56f60e3c8863d", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-15T13:18:21Z", "type": "forcePushed"}, {"oid": "114f7120e11105e8e7dab92a24a5650dd9aeb8c9", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/114f7120e11105e8e7dab92a24a5650dd9aeb8c9", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-15T14:55:24Z", "type": "forcePushed"}, {"oid": "03e77d1eebcdcff8917299cf24169594a6bba74d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/03e77d1eebcdcff8917299cf24169594a6bba74d", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-15T17:08:54Z", "type": "forcePushed"}, {"oid": "ba12145a91c148776b07eb2b665f6251dbafb947", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ba12145a91c148776b07eb2b665f6251dbafb947", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-16T11:31:31Z", "type": "forcePushed"}, {"oid": "5585abec835762a37aef47333e9c092f80283cc8", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5585abec835762a37aef47333e9c092f80283cc8", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-16T11:33:30Z", "type": "forcePushed"}, {"oid": "37750308ddab684aba5c6fcaf49a3d84a215edf6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/37750308ddab684aba5c6fcaf49a3d84a215edf6", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-17T09:57:19Z", "type": "commit"}, {"oid": "37750308ddab684aba5c6fcaf49a3d84a215edf6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/37750308ddab684aba5c6fcaf49a3d84a215edf6", "message": "Instrument spring-batch: chunk", "committedDate": "2020-12-17T09:57:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU2NzA4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1850#discussion_r545567081", "bodyText": "What's the use case for this flag by the way? It seems like it'd be nice if we can decide one or the other is better and stick with it", "author": "anuraaga", "createdAt": "2020-12-18T04:34:05Z", "path": "instrumentation/spring/spring-batch-3.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/batch/chunk/ChunkExecutionTracer.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.spring.batch.chunk;\n+\n+import static io.opentelemetry.api.trace.Span.Kind.INTERNAL;\n+import static io.opentelemetry.javaagent.instrumentation.spring.batch.SpringBatchInstrumentationConfig.shouldCreateRootSpanForChunk;\n+\n+import io.opentelemetry.api.trace.Span;\n+import io.opentelemetry.api.trace.SpanBuilder;\n+import io.opentelemetry.api.trace.SpanContext;\n+import io.opentelemetry.context.Context;\n+import io.opentelemetry.instrumentation.api.tracer.BaseTracer;\n+import org.springframework.batch.core.scope.context.ChunkContext;\n+\n+public class ChunkExecutionTracer extends BaseTracer {\n+  private static final ChunkExecutionTracer TRACER = new ChunkExecutionTracer();\n+\n+  public static ChunkExecutionTracer tracer() {\n+    return TRACER;\n+  }\n+\n+  public Context startSpan(ChunkContext chunkContext) {\n+    String jobName = chunkContext.getStepContext().getJobName();\n+    String stepName = chunkContext.getStepContext().getStepName();\n+    SpanBuilder spanBuilder =\n+        tracer.spanBuilder(\"BatchJob \" + jobName + \".\" + stepName + \".Chunk\").setSpanKind(INTERNAL);\n+    if (shouldCreateRootSpanForChunk()) {", "originalCommit": "37750308ddab684aba5c6fcaf49a3d84a215edf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTcyOTA1NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1850#discussion_r545729055", "bodyText": "That one's controversial, I know - Spring Batch jobs can get veeery large, like millions of spans in a trace. We are still in the middle of experimenting with how to treat traces like these, one option was to split them into many smaller traces. Personally, I don't think that having a separate trace for each chunk makes sense from a semantic perspective (since it's still a single job execution), but I added this here just to be able to experiment with this. It's highly probable that it'll get removed in one of the future PRs.", "author": "mateuszrzeszutek", "createdAt": "2020-12-18T10:06:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU2NzA4MQ=="}], "type": "inlineReview"}]}