{"pr_number": 1107, "pr_title": "Merge changes from dd-trace-java 0.58.0, 0.59.0, 0.60.0 (Part 1)", "pr_createdAt": "2020-08-26T19:41:22Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1107", "timeline": [{"oid": "6dec7a7eaa9694da0b2e371238ca5f165e6f4214", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6dec7a7eaa9694da0b2e371238ca5f165e6f4214", "message": "allow context propagation for kafka tombstones (DataDog/dd-trace-java#1754)", "committedDate": "2020-08-26T19:50:49Z", "type": "forcePushed"}, {"oid": "9c6341ff21026d64572b38201fffd6c2e29020ce", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9c6341ff21026d64572b38201fffd6c2e29020ce", "message": "allow context propagation for kafka tombstones (DataDog/dd-trace-java#1754)", "committedDate": "2020-08-27T04:09:05Z", "type": "forcePushed"}, {"oid": "4ec4e36a1248c7c7eefe67687e5ab8f1436af9ab", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4ec4e36a1248c7c7eefe67687e5ab8f1436af9ab", "message": "allow context propagation for kafka tombstones (DataDog/dd-trace-java#1754)", "committedDate": "2020-08-27T04:16:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODEyNjM1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1107#discussion_r478126353", "bodyText": "Can we confirm this caveat? Should we file an issue?", "author": "anuraaga", "createdAt": "2020-08-27T05:09:37Z", "path": "instrumentation/akka-context-propagation-2.5/src/main/java/io/opentelemetry/instrumentation/auto/akkaconcurrent/AkkaForkJoinPoolInstrumentation.java", "diffHunk": "@@ -28,27 +28,33 @@\n import io.opentelemetry.instrumentation.auto.api.InstrumentationContext;\n import io.opentelemetry.instrumentation.auto.api.concurrent.ExecutorInstrumentationUtils;\n import io.opentelemetry.instrumentation.auto.api.concurrent.State;\n-import io.opentelemetry.instrumentation.auto.javaconcurrent.AbstractExecutorInstrumentation;\n import io.opentelemetry.javaagent.tooling.Instrumenter;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.concurrent.Executor;\n import net.bytebuddy.asm.Advice;\n import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n import net.bytebuddy.matcher.ElementMatcher;\n \n @AutoService(Instrumenter.class)\n-public final class AkkaExecutorInstrumentation extends AbstractExecutorInstrumentation {\n+public final class AkkaForkJoinPoolInstrumentation extends Instrumenter.Default {\n \n-  public AkkaExecutorInstrumentation() {\n-    super(AbstractExecutorInstrumentation.EXEC_NAME + \".akka_fork_join\");\n+  public AkkaForkJoinPoolInstrumentation() {\n+    super(\"akka_context_propagation\");\n   }\n \n   @Override\n   protected boolean defaultEnabled() {\n     return false;\n   }\n \n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    // This might need to be an extendsClass matcher...", "originalCommit": "4ec4e36a1248c7c7eefe67687e5ab8f1436af9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODEyOTg3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1107#discussion_r478129870", "bodyText": "Just checking you saw my response #1089 (comment)", "author": "trask", "createdAt": "2020-08-27T05:15:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODEyNjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODEzOTUwOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1107#discussion_r478139508", "bodyText": "@trask You have removed this check in another PR, haven't you?", "author": "iNikem", "createdAt": "2020-08-27T05:30:27Z", "path": "instrumentation/guava-10.0/src/main/java/io/opentelemetry/instrumentation/auto/guava/ListenableFutureInstrumentation.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.instrumentation.guava10;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import com.google.common.util.concurrent.AbstractFuture;\n+import io.grpc.Context;\n+import io.opentelemetry.instrumentation.auto.api.ContextStore;\n+import io.opentelemetry.instrumentation.auto.api.InstrumentationContext;\n+import io.opentelemetry.instrumentation.auto.api.concurrent.ExecutorInstrumentationUtils;\n+import io.opentelemetry.instrumentation.auto.api.concurrent.RunnableWrapper;\n+import io.opentelemetry.instrumentation.auto.api.concurrent.State;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Map;\n+import java.util.concurrent.Executor;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import net.bytebuddy.matcher.ElementMatchers;\n+\n+@AutoService(Instrumenter.class)\n+public class ListenableFutureInstrumentation extends Instrumenter.Default {\n+\n+  public ListenableFutureInstrumentation() {\n+    super(\"guava\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"com.google.common.util.concurrent.AbstractFuture\");\n+  }\n+\n+  @Override\n+  public Map<String, String> contextStore() {\n+    return singletonMap(Runnable.class.getName(), State.class.getName());\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        named(\"addListener\").and(ElementMatchers.takesArguments(Runnable.class, Executor.class)),\n+        ListenableFutureInstrumentation.class.getName() + \"$AddListenerAdvice\");\n+  }\n+\n+  public static class AddListenerAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static State addListenerEnter(\n+        @Advice.Argument(value = 0, readOnly = false) Runnable task,\n+        @Advice.Argument(1) final Executor executor) {\n+      final Context context = Context.current();\n+      final Runnable newTask = RunnableWrapper.wrapIfNeeded(task);\n+      // It is important to check potentially wrapped task if we can instrument task in this\n+      // executor. Some executors do not support wrapped tasks.", "originalCommit": "4ec4e36a1248c7c7eefe67687e5ab8f1436af9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcyMDEyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1107#discussion_r479720127", "bodyText": "yes, thanks, and this comment prompted #1128", "author": "trask", "createdAt": "2020-08-30T04:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODEzOTUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODE0MzMxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1107#discussion_r478143310", "bodyText": "This certainly needs javadoc", "author": "iNikem", "createdAt": "2020-08-27T05:36:49Z", "path": "instrumentation/spring/spring-webflux-5.0/spring-webflux-5.0-library/src/main/java/io/opentelemetry/instrumentation/spring/webflux/client/SpringWebfluxHttpClientTracer.java", "diffHunk": "@@ -76,4 +87,13 @@ protected String getInstrumentationName() {\n   public Tracer getTracer() {\n     return tracer;\n   }\n+\n+  private static MethodHandle findRawStatusCode() {", "originalCommit": "4ec4e36a1248c7c7eefe67687e5ab8f1436af9ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7935668043648da648079a680e06145610b4a5ca", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7935668043648da648079a680e06145610b4a5ca", "message": "allow context propagation for kafka tombstones (DataDog/dd-trace-java#1754)", "committedDate": "2020-08-27T18:36:40Z", "type": "forcePushed"}, {"oid": "b78b2db7be966cac1edcf5bbb5646657d28a5a3c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b78b2db7be966cac1edcf5bbb5646657d28a5a3c", "message": "allow context propagation for kafka tombstones (DataDog/dd-trace-java#1754)", "committedDate": "2020-08-30T04:27:01Z", "type": "forcePushed"}, {"oid": "7f9f61cc2dea4bbd7a251edaae19893751b0e3f1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7f9f61cc2dea4bbd7a251edaae19893751b0e3f1", "message": "Revert \"Config class should be loaded on the bootstrap for instrumentation tests\"\n\nThis reverts commit 4b6af486e62884a9af64a2446a6707152546a966.", "committedDate": "2020-08-30T05:28:41Z", "type": "forcePushed"}, {"oid": "e6be98f0e0dc695e1863d7fdc3cc8ba37cd8d2c7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e6be98f0e0dc695e1863d7fdc3cc8ba37cd8d2c7", "message": "Add classloader matcher to validate scala/akka presence (DataDog/dd-trace-java#1669)", "committedDate": "2020-09-01T17:24:52Z", "type": "commit"}, {"oid": "ea619fb16b4bfd5acadcca93eec8c06a19c62818", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ea619fb16b4bfd5acadcca93eec8c06a19c62818", "message": "allow context propagation for kafka tombstones (DataDog/dd-trace-java#1754)", "committedDate": "2020-09-01T17:24:54Z", "type": "forcePushed"}, {"oid": "d7d46b2ef9e66b94c9f46837e8961acef37390d3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d7d46b2ef9e66b94c9f46837e8961acef37390d3", "message": "Add instrumentation for Guava ListenableFutures context propagation (DataDog/dd-trace-java#1665)", "committedDate": "2020-09-01T17:31:23Z", "type": "commit"}, {"oid": "9e20571dabad856737ddbb5bff5609b4c1716c84", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9e20571dabad856737ddbb5bff5609b4c1716c84", "message": "Separate out Akka ForkJoinPool instrumentation from java_concurrent (DataDog/dd-trace-java#1685)", "committedDate": "2020-09-01T17:31:23Z", "type": "commit"}, {"oid": "9f4c1ae578a4675e8666eacf5d04d5a04aef2790", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9f4c1ae578a4675e8666eacf5d04d5a04aef2790", "message": "Separate out Scala ForkJoinPool instrumentation from java_concurrent (DataDog/dd-trace-java#1687)", "committedDate": "2020-09-01T17:31:23Z", "type": "commit"}, {"oid": "4f7e97c0d6b7d078c06b5cfc55e41be87d921d12", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4f7e97c0d6b7d078c06b5cfc55e41be87d921d12", "message": "Fix Spring filter instrumentation edge case (DataDog/dd-trace-java#1700)", "committedDate": "2020-09-01T17:31:23Z", "type": "commit"}, {"oid": "32fb96318b0308d798cfd729b5469931b1805571", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/32fb96318b0308d798cfd729b5469931b1805571", "message": "Fix finatra tests for latest dependencies (DataDog/dd-trace-java#1706)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "e2aca0f378457278ed877d1f4b0f77fdace0d162", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e2aca0f378457278ed877d1f4b0f77fdace0d162", "message": "Add muzzle reference detection for invokedynamic calls. (DataDog/dd-trace-java#1712)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "0d4fe92296eecf6772cc2f1cbd92bb3df8ee9742", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0d4fe92296eecf6772cc2f1cbd92bb3df8ee9742", "message": "use spring-webflux-5.1+ ClientResponse.rawStatusCode when available (DataDog/dd-trace-java#1711)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "0cc35d36e535de6ebf26da6c8d2dc43b90a51cc2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0cc35d36e535de6ebf26da6c8d2dc43b90a51cc2", "message": "Move Spring Scheduling RunnableWrapper to separate class (DataDog/dd-trace-java#1717)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "f7b32e4fd54d52b7ed40b0c76a4a3b55e7365ad2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f7b32e4fd54d52b7ed40b0c76a4a3b55e7365ad2", "message": "Enable Async Propagation of trace in Kafka producer callback (DataDog/dd-trace-java#1727)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "a012143ac0cf2fd7627439e3bbca5da6efc8d180", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a012143ac0cf2fd7627439e3bbca5da6efc8d180", "message": "don't cache classloaders which can be skipped by name (DataDog/dd-trace-java#1732)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "80ee4f1d7c8ee02961895b9c2f0bbe8d3b93652d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/80ee4f1d7c8ee02961895b9c2f0bbe8d3b93652d", "message": "verify spring-scheduling supports lambdas (DataDog/dd-trace-java#1750)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "278672595b8ef04492748a7705c5e5c5486233e2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/278672595b8ef04492748a7705c5e5c5486233e2", "message": "disable hystrix tags by default, enabled by system property (DataDog/dd-trace-java#1743)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "43d53c9c0623c381b276c7be7114113182fbb956", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/43d53c9c0623c381b276c7be7114113182fbb956", "message": "allow context propagation for kafka tombstones (DataDog/dd-trace-java#1754)", "committedDate": "2020-09-01T17:31:24Z", "type": "commit"}, {"oid": "43d53c9c0623c381b276c7be7114113182fbb956", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/43d53c9c0623c381b276c7be7114113182fbb956", "message": "allow context propagation for kafka tombstones (DataDog/dd-trace-java#1754)", "committedDate": "2020-09-01T17:31:24Z", "type": "forcePushed"}]}