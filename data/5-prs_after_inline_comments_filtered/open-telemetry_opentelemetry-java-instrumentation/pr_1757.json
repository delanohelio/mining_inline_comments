{"pr_number": 1757, "pr_title": "Simplify netty-4.1 AttributeKeys", "pr_createdAt": "2020-11-24T20:37:46Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757", "timeline": [{"oid": "760283ab708654257af12c103128d9f1f7df8eaa", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/760283ab708654257af12c103128d9f1f7df8eaa", "message": "Simplify netty-4.1 AttributeKeys", "committedDate": "2020-11-24T20:34:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0ODIyMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530048223", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class.getName() + \".context\");\n          \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class, \"server-span\");", "author": "anuraaga", "createdAt": "2020-11-25T01:24:17Z", "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_1/AttributeKeys.java", "diffHunk": "@@ -8,51 +8,19 @@\n import io.netty.util.AttributeKey;\n import io.opentelemetry.api.trace.Span;\n import io.opentelemetry.context.Context;\n-import io.opentelemetry.javaagent.instrumentation.api.WeakMap;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n \n public class AttributeKeys {\n-  private static final WeakMap<ClassLoader, ConcurrentMap<String, AttributeKey<?>>> map =\n-      WeakMap.Implementation.DEFAULT.get();\n-  private static final WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>\n-      mapSupplier =\n-          new WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>() {\n-            @Override\n-            public ConcurrentMap<String, AttributeKey<?>> get(ClassLoader ignore) {\n-              return new ConcurrentHashMap<>();\n-            }\n-          };\n \n   public static final AttributeKey<Context> CONNECT_CONTEXT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \"connect.context\");\n+      AttributeKey.valueOf(AttributeKeys.class, \"connect.context\");\n \n   // this attribute key is also used by ratpack instrumentation\n   public static final AttributeKey<Context> SERVER_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".context\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".context\");", "originalCommit": "760283ab708654257af12c103128d9f1f7df8eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNjMzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530106333", "bodyText": "oops, fixed, and I like the naming suggestions", "author": "trask", "createdAt": "2020-11-25T04:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0ODIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0ODM0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530048341", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class.getName() + \".span\");\n          \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class, \"client-span\");", "author": "anuraaga", "createdAt": "2020-11-25T01:24:40Z", "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_1/AttributeKeys.java", "diffHunk": "@@ -8,51 +8,19 @@\n import io.netty.util.AttributeKey;\n import io.opentelemetry.api.trace.Span;\n import io.opentelemetry.context.Context;\n-import io.opentelemetry.javaagent.instrumentation.api.WeakMap;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n \n public class AttributeKeys {\n-  private static final WeakMap<ClassLoader, ConcurrentMap<String, AttributeKey<?>>> map =\n-      WeakMap.Implementation.DEFAULT.get();\n-  private static final WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>\n-      mapSupplier =\n-          new WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>() {\n-            @Override\n-            public ConcurrentMap<String, AttributeKey<?>> get(ClassLoader ignore) {\n-              return new ConcurrentHashMap<>();\n-            }\n-          };\n \n   public static final AttributeKey<Context> CONNECT_CONTEXT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \"connect.context\");\n+      AttributeKey.valueOf(AttributeKeys.class, \"connect.context\");\n \n   // this attribute key is also used by ratpack instrumentation\n   public static final AttributeKey<Context> SERVER_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".context\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".context\");\n \n   public static final AttributeKey<Span> CLIENT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".span\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".span\");", "originalCommit": "760283ab708654257af12c103128d9f1f7df8eaa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0ODQxOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530048419", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class.getName() + \".parent\");\n          \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class, \"client-parent-span\");", "author": "anuraaga", "createdAt": "2020-11-25T01:24:59Z", "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_1/AttributeKeys.java", "diffHunk": "@@ -8,51 +8,19 @@\n import io.netty.util.AttributeKey;\n import io.opentelemetry.api.trace.Span;\n import io.opentelemetry.context.Context;\n-import io.opentelemetry.javaagent.instrumentation.api.WeakMap;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n \n public class AttributeKeys {\n-  private static final WeakMap<ClassLoader, ConcurrentMap<String, AttributeKey<?>>> map =\n-      WeakMap.Implementation.DEFAULT.get();\n-  private static final WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>\n-      mapSupplier =\n-          new WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>() {\n-            @Override\n-            public ConcurrentMap<String, AttributeKey<?>> get(ClassLoader ignore) {\n-              return new ConcurrentHashMap<>();\n-            }\n-          };\n \n   public static final AttributeKey<Context> CONNECT_CONTEXT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \"connect.context\");\n+      AttributeKey.valueOf(AttributeKeys.class, \"connect.context\");\n \n   // this attribute key is also used by ratpack instrumentation\n   public static final AttributeKey<Context> SERVER_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".context\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".context\");\n \n   public static final AttributeKey<Span> CLIENT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".span\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".span\");\n \n   public static final AttributeKey<Context> CLIENT_PARENT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".parent\");\n-\n-  /**\n-   * Generate an attribute key or reuse the one existing in the global app map. This implementation\n-   * creates attributes only once even if the current class is loaded by several class loaders and\n-   * prevents an issue with Apache Atlas project were this class loaded by multiple class loaders,\n-   * while the Attribute class is loaded by a third class loader and used internally for the\n-   * cassandra driver.\n-   */\n-  private static <T> AttributeKey<T> attributeKey(String key) {\n-    ConcurrentMap<String, AttributeKey<?>> classLoaderMap =\n-        map.computeIfAbsent(AttributeKey.class.getClassLoader(), mapSupplier);\n-    if (classLoaderMap.containsKey(key)) {\n-      return (AttributeKey<T>) classLoaderMap.get(key);\n-    }\n-\n-    AttributeKey<T> value = AttributeKey.valueOf(key);\n-    classLoaderMap.put(key, value);\n-    return value;\n-  }\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".parent\");", "originalCommit": "760283ab708654257af12c103128d9f1f7df8eaa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2313933b37f68802a1707a4320e3b96a0d614fdb", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2313933b37f68802a1707a4320e3b96a0d614fdb", "message": "Suggestions", "committedDate": "2020-11-25T01:43:25Z", "type": "commit"}, {"oid": "48c4f0c6c401e98eb3cbdf116b1af3640295aa4c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/48c4f0c6c401e98eb3cbdf116b1af3640295aa4c", "message": "Shorten names", "committedDate": "2020-11-25T01:47:43Z", "type": "commit"}, {"oid": "a0984d4bae6aad2a78fef1da95affba83983e423", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a0984d4bae6aad2a78fef1da95affba83983e423", "message": "Make same naming changes for netty-4.0", "committedDate": "2020-11-25T01:49:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNjU5OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530206599", "bodyText": "Typo?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  attributeKey(AttributeKeys.class.getName() + \".connect0context\");\n          \n          \n            \n                  attributeKey(AttributeKeys.class.getName() + \".connect-context\");", "author": "mateuszrzeszutek", "createdAt": "2020-11-25T09:01:02Z", "path": "instrumentation/netty/netty-4.0/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_0/AttributeKeys.java", "diffHunk": "@@ -24,17 +24,18 @@\n             }\n           };\n \n-  public static final AttributeKey<Context> CONNECT_CONTEXT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".connect.context\");\n+  public static final AttributeKey<Context> CONNECT_CONTEXT =\n+      attributeKey(AttributeKeys.class.getName() + \".connect0context\");", "originalCommit": "a0984d4bae6aad2a78fef1da95affba83983e423", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "30135aef081d3d15134e8e5f50d99ab77fe6a8ca", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/30135aef081d3d15134e8e5f50d99ab77fe6a8ca", "message": "Update instrumentation/netty/netty-4.0/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_0/AttributeKeys.java\n\nCo-authored-by: Mateusz Rzeszutek <mrzeszutek@splunk.com>", "committedDate": "2020-11-25T18:10:07Z", "type": "commit"}]}