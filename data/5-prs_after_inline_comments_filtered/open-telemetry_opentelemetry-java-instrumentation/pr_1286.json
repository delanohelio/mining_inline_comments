{"pr_number": 1286, "pr_title": "Remove instrumentation (and tooling) specific properties from Config", "pr_createdAt": "2020-09-29T13:58:52Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286", "timeline": [{"oid": "b43265fc50345bf44aa2015d4d6c4aa96eaff1e5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b43265fc50345bf44aa2015d4d6c4aa96eaff1e5", "message": "Remove instrumentation (and tooling) specific properties from Config", "committedDate": "2020-09-29T14:08:04Z", "type": "forcePushed"}, {"oid": "d113247b24fc1f5f08d6b0f701cf02e028ce3a35", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d113247b24fc1f5f08d6b0f701cf02e028ce3a35", "message": "Remove instrumentation (and tooling) specific properties from Config", "committedDate": "2020-09-29T15:00:55Z", "type": "forcePushed"}, {"oid": "0f91c3c08982b3c6fbbbc8d19446f4270c8871ea", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0f91c3c08982b3c6fbbbc8d19446f4270c8871ea", "message": "Remove instrumentation (and tooling) specific properties from Config", "committedDate": "2020-09-29T15:36:54Z", "type": "forcePushed"}, {"oid": "502782cf4f7971b1ab0347c8cb38436bd4b62b3b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/502782cf4f7971b1ab0347c8cb38436bd4b62b3b", "message": "Remove instrumentation (and tooling) specific properties from Config", "committedDate": "2020-09-29T16:10:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5MjgyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497092822", "bodyText": "Is this class still needed/useful?", "author": "trask", "createdAt": "2020-09-29T22:17:19Z", "path": "javaagent-tooling/src/main/java/io/opentelemetry/javaagent/tooling/config/ConfigBuilder.java", "diffHunk": "@@ -16,53 +16,15 @@\n \n package io.opentelemetry.javaagent.tooling.config;\n \n-import static io.opentelemetry.instrumentation.api.config.Config.DEFAULT_EXPORTER;\n-import static io.opentelemetry.instrumentation.api.config.Config.DEFAULT_HYSTRIX_TAGS_ENABLED;\n-import static io.opentelemetry.instrumentation.api.config.Config.DEFAULT_INTEGRATIONS_ENABLED;\n-import static io.opentelemetry.instrumentation.api.config.Config.DEFAULT_KAFKA_CLIENT_PROPAGATION_ENABLED;\n-import static io.opentelemetry.instrumentation.api.config.Config.DEFAULT_RUNTIME_CONTEXT_FIELD_INJECTION;\n-import static io.opentelemetry.instrumentation.api.config.Config.DEFAULT_SQL_NORMALIZER_ENABLED;\n-import static io.opentelemetry.instrumentation.api.config.Config.DEFAULT_TRACE_ENABLED;\n-import static io.opentelemetry.instrumentation.api.config.Config.DEFAULT_TRACE_EXECUTORS_ALL;\n import static io.opentelemetry.instrumentation.api.config.Config.normalizePropertyName;\n \n import io.opentelemetry.instrumentation.api.config.Config;\n-import java.util.Arrays;\n-import java.util.Collections;\n import java.util.HashMap;\n-import java.util.LinkedHashMap;\n-import java.util.List;\n import java.util.Map;\n import java.util.Properties;\n-import java.util.function.Function;\n-import org.checkerframework.checker.nullness.qual.Nullable;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n \n public final class ConfigBuilder", "originalCommit": "502782cf4f7971b1ab0347c8cb38436bd4b62b3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM0MDA4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497340087", "bodyText": "I think it is: it allows us to reuse SDK ConfigBuilder's environment variable and system property mechanism, it is a single place where we can specify the property reading order.", "author": "mateuszrzeszutek", "createdAt": "2020-09-30T08:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5MjgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NzgxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497097810", "bodyText": "I'm curious the reason for this change?", "author": "trask", "createdAt": "2020-09-29T22:29:53Z", "path": "testing-common/src/main/groovy/io/opentelemetry/auto/test/AgentTestRunner.java", "diffHunk": "@@ -102,7 +102,7 @@\n   private static volatile ClassFileTransformer activeTransformer = null;\n \n   static {\n-    INSTRUMENTATION = ByteBuddyAgent.getInstrumentation();\n+    INSTRUMENTATION = ByteBuddyAgent.install();", "originalCommit": "502782cf4f7971b1ab0347c8cb38436bd4b62b3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE1MDExMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497150112", "bodyText": "oh nm, I see install() was moved here from AgentSpecification \ud83d\udc4d", "author": "trask", "createdAt": "2020-09-29T23:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NzgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEwNTA2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497105069", "bodyText": "maybe make fields private with static accessors, e.g. isEnabled(), getLocation(Context), withLocation(List<StackTraceElement[]>, Context)", "author": "trask", "createdAt": "2020-09-29T22:44:17Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/context/ContextPropagationDebug.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.context;\n+\n+import io.grpc.Context;\n+import java.util.List;\n+\n+public final class ContextPropagationDebug {\n+\n+  // locations where the context was propagated to another thread (tracking multiple steps is\n+  // helpful in akka where there is so much recursive async spawning of new work)\n+  public static final Context.Key<List<StackTraceElement[]>> THREAD_PROPAGATION_LOCATIONS =\n+      Context.key(\"thread-propagation-locations\");\n+  public static final boolean THREAD_PROPAGATION_DEBUGGER =\n+      Boolean.getBoolean(\"otel.threadPropagationDebugger\");", "originalCommit": "502782cf4f7971b1ab0347c8cb38436bd4b62b3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5NjAzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497296035", "bodyText": "Specification explicitly advices against exposing context keys.", "author": "iNikem", "createdAt": "2020-09-30T07:25:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEwNTA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM0OTAyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497349028", "bodyText": "Very good point, fixed.", "author": "mateuszrzeszutek", "createdAt": "2020-09-30T08:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEwNTA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5NDU3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497294576", "bodyText": "So default config is one without any configuration? Maybe it should use old default values in some way?", "author": "iNikem", "createdAt": "2020-09-30T07:23:15Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/config/Config.java", "diffHunk": "@@ -35,23 +35,7 @@\n   private static final Logger log = LoggerFactory.getLogger(Config.class);\n   private static final Pattern PROPERTY_NAME_REPLACEMENTS = Pattern.compile(\"[^a-zA-Z0-9.]\");\n \n-  // locations where the context was propagated to another thread (tracking multiple steps is\n-  // helpful in akka where there is so much recursive async spawning of new work)\n-  public static final Context.Key<List<StackTraceElement[]>> THREAD_PROPAGATION_LOCATIONS =\n-      Context.key(\"thread-propagation-locations\");\n-  public static final boolean THREAD_PROPAGATION_DEBUGGER =\n-      Boolean.getBoolean(\"otel.threadPropagationDebugger\");\n-\n-  public static final String DEFAULT_EXPORTER = \"otlp\";\n-  public static final boolean DEFAULT_TRACE_ENABLED = true;\n-  public static final boolean DEFAULT_INTEGRATIONS_ENABLED = true;\n-  public static final boolean DEFAULT_RUNTIME_CONTEXT_FIELD_INJECTION = true;\n-  public static final boolean DEFAULT_TRACE_EXECUTORS_ALL = false;\n-  public static final boolean DEFAULT_SQL_NORMALIZER_ENABLED = true;\n-  public static final boolean DEFAULT_KAFKA_CLIENT_PROPAGATION_ENABLED = true;\n-  public static final boolean DEFAULT_HYSTRIX_TAGS_ENABLED = false;\n-\n-  private static final Config DEFAULT = Config.newBuilder().build();\n+  private static final Config DEFAULT = Config.create(Collections.emptyMap());", "originalCommit": "502782cf4f7971b1ab0347c8cb38436bd4b62b3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM1MDM4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497350386", "bodyText": "The default values are now specified by Config callers, so there's no need to keep anything here -- which makes sense, because we wouldn't want to keep a default value for some Kafka property here.", "author": "mateuszrzeszutek", "createdAt": "2020-09-30T08:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5NDU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5NjM1Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497296356", "bodyText": "Looks like more than Utils now", "author": "iNikem", "createdAt": "2020-09-30T07:26:34Z", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/decorator/BaseDecorator.java", "diffHunk": "@@ -17,10 +17,10 @@\n package io.opentelemetry.instrumentation.api.decorator;\n \n import static io.opentelemetry.OpenTelemetry.getPropagators;\n+import static io.opentelemetry.instrumentation.api.tracer.utils.NetPeerUtils.ENDPOINT_PEER_SERVICE_MAPPING;", "originalCommit": "502782cf4f7971b1ab0347c8cb38436bd4b62b3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM1MzYwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497353606", "bodyText": "Yes - but on the other hand, once we remove all BaseDecorator extensions this constant will go back to being private.", "author": "mateuszrzeszutek", "createdAt": "2020-09-30T09:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5NjM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5ODc1Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497298752", "bodyText": "This should be cached, I think.", "author": "iNikem", "createdAt": "2020-09-30T07:30:54Z", "path": "javaagent-tooling/src/main/java/io/opentelemetry/javaagent/tooling/Instrumenter.java", "diffHunk": "@@ -237,7 +237,7 @@ protected ReferenceMatcher getInstrumentationMuzzle() {\n     }\n \n     protected boolean defaultEnabled() {\n-      return Config.get().isIntegrationsEnabled();\n+      return Config.get().getBooleanProperty(\"otel.integrations.enabled\", true);", "originalCommit": "502782cf4f7971b1ab0347c8cb38436bd4b62b3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM1NTg4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1286#discussion_r497355885", "bodyText": "It probably should - but its value is modified in the unit test heavily, so I've decided to just leave it here. This method is only called during the instrumenter initialization, so calling the Config here adds no overhead once the agent starts.", "author": "mateuszrzeszutek", "createdAt": "2020-09-30T09:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5ODc1Mg=="}], "type": "inlineReview"}, {"oid": "57d5318bbc882fdc0ab3a8a8b85e73a8cc411f24", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/57d5318bbc882fdc0ab3a8a8b85e73a8cc411f24", "message": "Remove instrumentation (and tooling) specific properties from Config", "committedDate": "2020-09-30T08:38:16Z", "type": "commit"}, {"oid": "1728207cfeb080f1ddd0ed5f89bbb3304406bff6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1728207cfeb080f1ddd0ed5f89bbb3304406bff6", "message": "Remove instrumentation (and tooling) specific properties from Config", "committedDate": "2020-09-30T09:14:12Z", "type": "commit"}, {"oid": "1728207cfeb080f1ddd0ed5f89bbb3304406bff6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1728207cfeb080f1ddd0ed5f89bbb3304406bff6", "message": "Remove instrumentation (and tooling) specific properties from Config", "committedDate": "2020-09-30T09:14:12Z", "type": "forcePushed"}, {"oid": "91675c240a18860cbd9e8dbf6841e2bb5cec9451", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/91675c240a18860cbd9e8dbf6841e2bb5cec9451", "message": "Remove instrumentation (and tooling) specific properties from Config", "committedDate": "2020-09-30T09:21:38Z", "type": "commit"}]}