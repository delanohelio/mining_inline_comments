{"pr_number": 623, "pr_title": "Add extension point for HTTP client decorators to return headers gene\u2026", "pr_createdAt": "2020-07-01T09:04:51Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623", "timeline": [{"oid": "22e80d0c83ca5845d47225cb9dfb9fefc516aef9", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/22e80d0c83ca5845d47225cb9dfb9fefc516aef9", "message": "Add extension point for HTTP client decorators to return headers generically instead of only user agent.", "committedDate": "2020-07-01T09:02:52Z", "type": "commit"}, {"oid": "5b8d26849a9be546c56b59c1df56d9419635e1fe", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5b8d26849a9be546c56b59c1df56d9419635e1fe", "message": "Use older Play API for better compatibility", "committedDate": "2020-07-02T02:14:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczMzM0NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623#discussion_r448733344", "bodyText": "since this is now arbitrary header, maybe call .toString() (with null check) instead of casting?", "author": "trask", "createdAt": "2020-07-02T03:52:55Z", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientDecorator.java", "diffHunk": "@@ -117,7 +117,12 @@ protected Integer status(final Response response) {\n   }\n \n   @Override\n-  protected String userAgent(Request request) {\n-    return (String) request.getHeaders().get(USER_AGENT);\n+  protected String requestHeader(Request request, String name) {\n+    return (String) request.getHeaders().get(name);", "originalCommit": "5b8d26849a9be546c56b59c1df56d9419635e1fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0Mzk2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623#discussion_r448743962", "bodyText": "For this one specifically, Java handles this way different than I'd expect - still learning new things :)\nUnchecked assignment: 'java.util.Map' to 'java.util.Map<java.lang.String,java.lang.String>'. Reason: 'request' has raw type, so result of getHeaders is erased\nEven though the class defines Map<String, String>, generics seem to be eliminated deeply when not using them!", "author": "anuraaga", "createdAt": "2020-07-02T04:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczMzM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczMzQ4OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623#discussion_r448733489", "bodyText": "same", "author": "trask", "createdAt": "2020-07-02T03:53:40Z", "path": "instrumentation/google-http-client-1.19/src/main/java/io/opentelemetry/auto/instrumentation/googlehttpclient/GoogleHttpClientDecorator.java", "diffHunk": "@@ -50,7 +51,16 @@ protected Integer status(final HttpResponse httpResponse) {\n   }\n \n   @Override\n-  protected String userAgent(HttpRequest httpRequest) {\n-    return httpRequest.getHeaders().getUserAgent();\n+  protected String requestHeader(HttpRequest httpRequest, String name) {\n+    return header(httpRequest.getHeaders(), name);\n+  }\n+\n+  @Override\n+  protected String responseHeader(HttpResponse httpResponse, String name) {\n+    return header(httpResponse.getHeaders(), name);\n+  }\n+\n+  private static String header(HttpHeaders headers, String name) {\n+    return (String) headers.get(name);", "originalCommit": "5b8d26849a9be546c56b59c1df56d9419635e1fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0NDQwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623#discussion_r448744407", "bodyText": "Oops missed a better method", "author": "anuraaga", "createdAt": "2020-07-02T04:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczMzQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczMzUyMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623#discussion_r448733523", "bodyText": "same", "author": "trask", "createdAt": "2020-07-02T03:53:48Z", "path": "instrumentation/jaxrs-client/jaxrs-client-1.1/src/main/java/io/opentelemetry/auto/instrumentation/jaxrsclient/v1_1/JaxRsClientV1Decorator.java", "diffHunk": "@@ -45,7 +45,12 @@ protected Integer status(final ClientResponse clientResponse) {\n   }\n \n   @Override\n-  protected String userAgent(ClientRequest clientRequest) {\n-    return (String) clientRequest.getHeaders().getFirst(USER_AGENT);\n+  protected String requestHeader(ClientRequest clientRequest, String name) {\n+    return (String) clientRequest.getHeaders().getFirst(name);", "originalCommit": "5b8d26849a9be546c56b59c1df56d9419635e1fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0NDkyMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623#discussion_r448744923", "bodyText": "Fixed (and blown away by not having to do the same to responseHeader...)", "author": "anuraaga", "createdAt": "2020-07-02T04:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczMzUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0MDg3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623#discussion_r448740872", "bodyText": "instead of extracting the response from context twice (even though cheap), do u mind trying out changing ApacheHttpAsyncClientDecorator generic type from HttpContext to HttpResponse, and extracting response from context in TraceContinuedFutureCallback when calling onResponse, e.g.\n    public void completed(final T result) {\n      HttpResponse response = getResponse(context);\n      DECORATE.onResponse(clientSpan, response);\n      ...\n    }\n\ni think this may be nicer\nalso, just noticed, then won't need the response != null conditionals above since response != null is already checked prior to calling those methods", "author": "trask", "createdAt": "2020-07-02T04:24:23Z", "path": "instrumentation/apache-httpasyncclient-4.0/src/main/java/io/opentelemetry/auto/instrumentation/apachehttpasyncclient/ApacheHttpAsyncClientDecorator.java", "diffHunk": "@@ -76,8 +77,26 @@ protected Integer status(final HttpContext context) {\n   }\n \n   @Override\n-  protected String userAgent(HttpRequest httpRequest) {\n-    final Header header = httpRequest.getFirstHeader(USER_AGENT);\n+  protected String requestHeader(HttpRequest request, String name) {\n+    return header(request, name);\n+  }\n+\n+  @Override\n+  protected String responseHeader(HttpContext context, String name) {\n+    HttpResponse response = extractResponse(context);\n+    if (response != null) {\n+      return header(response, name);\n+    }\n+    return null;\n+  }\n+\n+  private static String header(HttpMessage message, String name) {\n+    Header header = message.getFirstHeader(name);\n     return header != null ? header.getValue() : null;\n   }\n+\n+  private static HttpResponse extractResponse(HttpContext context) {\n+    Object responseObject = context.getAttribute(HttpCoreContext.HTTP_RESPONSE);\n+    return responseObject instanceof HttpResponse ? (HttpResponse) responseObject : null;\n+  }", "originalCommit": "5b8d26849a9be546c56b59c1df56d9419635e1fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0NjIyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/623#discussion_r448746229", "bodyText": "Cool, looks much nicer", "author": "anuraaga", "createdAt": "2020-07-02T04:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0MDg3Mg=="}], "type": "inlineReview"}, {"oid": "20b0e187d646af5e569a94f4d6051884d27d2cab", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/20b0e187d646af5e569a94f4d6051884d27d2cab", "message": "Cleanups", "committedDate": "2020-07-02T04:49:21Z", "type": "commit"}]}