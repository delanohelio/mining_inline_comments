{"pr_number": 774, "pr_title": "Update server span", "pr_createdAt": "2020-07-23T17:29:23Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774", "timeline": [{"oid": "41e6052b390e1e0cb8c4c702ccdc2b7b2dc6b741", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/41e6052b390e1e0cb8c4c702ccdc2b7b2dc6b741", "message": "Change name on SERVER spans", "committedDate": "2020-07-23T16:46:22Z", "type": "commit"}, {"oid": "a2ffda5cf6fe476cbb8cf9ebc9cd47bf0e9b97df", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a2ffda5cf6fe476cbb8cf9ebc9cd47bf0e9b97df", "message": "Change name on SERVER spans", "committedDate": "2020-07-23T17:29:04Z", "type": "commit"}, {"oid": "6724e0d693627f84815ded1c5d3cf95715e79c2e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6724e0d693627f84815ded1c5d3cf95715e79c2e", "message": "Fixes", "committedDate": "2020-07-23T17:50:40Z", "type": "commit"}, {"oid": "e27f90173e4bb206b8bc2883ee1edb9a23e81724", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e27f90173e4bb206b8bc2883ee1edb9a23e81724", "message": "Fixes", "committedDate": "2020-07-23T18:33:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyMTA2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774#discussion_r459621062", "bodyText": "since we only get the server span to update its name, does it make sense to scope this down to only support that use case? e.g. updateCurrentServerSpanName(String), or do you prefer this in case other use cases emerge, e.g. updating attributes(?)", "author": "trask", "createdAt": "2020-07-23T17:44:31Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseTracer.java", "diffHunk": "@@ -16,11 +16,124 @@\n \n package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n \n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Status;\n+import io.opentelemetry.trace.Tracer;\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.ExecutionException;\n \n public abstract class BaseTracer {\n+  // Keeps track of the server span for the current trace.\n+  public static final Context.Key<Span> CONTEXT_SERVER_SPAN_KEY =\n+      Context.key(\"opentelemetry-trace-server-span-key\");\n \n-  protected BaseTracer() {}\n+  protected final Tracer tracer;\n+\n+  public BaseTracer() {\n+    tracer = OpenTelemetry.getTracerProvider().get(getInstrumentationName(), getVersion());\n+  }\n+\n+  public BaseTracer(Tracer tracer) {\n+    this.tracer = tracer;\n+  }\n+\n+  public Span startSpan(Class<?> clazz) {\n+    String spanName = spanNameForClass(clazz);\n+    return startSpan(spanName);\n+  }\n+\n+  public Span startSpan(String spanName) {\n+    return tracer.spanBuilder(spanName).startSpan();\n+  }\n+\n+  public Span getCurrentSpan() {\n+    return tracer.getCurrentSpan();\n+  }\n+\n+  /** Returns valid span of type SERVER from current context or <code>null</code> if not found. */\n+  // TODO when all decorator are replaced with tracers, make this method instance\n+  public static Span getCurrentServerSpan() {", "originalCommit": "a2ffda5cf6fe476cbb8cf9ebc9cd47bf0e9b97df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0NTY5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774#discussion_r459845692", "bodyText": "I would leave it as is for now. It is nice counterpart to getCurrentSpan and I am not comfortable claiming this is the only use-case for server spans.", "author": "iNikem", "createdAt": "2020-07-24T04:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyMTA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1MDk2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774#discussion_r459650969", "bodyText": "\ud83d\udc4d", "author": "trask", "createdAt": "2020-07-23T18:37:20Z", "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/auto/instrumentation/netty/v4_1/server/HttpServerRequestTracingHandler.java", "diffHunk": "@@ -33,11 +34,11 @@ public void channelRead(final ChannelHandlerContext ctx, final Object msg) {\n     Channel channel = ctx.channel();\n \n     if (!(msg instanceof HttpRequest)) {\n-      Span serverSpan = TRACER.getServerSpan(channel);\n-      if (serverSpan == null) {\n+      Context serverContext = TRACER.getServerContext(channel);\n+      if (serverContext == null) {\n         ctx.fireChannelRead(msg);\n       } else {\n-        try (Scope ignored = currentContextWith(serverSpan)) {\n+        try (Scope ignored = withScopedContext(serverContext)) {", "originalCommit": "6724e0d693627f84815ded1c5d3cf95715e79c2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY3MDg4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774#discussion_r459670885", "bodyText": "\ud83d\udc4d", "author": "trask", "createdAt": "2020-07-23T19:14:04Z", "path": "instrumentation/spring-webflux-5.0/src/main/java/io/opentelemetry/auto/instrumentation/springwebflux/server/HandlerAdapterAdvice.java", "diffHunk": "@@ -59,12 +60,13 @@ public static SpanWithScope methodEnter(\n       spanWithScope = new SpanWithScope(span, currentContextWith(span));\n     }\n \n-    Context parentContext = exchange.getAttribute(AdviceUtils.PARENT_CONTEXT_ATTRIBUTE);\n-    PathPattern bestPattern = exchange.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n-    if (parentContext != null && bestPattern != null) {\n-      // TODO this is wrong span to update. We should update the outermost server span\n-      String spanName = bestPattern.getPatternString();\n-      TracingContextUtils.getSpan(parentContext).updateName(spanName);\n+    if (context != null) {\n+      Span serverSpan = BaseTracer.CONTEXT_SERVER_SPAN_KEY.get(context);", "originalCommit": "6724e0d693627f84815ded1c5d3cf95715e79c2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY3MjY1NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774#discussion_r459672655", "bodyText": "span is ended above in stopSpan\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // TODO sooo this adds throwable but does not end the span?", "author": "trask", "createdAt": "2020-07-23T19:17:25Z", "path": "instrumentation/spring-webmvc-3.1/src/main/java/io/opentelemetry/auto/instrumentation/springwebmvc/DispatcherServletInstrumentation.java", "diffHunk": "@@ -134,7 +133,8 @@ public static void nameResource(@Advice.Argument(3) final Exception exception) {\n       if (span.getContext().isValid() && exception != null) {\n         // We want to capture the stacktrace, but that doesn't mean it should be an error.\n         // We rely on a decorator to set the error state based on response code. (5xx -> error)\n-        DECORATE.addThrowable(span, exception);\n+        // TODO sooo this adds throwable but does not end the span?", "originalCommit": "6724e0d693627f84815ded1c5d3cf95715e79c2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4MDEzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774#discussion_r459680136", "bodyText": "would be better to set the span name directly in the Span.Builder in this case, i'd be happy with just a TODO marker here", "author": "trask", "createdAt": "2020-07-23T19:31:18Z", "path": "instrumentation/jaxrs/jaxrs-2.0/src/main/java/io/opentelemetry/auto/instrumentation/jaxrs/v2_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -18,55 +18,49 @@\n \n import static io.opentelemetry.auto.bootstrap.WeakMap.Provider.newWeakMap;\n \n-import io.opentelemetry.OpenTelemetry;\n import io.opentelemetry.auto.bootstrap.WeakMap;\n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseDecorator;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseTracer;\n import io.opentelemetry.auto.tooling.ClassHierarchyIterable;\n import io.opentelemetry.trace.Span;\n-import io.opentelemetry.trace.Tracer;\n import java.lang.annotation.Annotation;\n import java.lang.reflect.Method;\n import java.util.Map;\n import java.util.concurrent.ConcurrentHashMap;\n import javax.ws.rs.HttpMethod;\n import javax.ws.rs.Path;\n \n-public class JaxRsAnnotationsDecorator extends BaseDecorator {\n+public class JaxRsAnnotationsTracer extends BaseTracer {\n   public static final String ABORT_FILTER_CLASS =\n       \"io.opentelemetry.auto.instrumentation.jaxrs2.filter.abort.class\";\n   public static final String ABORT_HANDLED =\n       \"io.opentelemetry.auto.instrumentation.jaxrs2.filter.abort.handled\";\n-  public static final String ABORT_PARENT =\n-      \"io.opentelemetry.auto.instrumentation.jaxrs2.filter.abort.parent\";\n-  public static final String ABORT_SPAN =\n-      \"io.opentelemetry.auto.instrumentation.jaxrs2.filter.abort.span\";\n \n-  public static final JaxRsAnnotationsDecorator DECORATE = new JaxRsAnnotationsDecorator();\n-\n-  public static final Tracer TRACER =\n-      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.jaxrs-2.0\");\n+  public static final JaxRsAnnotationsTracer TRACER = new JaxRsAnnotationsTracer();\n \n   private final WeakMap<Class<?>, Map<Method, String>> spanNames = newWeakMap();\n \n-  public void onJaxRsSpan(\n-      final Span span, final Span parent, final Class target, final Method method) {\n-\n-    String spanName = getPathSpanName(target, method);\n-    updateParent(parent, spanName);\n+  public Span startSpan(final Class<?> target, final Method method) {\n+    // We create span and immediately update its name\n+    // We do that in order to reuse logic inside updateSpanNames method, which is used externally as\n+    // well.\n+    Span span = tracer.spanBuilder(\"jax-rs.request\").startSpan();\n+    updateSpanNames(span, getCurrentServerSpan(), target, method);", "originalCommit": "6724e0d693627f84815ded1c5d3cf95715e79c2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgzOTg2NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774#discussion_r459839864", "bodyText": "Have you seen my comment? :) Setting name to builder would lead to almost identical two methods in this class.", "author": "iNikem", "createdAt": "2020-07-24T03:50:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4MDEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0NjE4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/774#discussion_r459846180", "bodyText": "ah, I missed the comment. I still think better to set the span name directly on span builder instead of calling updateName right afterwards, even if it requires some duplicate code, but not a big deal", "author": "trask", "createdAt": "2020-07-24T04:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4MDEzNg=="}], "type": "inlineReview"}, {"oid": "d4cf57babd777f07abcf2dad4eb8fdebc0d5d9b5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d4cf57babd777f07abcf2dad4eb8fdebc0d5d9b5", "message": "Update instrumentation/spring-webmvc-3.1/src/main/java/io/opentelemetry/auto/instrumentation/springwebmvc/DispatcherServletInstrumentation.java\n\nCo-authored-by: Trask Stalnaker <trask.stalnaker@gmail.com>", "committedDate": "2020-07-24T04:24:23Z", "type": "commit"}]}