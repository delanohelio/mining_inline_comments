{"pr_number": 1184, "pr_title": "Implement some support for JAX-RS 2.1 additions", "pr_createdAt": "2020-09-09T12:19:45Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184", "timeline": [{"oid": "c207902636429c525d81141e64e758b8671cf187", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c207902636429c525d81141e64e758b8671cf187", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-09T12:21:08Z", "type": "forcePushed"}, {"oid": "1b3a19cb9f9b547a9791b698bc03fb3129c1c041", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1b3a19cb9f9b547a9791b698bc03fb3129c1c041", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-09T12:33:40Z", "type": "forcePushed"}, {"oid": "116d13b4efc89bcef8cebfa2246e71d54a4e87c5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/116d13b4efc89bcef8cebfa2246e71d54a4e87c5", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-09T12:41:24Z", "type": "forcePushed"}, {"oid": "32db9a852fc02bd5f893f74387835b5c6931532c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/32db9a852fc02bd5f893f74387835b5c6931532c", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T07:20:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0OTEwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486849105", "bodyText": "I don't think we consistently do so in this codebase, but FWIU handle has much better performance than whenComplete (due to a JDK bug?)\nline/armeria#1426\nCan we use handle here?", "author": "anuraaga", "createdAt": "2020-09-11T08:12:22Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-common/src/main/java/io/opentelemetry/instrumentation/auto/jaxrs/v2_0/JaxRsAnnotationsInstrumentation.java", "diffHunk": "@@ -155,15 +157,23 @@ public static void stopSpan(\n         return;\n       }\n \n+      CompletionStage<?> asyncReturnValue =\n+          returnValue instanceof CompletionStage ? (CompletionStage<?>) returnValue : null;\n+\n       if (asyncResponse != null && !asyncResponse.isSuspended()) {\n         // Clear span from the asyncResponse. Logically this should never happen. Added to be safe.\n         InstrumentationContext.get(AsyncResponse.class, Span.class).put(asyncResponse, null);\n       }\n-      if (asyncResponse == null || !asyncResponse.isSuspended()) {\n+      if (asyncReturnValue != null) {\n+        // span finished by CompletionStageFinishCallback\n+        asyncReturnValue = asyncReturnValue.whenComplete(new CompletionStageFinishCallback<>(span));", "originalCommit": "32db9a852fc02bd5f893f74387835b5c6931532c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg4NTg1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486885857", "bodyText": "Can we use handle here?\n\nOf course -- changed. Thanks!", "author": "mateuszrzeszutek", "createdAt": "2020-09-11T09:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0OTEwNQ=="}], "type": "inlineReview"}, {"oid": "4330e12dc1689e831d2168556b41f4092318cabf", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4330e12dc1689e831d2168556b41f4092318cabf", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T09:06:35Z", "type": "forcePushed"}, {"oid": "cbed7ed7f8d5b7b17aabad6c31900b4a1867687b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cbed7ed7f8d5b7b17aabad6c31900b4a1867687b", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T09:13:34Z", "type": "forcePushed"}, {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/da831c1c1d09b980e1bc52042a60f969b79c9650", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T09:20:10Z", "type": "commit"}, {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/da831c1c1d09b980e1bc52042a60f969b79c9650", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T09:20:10Z", "type": "forcePushed"}]}