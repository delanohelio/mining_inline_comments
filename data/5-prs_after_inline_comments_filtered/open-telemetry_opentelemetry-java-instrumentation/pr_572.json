{"pr_number": 572, "pr_title": "Propagate context", "pr_createdAt": "2020-06-24T11:55:22Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572", "timeline": [{"oid": "5f2813b54a0f72147e72b7c9d245246751f43e25", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5f2813b54a0f72147e72b7c9d245246751f43e25", "message": "First cut on propagating full Context instead of just Span", "committedDate": "2020-06-24T11:45:37Z", "type": "commit"}, {"oid": "6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "message": "First cut on propagating full Context instead of just Span", "committedDate": "2020-06-24T11:49:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3OTIxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445079211", "bodyText": "i think it makes sense to end the span here, at the beginning of onCompleted", "author": "trask", "createdAt": "2020-06-24T18:09:53Z", "path": "instrumentation/grizzly-client-1.9/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/client/ClientResponseAdvice.java", "diffHunk": "@@ -34,9 +35,12 @@\n   public static Scope onEnter(\n       @Advice.This final AsyncCompletionHandler<?> handler,\n       @Advice.Argument(0) final Response response) {\n+\n+    // TODO I think all this should happen on exit, not on enter.\n+    // After response was handled by user provided handler.", "originalCommit": "6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM0MDgwOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445340808", "bodyText": "My line of thought was the following: in comes a request, when a response is ready AsyncCompletionHandler will be called. I think we want to end the request processing span after that handler has completed its job. So that if it fails or takes long time, that would be recorded in the captured span. No?", "author": "iNikem", "createdAt": "2020-06-25T06:46:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3OTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTE3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445905176", "bodyText": "i think the CLIENT span timing and success are supposed to match the HTTP timing / success as closely as possible\ni don't see this called out in the spec, but there's some related discussion here: open-telemetry/opentelemetry-specification#591 (comment)", "author": "trask", "createdAt": "2020-06-26T00:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3OTIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDI0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445080243", "bodyText": "it's the same, but i think clearer to capture currentContext before startSpan\ni think naming it parentContext might help also\nalso, i realized by moving this above startSpan, i think we can save a Context.current() lookup in span builder with\n.setParent(TracingContextUtil.getSpan(parentContext))", "author": "trask", "createdAt": "2020-06-24T18:11:46Z", "path": "instrumentation/grizzly-client-1.9/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/client/ClientRequestAdvice.java", "diffHunk": "@@ -37,17 +38,18 @@\n   public static Scope onEnter(\n       @Advice.Argument(0) final Request request,\n       @Advice.Argument(1) final AsyncHandler<?> handler) {\n-    final Span parentSpan = TRACER.getCurrentSpan();\n     final Span span =\n         TRACER.spanBuilder(DECORATE.spanNameForRequest(request)).setSpanKind(CLIENT).startSpan();\n     DECORATE.afterStart(span);\n     DECORATE.onRequest(span, request);\n \n-    final Context context = withSpan(span, Context.current());\n-    OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request, SETTER);\n+    Context currentContext = Context.current();", "originalCommit": "6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4NTIxOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445085219", "bodyText": "here also, i think clearer to capture context before startSpan and name it parentContext\nand save a Context.current() lookup in span builder with\n.setParent(TracingContextUtil.getSpan(parentContext))", "author": "trask", "createdAt": "2020-06-24T18:20:42Z", "path": "instrumentation/play-ws/play-ws-1.0/src/main/java/io/opentelemetry/auto/instrumentation/playws/v1_0/PlayWSClientInstrumentation.java", "diffHunk": "@@ -46,14 +46,20 @@ public static Span methodEnter(\n \n       DECORATE.afterStart(span);\n       DECORATE.onRequest(span, request);\n-      final Context context = withSpan(span, Context.current());\n-      OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request, SETTER);\n+\n+      Context currentContext = Context.current();", "originalCommit": "6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwNzY1MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445107651", "bodyText": "i think we can save a Context.current() lookup here since we have it already now:\n.setParent(TracingContextUtil.getSpan(parentContext))", "author": "trask", "createdAt": "2020-06-24T19:01:54Z", "path": "instrumentation/spring-webflux-5.0/src/main/java8/io/opentelemetry/auto/instrumentation/springwebflux/server/DispatcherHandlerAdvice.java", "diffHunk": "@@ -32,34 +34,38 @@\n public class DispatcherHandlerAdvice {\n \n   @Advice.OnMethodEnter(suppress = Throwable.class)\n-  public static SpanWithScope methodEnter(@Advice.Argument(0) final ServerWebExchange exchange) {\n+  public static void methodEnter(\n+      @Advice.Argument(0) final ServerWebExchange exchange,\n+      @Advice.Local(\"otelScope\") Scope otelScope,\n+      @Advice.Local(\"otelContext\") Context otelContext) {\n     // Unfortunately Netty EventLoop is not instrumented well enough to attribute all work to the\n-    // right things so we have to store span in request itself. We also store parent (netty's) span\n-    // so we could update resource name.\n-    final Span parentSpan = TRACER.getCurrentSpan();\n-    if (parentSpan.getContext().isValid()) {\n-      exchange.getAttributes().put(AdviceUtils.PARENT_SPAN_ATTRIBUTE, parentSpan);\n-    }\n+    // right things so we have to store the context in request itself.\n+    // We also store parent (netty's) context so we could update resource name.\n+    Context currentContext = Context.current();\n+    exchange.getAttributes().put(AdviceUtils.PARENT_CONTEXT_ATTRIBUTE, currentContext);\n \n     final Span span = TRACER.spanBuilder(\"DispatcherHandler.handle\").startSpan();", "originalCommit": "6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwODUzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445108530", "bodyText": "i think i like naming it parentContext here", "author": "trask", "createdAt": "2020-06-24T19:03:40Z", "path": "instrumentation/spring-webflux-5.0/src/main/java8/io/opentelemetry/auto/instrumentation/springwebflux/server/DispatcherHandlerAdvice.java", "diffHunk": "@@ -32,34 +34,38 @@\n public class DispatcherHandlerAdvice {\n \n   @Advice.OnMethodEnter(suppress = Throwable.class)\n-  public static SpanWithScope methodEnter(@Advice.Argument(0) final ServerWebExchange exchange) {\n+  public static void methodEnter(\n+      @Advice.Argument(0) final ServerWebExchange exchange,\n+      @Advice.Local(\"otelScope\") Scope otelScope,\n+      @Advice.Local(\"otelContext\") Context otelContext) {\n     // Unfortunately Netty EventLoop is not instrumented well enough to attribute all work to the\n-    // right things so we have to store span in request itself. We also store parent (netty's) span\n-    // so we could update resource name.\n-    final Span parentSpan = TRACER.getCurrentSpan();\n-    if (parentSpan.getContext().isValid()) {\n-      exchange.getAttributes().put(AdviceUtils.PARENT_SPAN_ATTRIBUTE, parentSpan);\n-    }\n+    // right things so we have to store the context in request itself.\n+    // We also store parent (netty's) context so we could update resource name.\n+    Context currentContext = Context.current();", "originalCommit": "6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwOTg3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445109877", "bodyText": "\ud83d\udc4d created #575 to track this general issue", "author": "trask", "createdAt": "2020-06-24T19:06:17Z", "path": "instrumentation/spring-webflux-5.0/src/main/java8/io/opentelemetry/auto/instrumentation/springwebflux/server/HandlerAdapterAdvice.java", "diffHunk": "@@ -55,12 +58,13 @@ public static SpanWithScope methodEnter(\n       spanWithScope = new SpanWithScope(span, currentContextWith(span));\n     }\n \n-    final Span parentSpan = exchange.getAttribute(AdviceUtils.PARENT_SPAN_ATTRIBUTE);\n+    final Context parentContext = exchange.getAttribute(AdviceUtils.PARENT_CONTEXT_ATTRIBUTE);\n     final PathPattern bestPattern =\n         exchange.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n-    if (parentSpan != null && bestPattern != null) {\n+    if (parentContext != null && bestPattern != null) {\n+      // TODO this is wrong span to update. We should update the outermost server span", "originalCommit": "6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "405ecbd888a4abfb360801f623f6a880205d8a31", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/405ecbd888a4abfb360801f623f6a880205d8a31", "message": "Polish", "committedDate": "2020-06-25T06:59:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM0NTI0Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/572#discussion_r445345242", "bodyText": "invocationContext maybe - I think this is meant to be the context that invoked the asynchronous call, it's technically not necessarily the parent of the span (in practice it might always be though)", "author": "anuraaga", "createdAt": "2020-06-25T06:57:46Z", "path": "instrumentation/play-ws/play-ws-1.0/src/main/java/io/opentelemetry/auto/instrumentation/playws/v1_0/AsyncHandlerWrapper.java", "diffHunk": "@@ -30,14 +30,14 @@\n public class AsyncHandlerWrapper implements AsyncHandler {\n   private final AsyncHandler delegate;\n   private final Span span;\n-  private final Span parentSpan;\n+  private final Context parentContext;\n \n   private final Response.ResponseBuilder builder = new Response.ResponseBuilder();\n \n-  public AsyncHandlerWrapper(final AsyncHandler delegate, final Span span) {\n+  public AsyncHandlerWrapper(final AsyncHandler delegate, final Span span, Context parentContext) {\n     this.delegate = delegate;\n     this.span = span;\n-    parentSpan = TRACER.getCurrentSpan();\n+    this.parentContext = parentContext;", "originalCommit": "6b9ebff2dfc87e57766a2ece90fac97dae678a6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1b3eb372200acb4219e899a2f163f6a77e1f196", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a1b3eb372200acb4219e899a2f163f6a77e1f196", "message": "Polish", "committedDate": "2020-06-25T09:57:34Z", "type": "commit"}, {"oid": "aad7b018052869a462d43e9640146986c68a99ac", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/aad7b018052869a462d43e9640146986c68a99ac", "message": "Merge remote-tracking branch 'upstream/master' into propagate-context", "committedDate": "2020-06-25T09:57:38Z", "type": "commit"}, {"oid": "abf5bfecef7be61f8276616e9ed6270fbf86da9a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/abf5bfecef7be61f8276616e9ed6270fbf86da9a", "message": "Format", "committedDate": "2020-06-25T10:22:07Z", "type": "commit"}, {"oid": "a1e4613513c88592c1c85a329ec29e20fe32b1eb", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a1e4613513c88592c1c85a329ec29e20fe32b1eb", "message": "Merge branch 'master' into propagate-context", "committedDate": "2020-06-26T04:32:39Z", "type": "commit"}]}