{"pr_number": 1262, "pr_title": "Add Prometheus metric exporter", "pr_createdAt": "2020-09-26T16:58:59Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMTE0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r495511140", "bodyText": "Based on the link from your spec issue (https://github.com/prometheus/prometheus/wiki/Default-port-allocations), it sounds like we should update that wiki page and reserve a default value dedicated to OpenTelemetry.\nIf we aren't ready to do that yet, I'd suggest we make port a required configuration.", "author": "trask", "createdAt": "2020-09-27T00:49:12Z", "path": "javaagent-exporters/prometheus/src/main/java/io/opentelemetry/javaagent/exporters/prometheus/PrometheusMetricExporterFactory.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.javaagent.exporters.prometheus;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.exporters.prometheus.PrometheusCollector;\n+import io.opentelemetry.javaagent.spi.exporter.ExporterConfig;\n+import io.opentelemetry.javaagent.spi.exporter.MetricExporterFactory;\n+import io.opentelemetry.sdk.OpenTelemetrySdk;\n+import io.opentelemetry.sdk.metrics.MeterSdkProvider;\n+import io.opentelemetry.sdk.metrics.export.MetricExporter;\n+import io.prometheus.client.exporter.HTTPServer;\n+import java.io.IOException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@AutoService(MetricExporterFactory.class)\n+public class PrometheusMetricExporterFactory implements MetricExporterFactory {\n+  private static final Logger log = LoggerFactory.getLogger(PrometheusMetricExporterFactory.class);\n+\n+  private static final String EXPORTER_NAME = \"prometheus\";\n+  private static final String PORT_CONF_PROP_NAME = EXPORTER_NAME + \".port\";\n+  private static final String HOST_CONF_PROP_NAME = EXPORTER_NAME + \".host\";\n+  private static final int DEFAULT_PORT = 9464;", "originalCommit": "a6695ea995ffb90b80b025fd588659407a1326b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMTYwOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r495511608", "bodyText": "TracerInstaller is going to create an IntervalMetricReader based on this return value, and flush metrics to it every 60 seconds.\n[This could be why you aren't seeing metrics on your endpoint, although also the javaagent doesn't produce any metrics, so currently you need to use otel metric API manually in your app, and then the javaagent interop/bridge will capture and export those]\nOne option would be to add a MetricCollector SPI interface in javaagent-spi for pull-based metric \"exporters\", something like:\npublic interface MetricCollector {\n  // ExporterConfig is being deleted in #1254, replaced by `Properties`\n  // which will be nice here since this isn't exactly quite an \"exporter\"\n  void init(MetricProducer producer, ExporterConfig config);\n}\n\nand turn this class into a MetricCollector, and add something like findMetricCollector(exporterName) in TracerInstaller", "author": "trask", "createdAt": "2020-09-27T00:55:30Z", "path": "javaagent-exporters/prometheus/src/main/java/io/opentelemetry/javaagent/exporters/prometheus/PrometheusMetricExporterFactory.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.javaagent.exporters.prometheus;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.exporters.prometheus.PrometheusCollector;\n+import io.opentelemetry.javaagent.spi.exporter.ExporterConfig;\n+import io.opentelemetry.javaagent.spi.exporter.MetricExporterFactory;\n+import io.opentelemetry.sdk.OpenTelemetrySdk;\n+import io.opentelemetry.sdk.metrics.MeterSdkProvider;\n+import io.opentelemetry.sdk.metrics.export.MetricExporter;\n+import io.prometheus.client.exporter.HTTPServer;\n+import java.io.IOException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@AutoService(MetricExporterFactory.class)\n+public class PrometheusMetricExporterFactory implements MetricExporterFactory {\n+  private static final Logger log = LoggerFactory.getLogger(PrometheusMetricExporterFactory.class);\n+\n+  private static final String EXPORTER_NAME = \"prometheus\";\n+  private static final String PORT_CONF_PROP_NAME = EXPORTER_NAME + \".port\";\n+  private static final String HOST_CONF_PROP_NAME = EXPORTER_NAME + \".host\";\n+  private static final int DEFAULT_PORT = 9464;\n+  // The empty address equals to any address\n+  private static final String DEFAULT_HOST = \"0.0.0.0\";\n+\n+  private final MeterSdkProvider meterSdkProvider = OpenTelemetrySdk.getMeterProvider();\n+\n+  @Override\n+  public MetricExporter fromConfig(ExporterConfig config) {\n+    PrometheusCollector.newBuilder()\n+        .setMetricProducer(meterSdkProvider.getMetricProducer())\n+        .buildAndRegister();\n+    try {\n+      int port = config.getInt(PORT_CONF_PROP_NAME, DEFAULT_PORT);\n+      String host = config.getString(HOST_CONF_PROP_NAME, DEFAULT_HOST);\n+      log.info(\"Creating Prometheus exporter on host: '{}' and port: '{}'\", host, port);\n+      HTTPServer server = new HTTPServer(host, port);\n+      return new PrometheusExporter(server);", "originalCommit": "a6695ea995ffb90b80b025fd588659407a1326b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NzkzOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r495597938", "bodyText": "I have switch to this API, however I still don't get any metrics from my APP.\nAn alternative solution might be to implement adapter for MetricProducer in PrometheusMetricExporterFactory that would cache the metrics returned by the MetricExporter.", "author": "pavolloffay", "createdAt": "2020-09-27T17:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc2Njk4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r495766985", "bodyText": "There is smth weird going on, I am not able to get metrics from the app to the agent.\nIn the debugger I see the metrics being collected (OpenTelemetrySdk.getMeterProvider().getMetricProducer().collectAllMetrics()) but the exporter or collector do not get any metrcics.", "author": "pavolloffay", "createdAt": "2020-09-28T08:21:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc3MDI5OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r495770298", "bodyText": "It seems that the app is using a different instance of OpenTelemetrySdk.getMeterProvider  than the agent.", "author": "pavolloffay", "createdAt": "2020-09-28T08:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyMDMwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r495820303", "bodyText": "My issue is that the opentelemetry-api-beta does no kick so the calls to the OTel API in the app are noop. Since I have included only the API.", "author": "pavolloffay", "createdAt": "2020-09-28T09:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyOTI2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r495829269", "bodyText": "Finally, I have managed to get this working. There are two things that I have learned by hard:\n\nthe app should use only the OTel API\nI had to rebase and use OTEL 0.9.0-SNAPSHOT API in the app.", "author": "pavolloffay", "createdAt": "2020-09-28T10:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM1Nzc1Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496357752", "bodyText": "sorry about that \u2639\ufe0f\nI logged #1279 for the first item, and bumped priority for the second item #1043, though that issue will magically go away once we GA since we will support all GA OTel API versions", "author": "trask", "createdAt": "2020-09-29T03:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMTYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM1ODg2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496358867", "bodyText": "nice thing about javaagent is we don't have to close, though we do have to worry about creating non-daemon threads, can you check that? e.g. use the javaagent w/ prometheus exporter from a command-line app and make sure we don't prevent the app from exiting and the end of main\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // TODO close the server", "author": "trask", "createdAt": "2020-09-29T03:38:10Z", "path": "javaagent-exporters/prometheus/src/main/java/io/opentelemetry/javaagent/exporters/prometheus/PrometheusMetricCollector.java", "diffHunk": "@@ -39,22 +37,18 @@\n   // The empty address equals to any address\n   private static final String DEFAULT_HOST = \"0.0.0.0\";\n \n-  private final MeterSdkProvider meterSdkProvider = OpenTelemetrySdk.getMeterProvider();\n-\n   @Override\n-  public MetricExporter fromConfig(ExporterConfig config) {\n-    PrometheusCollector.newBuilder()\n-        .setMetricProducer(meterSdkProvider.getMetricProducer())\n-        .buildAndRegister();\n+  public void init(MetricProducer producer, ExporterConfig config) {\n+\n+    PrometheusCollector.newBuilder().setMetricProducer(producer).buildAndRegister();\n     try {\n       int port = config.getInt(PORT_CONF_PROP_NAME, DEFAULT_PORT);\n       String host = config.getString(HOST_CONF_PROP_NAME, DEFAULT_HOST);\n       log.info(\"Creating Prometheus exporter on host: '{}' and port: '{}'\", host, port);\n-      HTTPServer server = new HTTPServer(host, port);\n-      return new PrometheusExporter(server);\n+      // TODO close the server", "originalCommit": "f712e8c0db4e56b94a37a36df57b82059cb458d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUwNDMyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496504320", "bodyText": "Good catch, there is a daemon param on the constructor.", "author": "pavolloffay", "createdAt": "2020-09-29T08:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM1ODg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1NTY2MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496455660", "bodyText": "Why is this Collector and not Exporter?", "author": "iNikem", "createdAt": "2020-09-29T06:49:45Z", "path": "javaagent-spi/src/main/java/io/opentelemetry/javaagent/spi/exporter/MetricCollector.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.javaagent.spi.exporter;\n+\n+import io.opentelemetry.sdk.metrics.export.MetricProducer;\n+\n+/**\n+ * A {@link MetricCollector} acts as the bootstrap for metric exporters that use {@link\n+ * MetricProducer} to consume the metrics.\n+ *\n+ * <p>Implementation of {@link MetricCollector} must be registered through the Java SPI framework.\n+ */\n+public interface MetricCollector {", "originalCommit": "a1f5a25887ec0f6296d880c4faf9c89866c8927c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ2NzMwOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496467308", "bodyText": "The name was suggested by @trask. I think we can do better.\nI am more in favor of removing this interface and use #1273", "author": "pavolloffay", "createdAt": "2020-09-29T07:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1NTY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ3MTAyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496471029", "bodyText": "You mean removing all individual SPIs and having one single SPI OpenTelemetrySdkCustomizer?", "author": "iNikem", "createdAt": "2020-09-29T07:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1NTY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU2OTg5MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496569890", "bodyText": "Not really, The #1273 does not seem feasible since the static class, we could pass all the telemetry objects but that does not seem right to me.\nI have renamed the class to\npublic interface MetricProducerCustomizer {\n\n  /**\n   * Initialize the metric collector.\n   *\n   * @param producer The metric producer\n   * @param config The configuration\n   */\n  void configure(MetricProducer producer, Properties config);\n}\n\nthe `configure` method matches the `TracerCustomizer`.", "author": "pavolloffay", "createdAt": "2020-09-29T09:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1NTY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3OTcwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496879707", "bodyText": "@iNikem MetricExporter is for push-based metric exporters, there isn't a corresponding SDK interface for pull-based exporters\nthe name MetricCollector makes sense to me because they call collectAllMetrics() on the MetricProducer, as opposed to customizing the MetricProducer\nbut I'm also good with MetricProducerCustomizer\nI think the important thing that we should only support one of these two configurations:\n\nA single MetricProducerCustomizer + zero MetricExporterFactory, or\nZero MetricProducerCustomizer + any number of MetricExporterFactory (whose exporters we wrap in a single IntervalMetricReader)\n\n(but this doesn't need to be in this PR, I created #1281 to track this)", "author": "trask", "createdAt": "2020-09-29T16:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1NTY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1Njg0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496456840", "bodyText": "I think this method requires documentation to explain what is going on here. Just by reading it I don't understand what is a connection between PrometheusCollector that we built and registered and HTTPServer that we started later. How that server gets metrics?\nThe absence of javadoc on PrometheusCollector does not help it neither :)", "author": "iNikem", "createdAt": "2020-09-29T06:52:07Z", "path": "javaagent-exporters/prometheus/src/main/java/io/opentelemetry/javaagent/exporters/prometheus/PrometheusMetricCollector.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.javaagent.exporters.prometheus;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.exporters.prometheus.PrometheusCollector;\n+import io.opentelemetry.javaagent.spi.exporter.ExporterConfig;\n+import io.opentelemetry.javaagent.spi.exporter.MetricCollector;\n+import io.opentelemetry.sdk.metrics.export.MetricProducer;\n+import io.prometheus.client.exporter.HTTPServer;\n+import java.io.IOException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@AutoService(MetricCollector.class)\n+public class PrometheusMetricCollector implements MetricCollector {\n+  private static final Logger log = LoggerFactory.getLogger(PrometheusMetricCollector.class);\n+\n+  private static final String EXPORTER_NAME = \"prometheus\";\n+  private static final String PORT_CONF_PROP_NAME = EXPORTER_NAME + \".port\";\n+  private static final String HOST_CONF_PROP_NAME = EXPORTER_NAME + \".host\";\n+  private static final int DEFAULT_PORT = 9464;\n+  // The empty address equals to any address\n+  private static final String DEFAULT_HOST = \"0.0.0.0\";\n+\n+  @Override\n+  public void init(MetricProducer producer, ExporterConfig config) {", "originalCommit": "a1f5a25887ec0f6296d880c4faf9c89866c8927c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ2NzM2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496467367", "bodyText": "+1 I will add some docs.", "author": "pavolloffay", "createdAt": "2020-09-29T07:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1Njg0MA=="}], "type": "inlineReview"}, {"oid": "438cf34b2ead9407f2009ceeb02ff7ed8ed0cdf0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/438cf34b2ead9407f2009ceeb02ff7ed8ed0cdf0", "message": "Add prometheus exporter\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-09-29T08:08:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496878453", "bodyText": "Instead of this undocumented naming convention what do you think about adding a String getExporterName() method to the MetricProducerCustomizer interface?", "author": "mateuszrzeszutek", "createdAt": "2020-09-29T16:30:40Z", "path": "javaagent-tooling/src/main/java/io/opentelemetry/javaagent/tooling/TracerInstaller.java", "diffHunk": "@@ -99,6 +108,23 @@ private static MetricExporterFactory findMetricExporterFactory(String exporterNa\n     return null;\n   }\n \n+  private static MetricProducerCustomizer findMetricCollector(String exporterName) {\n+    ServiceLoader<MetricProducerCustomizer> serviceLoader =\n+        ServiceLoader.load(MetricProducerCustomizer.class, TracerInstaller.class.getClassLoader());\n+\n+    for (MetricProducerCustomizer metricProducerCustomizer : serviceLoader) {\n+      if (metricProducerCustomizer\n+          .getClass()\n+          .getSimpleName()\n+          .replace(\"_\", \"\")\n+          .toLowerCase()\n+          .startsWith(exporterName.toLowerCase())) {", "originalCommit": "16af2556fdc96397ceb92c300cdc87929bb0cab7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MTkwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496881901", "bodyText": "ya, this has come up for SpanExporterFactory and MetricExporterFactory also #1253 (comment) \ud83d\ude04\nI will create a tracking issue for this", "author": "trask", "createdAt": "2020-09-29T16:35:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MzY4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496883680", "bodyText": "#1287", "author": "trask", "createdAt": "2020-09-29T16:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzODg2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498338867", "bodyText": "I think we have two different issues here. One is how to select this or that exporter. Two, it is not obvious that the class name of MetricProducerCustomizer should start with the same string as MetricExporter. E.g. if we make MetricProducerCustomizer.getExporterName it will be confusing to me: \"why customizer of MetricProducers is connected to an exporter\"?", "author": "iNikem", "createdAt": "2020-10-01T15:35:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4ODQxOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498388418", "bodyText": "@iNikem the metrics can use the pull and push model. The p8s metric exporter uses pull model. It pulls metrics from OTEL once the metric endpoint is hit.", "author": "pavolloffay", "createdAt": "2020-10-01T16:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5ODI1OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498398259", "bodyText": "But push model is supported by our Exporters API, they don't need any new SPI, right?", "author": "iNikem", "createdAt": "2020-10-01T17:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwNjQ3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498406472", "bodyText": "@iNikem MetricExporter supports push model, but not pull model. Pull model has to use MetricProducer directly, e.g. https://github.com/open-telemetry/opentelemetry-java/blob/a08dd9fbe4a98f34aec3618475905fa55fece87e/examples/prometheus/src/main/java/io/opentelemetry/example/PrometheusExample.java#L46-L48", "author": "trask", "createdAt": "2020-10-01T17:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwODUyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498408520", "bodyText": "E.g. if we make MetricProducerCustomizer.getExporterName it will be confusing to me: \"why customizer of MetricProducers is connected to an exporter\"?\n\nThis is maybe a reason to rename MetricProducerCustomizer. The question is what to rename it to?", "author": "trask", "createdAt": "2020-10-01T17:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwOTE4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498409180", "bodyText": "Some options:\n\nMetricConsumer\nMetricCollector\nMetricEndpoint", "author": "trask", "createdAt": "2020-10-01T17:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYzNzgzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498637830", "bodyText": "Maybe we could unify these interfaces and just simply add MetricProducer to the current interface? If null is returned it would not install the exporter to the SDK.\npublic interface MetricExporterFactory {\n  MetricExporter fromConfig(MetricProducer, Properties);\n}\nOr it could return Optional", "author": "pavolloffay", "createdAt": "2020-10-02T06:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE3NzY1Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r499177656", "bodyText": "there's some benefit to having different factories for push and pull cases, since we can support multiple push factories, but only a single pull factory (and not both): #1281 (comment)", "author": "trask", "createdAt": "2020-10-03T20:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQzODk2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r501438969", "bodyText": "@pavolloffay @iNikem @anuraaga I think we just need a name for MetricProducerCustomizer and then good to merge.\nWhat do you think of:\npublic interface MetricExporterInitializer {\n  void start(MetricProducer, Properties);\n}\n\nThough maybe that's too close to MetricExporterFactory, and people might use MetricExporterInitializer accidentally when it would be better to use MetricExporterFactory (which can support multiple exporters, and can be configured using IntervalMetricReader).\nAnother option is to go all-in on the one use case we have so far (exposing a metric server):\npublic interface MetricServer {\n  void start(MetricProducer, Properties);\n}\n\nI'm struggling to come up with a name that's both general and not confusing, so would probably opt for the narrower and less confusing MetricServer. (credit to @iNikem for this name btw)\nThoughts?", "author": "trask", "createdAt": "2020-10-08T04:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MTc2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496881766", "bodyText": "Just wondering: shouldn't these settings be prefixed with otel.exporter. or at least otel.?", "author": "mateuszrzeszutek", "createdAt": "2020-09-29T16:35:34Z", "path": "javaagent-exporters/prometheus/src/main/java/io/opentelemetry/javaagent/exporters/prometheus/PrometheusMetricProducerCustomizer.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.javaagent.exporters.prometheus;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.exporters.prometheus.PrometheusCollector;\n+import io.opentelemetry.javaagent.spi.exporter.MetricProducerCustomizer;\n+import io.opentelemetry.sdk.metrics.export.MetricProducer;\n+import io.prometheus.client.exporter.HTTPServer;\n+import java.io.IOException;\n+import java.util.Properties;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link PrometheusMetricProducerCustomizer} registers {@link MetricProducer} to the ${@link\n+ * PrometheusMetricProducerCustomizer}. The collector pulls metrics from the producer when the\n+ * Prometheus server scraps metric endpoint.\n+ */\n+@AutoService(MetricProducerCustomizer.class)\n+public class PrometheusMetricProducerCustomizer implements MetricProducerCustomizer {\n+  private static final Logger log =\n+      LoggerFactory.getLogger(PrometheusMetricProducerCustomizer.class);\n+\n+  private static final String EXPORTER_NAME = \"prometheus\";\n+  private static final String PORT_CONF_PROP_NAME = EXPORTER_NAME + \".port\";\n+  private static final String HOST_CONF_PROP_NAME = EXPORTER_NAME + \".host\";", "originalCommit": "16af2556fdc96397ceb92c300cdc87929bb0cab7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4NTEwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r496885107", "bodyText": "oh ya, this just changed in #1254, ExporterConfig used to automagically add the prefix", "author": "trask", "createdAt": "2020-09-29T16:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MTc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk4NjU1Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r497986552", "bodyText": "@pavolloffay can you check this? then I think good to merge!", "author": "trask", "createdAt": "2020-10-01T05:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MTc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI5MDc0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498290741", "bodyText": "sorry for the delay I have updated it.", "author": "pavolloffay", "createdAt": "2020-10-01T14:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MTc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzNDY5MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498334691", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * PrometheusMetricProducerCustomizer}. The collector pulls metrics from the producer when the\n          \n          \n            \n             * PrometheusCollector}. The collector pulls metrics from the producer when the", "author": "iNikem", "createdAt": "2020-10-01T15:30:06Z", "path": "javaagent-exporters/prometheus/src/main/java/io/opentelemetry/javaagent/exporters/prometheus/PrometheusMetricProducerCustomizer.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.javaagent.exporters.prometheus;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.exporters.prometheus.PrometheusCollector;\n+import io.opentelemetry.javaagent.spi.exporter.MetricProducerCustomizer;\n+import io.opentelemetry.sdk.metrics.export.MetricProducer;\n+import io.prometheus.client.exporter.HTTPServer;\n+import java.io.IOException;\n+import java.util.Properties;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link PrometheusMetricProducerCustomizer} registers {@link MetricProducer} to the ${@link\n+ * PrometheusMetricProducerCustomizer}. The collector pulls metrics from the producer when the", "originalCommit": "e4868abaa7f74547dd7a63970eb97e35f681670a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzNTYxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498335611", "bodyText": "Sorry, but I still not quite understand how HTTPServer and PrometheusCollector are connected :(", "author": "iNikem", "createdAt": "2020-10-01T15:31:16Z", "path": "javaagent-exporters/prometheus/src/main/java/io/opentelemetry/javaagent/exporters/prometheus/PrometheusMetricProducerCustomizer.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.javaagent.exporters.prometheus;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.exporters.prometheus.PrometheusCollector;\n+import io.opentelemetry.javaagent.spi.exporter.MetricProducerCustomizer;\n+import io.opentelemetry.sdk.metrics.export.MetricProducer;\n+import io.prometheus.client.exporter.HTTPServer;\n+import java.io.IOException;\n+import java.util.Properties;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link PrometheusMetricProducerCustomizer} registers {@link MetricProducer} to the ${@link\n+ * PrometheusMetricProducerCustomizer}. The collector pulls metrics from the producer when the\n+ * Prometheus server scraps metric endpoint.\n+ */\n+@AutoService(MetricProducerCustomizer.class)\n+public class PrometheusMetricProducerCustomizer implements MetricProducerCustomizer {\n+  private static final Logger log =\n+      LoggerFactory.getLogger(PrometheusMetricProducerCustomizer.class);\n+\n+  private static final String EXPORTER_NAME = \"otel.exporter.prometheus\";\n+  private static final String PORT_CONF_PROP_NAME = EXPORTER_NAME + \".port\";\n+  private static final String HOST_CONF_PROP_NAME = EXPORTER_NAME + \".host\";\n+  private static final String DEFAULT_PORT = \"9464\";\n+  // The empty address equals to any address\n+  private static final String DEFAULT_HOST = \"0.0.0.0\";\n+\n+  @Override\n+  public void configure(MetricProducer producer, Properties config) {\n+    PrometheusCollector.newBuilder().setMetricProducer(producer).buildAndRegister();\n+    try {\n+      String portStr = config.getProperty(PORT_CONF_PROP_NAME, DEFAULT_PORT);\n+      String host = config.getProperty(HOST_CONF_PROP_NAME, DEFAULT_HOST);\n+      log.info(\"Creating Prometheus exporter on host: '{}' and port: '{}'\", host, portStr);\n+      new HTTPServer(host, Integer.parseInt(portStr), true);", "originalCommit": "e4868abaa7f74547dd7a63970eb97e35f681670a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4NzIyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498387222", "bodyText": "Added a comment", "author": "pavolloffay", "createdAt": "2020-10-01T16:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzNTYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzOTYxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498339617", "bodyText": "What collector? I see MetricProducerCustomizer and MetricProducer in method body, what is collector? :)", "author": "iNikem", "createdAt": "2020-10-01T15:36:57Z", "path": "javaagent-tooling/src/main/java/io/opentelemetry/javaagent/tooling/TracerInstaller.java", "diffHunk": "@@ -165,6 +191,14 @@ private static void installExporter(SpanExporterFactory spanExporterFactory, Pro\n     log.info(\"Installed span exporter: \" + spanExporter.getClass().getName());\n   }\n \n+  private static void installCollector(", "originalCommit": "e4868abaa7f74547dd7a63970eb97e35f681670a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4NjM4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r498386386", "bodyText": "This is a leftover from the previous naming. I will rename it to match the new name.", "author": "pavolloffay", "createdAt": "2020-10-01T16:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzOTYxNw=="}], "type": "inlineReview"}, {"oid": "3feb6c8c20408b88c61ebda8518eae74f1a69e4c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3feb6c8c20408b88c61ebda8518eae74f1a69e4c", "message": "Add prometheus exporter\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-10-09T07:00:47Z", "type": "commit"}, {"oid": "3feb6c8c20408b88c61ebda8518eae74f1a69e4c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3feb6c8c20408b88c61ebda8518eae74f1a69e4c", "message": "Add prometheus exporter\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-10-09T07:00:47Z", "type": "forcePushed"}, {"oid": "9fd49434eea5d7f4e9ab01f83c9c66e7dd3eaf2a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9fd49434eea5d7f4e9ab01f83c9c66e7dd3eaf2a", "message": "rename\n\nSigned-off-by: Pavol Loffay <p.loffay@gmail.com>", "committedDate": "2020-10-09T07:02:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyMjgxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r502322811", "bodyText": "Do you think configure is a better name than start as Trask proposed?", "author": "iNikem", "createdAt": "2020-10-09T10:02:08Z", "path": "javaagent-spi/src/main/java/io/opentelemetry/javaagent/spi/exporter/MetricServer.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.spi.exporter;\n+\n+import io.opentelemetry.sdk.metrics.export.MetricProducer;\n+import java.util.Properties;\n+\n+/**\n+ * A {@link MetricServer} acts as the bootstrap for metric exporters that use {@link MetricProducer}\n+ * to consume the metrics.\n+ *\n+ * <p>Implementation of {@link MetricServer} must be registered through the Java SPI framework.\n+ */\n+public interface MetricServer {\n+\n+  /**\n+   * Initialize the metric server that pull metric from the {@link MetricProducer}.\n+   *\n+   * @param producer The metric producer\n+   * @param config The configuration\n+   */\n+  void configure(MetricProducer producer, Properties config);", "originalCommit": "9fd49434eea5d7f4e9ab01f83c9c66e7dd3eaf2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2NDg2OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1262#discussion_r502564868", "bodyText": "my bad I didn't pay attention. Either one if fine with me, I will rename it to start.", "author": "pavolloffay", "createdAt": "2020-10-09T17:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyMjgxMQ=="}], "type": "inlineReview"}, {"oid": "6f0313b764a2c622eed2727dc20a7c426d2cfdfc", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6f0313b764a2c622eed2727dc20a7c426d2cfdfc", "message": "Rename to start\n\nSigned-off-by: Pavol Loffay <p.loffay@gmail.com>", "committedDate": "2020-10-09T17:15:23Z", "type": "commit"}]}