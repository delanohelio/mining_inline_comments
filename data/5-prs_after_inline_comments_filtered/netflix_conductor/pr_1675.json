{"pr_number": 1675, "pr_title": "Add configurations to enable external index management", "pr_createdAt": "2020-05-11T07:06:57Z", "pr_url": "https://github.com/Netflix/conductor/pull/1675", "timeline": [{"oid": "2a137b4ce19b36fd9e0ba51b3b6212f9a78706ea", "url": "https://github.com/Netflix/conductor/commit/2a137b4ce19b36fd9e0ba51b3b6212f9a78706ea", "message": "enable configuration for external index management", "committedDate": "2020-05-11T07:35:36Z", "type": "forcePushed"}, {"oid": "e3cdb26f6b243c16a7fc13411ee689f3c0665383", "url": "https://github.com/Netflix/conductor/commit/e3cdb26f6b243c16a7fc13411ee689f3c0665383", "message": "enable configuration for external index management", "committedDate": "2020-05-11T07:40:52Z", "type": "forcePushed"}, {"oid": "5cecf139e791c92502370444c5a6623254bf0eca", "url": "https://github.com/Netflix/conductor/commit/5cecf139e791c92502370444c5a6623254bf0eca", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-11T07:44:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3Mjg3NA==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423372874", "bodyText": "Do you use @nullable annotations? What is the expected response for bad input?", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:17:14Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/dao/es6/index/ElasticSearchBaseDAO.java", "diffHunk": "@@ -45,8 +56,7 @@ BoolQueryBuilder boolQueryBuilder(String expression, String queryString) throws\n         return QueryBuilders.boolQuery().must(stringQuery).must(filterQuery);\n     }\n \n-    String indexName(String documentType) {\n+    String getIndexName(String documentType) {", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3MzQ3MA==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423373470", "bodyText": "private static final constants, should they be capitalized? I think a better question is do we have code guidelines for Conductor published somewhere?", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:18:57Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/dao/es6/index/ElasticSearchDAOV6.java", "diffHunk": "@@ -91,62 +91,45 @@\n @Singleton\n public class ElasticSearchDAOV6 extends ElasticSearchBaseDAO implements IndexDAO {\n \n-    private static final Logger logger = LoggerFactory.getLogger(ElasticSearchDAOV6.class);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ElasticSearchDAOV6.class);\n \n     private static final String WORKFLOW_DOC_TYPE = \"workflow\";\n-\n     private static final String TASK_DOC_TYPE = \"task\";\n-\n     private static final String LOG_DOC_TYPE = \"task_log\";\n-\n     private static final String EVENT_DOC_TYPE = \"event\";\n-\n     private static final String MSG_DOC_TYPE = \"message\";\n \n-    private static final String className = ElasticSearchDAOV6.class.getSimpleName();\n-\n     private static final int RETRY_COUNT = 3;\n-\n     private static final int CORE_POOL_SIZE = 6;\n-\n     private static final long KEEP_ALIVE_TIME = 1L;\n-\n     private static final int UPDATE_REQUEST_RETRY_COUNT = 5;\n \n-    private String workflowIndexName;\n-\n-    private String taskIndexName;\n-\n-    private String eventIndexPrefix;\n+    private static final String className = ElasticSearchDAOV6.class.getSimpleName();", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3MzkzNQ==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423373935", "bodyText": "I see the structure of the indices is more complicated than I suspected. Is that documented somewhere?", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:20:23Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/dao/es6/index/ElasticSearchDAOV6.java", "diffHunk": "@@ -91,62 +91,45 @@\n @Singleton\n public class ElasticSearchDAOV6 extends ElasticSearchBaseDAO implements IndexDAO {\n \n-    private static final Logger logger = LoggerFactory.getLogger(ElasticSearchDAOV6.class);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ElasticSearchDAOV6.class);\n \n     private static final String WORKFLOW_DOC_TYPE = \"workflow\";\n-\n     private static final String TASK_DOC_TYPE = \"task\";\n-\n     private static final String LOG_DOC_TYPE = \"task_log\";\n-\n     private static final String EVENT_DOC_TYPE = \"event\";\n-\n     private static final String MSG_DOC_TYPE = \"message\";\n \n-    private static final String className = ElasticSearchDAOV6.class.getSimpleName();\n-\n     private static final int RETRY_COUNT = 3;\n-\n     private static final int CORE_POOL_SIZE = 6;\n-\n     private static final long KEEP_ALIVE_TIME = 1L;\n-\n     private static final int UPDATE_REQUEST_RETRY_COUNT = 5;\n \n-    private String workflowIndexName;\n-\n-    private String taskIndexName;\n-\n-    private String eventIndexPrefix;\n+    private static final String className = ElasticSearchDAOV6.class.getSimpleName();\n \n+    private final String workflowIndexName;\n+    private final String taskIndexName;\n+    private final String eventIndexPrefix;\n     private String eventIndexName;\n-\n-    private String messageIndexPrefix;\n-\n+    private final String messageIndexPrefix;", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3NDU4OA==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r424674588", "bodyText": "In ES6, each index corresponds to one document type.", "author": "apanicker-nflx", "createdAt": "2020-05-13T19:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3MzkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NDcwNQ==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423374705", "bodyText": "I suppose there're some legacy reasons behind this, but, shouldn't this doc types be an enum instead of a series of Strings?", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:22:49Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/dao/es6/index/ElasticSearchDAOV6.java", "diffHunk": "@@ -156,8 +139,8 @@ public ElasticSearchDAOV6(Client elasticSearchClient, ElasticSearchConfiguration\n         this.objectMapper = objectMapper;\n         this.elasticSearchClient = elasticSearchClient;\n         this.indexPrefix = config.getIndexName();\n-        this.workflowIndexName = indexName(WORKFLOW_DOC_TYPE);\n-        this.taskIndexName = indexName(TASK_DOC_TYPE);\n+        this.workflowIndexName = getIndexName(WORKFLOW_DOC_TYPE);", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3NzkwNQ==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r424677905", "bodyText": "will refactor in a subsequent PR.", "author": "apanicker-nflx", "createdAt": "2020-05-13T19:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NDcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NzU2Mg==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423377562", "bodyText": "Nitpicking on phrasing \"Starting graceful shutdown\"?", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:31:21Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/dao/es6/index/ElasticSearchDAOV6.java", "diffHunk": "@@ -187,17 +177,16 @@ public ElasticSearchDAOV6(Client elasticSearchClient, ElasticSearchConfiguration\n             TimeUnit.SECONDS,\n             new LinkedBlockingQueue<>(workerQueueSize),\n             (runnable, executor) -> {\n-                logger.warn(\"Request {} to async log dao discarded in executor {}\", runnable, executor);\n+                LOGGER.warn(\"Request {} to async log dao discarded in executor {}\", runnable, executor);\n                 Monitors.recordDiscardedIndexingCount(\"logQueue\");\n             });\n \n         Executors.newSingleThreadScheduledExecutor().scheduleAtFixedRate(this::flushBulkRequests, 60, 30, TimeUnit.SECONDS);\n-\n     }\n \n     @PreDestroy\n     private void shutdown() {\n-        logger.info(\"Gracefully shutdown executor service\");\n+        LOGGER.info(\"Gracefully shutdown executor service\");", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3ODM5Mg==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423378392", "bodyText": "Why do you explicitly call the current thread's interrupt, instead of letting the exception float up? At the very least you're loosing the context of the original exception.", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:34:10Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/dao/es6/index/ElasticSearchDAOV6.java", "diffHunk": "@@ -206,13 +195,13 @@ private void shutdownExecutorService(ExecutorService execService) {\n         try {\n             execService.shutdown();\n             if (execService.awaitTermination(30, TimeUnit.SECONDS)) {\n-                logger.debug(\"tasks completed, shutting down\");\n+                LOGGER.debug(\"tasks completed, shutting down\");\n             } else {\n-                logger.warn(\"Forcing shutdown after waiting for 30 seconds\");\n+                LOGGER.warn(\"Forcing shutdown after waiting for 30 seconds\");\n                 execService.shutdownNow();\n             }\n         } catch (InterruptedException ie) {\n-            logger.warn(\"Shutdown interrupted, invoking shutdownNow on scheduledThreadPoolExecutor for delay queue\");\n+            LOGGER.warn(\"Shutdown interrupted, invoking shutdownNow on scheduledThreadPoolExecutor for delay queue\");\n             execService.shutdownNow();\n             Thread.currentThread().interrupt();", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3ODkxMQ==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423378911", "bodyText": "(Following up on our conversation)\nI think this could be refactored to use an in-memory queue and an indexer class when index management is enabled. That way we'll have comparable architecture in both cases (producer -> queue -> indexer)\nAll this logic would remain the same, but isolated in it's own class, and that class can be re-used from the indexer service, when you decide your deployment requires an independent service.", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:36:01Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/dao/es6/index/ElasticSearchDAOV6.java", "diffHunk": "@@ -222,12 +211,11 @@ private void shutdownExecutorService(ExecutorService execService) {\n     public void setup() throws Exception {\n         waitForHealthyCluster();\n \n-        createIndexesTemplates();\n-\n-        createWorkflowIndex();\n-\n-        createTaskIndex();\n-\n+        if (config.isElasticSearchAutoIndexManagementEnabled()) {", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MDQ5OA==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423380498", "bodyText": "When you get this error, doesn't the whole system end up in a bad state? Here you're just logging and continuing on, but something really bad happened. Does it make sense to let the process go on?", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:40:59Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/dao/es6/index/ElasticSearchDAOV6.java", "diffHunk": "@@ -310,20 +298,20 @@ private void createIndex(String indexName) {\n                         .create(createIndexRequest)\n                         .actionGet();\n             } catch (ResourceAlreadyExistsException done) {\n-                logger.error(\"Failed to update log index name: {}\", indexName, done);\n+                LOGGER.error(\"Failed to update log index name: {}\", indexName, done);\n             }\n         }\n     }\n \n     private void addTypeMapping(String indexName, String type, String sourcePath) {\n         GetMappingsResponse getMappingsResponse = elasticSearchClient.admin().indices().prepareGetMappings(indexName).addTypes(type).execute().actionGet();\n         if (getMappingsResponse.mappings().isEmpty()) {\n-            logger.info(\"Adding the {} type mappings\", indexName);\n+            LOGGER.info(\"Adding the {} type mappings\", indexName);\n             try {\n                 String source = loadTypeMappingSource(sourcePath);\n                 elasticSearchClient.admin().indices().preparePutMapping(indexName).setType(type).setSource(source, XContentType.JSON).execute().actionGet();\n             } catch (Exception e) {\n-                logger.error(\"Failed to init index \" + indexName + \" mappings\", e);\n+                LOGGER.error(\"Failed to init index \" + indexName + \" mappings\", e);", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MjkyNQ==", "url": "https://github.com/Netflix/conductor/pull/1675#discussion_r423382925", "bodyText": "Javadoc? :)", "author": "AlejandroJorgePerez", "createdAt": "2020-05-11T23:48:41Z", "path": "es6-persistence/src/main/java/com/netflix/conductor/elasticsearch/SystemPropertiesElasticSearchConfiguration.java", "diffHunk": "@@ -1,7 +1,20 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n package com.netflix.conductor.elasticsearch;\n \n import com.netflix.conductor.core.config.SystemPropertiesConfiguration;\n \n public class SystemPropertiesElasticSearchConfiguration", "originalCommit": "5cecf139e791c92502370444c5a6623254bf0eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "02069453045cab658035f4c66ce31c059ee0d60f", "url": "https://github.com/Netflix/conductor/commit/02069453045cab658035f4c66ce31c059ee0d60f", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-12T01:40:18Z", "type": "forcePushed"}, {"oid": "e220d01139534a9a1f85704b3dc47acb115eab7c", "url": "https://github.com/Netflix/conductor/commit/e220d01139534a9a1f85704b3dc47acb115eab7c", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-12T01:44:20Z", "type": "forcePushed"}, {"oid": "8a952ad534ccbe0afba41734bc4fb1af9786fd1f", "url": "https://github.com/Netflix/conductor/commit/8a952ad534ccbe0afba41734bc4fb1af9786fd1f", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-12T01:45:19Z", "type": "forcePushed"}, {"oid": "7b9e4e457d1615dab3b513a8c7760bfa834fcd7f", "url": "https://github.com/Netflix/conductor/commit/7b9e4e457d1615dab3b513a8c7760bfa834fcd7f", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-13T04:19:10Z", "type": "forcePushed"}, {"oid": "427ada64625340e77a2b937c03d04fa084a58e80", "url": "https://github.com/Netflix/conductor/commit/427ada64625340e77a2b937c03d04fa084a58e80", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-13T07:28:38Z", "type": "forcePushed"}, {"oid": "97c633bbd9e92f2918b3ccde45ed6b7ec8ec924a", "url": "https://github.com/Netflix/conductor/commit/97c633bbd9e92f2918b3ccde45ed6b7ec8ec924a", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-13T19:28:01Z", "type": "forcePushed"}, {"oid": "167180ad517ef8d65679e2094ad3a63f4920cd5b", "url": "https://github.com/Netflix/conductor/commit/167180ad517ef8d65679e2094ad3a63f4920cd5b", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-13T20:17:10Z", "type": "commit"}, {"oid": "167180ad517ef8d65679e2094ad3a63f4920cd5b", "url": "https://github.com/Netflix/conductor/commit/167180ad517ef8d65679e2094ad3a63f4920cd5b", "message": "add configuration to enable external index management in es6", "committedDate": "2020-05-13T20:17:10Z", "type": "forcePushed"}]}