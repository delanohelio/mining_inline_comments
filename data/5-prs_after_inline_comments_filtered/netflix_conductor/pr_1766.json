{"pr_number": 1766, "pr_title": "Bugfix/correlation id performance fix for issue #1681", "pr_createdAt": "2020-07-06T19:18:27Z", "pr_url": "https://github.com/Netflix/conductor/pull/1766", "timeline": [{"oid": "ce0a00020e734980121bb2bbdf8076ab3592de7c", "url": "https://github.com/Netflix/conductor/commit/ce0a00020e734980121bb2bbdf8076ab3592de7c", "message": "added a performance improvement for doing a search for workflows by correlation id", "committedDate": "2020-07-06T19:13:24Z", "type": "commit"}, {"oid": "2390d59ada1a0499c3020071b4d95d7a23ff6bc6", "url": "https://github.com/Netflix/conductor/commit/2390d59ada1a0499c3020071b4d95d7a23ff6bc6", "message": "remove no-longer-needed getWorkflowsByCorrelationId method without workflowName as a parameter", "committedDate": "2020-07-08T14:23:20Z", "type": "commit"}, {"oid": "41251425b365c37c1cfe4fd24e1acb8cafee8ddf", "url": "https://github.com/Netflix/conductor/commit/41251425b365c37c1cfe4fd24e1acb8cafee8ddf", "message": "fix tests to use the appropriate workflow name", "committedDate": "2020-07-08T15:39:06Z", "type": "commit"}, {"oid": "201bec6a0856ef5048ca220d347afa623011f0e0", "url": "https://github.com/Netflix/conductor/commit/201bec6a0856ef5048ca220d347afa623011f0e0", "message": "Merge branch 'dev' of https://github.com/Netflix/conductor into bugfix/correlationId-performance-fix", "committedDate": "2020-07-08T15:39:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4NjY0Mw==", "url": "https://github.com/Netflix/conductor/pull/1766#discussion_r452386643", "bodyText": "Comparator.comparingLong(Task::getScheduledTime) is not needed here since sorting by seq here would arrange the tasks in the correct order.", "author": "apanicker-nflx", "createdAt": "2020-07-09T17:44:51Z", "path": "core/src/main/java/com/netflix/conductor/service/ExecutionService.java", "diffHunk": "@@ -342,14 +343,21 @@ private boolean requeue(Task pending) {\n \n \tpublic List<Workflow> getWorkflowInstances(String workflowName, String correlationId, boolean includeClosed, boolean includeTasks) {\n \n-\t\tList<Workflow> workflows = executionDAOFacade.getWorkflowsByCorrelationId(correlationId, includeTasks);\n+\t\tList<Workflow> workflows = executionDAOFacade.getWorkflowsByCorrelationId(workflowName, correlationId, false);\n \t\tList<Workflow> result = new LinkedList<>();\n-\t\tfor (Workflow wf : workflows) {\n-\t\t\tif (wf.getWorkflowName().equals(workflowName) && (includeClosed || wf.getStatus().equals(Workflow.WorkflowStatus.RUNNING))) {\n-\t\t\t\tresult.add(wf);\n+\t\tresult = workflows.stream().parallel().filter(wf -> {\n+\t\t\tif (includeClosed || wf.getStatus().equals(Workflow.WorkflowStatus.RUNNING)) {\n+\t\t\t\t// including tasks for subset of workflows to increase performance\n+\t\t\t\tif (includeTasks) {\n+\t\t\t\t\tList<Task> tasks = executionDAOFacade.getTasksForWorkflow(wf.getWorkflowId());\n+\t\t\t\t\ttasks.sort(Comparator.comparingLong(Task::getScheduledTime).thenComparingInt(Task::getSeq));", "originalCommit": "201bec6a0856ef5048ca220d347afa623011f0e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "754f6847ea7da9976863133accb8aa894c74146e", "url": "https://github.com/Netflix/conductor/commit/754f6847ea7da9976863133accb8aa894c74146e", "message": "Merge branch 'dev' of https://github.com/Netflix/conductor into bugfix/correlationId-performance-fix", "committedDate": "2020-07-09T18:48:46Z", "type": "commit"}, {"oid": "c87755bb80508439bed943a32cf159fbf1ff02fe", "url": "https://github.com/Netflix/conductor/commit/c87755bb80508439bed943a32cf159fbf1ff02fe", "message": "take out scheduledTime sort when already sorting by sequence", "committedDate": "2020-07-09T18:52:24Z", "type": "commit"}]}