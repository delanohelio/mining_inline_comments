{"pr_number": 842, "pr_title": "Add support for multiple ActiveQueryLog instances", "pr_createdAt": "2020-06-27T01:33:30Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/842", "timeline": [{"oid": "db0167f3dcc7672360631094314f08b6951e79ab", "url": "https://github.com/NationalSecurityAgency/datawave/commit/db0167f3dcc7672360631094314f08b6951e79ab", "message": "Add support for multiple ActiveQueryLog instances\n\nCurrently an ActiveQueryLog singleton is used for logging events from\nall active queries. It can be difficult to easily search the logs for\nqueries that are running on specific tables.\n\nAdd support to be able to retrieve a new ActiveQueryLog instance\nassociated with a configurable name, and include this name in log\nmessages generated by the ActiveQueryLog. Keep support for a default\nActiveQueryLog instance that can be shared by queries when additional\nsearch details is not needed.\n\nIn addition, add the ability to specifiy a source for the active query\nlog name for ShardQueryLogic.\n\nFixes #817", "committedDate": "2020-06-27T01:37:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0Nzc3OQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r448947779", "bodyText": "But how can we be sure these are set if we don't set them multiple times?  ;)", "author": "ivakegg", "createdAt": "2020-07-02T11:56:07Z", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryOptions.java", "diffHunk": "@@ -465,21 +477,6 @@ public void deepCopy(QueryOptions other) {\n         \n         this.sortedUIDs = other.sortedUIDs;\n         \n-        this.compressedMappings = other.compressedMappings;", "originalCommit": "db0167f3dcc7672360631094314f08b6951e79ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2ODk3OA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r448968978", "bodyText": "Heh, you got me there.", "author": "lbschanno", "createdAt": "2020-07-02T12:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0Nzc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MTMxMg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r448951312", "bodyText": "ouch!  How about a shorter name and some comments above it.", "author": "ivakegg", "createdAt": "2020-07-02T12:02:54Z", "path": "warehouse/query-core/src/test/java/datawave/query/config/ShardQueryConfigurationTest.java", "diffHunk": "@@ -434,17 +436,46 @@ public void testIsTldQuery() {\n      */\n     @Test\n     public void testCheckForNewAdditions() throws IOException {\n-        int expectedObjectCount = 172;\n+        int expectedObjectCount = 173;\n         ShardQueryConfiguration config = ShardQueryConfiguration.create();\n         ObjectMapper mapper = new ObjectMapper();\n         JsonNode root = mapper.readTree(mapper.writeValueAsString(config));\n         Iterator<JsonNode> rootIter = root.elements();\n         int objectCount = 0;\n         while (rootIter.hasNext()) {\n-            rootIter.next();\n+            JsonNode next = rootIter.next();\n+            \n             objectCount++;\n         }\n         \n-        Assert.assertEquals(\"New variable was added to or removed from the ShardQueryConfiguration\", expectedObjectCount, objectCount);\n+        assertEquals(\"New variable was added to or removed from the ShardQueryConfiguration\", expectedObjectCount, objectCount);\n+    }\n+    \n+    @Test\n+    public void whenRetrievingActiveQueryLogName_givenTableNameSource_thenReturnsTableName() {", "originalCommit": "db0167f3dcc7672360631094314f08b6951e79ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4NzcyOQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r448987729", "bodyText": "I agree that one shouldn't use overly long method names when writing product code, but I don't think the same should apply to unit tests. By using a when<behavior_under_test>_given_then<expected_behavior>, I'm able to state a single technical requirement being tested (which works well for TDD) and make the method self documenting. If a test fails during a build, I'll be able to know at a glance in the logs what was being tested and which requirement failed. I think this naming style also makes it easier for other developers to clearly understand each test case.\nI have found that when testing multiple methods with multiple technical requirements for each method, writing short but still clear method names can get pretty tricky. Granted, that's not necessarily the case here and I can shorten the names a bit. I hope I've been able to explain my reasoning clearly; this is a habit formed from many years of TDD and I think it works well, but I will work on changing it if you feel that it doesn't fit this project's style.", "author": "lbschanno", "createdAt": "2020-07-02T13:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MTMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MjEwMA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r448952100", "bodyText": "ouch! How about a shorter name and some comments above it.", "author": "ivakegg", "createdAt": "2020-07-02T12:04:25Z", "path": "warehouse/query-core/src/test/java/datawave/query/tracking/ActiveQueryLogTest.java", "diffHunk": "@@ -90,6 +95,33 @@ public void run() {\n         }\n     }\n     \n+    @Test\n+    public void whenRetrievingInstance_givenNullName_shouldReturnsDefaultInstance() {", "originalCommit": "db0167f3dcc7672360631094314f08b6951e79ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc3OTQ0Ng==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r465779446", "bodyText": "I shortened the test case names a bit.", "author": "lbschanno", "createdAt": "2020-08-05T14:43:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MjEwMA=="}], "type": "inlineReview"}, {"oid": "7f4d4ed968fce18411815a6fff8f92d29ae9074f", "url": "https://github.com/NationalSecurityAgency/datawave/commit/7f4d4ed968fce18411815a6fff8f92d29ae9074f", "message": "Add support for multiple ActiveQueryLog instances\n\nCurrently an ActiveQueryLog singleton is used for logging events from\nall active queries. It can be difficult to easily search the logs for\nqueries that are running on specific tables.\n\nAdd support to be able to retrieve a new ActiveQueryLog instance\nassociated with a configurable name, and include this name in log\nmessages generated by the ActiveQueryLog. Keep support for a default\nActiveQueryLog instance that can be shared by queries when additional\nsearch details is not needed.\n\nIn addition, add the ability to specifiy a source for the active query\nlog name for ShardQueryLogic.\n\nFixes #817", "committedDate": "2020-12-15T18:16:35Z", "type": "commit"}, {"oid": "536f503c662c1cd52678167069bbc33436c3ddc4", "url": "https://github.com/NationalSecurityAgency/datawave/commit/536f503c662c1cd52678167069bbc33436c3ddc4", "message": "Remove duplicate definition for METADATA_TABLE_NAME", "committedDate": "2020-12-15T18:16:40Z", "type": "commit"}, {"oid": "e3a98be678bfed276692cb51d372eb117c60eae9", "url": "https://github.com/NationalSecurityAgency/datawave/commit/e3a98be678bfed276692cb51d372eb117c60eae9", "message": "Update maxIdle in setMaxIdle", "committedDate": "2020-12-15T18:16:40Z", "type": "commit"}, {"oid": "a113e86ee72ba1b7fc17c9d284320a7297af329f", "url": "https://github.com/NationalSecurityAgency/datawave/commit/a113e86ee72ba1b7fc17c9d284320a7297af329f", "message": "Shorten test case names", "committedDate": "2020-12-15T18:16:40Z", "type": "commit"}, {"oid": "a113e86ee72ba1b7fc17c9d284320a7297af329f", "url": "https://github.com/NationalSecurityAgency/datawave/commit/a113e86ee72ba1b7fc17c9d284320a7297af329f", "message": "Shorten test case names", "committedDate": "2020-12-15T18:16:40Z", "type": "forcePushed"}, {"oid": "55e4b1785869c33e1e0bbe5ecbab46dd73af238d", "url": "https://github.com/NationalSecurityAgency/datawave/commit/55e4b1785869c33e1e0bbe5ecbab46dd73af238d", "message": "Merge branch 'release/version3.1' into active-query-log", "committedDate": "2021-01-30T00:30:06Z", "type": "commit"}, {"oid": "698d0216fa91e4bcce749f7904440fa4f8ae2a97", "url": "https://github.com/NationalSecurityAgency/datawave/commit/698d0216fa91e4bcce749f7904440fa4f8ae2a97", "message": "Merge branch 'release/version3.2' into active-query-log", "committedDate": "2021-02-23T17:16:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk2NzI2NQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r581967265", "bodyText": "delete unused import", "author": "billoley", "createdAt": "2021-02-24T13:41:38Z", "path": "warehouse/query-core/src/main/java/datawave/query/tracking/ActiveQueryLog.java", "diffHunk": "@@ -2,85 +2,139 @@\n \n import com.github.benmanes.caffeine.cache.Cache;\n import com.github.benmanes.caffeine.cache.Caffeine;\n+import com.google.common.annotations.VisibleForTesting;", "originalCommit": "698d0216fa91e4bcce749f7904440fa4f8ae2a97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk2ODE3MA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r581968170", "bodyText": "use ActiveQueryLog.logCacheLock and ActiveQueryLog.logCache to make the static access obvious\nmove null check outside the synchronized to prevent unnecessary syncronization (I understand that this only happens for a very short time)", "author": "billoley", "createdAt": "2021-02-24T13:42:51Z", "path": "warehouse/query-core/src/main/java/datawave/query/tracking/ActiveQueryLog.java", "diffHunk": "@@ -2,85 +2,139 @@\n \n import com.github.benmanes.caffeine.cache.Cache;\n import com.github.benmanes.caffeine.cache.Caffeine;\n+import com.google.common.annotations.VisibleForTesting;\n import org.apache.accumulo.core.conf.AccumuloConfiguration;\n import org.apache.accumulo.core.data.Range;\n+import org.apache.commons.lang.StringUtils;\n import org.apache.log4j.Logger;\n \n import java.util.ArrayList;\n import java.util.List;\n import java.util.Timer;\n import java.util.TimerTask;\n import java.util.UUID;\n+import java.util.concurrent.ConcurrentMap;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n \n public class ActiveQueryLog {\n     \n+    public static final String DEFAULT_NAME = \"default_log\";\n     private static final String DEFAULT_EMPTY_QUERY_ID = new UUID(0, 0).toString();\n-    private static Logger log = Logger.getLogger(ActiveQueryLog.class);\n-    private static ActiveQueryLog instance = null;\n+    private static final Logger log = Logger.getLogger(ActiveQueryLog.class);\n+    private static Cache<String,ActiveQueryLog> logCache = null;\n+    private static final Object logCacheLock = new Object();\n     private static AccumuloConfiguration conf = null;\n     \n     // Accumulo properties\n     public static final String MAX_IDLE = \"datawave.query.active.maxIdleMs\";\n     public static final String LOG_PERIOD = \"datawave.query.active.logPeriodMs\";\n     public static final String LOG_MAX_QUERIES = \"datawave.query.active.logMaxQueries\";\n     public static final String WINDOW_SIZE = \"datawave.query.active.windowSize\";\n-    private static long HOURS_24_MS = TimeUnit.MILLISECONDS.convert(24, TimeUnit.HOURS);\n-    private static long MINUTES_15_MS = TimeUnit.MILLISECONDS.convert(15, TimeUnit.MINUTES);\n-    private static long MINUTES_1_MS = TimeUnit.MILLISECONDS.convert(1, TimeUnit.MINUTES);\n+    private static final long HOURS_24_MS = TimeUnit.MILLISECONDS.convert(24, TimeUnit.HOURS);\n+    private static final long MINUTES_15_MS = TimeUnit.MILLISECONDS.convert(15, TimeUnit.MINUTES);\n+    private static final long MINUTES_1_MS = TimeUnit.MILLISECONDS.convert(1, TimeUnit.MINUTES);\n     \n     // Changeable via Accumulo properties\n     volatile private long maxIdle = MINUTES_15_MS;\n     volatile private long logPeriod = MINUTES_1_MS;\n     volatile private int logMaxQueries = 5;\n     volatile private int windowSize = 10;\n-    private AtomicLong lastAccess = new AtomicLong(System.currentTimeMillis());\n+    private final AtomicLong lastAccess = new AtomicLong(System.currentTimeMillis());\n     \n     private Cache<String,ActiveQuery> CACHE = null;\n-    private ReentrantReadWriteLock cacheLock = new ReentrantReadWriteLock();\n+    private final ReentrantReadWriteLock cacheLock = new ReentrantReadWriteLock();\n     private Timer timer = null;\n     private TimerTask timerTask = null;\n     \n-    synchronized public static void setConfig(AccumuloConfiguration conf) {\n+    private final String name;\n+    \n+    synchronized public static void setConfig(final AccumuloConfiguration conf) {\n         if (conf != null) {\n             if (ActiveQueryLog.conf == null || conf.getUpdateCount() > ActiveQueryLog.conf.getUpdateCount()) {\n                 ActiveQueryLog.conf = conf;\n-                ActiveQueryLog.getInstance().checkSettings(conf, false);\n+            }\n+            // Do not allow access to the cache while updating each log's settings.\n+            synchronized (logCacheLock) {", "originalCommit": "698d0216fa91e4bcce749f7904440fa4f8ae2a97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4NjAzNw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r581986037", "bodyText": "Shouldn't this be:  synchronized (ActiveQueryLog.logCacheLock) now so that the logCache is protected by syncronizing on the same object if it's being assigned here?\nAlso -- use ActiveQueryLog.logCacheLock and ActiveQueryLog.logCache below", "author": "billoley", "createdAt": "2021-02-24T14:06:23Z", "path": "warehouse/query-core/src/main/java/datawave/query/tracking/ActiveQueryLog.java", "diffHunk": "@@ -2,85 +2,139 @@\n \n import com.github.benmanes.caffeine.cache.Cache;\n import com.github.benmanes.caffeine.cache.Caffeine;\n+import com.google.common.annotations.VisibleForTesting;\n import org.apache.accumulo.core.conf.AccumuloConfiguration;\n import org.apache.accumulo.core.data.Range;\n+import org.apache.commons.lang.StringUtils;\n import org.apache.log4j.Logger;\n \n import java.util.ArrayList;\n import java.util.List;\n import java.util.Timer;\n import java.util.TimerTask;\n import java.util.UUID;\n+import java.util.concurrent.ConcurrentMap;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n \n public class ActiveQueryLog {\n     \n+    public static final String DEFAULT_NAME = \"default_log\";\n     private static final String DEFAULT_EMPTY_QUERY_ID = new UUID(0, 0).toString();\n-    private static Logger log = Logger.getLogger(ActiveQueryLog.class);\n-    private static ActiveQueryLog instance = null;\n+    private static final Logger log = Logger.getLogger(ActiveQueryLog.class);\n+    private static Cache<String,ActiveQueryLog> logCache = null;\n+    private static final Object logCacheLock = new Object();\n     private static AccumuloConfiguration conf = null;\n     \n     // Accumulo properties\n     public static final String MAX_IDLE = \"datawave.query.active.maxIdleMs\";\n     public static final String LOG_PERIOD = \"datawave.query.active.logPeriodMs\";\n     public static final String LOG_MAX_QUERIES = \"datawave.query.active.logMaxQueries\";\n     public static final String WINDOW_SIZE = \"datawave.query.active.windowSize\";\n-    private static long HOURS_24_MS = TimeUnit.MILLISECONDS.convert(24, TimeUnit.HOURS);\n-    private static long MINUTES_15_MS = TimeUnit.MILLISECONDS.convert(15, TimeUnit.MINUTES);\n-    private static long MINUTES_1_MS = TimeUnit.MILLISECONDS.convert(1, TimeUnit.MINUTES);\n+    private static final long HOURS_24_MS = TimeUnit.MILLISECONDS.convert(24, TimeUnit.HOURS);\n+    private static final long MINUTES_15_MS = TimeUnit.MILLISECONDS.convert(15, TimeUnit.MINUTES);\n+    private static final long MINUTES_1_MS = TimeUnit.MILLISECONDS.convert(1, TimeUnit.MINUTES);\n     \n     // Changeable via Accumulo properties\n     volatile private long maxIdle = MINUTES_15_MS;\n     volatile private long logPeriod = MINUTES_1_MS;\n     volatile private int logMaxQueries = 5;\n     volatile private int windowSize = 10;\n-    private AtomicLong lastAccess = new AtomicLong(System.currentTimeMillis());\n+    private final AtomicLong lastAccess = new AtomicLong(System.currentTimeMillis());\n     \n     private Cache<String,ActiveQuery> CACHE = null;\n-    private ReentrantReadWriteLock cacheLock = new ReentrantReadWriteLock();\n+    private final ReentrantReadWriteLock cacheLock = new ReentrantReadWriteLock();\n     private Timer timer = null;\n     private TimerTask timerTask = null;\n     \n-    synchronized public static void setConfig(AccumuloConfiguration conf) {\n+    private final String name;\n+    \n+    synchronized public static void setConfig(final AccumuloConfiguration conf) {\n         if (conf != null) {\n             if (ActiveQueryLog.conf == null || conf.getUpdateCount() > ActiveQueryLog.conf.getUpdateCount()) {\n                 ActiveQueryLog.conf = conf;\n-                ActiveQueryLog.getInstance().checkSettings(conf, false);\n+            }\n+            // Do not allow access to the cache while updating each log's settings.\n+            synchronized (logCacheLock) {\n+                if (logCache != null) {\n+                    ConcurrentMap<String,ActiveQueryLog> logMap = logCache.asMap();\n+                    logMap.values().forEach(log -> log.checkSettings(conf, false));\n+                }\n             }\n         }\n     }\n     \n+    /**\n+     * Return the default {@link ActiveQueryLog} instance. The time the instance was last accessed will be updated to the current time in milliseconds, and if\n+     * the instance's timer was cancelled, it will be restarted.\n+     * \n+     * @return the default {@link ActiveQueryLog} instance\n+     */\n     public static ActiveQueryLog getInstance() {\n+        return getInstance(DEFAULT_NAME);\n+    }\n+    \n+    /**\n+     * Return the {@link ActiveQueryLog} instance associated with the specified name. If one does not exist, it will be created.\n+     *\n+     * If the specified name is null or blank, the default instance with the name '{@value #DEFAULT_NAME}' will be returned. Additionally, the time the log was\n+     * last accessed will be updated to the current time in milliseconds, and if the log's timer was cancelled, it will be restarted.\n+     * \n+     * @param name\n+     *            the associated name by which to look up the desired {@link ActiveQueryLog}. This will typically be the name of a table or query logic.\n+     * @return the existing or new {@link ActiveQueryLog} for the name\n+     */\n+    public static ActiveQueryLog getInstance(String name) {\n+        // Return the default instance if the name is blank.\n+        if (StringUtils.isBlank(name)) {\n+            name = DEFAULT_NAME;\n+        }\n         \n-        if (ActiveQueryLog.instance == null) {\n+        // Initialize the log cache if necessary.\n+        if (logCache == null) {\n             synchronized (ActiveQueryLog.class) {", "originalCommit": "698d0216fa91e4bcce749f7904440fa4f8ae2a97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjA0NzQ0MA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r582047440", "bodyText": "In describeOptions, this:\noptions.put(METADATA_TABLE_NAME, \"The name of the metadata table\");\nis the correct line to leave in and should remain\noptions.put(METADATA_TABLE_NAME, this.metadataTableName);\nbelow is not descriptive and should be deleted", "author": "billoley", "createdAt": "2021-02-24T15:18:57Z", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryOptions.java", "diffHunk": "@@ -1013,7 +1030,6 @@ public IteratorOptions describeOptions() {\n         options.put(QUERY, \"The JEXL query to evaluate documents against\");\n         options.put(QUERY_ID, \"The UUID of the query\");\n         options.put(TYPE_METADATA, \"A mapping of field name to a set of DataType class names\");\n-        options.put(METADATA_TABLE_NAME, \"The name of the metadata table\");", "originalCommit": "698d0216fa91e4bcce749f7904440fa4f8ae2a97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjA1MTkzMg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r582051932", "bodyText": "can be converted into a switch/case structure for readability", "author": "billoley", "createdAt": "2021-02-24T15:24:11Z", "path": "warehouse/query-core/src/main/java/datawave/query/config/ShardQueryConfiguration.java", "diffHunk": "@@ -2061,6 +2073,35 @@ public void setEvaluationOnlyFields(Set<String> evaluationOnlyFields) {\n         return this.evaluationOnlyFields;\n     }\n     \n+    public String getActiveQueryLogNameSource() {\n+        return activeQueryLogNameSource;\n+    }\n+    \n+    public void setActiveQueryLogNameSource(String activeQueryLogNameSource) {\n+        this.activeQueryLogNameSource = activeQueryLogNameSource;\n+    }\n+    \n+    /**\n+     * Returns the name to use for the active query log for query iterators, derived from the value {@link #activeQueryLogNameSource}. Cases:\n+     * <ul>\n+     * <li>{@value TABLE_NAME_SOURCE}: returns the shard table name</li>\n+     * <li>{@value QUERY_LOGIC_NAME_SOURCE}: returns the name of the shard query logic class</li>\n+     * <li>otherwise returns a blank value</li>\n+     * </ul>\n+     *\n+     * @return the custom active query name to use, or a blank value if the default active query log should be used\n+     */\n+    @JsonIgnore", "originalCommit": "698d0216fa91e4bcce749f7904440fa4f8ae2a97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjA2MjA2OQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r582062069", "bodyText": "We should reduce unnecessary calls and cache accesses by declaring\nfinal ActiveQueryLog activeQueryLog = ActiveQueryLog.getInstance(getActiveQueryLogName());\nand using  activeQueryLog in place of ActiveQueryLog.getInstance(getActiveQueryLogName()) in this method", "author": "billoley", "createdAt": "2021-02-24T15:35:26Z", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "diffHunk": "@@ -314,7 +314,7 @@ public void enableYielding(YieldCallback<Key> yieldCallback) {\n     \n     @Override\n     public void next() throws IOException {\n-        ActiveQueryLog.getInstance().get(getQueryId()).beginCall(this.originalRange, ActiveQuery.CallType.NEXT);\n+        ActiveQueryLog.getInstance(getActiveQueryLogName()).get(getQueryId()).beginCall(this.originalRange, ActiveQuery.CallType.NEXT);", "originalCommit": "698d0216fa91e4bcce749f7904440fa4f8ae2a97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjA2MjU5Mg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r582062592", "bodyText": "We should reduce unnecessary calls and cache accesses by declaring\nfinal ActiveQueryLog activeQueryLog = ActiveQueryLog.getInstance(getActiveQueryLogName());\nand using  activeQueryLog in place of ActiveQueryLog.getInstance(getActiveQueryLogName()) in this method", "author": "billoley", "createdAt": "2021-02-24T15:36:02Z", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "diffHunk": "@@ -345,10 +345,10 @@ public void seek(Range range, Collection<ByteSequence> columnFamilies, boolean i\n         // preserve the original range for use with the Final Document tracking iterator because it is placed after the ResultCountingIterator\n         // so the FinalDocumentTracking iterator needs the start key with the count already appended\n         originalRange = range;\n-        ActiveQueryLog.getInstance().get(getQueryId()).beginCall(this.originalRange, ActiveQuery.CallType.SEEK);\n+        ActiveQueryLog.getInstance(getActiveQueryLogName()).get(getQueryId()).beginCall(this.originalRange, ActiveQuery.CallType.SEEK);", "originalCommit": "698d0216fa91e4bcce749f7904440fa4f8ae2a97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "449048c5aefc4d357660b4face22caf584d1aae4", "url": "https://github.com/NationalSecurityAgency/datawave/commit/449048c5aefc4d357660b4face22caf584d1aae4", "message": "Delete unused import", "committedDate": "2021-02-24T17:11:48Z", "type": "commit"}, {"oid": "d686721dcb32da584b2cd4f97f6ed8bbb9125b0f", "url": "https://github.com/NationalSecurityAgency/datawave/commit/d686721dcb32da584b2cd4f97f6ed8bbb9125b0f", "message": "Make static access obvious", "committedDate": "2021-02-24T17:18:40Z", "type": "commit"}, {"oid": "5828d402429abd2519cc6bfc9539418e0e3d7680", "url": "https://github.com/NationalSecurityAgency/datawave/commit/5828d402429abd2519cc6bfc9539418e0e3d7680", "message": "Prevent unnecessary synchronization", "committedDate": "2021-02-24T17:23:09Z", "type": "commit"}, {"oid": "2c989d405cac1035e2eb9fd3f534429b1866b580", "url": "https://github.com/NationalSecurityAgency/datawave/commit/2c989d405cac1035e2eb9fd3f534429b1866b580", "message": "Synchronize on logCacheLock instead of ActiveQueryLog.class", "committedDate": "2021-02-24T17:24:53Z", "type": "commit"}, {"oid": "e9d69796d07a4f44b64fd5cc27c9567c3d9f9e79", "url": "https://github.com/NationalSecurityAgency/datawave/commit/e9d69796d07a4f44b64fd5cc27c9567c3d9f9e79", "message": "Use switch/case structure for readability", "committedDate": "2021-02-24T17:28:14Z", "type": "commit"}, {"oid": "678479a6cbacc50a7603c53be5d47a0a7276a2af", "url": "https://github.com/NationalSecurityAgency/datawave/commit/678479a6cbacc50a7603c53be5d47a0a7276a2af", "message": "Reduce unecessary calls to ActiveQueryLog.getInstance()", "committedDate": "2021-02-24T17:45:40Z", "type": "commit"}, {"oid": "6f13cd10a8f84ab5c99b630dddf58383eee08df0", "url": "https://github.com/NationalSecurityAgency/datawave/commit/6f13cd10a8f84ab5c99b630dddf58383eee08df0", "message": "Shorten test names", "committedDate": "2021-02-24T17:45:48Z", "type": "commit"}, {"oid": "2ef3ffb7b68b56716da7a53090780cb365606219", "url": "https://github.com/NationalSecurityAgency/datawave/commit/2ef3ffb7b68b56716da7a53090780cb365606219", "message": "Fix NPEs", "committedDate": "2021-02-24T18:47:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjM1ODkzMg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r582358932", "bodyText": "This should go back to the way it was before the last commit so that we check for the named AQL in the logCache and add it if necessary all inside the synchronized block", "author": "billoley", "createdAt": "2021-02-24T22:43:24Z", "path": "warehouse/query-core/src/main/java/datawave/query/tracking/ActiveQueryLog.java", "diffHunk": "@@ -100,10 +100,9 @@ public static ActiveQueryLog getInstance(String name) {\n         }\n         \n         // If no log currently exists for the name, create one.", "originalCommit": "5828d402429abd2519cc6bfc9539418e0e3d7680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzI3ODM5Mg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r583278392", "bodyText": "Fixed.", "author": "lbschanno", "createdAt": "2021-02-25T23:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjM1ODkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjM2MDM3MA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r582360370", "bodyText": "This is where I thought the  if (logCache != null) check could be outside of the synchronized", "author": "billoley", "createdAt": "2021-02-24T22:46:12Z", "path": "warehouse/query-core/src/main/java/datawave/query/tracking/ActiveQueryLog.java", "diffHunk": "@@ -4,83 +4,139 @@\n import com.github.benmanes.caffeine.cache.Caffeine;\n import org.apache.accumulo.core.conf.AccumuloConfiguration;\n import org.apache.accumulo.core.data.Range;\n+import org.apache.commons.lang.StringUtils;\n import org.apache.log4j.Logger;\n \n import java.util.ArrayList;\n import java.util.List;\n import java.util.Timer;\n import java.util.TimerTask;\n import java.util.UUID;\n+import java.util.concurrent.ConcurrentMap;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n \n public class ActiveQueryLog {\n     \n+    public static final String DEFAULT_NAME = \"default_log\";\n     private static final String DEFAULT_EMPTY_QUERY_ID = new UUID(0, 0).toString();\n-    private static Logger log = Logger.getLogger(ActiveQueryLog.class);\n-    private static ActiveQueryLog instance = null;\n+    private static final Logger log = Logger.getLogger(ActiveQueryLog.class);\n+    private static Cache<String,ActiveQueryLog> logCache = null;\n+    private static final Object logCacheLock = new Object();\n     private static AccumuloConfiguration conf = null;\n     \n     // Accumulo properties\n     public static final String MAX_IDLE = \"datawave.query.active.maxIdleMs\";\n     public static final String LOG_PERIOD = \"datawave.query.active.logPeriodMs\";\n     public static final String LOG_MAX_QUERIES = \"datawave.query.active.logMaxQueries\";\n     public static final String WINDOW_SIZE = \"datawave.query.active.windowSize\";\n-    private static long HOURS_24_MS = TimeUnit.MILLISECONDS.convert(24, TimeUnit.HOURS);\n-    private static long MINUTES_15_MS = TimeUnit.MILLISECONDS.convert(15, TimeUnit.MINUTES);\n-    private static long MINUTES_1_MS = TimeUnit.MILLISECONDS.convert(1, TimeUnit.MINUTES);\n+    private static final long HOURS_24_MS = TimeUnit.MILLISECONDS.convert(24, TimeUnit.HOURS);\n+    private static final long MINUTES_15_MS = TimeUnit.MILLISECONDS.convert(15, TimeUnit.MINUTES);\n+    private static final long MINUTES_1_MS = TimeUnit.MILLISECONDS.convert(1, TimeUnit.MINUTES);\n     \n     // Changeable via Accumulo properties\n     volatile private long maxIdle = MINUTES_15_MS;\n     volatile private long logPeriod = MINUTES_1_MS;\n     volatile private int logMaxQueries = 5;\n     volatile private int windowSize = 10;\n-    private AtomicLong lastAccess = new AtomicLong(System.currentTimeMillis());\n+    private final AtomicLong lastAccess = new AtomicLong(System.currentTimeMillis());\n     \n     private Cache<String,ActiveQuery> CACHE = null;\n-    private ReentrantReadWriteLock cacheLock = new ReentrantReadWriteLock();\n+    private final ReentrantReadWriteLock cacheLock = new ReentrantReadWriteLock();\n     private Timer timer = null;\n     private TimerTask timerTask = null;\n     \n-    synchronized public static void setConfig(AccumuloConfiguration conf) {\n+    private final String name;\n+    \n+    synchronized public static void setConfig(final AccumuloConfiguration conf) {\n         if (conf != null) {\n             if (ActiveQueryLog.conf == null || conf.getUpdateCount() > ActiveQueryLog.conf.getUpdateCount()) {\n                 ActiveQueryLog.conf = conf;\n-                ActiveQueryLog.getInstance().checkSettings(conf, false);\n+            }\n+            // Do not allow access to the cache while updating each log's settings.", "originalCommit": "2ef3ffb7b68b56716da7a53090780cb365606219", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjM2NTM0NA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r582365344", "bodyText": "The other changes look fine.  I just have these two issues with the synchronization changes in AQL.", "author": "billoley", "createdAt": "2021-02-24T22:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjM2MDM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzI3ODQ3Mg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/842#discussion_r583278472", "bodyText": "Fixed.", "author": "lbschanno", "createdAt": "2021-02-25T23:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjM2MDM3MA=="}], "type": "inlineReview"}, {"oid": "7682aaaa31433383d7ef143f9602e2e2d906bbb7", "url": "https://github.com/NationalSecurityAgency/datawave/commit/7682aaaa31433383d7ef143f9602e2e2d906bbb7", "message": "Revert changes to null check placement", "committedDate": "2021-02-25T23:30:55Z", "type": "commit"}, {"oid": "593a049a6918f4f7d9757ce554a631240bb2ba0d", "url": "https://github.com/NationalSecurityAgency/datawave/commit/593a049a6918f4f7d9757ce554a631240bb2ba0d", "message": "Move null check outside synchonization block", "committedDate": "2021-02-25T23:32:08Z", "type": "commit"}, {"oid": "400ce45943df176353fca6aabb583ea2087f2fc7", "url": "https://github.com/NationalSecurityAgency/datawave/commit/400ce45943df176353fca6aabb583ea2087f2fc7", "message": "Merge branch 'release/version3.2' into active-query-log", "committedDate": "2021-03-02T21:39:52Z", "type": "commit"}]}