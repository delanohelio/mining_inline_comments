{"pr_number": 789, "pr_title": "fixes #750 Re-enable AuditBean in Embedded, Filter out shaded guava c\u2026", "pr_createdAt": "2020-03-23T14:17:31Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/789", "timeline": [{"oid": "1dc424506498cddc3ccdbba84104e502fdb3da79", "url": "https://github.com/NationalSecurityAgency/datawave/commit/1dc424506498cddc3ccdbba84104e502fdb3da79", "message": "fixes #750 Re-enable AuditBean in Embedded, Filter out shaded guava classes from jboss-client.jar while writing to job distributed cache", "committedDate": "2020-03-20T21:01:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxOTcxNw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/789#discussion_r396519717", "bodyText": "Not required, but you can simplify this quite a bit with streams...\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    boolean include = true;\n          \n          \n            \n                                    Iterator<Pattern> patternItr = patterns.iterator();\n          \n          \n            \n                                    while (patternItr.hasNext() && include == true) {\n          \n          \n            \n                                        Pattern p = patternItr.next();\n          \n          \n            \n                                        if (p.matcher(zipEntry.getName()).matches()) {\n          \n          \n            \n                                            include = false;\n          \n          \n            \n                                        }\n          \n          \n            \n                                    }\n          \n          \n            \n                                    if (include) {\n          \n          \n            \n                                    final String entryName = zipEntry.getName();\n          \n          \n            \n                                    if (patterns.stream().noneMatch(p -> p.matcher(entryName).matches())) {", "author": "brianloss", "createdAt": "2020-03-23T15:04:53Z", "path": "web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/MapReduceJobConfiguration.java", "diffHunk": "@@ -302,6 +316,40 @@ protected void prepareClasspath(String jobId, Job job, Path jobDir) throws Excep\n         exportSystemProperties(jobId, job, fs, classpath);\n     }\n     \n+    private File filterJar(File source, List<Pattern> patterns) {\n+        File f = null;\n+        try {\n+            f = File.createTempFile(source.getName() + \".\", \"\");\n+            try (FileOutputStream fos = new FileOutputStream(f); ZipOutputStream zipOutputStream = new ZipOutputStream(fos)) {\n+                try (ZipInputStream zipInputStream = new ZipInputStream(new FileInputStream(source))) {\n+                    for (ZipEntry zipEntry = zipInputStream.getNextEntry(); zipEntry != null; zipEntry = zipInputStream.getNextEntry()) {\n+                        boolean include = true;\n+                        Iterator<Pattern> patternItr = patterns.iterator();\n+                        while (patternItr.hasNext() && include == true) {\n+                            Pattern p = patternItr.next();\n+                            if (p.matcher(zipEntry.getName()).matches()) {\n+                                include = false;\n+                            }\n+                        }\n+                        if (include) {", "originalCommit": "1dc424506498cddc3ccdbba84104e502fdb3da79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTk5OQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/789#discussion_r396521999", "bodyText": "Another way...\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        byte[] buffer = new byte[2048];\n          \n          \n            \n                                        int len;\n          \n          \n            \n                                        while ((len = zipInputStream.read(buffer)) > 0) {\n          \n          \n            \n                                            zipOutputStream.write(buffer, 0, len);\n          \n          \n            \n                                        }\n          \n          \n            \n                                        ByteStreams.copy(zipInputStream, zipOutputStream);", "author": "brianloss", "createdAt": "2020-03-23T15:08:03Z", "path": "web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/MapReduceJobConfiguration.java", "diffHunk": "@@ -302,6 +316,40 @@ protected void prepareClasspath(String jobId, Job job, Path jobDir) throws Excep\n         exportSystemProperties(jobId, job, fs, classpath);\n     }\n     \n+    private File filterJar(File source, List<Pattern> patterns) {\n+        File f = null;\n+        try {\n+            f = File.createTempFile(source.getName() + \".\", \"\");\n+            try (FileOutputStream fos = new FileOutputStream(f); ZipOutputStream zipOutputStream = new ZipOutputStream(fos)) {\n+                try (ZipInputStream zipInputStream = new ZipInputStream(new FileInputStream(source))) {\n+                    for (ZipEntry zipEntry = zipInputStream.getNextEntry(); zipEntry != null; zipEntry = zipInputStream.getNextEntry()) {\n+                        boolean include = true;\n+                        Iterator<Pattern> patternItr = patterns.iterator();\n+                        while (patternItr.hasNext() && include == true) {\n+                            Pattern p = patternItr.next();\n+                            if (p.matcher(zipEntry.getName()).matches()) {\n+                                include = false;\n+                            }\n+                        }\n+                        if (include) {\n+                            zipOutputStream.putNextEntry(zipEntry);\n+                            byte[] buffer = new byte[2048];\n+                            int len;\n+                            while ((len = zipInputStream.read(buffer)) > 0) {\n+                                zipOutputStream.write(buffer, 0, len);\n+                            }", "originalCommit": "1dc424506498cddc3ccdbba84104e502fdb3da79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3NDA4Ng==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/789#discussion_r396574086", "bodyText": "Thanks for the suggestions.  This way is much cleaner.  It took me a while to figure out the Zip(Input/Output)Stream semantics and I didn't circle back to clean it up.\nOh the irony that we are using a guava class in the wildfly jvm to remove the wildfly classes from a shaded jar.  I combined both suggestions and pushed a commit.", "author": "billoley", "createdAt": "2020-03-23T16:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3NDg2NQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/789#discussion_r396574865", "bodyText": "Figured you'd appreciate that. ;)", "author": "brianloss", "createdAt": "2020-03-23T16:15:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyMTk5OQ=="}], "type": "inlineReview"}, {"oid": "53bee4e8e0291ab1394996861c420d318244fde7", "url": "https://github.com/NationalSecurityAgency/datawave/commit/53bee4e8e0291ab1394996861c420d318244fde7", "message": "fixes #750 Simplify pattern interation and stream copy", "committedDate": "2020-03-23T16:11:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2NTA2NA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/789#discussion_r396765064", "bodyText": "ugh, but ok for now I guess....", "author": "ivakegg", "createdAt": "2020-03-23T21:22:57Z", "path": "web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/MapReduceJobConfiguration.java", "diffHunk": "@@ -284,7 +288,17 @@ protected void prepareClasspath(String jobId, Job job, Path jobDir) throws Excep\n         File[] jarFiles = libDir.listFiles(jarFilter);\n         if (jarFiles != null) {\n             for (File jar : jarFiles) {\n-                addSingleFile(jar, new Path(classpath, jar.getName()), jobId, job, fs);\n+                // remove guava classes from jboss-client.jar\n+                if (jar.getName().equals(\"jboss-client.jar\")) {\n+                    List<Pattern> patterns = new ArrayList<>();", "originalCommit": "53bee4e8e0291ab1394996861c420d318244fde7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc4Mjc2MQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/789#discussion_r396782761", "bodyText": "I know, but the alternative is storing a modified version of that file in our version control.  That's not great either.  The dependency is needed for our MapReduce jobs to run, but because of the inability to order the user classpath to the job we have to eliminate the newer guava classes that are shaded into that jar.\nI considered adding configuration to take care of this (which jar to transfer, which regexes to filter out).  I can do that later.  The java would be cleaner at least.   I ran out of time at the end of the week and this will work for now.", "author": "billoley", "createdAt": "2020-03-23T22:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2NTA2NA=="}], "type": "inlineReview"}]}