{"pr_number": 980, "pr_title": "Handle orphaned files from killed MapFileLoader (#740)", "pr_createdAt": "2020-10-30T16:10:11Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/980", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODAwMw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515298003", "bodyText": "Why not put this before the while loop and avoid the firstRun flag altogether?", "author": "ivakegg", "createdAt": "2020-10-30T18:24:11Z", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -433,9 +434,16 @@ public void run() {\n         int fsAccessFailures = 0;\n         Path[] jobDirectories = new Path[0];\n         int nextJobIndex = 0;\n+        boolean firstRun = true;\n+        \n         try {\n             while (true) {\n                 try {\n+                    if (firstRun) {\n+                        \n+                        cleanJobDirectoriesOnStartup();", "originalCommit": "6ea057db3db7f65f67a9a62225cb01269ffa5dea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMyNTQ5NA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515325494", "bodyText": "Why not, indeed.", "author": "hlgp", "createdAt": "2020-10-30T19:22:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5OTI2Ng==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515299266", "bodyText": "I realize that the markSourceFilesLoaded can supposedly be run by multiple instances concurrently, but how about the runCleanUpScript?  Since that is being passed in, I am thinking this could be a problem.", "author": "ivakegg", "createdAt": "2020-10-30T18:26:44Z", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -534,6 +542,18 @@ public void run() {\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);", "originalCommit": "6ea057db3db7f65f67a9a62225cb01269ffa5dea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM1NjY2Ng==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515356666", "bodyText": "We don't actually use this script option anywhere.  Might be an artifact from a bygone era.  Thinking to remove the logic and option for it since it seems hokey to call a bash script like this anyway. Thoughts?", "author": "hlgp", "createdAt": "2020-10-30T20:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5OTI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMzczNQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515303735", "bodyText": "I don't think this will work if the srcHdfs is different than the destHdfs, in which case the directory will have been discp'ed to the destHdfs prior to having been processed.  See the routine below that marks the directory for cleanup which works with the destHdfs.", "author": "ivakegg", "createdAt": "2020-10-30T18:35:45Z", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -534,6 +542,18 @@ public void run() {\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));", "originalCommit": "6ea057db3db7f65f67a9a62225cb01269ffa5dea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0OTk5Mw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515349993", "bodyText": "true!", "author": "hlgp", "createdAt": "2020-10-30T20:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMzczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk5MjcyNw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515992727", "bodyText": "Will this throw an exception if some other process already deleted the directory?", "author": "ivakegg", "createdAt": "2020-11-02T14:05:08Z", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -527,13 +524,26 @@ public void run() {\n                     log.error(\"Error: \" + e.getMessage(), e);\n                 }\n             }\n+        } catch (IOException e) {\n+            log.error(\"Error: \" + e.getMessage(), e);\n         } finally {\n             log.info(\"Shutting down executor service\");\n             executor.shutdown();\n         }\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(destHdfs, new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);\n+            getFileSystem(destHdfs).delete(cleanupDirectories[i], true);", "originalCommit": "ac7be3d5758029580ab66da649488efbc12e3134", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA3MjQxMA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r516072410", "bodyText": "Ah, you're right.  I'll adjust that try/catch", "author": "hlgp", "createdAt": "2020-11-02T15:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk5MjcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU2OTMwNw==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r520569307", "bodyText": "How do you know that is the reason for the IOException?  Perhaps the client could not reach the NN at the time or something else.  Include the message from the IOException as the reason.", "author": "ivakegg", "createdAt": "2020-11-10T13:41:23Z", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -527,13 +528,29 @@ public void run() {\n                     log.error(\"Error: \" + e.getMessage(), e);\n                 }\n             }\n+            \n         } finally {\n             log.info(\"Shutting down executor service\");\n             executor.shutdown();\n         }\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(destHdfs, new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);\n+            try {\n+                getFileSystem(destHdfs).delete(cleanupDirectories[i], true);\n+            } catch (IOException e) {\n+                log.warn(\"Unable to delete directory \" + cleanupDirectories[i] + \".  Another process already cleaned it up.\");", "originalCommit": "229a8eab5c6bf8717c5051d5066007abc29208cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NTQ2NA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r520885464", "bodyText": "updated.", "author": "hlgp", "createdAt": "2020-11-10T21:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU2OTMwNw=="}], "type": "inlineReview"}, {"oid": "75dfb7205a6338cf54125df550db7deb33809a64", "url": "https://github.com/NationalSecurityAgency/datawave/commit/75dfb7205a6338cf54125df550db7deb33809a64", "message": "Address #740 Handle orphaned files from killed MapFileLoader", "committedDate": "2020-11-10T21:58:06Z", "type": "commit"}, {"oid": "75dfb7205a6338cf54125df550db7deb33809a64", "url": "https://github.com/NationalSecurityAgency/datawave/commit/75dfb7205a6338cf54125df550db7deb33809a64", "message": "Address #740 Handle orphaned files from killed MapFileLoader", "committedDate": "2020-11-10T21:58:06Z", "type": "forcePushed"}]}