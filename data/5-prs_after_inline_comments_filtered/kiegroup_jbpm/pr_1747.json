{"pr_number": 1747, "pr_title": "[JBPM-9317] userTaskService.saveContent doesn't work", "pr_createdAt": "2020-08-31T10:04:28Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1747", "timeline": [{"oid": "6f5f68b0dc33e6221e1dd4a56b1daff515827bdc", "url": "https://github.com/kiegroup/jbpm/commit/6f5f68b0dc33e6221e1dd4a56b1daff515827bdc", "message": "[JBPM-9317] userTaskService.saveContent doesn't work", "committedDate": "2020-08-31T13:27:52Z", "type": "commit"}, {"oid": "6f5f68b0dc33e6221e1dd4a56b1daff515827bdc", "url": "https://github.com/kiegroup/jbpm/commit/6f5f68b0dc33e6221e1dd4a56b1daff515827bdc", "message": "[JBPM-9317] userTaskService.saveContent doesn't work", "committedDate": "2020-08-31T13:27:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyNzU0Nw==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480127547", "bodyText": "identityProvider may be null", "author": "afalhambra", "createdAt": "2020-08-31T13:22:52Z", "path": "jbpm-human-task/jbpm-human-task-core/src/main/java/org/jbpm/services/task/deadlines/notifications/impl/NotificationListenerManager.java", "diffHunk": "@@ -98,6 +101,16 @@ public void registerAdditionalNotificationListener(List<NotificationListener> ad\n     public List<NotificationListener> getNotificationListeners() {\n         return listeners;\n     }\n+\n+    public void broadcast(TaskContext taskContext, NotificationEvent event, UserInfo userInfo) {\n+        IdentityProvider identityProvider = (IdentityProvider) taskContext.get(EnvironmentName.IDENTITY_PROVIDER);\n+        identityProvider.setContextIdentity(System.getProperty(\"org.jbpm.ht.admin.user\", \"Administrator\"));", "originalCommit": "a6cdc965b937fc2bf7bc79905d41938163d6ddcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk0MDk0OA==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480940948", "bodyText": "done", "author": "elguardian", "createdAt": "2020-09-01T07:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyNzU0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNjk4MA==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480136980", "bodyText": "Shouldn't we check whether identity context is already set? And if so, skip this?\nOtherwise, we are always overriding identity context with property org.jbpm.ht.admin.user or Administrator (if empty).\nwdyt?", "author": "afalhambra", "createdAt": "2020-08-31T13:38:38Z", "path": "jbpm-human-task/jbpm-human-task-core/src/main/java/org/jbpm/services/task/deadlines/notifications/impl/NotificationListenerManager.java", "diffHunk": "@@ -98,6 +101,21 @@ public void registerAdditionalNotificationListener(List<NotificationListener> ad\n     public List<NotificationListener> getNotificationListeners() {\n         return listeners;\n     }\n+\n+    public void broadcast(TaskContext taskContext, NotificationEvent event, UserInfo userInfo) {\n+        IdentityProvider identityProvider = (IdentityProvider) taskContext.get(EnvironmentName.IDENTITY_PROVIDER);\n+        if(identityProvider != null) {\n+            identityProvider.setContextIdentity(System.getProperty(\"org.jbpm.ht.admin.user\", \"Administrator\"));", "originalCommit": "6f5f68b0dc33e6221e1dd4a56b1daff515827bdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk0NDIyNQ==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480944225", "bodyText": "The  problem here is those operations are not executed by anybody (deadlines and reminders so you need to set a context already(there is identity manager at runtime).\nDue to the nature of commands you don't know who is setting what so it is better to be safe than sorry here allowing a better check in the future. so you push the name and then you remove it from context identity at the end.\nI set the name because it does make more sense to me to put the task administrator. We could tie to another variable But I don't see it necessary. We always can change that. So yes in this case we are always overriding the context from an anonymous user to Administrator which is exactly the problem. Anonymous does not have permission to modify user tasks.", "author": "elguardian", "createdAt": "2020-09-01T07:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNjk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1MjU3Nw==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480952577", "bodyText": "thanks for clarifying", "author": "afalhambra", "createdAt": "2020-09-01T08:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNjk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNzY1Mw==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480137653", "bodyText": "Same as above, shouldn't we only remove when there is no identity context set other than the one we are setting in the above lines?\nwdyt?", "author": "afalhambra", "createdAt": "2020-08-31T13:39:48Z", "path": "jbpm-human-task/jbpm-human-task-core/src/main/java/org/jbpm/services/task/deadlines/notifications/impl/NotificationListenerManager.java", "diffHunk": "@@ -98,6 +101,21 @@ public void registerAdditionalNotificationListener(List<NotificationListener> ad\n     public List<NotificationListener> getNotificationListeners() {\n         return listeners;\n     }\n+\n+    public void broadcast(TaskContext taskContext, NotificationEvent event, UserInfo userInfo) {\n+        IdentityProvider identityProvider = (IdentityProvider) taskContext.get(EnvironmentName.IDENTITY_PROVIDER);\n+        if(identityProvider != null) {\n+            identityProvider.setContextIdentity(System.getProperty(\"org.jbpm.ht.admin.user\", \"Administrator\"));\n+        }\n+\n+        try {\n+            broadcast(event, userInfo);\n+        } finally {\n+            if(identityProvider != null) {\n+                identityProvider.removeContextIdentity();", "originalCommit": "6f5f68b0dc33e6221e1dd4a56b1daff515827bdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk0MTI4NQ==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480941285", "bodyText": "not really explained above.", "author": "elguardian", "createdAt": "2020-09-01T07:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNzY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk3MjE1Mg==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480972152", "bodyText": "import not used, remove it", "author": "gmunozfe", "createdAt": "2020-09-01T08:42:10Z", "path": "jbpm-human-task/jbpm-human-task-core/src/main/java/org/jbpm/services/task/commands/ExecuteReminderCommand.java", "diffHunk": "@@ -27,6 +27,7 @@\n import org.kie.api.task.model.Status;\n import org.kie.api.task.model.Task;\n import org.kie.api.task.model.TaskData;\n+import org.kie.internal.identity.IdentityProvider;", "originalCommit": "6f5f68b0dc33e6221e1dd4a56b1daff515827bdc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk3MzI5NQ==", "url": "https://github.com/kiegroup/jbpm/pull/1747#discussion_r480973295", "bodyText": "Add javadoc as method bellow", "author": "gmunozfe", "createdAt": "2020-09-01T08:43:59Z", "path": "jbpm-human-task/jbpm-human-task-core/src/main/java/org/jbpm/services/task/deadlines/notifications/impl/NotificationListenerManager.java", "diffHunk": "@@ -98,6 +101,21 @@ public void registerAdditionalNotificationListener(List<NotificationListener> ad\n     public List<NotificationListener> getNotificationListeners() {\n         return listeners;\n     }\n+\n+    public void broadcast(TaskContext taskContext, NotificationEvent event, UserInfo userInfo) {", "originalCommit": "6f5f68b0dc33e6221e1dd4a56b1daff515827bdc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}