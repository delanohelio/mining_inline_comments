{"pr_number": 1762, "pr_title": "[RPHAM-3106] Getting error then try to generate classes from WSDL file or URL", "pr_createdAt": "2020-09-28T15:36:44Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1762", "timeline": [{"oid": "d0a979b6ebfbbeaa6a287441d7333b0861ed9f9c", "url": "https://github.com/kiegroup/jbpm/commit/d0a979b6ebfbbeaa6a287441d7333b0861ed9f9c", "message": "[RPHAM-3106] Classloader hack\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-09-28T15:51:44Z", "type": "forcePushed"}, {"oid": "947c40855aeea7703267a5b0dd32b45f4dd3cd9f", "url": "https://github.com/kiegroup/jbpm/commit/947c40855aeea7703267a5b0dd32b45f4dd3cd9f", "message": "[RPHAM-3106] Classloader hack\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-09-28T15:52:03Z", "type": "forcePushed"}, {"oid": "430bce57594e509d3b2375714a495c86e709e99c", "url": "https://github.com/kiegroup/jbpm/commit/430bce57594e509d3b2375714a495c86e709e99c", "message": "[RPHAM-3106] Classloader hack\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-09-28T15:52:33Z", "type": "forcePushed"}, {"oid": "5956453ab2476ca4f137db535e016efdc7a9d48c", "url": "https://github.com/kiegroup/jbpm/commit/5956453ab2476ca4f137db535e016efdc7a9d48c", "message": "[RPHAM-3106] Getting error then try to generate classes from WSDL file\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-09-28T16:24:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ2MjgyNw==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r496462827", "bodyText": "bad naming. this is a classpath phisical location. hackUrls says very little.\nurlLocationClassPathLibs or so", "author": "elguardian", "createdAt": "2020-09-29T07:04:18Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +543,86 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating classpath\", e);\n+                }\n+            }\n+            parent = parent.getParent();\n+        } while (parent != null);\n+        if (!uris.isEmpty()) {\n+            cl = new CustomClassLoader(uris, cl);\n+        }\n+        return cl;\n+    }\n+\n+    private static class CustomClassLoader extends URLClassLoader {\n+\n+        private URL[] hackUrls;", "originalCommit": "5956453ab2476ca4f137db535e016efdc7a9d48c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUxNjI5NA==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r496516294", "bodyText": "yes, I changed to jarUrls, which is shorter that urlLocationClasspathLibs and more accurate than hackURLs", "author": "fjtirado", "createdAt": "2020-09-29T08:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ2MjgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ2MzI0OA==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r496463248", "bodyText": "says very little. You are bypassing the class loader problem of CXF. what about\nCXFJavaCompilerClassLoader or so ?", "author": "elguardian", "createdAt": "2020-09-29T07:05:06Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +543,86 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating classpath\", e);\n+                }\n+            }\n+            parent = parent.getParent();\n+        } while (parent != null);\n+        if (!uris.isEmpty()) {\n+            cl = new CustomClassLoader(uris, cl);\n+        }\n+        return cl;\n+    }\n+\n+    private static class CustomClassLoader extends URLClassLoader {", "originalCommit": "5956453ab2476ca4f137db535e016efdc7a9d48c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUxNTM3OA==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r496515378", "bodyText": "Thanks for the suggestion, I was unable to find a proper name ;)", "author": "fjtirado", "createdAt": "2020-09-29T08:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ2MzI0OA=="}], "type": "inlineReview"}, {"oid": "cd8b64189ff5afaeee9465bfd530b7669d8df7fa", "url": "https://github.com/kiegroup/jbpm/commit/cd8b64189ff5afaeee9465bfd530b7669d8df7fa", "message": "[RPHAM-3106] Getting error then try to generate classes from WSDL file\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-09-29T08:16:54Z", "type": "forcePushed"}, {"oid": "8a77c6bf014ff2e148d012b90802128034264457", "url": "https://github.com/kiegroup/jbpm/commit/8a77c6bf014ff2e148d012b90802128034264457", "message": "[RPHAM-3106] Getting error then try to generate classes from WSDL file\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-09-29T08:20:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1NzMyMA==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r497557320", "bodyText": "as getJarsFromModuleClassLoader method is only valid for ModuleClassLoader maybe it's worth to add this validation inside the method at the beginning and return if the condition is not met.\nBut just a suggestion only, as the method is private there is no really a need for that validation.", "author": "afalhambra", "createdAt": "2020-09-30T14:30:49Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +540,94 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        /* CXF builds compiler classpath assuming that the hierarchy of ClassLoader is composed of URLClassLoader instances.\n+         * Since ModuleClassLoader does not implement URLClassLoader, we need to provide an alternative way of retrieving these URLS\n+         * so CXF can build a proper classpath, avoiding the issue mentioned below. \n+         * @see https://issues.apache.org/jira/browse/CXF-7925\n+         */\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {", "originalCommit": "8a77c6bf014ff2e148d012b90802128034264457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzNjc0Mg==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498136742", "bodyText": "I prefer to reduce method invocations as possible.\nAlso, if in future we might support more classloaders we will extend that if statement here, so it makes sense to keep it where it is", "author": "fjtirado", "createdAt": "2020-10-01T10:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1NzMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE0MjMyOQ==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498142329", "bodyText": "we won't support any class loaders. This is a temporary solution that should go to some point to cxf so this will be lost at some point.", "author": "elguardian", "createdAt": "2020-10-01T10:28:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1NzMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1ODQ0Mg==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r497558442", "bodyText": "maybe we can log the exception also", "author": "afalhambra", "createdAt": "2020-09-30T14:32:12Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +540,94 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        /* CXF builds compiler classpath assuming that the hierarchy of ClassLoader is composed of URLClassLoader instances.\n+         * Since ModuleClassLoader does not implement URLClassLoader, we need to provide an alternative way of retrieving these URLS\n+         * so CXF can build a proper classpath, avoiding the issue mentioned below. \n+         * @see https://issues.apache.org/jira/browse/CXF-7925\n+         */\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating list of URLs from ModuleClassLoader\", e);", "originalCommit": "8a77c6bf014ff2e148d012b90802128034264457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzNzgyNw==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498137827", "bodyText": "There is not need to log (this is reponsibility of exceptin handler in upper layers) but it seems more correct to replace IllegalStateException by WorkItemRuntimeException", "author": "fjtirado", "createdAt": "2020-10-01T10:19:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1ODQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1OTQ0OA==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r497559448", "bodyText": "what if uris is empty? it could be a problem later on? what do you think?", "author": "afalhambra", "createdAt": "2020-09-30T14:33:30Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +540,94 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        /* CXF builds compiler classpath assuming that the hierarchy of ClassLoader is composed of URLClassLoader instances.\n+         * Since ModuleClassLoader does not implement URLClassLoader, we need to provide an alternative way of retrieving these URLS\n+         * so CXF can build a proper classpath, avoiding the issue mentioned below. \n+         * @see https://issues.apache.org/jira/browse/CXF-7925\n+         */\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating list of URLs from ModuleClassLoader\", e);\n+                }\n+            }\n+            parent = parent.getParent();\n+        } while (parent != null);\n+        if (!uris.isEmpty()) {\n+            cl = new CXFJavaCompileClassLoader(uris, cl);\n+        }", "originalCommit": "8a77c6bf014ff2e148d012b90802128034264457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzODIxNQ==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498138215", "bodyText": "if uris is empty, it means there are not ModuleClassLoader in hierarchy and we can safely use the \"standard\" classloader", "author": "fjtirado", "createdAt": "2020-10-01T10:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1OTQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MDM3Nw==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r497560377", "bodyText": "maybe it's worth logging the exception? or just a e.printStackTrace?", "author": "afalhambra", "createdAt": "2020-09-30T14:34:46Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +540,94 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        /* CXF builds compiler classpath assuming that the hierarchy of ClassLoader is composed of URLClassLoader instances.\n+         * Since ModuleClassLoader does not implement URLClassLoader, we need to provide an alternative way of retrieving these URLS\n+         * so CXF can build a proper classpath, avoiding the issue mentioned below. \n+         * @see https://issues.apache.org/jira/browse/CXF-7925\n+         */\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating list of URLs from ModuleClassLoader\", e);\n+                }\n+            }\n+            parent = parent.getParent();\n+        } while (parent != null);\n+        if (!uris.isEmpty()) {\n+            cl = new CXFJavaCompileClassLoader(uris, cl);\n+        }\n+        return cl;\n+    }\n+\n+    private static class CXFJavaCompileClassLoader extends URLClassLoader {\n+\n+        private URL[] jarUrls;\n+\n+        public CXFJavaCompileClassLoader(Collection<File> files, ClassLoader parent) {\n+            super(new URL[0], parent);\n+            // maybe it makes sense to filter only jaxb ones (there are 256 jars in kie-server)?\n+            this.jarUrls = files.stream().map(CXFJavaCompileClassLoader::toUrl).toArray(URL[]::new);\n+        }\n+        \n+        @Override\n+        public URL[] getURLs() {\n+            return jarUrls;\n+        }\n+\n+        private static URL toUrl(File file) {\n+            try {\n+                return file.toURI().toURL();\n+            } catch (MalformedURLException e) {\n+                throw new IllegalStateException(\"Problem converting file to URL: \"+file,e);", "originalCommit": "8a77c6bf014ff2e148d012b90802128034264457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzODMwOQ==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498138309", "bodyText": "same as above", "author": "fjtirado", "createdAt": "2020-10-01T10:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MDM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2NDI5MQ==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r497564291", "bodyText": "Just a question - I can't see why we need to go through all parents, is it really possible to have more than one ModuleClassLoader as a class loader parent?", "author": "afalhambra", "createdAt": "2020-09-30T14:39:44Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +540,94 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        /* CXF builds compiler classpath assuming that the hierarchy of ClassLoader is composed of URLClassLoader instances.\n+         * Since ModuleClassLoader does not implement URLClassLoader, we need to provide an alternative way of retrieving these URLS\n+         * so CXF can build a proper classpath, avoiding the issue mentioned below. \n+         * @see https://issues.apache.org/jira/browse/CXF-7925\n+         */\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating list of URLs from ModuleClassLoader\", e);\n+                }\n+            }\n+            parent = parent.getParent();\n+        } while (parent != null);", "originalCommit": "8a77c6bf014ff2e148d012b90802128034264457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzODY1Mw==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498138653", "bodyText": "we should not assume anything about classloader hierarchy, this code will be executed in other containers different than wildfly", "author": "fjtirado", "createdAt": "2020-10-01T10:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2NDI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE0MDg2OQ==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498140869", "bodyText": "Actually it is a bit more complex that that. you can have multiple parents in here. but this should be enough. We can argue that we should stopped looking after finding the wildfly module class loader. I leave that to QE to decide", "author": "elguardian", "createdAt": "2020-10-01T10:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2NDI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3MDcyNQ==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r497570725", "bodyText": "I would make this part of the java doc for this method.", "author": "afalhambra", "createdAt": "2020-09-30T14:47:47Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +540,94 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        /* CXF builds compiler classpath assuming that the hierarchy of ClassLoader is composed of URLClassLoader instances.\n+         * Since ModuleClassLoader does not implement URLClassLoader, we need to provide an alternative way of retrieving these URLS\n+         * so CXF can build a proper classpath, avoiding the issue mentioned below. \n+         * @see https://issues.apache.org/jira/browse/CXF-7925\n+         */\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating list of URLs from ModuleClassLoader\", e);\n+                }\n+            }\n+            parent = parent.getParent();\n+        } while (parent != null);\n+        if (!uris.isEmpty()) {\n+            cl = new CXFJavaCompileClassLoader(uris, cl);\n+        }\n+        return cl;\n+    }\n+\n+    private static class CXFJavaCompileClassLoader extends URLClassLoader {\n+\n+        private URL[] jarUrls;\n+\n+        public CXFJavaCompileClassLoader(Collection<File> files, ClassLoader parent) {\n+            super(new URL[0], parent);\n+            // maybe it makes sense to filter only jaxb ones (there are 256 jars in kie-server)?\n+            this.jarUrls = files.stream().map(CXFJavaCompileClassLoader::toUrl).toArray(URL[]::new);\n+        }\n+        \n+        @Override\n+        public URL[] getURLs() {\n+            return jarUrls;\n+        }\n+\n+        private static URL toUrl(File file) {\n+            try {\n+                return file.toURI().toURL();\n+            } catch (MalformedURLException e) {\n+                throw new IllegalStateException(\"Problem converting file to URL: \"+file,e);\n+            }\n         }\n+    }\n+\n+    private void getJarsFromModuleClassLoader(ClassLoader cl, Collection<File> collector) throws ReflectiveOperationException {\n+        /* This method makes assumptions over the internal structure of ModuleClassLoader. If this class is changed, this method\n+         * will need to change accordingly\n+         */", "originalCommit": "8a77c6bf014ff2e148d012b90802128034264457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzOTM4Nw==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498139387", "bodyText": "Implementation details should not be part of java doc, but this comment should be moved, as you said, before the method\nSee this old but still aplicable link https://www.oracle.com/technetwork/java/codeconventions-150003.pdf (section 5.1.1)", "author": "fjtirado", "createdAt": "2020-10-01T10:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3MDcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA0MzMxOQ==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498043319", "bodyText": "Maybe a more descriptive method name can be useful? something like getFieldObject?", "author": "afalhambra", "createdAt": "2020-10-01T07:39:59Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +540,94 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        /* CXF builds compiler classpath assuming that the hierarchy of ClassLoader is composed of URLClassLoader instances.\n+         * Since ModuleClassLoader does not implement URLClassLoader, we need to provide an alternative way of retrieving these URLS\n+         * so CXF can build a proper classpath, avoiding the issue mentioned below. \n+         * @see https://issues.apache.org/jira/browse/CXF-7925\n+         */\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating list of URLs from ModuleClassLoader\", e);\n+                }\n+            }\n+            parent = parent.getParent();\n+        } while (parent != null);\n+        if (!uris.isEmpty()) {\n+            cl = new CXFJavaCompileClassLoader(uris, cl);\n+        }\n+        return cl;\n+    }\n+\n+    private static class CXFJavaCompileClassLoader extends URLClassLoader {\n+\n+        private URL[] jarUrls;\n+\n+        public CXFJavaCompileClassLoader(Collection<File> files, ClassLoader parent) {\n+            super(new URL[0], parent);\n+            // maybe it makes sense to filter only jaxb ones (there are 256 jars in kie-server)?\n+            this.jarUrls = files.stream().map(CXFJavaCompileClassLoader::toUrl).toArray(URL[]::new);\n+        }\n+        \n+        @Override\n+        public URL[] getURLs() {\n+            return jarUrls;\n+        }\n+\n+        private static URL toUrl(File file) {\n+            try {\n+                return file.toURI().toURL();\n+            } catch (MalformedURLException e) {\n+                throw new IllegalStateException(\"Problem converting file to URL: \"+file,e);\n+            }\n         }\n+    }\n+\n+    private void getJarsFromModuleClassLoader(ClassLoader cl, Collection<File> collector) throws ReflectiveOperationException {\n+        /* This method makes assumptions over the internal structure of ModuleClassLoader. If this class is changed, this method\n+         * will need to change accordingly\n+         */\n+        AtomicReference paths = (AtomicReference) get(cl, \"paths\");\n+        Object sourceList = get(paths.get(), \"sourceList\");\n+        int size = Array.getLength(sourceList);\n+        Method getVFSResource = null;\n+        Method getPhysicalFile = null;\n+        Field rootField = null;\n+        Field rootNameField = null;\n+        for (int i = 0; i < size; i++) {\n+            Object resource = Array.get(sourceList, i);\n+            if (getVFSResource == null) {\n+                getVFSResource = resource.getClass().getDeclaredMethod(\"getResourceLoader\");\n+                getVFSResource.setAccessible(true);\n+            }\n+            resource = getVFSResource.invoke(resource);\n+            if (rootField == null) {\n+                Class<?> resourceClass = resource.getClass();\n+                rootField = resourceClass.getDeclaredField(\"root\");\n+                rootNameField = resourceClass.getDeclaredField(\"rootName\");\n+                rootField.setAccessible(true);\n+                rootNameField.setAccessible(true);\n+            }\n+            String rootName = (String) rootNameField.get(resource);\n+            if (rootName.endsWith(\"jar\")) {\n+                Object root = rootField.get(resource);\n+                if (getPhysicalFile == null) {\n+                    getPhysicalFile = root.getClass().getDeclaredMethod(\"getPhysicalFile\");\n+                    getPhysicalFile.setAccessible(true);\n+                }\n+                collector.add(new File(((File) getPhysicalFile.invoke(root)).getParentFile(), rootName));\n+            }\n+        }\n+    }\n \n-        return Thread.currentThread().getContextClassLoader();\n+    private Object get(Object container, String fieldName) throws NoSuchFieldException, IllegalAccessException {", "originalCommit": "8a77c6bf014ff2e148d012b90802128034264457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzOTUxMg==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498139512", "bodyText": "sure, will change", "author": "fjtirado", "createdAt": "2020-10-01T10:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA0MzMxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA0MzkwMw==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498043903", "bodyText": "Yep, as per comment, maybe it's worth filtering filenames with \"jaxb\"", "author": "afalhambra", "createdAt": "2020-10-01T07:41:02Z", "path": "jbpm-workitems/jbpm-workitems-webservice/src/main/java/org/jbpm/process/workitem/webservice/WebServiceWorkItemHandler.java", "diffHunk": "@@ -533,11 +540,94 @@ public void abortWorkItem(WorkItem workItem,\n     }\n \n     private ClassLoader getInternalClassLoader() {\n-        if (this.classLoader != null) {\n-            return this.classLoader;\n+        /* CXF builds compiler classpath assuming that the hierarchy of ClassLoader is composed of URLClassLoader instances.\n+         * Since ModuleClassLoader does not implement URLClassLoader, we need to provide an alternative way of retrieving these URLS\n+         * so CXF can build a proper classpath, avoiding the issue mentioned below. \n+         * @see https://issues.apache.org/jira/browse/CXF-7925\n+         */\n+        ClassLoader cl = this.classLoader != null ? classLoader : Thread.currentThread().getContextClassLoader(), parent = cl;\n+        Collection<File> uris = new HashSet<>();\n+        do {\n+            if (parent.getClass().getSimpleName().equals(\"ModuleClassLoader\")) {\n+                try {\n+                    getJarsFromModuleClassLoader(parent, uris);\n+                } catch (ReflectiveOperationException e) {\n+                    throw new IllegalStateException(\"Problem calculating list of URLs from ModuleClassLoader\", e);\n+                }\n+            }\n+            parent = parent.getParent();\n+        } while (parent != null);\n+        if (!uris.isEmpty()) {\n+            cl = new CXFJavaCompileClassLoader(uris, cl);\n+        }\n+        return cl;\n+    }\n+\n+    private static class CXFJavaCompileClassLoader extends URLClassLoader {\n+\n+        private URL[] jarUrls;\n+\n+        public CXFJavaCompileClassLoader(Collection<File> files, ClassLoader parent) {\n+            super(new URL[0], parent);\n+            // maybe it makes sense to filter only jaxb ones (there are 256 jars in kie-server)?\n+            this.jarUrls = files.stream().map(CXFJavaCompileClassLoader::toUrl).toArray(URL[]::new);", "originalCommit": "8a77c6bf014ff2e148d012b90802128034264457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE0MDA0OA==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498140048", "bodyText": "this is a comment to easily locate the piece of code to change if, in future, we need to generate a smaller classpath for compiler.", "author": "fjtirado", "createdAt": "2020-10-01T10:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA0MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE0MTQ0Ng==", "url": "https://github.com/kiegroup/jbpm/pull/1762#discussion_r498141446", "bodyText": "it should be all of them. That comment should be removed. Please try to avoid this sort of comments. If you want to point out something to reviewers just add a comment in github pull request.", "author": "elguardian", "createdAt": "2020-10-01T10:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA0MzkwMw=="}], "type": "inlineReview"}, {"oid": "3ad585817efe5240a98094ae66923504927fa1d4", "url": "https://github.com/kiegroup/jbpm/commit/3ad585817efe5240a98094ae66923504927fa1d4", "message": "[RPHAM-3106] Getting error then try to generate classes from WSDL file\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-10-01T10:33:45Z", "type": "forcePushed"}, {"oid": "fd33069d9989972800f5f18273f569511447d06b", "url": "https://github.com/kiegroup/jbpm/commit/fd33069d9989972800f5f18273f569511447d06b", "message": "[RPHAM-3106] Getting error then try to generate classes from WSDL file\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-10-01T18:09:38Z", "type": "commit"}, {"oid": "fd33069d9989972800f5f18273f569511447d06b", "url": "https://github.com/kiegroup/jbpm/commit/fd33069d9989972800f5f18273f569511447d06b", "message": "[RPHAM-3106] Getting error then try to generate classes from WSDL file\n\nGenerating custom class loader with list of jars in case\nModuleClassLoader is found in hierachy", "committedDate": "2020-10-01T18:09:38Z", "type": "forcePushed"}]}