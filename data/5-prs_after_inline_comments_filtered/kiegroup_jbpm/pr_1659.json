{"pr_number": 1659, "pr_title": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after", "pr_createdAt": "2020-05-22T16:42:41Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1659", "timeline": [{"oid": "e9ae966c2e7690646796c806bd45b12f1a341881", "url": "https://github.com/kiegroup/jbpm/commit/e9ae966c2e7690646796c806bd45b12f1a341881", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it when reopening.\n\nImplementation note. In order to not change existing interface, which I\nbelieve to be out of scope, the\nparameter to decide if ViolationException should be thrown or not is\nspecified inside the parameters map.", "committedDate": "2020-05-25T08:11:08Z", "type": "forcePushed"}, {"oid": "5c4ccd4102f105ba2f76ccbe83f34ea73b6b7bf0", "url": "https://github.com/kiegroup/jbpm/commit/5c4ccd4102f105ba2f76ccbe83f34ea73b6b7bf0", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it when reopening.\n\nImplementation note. In order to not change existing interface, which I\nbelieve to be out of scope, the\nparameter to decide if ViolationException should be thrown or not is\nspecified inside the parameters map.", "committedDate": "2020-05-25T10:50:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NDQzMg==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r429884432", "bodyText": "It should control also that variable has a previous value assigned which tries to be overwritten", "author": "gmunozfe", "createdAt": "2020-05-25T11:28:40Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -73,6 +74,15 @@ public Void execute(Context context) {\n         \n         KieSession ksession = ((RegistryContext) context).lookup( KieSession.class );\n         \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);\n+        VariableScope variableScope = (VariableScope) pi.getContextContainer().getDefaultContext(VariableScope.VARIABLE_SCOPE);\n+        \n+        for (String name: parameters.keySet())\n+        {\n+            if (variableScope.isReadOnly(VariableScope.CASE_FILE_PREFIX+name))", "originalCommit": "5c4ccd4102f105ba2f76ccbe83f34ea73b6b7bf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNzk4MQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r429927981", "bodyText": "Done", "author": "fjtirado", "createdAt": "2020-05-25T13:13:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NDQzMg=="}], "type": "inlineReview"}, {"oid": "da973012bc88cf9b75af3b8e355b71c5f019d048", "url": "https://github.com/kiegroup/jbpm/commit/da973012bc88cf9b75af3b8e355b71c5f019d048", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it when reopening.\n\nImplementation note. In order to not change existing interface, which I\nbelieve to be out of scope, the\nparameter to decide if ViolationException should be thrown or not is\nspecified inside the parameters map.", "committedDate": "2020-05-25T13:11:17Z", "type": "forcePushed"}, {"oid": "9afb2b3b05442e6db2a89d1feb6c2a0b57862309", "url": "https://github.com/kiegroup/jbpm/commit/9afb2b3b05442e6db2a89d1feb6c2a0b57862309", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it when reopening.\n\nImplementation note. In order to not change existing interface, which I\nbelieve to be out of scope, the\nparameter to decide if ViolationException should be thrown or not is\nspecified inside the parameters map.", "committedDate": "2020-05-25T15:40:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMyNDk5Ng==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r430324996", "bodyText": "I am not very convince about this.\nIf you are starting a case o restarting one to avoid any problem with variable you just need to check whether the oldValue and the newOne are the same instead of this. This will fix the issue regarding using the newCaseFileInstance + startCase... reopening will be more tricky as drools and facts are involved.", "author": "elguardian", "createdAt": "2020-05-26T10:52:46Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "diffHunk": "@@ -125,6 +123,7 @@ public void matchCreated(MatchCreatedEvent event) {\n         }\n         // set case id to allow it to use CaseContext when creating runtime engine\n         params.put(EnvironmentName.CASE_ID, caseId);\n+        params.put(VariableScope.FORCE_UPDATE, Boolean.TRUE);", "originalCommit": "9afb2b3b05442e6db2a89d1feb6c2a0b57862309", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ1NzQ1NA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r430457454", "bodyText": "Additional parameter has been removed.\nassuming assigment of equal object is not considered assigment, we can avoid it", "author": "fjtirado", "createdAt": "2020-05-26T14:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMyNDk5Ng=="}], "type": "inlineReview"}, {"oid": "7a47a0592c88a5a67a43c1619d2640f97b8ce1e0", "url": "https://github.com/kiegroup/jbpm/commit/7a47a0592c88a5a67a43c1619d2640f97b8ce1e0", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-05-26T14:22:29Z", "type": "forcePushed"}, {"oid": "18a0059edc966bae836522d2daf0a0767340d12a", "url": "https://github.com/kiegroup/jbpm/commit/18a0059edc966bae836522d2daf0a0767340d12a", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-05-27T22:27:47Z", "type": "forcePushed"}, {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02", "url": "https://github.com/kiegroup/jbpm/commit/03c7d3b0d82f470b8550181d8c15b17d34622d02", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-05-28T07:17:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTc0OQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432329749", "bodyText": "logic spreaded between VariableScopeInstance and here.", "author": "elguardian", "createdAt": "2020-05-29T08:20:53Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -85,6 +87,16 @@ public Void execute(Context context) {\n         \n         CaseEventSupport caseEventSupport = getCaseEventSupport(context);\n         caseEventSupport.fireBeforeCaseDataAdded(caseFile.getCaseId(), caseFile, caseFile.getDefinitionId(), parameters);\n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "originalCommit": "03c7d3b0d82f470b8550181d8c15b17d34622d02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1ODkwMQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432358901", "bodyText": "VariableScopeInstance is not really used in this scenario. Please check getVariable, which relies on CaseFileInnstan", "author": "fjtirado", "createdAt": "2020-05-29T09:15:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ0ODc1NQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432448755", "bodyText": "Code changed to reuse setVariable on VariableScopeInstance", "author": "fjtirado", "createdAt": "2020-05-29T12:26:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTg2OA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432329868", "bodyText": "logic spreaded between VariableScopeInstance and here.", "author": "elguardian", "createdAt": "2020-05-29T08:21:04Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -60,6 +64,17 @@ public Void execute(Context context) {\n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, variableNames);\n         \n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "originalCommit": "03c7d3b0d82f470b8550181d8c15b17d34622d02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1ODk2NQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432358965", "bodyText": "VariableScopeInstance is not really used in this scenario. Please check getVariable, which relies on CaseFileInnstan", "author": "fjtirado", "createdAt": "2020-05-29T09:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ0OTM2Ng==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432449366", "bodyText": "Remove logic is very particular of CaseFileInstance (the events published are specific), so there is not really logic spread besided the call to variableScopeInstance.isReadOnly, which I believe is probably fine.", "author": "fjtirado", "createdAt": "2020-05-29T12:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI0MDQ4Nw==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r435240487", "bodyText": "After some failed tests, I think the original code is good there, reusing VariableScopeInstance.setVariable cause case duplication because of the way the listeners are handled there.\nI do not think it is wise to change it more deeply.", "author": "fjtirado", "createdAt": "2020-06-04T13:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDE4MA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432330180", "bodyText": "why removed the check of null ?", "author": "elguardian", "createdAt": "2020-05-29T08:21:40Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/ReopenCaseCommand.java", "diffHunk": "@@ -78,29 +78,43 @@ public Void execute(Context context) {\n         \n         KieSession ksession = ((RegistryContext) context).lookup( KieSession.class );\n                                \n-        CaseFileInstance caseFile = getCaseFile(ksession, caseId);                        \n+        CaseFileInstance caseFile = getCaseFile(ksession, caseId);     \n         \n         caseEventSupport.fireBeforeCaseReopened(caseId, caseFile, deploymentId, caseDefinitionId, data);\n         \n         logger.debug(\"Updating case file in working memory\");\n         FactHandle factHandle = ksession.getFactHandle(caseFile);\n-        ((CaseFileInstanceImpl)caseFile).setCaseReopenDate(new Date());\n-        if (data != null && !data.isEmpty()) {\n-            caseFile.addAll(data);\n-        }\n         ksession.update(factHandle, caseFile);\n         \n         logger.debug(\"Starting process instance for case {} and case definition {}\", caseId, caseDefinitionId);\n         CorrelationKey correlationKey = correlationKeyFactory.newCorrelationKey(caseId);\n         Map<String, Object> params = new HashMap<>();\n         // set case id to allow it to use CaseContext when creating runtime engine\n         params.put(EnvironmentName.CASE_ID, caseId);\n+        final Map<String, Object> caseData = caseFile.getData();\n+        \n+        \n+        for (Map.Entry<String, Object> entry : caseData.entrySet()) {\n+            params.put(VariableScope.CASE_FILE_PREFIX + entry.getKey(), entry.getValue());\n+        }\n+        \n+        if (data != null)   {\n+            for (Map.Entry<String, Object> entry : data.entrySet()) {\n+                params.put(VariableScope.CASE_FILE_PREFIX + entry.getKey(), entry.getValue());\n+            }\n+        }\n+\n         long processInstanceId = processService.startProcess(deploymentId, caseDefinitionId, correlationKey, params);\n+        \n+        ((CaseFileInstanceImpl)caseFile).setCaseReopenDate(new Date());\n+        if (data != null) {\n+            caseFile.addAll(data);\n+        }\n+        \n         logger.debug(\"Removing case file from working memory to allow refiring of rules...\");\n         ksession.delete(factHandle);\n         ksession.insert(caseFile);\n-        final Map<String, Object> caseData = caseFile.getData();\n-        if (caseData != null && !caseData.isEmpty()) {\n+        if (!caseData.isEmpty()) {", "originalCommit": "03c7d3b0d82f470b8550181d8c15b17d34622d02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1NjEzOQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432356139", "bodyText": "because it was unneded and reported as a code smell", "author": "fjtirado", "createdAt": "2020-05-29T09:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDUwNQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432330505", "bodyText": "unneeded", "author": "elguardian", "createdAt": "2020-05-29T08:22:15Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "diffHunk": "@@ -112,10 +111,7 @@ public void matchCreated(MatchCreatedEvent event) {\n         });\n         commands.add(commandsFactory.newInsert(caseFile));\n         commands.add(commandsFactory.newFireAllRules());\n-\n-        BatchExecutionCommand batch = commandsFactory.newBatchExecution(commands);\n-        processService.execute(deploymentId, CaseContext.get(caseId), batch);\n-\n+        processService.execute(deploymentId, CaseContext.get(caseId), commandsFactory.newBatchExecution(commands));", "originalCommit": "03c7d3b0d82f470b8550181d8c15b17d34622d02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyMTk2NA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432421964", "bodyText": "what was unnededed is the definition of a variable which is used in one place, this is an improvement of previous code and should stay", "author": "fjtirado", "createdAt": "2020-05-29T11:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDUwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNjMzMQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432426331", "bodyText": "Change rolled back", "author": "fjtirado", "createdAt": "2020-05-29T11:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDczNw==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432330737", "bodyText": "unneeded", "author": "elguardian", "createdAt": "2020-05-29T08:22:40Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/model/instance/CaseFileInstanceImpl.java", "diffHunk": "@@ -113,7 +113,7 @@ public Date getCaseEndDate() {\n \n     @Override\n     public Map<String, Object> getData() {\n-        return this.data;\n+        return Collections.unmodifiableMap(this.data);", "originalCommit": "03c7d3b0d82f470b8550181d8c15b17d34622d02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1Njg4MA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432356880", "bodyText": "this is to prevent a backdoor update of the intenal map, it should stay to make the solution more robust", "author": "fjtirado", "createdAt": "2020-05-29T09:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNjU0Mg==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432426542", "bodyText": "Change rolled back. Althoung theoretically correct, making the  map unmodifiable is potentially harmful for existing clients", "author": "fjtirado", "createdAt": "2020-05-29T11:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTQwOA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432331408", "bodyText": "this will required a full downstream compilation at least. Commands are sensitive. @gmunozfe", "author": "elguardian", "createdAt": "2020-05-29T08:23:54Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -40,9 +42,11 @@\n \n     private List<String> variableNames;\n     private AuthorizationManager authorizationManager;\n+    private Long processInstanceId;\n     \n-    public RemoveDataCaseFileInstanceCommand(IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                \n+    public RemoveDataCaseFileInstanceCommand(Long processInstanceId, IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                ", "originalCommit": "03c7d3b0d82f470b8550181d8c15b17d34622d02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1NzQxNQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432357415", "bodyText": "this is the only way I found to access variable readonly definition in RemoveDataCaseFileInstace. Lets do the full downstream compilation", "author": "fjtirado", "createdAt": "2020-05-29T09:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTQwOA=="}], "type": "inlineReview"}, {"oid": "9681fd1d6f0629d72d9404b8758885f964e46f65", "url": "https://github.com/kiegroup/jbpm/commit/9681fd1d6f0629d72d9404b8758885f964e46f65", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-05-29T12:26:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUzMTA0NQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432531045", "bodyText": "It doesn't match with the file name (case sensitive)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    processes.add(\"cases/UserTaskCaseReadOnlyCaseFileItem.bpmn2\");\n          \n          \n            \n                    processes.add(\"cases/UserTaskCaseReadonlyCaseFileItem.bpmn2\");\n          \n      \n    \n    \n  \n\nor change the file name.", "author": "gmunozfe", "createdAt": "2020-05-29T14:37:51Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/test/java/org/jbpm/casemgmt/impl/CaseServiceImplTest.java", "diffHunk": "@@ -146,6 +146,7 @@\n         processes.add(\"cases/UserTaskCaseRequiredCaseFileItem.bpmn2\");\n         processes.add(\"cases/UserTaskCaseRestrictedCaseFileItem.bpmn2\");\n         processes.add(\"cases/UserTaskCaseRequiredRestrictedCaseFileItem.bpmn2\");\n+        processes.add(\"cases/UserTaskCaseReadOnlyCaseFileItem.bpmn2\");", "originalCommit": "9681fd1d6f0629d72d9404b8758885f964e46f65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4MTYwNA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432581604", "bodyText": "file name changed", "author": "fjtirado", "createdAt": "2020-05-29T15:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUzMTA0NQ=="}], "type": "inlineReview"}, {"oid": "b880fb224049023d0482c6526139448cf0f0fc3d", "url": "https://github.com/kiegroup/jbpm/commit/b880fb224049023d0482c6526139448cf0f0fc3d", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-05-29T14:44:58Z", "type": "forcePushed"}, {"oid": "65ac5110b5635cf545564f9b948a6de61af0922e", "url": "https://github.com/kiegroup/jbpm/commit/65ac5110b5635cf545564f9b948a6de61af0922e", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-06-04T09:01:43Z", "type": "forcePushed"}, {"oid": "cf8f5cb5c26a1065f472b9d957ae5e6c438ddd10", "url": "https://github.com/kiegroup/jbpm/commit/cf8f5cb5c26a1065f472b9d957ae5e6c438ddd10", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-06-04T12:58:35Z", "type": "forcePushed"}, {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21", "url": "https://github.com/kiegroup/jbpm/commit/2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-06-08T15:11:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyMTU5Mg==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440821592", "bodyText": "Can you clarify it here, please? So VariableScopeInstance.setVariable calls fire methods which we don't want to call, so we use this approach?", "author": "MarianMacik", "createdAt": "2020-06-16T12:47:06Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -81,6 +82,16 @@ public Void execute(Context context) {\n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, parameters.keySet());\n         \n+        // check read only variables, due to dependencies between firexxxCaseData methods, we need this logic here, we cannot reuse VariableScopeInstance.setVariable", "originalCommit": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3Mjg4OA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440972888", "bodyText": "Yes, after trying to modify original code to call setVariable instance and centralize some logic, some test were failing because the trigger call needs to be invoked at a very specific moment of time (or the case will be added twice), so I was adding that comment to avoid the temptation to do the same change in the future", "author": "fjtirado", "createdAt": "2020-06-16T16:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyMTU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwNTk3MA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440905970", "bodyText": "Any reason why this was removed?", "author": "MarianMacik", "createdAt": "2020-06-16T14:42:38Z", "path": "jbpm-test-coverage/src/main/java/org/jbpm/test/entity/MedicalRecord.java", "diffHunk": "@@ -110,9 +110,6 @@ public boolean equals(Object obj) {\n         if ((this.description == null) ? (other.description != null) : !this.description.equals(other.description)) {\n             return false;\n         }\n-        if (this.patient != other.patient && (this.patient == null || !this.patient.equals(other.patient))) {\n-            return false;\n-        }", "originalCommit": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3MTYxOA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440971618", "bodyText": "This was changed to avoid a circular dependency between equals that causes StackOverflowException", "author": "fjtirado", "createdAt": "2020-06-16T16:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwNTk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNTkyOQ==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440925929", "bodyText": "In theory somebody can be already using that via ProcessService to be run as a separate command, so we can break backward compatibility, but if there is no other way, it is ok from my side.", "author": "MarianMacik", "createdAt": "2020-06-16T15:08:19Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -40,9 +42,11 @@\n \n     private List<String> variableNames;\n     private AuthorizationManager authorizationManager;\n+    private Long processInstanceId;\n     \n-    public RemoveDataCaseFileInstanceCommand(IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                \n+    public RemoveDataCaseFileInstanceCommand(Long processInstanceId, IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                ", "originalCommit": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3Mzg4Nw==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440973887", "bodyText": "Im aware of the potential backward compatiiliry problem, but I cannot find other way, processInstanceId is needed to check the readonly flag (and now both command constructors, add and remove data case are symetrical)", "author": "fjtirado", "createdAt": "2020-06-16T16:12:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNTkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNjY1OA==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440926658", "bodyText": "Maybe use the same message as in VariableScopeInstance?\nthrow new VariableViolationException(getProcessInstance().getId(), name, \"Variable '\" + name + \"' is already set and is marked as read only\");", "author": "MarianMacik", "createdAt": "2020-06-16T15:09:20Z", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -59,7 +63,15 @@ public Void execute(Context context) {\n         \n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, variableNames);\n-        \n+          \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);\n+        VariableScope variableScope = (VariableScope) pi.getContextContainer().getDefaultContext(VariableScope.VARIABLE_SCOPE);\n+        for (String name: variableNames) {\n+            if (caseFile.getData(name) != null && variableScope.isReadOnly(VariableScope.CASE_FILE_PREFIX+name)) {\n+                throw new VariableViolationException(pi.getId(), name,\"variable is read only and cannot be removed\");", "originalCommit": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3NDk2Ng==", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440974966", "bodyText": "Changed", "author": "fjtirado", "createdAt": "2020-06-16T16:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNjY1OA=="}], "type": "inlineReview"}, {"oid": "74156c2b50141d04a3986b4b67e42d57507bbd32", "url": "https://github.com/kiegroup/jbpm/commit/74156c2b50141d04a3986b4b67e42d57507bbd32", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-06-16T16:15:59Z", "type": "commit"}, {"oid": "74156c2b50141d04a3986b4b67e42d57507bbd32", "url": "https://github.com/kiegroup/jbpm/commit/74156c2b50141d04a3986b4b67e42d57507bbd32", "message": "[JBPM-9097] Case variable: \"readonly\" tag permits changing value after\n\nNow it is possible to assign a value to a case property when the\nprocess is created, but a ViolationException will be thrown if trying\nto update it with a different value when reopening.", "committedDate": "2020-06-16T16:15:59Z", "type": "forcePushed"}]}