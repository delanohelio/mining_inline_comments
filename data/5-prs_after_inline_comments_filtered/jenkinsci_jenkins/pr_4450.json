{"pr_number": 4450, "pr_title": "[JENKINS-51856] Add new Jenkins initialization milestones: SYSTEM_CONFIG_LOADED, SYSTEM_CONFIG_ADAPTED, JOB_CONFIG_ADAPTED", "pr_createdAt": "2020-01-23T13:24:03Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4450", "timeline": [{"oid": "adfa0a9a7fd4fa800cee95f6b08ee3c847be7804", "url": "https://github.com/jenkinsci/jenkins/commit/adfa0a9a7fd4fa800cee95f6b08ee3c847be7804", "message": "[JENKINS-51856] Add new milestones", "committedDate": "2020-01-23T11:30:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEyNjAxOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370126018", "bodyText": "\"... all the system configuration ...\", to make sure this does not involve jobs", "author": "olivergondza", "createdAt": "2020-01-23T13:48:43Z", "path": "core/src/main/java/hudson/init/InitMilestone.java", "diffHunk": "@@ -82,13 +85,29 @@\n      * By this milestone, all programmatically constructed extension point implementations\n      * should be added.\n      */\n-    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"), // TODO nothing attains() this so when does it actually happen?\n+    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"),\n+\n+    /**\n+     * By this milestone, all the configurations are loaded from file system", "originalCommit": "adfa0a9a7fd4fa800cee95f6b08ee3c847be7804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUxNTUxOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370515518", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * By this milestone, all the configurations are loaded from file system\n          \n          \n            \n                 * By this milestone, all the system configurations are loaded from file system", "author": "fcojfernandez", "createdAt": "2020-01-24T08:22:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEyNjAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEyNjgyNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370126825", "bodyText": "OT but since we are touching this, do we want to make sure / document groovy init hooks are called here?", "author": "olivergondza", "createdAt": "2020-01-23T13:50:08Z", "path": "core/src/main/java/hudson/init/InitMilestone.java", "diffHunk": "@@ -82,13 +85,29 @@\n      * By this milestone, all programmatically constructed extension point implementations\n      * should be added.\n      */\n-    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"), // TODO nothing attains() this so when does it actually happen?\n+    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"),\n+\n+    /**\n+     * By this milestone, all the configurations are loaded from file system\n+     */\n+    SYSTEM_CONFIG_LOADED(\"System config loaded\"),\n+\n+    /**\n+     * By this milestone, the system configuration is adapted just in case any plugin (CasC might be an example) needs\n+     * to update configuration files\n+     */\n+    SYSTEM_CONFIG_ADAPTED(\"System config adapted\"),", "originalCommit": "adfa0a9a7fd4fa800cee95f6b08ee3c847be7804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEyNzQxNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370127417", "bodyText": "Disregard, I see you did that. Great", "author": "olivergondza", "createdAt": "2020-01-23T13:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEyNjgyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzOTQ0Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370239447", "bodyText": "Later we can introduce more Goorvy hooks if needed (e.g. before the jobs load)", "author": "oleg-nenashev", "createdAt": "2020-01-23T16:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEyNjgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NzAyOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370147028", "bodyText": "The wording here is a little confusing just in case any plugin is updated doesn't really state an example that would make it obvious to the reader", "author": "res0nance", "createdAt": "2020-01-23T14:25:38Z", "path": "core/src/main/java/hudson/init/InitMilestone.java", "diffHunk": "@@ -82,13 +85,29 @@\n      * By this milestone, all programmatically constructed extension point implementations\n      * should be added.\n      */\n-    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"), // TODO nothing attains() this so when does it actually happen?\n+    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"),\n+\n+    /**\n+     * By this milestone, all the configurations are loaded from file system\n+     */\n+    SYSTEM_CONFIG_LOADED(\"System config loaded\"),\n+\n+    /**\n+     * By this milestone, the system configuration is adapted just in case any plugin (CasC might be an example) needs\n+     * to update configuration files\n+     */\n+    SYSTEM_CONFIG_ADAPTED(\"System config adapted\"),\n \n     /**\n      * By this milestone, all jobs and their build records are loaded from disk.\n      */\n     JOB_LOADED(\"Loaded all jobs\"),\n \n+    /**\n+     * By this milestone, any job configuration is adapted or updated just in case any plugin is updated", "originalCommit": "adfa0a9a7fd4fa800cee95f6b08ee3c847be7804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUxNjUxMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370516513", "bodyText": "@res0nance what about this?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * By this milestone, any job configuration is adapted or updated just in case any plugin is updated\n          \n          \n            \n                 * By this milestone, any job configuration is adapted or updated just in case any plugin needs update former/old configurations or init scripts", "author": "fcojfernandez", "createdAt": "2020-01-24T08:25:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NzAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5NzIzOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370597238", "bodyText": "Should be needs to update. Other than that, I think its a lot more clear why this milestone exists \ud83d\udc4d", "author": "res0nance", "createdAt": "2020-01-24T11:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE0NzAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxMTM3Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370211376", "bodyText": "Maybe I'm missing something, where is it added to the lifecycle?", "author": "MRamonLeon", "createdAt": "2020-01-23T16:09:07Z", "path": "core/src/main/java/hudson/init/InitMilestone.java", "diffHunk": "@@ -43,7 +43,10 @@\n  *  <li>PLUGINS_PREPARED\n  *  <li>PLUGINS_STARTED\n  *  <li>EXTENSIONS_AUGMENTED\n+ *  <li>SYSTEM_CONFIG_LOADED</li>\n+ *  <li>SYSTEM_CONFIG_ADAPTED</li>", "originalCommit": "adfa0a9a7fd4fa800cee95f6b08ee3c847be7804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI3Mjg1Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370272856", "bodyText": "I was wondering the same thing \ud83e\udd14", "author": "jetersen", "createdAt": "2020-01-23T18:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxMTM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUxNTMwOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r370515309", "bodyText": "If I understand correctly the magic inside Jenkins, it's added in the same way as EXTENSION_AUGMENTED, which is never attained directly:\n\n  \n    \n      jenkins/core/src/main/java/jenkins/model/Jenkins.java\n    \n    \n        Lines 965 to 970\n      in\n      30dbf72\n    \n    \n    \n    \n\n        \n          \n           // initialization consists of ... \n        \n\n        \n          \n           executeReactor( is, \n        \n\n        \n          \n                   pluginManager.initTasks(is),    // loading and preparing plugins \n        \n\n        \n          \n                   loadTasks(),                    // load jobs \n        \n\n        \n          \n                   InitMilestone.ordering()        // forced ordering among key milestones \n        \n\n        \n          \n           ); \n        \n    \n  \n\n\n(thanks @jtnord for the hit)", "author": "fcojfernandez", "createdAt": "2020-01-24T08:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxMTM3Ng=="}], "type": "inlineReview"}, {"oid": "c22de096fbc377113130ea932a9e9fccd83ee335", "url": "https://github.com/jenkinsci/jenkins/commit/c22de096fbc377113130ea932a9e9fccd83ee335", "message": "Apply suggestions from code review", "committedDate": "2020-01-24T10:45:35Z", "type": "commit"}, {"oid": "f79828ffaafcadc0e0abd206ee98b15e555af3ef", "url": "https://github.com/jenkinsci/jenkins/commit/f79828ffaafcadc0e0abd206ee98b15e555af3ef", "message": "Merge branch 'master' into JENKINS-51856", "committedDate": "2020-01-24T10:48:13Z", "type": "commit"}, {"oid": "3f3ed71bfcc855341138de08fa6369a8e474e9fb", "url": "https://github.com/jenkinsci/jenkins/commit/3f3ed71bfcc855341138de08fa6369a8e474e9fb", "message": "[JENKINS-51856] Improve description of JOB_CONFIG_ADAPTED", "committedDate": "2020-01-27T11:07:46Z", "type": "commit"}, {"oid": "1d4d313890a3f1ea4c989719e44fbf0bf17d22f5", "url": "https://github.com/jenkinsci/jenkins/commit/1d4d313890a3f1ea4c989719e44fbf0bf17d22f5", "message": "[JENKINS-51856] Add test for milestones", "committedDate": "2020-01-27T11:08:40Z", "type": "commit"}, {"oid": "b406701cd2df0bc19b8dfbb349116c1418621b8e", "url": "https://github.com/jenkinsci/jenkins/commit/b406701cd2df0bc19b8dfbb349116c1418621b8e", "message": "[JENKINS-51856] Fix test error", "committedDate": "2020-01-27T13:21:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjYwMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r373826603", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 */\n          \n          \n            \n                 * @since TODO\n          \n          \n            \n                 */\n          \n      \n    \n    \n  \n\nHere and below", "author": "oleg-nenashev", "createdAt": "2020-02-02T07:53:14Z", "path": "core/src/main/java/hudson/init/InitMilestone.java", "diffHunk": "@@ -82,13 +85,29 @@\n      * By this milestone, all programmatically constructed extension point implementations\n      * should be added.\n      */\n-    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"), // TODO nothing attains() this so when does it actually happen?\n+    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"),\n+\n+    /**\n+     * By this milestone, all the system configurations are loaded from file system\n+     */", "originalCommit": "b406701cd2df0bc19b8dfbb349116c1418621b8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjcyNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r373826726", "bodyText": "It is a risk, because Groovy hooks may be used to adapt Job confis as well. So one must NOT rely on all jobs are adapted at this point, unless we redesign how Groovy hooks operate and introduce new calls there\nI suggest adding disclaimers to Javadoc and documenting this case.\nReverting this change could be also an option to discuss", "author": "oleg-nenashev", "createdAt": "2020-02-02T07:55:56Z", "path": "core/src/main/java/hudson/init/impl/GroovyInitScript.java", "diffHunk": "@@ -36,7 +36,7 @@\n  * @author Kohsuke Kawaguchi\n  */\n public class GroovyInitScript {\n-    @Initializer(after=JOB_LOADED)\n+    @Initializer(after=JOB_CONFIG_ADAPTED)", "originalCommit": "b406701cd2df0bc19b8dfbb349116c1418621b8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk4MDcwNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r373980705", "bodyText": "Reverting this change could be also an option to discuss\n\n@oleg-nenashev do you mean reverting this concrete change or not adding this JOB_CONFIG_ADAPTED milestone?", "author": "fcojfernandez", "createdAt": "2020-02-03T08:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE5MjQ3OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r375192479", "bodyText": "This concrete one", "author": "oleg-nenashev", "createdAt": "2020-02-05T11:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE5MzAyMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r375193022", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Initializer(after=JOB_CONFIG_ADAPTED)\n          \n          \n            \n                @Initializer(after=JOB_LOADED)", "author": "timja", "createdAt": "2020-02-05T11:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwNTAzNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r375205037", "bodyText": "Seeing it's risky, I agree", "author": "fcojfernandez", "createdAt": "2020-02-05T11:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk3OTQ5Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r373979496", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 */\n          \n          \n            \n                 * @since TODO\n          \n          \n            \n                 */", "author": "fcojfernandez", "createdAt": "2020-02-03T08:50:19Z", "path": "core/src/main/java/hudson/init/InitMilestone.java", "diffHunk": "@@ -82,13 +85,29 @@\n      * By this milestone, all programmatically constructed extension point implementations\n      * should be added.\n      */\n-    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"), // TODO nothing attains() this so when does it actually happen?\n+    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"),\n+\n+    /**\n+     * By this milestone, all the system configurations are loaded from file system\n+     */\n+    SYSTEM_CONFIG_LOADED(\"System config loaded\"),\n+\n+    /**\n+     * By this milestone, the system configuration is adapted just in case any plugin (CasC might be an example) needs\n+     * to update configuration files\n+     */", "originalCommit": "b406701cd2df0bc19b8dfbb349116c1418621b8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk3OTU2OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4450#discussion_r373979569", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 */\n          \n          \n            \n                 * @since TODO\n          \n          \n            \n                 */", "author": "fcojfernandez", "createdAt": "2020-02-03T08:50:31Z", "path": "core/src/main/java/hudson/init/InitMilestone.java", "diffHunk": "@@ -82,13 +85,29 @@\n      * By this milestone, all programmatically constructed extension point implementations\n      * should be added.\n      */\n-    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"), // TODO nothing attains() this so when does it actually happen?\n+    EXTENSIONS_AUGMENTED(\"Augmented all extensions\"),\n+\n+    /**\n+     * By this milestone, all the system configurations are loaded from file system\n+     */\n+    SYSTEM_CONFIG_LOADED(\"System config loaded\"),\n+\n+    /**\n+     * By this milestone, the system configuration is adapted just in case any plugin (CasC might be an example) needs\n+     * to update configuration files\n+     */\n+    SYSTEM_CONFIG_ADAPTED(\"System config adapted\"),\n \n     /**\n      * By this milestone, all jobs and their build records are loaded from disk.\n      */\n     JOB_LOADED(\"Loaded all jobs\"),\n \n+    /**\n+     * By this milestone, any job configuration is adapted or updated just in case any plugin needs to update former/old configurations or init scripts\n+     */", "originalCommit": "b406701cd2df0bc19b8dfbb349116c1418621b8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0b8462e148f63294bbedbcdaf124567d21ec1d08", "url": "https://github.com/jenkinsci/jenkins/commit/0b8462e148f63294bbedbcdaf124567d21ec1d08", "message": "Apply suggestions from code review\n\nCo-Authored-By: Oleg Nenashev <o.v.nenashev@gmail.com>", "committedDate": "2020-02-03T08:58:42Z", "type": "commit"}, {"oid": "ab12f71a48901ab3b78521382057a03e166fe668", "url": "https://github.com/jenkinsci/jenkins/commit/ab12f71a48901ab3b78521382057a03e166fe668", "message": "Update core/src/main/java/hudson/init/impl/GroovyInitScript.java\n\nCo-Authored-By: Tim Jacomb <t.jacomb@kainos.com>", "committedDate": "2020-02-05T11:36:01Z", "type": "commit"}]}