{"pr_number": 4442, "pr_title": "[JENKINS-60848] Improve RSS title wording + Add more RSS tests", "pr_createdAt": "2020-01-20T21:58:12Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4442", "timeline": [{"oid": "3ff813649621cd536b48965d8fe112e91fde65ba", "url": "https://github.com/jenkinsci/jenkins/commit/3ff813649621cd536b48965d8fe112e91fde65ba", "message": "Add more tests.\n\nAlso a little cleanup of RSS.\nFix the broken \"All all ...\" title and description.\nRemove a long unused bit for never implemented trackback.", "committedDate": "2020-01-20T21:51:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkxNTc0MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r368915740", "bodyText": "Fix the broken \"All all ...\" title\n\nNot sure it's a bug as the default view is called \"All\", as the code adds \"all builds\" as it's the option chosen for RSS (compared to \"failed builds\"). I would say it's an improvement, if desired.\n\"if desired\" => we are not correcting the behavior here, just hiding the symptom. For example, in french, the default view is called \"Tous\" (= All in english), and the RSS will have as title and description: \"Tous all builds\". Perhaps a \"better\" way to change this is to just put a \":\", like All: all builds.\nSecond thoughts: after having seen the rssHeader.jelly, I am convinced we need to change the behavior, but not in the way proposed.", "author": "Wadeck", "createdAt": "2020-01-21T10:19:12Z", "path": "core/src/main/java/hudson/model/RSS.java", "diffHunk": "@@ -75,7 +56,14 @@ public static void doTrackback( Object it, StaplerRequest req, StaplerResponse r\n      */\n     public static <E> void forwardToRss(String title, String url, Collection<? extends E> entries, FeedAdapter<E> adapter, StaplerRequest req, HttpServletResponse rsp) throws IOException, ServletException {\n         req.setAttribute(\"adapter\",adapter);\n-        req.setAttribute(\"title\",title);\n+        String fixedTitle = title;\n+        String brokenFragment = \"All all \";\n+        if (title.startsWith(brokenFragment)) {\n+            StringBuilder fixing = new StringBuilder(\"All \");\n+            fixing.append(title.substring(brokenFragment.length()));\n+            fixedTitle = fixing.toString();\n+        }\n+        req.setAttribute(\"title\",fixedTitle);", "originalCommit": "3ff813649621cd536b48965d8fe112e91fde65ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1NTMwNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r369255304", "bodyText": "What's your proposal here Wadeck? \"All all builds\" is pretty bad.", "author": "jeffret-b", "createdAt": "2020-01-21T21:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkxNTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1ODI5NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r369258294", "bodyText": "Here's what it looks like in Thunderbird:\n\nIt doesn't make much sense to separate this fix out, though changing the title is better and it probably needs a ticket filed.", "author": "jeffret-b", "createdAt": "2020-01-21T21:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkxNTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxMDg4MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r369410881", "bodyText": "As the RSS titles are potentially more debatable, I am in favor of separating the addition of test and the change on the title / description.\nThe proposal would be to just apply the same naming as in the header => Jenkins:all (all builds)", "author": "Wadeck", "createdAt": "2020-01-22T07:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkxNTc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzNzA3Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r368937076", "bodyText": "\u274c Does not cover the regression corrected by #4148. The \"published\" was empty and so, is still not null.", "author": "Wadeck", "createdAt": "2020-01-21T11:02:54Z", "path": "test/src/test/java/hudson/model/RSSTest.java", "diffHunk": "@@ -63,16 +64,89 @@ public void absoluteURLsPresentInRSS_evenWithoutRootUrlSetup() throws Exception\n         assertAllRSSLinksContainRootUrl(allLinks);\n     }\n \n-    private XmlPage getRssAllPage() throws Exception {\n-        return (XmlPage) j.createWebClient().goTo(\"rssAll?flavor=rss20\", \"text/xml\");\n+    @Test\n+    public void checkInitialContentAllRss() throws Exception {\n+        XmlPage page = getRssAllPage();\n+        Document xmlDocument = page.getXmlDocument();\n+        Element documentElement = xmlDocument.getDocumentElement();\n+        assertThat(documentElement.getNodeName(), is(\"rss\"));\n+        assertThat(documentElement.getAttribute(\"version\"), is(\"2.0\"));\n+        assertThat(documentElement.getChildNodes().getLength(), is(1));\n+        Node channelNode = documentElement.getFirstChild();\n+        assertThat(channelNode.getNodeName(), is(\"channel\"));\n+        checkRssBasicNodes(channelNode, \"All builds\", 3);\n     }\n \n-    private void assertAllRSSLinksContainRootUrl(NodeList allLinks) throws Exception {\n-        for (int i = 0; i < allLinks.getLength(); i++) {\n-            Node item = allLinks.item(i);\n-            String url = item.getTextContent();\n-            assertThat(url, containsString(j.getURL().toString()));\n-        }\n+    @Test\n+    public void checkInitialContentFailedRss() throws Exception {\n+        XmlPage page = (XmlPage) j.createWebClient().goTo(\"rssFailed?flavor=rss20\", \"text/xml\");\n+        Document xmlDocument = page.getXmlDocument();\n+        Element documentElement = xmlDocument.getDocumentElement();\n+        assertThat(documentElement.getNodeName(), is(\"rss\"));\n+        assertThat(documentElement.getAttribute(\"version\"), is(\"2.0\"));\n+        assertThat(documentElement.getChildNodes().getLength(), is(1));\n+        Node channelNode = documentElement.getFirstChild();\n+        assertThat(channelNode.getNodeName(), is(\"channel\"));\n+        checkRssBasicNodes(channelNode, \"All failed builds\", 3);\n+    }\n+\n+    @Test\n+    public void checkInitialContentAllAtom() throws Exception {\n+        XmlPage page = getRssAllAtomPage();\n+        Document xmlDocument = page.getXmlDocument();\n+        Element documentElement = xmlDocument.getDocumentElement();\n+        assertThat(documentElement.getNodeName(), is(\"feed\"));\n+        checkAtomBasicNodes(documentElement, \"All builds\", 5);\n+    }\n+\n+    @Test\n+    public void checkWithSingleBuildAllRss() throws Exception {\n+        FreeStyleProject p = j.createFreeStyleProject();\n+        j.assertBuildStatusSuccess(p.scheduleBuild2(0));\n+\n+        XmlPage page = getRssAllPage();\n+        Document xmlDocument = page.getXmlDocument();\n+        Element documentElement = xmlDocument.getDocumentElement();\n+        assertThat(documentElement.getNodeName(), is(\"rss\"));\n+        assertThat(documentElement.getAttribute(\"version\"), is(\"2.0\"));\n+        assertThat(documentElement.getChildNodes().getLength(), is(1));\n+        Node channelNode = documentElement.getFirstChild();\n+        assertThat(channelNode.getNodeName(), is(\"channel\"));\n+        checkRssBasicNodes(channelNode, \"All builds\", 4);\n+        NodeList items = xmlDocument.getElementsByTagName(\"item\");\n+        assertThat(items.getLength(), is(1));\n+        Node firstBuild = items.item(0);\n+        assertThat(firstBuild.getChildNodes().getLength(), is(5));\n+        assertThat(getSingleNode(firstBuild, \"title\").getTextContent(), is(\"test0 #1 (stable)\"));\n+        assertNotNull(getSingleNode(firstBuild, \"pubDate\").getTextContent());\n+        assertNotNull(getSingleNode(firstBuild, \"author\").getTextContent());\n+        Node guidNode = getSingleNode(firstBuild, \"guid\");\n+        assertThat(guidNode.getAttributes().getNamedItem(\"isPermaLink\").getTextContent(), is(\"false\"));\n+        assertNotNull(guidNode.getTextContent());\n+    }\n+\n+    @Test\n+    public void checkWithSingleBuildAllAtom() throws Exception {\n+        FreeStyleProject p = j.createFreeStyleProject();\n+        j.assertBuildStatusSuccess(p.scheduleBuild2(0));\n+\n+        XmlPage page = getRssAllAtomPage();\n+        Document xmlDocument = page.getXmlDocument();\n+        Element documentElement = xmlDocument.getDocumentElement();\n+        assertThat(documentElement.getNodeName(), is(\"feed\"));\n+        checkAtomBasicNodes(documentElement, \"All builds\", 6);\n+        NodeList entries = xmlDocument.getElementsByTagName(\"entry\");\n+        assertThat(entries.getLength(), is(1));\n+        Node firstBuild = entries.item(0);\n+        assertThat(firstBuild.getChildNodes().getLength(), is(5));\n+        assertThat(getSingleNode(firstBuild, \"title\").getTextContent(), is(\"test0 #1 (stable)\"));\n+        assertNotNull(getSingleNode(firstBuild, \"published\").getTextContent());", "originalCommit": "3ff813649621cd536b48965d8fe112e91fde65ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4MDEwNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r369280106", "bodyText": "Added checks to validate the dates. There are advantages and disadvantages to canned data. It can mask or complicate other things. There isn't any real need for canned data here.", "author": "jeffret-b", "createdAt": "2020-01-21T22:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzNzA3Ng=="}], "type": "inlineReview"}, {"oid": "0244339945447207df3007ff313a8452b010f4e0", "url": "https://github.com/jenkinsci/jenkins/commit/0244339945447207df3007ff313a8452b010f4e0", "message": "Increase date time checks.", "committedDate": "2020-01-21T22:25:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQyMTE5NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r369421194", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Date date = formatter.parse(\"Sat, 24 Apr 2010 14:01:00 GMT\");\n          \n          \n            \n                    Date date = formatter.parse(pubDate);\n          \n      \n    \n    \n  \n\nOtherwise the test does not test what you want.\nAdditionnally, the parse will throw an exception if the date is not parseable, so the assertNotNull does not provide any value except confusion.", "author": "Wadeck", "createdAt": "2020-01-22T08:24:16Z", "path": "test/src/test/java/hudson/model/RSSTest.java", "diffHunk": "@@ -135,6 +201,86 @@ public void latestBuilds() throws Exception {\n         assertEquals(6, allLinks.getLength());\n     }\n \n+    private void checkRssBasicNodes(Node channelNode, String expectedTitle, int expectedNodes) throws IOException {\n+        assertThat(channelNode.getChildNodes().getLength(), is(expectedNodes));\n+        assertThat(getSingleNode(channelNode, \"link\").getTextContent(), is(j.getURL().toString()));\n+        assertThat(getSingleNode(channelNode, \"description\").getTextContent(), is(expectedTitle));\n+        assertThat(getSingleNode(channelNode, \"title\").getTextContent(), is(expectedTitle));\n+    }\n+\n+    private void checkAtomBasicNodes(Node feedNode, String expectedTitle, int expectedNodes) throws IOException {\n+        assertThat(feedNode.getChildNodes().getLength(), is(expectedNodes));\n+        Node linkNode = getSingleNode(feedNode, \"link\");\n+        assertThat(linkNode.getAttributes().getNamedItem(\"rel\").getTextContent(), is(\"alternate\"));\n+        assertThat(linkNode.getAttributes().getNamedItem(\"type\").getTextContent(), is(\"text/html\"));\n+        assertThat(linkNode.getAttributes().getNamedItem(\"href\").getTextContent(), is(j.getURL().toString()));\n+        assertNotNull(getSingleNode(feedNode, \"updated\"));\n+        assertThat(getSingleNode(feedNode, \"title\").getTextContent(), is(expectedTitle));\n+        Node authorNode = getSingleNode(feedNode, \"author\");\n+        NodeList authorNodes = authorNode.getChildNodes();\n+        assertThat(authorNodes.getLength(), is(1));\n+        Node nameNode = authorNodes.item(0);\n+        assertThat(nameNode.getTextContent(), is(\"Jenkins Server\"));\n+        Node idNode = getSingleNode(feedNode, \"id\");\n+        assertFalse(idNode.getTextContent().isEmpty());\n+    }\n+\n+    private Node getSingleNode(Node parentNode, String nodeName) {\n+        Node childNode = null;\n+        NodeList childNodes = parentNode.getChildNodes();\n+        for (int i = 0; i < childNodes.getLength(); i++) {\n+            if (childNodes.item(i).getNodeName().equals(nodeName)) {\n+                if (childNode == null) {\n+                    childNode = childNodes.item(i);\n+                } else {\n+                    fail(\"Too many children.\");\n+                }\n+            }\n+        }\n+        return childNode;\n+    }\n+\n+    private void checkRssTimeNode(Node firstBuild, String nodeName) throws ParseException {\n+        String pubDate = getSingleNode(firstBuild, nodeName).getTextContent();\n+        assertNotNull(pubDate);\n+        DateFormat formatter = new SimpleDateFormat(\"EEE, dd MMM yyyy HH:mm:ss zzz\");\n+        Date date = formatter.parse(\"Sat, 24 Apr 2010 14:01:00 GMT\");", "originalCommit": "0244339945447207df3007ff313a8452b010f4e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcxMDE2Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r369710167", "bodyText": "I tried with and without. It felt kind of weird and more confusing to have it there without any assertion.", "author": "jeffret-b", "createdAt": "2020-01-22T17:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQyMTE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQyNTgwOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r369425808", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertNotNull(pubDate);\n          \n          \n            \n                    assertThat(pubDate, not(emptyString()));\n          \n      \n    \n    \n  \n\ngetTextContent never returns null. If the node does not exist, it's an NPE before the method being called.\nThat also prevent the next suggestion to not throw an exception if the string is empty.", "author": "Wadeck", "createdAt": "2020-01-22T08:35:52Z", "path": "test/src/test/java/hudson/model/RSSTest.java", "diffHunk": "@@ -135,6 +201,86 @@ public void latestBuilds() throws Exception {\n         assertEquals(6, allLinks.getLength());\n     }\n \n+    private void checkRssBasicNodes(Node channelNode, String expectedTitle, int expectedNodes) throws IOException {\n+        assertThat(channelNode.getChildNodes().getLength(), is(expectedNodes));\n+        assertThat(getSingleNode(channelNode, \"link\").getTextContent(), is(j.getURL().toString()));\n+        assertThat(getSingleNode(channelNode, \"description\").getTextContent(), is(expectedTitle));\n+        assertThat(getSingleNode(channelNode, \"title\").getTextContent(), is(expectedTitle));\n+    }\n+\n+    private void checkAtomBasicNodes(Node feedNode, String expectedTitle, int expectedNodes) throws IOException {\n+        assertThat(feedNode.getChildNodes().getLength(), is(expectedNodes));\n+        Node linkNode = getSingleNode(feedNode, \"link\");\n+        assertThat(linkNode.getAttributes().getNamedItem(\"rel\").getTextContent(), is(\"alternate\"));\n+        assertThat(linkNode.getAttributes().getNamedItem(\"type\").getTextContent(), is(\"text/html\"));\n+        assertThat(linkNode.getAttributes().getNamedItem(\"href\").getTextContent(), is(j.getURL().toString()));\n+        assertNotNull(getSingleNode(feedNode, \"updated\"));\n+        assertThat(getSingleNode(feedNode, \"title\").getTextContent(), is(expectedTitle));\n+        Node authorNode = getSingleNode(feedNode, \"author\");\n+        NodeList authorNodes = authorNode.getChildNodes();\n+        assertThat(authorNodes.getLength(), is(1));\n+        Node nameNode = authorNodes.item(0);\n+        assertThat(nameNode.getTextContent(), is(\"Jenkins Server\"));\n+        Node idNode = getSingleNode(feedNode, \"id\");\n+        assertFalse(idNode.getTextContent().isEmpty());\n+    }\n+\n+    private Node getSingleNode(Node parentNode, String nodeName) {\n+        Node childNode = null;\n+        NodeList childNodes = parentNode.getChildNodes();\n+        for (int i = 0; i < childNodes.getLength(); i++) {\n+            if (childNodes.item(i).getNodeName().equals(nodeName)) {\n+                if (childNode == null) {\n+                    childNode = childNodes.item(i);\n+                } else {\n+                    fail(\"Too many children.\");\n+                }\n+            }\n+        }\n+        return childNode;\n+    }\n+\n+    private void checkRssTimeNode(Node firstBuild, String nodeName) throws ParseException {\n+        String pubDate = getSingleNode(firstBuild, nodeName).getTextContent();\n+        assertNotNull(pubDate);", "originalCommit": "0244339945447207df3007ff313a8452b010f4e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "618604ed4e3f60a8574d21201d1bfabd54236baa", "url": "https://github.com/jenkinsci/jenkins/commit/618604ed4e3f60a8574d21201d1bfabd54236baa", "message": "Copy and paste error.\n\nCo-Authored-By: Wadeck Follonier <Wadeck@users.noreply.github.com>", "committedDate": "2020-01-22T17:47:23Z", "type": "commit"}, {"oid": "d65241e9103cea418ea09a25126fcfc7b45b32bd", "url": "https://github.com/jenkinsci/jenkins/commit/d65241e9103cea418ea09a25126fcfc7b45b32bd", "message": "Assert not empty.\n\nCo-Authored-By: Wadeck Follonier <Wadeck@users.noreply.github.com>", "committedDate": "2020-01-22T17:50:58Z", "type": "commit"}, {"oid": "f379a9a7f41d83135898de043e5eac9e538c2561", "url": "https://github.com/jenkinsci/jenkins/commit/f379a9a7f41d83135898de043e5eac9e538c2561", "message": "Add a bunch more tests and clarify title.\n\nAdd a number of more tests. Test the various places that RSS is used.\nImprove title wording to something consistent and somewhat sensible.", "committedDate": "2020-01-23T21:12:18Z", "type": "commit"}, {"oid": "12aaaee183a7c20c6e5632f7e8967e5dea4c3990", "url": "https://github.com/jenkinsci/jenkins/commit/12aaaee183a7c20c6e5632f7e8967e5dea4c3990", "message": "Merge branch 'rssTestCoverage' of github.com:jeffret-b/jenkins into rssTestCoverage", "committedDate": "2020-01-23T21:13:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyNzg5OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4442#discussion_r375227898", "bodyText": "I was unable to find any usages, but it would be great to have some binary compatibility analysis when such changes are submitted. Also not sure why it needs to be renamed", "author": "oleg-nenashev", "createdAt": "2020-02-05T12:31:14Z", "path": "core/src/main/java/hudson/model/RSS.java", "diffHunk": "@@ -42,25 +41,6 @@\n  */\n public final class RSS {\n \n-    /**\n-     * Parses trackback ping.\n-     */\n-    public static void doTrackback( Object it, StaplerRequest req, StaplerResponse rsp ) throws IOException, ServletException {", "originalCommit": "12aaaee183a7c20c6e5632f7e8967e5dea4c3990", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}