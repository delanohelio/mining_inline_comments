{"pr_number": 4596, "pr_title": "[JENKINS-61409] Websockets: Use AbstractByteBufferCommandTransport to transport messages", "pr_createdAt": "2020-03-20T12:19:14Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4596", "timeline": [{"oid": "4e30b7f8b324c0b5b546790aaba6ccf2d1be49ea", "url": "https://github.com/jenkinsci/jenkins/commit/4e30b7f8b324c0b5b546790aaba6ccf2d1be49ea", "message": "[JENKINS-61409] Websockets: Use AbstractByteBufferCommandTransport to transport messages", "committedDate": "2020-03-20T12:17:16Z", "type": "commit"}, {"oid": "3b4b245151c4e44a278d705f13315cb7240d7411", "url": "https://github.com/jenkinsci/jenkins/commit/3b4b245151c4e44a278d705f13315cb7240d7411", "message": "Depend on timestamped snapshot since incrementals is broken", "committedDate": "2020-03-20T13:19:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMTYwNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r395811607", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        } catch (IOException e) {\n          \n          \n            \n                            error(e);\n          \n          \n            \n                        } catch (InterruptedException e) {\n          \n          \n            \n                        } catch (IOException | InterruptedException e) {", "author": "jglick", "createdAt": "2020-03-20T18:13:05Z", "path": "core/src/main/java/jenkins/agents/WebSocketAgents.java", "diffHunk": "@@ -128,18 +127,20 @@ protected void opened() {\n         @Override\n         protected void binary(byte[] payload, int offset, int len) {\n             LOGGER.finest(() -> \"reading block of length \" + len + \" from \" + agent);\n-            if (offset == 0 && len == payload.length) {\n-                receiver.handle(payload);\n-            } else {\n-                receiver.handle(Arrays.copyOfRange(payload, offset, offset + len));\n+            try {\n+                transport.receive(ByteBuffer.wrap(payload, offset, len));\n+            } catch (IOException e) {\n+                error(e);\n+            } catch (InterruptedException e) {", "originalCommit": "3b4b245151c4e44a278d705f13315cb7240d7411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMTc5Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r395811797", "bodyText": "Can we keep logging?", "author": "jglick", "createdAt": "2020-03-20T18:13:26Z", "path": "core/src/main/java/jenkins/agents/WebSocketAgents.java", "diffHunk": "@@ -149,22 +150,12 @@ protected void error(Throwable cause) {\n             LOGGER.log(Level.WARNING, null, cause);\n         }\n \n-        class Transport extends AbstractByteArrayCommandTransport {\n+        class Transport extends AbstractByteBufferCommandTransport {\n \n             @Override\n-            public void setup(AbstractByteArrayCommandTransport.ByteArrayReceiver bar) {\n-                receiver = bar;\n-            }\n-\n-            @Override\n-            public void writeBlock(Channel chnl, byte[] bytes) throws IOException {\n-                LOGGER.finest(() -> \"writing block of length \" + bytes.length + \" to \" + agent);", "originalCommit": "3b4b245151c4e44a278d705f13315cb7240d7411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMjQ1MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r395812450", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            sendBinary(header);\n          \n          \n            \n                            sendBinary(data);\n          \n          \n            \n                            sendBinary(header, false);\n          \n          \n            \n                            sendBinary(data, true);\n          \n      \n    \n    \n  \n\nif WebSocketSession is extended in the obvious way", "author": "jglick", "createdAt": "2020-03-20T18:14:38Z", "path": "core/src/main/java/jenkins/agents/WebSocketAgents.java", "diffHunk": "@@ -149,22 +150,12 @@ protected void error(Throwable cause) {\n             LOGGER.log(Level.WARNING, null, cause);\n         }\n \n-        class Transport extends AbstractByteArrayCommandTransport {\n+        class Transport extends AbstractByteBufferCommandTransport {\n \n             @Override\n-            public void setup(AbstractByteArrayCommandTransport.ByteArrayReceiver bar) {\n-                receiver = bar;\n-            }\n-\n-            @Override\n-            public void writeBlock(Channel chnl, byte[] bytes) throws IOException {\n-                LOGGER.finest(() -> \"writing block of length \" + bytes.length + \" to \" + agent);\n-                try {\n-                    sendBinary(ByteBuffer.wrap(bytes)).get();\n-                } catch (Exception x) {\n-                    x.printStackTrace();\n-                    throw new IOException(x);\n-                }\n+            protected void write(ByteBuffer header, ByteBuffer data) throws IOException {\n+                sendBinary(header);\n+                sendBinary(data);", "originalCommit": "3b4b245151c4e44a278d705f13315cb7240d7411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMzI5MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r395813291", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        p.getBuildersList().add(Functions.isWindows() ? new BatchFile(\"echo hello\") : new Shell(\"dd if=/dev/random of=file.txt count=1024 bs=200;cat file.txt\"));\n          \n          \n            \n                        p.getBuildersList().add(Functions.isWindows() ? new BatchFile(\"echo hello\") : new Shell(\"dd if=/dev/random count=1024 bs=200\"));", "author": "jglick", "createdAt": "2020-03-20T18:16:13Z", "path": "test/src/test/java/jenkins/agents/WebSocketAgentsTest.java", "diffHunk": "@@ -99,9 +100,10 @@ public void smokes() throws Exception {\n             ).stdout(System.out).start());\n             r.waitOnline(s);\n             assertEquals(\"response\", s.getChannel().call(new DummyTask()));\n+            assertNotNull(s.getChannel().call(new FatTask()));\n             FreeStyleProject p = r.createFreeStyleProject();\n             p.setAssignedNode(s);\n-            p.getBuildersList().add(Functions.isWindows() ? new BatchFile(\"echo hello\") : new Shell(\"echo hello\"));\n+            p.getBuildersList().add(Functions.isWindows() ? new BatchFile(\"echo hello\") : new Shell(\"dd if=/dev/random of=file.txt count=1024 bs=200;cat file.txt\"));", "originalCommit": "3b4b245151c4e44a278d705f13315cb7240d7411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMzkxOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r395813918", "bodyText": "This should suffice to reproduce on its own (both directions), without the dd, right?", "author": "jglick", "createdAt": "2020-03-20T18:17:30Z", "path": "test/src/test/java/jenkins/agents/WebSocketAgentsTest.java", "diffHunk": "@@ -122,4 +124,18 @@ public String call() {\n         }\n     }\n \n+    private static class FatTask extends SlaveToMasterCallable<String, RuntimeException> {", "originalCommit": "3b4b245151c4e44a278d705f13315cb7240d7411", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NTk2Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r396285963", "bodyText": "Yes, though it doesn't seem to exercize the same code path, as the dd was working even before I did any change.", "author": "Vlatombe", "createdAt": "2020-03-23T08:42:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMzkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQxMTM0MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r396411340", "bodyText": "Possibly due to line-oriented output? Try excluding newline characters using tr or whatever.", "author": "jglick", "createdAt": "2020-03-23T12:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMzkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MjkxNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r396482914", "bodyText": "For freestyle, output seems to be buffered in 8k blocks, due to usage of \n  \n    \n      jenkins/core/src/main/java/hudson/util/StreamCopyThread.java\n    \n    \n         Line 58\n      in\n      a21f83f\n    \n    \n    \n    \n\n        \n          \n           byte[] buf = new byte[8192];", "author": "Vlatombe", "createdAt": "2020-03-23T14:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMzkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4NjIyNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r396486227", "bodyText": "Ah OK. So some remote operations involving lots of data would be affected, others would not, and there is no way to tell which other than reading the code or inserting debug traces.", "author": "jglick", "createdAt": "2020-03-23T14:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMzkxOA=="}], "type": "inlineReview"}, {"oid": "a7f17f2be87b5d5851f128ca24fb4b897f968313", "url": "https://github.com/jenkinsci/jenkins/commit/a7f17f2be87b5d5851f128ca24fb4b897f968313", "message": "Fix reviews", "committedDate": "2020-03-23T08:36:03Z", "type": "commit"}, {"oid": "5ba8c8a9e591a02d73506062a45a521e9badea2f", "url": "https://github.com/jenkinsci/jenkins/commit/5ba8c8a9e591a02d73506062a45a521e9badea2f", "message": "Update snapshot dep", "committedDate": "2020-03-23T08:36:12Z", "type": "commit"}, {"oid": "e57ed6368b0036275c5392b2bc8ffbbf4c3cd4f7", "url": "https://github.com/jenkinsci/jenkins/commit/e57ed6368b0036275c5392b2bc8ffbbf4c3cd4f7", "message": "Print directly", "committedDate": "2020-03-23T08:41:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4OTA4Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r396489083", "bodyText": "Note that unlike the existing overload, this is blocking. Maybe OK in this context.", "author": "jglick", "createdAt": "2020-03-23T14:24:38Z", "path": "core/src/main/java/jenkins/websocket/WebSocketSession.java", "diffHunk": "@@ -130,6 +131,15 @@ protected void text(String message) {\n         }\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    protected final void sendBinary(ByteBuffer partialByte, boolean isLast) {\n+        try {\n+            remoteEndpoint.getClass().getMethod(\"sendPartialBytes\", ByteBuffer.class, boolean.class).invoke(remoteEndpoint, partialByte, isLast);", "originalCommit": "e57ed6368b0036275c5392b2bc8ffbbf4c3cd4f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5MTk4Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r396991986", "bodyText": "I didn't check behaviour of BatchMode.", "author": "Vlatombe", "createdAt": "2020-03-24T08:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4OTA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkyMzk4Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r419923983", "bodyText": "Probably safer to use /dev/urandom here if you're low on entropy?", "author": "daniel-beck", "createdAt": "2020-05-05T07:50:35Z", "path": "test/src/test/java/jenkins/agents/WebSocketAgentsTest.java", "diffHunk": "@@ -99,9 +100,10 @@ public void smokes() throws Exception {\n             ).stdout(System.out).start());\n             r.waitOnline(s);\n             assertEquals(\"response\", s.getChannel().call(new DummyTask()));\n+            assertNotNull(s.getChannel().call(new FatTask()));\n             FreeStyleProject p = r.createFreeStyleProject();\n             p.setAssignedNode(s);\n-            p.getBuildersList().add(Functions.isWindows() ? new BatchFile(\"echo hello\") : new Shell(\"echo hello\"));\n+            p.getBuildersList().add(Functions.isWindows() ? new BatchFile(\"echo hello\") : new Shell(\"dd if=/dev/random count=1024 bs=200\"));", "originalCommit": "e57ed6368b0036275c5392b2bc8ffbbf4c3cd4f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0NTMxNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r420045317", "bodyText": "This line has been reverted by #4605 anyway", "author": "Vlatombe", "createdAt": "2020-05-05T11:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkyMzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA4MDE4OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4596#discussion_r420080189", "bodyText": "\u21d2 #4710 (comment)", "author": "jglick", "createdAt": "2020-05-05T12:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkyMzk4Mw=="}], "type": "inlineReview"}]}