{"pr_number": 4501, "pr_title": "[JEP-223, JENKINS-60266] - Add a new Overall/Manage permission which allows to configure parts of the global configuration (experimental feature)", "pr_createdAt": "2020-02-14T18:42:59Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4501", "timeline": [{"oid": "55b2bc7f3fe037e46a06deb44b93b02787df28ef", "url": "https://github.com/jenkinsci/jenkins/commit/55b2bc7f3fe037e46a06deb44b93b02787df28ef", "message": "[JEP-223] Overall/Manage permission\n\nCo-Authored-By: Esther Alvarez Feijoo <ealvarez@cloudbees.com>\nCo-Authored-By: aHenryJard <ajard@cloudbees.com>\nCo-Authored-By: michael cirioli <mikecirioli@gmail.com>", "committedDate": "2020-02-14T18:37:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4NzUwMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379587501", "bodyText": "This takes the place of the DescriptorVisibilityFilter in an earlier attempt.\nThe problem there was that we either had to allow any descriptor that wasn't a GlobalConfiguration (which leaves all DescriptorImpl/global.jelly accessible, which is unsafe), or we actually filtered out descriptors from, well, everywhere:\n\nWhile funny, this wasn't useful.", "author": "daniel-beck", "createdAt": "2020-02-14T18:46:47Z", "path": "core/src/main/java/hudson/Functions.java", "diffHunk": "@@ -1062,6 +1062,10 @@ public static String getFooterURL() {\n             Descriptor d = c.getInstance();\n             if (d.getGlobalConfigPage()==null)  continue;\n \n+            if (!Jenkins.get().hasPermission(d.getPermission())) {\n+                continue;\n+            }\n+", "originalCommit": "55b2bc7f3fe037e46a06deb44b93b02787df28ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4Nzk3MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379587970", "bodyText": "No special permissions are needed to access this anyway: https://ci.jenkins.io/load-statistics", "author": "daniel-beck", "createdAt": "2020-02-14T18:47:53Z", "path": "core/src/main/java/jenkins/management/StatisticsLink.java", "diffHunk": "@@ -48,6 +52,12 @@ public String getDescription() {\n         return Messages.StatisticsLink_Description();\n     }\n \n+    @CheckForNull\n+    @Override\n+    public Permission getRequiredPermission() {\n+        return Jenkins.MANAGE;\n+    }\n+", "originalCommit": "55b2bc7f3fe037e46a06deb44b93b02787df28ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4ODEwNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379588104", "bodyText": "No special permissions are needed to access this anyway: https://ci.jenkins.io/computer/", "author": "daniel-beck", "createdAt": "2020-02-14T18:48:10Z", "path": "core/src/main/java/jenkins/management/NodesLink.java", "diffHunk": "@@ -49,6 +53,12 @@ public String getDescription() {\n         return Messages.NodesLink_Description();\n     }\n \n+    @CheckForNull\n+    @Override\n+    public Permission getRequiredPermission() {\n+        return Jenkins.MANAGE;\n+    }\n+", "originalCommit": "55b2bc7f3fe037e46a06deb44b93b02787df28ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0NjQ0Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379646447", "bodyText": "\u2714\ufe0f still accessible to user with just Overall/Read", "author": "Wadeck", "createdAt": "2020-02-14T21:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4ODEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MDUxOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380240519", "bodyText": "So an improvement then?", "author": "jvz", "createdAt": "2020-02-17T15:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4ODEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4ODQwNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379588404", "bodyText": "No special permissions are needed to access this anyway.", "author": "daniel-beck", "createdAt": "2020-02-14T18:48:55Z", "path": "core/src/main/java/jenkins/management/CliLink.java", "diffHunk": "@@ -48,6 +52,12 @@ public String getDescription() {\n         return Messages.CliLink_Description();\n     }\n \n+    @CheckForNull\n+    @Override\n+    public Permission getRequiredPermission() {\n+        return Jenkins.MANAGE;\n+    }\n+", "originalCommit": "55b2bc7f3fe037e46a06deb44b93b02787df28ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyMDM5Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380120397", "bodyText": "Maybe returning Jenkins.READ is a better option then. Could save time for JEP-224 later.\nSame for the similar comments below", "author": "oleg-nenashev", "createdAt": "2020-02-17T11:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4ODQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3NjA3MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380176070", "bodyText": "Possibly, but the combined JEP-223/224 exists and solves this differently, since it needs explicit checks for either of the permissions in quite a few places.", "author": "daniel-beck", "createdAt": "2020-02-17T13:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4ODQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4OTA2Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379589067", "bodyText": "Hide administrative monitors so they won't show up on /manage.", "author": "daniel-beck", "createdAt": "2020-02-14T18:50:25Z", "path": "core/src/main/java/jenkins/model/Jenkins.java", "diffHunk": "@@ -2199,6 +2199,9 @@ public AdministrativeMonitor getAdministrativeMonitor(String id) {\n      * @since 2.64\n      */\n     public List<AdministrativeMonitor> getActiveAdministrativeMonitors() {\n+        if (!Jenkins.get().hasPermission(ADMINISTER)) {\n+            return Collections.emptyList();\n+        }", "originalCommit": "55b2bc7f3fe037e46a06deb44b93b02787df28ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyMDg4NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380120885", "bodyText": "I would argue that Jenkins \"managers\" may want to see some administrative warnings in the future, but it is a subject for future enhancements", "author": "oleg-nenashev", "createdAt": "2020-02-17T11:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4OTA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3NTY0Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380175643", "bodyText": "These are difficult due to how they're secured, and have been secured, for a long time.\nSimilar to all other /manage entries besides the trivial ones whose URLs are accessible to anyone anyway, I consider this a topic for future improvements that can be reviewed and debated independently.", "author": "daniel-beck", "createdAt": "2020-02-17T13:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4OTA2Nw=="}], "type": "inlineReview"}, {"oid": "3b2d0d2c78fefc1fd9428a55ee7a112abd28fe51", "url": "https://github.com/jenkinsci/jenkins/commit/3b2d0d2c78fefc1fd9428a55ee7a112abd28fe51", "message": "As this is experimental, annotate with Restricted(Beta)", "committedDate": "2020-02-14T18:59:03Z", "type": "commit"}, {"oid": "a1d097f30c9d2f18c8d5a63bf7f95c4a9605266b", "url": "https://github.com/jenkinsci/jenkins/commit/a1d097f30c9d2f18c8d5a63bf7f95c4a9605266b", "message": "Add test back\n\nCo-Authored-By: Esther Alvarez Feijoo <ealvarez@cloudbees.com>\nCo-Authored-By: A. Jard <angelique.jard@gmail.com>\nCo-Authored-By: michael cirioli <mikecirioli@gmail.com>", "committedDate": "2020-02-14T20:23:29Z", "type": "commit"}, {"oid": "17f1a7c15543ffae19afe7541494898ac3fdb972", "url": "https://github.com/jenkinsci/jenkins/commit/17f1a7c15543ffae19afe7541494898ac3fdb972", "message": "Fix Javadoc", "committedDate": "2020-02-14T20:31:28Z", "type": "commit"}, {"oid": "311fe0a3ef5310bef31a81b163902f7534ffc5e9", "url": "https://github.com/jenkinsci/jenkins/commit/311fe0a3ef5310bef31a81b163902f7534ffc5e9", "message": "Only show the link to the cloud configuration to admins", "committedDate": "2020-02-14T20:37:15Z", "type": "commit"}, {"oid": "042dc75a8f650523916ca789e938cf2b01ed365b", "url": "https://github.com/jenkinsci/jenkins/commit/042dc75a8f650523916ca789e938cf2b01ed365b", "message": "For consistency with ManagementLink, name this #getRequiredPermission()", "committedDate": "2020-02-14T20:55:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzODU4NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379638584", "bodyText": "\ud83d\udc4d This potentially breaking change will have no impact on the plugins from the ecosystem.\nYou can find the analysis report in jenkinsci/jep#269, done with two different tools (GitHub search and \"grep\" search) by two different persons. Nothing was found that is not expected.", "author": "Wadeck", "createdAt": "2020-02-14T20:50:38Z", "path": "core/src/main/java/hudson/model/ManagementLink.java", "diffHunk": "@@ -115,7 +115,7 @@ public boolean getRequiresConfirmation() {\n      * @return permission required for user to access this management link, in addition to {@link Jenkins#ADMINISTER}\n      */\n     public @CheckForNull Permission getRequiredPermission() {\n-        return null;\n+        return Jenkins.ADMINISTER;", "originalCommit": "311fe0a3ef5310bef31a81b163902f7534ffc5e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyNTIxNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379825215", "bodyText": "This does hugely impact system read though, and it doesn't seem to have been considered in https://github.com/jenkinsci/jep/pull/269/files at all\nThe manage page is now completely empty if I branch JEP-223 and JEP-224 and merge them together.\nOptions I've looked at so far,\n\nrevert this change and go back to null, system read continues to work, manage will see everything\nchange it to system read, then you get manager is missing the Overall/SystemRead permission", "author": "timja", "createdAt": "2020-02-15T11:10:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzODU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzOTA4Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379839082", "bodyText": "I addressed @timja's concerns in #4501 (comment)", "author": "daniel-beck", "createdAt": "2020-02-15T15:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzODU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDExOTU3MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380119571", "bodyText": "I agree that it is ok as an intermediate solution. permission required for user to access this management link, in addition to {@link Jenkins#ADMINISTER} already implies that there will be rework needed to make it compatible with JEP-224. Since the JEP-223 is about landing as experimental, we can afford further breaking changes in the implementation if needed for JEP-224", "author": "oleg-nenashev", "createdAt": "2020-02-17T11:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzODU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0ODE1NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379648155", "bodyText": "FTR The \"protection\" against illegal modifications is done by filtering out the descriptor with getSortedDescriptorsForGlobalConfigUnclassified", "author": "Wadeck", "createdAt": "2020-02-14T21:17:05Z", "path": "core/src/main/java/jenkins/model/Jenkins.java", "diffHunk": "@@ -3762,7 +3766,7 @@ public Object getDynamic(String token) {\n     public synchronized void doConfigSubmit( StaplerRequest req, StaplerResponse rsp ) throws IOException, ServletException, FormException {\n         BulkChange bc = new BulkChange(this);\n         try {\n-            checkPermission(ADMINISTER);\n+            checkPermission(MANAGE);", "originalCommit": "042dc75a8f650523916ca789e938cf2b01ed365b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc3OTYwOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379779608", "bodyText": "Most of the explanation in #4483 (comment) still applies.", "author": "daniel-beck", "createdAt": "2020-02-15T07:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0ODE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NTE5MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379665190", "bodyText": "This comment is confusing. As best I can tell, these tests are inspired by tests in DisablePluginCommandTest but nothing was moved from there or even directly copied. I'm not sure there's even any value in referencing at all here.\nThere are other similar confusing comments in this same test file referring to other moves.\nI suppose the private helper methods are copied from the other files. That copying could be noted here, but I'm not sure that's useful in these tests.", "author": "jeffret-b", "createdAt": "2020-02-14T22:02:19Z", "path": "test/src/test/java/jenkins/model/JenkinsManagePermissionTest.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package jenkins.model;\n+\n+import java.net.HttpURLConnection;\n+import com.gargoylesoftware.htmlunit.WebResponse;\n+import com.gargoylesoftware.htmlunit.html.HtmlForm;\n+import com.gargoylesoftware.htmlunit.html.HtmlPage;\n+import org.hamcrest.BaseMatcher;\n+import org.hamcrest.Description;\n+import org.hamcrest.Matcher;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+import org.jvnet.hudson.test.MockAuthorizationStrategy;\n+import org.jvnet.hudson.test.recipes.WithPlugin;\n+\n+import hudson.PluginWrapper;\n+import hudson.cli.CLICommandInvoker;\n+import hudson.cli.DisablePluginCommand;\n+import hudson.model.Descriptor;\n+import hudson.model.MyView;\n+import hudson.model.View;\n+import hudson.model.labels.LabelAtom;\n+import hudson.tasks.Shell;\n+\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.not;\n+import static org.hamcrest.Matchers.notNullValue;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+import static hudson.cli.CLICommandInvoker.Matcher.failedWith;\n+\n+/**\n+ * As Jenkins.MANAGE can be enabled on startup with jenkins.security.ManagePermission property, we need a test class\n+ * with this property activated.\n+ */\n+public class JenkinsManagePermissionTest {\n+\n+    @Rule\n+    public JenkinsRule j = new JenkinsRule();\n+\n+    @BeforeClass //TODO: remove once Jenkins.MANAGE is no longer an experimental feature\n+    public static void enableManagePermission() {\n+        System.setProperty(\"jenkins.security.ManagePermission\", \"true\");\n+    }\n+\n+    @AfterClass //TODO: remove once Jenkins.MANAGE is no longer an experimental feature\n+    public static void disableManagePermission() {\n+        System.clearProperty(\"jenkins.security.ManagePermission\");\n+    }\n+\n+\n+    // -----------------------------\n+    //Moved from DisablePluginCommandTest", "originalCommit": "311fe0a3ef5310bef31a81b163902f7534ffc5e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTcwNzg1NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r379707854", "bodyText": "These tests logically belong in the other tests, and are only here because of the need to set the system property. That's my interpretation at least.", "author": "daniel-beck", "createdAt": "2020-02-15T01:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NTE5MA=="}], "type": "inlineReview"}, {"oid": "58a3f01c1ec14d58aa65017e4459f4ad36d9c0e1", "url": "https://github.com/jenkinsci/jenkins/commit/58a3f01c1ec14d58aa65017e4459f4ad36d9c0e1", "message": "Address review feedback", "committedDate": "2020-02-15T01:43:40Z", "type": "commit"}, {"oid": "9ba18f5de0c3b44a4dcd96d3978bc9f3a4c324b1", "url": "https://github.com/jenkinsci/jenkins/commit/9ba18f5de0c3b44a4dcd96d3978bc9f3a4c324b1", "message": "Merge branch 'master' into jep-223", "committedDate": "2020-02-15T11:56:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyMjgzOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380122838", "bodyText": "Should it be implied by MANAGE after the change?", "author": "oleg-nenashev", "createdAt": "2020-02-17T11:15:02Z", "path": "core/src/main/java/jenkins/model/Jenkins.java", "diffHunk": "@@ -5236,7 +5240,26 @@ private static void computeVersion(ServletContext context) {\n     private static final Logger LOGGER = Logger.getLogger(Jenkins.class.getName());\n \n     public static final PermissionGroup PERMISSIONS = Permission.HUDSON_PERMISSIONS;\n+    /**\n+     * Grants ability to configure any and all aspects of the Jenkins instance\n+     */\n     public static final Permission ADMINISTER = Permission.HUDSON_ADMINISTER;\n+\n+    /**\n+     * Allows non-privilege escalating configuration permission for a Jenkins instance.  Actions which could result\n+     * in a privilege  escalation (such as RUN_SCRIPTS) require explicit ADMINISTER permission.\n+     *\n+     * As an experimental feature, making the manage permission able to be disabled by default (keep as ADMINISTER), can\n+     * be enabled with \"jenkins.security.ManagePermission\" system property.\n+     */\n+    @Restricted(Beta.class)\n+    public static final Permission MANAGE = new Permission(PERMISSIONS, \"Manage\",\n+            Messages._Jenkins_Manage_Description(),\n+            ADMINISTER,\n+            SystemProperties.getBoolean(\"jenkins.security.ManagePermission\"),\n+            new PermissionScope[]{PermissionScope.JENKINS});\n+\n+\n     public static final Permission READ = new Permission(PERMISSIONS,\"Read\",Messages._Hudson_ReadPermission_Description(),Permission.READ,PermissionScope.JENKINS);", "originalCommit": "9ba18f5de0c3b44a4dcd96d3978bc9f3a4c324b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMjYzMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380132630", "bodyText": "An analysis of that topic has been documented in the JEP: Jenkins.MANAGE implies no other permission", "author": "EstherAF", "createdAt": "2020-02-17T11:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyMjgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNDYwMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380134602", "bodyText": "thanks!", "author": "oleg-nenashev", "createdAt": "2020-02-17T11:43:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyMjgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3MDQ5MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380170490", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * be enabled with \"jenkins.security.ManagePermission\" system property.\n          \n          \n            \n                 * be enabled with \"jenkins.security.ManagePermission\" system property.\n          \n          \n            \n                 * @since TODO", "author": "oleg-nenashev", "createdAt": "2020-02-17T13:05:39Z", "path": "core/src/main/java/jenkins/model/Jenkins.java", "diffHunk": "@@ -5236,7 +5240,26 @@ private static void computeVersion(ServletContext context) {\n     private static final Logger LOGGER = Logger.getLogger(Jenkins.class.getName());\n \n     public static final PermissionGroup PERMISSIONS = Permission.HUDSON_PERMISSIONS;\n+    /**\n+     * Grants ability to configure any and all aspects of the Jenkins instance\n+     */\n     public static final Permission ADMINISTER = Permission.HUDSON_ADMINISTER;\n+\n+    /**\n+     * Allows non-privilege escalating configuration permission for a Jenkins instance.  Actions which could result\n+     * in a privilege  escalation (such as RUN_SCRIPTS) require explicit ADMINISTER permission.\n+     *\n+     * As an experimental feature, making the manage permission able to be disabled by default (keep as ADMINISTER), can\n+     * be enabled with \"jenkins.security.ManagePermission\" system property.", "originalCommit": "9ba18f5de0c3b44a4dcd96d3978bc9f3a4c324b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3MDYzOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380170638", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return Permission required to configure this descriptor.\n          \n          \n            \n                 * @return Permission required to configure this descriptor.\n          \n          \n            \n                 * @since TODO", "author": "oleg-nenashev", "createdAt": "2020-02-17T13:05:57Z", "path": "core/src/main/java/hudson/model/Descriptor.java", "diffHunk": "@@ -830,6 +832,18 @@ public String getGlobalConfigPage() {\n         return GlobalConfigurationCategory.get(GlobalConfigurationCategory.Unclassified.class);\n     }\n \n+    /**\n+     * Returns the permission type needed in order to configure the descriptor if and only if it is configured through the global (Unclassified) configuration.\n+     * By default, requires {@link Jenkins#ADMINISTER} permission.\n+     * Override to return something different if appropriate. The only currently supported alternative return value is {@link Jenkins#MANAGE}.\n+     *\n+     * @return Permission required to configure this descriptor.", "originalCommit": "9ba18f5de0c3b44a4dcd96d3978bc9f3a4c324b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "url": "https://github.com/jenkinsci/jenkins/commit/735193c2ecfbea75ba174af96c5b98a052e9ff5f", "message": "Add at-since TODO to Javadoc\n\nCo-Authored-By: Oleg Nenashev <o.v.nenashev@gmail.com>", "committedDate": "2020-02-17T13:14:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5ODgyNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380198825", "bodyText": "@link?", "author": "jglick", "createdAt": "2020-02-17T14:02:28Z", "path": "core/src/main/java/hudson/model/Descriptor.java", "diffHunk": "@@ -830,6 +832,19 @@ public String getGlobalConfigPage() {\n         return GlobalConfigurationCategory.get(GlobalConfigurationCategory.Unclassified.class);\n     }\n \n+    /**\n+     * Returns the permission type needed in order to configure the descriptor if and only if it is configured through the global (Unclassified) configuration.", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5OTM3Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380199376", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @CheckForNull Permission getRequiredPermission() {\n          \n          \n            \n                public @Nonnull Permission getRequiredPermission() {\n          \n      \n    \n    \n  \n\n?", "author": "jglick", "createdAt": "2020-02-17T14:03:35Z", "path": "core/src/main/java/hudson/model/ManagementLink.java", "diffHunk": "@@ -115,7 +115,7 @@ public boolean getRequiresConfirmation() {\n      * @return permission required for user to access this management link, in addition to {@link Jenkins#ADMINISTER}\n      */\n     public @CheckForNull Permission getRequiredPermission() {", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5OTc5NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380199794", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return permission required for user to access this management link, in addition to {@link Jenkins#ADMINISTER}\n          \n          \n            \n                 * @return permission required for user to access this management link; by default, {@link Jenkins#ADMINISTER}\n          \n      \n    \n    \n  \n\n?", "author": "jglick", "createdAt": "2020-02-17T14:04:28Z", "path": "core/src/main/java/hudson/model/ManagementLink.java", "diffHunk": "@@ -115,7 +115,7 @@ public boolean getRequiresConfirmation() {\n      * @return permission required for user to access this management link, in addition to {@link Jenkins#ADMINISTER}", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzNTM3NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380235375", "bodyText": "More information about the changes in this method can be found in jenkinsci/jep#269", "author": "EstherAF", "createdAt": "2020-02-17T15:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5OTc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzNzcxOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380237719", "bodyText": "I do not see anything in a quick reading of that PR that addresses my question and the one below:\n\nIf ADMINISTER rather than null is now the default, under what conditions would a plugin be overriding this to return null, and why should we even permit that?\nIf the returned permission is \u201cin addition to\u201d ADMINISTER, then what sense would it make to return MANAGE, since ADMINISTER + MANAGE = ADMINISTER anyway?\n\nAm I missing a particular subtle point in that PR that should be called out here?", "author": "jglick", "createdAt": "2020-02-17T15:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5OTc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2ODI0Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380268243", "bodyText": "Not sure I understand. If others do understand and the code is correct as written (null is allowed, and this is actually in addition to ADMINISTER) then I guess ignore me (or improve documentation).", "author": "jglick", "createdAt": "2020-02-17T16:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5OTc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMTA3Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380201072", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * in a privilege  escalation (such as RUN_SCRIPTS) require explicit ADMINISTER permission.\n          \n          \n            \n                 * in a privilege escalation (such as {@link #RUN_SCRIPTS}) require explicit {@link #ADMINISTER} permission.", "author": "jglick", "createdAt": "2020-02-17T14:06:52Z", "path": "core/src/main/java/jenkins/model/Jenkins.java", "diffHunk": "@@ -5236,7 +5240,27 @@ private static void computeVersion(ServletContext context) {\n     private static final Logger LOGGER = Logger.getLogger(Jenkins.class.getName());\n \n     public static final PermissionGroup PERMISSIONS = Permission.HUDSON_PERMISSIONS;\n+    /**\n+     * Grants ability to configure any and all aspects of the Jenkins instance\n+     */\n     public static final Permission ADMINISTER = Permission.HUDSON_ADMINISTER;\n+\n+    /**\n+     * Allows non-privilege escalating configuration permission for a Jenkins instance.  Actions which could result\n+     * in a privilege  escalation (such as RUN_SCRIPTS) require explicit ADMINISTER permission.", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMTE5MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380201191", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 *\n          \n          \n            \n                 * <p>", "author": "jglick", "createdAt": "2020-02-17T14:07:06Z", "path": "core/src/main/java/jenkins/model/Jenkins.java", "diffHunk": "@@ -5236,7 +5240,27 @@ private static void computeVersion(ServletContext context) {\n     private static final Logger LOGGER = Logger.getLogger(Jenkins.class.getName());\n \n     public static final PermissionGroup PERMISSIONS = Permission.HUDSON_PERMISSIONS;\n+    /**\n+     * Grants ability to configure any and all aspects of the Jenkins instance\n+     */\n     public static final Permission ADMINISTER = Permission.HUDSON_ADMINISTER;\n+\n+    /**\n+     * Allows non-privilege escalating configuration permission for a Jenkins instance.  Actions which could result\n+     * in a privilege  escalation (such as RUN_SCRIPTS) require explicit ADMINISTER permission.\n+     *", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMTQxNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380201417", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * As an experimental feature, making the manage permission able to be disabled by default (keep as ADMINISTER), can\n          \n          \n            \n                 * As an experimental feature, making the manage permission able to be disabled by default (keep as {@link #ADMINISTER}), can", "author": "jglick", "createdAt": "2020-02-17T14:07:34Z", "path": "core/src/main/java/jenkins/model/Jenkins.java", "diffHunk": "@@ -5236,7 +5240,27 @@ private static void computeVersion(ServletContext context) {\n     private static final Logger LOGGER = Logger.getLogger(Jenkins.class.getName());\n \n     public static final PermissionGroup PERMISSIONS = Permission.HUDSON_PERMISSIONS;\n+    /**\n+     * Grants ability to configure any and all aspects of the Jenkins instance\n+     */\n     public static final Permission ADMINISTER = Permission.HUDSON_ADMINISTER;\n+\n+    /**\n+     * Allows non-privilege escalating configuration permission for a Jenkins instance.  Actions which could result\n+     * in a privilege  escalation (such as RUN_SCRIPTS) require explicit ADMINISTER permission.\n+     *\n+     * As an experimental feature, making the manage permission able to be disabled by default (keep as ADMINISTER), can", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMTU1NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380201554", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * be enabled with \"jenkins.security.ManagePermission\" system property.\n          \n          \n            \n                 * be enabled with {@code jenkins.security.ManagePermission} system property.", "author": "jglick", "createdAt": "2020-02-17T14:07:50Z", "path": "core/src/main/java/jenkins/model/Jenkins.java", "diffHunk": "@@ -5236,7 +5240,27 @@ private static void computeVersion(ServletContext context) {\n     private static final Logger LOGGER = Logger.getLogger(Jenkins.class.getName());\n \n     public static final PermissionGroup PERMISSIONS = Permission.HUDSON_PERMISSIONS;\n+    /**\n+     * Grants ability to configure any and all aspects of the Jenkins instance\n+     */\n     public static final Permission ADMINISTER = Permission.HUDSON_ADMINISTER;\n+\n+    /**\n+     * Allows non-privilege escalating configuration permission for a Jenkins instance.  Actions which could result\n+     * in a privilege  escalation (such as RUN_SCRIPTS) require explicit ADMINISTER permission.\n+     *\n+     * As an experimental feature, making the manage permission able to be disabled by default (keep as ADMINISTER), can\n+     * be enabled with \"jenkins.security.ManagePermission\" system property.", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMjg3OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380202878", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void managerCanNotDisablePlugin() {\n          \n          \n            \n                public void managerCannotDisablePlugin() {", "author": "jglick", "createdAt": "2020-02-17T14:10:23Z", "path": "test/src/test/java/jenkins/model/JenkinsManagePermissionTest.java", "diffHunk": "@@ -0,0 +1,215 @@\n+package jenkins.model;\n+\n+import java.net.HttpURLConnection;\n+import com.gargoylesoftware.htmlunit.WebResponse;\n+import com.gargoylesoftware.htmlunit.html.HtmlForm;\n+import com.gargoylesoftware.htmlunit.html.HtmlPage;\n+import org.hamcrest.BaseMatcher;\n+import org.hamcrest.Description;\n+import org.hamcrest.Matcher;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+import org.jvnet.hudson.test.MockAuthorizationStrategy;\n+import org.jvnet.hudson.test.recipes.WithPlugin;\n+\n+import hudson.PluginWrapper;\n+import hudson.cli.CLICommandInvoker;\n+import hudson.cli.DisablePluginCommand;\n+import hudson.model.Descriptor;\n+import hudson.model.MyView;\n+import hudson.model.View;\n+import hudson.model.labels.LabelAtom;\n+import hudson.tasks.Shell;\n+\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.not;\n+import static org.hamcrest.Matchers.notNullValue;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+import static hudson.cli.CLICommandInvoker.Matcher.failedWith;\n+\n+/**\n+ * As Jenkins.MANAGE can be enabled on startup with jenkins.security.ManagePermission property, we need a test class\n+ * with this property activated.\n+ */\n+// TODO move tests to indicated test classes when we no longer need to set the system property\n+public class JenkinsManagePermissionTest {\n+\n+    @Rule\n+    public JenkinsRule j = new JenkinsRule();\n+\n+    @BeforeClass\n+    public static void enableManagePermission() {\n+        System.setProperty(\"jenkins.security.ManagePermission\", \"true\");\n+    }\n+\n+    @AfterClass\n+    public static void disableManagePermission() {\n+        System.clearProperty(\"jenkins.security.ManagePermission\");\n+    }\n+\n+\n+    // -----------------------------\n+    // DisablePluginCommandTest\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    @WithPlugin({ \"depender-0.0.2.hpi\", \"dependee-0.0.2.hpi\"})\n+    public void managerCanNotDisablePlugin() {", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxMzM4NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380213384", "bodyText": "is cannot a British Englishism?", "author": "jtnord", "createdAt": "2020-02-17T14:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMjg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxNDY0NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380214644", "bodyText": "https://en.wiktionary.org/wiki/cannot#Usage_notes", "author": "daniel-beck", "createdAt": "2020-02-17T14:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMjg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIyMDEzMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380220133", "bodyText": "\u201c[a] manager can not disable [a] plugin\u201d reads to me something like \u201ca manager is permitted to decline to disable a plugin\u201d. \u201ccannot\u201d is what was meant here: \u201ca manager is not permitted to disable a plugin\u201d.", "author": "jglick", "createdAt": "2020-02-17T14:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMjg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMzIxOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380203219", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // End of HusdonTest\n          \n          \n            \n                // End of HudsonTest", "author": "jglick", "createdAt": "2020-02-17T14:11:02Z", "path": "test/src/test/java/jenkins/model/JenkinsManagePermissionTest.java", "diffHunk": "@@ -0,0 +1,215 @@\n+package jenkins.model;\n+\n+import java.net.HttpURLConnection;\n+import com.gargoylesoftware.htmlunit.WebResponse;\n+import com.gargoylesoftware.htmlunit.html.HtmlForm;\n+import com.gargoylesoftware.htmlunit.html.HtmlPage;\n+import org.hamcrest.BaseMatcher;\n+import org.hamcrest.Description;\n+import org.hamcrest.Matcher;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+import org.jvnet.hudson.test.MockAuthorizationStrategy;\n+import org.jvnet.hudson.test.recipes.WithPlugin;\n+\n+import hudson.PluginWrapper;\n+import hudson.cli.CLICommandInvoker;\n+import hudson.cli.DisablePluginCommand;\n+import hudson.model.Descriptor;\n+import hudson.model.MyView;\n+import hudson.model.View;\n+import hudson.model.labels.LabelAtom;\n+import hudson.tasks.Shell;\n+\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.not;\n+import static org.hamcrest.Matchers.notNullValue;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+import static hudson.cli.CLICommandInvoker.Matcher.failedWith;\n+\n+/**\n+ * As Jenkins.MANAGE can be enabled on startup with jenkins.security.ManagePermission property, we need a test class\n+ * with this property activated.\n+ */\n+// TODO move tests to indicated test classes when we no longer need to set the system property\n+public class JenkinsManagePermissionTest {\n+\n+    @Rule\n+    public JenkinsRule j = new JenkinsRule();\n+\n+    @BeforeClass\n+    public static void enableManagePermission() {\n+        System.setProperty(\"jenkins.security.ManagePermission\", \"true\");\n+    }\n+\n+    @AfterClass\n+    public static void disableManagePermission() {\n+        System.clearProperty(\"jenkins.security.ManagePermission\");\n+    }\n+\n+\n+    // -----------------------------\n+    // DisablePluginCommandTest\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    @WithPlugin({ \"depender-0.0.2.hpi\", \"dependee-0.0.2.hpi\"})\n+    public void managerCanNotDisablePlugin() {\n+\n+        //GIVEN a user with Jenkins.MANAGE permission\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.MANAGE).everywhere().to(\"manager\")\n+        );\n+\n+        //WHEN trying to disable a plugin\n+        assertThat(disablePluginsCLiCommandAs(\"manager\", \"dependee\"), failedWith(6));\n+        //THEN it's refused and the plugin is not disabled.\n+        assertPluginEnabled(\"dependee\");\n+    }\n+\n+    /**\n+     * Disable a list of plugins using the CLI command.\n+     * @param user Username\n+     * @param args Arguments to pass to the command.\n+     * @return Result of the command. 0 if succeed, 16 if some plugin couldn't be disabled due to dependent plugins.\n+     */\n+    private CLICommandInvoker.Result disablePluginsCLiCommandAs(String user, String... args) {\n+        return new CLICommandInvoker(j, new DisablePluginCommand()).asUser(user).invokeWithArgs(args);\n+    }\n+\n+\n+    private void assertPluginEnabled(String name) {\n+        PluginWrapper plugin = j.getPluginManager().getPlugin(name);\n+        assertThat(plugin, is(notNullValue()));\n+        assertTrue(plugin.isEnabled());\n+    }\n+\n+    // End of DisablePluginCommandTest\n+    //-------\n+\n+    // -----------------------------\n+    //ComputerTest\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    public void dumpExportTableForbiddenWithoutAdminPermission() throws Exception {\n+        final String READER = \"reader\";\n+        final String MANAGER = \"manager\";\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.READ).everywhere().to(READER)\n+                .grant(Jenkins.MANAGE).everywhere().to(MANAGER)\n+                .grant(Jenkins.READ).everywhere().to(MANAGER)\n+        );\n+        j.createWebClient().login(READER).assertFails(\"computer/(master)/dumpExportTable\", HttpURLConnection.HTTP_FORBIDDEN);\n+        j.createWebClient().login(MANAGER).assertFails(\"computer/(master)/dumpExportTable\", HttpURLConnection.HTTP_FORBIDDEN);\n+    }\n+\n+    // End of ComputerTest\n+    //-------\n+\n+    // -----------------------------\n+    // HusdonTest\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    public void someGlobalConfigurationIsNotDisplayedWithManagePermission() throws Exception {\n+        //GIVEN a user with Jenkins.MANAGE permission\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.MANAGE, Jenkins.READ).everywhere().toEveryone());\n+\n+        //WHEN the user goes to /configure page\n+        HtmlForm form = j.createWebClient().goTo(\"configure\").getFormByName(\"config\");\n+        String formText = form.asText();\n+        //THEN items restricted to ADMINISTER only should not be displayed.\n+        assertThat(\"Should be able to configure system message\", formText, not(containsString(\"systemMessage\")));\n+        assertThat(\"Should be able to configure project naming strategy\", formText, not(containsString(\"useProjectNamingStrategy\")));\n+        assertThat(\"Shouldn't be able to configure primary view\", formText, not(containsString(\"primaryView\")));\n+        assertThat(\"Shouldn't be able to configure # of executors\", formText, not(containsString(\"executors\")));\n+        assertThat(\"Shouldn't be able to configure Global properties\", formText,\n+                not(containsString(\"Global properties\")));\n+        assertThat(\"Shouldn't be able to configure Administrative monitors\", formText, not(containsString(\n+                \"Administrative \"\n+                        + \"monitors\")));\n+        assertThat(\"Shouldn't be able to configure Shell\", formText, not(containsString(\"Shell\")));\n+    }\n+\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    public void someGlobalConfigCanNotBeModifiedWithManagePermission() throws Exception {\n+        j.jenkins.addView(new MyView(\"testView\", j.jenkins));\n+\n+        //GIVEN the Global Configuration Form, with some changes unsaved\n+        int currentNumberExecutors = j.getInstance().getNumExecutors();\n+        String shell = getShell();\n+        View view = j.jenkins.getPrimaryView();\n+        HtmlForm form = j.createWebClient().goTo(\"configure\").getFormByName(\"config\");\n+        form.getInputByName(\"_.numExecutors\").setValueAttribute(\"\"+(currentNumberExecutors+1));\n+        form.getInputByName(\"_.shell\").setValueAttribute(\"/fakeShell\");\n+        form.getSelectByName(\"primaryView\").setSelectedAttribute(\"testView\", true);\n+\n+        // WHEN a user with only Jenkins.MANAGE permission try to save those changes\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.MANAGE, Jenkins.READ).everywhere().toEveryone());\n+        j.submit(form);\n+        // THEN the changes on fields forbidden to a Jenkins.MANAGE permission are not saved\n+        assertEquals(\"shouldn't be allowed to change the number of executors\", currentNumberExecutors, j.getInstance().getNumExecutors());\n+        assertEquals(\"shouldn't be allowed to change the shell executable\", shell, getShell());\n+        assertEquals(\"shouldn't be allowed to change the primary view\", view, j.getInstance().getPrimaryView());\n+    }\n+\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    public void globalConfigAllowedWithManagePermission() throws Exception {\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.MANAGE, Jenkins.READ).everywhere().toEveryone());\n+\n+        HtmlForm form = j.createWebClient().goTo(\"configure\").getFormByName(\"config\");\n+        HtmlPage updated = j.submit(form);\n+        assertThat(\"User with Jenkins.MANAGE permission should be able to update global configuration\",\n+                updated.getWebResponse(), hasResponseCode(HttpURLConnection.HTTP_OK));\n+    }\n+\n+    private String getShell() {\n+        Descriptor descriptorByName = j.getInstance().getDescriptorByName(\"hudson.tasks.Shell\");\n+        return ((Shell.DescriptorImpl) descriptorByName).getShell();\n+    }\n+\n+    private static Matcher<WebResponse> hasResponseCode(final int httpStatus) {\n+        return new BaseMatcher<WebResponse>() {\n+            @Override\n+            public boolean matches(final Object item) {\n+                final WebResponse response = (WebResponse) item;\n+                return (response.getStatusCode() == httpStatus);\n+            }\n+\n+            @Override\n+            public void describeTo(final Description description) {\n+                description.appendText(\"Jenkins to return  \").appendValue(httpStatus);\n+            }\n+\n+            @Override\n+            public void describeMismatch(Object item, Description description) {\n+                WebResponse response = (WebResponse) item;\n+                description.appendText(\"Response code was: \");\n+                description.appendValue(response.getStatusCode());\n+                description.appendText(\" with error message: \");\n+                description.appendText(response.getStatusMessage());\n+                description.appendText(\"\\n with headers \").appendValueList(\"\", \"\\n    \", \"\", response.getResponseHeaders());\n+                description.appendText(\"\\nPage content: \").appendValue(response.getContentAsString());\n+            }\n+        };\n+    }\n+\n+    // End of HusdonTest", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwNDg3OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380204879", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return permission required for user to access this management link, in addition to {@link Jenkins#ADMINISTER}\n          \n          \n            \n                 * @return permission required for user to access this management link, in addition to {@link Jenkins#MANAGE}", "author": "jtnord", "createdAt": "2020-02-17T14:14:04Z", "path": "core/src/main/java/hudson/model/ManagementLink.java", "diffHunk": "@@ -115,7 +115,7 @@ public boolean getRequiresConfirmation() {\n      * @return permission required for user to access this management link, in addition to {@link Jenkins#ADMINISTER}", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzNjM1NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380236354", "bodyText": "This is not correct. The default permission is still Jenkins.ADMINISTER", "author": "EstherAF", "createdAt": "2020-02-17T15:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwNDg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MjIyOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380262229", "bodyText": "suggestion from @jglick is clearer and more correct.", "author": "jtnord", "createdAt": "2020-02-17T16:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwNDg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwNjk3NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4501#discussion_r380206974", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            }", "author": "jtnord", "createdAt": "2020-02-17T14:18:06Z", "path": "test/src/test/java/jenkins/model/JenkinsManagePermissionTest.java", "diffHunk": "@@ -0,0 +1,215 @@\n+package jenkins.model;\n+\n+import java.net.HttpURLConnection;\n+import com.gargoylesoftware.htmlunit.WebResponse;\n+import com.gargoylesoftware.htmlunit.html.HtmlForm;\n+import com.gargoylesoftware.htmlunit.html.HtmlPage;\n+import org.hamcrest.BaseMatcher;\n+import org.hamcrest.Description;\n+import org.hamcrest.Matcher;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+import org.jvnet.hudson.test.MockAuthorizationStrategy;\n+import org.jvnet.hudson.test.recipes.WithPlugin;\n+\n+import hudson.PluginWrapper;\n+import hudson.cli.CLICommandInvoker;\n+import hudson.cli.DisablePluginCommand;\n+import hudson.model.Descriptor;\n+import hudson.model.MyView;\n+import hudson.model.View;\n+import hudson.model.labels.LabelAtom;\n+import hudson.tasks.Shell;\n+\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.not;\n+import static org.hamcrest.Matchers.notNullValue;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+import static hudson.cli.CLICommandInvoker.Matcher.failedWith;\n+\n+/**\n+ * As Jenkins.MANAGE can be enabled on startup with jenkins.security.ManagePermission property, we need a test class\n+ * with this property activated.\n+ */\n+// TODO move tests to indicated test classes when we no longer need to set the system property\n+public class JenkinsManagePermissionTest {\n+\n+    @Rule\n+    public JenkinsRule j = new JenkinsRule();\n+\n+    @BeforeClass\n+    public static void enableManagePermission() {\n+        System.setProperty(\"jenkins.security.ManagePermission\", \"true\");\n+    }\n+\n+    @AfterClass\n+    public static void disableManagePermission() {\n+        System.clearProperty(\"jenkins.security.ManagePermission\");\n+    }\n+\n+\n+    // -----------------------------\n+    // DisablePluginCommandTest\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    @WithPlugin({ \"depender-0.0.2.hpi\", \"dependee-0.0.2.hpi\"})\n+    public void managerCanNotDisablePlugin() {\n+\n+        //GIVEN a user with Jenkins.MANAGE permission\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.MANAGE).everywhere().to(\"manager\")\n+        );\n+\n+        //WHEN trying to disable a plugin\n+        assertThat(disablePluginsCLiCommandAs(\"manager\", \"dependee\"), failedWith(6));\n+        //THEN it's refused and the plugin is not disabled.\n+        assertPluginEnabled(\"dependee\");\n+    }\n+\n+    /**\n+     * Disable a list of plugins using the CLI command.\n+     * @param user Username\n+     * @param args Arguments to pass to the command.\n+     * @return Result of the command. 0 if succeed, 16 if some plugin couldn't be disabled due to dependent plugins.\n+     */\n+    private CLICommandInvoker.Result disablePluginsCLiCommandAs(String user, String... args) {\n+        return new CLICommandInvoker(j, new DisablePluginCommand()).asUser(user).invokeWithArgs(args);\n+    }\n+\n+\n+    private void assertPluginEnabled(String name) {\n+        PluginWrapper plugin = j.getPluginManager().getPlugin(name);\n+        assertThat(plugin, is(notNullValue()));\n+        assertTrue(plugin.isEnabled());\n+    }\n+\n+    // End of DisablePluginCommandTest\n+    //-------\n+\n+    // -----------------------------\n+    //ComputerTest\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    public void dumpExportTableForbiddenWithoutAdminPermission() throws Exception {\n+        final String READER = \"reader\";\n+        final String MANAGER = \"manager\";\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.READ).everywhere().to(READER)\n+                .grant(Jenkins.MANAGE).everywhere().to(MANAGER)\n+                .grant(Jenkins.READ).everywhere().to(MANAGER)\n+        );\n+        j.createWebClient().login(READER).assertFails(\"computer/(master)/dumpExportTable\", HttpURLConnection.HTTP_FORBIDDEN);\n+        j.createWebClient().login(MANAGER).assertFails(\"computer/(master)/dumpExportTable\", HttpURLConnection.HTTP_FORBIDDEN);\n+    }\n+\n+    // End of ComputerTest\n+    //-------\n+\n+    // -----------------------------\n+    // HusdonTest\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    public void someGlobalConfigurationIsNotDisplayedWithManagePermission() throws Exception {\n+        //GIVEN a user with Jenkins.MANAGE permission\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.MANAGE, Jenkins.READ).everywhere().toEveryone());\n+\n+        //WHEN the user goes to /configure page\n+        HtmlForm form = j.createWebClient().goTo(\"configure\").getFormByName(\"config\");\n+        String formText = form.asText();\n+        //THEN items restricted to ADMINISTER only should not be displayed.\n+        assertThat(\"Should be able to configure system message\", formText, not(containsString(\"systemMessage\")));\n+        assertThat(\"Should be able to configure project naming strategy\", formText, not(containsString(\"useProjectNamingStrategy\")));\n+        assertThat(\"Shouldn't be able to configure primary view\", formText, not(containsString(\"primaryView\")));\n+        assertThat(\"Shouldn't be able to configure # of executors\", formText, not(containsString(\"executors\")));\n+        assertThat(\"Shouldn't be able to configure Global properties\", formText,\n+                not(containsString(\"Global properties\")));\n+        assertThat(\"Shouldn't be able to configure Administrative monitors\", formText, not(containsString(\n+                \"Administrative \"\n+                        + \"monitors\")));\n+        assertThat(\"Shouldn't be able to configure Shell\", formText, not(containsString(\"Shell\")));\n+    }\n+\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    public void someGlobalConfigCanNotBeModifiedWithManagePermission() throws Exception {\n+        j.jenkins.addView(new MyView(\"testView\", j.jenkins));\n+\n+        //GIVEN the Global Configuration Form, with some changes unsaved\n+        int currentNumberExecutors = j.getInstance().getNumExecutors();\n+        String shell = getShell();\n+        View view = j.jenkins.getPrimaryView();\n+        HtmlForm form = j.createWebClient().goTo(\"configure\").getFormByName(\"config\");\n+        form.getInputByName(\"_.numExecutors\").setValueAttribute(\"\"+(currentNumberExecutors+1));\n+        form.getInputByName(\"_.shell\").setValueAttribute(\"/fakeShell\");\n+        form.getSelectByName(\"primaryView\").setSelectedAttribute(\"testView\", true);\n+\n+        // WHEN a user with only Jenkins.MANAGE permission try to save those changes\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.MANAGE, Jenkins.READ).everywhere().toEveryone());\n+        j.submit(form);\n+        // THEN the changes on fields forbidden to a Jenkins.MANAGE permission are not saved\n+        assertEquals(\"shouldn't be allowed to change the number of executors\", currentNumberExecutors, j.getInstance().getNumExecutors());\n+        assertEquals(\"shouldn't be allowed to change the shell executable\", shell, getShell());\n+        assertEquals(\"shouldn't be allowed to change the primary view\", view, j.getInstance().getPrimaryView());\n+    }\n+\n+    @Issue(\"JENKINS-60266\")\n+    @Test\n+    public void globalConfigAllowedWithManagePermission() throws Exception {\n+        j.jenkins.setSecurityRealm(j.createDummySecurityRealm());\n+        j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy()\n+                .grant(Jenkins.MANAGE, Jenkins.READ).everywhere().toEveryone());\n+\n+        HtmlForm form = j.createWebClient().goTo(\"configure\").getFormByName(\"config\");\n+        HtmlPage updated = j.submit(form);\n+        assertThat(\"User with Jenkins.MANAGE permission should be able to update global configuration\",\n+                updated.getWebResponse(), hasResponseCode(HttpURLConnection.HTTP_OK));\n+    }\n+\n+    private String getShell() {\n+        Descriptor descriptorByName = j.getInstance().getDescriptorByName(\"hudson.tasks.Shell\");\n+        return ((Shell.DescriptorImpl) descriptorByName).getShell();\n+    }\n+\n+    private static Matcher<WebResponse> hasResponseCode(final int httpStatus) {\n+        return new BaseMatcher<WebResponse>() {\n+            @Override\n+            public boolean matches(final Object item) {\n+                final WebResponse response = (WebResponse) item;\n+                return (response.getStatusCode() == httpStatus);\n+            }\n+\n+            @Override\n+            public void describeTo(final Description description) {\n+                description.appendText(\"Jenkins to return  \").appendValue(httpStatus);\n+            }\n+\n+            @Override\n+            public void describeMismatch(Object item, Description description) {\n+                WebResponse response = (WebResponse) item;\n+                description.appendText(\"Response code was: \");\n+                description.appendValue(response.getStatusCode());\n+                description.appendText(\" with error message: \");\n+                description.appendText(response.getStatusMessage());\n+                description.appendText(\"\\n with headers \").appendValueList(\"\", \"\\n    \", \"\", response.getResponseHeaders());\n+                description.appendText(\"\\nPage content: \").appendValue(response.getContentAsString());\n+            }\n+        };\n+    }\n+\n+    // End of HusdonTest\n+    //-------\n+}", "originalCommit": "735193c2ecfbea75ba174af96c5b98a052e9ff5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9c8a44ca34f084c99f4c3623ad64f87741dff442", "url": "https://github.com/jenkinsci/jenkins/commit/9c8a44ca34f084c99f4c3623ad64f87741dff442", "message": "Rename to #getRequiredGlobalConfigPagePermission to disambiguate", "committedDate": "2020-02-18T11:41:00Z", "type": "commit"}, {"oid": "913844de17e7d12f924af3823d58a0bc41fba2ec", "url": "https://github.com/jenkinsci/jenkins/commit/913844de17e7d12f924af3823d58a0bc41fba2ec", "message": "Javadoc improvements, improve description of Manage permission", "committedDate": "2020-02-18T13:09:09Z", "type": "commit"}, {"oid": "b0dd37324facffc5bacbebca8cd0b6409893c9c9", "url": "https://github.com/jenkinsci/jenkins/commit/b0dd37324facffc5bacbebca8cd0b6409893c9c9", "message": "Adapt annotations", "committedDate": "2020-02-18T13:24:24Z", "type": "commit"}]}