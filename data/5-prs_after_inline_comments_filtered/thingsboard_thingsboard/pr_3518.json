{"pr_number": 3518, "pr_title": "Feature/device provision 3.2 version", "pr_createdAt": "2020-09-28T12:50:19Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3518", "timeline": [{"oid": "d228208072eca2ee1d5610280651618c136d50b8", "url": "https://github.com/thingsboard/thingsboard/commit/d228208072eca2ee1d5610280651618c136d50b8", "message": "Provision init", "committedDate": "2020-09-18T13:11:49Z", "type": "commit"}, {"oid": "15be6d60a314d2dbaf9ad09dd4ed05a55349d364", "url": "https://github.com/thingsboard/thingsboard/commit/15be6d60a314d2dbaf9ad09dd4ed05a55349d364", "message": "Added strategy checking", "committedDate": "2020-09-22T05:36:08Z", "type": "commit"}, {"oid": "8a8695f260e0b98615c711a4c0d6b77819a2c26a", "url": "https://github.com/thingsboard/thingsboard/commit/8a8695f260e0b98615c711a4c0d6b77819a2c26a", "message": "Working version for provision feature with provision credentials on device level", "committedDate": "2020-09-23T11:24:44Z", "type": "commit"}, {"oid": "073225ab9fbc142d44a8944f9aba7f3cb8aa3e2f", "url": "https://github.com/thingsboard/thingsboard/commit/073225ab9fbc142d44a8944f9aba7f3cb8aa3e2f", "message": "Working version with provision data only in device profile", "committedDate": "2020-09-23T12:19:06Z", "type": "commit"}, {"oid": "1e44303473848ea1be55c195b3d6250992017f99", "url": "https://github.com/thingsboard/thingsboard/commit/1e44303473848ea1be55c195b3d6250992017f99", "message": "removed debuging", "committedDate": "2020-09-28T11:24:46Z", "type": "commit"}, {"oid": "70b8647ef483d194b7fbfcf21c24e2ed4a42a6ae", "url": "https://github.com/thingsboard/thingsboard/commit/70b8647ef483d194b7fbfcf21c24e2ed4a42a6ae", "message": "Refactoring to use provision data only from device profile", "committedDate": "2020-09-28T12:16:38Z", "type": "commit"}, {"oid": "263dd8f9b3074b98792d8872f97ac7c1aa07b052", "url": "https://github.com/thingsboard/thingsboard/commit/263dd8f9b3074b98792d8872f97ac7c1aa07b052", "message": "Removed provision info from device dao", "committedDate": "2020-09-28T12:48:23Z", "type": "commit"}, {"oid": "b80fc6592bb207718ca601d9adf4e779d04ae542", "url": "https://github.com/thingsboard/thingsboard/commit/b80fc6592bb207718ca601d9adf4e779d04ae542", "message": "Refactoring", "committedDate": "2020-09-28T12:54:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkyNTk3Mg==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r495925972", "bodyText": "Is it need?", "author": "YevhenBondarenko", "createdAt": "2020-09-28T13:10:00Z", "path": "common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/MqttTransportHandler.java", "diffHunk": "@@ -136,10 +136,49 @@ private void processMqttMsg(ChannelHandlerContext ctx, MqttMessage msg) {\n             return;\n         }\n         deviceSessionCtx.setChannel(ctx);\n+        if (CONNECT.equals(msg.fixedHeader().messageType())) {\n+            processConnect(ctx, (MqttConnectMessage) msg);\n+        } else if (deviceSessionCtx.isProvisionOnly()) {\n+            processProvisionSessionMsg(ctx, msg);\n+        } else {\n+            processRegularSessionMsg(ctx, msg);\n+        }\n+    }\n+\n+    private void processProvisionSessionMsg(ChannelHandlerContext ctx, MqttMessage msg) {\n         switch (msg.fixedHeader().messageType()) {\n-            case CONNECT:\n-                processConnect(ctx, (MqttConnectMessage) msg);\n+            case PUBLISH:\n+                MqttPublishMessage mqttMsg = (MqttPublishMessage) msg;\n+                String topicName = mqttMsg.variableHeader().topicName();\n+                int msgId = mqttMsg.variableHeader().packetId();\n+                try {\n+                    if (topicName.equals(MqttTopics.DEVICE_PROVISION_REQUEST_TOPIC)) {\n+                        TransportProtos.ProvisionDeviceRequestMsg provisionRequestMsg = adaptor.convertToProvisionRequestMsg(deviceSessionCtx, mqttMsg);\n+                        transportService.process(provisionRequestMsg, new DeviceProvisionCallback(ctx, msgId, provisionRequestMsg));\n+                        log.trace(\"[{}][{}] Processing publish msg [{}][{}]!\", sessionId, deviceSessionCtx.getDeviceId(), topicName, msgId);\n+                    } else {\n+                        throw new RuntimeException(\"Unsupported topic for provisioning requests!\");\n+                    }\n+                } catch (RuntimeException | AdaptorException e) {\n+                    log.warn(\"[{}] Failed to process publish msg [{}][{}]\", sessionId, topicName, msgId, e);\n+                    ctx.close();\n+                }\n                 break;\n+            case PINGREQ:\n+                ctx.writeAndFlush(new MqttMessage(new MqttFixedHeader(PINGRESP, false, AT_MOST_ONCE, false, 0)));\n+                break;\n+//            case SUBSCRIBE:\n+//                deviceSessionCtx.setDeviceInfo(TransportDeviceInfo);", "originalCommit": "b80fc6592bb207718ca601d9adf4e779d04ae542", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkzMTE1Nw==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r495931157", "bodyText": "Do not need to create DeviceId, new UUID(...).toString() will be enough.", "author": "YevhenBondarenko", "createdAt": "2020-09-28T13:17:42Z", "path": "common/transport/transport-api/src/main/java/org/thingsboard/server/common/transport/adaptor/JsonConverter.java", "diffHunk": "@@ -397,6 +399,34 @@ public static JsonElement toJson(TransportProtos.ToServerRpcResponseMsg msg) {\n         }\n     }\n \n+    public static JsonObject toJson(ProvisionDeviceResponseMsg payload) {\n+        return toJson(payload, false, 0);\n+    }\n+\n+    public static JsonObject toJson(ProvisionDeviceResponseMsg payload, int requestId) {\n+        return toJson(payload, true, requestId);\n+    }\n+\n+    private static JsonObject toJson(ProvisionDeviceResponseMsg payload, boolean toGateway, int requestId) {\n+        JsonObject result = new JsonObject();\n+        if (payload.getProvisionResponseStatus() == TransportProtos.ProvisionResponseStatus.NOT_FOUND) {\n+            result.addProperty(\"errorMsg\", \"Provision data was not found!\");\n+        } else if (payload.getProvisionResponseStatus() == TransportProtos.ProvisionResponseStatus.FAILURE) {\n+            result.addProperty(\"errorMsg\", \"Failed to provision device!\");\n+        } else {\n+            if (toGateway) {\n+                result.addProperty(\"id\", requestId);\n+            }\n+            result.addProperty(\"deviceId\", new DeviceId(\n+                    new UUID(payload.getDeviceCredentials().getDeviceIdMSB(), payload.getDeviceCredentials().getDeviceIdLSB())).toString());", "originalCommit": "b80fc6592bb207718ca601d9adf4e779d04ae542", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkzNTgyOA==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r495935828", "bodyText": "not used", "author": "YevhenBondarenko", "createdAt": "2020-09-28T13:24:20Z", "path": "dao/src/main/java/org/thingsboard/server/dao/sql/device/JpaDeviceProfileDao.java", "diffHunk": "@@ -29,6 +29,7 @@\n import org.thingsboard.server.dao.sql.JpaAbstractSearchTextDao;\n \n import java.util.Objects;\n+import java.util.Optional;", "originalCommit": "b80fc6592bb207718ca601d9adf4e779d04ae542", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkzNjA4OQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r495936089", "bodyText": "not used", "author": "YevhenBondarenko", "createdAt": "2020-09-28T13:24:41Z", "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceProfileDao.java", "diffHunk": "@@ -22,6 +22,7 @@\n import org.thingsboard.server.common.data.page.PageLink;\n import org.thingsboard.server.dao.Dao;\n \n+import java.util.Optional;", "originalCommit": "b80fc6592bb207718ca601d9adf4e779d04ae542", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk0MzgwMQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r495943801", "bodyText": "You can add the final modifier to fields and remove the annotation @AllArgsConstructor. (@DaTa create a constructor with all final fields)", "author": "YevhenBondarenko", "createdAt": "2020-09-28T13:35:38Z", "path": "common/dao-api/src/main/java/org/thingsboard/server/dao/device/provision/ProvisionResponse.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.dao.device.provision;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import org.thingsboard.server.common.data.security.DeviceCredentials;\n+\n+@Data\n+@AllArgsConstructor\n+public class ProvisionResponse {\n+    private DeviceCredentials deviceCredentials;", "originalCommit": "b80fc6592bb207718ca601d9adf4e779d04ae542", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ3NjI2Mg==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r496476262", "bodyText": "if this query is slow, we should replace embedded json fields with separate columns in the device_profle table.", "author": "ashvayka", "createdAt": "2020-09-29T07:28:52Z", "path": "dao/src/main/java/org/thingsboard/server/dao/sql/device/DeviceProfileRepository.java", "diffHunk": "@@ -57,4 +56,14 @@\n \n     DeviceProfileEntity findByTenantIdAndName(UUID id, String profileName);\n \n+    @Query(value = \"SELECT d.* FROM device_profile as d \" +\n+            \"WHERE d.name = :profileName \" +\n+            \"AND d.profile_data->'configuration'->>'provisionDeviceKey' IS NOT NULL \" +\n+            \"AND d.profile_data->'configuration'->>'provisionDeviceSecret' IS NOT NULL \" +\n+            \"AND d.profile_data->'configuration'->>'provisionDeviceKey' = :provisionDeviceKey \" +", "originalCommit": "b80fc6592bb207718ca601d9adf4e779d04ae542", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e86c07599c54d434d44196133f2e2322e0008752", "url": "https://github.com/thingsboard/thingsboard/commit/e86c07599c54d434d44196133f2e2322e0008752", "message": "Merge branch 'develop/3.2' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-09-29T08:17:05Z", "type": "commit"}, {"oid": "950907d3980f9602f8b10a53cf036f5e5698118b", "url": "https://github.com/thingsboard/thingsboard/commit/950907d3980f9602f8b10a53cf036f5e5698118b", "message": "Refactoring according to comments from @YevhenBondarenko", "committedDate": "2020-09-29T08:30:32Z", "type": "commit"}, {"oid": "2704696f2bc6a1abdf55176ddc8183c4655df8c2", "url": "https://github.com/thingsboard/thingsboard/commit/2704696f2bc6a1abdf55176ddc8183c4655df8c2", "message": "Moved provisionDeviceKey as regular column", "committedDate": "2020-10-01T09:23:12Z", "type": "commit"}, {"oid": "1bb1f5be8b34a7f1955cc36929f264a3df4d2037", "url": "https://github.com/thingsboard/thingsboard/commit/1bb1f5be8b34a7f1955cc36929f264a3df4d2037", "message": "Refactoring", "committedDate": "2020-10-02T07:42:34Z", "type": "commit"}, {"oid": "2b1317b10fe432fc0ff666ffb38ed9a9d1393852", "url": "https://github.com/thingsboard/thingsboard/commit/2b1317b10fe432fc0ff666ffb38ed9a9d1393852", "message": "Merge branch 'feature/device-provision-3.2-onlyProfileVersion' of https://github.com/zbeacon/thingsboard into zbeacon-feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-03T07:33:56Z", "type": "commit"}, {"oid": "e8d8382c74c7d76f7050618eae1f36cbff329bc6", "url": "https://github.com/thingsboard/thingsboard/commit/e8d8382c74c7d76f7050618eae1f36cbff329bc6", "message": "UI: Added device provision to device profile", "committedDate": "2020-10-03T21:05:52Z", "type": "commit"}, {"oid": "8c9dda1b4d16b17311e1e91d4d9f0c92edd60e62", "url": "https://github.com/thingsboard/thingsboard/commit/8c9dda1b4d16b17311e1e91d4d9f0c92edd60e62", "message": "Added ability to provision device using protobuf", "committedDate": "2020-10-05T05:51:51Z", "type": "commit"}, {"oid": "dd0ab346257eb78a4378d6a232273d439a061a70", "url": "https://github.com/thingsboard/thingsboard/commit/dd0ab346257eb78a4378d6a232273d439a061a70", "message": "Merge from develop/3.2", "committedDate": "2020-10-05T05:54:44Z", "type": "commit"}, {"oid": "6eac10d60cdd293d68675ce767d67498e1fb2d8e", "url": "https://github.com/thingsboard/thingsboard/commit/6eac10d60cdd293d68675ce767d67498e1fb2d8e", "message": "Merge branch 'develop/3.2' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-05T06:19:01Z", "type": "commit"}, {"oid": "b5969eacc865b379c3522d80e994a3792d8ab660", "url": "https://github.com/thingsboard/thingsboard/commit/b5969eacc865b379c3522d80e994a3792d8ab660", "message": "Improvements", "committedDate": "2020-10-05T07:39:04Z", "type": "commit"}, {"oid": "2020da577d54205c91d963996751d83b9384785c", "url": "https://github.com/thingsboard/thingsboard/commit/2020da577d54205c91d963996751d83b9384785c", "message": "Changed provision device key/secret fields position in UI", "committedDate": "2020-10-05T07:40:47Z", "type": "commit"}, {"oid": "0c56a1d8d85a02b786e15c7e762e2a99a7f42cf0", "url": "https://github.com/thingsboard/thingsboard/commit/0c56a1d8d85a02b786e15c7e762e2a99a7f42cf0", "message": "Improvements", "committedDate": "2020-10-05T11:44:43Z", "type": "commit"}, {"oid": "9a022c1a52737d5420ab2ad049c387a31f6d6184", "url": "https://github.com/thingsboard/thingsboard/commit/9a022c1a52737d5420ab2ad049c387a31f6d6184", "message": "Merge branch 'develop/3.2' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-05T12:24:18Z", "type": "commit"}, {"oid": "fd80cda30a98a3b6a4bd3ba8a939f6b9d6d43bb4", "url": "https://github.com/thingsboard/thingsboard/commit/fd80cda30a98a3b6a4bd3ba8a939f6b9d6d43bb4", "message": "Added TbCoreComponent annotation", "committedDate": "2020-10-06T06:50:47Z", "type": "commit"}, {"oid": "0751824c3329b3b6b963cf512e27187dc9acd4a8", "url": "https://github.com/thingsboard/thingsboard/commit/0751824c3329b3b6b963cf512e27187dc9acd4a8", "message": "Merge branch 'develop/3.2' into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-06T09:47:03Z", "type": "commit"}, {"oid": "616f6a8b4f8a7ba1d84012d6c84440abea1c5a03", "url": "https://github.com/thingsboard/thingsboard/commit/616f6a8b4f8a7ba1d84012d6c84440abea1c5a03", "message": "Changed Provision statuses", "committedDate": "2020-10-06T14:17:50Z", "type": "commit"}, {"oid": "2ec09e08ff377d84b02e1223009bb76dc0aad594", "url": "https://github.com/thingsboard/thingsboard/commit/2ec09e08ff377d84b02e1223009bb76dc0aad594", "message": "Added ProvisionTransportType to get protocol", "committedDate": "2020-10-06T15:27:58Z", "type": "commit"}, {"oid": "6d0dc981a0837defaa37c30f2a0edbf4f62fccaf", "url": "https://github.com/thingsboard/thingsboard/commit/6d0dc981a0837defaa37c30f2a0edbf4f62fccaf", "message": "Adding tests for device provisioning feature", "committedDate": "2020-10-06T15:28:44Z", "type": "commit"}, {"oid": "16732dfaa938fc6f496596f88289ccf6d719958d", "url": "https://github.com/thingsboard/thingsboard/commit/16732dfaa938fc6f496596f88289ccf6d719958d", "message": "Merge branch 'feature/device-provision-3.2-onlyProfileVersion' of https://github.com/zbeacon/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-06T15:29:03Z", "type": "commit"}, {"oid": "dc9957611339bf06627a1b0733f7bfc431e5d42b", "url": "https://github.com/thingsboard/thingsboard/commit/dc9957611339bf06627a1b0733f7bfc431e5d42b", "message": "Merge branch 'develop/3.2' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-06T15:29:26Z", "type": "commit"}, {"oid": "e8220e5102ff5e3fb75ede9aff16bed0fbcf1503", "url": "https://github.com/thingsboard/thingsboard/commit/e8220e5102ff5e3fb75ede9aff16bed0fbcf1503", "message": "Merge branch 'develop/3.2' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-07T07:36:15Z", "type": "commit"}, {"oid": "4494f3dd67504a4e488869868ba3eade8bf087b7", "url": "https://github.com/thingsboard/thingsboard/commit/4494f3dd67504a4e488869868ba3eade8bf087b7", "message": "Fix for tests", "committedDate": "2020-10-07T09:10:05Z", "type": "commit"}, {"oid": "08e4b38b1393dc65ff86583c67b5527f5ed5d495", "url": "https://github.com/thingsboard/thingsboard/commit/08e4b38b1393dc65ff86583c67b5527f5ed5d495", "message": "Merge branch 'feature/device-provision-3.2-onlyProfileVersion' of https://github.com/zbeacon/thingsboard into zbeacon-feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-07T09:13:19Z", "type": "commit"}, {"oid": "ab9199d8b8d323b4f79c7f066203e535f1f4f1ed", "url": "https://github.com/thingsboard/thingsboard/commit/ab9199d8b8d323b4f79c7f066203e535f1f4f1ed", "message": "Update locale.constant-en_US.json", "committedDate": "2020-10-07T09:56:35Z", "type": "commit"}, {"oid": "5dd460b81d616852ef1bd216a20aae0ca0fdc7c0", "url": "https://github.com/thingsboard/thingsboard/commit/5dd460b81d616852ef1bd216a20aae0ca0fdc7c0", "message": "Some improvements", "committedDate": "2020-10-07T11:13:25Z", "type": "commit"}, {"oid": "adf5069da1b0f3f8f66c98e01290c70259a3f67d", "url": "https://github.com/thingsboard/thingsboard/commit/adf5069da1b0f3f8f66c98e01290c70259a3f67d", "message": "Added ability to provision credentials type from device using provision feature", "committedDate": "2020-10-08T12:08:29Z", "type": "commit"}, {"oid": "d1167bca0f3b528e758a36218a6aadfe1b70c3ff", "url": "https://github.com/thingsboard/thingsboard/commit/d1167bca0f3b528e758a36218a6aadfe1b70c3ff", "message": "Merge branch 'feature/device-provision-3.2-onlyProfileVersion' of https://github.com/zbeacon/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-08T12:16:44Z", "type": "commit"}, {"oid": "6df92197900df6cb750920100eebc0b1d2265354", "url": "https://github.com/thingsboard/thingsboard/commit/6df92197900df6cb750920100eebc0b1d2265354", "message": "Improvements for provisioning", "committedDate": "2020-10-08T13:13:45Z", "type": "commit"}, {"oid": "17ca3cfab4e5f9cf47949318d4e3fe6626eed73c", "url": "https://github.com/thingsboard/thingsboard/commit/17ca3cfab4e5f9cf47949318d4e3fe6626eed73c", "message": "Refactoring", "committedDate": "2020-10-08T13:51:28Z", "type": "commit"}, {"oid": "6b72e82104a2cb0f20efc3e036bd72d804e41f4e", "url": "https://github.com/thingsboard/thingsboard/commit/6b72e82104a2cb0f20efc3e036bd72d804e41f4e", "message": "Improvement", "committedDate": "2020-10-08T14:30:35Z", "type": "commit"}, {"oid": "d032b0a3f7a5394cfe3bbefb54a5e1ff96ce7f3e", "url": "https://github.com/thingsboard/thingsboard/commit/d032b0a3f7a5394cfe3bbefb54a5e1ff96ce7f3e", "message": "Adding tests", "committedDate": "2020-10-09T06:28:04Z", "type": "commit"}, {"oid": "6683158c6b262ed930db41c3ced73efec94320aa", "url": "https://github.com/thingsboard/thingsboard/commit/6683158c6b262ed930db41c3ced73efec94320aa", "message": "Merge branch 'master' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-09T06:53:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxODc2OA==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502318768", "bodyText": "Why you return Future if you don't have any async operations in the implementation?", "author": "ashvayka", "createdAt": "2020-10-09T09:54:45Z", "path": "application/src/main/java/org/thingsboard/server/service/device/DeviceProvisionServiceImpl.java", "diffHunk": "@@ -0,0 +1,326 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.service.device;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.StringUtils;\n+import org.thingsboard.server.common.data.DataConstants;\n+import org.thingsboard.server.common.data.Device;\n+import org.thingsboard.server.common.data.DeviceProfile;\n+import org.thingsboard.server.common.data.audit.ActionType;\n+import org.thingsboard.server.common.data.device.credentials.BasicMqttCredentials;\n+import org.thingsboard.server.common.data.device.profile.AllowCreateNewDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.device.profile.CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.id.CustomerId;\n+import org.thingsboard.server.common.data.id.TenantId;\n+import org.thingsboard.server.common.data.id.UserId;\n+import org.thingsboard.server.common.data.kv.AttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.BaseAttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.StringDataEntry;\n+import org.thingsboard.server.common.data.security.DeviceCredentials;\n+import org.thingsboard.server.common.msg.TbMsg;\n+import org.thingsboard.server.common.msg.TbMsgMetaData;\n+import org.thingsboard.server.common.msg.queue.ServiceType;\n+import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;\n+import org.thingsboard.server.dao.attributes.AttributesService;\n+import org.thingsboard.server.dao.audit.AuditLogService;\n+import org.thingsboard.server.dao.device.DeviceCredentialsService;\n+import org.thingsboard.server.dao.device.DeviceDao;\n+import org.thingsboard.server.dao.device.DeviceProfileDao;\n+import org.thingsboard.server.dao.device.DeviceProvisionService;\n+import org.thingsboard.server.dao.device.DeviceService;\n+import org.thingsboard.server.dao.device.provision.ProvisionRequest;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponse;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;\n+import org.thingsboard.server.dao.util.mapping.JacksonUtil;\n+import org.thingsboard.server.gen.transport.TransportProtos;\n+import org.thingsboard.server.gen.transport.TransportProtos.ToRuleEngineMsg;\n+import org.thingsboard.server.queue.TbQueueCallback;\n+import org.thingsboard.server.queue.TbQueueProducer;\n+import org.thingsboard.server.queue.common.TbProtoQueueMsg;\n+import org.thingsboard.server.queue.discovery.PartitionService;\n+import org.thingsboard.server.queue.provider.TbQueueProducerProvider;\n+import org.thingsboard.server.queue.util.TbCoreComponent;\n+import org.thingsboard.server.service.state.DeviceStateService;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+\n+@Service\n+@Slf4j\n+@TbCoreComponent\n+public class DeviceProvisionServiceImpl implements DeviceProvisionService {\n+\n+    protected TbQueueProducer<TbProtoQueueMsg<ToRuleEngineMsg>> ruleEngineMsgProducer;\n+\n+    private static final String DEVICE_PROVISION_STATE = \"provisionState\";\n+    private static final String PROVISIONED_STATE = \"provisioned\";\n+\n+    private final ReentrantLock deviceCreationLock = new ReentrantLock();\n+\n+    @Autowired\n+    DeviceDao deviceDao;\n+\n+    @Autowired\n+    DeviceProfileDao deviceProfileDao;\n+\n+    @Autowired\n+    DeviceService deviceService;\n+\n+    @Autowired\n+    DeviceCredentialsService deviceCredentialsService;\n+\n+    @Autowired\n+    AttributesService attributesService;\n+\n+    @Autowired\n+    DeviceStateService deviceStateService;\n+\n+    @Autowired\n+    AuditLogService auditLogService;\n+\n+    @Autowired\n+    PartitionService partitionService;\n+\n+    public DeviceProvisionServiceImpl(TbQueueProducerProvider producerProvider) {\n+        ruleEngineMsgProducer = producerProvider.getRuleEngineMsgProducer();\n+    }\n+\n+    @Override\n+    public ListenableFuture<ProvisionResponse> provisionDevice(ProvisionRequest provisionRequest) {\n+        String provisionRequestKey = provisionRequest.getCredentials().getProvisionDeviceKey();\n+        String provisionRequestSecret = provisionRequest.getCredentials().getProvisionDeviceSecret();\n+\n+        if (StringUtils.isEmpty(provisionRequestKey) || StringUtils.isEmpty(provisionRequestSecret)) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        if (provisionRequest.getCredentialsType() != null) {\n+            ListenableFuture<ProvisionResponse> error = validateCredentials(provisionRequest);\n+            if (error != null) {\n+                return error;\n+            }\n+        }\n+\n+        DeviceProfile targetProfile = deviceProfileDao.findByProvisionDeviceKey(provisionRequestKey);\n+\n+        if (targetProfile == null) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        Device targetDevice = deviceDao.findDeviceByTenantIdAndName(targetProfile.getTenantId().getId(), provisionRequest.getDeviceName()).orElse(null);\n+\n+        switch (targetProfile.getProvisionType()) {\n+            case ALLOW_CREATE_NEW_DEVICES:\n+                if (((AllowCreateNewDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null) {\n+                        log.warn(\"[{}] The device is present and could not be provisioned once more!\", targetDevice.getName());\n+                        notify(targetDevice, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    } else {\n+                        return createDevice(provisionRequest, targetProfile);\n+                    }\n+                }\n+                break;\n+            case CHECK_PRE_PROVISIONED_DEVICES:\n+                if (((CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null && targetDevice.getDeviceProfileId().equals(targetProfile.getId())) {\n+                        return processProvision(targetDevice, provisionRequest);\n+                    } else {\n+                        log.warn(\"[{}] Failed to find pre provisioned device!\", provisionRequest.getDeviceName());\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    }\n+                }\n+                break;\n+        }\n+        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> validateCredentials(ProvisionRequest provisionRequest) {", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyMjA0Ng==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502322046", "bodyText": "Make new method \"getProvisionConfiguration\" in ProvisionConfiguration interface and avoid all this casts.", "author": "ashvayka", "createdAt": "2020-10-09T10:00:38Z", "path": "application/src/main/java/org/thingsboard/server/service/device/DeviceProvisionServiceImpl.java", "diffHunk": "@@ -0,0 +1,326 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.service.device;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.StringUtils;\n+import org.thingsboard.server.common.data.DataConstants;\n+import org.thingsboard.server.common.data.Device;\n+import org.thingsboard.server.common.data.DeviceProfile;\n+import org.thingsboard.server.common.data.audit.ActionType;\n+import org.thingsboard.server.common.data.device.credentials.BasicMqttCredentials;\n+import org.thingsboard.server.common.data.device.profile.AllowCreateNewDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.device.profile.CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.id.CustomerId;\n+import org.thingsboard.server.common.data.id.TenantId;\n+import org.thingsboard.server.common.data.id.UserId;\n+import org.thingsboard.server.common.data.kv.AttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.BaseAttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.StringDataEntry;\n+import org.thingsboard.server.common.data.security.DeviceCredentials;\n+import org.thingsboard.server.common.msg.TbMsg;\n+import org.thingsboard.server.common.msg.TbMsgMetaData;\n+import org.thingsboard.server.common.msg.queue.ServiceType;\n+import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;\n+import org.thingsboard.server.dao.attributes.AttributesService;\n+import org.thingsboard.server.dao.audit.AuditLogService;\n+import org.thingsboard.server.dao.device.DeviceCredentialsService;\n+import org.thingsboard.server.dao.device.DeviceDao;\n+import org.thingsboard.server.dao.device.DeviceProfileDao;\n+import org.thingsboard.server.dao.device.DeviceProvisionService;\n+import org.thingsboard.server.dao.device.DeviceService;\n+import org.thingsboard.server.dao.device.provision.ProvisionRequest;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponse;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;\n+import org.thingsboard.server.dao.util.mapping.JacksonUtil;\n+import org.thingsboard.server.gen.transport.TransportProtos;\n+import org.thingsboard.server.gen.transport.TransportProtos.ToRuleEngineMsg;\n+import org.thingsboard.server.queue.TbQueueCallback;\n+import org.thingsboard.server.queue.TbQueueProducer;\n+import org.thingsboard.server.queue.common.TbProtoQueueMsg;\n+import org.thingsboard.server.queue.discovery.PartitionService;\n+import org.thingsboard.server.queue.provider.TbQueueProducerProvider;\n+import org.thingsboard.server.queue.util.TbCoreComponent;\n+import org.thingsboard.server.service.state.DeviceStateService;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+\n+@Service\n+@Slf4j\n+@TbCoreComponent\n+public class DeviceProvisionServiceImpl implements DeviceProvisionService {\n+\n+    protected TbQueueProducer<TbProtoQueueMsg<ToRuleEngineMsg>> ruleEngineMsgProducer;\n+\n+    private static final String DEVICE_PROVISION_STATE = \"provisionState\";\n+    private static final String PROVISIONED_STATE = \"provisioned\";\n+\n+    private final ReentrantLock deviceCreationLock = new ReentrantLock();\n+\n+    @Autowired\n+    DeviceDao deviceDao;\n+\n+    @Autowired\n+    DeviceProfileDao deviceProfileDao;\n+\n+    @Autowired\n+    DeviceService deviceService;\n+\n+    @Autowired\n+    DeviceCredentialsService deviceCredentialsService;\n+\n+    @Autowired\n+    AttributesService attributesService;\n+\n+    @Autowired\n+    DeviceStateService deviceStateService;\n+\n+    @Autowired\n+    AuditLogService auditLogService;\n+\n+    @Autowired\n+    PartitionService partitionService;\n+\n+    public DeviceProvisionServiceImpl(TbQueueProducerProvider producerProvider) {\n+        ruleEngineMsgProducer = producerProvider.getRuleEngineMsgProducer();\n+    }\n+\n+    @Override\n+    public ListenableFuture<ProvisionResponse> provisionDevice(ProvisionRequest provisionRequest) {\n+        String provisionRequestKey = provisionRequest.getCredentials().getProvisionDeviceKey();\n+        String provisionRequestSecret = provisionRequest.getCredentials().getProvisionDeviceSecret();\n+\n+        if (StringUtils.isEmpty(provisionRequestKey) || StringUtils.isEmpty(provisionRequestSecret)) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        if (provisionRequest.getCredentialsType() != null) {\n+            ListenableFuture<ProvisionResponse> error = validateCredentials(provisionRequest);\n+            if (error != null) {\n+                return error;\n+            }\n+        }\n+\n+        DeviceProfile targetProfile = deviceProfileDao.findByProvisionDeviceKey(provisionRequestKey);\n+\n+        if (targetProfile == null) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        Device targetDevice = deviceDao.findDeviceByTenantIdAndName(targetProfile.getTenantId().getId(), provisionRequest.getDeviceName()).orElse(null);\n+\n+        switch (targetProfile.getProvisionType()) {\n+            case ALLOW_CREATE_NEW_DEVICES:\n+                if (((AllowCreateNewDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyMjkyMw==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502322923", "bodyText": "}else{\n..\n}", "author": "ashvayka", "createdAt": "2020-10-09T10:02:23Z", "path": "application/src/main/java/org/thingsboard/server/service/device/DeviceProvisionServiceImpl.java", "diffHunk": "@@ -0,0 +1,326 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.service.device;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.StringUtils;\n+import org.thingsboard.server.common.data.DataConstants;\n+import org.thingsboard.server.common.data.Device;\n+import org.thingsboard.server.common.data.DeviceProfile;\n+import org.thingsboard.server.common.data.audit.ActionType;\n+import org.thingsboard.server.common.data.device.credentials.BasicMqttCredentials;\n+import org.thingsboard.server.common.data.device.profile.AllowCreateNewDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.device.profile.CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.id.CustomerId;\n+import org.thingsboard.server.common.data.id.TenantId;\n+import org.thingsboard.server.common.data.id.UserId;\n+import org.thingsboard.server.common.data.kv.AttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.BaseAttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.StringDataEntry;\n+import org.thingsboard.server.common.data.security.DeviceCredentials;\n+import org.thingsboard.server.common.msg.TbMsg;\n+import org.thingsboard.server.common.msg.TbMsgMetaData;\n+import org.thingsboard.server.common.msg.queue.ServiceType;\n+import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;\n+import org.thingsboard.server.dao.attributes.AttributesService;\n+import org.thingsboard.server.dao.audit.AuditLogService;\n+import org.thingsboard.server.dao.device.DeviceCredentialsService;\n+import org.thingsboard.server.dao.device.DeviceDao;\n+import org.thingsboard.server.dao.device.DeviceProfileDao;\n+import org.thingsboard.server.dao.device.DeviceProvisionService;\n+import org.thingsboard.server.dao.device.DeviceService;\n+import org.thingsboard.server.dao.device.provision.ProvisionRequest;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponse;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;\n+import org.thingsboard.server.dao.util.mapping.JacksonUtil;\n+import org.thingsboard.server.gen.transport.TransportProtos;\n+import org.thingsboard.server.gen.transport.TransportProtos.ToRuleEngineMsg;\n+import org.thingsboard.server.queue.TbQueueCallback;\n+import org.thingsboard.server.queue.TbQueueProducer;\n+import org.thingsboard.server.queue.common.TbProtoQueueMsg;\n+import org.thingsboard.server.queue.discovery.PartitionService;\n+import org.thingsboard.server.queue.provider.TbQueueProducerProvider;\n+import org.thingsboard.server.queue.util.TbCoreComponent;\n+import org.thingsboard.server.service.state.DeviceStateService;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+\n+@Service\n+@Slf4j\n+@TbCoreComponent\n+public class DeviceProvisionServiceImpl implements DeviceProvisionService {\n+\n+    protected TbQueueProducer<TbProtoQueueMsg<ToRuleEngineMsg>> ruleEngineMsgProducer;\n+\n+    private static final String DEVICE_PROVISION_STATE = \"provisionState\";\n+    private static final String PROVISIONED_STATE = \"provisioned\";\n+\n+    private final ReentrantLock deviceCreationLock = new ReentrantLock();\n+\n+    @Autowired\n+    DeviceDao deviceDao;\n+\n+    @Autowired\n+    DeviceProfileDao deviceProfileDao;\n+\n+    @Autowired\n+    DeviceService deviceService;\n+\n+    @Autowired\n+    DeviceCredentialsService deviceCredentialsService;\n+\n+    @Autowired\n+    AttributesService attributesService;\n+\n+    @Autowired\n+    DeviceStateService deviceStateService;\n+\n+    @Autowired\n+    AuditLogService auditLogService;\n+\n+    @Autowired\n+    PartitionService partitionService;\n+\n+    public DeviceProvisionServiceImpl(TbQueueProducerProvider producerProvider) {\n+        ruleEngineMsgProducer = producerProvider.getRuleEngineMsgProducer();\n+    }\n+\n+    @Override\n+    public ListenableFuture<ProvisionResponse> provisionDevice(ProvisionRequest provisionRequest) {\n+        String provisionRequestKey = provisionRequest.getCredentials().getProvisionDeviceKey();\n+        String provisionRequestSecret = provisionRequest.getCredentials().getProvisionDeviceSecret();\n+\n+        if (StringUtils.isEmpty(provisionRequestKey) || StringUtils.isEmpty(provisionRequestSecret)) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        if (provisionRequest.getCredentialsType() != null) {\n+            ListenableFuture<ProvisionResponse> error = validateCredentials(provisionRequest);\n+            if (error != null) {\n+                return error;\n+            }\n+        }\n+\n+        DeviceProfile targetProfile = deviceProfileDao.findByProvisionDeviceKey(provisionRequestKey);\n+\n+        if (targetProfile == null) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        Device targetDevice = deviceDao.findDeviceByTenantIdAndName(targetProfile.getTenantId().getId(), provisionRequest.getDeviceName()).orElse(null);\n+\n+        switch (targetProfile.getProvisionType()) {\n+            case ALLOW_CREATE_NEW_DEVICES:\n+                if (((AllowCreateNewDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null) {\n+                        log.warn(\"[{}] The device is present and could not be provisioned once more!\", targetDevice.getName());\n+                        notify(targetDevice, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    } else {\n+                        return createDevice(provisionRequest, targetProfile);\n+                    }\n+                }\n+                break;\n+            case CHECK_PRE_PROVISIONED_DEVICES:\n+                if (((CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null && targetDevice.getDeviceProfileId().equals(targetProfile.getId())) {\n+                        return processProvision(targetDevice, provisionRequest);\n+                    } else {\n+                        log.warn(\"[{}] Failed to find pre provisioned device!\", provisionRequest.getDeviceName());\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    }\n+                }\n+                break;\n+        }\n+        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> validateCredentials(ProvisionRequest provisionRequest) {\n+        switch (provisionRequest.getCredentialsType()) {\n+            case MQTT_BASIC:\n+                if (StringUtils.isEmpty(provisionRequest.getCredentialsData().getClientId()) ||\n+                        StringUtils.isEmpty(provisionRequest.getCredentialsData().getUsername()) ||\n+                        StringUtils.isEmpty(provisionRequest.getCredentialsData().getPassword())) {\n+                    log.error(\"Failed to get basic mqtt credentials from credentials data!\");\n+                    return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                }\n+                break;\n+            case X509_CERTIFICATE:\n+                if (StringUtils.isEmpty(provisionRequest.getCredentialsData().getHash())) {\n+                    log.error(\"Failed to get hash from credentials data!\");\n+                    return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                }\n+                break;\n+        }\n+        return null;\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> processProvision(Device device, ProvisionRequest provisionRequest) {\n+        ListenableFuture<Optional<AttributeKvEntry>> provisionStateFuture = attributesService.find(device.getTenantId(), device.getId(),\n+                DataConstants.SERVER_SCOPE, DEVICE_PROVISION_STATE);\n+        ListenableFuture<Boolean> provisionedFuture = Futures.transformAsync(provisionStateFuture, optionalAtr -> {\n+            if (optionalAtr.isPresent()) {\n+                String state = optionalAtr.get().getValueAsString();\n+                if (state.equals(PROVISIONED_STATE)) {\n+                    return Futures.immediateFuture(true);\n+                } else {\n+                    log.error(\"[{}][{}] Unknown provision state: {}!\", device.getName(), DEVICE_PROVISION_STATE, state);\n+                    return Futures.immediateCancelledFuture();\n+                }\n+            }\n+            return Futures.transform(saveProvisionStateAttribute(device), input -> false, MoreExecutors.directExecutor());\n+        }, MoreExecutors.directExecutor());\n+        if (provisionedFuture.isCancelled()) {\n+            throw new RuntimeException(\"Unknown provision state!\");\n+        }\n+        return Futures.transform(provisionedFuture, provisioned -> {\n+            if (provisioned) {\n+                notify(device, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+                return new ProvisionResponse(null, ProvisionResponseStatus.FAILURE);\n+            }\n+            notify(device, provisionRequest, DataConstants.PROVISION_SUCCESS, true);\n+            return new ProvisionResponse(deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), device.getId()), ProvisionResponseStatus.SUCCESS);\n+        }, MoreExecutors.directExecutor());\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> createDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {\n+        deviceCreationLock.lock();\n+        try {\n+            return processCreateDevice(provisionRequest, profile);\n+        } finally {\n+            deviceCreationLock.unlock();\n+        }\n+    }\n+\n+    private void notify(Device device, ProvisionRequest provisionRequest, String type, boolean success) {\n+        pushProvisionEventToRuleEngine(provisionRequest, device, type);\n+        logAction(device.getTenantId(), device.getCustomerId(), device, success, provisionRequest);\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> processCreateDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {\n+        Device device = deviceService.findDeviceByTenantIdAndName(profile.getTenantId(), provisionRequest.getDeviceName());\n+        if (device == null) {\n+            Device savedDevice = saveDevice(provisionRequest, profile);\n+\n+            deviceStateService.onDeviceAdded(savedDevice);\n+            pushDeviceCreatedEventToRuleEngine(savedDevice);\n+            notify(savedDevice, provisionRequest, DataConstants.PROVISION_SUCCESS, true);\n+\n+            return Futures.transform(saveProvisionStateAttribute(savedDevice), input ->\n+                    new ProvisionResponse(\n+                            getDeviceCredentials(savedDevice),\n+                            ProvisionResponseStatus.SUCCESS), MoreExecutors.directExecutor());\n+        }", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyMzQ5Mg==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502323492", "bodyText": "Where is ACCESS_TOKEN case?", "author": "ashvayka", "createdAt": "2020-10-09T10:03:26Z", "path": "application/src/main/java/org/thingsboard/server/service/device/DeviceProvisionServiceImpl.java", "diffHunk": "@@ -0,0 +1,326 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.service.device;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.StringUtils;\n+import org.thingsboard.server.common.data.DataConstants;\n+import org.thingsboard.server.common.data.Device;\n+import org.thingsboard.server.common.data.DeviceProfile;\n+import org.thingsboard.server.common.data.audit.ActionType;\n+import org.thingsboard.server.common.data.device.credentials.BasicMqttCredentials;\n+import org.thingsboard.server.common.data.device.profile.AllowCreateNewDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.device.profile.CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.id.CustomerId;\n+import org.thingsboard.server.common.data.id.TenantId;\n+import org.thingsboard.server.common.data.id.UserId;\n+import org.thingsboard.server.common.data.kv.AttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.BaseAttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.StringDataEntry;\n+import org.thingsboard.server.common.data.security.DeviceCredentials;\n+import org.thingsboard.server.common.msg.TbMsg;\n+import org.thingsboard.server.common.msg.TbMsgMetaData;\n+import org.thingsboard.server.common.msg.queue.ServiceType;\n+import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;\n+import org.thingsboard.server.dao.attributes.AttributesService;\n+import org.thingsboard.server.dao.audit.AuditLogService;\n+import org.thingsboard.server.dao.device.DeviceCredentialsService;\n+import org.thingsboard.server.dao.device.DeviceDao;\n+import org.thingsboard.server.dao.device.DeviceProfileDao;\n+import org.thingsboard.server.dao.device.DeviceProvisionService;\n+import org.thingsboard.server.dao.device.DeviceService;\n+import org.thingsboard.server.dao.device.provision.ProvisionRequest;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponse;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;\n+import org.thingsboard.server.dao.util.mapping.JacksonUtil;\n+import org.thingsboard.server.gen.transport.TransportProtos;\n+import org.thingsboard.server.gen.transport.TransportProtos.ToRuleEngineMsg;\n+import org.thingsboard.server.queue.TbQueueCallback;\n+import org.thingsboard.server.queue.TbQueueProducer;\n+import org.thingsboard.server.queue.common.TbProtoQueueMsg;\n+import org.thingsboard.server.queue.discovery.PartitionService;\n+import org.thingsboard.server.queue.provider.TbQueueProducerProvider;\n+import org.thingsboard.server.queue.util.TbCoreComponent;\n+import org.thingsboard.server.service.state.DeviceStateService;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+\n+@Service\n+@Slf4j\n+@TbCoreComponent\n+public class DeviceProvisionServiceImpl implements DeviceProvisionService {\n+\n+    protected TbQueueProducer<TbProtoQueueMsg<ToRuleEngineMsg>> ruleEngineMsgProducer;\n+\n+    private static final String DEVICE_PROVISION_STATE = \"provisionState\";\n+    private static final String PROVISIONED_STATE = \"provisioned\";\n+\n+    private final ReentrantLock deviceCreationLock = new ReentrantLock();\n+\n+    @Autowired\n+    DeviceDao deviceDao;\n+\n+    @Autowired\n+    DeviceProfileDao deviceProfileDao;\n+\n+    @Autowired\n+    DeviceService deviceService;\n+\n+    @Autowired\n+    DeviceCredentialsService deviceCredentialsService;\n+\n+    @Autowired\n+    AttributesService attributesService;\n+\n+    @Autowired\n+    DeviceStateService deviceStateService;\n+\n+    @Autowired\n+    AuditLogService auditLogService;\n+\n+    @Autowired\n+    PartitionService partitionService;\n+\n+    public DeviceProvisionServiceImpl(TbQueueProducerProvider producerProvider) {\n+        ruleEngineMsgProducer = producerProvider.getRuleEngineMsgProducer();\n+    }\n+\n+    @Override\n+    public ListenableFuture<ProvisionResponse> provisionDevice(ProvisionRequest provisionRequest) {\n+        String provisionRequestKey = provisionRequest.getCredentials().getProvisionDeviceKey();\n+        String provisionRequestSecret = provisionRequest.getCredentials().getProvisionDeviceSecret();\n+\n+        if (StringUtils.isEmpty(provisionRequestKey) || StringUtils.isEmpty(provisionRequestSecret)) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        if (provisionRequest.getCredentialsType() != null) {\n+            ListenableFuture<ProvisionResponse> error = validateCredentials(provisionRequest);\n+            if (error != null) {\n+                return error;\n+            }\n+        }\n+\n+        DeviceProfile targetProfile = deviceProfileDao.findByProvisionDeviceKey(provisionRequestKey);\n+\n+        if (targetProfile == null) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        Device targetDevice = deviceDao.findDeviceByTenantIdAndName(targetProfile.getTenantId().getId(), provisionRequest.getDeviceName()).orElse(null);\n+\n+        switch (targetProfile.getProvisionType()) {\n+            case ALLOW_CREATE_NEW_DEVICES:\n+                if (((AllowCreateNewDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null) {\n+                        log.warn(\"[{}] The device is present and could not be provisioned once more!\", targetDevice.getName());\n+                        notify(targetDevice, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    } else {\n+                        return createDevice(provisionRequest, targetProfile);\n+                    }\n+                }\n+                break;\n+            case CHECK_PRE_PROVISIONED_DEVICES:\n+                if (((CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null && targetDevice.getDeviceProfileId().equals(targetProfile.getId())) {\n+                        return processProvision(targetDevice, provisionRequest);\n+                    } else {\n+                        log.warn(\"[{}] Failed to find pre provisioned device!\", provisionRequest.getDeviceName());\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    }\n+                }\n+                break;\n+        }\n+        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> validateCredentials(ProvisionRequest provisionRequest) {\n+        switch (provisionRequest.getCredentialsType()) {", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyMzg1OQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502323859", "bodyText": "There is a method \"valueToTree\" in the JacksonUtil", "author": "ashvayka", "createdAt": "2020-10-09T10:04:10Z", "path": "application/src/main/java/org/thingsboard/server/service/device/DeviceProvisionServiceImpl.java", "diffHunk": "@@ -0,0 +1,326 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.service.device;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.StringUtils;\n+import org.thingsboard.server.common.data.DataConstants;\n+import org.thingsboard.server.common.data.Device;\n+import org.thingsboard.server.common.data.DeviceProfile;\n+import org.thingsboard.server.common.data.audit.ActionType;\n+import org.thingsboard.server.common.data.device.credentials.BasicMqttCredentials;\n+import org.thingsboard.server.common.data.device.profile.AllowCreateNewDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.device.profile.CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.id.CustomerId;\n+import org.thingsboard.server.common.data.id.TenantId;\n+import org.thingsboard.server.common.data.id.UserId;\n+import org.thingsboard.server.common.data.kv.AttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.BaseAttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.StringDataEntry;\n+import org.thingsboard.server.common.data.security.DeviceCredentials;\n+import org.thingsboard.server.common.msg.TbMsg;\n+import org.thingsboard.server.common.msg.TbMsgMetaData;\n+import org.thingsboard.server.common.msg.queue.ServiceType;\n+import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;\n+import org.thingsboard.server.dao.attributes.AttributesService;\n+import org.thingsboard.server.dao.audit.AuditLogService;\n+import org.thingsboard.server.dao.device.DeviceCredentialsService;\n+import org.thingsboard.server.dao.device.DeviceDao;\n+import org.thingsboard.server.dao.device.DeviceProfileDao;\n+import org.thingsboard.server.dao.device.DeviceProvisionService;\n+import org.thingsboard.server.dao.device.DeviceService;\n+import org.thingsboard.server.dao.device.provision.ProvisionRequest;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponse;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;\n+import org.thingsboard.server.dao.util.mapping.JacksonUtil;\n+import org.thingsboard.server.gen.transport.TransportProtos;\n+import org.thingsboard.server.gen.transport.TransportProtos.ToRuleEngineMsg;\n+import org.thingsboard.server.queue.TbQueueCallback;\n+import org.thingsboard.server.queue.TbQueueProducer;\n+import org.thingsboard.server.queue.common.TbProtoQueueMsg;\n+import org.thingsboard.server.queue.discovery.PartitionService;\n+import org.thingsboard.server.queue.provider.TbQueueProducerProvider;\n+import org.thingsboard.server.queue.util.TbCoreComponent;\n+import org.thingsboard.server.service.state.DeviceStateService;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+\n+@Service\n+@Slf4j\n+@TbCoreComponent\n+public class DeviceProvisionServiceImpl implements DeviceProvisionService {\n+\n+    protected TbQueueProducer<TbProtoQueueMsg<ToRuleEngineMsg>> ruleEngineMsgProducer;\n+\n+    private static final String DEVICE_PROVISION_STATE = \"provisionState\";\n+    private static final String PROVISIONED_STATE = \"provisioned\";\n+\n+    private final ReentrantLock deviceCreationLock = new ReentrantLock();\n+\n+    @Autowired\n+    DeviceDao deviceDao;\n+\n+    @Autowired\n+    DeviceProfileDao deviceProfileDao;\n+\n+    @Autowired\n+    DeviceService deviceService;\n+\n+    @Autowired\n+    DeviceCredentialsService deviceCredentialsService;\n+\n+    @Autowired\n+    AttributesService attributesService;\n+\n+    @Autowired\n+    DeviceStateService deviceStateService;\n+\n+    @Autowired\n+    AuditLogService auditLogService;\n+\n+    @Autowired\n+    PartitionService partitionService;\n+\n+    public DeviceProvisionServiceImpl(TbQueueProducerProvider producerProvider) {\n+        ruleEngineMsgProducer = producerProvider.getRuleEngineMsgProducer();\n+    }\n+\n+    @Override\n+    public ListenableFuture<ProvisionResponse> provisionDevice(ProvisionRequest provisionRequest) {\n+        String provisionRequestKey = provisionRequest.getCredentials().getProvisionDeviceKey();\n+        String provisionRequestSecret = provisionRequest.getCredentials().getProvisionDeviceSecret();\n+\n+        if (StringUtils.isEmpty(provisionRequestKey) || StringUtils.isEmpty(provisionRequestSecret)) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        if (provisionRequest.getCredentialsType() != null) {\n+            ListenableFuture<ProvisionResponse> error = validateCredentials(provisionRequest);\n+            if (error != null) {\n+                return error;\n+            }\n+        }\n+\n+        DeviceProfile targetProfile = deviceProfileDao.findByProvisionDeviceKey(provisionRequestKey);\n+\n+        if (targetProfile == null) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        Device targetDevice = deviceDao.findDeviceByTenantIdAndName(targetProfile.getTenantId().getId(), provisionRequest.getDeviceName()).orElse(null);\n+\n+        switch (targetProfile.getProvisionType()) {\n+            case ALLOW_CREATE_NEW_DEVICES:\n+                if (((AllowCreateNewDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null) {\n+                        log.warn(\"[{}] The device is present and could not be provisioned once more!\", targetDevice.getName());\n+                        notify(targetDevice, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    } else {\n+                        return createDevice(provisionRequest, targetProfile);\n+                    }\n+                }\n+                break;\n+            case CHECK_PRE_PROVISIONED_DEVICES:\n+                if (((CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null && targetDevice.getDeviceProfileId().equals(targetProfile.getId())) {\n+                        return processProvision(targetDevice, provisionRequest);\n+                    } else {\n+                        log.warn(\"[{}] Failed to find pre provisioned device!\", provisionRequest.getDeviceName());\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    }\n+                }\n+                break;\n+        }\n+        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> validateCredentials(ProvisionRequest provisionRequest) {\n+        switch (provisionRequest.getCredentialsType()) {\n+            case MQTT_BASIC:\n+                if (StringUtils.isEmpty(provisionRequest.getCredentialsData().getClientId()) ||\n+                        StringUtils.isEmpty(provisionRequest.getCredentialsData().getUsername()) ||\n+                        StringUtils.isEmpty(provisionRequest.getCredentialsData().getPassword())) {\n+                    log.error(\"Failed to get basic mqtt credentials from credentials data!\");\n+                    return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                }\n+                break;\n+            case X509_CERTIFICATE:\n+                if (StringUtils.isEmpty(provisionRequest.getCredentialsData().getHash())) {\n+                    log.error(\"Failed to get hash from credentials data!\");\n+                    return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                }\n+                break;\n+        }\n+        return null;\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> processProvision(Device device, ProvisionRequest provisionRequest) {\n+        ListenableFuture<Optional<AttributeKvEntry>> provisionStateFuture = attributesService.find(device.getTenantId(), device.getId(),\n+                DataConstants.SERVER_SCOPE, DEVICE_PROVISION_STATE);\n+        ListenableFuture<Boolean> provisionedFuture = Futures.transformAsync(provisionStateFuture, optionalAtr -> {\n+            if (optionalAtr.isPresent()) {\n+                String state = optionalAtr.get().getValueAsString();\n+                if (state.equals(PROVISIONED_STATE)) {\n+                    return Futures.immediateFuture(true);\n+                } else {\n+                    log.error(\"[{}][{}] Unknown provision state: {}!\", device.getName(), DEVICE_PROVISION_STATE, state);\n+                    return Futures.immediateCancelledFuture();\n+                }\n+            }\n+            return Futures.transform(saveProvisionStateAttribute(device), input -> false, MoreExecutors.directExecutor());\n+        }, MoreExecutors.directExecutor());\n+        if (provisionedFuture.isCancelled()) {\n+            throw new RuntimeException(\"Unknown provision state!\");\n+        }\n+        return Futures.transform(provisionedFuture, provisioned -> {\n+            if (provisioned) {\n+                notify(device, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+                return new ProvisionResponse(null, ProvisionResponseStatus.FAILURE);\n+            }\n+            notify(device, provisionRequest, DataConstants.PROVISION_SUCCESS, true);\n+            return new ProvisionResponse(deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), device.getId()), ProvisionResponseStatus.SUCCESS);\n+        }, MoreExecutors.directExecutor());\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> createDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {\n+        deviceCreationLock.lock();\n+        try {\n+            return processCreateDevice(provisionRequest, profile);\n+        } finally {\n+            deviceCreationLock.unlock();\n+        }\n+    }\n+\n+    private void notify(Device device, ProvisionRequest provisionRequest, String type, boolean success) {\n+        pushProvisionEventToRuleEngine(provisionRequest, device, type);\n+        logAction(device.getTenantId(), device.getCustomerId(), device, success, provisionRequest);\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> processCreateDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {\n+        Device device = deviceService.findDeviceByTenantIdAndName(profile.getTenantId(), provisionRequest.getDeviceName());\n+        if (device == null) {\n+            Device savedDevice = saveDevice(provisionRequest, profile);\n+\n+            deviceStateService.onDeviceAdded(savedDevice);\n+            pushDeviceCreatedEventToRuleEngine(savedDevice);\n+            notify(savedDevice, provisionRequest, DataConstants.PROVISION_SUCCESS, true);\n+\n+            return Futures.transform(saveProvisionStateAttribute(savedDevice), input ->\n+                    new ProvisionResponse(\n+                            getDeviceCredentials(savedDevice),\n+                            ProvisionResponseStatus.SUCCESS), MoreExecutors.directExecutor());\n+        }\n+        log.warn(\"[{}] The device is already provisioned!\", device.getName());\n+        notify(device, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+    }\n+\n+    private ListenableFuture<List<Void>> saveProvisionStateAttribute(Device device) {\n+        return attributesService.save(device.getTenantId(), device.getId(), DataConstants.SERVER_SCOPE,\n+                Collections.singletonList(new BaseAttributeKvEntry(new StringDataEntry(DEVICE_PROVISION_STATE, PROVISIONED_STATE),\n+                        System.currentTimeMillis())));\n+    }\n+\n+    private Device saveDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {\n+        Device device = new Device();\n+        device.setName(provisionRequest.getDeviceName());\n+        device.setType(profile.getName());\n+        device.setTenantId(profile.getTenantId());\n+        Device savedDevice = deviceService.saveDevice(device);\n+        if (!StringUtils.isEmpty(provisionRequest.getCredentialsData().getToken()) ||\n+                !StringUtils.isEmpty(provisionRequest.getCredentialsData().getHash()) ||\n+                !StringUtils.isEmpty(provisionRequest.getCredentialsData().getUsername()) ||\n+                !StringUtils.isEmpty(provisionRequest.getCredentialsData().getPassword()) ||\n+                !StringUtils.isEmpty(provisionRequest.getCredentialsData().getClientId())) {\n+            DeviceCredentials deviceCredentials = deviceCredentialsService.findDeviceCredentialsByDeviceId(savedDevice.getTenantId(), savedDevice.getId());\n+            deviceCredentials.setCredentialsType(provisionRequest.getCredentialsType());\n+            switch (provisionRequest.getCredentialsType()) {\n+                case ACCESS_TOKEN:\n+                    deviceCredentials.setDeviceId(savedDevice.getId());\n+                    deviceCredentials.setCredentialsId(provisionRequest.getCredentialsData().getToken());\n+                    break;\n+                case MQTT_BASIC:\n+                    BasicMqttCredentials mqttCredentials = new BasicMqttCredentials();\n+                    mqttCredentials.setClientId(provisionRequest.getCredentialsData().getClientId());\n+                    mqttCredentials.setUserName(provisionRequest.getCredentialsData().getUsername());\n+                    mqttCredentials.setPassword(provisionRequest.getCredentialsData().getPassword());\n+                    deviceCredentials.setCredentialsValue(JacksonUtil.toString(mqttCredentials));\n+                    break;\n+                case X509_CERTIFICATE:\n+                    deviceCredentials.setCredentialsValue(provisionRequest.getCredentialsData().getHash());\n+                    break;\n+            }\n+            deviceCredentials.setCredentialsType(provisionRequest.getCredentialsType());\n+            deviceCredentialsService.updateDeviceCredentials(savedDevice.getTenantId(), deviceCredentials);\n+        }\n+        return savedDevice;\n+    }\n+\n+    private DeviceCredentials getDeviceCredentials(Device device) {\n+        return deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), device.getId());\n+    }\n+\n+    private void pushProvisionEventToRuleEngine(ProvisionRequest request, Device device, String type) {\n+        try {\n+            ObjectNode entityNode = JacksonUtil.OBJECT_MAPPER.valueToTree(request);\n+            TbMsg msg = TbMsg.newMsg(type, device.getId(), createTbMsgMetaData(device), JacksonUtil.OBJECT_MAPPER.writeValueAsString(entityNode));\n+            sendToRuleEngine(device.getTenantId(), msg, null);\n+        } catch (JsonProcessingException | IllegalArgumentException e) {\n+            log.warn(\"[{}] Failed to push device action to rule engine: {}\", device.getId(), type, e);\n+        }\n+    }\n+\n+    private void pushDeviceCreatedEventToRuleEngine(Device device) {\n+        try {\n+            ObjectNode entityNode = JacksonUtil.OBJECT_MAPPER.valueToTree(device);", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyNDg1Nw==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502324857", "bodyText": "We need to make the main method transactional and pay attention to avoid using DAO layer that is executed in different threads (to avoid locks). Same for TB PE.", "author": "ashvayka", "createdAt": "2020-10-09T10:06:07Z", "path": "application/src/main/java/org/thingsboard/server/service/device/DeviceProvisionServiceImpl.java", "diffHunk": "@@ -0,0 +1,326 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.service.device;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.StringUtils;\n+import org.thingsboard.server.common.data.DataConstants;\n+import org.thingsboard.server.common.data.Device;\n+import org.thingsboard.server.common.data.DeviceProfile;\n+import org.thingsboard.server.common.data.audit.ActionType;\n+import org.thingsboard.server.common.data.device.credentials.BasicMqttCredentials;\n+import org.thingsboard.server.common.data.device.profile.AllowCreateNewDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.device.profile.CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration;\n+import org.thingsboard.server.common.data.id.CustomerId;\n+import org.thingsboard.server.common.data.id.TenantId;\n+import org.thingsboard.server.common.data.id.UserId;\n+import org.thingsboard.server.common.data.kv.AttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.BaseAttributeKvEntry;\n+import org.thingsboard.server.common.data.kv.StringDataEntry;\n+import org.thingsboard.server.common.data.security.DeviceCredentials;\n+import org.thingsboard.server.common.msg.TbMsg;\n+import org.thingsboard.server.common.msg.TbMsgMetaData;\n+import org.thingsboard.server.common.msg.queue.ServiceType;\n+import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;\n+import org.thingsboard.server.dao.attributes.AttributesService;\n+import org.thingsboard.server.dao.audit.AuditLogService;\n+import org.thingsboard.server.dao.device.DeviceCredentialsService;\n+import org.thingsboard.server.dao.device.DeviceDao;\n+import org.thingsboard.server.dao.device.DeviceProfileDao;\n+import org.thingsboard.server.dao.device.DeviceProvisionService;\n+import org.thingsboard.server.dao.device.DeviceService;\n+import org.thingsboard.server.dao.device.provision.ProvisionRequest;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponse;\n+import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;\n+import org.thingsboard.server.dao.util.mapping.JacksonUtil;\n+import org.thingsboard.server.gen.transport.TransportProtos;\n+import org.thingsboard.server.gen.transport.TransportProtos.ToRuleEngineMsg;\n+import org.thingsboard.server.queue.TbQueueCallback;\n+import org.thingsboard.server.queue.TbQueueProducer;\n+import org.thingsboard.server.queue.common.TbProtoQueueMsg;\n+import org.thingsboard.server.queue.discovery.PartitionService;\n+import org.thingsboard.server.queue.provider.TbQueueProducerProvider;\n+import org.thingsboard.server.queue.util.TbCoreComponent;\n+import org.thingsboard.server.service.state.DeviceStateService;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+\n+@Service\n+@Slf4j\n+@TbCoreComponent\n+public class DeviceProvisionServiceImpl implements DeviceProvisionService {\n+\n+    protected TbQueueProducer<TbProtoQueueMsg<ToRuleEngineMsg>> ruleEngineMsgProducer;\n+\n+    private static final String DEVICE_PROVISION_STATE = \"provisionState\";\n+    private static final String PROVISIONED_STATE = \"provisioned\";\n+\n+    private final ReentrantLock deviceCreationLock = new ReentrantLock();\n+\n+    @Autowired\n+    DeviceDao deviceDao;\n+\n+    @Autowired\n+    DeviceProfileDao deviceProfileDao;\n+\n+    @Autowired\n+    DeviceService deviceService;\n+\n+    @Autowired\n+    DeviceCredentialsService deviceCredentialsService;\n+\n+    @Autowired\n+    AttributesService attributesService;\n+\n+    @Autowired\n+    DeviceStateService deviceStateService;\n+\n+    @Autowired\n+    AuditLogService auditLogService;\n+\n+    @Autowired\n+    PartitionService partitionService;\n+\n+    public DeviceProvisionServiceImpl(TbQueueProducerProvider producerProvider) {\n+        ruleEngineMsgProducer = producerProvider.getRuleEngineMsgProducer();\n+    }\n+\n+    @Override\n+    public ListenableFuture<ProvisionResponse> provisionDevice(ProvisionRequest provisionRequest) {\n+        String provisionRequestKey = provisionRequest.getCredentials().getProvisionDeviceKey();\n+        String provisionRequestSecret = provisionRequest.getCredentials().getProvisionDeviceSecret();\n+\n+        if (StringUtils.isEmpty(provisionRequestKey) || StringUtils.isEmpty(provisionRequestSecret)) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        if (provisionRequest.getCredentialsType() != null) {\n+            ListenableFuture<ProvisionResponse> error = validateCredentials(provisionRequest);\n+            if (error != null) {\n+                return error;\n+            }\n+        }\n+\n+        DeviceProfile targetProfile = deviceProfileDao.findByProvisionDeviceKey(provisionRequestKey);\n+\n+        if (targetProfile == null) {\n+            return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+        }\n+\n+        Device targetDevice = deviceDao.findDeviceByTenantIdAndName(targetProfile.getTenantId().getId(), provisionRequest.getDeviceName()).orElse(null);\n+\n+        switch (targetProfile.getProvisionType()) {\n+            case ALLOW_CREATE_NEW_DEVICES:\n+                if (((AllowCreateNewDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null) {\n+                        log.warn(\"[{}] The device is present and could not be provisioned once more!\", targetDevice.getName());\n+                        notify(targetDevice, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    } else {\n+                        return createDevice(provisionRequest, targetProfile);\n+                    }\n+                }\n+                break;\n+            case CHECK_PRE_PROVISIONED_DEVICES:\n+                if (((CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration()).getProvisionDeviceSecret().equals(provisionRequestSecret)) {\n+                    if (targetDevice != null && targetDevice.getDeviceProfileId().equals(targetProfile.getId())) {\n+                        return processProvision(targetDevice, provisionRequest);\n+                    } else {\n+                        log.warn(\"[{}] Failed to find pre provisioned device!\", provisionRequest.getDeviceName());\n+                        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                    }\n+                }\n+                break;\n+        }\n+        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.NOT_FOUND));\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> validateCredentials(ProvisionRequest provisionRequest) {\n+        switch (provisionRequest.getCredentialsType()) {\n+            case MQTT_BASIC:\n+                if (StringUtils.isEmpty(provisionRequest.getCredentialsData().getClientId()) ||\n+                        StringUtils.isEmpty(provisionRequest.getCredentialsData().getUsername()) ||\n+                        StringUtils.isEmpty(provisionRequest.getCredentialsData().getPassword())) {\n+                    log.error(\"Failed to get basic mqtt credentials from credentials data!\");\n+                    return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                }\n+                break;\n+            case X509_CERTIFICATE:\n+                if (StringUtils.isEmpty(provisionRequest.getCredentialsData().getHash())) {\n+                    log.error(\"Failed to get hash from credentials data!\");\n+                    return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+                }\n+                break;\n+        }\n+        return null;\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> processProvision(Device device, ProvisionRequest provisionRequest) {\n+        ListenableFuture<Optional<AttributeKvEntry>> provisionStateFuture = attributesService.find(device.getTenantId(), device.getId(),\n+                DataConstants.SERVER_SCOPE, DEVICE_PROVISION_STATE);\n+        ListenableFuture<Boolean> provisionedFuture = Futures.transformAsync(provisionStateFuture, optionalAtr -> {\n+            if (optionalAtr.isPresent()) {\n+                String state = optionalAtr.get().getValueAsString();\n+                if (state.equals(PROVISIONED_STATE)) {\n+                    return Futures.immediateFuture(true);\n+                } else {\n+                    log.error(\"[{}][{}] Unknown provision state: {}!\", device.getName(), DEVICE_PROVISION_STATE, state);\n+                    return Futures.immediateCancelledFuture();\n+                }\n+            }\n+            return Futures.transform(saveProvisionStateAttribute(device), input -> false, MoreExecutors.directExecutor());\n+        }, MoreExecutors.directExecutor());\n+        if (provisionedFuture.isCancelled()) {\n+            throw new RuntimeException(\"Unknown provision state!\");\n+        }\n+        return Futures.transform(provisionedFuture, provisioned -> {\n+            if (provisioned) {\n+                notify(device, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+                return new ProvisionResponse(null, ProvisionResponseStatus.FAILURE);\n+            }\n+            notify(device, provisionRequest, DataConstants.PROVISION_SUCCESS, true);\n+            return new ProvisionResponse(deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), device.getId()), ProvisionResponseStatus.SUCCESS);\n+        }, MoreExecutors.directExecutor());\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> createDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {\n+        deviceCreationLock.lock();\n+        try {\n+            return processCreateDevice(provisionRequest, profile);\n+        } finally {\n+            deviceCreationLock.unlock();\n+        }\n+    }\n+\n+    private void notify(Device device, ProvisionRequest provisionRequest, String type, boolean success) {\n+        pushProvisionEventToRuleEngine(provisionRequest, device, type);\n+        logAction(device.getTenantId(), device.getCustomerId(), device, success, provisionRequest);\n+    }\n+\n+    private ListenableFuture<ProvisionResponse> processCreateDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {\n+        Device device = deviceService.findDeviceByTenantIdAndName(profile.getTenantId(), provisionRequest.getDeviceName());\n+        if (device == null) {\n+            Device savedDevice = saveDevice(provisionRequest, profile);\n+\n+            deviceStateService.onDeviceAdded(savedDevice);\n+            pushDeviceCreatedEventToRuleEngine(savedDevice);\n+            notify(savedDevice, provisionRequest, DataConstants.PROVISION_SUCCESS, true);\n+\n+            return Futures.transform(saveProvisionStateAttribute(savedDevice), input ->\n+                    new ProvisionResponse(\n+                            getDeviceCredentials(savedDevice),\n+                            ProvisionResponseStatus.SUCCESS), MoreExecutors.directExecutor());\n+        }\n+        log.warn(\"[{}] The device is already provisioned!\", device.getName());\n+        notify(device, provisionRequest, DataConstants.PROVISION_FAILURE, false);\n+        return Futures.immediateFuture(new ProvisionResponse(null, ProvisionResponseStatus.FAILURE));\n+    }\n+\n+    private ListenableFuture<List<Void>> saveProvisionStateAttribute(Device device) {\n+        return attributesService.save(device.getTenantId(), device.getId(), DataConstants.SERVER_SCOPE,\n+                Collections.singletonList(new BaseAttributeKvEntry(new StringDataEntry(DEVICE_PROVISION_STATE, PROVISIONED_STATE),\n+                        System.currentTimeMillis())));\n+    }\n+\n+    private Device saveDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {\n+        Device device = new Device();\n+        device.setName(provisionRequest.getDeviceName());\n+        device.setType(profile.getName());\n+        device.setTenantId(profile.getTenantId());\n+        Device savedDevice = deviceService.saveDevice(device);\n+        if (!StringUtils.isEmpty(provisionRequest.getCredentialsData().getToken()) ||", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyNTI5MQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502325291", "bodyText": "empty line", "author": "ashvayka", "createdAt": "2020-10-09T10:07:01Z", "path": "common/dao-api/src/main/java/org/thingsboard/server/dao/device/provision/ProvisionResponseStatus.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.dao.device.provision;\n+\n+public enum ProvisionResponseStatus {\n+    UNKNOWN,\n+    SUCCESS,\n+    NOT_FOUND,\n+    FAILURE\n+", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyNTY4OA==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502325688", "bodyText": "make the variable name clear. Something like x509CertHash", "author": "ashvayka", "createdAt": "2020-10-09T10:07:47Z", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/credentials/ProvisionDeviceCredentialsData.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.common.data.device.credentials;\n+\n+import lombok.Data;\n+\n+@Data\n+public class ProvisionDeviceCredentialsData {\n+    private final String token;\n+    private final String clientId;\n+    private final String username;\n+    private final String password;\n+    private final String hash;", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyNTgzMA==", "url": "https://github.com/thingsboard/thingsboard/pull/3518#discussion_r502325830", "bodyText": "no new line", "author": "ashvayka", "createdAt": "2020-10-09T10:08:04Z", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/DeviceProfileProvisionConfiguration.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.common.data.device.profile;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import org.thingsboard.server.common.data.DeviceProfileProvisionType;\n+\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+@JsonTypeInfo(\n+        use = JsonTypeInfo.Id.NAME,\n+        include = JsonTypeInfo.As.PROPERTY,\n+        property = \"type\")\n+@JsonSubTypes({\n+        @JsonSubTypes.Type(value = DisabledDeviceProfileProvisionConfiguration.class, name = \"DISABLED\"),\n+        @JsonSubTypes.Type(value = AllowCreateNewDevicesDeviceProfileProvisionConfiguration.class, name = \"ALLOW_CREATE_NEW_DEVICES\"),\n+        @JsonSubTypes.Type(value = CheckPreProvisionedDevicesDeviceProfileProvisionConfiguration.class, name = \"CHECK_PRE_PROVISIONED_DEVICES\")})\n+public interface DeviceProfileProvisionConfiguration {\n+\n+    @JsonIgnore\n+    DeviceProfileProvisionType getType();\n+\n+}", "originalCommit": "6683158c6b262ed930db41c3ced73efec94320aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "93278f7236555b26f52af3a8e4fdebc80037cee1", "url": "https://github.com/thingsboard/thingsboard/commit/93278f7236555b26f52af3a8e4fdebc80037cee1", "message": "Refactoring according to comments", "committedDate": "2020-10-09T14:32:32Z", "type": "commit"}, {"oid": "35f6f40ca347f2e4dba0fcfff2ed306ba325bfff", "url": "https://github.com/thingsboard/thingsboard/commit/35f6f40ca347f2e4dba0fcfff2ed306ba325bfff", "message": "Merge branch 'master' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-09T14:35:30Z", "type": "commit"}, {"oid": "6e4c4049290cad539f648589a565f704866d8d40", "url": "https://github.com/thingsboard/thingsboard/commit/6e4c4049290cad539f648589a565f704866d8d40", "message": "Merge branch 'master' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-12T05:25:34Z", "type": "commit"}, {"oid": "ca4e9238c88bb69e2abec04ec8be4a2740d1ead0", "url": "https://github.com/thingsboard/thingsboard/commit/ca4e9238c88bb69e2abec04ec8be4a2740d1ead0", "message": "Fix for device provision tests", "committedDate": "2020-10-12T10:30:23Z", "type": "commit"}, {"oid": "005ad7065722432a0f9d835505f5c14c4f2cc57f", "url": "https://github.com/thingsboard/thingsboard/commit/005ad7065722432a0f9d835505f5c14c4f2cc57f", "message": "Merge branch 'master' of https://github.com/thingsboard/thingsboard into feature/device-provision-3.2-onlyProfileVersion", "committedDate": "2020-10-12T10:57:01Z", "type": "commit"}, {"oid": "1a718593ecd6919f164b40830d3783b4415aab27", "url": "https://github.com/thingsboard/thingsboard/commit/1a718593ecd6919f164b40830d3783b4415aab27", "message": "Refactoring", "committedDate": "2020-10-12T13:19:36Z", "type": "commit"}]}