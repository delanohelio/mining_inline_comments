{"pr_number": 3052, "pr_title": "Prometheus Metrics", "pr_createdAt": "2020-07-06T11:18:51Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3052", "timeline": [{"oid": "c8325751e408678e4812fca2b53da875d584a64c", "url": "https://github.com/thingsboard/thingsboard/commit/c8325751e408678e4812fca2b53da875d584a64c", "message": "Moved resetting ruleEngineStats to Consumer", "committedDate": "2020-07-02T12:30:32Z", "type": "commit"}, {"oid": "c02e9474d72497b27aed4a508b34542a57c463ef", "url": "https://github.com/thingsboard/thingsboard/commit/c02e9474d72497b27aed4a508b34542a57c463ef", "message": "Moved counters to Map in TbCoreConsumerStats", "committedDate": "2020-07-02T12:53:40Z", "type": "commit"}, {"oid": "3afd37eddeb70867aabfdc806db06ce8abab3b73", "url": "https://github.com/thingsboard/thingsboard/commit/3afd37eddeb70867aabfdc806db06ce8abab3b73", "message": "Added actuator and MetricsService", "committedDate": "2020-07-02T12:55:33Z", "type": "commit"}, {"oid": "b2f11e6c36f9ad1ea3f0cce819d16afc5fbd65b4", "url": "https://github.com/thingsboard/thingsboard/commit/b2f11e6c36f9ad1ea3f0cce819d16afc5fbd65b4", "message": "Added metrics to core and rule_engine consumers", "committedDate": "2020-07-02T12:56:33Z", "type": "commit"}, {"oid": "eae7182f3bc93e172be2a1542051f69bd0f7f497", "url": "https://github.com/thingsboard/thingsboard/commit/eae7182f3bc93e172be2a1542051f69bd0f7f497", "message": "Added license headers", "committedDate": "2020-07-06T09:57:46Z", "type": "commit"}, {"oid": "95bae2aa929617140e34a90d0bd6fd2057d73980", "url": "https://github.com/thingsboard/thingsboard/commit/95bae2aa929617140e34a90d0bd6fd2057d73980", "message": "Replaced summary with counters", "committedDate": "2020-07-06T09:57:49Z", "type": "commit"}, {"oid": "2e1a0b8574f55b46ed5ca926a02c298de1baea61", "url": "https://github.com/thingsboard/thingsboard/commit/2e1a0b8574f55b46ed5ca926a02c298de1baea61", "message": "Removed most setters and getters from TbRuleEngine stats", "committedDate": "2020-07-06T09:57:52Z", "type": "commit"}, {"oid": "d36fe0a473c9d35f7e8246ac3c703a4f3bf37664", "url": "https://github.com/thingsboard/thingsboard/commit/d36fe0a473c9d35f7e8246ac3c703a4f3bf37664", "message": "Added stats to Transport consumer", "committedDate": "2020-07-06T09:57:55Z", "type": "commit"}, {"oid": "febbfccabbc63f410bcaa6c685d227c997d773a1", "url": "https://github.com/thingsboard/thingsboard/commit/febbfccabbc63f410bcaa6c685d227c997d773a1", "message": "Added JsInvoke actuator stats", "committedDate": "2020-07-06T09:57:58Z", "type": "commit"}, {"oid": "c6f2ef2d2fd233529955836b5662576d6af16a27", "url": "https://github.com/thingsboard/thingsboard/commit/c6f2ef2d2fd233529955836b5662576d6af16a27", "message": "Added license headers", "committedDate": "2020-07-06T10:25:36Z", "type": "commit"}, {"oid": "ba68c71a2728f7effee0e5a757a57e041e4c3ece", "url": "https://github.com/thingsboard/thingsboard/commit/ba68c71a2728f7effee0e5a757a57e041e4c3ece", "message": "Merge remote-tracking branch 'upstream/develop/2.5.3' into feature/metrics", "committedDate": "2020-07-06T10:31:01Z", "type": "commit"}, {"oid": "78a289656fa4f308736cc4501e601b55f4c6d5b7", "url": "https://github.com/thingsboard/thingsboard/commit/78a289656fa4f308736cc4501e601b55f4c6d5b7", "message": "Removed MetricsService", "committedDate": "2020-07-06T11:11:01Z", "type": "commit"}, {"oid": "0a5378c0af548a7984adb0599b9afb65f7695fa9", "url": "https://github.com/thingsboard/thingsboard/commit/0a5378c0af548a7984adb0599b9afb65f7695fa9", "message": "Removed TODOs", "committedDate": "2020-07-06T11:17:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MzkxMg==", "url": "https://github.com/thingsboard/thingsboard/pull/3052#discussion_r450153912", "bodyText": "maybe it's possible to do this somehow better and without passing factory obj?", "author": "vzikratyi-tb", "createdAt": "2020-07-06T11:19:49Z", "path": "application/src/main/java/org/thingsboard/server/service/queue/TbRuleEngineConsumerStats.java", "diffHunk": "@@ -43,61 +43,72 @@\n     public static final String SUCCESSFUL_ITERATIONS = \"successfulIterations\";\n     public static final String FAILED_ITERATIONS = \"failedIterations\";\n \n-    private final AtomicInteger totalMsgCounter = new AtomicInteger(0);\n-    private final AtomicInteger successMsgCounter = new AtomicInteger(0);\n-    private final AtomicInteger tmpTimeoutMsgCounter = new AtomicInteger(0);\n-    private final AtomicInteger tmpFailedMsgCounter = new AtomicInteger(0);\n+    private final StatsCounter totalMsgCounter;\n+    private final StatsCounter successMsgCounter;\n+    private final StatsCounter tmpTimeoutMsgCounter;\n+    private final StatsCounter tmpFailedMsgCounter;\n \n-    private final AtomicInteger timeoutMsgCounter = new AtomicInteger(0);\n-    private final AtomicInteger failedMsgCounter = new AtomicInteger(0);\n+    private final StatsCounter timeoutMsgCounter;\n+    private final StatsCounter failedMsgCounter;\n \n-    private final AtomicInteger successIterationsCounter = new AtomicInteger(0);\n-    private final AtomicInteger failedIterationsCounter = new AtomicInteger(0);\n+    private final StatsCounter successIterationsCounter;\n+    private final StatsCounter failedIterationsCounter;\n \n-    private final Map<String, AtomicInteger> counters = new HashMap<>();\n+    private final List<StatsCounter> counters = new ArrayList<>();\n     private final ConcurrentMap<UUID, TbTenantRuleEngineStats> tenantStats = new ConcurrentHashMap<>();\n     private final ConcurrentMap<TenantId, RuleEngineException> tenantExceptions = new ConcurrentHashMap<>();\n \n     private final String queueName;\n \n-    public TbRuleEngineConsumerStats(String queueName) {\n+    public TbRuleEngineConsumerStats(String queueName, StatsCounterFactory counterFactory) {", "originalCommit": "0a5378c0af548a7984adb0599b9afb65f7695fa9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NDMwMw==", "url": "https://github.com/thingsboard/thingsboard/pull/3052#discussion_r450154303", "bodyText": "not sure if that's a good idea", "author": "vzikratyi-tb", "createdAt": "2020-07-06T11:20:46Z", "path": "application/src/main/java/org/thingsboard/server/service/stats/StatsCounterFactory.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.service.stats;\n+\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+import org.thingsboard.server.service.metrics.StubCounter;\n+\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+@Service\n+public class StatsCounterFactory {\n+    private static final String STATS_NAME_TAG = \"statsName\";\n+\n+    private static final Counter STUB_COUNTER = new StubCounter();", "originalCommit": "0a5378c0af548a7984adb0599b9afb65f7695fa9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}