{"pr_number": 3572, "pr_title": "[3.2] Custom proto schemas for MQTT telemetry & attributes upload. ", "pr_createdAt": "2020-10-12T13:22:59Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3572", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDQwNA==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r503874404", "bodyText": "fix this", "author": "ashvayka", "createdAt": "2020-10-13T11:28:58Z", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/MqttDeviceProfileTransportConfiguration.java", "diffHunk": "@@ -15,17 +15,33 @@\n  */\n package org.thingsboard.server.common.data.device.profile;\n \n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n import lombok.Data;\n+import lombok.extern.slf4j.Slf4j;\n import org.thingsboard.server.common.data.TransportPayloadType;\n import org.thingsboard.server.common.data.DeviceTransportType;\n \n+\n+@Slf4j\n @Data\n-public class MqttDeviceProfileTransportConfiguration implements DeviceProfileTransportConfiguration {\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+@JsonTypeInfo(\n+        use = JsonTypeInfo.Id.NAME,\n+        include = JsonTypeInfo.As.PROPERTY,\n+        property = \"transportPayloadType\")\n+@JsonSubTypes({\n+        @JsonSubTypes.Type(value = MqttJsonDeviceProfileTransportConfiguration.class, name = \"JSON\"),\n+        @JsonSubTypes.Type(value = MqttProtoDeviceProfileTransportConfiguration.class, name = \"PROTOBUF\")})\n+@JsonDeserialize(using = MqttTransportConfigurationDeserializer.class)\n+public abstract class MqttDeviceProfileTransportConfiguration implements DeviceProfileTransportConfiguration {\n \n-    private TransportPayloadType transportPayloadType = TransportPayloadType.JSON;\n+    protected String deviceTelemetryTopic = MqttTopics.DEVICE_TELEMETRY_TOPIC;", "originalCommit": "e85daa81e0d933a3b82142d04f9e17823f2e3387", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkzNjE0Nw==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r503936147", "bodyText": "done", "author": "ShvaykaD", "createdAt": "2020-10-13T13:09:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NzMzMQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r521997331", "bodyText": "Please provide an example that also contains inner object. This will be more useful for the end user (to use as a referene.", "author": "ashvayka", "createdAt": "2020-11-12T10:24:52Z", "path": "application/src/test/java/org/thingsboard/server/mqtt/AbstractMqttIntegrationTest.java", "diffHunk": "@@ -60,6 +61,30 @@\n \n     private static final AtomicInteger atomicInteger = new AtomicInteger(2);\n \n+    protected static final String DEVICE_TELEMETRY_PROTO_SCHEMA = \"syntax =\\\"proto3\\\";\\n\" +\n+            \"\\n\" +\n+            \"package test;\\n\" +\n+            \"        \\n\" +\n+            \"message PostTelemetry {\\n\" +", "originalCommit": "4725ad14514036f773b23670fbce1880a22d8192", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5Nzc0NQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r521997745", "bodyText": "Same logic should be applied for the \"default\" input in the UI form.", "author": "ashvayka", "createdAt": "2020-11-12T10:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NzMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAxNjc5OQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r522016799", "bodyText": "@ashvayka do you mean that I need to add another test case with an inner object, and also add the placeholder to the UI input, or this should be the default value?", "author": "ShvaykaD", "createdAt": "2020-11-12T10:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NzMzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5ODYzMA==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r521998630", "bodyText": "Why this was removed?", "author": "ashvayka", "createdAt": "2020-11-12T10:26:54Z", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/DeviceProfileTransportConfiguration.java", "diffHunk": "@@ -29,11 +29,10 @@\n         property = \"type\")\n @JsonSubTypes({\n          @JsonSubTypes.Type(value = DefaultDeviceProfileTransportConfiguration.class, name = \"DEFAULT\"),\n-        @JsonSubTypes.Type(value = MqttDeviceProfileTransportConfiguration.class, name = \"MQTT\"),\n+         @JsonSubTypes.Type(value = MqttDeviceProfileTransportConfiguration.class, name = \"MQTT\"),\n          @JsonSubTypes.Type(value = Lwm2mDeviceProfileTransportConfiguration.class, name = \"LWM2M\")})\n public interface DeviceProfileTransportConfiguration {\n \n-    @JsonIgnore", "originalCommit": "4725ad14514036f773b23670fbce1880a22d8192", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAwMTc1Mw==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r522001753", "bodyText": "This is completely wrong. You are breaking the main OOP principles.\nYou should have only one MqttDeviceProfileTransportConfiguration (not abstract) that has a field:\nTransportPayloadType\nand one more variable of new TransportPayloadTypeConfiguration interface (JSON or PROTOBUF)\nwith two sub-classes", "author": "ashvayka", "createdAt": "2020-11-12T10:31:51Z", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/MqttDeviceProfileTransportConfiguration.java", "diffHunk": "@@ -15,17 +15,30 @@\n  */\n package org.thingsboard.server.common.data.device.profile;\n \n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n import lombok.Data;\n import org.thingsboard.server.common.data.TransportPayloadType;\n import org.thingsboard.server.common.data.DeviceTransportType;\n \n+@JsonIgnoreProperties(ignoreUnknown = true)\n+@JsonTypeInfo(\n+        use = JsonTypeInfo.Id.NAME,\n+        include = JsonTypeInfo.As.PROPERTY,\n+        property = \"transportPayloadType\")\n+@JsonSubTypes({\n+        @JsonSubTypes.Type(value = MqttJsonDeviceProfileTransportConfiguration.class, name = \"JSON\"),\n+        @JsonSubTypes.Type(value = MqttProtoDeviceProfileTransportConfiguration.class, name = \"PROTOBUF\")})\n+@JsonDeserialize(using = MqttTransportConfigurationDeserializer.class)\n @Data\n-public class MqttDeviceProfileTransportConfiguration implements DeviceProfileTransportConfiguration {\n+public abstract class MqttDeviceProfileTransportConfiguration implements DeviceProfileTransportConfiguration {", "originalCommit": "4725ad14514036f773b23670fbce1880a22d8192", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAxNzkzMg==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r522017932", "bodyText": "Ok. This is clear.", "author": "ShvaykaD", "createdAt": "2020-11-12T10:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAwMTc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAwMjk2Mw==", "url": "https://github.com/thingsboard/thingsboard/pull/3572#discussion_r522002963", "bodyText": "All this logic should be in the DeviceProfileService in the validator", "author": "ashvayka", "createdAt": "2020-11-12T10:33:35Z", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/MqttProtoDeviceProfileTransportConfiguration.java", "diffHunk": "@@ -0,0 +1,305 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.common.data.device.profile;\n+\n+import com.fasterxml.jackson.annotation.JsonTypeName;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.github.os72.protobuf.dynamic.DynamicSchema;\n+import com.github.os72.protobuf.dynamic.EnumDefinition;\n+import com.github.os72.protobuf.dynamic.MessageDefinition;\n+import com.google.protobuf.Descriptors;\n+import com.google.protobuf.DynamicMessage;\n+import com.squareup.wire.Syntax;\n+import com.squareup.wire.schema.Field;\n+import com.squareup.wire.schema.Location;\n+import com.squareup.wire.schema.internal.parser.EnumConstantElement;\n+import com.squareup.wire.schema.internal.parser.EnumElement;\n+import com.squareup.wire.schema.internal.parser.FieldElement;\n+import com.squareup.wire.schema.internal.parser.MessageElement;\n+import com.squareup.wire.schema.internal.parser.OneOfElement;\n+import com.squareup.wire.schema.internal.parser.ProtoFileElement;\n+import com.squareup.wire.schema.internal.parser.ProtoParser;\n+import com.squareup.wire.schema.internal.parser.TypeElement;\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.extern.slf4j.Slf4j;\n+import org.thingsboard.server.common.data.TransportPayloadType;\n+\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+@EqualsAndHashCode(callSuper = true)\n+@Data\n+@JsonDeserialize(as = MqttProtoDeviceProfileTransportConfiguration.class)\n+public class MqttProtoDeviceProfileTransportConfiguration extends MqttDeviceProfileTransportConfiguration {\n+\n+    public static final Location LOCATION = new Location(\"\", \"\", -1, -1);\n+    public static final String ATTRIBUTES_PROTO_SCHEMA = \"attributes proto schema\";\n+    public static final String TELEMETRY_PROTO_SCHEMA = \"telemetry proto schema\";\n+\n+    public static String invalidSchemaProvidedMessage(String schemaName) {\n+        return \"[Transport Configuration] invalid \" + schemaName + \" schema provided!\";\n+    }\n+\n+    private String deviceTelemetryProtoSchema;\n+    private String deviceAttributesProtoSchema;\n+\n+    @Override\n+    public TransportPayloadType getTransportPayloadType() {\n+        return TransportPayloadType.PROTOBUF;\n+    }\n+\n+    public void validateTransportProtoSchema(String schema, String schemaName) throws IllegalArgumentException {", "originalCommit": "4725ad14514036f773b23670fbce1880a22d8192", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "abfb6893ba7dd67abba3e42f2c3f4f47b3b4a6d2", "url": "https://github.com/thingsboard/thingsboard/commit/abfb6893ba7dd67abba3e42f2c3f4f47b3b4a6d2", "message": "UI: Added unique alarm type validation in alarm rule", "committedDate": "2020-11-16T14:48:10Z", "type": "commit"}, {"oid": "9c14088cade430bcea819253d3093f0db2cbe159", "url": "https://github.com/thingsboard/thingsboard/commit/9c14088cade430bcea819253d3093f0db2cbe159", "message": "added # filter topic handling", "committedDate": "2020-11-16T14:56:59Z", "type": "commit"}, {"oid": "fde0e7824de10157f38f40e2d10bc535978e49c2", "url": "https://github.com/thingsboard/thingsboard/commit/fde0e7824de10157f38f40e2d10bc535978e49c2", "message": "change regex for # filter", "committedDate": "2020-11-16T14:56:59Z", "type": "commit"}, {"oid": "7482d73a9ba47954860c02ae206294e01afc9a27", "url": "https://github.com/thingsboard/thingsboard/commit/7482d73a9ba47954860c02ae206294e01afc9a27", "message": "added AlwaysTrueTopicFilter", "committedDate": "2020-11-16T14:56:59Z", "type": "commit"}, {"oid": "13a731ecb38203d4b17b187519dd98fb93c755cb", "url": "https://github.com/thingsboard/thingsboard/commit/13a731ecb38203d4b17b187519dd98fb93c755cb", "message": "fix MqttTopicFilterFactory toFilter", "committedDate": "2020-11-16T14:56:59Z", "type": "commit"}, {"oid": "7dc793e777a623c682f68bde03637de898cc22ed", "url": "https://github.com/thingsboard/thingsboard/commit/7dc793e777a623c682f68bde03637de898cc22ed", "message": "UI: Change translate", "committedDate": "2020-11-16T15:12:27Z", "type": "commit"}, {"oid": "566f24f42943e091907dbc87db7e7a8e6d0a9aef", "url": "https://github.com/thingsboard/thingsboard/commit/566f24f42943e091907dbc87db7e7a8e6d0a9aef", "message": "Merge pull request #3733 from vvlladd28/improvement/device-profile/alarm-type/validation\n\nUI: Added unique alarm type validation in alarm rule", "committedDate": "2020-11-16T15:17:14Z", "type": "commit"}, {"oid": "aa61db22f2ec63efe3c167b0a012978bc95690ba", "url": "https://github.com/thingsboard/thingsboard/commit/aa61db22f2ec63efe3c167b0a012978bc95690ba", "message": "added validations for DeviceProfileAlarm type", "committedDate": "2020-11-16T16:49:18Z", "type": "commit"}, {"oid": "3c5bce7d20509113efd5ae304eb298ea85016d71", "url": "https://github.com/thingsboard/thingsboard/commit/3c5bce7d20509113efd5ae304eb298ea85016d71", "message": "Updated thermostat demo", "committedDate": "2020-11-16T16:58:41Z", "type": "commit"}, {"oid": "eecc6aa1a69a9b558c76dd59399df68ebbc49d39", "url": "https://github.com/thingsboard/thingsboard/commit/eecc6aa1a69a9b558c76dd59399df68ebbc49d39", "message": "fix dynamic schemas, tests", "committedDate": "2020-11-16T17:08:55Z", "type": "commit"}, {"oid": "dc310f4cab6488beb3e70b377273c26c61348799", "url": "https://github.com/thingsboard/thingsboard/commit/dc310f4cab6488beb3e70b377273c26c61348799", "message": "merge with master", "committedDate": "2020-11-16T17:13:00Z", "type": "commit"}, {"oid": "be094fc62a7b0df444344d3c5796f61b57c1caf9", "url": "https://github.com/thingsboard/thingsboard/commit/be094fc62a7b0df444344d3c5796f61b57c1caf9", "message": "fix license", "committedDate": "2020-11-16T17:15:34Z", "type": "commit"}]}