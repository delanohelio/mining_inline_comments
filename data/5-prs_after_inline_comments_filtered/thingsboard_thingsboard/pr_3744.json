{"pr_number": 3744, "pr_title": "created sendApiFeatureStateEmail", "pr_createdAt": "2020-11-17T15:34:49Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3744", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2MjAzNg==", "url": "https://github.com/thingsboard/thingsboard/pull/3744#discussion_r525262036", "bodyText": "Please add info about the update to the log.", "author": "ashvayka", "createdAt": "2020-11-17T15:40:43Z", "path": "application/src/main/java/org/thingsboard/server/service/apiusage/DefaultTbApiUsageStateService.java", "diffHunk": "@@ -286,7 +286,26 @@ private void persistAndNotify(TenantApiUsageState state, Map<ApiFeature, ApiUsag\n         List<TsKvEntry> stateTelemetry = new ArrayList<>();\n         result.forEach(((apiFeature, aState) -> stateTelemetry.add(new BasicTsKvEntry(ts, new StringDataEntry(apiFeature.getApiStateKey(), aState.name())))));\n         tsWsService.saveAndNotifyInternal(state.getTenantId(), state.getApiUsageState().getId(), stateTelemetry, VOID_CALLBACK);\n-        //TODO: notify tenant admin via email!\n+\n+        String email = tenantService.findTenantById(state.getTenantId()).getEmail();\n+\n+        if (StringUtils.isNotEmpty(email)) {\n+            result.forEach((apiFeature, stateValue) -> {\n+                ApiUsageRecordKey[] keys = ApiUsageRecordKey.getKeys(apiFeature);\n+                ApiUsageStateMailMessage[] msgs = new ApiUsageStateMailMessage[keys.length];\n+                for (int i = 0; i < keys.length; i++) {\n+                    ApiUsageRecordKey key = keys[i];\n+                    msgs[i] = new ApiUsageStateMailMessage(key, state.getProfileThreshold(key), state.get(key));\n+                }\n+                try {\n+                    mailService.sendApiFeatureStateEmail(apiFeature, stateValue, email, msgs);\n+                } catch (ThingsboardException e) {\n+                    log.warn(\"[{}] Can't send update of the API state to tenant with provided email [{}]\", state.getTenantId(), email, e);\n+                }\n+            });\n+        } else {\n+            log.warn(\"[{}] Can't send update of the API state to tenant with empty email!\", state.getTenantId());", "originalCommit": "b60f65e0a9449ad8b78306ea3a092f7ccc2eda1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2MjYyOA==", "url": "https://github.com/thingsboard/thingsboard/pull/3744#discussion_r525262628", "bodyText": "Let's move this to a separate thread. This may be very time consuming.", "author": "ashvayka", "createdAt": "2020-11-17T15:41:30Z", "path": "application/src/main/java/org/thingsboard/server/service/apiusage/DefaultTbApiUsageStateService.java", "diffHunk": "@@ -286,7 +286,26 @@ private void persistAndNotify(TenantApiUsageState state, Map<ApiFeature, ApiUsag\n         List<TsKvEntry> stateTelemetry = new ArrayList<>();\n         result.forEach(((apiFeature, aState) -> stateTelemetry.add(new BasicTsKvEntry(ts, new StringDataEntry(apiFeature.getApiStateKey(), aState.name())))));\n         tsWsService.saveAndNotifyInternal(state.getTenantId(), state.getApiUsageState().getId(), stateTelemetry, VOID_CALLBACK);\n-        //TODO: notify tenant admin via email!\n+\n+        String email = tenantService.findTenantById(state.getTenantId()).getEmail();\n+\n+        if (StringUtils.isNotEmpty(email)) {\n+            result.forEach((apiFeature, stateValue) -> {\n+                ApiUsageRecordKey[] keys = ApiUsageRecordKey.getKeys(apiFeature);\n+                ApiUsageStateMailMessage[] msgs = new ApiUsageStateMailMessage[keys.length];\n+                for (int i = 0; i < keys.length; i++) {\n+                    ApiUsageRecordKey key = keys[i];\n+                    msgs[i] = new ApiUsageStateMailMessage(key, state.getProfileThreshold(key), state.get(key));\n+                }\n+                try {\n+                    mailService.sendApiFeatureStateEmail(apiFeature, stateValue, email, msgs);", "originalCommit": "b60f65e0a9449ad8b78306ea3a092f7ccc2eda1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5f7e5337964a3675bb1e4b6b3a756de0f59b12c6", "url": "https://github.com/thingsboard/thingsboard/commit/5f7e5337964a3675bb1e4b6b3a756de0f59b12c6", "message": "Improvements to the templates", "committedDate": "2020-11-18T13:28:16Z", "type": "commit"}]}