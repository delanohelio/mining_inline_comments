{"pr_number": 1594, "pr_title": "Elide 5: Sketch out support for nested query plans.", "pr_createdAt": "2020-10-15T16:55:42Z", "pr_url": "https://github.com/yahoo/elide/pull/1594", "timeline": [{"oid": "3b5b33d1b1d09b0fc21916d03d2862c2fdf31fae", "url": "https://github.com/yahoo/elide/commit/3b5b33d1b1d09b0fc21916d03d2862c2fdf31fae", "message": "added query plan to Metric formula", "committedDate": "2020-10-13T18:35:39Z", "type": "commit"}, {"oid": "78237eb6236fd775e4227bce62446ecfd759c5da", "url": "https://github.com/yahoo/elide/commit/78237eb6236fd775e4227bce62446ecfd759c5da", "message": "Added monthly time grain to playerStats test table", "committedDate": "2020-10-13T19:46:28Z", "type": "commit"}, {"oid": "874028f7ffa05a255576865979f88426823fd20b", "url": "https://github.com/yahoo/elide/commit/874028f7ffa05a255576865979f88426823fd20b", "message": "Made query plan queryable.  Added query resolver test", "committedDate": "2020-10-13T22:08:46Z", "type": "commit"}, {"oid": "5f7d1cd9b5b5a3857d9a3d5d50cfd030e49449c3", "url": "https://github.com/yahoo/elide/commit/5f7d1cd9b5b5a3857d9a3d5d50cfd030e49449c3", "message": "Removed visit from SQLTable", "committedDate": "2020-10-13T22:11:05Z", "type": "commit"}, {"oid": "40d1c4a78dd4d1da2e90853294a9ee0d91b8d9ad", "url": "https://github.com/yahoo/elide/commit/40d1c4a78dd4d1da2e90853294a9ee0d91b8d9ad", "message": "Added QueryPlanTranslator", "committedDate": "2020-10-13T22:45:01Z", "type": "commit"}, {"oid": "d0afc7bc9fc1bf82480a4b2752764b017a3aa089", "url": "https://github.com/yahoo/elide/commit/d0afc7bc9fc1bf82480a4b2752764b017a3aa089", "message": "Added todo comments", "committedDate": "2020-10-13T23:00:17Z", "type": "commit"}, {"oid": "91d402177308073dbc2c276195bdc94c1f30f497", "url": "https://github.com/yahoo/elide/commit/91d402177308073dbc2c276195bdc94c1f30f497", "message": "Fixed a number of bugs", "committedDate": "2020-10-14T04:02:23Z", "type": "commit"}, {"oid": "fa47a7d0db67d63e3227cb84c1a42e5a0ac8432b", "url": "https://github.com/yahoo/elide/commit/fa47a7d0db67d63e3227cb84c1a42e5a0ac8432b", "message": "Fixed more issues", "committedDate": "2020-10-14T17:02:58Z", "type": "commit"}, {"oid": "2cded7e07c6eb9e6f7fcaace4f7c1e55be4dfc84", "url": "https://github.com/yahoo/elide/commit/2cded7e07c6eb9e6f7fcaace4f7c1e55be4dfc84", "message": "Fixed all but one error", "committedDate": "2020-10-14T18:14:54Z", "type": "commit"}, {"oid": "2e3e5b256f02a54f0044780e5f999d0bb2781392", "url": "https://github.com/yahoo/elide/commit/2e3e5b256f02a54f0044780e5f999d0bb2781392", "message": "SQLUnitTest registers custom time serdes.", "committedDate": "2020-10-14T18:20:36Z", "type": "commit"}, {"oid": "b240f605f4bdaddafc94a7da804c5de529f7b523", "url": "https://github.com/yahoo/elide/commit/b240f605f4bdaddafc94a7da804c5de529f7b523", "message": "Added withSource methods to do proper conversions of projections", "committedDate": "2020-10-14T19:42:15Z", "type": "commit"}, {"oid": "cae710e970668fc22e6d5ecf0c7646927e7b73fa", "url": "https://github.com/yahoo/elide/commit/cae710e970668fc22e6d5ecf0c7646927e7b73fa", "message": "Added nesting and merge logic", "committedDate": "2020-10-14T21:22:45Z", "type": "commit"}, {"oid": "d19119d19fad329a3365cecc9cfe703a3c174a1f", "url": "https://github.com/yahoo/elide/commit/d19119d19fad329a3365cecc9cfe703a3c174a1f", "message": "Fixed issue with query symbol resolution.  QueryPlanResolver now sources projections directly from the SQL table.", "committedDate": "2020-10-14T22:20:07Z", "type": "commit"}, {"oid": "9edd4267c49b630d45854897544e2b7c7d1d0496", "url": "https://github.com/yahoo/elide/commit/9edd4267c49b630d45854897544e2b7c7d1d0496", "message": "Fixed more issues.", "committedDate": "2020-10-14T22:52:07Z", "type": "commit"}, {"oid": "dc356ece85f8e09fda4a77ac16e8ee795331ed3d", "url": "https://github.com/yahoo/elide/commit/dc356ece85f8e09fda4a77ac16e8ee795331ed3d", "message": "Build passes", "committedDate": "2020-10-14T23:53:59Z", "type": "commit"}, {"oid": "538892d97f023d5d9e094dd585a3ac8d94b006c5", "url": "https://github.com/yahoo/elide/commit/538892d97f023d5d9e094dd585a3ac8d94b006c5", "message": "Decoupled QueryPlan from SQL classes", "committedDate": "2020-10-15T14:30:59Z", "type": "commit"}, {"oid": "a8825c839ec98e55cb875d8fa50c0c9b7b7bf0ec", "url": "https://github.com/yahoo/elide/commit/a8825c839ec98e55cb875d8fa50c0c9b7b7bf0ec", "message": "Build Passes", "committedDate": "2020-10-15T15:29:59Z", "type": "commit"}, {"oid": "ec74d48e38fa519c7a245078f91a016464bf8dc6", "url": "https://github.com/yahoo/elide/commit/ec74d48e38fa519c7a245078f91a016464bf8dc6", "message": "Updated a few comments", "committedDate": "2020-10-15T16:09:50Z", "type": "commit"}, {"oid": "a2bd82c1036549256de7b8f1ad555a3fb146d296", "url": "https://github.com/yahoo/elide/commit/a2bd82c1036549256de7b8f1ad555a3fb146d296", "message": "Added new dynamic sql reference resolver which avoids copying all the static lookups for each query.", "committedDate": "2020-10-15T16:52:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgyMzMwNg==", "url": "https://github.com/yahoo/elide/pull/1594#discussion_r505823306", "bodyText": "This could be written as if (!invoked)", "author": "moizarafat", "createdAt": "2020-10-15T20:33:24Z", "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/query/QueryPlanTranslator.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+\n+package com.yahoo.elide.datastores.aggregation.queryengines.sql.query;\n+\n+import static com.yahoo.elide.datastores.aggregation.query.QueryPlan.nestColumnProjection;\n+import static com.yahoo.elide.datastores.aggregation.query.QueryPlan.withSource;\n+\n+import com.yahoo.elide.datastores.aggregation.query.ColumnProjection;\n+import com.yahoo.elide.datastores.aggregation.query.Query;\n+import com.yahoo.elide.datastores.aggregation.query.QueryVisitor;\n+import com.yahoo.elide.datastores.aggregation.query.Queryable;\n+import com.yahoo.elide.datastores.aggregation.query.TimeDimensionProjection;\n+import com.google.common.collect.Streams;\n+\n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Translates a merged query plan and a client query into query that can be executed.\n+ *\n+ * Column projection expressions originating from the query plan are left untouched.\n+ * Column projection expressions originating from the client query are nested for outer queries.\n+ */\n+public class QueryPlanTranslator implements QueryVisitor<Query.QueryBuilder> {\n+\n+    private Query clientQuery;\n+\n+    //Whether or not this visitor has been invoked yet.\n+    private boolean invoked = false;\n+\n+    public QueryPlanTranslator(Query clientQuery) {\n+        this.clientQuery = clientQuery;\n+    }\n+\n+    @Override\n+    public Query.QueryBuilder visitQuery(Query query) {\n+        throw new UnsupportedOperationException(\"Visitor does not visit queries\");\n+    }\n+\n+    @Override\n+    public Query.QueryBuilder visitQueryable(Queryable plan) {\n+        if (invoked == false) {", "originalCommit": "a2bd82c1036549256de7b8f1ad555a3fb146d296", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c3ab9c1292d6f9c6ef1f2ee864cf7784dcb11e1", "url": "https://github.com/yahoo/elide/commit/5c3ab9c1292d6f9c6ef1f2ee864cf7784dcb11e1", "message": "Rework", "committedDate": "2020-10-15T21:27:15Z", "type": "commit"}]}