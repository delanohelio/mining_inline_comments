{"pr_number": 1622, "pr_title": "Refactor dbconnection", "pr_createdAt": "2020-10-30T16:27:15Z", "pr_url": "https://github.com/yahoo/elide/pull/1622", "timeline": [{"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "url": "https://github.com/yahoo/elide/commit/d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "message": "Refactoring to add ConnectionDetails object to SQLTable", "committedDate": "2020-10-30T16:25:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODA1OA==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515298058", "bodyText": "We can just return connectionDetails here.", "author": "aklish", "createdAt": "2020-10-30T18:24:19Z", "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/query/Queryable.java", "diffHunk": "@@ -138,11 +140,15 @@ default TimeDimensionProjection getTimeDimensionProjection(String name) {\n     }\n \n     /**\n-     * Returns the connection name where this queryable is sourced from.\n-     * @return the connectinon name\n+     * Returns the connection details where this queryable is sourced from.\n+     * @return the connectinon details\n      */\n-    default String getDbConnectionName() {\n-        return getSource().getDbConnectionName();\n+    default ConnectionDetails getConnectionDetails() {\n+        ConnectionDetails connectionDetails = getSource().getConnectionDetails();\n+        if (connectionDetails == null) {\n+            throw new IllegalStateException(\"ConnectionDetails undefined for: \" + getSource().getName());\n+        }\n+        return getSource().getConnectionDetails();", "originalCommit": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODkxOQ==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515298919", "bodyText": "The SQLTable shouldn't need the default and connectionDetails map.  It should just be handed the only ConnectionDetail object that pertains to it.", "author": "aklish", "createdAt": "2020-10-30T18:26:00Z", "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -106,7 +117,7 @@ public Object apply(ResultSet rs) {\n \n     @Override\n     protected Table constructTable(Class<?> entityClass, EntityDictionary metaDataDictionary) {\n-        return new SQLTable(entityClass, metaDataDictionary);\n+        return new SQLTable(entityClass, metaDataDictionary, defaultConnectionDetails, connectionDetailsMap);", "originalCommit": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNzU2Mw==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515317563", "bodyText": "ok.", "author": "rishi-aga", "createdAt": "2020-10-30T19:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMTQ5MA==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515301490", "bodyText": "I don't feel like the connectionDetailsMap is something this class should be concerned with.\nThe more we keep the metadata models like dumb pojos - the more flexibility we have down the road to do make certain modifications I see coming.  Let's not put any more annotation parsing stuff in them.", "author": "aklish", "createdAt": "2020-10-30T18:31:04Z", "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/metadata/SQLTable.java", "diffHunk": "@@ -33,6 +40,32 @@\n  */\n @EqualsAndHashCode(callSuper = true)\n public class SQLTable extends Table implements Queryable {\n+\n+    @Getter\n+    private ConnectionDetails connectionDetails;\n+\n+    public SQLTable(Class<?> cls,\n+                    EntityDictionary dictionary,\n+                    ConnectionDetails defaultConnectionDetails,\n+                    Map<String, ConnectionDetails> connectionDetailsMap) {\n+        super(cls, dictionary);\n+\n+        String dbConnectionName = null;\n+        Annotation annotation =", "originalCommit": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNzczNw==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515317737", "bodyText": "updated.", "author": "rishi-aga", "createdAt": "2020-10-30T19:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMTQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMjA5Nw==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515302097", "bodyText": "How about an empty map here instead of null.", "author": "aklish", "createdAt": "2020-10-30T18:32:19Z", "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -67,10 +68,7 @@\n \n     public SQLQueryEngine(MetaDataStore metaDataStore,\n                     com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails defaultConnectionDetails) {\n-        super(metaDataStore);\n-        referenceTable = new SQLReferenceTable(metaDataStore);\n-        this.defaultConnectionDetails = new ConnectionDetails(defaultConnectionDetails.getDataSource(),\n-                        SQLDialectFactory.getDialect(defaultConnectionDetails.getDialect()));\n+        this(metaDataStore, defaultConnectionDetails, null);", "originalCommit": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMjM3Nw==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515302377", "bodyText": "I would just put google preconditions that defaultConn cannot be null nor can detailsMap.", "author": "aklish", "createdAt": "2020-10-30T18:32:58Z", "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -82,11 +80,24 @@ public SQLQueryEngine(MetaDataStore metaDataStore,\n     public SQLQueryEngine(MetaDataStore metaDataStore,\n                     com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails defaultConnectionDetails,\n                     Map<String, com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails> detailsMap) {\n-        this(metaDataStore, defaultConnectionDetails);\n-        detailsMap.forEach((name, details) -> {\n-            this.connectionDetailsMap.put(name, new ConnectionDetails(details.getDataSource(),\n-                            SQLDialectFactory.getDialect(details.getDialect())));\n-        });\n+        if (defaultConnectionDetails == null) {", "originalCommit": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNzkwMw==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515317903", "bodyText": "updated", "author": "rishi-aga", "createdAt": "2020-10-30T19:05:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMjM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMjczMQ==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515302731", "bodyText": "Is there a reason we moved all this initialization here (and removed final keywords as well from the parent class)?", "author": "aklish", "createdAt": "2020-10-30T18:33:45Z", "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -82,11 +80,24 @@ public SQLQueryEngine(MetaDataStore metaDataStore,\n     public SQLQueryEngine(MetaDataStore metaDataStore,\n                     com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails defaultConnectionDetails,\n                     Map<String, com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails> detailsMap) {\n-        this(metaDataStore, defaultConnectionDetails);\n-        detailsMap.forEach((name, details) -> {\n-            this.connectionDetailsMap.put(name, new ConnectionDetails(details.getDataSource(),\n-                            SQLDialectFactory.getDialect(details.getDialect())));\n-        });\n+        if (defaultConnectionDetails == null) {\n+            this.defaultConnectionDetails = null;\n+        } else {\n+            this.defaultConnectionDetails = new ConnectionDetails(defaultConnectionDetails.getDataSource(),\n+                            SQLDialectFactory.getDialect(defaultConnectionDetails.getDialect()));\n+        }\n+        if (!(detailsMap == null || detailsMap.size() == 0)) {\n+            detailsMap.forEach((name, details) -> {\n+                this.connectionDetailsMap.put(name, new ConnectionDetails(details.getDataSource(),\n+                                SQLDialectFactory.getDialect(details.getDialect())));\n+            });\n+        }\n+        this.metaDataStore = metaDataStore;", "originalCommit": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxODcyMw==", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515318723", "bodyText": "need to call construct table after initializing connection details map.", "author": "rishi-aga", "createdAt": "2020-10-30T19:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMjczMQ=="}], "type": "inlineReview"}, {"oid": "205ebdc46617414bf20b534b44975885e6e6bd6f", "url": "https://github.com/yahoo/elide/commit/205ebdc46617414bf20b534b44975885e6e6bd6f", "message": "Review Comments", "committedDate": "2020-10-30T19:04:16Z", "type": "commit"}]}