{"pr_number": 1354, "pr_title": "Elide dynamic config model verification", "pr_createdAt": "2020-05-29T05:20:02Z", "pr_url": "https://github.com/yahoo/elide/pull/1354", "timeline": [{"oid": "3f9357ce2b19408972d776058df36aa202cd2a85", "url": "https://github.com/yahoo/elide/commit/3f9357ce2b19408972d776058df36aa202cd2a85", "message": "sign & Verify model", "committedDate": "2020-05-29T05:15:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMDIzMQ==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432620231", "bodyText": "Please refer \n  \n    \n      elide/elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java\n    \n    \n         Line 64\n      in\n      ece0742\n    \n    \n    \n    \n\n        \n          \n           Options options = prepareOptions(); \n        \n    \n  \n\n. We want to use Options class.", "author": "moizarafat", "createdAt": "2020-05-29T17:05:25Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Methode to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws IllegalStateException\n+     */\n+    public static void main(String[] args) {\n+        if (args == null || args.length != 3) {", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMDQ2Mw==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432620463", "bodyText": "Please refer \n  \n    \n      elide/elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java\n    \n    \n         Line 270\n      in\n      ece0742\n    \n    \n    \n    \n\n        \n          \n           private static void printHelp(Options options) { \n        \n    \n  \n\n to use HelpFormatter.", "author": "moizarafat", "createdAt": "2020-05-29T17:05:52Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Methode to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws IllegalStateException\n+     */\n+    public static void main(String[] args) {\n+        if (args == null || args.length != 3) {\n+            usage();\n+            throw new IllegalStateException(\"No Arguments provided!\");\n+        }\n+        String modelTarFile = args[0];\n+        String signatureFile = args[1];\n+        String publicKeyName = args[2];\n+\n+        if (verify(tarContents(modelTarFile), signatureFile, getPublicKey(publicKeyName))) {\n+            log.info(\"Successfully Validated \" + modelTarFile);\n+        }\n+        else {\n+            log.error(\"Could not verify \" + modelTarFile + \" with details provided\");\n+        }\n+    }\n+\n+    private static PublicKey getPublicKey(String keyName) {\n+        PublicKey publicKey = null;\n+        try {\n+            KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+            Certificate cert = keyStore.getCertificate(keyName);\n+            publicKey = cert.getPublicKey();\n+        } catch (KeyStoreException e) {\n+            log.error(e.getMessage());\n+            throw new IllegalArgumentException(\"Key \" + keyName + \" is not availabe in keystore\");\n+        }\n+        return publicKey;\n+    }\n+\n+    /**\n+     * Verify signature of tar.gz.\n+     * @param fileList\n+     * @param signature\n+     * @param publicKey\n+     * @return whether the file can be verified by given key & signature.\n+     * @throws Exception\n+     */\n+    public static boolean verify(String fileList, String signature, PublicKey publicKey) {\n+        Signature publicSignature;\n+        try {\n+            publicSignature = Signature.getInstance(\"SHA256withRSA\");\n+            publicSignature.initVerify(publicKey);\n+            publicSignature.update(fileList.getBytes(StandardCharsets.UTF_8));\n+            byte[] signatureBytes = Base64.getDecoder().decode(signature);\n+            return publicSignature.verify(signatureBytes);\n+        } catch (NoSuchAlgorithmException e) {\n+            log.error(e.getMessage());\n+        } catch (InvalidKeyException e) {\n+            log.error(e.getMessage());\n+        } catch (SignatureException e) {\n+            log.error(e.getMessage());\n+        }\n+        return false;\n+    }\n+\n+    private static String tarContents(String archiveFile) {\n+        StringBuffer sb = new StringBuffer();\n+        try (TarArchiveInputStream archive = new TarArchiveInputStream(\n+                new GzipCompressorInputStream(new BufferedInputStream(new FileInputStream(archiveFile))))) {\n+            TarArchiveEntry entry;\n+            while ((entry = archive.getNextTarEntry()) != null) {\n+                sb.append(entry.getName());\n+            }\n+        } catch (IOException e) {\n+            log.error(e.getMessage());\n+            throw new IllegalArgumentException(\"archiveFile \" + archiveFile + \" is not available\");\n+        }\n+        return sb.toString();\n+    }\n+\n+    private static void usage() {", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMTI2Mg==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432621262", "bodyText": "Lets not catch the exception and just let the original exception propagate unto main.", "author": "moizarafat", "createdAt": "2020-05-29T17:06:52Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Methode to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws IllegalStateException\n+     */\n+    public static void main(String[] args) {\n+        if (args == null || args.length != 3) {\n+            usage();\n+            throw new IllegalStateException(\"No Arguments provided!\");\n+        }\n+        String modelTarFile = args[0];\n+        String signatureFile = args[1];\n+        String publicKeyName = args[2];\n+\n+        if (verify(tarContents(modelTarFile), signatureFile, getPublicKey(publicKeyName))) {\n+            log.info(\"Successfully Validated \" + modelTarFile);\n+        }\n+        else {\n+            log.error(\"Could not verify \" + modelTarFile + \" with details provided\");\n+        }\n+    }\n+\n+    private static PublicKey getPublicKey(String keyName) {\n+        PublicKey publicKey = null;\n+        try {\n+            KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+            Certificate cert = keyStore.getCertificate(keyName);\n+            publicKey = cert.getPublicKey();\n+        } catch (KeyStoreException e) {", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMjQyMg==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432622422", "bodyText": "same, let the exceptions propagate back as is.", "author": "moizarafat", "createdAt": "2020-05-29T17:08:13Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Methode to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws IllegalStateException\n+     */\n+    public static void main(String[] args) {\n+        if (args == null || args.length != 3) {\n+            usage();\n+            throw new IllegalStateException(\"No Arguments provided!\");\n+        }\n+        String modelTarFile = args[0];\n+        String signatureFile = args[1];\n+        String publicKeyName = args[2];\n+\n+        if (verify(tarContents(modelTarFile), signatureFile, getPublicKey(publicKeyName))) {\n+            log.info(\"Successfully Validated \" + modelTarFile);\n+        }\n+        else {\n+            log.error(\"Could not verify \" + modelTarFile + \" with details provided\");\n+        }\n+    }\n+\n+    private static PublicKey getPublicKey(String keyName) {\n+        PublicKey publicKey = null;\n+        try {\n+            KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+            Certificate cert = keyStore.getCertificate(keyName);\n+            publicKey = cert.getPublicKey();\n+        } catch (KeyStoreException e) {\n+            log.error(e.getMessage());\n+            throw new IllegalArgumentException(\"Key \" + keyName + \" is not availabe in keystore\");\n+        }\n+        return publicKey;\n+    }\n+\n+    /**\n+     * Verify signature of tar.gz.\n+     * @param fileList\n+     * @param signature\n+     * @param publicKey\n+     * @return whether the file can be verified by given key & signature.\n+     * @throws Exception\n+     */\n+    public static boolean verify(String fileList, String signature, PublicKey publicKey) {\n+        Signature publicSignature;\n+        try {\n+            publicSignature = Signature.getInstance(\"SHA256withRSA\");\n+            publicSignature.initVerify(publicKey);\n+            publicSignature.update(fileList.getBytes(StandardCharsets.UTF_8));\n+            byte[] signatureBytes = Base64.getDecoder().decode(signature);\n+            return publicSignature.verify(signatureBytes);\n+        } catch (NoSuchAlgorithmException e) {", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMjYzMQ==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432622631", "bodyText": "Let exception propagate as is.", "author": "moizarafat", "createdAt": "2020-05-29T17:08:32Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Methode to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws IllegalStateException\n+     */\n+    public static void main(String[] args) {\n+        if (args == null || args.length != 3) {\n+            usage();\n+            throw new IllegalStateException(\"No Arguments provided!\");\n+        }\n+        String modelTarFile = args[0];\n+        String signatureFile = args[1];\n+        String publicKeyName = args[2];\n+\n+        if (verify(tarContents(modelTarFile), signatureFile, getPublicKey(publicKeyName))) {\n+            log.info(\"Successfully Validated \" + modelTarFile);\n+        }\n+        else {\n+            log.error(\"Could not verify \" + modelTarFile + \" with details provided\");\n+        }\n+    }\n+\n+    private static PublicKey getPublicKey(String keyName) {\n+        PublicKey publicKey = null;\n+        try {\n+            KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+            Certificate cert = keyStore.getCertificate(keyName);\n+            publicKey = cert.getPublicKey();\n+        } catch (KeyStoreException e) {\n+            log.error(e.getMessage());\n+            throw new IllegalArgumentException(\"Key \" + keyName + \" is not availabe in keystore\");\n+        }\n+        return publicKey;\n+    }\n+\n+    /**\n+     * Verify signature of tar.gz.\n+     * @param fileList\n+     * @param signature\n+     * @param publicKey\n+     * @return whether the file can be verified by given key & signature.\n+     * @throws Exception\n+     */\n+    public static boolean verify(String fileList, String signature, PublicKey publicKey) {\n+        Signature publicSignature;\n+        try {\n+            publicSignature = Signature.getInstance(\"SHA256withRSA\");\n+            publicSignature.initVerify(publicKey);\n+            publicSignature.update(fileList.getBytes(StandardCharsets.UTF_8));\n+            byte[] signatureBytes = Base64.getDecoder().decode(signature);\n+            return publicSignature.verify(signatureBytes);\n+        } catch (NoSuchAlgorithmException e) {\n+            log.error(e.getMessage());\n+        } catch (InvalidKeyException e) {\n+            log.error(e.getMessage());\n+        } catch (SignatureException e) {\n+            log.error(e.getMessage());\n+        }\n+        return false;\n+    }\n+\n+    private static String tarContents(String archiveFile) {\n+        StringBuffer sb = new StringBuffer();\n+        try (TarArchiveInputStream archive = new TarArchiveInputStream(\n+                new GzipCompressorInputStream(new BufferedInputStream(new FileInputStream(archiveFile))))) {\n+            TarArchiveEntry entry;\n+            while ((entry = archive.getNextTarEntry()) != null) {\n+                sb.append(entry.getName());\n+            }\n+        } catch (IOException e) {\n+            log.error(e.getMessage());", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMzE5MA==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432623190", "bodyText": "Since this method is used by all test cases, we can annotate with @BeforeEach instead of calling setup from the individual tests.", "author": "moizarafat", "createdAt": "2020-05-29T17:09:32Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/test/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifiesTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.security.KeyPair;\n+import java.security.KeyPairGenerator;\n+import java.security.PrivateKey;\n+import java.security.SecureRandom;\n+import java.security.Signature;\n+import java.util.Base64;\n+\n+public class DynamicConfigVerifiesTest {\n+\n+    private KeyPair kp;\n+    private String signature;\n+\n+    private static KeyPair generateKeyPair() throws Exception {\n+        KeyPairGenerator generator = KeyPairGenerator.getInstance(\"RSA\");\n+        generator.initialize(2048, new SecureRandom());\n+        KeyPair pair = generator.generateKeyPair();\n+        return pair;\n+    }\n+\n+    private static String sign(String data, PrivateKey privateKey) throws Exception {\n+        Signature privateSignature = Signature.getInstance(\"SHA256withRSA\");\n+        privateSignature.initSign(privateKey);\n+        privateSignature.update(data.getBytes(StandardCharsets.UTF_8));\n+\n+        byte[] signature = privateSignature.sign();\n+\n+        return Base64.getEncoder().encodeToString(signature);\n+    }\n+\n+    private void setup() throws Exception {", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMzI5Mw==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432623293", "bodyText": "this is same as setup method.", "author": "moizarafat", "createdAt": "2020-05-29T17:09:43Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/test/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifiesTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.security.KeyPair;\n+import java.security.KeyPairGenerator;\n+import java.security.PrivateKey;\n+import java.security.SecureRandom;\n+import java.security.Signature;\n+import java.util.Base64;\n+\n+public class DynamicConfigVerifiesTest {\n+\n+    private KeyPair kp;\n+    private String signature;\n+\n+    private static KeyPair generateKeyPair() throws Exception {\n+        KeyPairGenerator generator = KeyPairGenerator.getInstance(\"RSA\");\n+        generator.initialize(2048, new SecureRandom());\n+        KeyPair pair = generator.generateKeyPair();\n+        return pair;\n+    }\n+\n+    private static String sign(String data, PrivateKey privateKey) throws Exception {\n+        Signature privateSignature = Signature.getInstance(\"SHA256withRSA\");\n+        privateSignature.initSign(privateKey);\n+        privateSignature.update(data.getBytes(StandardCharsets.UTF_8));\n+\n+        byte[] signature = privateSignature.sign();\n+\n+        return Base64.getEncoder().encodeToString(signature);\n+    }\n+\n+    private void setup() throws Exception {\n+        kp = generateKeyPair();\n+        signature = sign(\"testing-signature\", kp.getPrivate());\n+    }\n+\n+    @Test\n+    public void testValidSignature() throws Exception {\n+        setup();\n+        assertTrue(DynamicConfigVerifier.verify(\"testing-signature\", signature, kp.getPublic()));\n+    }\n+\n+    @Test\n+    public void testInvalidSignature() throws Exception {\n+        setup();\n+        assertFalse(DynamicConfigVerifier.verify(\"invalid-signature\", signature, kp.getPublic()));\n+    }\n+\n+    @Test\n+    public void testFileSignature() throws Exception {\n+        kp = generateKeyPair();", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyNDUzMQ==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432624531", "bodyText": "readTarFile will be a better name here. tarContents sounds like we are trying to generate a tar.", "author": "moizarafat", "createdAt": "2020-05-29T17:12:17Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Methode to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws IllegalStateException\n+     */\n+    public static void main(String[] args) {\n+        if (args == null || args.length != 3) {\n+            usage();\n+            throw new IllegalStateException(\"No Arguments provided!\");\n+        }\n+        String modelTarFile = args[0];\n+        String signatureFile = args[1];\n+        String publicKeyName = args[2];\n+\n+        if (verify(tarContents(modelTarFile), signatureFile, getPublicKey(publicKeyName))) {\n+            log.info(\"Successfully Validated \" + modelTarFile);\n+        }\n+        else {\n+            log.error(\"Could not verify \" + modelTarFile + \" with details provided\");\n+        }\n+    }\n+\n+    private static PublicKey getPublicKey(String keyName) {\n+        PublicKey publicKey = null;\n+        try {\n+            KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+            Certificate cert = keyStore.getCertificate(keyName);\n+            publicKey = cert.getPublicKey();\n+        } catch (KeyStoreException e) {\n+            log.error(e.getMessage());\n+            throw new IllegalArgumentException(\"Key \" + keyName + \" is not availabe in keystore\");\n+        }\n+        return publicKey;\n+    }\n+\n+    /**\n+     * Verify signature of tar.gz.\n+     * @param fileList\n+     * @param signature\n+     * @param publicKey\n+     * @return whether the file can be verified by given key & signature.\n+     * @throws Exception\n+     */\n+    public static boolean verify(String fileList, String signature, PublicKey publicKey) {\n+        Signature publicSignature;\n+        try {\n+            publicSignature = Signature.getInstance(\"SHA256withRSA\");\n+            publicSignature.initVerify(publicKey);\n+            publicSignature.update(fileList.getBytes(StandardCharsets.UTF_8));\n+            byte[] signatureBytes = Base64.getDecoder().decode(signature);\n+            return publicSignature.verify(signatureBytes);\n+        } catch (NoSuchAlgorithmException e) {\n+            log.error(e.getMessage());\n+        } catch (InvalidKeyException e) {\n+            log.error(e.getMessage());\n+        } catch (SignatureException e) {\n+            log.error(e.getMessage());\n+        }\n+        return false;\n+    }\n+\n+    private static String tarContents(String archiveFile) {", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyNjMxOA==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r432626318", "bodyText": "list the exceptions instead of generic exception.", "author": "moizarafat", "createdAt": "2020-05-29T17:15:51Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Methode to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws IllegalStateException\n+     */\n+    public static void main(String[] args) {\n+        if (args == null || args.length != 3) {\n+            usage();\n+            throw new IllegalStateException(\"No Arguments provided!\");\n+        }\n+        String modelTarFile = args[0];\n+        String signatureFile = args[1];\n+        String publicKeyName = args[2];\n+\n+        if (verify(tarContents(modelTarFile), signatureFile, getPublicKey(publicKeyName))) {\n+            log.info(\"Successfully Validated \" + modelTarFile);\n+        }\n+        else {\n+            log.error(\"Could not verify \" + modelTarFile + \" with details provided\");\n+        }\n+    }\n+\n+    private static PublicKey getPublicKey(String keyName) {\n+        PublicKey publicKey = null;\n+        try {\n+            KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+            Certificate cert = keyStore.getCertificate(keyName);\n+            publicKey = cert.getPublicKey();\n+        } catch (KeyStoreException e) {\n+            log.error(e.getMessage());\n+            throw new IllegalArgumentException(\"Key \" + keyName + \" is not availabe in keystore\");\n+        }\n+        return publicKey;\n+    }\n+\n+    /**\n+     * Verify signature of tar.gz.\n+     * @param fileList\n+     * @param signature\n+     * @param publicKey\n+     * @return whether the file can be verified by given key & signature.\n+     * @throws Exception", "originalCommit": "3f9357ce2b19408972d776058df36aa202cd2a85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f9f7d789687d11244fc0a0a0f02083e21d3d49de", "url": "https://github.com/yahoo/elide/commit/f9f7d789687d11244fc0a0a0f02083e21d3d49de", "message": "Merge branch 'elide-5.x' into elide-5.x-dynamic-config-sign-verify", "committedDate": "2020-06-02T04:16:30Z", "type": "commit"}, {"oid": "45ed1c58ee31f4aeb51c15b2a653cacba0760c81", "url": "https://github.com/yahoo/elide/commit/45ed1c58ee31f4aeb51c15b2a653cacba0760c81", "message": "review comments", "committedDate": "2020-06-02T07:46:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyMTI3NQ==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r433921275", "bodyText": "Arguments is spelled incorrectly in this class a few times.", "author": "moizarafat", "createdAt": "2020-06-02T14:29:04Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/test/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifiesTest.java", "diffHunk": "@@ -40,28 +45,47 @@ private static String sign(String data, PrivateKey privateKey) throws Exception\n         return Base64.getEncoder().encodeToString(signature);\n     }\n \n-    private void setup() throws Exception {\n+    @BeforeAll\n+    public static void setup() throws Exception {\n         kp = generateKeyPair();\n-        signature = sign(\"testing-signature\", kp.getPrivate());\n+        signature = sign(\"testing-signature5\", kp.getPrivate());\n     }\n \n     @Test\n     public void testValidSignature() throws Exception {\n-        setup();\n-        assertTrue(DynamicConfigVerifier.verify(\"testing-signature\", signature, kp.getPublic()));\n+        assertTrue(DynamicConfigVerifier.verify(\"testing-signature\", 5, signature, kp.getPublic()));\n     }\n \n     @Test\n     public void testInvalidSignature() throws Exception {\n-        setup();\n-        assertFalse(DynamicConfigVerifier.verify(\"invalid-signature\", signature, kp.getPublic()));\n+        assertFalse(DynamicConfigVerifier.verify(\"invalid-signature\", 5, signature, kp.getPublic()));\n     }\n \n     @Test\n-    public void testFileSignature() throws Exception {\n-        kp = generateKeyPair();\n-        signature = sign(\"testing-signature\", kp.getPrivate());\n+    public void testHelpArgumnents() {", "originalCommit": "45ed1c58ee31f4aeb51c15b2a653cacba0760c81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e80cffbb26f3044b7b0cb05e5f890253b888b5aa", "url": "https://github.com/yahoo/elide/commit/e80cffbb26f3044b7b0cb05e5f890253b888b5aa", "message": "typo fix", "committedDate": "2020-06-02T15:34:51Z", "type": "commit"}, {"oid": "e6e6d3d8cc3a2c0a6a5c9382b3aa6046773bd735", "url": "https://github.com/yahoo/elide/commit/e6e6d3d8cc3a2c0a6a5c9382b3aa6046773bd735", "message": "indent fix", "committedDate": "2020-06-03T03:53:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NzI5MA==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r434887290", "bodyText": "Java doc comment explaining what this is for", "author": "aklish", "createdAt": "2020-06-03T22:14:02Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.HelpFormatter;\n+import org.apache.commons.cli.MissingOptionException;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.apache.commons.cli.ParseException;\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+import org.apache.commons.io.FileUtils;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {", "originalCommit": "e6e6d3d8cc3a2c0a6a5c9382b3aa6046773bd735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4ODIyNA==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r434888224", "bodyText": "This seems to be only verifying the names of the files but not the file contents.  Am I reading this correct?   If so - we'll need to verify the contents as well.", "author": "aklish", "createdAt": "2020-06-03T22:16:17Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.HelpFormatter;\n+import org.apache.commons.cli.MissingOptionException;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.apache.commons.cli.ParseException;\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+import org.apache.commons.io.FileUtils;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Method to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws ParseException\n+     * @throws IOException\n+     * @throws KeyStoreException\n+     * @throws FileNotFoundException\n+     * @throws SignatureException\n+     * @throws NoSuchAlgorithmException\n+     * @throws InvalidKeyException\n+     *\n+     */\n+    public static void main(String[] args) throws ParseException, InvalidKeyException, NoSuchAlgorithmException,\n+    SignatureException, FileNotFoundException, KeyStoreException, IOException {\n+\n+        Options options = prepareOptions();\n+        CommandLine cli = new DefaultParser().parse(options, args);\n+\n+        if (cli.hasOption(\"help\")) {\n+            printHelp(options);\n+            return;\n+        }\n+        if (!cli.hasOption(\"tarFile\") || !cli.hasOption(\"signatureFile\") || !cli.hasOption(\"publicKeyName\")) {\n+            printHelp(options);\n+            throw new MissingOptionException(\"Missing required option\");\n+        }\n+\n+        String modelTarFile = cli.getOptionValue(\"tarFile\");\n+        String signatureFile = cli.getOptionValue(\"signatureFile\");\n+        String publicKeyName = cli.getOptionValue(\"publicKeyName\");\n+        long tarFileSize = getFileSize(modelTarFile);\n+\n+        if (verify(readTarContents(modelTarFile), tarFileSize,\n+                signatureFile, getPublicKey(publicKeyName))) {\n+            log.info(\"Successfully Validated \" + modelTarFile);\n+        }\n+        else {\n+            log.error(\"Could not verify \" + modelTarFile + \" with details provided\");\n+        }\n+    }\n+\n+    /**\n+     * Verify signature of tar.gz.\n+     * @param fileList : list of files\n+     * @param sizeOfFile : size of tar file\n+     * @param signature : file containing signature\n+     * @param publicKey : public key name\n+     * @return whether the file can be verified by given key and signature\n+     * @throws NoSuchAlgorithmException\n+     * @throws InvalidKeyException\n+     * @throws SignatureException\n+     */\n+    public static boolean verify(String fileList, long sizeOfFile, String signature, PublicKey publicKey)\n+            throws NoSuchAlgorithmException, InvalidKeyException, SignatureException {\n+\n+        Signature publicSignature;\n+\n+        publicSignature = Signature.getInstance(\"SHA256withRSA\");\n+        publicSignature.initVerify(publicKey);\n+        publicSignature.update((fileList + sizeOfFile).getBytes(StandardCharsets.UTF_8));\n+        byte[] signatureBytes = Base64.getDecoder().decode(signature);\n+        return publicSignature.verify(signatureBytes);\n+    }\n+\n+    /**\n+     * Get tar file size.\n+     * @param modelTarFile\n+     * @return size of tar file\n+     */\n+    private static long getFileSize(String modelTarFile) {\n+        return FileUtils.sizeOf(new File(modelTarFile));\n+    }\n+\n+    /**\n+     * Retrieve public key from Key Store.\n+     * @param keyName : name of the public key\n+     * @return publickey\n+     */\n+    private static PublicKey getPublicKey(String keyName) throws KeyStoreException {\n+        PublicKey publicKey = null;\n+        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+        Certificate cert = keyStore.getCertificate(keyName);\n+        publicKey = cert.getPublicKey();\n+        return publicKey;\n+    }\n+\n+    private static String readTarContents(String archiveFile) throws FileNotFoundException, IOException {\n+        StringBuffer sb = new StringBuffer();\n+        TarArchiveInputStream archive = new TarArchiveInputStream(\n+                new GzipCompressorInputStream(new BufferedInputStream(new FileInputStream(archiveFile))));\n+        TarArchiveEntry entry;\n+        while ((entry = archive.getNextTarEntry()) != null) {\n+            sb.append(entry.getName());", "originalCommit": "e6e6d3d8cc3a2c0a6a5c9382b3aa6046773bd735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4OTA3OA==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r434889078", "bodyText": "We'll want a way to programmatically do this as well as run this from the command line.", "author": "aklish", "createdAt": "2020-06-03T22:18:27Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.HelpFormatter;\n+import org.apache.commons.cli.MissingOptionException;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.apache.commons.cli.ParseException;\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+import org.apache.commons.io.FileUtils;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Method to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws ParseException\n+     * @throws IOException\n+     * @throws KeyStoreException\n+     * @throws FileNotFoundException\n+     * @throws SignatureException\n+     * @throws NoSuchAlgorithmException\n+     * @throws InvalidKeyException\n+     *\n+     */\n+    public static void main(String[] args) throws ParseException, InvalidKeyException, NoSuchAlgorithmException,", "originalCommit": "e6e6d3d8cc3a2c0a6a5c9382b3aa6046773bd735", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3MDYxNg==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r437070616", "bodyText": "public static boolean verify(String fileContent, String signature, PublicKey publicKey) throws NoSuchAlgorithmException, InvalidKeyException, SignatureException {\nverify function can be called programmatically to verify the tar signature", "author": "AvaniMakwana", "createdAt": "2020-06-09T00:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4OTA3OA=="}], "type": "inlineReview"}, {"oid": "64685aedf257eb8bd7f77cc80d2784a97f3a2b16", "url": "https://github.com/yahoo/elide/commit/64685aedf257eb8bd7f77cc80d2784a97f3a2b16", "message": "review comment", "committedDate": "2020-06-09T11:14:13Z", "type": "commit"}, {"oid": "64685aedf257eb8bd7f77cc80d2784a97f3a2b16", "url": "https://github.com/yahoo/elide/commit/64685aedf257eb8bd7f77cc80d2784a97f3a2b16", "message": "review comment", "committedDate": "2020-06-09T11:14:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2MDA5MA==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r437560090", "bodyText": "You should set the exit status on failure to something that will cause this to abort shell scripts.", "author": "aklish", "createdAt": "2020-06-09T16:24:01Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifier.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.DefaultParser;\n+import org.apache.commons.cli.HelpFormatter;\n+import org.apache.commons.cli.MissingOptionException;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+import org.apache.commons.cli.ParseException;\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.compress.compressors.gzip.GzipCompressorInputStream;\n+import org.apache.commons.io.FileUtils;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PublicKey;\n+import java.security.Signature;\n+import java.security.SignatureException;\n+import java.security.cert.Certificate;\n+import java.util.Base64;\n+\n+/**\n+ * Util class to Verify model tar.gz file's RSA signature with available public key in key store.\n+ */\n+@Slf4j\n+public class DynamicConfigVerifier {\n+\n+    /**\n+     * Main Method to Verify Signature of Model Tar file.\n+     * @param args : expects 3 arguments.\n+     * @throws ParseException\n+     * @throws IOException\n+     * @throws KeyStoreException\n+     * @throws FileNotFoundException\n+     * @throws SignatureException\n+     * @throws NoSuchAlgorithmException\n+     * @throws InvalidKeyException\n+     * @throws MissingOptionException\n+     */\n+    public static void main(String[] args) throws ParseException, InvalidKeyException, NoSuchAlgorithmException,\n+            SignatureException, FileNotFoundException, KeyStoreException, IOException {\n+\n+        Options options = prepareOptions();\n+        CommandLine cli = new DefaultParser().parse(options, args);\n+\n+        if (cli.hasOption(\"help\")) {\n+            printHelp(options);\n+            return;\n+        }\n+        if (!cli.hasOption(\"tarFile\") || !cli.hasOption(\"signatureFile\") || !cli.hasOption(\"publicKeyName\")) {\n+            printHelp(options);\n+            throw new MissingOptionException(\"Missing required option\");\n+        }\n+\n+        String modelTarFile = cli.getOptionValue(\"tarFile\");\n+        String signatureFile = cli.getOptionValue(\"signatureFile\");\n+        String publicKeyName = cli.getOptionValue(\"publicKeyName\");\n+\n+        if (verify(readTarContents(modelTarFile), signatureFile, getPublicKey(publicKeyName))) {\n+            log.info(\"Successfully Validated \" + modelTarFile);\n+        }\n+        else {\n+            log.error(\"Could not verify \" + modelTarFile + \" with details provided\");", "originalCommit": "64685aedf257eb8bd7f77cc80d2784a97f3a2b16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2MTQ5MA==", "url": "https://github.com/yahoo/elide/pull/1354#discussion_r437561490", "bodyText": "We need to add a test that creates a gzipped tarball, signs it, and then verifies your functions can do the reverse and verify the signature.", "author": "aklish", "createdAt": "2020-06-09T16:26:03Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/test/java/com/yahoo/elide/contrib/dynamicconfighelpers/verify/DynamicConfigVerifiesTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.verify;\n+\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import org.apache.commons.cli.MissingArgumentException;\n+import org.apache.commons.cli.MissingOptionException;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.security.KeyPair;\n+import java.security.KeyPairGenerator;\n+import java.security.PrivateKey;\n+import java.security.SecureRandom;\n+import java.security.Signature;\n+import java.util.Base64;\n+\n+public class DynamicConfigVerifiesTest {", "originalCommit": "64685aedf257eb8bd7f77cc80d2784a97f3a2b16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e4230d50d8d49ad62f2bc177ee9e0b2d6acaaf4", "url": "https://github.com/yahoo/elide/commit/9e4230d50d8d49ad62f2bc177ee9e0b2d6acaaf4", "message": "additional testcases", "committedDate": "2020-06-09T23:59:28Z", "type": "commit"}, {"oid": "9e4230d50d8d49ad62f2bc177ee9e0b2d6acaaf4", "url": "https://github.com/yahoo/elide/commit/9e4230d50d8d49ad62f2bc177ee9e0b2d6acaaf4", "message": "additional testcases", "committedDate": "2020-06-09T23:59:28Z", "type": "forcePushed"}, {"oid": "34dd314dabe1d8517d97daafdd24c1f03fb67aa0", "url": "https://github.com/yahoo/elide/commit/34dd314dabe1d8517d97daafdd24c1f03fb67aa0", "message": "revert system exit", "committedDate": "2020-06-10T00:28:42Z", "type": "commit"}, {"oid": "7b0f4b25a449872ed76835b6b8e085a3e6dedc64", "url": "https://github.com/yahoo/elide/commit/7b0f4b25a449872ed76835b6b8e085a3e6dedc64", "message": "fix codacy", "committedDate": "2020-06-10T00:39:49Z", "type": "commit"}, {"oid": "022a2a13e9de94d8064adabcd35d54c63f1c1f7c", "url": "https://github.com/yahoo/elide/commit/022a2a13e9de94d8064adabcd35d54c63f1c1f7c", "message": "add return", "committedDate": "2020-06-10T00:44:51Z", "type": "commit"}, {"oid": "5de1a66371bc1f4f26f44da0183e95682afb6acc", "url": "https://github.com/yahoo/elide/commit/5de1a66371bc1f4f26f44da0183e95682afb6acc", "message": "add system exit", "committedDate": "2020-06-10T14:23:11Z", "type": "commit"}]}