{"pr_number": 5653, "pr_title": "Enhance min/max value support in realtime segment creation", "pr_createdAt": "2020-07-02T10:54:11Z", "pr_url": "https://github.com/apache/pinot/pull/5653", "timeline": [{"oid": "e07118fa89b1db77de50e1eba374b907a9740a46", "url": "https://github.com/apache/pinot/commit/e07118fa89b1db77de50e1eba374b907a9740a46", "message": "Adding min/max value support in realtime segment", "committedDate": "2020-07-02T11:03:55Z", "type": "forcePushed"}, {"oid": "1bc9f21aa90f5f26347a9412a33cfa09eaa677ad", "url": "https://github.com/apache/pinot/commit/1bc9f21aa90f5f26347a9412a33cfa09eaa677ad", "message": "Adding min/max value support in realtime segment", "committedDate": "2020-07-02T11:48:15Z", "type": "forcePushed"}, {"oid": "7f995dfca2f58c2b407895274ee62d94161ae75e", "url": "https://github.com/apache/pinot/commit/7f995dfca2f58c2b407895274ee62d94161ae75e", "message": "Adding min/max value support in realtime segment", "committedDate": "2020-07-02T12:24:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyODAwOQ==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449028009", "bodyText": "Seems this is used only in HLRealtimeSegmentDataManager?", "author": "mayankshriv", "createdAt": "2020-07-02T14:07:05Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -367,11 +366,33 @@ public SegmentPartitionConfig getSegmentPartitionConfig() {\n   }\n \n   public long getMinTime() {\n-    return _minTime;\n+    Long minTime = extractTimeValue(_minValueMap.get(_timeColumnName));\n+    if (minTime != null) {\n+      return minTime;\n+    }\n+    return Long.MAX_VALUE;\n   }\n \n   public long getMaxTime() {", "originalCommit": "7f995dfca2f58c2b407895274ee62d94161ae75e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NDM4OQ==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449174389", "bodyText": "Yes.", "author": "xiangfu0", "createdAt": "2020-07-02T17:41:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyODAwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyOTc5Mw==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449029793", "bodyText": "Can this be done inline during index() (inside addForwardIndex)? Doing it separately may have several redundant operations, that may impact use cases with high ingestion rate.", "author": "mayankshriv", "createdAt": "2020-07-02T14:09:47Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -425,6 +449,37 @@ public boolean index(GenericRow row, @Nullable RowMetadata rowMetadata) {\n     return canTakeMore;\n   }\n \n+  private void updateMinMaxValue(GenericRow row) {", "originalCommit": "7f995dfca2f58c2b407895274ee62d94161ae75e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NDY3MQ==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449174671", "bodyText": "will do", "author": "xiangfu0", "createdAt": "2020-07-02T17:41:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyOTc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzMTMwOA==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449031308", "bodyText": "Will this be run as a separate integration test (as in setup/teardown the cluster)? If so, perhaps it can be merged into RealtimeClusterIntegrationTest by choosing some of the columns as noDictionary?", "author": "mayankshriv", "createdAt": "2020-07-02T14:11:56Z", "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/RealtimeNoDictionaryTimeColumnClusterIntegrationTest.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.integration.tests;\n+\n+import java.io.File;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.pinot.util.TestUtils;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+\n+/**\n+ * Extends RealtimeClusterIntegrationTest and configure time column to be a non-dictionary column.\n+ */\n+public class RealtimeNoDictionaryTimeColumnClusterIntegrationTest extends RealtimeClusterIntegrationTest {", "originalCommit": "7f995dfca2f58c2b407895274ee62d94161ae75e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NTk3Ng==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449175976", "bodyText": "Yes, wanna check if time column could be set as dictionary or no-dictionary. It's a bit hard to merge it as only one time column is used during segment creation for metadata/segment name etc.", "author": "xiangfu0", "createdAt": "2020-07-02T17:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzMTMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwNTQwMQ==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449205401", "bodyText": "One way to merge these 2 tests is by using a random boolean to decide the NoDictionaryColumns", "author": "Jackie-Jiang", "createdAt": "2020-07-02T18:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzMTMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIzNjU0MA==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449236540", "bodyText": "Then we may not catch a potential issue in the corresponding PR?", "author": "xiangfu0", "createdAt": "2020-07-02T19:55:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzMTMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI0NjEwNw==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449246107", "bodyText": "is the main reason to merge the tests more about the time it takes to run the build?", "author": "kishoreg", "createdAt": "2020-07-02T20:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzMTMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI4NjA3Nw==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449286077", "bodyText": "Yes. Adding each new integration test will make the testing time roughly 3 minutes longer.", "author": "Jackie-Jiang", "createdAt": "2020-07-02T22:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzMTMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMxOTA2Nw==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449319067", "bodyText": "got it, added a random condition here.", "author": "xiangfu0", "createdAt": "2020-07-03T00:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzMTMwOA=="}], "type": "inlineReview"}, {"oid": "804feb60fa86e0b8cb04232ee8a34bc192e61df8", "url": "https://github.com/apache/pinot/commit/804feb60fa86e0b8cb04232ee8a34bc192e61df8", "message": "Adding min/max value support in realtime segment", "committedDate": "2020-07-02T18:04:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDA1Nw==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449200057", "bodyText": "This has potential thread safety issue (expanding hashMap while reading). You can prevent that by putting null in the constructor.", "author": "Jackie-Jiang", "createdAt": "2020-07-02T18:33:01Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -116,15 +116,14 @@\n   private final Map<String, InvertedIndexReader> _invertedIndexMap = new HashMap<>();\n   private final Map<String, InvertedIndexReader> _rangeIndexMap = new HashMap<>();\n   private final Map<String, BloomFilterReader> _bloomFilterMap = new HashMap<>();\n+  private final Map<String, Comparable> _minValueMap = new HashMap<>();", "originalCommit": "804feb60fa86e0b8cb04232ee8a34bc192e61df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDMzMg==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449200332", "bodyText": "(nit) revert?", "author": "Jackie-Jiang", "createdAt": "2020-07-02T18:33:42Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java", "diffHunk": "@@ -491,7 +491,6 @@ public static void addColumnMetadataInfo(PropertiesConfiguration properties, Str\n         String.valueOf(columnIndexCreationInfo.getTotalNumberOfEntries()));\n     properties.setProperty(V1Constants.MetadataKeys.Column.getKeyFor(column, IS_AUTO_GENERATED),\n         String.valueOf(columnIndexCreationInfo.isAutoGenerated()));\n-", "originalCommit": "804feb60fa86e0b8cb04232ee8a34bc192e61df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDU1NA==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449200554", "bodyText": "Annotate them as nullable", "author": "Jackie-Jiang", "createdAt": "2020-07-02T18:34:14Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/datasource/MutableDataSource.java", "diffHunk": "@@ -39,11 +39,12 @@\n   private static final String OPERATOR_NAME_PREFIX = \"MutableDataSource:\";\n \n   public MutableDataSource(FieldSpec fieldSpec, int numDocs, int numValues, int maxNumValuesPerMVEntry,\n-      @Nullable PartitionFunction partitionFunction, int partitionId, DataFileReader forwardIndex,\n-      @Nullable Dictionary dictionary, @Nullable InvertedIndexReader invertedIndex, @Nullable InvertedIndexReader rangeIndex,\n-      @Nullable BloomFilterReader bloomFilter, @Nullable NullValueVectorReader nullValueVector) {\n+      @Nullable PartitionFunction partitionFunction, int partitionId, Comparable minValue, Comparable maxValue,", "originalCommit": "804feb60fa86e0b8cb04232ee8a34bc192e61df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDU4NA==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449200584", "bodyText": "Annotate them as nullable", "author": "Jackie-Jiang", "createdAt": "2020-07-02T18:34:17Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/datasource/MutableDataSource.java", "diffHunk": "@@ -54,9 +55,11 @@ public MutableDataSource(FieldSpec fieldSpec, int numDocs, int numValues, int ma\n     final int _maxNumValuesPerMVEntry;\n     final PartitionFunction _partitionFunction;\n     final Set<Integer> _partitions;\n+    final Comparable _minValue;\n+    final Comparable _maxValue;\n \n     MutableDataSourceMetadata(FieldSpec fieldSpec, int numDocs, int numValues, int maxNumValuesPerMVEntry,\n-        @Nullable PartitionFunction partitionFunction, int partitionId) {\n+        @Nullable PartitionFunction partitionFunction, int partitionId, Comparable minValue, Comparable maxValue) {", "originalCommit": "804feb60fa86e0b8cb04232ee8a34bc192e61df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDc2Mg==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449200762", "bodyText": "Revert", "author": "Jackie-Jiang", "createdAt": "2020-07-02T18:34:37Z", "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/RealtimeClusterIntegrationTest.java", "diffHunk": "@@ -19,8 +19,10 @@\n package org.apache.pinot.integration.tests;\n \n import java.io.File;\n+import java.util.Arrays;", "originalCommit": "804feb60fa86e0b8cb04232ee8a34bc192e61df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwNDM0OA==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449204348", "bodyText": "Cache _minValueMap.get(column) here to save 2 extra map lookups", "author": "Jackie-Jiang", "createdAt": "2020-07-02T18:42:20Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -514,6 +518,32 @@ private void addForwardIndex(GenericRow row, int docId, Map<String, Object> dict\n \n         numValuesInfo.updateMVEntry(dictIds.length);\n       }\n+\n+      // Update min/max value for columns\n+      BaseMutableDictionary dictionary = _dictionaryMap.get(column);\n+      if (dictionary != null) {\n+        _minValueMap.put(column, dictionary.getMinVal());\n+        _maxValueMap.put(column, dictionary.getMaxVal());\n+        continue;\n+      }\n+      if (value == null) {\n+        continue;\n+      }\n+      if (!(value instanceof Comparable)) {\n+        continue;\n+      }\n+      Comparable comparableValue = (Comparable) value;\n+      if (!_minValueMap.containsKey(column)) {", "originalCommit": "804feb60fa86e0b8cb04232ee8a34bc192e61df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwNDkyOQ==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449204929", "bodyText": "This check is redundant (1. value cannot be null; 2. already handled in the instanceof check)", "author": "Jackie-Jiang", "createdAt": "2020-07-02T18:43:31Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -514,6 +518,32 @@ private void addForwardIndex(GenericRow row, int docId, Map<String, Object> dict\n \n         numValuesInfo.updateMVEntry(dictIds.length);\n       }\n+\n+      // Update min/max value for columns\n+      BaseMutableDictionary dictionary = _dictionaryMap.get(column);\n+      if (dictionary != null) {\n+        _minValueMap.put(column, dictionary.getMinVal());\n+        _maxValueMap.put(column, dictionary.getMaxVal());\n+        continue;\n+      }\n+      if (value == null) {", "originalCommit": "804feb60fa86e0b8cb04232ee8a34bc192e61df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6069186482161d317a884b28aef4fd8327e48990", "url": "https://github.com/apache/pinot/commit/6069186482161d317a884b28aef4fd8327e48990", "message": "Adding min/max value support in realtime segment", "committedDate": "2020-07-02T19:50:16Z", "type": "forcePushed"}, {"oid": "375d1516f368c0c5aa3ae2b671e986524dc21deb", "url": "https://github.com/apache/pinot/commit/375d1516f368c0c5aa3ae2b671e986524dc21deb", "message": "Adding min/max value support in realtime segment", "committedDate": "2020-07-02T19:53:46Z", "type": "forcePushed"}, {"oid": "3a421a95312309772718c621ca1d761022c373fa", "url": "https://github.com/apache/pinot/commit/3a421a95312309772718c621ca1d761022c373fa", "message": "Adding min/max value support in realtime segment", "committedDate": "2020-07-03T00:16:21Z", "type": "commit"}, {"oid": "3a421a95312309772718c621ca1d761022c373fa", "url": "https://github.com/apache/pinot/commit/3a421a95312309772718c621ca1d761022c373fa", "message": "Adding min/max value support in realtime segment", "committedDate": "2020-07-03T00:16:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4OTQ4Mg==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449689482", "bodyText": "why are we assuming time is always long?", "author": "kishoreg", "createdAt": "2020-07-03T19:34:41Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -367,11 +370,33 @@ public SegmentPartitionConfig getSegmentPartitionConfig() {\n   }\n \n   public long getMinTime() {\n-    return _minTime;\n+    Long minTime = extractTimeValue(_minValueMap.get(_timeColumnName));\n+    if (minTime != null) {\n+      return minTime;\n+    }\n+    return Long.MAX_VALUE;\n   }\n \n   public long getMaxTime() {\n-    return _maxTime;\n+    Long maxTime = extractTimeValue(_maxValueMap.get(_timeColumnName));\n+    if (maxTime != null) {\n+      return maxTime;\n+    }\n+    return Long.MIN_VALUE;\n+  }\n+\n+  private Long extractTimeValue(Comparable time) {\n+    if (time != null) {\n+      if (time instanceof Number) {\n+        return ((Number) time).longValue();\n+      } else {\n+        String stringValue = time.toString();", "originalCommit": "3a421a95312309772718c621ca1d761022c373fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcwNDY0NA==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449704644", "bodyText": "This logic is only used for Kafka HLC. It assumes time field  is always some epoch value. Maybe we should mark this as Deprecated or at least put some comments.", "author": "xiangfu0", "createdAt": "2020-07-03T21:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4OTQ4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcxMDgyOQ==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449710829", "bodyText": "In case of offheap string dictionary it will create a new string everytime from the serialized values. Why nnot just get the minvalue when needed from the dictionary?", "author": "mcvsubbu", "createdAt": "2020-07-03T22:01:24Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -514,6 +522,30 @@ private void addForwardIndex(GenericRow row, int docId, Map<String, Object> dict\n \n         numValuesInfo.updateMVEntry(dictIds.length);\n       }\n+\n+      // Update min/max value for columns\n+      BaseMutableDictionary dictionary = _dictionaryMap.get(column);\n+      if (dictionary != null) {\n+        _minValueMap.put(column, dictionary.getMinVal());", "originalCommit": "3a421a95312309772718c621ca1d761022c373fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTczMjI0NA==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449732244", "bodyText": "Make sense, I will change to just store no-dictionary min/max values.", "author": "xiangfu0", "createdAt": "2020-07-04T02:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcxMDgyOQ=="}], "type": "inlineReview"}, {"oid": "1393d5b80f1212b2e87e825e18e1fcc68b8dd2a0", "url": "https://github.com/apache/pinot/commit/1393d5b80f1212b2e87e825e18e1fcc68b8dd2a0", "message": "Only cache min/max values for non-dictionary columns in MutableSegmentImpl", "committedDate": "2020-07-04T12:25:02Z", "type": "commit"}, {"oid": "1393d5b80f1212b2e87e825e18e1fcc68b8dd2a0", "url": "https://github.com/apache/pinot/commit/1393d5b80f1212b2e87e825e18e1fcc68b8dd2a0", "message": "Only cache min/max values for non-dictionary columns in MutableSegmentImpl", "committedDate": "2020-07-04T12:25:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxMTg4NQ==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449911885", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    _minValueMap.put(fieldSpec.getName(), null);\n          \n          \n            \n                    _maxValueMap.put(fieldSpec.getName(), null);\n          \n          \n            \n                    _minValueMap.put(column, null);\n          \n          \n            \n                    _maxValueMap.put(column, null);", "author": "Jackie-Jiang", "createdAt": "2020-07-05T19:44:57Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -227,6 +226,9 @@ public long getLatestIngestionTimestamp() {\n         if (isFixedWidthColumn) {\n           forwardIndexColumnSize = dataType.size();\n         }\n+        // Init min/max value map to avoid potential thread safety issue (expanding hashMap while reading).\n+        _minValueMap.put(fieldSpec.getName(), null);\n+        _maxValueMap.put(fieldSpec.getName(), null);", "originalCommit": "1393d5b80f1212b2e87e825e18e1fcc68b8dd2a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxMjAzNA==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449912034", "bodyText": "Is numeric is not good enough, recommend put try-catch over Long.parseLong(stringValue)", "author": "Jackie-Jiang", "createdAt": "2020-07-05T19:46:36Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -366,12 +368,68 @@ public SegmentPartitionConfig getSegmentPartitionConfig() {\n     }\n   }\n \n+  /**\n+   * Get min time from the segment, based on the time column, only used by Kafka HLC.\n+   */\n+  @Deprecated\n   public long getMinTime() {\n-    return _minTime;\n+    Long minTime = extractTimeValue(getMinVal(_timeColumnName));\n+    if (minTime != null) {\n+      return minTime;\n+    }\n+    return Long.MAX_VALUE;\n   }\n \n+  /**\n+   * Get max time from the segment, based on the time column, only used by Kafka HLC.\n+   */\n+  @Deprecated\n   public long getMaxTime() {\n-    return _maxTime;\n+    Long maxTime = extractTimeValue(getMaxVal(_timeColumnName));\n+    if (maxTime != null) {\n+      return maxTime;\n+    }\n+    return Long.MIN_VALUE;\n+  }\n+\n+  private Long extractTimeValue(Comparable time) {\n+    if (time != null) {\n+      if (time instanceof Number) {\n+        return ((Number) time).longValue();\n+      } else {\n+        String stringValue = time.toString();\n+        if (StringUtils.isNumeric(stringValue)) {", "originalCommit": "1393d5b80f1212b2e87e825e18e1fcc68b8dd2a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4MTc1OQ==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449981759", "bodyText": "I keep the same logic as before, this is for legacy HLC usage which assumes time is epoch value.", "author": "xiangfu0", "createdAt": "2020-07-06T04:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxMjAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk5NzUyNw==", "url": "https://github.com/apache/pinot/pull/5653#discussion_r449997527", "bodyText": "nvm, I thought this is NumberUtils.isNumber(). This should be good", "author": "Jackie-Jiang", "createdAt": "2020-07-06T05:55:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxMjAzNA=="}], "type": "inlineReview"}, {"oid": "f925484e64e2d297e508e350655efa30958f198d", "url": "https://github.com/apache/pinot/commit/f925484e64e2d297e508e350655efa30958f198d", "message": "Update pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java\n\nCo-authored-by: Xiaotian (Jackie) Jiang <17555551+Jackie-Jiang@users.noreply.github.com>", "committedDate": "2020-07-06T04:48:47Z", "type": "commit"}]}