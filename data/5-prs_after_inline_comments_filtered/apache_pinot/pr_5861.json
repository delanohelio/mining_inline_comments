{"pr_number": 5861, "pr_title": "[TE] merge time series snapshot when merging anomalies", "pr_createdAt": "2020-08-14T01:15:39Z", "pr_url": "https://github.com/apache/pinot/pull/5861", "timeline": [{"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb", "url": "https://github.com/apache/pinot/commit/ad2ea576a5619b708b4f6a0164ffe55af27626bb", "message": "[TE] merge time series snapshot when merging anomalies", "committedDate": "2020-08-14T01:09:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4ODY0Ng==", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470788646", "bodyText": "Probably better to compare with absolute difference: abs(actual - expected) < 0.00001. Or better:\nwe can use Assert.assertEquals(actual, expected, delta)", "author": "Ruoyingw", "createdAt": "2020-08-14T18:23:57Z", "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "diffHunk": "@@ -176,21 +179,51 @@ public void testExceptionToStringLimited() {\n   }\n \n   @Test\n-  public void testMergeAnomalyProperties() {\n+  public void testMergeAnomalyProperties() throws Exception {\n+    final long now = System.currentTimeMillis();\n+    final long bucketSize = 300_000;\n+    final double parentVal = 1.0, childVal = 2.0;\n+\n     Map<String, String> parentProperties = new HashMap<>();\n     parentProperties.put(\"p1\", \"value1\");\n     parentProperties.put(\"p2\", \"value2\");\n     parentProperties.put(\"detectorComponentName\", \"rule1\");\n+    parentProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now, bucketSize, 10, parentVal).toJsonString());\n+\n \n     Map<String, String> childProperties = new HashMap<>();\n     childProperties.put(\"p1\", \"value3\");\n     childProperties.put(\"c1\", \"value4\");\n     childProperties.put(\"detectorComponentName\", \"rule2\");\n+    childProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now + bucketSize, bucketSize, 10,  childVal).toJsonString());\n \n     ThirdEyeUtils.mergeAnomalyProperties(parentProperties, childProperties);\n     Assert.assertEquals(parentProperties.get(\"p1\"), \"value1\");\n     Assert.assertEquals(parentProperties.get(\"p2\"), \"value2\");\n     Assert.assertEquals(parentProperties.get(\"c1\"), \"value4\");\n     Assert.assertEquals(parentProperties.get(\"detectorComponentName\"), \"rule1,rule2\");\n+    AnomalyTimelinesView merged = AnomalyTimelinesView.fromJsonString(parentProperties.get(\"anomalyTimelinesView\"));\n+    Assert.assertEquals(merged.getTimeBuckets().size(), 11);\n+    Assert.assertTrue(merged.getCurrentValues().get(0) - parentVal < 0.00001);\n+    Assert.assertTrue(merged.getCurrentValues().get(1) - parentVal < 0.00001);\n+    Assert.assertTrue(merged.getCurrentValues().get(10) - childVal < 0.00001);", "originalCommit": "ad2ea576a5619b708b4f6a0164ffe55af27626bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg4OTA1NA==", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470889054", "bodyText": "Good point.", "author": "vincentchenjl", "createdAt": "2020-08-14T22:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4ODY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MzExMA==", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470793110", "bodyText": "Can we add another unit test case where the child anomaly has a gap with parent? say\nchildProperties.put(\"anomalyTimelinesView\", generateAnomalyTimelineView(now + bucketSize * 20, bucketSize, 10,  childVal).toJsonString());", "author": "Ruoyingw", "createdAt": "2020-08-14T18:29:13Z", "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "diffHunk": "@@ -176,21 +179,51 @@ public void testExceptionToStringLimited() {\n   }\n \n   @Test\n-  public void testMergeAnomalyProperties() {\n+  public void testMergeAnomalyProperties() throws Exception {\n+    final long now = System.currentTimeMillis();\n+    final long bucketSize = 300_000;\n+    final double parentVal = 1.0, childVal = 2.0;\n+\n     Map<String, String> parentProperties = new HashMap<>();\n     parentProperties.put(\"p1\", \"value1\");\n     parentProperties.put(\"p2\", \"value2\");\n     parentProperties.put(\"detectorComponentName\", \"rule1\");\n+    parentProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now, bucketSize, 10, parentVal).toJsonString());\n+\n \n     Map<String, String> childProperties = new HashMap<>();\n     childProperties.put(\"p1\", \"value3\");\n     childProperties.put(\"c1\", \"value4\");\n     childProperties.put(\"detectorComponentName\", \"rule2\");\n+    childProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now + bucketSize, bucketSize, 10,  childVal).toJsonString());", "originalCommit": "ad2ea576a5619b708b4f6a0164ffe55af27626bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg4OTAxNQ==", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470889015", "bodyText": "Added it as a new test.", "author": "vincentchenjl", "createdAt": "2020-08-14T22:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MzExMA=="}], "type": "inlineReview"}, {"oid": "0348d62d5ad8b64073b874c0cb8041b23a6d51ab", "url": "https://github.com/apache/pinot/commit/0348d62d5ad8b64073b874c0cb8041b23a6d51ab", "message": "add one more test", "committedDate": "2020-08-14T22:20:48Z", "type": "commit"}]}