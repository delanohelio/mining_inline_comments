{"pr_number": 5875, "pr_title": "Config recommender patch", "pr_createdAt": "2020-08-17T05:35:24Z", "pr_url": "https://github.com/apache/pinot/pull/5875", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NTI3Mg==", "url": "https://github.com/apache/pinot/pull/5875#discussion_r473275272", "bodyText": "Maybe we should remove this comments?", "author": "jackjlli", "createdAt": "2020-08-19T19:41:27Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/recommender/rules/impl/InvertedSortedIndexJointRule.java", "diffHunk": "@@ -197,28 +194,48 @@ public PredicateParseResult findOptimalCombination(List<List<PredicateParseResul\n    * {@link PredicateParseResult#getnESI()} the nESI before applying any index\n    * {@link PredicateParseResult#getnESIWithIdx()} the estimated nESI after applying optimal indices\n    */\n-  public PredicateParseResult evaluateCombination(int n, int r, List<List<PredicateParseResult>> parsedQuery) {\n-    List<int[]> combinationIntArrays = generateCombinations(n, r);\n-    LOGGER.debug(\"combinationIntArrays {}\", combinationIntArrays);\n+  public PredicateParseResult evaluateCombination(final int n, final int r, List<List<PredicateParseResult>> parsedQuery) {\n+    FixedLenBitset usedCols = new FixedLenBitset(n);\n+    parsedQuery.forEach(list -> list.stream()\n+        .filter(predicateParseResult -> (predicateParseResult.getCandidateDims().getCardinality() <= r))\n+        .forEach(predicateParseResult -> usedCols.union(predicateParseResult.getCandidateDims())));\n+    LOGGER.debug(\"totalUsed {}\", usedCols.getCardinality());\n+\n+    List<Integer> usedColIDs = usedCols.getOffsets();\n+    int nCapped = usedColIDs.size();\n+    int rCapped = Math.min(r, nCapped);\n+\n+    int[] idToColID = new int[nCapped];\n+    for (int i = 0; i < nCapped; i++) {\n+      idToColID[i] = usedColIDs.get(i);\n+    }\n+\n \n     // Enumerate all possible combinations of r-sized set, which will be applied indices on\n-    List<FixedLenBitset> combinations = combinationIntArrays.parallelStream().map(combinationIntArray -> {\n-      FixedLenBitset indices = new FixedLenBitset(n);\n-      for (int j = 0; j < r; j++) {\n-        indices.add(combinationIntArray[j]);\n-      }\n-      return indices;\n-    }).collect(Collectors.toList());\n+    List<int[]> combinationIntArrays = generateCombinations(nCapped, rCapped);\n+\n+//     Enumerate all possible combinations of r-sized set, which will be applied indices on\n+//    List<FixedLenBitset> combinations = combinationIntArrays.parallelStream().map(combinationIntArray -> {", "originalCommit": "dc4e5fc19059f1f50ed6eca312dfe7599b6255ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxODk1Ng==", "url": "https://github.com/apache/pinot/pull/5875#discussion_r473318956", "bodyText": "Done", "author": "jasperjiaguo", "createdAt": "2020-08-19T21:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NTI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NjU1OA==", "url": "https://github.com/apache/pinot/pull/5875#discussion_r473276558", "bodyText": "Can we add the link of this class to the doc so that we know this is the default values?", "author": "jackjlli", "createdAt": "2020-08-19T19:44:06Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/recommender/rules/io/params/RecommenderConstants.java", "diffHunk": "@@ -32,7 +32,7 @@\n     public static final double DEFAULT_THRESHOLD_MIN_AND_PREDICATE_INCREMENTAL_VOTE = 0.6d;\n     public static final double DEFAULT_THRESHOLD_RATIO_MIN_AND_PREDICATE_TOP_CANDIDATES = 0.8d;\n     public static final double DEFAULT_THRESHOLD_RATIO_MIN_GAIN_DIFF_BETWEEN_ITERATION = 0.05d;\n-    public static final int DEFAULT_MAX_NUM_ITERATION_WITHOUT_GAIN = 3;\n+    public static final int DEFAULT_MAX_NUM_ITERATION_WITHOUT_GAIN = 2;", "originalCommit": "dc4e5fc19059f1f50ed6eca312dfe7599b6255ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxODkwNA==", "url": "https://github.com/apache/pinot/pull/5875#discussion_r473318904", "bodyText": "Sure", "author": "jasperjiaguo", "createdAt": "2020-08-19T21:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NjU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NjkyMA==", "url": "https://github.com/apache/pinot/pull/5875#discussion_r473276920", "bodyText": "should put a space between ) and {", "author": "jackjlli", "createdAt": "2020-08-19T19:44:49Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/recommender/rules/utils/QueryInvertedSortedIndexRecommender.java", "diffHunk": "@@ -585,7 +573,9 @@ else if (type == Predicate.Type.IN || type == Predicate.Type.NOT_IN) {\n \n       boolean isFirst = false;\n       List<String> values = (type == Predicate.Type.IN)?((InPredicate) predicate).getValues():((NotInPredicate) predicate).getValues();\n-      if (values.get(RecommenderConstants.FIRST).equals(RecommenderConstants.IN_PREDICATE_ESTIMATE_LEN_FLAG) ||\n+      if(values.size()==1){", "originalCommit": "dc4e5fc19059f1f50ed6eca312dfe7599b6255ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxODk5Mg==", "url": "https://github.com/apache/pinot/pull/5875#discussion_r473318992", "bodyText": "Reformatted", "author": "jasperjiaguo", "createdAt": "2020-08-19T21:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NjkyMA=="}], "type": "inlineReview"}, {"oid": "61874c0364a69b87cffadebc485e515ad031c808", "url": "https://github.com/apache/pinot/commit/61874c0364a69b87cffadebc485e515ad031c808", "message": "Refactored code for overwritten configs\n\nfixed typos\n\nfixed naming mismatch\n\nFixed a issue where the engine may crash if empty query patterns are provided. Added test case for that.\n\nAddressed comments in PR\n\nrefactored code\n\nsonly recommend inverted indices if sorted index presents in the overwritten config\n\nreduced time complexity for combination generation\n\nreduced time complexity for combination generation\n\n1. fixed a bug that the engine will crash when parsing X NOT IN ('x')\n2. now the code will not complain even if no time spec appears in the schema\n\nfix typo in names\n\nreduced time complexity for combination generation\n\nreduced time complexity for combination generation\n\nreduced time complexity for combination generation", "committedDate": "2020-08-21T00:16:52Z", "type": "commit"}, {"oid": "61874c0364a69b87cffadebc485e515ad031c808", "url": "https://github.com/apache/pinot/commit/61874c0364a69b87cffadebc485e515ad031c808", "message": "Refactored code for overwritten configs\n\nfixed typos\n\nfixed naming mismatch\n\nFixed a issue where the engine may crash if empty query patterns are provided. Added test case for that.\n\nAddressed comments in PR\n\nrefactored code\n\nsonly recommend inverted indices if sorted index presents in the overwritten config\n\nreduced time complexity for combination generation\n\nreduced time complexity for combination generation\n\n1. fixed a bug that the engine will crash when parsing X NOT IN ('x')\n2. now the code will not complain even if no time spec appears in the schema\n\nfix typo in names\n\nreduced time complexity for combination generation\n\nreduced time complexity for combination generation\n\nreduced time complexity for combination generation", "committedDate": "2020-08-21T00:16:52Z", "type": "forcePushed"}]}