{"pr_number": 5897, "pr_title": "Fixing segment push uri ingestion jobs", "pr_createdAt": "2020-08-18T22:29:42Z", "pr_url": "https://github.com/apache/pinot/pull/5897", "timeline": [{"oid": "4874e7a478c1b809a4ccbc07a51940df9d1eb613", "url": "https://github.com/apache/pinot/commit/4874e7a478c1b809a4ccbc07a51940df9d1eb613", "message": "Fixing segment push uri ingestion jobs", "committedDate": "2020-08-18T23:35:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1Mzc5Mw==", "url": "https://github.com/apache/pinot/pull/5897#discussion_r472553793", "bodyText": "Rename it to SegmentPushUtilsTest", "author": "Jackie-Jiang", "createdAt": "2020-08-18T23:45:08Z", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/test/java/org/apache/pinot/plugin/ingestion/batch/common/TestSegmentPushUtils.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.pinot.plugin.ingestion.batch.common;\n+\n+import java.net.URI;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+\n+public class TestSegmentPushUtils {", "originalCommit": "4874e7a478c1b809a4ccbc07a51940df9d1eb613", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NDE5MA==", "url": "https://github.com/apache/pinot/pull/5897#discussion_r472554190", "bodyText": "Why do we change this in the test? This should be handled within the PinotFS", "author": "Jackie-Jiang", "createdAt": "2020-08-18T23:46:32Z", "path": "pinot-plugins/pinot-file-system/pinot-s3/src/test/java/org/apache/pinot/plugin/filesystem/S3PinotFSTest.java", "diffHunk": "@@ -287,7 +287,7 @@ public void testCopyFromAndToLocal()\n \n     Assert.assertEquals(headObjectResponse.contentLength(), (Long) fileToCopy.length());\n \n-    File fileToDownload = new File(\"copyFile_download.txt\");\n+    File fileToDownload = new File(\"copyFile_download.txt\").getAbsoluteFile();", "originalCommit": "4874e7a478c1b809a4ccbc07a51940df9d1eb613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1ODA1MQ==", "url": "https://github.com/apache/pinot/pull/5897#discussion_r472558051", "bodyText": "because relative File.getParent will return null, which is not going to happen in the prod environment", "author": "xiangfu0", "createdAt": "2020-08-18T23:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NDE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NDM3Ng==", "url": "https://github.com/apache/pinot/pull/5897#discussion_r472554376", "bodyText": "Should we handle this in the PinotFS?", "author": "Jackie-Jiang", "createdAt": "2020-08-18T23:47:15Z", "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -411,6 +412,7 @@ public void copyToLocalFile(URI srcUri, File dstFile)\n       throws Exception {\n     LOGGER.info(\"Copy {} to local {}\", srcUri, dstFile.getAbsolutePath());\n     URI base = getBase(srcUri);\n+    FileUtils.forceMkdir(dstFile.getParentFile());", "originalCommit": "4874e7a478c1b809a4ccbc07a51940df9d1eb613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1Nzg0OQ==", "url": "https://github.com/apache/pinot/pull/5897#discussion_r472557849", "bodyText": "Per #5890 seems that this is expected behavior.", "author": "xiangfu0", "createdAt": "2020-08-18T23:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NDM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NDU0OQ==", "url": "https://github.com/apache/pinot/pull/5897#discussion_r472554549", "bodyText": "Log something here for debugging purpose?", "author": "Jackie-Jiang", "createdAt": "2020-08-18T23:47:48Z", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -46,6 +47,27 @@\n \n   private static final FileUploadDownloadClient FILE_UPLOAD_DOWNLOAD_CLIENT = new FileUploadDownloadClient();\n \n+  public static URI generateSegmentTarURI(URI outputDirURI, URI fileURI, String prefix, String suffix) {\n+    if (StringUtils.isEmpty(prefix) && StringUtils.isEmpty(suffix)) {\n+      // In case the FS doesn't provide scheme or host, will fill it up from outputDirURI.\n+      String scheme = fileURI.getScheme();\n+      if (StringUtils.isEmpty(fileURI.getScheme())) {\n+        scheme = outputDirURI.getScheme();\n+      }\n+      String host = fileURI.getHost();\n+      if (StringUtils.isEmpty(fileURI.getHost())) {\n+        host = outputDirURI.getHost();\n+      }\n+      try {\n+        return new URI(scheme, fileURI.getUserInfo(), host, fileURI.getPort(), fileURI.getPath(), fileURI.getQuery(),\n+            fileURI.getFragment());\n+      } catch (URISyntaxException e) {\n+        return fileURI;", "originalCommit": "4874e7a478c1b809a4ccbc07a51940df9d1eb613", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83316a54ccd6dd6f791ef6e76dcdadd7caac259e", "url": "https://github.com/apache/pinot/commit/83316a54ccd6dd6f791ef6e76dcdadd7caac259e", "message": "Fixing segment push uri ingestion jobs", "committedDate": "2020-08-19T00:02:35Z", "type": "commit"}, {"oid": "83316a54ccd6dd6f791ef6e76dcdadd7caac259e", "url": "https://github.com/apache/pinot/commit/83316a54ccd6dd6f791ef6e76dcdadd7caac259e", "message": "Fixing segment push uri ingestion jobs", "committedDate": "2020-08-19T00:02:35Z", "type": "forcePushed"}]}