{"pr_number": 6150, "pr_title": "Adding grpcPort in controller instance API response", "pr_createdAt": "2020-10-16T16:53:33Z", "pr_url": "https://github.com/apache/pinot/pull/6150", "timeline": [{"oid": "9796cbfcebe167ad6c5ad4f8029c85fa266614af", "url": "https://github.com/apache/pinot/commit/9796cbfcebe167ad6c5ad4f8029c85fa266614af", "message": "Adding grpcPort in controller instance API response", "committedDate": "2020-10-16T16:52:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4NTc0Mg==", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506685742", "bodyText": "Not related to this PR, but we might want to provide a new API to return the Instance to be in-sync with the setter API.", "author": "Jackie-Jiang", "createdAt": "2020-10-16T19:41:12Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotInstanceRestletResource.java", "diffHunk": "@@ -101,6 +101,7 @@ public String getInstance(\n     response.put(\"port\", instanceConfig.getPort());\n     response.set(\"tags\", JsonUtils.objectToJsonNode(instanceConfig.getTags()));\n     response.set(\"pools\", JsonUtils.objectToJsonNode(instanceConfig.getRecord().getMapField(InstanceUtils.POOL_KEY)));\n+    response.put(\"grpcPort\", instanceConfig.getRecord().getSimpleField(InstanceUtils.GRPC_PORT_KEY));", "originalCommit": "9796cbfcebe167ad6c5ad4f8029c85fa266614af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0MDA0Nw==", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506740047", "bodyText": "Agree, we should have a consistent object.", "author": "xiangfu0", "createdAt": "2020-10-16T22:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4NTc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4NjUzMA==", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506686530", "bodyText": "Remove the static import\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                checkInstanceInfo(instanceName, hostName, port, tags, pools, poolValues, NOT_SET_GRPC_PORT_VALUE);\n          \n          \n            \n                checkInstanceInfo(instanceName, hostName, port, tags, pools, poolValues, Instance.NOT_SET_GRPC_PORT_VALUE);", "author": "Jackie-Jiang", "createdAt": "2020-10-16T19:43:04Z", "path": "pinot-controller/src/test/java/org/apache/pinot/controller/api/PinotInstanceRestletResourceTest.java", "diffHunk": "@@ -144,14 +148,18 @@ public void testInstanceListingAndCreation()\n     String serverInstanceUpdateTagsUrl = _controllerRequestURLBuilder.forInstanceUpdateTags(serverInstanceId,\n         Lists.newArrayList(\"tag_REALTIME\", \"newTag_OFFLINE\", \"newTag_REALTIME\"));\n     sendPutRequest(serverInstanceUpdateTagsUrl);\n-    checkInstanceInfo(brokerInstanceId, \"Broker_1.2.3.4\", 1234, new String[]{\"tag_BROKER\", \"newTag_BROKER\"}, null,\n-        null);\n+    checkInstanceInfo(brokerInstanceId, \"Broker_1.2.3.4\", 1234, new String[]{\"tag_BROKER\", \"newTag_BROKER\"}, null, null);\n     checkInstanceInfo(serverInstanceId, \"Server_1.2.3.4\", 2345,\n-        new String[]{\"tag_REALTIME\", \"newTag_OFFLINE\", \"newTag_REALTIME\"}, null, null);\n+        new String[]{\"tag_REALTIME\", \"newTag_OFFLINE\", \"newTag_REALTIME\"}, null, null, 28090);\n   }\n \n   private void checkInstanceInfo(String instanceName, String hostName, int port, String[] tags, String[] pools,\n       int[] poolValues) {\n+    checkInstanceInfo(instanceName, hostName, port, tags, pools, poolValues, NOT_SET_GRPC_PORT_VALUE);", "originalCommit": "9796cbfcebe167ad6c5ad4f8029c85fa266614af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4ODM3Mg==", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506688372", "bodyText": "This will be set to 0 from the json if grpcPort is not set. You can check for 0 and put -1", "author": "Jackie-Jiang", "createdAt": "2020-10-16T19:47:14Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/instance/Instance.java", "diffHunk": "@@ -38,29 +38,40 @@\n  *   \"tags\": [\"example_OFFLINE\"],\n  *   \"pools\": {\n  *     \"example_OFFLINE\": 0\n- *   }\n+ *   },\n+ *   \"grpcPort\": 8090\n  * }\n  * </pre>\n  */\n public class Instance extends BaseJsonConfig {\n+  public static int NOT_SET_GRPC_PORT_VALUE = -1;\n+\n   private final String _host;\n   private final int _port;\n   private final InstanceType _type;\n   private final List<String> _tags;\n   private final Map<String, Integer> _pools;\n+  private final int _grpcPort;\n+\n+\n+  public Instance(String host, int port, InstanceType type, List<String> tags, Map<String, Integer> pools) {\n+    this(host, port, type, tags, pools, NOT_SET_GRPC_PORT_VALUE);\n+  }\n \n   @JsonCreator\n   public Instance(@JsonProperty(value = \"host\", required = true) String host,\n       @JsonProperty(value = \"port\", required = true) int port,\n       @JsonProperty(value = \"type\", required = true) InstanceType type,\n-      @JsonProperty(\"tags\") @Nullable List<String> tags, @JsonProperty(\"pools\") @Nullable Map<String, Integer> pools) {\n+      @JsonProperty(\"tags\") @Nullable List<String> tags, @JsonProperty(\"pools\") @Nullable Map<String, Integer> pools,\n+      @JsonProperty(\"grpcPort\") int grpcPort) {\n     Preconditions.checkArgument(host != null, \"'host' must be configured\");\n     Preconditions.checkArgument(type != null, \"'type' must be configured\");\n     _host = host;\n     _port = port;\n     _type = type;\n     _tags = tags;\n     _pools = pools;\n+    _grpcPort = grpcPort;", "originalCommit": "9796cbfcebe167ad6c5ad4f8029c85fa266614af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4OTY1OA==", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506689658", "bodyText": "Recommend removing this constructor. This class is always deserialized from json", "author": "Jackie-Jiang", "createdAt": "2020-10-16T19:50:00Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/instance/Instance.java", "diffHunk": "@@ -38,29 +38,40 @@\n  *   \"tags\": [\"example_OFFLINE\"],\n  *   \"pools\": {\n  *     \"example_OFFLINE\": 0\n- *   }\n+ *   },\n+ *   \"grpcPort\": 8090\n  * }\n  * </pre>\n  */\n public class Instance extends BaseJsonConfig {\n+  public static int NOT_SET_GRPC_PORT_VALUE = -1;\n+\n   private final String _host;\n   private final int _port;\n   private final InstanceType _type;\n   private final List<String> _tags;\n   private final Map<String, Integer> _pools;\n+  private final int _grpcPort;\n+\n+\n+  public Instance(String host, int port, InstanceType type, List<String> tags, Map<String, Integer> pools) {", "originalCommit": "9796cbfcebe167ad6c5ad4f8029c85fa266614af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "845320e1881315f9a682a71c0bd17d0932f0d085", "url": "https://github.com/apache/pinot/commit/845320e1881315f9a682a71c0bd17d0932f0d085", "message": "address comments", "committedDate": "2020-10-16T22:01:00Z", "type": "commit"}, {"oid": "3071bab71aa38a67f964e79a455a3222eabac95d", "url": "https://github.com/apache/pinot/commit/3071bab71aa38a67f964e79a455a3222eabac95d", "message": "make grpcPort returns -1 if not set", "committedDate": "2020-10-17T19:51:31Z", "type": "commit"}]}