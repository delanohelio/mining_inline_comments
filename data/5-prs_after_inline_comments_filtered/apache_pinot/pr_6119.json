{"pr_number": 6119, "pr_title": "Change Signature of Broker API in Controller", "pr_createdAt": "2020-10-08T08:21:06Z", "pr_url": "https://github.com/apache/pinot/pull/6119", "timeline": [{"oid": "41a821824d52911baa5767190e345ad265febad8", "url": "https://github.com/apache/pinot/commit/41a821824d52911baa5767190e345ad265febad8", "message": "Add code for v2 broker api", "committedDate": "2020-10-08T07:18:12Z", "type": "commit"}, {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "url": "https://github.com/apache/pinot/commit/987a01d267f2b67798386d5c002c3d5e4275ba2f", "message": "Change v1 methods to use v2 signature", "committedDate": "2020-10-08T07:50:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjA5MA==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502132090", "bodyText": "Can we keep the old implementation as there are performance differences", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:06:17Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -422,10 +423,15 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * reuse instance configs in order to reduce ZK accesses\n    */\n   public static List<String> getInstancesWithTag(List<InstanceConfig> instanceConfigs, String tag) {\n-    List<String> instancesWithTag = new ArrayList<>();\n+    List<InstanceConfig> instancesWithTag = getInstancesConfigsWithTag(instanceConfigs, tag);\n+    return instancesWithTag.stream().map(InstanceConfig::getInstanceName).collect(Collectors.toList());", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5NTk5Nw==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502295997", "bodyText": "These APIs won't be called frequently. The only use of this API is to determine brokers for a tenant or table while creating a connection for a query. Once the connection is created, the API is only called again if the connection breaks.", "author": "KKcorps", "createdAt": "2020-10-09T09:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjU2OQ==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502132569", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return new HashSet<>(HelixHelper.getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n          \n          \n            \n                return new HashSet<>(getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:07:21Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -474,6 +480,12 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * TODO: refactor code to use this method if applicable to reuse instance configs in order to reduce ZK accesses\n    */\n   public static Set<String> getBrokerInstancesForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n-    return new HashSet<>(HelixHelper.getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n+    return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n+        Collectors.toSet());\n   }\n+\n+  public static Set<InstanceConfig> getBrokerInstanceConfigsForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n+    return new HashSet<>(HelixHelper.getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMwMDczOQ==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502300739", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-10-09T09:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzE3MQ==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502133171", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n          \n          \n            \n                    Collectors.toSet());\n          \n          \n            \n                return new HashSet<>(getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:08:31Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -474,6 +480,12 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * TODO: refactor code to use this method if applicable to reuse instance configs in order to reduce ZK accesses\n    */\n   public static Set<String> getBrokerInstancesForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n-    return new HashSet<>(HelixHelper.getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n+    return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n+        Collectors.toSet());", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5OTgzMg==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502299832", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-10-09T09:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzQ1Mg==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502133452", "bodyText": "Is this used?", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:09:03Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/Constants.java", "diffHunk": "@@ -36,6 +36,7 @@\n   public static final String SCHEMA_TAG = \"Schema\";\n   public static final String TENANT_TAG = \"Tenant\";\n   public static final String BROKER_TAG = \"Broker\";\n+  public static final String BROKER_V2_TAG = \"BrokerV2\";", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5OTc2OQ==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502299769", "bodyText": "removed", "author": "KKcorps", "createdAt": "2020-10-09T09:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzNjY1Ng==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502136656", "bodyText": "Again suggest keeping the current logic for performance concern if this will be called frequently. You may extract a helper function for getting the brokerTenantName to avoid duplicate code", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:15:00Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -348,6 +348,11 @@ public InstanceZKMetadata getInstanceZKMetadata(String instanceId) {\n    * @return List of broker instance Ids\n    */\n   public List<String> getBrokerInstancesFor(String tableName) {\n+    List<InstanceConfig> instanceConfigList = getBrokerInstancesConfigsFor(tableName);\n+    return instanceConfigList.stream().map(InstanceConfig::getInstanceName).collect(Collectors.toList());", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDQ0OA==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502164448", "bodyText": "Suggest renaming it to InstanceInfo so that it can be reused for server instances if necessary.", "author": "Jackie-Jiang", "createdAt": "2020-10-09T03:27:21Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/ControllerBrokerResponse.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.api.resources;\n+\n+public class ControllerBrokerResponse {", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5OTUyNg==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502299526", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-10-09T09:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDU4NA==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502164584", "bodyText": "You can change these variables to final and remove the setters as they are not needed", "author": "Jackie-Jiang", "createdAt": "2020-10-09T03:27:55Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/ControllerBrokerResponse.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.api.resources;\n+\n+public class ControllerBrokerResponse {\n+  private String _instanceName;", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5OTQ5Ng==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502299496", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-10-09T09:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDU4NA=="}], "type": "inlineReview"}, {"oid": "6a1accf846f03c4cac5dbf442594317936a409ac", "url": "https://github.com/apache/pinot/commit/6a1accf846f03c4cac5dbf442594317936a409ac", "message": "Refactor: Change class name from ControllerBrokerResponse to InstanceInfo", "committedDate": "2020-10-09T09:16:33Z", "type": "commit"}, {"oid": "9b245e6ce88b10d63369a902ffc2ef7205fc7e3b", "url": "https://github.com/apache/pinot/commit/9b245e6ce88b10d63369a902ffc2ef7205fc7e3b", "message": "Refactor: Remove unused constant and reuse functions", "committedDate": "2020-10-09T09:18:43Z", "type": "commit"}, {"oid": "f49a0172a206ccb01f38df840bff3ac250221d8c", "url": "https://github.com/apache/pinot/commit/f49a0172a206ccb01f38df840bff3ac250221d8c", "message": "Refactor: Remove class name from the methods called from same class", "committedDate": "2020-10-09T09:21:12Z", "type": "commit"}]}