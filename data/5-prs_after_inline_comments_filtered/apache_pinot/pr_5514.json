{"pr_number": 5514, "pr_title": "Add integration test for theta sketches", "pr_createdAt": "2020-06-08T01:09:24Z", "pr_url": "https://github.com/apache/pinot/pull/5514", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1MDE2Mg==", "url": "https://github.com/apache/pinot/pull/5514#discussion_r436750162", "bodyText": "Can this be merged inside of OfflineClusterIntegrationTest, by creating a new table (once the original test is completed)? This way we avoid setting up the cluster for every new feature new add. Not sure, if there's a time limit on travis per test though (would need to check that first).", "author": "mayankshriv", "createdAt": "2020-06-08T14:25:40Z", "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/ThetaSketchIntegrationTest.java", "diffHunk": "@@ -0,0 +1,263 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.integration.tests;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.avro.Schema.Field;\n+import org.apache.avro.Schema.Type;\n+import org.apache.avro.file.DataFileWriter;\n+import org.apache.avro.generic.GenericData;\n+import org.apache.avro.generic.GenericDatumWriter;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.lang3.tuple.ImmutablePair;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.datasketches.theta.UpdateSketch;\n+import org.apache.datasketches.theta.UpdateSketchBuilder;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TableType;\n+import org.apache.pinot.spi.data.FieldSpec;\n+import org.apache.pinot.spi.data.Schema;\n+import org.apache.pinot.spi.utils.builder.TableConfigBuilder;\n+import org.apache.pinot.util.TestUtils;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+\n+public class ThetaSketchIntegrationTest extends BaseClusterIntegrationTest {", "originalCommit": "34ce461a7f9dc8277f062d485e545a8da00eec65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyMTA5OQ==", "url": "https://github.com/apache/pinot/pull/5514#discussion_r436821099", "bodyText": "On second thought, perhaps we should have a (single) separate integration test for specialized data structures such as TDigest, HLL, ThetaSketch, etc.", "author": "mayankshriv", "createdAt": "2020-06-08T16:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MDMzMA==", "url": "https://github.com/apache/pinot/pull/5514#discussion_r449040330", "bodyText": "To elaborate, I was suggesting to create one integration test for these specialized data structures such that:\n\nThe cluster is set up once at begining.\nFor each of these features, we can setup the table -> run queries -> delete the table, iteratively\n\nThis will avoid setting up the cluster multiple times, as we know this can lead to flakiness at times (if the cluster from test is not fully shutdown, before the next test starts).", "author": "mayankshriv", "createdAt": "2020-07-02T14:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1MDE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI3NTc3Nw==", "url": "https://github.com/apache/pinot/pull/5514#discussion_r449275777", "bodyText": "I created an issue #5655 to do so in a separate RB.", "author": "sajjad-moradi", "createdAt": "2020-07-02T21:32:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1MDE2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1MDg2Mw==", "url": "https://github.com/apache/pinot/pull/5514#discussion_r436750863", "bodyText": "Would be good to create a utility method that generates the query based on parameters. Also, would be good to cover SQL/PQL, selection and group by.", "author": "mayankshriv", "createdAt": "2020-06-08T14:26:28Z", "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/ThetaSketchIntegrationTest.java", "diffHunk": "@@ -0,0 +1,263 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.integration.tests;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.avro.Schema.Field;\n+import org.apache.avro.Schema.Type;\n+import org.apache.avro.file.DataFileWriter;\n+import org.apache.avro.generic.GenericData;\n+import org.apache.avro.generic.GenericDatumWriter;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.lang3.tuple.ImmutablePair;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.datasketches.theta.UpdateSketch;\n+import org.apache.datasketches.theta.UpdateSketchBuilder;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TableType;\n+import org.apache.pinot.spi.data.FieldSpec;\n+import org.apache.pinot.spi.data.Schema;\n+import org.apache.pinot.spi.utils.builder.TableConfigBuilder;\n+import org.apache.pinot.util.TestUtils;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+\n+public class ThetaSketchIntegrationTest extends BaseClusterIntegrationTest {\n+\n+  private static final String DIM_NAME = \"dimName\";\n+  private static final String DIM_VALUE = \"dimValue\";\n+  private static final String SHARD_ID = \"shardId\";\n+  private static final String THETA_SKETCH = \"thetaSketchCol\";\n+\n+  @BeforeClass\n+  public void setup()\n+      throws Exception {\n+    TestUtils.ensureDirectoriesExistAndEmpty(_tempDir, _segmentDir, _tarDir);\n+\n+    // Start the Pinot cluster\n+    startZk();\n+    startController();\n+    startBroker();\n+    startServer();\n+\n+    // create & upload schema AND table config\n+    Schema schema = new Schema.SchemaBuilder().setSchemaName(DEFAULT_SCHEMA_NAME)\n+        .addSingleValueDimension(DIM_NAME, FieldSpec.DataType.STRING)\n+        .addSingleValueDimension(DIM_VALUE, FieldSpec.DataType.STRING)\n+        .addSingleValueDimension(SHARD_ID, FieldSpec.DataType.INT)\n+        .addSingleValueDimension(THETA_SKETCH, FieldSpec.DataType.BYTES).build();\n+    addSchema(schema);\n+    TableConfig tableConfig = new TableConfigBuilder(TableType.OFFLINE).setTableName(DEFAULT_TABLE_NAME).build();\n+    addTableConfig(tableConfig);\n+\n+    // create & upload segments\n+    File avroFile = createAvroFile();\n+    ClusterIntegrationTestUtils.buildSegmentFromAvro(avroFile, tableConfig, schema, 0, _segmentDir, _tarDir);\n+    uploadSegments(DEFAULT_TABLE_NAME, _tarDir);\n+\n+    waitForAllDocsLoaded(60_000);\n+  }\n+\n+  @Override\n+  protected long getCountStarResult() {\n+    /*\n+    Uploaded table content:\n+\n+    row#  dimName  dimValue  shardId  thetaSketchCol\n+    ----  =======  ========  =======  ==============\n+    1     country  US        1        ...\n+    2     country  CA        1        ...\n+    3     country  MX        1        ...\n+    4     title    Engineer  1        ...\n+    5     title    Manager   1        ...\n+    6     country  US        2        ...\n+    7     country  CA        2        ...\n+    8     country  MX        2        ...\n+    9     title    Engineer  2        ...\n+    10    title    Manager   2        ...\n+     */\n+    return 10;\n+  }\n+\n+  @Test\n+  public void testThetaSketchQuery()\n+      throws Exception {\n+    /*\n+    Original data:\n+\n+    Title     Country  Shard#1  Shard#2\n+    --------  -------  -------  -------\n+    Engineer  US       50       110\n+    Engineer  CA       60       120\n+    Engineer  MX       70       130\n+    Manager   US       80       140\n+    Manager   CA       90       150\n+    Manager   MX       100      160\n+     */\n+\n+    // title = engineer\n+    String query = \"select distinctCountThetaSketch(thetaSketchCol, '', \"", "originalCommit": "34ce461a7f9dc8277f062d485e545a8da00eec65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzQ0MA==", "url": "https://github.com/apache/pinot/pull/5514#discussion_r448667440", "bodyText": "I just added the test case for groupby and also ran everything against sql endpoint as well.\nFor utility method, I intentionally didn't use it here because this is a slightly complicated aggregation function and I wanted to spell out the queries so the reader can easily see what the syntax is and what the differences are.", "author": "sajjad-moradi", "createdAt": "2020-07-01T23:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1MDg2Mw=="}], "type": "inlineReview"}, {"oid": "295f5a209bfdabc7aa9d7e21271009b391265507", "url": "https://github.com/apache/pinot/commit/295f5a209bfdabc7aa9d7e21271009b391265507", "message": "Add integration test for theta sketches", "committedDate": "2020-07-01T23:24:11Z", "type": "commit"}, {"oid": "d351b0a14116e16b7e469384822898f54e0551bf", "url": "https://github.com/apache/pinot/commit/d351b0a14116e16b7e469384822898f54e0551bf", "message": "Change dim names and values", "committedDate": "2020-07-01T23:24:11Z", "type": "commit"}, {"oid": "c0d23ef60a36b7c00e16b2958d550f5499e4564d", "url": "https://github.com/apache/pinot/commit/c0d23ef60a36b7c00e16b2958d550f5499e4564d", "message": "Added groupby + sql/pql", "committedDate": "2020-07-01T23:24:11Z", "type": "commit"}, {"oid": "c0d23ef60a36b7c00e16b2958d550f5499e4564d", "url": "https://github.com/apache/pinot/commit/c0d23ef60a36b7c00e16b2958d550f5499e4564d", "message": "Added groupby + sql/pql", "committedDate": "2020-07-01T23:24:11Z", "type": "forcePushed"}, {"oid": "f04d195129c9ad10e6747291b69fd95c3389c4e0", "url": "https://github.com/apache/pinot/commit/f04d195129c9ad10e6747291b69fd95c3389c4e0", "message": "Fix sql litral issue", "committedDate": "2020-07-02T20:45:10Z", "type": "commit"}]}