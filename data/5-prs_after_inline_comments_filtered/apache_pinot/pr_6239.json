{"pr_number": 6239, "pr_title": "Always read start/end time in millis from the segment ZK metadata", "pr_createdAt": "2020-11-04T23:25:01Z", "pr_url": "https://github.com/apache/pinot/pull/6239", "timeline": [{"oid": "a38db3231b296cfcaae4bdfd9ff501c4f21b41b5", "url": "https://github.com/apache/pinot/commit/a38db3231b296cfcaae4bdfd9ff501c4f21b41b5", "message": "Always read start/end time in millis from the segment ZK metadata", "committedDate": "2020-11-04T23:46:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc0NDk2Ng==", "url": "https://github.com/apache/pinot/pull/6239#discussion_r517744966", "bodyText": "For consuming segment, neither start nor end time will be set.", "author": "mcvsubbu", "createdAt": "2020-11-05T02:17:46Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/metadata/segment/SegmentZKMetadata.java", "diffHunk": "@@ -105,54 +97,40 @@ public void setSegmentName(String segmentName) {\n     _segmentName = segmentName;\n   }\n \n-  @Deprecated\n-  public String getTableName() {\n-    return _tableName;\n+  public SegmentType getSegmentType() {\n+    return _segmentType;\n   }\n \n-  @Deprecated\n-  public void setTableName(String tableName) {\n-    _tableName = tableName;\n+  public void setSegmentType(SegmentType segmentType) {\n+    _segmentType = segmentType;\n   }\n \n-  public long getStartTime() {\n-    return _startTime;\n+  public long getStartTimeMs() {\n+    if (_startTime > 0 && _timeUnit != null) {\n+      return _timeUnit.toMillis(_startTime);\n+    } else {\n+      return -1;\n+    }\n   }\n \n   public void setStartTime(long startTime) {\n     _startTime = startTime;\n   }\n \n-  public long getEndTime() {\n-    return _endTime;\n+  public long getEndTimeMs() {\n+    if (_endTime > 0 && _timeUnit != null) {\n+      return _timeUnit.toMillis(_endTime);\n+    } else {\n+      return -1;\n+    }\n   }\n \n   public void setEndTime(long endTime) {\n     _endTime = endTime;\n   }\n \n-  public TimeUnit getTimeUnit() {\n-    return _timeUnit;\n-  }\n-\n-  /**\n-   * NOTE: should be called after setting start and end time.\n-   */\n-  public void setTimeUnit(@Nonnull TimeUnit timeUnit) {\n+  public void setTimeUnit(TimeUnit timeUnit) {\n     _timeUnit = timeUnit;\n-    _timeGranularity = new Duration(_timeUnit.toMillis(1));\n-    // For consuming segment, end time might not be set", "originalCommit": "a38db3231b296cfcaae4bdfd9ff501c4f21b41b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3NTEwNQ==", "url": "https://github.com/apache/pinot/pull/6239#discussion_r518275105", "bodyText": "True, time unit won't be set as well.\nThe new code doesn't have the requirement of setting start/end before time unit.", "author": "Jackie-Jiang", "createdAt": "2020-11-05T18:34:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc0NDk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk0Njg0Ng==", "url": "https://github.com/apache/pinot/pull/6239#discussion_r518946846", "bodyText": "Can we put @Deprecated annotation instead of removing the function?", "author": "snleee", "createdAt": "2020-11-06T19:02:30Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/metadata/segment/SegmentZKMetadata.java", "diffHunk": "@@ -105,54 +97,40 @@ public void setSegmentName(String segmentName) {\n     _segmentName = segmentName;\n   }\n \n-  @Deprecated\n-  public String getTableName() {\n-    return _tableName;\n+  public SegmentType getSegmentType() {\n+    return _segmentType;\n   }\n \n-  @Deprecated\n-  public void setTableName(String tableName) {\n-    _tableName = tableName;\n+  public void setSegmentType(SegmentType segmentType) {\n+    _segmentType = segmentType;\n   }\n \n-  public long getStartTime() {\n-    return _startTime;\n+  public long getStartTimeMs() {\n+    if (_startTime > 0 && _timeUnit != null) {\n+      return _timeUnit.toMillis(_startTime);\n+    } else {\n+      return -1;\n+    }\n   }\n \n   public void setStartTime(long startTime) {\n     _startTime = startTime;\n   }\n \n-  public long getEndTime() {\n-    return _endTime;\n+  public long getEndTimeMs() {\n+    if (_endTime > 0 && _timeUnit != null) {\n+      return _timeUnit.toMillis(_endTime);\n+    } else {\n+      return -1;\n+    }\n   }\n \n   public void setEndTime(long endTime) {\n     _endTime = endTime;\n   }\n \n-  public TimeUnit getTimeUnit() {\n-    return _timeUnit;\n-  }\n-\n-  /**\n-   * NOTE: should be called after setting start and end time.\n-   */\n-  public void setTimeUnit(@Nonnull TimeUnit timeUnit) {\n+  public void setTimeUnit(TimeUnit timeUnit) {\n     _timeUnit = timeUnit;\n-    _timeGranularity = new Duration(_timeUnit.toMillis(1));\n-    // For consuming segment, end time might not be set\n-    if (_startTime >= 0 && _startTime <= _endTime) {\n-      _timeInterval = new Interval(_timeUnit.toMillis(_startTime), _timeUnit.toMillis(_endTime));\n-    }\n-  }\n-\n-  public Duration getTimeGranularity() {\n-    return _timeGranularity;\n-  }\n-\n-  public Interval getTimeInterval() {", "originalCommit": "a38db3231b296cfcaae4bdfd9ff501c4f21b41b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyNDA2MA==", "url": "https://github.com/apache/pinot/pull/6239#discussion_r520824060", "bodyText": "Done", "author": "Jackie-Jiang", "createdAt": "2020-11-10T19:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk0Njg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk0NzEyMQ==", "url": "https://github.com/apache/pinot/pull/6239#discussion_r518947121", "bodyText": "Can we put @Deprecated  annotation instead of removing this?", "author": "snleee", "createdAt": "2020-11-06T19:03:09Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/metadata/segment/SegmentZKMetadata.java", "diffHunk": "@@ -105,54 +97,40 @@ public void setSegmentName(String segmentName) {\n     _segmentName = segmentName;\n   }\n \n-  @Deprecated\n-  public String getTableName() {\n-    return _tableName;\n+  public SegmentType getSegmentType() {\n+    return _segmentType;\n   }\n \n-  @Deprecated\n-  public void setTableName(String tableName) {\n-    _tableName = tableName;\n+  public void setSegmentType(SegmentType segmentType) {\n+    _segmentType = segmentType;\n   }\n \n-  public long getStartTime() {\n-    return _startTime;\n+  public long getStartTimeMs() {\n+    if (_startTime > 0 && _timeUnit != null) {\n+      return _timeUnit.toMillis(_startTime);\n+    } else {\n+      return -1;\n+    }\n   }\n \n   public void setStartTime(long startTime) {\n     _startTime = startTime;\n   }\n \n-  public long getEndTime() {\n-    return _endTime;\n+  public long getEndTimeMs() {\n+    if (_endTime > 0 && _timeUnit != null) {\n+      return _timeUnit.toMillis(_endTime);\n+    } else {\n+      return -1;\n+    }\n   }\n \n   public void setEndTime(long endTime) {\n     _endTime = endTime;\n   }\n \n-  public TimeUnit getTimeUnit() {\n-    return _timeUnit;\n-  }\n-\n-  /**\n-   * NOTE: should be called after setting start and end time.\n-   */\n-  public void setTimeUnit(@Nonnull TimeUnit timeUnit) {\n+  public void setTimeUnit(TimeUnit timeUnit) {\n     _timeUnit = timeUnit;\n-    _timeGranularity = new Duration(_timeUnit.toMillis(1));\n-    // For consuming segment, end time might not be set\n-    if (_startTime >= 0 && _startTime <= _endTime) {\n-      _timeInterval = new Interval(_timeUnit.toMillis(_startTime), _timeUnit.toMillis(_endTime));\n-    }\n-  }\n-\n-  public Duration getTimeGranularity() {", "originalCommit": "a38db3231b296cfcaae4bdfd9ff501c4f21b41b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyNDEwNg==", "url": "https://github.com/apache/pinot/pull/6239#discussion_r520824106", "bodyText": "Done", "author": "Jackie-Jiang", "createdAt": "2020-11-10T19:34:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk0NzEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk0ODU4NQ==", "url": "https://github.com/apache/pinot/pull/6239#discussion_r518948585", "bodyText": "Do we want to add\nPreconditions.checkState(minStartTimeMs != Long.MAX_VALUE);\n\nto throw the exception at the same condition?", "author": "snleee", "createdAt": "2020-11-06T19:06:03Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/minion/generator/RealtimeToOfflineSegmentsTaskGenerator.java", "diffHunk": "@@ -287,21 +284,14 @@ private long getWatermarkMs(String realtimeTableName, List<LLCRealtimeSegmentZKM\n       long watermarkMs;\n \n       // Find the smallest time from all segments\n-      RealtimeSegmentZKMetadata minSegmentZkMetadata = null;\n+      long minStartTimeMs = Long.MAX_VALUE;\n       for (LLCRealtimeSegmentZKMetadata realtimeSegmentZKMetadata : completedSegmentsMetadata) {\n-        if (minSegmentZkMetadata == null || realtimeSegmentZKMetadata.getStartTime() < minSegmentZkMetadata\n-            .getStartTime()) {\n-          minSegmentZkMetadata = realtimeSegmentZKMetadata;\n-        }\n+        minStartTimeMs = Math.min(minStartTimeMs, realtimeSegmentZKMetadata.getStartTimeMs());\n       }", "originalCommit": "a38db3231b296cfcaae4bdfd9ff501c4f21b41b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyNTgwNg==", "url": "https://github.com/apache/pinot/pull/6239#discussion_r520825806", "bodyText": "It's not really possible with the current code, but added it in case the code changes in the future", "author": "Jackie-Jiang", "createdAt": "2020-11-10T19:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk0ODU4NQ=="}], "type": "inlineReview"}, {"oid": "580c85b9016d2bb8adc2cdaca74a80dc28bce017", "url": "https://github.com/apache/pinot/commit/580c85b9016d2bb8adc2cdaca74a80dc28bce017", "message": "Always read start/end time in millis from the segment ZK metadata", "committedDate": "2020-11-10T19:38:02Z", "type": "commit"}, {"oid": "580c85b9016d2bb8adc2cdaca74a80dc28bce017", "url": "https://github.com/apache/pinot/commit/580c85b9016d2bb8adc2cdaca74a80dc28bce017", "message": "Always read start/end time in millis from the segment ZK metadata", "committedDate": "2020-11-10T19:38:02Z", "type": "forcePushed"}]}