{"pr_number": 5760, "pr_title": "Enhance DataTypeTransformer to handle nested Map/List/Object[]", "pr_createdAt": "2020-07-27T23:04:20Z", "pr_url": "https://github.com/apache/pinot/pull/5760", "timeline": [{"oid": "ddf7f32ddeea9f2f66e269235f8cb75058fa82ce", "url": "https://github.com/apache/pinot/commit/ddf7f32ddeea9f2f66e269235f8cb75058fa82ce", "message": "Enhance DataTypeTransformer to handle nested Map/List/Object[]", "committedDate": "2020-07-27T22:59:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzNTUyMQ==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461235521", "bodyText": "Can we please add tests for the exact case where we were seeing the problem? The AvroRecorExtractor extracted the column as Object[] where each value in the array is a Map of single KV pair and this is what is passed to DataTypeTransformer.  The actual type of column in the schema is MV STRING and the transformer should just convert it into Object[] where each value is a String and is the corresponding value from each Map.\nLooking at the code in standardize and standardizeCollection, it looks the above scenario is well taken care of but want to make sure that in future when this code is changed for either handling map properly or something else, we don't regress again.\n@jackjlli , is there any other case that we were seeing when the problem was original reproduced. Good to share a sample of original data so that we can use it in tests here,", "author": "siddharthteotia", "createdAt": "2020-07-27T23:52:56Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/data/recordtransformer/DataTypeTransformerTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.recordtransformer;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertEqualsNoOrder;\n+import static org.testng.Assert.assertNull;\n+import static org.testng.Assert.fail;\n+\n+\n+public class DataTypeTransformerTest {\n+  private static final String COLUMN = \"testColumn\";\n+\n+  @Test\n+  public void testStandardize() {\n+    // Tests for Map", "originalCommit": "ddf7f32ddeea9f2f66e269235f8cb75058fa82ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzNzIzNQ==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461237235", "bodyText": "@siddharthteotia Added", "author": "Jackie-Jiang", "createdAt": "2020-07-27T23:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzNTUyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0ODkyMw==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461248923", "bodyText": "I think Line 138 in DataTypeTransformerTest.java is the example that we expect.", "author": "jackjlli", "createdAt": "2020-07-28T00:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzNTUyMQ=="}], "type": "inlineReview"}, {"oid": "376bd20435b3a9d58ac85c97311237c4cad8d861", "url": "https://github.com/apache/pinot/commit/376bd20435b3a9d58ac85c97311237c4cad8d861", "message": "Add test case for Object[] of multiple single-entry Maps", "committedDate": "2020-07-27T23:57:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0NTc1Mw==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461245753", "bodyText": "Can you add a simple comment here on why it should fail (because of single value column)?", "author": "jackjlli", "createdAt": "2020-07-28T00:25:27Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/data/recordtransformer/DataTypeTransformerTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.recordtransformer;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertEqualsNoOrder;\n+import static org.testng.Assert.assertNull;\n+import static org.testng.Assert.fail;\n+\n+\n+public class DataTypeTransformerTest {\n+  private static final String COLUMN = \"testColumn\";\n+\n+  @Test\n+  public void testStandardize() {\n+    // Tests for Map\n+    Map<String, Object> map = Collections.emptyMap();\n+    assertNull(DataTypeTransformer.standardize(COLUMN, map, true));\n+    assertNull(DataTypeTransformer.standardize(COLUMN, map, false));\n+    String expectedValue = \"testValue\";\n+    map = Collections.singletonMap(\"testKey\", expectedValue);\n+    assertEquals(DataTypeTransformer.standardize(COLUMN, map, true), expectedValue);\n+    assertEquals(DataTypeTransformer.standardize(COLUMN, map, false), expectedValue);\n+    Object[] expectedValues = new Object[]{\"testValue1\", \"testValue2\"};\n+    map = new HashMap<>();\n+    map.put(\"testKey1\", \"testValue1\");\n+    map.put(\"testKey2\", \"testValue2\");\n+    try {\n+      DataTypeTransformer.standardize(COLUMN, map, true);\n+      fail();\n+    } catch (Exception e) {\n+      // Expected\n+    }\n+    assertEqualsNoOrder((Object[]) DataTypeTransformer.standardize(COLUMN, map, false), expectedValues);\n+\n+    // Tests for List\n+    List<Object> list = Collections.emptyList();\n+    assertNull(DataTypeTransformer.standardize(COLUMN, list, true));\n+    assertNull(DataTypeTransformer.standardize(COLUMN, list, false));\n+    list = Collections.singletonList(expectedValue);\n+    assertEquals(DataTypeTransformer.standardize(COLUMN, list, true), expectedValue);\n+    assertEquals(DataTypeTransformer.standardize(COLUMN, list, false), expectedValue);\n+    list = Arrays.asList(expectedValues);\n+    try {\n+      DataTypeTransformer.standardize(COLUMN, list, true);", "originalCommit": "376bd20435b3a9d58ac85c97311237c4cad8d861", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0NTg5MQ==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461245891", "bodyText": "Same here", "author": "jackjlli", "createdAt": "2020-07-28T00:25:56Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/data/recordtransformer/DataTypeTransformerTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.recordtransformer;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertEqualsNoOrder;\n+import static org.testng.Assert.assertNull;\n+import static org.testng.Assert.fail;\n+\n+\n+public class DataTypeTransformerTest {\n+  private static final String COLUMN = \"testColumn\";\n+\n+  @Test\n+  public void testStandardize() {\n+    // Tests for Map\n+    Map<String, Object> map = Collections.emptyMap();\n+    assertNull(DataTypeTransformer.standardize(COLUMN, map, true));\n+    assertNull(DataTypeTransformer.standardize(COLUMN, map, false));\n+    String expectedValue = \"testValue\";\n+    map = Collections.singletonMap(\"testKey\", expectedValue);\n+    assertEquals(DataTypeTransformer.standardize(COLUMN, map, true), expectedValue);\n+    assertEquals(DataTypeTransformer.standardize(COLUMN, map, false), expectedValue);\n+    Object[] expectedValues = new Object[]{\"testValue1\", \"testValue2\"};\n+    map = new HashMap<>();\n+    map.put(\"testKey1\", \"testValue1\");\n+    map.put(\"testKey2\", \"testValue2\");\n+    try {\n+      DataTypeTransformer.standardize(COLUMN, map, true);", "originalCommit": "376bd20435b3a9d58ac85c97311237c4cad8d861", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0Njk2NQ==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461246965", "bodyText": "Can we add more description on what this method does and what should be the expected behavior?", "author": "jackjlli", "createdAt": "2020-07-28T00:29:35Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/recordtransformer/DataTypeTransformer.java", "diffHunk": "@@ -104,4 +115,76 @@ public GenericRow transform(GenericRow record) {\n     }\n     return record;\n   }\n+\n+  /**\n+   * Standardize the value into supported types.", "originalCommit": "376bd20435b3a9d58ac85c97311237c4cad8d861", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4NDg0Nw==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461784847", "bodyText": "Added", "author": "Jackie-Jiang", "createdAt": "2020-07-28T18:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0Njk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0NzIwNw==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461247207", "bodyText": "There is no need to have an extra check here since it's been covered in Line 89.", "author": "jackjlli", "createdAt": "2020-07-28T00:30:21Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/recordtransformer/DataTypeTransformer.java", "diffHunk": "@@ -73,10 +80,15 @@ public GenericRow transform(GenericRow record) {\n     for (Map.Entry<String, PinotDataType> entry : _dataTypes.entrySet()) {\n       String column = entry.getKey();\n       Object value = record.getValue(column);\n-\n-      // Convert List value to Object[]\n-      if (value instanceof List) {\n-        value = ((List) value).toArray();\n+      if (value == null) {", "originalCommit": "376bd20435b3a9d58ac85c97311237c4cad8d861", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4NTkzNg==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461785936", "bodyText": "Perform this check before standardizing the value to prevent the extra record.putValue()", "author": "Jackie-Jiang", "createdAt": "2020-07-28T18:28:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0NzIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0ODI4NQ==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461248285", "bodyText": "It'd be good to include test which value can be converted to other type like 100, 200 to make sure the output converted value should be the correct one.", "author": "jackjlli", "createdAt": "2020-07-28T00:34:13Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/data/recordtransformer/DataTypeTransformerTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.recordtransformer;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertEqualsNoOrder;\n+import static org.testng.Assert.assertNull;\n+import static org.testng.Assert.fail;\n+\n+\n+public class DataTypeTransformerTest {", "originalCommit": "376bd20435b3a9d58ac85c97311237c4cad8d861", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4NjI0Mg==", "url": "https://github.com/apache/pinot/pull/5760#discussion_r461786242", "bodyText": "That is covered in PinotDataTypeTest", "author": "Jackie-Jiang", "createdAt": "2020-07-28T18:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0ODI4NQ=="}], "type": "inlineReview"}, {"oid": "5e366e5227e88c19b5b3266d8214975ae73be3e5", "url": "https://github.com/apache/pinot/commit/5e366e5227e88c19b5b3266d8214975ae73be3e5", "message": "Address comments", "committedDate": "2020-07-28T18:29:18Z", "type": "commit"}]}