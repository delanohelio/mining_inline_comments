{"pr_number": 5320, "pr_title": "Use time column from table config instead of schema", "pr_createdAt": "2020-04-30T01:29:15Z", "pr_url": "https://github.com/apache/pinot/pull/5320", "timeline": [{"oid": "94de632e37e479c2111ab90908ac85fec07d71d9", "url": "https://github.com/apache/pinot/commit/94de632e37e479c2111ab90908ac85fec07d71d9", "message": "Use time column from table config", "committedDate": "2020-04-30T00:49:50Z", "type": "commit"}, {"oid": "5bd4db87445364d7efb6bc91a2093a1ca2e64a53", "url": "https://github.com/apache/pinot/commit/5bd4db87445364d7efb6bc91a2093a1ca2e64a53", "message": "Better handle PinotOutputFormat", "committedDate": "2020-04-30T01:51:12Z", "type": "commit"}, {"oid": "553d75f82ece189f71d7ded8b7ae9b81155808c0", "url": "https://github.com/apache/pinot/commit/553d75f82ece189f71d7ded8b7ae9b81155808c0", "message": "Fix table name in tests", "committedDate": "2020-04-30T17:11:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwMjM1OQ==", "url": "https://github.com/apache/pinot/pull/5320#discussion_r418202359", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    _logger.warn(\"Metrics aggregation cannot be turned ON in presence of no-dictionary datetime columns, eg: {}\",\n          \n          \n            \n                    _logger.warn(\"Metrics aggregation cannot be turned on in presence of no-dictionary datetime columns, eg: {}\",", "author": "mcvsubbu", "createdAt": "2020-04-30T18:19:39Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -860,6 +876,17 @@ private int getOrCreateDocId(Map<String, Object> dictIdMap) {\n       }\n     }\n \n+    // Date time columns should be dictionary encoded.\n+    for (FieldSpec fieldSpec : _physicalDateTimeFieldSpecs) {\n+      String dateTimeColumn = fieldSpec.getName();\n+      if (noDictionaryColumns.contains(dateTimeColumn)) {\n+        _logger.warn(\"Metrics aggregation cannot be turned ON in presence of no-dictionary datetime columns, eg: {}\",", "originalCommit": "553d75f82ece189f71d7ded8b7ae9b81155808c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwMzY0MQ==", "url": "https://github.com/apache/pinot/pull/5320#discussion_r418203641", "bodyText": "create an  issue for this and add the issue number here?", "author": "mcvsubbu", "createdAt": "2020-04-30T18:21:57Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/minion/SegmentPurger.java", "diffHunk": "@@ -85,7 +85,10 @@ public File purgeSegment()\n       }\n \n       Schema schema = purgeRecordReader.getSchema();\n-      SegmentGeneratorConfig config = new SegmentGeneratorConfig(schema);\n+      // FIXME: figure out how to get table config here.", "originalCommit": "553d75f82ece189f71d7ded8b7ae9b81155808c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzODAwNQ==", "url": "https://github.com/apache/pinot/pull/5320#discussion_r418238005", "bodyText": "Was able to fix it. please take a look", "author": "npawar", "createdAt": "2020-04-30T19:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwMzY0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM1NjE4Nw==", "url": "https://github.com/apache/pinot/pull/5320#discussion_r418356187", "bodyText": "As per offline discussion with @Jackie-Jiang  removing the timeColumnName from SegmentPurger for now. He will be working on a fix to make TableConfig available to SegmentPurger very soon.", "author": "npawar", "createdAt": "2020-05-01T00:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwMzY0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwNjU1NQ==", "url": "https://github.com/apache/pinot/pull/5320#discussion_r418206555", "bodyText": "remove the  the other unneeded arguments as well (tableName, sortedColumn, inv index columns, text index columnms, etc.). Another PR is also fine", "author": "mcvsubbu", "createdAt": "2020-04-30T18:27:21Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/realtime/converter/RealtimeSegmentConverter.java", "diffHunk": "@@ -35,114 +35,116 @@\n import org.apache.pinot.core.segment.creator.impl.SegmentIndexCreationDriverImpl;\n import org.apache.pinot.spi.config.table.ColumnPartitionConfig;\n import org.apache.pinot.spi.config.table.SegmentPartitionConfig;\n+import org.apache.pinot.spi.config.table.TableConfig;\n import org.apache.pinot.spi.data.FieldSpec;\n import org.apache.pinot.spi.data.Schema;\n import org.apache.pinot.spi.data.TimeFieldSpec;\n import org.apache.pinot.spi.data.TimeGranularitySpec;\n \n \n public class RealtimeSegmentConverter {\n-  private MutableSegmentImpl realtimeSegmentImpl;\n-  private String outputPath;\n-  private Schema dataSchema;\n-  private String tableName;\n-  private String timeColumnName;\n-  private String segmentName;\n-  private String sortedColumn;\n-  private List<String> invertedIndexColumns;\n-  private List<String> textIndexColumns;\n-  private List<String> noDictionaryColumns;\n-  private List<String> varLengthDictionaryColumns;\n+  private MutableSegmentImpl _realtimeSegmentImpl;\n+  private final String _outputPath;\n+  private final Schema _dataSchema;\n+  private final String _tableName;\n+  private final TableConfig _tableConfig;\n+  private final String _segmentName;\n+  private final String _sortedColumn;\n+  private final List<String> _invertedIndexColumns;\n+  private final List<String> _textIndexColumns;\n+  private final List<String> _noDictionaryColumns;\n+  private final List<String> _varLengthDictionaryColumns;\n   private final boolean _nullHandlingEnabled;\n \n   public RealtimeSegmentConverter(MutableSegmentImpl realtimeSegment, String outputPath, Schema schema,\n-      String tableName, String timeColumnName, String segmentName, String sortedColumn,\n+      String tableName, TableConfig tableConfig, String segmentName, String sortedColumn,", "originalCommit": "553d75f82ece189f71d7ded8b7ae9b81155808c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzODE5OQ==", "url": "https://github.com/apache/pinot/pull/5320#discussion_r418238199", "bodyText": "All the others are being used to set into the SegmentGeneratorConfig", "author": "npawar", "createdAt": "2020-04-30T19:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwNjU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI1OTU3Ng==", "url": "https://github.com/apache/pinot/pull/5320#discussion_r418259576", "bodyText": "But they can be derived from TableConfig?", "author": "mcvsubbu", "createdAt": "2020-04-30T20:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwNjU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MTc4Nw==", "url": "https://github.com/apache/pinot/pull/5320#discussion_r418281787", "bodyText": "Oh i see. Maybe they can be. In LLRealtimeDataManager, they're being pulled from IndexLoadingConfig. In HLRealtimeDataManager, they're being used in other places other than RealtimeSegmentConverter. Will see if it can be done in a followup PR", "author": "npawar", "createdAt": "2020-04-30T20:52:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwNjU1NQ=="}], "type": "inlineReview"}, {"oid": "f6555a5065c8a2200307030a4ed308dc1a779f91", "url": "https://github.com/apache/pinot/commit/f6555a5065c8a2200307030a4ed308dc1a779f91", "message": "Fix file name in test", "committedDate": "2020-04-30T18:34:46Z", "type": "commit"}, {"oid": "a56d6015bdf79c5a0ada1360f271c20785443fa1", "url": "https://github.com/apache/pinot/commit/a56d6015bdf79c5a0ada1360f271c20785443fa1", "message": "Make timeColumnName available to SegmentPurger", "committedDate": "2020-04-30T19:24:33Z", "type": "commit"}, {"oid": "e7c06bb4ce4383826c3c894bf504ed0c021361b3", "url": "https://github.com/apache/pinot/commit/e7c06bb4ce4383826c3c894bf504ed0c021361b3", "message": "Remove time column from SegmentPurge", "committedDate": "2020-05-01T00:03:37Z", "type": "commit"}]}