{"pr_number": 5671, "pr_title": "Rewrite non-aggregate group by query to distinct query", "pr_createdAt": "2020-07-09T04:34:06Z", "pr_url": "https://github.com/apache/pinot/pull/5671", "timeline": [{"oid": "3a2e1fd88292567f11f56bc4429b91e9d2a42270", "url": "https://github.com/apache/pinot/commit/3a2e1fd88292567f11f56bc4429b91e9d2a42270", "message": "Rewrite non-aggregate group by query to distinct query", "committedDate": "2020-07-09T05:56:09Z", "type": "forcePushed"}, {"oid": "74f85675b50d074a869cc07a96870d9e996aed05", "url": "https://github.com/apache/pinot/commit/74f85675b50d074a869cc07a96870d9e996aed05", "message": "Rewrite non-aggregate group by query to distinct query", "committedDate": "2020-07-09T06:27:16Z", "type": "forcePushed"}, {"oid": "83adf32a3a6c178cc255c4086187ec5403249914", "url": "https://github.com/apache/pinot/commit/83adf32a3a6c178cc255c4086187ec5403249914", "message": "Rewrite non-aggregate group by query to distinct query", "committedDate": "2020-07-09T07:33:46Z", "type": "forcePushed"}, {"oid": "25d70e4881dfc81565888f558d2739da8026c94c", "url": "https://github.com/apache/pinot/commit/25d70e4881dfc81565888f558d2739da8026c94c", "message": "Rewrite non-aggregate group by query to distinct query", "committedDate": "2020-07-09T10:46:29Z", "type": "commit"}, {"oid": "25d70e4881dfc81565888f558d2739da8026c94c", "url": "https://github.com/apache/pinot/commit/25d70e4881dfc81565888f558d2739da8026c94c", "message": "Rewrite non-aggregate group by query to distinct query", "committedDate": "2020-07-09T10:46:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMyNzIyNQ==", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452327225", "bodyText": "Would be good to add doc with sample query translations (as already stated in the PR description).", "author": "mayankshriv", "createdAt": "2020-07-09T16:03:58Z", "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -331,12 +345,59 @@ private static void queryRewrite(PinotQuery pinotQuery) {\n       pinotQuery.setFilterExpression(updatedFilterExpression);\n     }\n \n+    // Rewrite GroupBy to Distinct\n+    rewriteNonAggregationGroupByToDistinct(pinotQuery);\n+\n     // Update alias\n     Map<Identifier, Expression> aliasMap = extractAlias(pinotQuery.getSelectList());\n     applyAlias(aliasMap, pinotQuery);\n     validate(aliasMap, pinotQuery);\n   }\n \n+  private static void rewriteNonAggregationGroupByToDistinct(PinotQuery pinotQuery) {", "originalCommit": "25d70e4881dfc81565888f558d2739da8026c94c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MTY5Nw==", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452391697", "bodyText": "will do", "author": "xiangfu0", "createdAt": "2020-07-09T17:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMyNzIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzMDI1OA==", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452330258", "bodyText": "May be a non-issue here, but just wanted to point out that there are aggregation functions that take multiple args, some of which are expected to be literals (even though they look like expressions, eg distinctCountThetaSketch).", "author": "mayankshriv", "createdAt": "2020-07-09T16:08:58Z", "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -196,13 +198,25 @@ private static boolean isAggregateExpression(Expression expression) {\n     return false;\n   }\n \n-  public static Set<String> extractIdentifiers(List<Expression> expressions) {\n+  /**\n+   * Extract all the identifiers from given expressions.\n+   *\n+   * @param expressions\n+   * @param excludeAs if true, ignores the right side identifier for AS function.\n+   * @return all the identifier names.\n+   */\n+  public static Set<String> extractIdentifiers(List<Expression> expressions, boolean excludeAs) {", "originalCommit": "25d70e4881dfc81565888f558d2739da8026c94c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MTU5Ng==", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452391596", "bodyText": "I see, if those args are single-quoted then it should be fine .", "author": "xiangfu0", "createdAt": "2020-07-09T17:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzMDI1OA=="}], "type": "inlineReview"}, {"oid": "d5103dff769b485fe69f1853fc5f8f81899268fd", "url": "https://github.com/apache/pinot/commit/d5103dff769b485fe69f1853fc5f8f81899268fd", "message": "Adding tests to DistinctQueriesTest", "committedDate": "2020-07-09T21:41:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU3MjUzMQ==", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452572531", "bodyText": "private?", "author": "siddharthteotia", "createdAt": "2020-07-10T01:19:26Z", "path": "pinot-core/src/test/java/org/apache/pinot/queries/DistinctQueriesTest.java", "diffHunk": "@@ -179,18 +179,15 @@ private ImmutableSegment createSegment(int index, List<GenericRow> records)\n    *   <li>Selecting some columns with filter that does not match any record</li>\n    * </ul>\n    */\n-  @Test\n-  public void testDistinctInnerSegment()\n+  public void testDistinctInnerSegmentHelper(String[] queries, boolean isPql)", "originalCommit": "d5103dff769b485fe69f1853fc5f8f81899268fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU3Mjc2Ng==", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452572766", "bodyText": "private?", "author": "siddharthteotia", "createdAt": "2020-07-10T01:20:25Z", "path": "pinot-core/src/test/java/org/apache/pinot/queries/DistinctQueriesTest.java", "diffHunk": "@@ -347,19 +389,16 @@ private DistinctTable getDistinctTableInnerSegment(String query) {\n    *   </li>\n    * </ul>\n    */\n-  @Test\n-  public void testDistinctInterSegment()\n+  public void testDistinctInterSegmentHelper(String[] pqlQueries, String[] sqlQueries)", "originalCommit": "d5103dff769b485fe69f1853fc5f8f81899268fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "87468d1f6695027cf376e9c8a96b36d1b51f091b", "url": "https://github.com/apache/pinot/commit/87468d1f6695027cf376e9c8a96b36d1b51f091b", "message": "Update DistinctQueriesTest.java", "committedDate": "2020-07-10T01:37:39Z", "type": "commit"}]}