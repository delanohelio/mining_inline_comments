{"pr_number": 6053, "pr_title": "Add support for Decimal with Precision Sum aggregation", "pr_createdAt": "2020-09-23T12:44:57Z", "pr_url": "https://github.com/apache/pinot/pull/6053", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcwMTIyMw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r493701223", "bodyText": "call this sum_precision", "author": "kishoreg", "createdAt": "2020-09-23T15:48:25Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/TransformFunctionType.java", "diffHunk": "@@ -79,7 +79,10 @@\n \n   // Geo relationship\n   ST_CONTAINS(\"ST_Contains\"),\n-  ST_EQUALS(\"ST_Equals\");\n+  ST_EQUALS(\"ST_Equals\"),\n+\n+  //Big decimal\n+  ADD_WITH_PRECISION(\"add_with_precision\");", "originalCommit": "e51ac6d33e0ada8a7e5fa69c95211780b259fe3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyNDA5Ng==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r493824096", "bodyText": "@kishoreg This is the transform, instead of the aggregation. We might want to use add_precision for transform and sum_precision for aggregation.", "author": "Jackie-Jiang", "createdAt": "2020-09-23T18:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcwMTIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2MjI1Nw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r494462257", "bodyText": "Fixed.", "author": "KKcorps", "createdAt": "2020-09-24T16:42:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcwMTIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcxODM2MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r493718361", "bodyText": "add java docs with sample call", "author": "kishoreg", "createdAt": "2020-09-23T16:12:48Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/transform/function/AdditionWithPrecisionTransformFunction.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.operator.transform.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.core.common.DataSource;\n+import org.apache.pinot.core.operator.blocks.ProjectionBlock;\n+import org.apache.pinot.core.operator.transform.TransformResultMetadata;\n+import org.apache.pinot.core.plan.DocIdSetPlanNode;\n+\n+\n+public class AdditionWithPrecisionTransformFunction extends BaseTransformFunction {", "originalCommit": "e51ac6d33e0ada8a7e5fa69c95211780b259fe3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcxOTg3NA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r493719874", "bodyText": "this is toBigDecimal transform function right and can be used for sum, min max etc", "author": "kishoreg", "createdAt": "2020-09-23T16:15:00Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/transform/function/AdditionWithPrecisionTransformFunction.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.operator.transform.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.core.common.DataSource;\n+import org.apache.pinot.core.operator.blocks.ProjectionBlock;\n+import org.apache.pinot.core.operator.transform.TransformResultMetadata;\n+import org.apache.pinot.core.plan.DocIdSetPlanNode;\n+\n+\n+public class AdditionWithPrecisionTransformFunction extends BaseTransformFunction {\n+\n+  public static final String FUNCTION_NAME = \"addWithPrecision\";", "originalCommit": "e51ac6d33e0ada8a7e5fa69c95211780b259fe3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcyNzM3MA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r493727370", "bodyText": "no, that is in the scalar function", "author": "KKcorps", "createdAt": "2020-09-23T16:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcxOTg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMDQxNA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r493820414", "bodyText": "Parse the last argument as the precision instead of identifying LITERAL as precision? In certain cases user can add LITERAL to a column, e.g. addWithPrecision(col, BigDecimal(123), 0)", "author": "Jackie-Jiang", "createdAt": "2020-09-23T18:53:21Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/transform/function/AdditionWithPrecisionTransformFunction.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.operator.transform.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.core.common.DataSource;\n+import org.apache.pinot.core.operator.blocks.ProjectionBlock;\n+import org.apache.pinot.core.operator.transform.TransformResultMetadata;\n+import org.apache.pinot.core.plan.DocIdSetPlanNode;\n+\n+\n+public class AdditionWithPrecisionTransformFunction extends BaseTransformFunction {\n+\n+  public static final String FUNCTION_NAME = \"addWithPrecision\";\n+\n+  private List<TransformFunction> _transformFunctions = new ArrayList<>();\n+  private BigDecimal[] _sums;\n+  private Integer _precision = null;\n+\n+  @Override\n+  public String getName() {\n+    return FUNCTION_NAME;\n+  }\n+\n+  @Override\n+  public void init(List<TransformFunction> arguments, Map<String, DataSource> dataSourceMap) {\n+    // Check that there are more than 1 arguments\n+    if (arguments.size() < 3) {\n+      throw new IllegalArgumentException(\"At least 3 arguments are required for ADD transform function\");\n+    }\n+\n+    for (TransformFunction argument : arguments) {\n+      if (argument instanceof LiteralTransformFunction) {", "originalCommit": "e51ac6d33e0ada8a7e5fa69c95211780b259fe3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk4MjA0MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496982041", "bodyText": "Not applicable now.", "author": "KKcorps", "createdAt": "2020-09-29T19:19:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMDQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMjg3MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r493822871", "bodyText": "Function takes at least 3 arguments, and precision is mandatory?", "author": "Jackie-Jiang", "createdAt": "2020-09-23T18:55:48Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/transform/function/AdditionWithPrecisionTransformFunction.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.operator.transform.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.core.common.DataSource;\n+import org.apache.pinot.core.operator.blocks.ProjectionBlock;\n+import org.apache.pinot.core.operator.transform.TransformResultMetadata;\n+import org.apache.pinot.core.plan.DocIdSetPlanNode;\n+\n+\n+public class AdditionWithPrecisionTransformFunction extends BaseTransformFunction {\n+\n+  public static final String FUNCTION_NAME = \"addWithPrecision\";\n+\n+  private List<TransformFunction> _transformFunctions = new ArrayList<>();\n+  private BigDecimal[] _sums;\n+  private Integer _precision = null;\n+\n+  @Override\n+  public String getName() {\n+    return FUNCTION_NAME;\n+  }\n+\n+  @Override\n+  public void init(List<TransformFunction> arguments, Map<String, DataSource> dataSourceMap) {\n+    // Check that there are more than 1 arguments\n+    if (arguments.size() < 3) {\n+      throw new IllegalArgumentException(\"At least 3 arguments are required for ADD transform function\");\n+    }\n+\n+    for (TransformFunction argument : arguments) {\n+      if (argument instanceof LiteralTransformFunction) {\n+        if (_precision != null) {\n+          throw new IllegalArgumentException(\"Only one precision value can be specified in ADD transform function\");\n+        }\n+        _precision = Integer.parseInt(((LiteralTransformFunction) argument).getLiteral());\n+      } else {\n+        if (!argument.getResultMetadata().isSingleValue()) {\n+          throw new IllegalArgumentException(\"All the arguments of ADD transform function must be single-valued\");\n+        }\n+        _transformFunctions.add(argument);\n+      }\n+    }\n+  }\n+\n+  @Override\n+  public TransformResultMetadata getResultMetadata() {\n+    return BYTES_SV_NO_DICTIONARY_METADATA;\n+  }\n+\n+  @Override\n+  public byte[][] transformToBytesValuesSV(ProjectionBlock projectionBlock) {\n+    if (_sums == null) {\n+      _sums = new BigDecimal[DocIdSetPlanNode.MAX_DOC_PER_CALL];\n+    }\n+\n+    int length = projectionBlock.getNumDocs();\n+    Arrays.fill(_sums, 0, length, new BigDecimal(0));\n+    MathContext mathContext;\n+    if (_precision != null) {", "originalCommit": "e51ac6d33e0ada8a7e5fa69c95211780b259fe3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2MjQ5Mw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r494462493", "bodyText": "resolved.", "author": "KKcorps", "createdAt": "2020-09-24T16:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMjg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1ODk0Mg==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r494758942", "bodyText": "This should be in BIG ENDIAN byte order", "author": "siddharthteotia", "createdAt": "2020-09-25T05:41:55Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import org.apache.pinot.common.function.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {\n+    int scale = 0;\n+    for (int i = 0; i < 4; i++) {\n+      scale += (((int) bytes[i]) << (8 * (3 - i)));\n+    }\n+    byte[] vals = new byte[bytes.length - 4];", "originalCommit": "042d31da4891d9642ca78d6cb1878f12283a3627", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyNDIzOA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496624238", "bodyText": "it is BIG endian", "author": "KKcorps", "createdAt": "2020-09-29T10:54:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1ODk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1OTA0OA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r494759048", "bodyText": "What is the format here? Are we saying that byte array is the 2's complement representation of the underlying unscaled value.\nHow is scale represented in the byte array?\nDo we have to take care of endianness here? The unscaled values is going to be BIG-ENDIAN. How's it working without swapping bytes?", "author": "siddharthteotia", "createdAt": "2020-09-25T05:42:22Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import org.apache.pinot.common.function.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction", "originalCommit": "042d31da4891d9642ca78d6cb1878f12283a3627", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNjM1NQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r494816355", "bodyText": "Yes, it is the 2's complement representation of underlying unscaled value\n\n\nScale is the first 4 bytes in the byte array, the remaining bytes are of unscaled value\n\n\nThe unscaled value byte array is indeed Big-endian and they are copied as such in the result array. There's no need to swap the bytes.\n\n\nIn summary, the final byte array is just unscaled value's bytes appended to scale's bytes", "author": "KKcorps", "createdAt": "2020-09-25T08:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1OTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyMjEzOQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r495422139", "bodyText": "@KKcorps , can we add some e2e query execution functional tests?", "author": "siddharthteotia", "createdAt": "2020-09-26T06:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1OTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2NTYyOQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r495465629", "bodyText": "@siddharthteotia Yes, the tests are almost done. Will push them tomorrow.", "author": "KKcorps", "createdAt": "2020-09-26T15:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1OTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyNDA5Mw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496624093", "bodyText": "@siddharthteotia Tests have been added. Let me know if any changes are needed.", "author": "KKcorps", "createdAt": "2020-09-29T10:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1OTA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1OTE2MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r494759161", "bodyText": "Why not allow both precision and scale?", "author": "siddharthteotia", "createdAt": "2020-09-25T05:42:43Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -30,6 +30,7 @@\n   MIN(\"min\"),\n   MAX(\"max\"),\n   SUM(\"sum\"),\n+  SUMPRECISION(\"sumPrecision\"),", "originalCommit": "042d31da4891d9642ca78d6cb1878f12283a3627", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc5NjQ3Nw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r494796477", "bodyText": "Yes, I was actually discussing this with @kishoreg\nI can allow both.", "author": "KKcorps", "createdAt": "2020-09-25T07:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1OTE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyMzc3OA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496623778", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-09-29T10:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc1OTE2MQ=="}], "type": "inlineReview"}, {"oid": "a5d6762930714bf47a02cf49f3339e3efefae90f", "url": "https://github.com/apache/pinot/commit/a5d6762930714bf47a02cf49f3339e3efefae90f", "message": "Add test for big decimal", "committedDate": "2020-09-28T12:53:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MDg1MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496850851", "bodyText": "rename to bytesToBigDecimalHex?", "author": "kishoreg", "createdAt": "2020-09-29T16:02:21Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {", "originalCommit": "a57903c92b2a89d908ad6bd33b02f3773d4b8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MjE3MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496962171", "bodyText": "This doesn't output the hex string. It outputs BigDecimal.toString.", "author": "KKcorps", "createdAt": "2020-09-29T18:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MDg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA1MzQ2Nw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497053467", "bodyText": "Got it. please add java docs", "author": "kishoreg", "createdAt": "2020-09-29T20:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MDg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MjMzNg==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496852336", "bodyText": "whats is happening inside number.toString? is it possible for us to generate the hex string without having to create big integer and big decimal?", "author": "kishoreg", "createdAt": "2020-09-29T16:03:50Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {\n+    int scale = 0;\n+    for (int i = 0; i < 4; i++) {\n+      scale += (((int) bytes[i]) << (8 * (3 - i)));\n+    }\n+    byte[] vals = new byte[bytes.length - 4];\n+    System.arraycopy(bytes, 4, vals, 0, vals.length);\n+    BigInteger unscaled = new BigInteger(vals);\n+    BigDecimal number = new BigDecimal(unscaled, scale);\n+    return number.toString();", "originalCommit": "a57903c92b2a89d908ad6bd33b02f3773d4b8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3MDAzNg==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496870036", "bodyText": "This is not the hex string. This converts to normal String e.g. BigDecimal(1234121.5123127182, 2) to  \"1234.512\"", "author": "KKcorps", "createdAt": "2020-09-29T16:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MjMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MzcwMg==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496853702", "bodyText": "while you are there can you also add base64encode decode?", "author": "kishoreg", "createdAt": "2020-09-29T16:05:11Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {\n+    int scale = 0;\n+    for (int i = 0; i < 4; i++) {\n+      scale += (((int) bytes[i]) << (8 * (3 - i)));\n+    }\n+    byte[] vals = new byte[bytes.length - 4];\n+    System.arraycopy(bytes, 4, vals, 0, vals.length);\n+    BigInteger unscaled = new BigInteger(vals);\n+    BigDecimal number = new BigDecimal(unscaled, scale);\n+    return number.toString();\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalFromString(String bigDecimal) {\n+    return bigDecimalToBytes(new BigDecimal(bigDecimal));\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] hexToBytes(String hex) {\n+    int len = hex.length();\n+    byte[] data = new byte[len / 2];\n+    for (int i = 0; i < len; i += 2) {\n+      data[i / 2] = (byte) ((Character.digit(hex.charAt(i), 16) << 4) + Character.digit(hex.charAt(i + 1), 16));\n+    }\n+    return data;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToHex(byte[] bytes) {", "originalCommit": "a57903c92b2a89d908ad6bd33b02f3773d4b8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTMzNA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496961334", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-09-29T18:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MzcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1NDcyMQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496854721", "bodyText": "check your IDE pref to honor @Formatter:off annotation", "author": "kishoreg", "createdAt": "2020-09-29T16:06:09Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -776,31 +781,30 @@ public IdSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<BigDecimal> BIGDECIMAL_SER_DE = new ObjectSerDe<BigDecimal>() {\n+\n+    @Override\n+    public byte[] serialize(BigDecimal value) {\n+      return DataTypeConversionFunctions.bigDecimalToBytes(value);\n+    }\n+\n+    @Override\n+    public BigDecimal deserialize(byte[] bytes) {\n+      return new BigDecimal(DataTypeConversionFunctions.bytesToBigDecimal(bytes));\n+    }\n+\n+    @Override\n+    public BigDecimal deserialize(ByteBuffer byteBuffer) {\n+      byte[] bytes = new byte[byteBuffer.remaining()];\n+      byteBuffer.get(bytes);\n+      return deserialize(bytes);\n+    }\n+  };\n+\n   // NOTE: DO NOT change the order, it has to be the same order as the ObjectType\n   //@formatter:off\n-  private static final ObjectSerDe[] SER_DES = {\n-      STRING_SER_DE,\n-      LONG_SER_DE,\n-      DOUBLE_SER_DE,\n-      DOUBLE_ARRAY_LIST_SER_DE,\n-      AVG_PAIR_SER_DE,\n-      MIN_MAX_RANGE_PAIR_SER_DE,\n-      HYPER_LOG_LOG_SER_DE,\n-      QUANTILE_DIGEST_SER_DE,\n-      MAP_SER_DE,\n-      INT_SET_SER_DE,\n-      TDIGEST_SER_DE,\n-      DISTINCT_TABLE_SER_DE,\n-      DATA_SKETCH_SER_DE,\n-      GEOMETRY_SER_DE,\n-      ROARING_BITMAP_SER_DE,\n-      LONG_SET_SER_DE,\n-      FLOAT_SET_SER_DE,\n-      DOUBLE_SET_SER_DE,\n-      STRING_SET_SER_DE,\n-      BYTES_SET_SER_DE,\n-      ID_SET_SER_DE\n-  };\n+  private static final ObjectSerDe[] SER_DES =", "originalCommit": "a57903c92b2a89d908ad6bd33b02f3773d4b8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk4MjMxNg==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496982316", "bodyText": "resolved.", "author": "KKcorps", "createdAt": "2020-09-29T19:19:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1NDcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1NjI0NQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496856245", "bodyText": "its probably better to move this logic into SumPrecission(arguments) constructor. You can still keep the other two constructors", "author": "kishoreg", "createdAt": "2020-09-29T16:07:37Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java", "diffHunk": "@@ -117,6 +117,18 @@ public static AggregationFunction getAggregationFunction(FunctionContext functio\n             return new MaxAggregationFunction(firstArgument);\n           case SUM:\n             return new SumAggregationFunction(firstArgument);\n+          case SUMPRECISION:\n+            int numArguments = arguments.size();\n+            if (numArguments == 3) {", "originalCommit": "a57903c92b2a89d908ad6bd33b02f3773d4b8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3NjUyNA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496976524", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-09-29T19:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1NjI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2MDkwMQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496860901", "bodyText": "if users dont use scale, will the results vary depending on the order of segment execution?", "author": "kishoreg", "createdAt": "2020-09-29T16:12:11Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/SumWithPrecisionAggregationFunction.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.Map;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+\n+\n+public class SumWithPrecisionAggregationFunction extends BaseSingleInputAggregationFunction<BigDecimal, BigDecimal> {\n+  MathContext _mathContext = new MathContext(0);\n+  Integer _scale = null;\n+\n+  public SumWithPrecisionAggregationFunction(ExpressionContext expression, Integer precision) {", "originalCommit": "a57903c92b2a89d908ad6bd33b02f3773d4b8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2NzY5OA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496867698", "bodyText": "Yes, they can differ.", "author": "KKcorps", "createdAt": "2020-09-29T16:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2MDkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2MTkxMQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496861911", "bodyText": "this method is bit confusing, what is it trying to do. add some javadocs and maybe rename the function if possible", "author": "kishoreg", "createdAt": "2020-09-29T16:13:09Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/SumWithPrecisionAggregationFunction.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.Map;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+\n+\n+public class SumWithPrecisionAggregationFunction extends BaseSingleInputAggregationFunction<BigDecimal, BigDecimal> {\n+  MathContext _mathContext = new MathContext(0);\n+  Integer _scale = null;\n+\n+  public SumWithPrecisionAggregationFunction(ExpressionContext expression, Integer precision) {\n+    super(expression);\n+    _mathContext = new MathContext(precision);\n+  }\n+\n+  public SumWithPrecisionAggregationFunction(ExpressionContext expression, Integer precision, Integer scale) {\n+    super(expression);\n+    _mathContext = new MathContext(precision);\n+    _scale = scale;\n+  }\n+\n+  public SumWithPrecisionAggregationFunction(ExpressionContext expression) {\n+    super(expression);\n+  }\n+\n+  @Override\n+  public AggregationFunctionType getType() {\n+    return AggregationFunctionType.SUMPRECISION;\n+  }\n+\n+  @Override\n+  public AggregationResultHolder createAggregationResultHolder() {\n+    return new ObjectAggregationResultHolder();\n+  }\n+\n+  @Override\n+  public GroupByResultHolder createGroupByResultHolder(int initialCapacity, int maxCapacity) {\n+    return new ObjectGroupByResultHolder(initialCapacity, maxCapacity);\n+  }\n+\n+  @Override\n+  public void aggregate(int length, AggregationResultHolder aggregationResultHolder,\n+      Map<ExpressionContext, BlockValSet> blockValSetMap) {\n+    byte[][] valueArray = blockValSetMap.get(_expression).getBytesValuesSV();\n+    BigDecimal sumValue = getDefaultResult(aggregationResultHolder);\n+    for (int i = 0; i < length; i++) {\n+      BigDecimal value = new BigDecimal(DataTypeConversionFunctions.bytesToBigDecimal(valueArray[i]));\n+      sumValue = sumValue.add(value, _mathContext);\n+    }\n+    aggregationResultHolder.setValue(setScale(sumValue));\n+  }\n+\n+  @Override\n+  public void aggregateGroupBySV(int length, int[] groupKeyArray, GroupByResultHolder groupByResultHolder,\n+      Map<ExpressionContext, BlockValSet> blockValSetMap) {\n+    byte[][] valueArray = blockValSetMap.get(_expression).getBytesValuesSV();\n+    for (int i = 0; i < length; i++) {\n+      int groupKey = groupKeyArray[i];\n+      BigDecimal groupByResultValue = getDefaultResult(groupByResultHolder, groupKey);\n+      BigDecimal value = new BigDecimal(DataTypeConversionFunctions.bytesToBigDecimal(valueArray[i]));\n+      groupByResultValue = groupByResultValue.add(value, _mathContext);\n+      groupByResultHolder.setValueForKey(groupKey, setScale(groupByResultValue));\n+    }\n+  }\n+\n+  @Override\n+  public void aggregateGroupByMV(int length, int[][] groupKeysArray, GroupByResultHolder groupByResultHolder,\n+      Map<ExpressionContext, BlockValSet> blockValSetMap) {\n+    byte[][] valueArray = blockValSetMap.get(_expression).getBytesValuesSV();\n+    for (int i = 0; i < length; i++) {\n+      byte[] value = valueArray[i];\n+      for (int groupKey : groupKeysArray[i]) {\n+        BigDecimal groupByResultValue = getDefaultResult(groupByResultHolder, groupKey);\n+        BigDecimal valueBigDecimal = new BigDecimal(DataTypeConversionFunctions.bytesToBigDecimal(value));\n+        groupByResultValue = groupByResultValue.add(valueBigDecimal, _mathContext);\n+        groupByResultHolder.setValueForKey(groupKey, setScale(groupByResultValue));\n+      }\n+    }\n+  }\n+\n+  @Override\n+  public BigDecimal extractAggregationResult(AggregationResultHolder aggregationResultHolder) {\n+    return getDefaultResult(aggregationResultHolder);\n+  }\n+\n+  @Override\n+  public BigDecimal extractGroupByResult(GroupByResultHolder groupByResultHolder, int groupKey) {\n+    return getDefaultResult(groupByResultHolder, groupKey);\n+  }\n+\n+  @Override\n+  public BigDecimal merge(BigDecimal intermediateResult1, BigDecimal intermediateResult2) {\n+    try {\n+      return setScale(intermediateResult1.add(intermediateResult2, _mathContext));\n+    } catch (Exception e) {\n+      throw new RuntimeException(\"Caught Exception while merging results in sum with precision function\", e);\n+    }\n+  }\n+\n+  @Override\n+  public boolean isIntermediateResultComparable() {\n+    return true;\n+  }\n+\n+  @Override\n+  public DataSchema.ColumnDataType getIntermediateResultColumnType() {\n+    return DataSchema.ColumnDataType.OBJECT;\n+  }\n+\n+  @Override\n+  public DataSchema.ColumnDataType getFinalResultColumnType() {\n+    return DataSchema.ColumnDataType.STRING;\n+  }\n+\n+  @Override\n+  public BigDecimal extractFinalResult(BigDecimal intermediateResult) {\n+    return intermediateResult;\n+  }\n+\n+  public BigDecimal getDefaultResult(AggregationResultHolder aggregationResultHolder) {\n+    BigDecimal result = aggregationResultHolder.getResult();\n+    if (result == null) {\n+      result = new BigDecimal(0, _mathContext);\n+      aggregationResultHolder.setValue(result);\n+    }\n+    result = setScale(result);\n+    return result;\n+  }\n+\n+  public BigDecimal getDefaultResult(GroupByResultHolder groupByResultHolder, int groupKey) {\n+    BigDecimal result = groupByResultHolder.getResult(groupKey);\n+    if (result == null) {\n+      result = new BigDecimal(0, _mathContext);\n+      groupByResultHolder.setValueForKey(groupKey, result);\n+    }\n+    result = setScale(result);\n+    return result;\n+  }\n+\n+  private BigDecimal setScale(BigDecimal value) {", "originalCommit": "a57903c92b2a89d908ad6bd33b02f3773d4b8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2ODU4Nw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r496868587", "bodyText": "If the user doesn't set scale, then just return the value as such otherwise set the scale value.\nJust a small helper method to avoid if else in the code.", "author": "KKcorps", "createdAt": "2020-09-29T16:19:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2MTkxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA1NTQ2OA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497055468", "bodyText": "got it. I am assuming big decimal additions are idempotent -- bd1 + bd2 same as bd2 + bd1", "author": "kishoreg", "createdAt": "2020-09-29T21:01:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2MTkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE5OTE4OQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497199189", "bodyText": "For better performance, avoid the for loop\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                for (int i = 0; i < 4; i++) {\n          \n          \n            \n                  bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n          \n          \n            \n                }\n          \n          \n            \n                bigDecimalBytesArray[0] = (byte) scale >>> 24;\n          \n          \n            \n                bigDecimalBytesArray[1] = (byte) scale >>> 16;\n          \n          \n            \n                bigDecimalBytesArray[2] = (byte) scale >>> 8;\n          \n          \n            \n                bigDecimalBytesArray[3] = (byte) scale;", "author": "Jackie-Jiang", "createdAt": "2020-09-30T01:51:43Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.util.Base64;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwOTY4Ng==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497209686", "bodyText": "Actually, after another thought, I don't think we need to use 4 bytes for the scale. Scale larger than 256 doesn't make lots of sense.", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE5OTE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MTU3NQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497551575", "bodyText": "Won't the loop be unrolled anyways? Reduced the bytes to 2", "author": "KKcorps", "createdAt": "2020-09-30T14:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE5OTE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY5NDEwMw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497694103", "bodyText": "let's not try to optimize this for now. we can consider these optimizations when we add first class support for bigdecimal type", "author": "kishoreg", "createdAt": "2020-09-30T17:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE5OTE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMTAxMA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497201010", "bodyText": "Similarly here", "author": "Jackie-Jiang", "createdAt": "2020-09-30T01:59:09Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.util.Base64;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {\n+    int scale = 0;\n+    for (int i = 0; i < 4; i++) {", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MTIwNg==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497551206", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-09-30T14:23:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMTAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMTU2NQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497201565", "bodyText": "Recommend passing in String instead of BigDecimal for symmetry with bytesToBigDecimal(). Also, scaler transform function won't work on BigDecimal objects.", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:01:35Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.util.Base64;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MTE0MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497551141", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-09-30T14:23:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMjEzMw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497202133", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static String base64Encode(String input) {\n          \n          \n            \n                return Base64.getEncoder().encodeToString(input.getBytes());\n          \n          \n            \n              }\n          \n          \n            \n              public static byte[] base64Encode(byte[] bytes) {\n          \n          \n            \n                return Base64.getEncoder().encodeToString(bytes);\n          \n          \n            \n              }", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:04:04Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.util.Base64;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {\n+    int scale = 0;\n+    for (int i = 0; i < 4; i++) {\n+      scale += (((int) bytes[i]) << (8 * (3 - i)));\n+    }\n+    byte[] vals = new byte[bytes.length - 4];\n+    System.arraycopy(bytes, 4, vals, 0, vals.length);\n+    BigInteger unscaled = new BigInteger(vals);\n+    BigDecimal number = new BigDecimal(unscaled, scale);\n+    return number.toString();\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalFromString(String bigDecimal) {\n+    return bigDecimalToBytes(new BigDecimal(bigDecimal));\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] hexToBytes(String hex) {\n+    int len = hex.length();\n+    byte[] data = new byte[len / 2];\n+    for (int i = 0; i < len; i += 2) {\n+      data[i / 2] = (byte) ((Character.digit(hex.charAt(i), 16) << 4) + Character.digit(hex.charAt(i + 1), 16));\n+    }\n+    return data;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToHex(byte[] bytes) {\n+    StringBuilder sb = new StringBuilder();\n+    for (byte b : bytes) {\n+      sb.append(String.format(\"%02X \", b));\n+    }\n+\n+    return sb.toString();\n+  }\n+\n+  @ScalarFunction\n+  public static String base64Encode(String input) {\n+    return Base64.getEncoder().encodeToString(input.getBytes());\n+  }", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MTA1MA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497551050", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-09-30T14:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMjEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMjM4OQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497202389", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static String base64Decode(String input) {\n          \n          \n            \n                return new String(Base64.getDecoder().decode(input.getBytes()));\n          \n          \n            \n              }\n          \n          \n            \n              public static byte[] base64Decode(String input) {\n          \n          \n            \n                return Base64.getDecoder().decode(input);\n          \n          \n            \n              }", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:05:16Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.util.Base64;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {\n+    int scale = 0;\n+    for (int i = 0; i < 4; i++) {\n+      scale += (((int) bytes[i]) << (8 * (3 - i)));\n+    }\n+    byte[] vals = new byte[bytes.length - 4];\n+    System.arraycopy(bytes, 4, vals, 0, vals.length);\n+    BigInteger unscaled = new BigInteger(vals);\n+    BigDecimal number = new BigDecimal(unscaled, scale);\n+    return number.toString();\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalFromString(String bigDecimal) {\n+    return bigDecimalToBytes(new BigDecimal(bigDecimal));\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] hexToBytes(String hex) {\n+    int len = hex.length();\n+    byte[] data = new byte[len / 2];\n+    for (int i = 0; i < len; i += 2) {\n+      data[i / 2] = (byte) ((Character.digit(hex.charAt(i), 16) << 4) + Character.digit(hex.charAt(i + 1), 16));\n+    }\n+    return data;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToHex(byte[] bytes) {\n+    StringBuilder sb = new StringBuilder();\n+    for (byte b : bytes) {\n+      sb.append(String.format(\"%02X \", b));\n+    }\n+\n+    return sb.toString();\n+  }\n+\n+  @ScalarFunction\n+  public static String base64Encode(String input) {\n+    return Base64.getEncoder().encodeToString(input.getBytes());\n+  }\n+\n+  @ScalarFunction\n+  public static String base64Decode(String input) {\n+    return new String(Base64.getDecoder().decode(input.getBytes()));\n+  }", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MDk4NQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497550985", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-09-30T14:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMjM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMjcyNA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497202724", "bodyText": "You may use BytesUtils.toBytes(hex)", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:06:49Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.util.Base64;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {\n+    int scale = 0;\n+    for (int i = 0; i < 4; i++) {\n+      scale += (((int) bytes[i]) << (8 * (3 - i)));\n+    }\n+    byte[] vals = new byte[bytes.length - 4];\n+    System.arraycopy(bytes, 4, vals, 0, vals.length);\n+    BigInteger unscaled = new BigInteger(vals);\n+    BigDecimal number = new BigDecimal(unscaled, scale);\n+    return number.toString();\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalFromString(String bigDecimal) {\n+    return bigDecimalToBytes(new BigDecimal(bigDecimal));\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] hexToBytes(String hex) {\n+    int len = hex.length();", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMjg3Mw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497202873", "bodyText": "BytesUtils.toHexString(bytes)", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:07:24Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/scalar/DataTypeConversionFunctions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.function.scalar;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.util.Base64;\n+import org.apache.pinot.spi.annotations.ScalarFunction;\n+\n+\n+public class DataTypeConversionFunctions {\n+  private DataTypeConversionFunctions() {\n+\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalToBytes(BigDecimal number) {\n+    int scale = number.scale();\n+    BigInteger unscaled = number.unscaledValue();\n+    byte[] value = unscaled.toByteArray();\n+    byte[] bigDecimalBytesArray = new byte[value.length + 4];\n+    for (int i = 0; i < 4; i++) {\n+      bigDecimalBytesArray[i] = (byte) (scale >>> (8 * (3 - i)));\n+    }\n+    System.arraycopy(value, 0, bigDecimalBytesArray, 4, value.length);\n+    return bigDecimalBytesArray;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToBigDecimal(byte[] bytes) {\n+    int scale = 0;\n+    for (int i = 0; i < 4; i++) {\n+      scale += (((int) bytes[i]) << (8 * (3 - i)));\n+    }\n+    byte[] vals = new byte[bytes.length - 4];\n+    System.arraycopy(bytes, 4, vals, 0, vals.length);\n+    BigInteger unscaled = new BigInteger(vals);\n+    BigDecimal number = new BigDecimal(unscaled, scale);\n+    return number.toString();\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] bigDecimalFromString(String bigDecimal) {\n+    return bigDecimalToBytes(new BigDecimal(bigDecimal));\n+  }\n+\n+  @ScalarFunction\n+  public static byte[] hexToBytes(String hex) {\n+    int len = hex.length();\n+    byte[] data = new byte[len / 2];\n+    for (int i = 0; i < len; i += 2) {\n+      data[i / 2] = (byte) ((Character.digit(hex.charAt(i), 16) << 4) + Character.digit(hex.charAt(i + 1), 16));\n+    }\n+    return data;\n+  }\n+\n+  @ScalarFunction\n+  public static String bytesToHex(byte[] bytes) {\n+    StringBuilder sb = new StringBuilder();", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwMzQ5MA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497203490", "bodyText": "Make these 2 variables private final because the aggregation function can be shared among multiple segments, and needs to be stateless.", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:09:55Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/SumWithPrecisionAggregationFunction.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+\n+\n+public class SumWithPrecisionAggregationFunction extends BaseSingleInputAggregationFunction<BigDecimal, BigDecimal> {\n+  MathContext _mathContext = new MathContext(0);", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwNDA4Ng==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497204086", "bodyText": "Suggest adding a util class for BigDecimal (the scalar function can also call the util class). Here we should avoid converting BigDecimal to String and back again", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:12:13Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/SumWithPrecisionAggregationFunction.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+\n+\n+public class SumWithPrecisionAggregationFunction extends BaseSingleInputAggregationFunction<BigDecimal, BigDecimal> {\n+  MathContext _mathContext = new MathContext(0);\n+  Integer _scale = null;\n+\n+  public SumWithPrecisionAggregationFunction(ExpressionContext expression, List<ExpressionContext> arguments) {\n+    super(expression);\n+    int numArguments = arguments.size();\n+\n+    if (numArguments == 3) {\n+      Integer precision = Integer.parseInt(arguments.get(1).getLiteral());\n+      _scale = Integer.parseInt(arguments.get(2).getLiteral());\n+      _mathContext = new MathContext(precision);\n+    } else if (numArguments == 2) {\n+      Integer precision = Integer.parseInt(arguments.get(1).getLiteral());\n+      _mathContext = new MathContext(precision);\n+    }\n+  }\n+\n+  @Override\n+  public AggregationFunctionType getType() {\n+    return AggregationFunctionType.SUMPRECISION;\n+  }\n+\n+  @Override\n+  public AggregationResultHolder createAggregationResultHolder() {\n+    return new ObjectAggregationResultHolder();\n+  }\n+\n+  @Override\n+  public GroupByResultHolder createGroupByResultHolder(int initialCapacity, int maxCapacity) {\n+    return new ObjectGroupByResultHolder(initialCapacity, maxCapacity);\n+  }\n+\n+  @Override\n+  public void aggregate(int length, AggregationResultHolder aggregationResultHolder,\n+      Map<ExpressionContext, BlockValSet> blockValSetMap) {\n+    byte[][] valueArray = blockValSetMap.get(_expression).getBytesValuesSV();\n+    BigDecimal sumValue = getDefaultResult(aggregationResultHolder);\n+    for (int i = 0; i < length; i++) {\n+      BigDecimal value = new BigDecimal(DataTypeConversionFunctions.bytesToBigDecimal(valueArray[i]));", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2NDUyMA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497564520", "bodyText": "I don't understand.  What problem would Util class solve?", "author": "KKcorps", "createdAt": "2020-09-30T14:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwNDA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxMTE4OQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497711189", "bodyText": "DataTypeConversionFunctions.bytesToBigDecimal() first creates the BigDecimal, then create a String from it. Here we convert String back to BigDecimal again. Instead, we can have a util method to get BigDecimal from byte[] to avoid the unnecessary BigDecimal -> String -> BigDecimal.", "author": "Jackie-Jiang", "createdAt": "2020-09-30T18:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwNDA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwNTE0MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497205141", "bodyText": "Please add some javadoc on the arguments expected for the function.\nAlso recommend renaming it to SumPrecisionAggregationFunction to match the function name", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:16:39Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/SumWithPrecisionAggregationFunction.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+\n+\n+public class SumWithPrecisionAggregationFunction extends BaseSingleInputAggregationFunction<BigDecimal, BigDecimal> {", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MTE4Nw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497561187", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-09-30T14:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwNTE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwNTMyMg==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497205322", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public SumWithPrecisionAggregationFunction(ExpressionContext expression, List<ExpressionContext> arguments) {\n          \n          \n            \n                super(expression);\n          \n          \n            \n              public SumWithPrecisionAggregationFunction(List<ExpressionContext> arguments) {\n          \n          \n            \n                super(arguments.get(0));", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:17:20Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/SumWithPrecisionAggregationFunction.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+\n+\n+public class SumWithPrecisionAggregationFunction extends BaseSingleInputAggregationFunction<BigDecimal, BigDecimal> {\n+  MathContext _mathContext = new MathContext(0);\n+  Integer _scale = null;\n+\n+  public SumWithPrecisionAggregationFunction(ExpressionContext expression, List<ExpressionContext> arguments) {\n+    super(expression);", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MDUyNA==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497550524", "bodyText": "done.", "author": "KKcorps", "createdAt": "2020-09-30T14:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwNTMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwOTA0MQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497209041", "bodyText": "To get the consistent result, we should either set the scale at the end (in extractFinalResult) or for each value. I think setting it in extractFinalResult should give better performance.", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:32:42Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/SumWithPrecisionAggregationFunction.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+\n+\n+public class SumWithPrecisionAggregationFunction extends BaseSingleInputAggregationFunction<BigDecimal, BigDecimal> {\n+  MathContext _mathContext = new MathContext(0);\n+  Integer _scale = null;\n+\n+  public SumWithPrecisionAggregationFunction(ExpressionContext expression, List<ExpressionContext> arguments) {\n+    super(expression);\n+    int numArguments = arguments.size();\n+\n+    if (numArguments == 3) {\n+      Integer precision = Integer.parseInt(arguments.get(1).getLiteral());\n+      _scale = Integer.parseInt(arguments.get(2).getLiteral());\n+      _mathContext = new MathContext(precision);\n+    } else if (numArguments == 2) {\n+      Integer precision = Integer.parseInt(arguments.get(1).getLiteral());\n+      _mathContext = new MathContext(precision);\n+    }\n+  }\n+\n+  @Override\n+  public AggregationFunctionType getType() {\n+    return AggregationFunctionType.SUMPRECISION;\n+  }\n+\n+  @Override\n+  public AggregationResultHolder createAggregationResultHolder() {\n+    return new ObjectAggregationResultHolder();\n+  }\n+\n+  @Override\n+  public GroupByResultHolder createGroupByResultHolder(int initialCapacity, int maxCapacity) {\n+    return new ObjectGroupByResultHolder(initialCapacity, maxCapacity);\n+  }\n+\n+  @Override\n+  public void aggregate(int length, AggregationResultHolder aggregationResultHolder,\n+      Map<ExpressionContext, BlockValSet> blockValSetMap) {\n+    byte[][] valueArray = blockValSetMap.get(_expression).getBytesValuesSV();\n+    BigDecimal sumValue = getDefaultResult(aggregationResultHolder);\n+    for (int i = 0; i < length; i++) {\n+      BigDecimal value = new BigDecimal(DataTypeConversionFunctions.bytesToBigDecimal(valueArray[i]));\n+      sumValue = sumValue.add(value, _mathContext);\n+    }\n+    aggregationResultHolder.setValue(setScale(sumValue));", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MDQyMw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497550423", "bodyText": "resolved.", "author": "KKcorps", "createdAt": "2020-09-30T14:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwOTA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwOTE1OQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497209159", "bodyText": "We might also want to support string type as the BigDecimal values?", "author": "Jackie-Jiang", "createdAt": "2020-09-30T02:33:11Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/SumWithPrecisionAggregationFunction.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import java.math.BigDecimal;\n+import java.math.MathContext;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.scalar.DataTypeConversionFunctions;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+\n+\n+public class SumWithPrecisionAggregationFunction extends BaseSingleInputAggregationFunction<BigDecimal, BigDecimal> {\n+  MathContext _mathContext = new MathContext(0);\n+  Integer _scale = null;\n+\n+  public SumWithPrecisionAggregationFunction(ExpressionContext expression, List<ExpressionContext> arguments) {\n+    super(expression);\n+    int numArguments = arguments.size();\n+\n+    if (numArguments == 3) {\n+      Integer precision = Integer.parseInt(arguments.get(1).getLiteral());\n+      _scale = Integer.parseInt(arguments.get(2).getLiteral());\n+      _mathContext = new MathContext(precision);\n+    } else if (numArguments == 2) {\n+      Integer precision = Integer.parseInt(arguments.get(1).getLiteral());\n+      _mathContext = new MathContext(precision);\n+    }\n+  }\n+\n+  @Override\n+  public AggregationFunctionType getType() {\n+    return AggregationFunctionType.SUMPRECISION;\n+  }\n+\n+  @Override\n+  public AggregationResultHolder createAggregationResultHolder() {\n+    return new ObjectAggregationResultHolder();\n+  }\n+\n+  @Override\n+  public GroupByResultHolder createGroupByResultHolder(int initialCapacity, int maxCapacity) {\n+    return new ObjectGroupByResultHolder(initialCapacity, maxCapacity);\n+  }\n+\n+  @Override\n+  public void aggregate(int length, AggregationResultHolder aggregationResultHolder,\n+      Map<ExpressionContext, BlockValSet> blockValSetMap) {\n+    byte[][] valueArray = blockValSetMap.get(_expression).getBytesValuesSV();", "originalCommit": "d3add2ca32446c40a8cf2a81e88f05de324510a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2NTI1NQ==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497565255", "bodyText": "That can be done later when we implement full-fledged Big decimal support in DB itself.", "author": "KKcorps", "createdAt": "2020-09-30T14:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwOTE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxMjgyNg==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r497712826", "bodyText": "I feel string type is easier to use compared to bytes, where the raw data is the numeric strings", "author": "Jackie-Jiang", "createdAt": "2020-09-30T18:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwOTE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzNjQ2Mw==", "url": "https://github.com/apache/pinot/pull/6053#discussion_r498436463", "bodyText": "ok. added the methods in the existing class itself.", "author": "KKcorps", "createdAt": "2020-10-01T18:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIwOTE1OQ=="}], "type": "inlineReview"}, {"oid": "5ce9d70fe3161fb7cd0b48ec593077d9813c88a2", "url": "https://github.com/apache/pinot/commit/5ce9d70fe3161fb7cd0b48ec593077d9813c88a2", "message": "Add support for big decimal", "committedDate": "2020-09-30T14:41:59Z", "type": "commit"}, {"oid": "21e554affb0e3e49778498557015cfd82e3fd180", "url": "https://github.com/apache/pinot/commit/21e554affb0e3e49778498557015cfd82e3fd180", "message": "Add transform function to factory", "committedDate": "2020-09-30T14:41:59Z", "type": "commit"}, {"oid": "e657b4b01ac8b36f5ae43ceae189eddac966065a", "url": "https://github.com/apache/pinot/commit/e657b4b01ac8b36f5ae43ceae189eddac966065a", "message": "Add support for decimal with precision addition", "committedDate": "2020-09-30T14:41:59Z", "type": "commit"}, {"oid": "ff675d5c3a1ac3aa905653a2b3fbc199d7c47d66", "url": "https://github.com/apache/pinot/commit/ff675d5c3a1ac3aa905653a2b3fbc199d7c47d66", "message": "Add license header", "committedDate": "2020-09-30T14:41:59Z", "type": "commit"}, {"oid": "39a7e8cbf52f9a41ac57f58b9d04564c7ba4881f", "url": "https://github.com/apache/pinot/commit/39a7e8cbf52f9a41ac57f58b9d04564c7ba4881f", "message": "Add Sum Precision aggregation function", "committedDate": "2020-09-30T14:49:40Z", "type": "commit"}, {"oid": "b37d215554fa9f5b25ad9154a3442f89567f04c2", "url": "https://github.com/apache/pinot/commit/b37d215554fa9f5b25ad9154a3442f89567f04c2", "message": "Remove add with precision transform function", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "2c6ada3e46678a63e8ae13dc6d99375ce5c084a9", "url": "https://github.com/apache/pinot/commit/2c6ada3e46678a63e8ae13dc6d99375ce5c084a9", "message": "Add license header", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "d1f6d4a55157fec896eb5cf24ef749b7abdf967c", "url": "https://github.com/apache/pinot/commit/d1f6d4a55157fec896eb5cf24ef749b7abdf967c", "message": "Refactor: Correct import of Scalar function", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "600f66e9e67de527ba9cf613b5de5aaa3d3d0ad9", "url": "https://github.com/apache/pinot/commit/600f66e9e67de527ba9cf613b5de5aaa3d3d0ad9", "message": "Add function to convert normal string to bigdecimal bytes", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "77f4c9c8af7f196b096fe1307544f76971924a5a", "url": "https://github.com/apache/pinot/commit/77f4c9c8af7f196b096fe1307544f76971924a5a", "message": "Add test for big decimal", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "ea2f2b8733a4d293dc17cb153cbaf05ec1e616a7", "url": "https://github.com/apache/pinot/commit/ea2f2b8733a4d293dc17cb153cbaf05ec1e616a7", "message": "Add test for big decimal precision", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "eab40e28de67f9062ec0667330ab218c66dc8512", "url": "https://github.com/apache/pinot/commit/eab40e28de67f9062ec0667330ab218c66dc8512", "message": "Add support for scale along with precision", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "90d32dc02aba9c24fe74ef1b5fefde0c78397326", "url": "https://github.com/apache/pinot/commit/90d32dc02aba9c24fe74ef1b5fefde0c78397326", "message": "Add license header", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "988117ebecbf0db5caba1476369c419513957221", "url": "https://github.com/apache/pinot/commit/988117ebecbf0db5caba1476369c419513957221", "message": "Add base64 encode functions", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "38e146e1375ee1efed8ab98a234867efd6f75203", "url": "https://github.com/apache/pinot/commit/38e146e1375ee1efed8ab98a234867efd6f75203", "message": "typo fix", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "74f1e556774c99a4260da2d310c9f6e48ebfffd6", "url": "https://github.com/apache/pinot/commit/74f1e556774c99a4260da2d310c9f6e48ebfffd6", "message": "Move arguments logic inside constructor", "committedDate": "2020-09-30T14:49:41Z", "type": "commit"}, {"oid": "ae39b94c0dd3bf0b2e4fce8e005fee9d72c86a69", "url": "https://github.com/apache/pinot/commit/ae39b94c0dd3bf0b2e4fce8e005fee9d72c86a69", "message": "set scale and precision only in final result", "committedDate": "2020-09-30T14:51:17Z", "type": "commit"}, {"oid": "d3552991857936582db1644c4b570f8fcd582edd", "url": "https://github.com/apache/pinot/commit/d3552991857936582db1644c4b570f8fcd582edd", "message": "Reduce scale bytes from 4 to 2", "committedDate": "2020-09-30T14:51:17Z", "type": "commit"}, {"oid": "ec686cfc09f4ec8aa760a121ca545f7b63e3637f", "url": "https://github.com/apache/pinot/commit/ec686cfc09f4ec8aa760a121ca545f7b63e3637f", "message": "Add java docs for sum with precision function", "committedDate": "2020-09-30T14:51:17Z", "type": "commit"}, {"oid": "a43d2d73fa0894e948a4da992f198feb972002f8", "url": "https://github.com/apache/pinot/commit/a43d2d73fa0894e948a4da992f198feb972002f8", "message": "Rename sumWithPrecision to sumPrecision", "committedDate": "2020-09-30T14:51:17Z", "type": "commit"}, {"oid": "a43d2d73fa0894e948a4da992f198feb972002f8", "url": "https://github.com/apache/pinot/commit/a43d2d73fa0894e948a4da992f198feb972002f8", "message": "Rename sumWithPrecision to sumPrecision", "committedDate": "2020-09-30T14:51:17Z", "type": "forcePushed"}, {"oid": "ac95efc89098851a0772304ebb4270cccbb2eb35", "url": "https://github.com/apache/pinot/commit/ac95efc89098851a0772304ebb4270cccbb2eb35", "message": "Adding methods to directly take big decimal input", "committedDate": "2020-10-01T18:22:39Z", "type": "commit"}]}