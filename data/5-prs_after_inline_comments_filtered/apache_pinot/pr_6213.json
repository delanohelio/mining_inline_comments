{"pr_number": 6213, "pr_title": "[Upsert] Preserve the newer added record when 2 records have the same timestamp", "pr_createdAt": "2020-10-30T02:30:12Z", "pr_url": "https://github.com/apache/pinot/pull/6213", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwMjEwOQ==", "url": "https://github.com/apache/pinot/pull/6213#discussion_r514902109", "bodyText": "Can you update this line of comments? It is a bit hard to understand. Do you mean:\n\"\u2026, where we want to\" =>. In this case, we want to update the record location when there is a tie\u2026\nalso when this is a tie, how to you update the record location? Should it be determined by docID?", "author": "chenboat", "createdAt": "2020-10-30T06:54:14Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/upsert/PartitionUpsertMetadataManager.java", "diffHunk": "@@ -83,34 +87,34 @@ public ThreadSafeMutableRoaringBitmap addSegment(String segmentName, Iterator<Re\n           if (segmentName.equals(currentRecordLocation.getSegmentName())) {\n             // The current record location has the same segment name\n \n-            if (validDocIds == currentRecordLocation.getValidDocIds()) {\n-              // The current record location is pointing to the new segment being loaded\n-\n-              // Update the record location when getting a newer timestamp\n-              if (recordInfo._timestamp > currentRecordLocation.getTimestamp()) {\n+            // Update the record location when the new timestamp is greater than or equal to the current timestamp.\n+            // There are 2 scenarios:\n+            //   1. The current record location is pointing to the new segment being loaded, where we want to update the", "originalCommit": "089dac2b0f2b97865b4c8f17fd5ce2b6a730cfd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI4MzM2MA==", "url": "https://github.com/apache/pinot/pull/6213#discussion_r515283360", "bodyText": "Rephrased the comments.\nThe iterator will return records with incremental doc ids, so we don't need to compare docId here.", "author": "Jackie-Jiang", "createdAt": "2020-10-30T17:56:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwMjEwOQ=="}], "type": "inlineReview"}, {"oid": "6e632601f7ae709398eca33d22d872098770d34f", "url": "https://github.com/apache/pinot/commit/6e632601f7ae709398eca33d22d872098770d34f", "message": "[Upsert] Preserve the newer added record when 2 records have the same timestamp", "committedDate": "2020-10-30T17:57:04Z", "type": "commit"}, {"oid": "6e632601f7ae709398eca33d22d872098770d34f", "url": "https://github.com/apache/pinot/commit/6e632601f7ae709398eca33d22d872098770d34f", "message": "[Upsert] Preserve the newer added record when 2 records have the same timestamp", "committedDate": "2020-10-30T17:57:04Z", "type": "forcePushed"}]}