{"pr_number": 5728, "pr_title": "Add segment lineage based segment selector", "pr_createdAt": "2020-07-22T12:09:35Z", "pr_url": "https://github.com/apache/pinot/pull/5728", "timeline": [{"oid": "43f6837ea7d3d4d0068c23ca6a8fa9274557bd02", "url": "https://github.com/apache/pinot/commit/43f6837ea7d3d4d0068c23ca6a8fa9274557bd02", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data.", "committedDate": "2020-07-22T13:52:21Z", "type": "forcePushed"}, {"oid": "3a2938be4586a898b096e300cc60626e0ffd1ffa", "url": "https://github.com/apache/pinot/commit/3a2938be4586a898b096e300cc60626e0ffd1ffa", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data.", "committedDate": "2020-07-22T14:07:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMzU3OA==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r459033578", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;\n          \n          \n            \n              private final SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;", "author": "Jackie-Jiang", "createdAt": "2020-07-22T19:32:14Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/OfflineSegmentSelector.java", "diffHunk": "@@ -30,10 +31,17 @@\n  * Segment selector for offline table.\n  */\n public class OfflineSegmentSelector implements SegmentSelector {\n+  private SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;", "originalCommit": "3a2938be4586a898b096e300cc60626e0ffd1ffa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0NDA2Mg==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r459044062", "bodyText": "Don't implement SegmentSelector because it is not actually a segment selector, but a component inside the segment selector.\nYou may re-design the methods for this class to make it easier to use, e.g. public Set<String> refreshLinage(Set<String> onlineSegments); which returns the candidate segments based on the linage", "author": "Jackie-Jiang", "createdAt": "2020-07-22T19:51:53Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentSelector.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.model.ExternalView;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+import org.apache.pinot.common.request.BrokerRequest;\n+\n+\n+public class SegmentLineageBasedSegmentSelector implements SegmentSelector {", "originalCommit": "3a2938be4586a898b096e300cc60626e0ffd1ffa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0NDU1Ng==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r459044556", "bodyText": "Table name in table config always have the suffix\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String tableNameWithType =\n          \n          \n            \n                    TableNameBuilder.forType(tableConfig.getTableType()).tableNameWithType(tableConfig.getTableName());\n          \n          \n            \n                String tableNameWithType = tableConfig.getTableName();", "author": "Jackie-Jiang", "createdAt": "2020-07-22T19:52:46Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentSelectorFactory.java", "diffHunk": "@@ -17,19 +17,25 @@\n  * under the License.\n  */\n package org.apache.pinot.broker.routing.segmentselector;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n import org.apache.pinot.spi.config.table.TableConfig;\n import org.apache.pinot.spi.config.table.TableType;\n+import org.apache.pinot.spi.utils.builder.TableNameBuilder;\n \n \n public class SegmentSelectorFactory {\n   private SegmentSelectorFactory() {\n   }\n \n-  public static SegmentSelector getSegmentSelector(TableConfig tableConfig) {\n+  public static SegmentSelector getSegmentSelector(TableConfig tableConfig,\n+      ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    String tableNameWithType =\n+        TableNameBuilder.forType(tableConfig.getTableType()).tableNameWithType(tableConfig.getTableName());", "originalCommit": "3a2938be4586a898b096e300cc60626e0ffd1ffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0NjQyNw==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r459846427", "bodyText": "fixed", "author": "snleee", "createdAt": "2020-07-24T04:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0NDU1Ng=="}], "type": "inlineReview"}, {"oid": "c00ffbdbd998ba3a271684517a8317933971645d", "url": "https://github.com/apache/pinot/commit/c00ffbdbd998ba3a271684517a8317933971645d", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data.", "committedDate": "2020-07-24T04:38:11Z", "type": "forcePushed"}, {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162", "url": "https://github.com/apache/pinot/commit/d0c35445fff3432b5bf76ef2cba4e015bdf05162", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data.", "committedDate": "2020-07-24T05:02:13Z", "type": "commit"}, {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162", "url": "https://github.com/apache/pinot/commit/d0c35445fff3432b5bf76ef2cba4e015bdf05162", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data.", "committedDate": "2020-07-24T05:02:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODMyOQ==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r460408329", "bodyText": "This seems a bit confusing:\n\nOne segment selector class contains another segment segment selector.\nEven though both are named SegmentSelector, only one of them implements the SegmentSelector interface.\n\nI think SegmentLineageBasedSegmentSelector needs to be renamed, since it is not really implementing the interface.", "author": "mayankshriv", "createdAt": "2020-07-25T14:07:10Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/OfflineSegmentSelector.java", "diffHunk": "@@ -30,10 +30,17 @@\n  * Segment selector for offline table.\n  */\n public class OfflineSegmentSelector implements SegmentSelector {\n+  private final SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;", "originalCommit": "d0c35445fff3432b5bf76ef2cba4e015bdf05162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NDIwMA==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461064200", "bodyText": "+1", "author": "Jackie-Jiang", "createdAt": "2020-07-27T17:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5MTM0OA==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r462991348", "bodyText": "I adopted the SegmentPreSelector model.", "author": "snleee", "createdAt": "2020-07-30T13:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODc1Mg==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r460408752", "bodyText": "I am unclear on the extensibility of the code in future. Will we add more selectors and cascade them in future, for example versionBasedSelector/Pruner?", "author": "mayankshriv", "createdAt": "2020-07-25T14:12:40Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/OfflineSegmentSelector.java", "diffHunk": "@@ -42,7 +49,14 @@ public void onExternalViewChange(ExternalView externalView, Set<String> onlineSe\n     // TODO: for new added segments, before all replicas are up, consider not selecting them to avoid causing\n     //       hotspot servers\n \n-    _segments = Collections.unmodifiableList(new ArrayList<>(onlineSegments));\n+\n+    // Update segment lineage based segment selector\n+    _segmentLineageBasedSegmentSelector.onExternalViewChange();\n+\n+    // Compute the intersection of segments to process from both offline and segment lineage based segment selectors.\n+    List<String> segmentsToProcess =\n+        new ArrayList<>(_segmentLineageBasedSegmentSelector.computeSegmentsToProcess(onlineSegments));", "originalCommit": "d0c35445fff3432b5bf76ef2cba4e015bdf05162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4ODI5Ng==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461088296", "bodyText": "Another way is to model this as a SegmentPreselector which filters the onlineSegments before getting into the SegmentSelector", "author": "Jackie-Jiang", "createdAt": "2020-07-27T18:32:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2MTQ0MA==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461661440", "bodyText": "thinking out loud here, should we model them it as pruner?", "author": "kishoreg", "createdAt": "2020-07-28T15:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MTc1NQ==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461791755", "bodyText": "@kishoreg Based on the interface definition, I feel it is better to model it as SegmentSelector (The segments selected should cover the whole dataset (table) without overlap). Another benefit of putting it in Selector/Preselector is to avoid the per-query calculation within the Pruner", "author": "Jackie-Jiang", "createdAt": "2020-07-28T18:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4MTcwMg==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461081702", "bodyText": "You don't need to follow the interface for SegmentSelector. This class can be simplified into one method computeSegmentsToProcess() which fetches the lineage and filters the online segments.", "author": "Jackie-Jiang", "createdAt": "2020-07-27T18:20:35Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentSelector.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+public class SegmentLineageBasedSegmentSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  private volatile Set<String> _segmentsToRemove;\n+\n+  public SegmentLineageBasedSegmentSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  public void init() {", "originalCommit": "d0c35445fff3432b5bf76ef2cba4e015bdf05162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5MTI5OA==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r462991298", "bodyText": "I adopted the SegmentPreSelector model.", "author": "snleee", "createdAt": "2020-07-30T13:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4MTcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4NzQxMg==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461087412", "bodyText": "(Not related to this PR) Before updating lineage to COMPLETED, we might need to check whether all the segments on the right side has turned ONLINE in external view, or we might end up querying partial data", "author": "Jackie-Jiang", "createdAt": "2020-07-27T18:30:46Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentSelector.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+public class SegmentLineageBasedSegmentSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  private volatile Set<String> _segmentsToRemove;\n+\n+  public SegmentLineageBasedSegmentSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  public void init() {\n+    onExternalViewChange();\n+  }\n+\n+  public void onExternalViewChange() {\n+    // Fetch segment lineage\n+    SegmentLineage segmentLineage = SegmentLineageAccessHelper.getSegmentLineage(_propertyStore, _tableNameWithType);\n+    Set<String> segmentsToRemove = new HashSet<>();\n+    if (segmentLineage != null) {\n+      for (String lineageEntryId : segmentLineage.getLineageEntryIds()) {\n+        LineageEntry lineageEntry = segmentLineage.getLineageEntry(lineageEntryId);\n+        if (lineageEntry.getState() == LineageEntryState.COMPLETED) {", "originalCommit": "d0c35445fff3432b5bf76ef2cba4e015bdf05162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5MTAwNg==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r462991006", "bodyText": "I fixed the if check like the following:\n        if (lineageEntry.getState() == LineageEntryState.COMPLETED && onlineSegments\n            .containsAll(lineageEntry.getSegmentsTo())) {\n          segmentsToRemove.addAll(lineageEntry.getSegmentsFrom());\n        }", "author": "snleee", "createdAt": "2020-07-30T13:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4NzQxMg=="}], "type": "inlineReview"}, {"oid": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "url": "https://github.com/apache/pinot/commit/8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "message": "Added SegmentPreSelector interface", "committedDate": "2020-07-30T13:31:28Z", "type": "commit"}, {"oid": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "url": "https://github.com/apache/pinot/commit/8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "message": "Added SegmentPreSelector interface", "committedDate": "2020-07-30T13:31:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4Mjk2MA==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463182960", "bodyText": "Pre-select onlineSegments before calling init on other components", "author": "Jackie-Jiang", "createdAt": "2020-07-30T18:14:49Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/RoutingManager.java", "diffHunk": "@@ -312,6 +314,8 @@ public synchronized void buildRouting(String tableNameWithType) {\n \n     Set<String> enabledInstances = _enabledServerInstanceMap.keySet();\n \n+    SegmentPreSelector segmentPreSelector =\n+        SegmentPreSelectorFactory.getSegmentPreSelector(tableConfig, _propertyStore);", "originalCommit": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyNjkyNw==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463326927", "bodyText": "good catch :)", "author": "snleee", "createdAt": "2020-07-30T23:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4Mjk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4NjUxNQ==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463186515", "bodyText": "Check lineage before creating segmentsToProcess and segmentsToRemove. If lineage does not exist, directly return onlineSegments to prevent unnecessary overhead.\n(Optional) Consider modifying onlineSegments in-place?", "author": "Jackie-Jiang", "createdAt": "2020-07-30T18:21:17Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentPreSelector.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+/**\n+ * Segment lineage based segment pre-selector\n+ *\n+ * This pre-selector reads the segment lineage metadata and filters out either merged segments or original segments\n+ * to make sure that the final segments contain no duplicate data.\n+ */\n+public class SegmentLineageBasedSegmentPreSelector implements SegmentPreSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  public SegmentLineageBasedSegmentPreSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  @Override\n+  public Set<String> preSelect(Set<String> onlineSegments) {\n+    Set<String> segmentsToProcess = new HashSet<>(onlineSegments);\n+    SegmentLineage segmentLineage = SegmentLineageAccessHelper.getSegmentLineage(_propertyStore, _tableNameWithType);\n+    Set<String> segmentsToRemove = new HashSet<>();\n+    if (segmentLineage != null) {", "originalCommit": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyOTA4Mw==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463329083", "bodyText": "changed to modify onlineSegments in-place and also changed the code to create segmentsToRemove only if the lineage entry is not null.", "author": "snleee", "createdAt": "2020-07-30T23:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4NjUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIwODQyMA==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463208420", "bodyText": "This won't work because the onlineSegments are from the idealState instead of the externalView. Also, it  won't be able to handle some corner cases.\nE.g. the lineage is as following, and one segment in segmentsB is unavailable\nsegmentsA -> segmentsB -> segmentsC\nThis algorithm will select both segmentsA and segmentsC, which will cause wrong result.\nI still think we should handle this when updating the lineage. Before updating the lineage to COMPLETED, we check whether all segmentsTo are available in externalView. Also, the updater needs to notify the broker to rebuild the routing because there might be no externalView change to trigger the lineage update.", "author": "Jackie-Jiang", "createdAt": "2020-07-30T19:02:23Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentPreSelector.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+/**\n+ * Segment lineage based segment pre-selector\n+ *\n+ * This pre-selector reads the segment lineage metadata and filters out either merged segments or original segments\n+ * to make sure that the final segments contain no duplicate data.\n+ */\n+public class SegmentLineageBasedSegmentPreSelector implements SegmentPreSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  public SegmentLineageBasedSegmentPreSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  @Override\n+  public Set<String> preSelect(Set<String> onlineSegments) {\n+    Set<String> segmentsToProcess = new HashSet<>(onlineSegments);\n+    SegmentLineage segmentLineage = SegmentLineageAccessHelper.getSegmentLineage(_propertyStore, _tableNameWithType);\n+    Set<String> segmentsToRemove = new HashSet<>();\n+    if (segmentLineage != null) {\n+      for (String lineageEntryId : segmentLineage.getLineageEntryIds()) {\n+        LineageEntry lineageEntry = segmentLineage.getLineageEntry(lineageEntryId);\n+        if (lineageEntry.getState() == LineageEntryState.COMPLETED && onlineSegments\n+            .containsAll(lineageEntry.getSegmentsTo())) {", "originalCommit": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyMzc1NA==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463323754", "bodyText": "Sorry for the confusion. I somehow assumed that onlineSegments are from external view but it's actually from the idealstate. As you also said, I also think that it's better to check the external view in endReplaceSegments, which updates the segment lineage and keep the segment pre-selector as simple as possible. I will revert this change and file the separate PR for this.", "author": "snleee", "createdAt": "2020-07-30T23:21:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIwODQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyODY3OQ==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463328679", "bodyText": "As for the edge case that you mentioned, the edge case is correctly covered if we check external view when updating the lineage and segment pre-selector only checks COMPLETED.\nThis means that once the validation passes and the lineage entry gets updated to COMPLETED, we will never fall back to the original segments (which makes sense because original segments need to be deleted by the retention manager soon).", "author": "snleee", "createdAt": "2020-07-30T23:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIwODQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzMzA0MQ==", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463333041", "bodyText": "(nit) You can directly remove them from onlineSegments", "author": "Jackie-Jiang", "createdAt": "2020-07-30T23:52:45Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentPreSelector.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+/**\n+ * Segment lineage based segment pre-selector\n+ *\n+ * This pre-selector reads the segment lineage metadata and filters out either merged segments or original segments\n+ * to make sure that the final segments contain no duplicate data.\n+ */\n+public class SegmentLineageBasedSegmentPreSelector implements SegmentPreSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  public SegmentLineageBasedSegmentPreSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  @Override\n+  public Set<String> preSelect(Set<String> onlineSegments) {\n+    SegmentLineage segmentLineage = SegmentLineageAccessHelper.getSegmentLineage(_propertyStore, _tableNameWithType);\n+    if (segmentLineage != null) {\n+      Set<String> segmentsToRemove = new HashSet<>();\n+      for (String lineageEntryId : segmentLineage.getLineageEntryIds()) {\n+        LineageEntry lineageEntry = segmentLineage.getLineageEntry(lineageEntryId);\n+        if (lineageEntry.getState() == LineageEntryState.COMPLETED) {\n+          segmentsToRemove.addAll(lineageEntry.getSegmentsFrom());", "originalCommit": "c929fd318626a9c2bf38c22557626b1585e581e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7622673b2e20734bf11855d071c387932c37b1ae", "url": "https://github.com/apache/pinot/commit/7622673b2e20734bf11855d071c387932c37b1ae", "message": "Addressing comments", "committedDate": "2020-07-31T00:13:04Z", "type": "forcePushed"}, {"oid": "bbd686152db0412c111f66c140890ba06820633e", "url": "https://github.com/apache/pinot/commit/bbd686152db0412c111f66c140890ba06820633e", "message": "Addressing comments", "committedDate": "2020-07-31T03:01:59Z", "type": "commit"}, {"oid": "bbd686152db0412c111f66c140890ba06820633e", "url": "https://github.com/apache/pinot/commit/bbd686152db0412c111f66c140890ba06820633e", "message": "Addressing comments", "committedDate": "2020-07-31T03:01:59Z", "type": "forcePushed"}]}