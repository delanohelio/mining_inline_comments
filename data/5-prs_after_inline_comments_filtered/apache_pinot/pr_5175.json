{"pr_number": 5175, "pr_title": "add pinot upsert features to pinot common", "pr_createdAt": "2020-03-24T04:55:17Z", "pr_url": "https://github.com/apache/pinot/pull/5175", "timeline": [{"oid": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "url": "https://github.com/apache/pinot/commit/723f08aa12074f83ac31fdfe09b8dc1f0254f942", "message": "update pinot upsert features to pinot common", "committedDate": "2020-03-24T04:42:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTM0NA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r396905344", "bodyText": "rename to IngestMode or just have a boolean enableUpsert?", "author": "kishoreg", "createdAt": "2020-03-24T05:10:35Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/config/TableConfig.java", "diffHunk": "@@ -75,6 +79,9 @@\n   private Map<InstancePartitionsType, InstanceAssignmentConfig> _instanceAssignmentConfigMap;\n   private List<FieldConfig> _fieldConfigList;\n \n+  @JsonPropertyDescription(value = \"The update semantic of the table, either append or upsert, default as append\")\n+  private UpdateSemantic _updateSemantic;", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2MDIzMw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397360233", "bodyText": "Is this for real-time? We already have push type of either APPEND or REFRESH for offline; aggregateMetrics for real-time. What does UPSERT stand for?", "author": "Jackie-Jiang", "createdAt": "2020-03-24T18:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2Mzc4Ng==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397563786", "bodyText": "@kishoreg I am thinking if using enum here will be more flexible in the case of future features changes or whatnot. Boolean seems to be only limiting two options and it might limit what other changes we might want to do with pinot. Please let me what you think. ingestionMode definitely sounds more explicit than what I am using here and I will definite consider about this.\n@Jackie-Jiang yes. So basically it is previous old design about we want to support update in pinot realtime ingestion by adding override by primary key (eg, a second message in Kafka with the same primary key represents the update of existing key instead of two records with the same primary key). Upsert stands for this new ingestion semantic (insert if no duplicated primary key, update if duplicate primary key). This feature will be applying to realtime table only", "author": "jamesyfshao", "createdAt": "2020-03-25T01:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTgwMQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r396905801", "bodyText": "where is this used?", "author": "kishoreg", "createdAt": "2020-03-24T05:12:33Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/config/TableNameBuilder.java", "diffHunk": "@@ -132,4 +132,19 @@ public static boolean isOfflineTableResource(String resourceName) {\n   public static boolean isRealtimeTableResource(String resourceName) {\n     return REALTIME.tableHasTypeSuffix(resourceName);\n   }\n+\n+  /**\n+   * ensure that table name ends with type info, if no, create one with the given type\n+   * @param tableName the name of the table\n+   * @param type the type of the table for it to fill in if the type info is missing\n+   * @return the table type name with the type info\n+   */\n+  public static String ensureTableNameWithType(String tableName, TableType type) {", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2MTY5Mg==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397361692", "bodyText": "Please use TableNameBuilder.forType(type).tableNameWithType(tableName)", "author": "Jackie-Jiang", "createdAt": "2020-03-24T18:10:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDg0NA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r401940844", "bodyText": "removed this method, @kishoreg this method is used in other components that I will submit PR later", "author": "jamesyfshao", "createdAt": "2020-04-01T22:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjAwNg==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r396906006", "bodyText": "what does this represent?", "author": "kishoreg", "createdAt": "2020-03-24T05:13:21Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/metrics/BrokerGauge.java", "diffHunk": "@@ -26,7 +26,8 @@\n  *\n  */\n public enum BrokerGauge implements AbstractMetrics.Gauge {\n-  QUERY_QUOTA_CAPACITY_UTILIZATION_RATE(\"tables\", false), NETTY_CONNECTION_CONNECT_TIME_MS(\"nettyConnection\", true);\n+  QUERY_QUOTA_CAPACITY_UTILIZATION_RATE(\"tables\", false), NETTY_CONNECTION_CONNECT_TIME_MS(\"nettyConnection\", true),\n+  TABLE_MIN_LOW_WATER_MARK(\"tables\", false);", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NDUxNw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397564517", "bodyText": "It represents how many table pinot broker is collecting the metrics for. The exact usage of the metrics will show up in later diffs", "author": "jamesyfshao", "createdAt": "2020-03-25T01:50:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNzc3Mw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r396907773", "bodyText": "what if the primary key is made up of two columns?", "author": "kishoreg", "createdAt": "2020-03-24T05:21:20Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -59,13 +65,28 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(Schema.class);\n \n   private String _schemaName;\n+\n+  // upsert related config\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private String _primaryKey;", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxMzc3Mg==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r396913772", "bodyText": "or multiple", "author": "kishoreg", "createdAt": "2020-03-24T05:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNzc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NDgxMw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397564813", "bodyText": "right now we don't have support for multiple primary keys. Do you think it will be an important feature to add multiple primary key support right now or you think it is fine to postpone it to later diff?", "author": "jamesyfshao", "createdAt": "2020-03-25T01:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNzc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYzMzA5Nw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397633097", "bodyText": "Better to design it for multiple, even if the implementation can handle only one primary key", "author": "kishoreg", "createdAt": "2020-03-25T06:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNzc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE1MzE4Ng==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r398153186", "bodyText": "don't have support for multiple primary keys\n\nThere will be some cases where multiple keys make sense right? Like in clickstream: userId and timestamp\nWill support for multiple keys be added later on?", "author": "ChethanUK", "createdAt": "2020-03-25T20:37:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNzc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYxMzgxNQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r402613815", "bodyText": "@kishoreg @ChethanUK I have changed the primary key in schema config to be a list instead of a single string. For now we are still performing check to ensure that primary key will be one and only one. However we should be able to change that once we have mulitple-primary-key support in place", "author": "jamesyfshao", "createdAt": "2020-04-02T21:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNzc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDM1OQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r396914359", "bodyText": "do we need all these things in Schema? What if we create a UpsertConfig in TableConfig to provide all the necessary information.", "author": "kishoreg", "createdAt": "2020-03-24T05:47:19Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -59,13 +65,28 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(Schema.class);\n \n   private String _schemaName;\n+\n+  // upsert related config\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private String _primaryKey;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NzUwMQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397567501", "bodyText": "definitely would be better this way, will submit a change later to update this", "author": "jamesyfshao", "createdAt": "2020-03-25T02:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDc2Mw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r396914763", "bodyText": "why is this needed? it will be great if we can avoid static methods in config objects. We can probably move this SchemaUtil", "author": "kishoreg", "createdAt": "2020-03-24T05:48:52Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -631,4 +751,50 @@ public int hashCode() {\n     result = EqualityUtils.hashCodeOf(result, _dateTimeFieldSpecs);\n     return result;\n   }\n+\n+  public boolean isVirtualColumn(String columnName) {\n+    return columnName.startsWith(\"$\") || (getFieldSpecFor(columnName).getVirtualColumnProvider() != null\n+        && !getFieldSpecFor(columnName).getVirtualColumnProvider().isEmpty());\n+  }\n+\n+\n+  @JsonIgnore\n+  public static byte[] getByteArrayFromField(Object value, DimensionFieldSpec fieldSpec) {", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3MTc5OA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397571798", "bodyText": "done.\nIt is used for converting a pinot column value into the appropriate binary representation for upsert primary key field. (make sure all primary key will become a byte array)", "author": "jamesyfshao", "createdAt": "2020-03-25T02:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNDc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NTU5MA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397355590", "bodyText": "Wrong import", "author": "Jackie-Jiang", "createdAt": "2020-03-24T18:00:25Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/config/TableConfig.java", "diffHunk": "@@ -30,17 +30,21 @@\n import java.util.List;\n import java.util.Map;\n import javax.annotation.Nullable;\n+import javax.validation.constraints.Null;", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3NzU4NA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397577584", "bodyText": "issue with merging, fixed. Thanks for pointing it out", "author": "jamesyfshao", "createdAt": "2020-03-25T02:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NTU5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1ODAwNA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397358004", "bodyText": "This can cause NPE", "author": "Jackie-Jiang", "createdAt": "2020-03-24T18:04:11Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/config/TableConfig.java", "diffHunk": "@@ -354,6 +387,7 @@ public ZNRecord toZNRecord()\n     }\n \n     ZNRecord znRecord = new ZNRecord(_tableName);\n+    simpleFields.put(UPDATE_SEMANTIC_CONFIG_KEY, _updateSemantic.toString());", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3NzQzNA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397577434", "bodyText": "updated to follow the convention of rest of the code", "author": "jamesyfshao", "createdAt": "2020-03-25T02:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1ODAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2MTk5NA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397361994", "bodyText": "Wrong order, please revert", "author": "Jackie-Jiang", "createdAt": "2020-03-24T18:10:50Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/metrics/AbstractMetrics.java", "diffHunk": "@@ -21,16 +21,17 @@\n import com.google.common.annotations.VisibleForTesting;\n import com.yammer.metrics.core.MetricName;\n import com.yammer.metrics.core.MetricsRegistry;\n+import org.apache.pinot.common.Utils;", "originalCommit": "723f08aa12074f83ac31fdfe09b8dc1f0254f942", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3NTg4OQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r397575889", "bodyText": "| Is this for real-time? We already have push type of either APPEND or REFRESH for offline; aggregateMetrics for real-time. What does UPSERT stand for?\nreplied in earlier comment, basically design for supporting update/insert in pinot realtime ingestion", "author": "jamesyfshao", "createdAt": "2020-03-25T02:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2MTk5NA=="}], "type": "inlineReview"}, {"oid": "5c3120146aed820387734b946f6ee32ac01411d7", "url": "https://github.com/apache/pinot/commit/5c3120146aed820387734b946f6ee32ac01411d7", "message": "frst update per cr", "committedDate": "2020-03-25T02:39:36Z", "type": "commit"}, {"oid": "a0f4fba2808b036d9a725deac9cad14b182b6bb2", "url": "https://github.com/apache/pinot/commit/a0f4fba2808b036d9a725deac9cad14b182b6bb2", "message": "adjust how schema work for upsert", "committedDate": "2020-03-31T01:13:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NjAyNw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r401996027", "bodyText": "Can we change the name of this class like I had suggested before?", "author": "mcvsubbu", "createdAt": "2020-04-02T01:04:13Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -308,6 +320,23 @@ public ServerType getServerType() {\n     public static final String PREFIX_OF_CONFIG_OF_PINOT_CRYPTER = \"crypter\";\n   }\n \n+  public static class Grigio {", "originalCommit": "a0f4fba2808b036d9a725deac9cad14b182b6bb2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NjI2NQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r401996265", "bodyText": "Please add comments on each of these. What does APPEND mean, vs what UPSERT means. Feel free to point to the design doc", "author": "mcvsubbu", "createdAt": "2020-04-02T01:05:04Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -378,4 +407,23 @@ public ServerType getServerType() {\n     @Deprecated\n     public static final String TABLE_NAME = \"segment.table.name\";\n   }\n+\n+  public enum UpdateSemantic {\n+    APPEND,", "originalCommit": "a0f4fba2808b036d9a725deac9cad14b182b6bb2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "553598e18953a0c5bc4b4ffad43c5e926ae03285", "url": "https://github.com/apache/pinot/commit/553598e18953a0c5bc4b4ffad43c5e926ae03285", "message": "enable multiple primary key support", "committedDate": "2020-04-02T21:38:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2MTM3MQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r402761371", "bodyText": "let's avoid adding additional utility methods to config classes if possible", "author": "kishoreg", "createdAt": "2020-04-03T06:27:05Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/config/TableConfig.java", "diffHunk": "@@ -470,6 +505,18 @@ public void setInstanceAssignmentConfigMap(\n     return _fieldConfigList;\n   }\n \n+  public UpdateSemantic getUpdateSemantic() {\n+    return _updateSemantic;\n+  }\n+\n+  public void setUpdateSemantic(UpdateSemantic updateSemantic) {\n+    _updateSemantic = updateSemantic;\n+  }\n+\n+  public boolean isTableForUpsert() {", "originalCommit": "553598e18953a0c5bc4b4ffad43c5e926ae03285", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5306aa567037e4b7ca4f6f807c61974afcc68f36", "url": "https://github.com/apache/pinot/commit/5306aa567037e4b7ca4f6f807c61974afcc68f36", "message": "move upsert config mostly to table config now", "committedDate": "2020-04-09T21:50:53Z", "type": "commit"}, {"oid": "17801a29868499bb77be93d3e2abae4f4e1875b6", "url": "https://github.com/apache/pinot/commit/17801a29868499bb77be93d3e2abae4f4e1875b6", "message": "add validFrom & validUntil definition to upsert table config", "committedDate": "2020-04-17T04:16:26Z", "type": "commit"}, {"oid": "e7c8047584fcb400ff6d6fa95f14123acddd1473", "url": "https://github.com/apache/pinot/commit/e7c8047584fcb400ff6d6fa95f14123acddd1473", "message": "update table config per meeting feedback, move other pinot common diff to later diff to ensure better review", "committedDate": "2020-04-17T04:34:50Z", "type": "commit"}, {"oid": "d78868093be43c4d117c4ece5b976f0781df16fc", "url": "https://github.com/apache/pinot/commit/d78868093be43c4d117c4ece5b976f0781df16fc", "message": "Merge remote-tracking branch 'upstream/master' into upsert-pr-land", "committedDate": "2020-04-17T05:26:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MDk2NQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410380965", "bodyText": "Can we call this UpsertConfig?", "author": "mcvsubbu", "createdAt": "2020-04-17T17:55:09Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMDA3MQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410500071", "bodyText": "+1. I think this config is only for upsert feature, and not applicable for general ingestion. When this config exist, we can assume the upsert feature is on.", "author": "Jackie-Jiang", "createdAt": "2020-04-17T22:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MDk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMDYwMw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410500603", "bodyText": "Also, please extends BaseJsonConfig, which handles the Json ser-de and common methods like hashCode(), equals() and toString(). You can refer to RoutingConfig which is similar to this one.", "author": "Jackie-Jiang", "createdAt": "2020-04-17T22:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MDk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MjQyNg==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410382426", "bodyText": "Can we avoid adding this for now? We can treat the presence of UpsertConfig as enabling upsert for Reatltime-only use cases (that you are handling now). It is therefore implied that the table push style is APPEND.\nIf, in future, we add multiple types of handling upserts, we can always add an enum (", "author": "mcvsubbu", "createdAt": "2020-04-17T17:57:54Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4Mjg5Mw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410382893", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private List<String> _primaryKeys;\n          \n          \n            \n              private List<String> _primaryKeyColumns;", "author": "mcvsubbu", "createdAt": "2020-04-17T17:58:47Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMDk3MA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410500970", "bodyText": "+1. You can also make it final. Same for other places", "author": "Jackie-Jiang", "createdAt": "2020-04-17T22:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4Mjg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MzA4MQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410383081", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private String _offsetKey;\n          \n          \n            \n              private String _offsetColumn;", "author": "mcvsubbu", "createdAt": "2020-04-17T17:59:06Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MzIzNQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410383235", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private String _validFromKey;\n          \n          \n            \n              private String _validFromColumn;", "author": "mcvsubbu", "createdAt": "2020-04-17T17:59:24Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validFromKey;", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MzMzNw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410383337", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private String _validUntilKey;\n          \n          \n            \n              private String _validUntilColumn;", "author": "mcvsubbu", "createdAt": "2020-04-17T17:59:35Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validFromKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validUntilKey;", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MzU3MQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410383571", "bodyText": "we should not need these two for now", "author": "mcvsubbu", "createdAt": "2020-04-17T18:00:01Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validFromKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validUntilKey;\n+\n+  public static final String UPSERT_TABLE_CONFIG_VALUE = \"upsert\";", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4NDA0MQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410384041", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"pinot upsert require one and only one primary key\");\n          \n          \n            \n                      \"Upsert feature supports only one primary key\");", "author": "mcvsubbu", "createdAt": "2020-04-17T18:00:59Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validFromKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validUntilKey;\n+\n+  public static final String UPSERT_TABLE_CONFIG_VALUE = \"upsert\";\n+  public static final String APPEND_TABLE_CONFIG_VALUE = \"append\";\n+\n+  public static final IngestionModeConfig DEFAULT_APPEND_INGESTION_MODE =\n+      new IngestionModeConfig(APPEND_TABLE_CONFIG_VALUE, null, null, null,\n+          null);\n+\n+  @JsonCreator\n+  public IngestionModeConfig(\n+      @JsonProperty(value=\"ingestionMode\") @Nullable String ingestionMode,\n+      @JsonProperty(value=\"primaryKeys\") @Nullable List<String> primaryKeys,\n+      @JsonProperty(value=\"offsetKey\") @Nullable String offsetKey,\n+      @JsonProperty(value=\"validFromKey\") @Nullable String validFromKey,\n+      @JsonProperty(value=\"validUntilKey\") @Nullable String validUntilKey) {\n+    if (StringUtils.isEmpty(ingestionMode)) {\n+      _ingestionMode = APPEND_TABLE_CONFIG_VALUE;\n+    } else {\n+      _ingestionMode = ingestionMode.toLowerCase();\n+    }\n+    if (primaryKeys == null) {\n+      _primaryKeys = ImmutableList.of();\n+    } else {\n+      _primaryKeys = primaryKeys;\n+    }\n+    _offsetKey = offsetKey;\n+    _validFromKey = validFromKey;\n+    _validUntilKey = validUntilKey;\n+\n+    if (UPSERT_TABLE_CONFIG_VALUE.equals(_ingestionMode)) {\n+      Preconditions.checkState(_primaryKeys.size() == 1,\n+          \"pinot upsert require one and only one primary key\");", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4NDQ5NQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410384495", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"pinot upsert require one offset key\");\n          \n          \n            \n                      \"Upsert feature requires \\\"offsetColumn\\\" to be set\");", "author": "mcvsubbu", "createdAt": "2020-04-17T18:01:57Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validFromKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validUntilKey;\n+\n+  public static final String UPSERT_TABLE_CONFIG_VALUE = \"upsert\";\n+  public static final String APPEND_TABLE_CONFIG_VALUE = \"append\";\n+\n+  public static final IngestionModeConfig DEFAULT_APPEND_INGESTION_MODE =\n+      new IngestionModeConfig(APPEND_TABLE_CONFIG_VALUE, null, null, null,\n+          null);\n+\n+  @JsonCreator\n+  public IngestionModeConfig(\n+      @JsonProperty(value=\"ingestionMode\") @Nullable String ingestionMode,\n+      @JsonProperty(value=\"primaryKeys\") @Nullable List<String> primaryKeys,\n+      @JsonProperty(value=\"offsetKey\") @Nullable String offsetKey,\n+      @JsonProperty(value=\"validFromKey\") @Nullable String validFromKey,\n+      @JsonProperty(value=\"validUntilKey\") @Nullable String validUntilKey) {\n+    if (StringUtils.isEmpty(ingestionMode)) {\n+      _ingestionMode = APPEND_TABLE_CONFIG_VALUE;\n+    } else {\n+      _ingestionMode = ingestionMode.toLowerCase();\n+    }\n+    if (primaryKeys == null) {\n+      _primaryKeys = ImmutableList.of();\n+    } else {\n+      _primaryKeys = primaryKeys;\n+    }\n+    _offsetKey = offsetKey;\n+    _validFromKey = validFromKey;\n+    _validUntilKey = validUntilKey;\n+\n+    if (UPSERT_TABLE_CONFIG_VALUE.equals(_ingestionMode)) {\n+      Preconditions.checkState(_primaryKeys.size() == 1,\n+          \"pinot upsert require one and only one primary key\");\n+      Preconditions.checkState(StringUtils.isNotEmpty(_offsetKey),\n+          \"pinot upsert require one offset key\");", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4NTY2NQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410385665", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"pinot upsert require one validFrom key\");\n          \n          \n            \n                      \"Upsert feature requires \\\"validFromColumn\\\" to be set\");", "author": "mcvsubbu", "createdAt": "2020-04-17T18:04:04Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validFromKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validUntilKey;\n+\n+  public static final String UPSERT_TABLE_CONFIG_VALUE = \"upsert\";\n+  public static final String APPEND_TABLE_CONFIG_VALUE = \"append\";\n+\n+  public static final IngestionModeConfig DEFAULT_APPEND_INGESTION_MODE =\n+      new IngestionModeConfig(APPEND_TABLE_CONFIG_VALUE, null, null, null,\n+          null);\n+\n+  @JsonCreator\n+  public IngestionModeConfig(\n+      @JsonProperty(value=\"ingestionMode\") @Nullable String ingestionMode,\n+      @JsonProperty(value=\"primaryKeys\") @Nullable List<String> primaryKeys,\n+      @JsonProperty(value=\"offsetKey\") @Nullable String offsetKey,\n+      @JsonProperty(value=\"validFromKey\") @Nullable String validFromKey,\n+      @JsonProperty(value=\"validUntilKey\") @Nullable String validUntilKey) {\n+    if (StringUtils.isEmpty(ingestionMode)) {\n+      _ingestionMode = APPEND_TABLE_CONFIG_VALUE;\n+    } else {\n+      _ingestionMode = ingestionMode.toLowerCase();\n+    }\n+    if (primaryKeys == null) {\n+      _primaryKeys = ImmutableList.of();\n+    } else {\n+      _primaryKeys = primaryKeys;\n+    }\n+    _offsetKey = offsetKey;\n+    _validFromKey = validFromKey;\n+    _validUntilKey = validUntilKey;\n+\n+    if (UPSERT_TABLE_CONFIG_VALUE.equals(_ingestionMode)) {\n+      Preconditions.checkState(_primaryKeys.size() == 1,\n+          \"pinot upsert require one and only one primary key\");\n+      Preconditions.checkState(StringUtils.isNotEmpty(_offsetKey),\n+          \"pinot upsert require one offset key\");\n+      Preconditions.checkState(StringUtils.isNotEmpty(_validFromKey),\n+          \"pinot upsert require one validFrom key\");", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4NTc3OQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410385779", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"pinot upsert require one validUntil key\");\n          \n          \n            \n                      \"Upsert feature requires \\\"validUntilColumn\\\"  to be set\");", "author": "mcvsubbu", "createdAt": "2020-04-17T18:04:15Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validFromKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validUntilKey;\n+\n+  public static final String UPSERT_TABLE_CONFIG_VALUE = \"upsert\";\n+  public static final String APPEND_TABLE_CONFIG_VALUE = \"append\";\n+\n+  public static final IngestionModeConfig DEFAULT_APPEND_INGESTION_MODE =\n+      new IngestionModeConfig(APPEND_TABLE_CONFIG_VALUE, null, null, null,\n+          null);\n+\n+  @JsonCreator\n+  public IngestionModeConfig(\n+      @JsonProperty(value=\"ingestionMode\") @Nullable String ingestionMode,\n+      @JsonProperty(value=\"primaryKeys\") @Nullable List<String> primaryKeys,\n+      @JsonProperty(value=\"offsetKey\") @Nullable String offsetKey,\n+      @JsonProperty(value=\"validFromKey\") @Nullable String validFromKey,\n+      @JsonProperty(value=\"validUntilKey\") @Nullable String validUntilKey) {\n+    if (StringUtils.isEmpty(ingestionMode)) {\n+      _ingestionMode = APPEND_TABLE_CONFIG_VALUE;\n+    } else {\n+      _ingestionMode = ingestionMode.toLowerCase();\n+    }\n+    if (primaryKeys == null) {\n+      _primaryKeys = ImmutableList.of();\n+    } else {\n+      _primaryKeys = primaryKeys;\n+    }\n+    _offsetKey = offsetKey;\n+    _validFromKey = validFromKey;\n+    _validUntilKey = validUntilKey;\n+\n+    if (UPSERT_TABLE_CONFIG_VALUE.equals(_ingestionMode)) {\n+      Preconditions.checkState(_primaryKeys.size() == 1,\n+          \"pinot upsert require one and only one primary key\");\n+      Preconditions.checkState(StringUtils.isNotEmpty(_offsetKey),\n+          \"pinot upsert require one offset key\");\n+      Preconditions.checkState(StringUtils.isNotEmpty(_validFromKey),\n+          \"pinot upsert require one validFrom key\");\n+      Preconditions.checkState(StringUtils.isNotEmpty(_validUntilKey),\n+          \"pinot upsert require one validUntil key\");", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4NjIwMw==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410386203", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final String INGESTION_MODE_CONFIG_KEY = \"ingestionModeConfig\";\n          \n          \n            \n              public static final String UPSERT_CONFIG_KEY = \"upsertConfig\";", "author": "mcvsubbu", "createdAt": "2020-04-17T18:05:01Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/TableConfig.java", "diffHunk": "@@ -44,6 +45,7 @@\n   public static final String QUERY_CONFIG_KEY = \"query\";\n   public static final String INSTANCE_ASSIGNMENT_CONFIG_MAP_KEY = \"instanceAssignmentConfigMap\";\n   public static final String FIELD_CONFIG_LIST_KEY = \"fieldConfigList\";\n+  public static final String INGESTION_MODE_CONFIG_KEY = \"ingestionModeConfig\";", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMTE1NQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r410501155", "bodyText": "If this config is for upsert only, I think all arguments are required", "author": "Jackie-Jiang", "createdAt": "2020-04-17T22:35:27Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/IngestionModeConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.pinot.spi.utils.JsonUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class IngestionModeConfig {\n+  // new config key to indicate if a table is for upsert. If this is define as upsert, it would be an upsert table\n+  // for other value it would be append value for now\n+  private String _ingestionMode;\n+  // primary key refers to the column name that is the primary key of this upsert table\n+  private List<String> _primaryKeys;\n+  // offset key refers to the column name that we are going to store the offset value to\n+  private String _offsetKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validFromKey;\n+  // validFrom key refers to the column name that we are going to store the validFrom value to\n+  private String _validUntilKey;\n+\n+  public static final String UPSERT_TABLE_CONFIG_VALUE = \"upsert\";\n+  public static final String APPEND_TABLE_CONFIG_VALUE = \"append\";\n+\n+  public static final IngestionModeConfig DEFAULT_APPEND_INGESTION_MODE =\n+      new IngestionModeConfig(APPEND_TABLE_CONFIG_VALUE, null, null, null,\n+          null);\n+\n+  @JsonCreator\n+  public IngestionModeConfig(\n+      @JsonProperty(value=\"ingestionMode\") @Nullable String ingestionMode,\n+      @JsonProperty(value=\"primaryKeys\") @Nullable List<String> primaryKeys,", "originalCommit": "d78868093be43c4d117c4ece5b976f0781df16fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c9695773720de6761bb705c3fbd6c30a82280ee7", "url": "https://github.com/apache/pinot/commit/c9695773720de6761bb705c3fbd6c30a82280ee7", "message": "update per pr feedback", "committedDate": "2020-04-22T05:11:24Z", "type": "commit"}, {"oid": "729f377833de2edba3af761ccbf581d02b3b2247", "url": "https://github.com/apache/pinot/commit/729f377833de2edba3af761ccbf581d02b3b2247", "message": "Merge branch 'upstream-master' into upsert-pr-land", "committedDate": "2020-04-22T05:24:52Z", "type": "commit"}, {"oid": "0f7ce4bdf5cca63337a4076834076351a0337fa2", "url": "https://github.com/apache/pinot/commit/0f7ce4bdf5cca63337a4076834076351a0337fa2", "message": "update docs", "committedDate": "2020-04-22T05:43:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIxODYzNQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r413218635", "bodyText": "(nit) extra empty line", "author": "Jackie-Jiang", "createdAt": "2020-04-22T18:27:40Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/config/TableConfigUtils.java", "diffHunk": "@@ -116,8 +117,16 @@ public static TableConfig fromZNRecord(ZNRecord znRecord)\n       });\n     }\n \n+    UpsertConfig upsertConfig = null;\n+    String upsertConfigString = simpleFields.get(TableConfig.UPSERT_CONFIG_KEY);\n+    if (upsertConfigString != null) {\n+      upsertConfig = JsonUtils.stringToObject(upsertConfigString, UpsertConfig.class);\n+    }\n+", "originalCommit": "0f7ce4bdf5cca63337a4076834076351a0337fa2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIxOTA1OQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r413219059", "bodyText": "Prefer using Collections.singletonList()", "author": "Jackie-Jiang", "createdAt": "2020-04-22T18:28:17Z", "path": "pinot-common/src/test/java/org/apache/pinot/common/utils/config/TableConfigSerDeTest.java", "diffHunk": "@@ -231,6 +234,17 @@ public void testSerDe()\n       assertEquals(tableConfigToCompare, tableConfig);\n       checkFieldConfig(tableConfigToCompare);\n     }\n+    {\n+      // with upsert config\n+      UpsertConfig upsertConfig = new UpsertConfig(ImmutableList.of(\"pk\"), \"offset\",", "originalCommit": "0f7ce4bdf5cca63337a4076834076351a0337fa2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyMjE2Mg==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r413222162", "bodyText": "Can you make this similar to other config check? Pass in a  table config and check the actual value inside the config. Then serialize and deserialize (both string and ZNRecord) and check again", "author": "Jackie-Jiang", "createdAt": "2020-04-22T18:32:50Z", "path": "pinot-common/src/test/java/org/apache/pinot/common/utils/config/TableConfigSerDeTest.java", "diffHunk": "@@ -367,4 +381,12 @@ private void checkFieldConfig(TableConfig tableConfig) {\n     assertNull(secondFieldConfig.getIndexType());\n     assertNull(secondFieldConfig.getProperties());\n   }\n+\n+  private void checkTableConfigWithUpsertConfig(TableConfig tableConfig, TableConfig tableConfigToCompare) {", "originalCommit": "0f7ce4bdf5cca63337a4076834076351a0337fa2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyMzAwOQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r413223009", "bodyText": "(nit) empty line", "author": "Jackie-Jiang", "createdAt": "2020-04-22T18:34:06Z", "path": "pinot-spi/src/test/java/org/apache/pinot/spi/config/UpsertConfigTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+import com.google.common.collect.ImmutableList;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.*;\n+\n+public class UpsertConfigTest {\n+\n+  @Test\n+  public void testUpsertConfig() {\n+    UpsertConfig upsertConfig;\n+\n+    // test regular upsert table\n+    upsertConfig = new UpsertConfig(ImmutableList.of(\"primaryKey\"), \"offset\", \"validFrom\",\n+        \"validUntil\");\n+    assertEquals(1, upsertConfig.getPrimaryKeyColumns().size());\n+    assertEquals(\"primaryKey\", upsertConfig.getPrimaryKeyColumns().get(0));\n+    assertEquals(\"offset\", upsertConfig.getOffsetColumn());\n+    assertEquals(\"validFrom\", upsertConfig.getValidFromColumn());\n+    assertEquals(\"validUntil\", upsertConfig.getValidUntilColumn());\n+\n+    // test sanity check\n+    try {\n+      upsertConfig = new UpsertConfig(null,\n+          \"offset\", \"validFrom\", \"validUntil\");\n+      fail();\n+    } catch (RuntimeException ex) {}\n+\n+    try {\n+      upsertConfig = new UpsertConfig(ImmutableList.of(\"pk1\", \"pk2\"),\n+          \"offset\", \"validFrom\", \"validUntil\");\n+      fail();\n+    } catch (RuntimeException ex) {}\n+\n+    try {\n+      upsertConfig = new UpsertConfig(ImmutableList.of(\"pk1\"),\n+          null, \"validFrom\", \"validUntil\");\n+      fail();\n+    } catch (RuntimeException ex) {}\n+\n+    try {\n+      upsertConfig = new UpsertConfig(ImmutableList.of(\"pk1\"),\n+          \"offset\", null, \"validUntil\");\n+      fail();\n+    } catch (RuntimeException ex) {}\n+\n+    try {\n+      upsertConfig = new UpsertConfig(ImmutableList.of(\"pk1\"),\n+          \"offset\", \"validFrom\", null);\n+      fail();\n+    } catch (RuntimeException ex) {}\n+  }\n+}", "originalCommit": "0f7ce4bdf5cca63337a4076834076351a0337fa2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f4f4f464d820127e4b03c78da76783b0febdc93f", "url": "https://github.com/apache/pinot/commit/f4f4f464d820127e4b03c78da76783b0febdc93f", "message": "more update per feedback and fix tests", "committedDate": "2020-04-23T20:29:40Z", "type": "commit"}, {"oid": "a5fd4b9dea816cea973e6ceaf19462a170af207b", "url": "https://github.com/apache/pinot/commit/a5fd4b9dea816cea973e6ceaf19462a170af207b", "message": "more doc, and trigger build again to see if it fixed tests", "committedDate": "2020-04-23T21:41:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NDU0Ng==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r414794546", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"upsert feature support only one primary key column\");\n          \n          \n            \n                    \"Upsert feature supports only one primary key column\");", "author": "mcvsubbu", "createdAt": "2020-04-24T18:56:08Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/UpsertConfig.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class UpsertConfig extends BaseJsonConfig {\n+  // names of the columns that used as primary keys of an upsert table\n+  private final List<String> _primaryKeyColumns;\n+  // name of the column that we are going to store the offset value to\n+  private final String _offsetColumn;\n+  // name of the virtual column that we are going to store the validFrom value to\n+  private final String _validFromColumn;\n+  // name of the virtual column that we are going to store the validUntil value to\n+  private final String _validUntilColumn;\n+\n+  @JsonCreator\n+  public UpsertConfig(\n+      @JsonProperty(value=\"primaryKeyColumns\") List<String> primaryKeyColumns,\n+      @JsonProperty(value=\"offsetColumn\") String offsetColumn,\n+      @JsonProperty(value=\"validFromColumn\") String validFromColumn,\n+      @JsonProperty(value=\"validUntilColumn\") String validUntilColumn) {\n+\n+    _primaryKeyColumns = primaryKeyColumns;\n+    _offsetColumn = offsetColumn;\n+    _validFromColumn = validFromColumn;\n+    _validUntilColumn = validUntilColumn;\n+\n+    Preconditions.checkState(_primaryKeyColumns.size() == 1,\n+        \"upsert feature support only one primary key column\");", "originalCommit": "a5fd4b9dea816cea973e6ceaf19462a170af207b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NDc0OQ==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r414794749", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"upsert feature requires \\\"offsetColumn\\\" to be set \");\n          \n          \n            \n                    \"Upsert feature requires \\\"offsetColumn\\\" to be set \");", "author": "mcvsubbu", "createdAt": "2020-04-24T18:56:28Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/UpsertConfig.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class UpsertConfig extends BaseJsonConfig {\n+  // names of the columns that used as primary keys of an upsert table\n+  private final List<String> _primaryKeyColumns;\n+  // name of the column that we are going to store the offset value to\n+  private final String _offsetColumn;\n+  // name of the virtual column that we are going to store the validFrom value to\n+  private final String _validFromColumn;\n+  // name of the virtual column that we are going to store the validUntil value to\n+  private final String _validUntilColumn;\n+\n+  @JsonCreator\n+  public UpsertConfig(\n+      @JsonProperty(value=\"primaryKeyColumns\") List<String> primaryKeyColumns,\n+      @JsonProperty(value=\"offsetColumn\") String offsetColumn,\n+      @JsonProperty(value=\"validFromColumn\") String validFromColumn,\n+      @JsonProperty(value=\"validUntilColumn\") String validUntilColumn) {\n+\n+    _primaryKeyColumns = primaryKeyColumns;\n+    _offsetColumn = offsetColumn;\n+    _validFromColumn = validFromColumn;\n+    _validUntilColumn = validUntilColumn;\n+\n+    Preconditions.checkState(_primaryKeyColumns.size() == 1,\n+        \"upsert feature support only one primary key column\");\n+    Preconditions.checkState(StringUtils.isNotEmpty(_offsetColumn),\n+        \"upsert feature requires \\\"offsetColumn\\\" to be set \");", "originalCommit": "a5fd4b9dea816cea973e6ceaf19462a170af207b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NDgzMA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r414794830", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"upsert feature requires \\\"validFromColumn\\\" to be set\");\n          \n          \n            \n                    \"Upsert feature requires \\\"validFromColumn\\\" to be set\");", "author": "mcvsubbu", "createdAt": "2020-04-24T18:56:38Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/UpsertConfig.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class UpsertConfig extends BaseJsonConfig {\n+  // names of the columns that used as primary keys of an upsert table\n+  private final List<String> _primaryKeyColumns;\n+  // name of the column that we are going to store the offset value to\n+  private final String _offsetColumn;\n+  // name of the virtual column that we are going to store the validFrom value to\n+  private final String _validFromColumn;\n+  // name of the virtual column that we are going to store the validUntil value to\n+  private final String _validUntilColumn;\n+\n+  @JsonCreator\n+  public UpsertConfig(\n+      @JsonProperty(value=\"primaryKeyColumns\") List<String> primaryKeyColumns,\n+      @JsonProperty(value=\"offsetColumn\") String offsetColumn,\n+      @JsonProperty(value=\"validFromColumn\") String validFromColumn,\n+      @JsonProperty(value=\"validUntilColumn\") String validUntilColumn) {\n+\n+    _primaryKeyColumns = primaryKeyColumns;\n+    _offsetColumn = offsetColumn;\n+    _validFromColumn = validFromColumn;\n+    _validUntilColumn = validUntilColumn;\n+\n+    Preconditions.checkState(_primaryKeyColumns.size() == 1,\n+        \"upsert feature support only one primary key column\");\n+    Preconditions.checkState(StringUtils.isNotEmpty(_offsetColumn),\n+        \"upsert feature requires \\\"offsetColumn\\\" to be set \");\n+    Preconditions.checkState(StringUtils.isNotEmpty(_validFromColumn),\n+        \"upsert feature requires \\\"validFromColumn\\\" to be set\");", "originalCommit": "a5fd4b9dea816cea973e6ceaf19462a170af207b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NTAxNA==", "url": "https://github.com/apache/pinot/pull/5175#discussion_r414795014", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"upsert feature requires \\\"validUntilColumn\\\" to be set\");\n          \n          \n            \n                    \"Upsert feature requires \\\"validUntilColumn\\\" to be set\");", "author": "mcvsubbu", "createdAt": "2020-04-24T18:56:58Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/UpsertConfig.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.spi.config;\n+\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang.StringUtils;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@SuppressWarnings(\"unused\")\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class UpsertConfig extends BaseJsonConfig {\n+  // names of the columns that used as primary keys of an upsert table\n+  private final List<String> _primaryKeyColumns;\n+  // name of the column that we are going to store the offset value to\n+  private final String _offsetColumn;\n+  // name of the virtual column that we are going to store the validFrom value to\n+  private final String _validFromColumn;\n+  // name of the virtual column that we are going to store the validUntil value to\n+  private final String _validUntilColumn;\n+\n+  @JsonCreator\n+  public UpsertConfig(\n+      @JsonProperty(value=\"primaryKeyColumns\") List<String> primaryKeyColumns,\n+      @JsonProperty(value=\"offsetColumn\") String offsetColumn,\n+      @JsonProperty(value=\"validFromColumn\") String validFromColumn,\n+      @JsonProperty(value=\"validUntilColumn\") String validUntilColumn) {\n+\n+    _primaryKeyColumns = primaryKeyColumns;\n+    _offsetColumn = offsetColumn;\n+    _validFromColumn = validFromColumn;\n+    _validUntilColumn = validUntilColumn;\n+\n+    Preconditions.checkState(_primaryKeyColumns.size() == 1,\n+        \"upsert feature support only one primary key column\");\n+    Preconditions.checkState(StringUtils.isNotEmpty(_offsetColumn),\n+        \"upsert feature requires \\\"offsetColumn\\\" to be set \");\n+    Preconditions.checkState(StringUtils.isNotEmpty(_validFromColumn),\n+        \"upsert feature requires \\\"validFromColumn\\\" to be set\");\n+    Preconditions.checkState(StringUtils.isNotEmpty(_validUntilColumn),\n+        \"upsert feature requires \\\"validUntilColumn\\\" to be set\");", "originalCommit": "a5fd4b9dea816cea973e6ceaf19462a170af207b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67c453042abfd21cdc45fa76a026035ea4adcb7b", "url": "https://github.com/apache/pinot/commit/67c453042abfd21cdc45fa76a026035ea4adcb7b", "message": "Update pinot-spi/src/main/java/org/apache/pinot/spi/config/UpsertConfig.java\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-04-24T20:22:10Z", "type": "commit"}, {"oid": "97370a4ab3d7264df9fd7e8fd318a8f7d7651695", "url": "https://github.com/apache/pinot/commit/97370a4ab3d7264df9fd7e8fd318a8f7d7651695", "message": "Update pinot-spi/src/main/java/org/apache/pinot/spi/config/UpsertConfig.java\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-04-24T20:22:48Z", "type": "commit"}, {"oid": "f56905e1293ee72b21af73a5189d980e94cecb22", "url": "https://github.com/apache/pinot/commit/f56905e1293ee72b21af73a5189d980e94cecb22", "message": "Update pinot-spi/src/main/java/org/apache/pinot/spi/config/UpsertConfig.java\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-04-24T20:22:59Z", "type": "commit"}, {"oid": "6c0bd60350ad6c00c6f571aac9818412d7380169", "url": "https://github.com/apache/pinot/commit/6c0bd60350ad6c00c6f571aac9818412d7380169", "message": "Update pinot-spi/src/main/java/org/apache/pinot/spi/config/UpsertConfig.java\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-04-24T20:23:19Z", "type": "commit"}]}