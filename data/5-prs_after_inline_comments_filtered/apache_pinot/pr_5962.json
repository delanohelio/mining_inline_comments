{"pr_number": 5962, "pr_title": "[TE] Severity based alerter", "pr_createdAt": "2020-09-02T17:26:27Z", "pr_url": "https://github.com/apache/pinot/pull/5962", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNjY1OA==", "url": "https://github.com/apache/pinot/pull/5962#discussion_r483806658", "bodyText": "Why are we not checking if the corresponding entry exists for the anomalies?", "author": "vincentchenjl", "createdAt": "2020-09-04T19:21:00Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/DetectionResource.java", "diffHunk": "@@ -570,4 +574,19 @@ public Response getDetectionHealth(@PathParam(\"id\") @ApiParam(\"detection config\n     }\n     return Response.ok(health).build();\n   }\n+\n+  @POST\n+  @Path(value = \"/re-notify\")\n+  @ApiOperation(\"Resend the notification for the anomalies to the subscribed notification groups, if the subscription group supports re-notify\")\n+  public Response alert(@QueryParam(\"id\") List<Long> anomalyIds) {\n+    List<MergedAnomalyResultDTO> anomalies = this.anomalyDAO.findByIds(anomalyIds);\n+    for (MergedAnomalyResultDTO anomaly : anomalies) {\n+      AnomalySubscriptionGroupNotificationDTO anomalySubscriptionGroupNotificationDTO =\n+          new AnomalySubscriptionGroupNotificationDTO();\n+      anomalySubscriptionGroupNotificationDTO.setAnomalyId(anomaly.getId());\n+      anomalySubscriptionGroupNotificationDTO.setDetectionConfigId(anomaly.getDetectionConfigId());\n+      anomalySubscriptionGroupNotificationManager.save(anomalySubscriptionGroupNotificationDTO);", "originalCommit": "55117218c4008a8d5a3893f0b29892a52e5d9608", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExMTUwMw==", "url": "https://github.com/apache/pinot/pull/5962#discussion_r485111503", "bodyText": "good catch. updated!", "author": "jihaozh", "createdAt": "2020-09-08T18:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNjY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg0NjU5NA==", "url": "https://github.com/apache/pinot/pull/5962#discussion_r483846594", "bodyText": "Do we expect that new anomalies also have renotify flag as true? Or this should only apply for existing anomalies?", "author": "vincentchenjl", "createdAt": "2020-09-04T21:14:47Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/DetectionPipelineTaskRunner.java", "diffHunk": "@@ -167,6 +175,14 @@ public DetectionPipelineTaskRunner(DetectionConfigManager detectionDAO, MergedAn\n       }\n       this.detectionDAO.update(config);\n \n+      // re-notify the anomalies if any\n+      for (MergedAnomalyResultDTO anomaly : result.getAnomalies()) {\n+        // if an anomaly should be re-notified, update the notification lookup table in the database\n+        if (anomaly.shouldRenotify()) {", "originalCommit": "55117218c4008a8d5a3893f0b29892a52e5d9608", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExMTcxNQ==", "url": "https://github.com/apache/pinot/pull/5962#discussion_r485111715", "bodyText": "no. the renotify flag only applies to exist anomalies.", "author": "jihaozh", "createdAt": "2020-09-08T18:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg0NjU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MjcyNQ==", "url": "https://github.com/apache/pinot/pull/5962#discussion_r483852725", "bodyText": "There's a conflict here between this PR and mine. The labeler in the other PR relies on the order of the severity.", "author": "vincentchenjl", "createdAt": "2020-09-04T21:35:17Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/constant/AnomalySeverity.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.pinot.thirdeye.constant;\n+\n+public enum AnomalySeverity {\n+  LOW(\"low\"), MODERATE(\"moderate\"), HIGH(\"high\"), CRITICAL(\"critical\"), DEFAULT(\"default\");", "originalCommit": "55117218c4008a8d5a3893f0b29892a52e5d9608", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyOTY4OQ==", "url": "https://github.com/apache/pinot/pull/5962#discussion_r485229689", "bodyText": "pls include some javadocs", "author": "akshayrai", "createdAt": "2020-09-08T22:28:16Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/datalayer/bao/AnomalySubscriptionGroupNotificationManager.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.pinot.thirdeye.datalayer.bao;\n+\n+import org.apache.pinot.thirdeye.datalayer.dto.AnomalySubscriptionGroupNotificationDTO;\n+\n+\n+public interface AnomalySubscriptionGroupNotificationManager", "originalCommit": "c95c341feb0c699d7d7fd2fc50f45afcef3fa9eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzMDMzMQ==", "url": "https://github.com/apache/pinot/pull/5962#discussion_r485230331", "bodyText": "javadocs", "author": "akshayrai", "createdAt": "2020-09-08T22:30:07Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/constant/AnomalySeverity.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.pinot.thirdeye.constant;\n+\n+public enum AnomalySeverity {", "originalCommit": "c95c341feb0c699d7d7fd2fc50f45afcef3fa9eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "815c52ad25ffb866569acc03c99b99cc1d8d578e", "url": "https://github.com/apache/pinot/commit/815c52ad25ffb866569acc03c99b99cc1d8d578e", "message": "add anomaly notification table", "committedDate": "2020-09-09T00:07:16Z", "type": "commit"}, {"oid": "9caca064677030856e7dd5649969e47e9c595f6e", "url": "https://github.com/apache/pinot/commit/9caca064677030856e7dd5649969e47e9c595f6e", "message": "severity alerter & unit tests", "committedDate": "2020-09-09T00:09:08Z", "type": "commit"}, {"oid": "09944df4bca95db34a46d7efee6197baa2cc017d", "url": "https://github.com/apache/pinot/commit/09944df4bca95db34a46d7efee6197baa2cc017d", "message": "refactor", "committedDate": "2020-09-09T00:09:12Z", "type": "commit"}, {"oid": "2c9a272e6948269fd66e42678e85a5151b924cc6", "url": "https://github.com/apache/pinot/commit/2c9a272e6948269fd66e42678e85a5151b924cc6", "message": "address comments", "committedDate": "2020-09-09T00:09:12Z", "type": "commit"}, {"oid": "13c7d66795a6d42f547f5fbe588f97eb8ab6da6a", "url": "https://github.com/apache/pinot/commit/13c7d66795a6d42f547f5fbe588f97eb8ab6da6a", "message": "rebase", "committedDate": "2020-09-09T00:18:52Z", "type": "commit"}, {"oid": "363004e569852a0e88ea8c5a18a6a82bc1c73762", "url": "https://github.com/apache/pinot/commit/363004e569852a0e88ea8c5a18a6a82bc1c73762", "message": "address comments", "committedDate": "2020-09-09T00:19:56Z", "type": "commit"}, {"oid": "363004e569852a0e88ea8c5a18a6a82bc1c73762", "url": "https://github.com/apache/pinot/commit/363004e569852a0e88ea8c5a18a6a82bc1c73762", "message": "address comments", "committedDate": "2020-09-09T00:19:56Z", "type": "forcePushed"}]}