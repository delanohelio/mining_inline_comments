{"pr_number": 5208, "pr_title": "[TE] Disable alerts if it has no success run within 30 days", "pr_createdAt": "2020-04-02T22:43:55Z", "pr_url": "https://github.com/apache/pinot/pull/5208", "timeline": [{"oid": "81583d6152c03be7519c9a8ff3f3d1452e38bb2d", "url": "https://github.com/apache/pinot/commit/81583d6152c03be7519c9a8ff3f3d1452e38bb2d", "message": "[TE] Disable alerts if it has no success run within 30 days", "committedDate": "2020-04-02T22:42:51Z", "type": "commit"}, {"oid": "3a13624711cf61b7713ac0839584d6ca2dc0b278", "url": "https://github.com/apache/pinot/commit/3a13624711cf61b7713ac0839584d6ca2dc0b278", "message": "[TE] Check if the update time is null", "committedDate": "2020-04-03T03:03:12Z", "type": "commit"}, {"oid": "010a571405362815894629caeebf5cd4f344d50a", "url": "https://github.com/apache/pinot/commit/010a571405362815894629caeebf5cd4f344d50a", "message": "[TE] Send notification mail when disabling alerts", "committedDate": "2020-04-04T16:55:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwMzkwNQ==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405803905", "bodyText": "log the exception.", "author": "akshayrai", "createdAt": "2020-04-08T20:45:51Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {\n+    DetectionConfigManager detectionDAO = DAO_REGISTRY.getDetectionConfigManager();\n+    List<DetectionConfigDTO> detectionConfigs = detectionDAO.findAllActive();\n+    long currentTimeMills = System.currentTimeMillis();\n+    long maxTaskFailMills = TimeUnit.DAYS.toMillis(MAX_FAILED_DISABLE_DAYS);\n+    for (DetectionConfigDTO config : detectionConfigs) {\n+      try {\n+        Timestamp updateTime = config.getUpdateTime();\n+        if (updateTime != null && config.getHealth() != null && config.getHealth().getDetectionTaskStatus() != null) {\n+          long lastTaskExecutionTime = config.getHealth().getDetectionTaskStatus().getLastTaskExecutionTime();\n+          if (updateTime.getTime() <= currentTimeMills - maxTaskFailMills && (lastTaskExecutionTime == -1L\n+              || lastTaskExecutionTime <= currentTimeMills - maxTaskFailMills)) {\n+            config.setActive(false);\n+            detectionDAO.update(config);\n+            sendDisableAlertNotificationEmail(config);\n+            LOG.info(\"Disabled alert \" + config.getId() + \" since it failed more than \" + MAX_FAILED_DISABLE_DAYS + \" days\");\n+            LOG.info(\"Task last update time: \" + config.getUpdateTime());\n+            LOG.info(\"Last success task execution time: \" + lastTaskExecutionTime);\n+          }\n+        }\n+      } catch (Exception e) {\n+        LOG.error(\"Exception in disabling alert \", config.getId());", "originalCommit": "010a571405362815894629caeebf5cd4f344d50a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0Njg3Mw==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r407146873", "bodyText": "fixed", "author": "xiaohui-sun", "createdAt": "2020-04-12T05:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwMzkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMTgxMQ==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405811811", "bodyText": "Can we include some unit tests for this?", "author": "akshayrai", "createdAt": "2020-04-08T21:00:04Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {", "originalCommit": "010a571405362815894629caeebf5cd4f344d50a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0Njk0Ng==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r407146946", "bodyText": "Currently we don't have a good way to test it. The only way would be integration test. But having more than one integration tests running may cause conflicts. That's why I have to add sequence number in our local integration test.", "author": "xiaohui-sun", "createdAt": "2020-04-12T05:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMTgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNDA2NA==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405814064", "bodyText": "nit: typo currentTimeMillis & maxTaskFailMillis", "author": "akshayrai", "createdAt": "2020-04-08T21:04:39Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {\n+    DetectionConfigManager detectionDAO = DAO_REGISTRY.getDetectionConfigManager();\n+    List<DetectionConfigDTO> detectionConfigs = detectionDAO.findAllActive();\n+    long currentTimeMills = System.currentTimeMillis();", "originalCommit": "010a571405362815894629caeebf5cd4f344d50a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0Njg1Mg==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r407146852", "bodyText": "fixed", "author": "xiaohui-sun", "createdAt": "2020-04-12T05:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNDA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNTIxOQ==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405815219", "bodyText": "Can we skip the lastTaskExecutionTime == -1L check?\nIsn't that already covered by lastTaskExecutionTime <= currentTimeMills - maxTaskFailMills?", "author": "akshayrai", "createdAt": "2020-04-08T21:07:00Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {\n+    DetectionConfigManager detectionDAO = DAO_REGISTRY.getDetectionConfigManager();\n+    List<DetectionConfigDTO> detectionConfigs = detectionDAO.findAllActive();\n+    long currentTimeMills = System.currentTimeMillis();\n+    long maxTaskFailMills = TimeUnit.DAYS.toMillis(MAX_FAILED_DISABLE_DAYS);\n+    for (DetectionConfigDTO config : detectionConfigs) {\n+      try {\n+        Timestamp updateTime = config.getUpdateTime();\n+        if (updateTime != null && config.getHealth() != null && config.getHealth().getDetectionTaskStatus() != null) {\n+          long lastTaskExecutionTime = config.getHealth().getDetectionTaskStatus().getLastTaskExecutionTime();\n+          if (updateTime.getTime() <= currentTimeMills - maxTaskFailMills && (lastTaskExecutionTime == -1L", "originalCommit": "010a571405362815894629caeebf5cd4f344d50a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0NTExNA==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r407145114", "bodyText": "lastTaskExecutionTime == -1L is used for backward compatibility.\nCurrently we have many long failing alerts have -1L.", "author": "xiaohui-sun", "createdAt": "2020-04-12T04:42:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNTIxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNjE2OQ==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405816169", "bodyText": "Clubbing them into one log statement might be easier to debug.", "author": "akshayrai", "createdAt": "2020-04-08T21:08:51Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {\n+    DetectionConfigManager detectionDAO = DAO_REGISTRY.getDetectionConfigManager();\n+    List<DetectionConfigDTO> detectionConfigs = detectionDAO.findAllActive();\n+    long currentTimeMills = System.currentTimeMillis();\n+    long maxTaskFailMills = TimeUnit.DAYS.toMillis(MAX_FAILED_DISABLE_DAYS);\n+    for (DetectionConfigDTO config : detectionConfigs) {\n+      try {\n+        Timestamp updateTime = config.getUpdateTime();\n+        if (updateTime != null && config.getHealth() != null && config.getHealth().getDetectionTaskStatus() != null) {\n+          long lastTaskExecutionTime = config.getHealth().getDetectionTaskStatus().getLastTaskExecutionTime();\n+          if (updateTime.getTime() <= currentTimeMills - maxTaskFailMills && (lastTaskExecutionTime == -1L\n+              || lastTaskExecutionTime <= currentTimeMills - maxTaskFailMills)) {\n+            config.setActive(false);\n+            detectionDAO.update(config);\n+            sendDisableAlertNotificationEmail(config);\n+            LOG.info(\"Disabled alert \" + config.getId() + \" since it failed more than \" + MAX_FAILED_DISABLE_DAYS + \" days\");\n+            LOG.info(\"Task last update time: \" + config.getUpdateTime());\n+            LOG.info(\"Last success task execution time: \" + lastTaskExecutionTime);", "originalCommit": "010a571405362815894629caeebf5cd4f344d50a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxODQ2NA==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405818464", "bodyText": "What if the alert was updated(after receiving the below notification) and it still continues to fail? We don't want to disable & notify them again?", "author": "akshayrai", "createdAt": "2020-04-08T21:13:29Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.", "originalCommit": "010a571405362815894629caeebf5cd4f344d50a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0NjI0NQ==", "url": "https://github.com/apache/pinot/pull/5208#discussion_r407146245", "bodyText": "Yes we want to handle it more conservatively. Give them 30 days grace period.", "author": "xiaohui-sun", "createdAt": "2020-04-12T04:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxODQ2NA=="}], "type": "inlineReview"}, {"oid": "da29f688886f2af28abd75948e97fbdf8392752a", "url": "https://github.com/apache/pinot/commit/da29f688886f2af28abd75948e97fbdf8392752a", "message": "[TE] Updated typo and logs for disabling alerts", "committedDate": "2020-04-12T05:04:38Z", "type": "commit"}]}