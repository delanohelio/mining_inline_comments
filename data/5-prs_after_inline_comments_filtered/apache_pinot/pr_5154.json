{"pr_number": 5154, "pr_title": "Fix the NPE for DISTINCT aggregation function when no record is selected", "pr_createdAt": "2020-03-15T22:54:40Z", "pr_url": "https://github.com/apache/pinot/pull/5154", "timeline": [{"oid": "8dd77cff736fb66a926c40c499b7711140637e02", "url": "https://github.com/apache/pinot/commit/8dd77cff736fb66a926c40c499b7711140637e02", "message": "Fix the NPE for DISTINCT aggregation function when no record is selected\n\nWhen no record is selected for the whole table, column data type will be STRING for all distinct columns (by Pinot convention)", "committedDate": "2020-03-15T22:56:57Z", "type": "commit"}, {"oid": "8dd77cff736fb66a926c40c499b7711140637e02", "url": "https://github.com/apache/pinot/commit/8dd77cff736fb66a926c40c499b7711140637e02", "message": "Fix the NPE for DISTINCT aggregation function when no record is selected\n\nWhen no record is selected for the whole table, column data type will be STRING for all distinct columns (by Pinot convention)", "committedDate": "2020-03-15T22:56:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNjc2Nw==", "url": "https://github.com/apache/pinot/pull/5154#discussion_r394906767", "bodyText": "I think this is the scenario when the overall result set of DISTINCT query at table level is empty and was throwing NPE as DistinctTable was null.\nCan we please also add a test where the overall result at table level is non-empty but one or more segment returns empty?\nThen we have everything  covered.", "author": "siddharthteotia", "createdAt": "2020-03-19T09:54:13Z", "path": "pinot-core/src/test/java/org/apache/pinot/queries/DistinctQueriesTest.java", "diffHunk": "@@ -685,6 +694,18 @@ public void testDistinctWithFilter()\n         sortedResults.add(new Record(new Object[]{\"California\", \"San Mateo\", 400000}));\n         sortedResults.add(new Record(new Object[]{\"California\", \"Sunnyvale\", 300000}));\n         runQueryInterSegmentWithOrderBy(orderByQuery, sortedResults, new String[]{\"State\", \"City\", \"SaleAmount\"});\n+\n+        String emptyResultQuery =", "originalCommit": "8dd77cff736fb66a926c40c499b7711140637e02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk0MTEzOQ==", "url": "https://github.com/apache/pinot/pull/5154#discussion_r394941139", "bodyText": "Now that I think more about it, I don't think this solution will work for the case when result from all segments on a single server is empty but across the servers is non empty.\nThe current solution would have sent. a Distinct table from the server with string types. However when the broker reduces distinct tables across server, it might choose the result column types as string if the server that sent empty distinct tables happens to be the 0th server. The broker has to decide the result column types for.the final response and it does that upfront by looking at the column types from first server's table since it assumes they will be the same (they should be in general cases except for this corner case). This will be wrong.", "author": "siddharthteotia", "createdAt": "2020-03-19T10:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNjc2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk0MTU1Mg==", "url": "https://github.com/apache/pinot/pull/5154#discussion_r394941552", "bodyText": "We need to introduce some hacky way of knowing this scenario in the broker.reduce code.", "author": "siddharthteotia", "createdAt": "2020-03-19T10:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNjc2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyMTUwOQ==", "url": "https://github.com/apache/pinot/pull/5154#discussion_r395221509", "bodyText": "As long as it is using the DistinctAggregationFunction.merge() to merge the DistinctTables, it is handled. Check the fix in  DistinctAggregationFunction.merge().\nLet me try to enhance the test to cover that.", "author": "Jackie-Jiang", "createdAt": "2020-03-19T18:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNjc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNzg5MQ==", "url": "https://github.com/apache/pinot/pull/5154#discussion_r394907891", "bodyText": "I am unable to recall why I had this if check. I think there was a code-path where null broker request could have been passed. It is not possible right?", "author": "siddharthteotia", "createdAt": "2020-03-19T09:55:59Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java", "diffHunk": "@@ -112,8 +111,10 @@ public static AggregationFunction getAggregationFunction(AggregationInfo aggrega\n           case DISTINCTCOUNTRAWHLLMV:\n             return new DistinctCountRawHLLMVAggregationFunction();\n           case DISTINCT:\n+            Preconditions.checkState(brokerRequest != null,\n+                \"Broker request must be provided for 'DISTINCT' aggregation function\");\n             return new DistinctAggregationFunction(AggregationFunctionUtils.getColumn(aggregationInfo),\n-                brokerRequest != null ? brokerRequest.getLimit() : SelectAstNode.DEFAULT_RECORD_LIMIT, brokerRequest.getOrderBy());\n+                brokerRequest.getOrderBy(), brokerRequest.getLimit());", "originalCommit": "8dd77cff736fb66a926c40c499b7711140637e02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxOTQ2Mw==", "url": "https://github.com/apache/pinot/pull/5154#discussion_r395219463", "bodyText": "The existing code never works for null brokerRequest because brokerRequest.getOrderBy() will directly throw NPE. The broker aggregation reducer might call this without brokerRequest, but distinct is not using that code path to reduce the result.\nI added TODOs in AggregationFunctionUtils to always pass broker request for all code paths", "author": "Jackie-Jiang", "createdAt": "2020-03-19T18:01:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNzg5MQ=="}], "type": "inlineReview"}]}