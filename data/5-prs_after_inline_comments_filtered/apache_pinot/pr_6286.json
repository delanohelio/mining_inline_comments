{"pr_number": 6286, "pr_title": "Adding offline dimension table creation and segment assignment", "pr_createdAt": "2020-11-23T22:48:02Z", "pr_url": "https://github.com/apache/pinot/pull/6286", "timeline": [{"oid": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "url": "https://github.com/apache/pinot/commit/a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "message": "Adding offline dim table creation and assignment", "committedDate": "2020-11-23T23:18:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2Mjk0OA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r529762948", "bodyText": "empty line", "author": "yupeng9", "createdAt": "2020-11-24T17:44:18Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -133,6 +135,10 @@ private void checkReplication(InstancePartitions instancePartitions) {\n   private List<String> assignSegment(String segmentName, Map<String, Map<String, String>> currentAssignment,\n       InstancePartitions instancePartitions) {\n     int numReplicaGroups = instancePartitions.getNumReplicaGroups();\n+    if (_isDimTable) {\n+", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NDI1NA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r529764254", "bodyText": "why only 1 replica? I thought it will be on every host, so it shall be as many as the hosts?", "author": "yupeng9", "createdAt": "2020-11-24T17:46:23Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/SegmentAssignmentUtils.java", "diffHunk": "@@ -87,6 +87,15 @@ private SegmentAssignmentUtils() {\n     return instances;\n   }\n \n+  static List<String> getInstancesForDimTable(InstancePartitions instancePartitions) {\n+    Preconditions\n+            .checkState(instancePartitions.getNumReplicaGroups() == 1 && instancePartitions.getNumPartitions() == 1,\n+                    \"Instance partitions: %s should contain 1 replica and 1 partition for a dim table\",", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE2MjM4Ng==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r533162386", "bodyText": "Removed this way of gathering hosts and now getting hosts from a given tag directly. In this case the replication number as such will be disregarded and by default we will assign to all the segment to all the hosts", "author": "dharakk", "createdAt": "2020-12-01T08:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NDI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NDkxMg==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r529764912", "bodyText": "add some javadoc explaining that DIMENSION is a special type of OFFLINE", "author": "yupeng9", "createdAt": "2020-11-24T17:47:27Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/TableDataManagerType.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager;\n+\n+public enum TableDataManagerType {\n+    OFFLINE, REALTIME, DIMENSION", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE2MjY0MQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r533162641", "bodyText": "Removed the newly added type, keeping on the boolean isDimTable check", "author": "dharakk", "createdAt": "2020-12-01T08:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NDkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NTQ0OA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r529765448", "bodyText": "equalsIgnoreCase", "author": "yupeng9", "createdAt": "2020-11-24T17:48:17Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/config/TableDataManagerConfig.java", "diffHunk": "@@ -79,7 +81,10 @@ public static TableDataManagerConfig getDefaultHelixTableDataManagerConfig(\n   public void overrideConfigs(@Nonnull TableConfig tableConfig) {\n     // Override table level configs\n \n-    // Currently we do not override any table level configs into TableDataManagerConfig\n+    if (tableConfig.getIsDimTable() != null && tableConfig.getIsDimTable().equals(\"true\")) {", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NjA0NQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r529766045", "bodyText": "do we need DimTableDataManager? or enhance OfflineTableDataManager", "author": "yupeng9", "createdAt": "2020-11-24T17:49:11Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/offline/TableDataManagerProvider.java", "diffHunk": "@@ -51,13 +52,17 @@ public static TableDataManager getTableDataManager(@Nonnull TableDataManagerConf\n       @Nonnull String instanceId, @Nonnull ZkHelixPropertyStore<ZNRecord> propertyStore,\n       @Nonnull ServerMetrics serverMetrics, @Nonnull HelixManager helixManager) {\n     TableDataManager tableDataManager;\n-    switch (TableType.valueOf(tableDataManagerConfig.getTableDataManagerType())) {\n+    switch (TableDataManagerType.valueOf(tableDataManagerConfig.getTableDataManagerType())) {\n       case OFFLINE:\n         tableDataManager = new OfflineTableDataManager();\n         break;\n       case REALTIME:\n         tableDataManager = new RealtimeTableDataManager(_segmentBuildSemaphore);\n         break;\n+      case DIMENSION:\n+        // TODO: Create a DimTableDataManager here when available", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE2NTEyOA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r533165128", "bodyText": "DimTableManager will have a lot of specific themes related to preloading the table and also storing the dim table static map, thus it will muddy the OfflineTableDataManager unnecessarily. Thus, we are thinking of extending the OfflineTableDataManager in the new manager class to implement the extra functionality. We can discuss this in following PRs as well.", "author": "dharakk", "createdAt": "2020-12-01T08:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NjA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NjIxMA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r529766210", "bodyText": "whether", "author": "yupeng9", "createdAt": "2020-11-24T17:49:26Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/table/TableConfig.java", "diffHunk": "@@ -62,6 +63,9 @@\n   @JsonPropertyDescription(value = \"The type of the table (OFFLINE|REALTIME) (mandatory)\")\n   private final TableType _tableType;\n \n+  @JsonPropertyDescription(\"Indicates weather the table is a dimension table or not\")", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNTM2Mw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r529805363", "bodyText": "We don't need instance partitions for dimTable. It should be assigned to all the instances under the given tag", "author": "Jackie-Jiang", "createdAt": "2020-11-24T18:52:45Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/SegmentAssignmentUtils.java", "diffHunk": "@@ -87,6 +87,15 @@ private SegmentAssignmentUtils() {\n     return instances;\n   }\n \n+  static List<String> getInstancesForDimTable(InstancePartitions instancePartitions) {", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE2NTk5Ng==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r533165996", "bodyText": "Removed this way of gathering hosts, now explicitly returning all the hosts under a given tag as you suggested", "author": "dharakk", "createdAt": "2020-12-01T08:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNTM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMDk1Nw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r529810957", "bodyText": "If possible, let's not introduce this new type. One option is to add the DIMENSION as a TableType, but I'm not sure if we are going to support real-time dimTable in the future (we can add another REALTIME_DIMENSION maybe)", "author": "Jackie-Jiang", "createdAt": "2020-11-24T19:02:03Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/TableDataManagerType.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager;\n+\n+public enum TableDataManagerType {", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE3MDQwMA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r533170400", "bodyText": "I refrained from adding a new table type because of the following two reasons:\n\nSince ingestion mode is still offline, it seems appropriate that table type still remain OFFLINE\nAdding a new type would be an invasive change and I wasn't sure of the blast radius.\n\nInstead of adding a new TableDataManagerType I have now added a boolean similar to how we are identifying the dim table in table config. Even for a future realtime dim table, this approach should work. Does this approach look good?", "author": "dharakk", "createdAt": "2020-12-01T08:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMDk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxNDk4Mw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r535414983", "bodyText": "Some suggestions: We could use TableSubtype maybe. And make it an enum so that we have some room in the future. I am not sure if, for example, a different layout of a larger table can also support joins.", "author": "mcvsubbu", "createdAt": "2020-12-03T17:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMDk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNDgwNA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r544714804", "bodyText": "@dharakk  why was this suggestion not implemented?", "author": "mcvsubbu", "createdAt": "2020-12-17T00:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMDk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMjc3OA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r530122778", "bodyText": "can we add a new subclass of OfflineSegmentAssignment instead of using a boolean check?", "author": "chenboat", "createdAt": "2020-11-25T05:51:11Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -133,6 +135,10 @@ private void checkReplication(InstancePartitions instancePartitions) {\n   private List<String> assignSegment(String segmentName, Map<String, Map<String, String>> currentAssignment,\n       InstancePartitions instancePartitions) {\n     int numReplicaGroups = instancePartitions.getNumReplicaGroups();\n+    if (_isDimTable) {", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE3MTcyMA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r533171720", "bodyText": "Thanks for the suggestion, this makes the code much cleaner and also allows to add an implementation of rebalanceTable method.", "author": "dharakk", "createdAt": "2020-12-01T08:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMjc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMjg2MQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r530122861", "bodyText": "Add a test?", "author": "chenboat", "createdAt": "2020-11-25T05:51:27Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/SegmentAssignmentUtils.java", "diffHunk": "@@ -87,6 +87,15 @@ private SegmentAssignmentUtils() {\n     return instances;\n   }\n \n+  static List<String> getInstancesForDimTable(InstancePartitions instancePartitions) {", "originalCommit": "a13ebf2ce03e2d5216371e86620ecb1506a4bf3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33dd715ce48acb3d081dd18c6f852a66d6ff09f8", "url": "https://github.com/apache/pinot/commit/33dd715ce48acb3d081dd18c6f852a66d6ff09f8", "message": "Adding offline dim table creation and assignment", "committedDate": "2020-12-01T08:43:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU3ODM0NQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r533578345", "bodyText": "I don't understand why we sort the instances and rotate if we are returning all instances for assignment. Can you add some comments as to why this is being done?", "author": "mcvsubbu", "createdAt": "2020-12-01T17:08:32Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+    private HelixManager _helixManager;\n+    private String _offlineTableName;\n+    private boolean _isDimTable;\n+    private TenantConfig _tenantConfig;\n+\n+    @Override\n+    public void init(HelixManager helixManager, TableConfig tableConfig) {\n+        _helixManager = helixManager;\n+        _offlineTableName = tableConfig.getTableName();\n+        _tenantConfig = tableConfig.getTenantConfig();\n+        _isDimTable = Boolean.parseBoolean(tableConfig.getIsDimTable());\n+        Preconditions.checkState(_isDimTable, \"Not a dimension table: %s\" + _offlineTableName);\n+    }\n+\n+    @Override\n+    public List<String> assignSegment(String segmentName, Map<String, Map<String, String>> currentAssignment, Map<InstancePartitionsType, InstancePartitions> instancePartitionsMap) {\n+        String serverTag = TagNameUtils.extractOfflineServerTag(_tenantConfig);\n+\n+        List<String> instances = HelixHelper.getInstancesWithTag(_helixManager, serverTag);\n+        int numInstances = instances.size();\n+        Preconditions.checkState(numInstances > 0, \"No instance found with tag: %s\", serverTag);\n+\n+        // Sort the instances and rotate the list based on the table name", "originalCommit": "33dd715ce48acb3d081dd18c6f852a66d6ff09f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1MDYzNw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r534650637", "bodyText": "I was taking my cue from other places where we were getting all the instances under a tag, but you are right there is no need here, removed it.", "author": "dharakk", "createdAt": "2020-12-03T04:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU3ODM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU3OTA2OQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r533579069", "bodyText": "Your indentation is off. Can you please import pinot coding conventions?", "author": "mcvsubbu", "createdAt": "2020-12-01T17:09:37Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+    private HelixManager _helixManager;", "originalCommit": "33dd715ce48acb3d081dd18c6f852a66d6ff09f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQyNDE4OQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r534424189", "bodyText": "Can you add javadoc to this new class? It should explain what is the property of the new DimTableSegmentAssignment? Also its differences with other SegmentAssignment strategies.", "author": "chenboat", "createdAt": "2020-12-02T19:25:06Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {", "originalCommit": "33dd715ce48acb3d081dd18c6f852a66d6ff09f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "url": "https://github.com/apache/pinot/commit/f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "message": "Adding offline dim table creation and assignment", "committedDate": "2020-12-03T03:42:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5NTUwNA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537795504", "bodyText": "Store as boolean for clarity?", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:05:14Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/config/TableConfigUtils.java", "diffHunk": "@@ -58,6 +58,7 @@ public static TableConfig fromZNRecord(ZNRecord znRecord)\n     String tableName = znRecord.getId();\n \n     String tableType = simpleFields.get(TableConfig.TABLE_TYPE_KEY);\n+    String isDimTable = simpleFields.get(TableConfig.IS_DIM_TABLE_KEY);", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5Nzg4Ng==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537797886", "bodyText": "No need to assign per segment. Fetch the instances with the tag once, and construct the new assignment", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:09:15Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+\n+/**\n+ * Segment assignment for an offline dimension table.\n+ * <ul>\n+ *   <li>\n+ *     <p>This segment assignment strategy is used when {@link TableConfig#IS_DIM_TABLE_KEY}is\n+ *     set to \"true\".</p>\n+ *   </li>\n+ *   <li>\n+ *     <p>For a dimension table we assign the segment to all the hosts Thus for this assignment\n+ *     strategy we simply return all the hosts under a given tag as the assigned hosts for\n+ *     a given segment.</p>\n+ *   </li>\n+ * </ul>\n+ */\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+  private HelixManager _helixManager;\n+  private String _offlineTableName;\n+  private boolean _isDimTable;\n+  private TenantConfig _tenantConfig;\n+\n+  @Override\n+  public void init(HelixManager helixManager, TableConfig tableConfig) {\n+    _helixManager = helixManager;\n+    _offlineTableName = tableConfig.getTableName();\n+    _tenantConfig = tableConfig.getTenantConfig();\n+    _isDimTable = Boolean.parseBoolean(tableConfig.getIsDimTable());\n+    Preconditions.checkState(_isDimTable, \"Not a dimension table: %s\" + _offlineTableName);\n+  }\n+\n+  @Override\n+  public List<String> assignSegment(String segmentName, Map<String, Map<String, String>> currentAssignment,\n+      Map<InstancePartitionsType, InstancePartitions> instancePartitionsMap) {\n+    String serverTag = TagNameUtils.extractOfflineServerTag(_tenantConfig);\n+\n+    List<String> instances = HelixHelper.getInstancesWithTag(_helixManager, serverTag);\n+    int numInstances = instances.size();\n+    Preconditions.checkState(numInstances > 0, \"No instance found with tag: %s\", serverTag);\n+\n+    return instances;\n+  }\n+\n+  @Override\n+  public Map<String, Map<String, String>> rebalanceTable(Map<String, Map<String, String>> currentAssignment,\n+      Map<InstancePartitionsType, InstancePartitions> instancePartitionsMap, @Nullable List<Tier> sortedTiers,\n+      @Nullable Map<String, InstancePartitions> tierInstancePartitionsMap, Configuration config) {\n+    Map<String, Map<String, String>> newAssignment = new TreeMap<>();\n+    for (String segment : currentAssignment.keySet()) {", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5ODEzNw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537798137", "bodyText": "No need to keep this member variable", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:09:33Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+\n+/**\n+ * Segment assignment for an offline dimension table.\n+ * <ul>\n+ *   <li>\n+ *     <p>This segment assignment strategy is used when {@link TableConfig#IS_DIM_TABLE_KEY}is\n+ *     set to \"true\".</p>\n+ *   </li>\n+ *   <li>\n+ *     <p>For a dimension table we assign the segment to all the hosts Thus for this assignment\n+ *     strategy we simply return all the hosts under a given tag as the assigned hosts for\n+ *     a given segment.</p>\n+ *   </li>\n+ * </ul>\n+ */\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+  private HelixManager _helixManager;\n+  private String _offlineTableName;\n+  private boolean _isDimTable;", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5ODg0Mw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537798843", "bodyText": "(nit)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (tableConfig.getTableType() == TableType.OFFLINE && Boolean.parseBoolean(tableConfig.getIsDimTable())) {\n          \n          \n            \n                  segmentAssignment = new OfflineDimTableSegmentAssignment();\n          \n          \n            \n                } else if (tableConfig.getTableType() == TableType.OFFLINE) {\n          \n          \n            \n                if (tableConfig.getTableType() == TableType.OFFLINE) {\n          \n          \n            \n                  return tableConfig.isDimTable() ? new OfflineDimTableSegmentAssignment() : new OfflineSegmentAssignment();\n          \n          \n            \n                }", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:10:44Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/SegmentAssignmentFactory.java", "diffHunk": "@@ -32,7 +32,9 @@ private SegmentAssignmentFactory() {\n \n   public static SegmentAssignment getSegmentAssignment(HelixManager helixManager, TableConfig tableConfig) {\n     SegmentAssignment segmentAssignment;\n-    if (tableConfig.getTableType() == TableType.OFFLINE) {\n+    if (tableConfig.getTableType() == TableType.OFFLINE && Boolean.parseBoolean(tableConfig.getIsDimTable())) {\n+      segmentAssignment = new OfflineDimTableSegmentAssignment();\n+    } else if (tableConfig.getTableType() == TableType.OFFLINE) {", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDQ0NQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537800445", "bodyText": "We should not have this config on instance level. It does not make sense for a server to only serve dimension table", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:13:19Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/config/TableDataManagerConfig.java", "diffHunk": "@@ -35,6 +35,7 @@\n   private static final String TABLE_DATA_MANAGER_DATA_DIRECTORY = \"directory\";\n   private static final String TABLE_DATA_MANAGER_CONSUMER_DIRECTORY = \"consumerDirectory\";\n   private static final String TABLE_DATA_MANAGER_NAME = \"name\";\n+  private static final String TABLE_IS_DIMENSION = \"isDimTable\";", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMDI5Nw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539100297", "bodyText": "Sorry, I didn't quite get this, can you elaborate?", "author": "dharakk", "createdAt": "2020-12-09T08:23:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU2MzA5MQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539563091", "bodyText": "The config in this class is for server specific config (the location of the data directory etc.). We should not keep the isDimTable() info in this class, it should be in table config only. Also, I don't think isDimTable() is used", "author": "Jackie-Jiang", "createdAt": "2020-12-09T18:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDYxMg==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537800612", "bodyText": "Store boolean instead of String", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:13:38Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/table/TableConfig.java", "diffHunk": "@@ -62,6 +63,9 @@\n   @JsonPropertyDescription(value = \"The type of the table (OFFLINE|REALTIME) (mandatory)\")\n   private final TableType _tableType;\n \n+  @JsonPropertyDescription(\"Indicates whether the table is a dimension table or not\")\n+  private final String _isDimTable;", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDc5Mw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537800793", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public String getIsDimTable() {\n          \n          \n            \n              public boolean isDimTable() {", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:13:57Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/table/TableConfig.java", "diffHunk": "@@ -142,6 +148,11 @@ public TableType getTableType() {\n     return _tableType;\n   }\n \n+  @JsonProperty(IS_DIM_TABLE_KEY)\n+  public String getIsDimTable() {", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDkxNw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537800917", "bodyText": "Store boolean", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:14:14Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/utils/builder/TableConfigBuilder.java", "diffHunk": "@@ -55,6 +55,7 @@\n \n   private final TableType _tableType;\n   private String _tableName;\n+  private String _isDimTable;", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMTgzNQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r537801835", "bodyText": "Don't add this quick start yet. We can add it along with the lookup feature support", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:15:45Z", "path": "pinot-tools/src/main/java/org/apache/pinot/tools/JoinQuickStart.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.tools;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.pinot.spi.plugin.PluginManager;\n+import org.apache.pinot.tools.admin.command.QuickstartRunner;\n+\n+import java.io.File;\n+import java.net.URL;\n+\n+import static org.apache.pinot.tools.Quickstart.prettyPrintResponse;\n+import static org.apache.pinot.tools.Quickstart.printStatus;\n+\n+\n+public class JoinQuickStart {", "originalCommit": "f0071f18a6834f65ed0c0137d3a222a0205ed9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "31e352220fb05a2466ab123215e741939f4b44bb", "url": "https://github.com/apache/pinot/commit/31e352220fb05a2466ab123215e741939f4b44bb", "message": "Adding offline dim table creation and assignment", "committedDate": "2020-12-09T08:21:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1ODkxMw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539558913", "bodyText": "Wrong import", "author": "Jackie-Jiang", "createdAt": "2020-12-09T18:48:05Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/config/TableConfigUtils.java", "diffHunk": "@@ -21,6 +21,7 @@\n import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.core.type.TypeReference;\n import com.google.common.base.Preconditions;\n+import com.sun.org.apache.xpath.internal.operations.Bool;", "originalCommit": "31e352220fb05a2466ab123215e741939f4b44bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2a0eb3703133c2cb3eacade83d3e4cfbae73e19f", "url": "https://github.com/apache/pinot/commit/2a0eb3703133c2cb3eacade83d3e4cfbae73e19f", "message": "Adding offline dim table creation and assignment", "committedDate": "2020-12-09T20:43:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NTk5Mg==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539685992", "bodyText": "Thus -> . Thus", "author": "yupeng9", "createdAt": "2020-12-09T22:11:08Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+\n+/**\n+ * Segment assignment for an offline dimension table.\n+ * <ul>\n+ *   <li>\n+ *     <p>This segment assignment strategy is used when {@link TableConfig#IS_DIM_TABLE_KEY}is\n+ *     set to \"true\".</p>\n+ *   </li>\n+ *   <li>\n+ *     <p>For a dimension table we assign the segment to all the hosts Thus for this assignment", "originalCommit": "2a0eb3703133c2cb3eacade83d3e4cfbae73e19f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NjcxMA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539686710", "bodyText": "final", "author": "yupeng9", "createdAt": "2020-12-09T22:12:21Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+\n+/**\n+ * Segment assignment for an offline dimension table.\n+ * <ul>\n+ *   <li>\n+ *     <p>This segment assignment strategy is used when {@link TableConfig#IS_DIM_TABLE_KEY}is\n+ *     set to \"true\".</p>\n+ *   </li>\n+ *   <li>\n+ *     <p>For a dimension table we assign the segment to all the hosts Thus for this assignment\n+ *     strategy we simply return all the hosts under a given tag as the assigned hosts for\n+ *     a given segment.</p>\n+ *   </li>\n+ * </ul>\n+ */\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+  private HelixManager _helixManager;", "originalCommit": "2a0eb3703133c2cb3eacade83d3e4cfbae73e19f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNjEwNQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539726105", "bodyText": "Unable to make these final as the initialization is happening in init() method and not the constructor.", "author": "dharakk", "createdAt": "2020-12-09T23:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NjcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4Njc3MA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539686770", "bodyText": "final", "author": "yupeng9", "createdAt": "2020-12-09T22:12:27Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+\n+/**\n+ * Segment assignment for an offline dimension table.\n+ * <ul>\n+ *   <li>\n+ *     <p>This segment assignment strategy is used when {@link TableConfig#IS_DIM_TABLE_KEY}is\n+ *     set to \"true\".</p>\n+ *   </li>\n+ *   <li>\n+ *     <p>For a dimension table we assign the segment to all the hosts Thus for this assignment\n+ *     strategy we simply return all the hosts under a given tag as the assigned hosts for\n+ *     a given segment.</p>\n+ *   </li>\n+ * </ul>\n+ */\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+  private HelixManager _helixManager;\n+  private String _offlineTableName;\n+  private TenantConfig _tenantConfig;", "originalCommit": "2a0eb3703133c2cb3eacade83d3e4cfbae73e19f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNjIzNA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539726234", "bodyText": "Same as above", "author": "dharakk", "createdAt": "2020-12-09T23:30:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4Njc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc0OTE5Ng==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539749196", "bodyText": "ah, right. I missed that", "author": "yupeng9", "createdAt": "2020-12-10T00:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4Njc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4Njk1Nw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539686957", "bodyText": "nit: precondition goes to the top", "author": "yupeng9", "createdAt": "2020-12-09T22:12:48Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+\n+/**\n+ * Segment assignment for an offline dimension table.\n+ * <ul>\n+ *   <li>\n+ *     <p>This segment assignment strategy is used when {@link TableConfig#IS_DIM_TABLE_KEY}is\n+ *     set to \"true\".</p>\n+ *   </li>\n+ *   <li>\n+ *     <p>For a dimension table we assign the segment to all the hosts Thus for this assignment\n+ *     strategy we simply return all the hosts under a given tag as the assigned hosts for\n+ *     a given segment.</p>\n+ *   </li>\n+ * </ul>\n+ */\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+  private HelixManager _helixManager;\n+  private String _offlineTableName;\n+  private TenantConfig _tenantConfig;\n+\n+  @Override\n+  public void init(HelixManager helixManager, TableConfig tableConfig) {\n+    _helixManager = helixManager;\n+    _offlineTableName = tableConfig.getTableName();\n+    _tenantConfig = tableConfig.getTenantConfig();\n+    Preconditions.checkState(tableConfig.isDimTable(), \"Not a dimension table: %s\" + _offlineTableName);", "originalCommit": "2a0eb3703133c2cb3eacade83d3e4cfbae73e19f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NzYzNw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539687637", "bodyText": "I think empty instance is valid? Shall this be a warning?", "author": "yupeng9", "createdAt": "2020-12-09T22:14:06Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+\n+/**\n+ * Segment assignment for an offline dimension table.\n+ * <ul>\n+ *   <li>\n+ *     <p>This segment assignment strategy is used when {@link TableConfig#IS_DIM_TABLE_KEY}is\n+ *     set to \"true\".</p>\n+ *   </li>\n+ *   <li>\n+ *     <p>For a dimension table we assign the segment to all the hosts Thus for this assignment\n+ *     strategy we simply return all the hosts under a given tag as the assigned hosts for\n+ *     a given segment.</p>\n+ *   </li>\n+ * </ul>\n+ */\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+  private HelixManager _helixManager;\n+  private String _offlineTableName;\n+  private TenantConfig _tenantConfig;\n+\n+  @Override\n+  public void init(HelixManager helixManager, TableConfig tableConfig) {\n+    _helixManager = helixManager;\n+    _offlineTableName = tableConfig.getTableName();\n+    _tenantConfig = tableConfig.getTenantConfig();\n+    Preconditions.checkState(tableConfig.isDimTable(), \"Not a dimension table: %s\" + _offlineTableName);\n+  }\n+\n+  @Override\n+  public List<String> assignSegment(String segmentName, Map<String, Map<String, String>> currentAssignment,\n+      Map<InstancePartitionsType, InstancePartitions> instancePartitionsMap) {\n+    String serverTag = TagNameUtils.extractOfflineServerTag(_tenantConfig);\n+\n+    List<String> instances = HelixHelper.getInstancesWithTag(_helixManager, serverTag);\n+    int numInstances = instances.size();\n+    Preconditions.checkState(numInstances > 0, \"No instance found with tag: %s\", serverTag);", "originalCommit": "2a0eb3703133c2cb3eacade83d3e4cfbae73e19f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyMDMyNQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539720325", "bodyText": "We don't allow empty instances. When creating the table, we check if there are instances for this table", "author": "Jackie-Jiang", "createdAt": "2020-12-09T23:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NzYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc0ODk4OQ==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539748989", "bodyText": "I see. But can the assignment happen post-creation? For example, what do you do after adding a new host.", "author": "yupeng9", "createdAt": "2020-12-10T00:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NzYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ2NzE0Nw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r540467147", "bodyText": "Yes it can. We can add more host to this tag (tenant), but if there is no host for the tag, we should throw exception because no server will host the segment", "author": "Jackie-Jiang", "createdAt": "2020-12-10T20:15:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NzYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5ODQ3Mw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539698473", "bodyText": "What do we do about the offline ones? Will we assign segments to them once they are back online?", "author": "yupeng9", "createdAt": "2020-12-09T22:32:50Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineDimTableSegmentAssignment.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.helix.core.assignment.segment;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.commons.configuration.Configuration;\n+import org.apache.helix.HelixManager;\n+import org.apache.pinot.common.assignment.InstancePartitions;\n+import org.apache.pinot.common.tier.Tier;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.common.utils.config.TagNameUtils;\n+import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.config.table.TenantConfig;\n+import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+\n+/**\n+ * Segment assignment for an offline dimension table.\n+ * <ul>\n+ *   <li>\n+ *     <p>This segment assignment strategy is used when {@link TableConfig#IS_DIM_TABLE_KEY}is\n+ *     set to \"true\".</p>\n+ *   </li>\n+ *   <li>\n+ *     <p>For a dimension table we assign the segment to all the hosts Thus for this assignment\n+ *     strategy we simply return all the hosts under a given tag as the assigned hosts for\n+ *     a given segment.</p>\n+ *   </li>\n+ * </ul>\n+ */\n+public class OfflineDimTableSegmentAssignment implements SegmentAssignment {\n+\n+  private HelixManager _helixManager;\n+  private String _offlineTableName;\n+  private TenantConfig _tenantConfig;\n+\n+  @Override\n+  public void init(HelixManager helixManager, TableConfig tableConfig) {\n+    _helixManager = helixManager;\n+    _offlineTableName = tableConfig.getTableName();\n+    _tenantConfig = tableConfig.getTenantConfig();\n+    Preconditions.checkState(tableConfig.isDimTable(), \"Not a dimension table: %s\" + _offlineTableName);\n+  }\n+\n+  @Override\n+  public List<String> assignSegment(String segmentName, Map<String, Map<String, String>> currentAssignment,\n+      Map<InstancePartitionsType, InstancePartitions> instancePartitionsMap) {\n+    String serverTag = TagNameUtils.extractOfflineServerTag(_tenantConfig);\n+\n+    List<String> instances = HelixHelper.getInstancesWithTag(_helixManager, serverTag);\n+    int numInstances = instances.size();\n+    Preconditions.checkState(numInstances > 0, \"No instance found with tag: %s\", serverTag);\n+\n+    return instances;\n+  }\n+\n+  @Override\n+  public Map<String, Map<String, String>> rebalanceTable(Map<String, Map<String, String>> currentAssignment,\n+      Map<InstancePartitionsType, InstancePartitions> instancePartitionsMap, @Nullable List<Tier> sortedTiers,\n+      @Nullable Map<String, InstancePartitions> tierInstancePartitionsMap, Configuration config) {\n+    String serverTag = TagNameUtils.extractOfflineServerTag(_tenantConfig);\n+    List<String> instances = HelixHelper.getInstancesWithTag(_helixManager, serverTag);\n+    Map<String, Map<String, String>> newAssignment = new TreeMap<>();\n+    for (String segment : currentAssignment.keySet()) {\n+      newAssignment.put(segment, SegmentAssignmentUtils\n+          .getInstanceStateMap(instances, CommonConstants.Helix.StateModel.SegmentStateModel.ONLINE));", "originalCommit": "2a0eb3703133c2cb3eacade83d3e4cfbae73e19f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyMDYxNA==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539720614", "bodyText": "This is ideal state, where we don't have OFFLINE state for the instance", "author": "Jackie-Jiang", "createdAt": "2020-12-09T23:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5ODQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc0OTAyNw==", "url": "https://github.com/apache/pinot/pull/6286#discussion_r539749027", "bodyText": "Makes sense", "author": "yupeng9", "createdAt": "2020-12-10T00:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5ODQ3Mw=="}], "type": "inlineReview"}, {"oid": "f63074429aedae31e97bcbd00a412b418fc71a94", "url": "https://github.com/apache/pinot/commit/f63074429aedae31e97bcbd00a412b418fc71a94", "message": "Adding offline dim table creation and assignment", "committedDate": "2020-12-09T23:28:18Z", "type": "commit"}, {"oid": "f63074429aedae31e97bcbd00a412b418fc71a94", "url": "https://github.com/apache/pinot/commit/f63074429aedae31e97bcbd00a412b418fc71a94", "message": "Adding offline dim table creation and assignment", "committedDate": "2020-12-09T23:28:18Z", "type": "forcePushed"}]}