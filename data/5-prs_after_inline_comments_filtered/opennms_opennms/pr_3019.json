{"pr_number": 3019, "pr_title": "NMS-12730: Meta-data tag enhancements to Time Series Storage API", "pr_createdAt": "2020-05-24T16:37:45Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3019", "timeline": [{"oid": "29ed20e23d9c09b9c3ee50355e21c02e23fd40bd", "url": "https://github.com/OpenNMS/opennms/commit/29ed20e23d9c09b9c3ee50355e21c02e23fd40bd", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: first version", "committedDate": "2020-05-24T16:27:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1NDc2NQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429654765", "bodyText": "Tags are unique by the combination of key and value. Thus we could have category tags like:\nTag(key=\"category\", value=\"myFirstCategory\"), Tag(key=\"category\", value=\"mySecondCategory\") etc.\nThe problem here is that we store the future tags as key value pairs in a Map<String, String>. That disallows us to store the tags with the same key since they have to be unique. I see two ways out of that:\n\nmake the keys unique like: Tag(key=\"category_1\", value=\"myFirstCategory\"), Tag(key=\"category_2\", value=\"mySecondCategory\")\nEnhance (by our own class) or substitute org.opennms.newts.api.Resource to store a set of Tags instead a Map of Strings\n\nThe first is the easier way (currently implemented) the second one more work but I guess the better way. I am not sure how we use the category tags later so it's hard for me to make a call here. @j-white What is your take?", "author": "patrick-schweizer", "createdAt": "2020-05-24T16:49:54Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/MetaTagDataLoader.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2006-2015 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2015 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.timeseries.integration.persistence;\n+\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.function.Supplier;\n+\n+import javax.inject.Inject;\n+\n+import org.opennms.netmgt.collection.api.CollectionResource;\n+import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.dao.api.SessionUtils;\n+import org.opennms.netmgt.model.OnmsAssetRecord;\n+import org.opennms.netmgt.model.OnmsCategory;\n+import org.opennms.netmgt.model.OnmsNode;\n+import org.opennms.netmgt.model.ResourceTypeUtils;\n+import org.opennms.netmgt.model.monitoringLocations.OnmsMonitoringLocation;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration.AssetTagKey;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration.MetaTagKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.base.Strings;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.collect.Maps;\n+\n+public class MetaTagDataLoader extends CacheLoader<CollectionResource, Map<String, String>> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(MetaTagDataLoader.class);\n+\n+    private final NodeDao nodeDao;\n+    private final SessionUtils sessionUtils;\n+    private MetaTagConfiguration config;\n+\n+    @Inject\n+    public MetaTagDataLoader(final NodeDao nodeDao, final SessionUtils sessionUtils) {\n+        this.nodeDao = nodeDao;\n+        this.sessionUtils = sessionUtils;\n+        setConfig(new MetaTagConfiguration(Maps.fromProperties(System.getProperties())));\n+    }\n+\n+    public void setConfig(final MetaTagConfiguration config) {\n+        this.config = config;\n+    }\n+\n+    public Map<String, String> load(final CollectionResource resource) {\n+        return sessionUtils.withReadOnlyTransaction(() -> {\n+            final Map<String, String> tags = new HashMap<>();\n+            addTag(tags, MetaTagKey.resourceLabel, () -> Optional.ofNullable(resource.getInterfaceLabel()).orElse(null));\n+\n+            if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_NODE)) {\n+                String nodeCriteria = getNodeCriteriaFromResource(resource);\n+                mapNode(tags, nodeCriteria);\n+            } else if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_IF)) {\n+\n+                String nodeCriteria = getNodeCriteriaFromResource(resource);\n+                if (!Strings.isNullOrEmpty(nodeCriteria)) {\n+                    mapNode(tags, nodeCriteria);\n+                }\n+            } else if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_LATENCY)) {\n+                mapResponseTimeResource(resource, tags);\n+            } else {\n+                String nodeCriteria = getNodeCriteriaFromResource(resource);\n+                if (!Strings.isNullOrEmpty(nodeCriteria)) {\n+                    mapNode(tags, nodeCriteria);\n+                }\n+            }\n+\n+            return tags;\n+        });\n+    }\n+\n+    private void mapNode(final Map<String, String> tags, final String nodeCriteria) {\n+        Optional<OnmsNode> node = getNode(nodeCriteria);\n+        addTag(tags, MetaTagKey.nodeCriteria, () -> nodeCriteria);\n+        addTag(tags, MetaTagKey.nodeLabel, () -> node.map(OnmsNode::getLabel).orElse(null));\n+        addTag(tags, MetaTagKey.location, () -> node.map(OnmsNode::getLocation).map(OnmsMonitoringLocation::getLocationName).orElse(null));\n+        addTag(tags, MetaTagKey.sysObjectID, () -> node.map(OnmsNode::getSysObjectId).orElse(null));\n+        addTag(tags, MetaTagKey.foreignSource, () -> node.map(OnmsNode::getForeignSource).orElse(null));\n+        addTag(tags, MetaTagKey.foreignId, () -> node.map(OnmsNode::getForeignId).orElse(null));\n+        // TODO Patrick: map rest of attributes\n+\n+        // categories\n+        if(node.isPresent()) {\n+            AtomicInteger n = new AtomicInteger(1);\n+            // Tags are only unique by key and value\n+            node.get().getCategories().stream()\n+                    .map(OnmsCategory::getName)\n+                    .filter(config::isCategoryEnabled)\n+                    // TODO: Patrick: is this acceptable? Or would we rather create Tags instead of a HashMap?", "originalCommit": "29ed20e23d9c09b9c3ee50355e21c02e23fd40bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk2MTM5OA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429961398", "bodyText": "I was thinking we could do something like this:\nfor(String categoryName : categoryNames) {\n  if (!enabledCategoryNames.contains(categoryName)) {\n      continue;\n   }\n  addTag(tags, \"cat\" + categoryName, categoryName);\n}", "author": "j-white", "createdAt": "2020-05-25T14:22:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1NDc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3Njk4Ng==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r430076986", "bodyText": "\ud83d\udc4d fixed", "author": "patrick-schweizer", "createdAt": "2020-05-25T21:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1NDc2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1NDgzOA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429654838", "bodyText": "@j-white what do you have here in mind? Do we have already something similar?", "author": "patrick-schweizer", "createdAt": "2020-05-24T16:50:44Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/MetaTagConfiguration.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+package org.opennms.netmgt.timeseries.integration;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/** Defines which additional meta tags should be exposed to the timeseries integration plugin. */\n+public class MetaTagConfiguration {\n+\n+    final static String PREFIX = \"org.opennms.timeseries.tin.metatags\";\n+\n+    /** properties defined in opennms.properties */\n+    public enum PropertyKey {\n+        assets,\n+        tags,\n+        categories\n+    }\n+\n+    public enum MetaTagKey {\n+        nodeLabel,\n+        location,\n+        sysObjectID,\n+        foreignSource,\n+        foreignId,\n+        nodeCriteria,\n+        ipAddress, // for response time resources\n+        service, // for response time resources\n+        ifDescr, // for interface resources\n+        ifAlias, // for interface resources\n+        resourceLabel\n+    }\n+\n+    // TODO: Patrick: do we want to merge MetaTagKey & AssetTagKey?\n+    public enum AssetTagKey {\n+        admin, additionalHardware, assetNumber,\n+    }\n+\n+    private final Set<MetaTagKey> enabledMetaTags;\n+    private final Set<String> enabledCategories;\n+    private final Set<AssetTagKey> enabledAssets;\n+\n+    public MetaTagConfiguration(final Map<String, String> properties) {\n+\n+        final Set<String> configuredAssets = getAsList(getProperty(properties, PropertyKey.assets));\n+        enabledAssets = Arrays\n+                .stream(AssetTagKey.values())\n+                .filter(key -> configuredAssets.contains(key.name()))\n+                .collect(Collectors.toSet());\n+\n+        enabledCategories = getAsList(getProperty(properties, PropertyKey.categories));\n+\n+        final Set<String> configuredTags = getAsList(getProperty(properties, PropertyKey.tags));\n+        enabledMetaTags = Arrays\n+                .stream(MetaTagKey.values())\n+                .filter(key -> configuredTags.contains(key.name()))\n+                .collect(Collectors.toSet());\n+\n+        // TODO: Patrick Meta-Data DSL expressions to build tags", "originalCommit": "29ed20e23d9c09b9c3ee50355e21c02e23fd40bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk1ODc0OA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429958748", "bodyText": "We can evaluate meta-data DSL expressions similarly to what is done here: https://github.com/OpenNMS/opennms/blob/opennms-26.1.0-1/core/ipc/rpc/shell-commands/src/main/java/org/opennms/core/rpc/commands/MetaCommand.java#L95", "author": "j-white", "createdAt": "2020-05-25T14:17:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1NDgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1NDg5Mw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429654893", "bodyText": "@j-white how often do we expect the Resource Meta Data to change / what should our eviction policy be?", "author": "patrick-schweizer", "createdAt": "2020-05-24T16:51:43Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/TimeseriesPersisterFactory.java", "diffHunk": "@@ -47,13 +52,19 @@\n public class TimeseriesPersisterFactory implements PersisterFactory {\n \n     private final TimeseriesWriter timeseriesWriter;\n-\n     private final Context context;\n+    private final MetaTagDataLoader metaTagDataLoader;\n+    private final Map<ResourcePath, Map<String, String>> metaCache;\n \n     @Inject\n-    public TimeseriesPersisterFactory(Context context, TimeseriesWriter timeseriesWriter) {\n+    public TimeseriesPersisterFactory(final Context context, final TimeseriesWriter timeseriesWriter, final MetaTagDataLoader metaTagDataLoader) {\n         this.context = Objects.requireNonNull(context);\n         this.timeseriesWriter = timeseriesWriter;\n+        this.metaTagDataLoader = metaTagDataLoader;\n+        Cache<ResourcePath, Map<String, String>> cache = CacheBuilder // TODO Patrick: define with Jesse the eviction policy", "originalCommit": "29ed20e23d9c09b9c3ee50355e21c02e23fd40bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk2MzEzMw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429963133", "bodyText": "Let's use expireAfterWrite with a default of 5m. (And make it configurable.)", "author": "j-white", "createdAt": "2020-05-25T14:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1NDg5Mw=="}], "type": "inlineReview"}, {"oid": "a5449bfbe4b996de47c6cc5ebb064ad00aeb9775", "url": "https://github.com/OpenNMS/opennms/commit/a5449bfbe4b996de47c6cc5ebb064ad00aeb9775", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: map more attributes", "committedDate": "2020-05-24T19:24:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY2NzA2MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429667061", "bodyText": "@j-white ?", "author": "patrick-schweizer", "createdAt": "2020-05-24T19:25:36Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/MetaTagDataLoader.java", "diffHunk": "@@ -0,0 +1,286 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2006-2015 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2015 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.timeseries.integration.persistence;\n+\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import javax.inject.Inject;\n+\n+import org.opennms.netmgt.collection.api.CollectionResource;\n+import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.dao.api.SessionUtils;\n+import org.opennms.netmgt.model.OnmsAssetRecord;\n+import org.opennms.netmgt.model.OnmsCategory;\n+import org.opennms.netmgt.model.OnmsNode;\n+import org.opennms.netmgt.model.ResourceTypeUtils;\n+import org.opennms.netmgt.model.monitoringLocations.OnmsMonitoringLocation;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration.AssetTagKey;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration.MetaTagKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.base.Strings;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.collect.Maps;\n+\n+public class MetaTagDataLoader extends CacheLoader<CollectionResource, Map<String, String>> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(MetaTagDataLoader.class);\n+\n+    private final NodeDao nodeDao;\n+    private final SessionUtils sessionUtils;\n+    private MetaTagConfiguration config;\n+\n+    @Inject\n+    public MetaTagDataLoader(final NodeDao nodeDao, final SessionUtils sessionUtils) {\n+        this.nodeDao = nodeDao;\n+        this.sessionUtils = sessionUtils;\n+        setConfig(new MetaTagConfiguration(Maps.fromProperties(System.getProperties())));\n+    }\n+\n+    public void setConfig(final MetaTagConfiguration config) {\n+        this.config = config;\n+    }\n+\n+    public Map<String, String> load(final CollectionResource resource) {\n+        return sessionUtils.withReadOnlyTransaction(() -> {\n+            final Map<String, String> tags = new HashMap<>();\n+            addTag(tags, MetaTagKey.resourceLabel, Optional.ofNullable(resource.getInterfaceLabel()).orElse(null));\n+\n+            if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_NODE)) {\n+                String nodeCriteria = getNodeCriteriaFromResource(resource);\n+                mapNode(tags, nodeCriteria);\n+            } else if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_IF)) {\n+                String nodeCriteria = getNodeCriteriaFromResource(resource);\n+                if (!Strings.isNullOrEmpty(nodeCriteria)) {\n+                    mapNode(tags, nodeCriteria);\n+                }\n+                addTag(tags, MetaTagKey.ifDescr, resource.getInterfaceLabel()); // TODO: Patrick: is that correct?", "originalCommit": "a5449bfbe4b996de47c6cc5ebb064ad00aeb9775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk1OTQ4MA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429959480", "bodyText": "We'll need to extract the ifIndex from the resource to be able to get everything we need.", "author": "j-white", "createdAt": "2020-05-25T14:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY2NzA2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY2NzA3NA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429667074", "bodyText": "@j-white", "author": "patrick-schweizer", "createdAt": "2020-05-24T19:25:45Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/MetaTagDataLoader.java", "diffHunk": "@@ -0,0 +1,286 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2006-2015 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2015 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.timeseries.integration.persistence;\n+\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import javax.inject.Inject;\n+\n+import org.opennms.netmgt.collection.api.CollectionResource;\n+import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.dao.api.SessionUtils;\n+import org.opennms.netmgt.model.OnmsAssetRecord;\n+import org.opennms.netmgt.model.OnmsCategory;\n+import org.opennms.netmgt.model.OnmsNode;\n+import org.opennms.netmgt.model.ResourceTypeUtils;\n+import org.opennms.netmgt.model.monitoringLocations.OnmsMonitoringLocation;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration.AssetTagKey;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration.MetaTagKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.base.Strings;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.collect.Maps;\n+\n+public class MetaTagDataLoader extends CacheLoader<CollectionResource, Map<String, String>> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(MetaTagDataLoader.class);\n+\n+    private final NodeDao nodeDao;\n+    private final SessionUtils sessionUtils;\n+    private MetaTagConfiguration config;\n+\n+    @Inject\n+    public MetaTagDataLoader(final NodeDao nodeDao, final SessionUtils sessionUtils) {\n+        this.nodeDao = nodeDao;\n+        this.sessionUtils = sessionUtils;\n+        setConfig(new MetaTagConfiguration(Maps.fromProperties(System.getProperties())));\n+    }\n+\n+    public void setConfig(final MetaTagConfiguration config) {\n+        this.config = config;\n+    }\n+\n+    public Map<String, String> load(final CollectionResource resource) {\n+        return sessionUtils.withReadOnlyTransaction(() -> {\n+            final Map<String, String> tags = new HashMap<>();\n+            addTag(tags, MetaTagKey.resourceLabel, Optional.ofNullable(resource.getInterfaceLabel()).orElse(null));\n+\n+            if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_NODE)) {\n+                String nodeCriteria = getNodeCriteriaFromResource(resource);\n+                mapNode(tags, nodeCriteria);\n+            } else if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_IF)) {\n+                String nodeCriteria = getNodeCriteriaFromResource(resource);\n+                if (!Strings.isNullOrEmpty(nodeCriteria)) {\n+                    mapNode(tags, nodeCriteria);\n+                }\n+                addTag(tags, MetaTagKey.ifDescr, resource.getInterfaceLabel()); // TODO: Patrick: is that correct?\n+                // addTag(tags, MetaTagKey.ifAlias, ); // TODO: Patrick: from where do we get that attribute?", "originalCommit": "a5449bfbe4b996de47c6cc5ebb064ad00aeb9775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk1NzY3MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r429957671", "bodyText": "I think we should move this to the Meta-Data DSL instead of defining it here.\nWe could add these to a new \"asset\" context and make them available in expressions like ${asset:operatingSystem}.", "author": "j-white", "createdAt": "2020-05-25T14:15:22Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/MetaTagConfiguration.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+package org.opennms.netmgt.timeseries.integration;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/** Defines which additional meta tags should be exposed to the timeseries integration plugin. */\n+public class MetaTagConfiguration {\n+\n+    final static String PREFIX = \"org.opennms.timeseries.tin.metatags\";\n+\n+    /** properties defined in opennms.properties */\n+    public enum PropertyKey {\n+        assets,\n+        tags,\n+        categories\n+    }\n+\n+    public enum MetaTagKey {\n+        nodeLabel,\n+        location,\n+        sysObjectID,\n+        foreignSource,\n+        foreignId,\n+        nodeCriteria,\n+        ipAddress, // for response time resources\n+        service, // for response time resources\n+        ifDescr, // for interface resources\n+        ifAlias, // for interface resources\n+        resourceLabel\n+    }\n+\n+    // TODO: Patrick: do we want to merge MetaTagKey & AssetTagKey?", "originalCommit": "a5449bfbe4b996de47c6cc5ebb064ad00aeb9775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "be46a55a9d69682d953bac0dcb85be0c1af410d4", "url": "https://github.com/OpenNMS/opennms/commit/be46a55a9d69682d953bac0dcb85be0c1af410d4", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: cache config & categories", "committedDate": "2020-05-25T21:30:42Z", "type": "commit"}, {"oid": "87c3163bbd5405f2f2fe297065420f5631058e98", "url": "https://github.com/OpenNMS/opennms/commit/87c3163bbd5405f2f2fe297065420f5631058e98", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: use entity DSL", "committedDate": "2020-05-27T16:40:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNTEwMg==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r431405102", "bodyText": "I would strongly advocate to put this into the \"asset\" context.\nI would like to see the assets stored as meta-data itself. By putting it in its own context we can avoid a rename later on.\nAnd we should update to docs for these additional keys.", "author": "fooker", "createdAt": "2020-05-27T19:53:13Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProviderImpl.java", "diffHunk": "@@ -87,11 +89,73 @@ public Scope getScopeForNode(final Integer nodeId) {\n                             .map(\"node\", \"sys-location\", (n) -> Optional.ofNullable(n.getSysLocation()))\n                             .map(\"node\", \"sys-contact\", (n) -> Optional.ofNullable(n.getSysContact()))\n                             .map(\"node\", \"sys-description\", (n) -> Optional.ofNullable(n.getSysDescription()))\n+                            .map(\"node\", \"sys-objectid\", (n) -> Optional.ofNullable(n.getSysObjectId()))\n                             .map(\"node\", \"location\", (n) -> Optional.ofNullable(n.getLocation().getLocationName()))\n                             .map(\"node\", \"area\", (n) -> Optional.ofNullable(n.getLocation().getMonitoringArea()))\n-            );\n+                            .map(\"node\", \"category\" , (n) -> Optional.ofNullable(node.getAssetRecord()).map(OnmsAssetRecord::getCategory))", "originalCommit": "87c3163bbd5405f2f2fe297065420f5631058e98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwODg2OQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r431408869", "bodyText": "I would strongly advocate to put this into the \"asset\" context.\nSure, I have no strong opinion on that. You propose to create a different scope \"asset\"?\n\n\nAnd we should update to docs for these additional keys.\n\ud83d\udc4d will do that once we have settled on all attributes. There still might be a few missing.", "author": "patrick-schweizer", "createdAt": "2020-05-27T20:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQzMjgzNA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r431432834", "bodyText": "@fooker is that how you were envisioning the asset scope?", "author": "patrick-schweizer", "createdAt": "2020-05-27T20:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNTEwMg=="}], "type": "inlineReview"}, {"oid": "95ca2867e403071e5c409cd3528c3e695ecaeea4", "url": "https://github.com/OpenNMS/opennms/commit/95ca2867e403071e5c409cd3528c3e695ecaeea4", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: move assets to its own scope", "committedDate": "2020-05-27T20:45:31Z", "type": "commit"}, {"oid": "c95f13b6ec582d5236d5965ca6821f2b3f42d521", "url": "https://github.com/OpenNMS/opennms/commit/c95f13b6ec582d5236d5965ca6821f2b3f42d521", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: move assets to its own scope", "committedDate": "2020-05-27T20:52:24Z", "type": "commit"}, {"oid": "9d5431a16625e2f688df54333b8b774459d9ab1c", "url": "https://github.com/OpenNMS/opennms/commit/9d5431a16625e2f688df54333b8b774459d9ab1c", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: add docu", "committedDate": "2020-05-27T23:38:11Z", "type": "commit"}, {"oid": "0ebcfe3975f570c01a0dc6e9be783a06341a3759", "url": "https://github.com/OpenNMS/opennms/commit/0ebcfe3975f570c01a0dc6e9be783a06341a3759", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: add assets to RoundtripTest", "committedDate": "2020-05-28T00:06:44Z", "type": "commit"}, {"oid": "f9daa3e8890a479256ae119911b84b7a6d514b74", "url": "https://github.com/OpenNMS/opennms/commit/f9daa3e8890a479256ae119911b84b7a6d514b74", "message": "NMS-12730: Add support for looking up interfaces by ifIndex.", "committedDate": "2020-05-28T12:59:37Z", "type": "commit"}, {"oid": "7337f2c958afaf74830f83325b98c22bf112dca9", "url": "https://github.com/OpenNMS/opennms/commit/7337f2c958afaf74830f83325b98c22bf112dca9", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: add test for interface attributes", "committedDate": "2020-05-28T20:27:33Z", "type": "commit"}, {"oid": "9878e614701c8476e038cf6b992822bc1ddc71a1", "url": "https://github.com/OpenNMS/opennms/commit/9878e614701c8476e038cf6b992822bc1ddc71a1", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: enable categories, fix doc", "committedDate": "2020-05-28T20:54:46Z", "type": "commit"}, {"oid": "b22e4d3e9e136fffedbb546d13e67d4ab4e3bfa3", "url": "https://github.com/OpenNMS/opennms/commit/b22e4d3e9e136fffedbb546d13e67d4ab4e3bfa3", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: fix integration test", "committedDate": "2020-05-29T17:30:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0MjMzMA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r432642330", "bodyText": "TODO", "author": "j-white", "createdAt": "2020-05-29T17:46:17Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/TimeseriesPersisterFactory.java", "diffHunk": "@@ -47,13 +53,20 @@\n public class TimeseriesPersisterFactory implements PersisterFactory {\n \n     private final TimeseriesWriter timeseriesWriter;\n-\n     private final Context context;\n+    private final MetaTagDataLoader metaTagDataLoader;\n+    private final Map<ResourcePath, Map<String, String>> metaCache;\n \n     @Inject\n-    public TimeseriesPersisterFactory(Context context, TimeseriesWriter timeseriesWriter) {\n+    public TimeseriesPersisterFactory(final Context context, final TimeseriesWriter timeseriesWriter, final MetaTagDataLoader metaTagDataLoader) {\n         this.context = Objects.requireNonNull(context);\n         this.timeseriesWriter = timeseriesWriter;\n+        this.metaTagDataLoader = metaTagDataLoader;\n+        Cache<ResourcePath, Map<String, String>> cache = CacheBuilder\n+                .newBuilder()\n+                .expireAfterWrite(5, TimeUnit.MINUTES) // TODO Patrick: make configurable - can use CacheBuilder.from(cacheConfig).build();", "originalCommit": "b22e4d3e9e136fffedbb546d13e67d4ab4e3bfa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczMjA0Nw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r432732047", "bodyText": "fixed", "author": "patrick-schweizer", "createdAt": "2020-05-29T20:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0MjMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0MzY1Mg==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r432643652", "bodyText": "Let's store this in the \"node\" context instead (and move it to the EntityScopeProvider).\nThe criteria should also be derived from the OnmsNode object and not the resource. (It's possible that the resource only references the node id, but an FS:FID is present on the node.)", "author": "j-white", "createdAt": "2020-05-29T17:48:52Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/MetaTagDataLoader.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2006-2015 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2015 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.timeseries.integration.persistence;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.opennms.core.rpc.utils.mate.EmptyScope;\n+import org.opennms.core.rpc.utils.mate.EntityScopeProvider;\n+import org.opennms.core.rpc.utils.mate.FallbackScope;\n+import org.opennms.core.rpc.utils.mate.Interpolator;\n+import org.opennms.core.rpc.utils.mate.ObjectScope;\n+import org.opennms.core.rpc.utils.mate.Scope;\n+import org.opennms.netmgt.collection.api.CollectionResource;\n+import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.dao.api.SessionUtils;\n+import org.opennms.netmgt.model.OnmsCategory;\n+import org.opennms.netmgt.model.OnmsNode;\n+import org.opennms.netmgt.model.ResourceTypeUtils;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.base.Strings;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.collect.Maps;\n+\n+public class MetaTagDataLoader extends CacheLoader<CollectionResource, Map<String, String>> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(MetaTagDataLoader.class);\n+\n+    private final NodeDao nodeDao;\n+    private final SessionUtils sessionUtils;\n+    private final EntityScopeProvider entityScopeProvider;\n+    private MetaTagConfiguration config;\n+\n+    @Inject\n+    public MetaTagDataLoader(final NodeDao nodeDao, final SessionUtils sessionUtils, final EntityScopeProvider entityScopeProvider) {\n+        this.nodeDao = nodeDao;\n+        this.sessionUtils = sessionUtils;\n+        this.entityScopeProvider = entityScopeProvider;\n+        setConfig(new MetaTagConfiguration(Maps.fromProperties(System.getProperties())));\n+    }\n+\n+    public void setConfig(final MetaTagConfiguration config) {\n+        this.config = config;\n+    }\n+\n+    public Map<String, String> load(final CollectionResource resource) {\n+        return sessionUtils.withReadOnlyTransaction(() -> {\n+\n+            final Map<String, String> tags = new HashMap<>();\n+            List<Scope> scopes = new ArrayList<>();\n+\n+            // resource related scope\n+            scopes.add(getScopeForResource(resource));\n+\n+            // node related scopes\n+            String nodeCriteria = getNodeCriteriaFromResource(resource);\n+            Optional<OnmsNode> nodeOptional = getNode(nodeCriteria);\n+            if(nodeOptional.isPresent()) {\n+                OnmsNode node = nodeOptional.get();\n+                scopes.add(this.entityScopeProvider.getScopeForNode(node.getId()));\n+                scopes.add(this.entityScopeProvider.getScopeForAssets(node.getId()));\n+                if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_IF)) {\n+                    // We expect #getInstance to return the ifIndex for interface-level resources\n+                    try {\n+                        int ifIndex = Integer.parseInt(resource.getInstance());\n+                        scopes.add(this.entityScopeProvider.getScopeForInterfaceByIfIndex(node.getId(), ifIndex));\n+                    } catch(NumberFormatException nfe) {\n+                        // pass\n+                    }\n+                }\n+                // We cannot retrieve service meta-data - resource time resources contain the IP address and service name, but not the node\n+            }\n+\n+            // create tags for scopes\n+            Scope scope = new FallbackScope(scopes);\n+            Map<String, String> configuredMetaTags = this.config.getConfiguredMetaTags();\n+            for(Map.Entry<String, String> entry: configuredMetaTags.entrySet()) {\n+                final String value = Interpolator.interpolate(entry.getValue(), scope);\n+                // Ignore tags with empty values\n+                if (Strings.isNullOrEmpty(value)) {\n+                    continue;\n+                }\n+                tags.put(entry.getKey(), value);\n+            }\n+\n+            // create tags for categories\n+            nodeOptional.ifPresent(onmsNode -> mapCategories(tags, onmsNode));\n+            return tags;\n+        });\n+    }\n+\n+    private void mapCategories(final Map<String, String> tags, final OnmsNode node) {\n+        Objects.requireNonNull(node);\n+        if(config.isCategoriesEnabled()) {\n+            node.getCategories().stream()\n+                    .map(OnmsCategory::getName)\n+                    .forEach(catName -> tags.put(\"cat_\" + catName, catName));\n+        }\n+    }\n+\n+    public Scope getScopeForResource(final CollectionResource resource) {\n+        if (resource == null) {\n+            return EmptyScope.EMPTY;\n+        }\n+        return new ObjectScope<>(resource)\n+                .map(\"resource\", \"criteria\", (r) -> Optional.ofNullable(getNodeCriteriaFromResource(resource)))", "originalCommit": "b22e4d3e9e136fffedbb546d13e67d4ab4e3bfa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwOTIyNQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r432709225", "bodyText": "done.", "author": "patrick-schweizer", "createdAt": "2020-05-29T20:04:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0MzY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0NDAyMQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r432644021", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG.error(\"error while trying to match node from {}\", nodeCriteria);\n          \n          \n            \n                        LOG.error(\"Error while trying to load node for criteria: {}. No node will be returned.\", nodeCriteria, e);", "author": "j-white", "createdAt": "2020-05-29T17:49:40Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/MetaTagDataLoader.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2006-2015 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2015 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.timeseries.integration.persistence;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.opennms.core.rpc.utils.mate.EmptyScope;\n+import org.opennms.core.rpc.utils.mate.EntityScopeProvider;\n+import org.opennms.core.rpc.utils.mate.FallbackScope;\n+import org.opennms.core.rpc.utils.mate.Interpolator;\n+import org.opennms.core.rpc.utils.mate.ObjectScope;\n+import org.opennms.core.rpc.utils.mate.Scope;\n+import org.opennms.netmgt.collection.api.CollectionResource;\n+import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.dao.api.SessionUtils;\n+import org.opennms.netmgt.model.OnmsCategory;\n+import org.opennms.netmgt.model.OnmsNode;\n+import org.opennms.netmgt.model.ResourceTypeUtils;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.base.Strings;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.collect.Maps;\n+\n+public class MetaTagDataLoader extends CacheLoader<CollectionResource, Map<String, String>> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(MetaTagDataLoader.class);\n+\n+    private final NodeDao nodeDao;\n+    private final SessionUtils sessionUtils;\n+    private final EntityScopeProvider entityScopeProvider;\n+    private MetaTagConfiguration config;\n+\n+    @Inject\n+    public MetaTagDataLoader(final NodeDao nodeDao, final SessionUtils sessionUtils, final EntityScopeProvider entityScopeProvider) {\n+        this.nodeDao = nodeDao;\n+        this.sessionUtils = sessionUtils;\n+        this.entityScopeProvider = entityScopeProvider;\n+        setConfig(new MetaTagConfiguration(Maps.fromProperties(System.getProperties())));\n+    }\n+\n+    public void setConfig(final MetaTagConfiguration config) {\n+        this.config = config;\n+    }\n+\n+    public Map<String, String> load(final CollectionResource resource) {\n+        return sessionUtils.withReadOnlyTransaction(() -> {\n+\n+            final Map<String, String> tags = new HashMap<>();\n+            List<Scope> scopes = new ArrayList<>();\n+\n+            // resource related scope\n+            scopes.add(getScopeForResource(resource));\n+\n+            // node related scopes\n+            String nodeCriteria = getNodeCriteriaFromResource(resource);\n+            Optional<OnmsNode> nodeOptional = getNode(nodeCriteria);\n+            if(nodeOptional.isPresent()) {\n+                OnmsNode node = nodeOptional.get();\n+                scopes.add(this.entityScopeProvider.getScopeForNode(node.getId()));\n+                scopes.add(this.entityScopeProvider.getScopeForAssets(node.getId()));\n+                if (resource.getResourceTypeName().equals(CollectionResource.RESOURCE_TYPE_IF)) {\n+                    // We expect #getInstance to return the ifIndex for interface-level resources\n+                    try {\n+                        int ifIndex = Integer.parseInt(resource.getInstance());\n+                        scopes.add(this.entityScopeProvider.getScopeForInterfaceByIfIndex(node.getId(), ifIndex));\n+                    } catch(NumberFormatException nfe) {\n+                        // pass\n+                    }\n+                }\n+                // We cannot retrieve service meta-data - resource time resources contain the IP address and service name, but not the node\n+            }\n+\n+            // create tags for scopes\n+            Scope scope = new FallbackScope(scopes);\n+            Map<String, String> configuredMetaTags = this.config.getConfiguredMetaTags();\n+            for(Map.Entry<String, String> entry: configuredMetaTags.entrySet()) {\n+                final String value = Interpolator.interpolate(entry.getValue(), scope);\n+                // Ignore tags with empty values\n+                if (Strings.isNullOrEmpty(value)) {\n+                    continue;\n+                }\n+                tags.put(entry.getKey(), value);\n+            }\n+\n+            // create tags for categories\n+            nodeOptional.ifPresent(onmsNode -> mapCategories(tags, onmsNode));\n+            return tags;\n+        });\n+    }\n+\n+    private void mapCategories(final Map<String, String> tags, final OnmsNode node) {\n+        Objects.requireNonNull(node);\n+        if(config.isCategoriesEnabled()) {\n+            node.getCategories().stream()\n+                    .map(OnmsCategory::getName)\n+                    .forEach(catName -> tags.put(\"cat_\" + catName, catName));\n+        }\n+    }\n+\n+    public Scope getScopeForResource(final CollectionResource resource) {\n+        if (resource == null) {\n+            return EmptyScope.EMPTY;\n+        }\n+        return new ObjectScope<>(resource)\n+                .map(\"resource\", \"criteria\", (r) -> Optional.ofNullable(getNodeCriteriaFromResource(resource)))\n+                .map(\"resource\", \"label\", (r) -> Optional.ofNullable(r.getInterfaceLabel()));\n+    }\n+\n+    private Optional<OnmsNode> getNode(String nodeCriteria) {\n+        if (nodeCriteria == null || nodeCriteria.trim().isEmpty()) {\n+            return Optional.empty();\n+        }\n+        try {\n+            return Optional.ofNullable(nodeDao.get(nodeCriteria));\n+        } catch (Exception e) {\n+            LOG.error(\"error while trying to match node from {}\", nodeCriteria);", "originalCommit": "b22e4d3e9e136fffedbb546d13e67d4ab4e3bfa3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "085d523f8fda8767ddf4c9aca130fdf38731ff70", "url": "https://github.com/OpenNMS/opennms/commit/085d523f8fda8767ddf4c9aca130fdf38731ff70", "message": "Apply suggestions from code review\r\n\r\nNMS-12730 Meta-data tag enhancements: PR comments\n\nCo-authored-by: Jesse White <jesse@opennms.org>", "committedDate": "2020-05-29T19:40:30Z", "type": "commit"}, {"oid": "ddd150165e98160a3424db4c792a83fe059db55a", "url": "https://github.com/OpenNMS/opennms/commit/ddd150165e98160a3424db4c792a83fe059db55a", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: add cache config, move node criteria to EntityScopeProviderImpl", "committedDate": "2020-05-29T21:01:29Z", "type": "commit"}, {"oid": "6ddcf6cc3f29ac1a0cd01f210eee14490c8cd27a", "url": "https://github.com/OpenNMS/opennms/commit/6ddcf6cc3f29ac1a0cd01f210eee14490c8cd27a", "message": "Merge branch 'NMS-12730-metatag' of github.com:OpenNMS/opennms into NMS-12730-metatag", "committedDate": "2020-05-29T21:02:09Z", "type": "commit"}, {"oid": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "url": "https://github.com/OpenNMS/opennms/commit/455f6ad42b897d340361b525ba7d02a5c416d6a4", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: add cache config", "committedDate": "2020-05-29T22:03:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1Mzk0Mg==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434353942", "bodyText": "Makes sense. Can you do that for the other context names, too. And maybe move them to the interface?", "author": "fooker", "createdAt": "2020-06-03T07:11:32Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProviderImpl.java", "diffHunk": "@@ -51,12 +55,17 @@\n \n public class EntityScopeProviderImpl implements EntityScopeProvider {\n \n+    private static final String INTERFACE = \"interface\";", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY2NzI0MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434667241", "bodyText": "\ud83d\udc4d done", "author": "patrick-schweizer", "createdAt": "2020-06-03T15:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1Mzk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1NzU4Nw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434357587", "bodyText": "You should use i.getIfAlias() here.", "author": "fooker", "createdAt": "2020-06-03T07:18:49Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProviderImpl.java", "diffHunk": "@@ -108,20 +207,56 @@ public Scope getScopeForInterface(final Integer nodeId, final String ipAddress)\n             }\n \n             return new FallbackScope(transform(ipInterface.getMetaData()),\n-                    new ObjectScope<>(ipInterface)\n-                            .map(\"interface\", \"hostname\", (i) -> Optional.ofNullable(i.getIpHostName()))\n-                            .map(\"interface\", \"address\", (i) -> Optional.ofNullable(i.getIpAddress()).map(InetAddressUtils::toIpAddrString))\n-                            .map(\"interface\", \"netmask\", (i) -> Optional.ofNullable(i.getNetMask()).map(InetAddressUtils::toIpAddrString))\n-                            .map(\"interface\", \"if-index\", (i) -> Optional.ofNullable(i.getIfIndex()).map(Object::toString))\n-                            .map(\"interface\", \"if-alias\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfAlias))\n-                            .map(\"interface\", \"if-description\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfDescr))\n-                            .map(\"interface\", \"phy-addr\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getPhysAddr))\n+                    mapIpIntefaceKeys(new ObjectScope<>(ipInterface))\n+                            .map(INTERFACE, \"if-alias\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfAlias))\n+                            .map(INTERFACE, \"if-description\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfDescr))\n+                            .map(INTERFACE, \"phy-addr\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getPhysAddr))\n             );\n         });\n \n         return metaDataScope;\n     }\n \n+    private static ObjectScope<OnmsIpInterface> mapIpIntefaceKeys(ObjectScope<OnmsIpInterface> scope) {\n+        return scope.map(INTERFACE, \"hostname\", (i) -> Optional.ofNullable(i.getIpHostName()))\n+                .map(INTERFACE, \"address\", (i) -> Optional.ofNullable(i.getIpAddress()).map(InetAddressUtils::toIpAddrString))\n+                .map(INTERFACE, \"netmask\", (i) -> Optional.ofNullable(i.getNetMask()).map(InetAddressUtils::toIpAddrString))\n+                .map(INTERFACE, \"if-index\", (i) -> Optional.ofNullable(i.getIfIndex()).map(Object::toString));\n+    }\n+\n+    @Override\n+    public Scope getScopeForInterfaceByIfIndex(final Integer nodeId, final int ifIndex) {\n+        if (nodeId == null) {\n+            return EmptyScope.EMPTY;\n+        }\n+\n+        final Scope metaDataScope = this.sessionUtils.withReadOnlyTransaction(() -> {\n+            final OnmsSnmpInterface snmpInterface = this.snmpInterfaceDao.findByNodeIdAndIfIndex(nodeId, ifIndex);\n+            if (snmpInterface == null) {\n+                return EmptyScope.EMPTY;\n+            }\n+\n+            ArrayList<Scope> scopes = new ArrayList<>();\n+\n+            // SNMP interface facts\n+            scopes.add(new ObjectScope<>(snmpInterface)\n+                    .map(INTERFACE, \"if-alias\", (i) -> Optional.ofNullable(snmpInterface.getIfAlias()))", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY2OTg1Ng==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434669856", "bodyText": "\ud83d\udc4d done", "author": "patrick-schweizer", "createdAt": "2020-06-03T15:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1NzU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1OTU4MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434359581", "bodyText": "FallbackScope uses a list internally. You can add a constructor which accepts a list (and alter the existing constructor to forward to the new one). If you use an ImmutableList.Builder here, this renders down to a no-op without any allocation.", "author": "fooker", "createdAt": "2020-06-03T07:22:40Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProviderImpl.java", "diffHunk": "@@ -108,20 +207,56 @@ public Scope getScopeForInterface(final Integer nodeId, final String ipAddress)\n             }\n \n             return new FallbackScope(transform(ipInterface.getMetaData()),\n-                    new ObjectScope<>(ipInterface)\n-                            .map(\"interface\", \"hostname\", (i) -> Optional.ofNullable(i.getIpHostName()))\n-                            .map(\"interface\", \"address\", (i) -> Optional.ofNullable(i.getIpAddress()).map(InetAddressUtils::toIpAddrString))\n-                            .map(\"interface\", \"netmask\", (i) -> Optional.ofNullable(i.getNetMask()).map(InetAddressUtils::toIpAddrString))\n-                            .map(\"interface\", \"if-index\", (i) -> Optional.ofNullable(i.getIfIndex()).map(Object::toString))\n-                            .map(\"interface\", \"if-alias\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfAlias))\n-                            .map(\"interface\", \"if-description\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfDescr))\n-                            .map(\"interface\", \"phy-addr\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getPhysAddr))\n+                    mapIpIntefaceKeys(new ObjectScope<>(ipInterface))\n+                            .map(INTERFACE, \"if-alias\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfAlias))\n+                            .map(INTERFACE, \"if-description\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfDescr))\n+                            .map(INTERFACE, \"phy-addr\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getPhysAddr))\n             );\n         });\n \n         return metaDataScope;\n     }\n \n+    private static ObjectScope<OnmsIpInterface> mapIpIntefaceKeys(ObjectScope<OnmsIpInterface> scope) {\n+        return scope.map(INTERFACE, \"hostname\", (i) -> Optional.ofNullable(i.getIpHostName()))\n+                .map(INTERFACE, \"address\", (i) -> Optional.ofNullable(i.getIpAddress()).map(InetAddressUtils::toIpAddrString))\n+                .map(INTERFACE, \"netmask\", (i) -> Optional.ofNullable(i.getNetMask()).map(InetAddressUtils::toIpAddrString))\n+                .map(INTERFACE, \"if-index\", (i) -> Optional.ofNullable(i.getIfIndex()).map(Object::toString));\n+    }\n+\n+    @Override\n+    public Scope getScopeForInterfaceByIfIndex(final Integer nodeId, final int ifIndex) {\n+        if (nodeId == null) {\n+            return EmptyScope.EMPTY;\n+        }\n+\n+        final Scope metaDataScope = this.sessionUtils.withReadOnlyTransaction(() -> {\n+            final OnmsSnmpInterface snmpInterface = this.snmpInterfaceDao.findByNodeIdAndIfIndex(nodeId, ifIndex);\n+            if (snmpInterface == null) {\n+                return EmptyScope.EMPTY;\n+            }\n+\n+            ArrayList<Scope> scopes = new ArrayList<>();\n+\n+            // SNMP interface facts\n+            scopes.add(new ObjectScope<>(snmpInterface)\n+                    .map(INTERFACE, \"if-alias\", (i) -> Optional.ofNullable(snmpInterface.getIfAlias()))\n+                    .map(INTERFACE, \"if-description\", (i) -> Optional.ofNullable(snmpInterface.getIfDescr()))\n+                    .map(INTERFACE, \"phy-addr\", (i) -> Optional.ofNullable(snmpInterface.getPhysAddr())));\n+\n+            // IP interface facts w/ meta-data extracted from IP interface\n+            Optional.ofNullable(snmpInterface.getPrimaryIpInterface())\n+                    .ifPresent(ipInterface -> {\n+                        scopes.add(transform(ipInterface.getMetaData()));\n+                        scopes.add(mapIpIntefaceKeys(new ObjectScope<>(ipInterface)));\n+                    });\n+\n+            return new FallbackScope(scopes.toArray(new Scope[0]));", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY3MjA1OA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434672058", "bodyText": "done.", "author": "patrick-schweizer", "createdAt": "2020-06-03T15:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1OTU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2MDMwMw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434360303", "bodyText": "Just return a new Scope as the are used in FallbackScopes anyway?", "author": "fooker", "createdAt": "2020-06-03T07:23:58Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProviderImpl.java", "diffHunk": "@@ -108,20 +207,56 @@ public Scope getScopeForInterface(final Integer nodeId, final String ipAddress)\n             }\n \n             return new FallbackScope(transform(ipInterface.getMetaData()),\n-                    new ObjectScope<>(ipInterface)\n-                            .map(\"interface\", \"hostname\", (i) -> Optional.ofNullable(i.getIpHostName()))\n-                            .map(\"interface\", \"address\", (i) -> Optional.ofNullable(i.getIpAddress()).map(InetAddressUtils::toIpAddrString))\n-                            .map(\"interface\", \"netmask\", (i) -> Optional.ofNullable(i.getNetMask()).map(InetAddressUtils::toIpAddrString))\n-                            .map(\"interface\", \"if-index\", (i) -> Optional.ofNullable(i.getIfIndex()).map(Object::toString))\n-                            .map(\"interface\", \"if-alias\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfAlias))\n-                            .map(\"interface\", \"if-description\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfDescr))\n-                            .map(\"interface\", \"phy-addr\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getPhysAddr))\n+                    mapIpIntefaceKeys(new ObjectScope<>(ipInterface))\n+                            .map(INTERFACE, \"if-alias\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfAlias))\n+                            .map(INTERFACE, \"if-description\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getIfDescr))\n+                            .map(INTERFACE, \"phy-addr\", (i) -> Optional.ofNullable(i.getSnmpInterface()).map(OnmsSnmpInterface::getPhysAddr))\n             );\n         });\n \n         return metaDataScope;\n     }\n \n+    private static ObjectScope<OnmsIpInterface> mapIpIntefaceKeys(ObjectScope<OnmsIpInterface> scope) {", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5MTIyNg==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434691226", "bodyText": "\ud83d\udc4d fixed", "author": "patrick-schweizer", "createdAt": "2020-06-03T16:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2MDMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2MjY2Mg==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434362662", "bodyText": "I have mixed feelings about having a new method. If we can merge this with getScopeForNode by just adding the Scope created here to the Nodes FallbackScope, all existing usages would benefit from the available data.", "author": "fooker", "createdAt": "2020-06-03T07:28:19Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProviderImpl.java", "diffHunk": "@@ -87,11 +97,100 @@ public Scope getScopeForNode(final Integer nodeId) {\n                             .map(\"node\", \"sys-location\", (n) -> Optional.ofNullable(n.getSysLocation()))\n                             .map(\"node\", \"sys-contact\", (n) -> Optional.ofNullable(n.getSysContact()))\n                             .map(\"node\", \"sys-description\", (n) -> Optional.ofNullable(n.getSysDescription()))\n+                            .map(\"node\", \"sys-object-id\", (n) -> Optional.ofNullable(n.getSysObjectId()))\n                             .map(\"node\", \"location\", (n) -> Optional.ofNullable(n.getLocation().getLocationName()))\n-                            .map(\"node\", \"area\", (n) -> Optional.ofNullable(n.getLocation().getMonitoringArea()))\n-            );\n+                            .map(\"node\", \"area\", (n) -> Optional.ofNullable(n.getLocation().getMonitoringArea())));\n         });\n+        return metaDataScope;\n+    }\n \n+    private Optional<String> getNodeCriteria(final OnmsNode node) {\n+        Objects.requireNonNull(node, \"Node can not be null\");\n+        if (node.getForeignSource() != null) {\n+            return Optional.of(node.getForeignSource() + \":\" + node.getForeignId());\n+        } else {\n+            return Optional.of(Integer.toString(node.getId()));\n+        }\n+    }\n+\n+    @Override\n+    public Scope getScopeForAssets(final Integer nodeId) {", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5MzQ1Mw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434693453", "bodyText": "I'm easy here. I merged the 2 methods.", "author": "patrick-schweizer", "createdAt": "2020-06-03T16:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2MjY2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2MzIzMw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434363233", "bodyText": "By using new ObjectScope<>(node.getAssetRecord()) this can be much less verbose.", "author": "fooker", "createdAt": "2020-06-03T07:29:16Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProviderImpl.java", "diffHunk": "@@ -87,11 +97,100 @@ public Scope getScopeForNode(final Integer nodeId) {\n                             .map(\"node\", \"sys-location\", (n) -> Optional.ofNullable(n.getSysLocation()))\n                             .map(\"node\", \"sys-contact\", (n) -> Optional.ofNullable(n.getSysContact()))\n                             .map(\"node\", \"sys-description\", (n) -> Optional.ofNullable(n.getSysDescription()))\n+                            .map(\"node\", \"sys-object-id\", (n) -> Optional.ofNullable(n.getSysObjectId()))\n                             .map(\"node\", \"location\", (n) -> Optional.ofNullable(n.getLocation().getLocationName()))\n-                            .map(\"node\", \"area\", (n) -> Optional.ofNullable(n.getLocation().getMonitoringArea()))\n-            );\n+                            .map(\"node\", \"area\", (n) -> Optional.ofNullable(n.getLocation().getMonitoringArea())));\n         });\n+        return metaDataScope;\n+    }\n \n+    private Optional<String> getNodeCriteria(final OnmsNode node) {\n+        Objects.requireNonNull(node, \"Node can not be null\");\n+        if (node.getForeignSource() != null) {\n+            return Optional.of(node.getForeignSource() + \":\" + node.getForeignId());\n+        } else {\n+            return Optional.of(Integer.toString(node.getId()));\n+        }\n+    }\n+\n+    @Override\n+    public Scope getScopeForAssets(final Integer nodeId) {\n+        if (nodeId == null) {\n+            return EmptyScope.EMPTY;\n+        }\n+\n+        final Scope metaDataScope = this.sessionUtils.withReadOnlyTransaction(() -> {\n+            final OnmsNode node = nodeDao.get(nodeId);\n+            if (node == null) {\n+                return EmptyScope.EMPTY;\n+            }\n+\n+            return new FallbackScope(transform(node.getMetaData()),\n+                    new ObjectScope<>(node)", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzNDAxMw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434834013", "bodyText": "fixed.", "author": "patrick-schweizer", "createdAt": "2020-06-03T20:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2MzIzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NDAwMA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434364000", "bodyText": "Not used, or did I miss something?", "author": "fooker", "createdAt": "2020-06-03T07:30:35Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/MetaTagConfiguration.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+package org.opennms.netmgt.timeseries.integration;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Defines which additional meta tags should be exposed to the timeseries integration plugin.\n+ */\n+public class MetaTagConfiguration {\n+\n+    final static String CONFIG_PREFIX = \"org.opennms.timeseries.tin.metatags\";\n+    final static String CONFIG_KEY_FOR_CATEGORIES = CONFIG_PREFIX + \".exposeCategories\";\n+    final static String CONFIG_PREFIX_FOR_TAGS = CONFIG_PREFIX + \".tag.\";\n+\n+    /**\n+     * properties defined in opennms.properties\n+     */\n+    public enum PropertyKey {", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzNDkyNA==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434834924", "bodyText": "Good catch. It was used but it is not anymore. I removed it...", "author": "patrick-schweizer", "createdAt": "2020-06-03T20:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NDAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM3MDY1MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434370651", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .filter(e -> e.getKey().startsWith(MetaTagConfiguration.CONFIG_PREFIX_FOR_TAGS))\n          \n          \n            \n                            .forEach((entry) -> filteredMap.put(entry.getKey().substring(MetaTagConfiguration.CONFIG_PREFIX_FOR_TAGS.length()), entry.getValue()));\n          \n          \n            \n                            .flatMap((entry) -> StringUtils.truncatePrefix(entry.getKey(), MetaTagConfiguration.CONFIG_PREFIX_FOR_TAGS)\n          \n          \n            \n                                                           .map(Stream::of)\n          \n          \n            \n                                                           .orElseGet(Stream::empty))\n          \n          \n            \n                            .collect(Collectors.toMap((entry) -> entry.getKey(), (entry) -> entry.getValue()));", "author": "fooker", "createdAt": "2020-06-03T07:42:44Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/MetaTagConfiguration.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+package org.opennms.netmgt.timeseries.integration;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Defines which additional meta tags should be exposed to the timeseries integration plugin.\n+ */\n+public class MetaTagConfiguration {\n+\n+    final static String CONFIG_PREFIX = \"org.opennms.timeseries.tin.metatags\";\n+    final static String CONFIG_KEY_FOR_CATEGORIES = CONFIG_PREFIX + \".exposeCategories\";\n+    final static String CONFIG_PREFIX_FOR_TAGS = CONFIG_PREFIX + \".tag.\";\n+\n+    /**\n+     * properties defined in opennms.properties\n+     */\n+    public enum PropertyKey {\n+        assets,\n+        tag,\n+        categories\n+    }\n+    private final boolean categoriesEnabled;\n+\n+    private final Map<String, String> configuredMetaTags;\n+\n+    public MetaTagConfiguration(final Map<String, String> properties) {\n+        this.categoriesEnabled = Optional.ofNullable(properties.get(CONFIG_KEY_FOR_CATEGORIES)).map(Boolean::valueOf).orElse(false);\n+        this.configuredMetaTags = findConfiguredMetaTags(properties);\n+    }\n+\n+    public Map<String, String> getConfiguredMetaTags() {\n+        return this.configuredMetaTags;\n+    }\n+\n+    public boolean isCategoriesEnabled() {\n+        return this.categoriesEnabled;\n+    }\n+\n+    private Map<String, String> findConfiguredMetaTags(final Map<String, String> properties) {\n+        Map<String, String> filteredMap = new HashMap<>();\n+        properties\n+                .entrySet()\n+                .stream()\n+                .filter(e -> e.getKey().startsWith(MetaTagConfiguration.CONFIG_PREFIX_FOR_TAGS))\n+                .forEach((entry) -> filteredMap.put(entry.getKey().substring(MetaTagConfiguration.CONFIG_PREFIX_FOR_TAGS.length()), entry.getValue()));", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM3MjYyNw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434372627", "bodyText": "I found a lot of benefit in using Objects.requireNotNull very often. Maybe add it here, too.", "author": "fooker", "createdAt": "2020-06-03T07:46:20Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/MetaTagConfiguration.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+package org.opennms.netmgt.timeseries.integration;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Defines which additional meta tags should be exposed to the timeseries integration plugin.\n+ */\n+public class MetaTagConfiguration {\n+\n+    final static String CONFIG_PREFIX = \"org.opennms.timeseries.tin.metatags\";\n+    final static String CONFIG_KEY_FOR_CATEGORIES = CONFIG_PREFIX + \".exposeCategories\";\n+    final static String CONFIG_PREFIX_FOR_TAGS = CONFIG_PREFIX + \".tag.\";\n+\n+    /**\n+     * properties defined in opennms.properties\n+     */\n+    public enum PropertyKey {\n+        assets,\n+        tag,\n+        categories\n+    }\n+    private final boolean categoriesEnabled;\n+\n+    private final Map<String, String> configuredMetaTags;\n+\n+    public MetaTagConfiguration(final Map<String, String> properties) {\n+        this.categoriesEnabled = Optional.ofNullable(properties.get(CONFIG_KEY_FOR_CATEGORIES)).map(Boolean::valueOf).orElse(false);", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM3MzI2Nw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434373267", "bodyText": "Objects.requireNotNull, too. Especially, if the value is not actively used in the constructor.", "author": "fooker", "createdAt": "2020-06-03T07:47:26Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/MetaTagDataLoader.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2006-2015 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2015 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.timeseries.integration.persistence;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.opennms.core.rpc.utils.mate.EntityScopeProvider;\n+import org.opennms.core.rpc.utils.mate.FallbackScope;\n+import org.opennms.core.rpc.utils.mate.Interpolator;\n+import org.opennms.core.rpc.utils.mate.Scope;\n+import org.opennms.netmgt.collection.api.CollectionResource;\n+import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.dao.api.SessionUtils;\n+import org.opennms.netmgt.model.OnmsCategory;\n+import org.opennms.netmgt.model.OnmsNode;\n+import org.opennms.netmgt.model.ResourceTypeUtils;\n+import org.opennms.netmgt.timeseries.integration.MetaTagConfiguration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.base.Strings;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.collect.Maps;\n+\n+public class MetaTagDataLoader extends CacheLoader<CollectionResource, Map<String, String>> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(MetaTagDataLoader.class);\n+\n+    private final NodeDao nodeDao;\n+    private final SessionUtils sessionUtils;\n+    private final EntityScopeProvider entityScopeProvider;\n+    private MetaTagConfiguration config;\n+\n+    @Inject\n+    public MetaTagDataLoader(final NodeDao nodeDao, final SessionUtils sessionUtils, final EntityScopeProvider entityScopeProvider) {\n+        this.nodeDao = nodeDao;", "originalCommit": "455f6ad42b897d340361b525ba7d02a5c416d6a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzNjU4MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434836581", "bodyText": "\ud83d\udc4d fixed.", "author": "patrick-schweizer", "createdAt": "2020-06-03T20:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM3MzI2Nw=="}], "type": "inlineReview"}, {"oid": "af869d2b4d592e25c30741da94f45ab9ca6df18e", "url": "https://github.com/OpenNMS/opennms/commit/af869d2b4d592e25c30741da94f45ab9ca6df18e", "message": "NMS-12730: Meta-data tag enhancements to Time Series Storage API: code review suggestions\n\nCo-authored-by: Dustin Frisch <fooker@lab.sh>", "committedDate": "2020-06-03T20:36:24Z", "type": "commit"}, {"oid": "0bd5f470cd90ff5f185d78fd0da852444be743a3", "url": "https://github.com/OpenNMS/opennms/commit/0bd5f470cd90ff5f185d78fd0da852444be743a3", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: apply pr comments", "committedDate": "2020-06-03T20:40:19Z", "type": "commit"}, {"oid": "3f13ae9be5dbbf0424ce3c30e3abab5f10d08c5f", "url": "https://github.com/OpenNMS/opennms/commit/3f13ae9be5dbbf0424ce3c30e3abab5f10d08c5f", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: apply pr comments", "committedDate": "2020-06-03T21:00:51Z", "type": "commit"}, {"oid": "6236b05e3a3599dadc771e7c179fe32cbe829f13", "url": "https://github.com/OpenNMS/opennms/commit/6236b05e3a3599dadc771e7c179fe32cbe829f13", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: apply pr comments", "committedDate": "2020-06-03T21:12:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg3MDg0NQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434870845", "bodyText": "To be more clear, it should be called Contexts. The terminology here is that the meta-data consists of (context, key, value) triplets whereas the (context, key) tuple is used to access a value. The scopes are just used be more flexible during interpolation.", "author": "fooker", "createdAt": "2020-06-03T21:34:09Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProvider.java", "diffHunk": "@@ -31,9 +31,15 @@\n import java.net.InetAddress;\n \n public interface EntityScopeProvider {\n-    Scope getScopeForNode(final Integer nodeId);\n \n-    Scope getScopeForAssets(final Integer nodeId);\n+    interface ScopeId {", "originalCommit": "6236b05e3a3599dadc771e7c179fe32cbe829f13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4OTU5Nw==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434889597", "bodyText": "fixed", "author": "patrick-schweizer", "createdAt": "2020-06-03T22:19:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg3MDg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg3MjIwNQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434872205", "bodyText": "Jut a nit: you import all the other context names statically. But not this one.", "author": "fooker", "createdAt": "2020-06-03T21:37:13Z", "path": "core/ipc/rpc/utils/src/main/java/org/opennms/core/rpc/utils/mate/EntityScopeProviderImpl.java", "diffHunk": "@@ -240,21 +233,19 @@ public Scope getScopeForInterfaceByIfIndex(final Integer nodeId, final int ifInd\n \n             // SNMP interface facts\n             scopes.add(new ObjectScope<>(snmpInterface)\n-                    .map(INTERFACE, \"if-alias\", (i) -> Optional.ofNullable(snmpInterface.getIfAlias()))\n-                    .map(INTERFACE, \"if-description\", (i) -> Optional.ofNullable(snmpInterface.getIfDescr()))\n-                    .map(INTERFACE, \"phy-addr\", (i) -> Optional.ofNullable(snmpInterface.getPhysAddr())));\n+                    .map(ScopeId.INTERFACE, \"if-alias\", (i) -> Optional.ofNullable(i.getIfAlias()))", "originalCommit": "6236b05e3a3599dadc771e7c179fe32cbe829f13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg5MDUzNQ==", "url": "https://github.com/OpenNMS/opennms/pull/3019#discussion_r434890535", "bodyText": "true :-) fixed", "author": "patrick-schweizer", "createdAt": "2020-06-03T22:22:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg3MjIwNQ=="}], "type": "inlineReview"}, {"oid": "55738c26a4815a31e844ab1bbe95237adeb49f1c", "url": "https://github.com/OpenNMS/opennms/commit/55738c26a4815a31e844ab1bbe95237adeb49f1c", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: apply pr comments", "committedDate": "2020-06-03T22:18:04Z", "type": "commit"}, {"oid": "37cb2b7cbda6d7ecc9802d9ad14cf71a330cdf5f", "url": "https://github.com/OpenNMS/opennms/commit/37cb2b7cbda6d7ecc9802d9ad14cf71a330cdf5f", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: apply pr comments", "committedDate": "2020-06-03T22:22:05Z", "type": "commit"}, {"oid": "f958ba3387113f5cac940af793e23bed1e20606f", "url": "https://github.com/OpenNMS/opennms/commit/f958ba3387113f5cac940af793e23bed1e20606f", "message": "NMS-12730 Meta-data tag enhancements to Time Series Storage API: apply pr comments", "committedDate": "2020-06-03T22:26:24Z", "type": "commit"}]}