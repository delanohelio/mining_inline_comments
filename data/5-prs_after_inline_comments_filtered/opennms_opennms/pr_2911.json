{"pr_number": 2911, "pr_title": "NMS-12574: Apply default to OpenBMP kafka producer", "pr_createdAt": "2020-03-05T13:21:56Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2911", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNDgyNw==", "url": "https://github.com/OpenNMS/opennms/pull/2911#discussion_r388304827", "bodyText": "The Kafka client library has constants for these strings, would nice to use those.", "author": "j-white", "createdAt": "2020-03-05T13:51:43Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/openbmp/BmpKafkaProducer.java", "diffHunk": "@@ -59,7 +59,18 @@ public BmpKafkaProducer(final String topicPrefix,\n     }\n \n     private static KafkaProducer<String, String> buildProducer(final Map<String, Object> kafkaConfig) {\n-        // TODO fooker: Apply defaults (steal from https://github.com/SNAS/openbmp/blob/1a615a3c75a0143cc87ec70458471f0af67d3929/Server/src/kafka/MsgBusImpl_kafka.cpp#L162) (see https://issues.opennms.org/browse/NMS-12574)\n+        // Apply some defaults\n+        kafkaConfig.putIfAbsent(\"batch.num.messages\", 100);", "originalCommit": "21ec1e46c060e359c06c194e79c802f53ce8d703", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyMTQ4Ng==", "url": "https://github.com/OpenNMS/opennms/pull/2911#discussion_r388521486", "bodyText": "Can't find this property with quick search on producer config.  If you can directly get them from kafka client as Jesse suggested, that would rule out any outdated configuration.", "author": "cgorantla", "createdAt": "2020-03-05T19:43:29Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/openbmp/BmpKafkaProducer.java", "diffHunk": "@@ -59,7 +59,18 @@ public BmpKafkaProducer(final String topicPrefix,\n     }\n \n     private static KafkaProducer<String, String> buildProducer(final Map<String, Object> kafkaConfig) {\n-        // TODO fooker: Apply defaults (steal from https://github.com/SNAS/openbmp/blob/1a615a3c75a0143cc87ec70458471f0af67d3929/Server/src/kafka/MsgBusImpl_kafka.cpp#L162) (see https://issues.opennms.org/browse/NMS-12574)\n+        // Apply some defaults\n+        kafkaConfig.putIfAbsent(\"batch.num.messages\", 100);\n+        kafkaConfig.putIfAbsent(\"compression.codec\", \"snappy\");\n+        kafkaConfig.putIfAbsent(\"message.max.bytes\", 1000000);\n+        kafkaConfig.putIfAbsent(\"receive.message.max.bytes\", 100000000);", "originalCommit": "21ec1e46c060e359c06c194e79c802f53ce8d703", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d567196a43d7d110625bdb47703c30c7ef15ff5d", "url": "https://github.com/OpenNMS/opennms/commit/d567196a43d7d110625bdb47703c30c7ef15ff5d", "message": "NMS-12574: Apply default to OpenBMP kafka producer\n\nThis applies default values to the Kafka producer of the OpenBMP\nIntegration Adapter. The defaults are the same as the ones used in the\nOpenBMP reference implementation.", "committedDate": "2020-03-12T12:40:59Z", "type": "commit"}, {"oid": "d567196a43d7d110625bdb47703c30c7ef15ff5d", "url": "https://github.com/OpenNMS/opennms/commit/d567196a43d7d110625bdb47703c30c7ef15ff5d", "message": "NMS-12574: Apply default to OpenBMP kafka producer\n\nThis applies default values to the Kafka producer of the OpenBMP\nIntegration Adapter. The defaults are the same as the ones used in the\nOpenBMP reference implementation.", "committedDate": "2020-03-12T12:40:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5OTY4NA==", "url": "https://github.com/OpenNMS/opennms/pull/2911#discussion_r391899684", "bodyText": "I think these two parameters are sufficient for increasing the default message size. By default it is 1MB, you may want to increase it to 10MB.\nkafkaConfig.putIfAbsent(ProducerConfig.COMPRESSION_TYPE_CONFIG, \"snappy\");\nkafkaConfig.putIfAbsent(ProducerConfig.MAX_REQUEST_SIZE_CONFIG, 1000000);\nAlso we should allow the config to be added from osgi configuration just like here\nThe loaded config should override anything that we set here.  So we can totally skip these defaults and allow user to add them.", "author": "cgorantla", "createdAt": "2020-03-12T21:19:54Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/openbmp/BmpKafkaProducer.java", "diffHunk": "@@ -59,7 +60,12 @@ public BmpKafkaProducer(final String topicPrefix,\n     }\n \n     private static KafkaProducer<String, String> buildProducer(final Map<String, Object> kafkaConfig) {\n-        // TODO fooker: Apply defaults (steal from https://github.com/SNAS/openbmp/blob/1a615a3c75a0143cc87ec70458471f0af67d3929/Server/src/kafka/MsgBusImpl_kafka.cpp#L162) (see https://issues.opennms.org/browse/NMS-12574)\n+        // Apply some defaults\n+        kafkaConfig.putIfAbsent(ProducerConfig.BATCH_SIZE_CONFIG, 100);\n+        kafkaConfig.putIfAbsent(ProducerConfig.COMPRESSION_TYPE_CONFIG, \"snappy\");", "originalCommit": "d567196a43d7d110625bdb47703c30c7ef15ff5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM3Njc4MQ==", "url": "https://github.com/OpenNMS/opennms/pull/2911#discussion_r394376781", "bodyText": "We don't use our default kafka config mechanism here, because we talk to the external OpenBMP kafka cluster. Therefore the config is only set in the according adapter. And this config is already overriding the defaults, right?", "author": "fooker", "createdAt": "2020-03-18T14:13:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5OTY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQzMTI2MQ==", "url": "https://github.com/OpenNMS/opennms/pull/2911#discussion_r394431261", "bodyText": "okay, looks like it is set in adapter config. That works.", "author": "cgorantla", "createdAt": "2020-03-18T15:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5OTY4NA=="}], "type": "inlineReview"}]}