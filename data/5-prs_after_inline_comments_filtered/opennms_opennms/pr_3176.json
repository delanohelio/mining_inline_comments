{"pr_number": 3176, "pr_title": "NMS-12800: Drop flows with negative duration", "pr_createdAt": "2020-10-02T08:09:59Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3176", "timeline": [{"oid": "e9233ef3ff90e4b8a6b52f4c8071e9c777c0509a", "url": "https://github.com/OpenNMS/opennms/commit/e9233ef3ff90e4b8a6b52f4c8071e9c777c0509a", "message": "NMS-12800: Drop flows with negative duration", "committedDate": "2020-10-02T08:30:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxMDMwMw==", "url": "https://github.com/OpenNMS/opennms/pull/3176#discussion_r498810303", "bodyText": "Can we use a rate limited logger or move this up into the block above? (Trying to avoid spamming the logs with this.)\nCan we also include the exporter address in the log message?", "author": "j-white", "createdAt": "2020-10-02T13:09:28Z", "path": "features/telemetry/protocols/netflow/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/netflow/parser/ParserBase.java", "diffHunk": "@@ -241,7 +265,32 @@ public void setThreads(int threads) {\n                     // if we can't keep up\n                     final Runnable dispatch = () -> {\n                         // Let's serialize\n-                        byte[] flowMessage = buildMessage(record, enrichment);\n+                        byte[] flowMessage = new byte[0];\n+                        try {\n+                            flowMessage = buildMessage(record, enrichment);\n+                        } catch (IllegalFlowException e) {\n+                            final Optional<Instant> instant = illegalFlowEventCache.getUnchecked(remoteAddress.getAddress());\n+\n+                            if (!instant.isPresent() || Duration.between(instant.get(), Instant.now()).getSeconds() > getIllegalFlowEventRate()) {\n+                                illegalFlowEventCache.put(remoteAddress.getAddress(), Optional.of(Instant.now()));\n+\n+                                eventForwarder.sendNow(new EventBuilder()\n+                                        .setUei(ILLEGAL_FLOW_EVENT_UEI)\n+                                        .setTime(new Date())\n+                                        .setSource(getName())\n+                                        .setInterface(remoteAddress.getAddress())\n+                                        .setDistPoller(identity.getId())\n+                                        .addParam(\"monitoringSystemId\", identity.getId())\n+                                        .addParam(\"monitoringSystemLocation\", identity.getLocation())\n+                                        .setParam(\"cause\", e.getMessage())\n+                                        .setParam(\"illegalFlowEventRate\", (int) getIllegalFlowEventRate())\n+                                        .getEvent());\n+                            }\n+\n+                            LOG.warn(\"Illegal flow detected\", e);", "originalCommit": "e9233ef3ff90e4b8a6b52f4c8071e9c777c0509a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg4MzA3Mw==", "url": "https://github.com/OpenNMS/opennms/pull/3176#discussion_r498883073", "bodyText": "Pas de probl\u00e8me. La ligne a \u00e9t\u00e9 d\u00e9plac\u00e9e vers le bloc sup\u00e9rieur.", "author": "christianpape", "createdAt": "2020-10-02T15:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxMDMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg4ODM3Mg==", "url": "https://github.com/OpenNMS/opennms/pull/3176#discussion_r498888372", "bodyText": "C'est tr\u00e8s bien @christianpape. Je suis ravi.", "author": "j-white", "createdAt": "2020-10-02T15:20:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxMDMwMw=="}], "type": "inlineReview"}, {"oid": "f3b07330f396fc9932e67697b058c328b9517d03", "url": "https://github.com/OpenNMS/opennms/commit/f3b07330f396fc9932e67697b058c328b9517d03", "message": "NMS-12800: Review changes", "committedDate": "2020-10-02T15:12:57Z", "type": "forcePushed"}, {"oid": "1c522861ff9d16107ab0e2b5d6ebc4777f1b82f2", "url": "https://github.com/OpenNMS/opennms/commit/1c522861ff9d16107ab0e2b5d6ebc4777f1b82f2", "message": "NMS-12800: Drop flows with negative duration", "committedDate": "2020-10-03T07:53:13Z", "type": "commit"}, {"oid": "bdacb4787947cb190fb079cccbe971ad24188059", "url": "https://github.com/OpenNMS/opennms/commit/bdacb4787947cb190fb079cccbe971ad24188059", "message": "NMS-12800: Review changes", "committedDate": "2020-10-03T07:53:13Z", "type": "commit"}, {"oid": "bdacb4787947cb190fb079cccbe971ad24188059", "url": "https://github.com/OpenNMS/opennms/commit/bdacb4787947cb190fb079cccbe971ad24188059", "message": "NMS-12800: Review changes", "committedDate": "2020-10-03T07:53:13Z", "type": "forcePushed"}, {"oid": "ad4e472cd01d91b4e7cb3834206cbc766c2e3691", "url": "https://github.com/OpenNMS/opennms/commit/ad4e472cd01d91b4e7cb3834206cbc766c2e3691", "message": "NMS-12800: Also check NF5 and IPFIX for negative duration", "committedDate": "2020-10-05T13:34:31Z", "type": "commit"}, {"oid": "a667c1f59d3a9feed1532e09aafa1363e6604ef8", "url": "https://github.com/OpenNMS/opennms/commit/a667c1f59d3a9feed1532e09aafa1363e6604ef8", "message": "NMS-12800: Fixed build error", "committedDate": "2020-10-06T05:57:55Z", "type": "commit"}, {"oid": "0f844cf468fe375e39d9fddcbaccd1d4865f23d3", "url": "https://github.com/OpenNMS/opennms/commit/0f844cf468fe375e39d9fddcbaccd1d4865f23d3", "message": "NMS-12800: Fixed tests", "committedDate": "2020-10-06T16:42:46Z", "type": "commit"}, {"oid": "5333ec9fd8bcd6c6336cb70f026ed4a4fcd1ac14", "url": "https://github.com/OpenNMS/opennms/commit/5333ec9fd8bcd6c6336cb70f026ed4a4fcd1ac14", "message": "NMS-12800: Fixed smoke test", "committedDate": "2020-10-07T05:40:40Z", "type": "commit"}]}