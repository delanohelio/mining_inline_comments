{"pr_number": 3005, "pr_title": "NMS-12391: Use bulkhead to restrict number of threads", "pr_createdAt": "2020-05-12T01:02:10Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3005", "timeline": [{"oid": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3", "url": "https://github.com/OpenNMS/opennms/commit/4d5e8c08b5f0e97b0164b9d250d7ddb982584db3", "message": "NMS-12391: Use bulkhead to restrict number of threads\n\nDuring node scan, one node can have 100/1000s of interfaces and those interfaces\ncan have 10s of services. When those nodes are on minion, OpenNMS\nasynchronously sends all requests to minion. This may result in too many\nconcurrent requests.\n\nIdea is to restrict number of concurrent requests at a given point.\nUsing bulkhead to gate requests that are incoming with tunable timeout\nDefault timeout is 100msecs and max concurrent calls is 1000.\nSo when 1000 rpc requests are processing currently, only 10 extra requests per sec\nwill be allowed. This will allow not having a hard limit on threads but also\ngives chance to tune the system depending on the load.", "committedDate": "2020-05-12T02:01:23Z", "type": "commit"}, {"oid": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3", "url": "https://github.com/OpenNMS/opennms/commit/4d5e8c08b5f0e97b0164b9d250d7ddb982584db3", "message": "NMS-12391: Use bulkhead to restrict number of threads\n\nDuring node scan, one node can have 100/1000s of interfaces and those interfaces\ncan have 10s of services. When those nodes are on minion, OpenNMS\nasynchronously sends all requests to minion. This may result in too many\nconcurrent requests.\n\nIdea is to restrict number of concurrent requests at a given point.\nUsing bulkhead to gate requests that are incoming with tunable timeout\nDefault timeout is 100msecs and max concurrent calls is 1000.\nSo when 1000 rpc requests are processing currently, only 10 extra requests per sec\nwill be allowed. This will allow not having a hard limit on threads but also\ngives chance to tune the system depending on the load.", "committedDate": "2020-05-12T02:01:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NjA3NA==", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426666074", "bodyText": "Can you elaborate on why we still need to process the request?\nIf we continue processing the request there may still be >maxConcurrentCalls active.", "author": "j-white", "createdAt": "2020-05-18T14:26:14Z", "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -287,8 +301,12 @@ public void run() {\n                             }\n                             // Should have complete message by this point.\n                             final ByteString requestMessage = rpcContent;\n+                            // Incoming RPC requests are gated to restrict number of threads used by Kafka RPC.\n+                            // Need to process the requests after timeout even though permission acquisition fails.", "originalCommit": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY4MDk0Mg==", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426680942", "bodyText": "I'm thinking this as gradual increase of threads instead of a burst that could cause issues with too many threads.  As per current defaults,  only 10 extra threads will be allowed per sec after a threshold of maxConcurrentCalls.   Currently burst only happens with Provisiond and this allows it to not to have a burst of requests within few secs.", "author": "cgorantla", "createdAt": "2020-05-18T14:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NjA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcwMjc3OQ==", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426702779", "bodyText": "Makes sense - this will slow down and put back-pressure on the topic for bursts.\nLet's also make sure to expose a Gauge for the actual number of threads active - since this may differ from the number of active calls being tracked by the bulkhead.", "author": "j-white", "createdAt": "2020-05-18T15:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NjA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NzE5OA==", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426667198", "bodyText": "Let's expose the bulk head metrics like we've done here: https://github.com/OpenNMS/opennms/blob/develop/features/dnsresolver/netty/src/main/java/org/opennms/netmgt/dnsresolver/netty/NettyDnsResolver.java#L126", "author": "j-white", "createdAt": "2020-05-18T14:27:46Z", "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -162,6 +171,11 @@ public void init() throws IOException {\n         });\n         tracerRegistry.init(minionIdentity.getLocation() + \"@\" + minionIdentity.getId());\n \n+        BulkheadConfig bulkheadConfig = BulkheadConfig.custom()\n+                .maxConcurrentCalls(maxConcurrentCalls)\n+                .maxWaitDuration(java.time.Duration.ofMillis(maxWaitDuration))\n+                .build();\n+        bulkhead = Bulkhead.of(\"ipc-rpc-kafka\", bulkheadConfig);", "originalCommit": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY5OTkyNg==", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426699926", "bodyText": "This should only be called if tryAcquirePermission returned true.", "author": "j-white", "createdAt": "2020-05-18T15:13:03Z", "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -329,10 +347,12 @@ private void handleRequest(RpcMessageProto rpcRequestProto, ByteString rpcConten\n                 }\n                 // Finish minion Span\n                 minionSpan.finish();\n+                bulkhead.onComplete();", "originalCommit": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "84fbf2b9be12c54344280f30b127eb9d459da904", "url": "https://github.com/OpenNMS/opennms/commit/84fbf2b9be12c54344280f30b127eb9d459da904", "message": "NMS-12391: Add metrics on Minion side.", "committedDate": "2020-05-19T19:50:33Z", "type": "commit"}, {"oid": "5e790a9af27be8feda182b62d6be5137c7f9a2b3", "url": "https://github.com/OpenNMS/opennms/commit/5e790a9af27be8feda182b62d6be5137c7f9a2b3", "message": "NMS-12391: Handle doc review comments", "committedDate": "2020-05-19T22:04:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4NjE2MA==", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r428886160", "bodyText": "We can omit location here since all the requests will be for the same location right?", "author": "j-white", "createdAt": "2020-05-21T20:08:59Z", "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -315,6 +368,8 @@ private void handleRequest(RpcMessageProto rpcRequestProto, ByteString rpcConten\n             setTagsOnMinion(rpcRequestProto, request, minionSpan);\n             // Modules may run the execution in their own thread pool.\n             CompletableFuture<RpcResponse> future = module.execute(request);\n+            final Meter requestSentMeter = getMetrics().meter(MetricRegistry.name(request.getLocation(), module.getId(), RPC_COUNT));", "originalCommit": "5e790a9af27be8feda182b62d6be5137c7f9a2b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MDc5Nw==", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r428890797", "bodyText": "Maybe we should rename to requestsReceived? From this perspective we're processing the received request.", "author": "j-white", "createdAt": "2020-05-21T20:18:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4NjE2MA=="}], "type": "inlineReview"}, {"oid": "74995c6a9f5a9e2cde44c20e3b5f385ab5235984", "url": "https://github.com/OpenNMS/opennms/commit/74995c6a9f5a9e2cde44c20e3b5f385ab5235984", "message": "NMS-12391: Handle review comments", "committedDate": "2020-05-26T14:21:14Z", "type": "commit"}]}