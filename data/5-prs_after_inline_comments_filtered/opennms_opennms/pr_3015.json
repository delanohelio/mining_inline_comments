{"pr_number": 3015, "pr_title": "NMS-12698: Use modern collection API for response times", "pr_createdAt": "2020-05-18T22:15:24Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3015", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0Nzg0NA==", "url": "https://github.com/OpenNMS/opennms/pull/3015#discussion_r427247844", "bodyText": "Do we need to enforce storeByGroup here?", "author": "christianpape", "createdAt": "2020-05-19T12:03:36Z", "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -321,25 +327,52 @@ public void saveResponseTimeData(final String locationName, final OnmsMonitoredS\n             return;\n         }\n \n-        // FIXME: We don't need to recompute this everytime\n-        RrdRepository repository = new RrdRepository();\n-        repository.setStep(pollerConfig.getStep(pkg));\n-        repository.setHeartBeat(repository.getHeartBeat());\n-        repository.setRraList(pollerConfig.getRRAList(pkg));\n+        // TODO: Apply thresholding\n+\n+        final RrdRepository repository = new RrdRepository();\n+        repository.setStep(this.pollerConfig.getStep(pkg));\n+        repository.setHeartBeat(repository.getStep() * 2);\n+        repository.setRraList(this.pollerConfig.getRRAList(pkg));\n         repository.setRrdBaseDir(new File(rrdRepository));\n \n-        // FIXME: Use collectionset builder for this\n-        LatencyCollectionResource latencyResource = new LatencyCollectionResource(monSvc.getServiceName(), InetAddressUtils.toIpAddrString(monSvc.getIpAddress()), locationName);\n-        LatencyCollectionAttributeType latencyType = new LatencyCollectionAttributeType(rrdBaseName, dsName);\n-        latencyResource.addAttribute(new LatencyCollectionAttribute(latencyResource,\n-                latencyType, dsName, responseTime));\n+        // Prefer ds-name over \"response-time\" for primary response-time value\n+        final Map<String, Number> properties = Maps.newHashMap(pollStatus.getProperties());\n+        if (!properties.containsKey(dsName) && properties.containsKey(PollStatus.PROPERTY_RESPONSE_TIME)) {\n+            properties.put(dsName, properties.get(PollStatus.PROPERTY_RESPONSE_TIME));\n+            properties.remove(PollStatus.PROPERTY_RESPONSE_TIME);\n+        }\n \n-        ServiceParameters params = new ServiceParameters(Collections.emptyMap());\n-        CollectionSetVisitor persister = persisterFactory.createPersister(params, repository, false, true, true);\n+        // Build collection agent\n+        final CollectionAgentDTO agent = new CollectionAgentDTO();\n+        agent.setAddress(monSvc.getIpAddress());\n+        agent.setForeignId(monSvc.getForeignId());\n+        agent.setForeignSource(monSvc.getForeignSource());\n+        agent.setNodeId(monSvc.getNodeId());\n+        agent.setNodeLabel(monSvc.getIpInterface().getNode().getLabel());\n+        agent.setLocationName(locationName);\n+        agent.setStorageResourcePath(ResourcePath.get(LocationUtils.isDefaultLocationName(residentLocationName)\n+                                                      ? ResourcePath.get()\n+                                                      : ResourcePath.get(ResourcePath.sanitize(residentLocationName)),\n+                                                      InetAddressUtils.str(monSvc.getIpAddress())));\n+        agent.setStoreByForeignSource(false);\n+\n+        // Create collection set from response times as gauges and persist\n+        final CollectionSetBuilder collectionSetBuilder = new CollectionSetBuilder(agent);\n+        final RemoteLatencyResource resource = new RemoteLatencyResource(locationName, InetAddressUtils.str(monSvc.getIpAddress()), svcName);\n+        for (final Map.Entry<String, Number> e: properties.entrySet()) {\n+            final String key = PollStatus.PROPERTY_RESPONSE_TIME.equals(e.getKey())\n+                               ? dsName\n+                               : e.getKey();\n+\n+            collectionSetBuilder.withGauge(resource, rrdBaseName, key, e.getValue());\n+        }\n \n-        SingleResourceCollectionSet collectionSet = new SingleResourceCollectionSet(latencyResource, new Date());\n-        collectionSet.setStatus(CollectionStatus.SUCCEEDED);\n-        collectionSet.visit(persister);\n+        collectionSetBuilder.build()\n+                            .visit(this.persisterFactory.createPersister(new ServiceParameters(Collections.emptyMap()),\n+                                                                         repository,\n+                                                                         false,\n+                                                                         true,", "originalCommit": "fb34a14ac17858089e6cbefad11fb30162f50e8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5OTU3Mw==", "url": "https://github.com/OpenNMS/opennms/pull/3015#discussion_r427499573", "bodyText": "Yes. Response Times are always stored by group. Allowing to configure this would require to add another level in folder hierarchy, because we have to store multiple \"response\" tracks.", "author": "fooker", "createdAt": "2020-05-19T18:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0Nzg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5OTYxMQ==", "url": "https://github.com/OpenNMS/opennms/pull/3015#discussion_r427499611", "bodyText": "Yes. Response Times are always stored by group. Allowing to configure this would require to add another level in folder hierarchy, because we have to store multiple \"response\" tracks.", "author": "fooker", "createdAt": "2020-05-19T18:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0Nzg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MDEwNA==", "url": "https://github.com/OpenNMS/opennms/pull/3015#discussion_r428050104", "bodyText": "Should be easy to apply thresholding now that we have the CollectionSet.", "author": "j-white", "createdAt": "2020-05-20T14:18:11Z", "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -321,25 +327,52 @@ public void saveResponseTimeData(final String locationName, final OnmsMonitoredS\n             return;\n         }\n \n-        // FIXME: We don't need to recompute this everytime\n-        RrdRepository repository = new RrdRepository();\n-        repository.setStep(pollerConfig.getStep(pkg));\n-        repository.setHeartBeat(repository.getHeartBeat());\n-        repository.setRraList(pollerConfig.getRRAList(pkg));\n+        // TODO: Apply thresholding", "originalCommit": "fb34a14ac17858089e6cbefad11fb30162f50e8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgxNDA3Ng==", "url": "https://github.com/OpenNMS/opennms/pull/3015#discussion_r433814076", "bodyText": "There is a issue for that: https://issues.opennms.org/browse/NMS-12721", "author": "fooker", "createdAt": "2020-06-02T11:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MDEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MTk2Mg==", "url": "https://github.com/OpenNMS/opennms/pull/3015#discussion_r428051962", "bodyText": "Can we move this to the org.opennms.netmgt.collection.support.builder package of the org.opennms.features.collection.api module?\nI've been trying to collect all of the resource types there :)", "author": "j-white", "createdAt": "2020-05-20T14:20:28Z", "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -358,4 +391,49 @@ private String getServiceParameter(final Service svc, final String key) {\n     @Override\n     public void afterPropertiesSet() throws Exception {\n     }\n+\n+    public static class RemoteLatencyResource extends AbstractResource {", "originalCommit": "fb34a14ac17858089e6cbefad11fb30162f50e8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgxNjgzOQ==", "url": "https://github.com/OpenNMS/opennms/pull/3015#discussion_r433816839", "bodyText": "Done", "author": "fooker", "createdAt": "2020-06-02T11:50:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MTk2Mg=="}], "type": "inlineReview"}, {"oid": "68f70de96736962094bedbd651be1a02171c20fe", "url": "https://github.com/OpenNMS/opennms/commit/68f70de96736962094bedbd651be1a02171c20fe", "message": "fixup! NMS-12698: Use moden collection API for response times", "committedDate": "2020-06-02T11:53:07Z", "type": "forcePushed"}, {"oid": "06d0c65037c05755d1019319582c8a06fdc22c3d", "url": "https://github.com/OpenNMS/opennms/commit/06d0c65037c05755d1019319582c8a06fdc22c3d", "message": "NMS-12698: Use moden collection API for response times", "committedDate": "2020-06-03T08:08:12Z", "type": "commit"}, {"oid": "06d0c65037c05755d1019319582c8a06fdc22c3d", "url": "https://github.com/OpenNMS/opennms/commit/06d0c65037c05755d1019319582c8a06fdc22c3d", "message": "NMS-12698: Use moden collection API for response times", "committedDate": "2020-06-03T08:08:12Z", "type": "forcePushed"}]}