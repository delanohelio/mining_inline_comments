{"pr_number": 3728, "pr_title": "Add bookmarks to Nearby map", "pr_createdAt": "2020-05-04T19:33:38Z", "pr_url": "https://github.com/commons-app/apps-android-commons/pull/3728", "timeline": [{"oid": "ed714356aa43a8f5aa2c989166123ea825f4b660", "url": "https://github.com/commons-app/apps-android-commons/commit/ed714356aa43a8f5aa2c989166123ea825f4b660", "message": "Remove bookmark button from row button set and put to upper level list item", "committedDate": "2020-05-04T14:29:26Z", "type": "commit"}, {"oid": "1730b6e13fad9f0a5954ab35615e836a4544c24a", "url": "https://github.com/commons-app/apps-android-commons/commit/1730b6e13fad9f0a5954ab35615e836a4544c24a", "message": "Fix npe caused by lookinf for parent fragment, we don't have one anymore", "committedDate": "2020-05-04T14:50:34Z", "type": "commit"}, {"oid": "2dea17b72869f5de1913ae6f092293b6a9dd8f37", "url": "https://github.com/commons-app/apps-android-commons/commit/2dea17b72869f5de1913ae6f092293b6a9dd8f37", "message": "style", "committedDate": "2020-05-04T15:02:27Z", "type": "commit"}, {"oid": "62a31eed1cdfa8ef89ecf7bcc4dd78d1023e95f9", "url": "https://github.com/commons-app/apps-android-commons/commit/62a31eed1cdfa8ef89ecf7bcc4dd78d1023e95f9", "message": "Add new icons for bookmarked places", "committedDate": "2020-05-04T16:04:53Z", "type": "commit"}, {"oid": "a92dfd09a40ec576f7bc93a409de2e3434af2034", "url": "https://github.com/commons-app/apps-android-commons/commit/a92dfd09a40ec576f7bc93a409de2e3434af2034", "message": "Change bookmarked info when bookmarked", "committedDate": "2020-05-05T10:18:58Z", "type": "commit"}, {"oid": "1268e8197fdec5e140494cad6c4e092e0eaf3428", "url": "https://github.com/commons-app/apps-android-commons/commit/1268e8197fdec5e140494cad6c4e092e0eaf3428", "message": "Add pic field to bookmark dao so that we can retrieve them later", "committedDate": "2020-05-05T11:27:37Z", "type": "commit"}, {"oid": "7001e13870a9f900b065bbbdf7cc4b5ed41f6dc3", "url": "https://github.com/commons-app/apps-android-commons/commit/7001e13870a9f900b065bbbdf7cc4b5ed41f6dc3", "message": "Put bookmarks as the first item of list", "committedDate": "2020-05-06T16:31:46Z", "type": "commit"}, {"oid": "77ef68c9394f015fc38045443285f3c4a8d31776", "url": "https://github.com/commons-app/apps-android-commons/commit/77ef68c9394f015fc38045443285f3c4a8d31776", "message": "Add bookmark as a label", "committedDate": "2020-05-06T16:32:23Z", "type": "commit"}, {"oid": "d2075777d26794e62b849000d2933f4f1456083b", "url": "https://github.com/commons-app/apps-android-commons/commit/d2075777d26794e62b849000d2933f4f1456083b", "message": "Add logic to filter nearby", "committedDate": "2020-05-06T16:39:13Z", "type": "commit"}, {"oid": "2ed248ffc767d80e18c94ce088531dc359bf0b80", "url": "https://github.com/commons-app/apps-android-commons/commit/2ed248ffc767d80e18c94ce088531dc359bf0b80", "message": "remove unneeded changes", "committedDate": "2020-05-06T16:50:30Z", "type": "commit"}, {"oid": "5c206176e2f9365b783a5c7adc916cbd92cb8bb0", "url": "https://github.com/commons-app/apps-android-commons/commit/5c206176e2f9365b783a5c7adc916cbd92cb8bb0", "message": "fix word", "committedDate": "2020-05-06T16:53:27Z", "type": "commit"}, {"oid": "2c7028bf34f56f58cf7e36c0c8a55480da013b5e", "url": "https://github.com/commons-app/apps-android-commons/commit/2c7028bf34f56f58cf7e36c0c8a55480da013b5e", "message": "Remove logs", "committedDate": "2020-05-12T14:33:24Z", "type": "commit"}, {"oid": "d993acd62b3c1584a3c1da0d6d87a5a66b5c0e85", "url": "https://github.com/commons-app/apps-android-commons/commit/d993acd62b3c1584a3c1da0d6d87a5a66b5c0e85", "message": "Remove unused part of code", "committedDate": "2020-05-12T14:56:25Z", "type": "commit"}, {"oid": "a45cf040c3c500365269e700db3b38267f7259ae", "url": "https://github.com/commons-app/apps-android-commons/commit/a45cf040c3c500365269e700db3b38267f7259ae", "message": "Fix tests", "committedDate": "2020-05-15T08:40:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4OTY5MA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3728#discussion_r425689690", "bodyText": "agh static lists! I would be very concerned about ConcurrentModification, this is not thread safe for ArrayList.\nMaybe a CopyOnWriteArrayList would be best here? I am really not sure without diving deeper", "author": "macgills", "createdAt": "2020-05-15T09:46:32Z", "path": "app/src/main/java/fr/free/nrw/commons/nearby/NearbyController.java", "diffHunk": "@@ -255,4 +226,18 @@ public NearbyPlacesInfo loadAttractionsFromLocation(LatLng curLatLng, LatLng sea\n         public LatLng curLatLng; // Current location when this places are populated\n         public LatLng searchLatLng; // Search location for finding this places\n     }\n+\n+    /**\n+     * Updates makerLabelList item isBookmarked value\n+     * @param place place which is bookmarked\n+     * @param isBookmarked true is bookmarked, false if bookmark removed\n+     */\n+    public static void updateMarkerLabelListBookmark(Place place, boolean isBookmarked) {\n+        for (ListIterator<MarkerPlaceGroup> iter = markerLabelList.listIterator(); iter.hasNext();) {", "originalCommit": "a45cf040c3c500365269e700db3b38267f7259ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwOTk3Mw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3728#discussion_r425709973", "bodyText": "Hmmm actually I think copyOnWrite iterators don't allow modification... maybe we can mark the methods that update the list @MainThread which I am assuming is the assumption that keeps this working?", "author": "macgills", "createdAt": "2020-05-15T10:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4OTY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5NTA1MQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3728#discussion_r425695051", "bodyText": "all of these don't need 2 execution branches on isBookmarked, a ternary will make it look all the nicer\nvectorDrawable = VectorDrawableCompat.create(\n                    getContext().getResources(), \n                    isBookmarked ? R.drawable.ic_custom_map_marker_green_bookmarked : R.drawable.ic_custom_map_marker_green,\n                    getContext().getTheme()\n                );\n\nand we are repeating this vector creation a lot too I'd propose\nvectorDrawable(  isBookmarked \n? R.drawable.ic_custom_map_marker_green_bookmarked \n: R.drawable.ic_custom_map_marker_green)\n\nhmm actually all this logic does is choose a drawable really, maybe just a method to do that?\nprivate @DrawableRes Int getIconFor(Place place, Boolean isBookmarked)", "author": "macgills", "createdAt": "2020-05-15T09:56:52Z", "path": "app/src/main/java/fr/free/nrw/commons/nearby/fragments/NearbyParentFragment.java", "diffHunk": "@@ -1175,22 +1176,41 @@ public void updateMarker(boolean isBookmarked, Place place, @Nullable fr.free.nr\n         addPlaceToNearbyList(place);\n \n         VectorDrawableCompat vectorDrawable;\n-        if (isBookmarked) {\n-            vectorDrawable = VectorDrawableCompat.create(\n-                    getContext().getResources(), R.drawable.ic_custom_bookmark_marker, getContext().getTheme()\n-            );\n-        } else if (!place.pic.trim().isEmpty()) {\n-            vectorDrawable = VectorDrawableCompat.create( // Means place has picture\n-                    getContext().getResources(), R.drawable.ic_custom_map_marker_green, getContext().getTheme()\n-            );\n+        if (!place.pic.trim().isEmpty()) {\n+            if (isBookmarked) {", "originalCommit": "a45cf040c3c500365269e700db3b38267f7259ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5NjE5NQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3728#discussion_r425696195", "bodyText": "do we need these logs?", "author": "macgills", "createdAt": "2020-05-15T09:58:59Z", "path": "app/src/main/java/fr/free/nrw/commons/nearby/presenter/NearbyParentFragmentPresenter.java", "diffHunk": "@@ -308,10 +309,14 @@ public void updateMapMarkersToController(List<NearbyBaseMarker> nearbyBaseMarker\n         for (int i = 0; i < nearbyBaseMarkers.size(); i++) {\n             NearbyBaseMarker nearbyBaseMarker = nearbyBaseMarkers.get(i);\n             NearbyController.markerLabelList.add(\n-                    new MarkerPlaceGroup(nearbyBaseMarkers.get(i).getMarker(), bookmarkLocationDao.findBookmarkLocation(nearbyBaseMarkers.get(i).getPlace()), nearbyBaseMarker.getPlace()));\n+                    new MarkerPlaceGroup(nearbyBaseMarker.getMarker(), bookmarkLocationDao.findBookmarkLocation(nearbyBaseMarker.getPlace()), nearbyBaseMarker.getPlace()));\n             //TODO: fix bookmark location\n             NearbyController.markerExistsMap.put((nearbyBaseMarkers.get(i).getPlace().hasWikidataLink()), nearbyBaseMarkers.get(i).getMarker());\n             NearbyController.markerNeedPicMap.put(((nearbyBaseMarkers.get(i).getPlace().pic == null) ? true : false), nearbyBaseMarkers.get(i).getMarker());\n+            Log.d(\"deneme5\",\"pics:\"+nearbyBaseMarkers.get(i).getPlace().pic);", "originalCommit": "a45cf040c3c500365269e700db3b38267f7259ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMjQ5NQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3728#discussion_r425702495", "bodyText": "So this should be completely unnecessary, enums are inherently ordered.\nThis is the culprit in Label, mucking up ordering\npublic static final Map<String, Label> TEXT_TO_DESCRIPTION\n            = new HashMap<>(Label.values().length);\n\n    static {\n        for (Label label : values()) {\n            TEXT_TO_DESCRIPTION.put(label.text, label);\n        }\n    }\n\nThis map doesn't need to exist, the only usage is when constructing this class. A list can be created out of Label.values()\nAlso you could have directly referenced the bookmark eg labels.indexOf(Label.BOOKMARK)", "author": "macgills", "createdAt": "2020-05-15T10:11:06Z", "path": "app/src/main/java/fr/free/nrw/commons/nearby/NearbyFilterSearchRecyclerViewAdapter.java", "diffHunk": "@@ -120,6 +121,8 @@ protected FilterResults performFiltering(CharSequence constraint) {\n                 }\n \n                 if (constraint == null || constraint.length() == 0) {\n+                    // set my bookmarks as the first item\n+                    Collections.swap(labels, 0 , labels.indexOf(Label.fromText(\"BOOKMARK\")));", "originalCommit": "a45cf040c3c500365269e700db3b38267f7259ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYzNTQ5NA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3728#discussion_r426635494", "bodyText": "Hmm, but this map is actually useful to get label from text:\n        Label label = TEXT_TO_DESCRIPTION.get(text);", "author": "neslihanturan", "createdAt": "2020-05-18T13:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMjQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYzODI2NA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3728#discussion_r426638264", "bodyText": "tch, I must have had read access off in my find usages without realising.\nTEXT_TO_DESCRIPTION isn't needed as the input to this adapter because values suits just fine and we don't need to do a swap", "author": "macgills", "createdAt": "2020-05-18T13:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMjQ5NQ=="}], "type": "inlineReview"}, {"oid": "01fe867333959a09d57c2f802477010a0e479438", "url": "https://github.com/commons-app/apps-android-commons/commit/01fe867333959a09d57c2f802477010a0e479438", "message": "Remove logs", "committedDate": "2020-05-18T12:29:29Z", "type": "commit"}, {"oid": "87e7be6103181cc5567290f5aeeddb9efae3915b", "url": "https://github.com/commons-app/apps-android-commons/commit/87e7be6103181cc5567290f5aeeddb9efae3915b", "message": "simplify icon picking", "committedDate": "2020-05-18T14:02:03Z", "type": "commit"}, {"oid": "f3c2122f1379a5186c0e1101e45f580c9177abf3", "url": "https://github.com/commons-app/apps-android-commons/commit/f3c2122f1379a5186c0e1101e45f580c9177abf3", "message": "remove redundant margin left", "committedDate": "2020-05-18T15:58:38Z", "type": "commit"}, {"oid": "f739f29c6f544e95ac048c0d0f46ad52eefacc5c", "url": "https://github.com/commons-app/apps-android-commons/commit/f739f29c6f544e95ac048c0d0f46ad52eefacc5c", "message": "Remove non needed map and swap", "committedDate": "2020-05-18T16:18:40Z", "type": "commit"}, {"oid": "46ec520c7643107e3a1ed72db03af664520258a8", "url": "https://github.com/commons-app/apps-android-commons/commit/46ec520c7643107e3a1ed72db03af664520258a8", "message": "Add main thread annotation", "committedDate": "2020-05-18T19:00:14Z", "type": "commit"}, {"oid": "80f1e710b89d55f070797a859b92a7efde4c2ddf", "url": "https://github.com/commons-app/apps-android-commons/commit/80f1e710b89d55f070797a859b92a7efde4c2ddf", "message": "Fix tests", "committedDate": "2020-05-20T08:53:11Z", "type": "commit"}, {"oid": "6cde7af275e9dba56b6b78d9ea521d313df6a5a3", "url": "https://github.com/commons-app/apps-android-commons/commit/6cde7af275e9dba56b6b78d9ea521d313df6a5a3", "message": "Fix conflicts", "committedDate": "2020-05-20T15:05:46Z", "type": "commit"}]}