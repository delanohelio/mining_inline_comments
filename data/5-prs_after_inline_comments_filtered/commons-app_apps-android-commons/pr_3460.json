{"pr_number": 3460, "pr_title": "Added Support for System Wide Dark Theme", "pr_createdAt": "2020-03-04T00:44:39Z", "pr_url": "https://github.com/commons-app/apps-android-commons/pull/3460", "timeline": [{"oid": "aeed7cc5781c79f0b6f9fad0497386964f022ec7", "url": "https://github.com/commons-app/apps-android-commons/commit/aeed7cc5781c79f0b6f9fad0497386964f022ec7", "message": "Added Support for System Wide Dark Theme", "committedDate": "2020-03-04T00:39:14Z", "type": "commit"}, {"oid": "f1162e2e95a6043d9075c381c8e66cb8e5dc05ed", "url": "https://github.com/commons-app/apps-android-commons/commit/f1162e2e95a6043d9075c381c8e66cb8e5dc05ed", "message": "changed methods to private", "committedDate": "2020-03-04T00:50:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1MTU0NA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387551544", "bodyText": "These methods are repeated across classes, making future updates to this functionality more difficult.\nI would extract a class NightModeChecker or something similarly named and have it be injected", "author": "macgills", "createdAt": "2020-03-04T09:44:44Z", "path": "app/src/main/java/fr/free/nrw/commons/nearby/fragments/NearbyParentFragment.java", "diffHunk": "@@ -241,6 +242,27 @@ public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceStat\n         });\n     }\n \n+    // Return true is system wide dark theme is enabled else false\n+    private boolean getSystemDefaultThemeBool(String theme) {", "originalCommit": "f1162e2e95a6043d9075c381c8e66cb8e5dc05ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2MjgzMQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387562831", "bodyText": "@macgills I tried to avoid the repetition but getResources() says a non-static method can't be inside a static method!", "author": "madhurgupta10", "createdAt": "2020-03-04T10:04:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1MTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3MTQ2Nw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387571467", "bodyText": "Then don't use static. Create a normal class to host the logic, one that is instantiated by Dagger", "author": "macgills", "createdAt": "2020-03-04T10:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1MTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1MzExNw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387653117", "bodyText": "Done!", "author": "madhurgupta10", "createdAt": "2020-03-04T13:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1MTU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1MzI4Ng==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387553286", "bodyText": "If you just returned true or false here you could simplify this method down to\nreturn (getResources().getConfiguration().uiMode & Configuration.UI_MODE_NIGHT_MASK) == Configuration.UI_MODE_NIGHT_YES;", "author": "macgills", "createdAt": "2020-03-04T09:47:43Z", "path": "app/src/main/java/fr/free/nrw/commons/auth/LoginActivity.java", "diffHunk": "@@ -133,14 +136,35 @@ public void onCreate(Bundle savedInstanceState) {\n         usernameEdit.addTextChangedListener(textWatcher);\n         passwordEdit.addTextChangedListener(textWatcher);\n         twoFactorEdit.addTextChangedListener(textWatcher);\n-        \n+\n         if (ConfigUtils.isBetaFlavour()) {\n             loginCredentials.setText(getString(R.string.login_credential));\n         } else {\n             loginCredentials.setVisibility(View.GONE);\n         }\n     }\n \n+    // Return true is system wide dark theme is enabled else false\n+    private boolean getSystemDefaultThemeBool(String theme) {\n+        switch (theme) {\n+            case \"Dark\":\n+                return true;\n+            case \"Default\":\n+                return getSystemDefaultThemeBool(getSystemDefaultTheme());\n+            default:\n+                return false;\n+        }\n+    }\n+\n+    // Returns the default system wide theme\n+    private String getSystemDefaultTheme() {\n+        if ((getResources().getConfiguration().uiMode &", "originalCommit": "f1162e2e95a6043d9075c381c8e66cb8e5dc05ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NDYxNA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387554614", "bodyText": "Ah but it is used as the default value for the store. Well a method could be extracted certainly, \"isDeviceInNightMode\"", "author": "macgills", "createdAt": "2020-03-04T09:49:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1MzI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1MzAwMg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387653002", "bodyText": "Done!", "author": "madhurgupta10", "createdAt": "2020-03-04T13:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1MzI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NjMzMg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387556332", "bodyText": "There is no separation between UI and data representation. As such these strings are untranslatable", "author": "macgills", "createdAt": "2020-03-04T09:52:59Z", "path": "app/src/main/java/fr/free/nrw/commons/settings/SettingsFragment.java", "diffHunk": "@@ -144,6 +141,71 @@ public void afterTextChanged(Editable s) {\n         }\n     }\n \n+    // Return true is system wide dark theme is enabled else false\n+    private boolean getSystemDefaultThemeBool(String theme) {\n+        switch (theme) {\n+            case \"Dark\":\n+                return true;\n+            case \"Default\":\n+                return getSystemDefaultThemeBool(getSystemDefaultTheme());\n+            default:\n+                return false;\n+        }\n+    }\n+\n+    // Returns the default system wide theme\n+    private String getSystemDefaultTheme() {\n+        if ((getResources().getConfiguration().uiMode &\n+                Configuration.UI_MODE_NIGHT_MASK) == Configuration.UI_MODE_NIGHT_YES) {\n+            return \"Dark\";\n+        }\n+        return \"Light\";\n+    }\n+\n+    /**\n+     * Prepares themes list and adds them to list preference as pairs.\n+     * Uses previously saved theme if there is any, if not then uses default.\n+     * Adds preference theme listener and saves value choosen by user to shared preferences\n+     * to remember later\n+     */\n+    private void prepareTheme() {\n+\n+        String[] themeOptionsNames = {\"Default\", \"Dark\", \"Light\"};", "originalCommit": "f1162e2e95a6043d9075c381c8e66cb8e5dc05ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2NTQ0NQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387565445", "bodyText": "Good point, I missed to catch it, I will move them to strings.xml", "author": "madhurgupta10", "createdAt": "2020-03-04T10:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NjMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3NzAxMA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387577010", "bodyText": "I would also map the internal representation to enums, switching on strings is a headache most people don't need.\nIt would also be preferrable if you could pass this data in in the preferences.xml.", "author": "macgills", "createdAt": "2020-03-04T10:29:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NjMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2Njc5MQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387666791", "bodyText": "Please review the new changes and let me know if I understood correctly.", "author": "madhurgupta10", "createdAt": "2020-03-04T13:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NjMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3ODUzNQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387578535", "bodyText": "You are using a different key than the one used preferences.xml, is this intentional?", "author": "macgills", "createdAt": "2020-03-04T10:32:06Z", "path": "app/src/main/java/fr/free/nrw/commons/settings/Prefs.java", "diffHunk": "@@ -9,6 +9,7 @@\n     public static final String IS_CONTRIBUTION_COUNT_CHANGED = \"ccontributionCountChanged\";\n     public static final String MANAGED_EXIF_TAGS = \"managed_exif_tags\";\n     public static final String KEY_LANGUAGE_VALUE = \"languageDescription\";\n+    public static final String KEY_THEME_VALUE = \"theme\";", "originalCommit": "f1162e2e95a6043d9075c381c8e66cb8e5dc05ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4Nzk5OA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387587998", "bodyText": "@macgills Yes! It is intentional", "author": "madhurgupta10", "createdAt": "2020-03-04T10:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3ODUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzMDgzNA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387630834", "bodyText": "It is however the same as the pre-existing boolean key... I am actually unsure what happens when you migrate the type of a sharedPreference value. Have you installed a previous version and then upgraded to this one after having changed the night mode value? I wouldn't be surprised if something explodes.\nAlso please elaborate on why it is intentional.", "author": "macgills", "createdAt": "2020-03-04T12:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3ODUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzNDA0NQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387634045", "bodyText": "@macgills I need to change it because I was getting the error String can't be converted into Boolean. The app data needs to be cleaned once after the update.", "author": "madhurgupta10", "createdAt": "2020-03-04T12:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3ODUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY0Nzc1NA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387647754", "bodyText": "Okay, the code will still break and we do not ask our users to clean their data to get an update for our app.\nLet me explain a bit how PreferenceFragment works.\nIt loads a preference from xml eg\n        <fr.free.nrw.commons.ui.LongTitlePreferences.LongTitleSwitchPreference\n            android:key=\"displayNearbyCardView\"\n            android:title=\"@string/display_nearby_notification\"\n            android:defaultValue=\"true\"\n            android:summary=\"@string/display_nearby_notification_summary\" />\n\nPreferenceFragment by default uses the DefaultSharedPreferences to store and retrieve these values, for the above example sharedPrefs.getBoolean(\"displayNearbyCardView\", \"true\") would be used when the UI loads.\nIt also uses the sharedPreferences to save this value when the UI updates sharedPrefs.putBoolean(\"displayNearbyCardView\", <uiValue>). This code is internal to PreferenceFragment.\nThe original key of this preference was theme when it was a boolean, you try to read it in LoginActivity as a String with the same key. If this preference exists ie set from a previous install, I forsee this being an issue.\nI recommend you use an entirely new key, and set android:entries android:entryValues android:defaultValue\" in xml\nI don't particularly like PreferenceFragment but it is here so we should use it.\nAugh we are using the deprecated PreferenceFragment instead of Androidx even! You don't have to worry about that though", "author": "macgills", "createdAt": "2020-03-04T12:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3ODUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2NjczNQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387666735", "bodyText": "Please review the new changes and let me know if I understood correctly.", "author": "madhurgupta10", "createdAt": "2020-03-04T13:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3ODUzNQ=="}], "type": "inlineReview"}, {"oid": "b5114d2626a6328b8825fe695c2ed1f9950133d5", "url": "https://github.com/commons-app/apps-android-commons/commit/b5114d2626a6328b8825fe695c2ed1f9950133d5", "message": "Moved Strings to strings.xml", "committedDate": "2020-03-04T10:48:33Z", "type": "commit"}, {"oid": "1fd47e88efd7e6953d375a7a41cb5173c68fc185", "url": "https://github.com/commons-app/apps-android-commons/commit/1fd47e88efd7e6953d375a7a41cb5173c68fc185", "message": "Used Dagger to reduce code repetition", "committedDate": "2020-03-04T13:05:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1ODU5MQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387658591", "bodyText": "You shouldn't perform field injection and constructor injection, wherever possible use constructor injection. Also this will not be injected and should crash the application with a NPE.\nMove @Named(\"default_preferences\") JsonKvStore applicationKvStore into the constructor like context", "author": "macgills", "createdAt": "2020-03-04T13:16:17Z", "path": "app/src/main/java/fr/free/nrw/commons/utils/SystemThemeUtils.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package fr.free.nrw.commons.utils;\n+\n+import android.content.Context;\n+import android.content.res.Configuration;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import fr.free.nrw.commons.R;\n+import fr.free.nrw.commons.kvstore.JsonKvStore;\n+import fr.free.nrw.commons.settings.Prefs;\n+\n+public class SystemThemeUtils {\n+\n+    private Context context;\n+\n+    @Inject\n+    @Named(\"default_preferences\")\n+    JsonKvStore applicationKvStore;", "originalCommit": "1fd47e88efd7e6953d375a7a41cb5173c68fc185", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2NjMzNg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387666336", "bodyText": "Done! Thanks for the suggestion.", "author": "madhurgupta10", "createdAt": "2020-03-04T13:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1ODU5MQ=="}], "type": "inlineReview"}, {"oid": "479a51c6ca7067e80229096ed902f697e4bac20c", "url": "https://github.com/commons-app/apps-android-commons/commit/479a51c6ca7067e80229096ed902f697e4bac20c", "message": "Changes made as per review suggestions", "committedDate": "2020-03-04T13:30:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3MDUxMA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387670510", "bodyText": "now you can delete all of this except\nsetOnPreferenceChangeListener{\nactivity.recreate()\n}", "author": "macgills", "createdAt": "2020-03-04T13:38:16Z", "path": "app/src/main/java/fr/free/nrw/commons/settings/SettingsFragment.java", "diffHunk": "@@ -144,10 +145,51 @@ public void afterTextChanged(Editable s) {\n         }\n     }\n \n+    /**\n+     * Uses previously saved theme if there is any, if not then uses default.\n+     * Adds preference theme listener and saves value chosen by user to shared preferences\n+     * to remember later\n+     */\n+    private void prepareTheme() {", "originalCommit": "479a51c6ca7067e80229096ed902f697e4bac20c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2MTk1Nw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387961957", "bodyText": "I removed the irrelevant code now but the if - else clause is important to set the initial summary so I kept it.", "author": "madhurgupta10", "createdAt": "2020-03-04T22:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3MDUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3MjQ2Mg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387672462", "bodyText": "context has a method getString(), you don't need resources to get a String", "author": "macgills", "createdAt": "2020-03-04T13:41:42Z", "path": "app/src/main/java/fr/free/nrw/commons/utils/SystemThemeUtils.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package fr.free.nrw.commons.utils;\n+\n+import android.content.Context;\n+import android.content.res.Configuration;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import fr.free.nrw.commons.R;\n+import fr.free.nrw.commons.kvstore.JsonKvStore;\n+import fr.free.nrw.commons.settings.Prefs;\n+\n+public class SystemThemeUtils {\n+\n+    private Context context;\n+    private JsonKvStore applicationKvStore;\n+\n+    @Inject\n+    public SystemThemeUtils(Context context, @Named(\"default_preferences\") JsonKvStore applicationKvStore) {\n+        this.context = context;\n+        this.applicationKvStore = applicationKvStore;\n+    }\n+\n+    // Return true is system wide dark theme is enabled else false\n+    public boolean getSystemDefaultThemeBool(String theme) {\n+        if (context.getResources().getString(R.string.theme_dark_name).equals(theme)) {", "originalCommit": "479a51c6ca7067e80229096ed902f697e4bac20c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2MTI2Nw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r387961267", "bodyText": "Thanks, changes made!", "author": "madhurgupta10", "createdAt": "2020-03-04T22:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3MjQ2Mg=="}], "type": "inlineReview"}, {"oid": "568448af968e547c4891b0b015d4b5fae96a91d4", "url": "https://github.com/commons-app/apps-android-commons/commit/568448af968e547c4891b0b015d4b5fae96a91d4", "message": "Minor Changes", "committedDate": "2020-03-04T22:02:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MDIyNQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388160225", "bodyText": "this is never true", "author": "macgills", "createdAt": "2020-03-05T09:09:35Z", "path": "app/src/main/java/fr/free/nrw/commons/settings/SettingsFragment.java", "diffHunk": "@@ -144,10 +141,42 @@ public void afterTextChanged(Editable s) {\n         }\n     }\n \n+    /**\n+     * Uses previously saved theme if there is any, if not then uses default.\n+     * Adds preference theme listener and saves value chosen by user to shared preferences\n+     * to remember later\n+     */\n+    private void prepareTheme() {\n+\n+        String currentTheme = getCurrentTheme();\n+        if (currentTheme.equals(\"\")){", "originalCommit": "568448af968e547c4891b0b015d4b5fae96a91d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI2OTIzNw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388269237", "bodyText": "I understand now, thanks for pointing it out, I removed it!", "author": "madhurgupta10", "createdAt": "2020-03-05T12:43:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MDIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MDUzMQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388160531", "bodyText": "You can just use simpleSummary, see the docs", "author": "macgills", "createdAt": "2020-03-05T09:10:13Z", "path": "app/src/main/java/fr/free/nrw/commons/settings/SettingsFragment.java", "diffHunk": "@@ -144,10 +141,42 @@ public void afterTextChanged(Editable s) {\n         }\n     }\n \n+    /**\n+     * Uses previously saved theme if there is any, if not then uses default.\n+     * Adds preference theme listener and saves value chosen by user to shared preferences\n+     * to remember later\n+     */\n+    private void prepareTheme() {\n+\n+        String currentTheme = getCurrentTheme();\n+        if (currentTheme.equals(\"\")){\n+            // If current theme code is empty, means none selected by user yet so use default\n+            themeListPreference.setSummary(getString(R.string.theme_default_name));\n+            themeListPreference.setValue(getString(R.string.theme_default_value));\n+        } else {\n+            // If any theme is selected by user previously, use it\n+            int prefIndex = themeListPreference.findIndexOfValue(currentTheme);\n+            themeListPreference.setSummary(themeListPreference.getEntries()[prefIndex]);", "originalCommit": "568448af968e547c4891b0b015d4b5fae96a91d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3MTg3Ng==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388271876", "bodyText": "I am unable to use simpleSumarry, I followed the instructions from the docs but there is no method ListPreference.SimpleSummaryProvider.getInstance() even after adding app:useSimpleSummaryProvider=\"true\" to XML", "author": "madhurgupta10", "createdAt": "2020-03-05T12:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3Nzg1OQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388277859", "bodyText": "Okay now I care about us not using the androidx artifacts. So irritating.\nHow do you feel about a follow up ticket to this? Change Preferences to use AndroidX?", "author": "macgills", "createdAt": "2020-03-05T13:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4Mzc1NA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388283754", "bodyText": "@macgills Sure, I think we should do it in a separate PR,", "author": "madhurgupta10", "createdAt": "2020-03-05T13:13:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4NjI4Ng==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388286286", "bodyText": "Absolutely, I'll make it and assign you, cheers.", "author": "macgills", "createdAt": "2020-03-05T13:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MDUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MjE5NQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388162195", "bodyText": "AS should suggest turning this into a ternary", "author": "macgills", "createdAt": "2020-03-05T09:13:25Z", "path": "app/src/main/java/fr/free/nrw/commons/utils/SystemThemeUtils.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package fr.free.nrw.commons.utils;\n+\n+import android.content.Context;\n+import android.content.res.Configuration;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import fr.free.nrw.commons.R;\n+import fr.free.nrw.commons.kvstore.JsonKvStore;\n+import fr.free.nrw.commons.settings.Prefs;\n+\n+public class SystemThemeUtils {\n+\n+    private Context context;\n+    private JsonKvStore applicationKvStore;\n+\n+    @Inject\n+    public SystemThemeUtils(Context context, @Named(\"default_preferences\") JsonKvStore applicationKvStore) {\n+        this.context = context;\n+        this.applicationKvStore = applicationKvStore;\n+    }\n+\n+    // Return true is system wide dark theme is enabled else false\n+    public boolean getSystemDefaultThemeBool(String theme) {\n+        if (theme.equals(context.getString(R.string.theme_dark_value))) {\n+            return true;\n+        } else if (theme.equals(context.getString(R.string.theme_default_value))) {\n+            return getSystemDefaultThemeBool(getSystemDefaultTheme());\n+        }\n+        return false;\n+    }\n+\n+    // Returns the default system wide theme\n+    public String getSystemDefaultTheme() {\n+        if ((context.getResources().getConfiguration().uiMode &", "originalCommit": "568448af968e547c4891b0b015d4b5fae96a91d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI2ODkyMA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388268920", "bodyText": "Done!", "author": "madhurgupta10", "createdAt": "2020-03-05T12:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2MjE5NQ=="}], "type": "inlineReview"}, {"oid": "e0371eeef98ed2601edcbb82b613b3738734bf16", "url": "https://github.com/commons-app/apps-android-commons/commit/e0371eeef98ed2601edcbb82b613b3738734bf16", "message": "Fixes as per suggestions", "committedDate": "2020-03-05T12:42:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3OTE0MA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388279140", "bodyText": "the recreate of the activity should mean that the summary gets set by the code above us anyhow, or at least that is how the code is running in my head. try it with deleting setSummary", "author": "macgills", "createdAt": "2020-03-05T13:03:40Z", "path": "app/src/main/java/fr/free/nrw/commons/settings/SettingsFragment.java", "diffHunk": "@@ -144,10 +141,39 @@ public void afterTextChanged(Editable s) {\n         }\n     }\n \n+    /**\n+     * Uses previously saved theme if there is any, if not then uses default.\n+     * Adds preference theme listener and saves value chosen by user to shared preferences\n+     * to remember later\n+     */\n+    private void prepareTheme() {\n+\n+        String currentTheme = getCurrentTheme();\n+\n+        themeListPreference.setSummary(getThemeSummary(currentTheme));\n+        themeListPreference.setValue(currentTheme);\n+\n+        themeListPreference.setOnPreferenceChangeListener((preference, newValue) -> {\n+            String userSelectedValue = (String) newValue;\n+            themeListPreference.setSummary(getThemeSummary(userSelectedValue));\n+            getActivity().recreate();", "originalCommit": "e0371eeef98ed2601edcbb82b613b3738734bf16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5NjMxNQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388296315", "bodyText": "You are right, I removed the unnecessary code!", "author": "madhurgupta10", "createdAt": "2020-03-05T13:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3OTE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4NTg3Mw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388285873", "bodyText": "These are magic strings and it would be good if we could not be using them like this.\nThere are 2 options:\n\nextract constants for 1,2,3 THEME_MODE_DEFAULT etc\ncreate a enum to represent these values, wrapping the retrieval from the keystore\n\nI much prefer 2 because it is a superiorily typed expression. 2 is easier. Your choice", "author": "macgills", "createdAt": "2020-03-05T13:17:22Z", "path": "app/src/main/java/fr/free/nrw/commons/utils/SystemThemeUtils.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package fr.free.nrw.commons.utils;\n+\n+import android.content.Context;\n+import android.content.res.Configuration;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import fr.free.nrw.commons.kvstore.JsonKvStore;\n+import fr.free.nrw.commons.settings.Prefs;\n+\n+public class SystemThemeUtils {\n+\n+    private Context context;\n+    private JsonKvStore applicationKvStore;\n+\n+    @Inject\n+    public SystemThemeUtils(Context context, @Named(\"default_preferences\") JsonKvStore applicationKvStore) {\n+        this.context = context;\n+        this.applicationKvStore = applicationKvStore;\n+    }\n+\n+    // Return true is system wide dark theme is enabled else false\n+    public boolean getSystemDefaultThemeBool(String theme) {\n+        if (theme.equals(\"1\")) {", "originalCommit": "e0371eeef98ed2601edcbb82b613b3738734bf16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5NjQyMw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388296423", "bodyText": "Done!", "author": "madhurgupta10", "createdAt": "2020-03-05T13:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4NTg3Mw=="}], "type": "inlineReview"}, {"oid": "492a336c9abc1bcd256d90452667f4fd54953899", "url": "https://github.com/commons-app/apps-android-commons/commit/492a336c9abc1bcd256d90452667f4fd54953899", "message": "Minor Fixes as per suggestion", "committedDate": "2020-03-05T13:40:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5OTkxNg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388299916", "bodyText": "make these static and access them statically", "author": "macgills", "createdAt": "2020-03-05T13:43:23Z", "path": "app/src/main/java/fr/free/nrw/commons/utils/SystemThemeUtils.java", "diffHunk": "@@ -14,6 +14,10 @@\n     private Context context;\n     private JsonKvStore applicationKvStore;\n \n+    public final String THEME_MODE_DEFAULT = \"0\";", "originalCommit": "492a336c9abc1bcd256d90452667f4fd54953899", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwMTg1MQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388301851", "bodyText": "Done!", "author": "madhurgupta10", "createdAt": "2020-03-05T13:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5OTkxNg=="}], "type": "inlineReview"}, {"oid": "8a99f7724c39d0d050da8959103ae659e2580810", "url": "https://github.com/commons-app/apps-android-commons/commit/8a99f7724c39d0d050da8959103ae659e2580810", "message": "made the variables static", "committedDate": "2020-03-05T13:49:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNjMzNg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388306336", "bodyText": "You can get rid of setValue, this should be the last comment!", "author": "macgills", "createdAt": "2020-03-05T13:54:18Z", "path": "app/src/main/java/fr/free/nrw/commons/settings/SettingsFragment.java", "diffHunk": "@@ -144,10 +143,35 @@ public void afterTextChanged(Editable s) {\n         }\n     }\n \n+    /**\n+     * Uses previously saved theme if there is any, if not then uses default.\n+     */\n+    private void prepareTheme() {\n+\n+        String currentTheme = getCurrentTheme();\n+\n+        themeListPreference.setSummary(getThemeSummary(currentTheme));\n+        themeListPreference.setValue(currentTheme);", "originalCommit": "8a99f7724c39d0d050da8959103ae659e2580810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNjc2Mw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388306763", "bodyText": "@macgills I kept it because it is important for the first time when the user installs the app!", "author": "madhurgupta10", "createdAt": "2020-03-05T13:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNjMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNzk4OQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388307989", "bodyText": "defaultValue in the xml should take care of it, maybe you didn't have that set when you first added this line", "author": "macgills", "createdAt": "2020-03-05T13:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNjMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMxMDI5MA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388310290", "bodyText": "Since I removed the default value (\"0\") from the strings.xml\nI think it is better to keep it in java code, in case we decide to change it to something else later we might forget to change it in XML but this is just my thinking.", "author": "madhurgupta10", "createdAt": "2020-03-05T14:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNjMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMxMzY2MA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388313660", "bodyText": "This is why I hate PreferenceFragment. I'd just keep default value in the xml.\nThe only other way to work around is a subclass of Preference or black magic with gradle", "author": "macgills", "createdAt": "2020-03-05T14:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNjMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyMDQ5OQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3460#discussion_r388320499", "bodyText": "Done!", "author": "madhurgupta10", "createdAt": "2020-03-05T14:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNjMzNg=="}], "type": "inlineReview"}, {"oid": "e7e820ee437bf767ddca385b978394aa88d58b89", "url": "https://github.com/commons-app/apps-android-commons/commit/e7e820ee437bf767ddca385b978394aa88d58b89", "message": "removed irrelevant code", "committedDate": "2020-03-05T14:17:40Z", "type": "commit"}]}