{"pr_number": 5250, "pr_title": "Issue 5221: Port CLI security changes from Pravega Tools to Pravega core", "pr_createdAt": "2020-10-13T12:47:02Z", "pr_url": "https://github.com/pravega/pravega/pull/5250", "timeline": [{"oid": "8cd9e167a223ac94bac6427e355d28201f751b91", "url": "https://github.com/pravega/pravega/commit/8cd9e167a223ac94bac6427e355d28201f751b91", "message": "added security related changes\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-12T05:59:16Z", "type": "commit"}, {"oid": "b152d1e10318ff4ca806791f08fc8f851f7a36f8", "url": "https://github.com/pravega/pravega/commit/b152d1e10318ff4ca806791f08fc8f851f7a36f8", "message": "Added more tests for controller commands in secure scenarios\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-13T09:49:29Z", "type": "commit"}, {"oid": "23f4acb5403afa478f29eb5e433e41f78774d8f0", "url": "https://github.com/pravega/pravega/commit/23f4acb5403afa478f29eb5e433e41f78774d8f0", "message": "Fixed checkstyle, added a SecureSetupUtils for secure env testing, modified tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-14T05:53:21Z", "type": "commit"}, {"oid": "d2a1e98c26dce8018fba0d9de847e13a87c65c01", "url": "https://github.com/pravega/pravega/commit/d2a1e98c26dce8018fba0d9de847e13a87c65c01", "message": "Fixed admin cli spotbug fail\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-14T07:58:59Z", "type": "commit"}, {"oid": "1241943d2cfdba7dab52b4630a911bb3101718fc", "url": "https://github.com/pravega/pravega/commit/1241943d2cfdba7dab52b4630a911bb3101718fc", "message": "Merge remote-tracking branch 'upstream/master' into issue-5221-secure-cli", "committedDate": "2020-10-16T04:29:52Z", "type": "commit"}, {"oid": "1c6d1cf48800d4f5b6187053398b8a98c7f38b70", "url": "https://github.com/pravega/pravega/commit/1c6d1cf48800d4f5b6187053398b8a98c7f38b70", "message": "ControllerWrapper auth is enabled in SecureSetupUtils\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-16T05:31:50Z", "type": "commit"}, {"oid": "716561dfdea93524f880eccdef691a77a7ea33b1", "url": "https://github.com/pravega/pravega/commit/716561dfdea93524f880eccdef691a77a7ea33b1", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-10-19T04:42:55Z", "type": "commit"}, {"oid": "958f481ceb915cc7a9c893b37c7db5d4fa92e48e", "url": "https://github.com/pravega/pravega/commit/958f481ceb915cc7a9c893b37c7db5d4fa92e48e", "message": "Added changes to user-cli for secure environments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-21T10:17:50Z", "type": "commit"}, {"oid": "b3446d8925062ac47c37dc812ba5561e454432be", "url": "https://github.com/pravega/pravega/commit/b3446d8925062ac47c37dc812ba5561e454432be", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-10-21T10:18:39Z", "type": "commit"}, {"oid": "b3446d8925062ac47c37dc812ba5561e454432be", "url": "https://github.com/pravega/pravega/commit/b3446d8925062ac47c37dc812ba5561e454432be", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-10-21T10:18:39Z", "type": "forcePushed"}, {"oid": "28080901e73ba9f1278c0bad59458a65378e48ce", "url": "https://github.com/pravega/pravega/commit/28080901e73ba9f1278c0bad59458a65378e48ce", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-10-22T10:35:56Z", "type": "commit"}, {"oid": "b6bc12bfb99346b5456ca02013d33828893c2b28", "url": "https://github.com/pravega/pravega/commit/b6bc12bfb99346b5456ca02013d33828893c2b28", "message": "Added auth tests for user commands, added standalone based tls, secure tests for admin\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-22T12:49:48Z", "type": "commit"}, {"oid": "b6bc12bfb99346b5456ca02013d33828893c2b28", "url": "https://github.com/pravega/pravega/commit/b6bc12bfb99346b5456ca02013d33828893c2b28", "message": "Added auth tests for user commands, added standalone based tls, secure tests for admin\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-22T12:49:48Z", "type": "forcePushed"}, {"oid": "d4bb324655b5b3c0639caa134504aa1a0a6a1ab3", "url": "https://github.com/pravega/pravega/commit/d4bb324655b5b3c0639caa134504aa1a0a6a1ab3", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-10-23T10:17:44Z", "type": "commit"}, {"oid": "2572fe32258bd2161c355bb69e114433f72568e4", "url": "https://github.com/pravega/pravega/commit/2572fe32258bd2161c355bb69e114433f72568e4", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-10-28T09:48:07Z", "type": "commit"}, {"oid": "64aefb5947586ab85025715fe60484460c955c16", "url": "https://github.com/pravega/pravega/commit/64aefb5947586ab85025715fe60484460c955c16", "message": "Changes to build.gradle to resolve dependencies, added tests for user cli cases\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-28T09:52:24Z", "type": "commit"}, {"oid": "7a905eec32cdafbea6730b94b1d2b57b93da6252", "url": "https://github.com/pravega/pravega/commit/7a905eec32cdafbea6730b94b1d2b57b93da6252", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-10-29T11:06:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA0ODA4OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516048088", "bodyText": "output supports formatted text. Please use that api.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:24:40Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -50,7 +61,39 @@ protected Context createContext() {\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If tls parameters are configured, set them in client\n+        if (getCLIControllerConfig().isTlsEnabled()) {\n+            KeyStore ks = null;\n+            InputStream trustStore = null;\n+            try {\n+                trustStore = new FileInputStream(new File(getCLIControllerConfig().getTruststore()));\n+                ks = KeyStore.getInstance(\"JKS\");\n+                ks.load(trustStore, null);\n+                trustStore.close();\n+\n+            } catch (KeyStoreException e) {\n+                output(\"The keystore file is invalid, the keystore type is not supported: \" + e.toString());", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTcyNA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121724", "bodyText": "Used the api for formatted text.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA0ODA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA0OTIzOA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516049238", "bodyText": "I suggest using try-with-resources or annotating with with @Cleanup to ensure this is closed. If you get an error between here and line 75, your input stream will not be closed.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:26:11Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -50,7 +61,39 @@ protected Context createContext() {\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If tls parameters are configured, set them in client\n+        if (getCLIControllerConfig().isTlsEnabled()) {\n+            KeyStore ks = null;\n+            InputStream trustStore = null;\n+            try {\n+                trustStore = new FileInputStream(new File(getCLIControllerConfig().getTruststore()));", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTc2NA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121764", "bodyText": "Used @Cleanup on the InputStream as suggested.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA0OTIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MDA5OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516050098", "bodyText": "Use TestUtils to get randomized ports. Hardcoding ports in unit tests is a recipe for failure due to ports already being used.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:27:25Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/AbstractTlsAdminCommandTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin;\n+\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsAdminCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    protected static final AtomicReference<AdminCommandState> STATE = new AtomicReference<>();\n+\n+    private static final Integer CONTROLLER_PORT = 9090;", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTc3NQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121775", "bodyText": "Used TestUtils for randomized ports.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MDA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MDQ3MQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516050471", "bodyText": "Any reason why these shouldn't be static or final?", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:27:54Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/AbstractTlsAdminCommandTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin;\n+\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsAdminCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    protected static final AtomicReference<AdminCommandState> STATE = new AtomicReference<>();\n+\n+    private static final Integer CONTROLLER_PORT = 9090;\n+    private static final Integer SEGMENT_STORE_PORT = 6000;\n+    private static final Integer REST_SERVER_PORT = 9091;\n+\n+    @Rule\n+    public final Timeout globalTimeout = new Timeout(80, TimeUnit.SECONDS);\n+\n+    protected boolean authEnabled = false;", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTc4MQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121781", "bodyText": "@Rule requires the variable to be final only and not static. The variables authEnabled and tlsEnabled cannot be final as these flags are set before calling super.setUp() in the test classes based on whether we test with authentication or TLS enabled or both.\nAlso static non final variables cannot be declared according to the checkstyle.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MDQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MTE3MQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516051171", "bodyText": "Why is this static?\nDo not use static fields that you set during your execution. This will prevent us from eventually running tests in parallel.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:28:50Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/AbstractTlsAdminCommandTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin;\n+\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsAdminCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    protected static final AtomicReference<AdminCommandState> STATE = new AtomicReference<>();", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTc5Mg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121792", "bodyText": "I've made this field non-static as suggested.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MTE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MTY4Mw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516051683", "bodyText": "Do not do this. Find a different way to figure out when the server has started.\n20 seconds may be too long in most cases and may not be sufficient if Travis is super-slow when your test executes.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:29:28Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/AbstractTlsAdminCommandTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin;\n+\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsAdminCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    protected static final AtomicReference<AdminCommandState> STATE = new AtomicReference<>();\n+\n+    private static final Integer CONTROLLER_PORT = 9090;\n+    private static final Integer SEGMENT_STORE_PORT = 6000;\n+    private static final Integer REST_SERVER_PORT = 9091;\n+\n+    @Rule\n+    public final Timeout globalTimeout = new Timeout(80, TimeUnit.SECONDS);\n+\n+    protected boolean authEnabled = false;\n+    protected boolean tlsEnabled = false;\n+    LocalPravegaEmulator localPravega;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+\n+        // Create the secure pravega server to test commands against.\n+        LocalPravegaEmulator.LocalPravegaEmulatorBuilder emulatorBuilder = LocalPravegaEmulator.builder()\n+                .controllerPort(CONTROLLER_PORT)\n+                .segmentStorePort(SEGMENT_STORE_PORT)\n+                .zkPort(io.pravega.test.common.TestUtils.getAvailableListenPort())\n+                .restServerPort(io.pravega.test.common.TestUtils.getAvailableListenPort())\n+                .enableRestServer(true)\n+                .restServerPort(REST_SERVER_PORT)\n+                .enableAuth(authEnabled)\n+                .enableTls(tlsEnabled);\n+\n+        // Since the server is being built right here, avoiding delegating these conditions to subclasses via factory\n+        // methods. This is so that it is easy to see the difference in server configs all in one place. This is also\n+        // unlike the ClientConfig preparation which is being delegated to factory methods to make their preparation\n+        // explicit in the respective test classes.\n+\n+        if (authEnabled) {\n+            emulatorBuilder.passwdFile(\"../../config/\" + SecurityConfigDefaults.AUTH_HANDLER_INPUT_FILE_NAME)\n+                    .userName(SecurityConfigDefaults.AUTH_ADMIN_USERNAME)\n+                    .passwd(SecurityConfigDefaults.AUTH_ADMIN_PASSWORD);\n+        }\n+\n+        if (tlsEnabled) {\n+            emulatorBuilder.certFile(\"../../config/\" + SecurityConfigDefaults.TLS_SERVER_CERT_FILE_NAME)\n+                    .keyFile(\"../../config/\" + SecurityConfigDefaults.TLS_SERVER_PRIVATE_KEY_FILE_NAME)\n+                    .jksKeyFile(\"../../config/\" + SecurityConfigDefaults.TLS_SERVER_KEYSTORE_NAME)\n+                    .jksTrustFile(\"../../config/\" + SecurityConfigDefaults.TLS_CLIENT_TRUSTSTORE_NAME)\n+                    .keyPasswordFile(\"../../config/\" + SecurityConfigDefaults.TLS_PASSWORD_FILE_NAME);\n+        }\n+\n+        localPravega = emulatorBuilder.build();\n+\n+        // The uri returned by LocalPravegaEmulator is in the form tcp://localhost:9090 (protocol + domain + port)\n+        // but for the CLI we need to set the GRPC uri as localhost:9090 (domain + port). Because the protocol\n+        // is decided based on whether security is enabled or not.\n+\n+        // Set the CLI properties.\n+        STATE.set(new AdminCommandState());\n+        Properties pravegaProperties = new Properties();\n+        pravegaProperties.setProperty(\"cli.controller.rest.uri\", \"localhost:\" + REST_SERVER_PORT.toString());\n+        pravegaProperties.setProperty(\"cli.controller.grpc.uri\", \"localhost:\" + CONTROLLER_PORT.toString());\n+        pravegaProperties.setProperty(\"pravegaservice.zk.connect.uri\", localPravega.getInProcPravegaCluster().getZkUrl());\n+        pravegaProperties.setProperty(\"pravegaservice.container.count\", \"4\");\n+        pravegaProperties.setProperty(\"cli.security.auth.enable\", Boolean.toString(authEnabled));\n+        pravegaProperties.setProperty(\"cli.security.auth.credentials.username\", SecurityConfigDefaults.AUTH_ADMIN_USERNAME);\n+        pravegaProperties.setProperty(\"cli.security.auth.credentials.password\", SecurityConfigDefaults.AUTH_ADMIN_PASSWORD);\n+        pravegaProperties.setProperty(\"cli.security.tls.enable\", Boolean.toString(tlsEnabled));\n+        pravegaProperties.setProperty(\"cli.security.tls.trustStore.location\", \"../../config/\" + SecurityConfigDefaults.TLS_CLIENT_TRUSTSTORE_NAME);\n+\n+        STATE.get().getConfigBuilder().include(pravegaProperties);\n+\n+        localPravega.start();\n+\n+        // Wait for the server to complete start-up.\n+        TimeUnit.SECONDS.sleep(20);", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTg3Nw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121877", "bodyText": "Will try to look for a better way to identify if the server has started.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMjQwMw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529812403", "bodyText": "This has been removed.", "author": "anirudhkovuru", "createdAt": "2020-11-24T19:04:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MTY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MjYwNg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516052606", "bodyText": "Please be consistent in how you reference UTF8. Here you use StandardCharset, yet 4 lines above you use a string.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:30:44Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/controller/AuthEnabledControllerCommandsTest.java", "diffHunk": "@@ -0,0 +1,252 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.controller;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.cli.admin.AbstractAdminCommandTest;\n+import io.pravega.cli.admin.AdminCommandState;\n+import io.pravega.cli.admin.CommandArgs;\n+import io.pravega.cli.admin.Parser;\n+import io.pravega.cli.admin.utils.CLIControllerConfig;\n+import io.pravega.cli.admin.utils.TestUtils;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.connection.impl.ConnectionPool;\n+import io.pravega.client.connection.impl.ConnectionPoolImpl;\n+import io.pravega.client.connection.impl.SocketConnectionFactoryImpl;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.Exceptions;\n+import io.pravega.common.cluster.Host;\n+import io.pravega.controller.server.SegmentHelper;\n+import io.pravega.controller.store.client.StoreClientFactory;\n+import io.pravega.controller.store.host.HostControllerStore;\n+import io.pravega.controller.store.host.HostMonitorConfig;\n+import io.pravega.controller.store.host.HostStoreFactory;\n+import io.pravega.controller.store.host.impl.HostMonitorConfigImpl;\n+import io.pravega.controller.util.Config;\n+import lombok.Cleanup;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.retry.RetryOneTime;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import javax.ws.rs.core.Response;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URI;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class AuthEnabledControllerCommandsTest extends AbstractAdminCommandTest {\n+\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        SETUP_UTILS.setAuthEnabled(true);\n+        super.setUp();\n+    }\n+\n+\n+    @Test\n+    public void testListScopesCommand() throws Exception {\n+        SETUP_UTILS.createTestStream(\"testListScopesCommand\", 2);\n+        String commandResult = TestUtils.executeCommand(\"controller list-scopes\", STATE.get());\n+        // Check that both the new scope and the system one exist.\n+        Assert.assertTrue(commandResult.contains(\"_system\"));\n+        Assert.assertTrue(commandResult.contains(SETUP_UTILS.getScope()));\n+        Assert.assertNotNull(ControllerListScopesCommand.descriptor());\n+    }\n+\n+    @Test\n+    public void testDescribeScopeCommand() throws Exception {\n+        String commandResult = TestUtils.executeCommand(\"controller describe-scope _system\", STATE.get());\n+        Assert.assertTrue(commandResult.contains(\"_system\"));\n+        Assert.assertNotNull(ControllerDescribeStreamCommand.descriptor());\n+    }\n+\n+    @Test\n+    public void testListStreamsCommand() throws Exception {\n+        String testStream = \"testListStreamsCommand\";\n+        SETUP_UTILS.createTestStream(testStream, 1);\n+        String commandResult = TestUtils.executeCommand(\"controller list-streams \" + SETUP_UTILS.getScope(), STATE.get());\n+        // Check that the newly created stream is retrieved as part of the list of streams.\n+        Assert.assertTrue(commandResult.contains(testStream));\n+        Assert.assertNotNull(ControllerListStreamsInScopeCommand.descriptor());\n+    }\n+\n+    @Test\n+    public void testListReaderGroupsCommand() throws Exception {\n+        // Check that the system reader group can be listed.\n+        String commandResult = TestUtils.executeCommand(\"controller list-readergroups _system\", STATE.get());\n+        Assert.assertTrue(commandResult.contains(\"commitStreamReaders\"));\n+        Assert.assertNotNull(ControllerListReaderGroupsInScopeCommand.descriptor());\n+    }\n+\n+    @Test\n+    public void testDescribeReaderGroupCommand() throws Exception {\n+        // Check that the system reader group can be listed.\n+        String commandResult = TestUtils.executeCommand(\"controller describe-readergroup _system commitStreamReaders\", STATE.get());\n+        Assert.assertTrue(commandResult.contains(\"commitStreamReaders\"));\n+        Assert.assertNotNull(ControllerDescribeReaderGroupCommand.descriptor());\n+    }\n+\n+    @Test\n+    public void testDescribeStreamCommand() throws Exception {\n+        String scope = \"testScope\";\n+        String testStream = \"testStream\";\n+        ClientConfig clientConfig = SETUP_UTILS.generateValidClientConfig();\n+\n+        // Generate the scope and stream required for testing.\n+        @Cleanup\n+        StreamManager streamManager = StreamManager.create(clientConfig);\n+        Assert.assertNotNull(streamManager);\n+\n+        boolean isScopeCreated = streamManager.createScope(scope);\n+\n+        // Check if scope created successfully.\n+        Assert.assertTrue(\"Failed to create scope\", isScopeCreated);\n+\n+        boolean isStreamCreated = streamManager.createStream(scope, testStream, StreamConfiguration.builder()\n+                .scalingPolicy(ScalingPolicy.fixed(1))\n+                .build());\n+\n+        // Check if stream created successfully.\n+        Assert.assertTrue(\"Failed to create the stream \", isStreamCreated);\n+\n+        String commandResult = executeCommand(\"controller describe-stream \" + scope + \" \" + testStream, STATE.get());\n+        Assert.assertTrue(commandResult.contains(\"stream_config\"));\n+        Assert.assertTrue(commandResult.contains(\"stream_state\"));\n+        Assert.assertTrue(commandResult.contains(\"segment_count\"));\n+        Assert.assertTrue(commandResult.contains(\"is_sealed\"));\n+        Assert.assertTrue(commandResult.contains(\"active_epoch\"));\n+        Assert.assertTrue(commandResult.contains(\"truncation_record\"));\n+        Assert.assertTrue(commandResult.contains(\"scaling_info\"));\n+\n+        // Exercise actual instantiateSegmentHelper\n+        CommandArgs commandArgs = new CommandArgs(Arrays.asList(scope, testStream), STATE.get());\n+        ControllerDescribeStreamCommand command = new ControllerDescribeStreamCommand(commandArgs);\n+        @Cleanup\n+        CuratorFramework curatorFramework = CuratorFrameworkFactory.newClient(SETUP_UTILS.getZkTestServer().getConnectString(),\n+                new RetryOneTime(5000));\n+        curatorFramework.start();\n+        Assert.assertNotNull(command.instantiateSegmentHelper(curatorFramework));\n+\n+        // Try the Zookeeper backend, which is expected to fail and be handled by the command.\n+        Properties properties = new Properties();\n+        properties.setProperty(\"cli.store.metadata.backend\", CLIControllerConfig.MetadataBackends.ZOOKEEPER.name());\n+        STATE.get().getConfigBuilder().include(properties);\n+        commandArgs = new CommandArgs(Arrays.asList(scope, testStream), STATE.get());\n+        new ControllerDescribeStreamCommand(commandArgs).execute();\n+        properties.setProperty(\"cli.store.metadata.backend\", CLIControllerConfig.MetadataBackends.SEGMENTSTORE.name());\n+        STATE.get().getConfigBuilder().include(properties);\n+    }\n+\n+    @Test\n+    public void testAuthConfig() throws Exception {\n+        SETUP_UTILS.createTestStream(\"testListScopesCommand\", 2);\n+        Properties pravegaProperties = new Properties();\n+        pravegaProperties.setProperty(\"cli.security.auth.enable\", \"true\");\n+        pravegaProperties.setProperty(\"cli.security.auth.credentials.username\", \"admin\");\n+        pravegaProperties.setProperty(\"cli.security.auth.credentials.password\", \"1111_aaaa\");\n+        STATE.get().getConfigBuilder().include(pravegaProperties);\n+        String commandResult = TestUtils.executeCommand(\"controller list-scopes\", STATE.get());\n+        // Check that both the new scope and the system one exist.\n+        Assert.assertTrue(commandResult.contains(\"_system\"));\n+        Assert.assertTrue(commandResult.contains(SETUP_UTILS.getScope()));\n+        Assert.assertNotNull(ControllerListScopesCommand.descriptor());\n+        // Restore config\n+        pravegaProperties.setProperty(\"cli.security.auth.enable\", \"false\");\n+        STATE.get().getConfigBuilder().include(pravegaProperties);\n+\n+        // Exercise response codes for REST requests.\n+        CommandArgs commandArgs = new CommandArgs(Collections.emptyList(), new AdminCommandState());\n+        ControllerListScopesCommand command = new ControllerListScopesCommand(commandArgs);\n+        command.printResponseInfo(Response.status(Response.Status.UNAUTHORIZED).build());\n+        command.printResponseInfo(Response.status(Response.Status.INTERNAL_SERVER_ERROR).build());\n+    }\n+\n+    static String executeCommand(String inputCommand, AdminCommandState state) throws Exception {\n+        Parser.Command pc = Parser.parse(inputCommand);\n+        Assert.assertNotNull(pc.toString());\n+        CommandArgs args = new CommandArgs(pc.getArgs(), state);\n+        final ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        TestingDescribeStreamCommand cmd = new TestingDescribeStreamCommand(args);\n+        try (PrintStream ps = new PrintStream(baos, true, \"UTF-8\")) {\n+            cmd.setOut(ps);\n+            cmd.execute();\n+        }\n+        return new String(baos.toByteArray(), StandardCharsets.UTF_8);", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTkwOQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121909", "bodyText": "The references are consistent now.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1MjYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1Mzg4NA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516053884", "bodyText": "randomize", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:32:30Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractTlsUserCommandTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.user;\n+\n+import io.pravega.cli.user.config.InteractiveConfig;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsUserCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    protected static final AtomicReference<InteractiveConfig> CONFIG = new AtomicReference<>();\n+\n+    private static final Integer CONTROLLER_PORT = 9090;", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTkyMg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121922", "bodyText": "done", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1Mzg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NDA0MQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516054041", "bodyText": "same comment about static shared variables.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:32:43Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractTlsUserCommandTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.user;\n+\n+import io.pravega.cli.user.config.InteractiveConfig;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsUserCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    protected static final AtomicReference<InteractiveConfig> CONFIG = new AtomicReference<>();", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMTk2MQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517121961", "bodyText": "made non-static", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NDA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NDEzNw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516054137", "bodyText": "final", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:32:50Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractTlsUserCommandTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.user;\n+\n+import io.pravega.cli.user.config.InteractiveConfig;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsUserCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    protected static final AtomicReference<InteractiveConfig> CONFIG = new AtomicReference<>();\n+\n+    private static final Integer CONTROLLER_PORT = 9090;\n+    private static final Integer SEGMENT_STORE_PORT = 6000;\n+    private static final Integer REST_SERVER_PORT = 9091;\n+\n+    @Rule\n+    public final Timeout globalTimeout = new Timeout(120, TimeUnit.SECONDS);\n+\n+    protected boolean authEnabled = false;", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMjAyNQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517122025", "bodyText": "authEnabled and tlsEnabled cannot be final as they will be changed according to the tests in which they are used. Explained above", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NDEzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NDI1NA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516054254", "bodyText": "No sleeping please.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:33:02Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractTlsUserCommandTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.user;\n+\n+import io.pravega.cli.user.config.InteractiveConfig;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsUserCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    protected static final AtomicReference<InteractiveConfig> CONFIG = new AtomicReference<>();\n+\n+    private static final Integer CONTROLLER_PORT = 9090;\n+    private static final Integer SEGMENT_STORE_PORT = 6000;\n+    private static final Integer REST_SERVER_PORT = 9091;\n+\n+    @Rule\n+    public final Timeout globalTimeout = new Timeout(120, TimeUnit.SECONDS);\n+\n+    protected boolean authEnabled = false;\n+    protected boolean tlsEnabled = false;\n+    LocalPravegaEmulator localPravega;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+\n+        // Create the secure pravega server to test commands against.\n+        LocalPravegaEmulator.LocalPravegaEmulatorBuilder emulatorBuilder = LocalPravegaEmulator.builder()\n+                .controllerPort(CONTROLLER_PORT)\n+                .segmentStorePort(SEGMENT_STORE_PORT)\n+                .zkPort(io.pravega.test.common.TestUtils.getAvailableListenPort())\n+                .restServerPort(io.pravega.test.common.TestUtils.getAvailableListenPort())\n+                .enableRestServer(true)\n+                .restServerPort(REST_SERVER_PORT)\n+                .enableAuth(authEnabled)\n+                .enableTls(tlsEnabled);\n+\n+        // Since the server is being built right here, avoiding delegating these conditions to subclasses via factory\n+        // methods. This is so that it is easy to see the difference in server configs all in one place. This is also\n+        // unlike the ClientConfig preparation which is being delegated to factory methods to make their preparation\n+        // explicit in the respective test classes.\n+\n+        if (authEnabled) {\n+            emulatorBuilder.passwdFile(\"../../config/\" + SecurityConfigDefaults.AUTH_HANDLER_INPUT_FILE_NAME)\n+                    .userName(SecurityConfigDefaults.AUTH_ADMIN_USERNAME)\n+                    .passwd(SecurityConfigDefaults.AUTH_ADMIN_PASSWORD);\n+        }\n+\n+        if (tlsEnabled) {\n+            emulatorBuilder.certFile(\"../../config/\" + SecurityConfigDefaults.TLS_SERVER_CERT_FILE_NAME)\n+                    .keyFile(\"../../config/\" + SecurityConfigDefaults.TLS_SERVER_PRIVATE_KEY_FILE_NAME)\n+                    .jksKeyFile(\"../../config/\" + SecurityConfigDefaults.TLS_SERVER_KEYSTORE_NAME)\n+                    .jksTrustFile(\"../../config/\" + SecurityConfigDefaults.TLS_CLIENT_TRUSTSTORE_NAME)\n+                    .keyPasswordFile(\"../../config/\" + SecurityConfigDefaults.TLS_PASSWORD_FILE_NAME);\n+        }\n+\n+        localPravega = emulatorBuilder.build();\n+        localPravega.start();\n+\n+        // Wait for the server to complete start-up.\n+        TimeUnit.SECONDS.sleep(20);", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMjA1Ng==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517122056", "bodyText": "Will look for another way.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NDI1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMjcwNw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529812707", "bodyText": "Removed this.", "author": "anirudhkovuru", "createdAt": "2020-11-24T19:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NDI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NzUwOQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516057509", "bodyText": "Make all these fields final. Initialize them in the class constructor, and start the services only when you invoke startAllServices", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:37:19Z", "path": "test/integration/src/main/java/io/pravega/test/integration/utils/SecureSetupUtils.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.test.integration.utils;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.EventStreamClientFactory;\n+import io.pravega.client.admin.ReaderGroupManager;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.control.impl.Controller;\n+import io.pravega.client.control.impl.ControllerImpl;\n+import io.pravega.client.control.impl.ControllerImplConfig;\n+import io.pravega.client.stream.EventStreamReader;\n+import io.pravega.client.stream.EventStreamWriter;\n+import io.pravega.client.stream.EventWriterConfig;\n+import io.pravega.client.stream.ReaderConfig;\n+import io.pravega.client.stream.ReaderGroupConfig;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.Stream;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.ClientFactoryImpl;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.concurrent.ExecutorServiceHelpers;\n+import io.pravega.controller.util.Config;\n+import io.pravega.segmentstore.contracts.StreamSegmentStore;\n+import io.pravega.segmentstore.server.host.delegationtoken.PassingTokenVerifier;\n+import io.pravega.segmentstore.server.host.handler.PravegaConnectionListener;\n+import io.pravega.segmentstore.server.host.stat.SegmentStatsRecorder;\n+import io.pravega.segmentstore.server.host.stat.TableSegmentStatsRecorder;\n+import io.pravega.segmentstore.server.store.ServiceBuilder;\n+import io.pravega.segmentstore.server.store.ServiceBuilderConfig;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import io.pravega.test.common.TestingServerStarter;\n+import io.pravega.test.integration.demo.ControllerWrapper;\n+import lombok.Cleanup;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.curator.test.TestingServer;\n+\n+import javax.annotation.concurrent.NotThreadSafe;\n+import java.net.URI;\n+import java.util.UUID;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Utility functions for creating the test setup.\n+ */\n+@Slf4j\n+@NotThreadSafe\n+public final class SecureSetupUtils {\n+\n+    // The different services.\n+    @Getter", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NzkwMA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516057900", "bodyText": "Also make this class implement AutoCloseable and in the close method make sure you shut down and close all these services. Otherwise you risk leaving them running in the background when your test is done.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NzUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMjA5MA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517122090", "bodyText": "The class implements AutoCloseable and the close method. Will look into making the fields final.", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NzUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1MTAzMw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529651033", "bodyText": "Ping! Please make the fields final. If you only set them in the constructor, then final is how they should be.", "author": "andreipaduroiu", "createdAt": "2020-11-24T15:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NzUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3NTEzNw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r530375137", "bodyText": "I've made all these fields final as suggested.", "author": "anirudhkovuru", "createdAt": "2020-11-25T13:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NzUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1ODU2OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r516058568", "bodyText": "You never shut this down. You need to keep a pointer to it and close it in your close method.", "author": "andreipaduroiu", "createdAt": "2020-11-02T15:38:53Z", "path": "test/integration/src/main/java/io/pravega/test/integration/utils/SecureSetupUtils.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.test.integration.utils;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.EventStreamClientFactory;\n+import io.pravega.client.admin.ReaderGroupManager;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.control.impl.Controller;\n+import io.pravega.client.control.impl.ControllerImpl;\n+import io.pravega.client.control.impl.ControllerImplConfig;\n+import io.pravega.client.stream.EventStreamReader;\n+import io.pravega.client.stream.EventStreamWriter;\n+import io.pravega.client.stream.EventWriterConfig;\n+import io.pravega.client.stream.ReaderConfig;\n+import io.pravega.client.stream.ReaderGroupConfig;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.Stream;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.ClientFactoryImpl;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.concurrent.ExecutorServiceHelpers;\n+import io.pravega.controller.util.Config;\n+import io.pravega.segmentstore.contracts.StreamSegmentStore;\n+import io.pravega.segmentstore.server.host.delegationtoken.PassingTokenVerifier;\n+import io.pravega.segmentstore.server.host.handler.PravegaConnectionListener;\n+import io.pravega.segmentstore.server.host.stat.SegmentStatsRecorder;\n+import io.pravega.segmentstore.server.host.stat.TableSegmentStatsRecorder;\n+import io.pravega.segmentstore.server.store.ServiceBuilder;\n+import io.pravega.segmentstore.server.store.ServiceBuilderConfig;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import io.pravega.test.common.TestingServerStarter;\n+import io.pravega.test.integration.demo.ControllerWrapper;\n+import lombok.Cleanup;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.curator.test.TestingServer;\n+\n+import javax.annotation.concurrent.NotThreadSafe;\n+import java.net.URI;\n+import java.util.UUID;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Utility functions for creating the test setup.\n+ */\n+@Slf4j\n+@NotThreadSafe\n+public final class SecureSetupUtils {\n+\n+    // The different services.\n+    @Getter\n+    private ScheduledExecutorService executor = null;\n+    @Getter\n+    private Controller controller = null;\n+    @Getter\n+    private EventStreamClientFactory clientFactory = null;\n+    private ControllerWrapper controllerWrapper = null;\n+    private PravegaConnectionListener server = null;\n+    @Getter\n+    private TestingServer zkTestServer = null;\n+\n+    @Getter\n+    @Setter\n+    private boolean authEnabled = false;\n+    @Getter\n+    @Setter\n+    private boolean tlsEnabled = false;\n+\n+    // Manage the state of the class.\n+    private final AtomicBoolean started = new AtomicBoolean(false);\n+\n+    // The test Scope name.\n+    @Getter\n+    private final String scope = \"scope\";\n+    private final int controllerRPCPort = TestUtils.getAvailableListenPort();\n+    private final int controllerRESTPort = TestUtils.getAvailableListenPort();\n+    @Getter\n+    private final int servicePort = TestUtils.getAvailableListenPort();\n+    private ClientConfig clientConfig = null;\n+\n+    public ClientConfig generateValidClientConfig() {\n+        ClientConfig.ClientConfigBuilder clientConfigBuilder = ClientConfig.builder()\n+                .controllerURI(URI.create((this.tlsEnabled ? \"tls\" : \"tcp\") + \"://localhost:\" + controllerRPCPort));\n+        if (this.authEnabled) {\n+            clientConfigBuilder.credentials(new DefaultCredentials(SecurityConfigDefaults.AUTH_ADMIN_PASSWORD,\n+                    SecurityConfigDefaults.AUTH_ADMIN_USERNAME));\n+        }\n+        if (this.tlsEnabled) {\n+            clientConfigBuilder.trustStore(\"../\" + SecurityConfigDefaults.TLS_CA_CERT_PATH)\n+                    .validateHostName(false);\n+        }\n+        return clientConfigBuilder.build();\n+    }\n+\n+    /**\n+     * Start all pravega related services required for the test deployment.\n+     *\n+     * @throws Exception on any errors.\n+     */\n+    public void startAllServices() throws Exception {\n+        startAllServices(null);\n+    }\n+\n+    /**\n+     * Start all pravega related services required for the test deployment.\n+     *\n+     * @param numThreads the number of threads for the internal client threadpool.\n+     * @throws Exception on any errors.\n+     */\n+    public void startAllServices(Integer numThreads) throws Exception {\n+        if (!this.started.compareAndSet(false, true)) {\n+            log.warn(\"Services already started, not attempting to start again\");\n+            return;\n+        }\n+        this.clientConfig = generateValidClientConfig();\n+        this.executor = ExecutorServiceHelpers.newScheduledThreadPool(2, \"Controller pool\");\n+        this.controller = new ControllerImpl(ControllerImplConfig.builder().clientConfig(clientConfig).build(),\n+                executor);\n+        this.clientFactory = new ClientFactoryImpl(scope, controller, clientConfig);\n+\n+        // Start zookeeper.\n+        this.zkTestServer = new TestingServerStarter().start();\n+        this.zkTestServer.start();\n+\n+        // Start Pravega Service.\n+        ServiceBuilder serviceBuilder = ServiceBuilder.newInMemoryBuilder(ServiceBuilderConfig.getDefaultConfig());", "originalCommit": "64aefb5947586ab85025715fe60484460c955c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyMjEyOA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r517122128", "bodyText": "I've added this as a field and close it in the close method", "author": "anirudhkovuru", "createdAt": "2020-11-04T06:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1ODU2OA=="}], "type": "inlineReview"}, {"oid": "875c102dbb9cb9baea6c7d8d048701881a286fce", "url": "https://github.com/pravega/pravega/commit/875c102dbb9cb9baea6c7d8d048701881a286fce", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-11-03T14:03:33Z", "type": "commit"}, {"oid": "d7b9bf29f0f9dc103b46d87cf6c13fa1c2627bfa", "url": "https://github.com/pravega/pravega/commit/d7b9bf29f0f9dc103b46d87cf6c13fa1c2627bfa", "message": "Addressing review comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-04T06:30:02Z", "type": "commit"}, {"oid": "d7b9bf29f0f9dc103b46d87cf6c13fa1c2627bfa", "url": "https://github.com/pravega/pravega/commit/d7b9bf29f0f9dc103b46d87cf6c13fa1c2627bfa", "message": "Addressing review comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-04T06:30:02Z", "type": "forcePushed"}, {"oid": "1bc054938cddacae143f99ff4304be09819da0b8", "url": "https://github.com/pravega/pravega/commit/1bc054938cddacae143f99ff4304be09819da0b8", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-11-09T05:52:43Z", "type": "commit"}, {"oid": "a1984f8f1f9e618e89b63ebb0fc4005d2301f30e", "url": "https://github.com/pravega/pravega/commit/a1984f8f1f9e618e89b63ebb0fc4005d2301f30e", "message": "Tweaked tests, following comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-09T13:30:31Z", "type": "commit"}, {"oid": "e330f208f2318ab2851e851bcc6f209d23567367", "url": "https://github.com/pravega/pravega/commit/e330f208f2318ab2851e851bcc6f209d23567367", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-11-17T11:04:21Z", "type": "commit"}, {"oid": "255984479ccaf137ea3f87cc7ae765ed291f7169", "url": "https://github.com/pravega/pravega/commit/255984479ccaf137ea3f87cc7ae765ed291f7169", "message": "Made changes to TLS and secure tests for admin and user\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-18T05:31:54Z", "type": "commit"}, {"oid": "9b5020ed6bdad79fd9a0d3e3ad938309d39be385", "url": "https://github.com/pravega/pravega/commit/9b5020ed6bdad79fd9a0d3e3ad938309d39be385", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-11-24T06:39:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0NzQ0Nw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529647447", "bodyText": "Do not make these static. Keeping state (available ports is a form of state) in static variables prevents these tests from being run in parallel.", "author": "andreipaduroiu", "createdAt": "2020-11-24T15:36:54Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/AbstractTlsAdminCommandTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin;\n+\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsAdminCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    private static final Integer CONTROLLER_PORT = TestUtils.getAvailableListenPort();", "originalCommit": "9deb600cfe23a0c1c8f0634ad0dd033f140bfa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODU5OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529798598", "bodyText": "Made these non static.", "author": "anirudhkovuru", "createdAt": "2020-11-24T18:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0NzQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1MTkzOA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529651938", "bodyText": "Same here. Do not make this thing static.", "author": "andreipaduroiu", "createdAt": "2020-11-24T15:40:03Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/AbstractAdminCommandTest.java", "diffHunk": "@@ -22,28 +23,34 @@\n public abstract class AbstractAdminCommandTest {\n \n     // Setup utility.\n-    protected static final SetupUtils SETUP_UTILS = new SetupUtils();\n-    protected static final AtomicReference<AdminCommandState> STATE = new AtomicReference<>();\n+    protected static final SecureSetupUtils SETUP_UTILS = new SecureSetupUtils();", "originalCommit": "9deb600cfe23a0c1c8f0634ad0dd033f140bfa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODU3Ng==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529798576", "bodyText": "Made it non static.", "author": "anirudhkovuru", "createdAt": "2020-11-24T18:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1MTkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1NDUwNA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529654504", "bodyText": "not static", "author": "andreipaduroiu", "createdAt": "2020-11-24T15:41:47Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractTlsUserCommandTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.user;\n+\n+import io.pravega.cli.user.config.InteractiveConfig;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsUserCommandTest {\n+\n+    // Security related flags and instantiate local pravega server.\n+    private static final Integer CONTROLLER_PORT = TestUtils.getAvailableListenPort();", "originalCommit": "9deb600cfe23a0c1c8f0634ad0dd033f140bfa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODU1NA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529798554", "bodyText": "same", "author": "anirudhkovuru", "createdAt": "2020-11-24T18:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1NDUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1NTMyMQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529655321", "bodyText": "not static", "author": "andreipaduroiu", "createdAt": "2020-11-24T15:42:19Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractUserCommandTest.java", "diffHunk": "@@ -22,26 +23,32 @@\n public abstract class AbstractUserCommandTest {\n \n     // Setup utility.\n-    protected static final SetupUtils SETUP_UTILS = new SetupUtils();\n-    protected static final AtomicReference<InteractiveConfig> CONFIG = new AtomicReference<>();\n+    protected static final SecureSetupUtils SETUP_UTILS = new SecureSetupUtils();", "originalCommit": "9deb600cfe23a0c1c8f0634ad0dd033f140bfa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODUzNg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529798536", "bodyText": "same", "author": "anirudhkovuru", "createdAt": "2020-11-24T18:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1NTMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1ODU0NA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529658544", "bodyText": "This is the wrong way to shut down an executor. Use ExecutorServiceHelpers.shutdown(...)", "author": "andreipaduroiu", "createdAt": "2020-11-24T15:44:36Z", "path": "test/integration/src/main/java/io/pravega/test/integration/utils/SecureSetupUtils.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.test.integration.utils;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.EventStreamClientFactory;\n+import io.pravega.client.admin.ReaderGroupManager;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.control.impl.Controller;\n+import io.pravega.client.control.impl.ControllerImpl;\n+import io.pravega.client.control.impl.ControllerImplConfig;\n+import io.pravega.client.stream.EventStreamReader;\n+import io.pravega.client.stream.EventStreamWriter;\n+import io.pravega.client.stream.EventWriterConfig;\n+import io.pravega.client.stream.ReaderConfig;\n+import io.pravega.client.stream.ReaderGroupConfig;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.Stream;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.ClientFactoryImpl;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.concurrent.ExecutorServiceHelpers;\n+import io.pravega.controller.util.Config;\n+import io.pravega.segmentstore.contracts.StreamSegmentStore;\n+import io.pravega.segmentstore.server.host.delegationtoken.PassingTokenVerifier;\n+import io.pravega.segmentstore.server.host.handler.PravegaConnectionListener;\n+import io.pravega.segmentstore.server.host.stat.SegmentStatsRecorder;\n+import io.pravega.segmentstore.server.host.stat.TableSegmentStatsRecorder;\n+import io.pravega.segmentstore.server.store.ServiceBuilder;\n+import io.pravega.segmentstore.server.store.ServiceBuilderConfig;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import io.pravega.test.common.TestingServerStarter;\n+import io.pravega.test.integration.demo.ControllerWrapper;\n+import lombok.Cleanup;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.curator.test.TestingServer;\n+\n+import javax.annotation.concurrent.NotThreadSafe;\n+import java.net.URI;\n+import java.util.UUID;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Utility functions for creating the test setup.\n+ */\n+@Slf4j\n+@NotThreadSafe\n+public final class SecureSetupUtils implements AutoCloseable {\n+\n+    // The different services.\n+    @Getter\n+    private ScheduledExecutorService executor = null;\n+    @Getter\n+    private Controller controller = null;\n+    @Getter\n+    private EventStreamClientFactory clientFactory = null;\n+    private ControllerWrapper controllerWrapper = null;\n+    private PravegaConnectionListener server = null;\n+    @Getter\n+    private TestingServer zkTestServer = null;\n+    private ServiceBuilder serviceBuilder = null;\n+\n+    @Getter\n+    @Setter\n+    private boolean authEnabled = false;\n+\n+    // Manage the state of the class.\n+    private final AtomicBoolean started = new AtomicBoolean(false);\n+\n+    // The test Scope name.\n+    @Getter\n+    private final String scope = \"scope\";\n+    private final int controllerRPCPort = TestUtils.getAvailableListenPort();\n+    private final int controllerRESTPort = TestUtils.getAvailableListenPort();\n+    @Getter\n+    private final int servicePort = TestUtils.getAvailableListenPort();\n+    private ClientConfig clientConfig = null;\n+\n+    public ClientConfig generateValidClientConfig() {\n+        ClientConfig.ClientConfigBuilder clientConfigBuilder = ClientConfig.builder()\n+                .controllerURI(URI.create(\"tcp://localhost:\" + controllerRPCPort));\n+        if (this.authEnabled) {\n+            clientConfigBuilder.credentials(new DefaultCredentials(SecurityConfigDefaults.AUTH_ADMIN_PASSWORD,\n+                    SecurityConfigDefaults.AUTH_ADMIN_USERNAME));\n+        }\n+        return clientConfigBuilder.build();\n+    }\n+\n+    /**\n+     * Start all pravega related services required for the test deployment.\n+     *\n+     * @throws Exception on any errors.\n+     */\n+    public void startAllServices() throws Exception {\n+        startAllServices(null);\n+    }\n+\n+    /**\n+     * Start all pravega related services required for the test deployment.\n+     *\n+     * @param numThreads the number of threads for the internal client threadpool.\n+     * @throws Exception on any errors.\n+     */\n+    public void startAllServices(Integer numThreads) throws Exception {\n+        if (!this.started.compareAndSet(false, true)) {\n+            log.warn(\"Services already started, not attempting to start again\");\n+            return;\n+        }\n+        this.clientConfig = generateValidClientConfig();\n+        this.executor = ExecutorServiceHelpers.newScheduledThreadPool(2, \"Controller pool\");\n+        this.controller = new ControllerImpl(ControllerImplConfig.builder().clientConfig(clientConfig).build(),\n+                executor);\n+        this.clientFactory = new ClientFactoryImpl(scope, controller, clientConfig);\n+\n+        // Start zookeeper.\n+        this.zkTestServer = new TestingServerStarter().start();\n+        this.zkTestServer.start();\n+\n+        // Start Pravega Service.\n+        this.serviceBuilder = ServiceBuilder.newInMemoryBuilder(ServiceBuilderConfig.getDefaultConfig());\n+\n+        this.serviceBuilder.initialize();\n+        StreamSegmentStore store = this.serviceBuilder.createStreamSegmentService();\n+        this.server = new PravegaConnectionListener(false, servicePort, store, this.serviceBuilder.createTableStoreService(),\n+                this.serviceBuilder.getLowPriorityExecutor());\n+        this.server.startListening();\n+        log.info(\"Started Pravega Service\");\n+\n+        // Start Controller.\n+        this.controllerWrapper = new ControllerWrapper(\n+                this.zkTestServer.getConnectString(), false, true, controllerRPCPort, \"localhost\", servicePort,\n+                Config.HOST_STORE_CONTAINER_COUNT, controllerRESTPort, this.authEnabled,\n+                \"../\" + SecurityConfigDefaults.AUTH_HANDLER_INPUT_PATH, \"secret\", 600);\n+        this.controllerWrapper.awaitRunning();\n+        this.controllerWrapper.getController().createScope(scope).get();\n+        log.info(\"Initialized Pravega Controller\");\n+    }\n+\n+    /**\n+     * Stop the pravega cluster and release all resources.\n+     *\n+     * @throws Exception on any errors.\n+     */\n+    @Override\n+    public void close() throws Exception {\n+        if (!this.started.compareAndSet(true, false)) {\n+            log.warn(\"Services not yet started or already stopped, not attempting to stop\");\n+            return;\n+        }\n+\n+        this.controllerWrapper.close();\n+        this.server.close();\n+        this.zkTestServer.close();\n+        this.serviceBuilder.close();\n+        this.clientFactory.close();\n+        this.controller.close();\n+        this.executor.shutdown();", "originalCommit": "9deb600cfe23a0c1c8f0634ad0dd033f140bfa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODUyNg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r529798526", "bodyText": "Using the method mentioned above.", "author": "anirudhkovuru", "createdAt": "2020-11-24T18:41:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1ODU0NA=="}], "type": "inlineReview"}, {"oid": "0e1a34947226571a67e0ab273fede21ca06fed4f", "url": "https://github.com/pravega/pravega/commit/0e1a34947226571a67e0ab273fede21ca06fed4f", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-11-24T15:54:47Z", "type": "commit"}, {"oid": "1c42424d927ca524e53ad0291cb6958c8122f273", "url": "https://github.com/pravega/pravega/commit/1c42424d927ca524e53ad0291cb6958c8122f273", "message": "Resolving comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-24T18:38:41Z", "type": "commit"}, {"oid": "1c42424d927ca524e53ad0291cb6958c8122f273", "url": "https://github.com/pravega/pravega/commit/1c42424d927ca524e53ad0291cb6958c8122f273", "message": "Resolving comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-24T18:38:41Z", "type": "forcePushed"}, {"oid": "ac0381247eb1f17130b45a6b5707ec34c9b4eb67", "url": "https://github.com/pravega/pravega/commit/ac0381247eb1f17130b45a6b5707ec34c9b4eb67", "message": "Added TODO for secure kvt tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-25T11:55:11Z", "type": "commit"}, {"oid": "6db78188c2dc556d68bb4923de89c304e0452a8c", "url": "https://github.com/pravega/pravega/commit/6db78188c2dc556d68bb4923de89c304e0452a8c", "message": "Tried making the fields of SecureSetupUtils final\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-25T13:12:18Z", "type": "commit"}, {"oid": "fecaac6f6c54c42f3742720340066bdb1894d39b", "url": "https://github.com/pravega/pravega/commit/fecaac6f6c54c42f3742720340066bdb1894d39b", "message": "Made all fields final in SecureSetupUtils\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-25T13:29:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MTA1OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r530561058", "bodyText": "Are you going to resolve this TODO?\nWhat about the commented out code below?", "author": "andreipaduroiu", "createdAt": "2020-11-25T18:08:34Z", "path": "cli/user/src/test/java/io/pravega/cli/user/SecureUserCommandsTest.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.user;\n+\n+import io.pravega.cli.user.scope.ScopeCommand;\n+import io.pravega.cli.user.stream.StreamCommand;\n+import io.pravega.shared.NameUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class SecureUserCommandsTest extends AbstractTlsUserCommandTest {\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        tlsEnabled = true;\n+        authEnabled = true;\n+        super.setUp();\n+    }\n+\n+    @After\n+    @Override\n+    public void tearDown() throws Exception {\n+        super.tearDown();\n+    }\n+\n+    @Test\n+    public void testCommands() throws Exception {\n+        final String scope = \"SecureTestScope\";\n+        final String streamName = \"SecureTestStream\";\n+        String stream = NameUtils.getScopedStreamName(scope, streamName);\n+        final String tableName = \"SecureKvtTestTable\";\n+        final String table = NameUtils.getScopedStreamName(scope, tableName);\n+\n+        String commandResult = TestUtils.executeCommand(\"scope create \" + scope, config.get());\n+        Assert.assertTrue(\"ScopeCreateCommand failed.\", commandResult.contains(\"created successfully\"));\n+        Assert.assertNotNull(ScopeCommand.Create.descriptor());\n+\n+        // List Streams in scope when it is empty.\n+        commandResult = TestUtils.executeCommand(\"stream list \" + scope, config.get());\n+        Assert.assertFalse(\"StreamListCommand failed.\", commandResult.contains(streamName));\n+\n+        commandResult = TestUtils.executeCommand(\"stream create \" + stream, config.get());\n+        Assert.assertTrue(\"StreamCreateCommand failed.\", commandResult.contains(\"created successfully\"));\n+        Assert.assertNotNull(StreamCommand.Create.descriptor());\n+\n+        // List Streams in scope when we have one.\n+        commandResult = TestUtils.executeCommand(\"stream list \" + scope, config.get());\n+        Assert.assertTrue(\"StreamListCommand failed.\", commandResult.contains(streamName));\n+        Assert.assertNotNull(StreamCommand.List.descriptor());\n+\n+        commandResult = TestUtils.executeCommand(\"stream append \" + stream + \" 100\", config.get());\n+        Assert.assertTrue(\"StreamAppendCommand failed.\", commandResult.contains(\"Done\"));\n+        Assert.assertNotNull(StreamCommand.Append.descriptor());\n+\n+        commandResult = TestUtils.executeCommand(\"stream read \" + stream + \" true 5\", config.get());\n+        Assert.assertTrue(\"StreamReadCommand failed.\", commandResult.contains(\"Done\"));\n+\n+        commandResult = TestUtils.executeCommand(\"stream append \" + stream + \" key 100\", config.get());\n+        Assert.assertTrue(\"StreamAppendCommand failed.\", commandResult.contains(\"Done\"));\n+        commandResult = TestUtils.executeCommand(\"stream read \" + stream + \" 5\", config.get());\n+        Assert.assertTrue(\"StreamReadCommand failed.\", commandResult.contains(\"Done\"));\n+        Assert.assertNotNull(StreamCommand.Read.descriptor());\n+\n+        commandResult = TestUtils.executeCommand(\"stream delete \" + stream, config.get());\n+        Assert.assertTrue(\"StreamDeleteCommand failed.\", commandResult.contains(\"deleted successfully\"));\n+        Assert.assertNotNull(StreamCommand.Delete.descriptor());\n+\n+        // TODO: Test KVT commands in the secure scenario (auth+TLS).", "originalCommit": "fecaac6f6c54c42f3742720340066bdb1894d39b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU5MDQ2Ng==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r530590466", "bodyText": "@anirudhkovuru please, review the guidelines to add TODOs in the code: https://github.com/pravega/pravega/wiki/Contributing#todos, which requires to add a reference to the issue the TODO is related to.\n@andreipaduroiu  it looks like this test cannot work today due to a bug that ahs been found: #5374. Until the bug is fix, this test cannot work combining Auth+TLS.", "author": "RaulGracia", "createdAt": "2020-11-25T19:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MTA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkwMzYzMQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r530903631", "bodyText": "I've removed the commented code and mentioned only the issue.", "author": "anirudhkovuru", "createdAt": "2020-11-26T09:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MTA1OA=="}], "type": "inlineReview"}, {"oid": "fdb1bd82cec40a3d96dc0af437706b2703d63b41", "url": "https://github.com/pravega/pravega/commit/fdb1bd82cec40a3d96dc0af437706b2703d63b41", "message": "Tweaking tests to avoid out of memory error\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-26T07:18:09Z", "type": "commit"}, {"oid": "b7cdf30ceb1bb3feb09eefcd7c2aac0730fd6179", "url": "https://github.com/pravega/pravega/commit/b7cdf30ceb1bb3feb09eefcd7c2aac0730fd6179", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-11-26T10:08:53Z", "type": "commit"}, {"oid": "fc306721dddc649295fcd733a9a589f99849363e", "url": "https://github.com/pravega/pravega/commit/fc306721dddc649295fcd733a9a589f99849363e", "message": "Added to InteractiveConfigTest\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-27T10:19:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMTI1Nw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531511257", "bodyText": "Nit: please, use caps for TLS and finish comments with dot . (see https://github.com/pravega/pravega/wiki/Contributing#codestyle).", "author": "RaulGracia", "createdAt": "2020-11-27T10:24:34Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -50,7 +62,38 @@ protected Context createContext() {\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If tls parameters are configured, set them in client", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NzE0OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532647148", "bodyText": "done", "author": "anirudhkovuru", "createdAt": "2020-11-30T14:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMTI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMTQyMg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531511422", "bodyText": "Nit: extra line might be removed.", "author": "RaulGracia", "createdAt": "2020-11-27T10:24:54Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -50,7 +62,38 @@ protected Context createContext() {\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If tls parameters are configured, set them in client\n+        if (getCLIControllerConfig().isTlsEnabled()) {\n+            KeyStore ks = null;\n+            try {\n+                @Cleanup\n+                InputStream trustStore = new FileInputStream(new File(getCLIControllerConfig().getTruststore()));\n+                ks = KeyStore.getInstance(\"JKS\");\n+                ks.load(trustStore, null);\n+", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU0NTY1Ng==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531545656", "bodyText": "Use the utility we have to do this:\n\n  \n    \n      pravega/common/src/main/java/io/pravega/common/util/CertificateUtils.java\n    \n    \n         Line 89\n      in\n      6acd317\n    \n    \n    \n    \n\n        \n          \n           public static KeyStore createTrustStore(String certFilePath) \n        \n    \n  \n\n\nThis will help us in multiple ways:\n\nAllows us to more easily move to a different format - say from JKS to the PKCS12 format that Java uses by default now.\nAllows us to add additional functionality more easily, such as supporting password-protected truststores.", "author": "ravisharda", "createdAt": "2020-11-27T11:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMTQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzOTg3NQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532039875", "bodyText": "Using createTrustStore now.", "author": "anirudhkovuru", "createdAt": "2020-11-28T13:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMTQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMzM3OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531513378", "bodyText": "If any of the previous settings is incorrect and caught on these catch blocks, it looks like we proceed anyway creating the client, right? I suppose that the result will be a non-functional client that won't be useful for the CLI. It is an option, but just want to double check that this is the behavior we want to implement there.", "author": "RaulGracia", "createdAt": "2020-11-27T10:28:21Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -50,7 +62,38 @@ protected Context createContext() {\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If tls parameters are configured, set them in client\n+        if (getCLIControllerConfig().isTlsEnabled()) {\n+            KeyStore ks = null;\n+            try {\n+                @Cleanup\n+                InputStream trustStore = new FileInputStream(new File(getCLIControllerConfig().getTruststore()));\n+                ks = KeyStore.getInstance(\"JKS\");\n+                ks.load(trustStore, null);\n+\n+            } catch (KeyStoreException e) {\n+                output(\"The keystore file is invalid, the keystore type is not supported: %s\", e.toString());\n+            } catch (IOException e) {\n+                output(\"The keystore file is invalid, check if the file exists: %s\", e.toString());\n+            } catch (NoSuchAlgorithmException e) {\n+                output(\"The keystore file is invalid, the keystore file might be in the wrong format: %s\", e.toString());\n+            } catch (CertificateException e) {\n+                output(\"The keystore file is invalid, check if the certificates are valid: %s\", e.toString());\n+            }\n+\n+            HostnameVerifier controllerHostnameVerifier = new ControllerHostnameVerifier();", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU0NjU4NQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531546585", "bodyText": "Proceeding won't work I suppose. No? @anirudhkovuru what do you say?", "author": "ravisharda", "createdAt": "2020-11-27T11:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMzM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NzAwNA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532647004", "bodyText": "I've added a message. Printed the stack trace. I can't throw an exception as I do not want to change the method signature. Instead I return null. Is there a better way than this?", "author": "anirudhkovuru", "createdAt": "2020-11-30T14:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMzM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxNTIwNw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531515207", "bodyText": "Are these hardcoded values correct on any environment? I mean, the accessTokenTTLInSeconds may be ok (while it could be on a constant variable for clarity), but what about the tokenSigningKey?", "author": "RaulGracia", "createdAt": "2020-11-27T10:31:45Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerDescribeStreamCommand.java", "diffHunk": "@@ -72,7 +72,12 @@ public void execute() {\n                 store = StreamStoreFactory.createZKStore(zkClient, executor);\n             } else {\n                 segmentHelper = instantiateSegmentHelper(zkClient);\n-                GrpcAuthHelper authHelper = GrpcAuthHelper.getDisabledAuthHelper();\n+                GrpcAuthHelper authHelper;\n+                if (getCLIControllerConfig().isAuthEnabled()) {\n+                    authHelper = new GrpcAuthHelper(true, \"secret\", 300);", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MDExNQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532040115", "bodyText": "tokenSigningKey can be subject to change. I've added a new property in the properties file for this.", "author": "anirudhkovuru", "createdAt": "2020-11-28T13:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxNTIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxNjEzNQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531516135", "bodyText": "Are we sure that none of these arguments can be null?", "author": "RaulGracia", "createdAt": "2020-11-27T10:33:27Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/utils/ControllerHostnameVerifier.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.utils;\n+\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.SSLSession;\n+\n+public class ControllerHostnameVerifier implements HostnameVerifier {\n+    @Override\n+    public boolean verify(String s, SSLSession sslSession) {\n+        return s.equalsIgnoreCase(sslSession.getPeerHost());", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NTkxMw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532645913", "bodyText": "This file is not used anymore as the connection to TLS is made through the use of SSLContext instead.", "author": "anirudhkovuru", "createdAt": "2020-11-30T14:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxNjEzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxODEyOQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531518129", "bodyText": "Nit: Pravega (starting with caps).", "author": "RaulGracia", "createdAt": "2020-11-27T10:35:10Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/AbstractTlsAdminCommandTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin;\n+\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsAdminCommandTest {\n+\n+    @Rule\n+    public final Timeout globalTimeout = new Timeout(80, TimeUnit.SECONDS);\n+\n+    protected final AtomicReference<AdminCommandState> state = new AtomicReference<>();\n+    protected boolean authEnabled = false;\n+    protected boolean tlsEnabled = false;\n+    LocalPravegaEmulator localPravega;\n+\n+    // Security related flags and instantiate local pravega server.", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxOTYyNQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531519625", "bodyText": "Nit: remove extra blank line.", "author": "RaulGracia", "createdAt": "2020-11-27T10:36:55Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/controller/AuthEnabledControllerCommandsTest.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.controller;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.cli.admin.AbstractAdminCommandTest;\n+import io.pravega.cli.admin.AdminCommandState;\n+import io.pravega.cli.admin.CommandArgs;\n+import io.pravega.cli.admin.Parser;\n+import io.pravega.cli.admin.utils.CLIControllerConfig;\n+import io.pravega.cli.admin.utils.TestUtils;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.connection.impl.ConnectionPool;\n+import io.pravega.client.connection.impl.ConnectionPoolImpl;\n+import io.pravega.client.connection.impl.SocketConnectionFactoryImpl;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.Exceptions;\n+import io.pravega.common.cluster.Host;\n+import io.pravega.controller.server.SegmentHelper;\n+import io.pravega.controller.store.client.StoreClientFactory;\n+import io.pravega.controller.store.host.HostControllerStore;\n+import io.pravega.controller.store.host.HostMonitorConfig;\n+import io.pravega.controller.store.host.HostStoreFactory;\n+import io.pravega.controller.store.host.impl.HostMonitorConfigImpl;\n+import io.pravega.controller.util.Config;\n+import lombok.Cleanup;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.retry.RetryOneTime;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import javax.ws.rs.core.Response;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URI;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class AuthEnabledControllerCommandsTest extends AbstractAdminCommandTest {\n+\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        authEnabled = true;\n+        super.setUp();\n+    }\n+", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MDIxOQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532040219", "bodyText": "done", "author": "anirudhkovuru", "createdAt": "2020-11-28T13:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxOTYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUyMjM0Nw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531522347", "bodyText": "Why this test is exactly the same as testListScopesCommand() in ControllerCommandsTest.java? The whole point of this structure would be to have the same common tests in both auth and no auth tests, which can be inherited, right? I mean, AbstractAdminCommandTest may implement the \"common\" tests for both auth and no auth tests. Then, if you need some specific tests on either of them, you could implement them in their respective classes. But please, do not duplicate code, as it makes maintenance harder and it provides no benefit.", "author": "RaulGracia", "createdAt": "2020-11-27T10:42:03Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/controller/AuthEnabledControllerCommandsTest.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.controller;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.cli.admin.AbstractAdminCommandTest;\n+import io.pravega.cli.admin.AdminCommandState;\n+import io.pravega.cli.admin.CommandArgs;\n+import io.pravega.cli.admin.Parser;\n+import io.pravega.cli.admin.utils.CLIControllerConfig;\n+import io.pravega.cli.admin.utils.TestUtils;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.connection.impl.ConnectionPool;\n+import io.pravega.client.connection.impl.ConnectionPoolImpl;\n+import io.pravega.client.connection.impl.SocketConnectionFactoryImpl;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.Exceptions;\n+import io.pravega.common.cluster.Host;\n+import io.pravega.controller.server.SegmentHelper;\n+import io.pravega.controller.store.client.StoreClientFactory;\n+import io.pravega.controller.store.host.HostControllerStore;\n+import io.pravega.controller.store.host.HostMonitorConfig;\n+import io.pravega.controller.store.host.HostStoreFactory;\n+import io.pravega.controller.store.host.impl.HostMonitorConfigImpl;\n+import io.pravega.controller.util.Config;\n+import lombok.Cleanup;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.retry.RetryOneTime;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import javax.ws.rs.core.Response;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URI;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class AuthEnabledControllerCommandsTest extends AbstractAdminCommandTest {\n+\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        authEnabled = true;\n+        super.setUp();\n+    }\n+\n+\n+    @Test\n+    public void testListScopesCommand() throws Exception {", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MDQwOA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532040408", "bodyText": "I've shifted the common tests to a single class so for example all the tests in ControllerCommandsTest.java are run by AuthEnabledControllerCommandsTest.java as it extends ControllerCommandsTest.java. Same changes have been made throughout admin and user cli", "author": "anirudhkovuru", "createdAt": "2020-11-28T13:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUyMjM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUyNDg1Ng==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531524856", "bodyText": "All this piece of code seems repeated here and in the previous test. Wondering about if we could add this logic in a utility method in testcommon package, which I assume will be available here too.", "author": "RaulGracia", "createdAt": "2020-11-27T10:46:48Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractTlsUserCommandTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.user;\n+\n+import io.pravega.cli.user.config.InteractiveConfig;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsUserCommandTest {\n+     @Rule\n+     public final Timeout globalTimeout = new Timeout(150, TimeUnit.SECONDS);\n+\n+    protected final AtomicReference<InteractiveConfig> config = new AtomicReference<>();\n+    protected boolean authEnabled = false;\n+    protected boolean tlsEnabled = false;\n+    LocalPravegaEmulator localPravega;\n+\n+    // Security related flags and instantiate local pravega server.\n+    private final Integer controllerPort = TestUtils.getAvailableListenPort();\n+    private final Integer segmentStorePort = TestUtils.getAvailableListenPort();\n+    private final Integer restServerPort = TestUtils.getAvailableListenPort();\n+\n+    @Before\n+    public void setUp() throws Exception {\n+\n+        // Create the secure pravega server to test commands against.\n+        LocalPravegaEmulator.LocalPravegaEmulatorBuilder emulatorBuilder = LocalPravegaEmulator.builder()\n+                .controllerPort(controllerPort)\n+                .segmentStorePort(segmentStorePort)\n+                .zkPort(io.pravega.test.common.TestUtils.getAvailableListenPort())\n+                .restServerPort(io.pravega.test.common.TestUtils.getAvailableListenPort())\n+                .enableRestServer(true)\n+                .restServerPort(restServerPort)\n+                .enableAuth(authEnabled)\n+                .enableTls(tlsEnabled);\n+\n+        // Since the server is being built right here, avoiding delegating these conditions to subclasses via factory", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUyOTMxNw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531529317", "bodyText": "All this logic seems similar to what is written in AbstractTlsAdminCommandTest. Is there any possibility to use the same initialization logic for both and embed such a logic in a common place, like SecureSetupUtils.java or any other place? The point is to minimize code duplication.", "author": "RaulGracia", "createdAt": "2020-11-27T10:55:16Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractTlsUserCommandTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.user;\n+\n+import io.pravega.cli.user.config.InteractiveConfig;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsUserCommandTest {\n+     @Rule\n+     public final Timeout globalTimeout = new Timeout(150, TimeUnit.SECONDS);\n+\n+    protected final AtomicReference<InteractiveConfig> config = new AtomicReference<>();\n+    protected boolean authEnabled = false;\n+    protected boolean tlsEnabled = false;\n+    LocalPravegaEmulator localPravega;\n+\n+    // Security related flags and instantiate local pravega server.\n+    private final Integer controllerPort = TestUtils.getAvailableListenPort();\n+    private final Integer segmentStorePort = TestUtils.getAvailableListenPort();\n+    private final Integer restServerPort = TestUtils.getAvailableListenPort();\n+\n+    @Before\n+    public void setUp() throws Exception {\n+\n+        // Create the secure pravega server to test commands against.\n+        LocalPravegaEmulator.LocalPravegaEmulatorBuilder emulatorBuilder = LocalPravegaEmulator.builder()\n+                .controllerPort(controllerPort)\n+                .segmentStorePort(segmentStorePort)\n+                .zkPort(io.pravega.test.common.TestUtils.getAvailableListenPort())\n+                .restServerPort(io.pravega.test.common.TestUtils.getAvailableListenPort())\n+                .enableRestServer(true)\n+                .restServerPort(restServerPort)\n+                .enableAuth(authEnabled)\n+                .enableTls(tlsEnabled);\n+\n+        // Since the server is being built right here, avoiding delegating these conditions to subclasses via factory", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUzMTQ4Ng==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531531486", "bodyText": "Many tests here are the same as in ClusterCommandsTest.java, right? If so, for the tests that are shared between ClusterCommandsTest.java and AuthEnabledControllerCommandsTest, move them to AbstractAdminCommandTest so both classes can inherit them and we can prevent code duplication. Then, the specific tests can be implemented on their respective test classes.", "author": "RaulGracia", "createdAt": "2020-11-27T10:59:29Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/controller/AuthEnabledControllerCommandsTest.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.controller;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.cli.admin.AbstractAdminCommandTest;\n+import io.pravega.cli.admin.AdminCommandState;\n+import io.pravega.cli.admin.CommandArgs;\n+import io.pravega.cli.admin.Parser;\n+import io.pravega.cli.admin.utils.CLIControllerConfig;\n+import io.pravega.cli.admin.utils.TestUtils;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.connection.impl.ConnectionPool;\n+import io.pravega.client.connection.impl.ConnectionPoolImpl;\n+import io.pravega.client.connection.impl.SocketConnectionFactoryImpl;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.Exceptions;\n+import io.pravega.common.cluster.Host;\n+import io.pravega.controller.server.SegmentHelper;\n+import io.pravega.controller.store.client.StoreClientFactory;\n+import io.pravega.controller.store.host.HostControllerStore;\n+import io.pravega.controller.store.host.HostMonitorConfig;\n+import io.pravega.controller.store.host.HostStoreFactory;\n+import io.pravega.controller.store.host.impl.HostMonitorConfigImpl;\n+import io.pravega.controller.util.Config;\n+import lombok.Cleanup;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.retry.RetryOneTime;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import javax.ws.rs.core.Response;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URI;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class AuthEnabledControllerCommandsTest extends AbstractAdminCommandTest {\n+\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        authEnabled = true;\n+        super.setUp();\n+    }\n+\n+\n+    @Test\n+    public void testListScopesCommand() throws Exception {", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MDUxMw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532040513", "bodyText": "Yeah as explained above now these tests are in ControllerCommandsTest, this file extends it so the tests transfer too.", "author": "anirudhkovuru", "createdAt": "2020-11-28T13:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUzMTQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUzMTYwMw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531531603", "bodyText": "Nit: remove extra blank line.", "author": "RaulGracia", "createdAt": "2020-11-27T10:59:42Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/controller/AuthEnabledControllerCommandsTest.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.controller;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.cli.admin.AbstractAdminCommandTest;\n+import io.pravega.cli.admin.AdminCommandState;\n+import io.pravega.cli.admin.CommandArgs;\n+import io.pravega.cli.admin.Parser;\n+import io.pravega.cli.admin.utils.CLIControllerConfig;\n+import io.pravega.cli.admin.utils.TestUtils;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.connection.impl.ConnectionPool;\n+import io.pravega.client.connection.impl.ConnectionPoolImpl;\n+import io.pravega.client.connection.impl.SocketConnectionFactoryImpl;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.Exceptions;\n+import io.pravega.common.cluster.Host;\n+import io.pravega.controller.server.SegmentHelper;\n+import io.pravega.controller.store.client.StoreClientFactory;\n+import io.pravega.controller.store.host.HostControllerStore;\n+import io.pravega.controller.store.host.HostMonitorConfig;\n+import io.pravega.controller.store.host.HostStoreFactory;\n+import io.pravega.controller.store.host.impl.HostMonitorConfigImpl;\n+import io.pravega.controller.util.Config;\n+import lombok.Cleanup;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.retry.RetryOneTime;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import javax.ws.rs.core.Response;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URI;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class AuthEnabledControllerCommandsTest extends AbstractAdminCommandTest {\n+\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        authEnabled = true;\n+        super.setUp();\n+    }\n+", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MDUyNg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532040526", "bodyText": "done", "author": "anirudhkovuru", "createdAt": "2020-11-28T13:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUzMTYwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU0NzIxMA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531547210", "bodyText": "If auth is enabled, you'll need to specify Credentials too.", "author": "ravisharda", "createdAt": "2020-11-27T11:32:05Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -50,7 +62,38 @@ protected Context createContext() {\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If tls parameters are configured, set them in client\n+        if (getCLIControllerConfig().isTlsEnabled()) {\n+            KeyStore ks = null;\n+            try {\n+                @Cleanup\n+                InputStream trustStore = new FileInputStream(new File(getCLIControllerConfig().getTruststore()));\n+                ks = KeyStore.getInstance(\"JKS\");\n+                ks.load(trustStore, null);\n+\n+            } catch (KeyStoreException e) {\n+                output(\"The keystore file is invalid, the keystore type is not supported: %s\", e.toString());\n+            } catch (IOException e) {\n+                output(\"The keystore file is invalid, check if the file exists: %s\", e.toString());\n+            } catch (NoSuchAlgorithmException e) {\n+                output(\"The keystore file is invalid, the keystore file might be in the wrong format: %s\", e.toString());\n+            } catch (CertificateException e) {\n+                output(\"The keystore file is invalid, check if the certificates are valid: %s\", e.toString());\n+            }\n+\n+            HostnameVerifier controllerHostnameVerifier = new ControllerHostnameVerifier();\n+            client = ClientBuilder.newBuilder()", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MDU2OQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532040569", "bodyText": "The credentials are registered in the next lines.", "author": "anirudhkovuru", "createdAt": "2020-11-28T13:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU0NzIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2MTk1NA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531561954", "bodyText": "Curious, why do you need a custom hostname verifier here? You could use one of the standard ones.\nHere's how we do it in the client (for the call to segment store):\n\n  \n    \n      pravega/client/src/main/java/io/pravega/client/connection/impl/TcpClientConnection.java\n    \n    \n        Lines 243 to 251\n      in\n      899a82d\n    \n    \n    \n    \n\n        \n          \n           if (clientConfig.isValidateHostName()) { \n        \n\n        \n          \n               SSLParameters tlsParams = new SSLParameters(); \n        \n\n        \n          \n            \n        \n\n        \n          \n               // While the connection is to a TCP service and not an HTTP server, we use `HTTPS` as the endpoint \n        \n\n        \n          \n               // identification algorithm, which in turn ensures that the SSLSocket will verify the server's host \n        \n\n        \n          \n               // name during TLS handshake. This is a commonly used way of enabling hostname verification \n        \n\n        \n          \n               // regardless of whether the service itself is HTTP (no in this case). \n        \n\n        \n          \n               tlsParams.setEndpointIdentificationAlgorithm(\"HTTPS\"); \n        \n\n        \n          \n               tlsClientSocket.setSSLParameters(tlsParams);", "author": "ravisharda", "createdAt": "2020-11-27T12:02:09Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/utils/ControllerHostnameVerifier.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.utils;\n+\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.SSLSession;\n+\n+public class ControllerHostnameVerifier implements HostnameVerifier {", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NDk2NQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532644965", "bodyText": "Instead of having a HostnameVerfier, using SSLContext as suggested.", "author": "anirudhkovuru", "createdAt": "2020-11-30T14:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2MTk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2MzExMw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531563113", "bodyText": "The String \"../../config\" gets repeated many times below. Create a String constant and use it here and below.", "author": "ravisharda", "createdAt": "2020-11-27T12:04:39Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/AbstractTlsAdminCommandTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin;\n+\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.local.LocalPravegaEmulator;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+\n+import java.net.URI;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public abstract class AbstractTlsAdminCommandTest {\n+\n+    @Rule\n+    public final Timeout globalTimeout = new Timeout(80, TimeUnit.SECONDS);\n+\n+    protected final AtomicReference<AdminCommandState> state = new AtomicReference<>();\n+    protected boolean authEnabled = false;\n+    protected boolean tlsEnabled = false;\n+    LocalPravegaEmulator localPravega;\n+\n+    // Security related flags and instantiate local pravega server.\n+    private final Integer controllerPort = TestUtils.getAvailableListenPort();\n+    private final Integer segmentStorePort = TestUtils.getAvailableListenPort();\n+    private final Integer restServerPort = TestUtils.getAvailableListenPort();\n+\n+    @Before\n+    public void setUp() throws Exception {\n+\n+        // Create the secure pravega server to test commands against.\n+        LocalPravegaEmulator.LocalPravegaEmulatorBuilder emulatorBuilder = LocalPravegaEmulator.builder()\n+                .controllerPort(controllerPort)\n+                .segmentStorePort(segmentStorePort)\n+                .zkPort(TestUtils.getAvailableListenPort())\n+                .restServerPort(TestUtils.getAvailableListenPort())\n+                .enableRestServer(true)\n+                .restServerPort(restServerPort)\n+                .enableAuth(authEnabled)\n+                .enableTls(tlsEnabled);\n+\n+        // Since the server is being built right here, avoiding delegating these conditions to subclasses via factory\n+        // methods. This is so that it is easy to see the difference in server configs all in one place. This is also\n+        // unlike the ClientConfig preparation which is being delegated to factory methods to make their preparation\n+        // explicit in the respective test classes.\n+\n+        if (authEnabled) {\n+            emulatorBuilder.passwdFile(\"../../config/\" + SecurityConfigDefaults.AUTH_HANDLER_INPUT_FILE_NAME)", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NDQ2MQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532644461", "bodyText": "Stored in a local variable.", "author": "anirudhkovuru", "createdAt": "2020-11-30T14:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2MzExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NDU2OQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531564569", "bodyText": "In general, you should avoid throwing the base Exception. If you must throw, throw the specific exceptions. Here, in the tests, throwing exceptions is meaningless, so you could simplify the code a bit by adding a @SneakyThrows exception, if you will.", "author": "ravisharda", "createdAt": "2020-11-27T12:07:53Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/controller/AuthEnabledControllerCommandsTest.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.controller;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.cli.admin.AbstractAdminCommandTest;\n+import io.pravega.cli.admin.AdminCommandState;\n+import io.pravega.cli.admin.CommandArgs;\n+import io.pravega.cli.admin.Parser;\n+import io.pravega.cli.admin.utils.CLIControllerConfig;\n+import io.pravega.cli.admin.utils.TestUtils;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.connection.impl.ConnectionPool;\n+import io.pravega.client.connection.impl.ConnectionPoolImpl;\n+import io.pravega.client.connection.impl.SocketConnectionFactoryImpl;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.Exceptions;\n+import io.pravega.common.cluster.Host;\n+import io.pravega.controller.server.SegmentHelper;\n+import io.pravega.controller.store.client.StoreClientFactory;\n+import io.pravega.controller.store.host.HostControllerStore;\n+import io.pravega.controller.store.host.HostMonitorConfig;\n+import io.pravega.controller.store.host.HostStoreFactory;\n+import io.pravega.controller.store.host.impl.HostMonitorConfigImpl;\n+import io.pravega.controller.util.Config;\n+import lombok.Cleanup;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.retry.RetryOneTime;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import javax.ws.rs.core.Response;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URI;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class AuthEnabledControllerCommandsTest extends AbstractAdminCommandTest {\n+\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        authEnabled = true;\n+        super.setUp();\n+    }\n+\n+\n+    @Test\n+    public void testListScopesCommand() throws Exception {\n+        setupUtils.createTestStream(\"testListScopesCommand\", 2);\n+        String commandResult = TestUtils.executeCommand(\"controller list-scopes\", state.get());\n+        // Check that both the new scope and the system one exist.\n+        Assert.assertTrue(commandResult.contains(\"_system\"));\n+        Assert.assertTrue(commandResult.contains(setupUtils.getScope()));\n+        Assert.assertNotNull(ControllerListScopesCommand.descriptor());\n+    }\n+\n+    @Test\n+    public void testDescribeScopeCommand() throws Exception {\n+        String commandResult = TestUtils.executeCommand(\"controller describe-scope _system\", state.get());\n+        Assert.assertTrue(commandResult.contains(\"_system\"));\n+        Assert.assertNotNull(ControllerDescribeStreamCommand.descriptor());\n+    }\n+\n+    @Test\n+    public void testListStreamsCommand() throws Exception {", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NDIxMw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532644213", "bodyText": "Using @SneakyThrows now.", "author": "anirudhkovuru", "createdAt": "2020-11-30T14:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NDU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3MDgwNw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531570807", "bodyText": "You seem to be using getCLIControllerConfig() multiple times. (The name of that method is misleading - it actually does a bit of processing as opposed to returning a cached value that one'd usually expect from a method having a name starting with get). You might want to call it once, store the value in a variable and reuse it.", "author": "ravisharda", "createdAt": "2020-11-27T12:21:14Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -50,7 +62,38 @@ protected Context createContext() {\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If tls parameters are configured, set them in client\n+        if (getCLIControllerConfig().isTlsEnabled()) {\n+            KeyStore ks = null;\n+            try {\n+                @Cleanup\n+                InputStream trustStore = new FileInputStream(new File(getCLIControllerConfig().getTruststore()));\n+                ks = KeyStore.getInstance(\"JKS\");\n+                ks.load(trustStore, null);\n+\n+            } catch (KeyStoreException e) {\n+                output(\"The keystore file is invalid, the keystore type is not supported: %s\", e.toString());\n+            } catch (IOException e) {\n+                output(\"The keystore file is invalid, check if the file exists: %s\", e.toString());\n+            } catch (NoSuchAlgorithmException e) {\n+                output(\"The keystore file is invalid, the keystore file might be in the wrong format: %s\", e.toString());\n+            } catch (CertificateException e) {\n+                output(\"The keystore file is invalid, check if the certificates are valid: %s\", e.toString());\n+            }\n+\n+            HostnameVerifier controllerHostnameVerifier = new ControllerHostnameVerifier();\n+            client = ClientBuilder.newBuilder()\n+                    .withConfig(clientConfig)\n+                    .trustStore(ks)\n+                    .hostnameVerifier(controllerHostnameVerifier)\n+                    .build();\n+        } else {\n+            client = ClientBuilder.newClient(clientConfig);\n+        }\n+\n         // If authorization parameters are configured, set them in the client.\n         if (getCLIControllerConfig().isAuthEnabled()) {", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MDY2OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r532040668", "bodyText": "Moved the return of getCLIControllerConfig() to a single variable which is used everywhere.", "author": "anirudhkovuru", "createdAt": "2020-11-28T13:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3MDgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3MzkxMw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r531573913", "bodyText": "This test is too ambitious. It tests multiple behaviors in a single test. If one behavior fails later if something is changed, it'll mask failures in other behaviors. Please refactor this into multiple tests.", "author": "ravisharda", "createdAt": "2020-11-27T12:27:51Z", "path": "cli/admin/src/test/java/io/pravega/cli/admin/controller/TLSEnabledControllerCommandsTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.cli.admin.controller;\n+\n+import io.pravega.cli.admin.AbstractTlsAdminCommandTest;\n+import io.pravega.cli.admin.utils.TestUtils;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.admin.ReaderGroupManager;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.stream.ReaderGroupConfig;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.Stream;\n+import io.pravega.client.stream.StreamConfiguration;\n+import lombok.Cleanup;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.UUID;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class TLSEnabledControllerCommandsTest extends AbstractTlsAdminCommandTest {\n+\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        tlsEnabled = true;\n+        super.setUp();\n+    }\n+\n+    @After\n+    @Override\n+    public void tearDown() throws Exception {\n+        super.tearDown();\n+    }\n+\n+    @Test\n+    public void testAllCommands() throws Exception {", "originalCommit": "fc306721dddc649295fcd733a9a589f99849363e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0MTk5NA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534241994", "bodyText": "Resolved all ambitious tests", "author": "anirudhkovuru", "createdAt": "2020-12-02T15:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3MzkxMw=="}], "type": "inlineReview"}, {"oid": "ccc19ed1f9cde60ce792e5e12b3d454be0ef769d", "url": "https://github.com/pravega/pravega/commit/ccc19ed1f9cde60ce792e5e12b3d454be0ef769d", "message": "Adding tokenSigningKey, removing duplicate tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-28T13:16:27Z", "type": "commit"}, {"oid": "c62eb73259427d44fd3866138919a5a60fff3fc8", "url": "https://github.com/pravega/pravega/commit/c62eb73259427d44fd3866138919a5a60fff3fc8", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-11-30T03:48:13Z", "type": "commit"}, {"oid": "d10a1a235e6a28a9fc99e05a842ef07c18680af6", "url": "https://github.com/pravega/pravega/commit/d10a1a235e6a28a9fc99e05a842ef07c18680af6", "message": "Adding coverage\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-30T05:54:56Z", "type": "commit"}, {"oid": "1e1114f90e0eca87a96d84142434ed09fc12fca0", "url": "https://github.com/pravega/pravega/commit/1e1114f90e0eca87a96d84142434ed09fc12fca0", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-11-30T11:16:01Z", "type": "commit"}, {"oid": "a76190e6d970ddccc0ac5e107d170d488c046a8c", "url": "https://github.com/pravega/pravega/commit/a76190e6d970ddccc0ac5e107d170d488c046a8c", "message": "Streamlined admin TLS logic, sneakyThrows for tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-30T14:37:43Z", "type": "commit"}, {"oid": "a76190e6d970ddccc0ac5e107d170d488c046a8c", "url": "https://github.com/pravega/pravega/commit/a76190e6d970ddccc0ac5e107d170d488c046a8c", "message": "Streamlined admin TLS logic, sneakyThrows for tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-11-30T14:37:43Z", "type": "forcePushed"}, {"oid": "07a9f1196abe32c683a1703beca19a004b5bc1c2", "url": "https://github.com/pravega/pravega/commit/07a9f1196abe32c683a1703beca19a004b5bc1c2", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-01T04:12:35Z", "type": "commit"}, {"oid": "31f80bb02466f9f0a630af86f357403fb36b3095", "url": "https://github.com/pravega/pravega/commit/31f80bb02466f9f0a630af86f357403fb36b3095", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-01T08:59:21Z", "type": "commit"}, {"oid": "275425d3fd8fe4b0f08a590d4deb700fc835d971", "url": "https://github.com/pravega/pravega/commit/275425d3fd8fe4b0f08a590d4deb700fc835d971", "message": "Changed wrong admin-cli.properties\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-01T11:38:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3Mzg4Mw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r533873883", "bodyText": "Please remove printStackTrace.", "author": "ravisharda", "createdAt": "2020-12-02T03:33:17Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -47,14 +58,39 @@\n      * @return REST client.\n      */\n     protected Context createContext() {\n+        CLIControllerConfig config = getCLIControllerConfig();\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If TLS parameters are configured, set them in client.\n+        if (config.isTlsEnabled()) {\n+            SSLContext tlsContext;\n+            try {\n+                KeyStore ks = createTrustStore(config.getTruststore());\n+                TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n+                tmf.init(ks);\n+                tlsContext = SSLContext.getInstance(\"TLS\");\n+                tlsContext.init(null, tmf.getTrustManagers(), null);\n+            } catch (KeyStoreException | IOException | NoSuchAlgorithmException | CertificateException | KeyManagementException e) {\n+                output(\"Encountered exception while trying to use the given truststore: %s\", config.getTruststore());\n+                e.printStackTrace();", "originalCommit": "275425d3fd8fe4b0f08a590d4deb700fc835d971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0MTczMA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534241730", "bodyText": "Removed", "author": "anirudhkovuru", "createdAt": "2020-12-02T15:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3Mzg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NDI2NQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r533874265", "bodyText": "Without the additional context, it'd be very difficult to debug this issue. Please output the exception message/trace too.\nCurious, why don't we add some logs to these methods too?", "author": "ravisharda", "createdAt": "2020-12-02T03:34:38Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -47,14 +58,39 @@\n      * @return REST client.\n      */\n     protected Context createContext() {\n+        CLIControllerConfig config = getCLIControllerConfig();\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If TLS parameters are configured, set them in client.\n+        if (config.isTlsEnabled()) {\n+            SSLContext tlsContext;\n+            try {\n+                KeyStore ks = createTrustStore(config.getTruststore());\n+                TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n+                tmf.init(ks);\n+                tlsContext = SSLContext.getInstance(\"TLS\");\n+                tlsContext.init(null, tmf.getTrustManagers(), null);\n+            } catch (KeyStoreException | IOException | NoSuchAlgorithmException | CertificateException | KeyManagementException e) {\n+                output(\"Encountered exception while trying to use the given truststore: %s\", config.getTruststore());", "originalCommit": "275425d3fd8fe4b0f08a590d4deb700fc835d971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0MTYyNQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534241625", "bodyText": "I print the error message.", "author": "anirudhkovuru", "createdAt": "2020-12-02T15:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NDI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk2NDU5NQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534964595", "bodyText": "Printing the error message gives feedback to the user who is running the command. Logging'd help customer support/developers debugging issues. So, they'd serve different purposes.", "author": "ravisharda", "createdAt": "2020-12-03T08:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NDI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NjUyNw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r533876527", "bodyText": "nit: The logic here'll be easier to follow with a slight rearrangement. Something like:\nbuilder = ClientBuilder.newBuilder().withConfig(clientConfig); \nif (tls enabled) {\n     builder.sslContext(...)\n} \nClient client = builder.build(); \n\nif (auth enabled) {\n     // do auth-specific stuff\n}\nClient client = builder.build();", "author": "ravisharda", "createdAt": "2020-12-02T03:43:01Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/controller/ControllerCommand.java", "diffHunk": "@@ -47,14 +58,39 @@\n      * @return REST client.\n      */\n     protected Context createContext() {\n+        CLIControllerConfig config = getCLIControllerConfig();\n         ClientConfig clientConfig = new ClientConfig();\n         clientConfig.register(JacksonJsonProvider.class);\n         clientConfig.property(\"sun.net.http.allowRestrictedHeaders\", \"true\");\n-        Client client = ClientBuilder.newClient(clientConfig);\n+\n+        Client client;\n+\n+        // If TLS parameters are configured, set them in client.\n+        if (config.isTlsEnabled()) {\n+            SSLContext tlsContext;\n+            try {\n+                KeyStore ks = createTrustStore(config.getTruststore());\n+                TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n+                tmf.init(ks);\n+                tlsContext = SSLContext.getInstance(\"TLS\");\n+                tlsContext.init(null, tmf.getTrustManagers(), null);\n+            } catch (KeyStoreException | IOException | NoSuchAlgorithmException | CertificateException | KeyManagementException e) {\n+                output(\"Encountered exception while trying to use the given truststore: %s\", config.getTruststore());\n+                e.printStackTrace();\n+                return null;\n+            }\n+            client = ClientBuilder.newBuilder()\n+                    .withConfig(clientConfig)\n+                    .sslContext(tlsContext)\n+                    .build();\n+        } else {\n+            client = ClientBuilder.newClient(clientConfig);\n+        }\n+\n         // If authorization parameters are configured, set them in the client.\n-        if (getCLIControllerConfig().isAuthEnabled()) {\n-            HttpAuthenticationFeature auth = HttpAuthenticationFeature.basic(getCLIControllerConfig().getUserName(),\n-                    getCLIControllerConfig().getPassword());\n+        if (config.isAuthEnabled()) {", "originalCommit": "275425d3fd8fe4b0f08a590d4deb700fc835d971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0MTM5MA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534241390", "bodyText": "Following a pattern like this", "author": "anirudhkovuru", "createdAt": "2020-12-02T15:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NjUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NzYwNQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r533877605", "bodyText": "Some of these config names are inconsistent with the scheme we use elsewhere in Pravega. See the following:\n\nConfiguration Naming Guidelines\nExisting examples\n\nHere are the suggested changes:\n\ncontroller.rest.uri -> controller.connect.rest.uri (because it is connecting to the Controller's REST URI)\ncontroller.grpc.uri -> controller.connect.grpc.uri\nsecurity.auth.credentials.username -> controller.connect.credentials.username\nsecurity.auth.credentials.password -> controller.connect.credentials.pwd (we avoid the term password so that scanners and other tools don't get confused)\nsecurity.auth.token.signingKey -- ? (what is this for, here?)\n\nEtc.\nAs for security.auth.enable (and similar items), it indicates you are enabling auth for CLI. If you are using it for specifying that auth be enabled for CLI to controller communication, the config name'd be different.", "author": "ravisharda", "createdAt": "2020-12-02T03:46:49Z", "path": "cli/admin/src/main/java/io/pravega/cli/admin/utils/CLIControllerConfig.java", "diffHunk": "@@ -24,11 +24,14 @@\n         SEGMENTSTORE, ZOOKEEPER\n     }\n \n-    private static final Property<String> CONTROLLER_REST_URI = Property.named(\"controller.rest.uri\", \"http://localhost:9091\");\n-    private static final Property<String> CONTROLLER_GRPC_URI = Property.named(\"controller.grpc.uri\", \"tcp://localhost:9090\");\n+    private static final Property<String> CONTROLLER_REST_URI = Property.named(\"controller.rest.uri\", \"localhost:9091\");", "originalCommit": "275425d3fd8fe4b0f08a590d4deb700fc835d971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyMzI1Ng==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534323256", "bodyText": "I've used the guidelines.", "author": "anirudhkovuru", "createdAt": "2020-12-02T16:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NzYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg4MjA4NQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r533882085", "bodyText": "Please avoid using abbreviations like this one. A streamMgr or streamManager'd help reduce the cognitive burden on the person who reads the code. Same for sc below.", "author": "ravisharda", "createdAt": "2020-12-02T04:03:02Z", "path": "cli/user/src/main/java/io/pravega/cli/user/stream/StreamCommand.java", "diffHunk": "@@ -65,7 +63,7 @@ public Create(@NonNull CommandArgs commandArgs) {\n         public void execute() {\n             ensureMinArgCount(1);\n             @Cleanup\n-            val sm = StreamManager.create(URI.create(getConfig().getControllerUri()));\n+            val sm = StreamManager.create(getClientConfig());", "originalCommit": "275425d3fd8fe4b0f08a590d4deb700fc835d971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0MDQ5Mg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534240492", "bodyText": "done", "author": "anirudhkovuru", "createdAt": "2020-12-02T15:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg4MjA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg4MjE1OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r533882158", "bodyText": "same here.", "author": "ravisharda", "createdAt": "2020-12-02T04:03:22Z", "path": "cli/user/src/main/java/io/pravega/cli/user/stream/StreamCommand.java", "diffHunk": "@@ -247,7 +245,7 @@ public void execute() {\n             val readerGroup = UUID.randomUUID().toString().replace(\"-\", \"\");\n             val readerId = UUID.randomUUID().toString().replace(\"-\", \"\");\n \n-            val cc = ClientConfig.builder().controllerURI(getControllerUri()).build();\n+            val cc = getClientConfig();", "originalCommit": "275425d3fd8fe4b0f08a590d4deb700fc835d971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0MDQzNA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534240434", "bodyText": "done", "author": "anirudhkovuru", "createdAt": "2020-12-02T15:07:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg4MjE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg4MjU5Mw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r533882593", "bodyText": "nit: The term factory is a bit abstract. A clientFactory is more precise, and eventStreamClientFactory even more so. In general, variable names should be as precise as possible (for reasons like reducing the work that a code reader needs to perform so that the person may focus more on the logic than the syntax). Here, it's not so much an issue as the factory is used right under this statement, so you may choose to leave it as-is.", "author": "ravisharda", "createdAt": "2020-12-02T04:04:47Z", "path": "cli/user/src/main/java/io/pravega/cli/user/stream/StreamCommand.java", "diffHunk": "@@ -183,7 +181,7 @@ public void execute() throws Exception {\n             }\n \n             @Cleanup\n-            val factory = EventStreamClientFactory.withScope(scopedStream.getScope(), ClientConfig.builder().controllerURI(getControllerUri()).build());\n+            val factory = EventStreamClientFactory.withScope(scopedStream.getScope(), getClientConfig());", "originalCommit": "275425d3fd8fe4b0f08a590d4deb700fc835d971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA5NTIyNg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r535095226", "bodyText": "done", "author": "anirudhkovuru", "createdAt": "2020-12-03T10:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg4MjU5Mw=="}], "type": "inlineReview"}, {"oid": "8936add8f97aefe7caa8cea6fcb7bcfda67f08fc", "url": "https://github.com/pravega/pravega/commit/8936add8f97aefe7caa8cea6fcb7bcfda67f08fc", "message": "Changed the test structure for user commands in security scenarios\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-02T11:31:31Z", "type": "commit"}, {"oid": "082f6f24f4f600c5a44d6f24cad91707474bd707", "url": "https://github.com/pravega/pravega/commit/082f6f24f4f600c5a44d6f24cad91707474bd707", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-02T11:32:16Z", "type": "commit"}, {"oid": "25ad699eeda86b64d09879c28aacd16e3e79a03a", "url": "https://github.com/pravega/pravega/commit/25ad699eeda86b64d09879c28aacd16e3e79a03a", "message": "Changed structure of the TLS tests for admin controller commands\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-02T15:04:41Z", "type": "commit"}, {"oid": "51efde1853960b302f98ae42a5116648b4999fd4", "url": "https://github.com/pravega/pravega/commit/51efde1853960b302f98ae42a5116648b4999fd4", "message": "Changed cli config names\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-02T16:50:37Z", "type": "commit"}, {"oid": "ac8067b0e14bed7dffab81a2c11032d6e3705e0a", "url": "https://github.com/pravega/pravega/commit/ac8067b0e14bed7dffab81a2c11032d6e3705e0a", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-03T04:03:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk3NjgyMg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534976822", "bodyText": "nit: Please avoid abbreviations to the extent possible. testCreateKeyValueTable() sounds better. Same for other tests below.", "author": "ravisharda", "createdAt": "2020-12-03T09:06:48Z", "path": "cli/user/src/test/java/io/pravega/cli/user/kvs/KVTCommandsTest.java", "diffHunk": "@@ -22,7 +23,8 @@\n public class KVTCommandsTest extends AbstractUserCommandTest {\n \n     @Test(timeout = 10000)\n-    public void testCreateKVT() throws Exception {\n+    @SneakyThrows\n+    public void testCreateKVT() {", "originalCommit": "ac8067b0e14bed7dffab81a2c11032d6e3705e0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA5NTAzMA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r535095030", "bodyText": "done", "author": "anirudhkovuru", "createdAt": "2020-12-03T10:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk3NjgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk4MjU3OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r534982578", "bodyText": "Please use the ClusterWrapper instead, as it already supports running clusters both with security (TLS and auth) on and off.", "author": "ravisharda", "createdAt": "2020-12-03T09:10:48Z", "path": "test/integration/src/main/java/io/pravega/test/integration/utils/SecureSetupUtils.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.test.integration.utils;\n+\n+import com.google.common.base.Preconditions;\n+import io.pravega.client.ClientConfig;\n+import io.pravega.client.EventStreamClientFactory;\n+import io.pravega.client.admin.ReaderGroupManager;\n+import io.pravega.client.admin.StreamManager;\n+import io.pravega.client.control.impl.Controller;\n+import io.pravega.client.control.impl.ControllerImpl;\n+import io.pravega.client.control.impl.ControllerImplConfig;\n+import io.pravega.client.stream.EventStreamReader;\n+import io.pravega.client.stream.EventStreamWriter;\n+import io.pravega.client.stream.EventWriterConfig;\n+import io.pravega.client.stream.ReaderConfig;\n+import io.pravega.client.stream.ReaderGroupConfig;\n+import io.pravega.client.stream.ScalingPolicy;\n+import io.pravega.client.stream.Stream;\n+import io.pravega.client.stream.StreamConfiguration;\n+import io.pravega.client.stream.impl.ClientFactoryImpl;\n+import io.pravega.client.stream.impl.DefaultCredentials;\n+import io.pravega.common.concurrent.ExecutorServiceHelpers;\n+import io.pravega.controller.util.Config;\n+import io.pravega.segmentstore.contracts.StreamSegmentStore;\n+import io.pravega.segmentstore.server.host.handler.PravegaConnectionListener;\n+import io.pravega.segmentstore.server.store.ServiceBuilder;\n+import io.pravega.segmentstore.server.store.ServiceBuilderConfig;\n+import io.pravega.test.common.SecurityConfigDefaults;\n+import io.pravega.test.common.TestUtils;\n+import io.pravega.test.common.TestingServerStarter;\n+import io.pravega.test.integration.demo.ControllerWrapper;\n+import lombok.Cleanup;\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.curator.test.TestingServer;\n+\n+import javax.annotation.concurrent.NotThreadSafe;\n+import java.net.URI;\n+import java.util.UUID;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Utility functions for creating the test setup.\n+ */\n+@Slf4j\n+@NotThreadSafe\n+public final class SecureSetupUtils implements AutoCloseable {", "originalCommit": "ac8067b0e14bed7dffab81a2c11032d6e3705e0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDcwNjMzOA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r540706338", "bodyText": "Using the ClusterWrapper now.", "author": "anirudhkovuru", "createdAt": "2020-12-11T05:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk4MjU3OA=="}], "type": "inlineReview"}, {"oid": "6576cbf3ca30f119321ead6c5360e40160dbdf56", "url": "https://github.com/pravega/pravega/commit/6576cbf3ca30f119321ead6c5360e40160dbdf56", "message": "Addressing comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-03T10:46:11Z", "type": "commit"}, {"oid": "b06e08ef230c4bc7eee7226f5290e668232b8c79", "url": "https://github.com/pravega/pravega/commit/b06e08ef230c4bc7eee7226f5290e668232b8c79", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-04T04:27:27Z", "type": "commit"}, {"oid": "73c621125f9eef7f7f3d63d479e2ebf2a54ef82d", "url": "https://github.com/pravega/pravega/commit/73c621125f9eef7f7f3d63d479e2ebf2a54ef82d", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-04T09:30:48Z", "type": "commit"}, {"oid": "5ce8dc4a8e6b27107fc8b3d5efcac048748ed709", "url": "https://github.com/pravega/pravega/commit/5ce8dc4a8e6b27107fc8b3d5efcac048748ed709", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-07T04:13:39Z", "type": "commit"}, {"oid": "19156259e42e0c5981bb90500101ce5c7e56a70c", "url": "https://github.com/pravega/pravega/commit/19156259e42e0c5981bb90500101ce5c7e56a70c", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-07T05:32:12Z", "type": "commit"}, {"oid": "46b1437d1f208f5ab56b95cd7412391b53ea1ab6", "url": "https://github.com/pravega/pravega/commit/46b1437d1f208f5ab56b95cd7412391b53ea1ab6", "message": "Resolving merge conflict\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-09T09:16:40Z", "type": "commit"}, {"oid": "46b1437d1f208f5ab56b95cd7412391b53ea1ab6", "url": "https://github.com/pravega/pravega/commit/46b1437d1f208f5ab56b95cd7412391b53ea1ab6", "message": "Resolving merge conflict\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-09T09:16:40Z", "type": "forcePushed"}, {"oid": "811ad18455cb93ba5bdd0f9791e235cf84c0827b", "url": "https://github.com/pravega/pravega/commit/811ad18455cb93ba5bdd0f9791e235cf84c0827b", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-10T09:38:58Z", "type": "commit"}, {"oid": "e09d57742b909690a4f13ed339885ec0da655a0c", "url": "https://github.com/pravega/pravega/commit/e09d57742b909690a4f13ed339885ec0da655a0c", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-11T03:55:55Z", "type": "commit"}, {"oid": "0e838f384346d560af279595e2761a7a3c634029", "url": "https://github.com/pravega/pravega/commit/0e838f384346d560af279595e2761a7a3c634029", "message": "Changing tests to use ClusterWrapper\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-11T05:41:34Z", "type": "commit"}, {"oid": "25657718bf360f091b8a4436fb06a33ed1b38d32", "url": "https://github.com/pravega/pravega/commit/25657718bf360f091b8a4436fb06a33ed1b38d32", "message": "New doc for TestUtils\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-11T14:33:59Z", "type": "commit"}, {"oid": "cc7077535cb31cdaaf7947565ba969fa5067acdf", "url": "https://github.com/pravega/pravega/commit/cc7077535cb31cdaaf7947565ba969fa5067acdf", "message": "Fixed leaky test\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-11T14:59:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTgyMjI2OA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r541822268", "bodyText": "Why are you using AtomicReference for CLUSTER and CONFIG?\nSince this CLUSTER variable is static, it will be shared across all classes that use it. This will cause a synchronization issue across different classes that use this or call setUpCluster(). You should instantiate this in the respective classes instead so that you don't prevent tests from different classes from running parallelly. Or, alternatively, you can have the setUpCluster() return a new instance.", "author": "ravisharda", "createdAt": "2020-12-13T02:01:43Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractUserCommandTest.java", "diffHunk": "@@ -19,29 +20,33 @@\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicReference;\n \n+import static io.pravega.cli.user.TestUtils.createPravegaCluster;\n+import static io.pravega.cli.user.TestUtils.setInteractiveConfig;\n+\n public abstract class AbstractUserCommandTest {\n \n-    // Setup utility.\n-    protected static final SetupUtils SETUP_UTILS = new SetupUtils();\n+    protected static final AtomicReference<ClusterWrapper> CLUSTER = new AtomicReference<>();", "originalCommit": "ef00bfcefa8e62bb1614113ab5a31cd34f6a4162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM0Nzk5Mg==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r542347992", "bodyText": "As discussed, avoiding the use of AtomicReference.", "author": "anirudhkovuru", "createdAt": "2020-12-14T12:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTgyMjI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTgyMjQ3MA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r541822470", "bodyText": "See comment earlier.", "author": "ravisharda", "createdAt": "2020-12-13T02:03:13Z", "path": "cli/user/src/test/java/io/pravega/cli/user/AbstractUserCommandTest.java", "diffHunk": "@@ -19,29 +20,33 @@\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicReference;\n \n+import static io.pravega.cli.user.TestUtils.createPravegaCluster;\n+import static io.pravega.cli.user.TestUtils.setInteractiveConfig;\n+\n public abstract class AbstractUserCommandTest {\n \n-    // Setup utility.\n-    protected static final SetupUtils SETUP_UTILS = new SetupUtils();\n+    protected static final AtomicReference<ClusterWrapper> CLUSTER = new AtomicReference<>();\n     protected static final AtomicReference<InteractiveConfig> CONFIG = new AtomicReference<>();\n-\n     @Rule\n     public final Timeout globalTimeout = new Timeout(60, TimeUnit.SECONDS);\n \n+    public static void setUpCluster(boolean authEnabled, boolean tlsEnabled) {\n+        CLUSTER.set(createPravegaCluster(authEnabled, tlsEnabled));\n+        CLUSTER.get().start();\n+        setInteractiveConfig(CLUSTER.get().controllerUri().replace(\"tcp://\", \"\").replace(\"tls://\", \"\"),\n+                authEnabled, tlsEnabled, CONFIG);\n+    }\n+\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        SETUP_UTILS.startAllServices();\n-        InteractiveConfig interactiveConfig = InteractiveConfig.getDefault();\n-        interactiveConfig.setControllerUri(SETUP_UTILS.getControllerUri().toString());\n-        interactiveConfig.setDefaultSegmentCount(4);\n-        interactiveConfig.setMaxListItems(100);\n-        interactiveConfig.setTimeoutMillis(1000);\n-        CONFIG.set(interactiveConfig);\n+    public static void start() {", "originalCommit": "ef00bfcefa8e62bb1614113ab5a31cd34f6a4162", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTgyMjcxNw==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r541822717", "bodyText": "This assertion of assumption should be done right after the Command is initialized.", "author": "ravisharda", "createdAt": "2020-12-13T02:05:23Z", "path": "cli/user/src/test/java/io/pravega/cli/user/TestUtils.java", "diffHunk": "@@ -35,11 +38,60 @@ public static String executeCommand(String inputCommand, InteractiveConfig confi\n         CommandArgs args = new CommandArgs(pc.getArgs().getArgs(), config);\n         Command cmd = Command.Factory.get(pc.getComponent(), pc.getName(), args);\n         final ByteArrayOutputStream baos = new ByteArrayOutputStream();\n-        try (PrintStream ps = new PrintStream(baos, true, \"UTF-8\")) {\n+        try (PrintStream ps = new PrintStream(baos, true, StandardCharsets.UTF_8)) {\n             assert cmd != null;", "originalCommit": "ef00bfcefa8e62bb1614113ab5a31cd34f6a4162", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTgyMzIyOQ==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r541823229", "bodyText": "nit: this'd be shorter: baos.toString(StandardCharsets.UTF_8)", "author": "ravisharda", "createdAt": "2020-12-13T02:09:20Z", "path": "cli/user/src/test/java/io/pravega/cli/user/TestUtils.java", "diffHunk": "@@ -35,11 +38,60 @@ public static String executeCommand(String inputCommand, InteractiveConfig confi\n         CommandArgs args = new CommandArgs(pc.getArgs().getArgs(), config);\n         Command cmd = Command.Factory.get(pc.getComponent(), pc.getName(), args);\n         final ByteArrayOutputStream baos = new ByteArrayOutputStream();\n-        try (PrintStream ps = new PrintStream(baos, true, \"UTF-8\")) {\n+        try (PrintStream ps = new PrintStream(baos, true, StandardCharsets.UTF_8)) {\n             assert cmd != null;\n             cmd.setOut(ps);\n             cmd.execute();\n         }\n         return new String(baos.toByteArray(), StandardCharsets.UTF_8);", "originalCommit": "ef00bfcefa8e62bb1614113ab5a31cd34f6a4162", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTgyMzQyMA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r541823420", "bodyText": "This and the next two lines are unnecessary if TLS is disabled. Why don't you call them only if TLS is enabled?", "author": "ravisharda", "createdAt": "2020-12-13T02:10:50Z", "path": "cli/user/src/test/java/io/pravega/cli/user/TestUtils.java", "diffHunk": "@@ -35,11 +38,60 @@ public static String executeCommand(String inputCommand, InteractiveConfig confi\n         CommandArgs args = new CommandArgs(pc.getArgs().getArgs(), config);\n         Command cmd = Command.Factory.get(pc.getComponent(), pc.getName(), args);\n         final ByteArrayOutputStream baos = new ByteArrayOutputStream();\n-        try (PrintStream ps = new PrintStream(baos, true, \"UTF-8\")) {\n+        try (PrintStream ps = new PrintStream(baos, true, StandardCharsets.UTF_8)) {\n             assert cmd != null;\n             cmd.setOut(ps);\n             cmd.execute();\n         }\n         return new String(baos.toByteArray(), StandardCharsets.UTF_8);\n     }\n+\n+    /**\n+     * Returns the relative path to `pravega/config` source directory from cli/user tests.\n+     *\n+     * @return the path\n+     */\n+    public static String pathToConfig() {\n+        return \"../../config/\";\n+    }\n+\n+    /**\n+     * Creates a local Pravega cluster to test on using {@link ClusterWrapper}.\n+     *\n+     * @param authEnabled whether accessing the cluster require authentication or not.\n+     * @param tlsEnabled whether accessing the cluster require TLS or not.\n+     * @return A local Pravega cluster\n+     */\n+    public static ClusterWrapper createPravegaCluster(boolean authEnabled, boolean tlsEnabled) {\n+        return ClusterWrapper.builder()\n+                .authEnabled(authEnabled)\n+                .tlsEnabled(tlsEnabled)\n+                .tlsServerCertificatePath(pathToConfig() + SecurityConfigDefaults.TLS_SERVER_CERT_FILE_NAME)", "originalCommit": "ef00bfcefa8e62bb1614113ab5a31cd34f6a4162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM0NzY1MA==", "url": "https://github.com/pravega/pravega/pull/5250#discussion_r542347650", "bodyText": "Rearranged accordingly.", "author": "anirudhkovuru", "createdAt": "2020-12-14T12:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTgyMzQyMA=="}], "type": "inlineReview"}, {"oid": "4f412f0b22e1c08fdb70b992b006e467a645bfc5", "url": "https://github.com/pravega/pravega/commit/4f412f0b22e1c08fdb70b992b006e467a645bfc5", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-13T10:45:50Z", "type": "commit"}, {"oid": "97dfd86bceb04477d11554120eb730cbf7fe9e38", "url": "https://github.com/pravega/pravega/commit/97dfd86bceb04477d11554120eb730cbf7fe9e38", "message": "Removed token signing key, changed tests to not use AtomicReference\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-14T09:42:37Z", "type": "commit"}, {"oid": "97dfd86bceb04477d11554120eb730cbf7fe9e38", "url": "https://github.com/pravega/pravega/commit/97dfd86bceb04477d11554120eb730cbf7fe9e38", "message": "Removed token signing key, changed tests to not use AtomicReference\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-14T09:42:37Z", "type": "forcePushed"}, {"oid": "0381048093ff3f70317c77d60c132b26927aa518", "url": "https://github.com/pravega/pravega/commit/0381048093ff3f70317c77d60c132b26927aa518", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5221-secure-cli", "committedDate": "2020-12-14T09:43:10Z", "type": "commit"}, {"oid": "41242028f81bb61a32e819e248ce25318457998f", "url": "https://github.com/pravega/pravega/commit/41242028f81bb61a32e819e248ce25318457998f", "message": "Updating admin tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-14T12:10:59Z", "type": "commit"}, {"oid": "826b068ab5565edf593c9cec681c4d5da3911269", "url": "https://github.com/pravega/pravega/commit/826b068ab5565edf593c9cec681c4d5da3911269", "message": "Added TODOs\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-14T12:26:19Z", "type": "commit"}]}