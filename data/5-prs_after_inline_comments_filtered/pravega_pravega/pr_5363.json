{"pr_number": 5363, "pr_title": "Issue 4902: (SLTS) - Implement more efficient eviction cache for ReadIndexCache", "pr_createdAt": "2020-11-23T04:36:41Z", "pr_url": "https://github.com/pravega/pravega/pull/5363", "timeline": [{"oid": "6feb6be7d00a15b182b129788fd196873643e498", "url": "https://github.com/pravega/pravega/commit/6feb6be7d00a15b182b129788fd196873643e498", "message": "Issue 5067: (SLTS) - Implement more efficient eviction cache for ReadIndexCache.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-11-23T04:15:24Z", "type": "commit"}, {"oid": "a7da2f175f53b58ae8372eab25deb63b75c04b30", "url": "https://github.com/pravega/pravega/commit/a7da2f175f53b58ae8372eab25deb63b75c04b30", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-4902-SLTS-efficient-read-index-eviction", "committedDate": "2020-11-23T17:48:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA2NjMzMw==", "url": "https://github.com/pravega/pravega/pull/5363#discussion_r529066333", "bodyText": "Guava cache is synchronized. Why are you re-synchronizing?", "author": "andreipaduroiu", "createdAt": "2020-11-23T23:37:58Z", "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/ReadIndexCache.java", "diffHunk": "@@ -86,59 +65,35 @@ public ReadIndexCache(int maxIndexedSegments, int maxIndexedChunksPerSegment, in\n      * @param streamSegmentName Name of the segment.\n      * @return Read index corresponding to the given segment. A new empty index is created if it doesn't already exist.\n      */\n-    private SegmentReadIndex getSegmentReadIndex(String streamSegmentName) {\n-        SegmentReadIndex readIndex = segmentsToReadIndexMap.get(streamSegmentName);\n-\n-        if (null == readIndex) {\n-            // Evict segments if required.\n-            if (maxIndexedSegments < segmentsToReadIndexMap.size() + 1 || maxIndexedChunks < totalChunkCount.get() + 1) {\n-                evictSegmentsFromOldestGeneration();\n+    private SegmentReadIndex getSegmentReadIndex(String streamSegmentName, boolean createIfNotPresent) {\n+        SegmentReadIndex readIndex = segmentsReadIndexCache.getIfPresent(streamSegmentName);\n+        if (null == readIndex && createIfNotPresent) {\n+            synchronized (segmentsReadIndexCache) {", "originalCommit": "a7da2f175f53b58ae8372eab25deb63b75c04b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA2OTE3MQ==", "url": "https://github.com/pravega/pravega/pull/5363#discussion_r529069171", "bodyText": "Multiple threads might find that entry does not exist and might race to create the entry for the first time. (This code is invoked only once per segment). If that happens then only one instance wins and other thread is holding on to a dangling reference that will be garbage collected - thus basically loosing updates.\nI did not find clean putIfNotPresent equivalent method.", "author": "sachin-j-joshi", "createdAt": "2020-11-23T23:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA2NjMzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MDYxNA==", "url": "https://github.com/pravega/pravega/pull/5363#discussion_r529070614", "bodyText": "SimpleCache has putIfAbsent. Check it out", "author": "andreipaduroiu", "createdAt": "2020-11-23T23:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA2NjMzMw=="}], "type": "inlineReview"}, {"oid": "6ec91fa70771db79dc86af4b7282d5f83ffeb21d", "url": "https://github.com/pravega/pravega/commit/6ec91fa70771db79dc86af4b7282d5f83ffeb21d", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-4902-SLTS-efficient-read-index-eviction", "committedDate": "2020-12-02T20:58:15Z", "type": "commit"}, {"oid": "56ae292dd2c7f54a6b09aec92a37ffe579b7acb4", "url": "https://github.com/pravega/pravega/commit/56ae292dd2c7f54a6b09aec92a37ffe579b7acb4", "message": "Merge branch 'master' into issue-4902-SLTS-efficient-read-index-eviction", "committedDate": "2020-12-03T23:21:57Z", "type": "commit"}, {"oid": "0f388dd93ac3ef8bde63d199195341dce5beb628", "url": "https://github.com/pravega/pravega/commit/0f388dd93ac3ef8bde63d199195341dce5beb628", "message": "Merge branch 'master' into issue-4902-SLTS-efficient-read-index-eviction", "committedDate": "2020-12-04T16:05:13Z", "type": "commit"}, {"oid": "2dff083d8ae2d9a950cc4c9b6af92d134f952eda", "url": "https://github.com/pravega/pravega/commit/2dff083d8ae2d9a950cc4c9b6af92d134f952eda", "message": "Merge branch 'master' into issue-4902-SLTS-efficient-read-index-eviction", "committedDate": "2020-12-07T23:42:03Z", "type": "commit"}]}