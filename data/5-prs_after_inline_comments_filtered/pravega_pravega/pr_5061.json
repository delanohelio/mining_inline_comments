{"pr_number": 5061, "pr_title": "Issue 5062: Handle SegmentSealedException during Append Setup", "pr_createdAt": "2020-08-12T18:02:46Z", "pr_url": "https://github.com/pravega/pravega/pull/5061", "timeline": [{"oid": "ef4163793f3178104a6276765889898daec84f37", "url": "https://github.com/pravega/pravega/commit/ef4163793f3178104a6276765889898daec84f37", "message": "handle SegmentSealedException\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-12T17:59:41Z", "type": "commit"}, {"oid": "f2893309e1e6d126b0695753b2094a02d95f99f2", "url": "https://github.com/pravega/pravega/commit/f2893309e1e6d126b0695753b2094a02d95f99f2", "message": "change condition\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-12T19:47:45Z", "type": "commit"}, {"oid": "ed6290b9b9bc5a3764013c3c7913ba302f256745", "url": "https://github.com/pravega/pravega/commit/ed6290b9b9bc5a3764013c3c7913ba302f256745", "message": "Merge branch 'master' into issue-4351-check", "committedDate": "2020-08-12T19:49:23Z", "type": "commit"}, {"oid": "e63c8b8e757fa17bb6279253d45b4978107ed8a2", "url": "https://github.com/pravega/pravega/commit/e63c8b8e757fa17bb6279253d45b4978107ed8a2", "message": "add test: 2020-08-12 14:10:19,472 6436 [Time-limited test] WARN i.p.c.s.i.SegmentOutputStreamImpl - Segment cannot be appended because it is already sealed for writer 9481b08e-326e-4ed6-957c-3b5c343e316c ]]\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-12T21:16:35Z", "type": "commit"}, {"oid": "e75607dd15bee102d078f3a3c868ae0370bd21d9", "url": "https://github.com/pravega/pravega/commit/e75607dd15bee102d078f3a3c868ae0370bd21d9", "message": "Merge branch 'master' into issue-4351-check", "committedDate": "2020-08-13T14:46:24Z", "type": "commit"}, {"oid": "730af096d587244ece0652e8b7dac35703a92201", "url": "https://github.com/pravega/pravega/commit/730af096d587244ece0652e8b7dac35703a92201", "message": "Squashed commit of the following:\n\ncommit 9c1d4ddcb60ca010fe8ec74098cd9df55e15a09f\nAuthor: Ravi Rajamani <ravi.rajamani@emc.com>\nDate:   Wed Aug 12 16:29:41 2020 -0700\n\n    return on segment sealed in setupAppend\n\n    Signed-off-by: Ravi Rajamani <ravi.rajamani@emc.com>\n\n2020-08-14 05:24:11,519 1605 [Time-limited test] INFO  i.p.s.s.h.handler.AppendProcessor - Segment 'scope/stream/testAppendSegment' is sealed and 61919238-61ef-41e2-83b4-8af89b087e67 cannot perform append, disabling caching of attribute value...\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-14T12:26:10Z", "type": "commit"}, {"oid": "033902e3ea9d2dba29d2607400b150674237d82c", "url": "https://github.com/pravega/pravega/commit/033902e3ea9d2dba29d2607400b150674237d82c", "message": "Merge branch 'master' into issue-4351-check", "committedDate": "2020-08-14T13:13:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTU4Nw==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470661587", "bodyText": "Invoking join here will eventually lead to a thread pool exhaustion.", "author": "andreipaduroiu", "createdAt": "2020-08-14T14:34:48Z", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();", "originalCommit": "033902e3ea9d2dba29d2607400b150674237d82c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTg0OA==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470661848", "bodyText": "Also why are you doing this for successful operations?", "author": "andreipaduroiu", "createdAt": "2020-08-14T14:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3MzczMQ==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470673731", "bodyText": "Yes Andrei, I could not find SegmentSealed exception raised until here.", "author": "ravibeta", "createdAt": "2020-08-14T14:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MjU4NQ==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470662585", "bodyText": "This is an inelegant way of handling this. Please use an exceptionally clause before the whenComplete to do this.\nBetter yet, use Futures.exceptionallyComposeExpecting with StreamSegmentSealedException.class as its expected exception and add your special handling code in the callback.", "author": "andreipaduroiu", "createdAt": "2020-08-14T14:36:37Z", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {", "originalCommit": "033902e3ea9d2dba29d2607400b150674237d82c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3NDA3OA==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470674078", "bodyText": "Yes Andrei", "author": "ravibeta", "createdAt": "2020-08-14T14:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MjU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzMxOA==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470663318", "bodyText": "This should not be info.\n\"disabling caching of attribute value\" is misleading. We are not disabling anything, just passing an arg to a method. Disabling may be perceived as \"disabling across the board\".\n\nI do not see the value of this log message here since the segment store logs its calls with all args.", "author": "andreipaduroiu", "createdAt": "2020-08-14T14:37:57Z", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();\n+                            if (sp.isSealed()) {\n+                                throw new StreamSegmentSealedException(newSegment);\n+                            }\n                             long eventNumber = attributes.getOrDefault(writer, Attributes.NULL_ATTRIBUTE_VALUE);\n                             this.writerStates.putIfAbsent(Pair.of(newSegment, writer), new WriterState(eventNumber));\n                             connection.send(new AppendSetup(setupAppend.getRequestId(), newSegment, writer, eventNumber));\n                         }\n                     } catch (Throwable e) {\n-                        handleException(writer, setupAppend.getRequestId(), newSegment, \"handling setupAppend result\", e);\n+                        if (e instanceof StreamSegmentSealedException || e.getCause() instanceof StreamSegmentSealedException) {\n+                            log.info(\"Segment '{}' is sealed and {} cannot perform append, disabling caching of attribute value...\", newSegment, writer);", "originalCommit": "033902e3ea9d2dba29d2607400b150674237d82c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3NDE5Mw==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470674193", "bodyText": "Yes Andrei", "author": "ravibeta", "createdAt": "2020-08-14T14:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzM3NA==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470663374", "bodyText": "Again, you are using join", "author": "andreipaduroiu", "createdAt": "2020-08-14T14:38:05Z", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();\n+                            if (sp.isSealed()) {\n+                                throw new StreamSegmentSealedException(newSegment);\n+                            }\n                             long eventNumber = attributes.getOrDefault(writer, Attributes.NULL_ATTRIBUTE_VALUE);\n                             this.writerStates.putIfAbsent(Pair.of(newSegment, writer), new WriterState(eventNumber));\n                             connection.send(new AppendSetup(setupAppend.getRequestId(), newSegment, writer, eventNumber));\n                         }\n                     } catch (Throwable e) {\n-                        handleException(writer, setupAppend.getRequestId(), newSegment, \"handling setupAppend result\", e);\n+                        if (e instanceof StreamSegmentSealedException || e.getCause() instanceof StreamSegmentSealedException) {\n+                            log.info(\"Segment '{}' is sealed and {} cannot perform append, disabling caching of attribute value...\", newSegment, writer);\n+                            Map<UUID, Long> newAttributes = store.getAttributes(newSegment, Collections.singleton(writer), false, TIMEOUT).join();", "originalCommit": "033902e3ea9d2dba29d2607400b150674237d82c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3NDYzOQ==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470674639", "bodyText": "Yes Andrei.", "author": "ravibeta", "createdAt": "2020-08-14T14:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzkwMQ==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470663901", "bodyText": "This code looks copy pasted from above. If you use my suggestion above, you will not need this duplication.", "author": "andreipaduroiu", "createdAt": "2020-08-14T14:39:06Z", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();\n+                            if (sp.isSealed()) {\n+                                throw new StreamSegmentSealedException(newSegment);\n+                            }\n                             long eventNumber = attributes.getOrDefault(writer, Attributes.NULL_ATTRIBUTE_VALUE);\n                             this.writerStates.putIfAbsent(Pair.of(newSegment, writer), new WriterState(eventNumber));\n                             connection.send(new AppendSetup(setupAppend.getRequestId(), newSegment, writer, eventNumber));\n                         }\n                     } catch (Throwable e) {\n-                        handleException(writer, setupAppend.getRequestId(), newSegment, \"handling setupAppend result\", e);\n+                        if (e instanceof StreamSegmentSealedException || e.getCause() instanceof StreamSegmentSealedException) {\n+                            log.info(\"Segment '{}' is sealed and {} cannot perform append, disabling caching of attribute value...\", newSegment, writer);\n+                            Map<UUID, Long> newAttributes = store.getAttributes(newSegment, Collections.singleton(writer), false, TIMEOUT).join();\n+                            long eventNumber = Attributes.NULL_ATTRIBUTE_VALUE;", "originalCommit": "033902e3ea9d2dba29d2607400b150674237d82c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3NDcxMw==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470674713", "bodyText": "Yes Andrei.", "author": "ravibeta", "createdAt": "2020-08-14T14:53:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzkwMQ=="}], "type": "inlineReview"}, {"oid": "c2beb1201882fff6c3c15457be6c01d343943dbe", "url": "https://github.com/pravega/pravega/commit/c2beb1201882fff6c3c15457be6c01d343943dbe", "message": "use Futures.exceptionallyComposeExpecting\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-14T16:32:49Z", "type": "commit"}, {"oid": "afa2643a46326e56792e0f0c4dbfee2f8f8a8e01", "url": "https://github.com/pravega/pravega/commit/afa2643a46326e56792e0f0c4dbfee2f8f8a8e01", "message": "Merge branch 'master' into issue-4351-check", "committedDate": "2020-08-14T17:15:28Z", "type": "commit"}, {"oid": "68a68c828bdf53ec78b708b003bff68f0dec0798", "url": "https://github.com/pravega/pravega/commit/68a68c828bdf53ec78b708b003bff68f0dec0798", "message": "run checkstylemain again\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-14T16:40:17Z", "type": "commit"}, {"oid": "85bb2352ad4e154524658b6ff13eedc6f7a26995", "url": "https://github.com/pravega/pravega/commit/85bb2352ad4e154524658b6ff13eedc6f7a26995", "message": "add code coverage\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-16T16:48:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwNzg1NA==", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r471607854", "bodyText": "This looks good, however I want some way of logging that we are indeed running into some sealed segment. At the same time, I do not want to pollute the logs with useless messages. Looking through this class, it seems that a subsequent append via this connection-writer will stumble across a sealed segment which will take care of some logging and cleanup (OK - nothing to do there).\nI just took a look at the getAttributes call inside the Segment Store and it turns out we are not logging the cache argument. Would you mind editing line 933 in StreamSegmentContainer.java and add the cache parameter to that logRequest call please? That way we will be able to see the first and the second call in the logs with proper args.", "author": "andreipaduroiu", "createdAt": "2020-08-17T16:48:44Z", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -157,20 +157,22 @@ public void setupAppend(SetupAppend setupAppend) {\n \n         // Get the last Event Number for this writer from the Store. This operation (cache=true) will automatically put\n         // the value in the Store's cache so it's faster to access later.\n-        store.getAttributes(newSegment, Collections.singleton(writer), true, TIMEOUT)\n-                .whenComplete((attributes, u) -> {\n-                    try {\n-                        if (u != null) {\n-                            handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n-                        } else {\n-                            long eventNumber = attributes.getOrDefault(writer, Attributes.NULL_ATTRIBUTE_VALUE);\n-                            this.writerStates.putIfAbsent(Pair.of(newSegment, writer), new WriterState(eventNumber));\n-                            connection.send(new AppendSetup(setupAppend.getRequestId(), newSegment, writer, eventNumber));\n-                        }\n-                    } catch (Throwable e) {\n-                        handleException(writer, setupAppend.getRequestId(), newSegment, \"handling setupAppend result\", e);\n-                    }\n-                });\n+        Futures.exceptionallyComposeExpecting(\n+                store.getAttributes(newSegment, Collections.singleton(writer), true, TIMEOUT),\n+                e -> e instanceof StreamSegmentSealedException, () -> store.getAttributes(newSegment, Collections.singleton(writer), false, TIMEOUT))", "originalCommit": "85bb2352ad4e154524658b6ff13eedc6f7a26995", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5416f0625e192651edfe10975861d2312eaff196", "url": "https://github.com/pravega/pravega/commit/5416f0625e192651edfe10975861d2312eaff196", "message": "Merge branch 'master' into issue-4351-check", "committedDate": "2020-08-17T17:32:59Z", "type": "commit"}, {"oid": "bdcee7fb49607bb387e1c13320b561485e65f5d9", "url": "https://github.com/pravega/pravega/commit/bdcee7fb49607bb387e1c13320b561485e65f5d9", "message": "add cache parameter in logs\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-17T16:57:21Z", "type": "commit"}]}