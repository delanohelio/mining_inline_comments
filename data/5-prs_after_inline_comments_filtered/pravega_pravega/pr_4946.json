{"pr_number": 4946, "pr_title": "Issue 4944: Change granularity of Time based Retention Config in REST API", "pr_createdAt": "2020-07-15T08:43:17Z", "pr_url": "https://github.com/pravega/pravega/pull/4946", "timeline": [{"oid": "2b2312f5810cb54696edd583f8bd3a06abb851dd", "url": "https://github.com/pravega/pravega/commit/2b2312f5810cb54696edd583f8bd3a06abb851dd", "message": "Changed granularity of Time based RetentionConfig in REST API\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-15T08:31:55Z", "type": "commit"}, {"oid": "8e66b14e36f82c72316a5b4e68373a01a7802450", "url": "https://github.com/pravega/pravega/commit/8e66b14e36f82c72316a5b4e68373a01a7802450", "message": "removed LIMITED_TIME enum and added doc\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-15T12:50:12Z", "type": "commit"}, {"oid": "bce00eb11f31ccc4758c13b19874c84f4221eee2", "url": "https://github.com/pravega/pravega/commit/bce00eb11f31ccc4758c13b19874c84f4221eee2", "message": "UT fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-15T13:20:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1MzQ2OA==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r455653468", "bodyText": "this can get NPE if getTimeBasedRetention is null.. do a precondition check before accessing its fields", "author": "shiveshr", "createdAt": "2020-07-16T09:30:50Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/ModelHelper.java", "diffHunk": "@@ -57,8 +59,13 @@ public static final StreamConfiguration getCreateStreamConfig(final CreateStream\n                             createStreamRequest.getRetentionPolicy().getValue() * 1024 * 1024);\n                     break;\n                 case LIMITED_DAYS:\n-                    retentionPolicy = RetentionPolicy.byTime(\n-                            Duration.ofDays(createStreamRequest.getRetentionPolicy().getValue()));\n+                    long retentionInDays = createStreamRequest.getRetentionPolicy().getValue();\n+                    Duration retentionDuration = (retentionInDays == 0) ?\n+                            Duration.ofDays(createStreamRequest.getRetentionPolicy().getTimeBasedRetention().getDays())", "originalCommit": "bce00eb11f31ccc4758c13b19874c84f4221eee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxNTc5MQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456215791", "bodyText": "For old requests timeBasedRetention could be null..... so instead of a precondition check I have  added an explicit null check.", "author": "pbelgundi", "createdAt": "2020-07-17T04:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1MzQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1Mzc5MQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r455653791", "bodyText": "same as above", "author": "shiveshr", "createdAt": "2020-07-16T09:31:25Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/ModelHelper.java", "diffHunk": "@@ -100,8 +107,13 @@ public static final StreamConfiguration getUpdateStreamConfig(final UpdateStream\n                             updateStreamRequest.getRetentionPolicy().getValue() * 1024 * 1024);\n                     break;\n                 case LIMITED_DAYS:\n-                    retentionPolicy = RetentionPolicy.byTime(\n-                            Duration.ofDays(updateStreamRequest.getRetentionPolicy().getValue()));\n+                    long retentionInDays = updateStreamRequest.getRetentionPolicy().getValue();\n+                    Duration retentionDuration = (retentionInDays == 0) ?\n+                         Duration.ofDays(updateStreamRequest.getRetentionPolicy().getTimeBasedRetention().getDays())", "originalCommit": "bce00eb11f31ccc4758c13b19874c84f4221eee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxNTgzNw==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456215837", "bodyText": "fixed. same as above.", "author": "pbelgundi", "createdAt": "2020-07-17T04:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1Mzc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTAxMA==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r455655010", "bodyText": "please dont change generated code", "author": "shiveshr", "createdAt": "2020-07-16T09:33:28Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/generated/api/ApiOriginFilter.java", "diffHunk": "@@ -5,7 +5,7 @@\n import javax.servlet.*;\n import javax.servlet.http.HttpServletResponse;\n \n-@SuppressWarnings(\"all\")\n+", "originalCommit": "bce00eb11f31ccc4758c13b19874c84f4221eee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxNTQ0MQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456215441", "bodyText": "fixed", "author": "pbelgundi", "createdAt": "2020-07-17T04:44:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTEzNA==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r455655134", "bodyText": "please dont change generated code", "author": "shiveshr", "createdAt": "2020-07-16T09:33:39Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/generated/api/ApiException.java", "diffHunk": "@@ -1,6 +1,6 @@\n package io.pravega.controller.server.rest.generated.api;\n \n-@SuppressWarnings(\"all\")\n+", "originalCommit": "bce00eb11f31ccc4758c13b19874c84f4221eee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgwMzg0Nw==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r455803847", "bodyText": "This was not changed intentionally, but on regeneration these values did not get added... adding them back now.", "author": "pbelgundi", "createdAt": "2020-07-16T13:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxNTM5NA==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456215394", "bodyText": "fixed", "author": "pbelgundi", "createdAt": "2020-07-17T04:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTEzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTQ3Nw==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r455655477", "bodyText": "same here. revert these generated files", "author": "shiveshr", "createdAt": "2020-07-16T09:34:12Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/generated/api/ScopesApi.java", "diffHunk": "@@ -49,7 +49,7 @@ public ScopesApi(@Context ServletConfig servletContext) {\n          String implClass = servletContext.getInitParameter(\"ScopesApi.implementation\");\n          if (implClass != null && !\"\".equals(implClass.trim())) {\n             try {\n-               delegate = (ScopesApiService) Class.forName(implClass).getConstructor().newInstance();\n+               delegate = (ScopesApiService) Class.forName(implClass).newInstance();", "originalCommit": "bce00eb11f31ccc4758c13b19874c84f4221eee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxNTM2OQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456215369", "bodyText": "OK. replaced", "author": "pbelgundi", "createdAt": "2020-07-17T04:44:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTgwNg==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r455655806", "bodyText": "why is this being changed here?", "author": "shiveshr", "createdAt": "2020-07-16T09:34:49Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/generated/model/ScaleMetadata.java", "diffHunk": "@@ -34,6 +34,12 @@\n   @JsonProperty(\"segmentList\")\n   private List<Segment> segmentList = null;\n \n+  @JsonProperty(\"splits\")", "originalCommit": "bce00eb11f31ccc4758c13b19874c84f4221eee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxNTIyMw==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456215223", "bodyText": "Replaced with old code.", "author": "pbelgundi", "createdAt": "2020-07-17T04:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NTgwNg=="}], "type": "inlineReview"}, {"oid": "94bced1d51714a3106eaa14a1ca0d7b6aaf89fb9", "url": "https://github.com/pravega/pravega/commit/94bced1d51714a3106eaa14a1ca0d7b6aaf89fb9", "message": "New Unit Tests to cover all code paths\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-16T14:07:34Z", "type": "commit"}, {"oid": "f4be1b0d928d1354a5bed67869139f4340b2e1bf", "url": "https://github.com/pravega/pravega/commit/f4be1b0d928d1354a5bed67869139f4340b2e1bf", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T04:41:27Z", "type": "commit"}, {"oid": "70614245a6a5732a0093e0328cdaab76caab3ad0", "url": "https://github.com/pravega/pravega/commit/70614245a6a5732a0093e0328cdaab76caab3ad0", "message": "Merge remote-tracking branch 'upstream/master' into issue-4944-restapi-retention", "committedDate": "2020-07-17T04:51:30Z", "type": "commit"}, {"oid": "7f5d34633724de227dd1cf5a4207d3904155d792", "url": "https://github.com/pravega/pravega/commit/7f5d34633724de227dd1cf5a4207d3904155d792", "message": "test fixes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T05:15:37Z", "type": "commit"}, {"oid": "e1b62c4d6583026e5f8374cdbb1c2198c3a28d00", "url": "https://github.com/pravega/pravega/commit/e1b62c4d6583026e5f8374cdbb1c2198c3a28d00", "message": "code coverage\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T09:17:01Z", "type": "commit"}, {"oid": "c301be076033531b5edcd67fc1582d2f9ed208a0", "url": "https://github.com/pravega/pravega/commit/c301be076033531b5edcd67fc1582d2f9ed208a0", "message": "minor fixes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T09:30:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NjMwNA==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456366304", "bodyText": "the params for this method seem a bit odd, mills, hours and daysInMs.\ncan we make it consistent?", "author": "shiveshr", "createdAt": "2020-07-17T10:44:17Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/ModelHelper.java", "diffHunk": "@@ -156,4 +172,25 @@ public static final StreamProperty encodeStreamResponse(String scope, String str\n         streamProperty.setRetentionPolicy(retentionConfig);\n         return streamProperty;\n     }\n+\n+    private static RetentionPolicy getRetentionPolicy(TimeBasedRetention timeRetention, long retentionInDays) {\n+        Duration retentionDuration = (timeRetention != null && retentionInDays == 0) ?\n+                Duration.ofDays(timeRetention.getDays())\n+                        .plusHours(timeRetention.getHours())\n+                        .plusMinutes(timeRetention.getMinutes())\n+                :  Duration.ofDays(retentionInDays);\n+        return RetentionPolicy.byTime(retentionDuration);\n+    }\n+\n+    private static long getMinsFromMillis(long millis, long hours, long daysInMs) {", "originalCommit": "c301be076033531b5edcd67fc1582d2f9ed208a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM4NjQxOQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456386419", "bodyText": "I have added a javadoc and changed param names to make them more intuitive. Please check.", "author": "pbelgundi", "createdAt": "2020-07-17T11:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NjMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NjYzNQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456366635", "bodyText": "please revert this", "author": "shiveshr", "createdAt": "2020-07-17T10:45:01Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/generated/model/CreateScopeRequest.java", "diffHunk": "@@ -14,9 +14,7 @@\n package io.pravega.controller.server.rest.generated.model;\n \n import java.util.Objects;\n-", "originalCommit": "c301be076033531b5edcd67fc1582d2f9ed208a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM4NjE2Mw==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456386163", "bodyText": "fixed", "author": "pbelgundi", "createdAt": "2020-07-17T11:33:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NjYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NzMwNA==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456367304", "bodyText": "please add more details to the javadoc", "author": "shiveshr", "createdAt": "2020-07-17T10:46:39Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/generated/model/RetentionConfig.java", "diffHunk": "@@ -101,6 +105,25 @@ public void setValue(Long value) {\n     this.value = value;\n   }\n \n+  public RetentionConfig timeBasedRetention(TimeBasedRetention timeBasedRetention) {\n+    this.timeBasedRetention = timeBasedRetention;\n+    return this;\n+  }\n+\n+  /**\n+   * Get timeBasedRetention", "originalCommit": "c301be076033531b5edcd67fc1582d2f9ed208a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM4NjA5OQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456386099", "bodyText": "Ok", "author": "pbelgundi", "createdAt": "2020-07-17T11:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NzMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NzkwMQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456367901", "bodyText": "nit: revert", "author": "shiveshr", "createdAt": "2020-07-17T10:48:02Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/generated/model/ScaleMetadata.java", "diffHunk": "@@ -3,7 +3,7 @@\n  * List of admin REST APIs for the pravega controller service.\n  *\n  * OpenAPI spec version: 0.0.1", "originalCommit": "c301be076033531b5edcd67fc1582d2f9ed208a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM4NjA1Mw==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456386053", "bodyText": "reverted", "author": "pbelgundi", "createdAt": "2020-07-17T11:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2NzkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2ODIwOQ==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456368209", "bodyText": "nit: revert this whole file please", "author": "shiveshr", "createdAt": "2020-07-17T10:48:47Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/generated/model/ScaleMetadata.java", "diffHunk": "@@ -91,7 +91,7 @@ public boolean equals(java.lang.Object o) {\n     }\n     ScaleMetadata scaleMetadata = (ScaleMetadata) o;\n     return Objects.equals(this.timestamp, scaleMetadata.timestamp) &&\n-        Objects.equals(this.segmentList, scaleMetadata.segmentList);\n+            Objects.equals(this.segmentList, scaleMetadata.segmentList);", "originalCommit": "c301be076033531b5edcd67fc1582d2f9ed208a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM4NjAyMA==", "url": "https://github.com/pravega/pravega/pull/4946#discussion_r456386020", "bodyText": "done", "author": "pbelgundi", "createdAt": "2020-07-17T11:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2ODIwOQ=="}], "type": "inlineReview"}, {"oid": "9fda9cddf90d2329e4fcbf487844c5e8508ccaa6", "url": "https://github.com/pravega/pravega/commit/9fda9cddf90d2329e4fcbf487844c5e8508ccaa6", "message": "code review\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T11:06:16Z", "type": "commit"}, {"oid": "1a624a91d0d1cee5113ac71881142c6312b645e3", "url": "https://github.com/pravega/pravega/commit/1a624a91d0d1cee5113ac71881142c6312b645e3", "message": "code review fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T11:11:36Z", "type": "commit"}, {"oid": "c89aba279e6db37a59b0b152b61565621ae449aa", "url": "https://github.com/pravega/pravega/commit/c89aba279e6db37a59b0b152b61565621ae449aa", "message": "review coments impl\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T11:32:25Z", "type": "commit"}, {"oid": "0484b7111e170e7ece26bfc07a6b890290d5f8bb", "url": "https://github.com/pravega/pravega/commit/0484b7111e170e7ece26bfc07a6b890290d5f8bb", "message": "review\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T11:52:08Z", "type": "commit"}, {"oid": "ab194a960775bb6264606fc332867740ef67de65", "url": "https://github.com/pravega/pravega/commit/ab194a960775bb6264606fc332867740ef67de65", "message": "scaleMetadata\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T11:55:26Z", "type": "commit"}, {"oid": "70e56fed8631de0d9e4216013ccb2570f22be999", "url": "https://github.com/pravega/pravega/commit/70e56fed8631de0d9e4216013ccb2570f22be999", "message": "review comment\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-17T12:02:31Z", "type": "commit"}]}