{"pr_number": 4798, "pr_title": "Issue 4531: Use new BookKeeper API and Upgrade to BookKeeper 4.9.2", "pr_createdAt": "2020-05-18T20:53:58Z", "pr_url": "https://github.com/pravega/pravega/pull/4798", "timeline": [{"oid": "d045a0aebca1c25b7d1dcbeb360ba6349f597bd0", "url": "https://github.com/pravega/pravega/commit/d045a0aebca1c25b7d1dcbeb360ba6349f597bd0", "message": "Use new BookKeeper Client API and upgrade to 4.9.2 version\n\n    Change log description:\n    BookKeeper 4.8 introduced a new API (org.apache.bookkeeper.client.api).\n    The old API, LedgerHandler, is going to be deprecated officially in next upcoming release (4.11).\n    The new API is based on CompletableFuture facility of the JDK.\n    The new API allows access to the internal refcounted Netty buffer used by BK client.\n\n    Purpose of the change:\n    Fixes #4531.\n\n    Switch from using LedgerHandle to WriteHandle and ReadHandle.\n    I am changing BK version to 4.9.2.\n\n    What the code does\n    Upgrade BookKeeper to 4.9.2 in Java code (not docker images)\n    Replace usages of LedgerHandle with WriteHandle and ReadHandle.\n    Use the new CompletableFuture based API.\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-05-18T20:54:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM2MzQ3OQ==", "url": "https://github.com/pravega/pravega/pull/4798#discussion_r427363479", "bodyText": "Why did you remove the try-catch here but not below (at 237)?", "author": "andreipaduroiu", "createdAt": "2020-05-19T14:49:02Z", "path": "segmentstore/storage/impl/src/main/java/io/pravega/segmentstore/storage/impl/bookkeeper/LogReader.java", "diffHunk": "@@ -75,12 +77,7 @@\n     public void close() {\n         if (!this.closed.getAndSet(true)) {\n             if (this.currentLedger != null) {\n-                try {\n-                    Ledgers.close(this.currentLedger.handle);\n-                } catch (DurableDataLogException bkEx) {\n-                    log.error(\"Unable to close LedgerHandle for Ledger {}.\", this.currentLedger.handle.getId(), bkEx);\n-                }\n-\n+                this.currentLedger.close();", "originalCommit": "d045a0aebca1c25b7d1dcbeb360ba6349f597bd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgwNjM5Ng==", "url": "https://github.com/pravega/pravega/pull/4798#discussion_r427806396", "bodyText": "@andreipaduroiu\nbecause at line 237 we have\nLedgers.close(xxx)\nthat may throw an exception, and it is actually not possible that it happens\nhere we are using currentLedger.close(); (LogReader#close)) that calls exactly the code at line 237, and there is not need to add a catch clause.", "author": "eolivelli", "createdAt": "2020-05-20T07:46:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM2MzQ3OQ=="}], "type": "inlineReview"}, {"oid": "b5c7e64383a06b8714a7c1f5c7efe41a59f15114", "url": "https://github.com/pravega/pravega/commit/b5c7e64383a06b8714a7c1f5c7efe41a59f15114", "message": "Use new BookKeeper Client API and upgrade to 4.9.2 version\n\n    Change log description:\n    BookKeeper 4.8 introduced a new API (org.apache.bookkeeper.client.api).\n    The old API, LedgerHandler, is going to be deprecated officially in next upcoming release (4.11).\n    The new API is based on CompletableFuture facility of the JDK.\n    The new API allows access to the internal refcounted Netty buffer used by BK client.\n\n    Purpose of the change:\n    Fixes #4531.\n\n    Switch from using LedgerHandle to WriteHandle and ReadHandle.\n    I am changing BK version to 4.9.2.\n\n    What the code does\n    Upgrade BookKeeper to 4.9.2 in Java code (not docker images)\n    Replace usages of LedgerHandle with WriteHandle and ReadHandle.\n    Use the new CompletableFuture based API.\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-05-27T10:04:52Z", "type": "commit"}, {"oid": "eac3522a074a2d893ef52f6669b7edc88b03e52c", "url": "https://github.com/pravega/pravega/commit/eac3522a074a2d893ef52f6669b7edc88b03e52c", "message": "Address review comments\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-05-27T10:04:52Z", "type": "commit"}, {"oid": "66fc30db6268e460733928660e6f8da6848018e9", "url": "https://github.com/pravega/pravega/commit/66fc30db6268e460733928660e6f8da6848018e9", "message": "Clean up code and fix checkstyle\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-05-27T10:04:52Z", "type": "commit"}, {"oid": "ac483b6da812cfbced2b29aecf91fd59d439c890", "url": "https://github.com/pravega/pravega/commit/ac483b6da812cfbced2b29aecf91fd59d439c890", "message": "Give 2g of DirectMemory to tests\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-05-27T10:04:53Z", "type": "commit"}, {"oid": "ac483b6da812cfbced2b29aecf91fd59d439c890", "url": "https://github.com/pravega/pravega/commit/ac483b6da812cfbced2b29aecf91fd59d439c890", "message": "Give 2g of DirectMemory to tests\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-05-27T10:04:53Z", "type": "forcePushed"}, {"oid": "72a715ad60cf0da86f1795a8230df2bbfd08eeb8", "url": "https://github.com/pravega/pravega/commit/72a715ad60cf0da86f1795a8230df2bbfd08eeb8", "message": "set MaxDirectMemorySize to 4g\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-05-27T11:13:40Z", "type": "commit"}, {"oid": "d5d7bda6ccd53970fb9c555ee1f21664b9535408", "url": "https://github.com/pravega/pravega/commit/d5d7bda6ccd53970fb9c555ee1f21664b9535408", "message": "Merge branch 'master' into fix/upgrade-to-bk-492", "committedDate": "2020-05-28T12:59:21Z", "type": "commit"}, {"oid": "f9672bed32ca32b65b675f6ea1371713953359b5", "url": "https://github.com/pravega/pravega/commit/f9672bed32ca32b65b675f6ea1371713953359b5", "message": "Merge branch 'master' into fix/upgrade-to-bk-492", "committedDate": "2020-05-29T06:51:36Z", "type": "commit"}, {"oid": "2ecbfe579104490b7e746c696d3073402bd174c3", "url": "https://github.com/pravega/pravega/commit/2ecbfe579104490b7e746c696d3073402bd174c3", "message": "Merge branch 'master' into fix/upgrade-to-bk-492", "committedDate": "2020-06-01T10:45:03Z", "type": "commit"}, {"oid": "d98242d8865987b55a877f90c0b3d4aa03f7d457", "url": "https://github.com/pravega/pravega/commit/d98242d8865987b55a877f90c0b3d4aa03f7d457", "message": "Merge branch 'master' into fix/upgrade-to-bk-492", "committedDate": "2020-06-02T08:38:36Z", "type": "commit"}, {"oid": "f50e90802d0cd523370dfd8f8ce3c0fa8419a53a", "url": "https://github.com/pravega/pravega/commit/f50e90802d0cd523370dfd8f8ce3c0fa8419a53a", "message": "Merge branch 'master' into fix/upgrade-to-bk-492", "committedDate": "2020-06-03T23:38:43Z", "type": "commit"}, {"oid": "85722f26402dcb9d2999e3a03d2c671d31870c89", "url": "https://github.com/pravega/pravega/commit/85722f26402dcb9d2999e3a03d2c671d31870c89", "message": "Merge branch 'master' into fix/upgrade-to-bk-492", "committedDate": "2020-06-04T07:52:01Z", "type": "commit"}, {"oid": "0ee3cffc9b0d03b1e450c2f86a99939fe5cc7f01", "url": "https://github.com/pravega/pravega/commit/0ee3cffc9b0d03b1e450c2f86a99939fe5cc7f01", "message": "Use JournalSyncData = false in tests and add more debug\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-06-04T08:25:36Z", "type": "commit"}, {"oid": "747e4ac3415826da8cce5a7b18bb5a312aabb4d1", "url": "https://github.com/pravega/pravega/commit/747e4ac3415826da8cce5a7b18bb5a312aabb4d1", "message": "Increase retry timeout and count, in order to make tests less flaky on Jenkins\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-06-04T09:32:43Z", "type": "commit"}, {"oid": "6191429999eaa0c8c042fa77fa285b5592e01ad1", "url": "https://github.com/pravega/pravega/commit/6191429999eaa0c8c042fa77fa285b5592e01ad1", "message": "Revert JournalSyncData change\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-06-04T10:04:10Z", "type": "commit"}, {"oid": "f75d35b2d0aa153af4cb96786b6da4cb5e211656", "url": "https://github.com/pravega/pravega/commit/f75d35b2d0aa153af4cb96786b6da4cb5e211656", "message": "Add tests\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-06-04T13:18:52Z", "type": "commit"}, {"oid": "42dc8b8d107224fd0e493a8c77719ec3a773c545", "url": "https://github.com/pravega/pravega/commit/42dc8b8d107224fd0e493a8c77719ec3a773c545", "message": "remove useless file\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>", "committedDate": "2020-06-04T13:36:07Z", "type": "commit"}, {"oid": "497c6575f17d3b594144f0d61fba30c57feedbda", "url": "https://github.com/pravega/pravega/commit/497c6575f17d3b594144f0d61fba30c57feedbda", "message": "Merge branch 'master' into fix/upgrade-to-bk-492", "committedDate": "2020-06-04T13:36:50Z", "type": "commit"}]}