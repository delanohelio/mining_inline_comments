{"pr_number": 5244, "pr_title": "Issue 5203: Stream-Cuts get saved as \"Checkpoints\" in Reader Group State", "pr_createdAt": "2020-10-08T06:58:10Z", "pr_url": "https://github.com/pravega/pravega/pull/5244", "timeline": [{"oid": "4b680aa7adc86f30cf2a9633bc57c08aee10845d", "url": "https://github.com/pravega/pravega/commit/4b680aa7adc86f30cf2a9633bc57c08aee10845d", "message": "Changed CheckpointState for stream-cuts\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-05T06:02:03Z", "type": "commit"}, {"oid": "cb50dcf3ea9d066dfed33cd4608458def199186f", "url": "https://github.com/pravega/pravega/commit/cb50dcf3ea9d066dfed33cd4608458def199186f", "message": "updating serializer test for new CheckpointState field\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-08T06:02:42Z", "type": "commit"}, {"oid": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd", "url": "https://github.com/pravega/pravega/commit/38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix", "committedDate": "2020-10-08T06:11:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAzMzE0Nw==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503033147", "bodyText": "we should be backward compatible here, this line would throw exceptions when trying to read from data from an older client.", "author": "shrids", "createdAt": "2020-10-12T04:31:20Z", "path": "client/src/main/java/io/pravega/client/stream/impl/CheckpointState.java", "diffHunk": "@@ -246,6 +255,7 @@ private void read00(RevisionDataInput input, CheckpointStateBuilder builder) thr\n             builder.uncheckpointedHosts(input.readMap(stringDeserializer, in -> in.readCollection(stringDeserializer, ArrayList::new)));\n             builder.checkpointPositions(input.readMap(stringDeserializer, in -> in.readMap(segmentDeserializer, longDeserializer)));\n             builder.lastCheckpointPosition(input.readMap(segmentDeserializer, longDeserializer));\n+            builder.lastStreamCutPosition(input.readMap(segmentDeserializer, longDeserializer));", "originalCommit": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQyMzE1NQ==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r504423155", "bodyText": "I've added a new revision and made changes to read00 ensure backward compatibility. I've also added a test for the same in SerializationTest.", "author": "anirudhkovuru", "createdAt": "2020-10-14T06:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAzMzE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA0MjgzMw==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r506042833", "bodyText": "The field has been removed so there shouldn't be an issue in regards to backward compatibility.", "author": "anirudhkovuru", "createdAt": "2020-10-16T04:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAzMzE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAzMzM4Ng==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503033386", "bodyText": "Please add tests to verify this change...", "author": "shrids", "createdAt": "2020-10-12T04:32:21Z", "path": "client/src/main/java/io/pravega/client/stream/impl/CheckpointState.java", "diffHunk": "@@ -256,6 +266,7 @@ private void write00(CheckpointState object, RevisionDataOutput output) throws I\n             output.writeMap(object.uncheckpointedHosts, stringSerializer, (out, hosts) -> out.writeCollection(hosts, stringSerializer));\n             output.writeMap(object.checkpointPositions, stringSerializer, (out, map) -> out.writeMap(map, segmentSerializer, longSerializer));\n             output.writeMap(object.lastCheckpointPosition, segmentSerializer, longSerializer);\n+            output.writeMap(object.lastStreamCutPosition, segmentSerializer, longSerializer);", "originalCommit": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1Njk5Ng==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503956996", "bodyText": "Please add UTs and integration tests for the new code...", "author": "pbelgundi", "createdAt": "2020-10-13T13:35:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAzMzM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyNzUyMA==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r506327520", "bodyText": "Added two tests for the new code. Please have a look", "author": "anirudhkovuru", "createdAt": "2020-10-16T11:41:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAzMzM4Ng=="}], "type": "inlineReview"}, {"oid": "282c6066494e63d1ac77b8a7c707abf58c1c330c", "url": "https://github.com/pravega/pravega/commit/282c6066494e63d1ac77b8a7c707abf58c1c330c", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix", "committedDate": "2020-10-12T06:21:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxOTc4MA==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503519780", "bodyText": "This is not being used anywhere.", "author": "tkaitchuck", "createdAt": "2020-10-12T20:35:59Z", "path": "client/src/main/java/io/pravega/client/stream/impl/CheckpointState.java", "diffHunk": "@@ -64,23 +64,26 @@\n      */\n     private final Map<String, Map<Segment, Long>> checkpointPositions;\n \n+    private Map<Segment, Long> lastStreamCutPosition;", "originalCommit": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY5ODE3Mw==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503698173", "bodyText": "This field will store the positions of the last stream-cut/silent checkpoint so that it does not interfere with lastCheckpointPosition where the positions of the actual last checkpoint will be stored. So, instead of having one field store the value of both which was the case before, we have two different fields lastStreamCutPosition and lastCheckpointPosition.", "author": "anirudhkovuru", "createdAt": "2020-10-13T06:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxOTc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1NjUzNg==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503956536", "bodyText": "Another way of saying what Tom has been alluding to, is where are we really using \"lastStreamCutPosition\" ?\nWhat purpose does it serve other than not persisting StreamCut data inside lastCheckpointPosition?\nThe generateStreamCut() API in ReaderGroup, still seems to be pulling positions from some CheckpointState objects:\n\n  \n    \n      pravega/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupState.java\n    \n    \n         Line 276\n      in\n      5410d55\n    \n    \n    \n    \n\n        \n          \n           final Optional<Map<Segment, Long>> positionMap = Optional.ofNullable(checkpointState.getPositionsForCompletedCheckpoint(checkpointId)); \n        \n    \n  \n\n\nSo instead of adding this new variable, we could just skip persisting positions into lastCheckpointedPosition, if the checkpoint is a silent one......however, if a new checkpoint is created before generateStreamCut() returns, it could clear fields in checkpoint state causing us to loose those StreamCut positions. So we need to think through if & how we'd want to use lastStreamCutPosition", "author": "pbelgundi", "createdAt": "2020-10-13T13:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxOTc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM2MTA5Mw==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r506361093", "bodyText": "I've removed the field and added two tests to verify the change. In the case of stream-cuts (silent checkpoints), the lastCheckpointPosition is not updated. It only stores the value of the last checkpointed position if it is a true checkpoint.", "author": "anirudhkovuru", "createdAt": "2020-10-16T12:25:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxOTc4MA=="}], "type": "inlineReview"}, {"oid": "0340deb4b41a182713de66a30b4fdbbfc0b20d4f", "url": "https://github.com/pravega/pravega/commit/0340deb4b41a182713de66a30b4fdbbfc0b20d4f", "message": "Added new revision and backwards compatibility, new test for same\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-13T08:56:38Z", "type": "commit"}, {"oid": "08effb7fcc6520665bc792a915b2577a448e2b0e", "url": "https://github.com/pravega/pravega/commit/08effb7fcc6520665bc792a915b2577a448e2b0e", "message": "Removed lastStreamCut field\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-15T06:00:35Z", "type": "commit"}, {"oid": "12e8bb026c8c3468f9e27f54c13e1cc1f1d77b9b", "url": "https://github.com/pravega/pravega/commit/12e8bb026c8c3468f9e27f54c13e1cc1f1d77b9b", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix", "committedDate": "2020-10-15T06:01:25Z", "type": "commit"}, {"oid": "12e8bb026c8c3468f9e27f54c13e1cc1f1d77b9b", "url": "https://github.com/pravega/pravega/commit/12e8bb026c8c3468f9e27f54c13e1cc1f1d77b9b", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix", "committedDate": "2020-10-15T06:01:25Z", "type": "forcePushed"}, {"oid": "3006f5a7973ccfd3ce8637d566f6ad4064192504", "url": "https://github.com/pravega/pravega/commit/3006f5a7973ccfd3ce8637d566f6ad4064192504", "message": "Fixed checkpointstate checkstyle\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-15T06:35:11Z", "type": "commit"}, {"oid": "48bc5f22997b55710d77ee65493aa62170bf9b6b", "url": "https://github.com/pravega/pravega/commit/48bc5f22997b55710d77ee65493aa62170bf9b6b", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix", "committedDate": "2020-10-16T05:32:56Z", "type": "commit"}, {"oid": "c753e265d7308392e61d6b79f79a044b6174ccf5", "url": "https://github.com/pravega/pravega/commit/c753e265d7308392e61d6b79f79a044b6174ccf5", "message": "Added a new CheckpointStateTest\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-16T08:57:22Z", "type": "commit"}, {"oid": "c753e265d7308392e61d6b79f79a044b6174ccf5", "url": "https://github.com/pravega/pravega/commit/c753e265d7308392e61d6b79f79a044b6174ccf5", "message": "Added a new CheckpointStateTest\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-16T08:57:22Z", "type": "forcePushed"}, {"oid": "c40772363a2c066a6d7b8890b3d79c359d0c9586", "url": "https://github.com/pravega/pravega/commit/c40772363a2c066a6d7b8890b3d79c359d0c9586", "message": "Added a test in UnreadBytesTests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-10-16T10:13:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM3OTA5Ng==", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r506379096", "bodyText": "nit: remove unnecessary newline addition", "author": "pbelgundi", "createdAt": "2020-10-16T12:50:12Z", "path": "client/src/main/java/io/pravega/client/stream/impl/CheckpointState.java", "diffHunk": "@@ -138,8 +138,12 @@ void readerCheckpointed(String checkpointId, String readerName, Map<Segment, Lon\n             positions.putAll(position);\n             if (readers.isEmpty()) {\n                 uncheckpointedHosts.remove(checkpointId);\n-                //checkpoint operation completed for all readers, update the last checkpoint position.\n-                lastCheckpointPosition = checkpointPositions.get(checkpointId);\n+", "originalCommit": "c40772363a2c066a6d7b8890b3d79c359d0c9586", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}