{"pr_number": 5092, "pr_title": "Issue 5058: Cache Manager Metrics Fix", "pr_createdAt": "2020-08-21T18:10:05Z", "pr_url": "https://github.com/pravega/pravega/pull/5092", "timeline": [{"oid": "18821956cc12d42db1218feb5b70ecf1943612d4", "url": "https://github.com/pravega/pravega/commit/18821956cc12d42db1218feb5b70ecf1943612d4", "message": "* Fixes issue 5058.\n\nSigned-off-by: Colin Hryniowski <co-jo@users.noreply.github.com>", "committedDate": "2020-08-21T18:07:50Z", "type": "commit"}, {"oid": "f3330860ed2fe8c7f5bf6efbd12e021d7ef5761f", "url": "https://github.com/pravega/pravega/commit/f3330860ed2fe8c7f5bf6efbd12e021d7ef5761f", "message": "Merge branch 'master' into issue-5058-cache-manager-metrics-patch", "committedDate": "2020-08-21T18:10:14Z", "type": "commit"}, {"oid": "8bf8016017508da6537c09cc9f1c183d73776f2d", "url": "https://github.com/pravega/pravega/commit/8bf8016017508da6537c09cc9f1c183d73776f2d", "message": "* Fix checkstyle error.\n\nSigned-off-by: Colin Hryniowski <co-jo@users.noreply.github.com>", "committedDate": "2020-08-21T20:09:03Z", "type": "commit"}, {"oid": "786b3804c9fb3ca50a11018bb58ab4c795fafc4d", "url": "https://github.com/pravega/pravega/commit/786b3804c9fb3ca50a11018bb58ab4c795fafc4d", "message": "Merge remote-tracking branch 'origin/issue-5058-cache-manager-metrics-patch' into issue-5058-cache-manager-metrics-patch", "committedDate": "2020-08-21T20:09:19Z", "type": "commit"}, {"oid": "79fcfa4f3bf99f5e7ed87ecb5ec39c06bfc0ef63", "url": "https://github.com/pravega/pravega/commit/79fcfa4f3bf99f5e7ed87ecb5ec39c06bfc0ef63", "message": "* Remove removal of Meters -- as it may have unforeseen side effects.\n\nSigned-off-by: Colin Hryniowski <co-jo@users.noreply.github.com>", "committedDate": "2020-08-25T18:04:53Z", "type": "commit"}, {"oid": "7a609ae5b9b817aec490eb43505f04277ce70600", "url": "https://github.com/pravega/pravega/commit/7a609ae5b9b817aec490eb43505f04277ce70600", "message": "Merge branch 'master' into issue-5058-cache-manager-metrics-patch", "committedDate": "2020-08-25T18:07:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3ODI3MQ==", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477378271", "bodyText": "Please wait sufficient time before assertion using assert utility tools, or retry a few times here, otherwise when the testing env is slow/busy, the test may fail again from time to time.", "author": "kevinhan88", "createdAt": "2020-08-26T15:12:06Z", "path": "segmentstore/server/src/test/java/io/pravega/segmentstore/server/SegmentStoreMetricsTests.java", "diffHunk": "@@ -161,30 +161,30 @@ public void testThrottlerMetrics() {\n \n     @Test\n     public void testCacheManagerMetrics() {\n-        int storedBytes = 10000;\n-        int usedBytes = 1000;\n-        int allocatedBytes = 100;\n+        long storedBytes = 10000;\n+        long usedBytes = 1000;\n+        long allocatedBytes = 100;\n         int generationSpread = 10;\n-        int managerIterationDuration = 1;\n+        long managerIterationDuration = 1;\n \n         int containerId = new Random().nextInt(Integer.MAX_VALUE);\n         @Cleanup\n         SegmentStoreMetrics.CacheManager cache = new SegmentStoreMetrics.CacheManager();\n         cache.report(new CacheState(storedBytes, usedBytes, 0, allocatedBytes, storedBytes), generationSpread, managerIterationDuration);\n \n-        assertEquals(storedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES).value());\n-        assertEquals(usedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_USED_SIZE_BYTES).value());\n-        assertEquals(allocatedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_ALLOC_SIZE_BYTES).value());\n+        assertEquals(storedBytes, (long) MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES).value());", "originalCommit": "7a609ae5b9b817aec490eb43505f04277ce70600", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ2NDcyNA==", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477464724", "bodyText": "Same response as below.", "author": "co-jo", "createdAt": "2020-08-26T17:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3ODI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3OTI2Nw==", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477379267", "bodyText": "Similarly, wait sufficient time (or retry) before the null check - this is the reason why the test always pass locally but sometimes fail in a loaded env.", "author": "kevinhan88", "createdAt": "2020-08-26T15:13:26Z", "path": "segmentstore/server/src/test/java/io/pravega/segmentstore/server/SegmentStoreMetricsTests.java", "diffHunk": "@@ -161,30 +161,30 @@ public void testThrottlerMetrics() {\n \n     @Test\n     public void testCacheManagerMetrics() {\n-        int storedBytes = 10000;\n-        int usedBytes = 1000;\n-        int allocatedBytes = 100;\n+        long storedBytes = 10000;\n+        long usedBytes = 1000;\n+        long allocatedBytes = 100;\n         int generationSpread = 10;\n-        int managerIterationDuration = 1;\n+        long managerIterationDuration = 1;\n \n         int containerId = new Random().nextInt(Integer.MAX_VALUE);\n         @Cleanup\n         SegmentStoreMetrics.CacheManager cache = new SegmentStoreMetrics.CacheManager();\n         cache.report(new CacheState(storedBytes, usedBytes, 0, allocatedBytes, storedBytes), generationSpread, managerIterationDuration);\n \n-        assertEquals(storedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES).value());\n-        assertEquals(usedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_USED_SIZE_BYTES).value());\n-        assertEquals(allocatedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_ALLOC_SIZE_BYTES).value());\n+        assertEquals(storedBytes, (long) MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES).value());\n+        assertEquals(usedBytes, (long) MetricRegistryUtils.getGauge(MetricsNames.CACHE_USED_SIZE_BYTES).value());\n+        assertEquals(allocatedBytes, (long) MetricRegistryUtils.getGauge(MetricsNames.CACHE_ALLOC_SIZE_BYTES).value());\n         assertEquals(generationSpread, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_GENERATION_SPREAD).value());\n-        assertEquals(managerIterationDuration, (int) MetricRegistryUtils.getTimer(MetricsNames.CACHE_MANAGER_ITERATION_DURATION).mean(TimeUnit.MILLISECONDS));\n+        assertEquals(managerIterationDuration, (long) MetricRegistryUtils.getTimer(MetricsNames.CACHE_MANAGER_ITERATION_DURATION).mean(TimeUnit.MILLISECONDS));\n \n         cache.close();\n \n         assertNull(MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES));", "originalCommit": "7a609ae5b9b817aec490eb43505f04277ce70600", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ2NDUzNQ==", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477464535", "bodyText": "The failure was due to the metric being declared as static as mentioned in the description. Is there anything about this specific metric that warrants a timeout (as opposed to others). I feel like we should be consistent in defining how we perceive success/failure across all the metrics. I don't notice many metrics relying on retries or timeouts.", "author": "co-jo", "createdAt": "2020-08-26T17:22:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3OTI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzODUwNw==", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477538507", "bodyText": "The failure was caused by not closing metrics after CacheManager is closed, as the code shows.\nStatic metrics registry is a design dilemma of Micrometer, which might be enhanced, however it's not the direct cause.\nWe've experienced the null assertion problem (not the random number caused by not closing metrics properly), due to the test code talked to registry too soon, before the registry was able to finish the processing. Since we do have assertion tools to address the concern, then why not take this opportunity to make the test robust? - Isn't this fix part of the effort trying to recover from a recent test disaster due to hostile test env?\nRemember in production code, metrics registry doesn't need to talk back to application code. So it is test code's responsibility to ensure things happen as expected.", "author": "kevinhan88", "createdAt": "2020-08-26T19:28:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3OTI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2MTM1OQ==", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477561359", "bodyText": "No, that was not the cause of the failure. The direct cause (for the issue introduced with this new metric) was because the metric was declared as static.", "author": "co-jo", "createdAt": "2020-08-26T20:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3OTI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4MDQ2Nw==", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477580467", "bodyText": "Ok, I thought you were talking about \"static\" metric registry.", "author": "kevinhan88", "createdAt": "2020-08-26T20:49:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3OTI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYwMTk4MQ==", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r478601981", "bodyText": "There were two issues with the PR that updated the CacheManager metric:\n\nDeclaring the metric as static. Depending on various timings, the logger likely resolves to a NullStatsLogger before the metrics provider is initialized, preventing any updates to the metric.\nThe CacheManager metrics was not closed, leading to potential residual metrics being reported between disjoint tests.\n\nThis PR is not necessarily to make the test as robust as possible. I would prefer to address any timing issues with the assert statements in a separate issue as it is not related to issues related to this PR (or the PR prompting this one). Many other metrics would have the same problem and it should be addressed with a new issue.", "author": "co-jo", "createdAt": "2020-08-27T18:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3OTI2Nw=="}], "type": "inlineReview"}, {"oid": "266a1c375825fbd93bf0cb0a3e100ba8acad9d72", "url": "https://github.com/pravega/pravega/commit/266a1c375825fbd93bf0cb0a3e100ba8acad9d72", "message": "Merge branch 'master' into issue-5058-cache-manager-metrics-patch", "committedDate": "2020-08-26T19:05:28Z", "type": "commit"}, {"oid": "b14c69938bf064329c8a20ed61f4088699e7c5d2", "url": "https://github.com/pravega/pravega/commit/b14c69938bf064329c8a20ed61f4088699e7c5d2", "message": "Merge branch 'master' into issue-5058-cache-manager-metrics-patch", "committedDate": "2020-08-28T16:28:05Z", "type": "commit"}]}