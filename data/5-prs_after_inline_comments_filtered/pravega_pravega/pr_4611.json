{"pr_number": 4611, "pr_title": "Issue 4610: (SegmentStore) Read Index data corruption during concurrent segment merge and cache eviction.", "pr_createdAt": "2020-03-10T21:18:29Z", "pr_url": "https://github.com/pravega/pravega/pull/4611", "timeline": [{"oid": "3aaaf73a95f4b8e3d0162e220cac719cae2a09e9", "url": "https://github.com/pravega/pravega/commit/3aaaf73a95f4b8e3d0162e220cac719cae2a09e9", "message": "Fixed a bug where a concurrent segment merge and cache eviction could corrupt the index.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-03-10T21:00:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNzM2Mg==", "url": "https://github.com/pravega/pravega/pull/4611#discussion_r390637362", "bodyText": "It says \"gets a copy\" but then later says they are removed, so, it's not really a copy.", "author": "tkaitchuck", "createdAt": "2020-03-10T22:03:14Z", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/reading/StreamSegmentReadIndex.java", "diffHunk": "@@ -1192,24 +1192,33 @@ private ReadResultEntryBase createFutureRead(long streamSegmentOffset, int maxLe\n     }\n \n     /**\n-     * Gets a copy of all the ReadIndexEntries in this Index that are not RedirectReadIndices. All returned\n-     * entries have their offsets adjusted by the given amount.\n+     * Gets a copy of all the ReadIndexEntries in this Index that are not RedirectReadIndices and removes them from this", "originalCommit": "3aaaf73a95f4b8e3d0162e220cac719cae2a09e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MTMxMw==", "url": "https://github.com/pravega/pravega/pull/4611#discussion_r390671313", "bodyText": "Reworded.", "author": "andreipaduroiu", "createdAt": "2020-03-10T23:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNzM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNzgyNg==", "url": "https://github.com/pravega/pravega/pull/4611#discussion_r390637826", "bodyText": "This should probably be called \"removeAllEntries\"", "author": "tkaitchuck", "createdAt": "2020-03-10T22:04:25Z", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/reading/StreamSegmentReadIndex.java", "diffHunk": "@@ -1192,24 +1192,33 @@ private ReadResultEntryBase createFutureRead(long streamSegmentOffset, int maxLe\n     }\n \n     /**\n-     * Gets a copy of all the ReadIndexEntries in this Index that are not RedirectReadIndices. All returned\n-     * entries have their offsets adjusted by the given amount.\n+     * Gets a copy of all the ReadIndexEntries in this Index that are not RedirectReadIndices and removes them from this\n+     * index. All returned entries have their offsets adjusted by the given amount.\n      *\n      * @param offsetAdjustment The amount to adjust the offset by.\n+     * @return A List of {@link MergedIndexEntry} that represents the contents of this index. All these entries point to\n+     * live data in the {@link CacheManager}; as such it is the responsibility of the caller to manage their lifecycle\n+     * from now on.\n      */\n-    private List<MergedIndexEntry> getAllEntries(long offsetAdjustment) {\n+    private List<MergedIndexEntry> fetchAllEntries(long offsetAdjustment) {", "originalCommit": "3aaaf73a95f4b8e3d0162e220cac719cae2a09e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1NDE2MA==", "url": "https://github.com/pravega/pravega/pull/4611#discussion_r390654160", "bodyText": "Is this change intentional?", "author": "RaulGracia", "createdAt": "2020-03-10T22:45:00Z", "path": "segmentstore/server/src/test/java/io/pravega/segmentstore/server/reading/ContainerReadIndexTests.java", "diffHunk": "@@ -91,7 +91,7 @@\n             .with(ReadIndexConfig.MEMORY_READ_MIN_LENGTH, 0) // Default: Off (we have a special test for this).\n             .with(ReadIndexConfig.STORAGE_READ_ALIGNMENT, 1024)\n             .build();\n-    private static final Duration TIMEOUT = Duration.ofSeconds(20);\n+    private static final Duration TIMEOUT = Duration.ofSeconds(2000000);", "originalCommit": "3aaaf73a95f4b8e3d0162e220cac719cae2a09e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MjI4OQ==", "url": "https://github.com/pravega/pravega/pull/4611#discussion_r390672289", "bodyText": "No it is not. Fixed it.", "author": "andreipaduroiu", "createdAt": "2020-03-10T23:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1NDE2MA=="}], "type": "inlineReview"}, {"oid": "c07c8f6c37a717c32209300b1946666bfcc45298", "url": "https://github.com/pravega/pravega/commit/c07c8f6c37a717c32209300b1946666bfcc45298", "message": "Renamed method.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-03-10T23:38:20Z", "type": "commit"}, {"oid": "a5ec2f973fcbcb2a86711e8ad138d381a6838bcd", "url": "https://github.com/pravega/pravega/commit/a5ec2f973fcbcb2a86711e8ad138d381a6838bcd", "message": "Reverted timeout\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-03-10T23:39:50Z", "type": "commit"}, {"oid": "96d8c13d8704786f13de51722907f46261a3b1a5", "url": "https://github.com/pravega/pravega/commit/96d8c13d8704786f13de51722907f46261a3b1a5", "message": "checkstyle\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-03-11T04:01:08Z", "type": "commit"}, {"oid": "eb9cac08d0579ffa7f75f78c458bbcddec5819df", "url": "https://github.com/pravega/pravega/commit/eb9cac08d0579ffa7f75f78c458bbcddec5819df", "message": "Merge branch 'master' into issue-4610-read-index", "committedDate": "2020-03-11T08:26:27Z", "type": "commit"}]}