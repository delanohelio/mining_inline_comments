{"pr_number": 4582, "pr_title": "Issue-4581: replaced the unsafe while loop with iterator looping", "pr_createdAt": "2020-02-27T23:41:53Z", "pr_url": "https://github.com/pravega/pravega/pull/4582", "timeline": [{"oid": "295a8922b89c3cfd80b2992c8a39ca6f97a6d9e1", "url": "https://github.com/pravega/pravega/commit/295a8922b89c3cfd80b2992c8a39ca6f97a6d9e1", "message": "Issue-4581: replaced the unsafe while loop with iterator looping\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>", "committedDate": "2020-02-27T23:37:59Z", "type": "commit"}, {"oid": "295a8922b89c3cfd80b2992c8a39ca6f97a6d9e1", "url": "https://github.com/pravega/pravega/commit/295a8922b89c3cfd80b2992c8a39ca6f97a6d9e1", "message": "Issue-4581: replaced the unsafe while loop with iterator looping\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>", "committedDate": "2020-02-27T23:37:59Z", "type": "forcePushed"}, {"oid": "cd07934ae65721ffa9f60f1182486a4261ae8729", "url": "https://github.com/pravega/pravega/commit/cd07934ae65721ffa9f60f1182486a4261ae8729", "message": "Merge branch 'master' into issue-4581", "committedDate": "2020-02-28T08:27:26Z", "type": "commit"}, {"oid": "8b2eb855b62124446410b0b09927b0f0f000620b", "url": "https://github.com/pravega/pravega/commit/8b2eb855b62124446410b0b09927b0f0f000620b", "message": "Merge branch 'master' into issue-4581", "committedDate": "2020-02-28T15:21:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1NTMyMg==", "url": "https://github.com/pravega/pravega/pull/4582#discussion_r385755322", "bodyText": "I don't understand how this is any different from the code before. for(X : Y) is invoking Y.iterator() and looping through it.\nWhat am I missing?", "author": "andreipaduroiu", "createdAt": "2020-02-28T15:23:00Z", "path": "shared/metrics/src/main/java/io/pravega/shared/metrics/StatsProviderImpl.java", "diffHunk": "@@ -75,9 +77,12 @@ public void start() {\n     @Synchronized\n     @Override\n     public void startWithoutExporting() {\n-        for (MeterRegistry registry : metrics.getRegistries()) {\n-            metrics.remove(registry);\n+\n+        Iterator<MeterRegistry> iterator = metrics.getRegistries().iterator();", "originalCommit": "8b2eb855b62124446410b0b09927b0f0f000620b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzNzA1OA==", "url": "https://github.com/pravega/pravega/pull/4582#discussion_r385837058", "bodyText": "FWIW, I get the same failure with the new code (my line numbers will be different):\n    java.util.ConcurrentModificationException\n        at java.util.IdentityHashMap$IdentityHashMapIterator.nextIndex(IdentityHashMap.java:735)\n        at java.util.IdentityHashMap$KeyIterator.next(IdentityHashMap.java:826)\n        at java.util.Collections$UnmodifiableCollection$1.next(Collections.java:1044)\n        at io.pravega.shared.metrics.StatsProviderImpl.startWithoutExporting(StatsProviderImpl.java:85)\n        at io.pravega.shared.metrics.StatsProviderProxy.startWithoutExporting(StatsProviderProxy.java:45)\n        at io.pravega.shared.metrics.MetricsProviderTest.setUp(MetricsProviderTest.java:35)\n\nIs this test working on some machines?", "author": "derekm", "createdAt": "2020-02-28T17:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1NTMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg5MjUwMQ==", "url": "https://github.com/pravega/pravega/pull/4582#discussion_r385892501", "bodyText": "the latest change fixes it for me: io.pravega.shared.metrics.MetricsProviderTest > testGauge PASSED", "author": "derekm", "createdAt": "2020-02-28T19:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1NTMyMg=="}], "type": "inlineReview"}, {"oid": "630c88bf30ae672d1e3dd13eedcf5f5aef3c660c", "url": "https://github.com/pravega/pravega/commit/630c88bf30ae672d1e3dd13eedcf5f5aef3c660c", "message": "Issue 4581: kept improving the handling of registry deletion\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>", "committedDate": "2020-02-28T19:13:13Z", "type": "commit"}, {"oid": "44ea37bc51ada25c06722c9e6082afcb4c63f330", "url": "https://github.com/pravega/pravega/commit/44ea37bc51ada25c06722c9e6082afcb4c63f330", "message": "Merge branch 'issue-4581' of https://github.com/kevinhan88/pravega into issue-4581", "committedDate": "2020-02-28T19:14:32Z", "type": "commit"}]}