{"pr_number": 5366, "pr_title": "Issue 5360: Require permissions on the scope for creating Key-Value Tables", "pr_createdAt": "2020-11-24T00:56:33Z", "pr_url": "https://github.com/pravega/pravega/pull/5366", "timeline": [{"oid": "9ef1f71fd472f6389c90726ab09eb544eeb4c3aa", "url": "https://github.com/pravega/pravega/commit/9ef1f71fd472f6389c90726ab09eb544eeb4c3aa", "message": "Modify resource string used for Key-Value Tables creation\n\nSigned-off-by: rsharda <ravi.sharda@emc.com>", "committedDate": "2020-11-24T00:51:00Z", "type": "commit"}, {"oid": "9023f0dfd956529d563072d6379a4189eaaf0d7e", "url": "https://github.com/pravega/pravega/commit/9023f0dfd956529d563072d6379a4189eaaf0d7e", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-11-24T04:52:48Z", "type": "commit"}, {"oid": "ddebef2624063e3bf91afb4297e56e12583bf196", "url": "https://github.com/pravega/pravega/commit/ddebef2624063e3bf91afb4297e56e12583bf196", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-11-25T01:11:50Z", "type": "commit"}, {"oid": "2f91abfae2a9bba8441d9f699c87e4dde39d2a15", "url": "https://github.com/pravega/pravega/commit/2f91abfae2a9bba8441d9f699c87e4dde39d2a15", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-11-30T02:04:10Z", "type": "commit"}, {"oid": "a3f702764b90e3069352fc9a9ec12a562aa634f2", "url": "https://github.com/pravega/pravega/commit/a3f702764b90e3069352fc9a9ec12a562aa634f2", "message": "Move test class to appropriate module so that tests are accounted for in test coverage\n\nSigned-off-by: rsharda <ravi.sharda@emc.com>", "committedDate": "2020-11-30T09:03:13Z", "type": "commit"}, {"oid": "608c821797be74565175046d388d210305f911df", "url": "https://github.com/pravega/pravega/commit/608c821797be74565175046d388d210305f911df", "message": "Merge remote-tracking branch 'origin/issue-5360-key-value-tables-create-permissions' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-11-30T09:03:26Z", "type": "commit"}, {"oid": "475da6ba0e7c67ed00c5f168d8e135d5cb7c7bd3", "url": "https://github.com/pravega/pravega/commit/475da6ba0e7c67ed00c5f168d8e135d5cb7c7bd3", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-11-30T10:39:55Z", "type": "commit"}, {"oid": "358181278ace58b434d732249d5fa67e761d4746", "url": "https://github.com/pravega/pravega/commit/358181278ace58b434d732249d5fa67e761d4746", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-12-01T00:58:01Z", "type": "commit"}, {"oid": "2484c4184543f064d6109915dcc3dd07277bd0af", "url": "https://github.com/pravega/pravega/commit/2484c4184543f064d6109915dcc3dd07277bd0af", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-12-01T09:00:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNjM0NQ==", "url": "https://github.com/pravega/pravega/pull/5366#discussion_r533936345", "bodyText": "Since only 'scope' is taken as arg to this method, please remove 'kvtname' from javadoc", "author": "pbelgundi", "createdAt": "2020-12-02T06:59:30Z", "path": "shared/security/src/main/java/io/pravega/shared/security/auth/AuthorizationResource.java", "diffHunk": "@@ -90,6 +90,16 @@\n      */\n     String ofReaderGroupInScope(String scopeName, String readerGroupName);\n \n+    /**\n+     * Creates a resource representation for use in authorization of actions pertaining to the collection of Key-Value\n+     * tables within the specified scope.\n+     *\n+     * @param scopeName the name of the scope\n+     * @throws NullPointerException if {@code scopeName} or {@code kvtName} are null", "originalCommit": "2484c4184543f064d6109915dcc3dd07277bd0af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNjI2MQ==", "url": "https://github.com/pravega/pravega/pull/5366#discussion_r534036261", "bodyText": "Sure, I've fixed it in the latest commit.", "author": "ravisharda", "createdAt": "2020-12-02T09:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNjM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzOTYyMg==", "url": "https://github.com/pravega/pravega/pull/5366#discussion_r533939622", "bodyText": "Not just create but listKeyValueTablesInScope also needs to look at \"scope\" permissions instead of \"scope + kvt\" permissions", "author": "pbelgundi", "createdAt": "2020-12-02T07:07:57Z", "path": "controller/src/main/java/io/pravega/controller/server/rpc/grpc/v1/ControllerServiceImpl.java", "diffHunk": "@@ -146,7 +146,7 @@ public void createKeyValueTable(KeyValueTableConfig request, StreamObserver<Crea\n                 scope, kvt);\n         log.info(requestTag.getRequestId(), \"createKeyValueTable called for KVTable {}/{}.\", scope, kvt);\n         authenticateExecuteAndProcessResults(() -> this.grpcAuthHelper.checkAuthorizationAndCreateToken(\n-                authorizationResource.ofKeyValueTableInScope(scope, kvt), AuthHandler.Permissions.READ_UPDATE),\n+                authorizationResource.ofKeyValueTablesInScope(scope), AuthHandler.Permissions.READ_UPDATE),", "originalCommit": "2484c4184543f064d6109915dcc3dd07277bd0af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk0NzIxMQ==", "url": "https://github.com/pravega/pravega/pull/5366#discussion_r533947211", "bodyText": "I see that lisStreamsInScope (ControllerServiceImpl) uses authorizationResource.ofStreamInScope(scopeName, x)\nwhere as StreamMetadataResourceImpl.listStreams uses authorizationResource.ofStreamsInScope(scopeName)...\nI believe create/list operations should be based on permissions for parent resource - scope (in case of Streams/KVTs)", "author": "pbelgundi", "createdAt": "2020-12-02T07:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzOTYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzMzk2Mg==", "url": "https://github.com/pravega/pravega/pull/5366#discussion_r534033962", "bodyText": "listKeyValueTablesInScope appears to be using the same model that we have applied in other listing operations like listScopes and listStreamsInScope, and looks OK to me. The general rule for applying authorization in listing operations is:\n\nRequire READ permission on the parent resource. (to check whether the user is allowed to invoke the listing operation in the first place)\nFilter in objects for which the user explicitly has READ access on. (so that only authorized objects are returned among the population of all objects).\n\nTo illustrate the general rule, taking an example of listStreamsInScope operation, say:\n\nuser1 has been assigned READ permission on scope1 and scope1/stream2.\nuser2 has been assigned READ on scope1.\nuser3 has been assigned READ on scope2`.\nThe system has 3 streams under the scope - say, scope1/stream1,  scope1/stream2 and  scope1/stream3\n\nThe listStreamsInScope will return:\n\nA list containing a single stream stream2 for user1`\nAn empty list for user2\nAn authorization exception for user3.\n\nA similar rule seems to have been applied for Key-Value tables listing, which looks good to me.\nNow, switching to StreamMetadataResourceImpl.listStreams, it has a similar rule too, which is correct:\n\nIt first checks if the user has read access:\n\n  \n    \n      pravega/controller/src/main/java/io/pravega/controller/server/rest/resources/StreamMetadataResourceImpl.java\n    \n    \n        Lines 530 to 531\n      in\n      0e77c81\n    \n    \n    \n    \n\n        \n          \n           restAuthHelper.authorize(authHeader, \n        \n\n        \n          \n                   authorizationResource.ofStreamsInScope(scopeName), principal, READ); \n        \n    \n  \n\n\nIt then adds only authorized streams into the list of returned items:\n\n  \n    \n      pravega/controller/src/main/java/io/pravega/controller/server/rest/resources/StreamMetadataResourceImpl.java\n    \n    \n        Lines 545 to 546\n      in\n      0e77c81\n    \n    \n    \n    \n\n        \n          \n           if (restAuthHelper.isAuthorized(authHeader, authorizationResource.ofStreamInScope(scopeName, stream), \n        \n\n        \n          \n                   principal, READ)) { \n        \n    \n  \n\n\n\nSo, the behaviors of the listing operations look OK to me. Am I missing something?", "author": "ravisharda", "createdAt": "2020-12-02T09:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzOTYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA1OTU1Nw==", "url": "https://github.com/pravega/pravega/pull/5366#discussion_r534059557", "bodyText": "Thanks for explaining. It looks fine to me.", "author": "pbelgundi", "createdAt": "2020-12-02T10:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzOTYyMg=="}], "type": "inlineReview"}, {"oid": "f24786de5a732e3996f266df194a60b958192c3b", "url": "https://github.com/pravega/pravega/commit/f24786de5a732e3996f266df194a60b958192c3b", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-12-02T09:07:55Z", "type": "commit"}, {"oid": "71d1fbb5c5d8c4975c6efa4a4f1bfc24c33ed5d8", "url": "https://github.com/pravega/pravega/commit/71d1fbb5c5d8c4975c6efa4a4f1bfc24c33ed5d8", "message": "Address review comment\n\nSigned-off-by: rsharda <ravi.sharda@emc.com>", "committedDate": "2020-12-02T09:55:32Z", "type": "commit"}, {"oid": "12bc16dd4862e90b0940a9d4b64fa4fb1959b9d0", "url": "https://github.com/pravega/pravega/commit/12bc16dd4862e90b0940a9d4b64fa4fb1959b9d0", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-12-03T02:09:23Z", "type": "commit"}, {"oid": "903437221792eb5cddff6adc9d8ecf1488404809", "url": "https://github.com/pravega/pravega/commit/903437221792eb5cddff6adc9d8ecf1488404809", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-12-04T01:01:29Z", "type": "commit"}, {"oid": "035a40fc241f7bbad8bd80fd399cf0a115602335", "url": "https://github.com/pravega/pravega/commit/035a40fc241f7bbad8bd80fd399cf0a115602335", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-12-04T08:52:29Z", "type": "commit"}, {"oid": "f4b6e5d5a4a391c2da6500c4b8353538a29a00a4", "url": "https://github.com/pravega/pravega/commit/f4b6e5d5a4a391c2da6500c4b8353538a29a00a4", "message": "Merge branch 'master' into issue-5360-key-value-tables-create-permissions", "committedDate": "2020-12-06T16:58:00Z", "type": "commit"}]}