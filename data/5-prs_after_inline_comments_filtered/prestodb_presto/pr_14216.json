{"pr_number": 14216, "pr_title": "Allow forcing streaming exchange for Mark Distinct", "pr_createdAt": "2020-03-05T17:50:48Z", "pr_url": "https://github.com/prestodb/presto/pull/14216", "timeline": [{"oid": "74252001693488e9eb14fd2365369cd296d454c8", "url": "https://github.com/prestodb/presto/commit/74252001693488e9eb14fd2365369cd296d454c8", "message": "Add stream mark distinct with LBM session property", "committedDate": "2020-03-05T21:12:58Z", "type": "forcePushed"}, {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "url": "https://github.com/prestodb/presto/commit/76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "message": "Add stream mark distinct with LBM session property", "committedDate": "2020-03-06T22:15:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5MzEyNA==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389793124", "bodyText": "Curious why it's called PARTITIONING_PRECISION_STRATEGY? -- didn't see discussion in #13354 ?\nSince when I see \"precision\", I am thinking whether the \"partitioning\" is accurate or not. However, in this case it's about whether we want to use ALL the columns required by join/aggregation, while any partitioning with SUBSET* of the columns would work.", "author": "wenleix", "createdAt": "2020-03-09T16:07:05Z", "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/optimizations/TestAddExchangesPlans.java", "diffHunk": "@@ -422,9 +422,7 @@ void assertExactDistributedPlan(String sql, PlanMatchPattern pattern)\n                 TestingSession.testSessionBuilder()\n                         .setCatalog(\"local\")\n                         .setSchema(\"tiny\")\n-                        .setSystemProperty(\n-                                SystemSessionProperties.PARTITIONING_PRECISION_STRATEGY,\n-                                FeaturesConfig.PartitioningPrecisionStrategy.PREFER_EXACT_PARTITIONING.toString())\n+                        .setSystemProperty(PARTITIONING_PRECISION_STRATEGY, PREFER_EXACT_PARTITIONING.toString())", "originalCommit": "05ab259710959c12e465787a66378585ddd6b310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5NTgzOQ==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r390395839", "bodyText": "We have a limited set of columns we can choose to partition on and the order matters. It must be partitioned on a prefix of the columns in the order used in the join/aggregation.\nSo we have different options for choosing whether to prefer precisely partitioning on all the columns (until the Presto learns to do a better job), or allowing Presto to choose (automatic).\nPrecision doesn't mean inaccurate especially in math and engineering. It just means accurate up to a point. The partitioning always needs to be accurate we just have a choice as to how big a prefix of columns to choose.\nI don't really care what it's called, but it made sense to me at the time.", "author": "aweisberg", "createdAt": "2020-03-10T15:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5MzEyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3Mjk2MA==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389872960", "bodyText": "nit: What about useStreamExchangeForMarkDistinct?", "author": "wenleix", "createdAt": "2020-03-09T18:14:39Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryManagerConfig.java", "diffHunk": "@@ -44,6 +44,7 @@\n     private int hashPartitionCount = 100;\n     private String partitioningProviderCatalog = GlobalSystemConnector.NAME;\n     private ExchangeMaterializationStrategy exchangeMaterializationStrategy = ExchangeMaterializationStrategy.NONE;\n+    private boolean streamMarkDistinctWithMaterializedExchange;", "originalCommit": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5MzE2MQ==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r391093161", "bodyText": "You are right technically that is what this does. I'll change to that.", "author": "aweisberg", "createdAt": "2020-03-11T16:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3Mjk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3MzIzMw==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389873233", "bodyText": "ditto, query.use-stream-exchange-for-mark-distinct", "author": "wenleix", "createdAt": "2020-03-09T18:15:08Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryManagerConfig.java", "diffHunk": "@@ -162,6 +163,20 @@ public ExchangeMaterializationStrategy getExchangeMaterializationStrategy()\n         return exchangeMaterializationStrategy;\n     }\n \n+    @Config(\"query.stream-mark-distinct-with-materialized-exchange\")", "originalCommit": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3Mzg0Nw==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389873847", "bodyText": "nit: useStreamExchangeForMarkDitinct as variable name ? :)", "author": "wenleix", "createdAt": "2020-03-09T18:16:11Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -1379,7 +1380,8 @@ private Partitioning createPartitioning(Collection<VariableReferenceExpression>\n         //   materialized exchange is supported for all nodes.\n         private Scope selectExchangeScopeForPartitionedRemoteExchange(PlanNode exchangeSource, boolean nullsAndAnyReplicated)\n         {\n-            if (nullsAndAnyReplicated || exchangeSource.getOutputVariables().isEmpty()) {\n+            boolean streamMarkDistinct = SystemSessionProperties.isStreamMarkDistinctWithMaterializedExchangeEnabled(session);", "originalCommit": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NDQ5Mw==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389874493", "bodyText": "Will this make ALL exchange to be streaming when useStreamExchangeForMarkDistinct is set? -- I expect to see some condition based on plan node? :)", "author": "wenleix", "createdAt": "2020-03-09T18:17:19Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -1379,7 +1380,8 @@ private Partitioning createPartitioning(Collection<VariableReferenceExpression>\n         //   materialized exchange is supported for all nodes.\n         private Scope selectExchangeScopeForPartitionedRemoteExchange(PlanNode exchangeSource, boolean nullsAndAnyReplicated)\n         {\n-            if (nullsAndAnyReplicated || exchangeSource.getOutputVariables().isEmpty()) {\n+            boolean streamMarkDistinct = SystemSessionProperties.isStreamMarkDistinctWithMaterializedExchangeEnabled(session);\n+            if (nullsAndAnyReplicated || exchangeSource.getOutputVariables().isEmpty() || streamMarkDistinct) {", "originalCommit": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3OTk5Nw==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r390379997", "bodyText": "Yes, I completely forgot that it would be used from multiple places. Will fix it.", "author": "aweisberg", "createdAt": "2020-03-10T15:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NDQ5Mw=="}], "type": "inlineReview"}, {"oid": "35c8f4117cfa1ef28c604051f2240cbab11c4917", "url": "https://github.com/prestodb/presto/commit/35c8f4117cfa1ef28c604051f2240cbab11c4917", "message": "Add stream mark distinct with LBM session property", "committedDate": "2020-03-10T15:08:12Z", "type": "forcePushed"}, {"oid": "58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9", "url": "https://github.com/prestodb/presto/commit/58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9", "message": "Add stream mark distinct with LBM session property", "committedDate": "2020-03-10T15:28:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc0OTM1OQ==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r390749359", "bodyText": "nit: static import", "author": "arhimondr", "createdAt": "2020-03-11T05:12:49Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -318,10 +319,15 @@ public PlanWithProperties visitMarkDistinct(MarkDistinctNode node, PreferredProp\n \n             if (child.getProperties().isSingleNode() ||\n                     !isStreamPartitionedOn(child.getProperties(), node.getDistinctVariables())) {\n+                boolean useStreamingExchangeWithMarkDistinct =\n+                        SystemSessionProperties.isStreamMarkDistinctWithMaterializedExchangeEnabled(session);", "originalCommit": "58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc0OTY5Mg==", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r390749692", "bodyText": "nit: It should be fine to inline it after the static import is applied", "author": "arhimondr", "createdAt": "2020-03-11T05:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc0OTM1OQ=="}], "type": "inlineReview"}, {"oid": "412ad855b885b91204cd574348551564665c5d9a", "url": "https://github.com/prestodb/presto/commit/412ad855b885b91204cd574348551564665c5d9a", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled.", "committedDate": "2020-03-11T17:18:51Z", "type": "forcePushed"}, {"oid": "c7071fe749b11d668095e868cf02dc6ef2c5125b", "url": "https://github.com/prestodb/presto/commit/c7071fe749b11d668095e868cf02dc6ef2c5125b", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled.", "committedDate": "2020-03-11T19:09:50Z", "type": "forcePushed"}, {"oid": "10bb97162169d44ad8269a3f5be3346736cb5468", "url": "https://github.com/prestodb/presto/commit/10bb97162169d44ad8269a3f5be3346736cb5468", "message": "Use static imports in TestAddExchangePlans", "committedDate": "2020-03-11T19:12:10Z", "type": "commit"}, {"oid": "48aa36235070e40a42d889e7ce2c84780cc0f6b8", "url": "https://github.com/prestodb/presto/commit/48aa36235070e40a42d889e7ce2c84780cc0f6b8", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled.", "committedDate": "2020-03-11T19:13:09Z", "type": "forcePushed"}, {"oid": "1e124c4aa1de49345d33c8df382a089d7f5a710b", "url": "https://github.com/prestodb/presto/commit/1e124c4aa1de49345d33c8df382a089d7f5a710b", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled.", "committedDate": "2020-03-11T20:25:14Z", "type": "commit"}, {"oid": "1e124c4aa1de49345d33c8df382a089d7f5a710b", "url": "https://github.com/prestodb/presto/commit/1e124c4aa1de49345d33c8df382a089d7f5a710b", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled.", "committedDate": "2020-03-11T20:25:14Z", "type": "forcePushed"}]}