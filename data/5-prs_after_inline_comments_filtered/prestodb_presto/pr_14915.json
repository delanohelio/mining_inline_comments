{"pr_number": 14915, "pr_title": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit", "pr_createdAt": "2020-07-29T05:53:23Z", "pr_url": "https://github.com/prestodb/presto/pull/14915", "timeline": [{"oid": "4cb60861f44106ee515c7ecde756ac498ff2c424", "url": "https://github.com/prestodb/presto/commit/4cb60861f44106ee515c7ecde756ac498ff2c424", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-07-29T20:54:56Z", "type": "forcePushed"}, {"oid": "16f67a3ad20ba4361be76f48bebdbc144902e006", "url": "https://github.com/prestodb/presto/commit/16f67a3ad20ba4361be76f48bebdbc144902e006", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-07-29T21:26:00Z", "type": "forcePushed"}, {"oid": "237c0b027c3cd1d50101afa59e61562e897e52be", "url": "https://github.com/prestodb/presto/commit/237c0b027c3cd1d50101afa59e61562e897e52be", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-07-29T21:54:38Z", "type": "forcePushed"}, {"oid": "915e3e54f543365467696fd42e1e69a2991146d1", "url": "https://github.com/prestodb/presto/commit/915e3e54f543365467696fd42e1e69a2991146d1", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-07-30T01:04:09Z", "type": "forcePushed"}, {"oid": "01ef4073c67a347cb9ed48fa3c89bacefa128ed9", "url": "https://github.com/prestodb/presto/commit/01ef4073c67a347cb9ed48fa3c89bacefa128ed9", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-07-30T05:54:10Z", "type": "forcePushed"}, {"oid": "1ea2d7cd39682d417221ed9aa00761ce5394d010", "url": "https://github.com/prestodb/presto/commit/1ea2d7cd39682d417221ed9aa00761ce5394d010", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-07-30T18:36:38Z", "type": "forcePushed"}, {"oid": "3c4b57f6310f638f6c64b44096ce211dc5d0b39c", "url": "https://github.com/prestodb/presto/commit/3c4b57f6310f638f6c64b44096ce211dc5d0b39c", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-07-30T21:16:57Z", "type": "forcePushed"}, {"oid": "b6e735db3e53a67dda8e2e2e0d22db2cb01657b6", "url": "https://github.com/prestodb/presto/commit/b6e735db3e53a67dda8e2e2e0d22db2cb01657b6", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-08-03T06:23:40Z", "type": "forcePushed"}, {"oid": "de71aadfd33bdf5024fee715f457ff64432578c1", "url": "https://github.com/prestodb/presto/commit/de71aadfd33bdf5024fee715f457ff64432578c1", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-08-03T17:18:34Z", "type": "forcePushed"}, {"oid": "318a1b9d9f6a5a9483d03c95b3516ab13e9691a1", "url": "https://github.com/prestodb/presto/commit/318a1b9d9f6a5a9483d03c95b3516ab13e9691a1", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-08-12T06:18:12Z", "type": "forcePushed"}, {"oid": "c98107bf5b9d08a291e70b8d6d050cb5be8c564f", "url": "https://github.com/prestodb/presto/commit/c98107bf5b9d08a291e70b8d6d050cb5be8c564f", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-08-17T23:02:03Z", "type": "forcePushed"}, {"oid": "cd080017abc84ce87e97b697e91811b1a0fb5a55", "url": "https://github.com/prestodb/presto/commit/cd080017abc84ce87e97b697e91811b1a0fb5a55", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-08-18T00:33:55Z", "type": "forcePushed"}, {"oid": "b77e70e7e891e7f7096018a678785b448f59a855", "url": "https://github.com/prestodb/presto/commit/b77e70e7e891e7f7096018a678785b448f59a855", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-08-19T03:27:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2ODIwMQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r473268201", "bodyText": "when would this e true.  this doesn't seem related to sort nodes.  Maybe it should be its own rule to replace subplans that would return zero rows with an empty values.", "author": "rschlussel", "createdAt": "2020-08-19T19:27:22Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/RemoveRedundantSort.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.ValuesNode;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.facebook.presto.sql.planner.plan.SortNode;\n+import com.google.common.collect.ImmutableList;\n+\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isAtMost;\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isScalar;\n+import static com.facebook.presto.sql.planner.plan.Patterns.sort;\n+\n+public class RemoveRedundantSort\n+        implements Rule<SortNode>\n+{\n+    private static final Pattern<SortNode> PATTERN = sort();\n+\n+    @Override\n+    public Pattern<SortNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(SortNode node, Captures captures, Context context)\n+    {\n+        if (isAtMost(node.getSource(), context.getLookup(), 0)) {", "originalCommit": "b77e70e7e891e7f7096018a678785b448f59a855", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ1MjQ3NQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r487452475", "bodyText": "So the new rule is EvaluateZeroCount which evaluates zeroSample, zero-topN, zero-limit, and zero-distinctLimit count.", "author": "fgwang7w", "createdAt": "2020-09-12T21:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2ODIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1MDYyNA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r491150624", "bodyText": "don't need this if block anymore.", "author": "rschlussel", "createdAt": "2020-09-18T19:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2ODIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2ODQ0MQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r473268441", "bodyText": "if we change the isAtMost(0) rule to be separate, then this should be isAtMostScalar()", "author": "rschlussel", "createdAt": "2020-08-19T19:27:50Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/RemoveRedundantSort.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.ValuesNode;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.facebook.presto.sql.planner.plan.SortNode;\n+import com.google.common.collect.ImmutableList;\n+\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isAtMost;\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isScalar;\n+import static com.facebook.presto.sql.planner.plan.Patterns.sort;\n+\n+public class RemoveRedundantSort\n+        implements Rule<SortNode>\n+{\n+    private static final Pattern<SortNode> PATTERN = sort();\n+\n+    @Override\n+    public Pattern<SortNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(SortNode node, Captures captures, Context context)\n+    {\n+        if (isAtMost(node.getSource(), context.getLookup(), 0)) {\n+            return Result.ofPlanNode(new ValuesNode(node.getId(), node.getOutputVariables(), ImmutableList.of()));\n+        }\n+        if (isScalar(node.getSource(), context.getLookup())) {", "originalCommit": "b77e70e7e891e7f7096018a678785b448f59a855", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ1Mjg1OQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r487452859", "bodyText": "Since the new rule does not implement a particular planNode, my take is to remain this code as it is to lookup from the tree and can be verified by testForZeroCardinality", "author": "fgwang7w", "createdAt": "2020-09-12T22:00:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2ODQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2ODczMg==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r473268732", "bodyText": "same comment as above regarding zero and scalar", "author": "rschlussel", "createdAt": "2020-08-19T19:28:30Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/RemoveRedundantTopN.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.TopNNode;\n+import com.facebook.presto.spi.plan.ValuesNode;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.facebook.presto.sql.planner.plan.SortNode;\n+import com.google.common.collect.ImmutableList;\n+\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isAtMost;\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isScalar;\n+import static com.facebook.presto.sql.planner.plan.Patterns.topN;\n+\n+/**\n+ * Replace TopN node\n+ * 1. With a Sort node when the subplan is guaranteed to produce fewer rows than N\n+ * 2. With its source when the subplan produces only one row\n+ * 3. With a empty ValuesNode when N is 0\n+ */\n+public class RemoveRedundantTopN\n+        implements Rule<TopNNode>\n+{\n+    private static final Pattern<TopNNode> PATTERN = topN();\n+\n+    @Override\n+    public Pattern<TopNNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(TopNNode node, Captures captures, Context context)\n+    {\n+        if (node.getCount() == 0) {", "originalCommit": "b77e70e7e891e7f7096018a678785b448f59a855", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ1Mjg3NQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r487452875", "bodyText": "this check is moved to the new rule now", "author": "fgwang7w", "createdAt": "2020-09-12T22:00:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2ODczMg=="}], "type": "inlineReview"}, {"oid": "a28c846f895b28e2a0ff2a4cf5a7a368bc1da5ed", "url": "https://github.com/prestodb/presto/commit/a28c846f895b28e2a0ff2a4cf5a7a368bc1da5ed", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-09-03T02:34:38Z", "type": "forcePushed"}, {"oid": "500dbe99c91d74f805ba0382273c5669ef21af89", "url": "https://github.com/prestodb/presto/commit/500dbe99c91d74f805ba0382273c5669ef21af89", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-09-03T05:37:18Z", "type": "forcePushed"}, {"oid": "af6d37d86d2fd02d52c84739ed05721b90fbf7aa", "url": "https://github.com/prestodb/presto/commit/af6d37d86d2fd02d52c84739ed05721b90fbf7aa", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441 and https://github.com/prestosql/presto/pull/818\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com> Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-09-03T21:32:59Z", "type": "forcePushed"}, {"oid": "f9d6b145db77be2bc4ca18a502ff9a5e73a67f7c", "url": "https://github.com/prestodb/presto/commit/f9d6b145db77be2bc4ca18a502ff9a5e73a67f7c", "message": "fix comment", "committedDate": "2020-09-11T07:52:09Z", "type": "forcePushed"}, {"oid": "3678ea226cff5462a41588493e943fe3af37c1e6", "url": "https://github.com/prestodb/presto/commit/3678ea226cff5462a41588493e943fe3af37c1e6", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit when relation is know to single row or less rows than requested\n\nCherry-pick of https://github.com/prestosql/presto/pull/441\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-09-12T22:03:11Z", "type": "forcePushed"}, {"oid": "c42ce5272883ae7f6fdfec1296c23a9c2bec7411", "url": "https://github.com/prestodb/presto/commit/c42ce5272883ae7f6fdfec1296c23a9c2bec7411", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818", "committedDate": "2020-09-13T03:14:19Z", "type": "forcePushed"}, {"oid": "a2105e8a454d98c97b5301ae5727bb0d3ec8978c", "url": "https://github.com/prestodb/presto/commit/a2105e8a454d98c97b5301ae5727bb0d3ec8978c", "message": "fix ut", "committedDate": "2020-09-14T01:09:22Z", "type": "forcePushed"}, {"oid": "27255182ebb832d9c9a81c966893a90da950f850", "url": "https://github.com/prestodb/presto/commit/27255182ebb832d9c9a81c966893a90da950f850", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818", "committedDate": "2020-09-14T16:51:54Z", "type": "forcePushed"}, {"oid": "4a67797195c33b4fc0843791175b1814073a0ff1", "url": "https://github.com/prestodb/presto/commit/4a67797195c33b4fc0843791175b1814073a0ff1", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818", "committedDate": "2020-09-15T17:28:07Z", "type": "forcePushed"}, {"oid": "e75391c436498a1e6b8fb0e5290153877055b74b", "url": "https://github.com/prestodb/presto/commit/e75391c436498a1e6b8fb0e5290153877055b74b", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818", "committedDate": "2020-09-15T17:50:01Z", "type": "forcePushed"}, {"oid": "98a884419c1f2cc5c120403f15c22a90491be2db", "url": "https://github.com/prestodb/presto/commit/98a884419c1f2cc5c120403f15c22a90491be2db", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818", "committedDate": "2020-09-15T18:42:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1MDMwOA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r491150308", "bodyText": "you don't need this anymore.", "author": "rschlussel", "createdAt": "2020-09-18T19:30:18Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/RemoveRedundantLimit.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.LimitNode;\n+import com.facebook.presto.spi.plan.ValuesNode;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.google.common.collect.ImmutableList;\n+\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isAtMost;\n+import static com.facebook.presto.sql.planner.plan.Patterns.limit;\n+\n+/**\n+ * Remove Limit node when the subplan is guaranteed to produce fewer rows than the limit and\n+ * replace the plan with empty values if the limit count is 0.\n+ */\n+public class RemoveRedundantLimit\n+        implements Rule<LimitNode>\n+{\n+    // Applies to both LimitNode with ties and LimitNode without ties.\n+    private static final Pattern<LimitNode> PATTERN = limit();\n+\n+    @Override\n+    public Pattern<LimitNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(LimitNode limit, Captures captures, Context context)\n+    {\n+        if (limit.getCount() == 0) {", "originalCommit": "f2a76ff6257544cc47e56184bfd2d231d200870c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4NDEyNg==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r494684126", "bodyText": "yes, this check not needed, removed", "author": "fgwang7w", "createdAt": "2020-09-25T00:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1MDMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1MDkzNg==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r491150936", "bodyText": "use isAtMostScalar()", "author": "rschlussel", "createdAt": "2020-09-18T19:31:37Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/RemoveRedundantTopN.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.TopNNode;\n+import com.facebook.presto.spi.plan.ValuesNode;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.facebook.presto.sql.planner.plan.SortNode;\n+import com.google.common.collect.ImmutableList;\n+\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isAtMost;\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isScalar;\n+import static com.facebook.presto.sql.planner.plan.Patterns.topN;\n+\n+/**\n+ * Replace TopN node\n+ * 1. With a Sort node when the subplan is guaranteed to produce fewer rows than N\n+ * 2. With its source when the subplan produces only one row\n+ * 3. With a empty ValuesNode when N is 0\n+ */\n+public class RemoveRedundantTopN\n+        implements Rule<TopNNode>\n+{\n+    private static final Pattern<TopNNode> PATTERN = topN();\n+\n+    @Override\n+    public Pattern<TopNNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(TopNNode node, Captures captures, Context context)\n+    {\n+        if (isScalar(node.getSource(), context.getLookup())) {", "originalCommit": "f2a76ff6257544cc47e56184bfd2d231d200870c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1MzQ2NQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r491153465", "bodyText": "Don't use PlanOptimizer for new optimizer rules.  Instead (and instead of deprecating the EvaluateZeroLimit and EvaluateZeroSample rule), create a new Iterative Rule for each of these other cases that you are adding.", "author": "rschlussel", "createdAt": "2020-09-18T19:37:38Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/EvaluateZeroCount.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package com.facebook.presto.sql.planner.optimizations;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.spi.WarningCollector;\n+import com.facebook.presto.spi.plan.*;\n+import com.facebook.presto.sql.planner.PlanVariableAllocator;\n+import com.facebook.presto.sql.planner.TypeProvider;\n+import com.facebook.presto.sql.planner.plan.SampleNode;\n+import com.facebook.presto.sql.planner.plan.SimplePlanRewriter;\n+import com.google.common.collect.ImmutableList;\n+\n+public class EvaluateZeroCount\n+    implements PlanOptimizer", "originalCommit": "f2a76ff6257544cc47e56184bfd2d231d200870c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4ODE3MA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r494688170", "bodyText": "ok will create new iterative rules for each case. So is it recommended not to create new PlanOplanizer for new rule? or is there any limitation on using planOptimizer?", "author": "fgwang7w", "createdAt": "2020-09-25T00:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1MzQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1NDUyOQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r491154529", "bodyText": "update the comment to remove bullet 3 since it's now a part of a different optimizer rule and update bullet 2 to say at most one row.", "author": "rschlussel", "createdAt": "2020-09-18T19:40:14Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/RemoveRedundantTopN.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.TopNNode;\n+import com.facebook.presto.spi.plan.ValuesNode;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.facebook.presto.sql.planner.plan.SortNode;\n+import com.google.common.collect.ImmutableList;\n+\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isAtMost;\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isScalar;\n+import static com.facebook.presto.sql.planner.plan.Patterns.topN;\n+\n+/**\n+ * Replace TopN node\n+ * 1. With a Sort node when the subplan is guaranteed to produce fewer rows than N\n+ * 2. With its source when the subplan produces only one row\n+ * 3. With a empty ValuesNode when N is 0", "originalCommit": "f2a76ff6257544cc47e56184bfd2d231d200870c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcwMDg3Nw==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r494700877", "bodyText": "fixed", "author": "fgwang7w", "createdAt": "2020-09-25T01:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1NDUyOQ=="}], "type": "inlineReview"}, {"oid": "6720b52e1fe615f8c6967de653b51d9a8ee8b000", "url": "https://github.com/prestodb/presto/commit/6720b52e1fe615f8c6967de653b51d9a8ee8b000", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818", "committedDate": "2020-09-25T01:53:35Z", "type": "forcePushed"}, {"oid": "fbd50bb72bc4393b4f1564c538991d5bc2e5f3c9", "url": "https://github.com/prestodb/presto/commit/fbd50bb72bc4393b4f1564c538991d5bc2e5f3c9", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818", "committedDate": "2020-09-25T06:22:57Z", "type": "forcePushed"}, {"oid": "f7136147c4f35182e2986c55b4188ed5f8bc5e16", "url": "https://github.com/prestodb/presto/commit/f7136147c4f35182e2986c55b4188ed5f8bc5e16", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818", "committedDate": "2020-09-25T17:01:45Z", "type": "forcePushed"}, {"oid": "fbf7bc09df0f15412b1c7857a99b9b7cf1d5bc56", "url": "https://github.com/prestodb/presto/commit/fbf7bc09df0f15412b1c7857a99b9b7cf1d5bc56", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-09-29T18:01:39Z", "type": "forcePushed"}, {"oid": "05641decfe7fba9875ac7125c9885ba320237d3a", "url": "https://github.com/prestodb/presto/commit/05641decfe7fba9875ac7125c9885ba320237d3a", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author by: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-10-07T05:10:53Z", "type": "forcePushed"}, {"oid": "eb2f4e4c9034128c654a95c1e232cba52559d411", "url": "https://github.com/prestodb/presto/commit/eb2f4e4c9034128c654a95c1e232cba52559d411", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author by: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-10-07T15:41:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI4NTgxMQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r503285811", "bodyText": "we don't use .* imports.  Can you change this back to explicitly listing all the optimizers", "author": "rschlussel", "createdAt": "2020-10-12T13:11:12Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -109,27 +113,7 @@\n import com.facebook.presto.sql.planner.iterative.rule.TransformUncorrelatedInPredicateSubqueryToSemiJoin;\n import com.facebook.presto.sql.planner.iterative.rule.TransformUncorrelatedLateralToJoin;\n import com.facebook.presto.sql.planner.iterative.rule.TranslateExpressions;\n-import com.facebook.presto.sql.planner.optimizations.AddExchanges;\n-import com.facebook.presto.sql.planner.optimizations.AddLocalExchanges;\n-import com.facebook.presto.sql.planner.optimizations.ApplyConnectorOptimization;\n-import com.facebook.presto.sql.planner.optimizations.CheckSubqueryNodesAreRewritten;\n-import com.facebook.presto.sql.planner.optimizations.HashGenerationOptimizer;\n-import com.facebook.presto.sql.planner.optimizations.ImplementIntersectAndExceptAsUnion;\n-import com.facebook.presto.sql.planner.optimizations.IndexJoinOptimizer;\n-import com.facebook.presto.sql.planner.optimizations.LimitPushDown;\n-import com.facebook.presto.sql.planner.optimizations.MetadataDeleteOptimizer;\n-import com.facebook.presto.sql.planner.optimizations.MetadataQueryOptimizer;\n-import com.facebook.presto.sql.planner.optimizations.OptimizeMixedDistinctAggregations;\n-import com.facebook.presto.sql.planner.optimizations.PlanOptimizer;\n-import com.facebook.presto.sql.planner.optimizations.PredicatePushDown;\n-import com.facebook.presto.sql.planner.optimizations.PruneUnreferencedOutputs;\n-import com.facebook.presto.sql.planner.optimizations.PushdownSubfields;\n-import com.facebook.presto.sql.planner.optimizations.ReplicateSemiJoinInDelete;\n-import com.facebook.presto.sql.planner.optimizations.SetFlatteningOptimizer;\n-import com.facebook.presto.sql.planner.optimizations.StatsRecordingPlanOptimizer;\n-import com.facebook.presto.sql.planner.optimizations.TransformQuantifiedComparisonApplyToLateralJoin;\n-import com.facebook.presto.sql.planner.optimizations.UnaliasSymbolReferences;\n-import com.facebook.presto.sql.planner.optimizations.WindowFilterPushDown;\n+import com.facebook.presto.sql.planner.optimizations.*;", "originalCommit": "126729c3227522f1f5ab238466fce3760dfd00ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3NDk4Nw==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504174987", "bodyText": "shouldn't be deprecated", "author": "rschlussel", "createdAt": "2020-10-13T18:36:00Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/EvaluateZeroLimit.java", "diffHunk": "@@ -23,6 +23,7 @@\n import static com.facebook.presto.sql.planner.plan.Patterns.Limit.count;\n import static com.facebook.presto.sql.planner.plan.Patterns.limit;\n \n+@Deprecated", "originalCommit": "126729c3227522f1f5ab238466fce3760dfd00ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3NTA4NQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504175085", "bodyText": "shouldn't be deprecated", "author": "rschlussel", "createdAt": "2020-10-13T18:36:08Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/EvaluateZeroSample.java", "diffHunk": "@@ -26,6 +26,7 @@\n /**\n  * Replaces 0% sample node with empty values node.\n  */\n+@Deprecated", "originalCommit": "126729c3227522f1f5ab238466fce3760dfd00ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3Nzk1Mg==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504177952", "bodyText": "deleting the newline should be part of the commit that adds this class", "author": "rschlussel", "createdAt": "2020-10-13T18:41:26Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/EvaluateZeroDistinctLimit.java", "diffHunk": "@@ -1,4 +1,3 @@\n-\n /*", "originalCommit": "eb2f4e4c9034128c654a95c1e232cba52559d411", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEzNDMyNQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r513134325", "bodyText": "my apology could you please elaborate a little bit? I am unsure what you mean by this \"deleting this newline?", "author": "fgwang7w", "createdAt": "2020-10-28T01:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3Nzk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU2MTg3Nw==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r513561877", "bodyText": "If you look at the changes commit by commit, you'll see that the commit \"Avoid planning unnecessary sort\" has a change that removes an extra line at the start of EvaluteZeroLimit.java.  This should be done in the previous commit where the class is added (i.e. don't have the extra line in the first place)", "author": "rschlussel", "createdAt": "2020-10-28T15:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3Nzk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg2MDM3OA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r513860378", "bodyText": "understood, fixed now in first commit", "author": "fgwang7w", "createdAt": "2020-10-29T01:29:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3Nzk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3ODE3OQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504178179", "bodyText": "this change should be part of the commit that adds this class", "author": "rschlussel", "createdAt": "2020-10-13T18:41:52Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/RemoveRedundantTopN.java", "diffHunk": "@@ -25,9 +25,8 @@\n \n /**\n  * Replace TopN node\n- * 1. With a Sort node when the subplan is guaranteed to produce fewer rows than N\n- * 2. With its source when the subplan produces only one row\n- * 3. With a empty ValuesNode when N is 0\n+ * 1. With its source when the subplan is at most one row", "originalCommit": "eb2f4e4c9034128c654a95c1e232cba52559d411", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwNTE0OA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542105148", "bodyText": "ok will move to the 2nd commit, along with its corresponding test", "author": "fgwang7w", "createdAt": "2020-12-14T04:32:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3ODE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3OTUwMQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504179501", "bodyText": "what's with this todo", "author": "rschlussel", "createdAt": "2020-10-13T18:44:19Z", "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/iterative/rule/TestRemoveRedundantTopN.java", "diffHunk": "@@ -81,6 +82,7 @@ public void testZeroTopN()\n                                                 ImmutableList.of(\n                                                         constantExpressions(BIGINT, 1L, 10L),\n                                                         constantExpressions(BIGINT, 2L, 11L))))))\n+                // TODO: verify contents", "originalCommit": "eb2f4e4c9034128c654a95c1e232cba52559d411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3OTU3Mg==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504179572", "bodyText": "why is this commented out?", "author": "rschlussel", "createdAt": "2020-10-13T18:44:26Z", "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/iterative/rule/TestRemoveRedundantTopN.java", "diffHunk": "@@ -70,6 +70,7 @@ public void test()\n     public void testZeroTopN()\n     {\n         tester().assertThat(new EvaluateZeroTopN())\n+                //tester().assertThat(new RemoveRedundantTopN())", "originalCommit": "eb2f4e4c9034128c654a95c1e232cba52559d411", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEzNjI1Ng==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r513136256", "bodyText": "comment out the incorrect class to test, remove comment", "author": "fgwang7w", "createdAt": "2020-10-28T02:05:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3OTU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3OTk0NQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504179945", "bodyText": "can you share more about this change? Also, it should be in the previous commit.", "author": "rschlussel", "createdAt": "2020-10-13T18:45:09Z", "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/iterative/rule/TestEvaluateZeroLimit.java", "diffHunk": "@@ -33,8 +33,7 @@ public void testDoesNotFire()\n                 .on(p ->\n                         p.limit(\n                                 1,\n-                                p.values(p.variable(\"a\"))))\n-                .doesNotFire();\n+                                p.values(p.variable(\"a\"))));", "originalCommit": "eb2f4e4c9034128c654a95c1e232cba52559d411", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEzNjg1Ng==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r513136856", "bodyText": "this was left out unintensionally. added back.", "author": "fgwang7w", "createdAt": "2020-10-28T02:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3OTk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4MDM0OA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504180348", "bodyText": "This belongs in the previous commit.", "author": "rschlussel", "createdAt": "2020-10-13T18:45:53Z", "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/iterative/rule/TestEvaluateZeroSample.java", "diffHunk": "@@ -35,8 +35,7 @@ public void testDoesNotFire()\n                         p.sample(\n                                 0.15,\n                                 Type.BERNOULLI,\n-                                p.values(p.variable(\"a\"))))\n-                .doesNotFire();\n+                                p.values(p.variable(\"a\"))));", "originalCommit": "eb2f4e4c9034128c654a95c1e232cba52559d411", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxNzgxMw==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542917813", "bodyText": "fixed", "author": "fgwang7w", "createdAt": "2020-12-14T23:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4MDM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4MDU0OQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r504180549", "bodyText": "this should be in the previous commit and in the evaluateZeroLimit test", "author": "rschlussel", "createdAt": "2020-10-13T18:46:14Z", "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/iterative/rule/TestRemoveRedundantLimit.java", "diffHunk": "@@ -79,7 +79,7 @@ public void testForZeroLimit()\n     @Test\n     public void doesNotFire()\n     {\n-        tester().assertThat(new RemoveRedundantLimit())\n+        tester().assertThat(new EvaluateZeroLimit())", "originalCommit": "eb2f4e4c9034128c654a95c1e232cba52559d411", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwNjczNw==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542106737", "bodyText": "yes fixed", "author": "fgwang7w", "createdAt": "2020-12-14T04:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4MDU0OQ=="}], "type": "inlineReview"}, {"oid": "30aad5d91817a2d9b5a25349109cbdce0116e449", "url": "https://github.com/prestodb/presto/commit/30aad5d91817a2d9b5a25349109cbdce0116e449", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-10-29T02:45:01Z", "type": "forcePushed"}, {"oid": "a189b815db531c8578ae5fe91cd60db00bee2142", "url": "https://github.com/prestodb/presto/commit/a189b815db531c8578ae5fe91cd60db00bee2142", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-11-06T07:31:13Z", "type": "forcePushed"}, {"oid": "b871fe8268f411eb5e12541ad84dfc31faff4d0d", "url": "https://github.com/prestodb/presto/commit/b871fe8268f411eb5e12541ad84dfc31faff4d0d", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-11-06T17:50:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI5OTA0OQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r540299049", "bodyText": "nit: remove this change.", "author": "rschlussel", "createdAt": "2020-12-10T16:14:53Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/EvaluateZeroSample.java", "diffHunk": "@@ -26,6 +26,7 @@\n /**\n  * Replaces 0% sample node with empty values node.\n  */\n+", "originalCommit": "581957b1074062b96e651a18a0719b29446e1f9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwNDcyMA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542104720", "bodyText": "ok", "author": "fgwang7w", "createdAt": "2020-12-14T04:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI5OTA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwNjQ5OQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542106499", "bodyText": "removed", "author": "fgwang7w", "createdAt": "2020-12-14T04:37:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI5OTA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwMDc1OQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r540300759", "bodyText": "the string should be skip_redundant_sort to match the config property and variable name.", "author": "rschlussel", "createdAt": "2020-12-10T16:17:04Z", "path": "presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java", "diffHunk": "@@ -170,6 +170,7 @@\n     public static final String INLINE_SQL_FUNCTIONS = \"inline_sql_functions\";\n     public static final String REMOTE_FUNCTIONS_ENABLED = \"remote_functions_enabled\";\n     public static final String CHECK_ACCESS_CONTROL_ON_UTILIZED_COLUMNS_ONLY = \"check_access_control_on_utilized_columns_only\";\n+    public static final String SKIP_REDUNDANT_SORT = \"remove_redundant_sort\";", "originalCommit": "b871fe8268f411eb5e12541ad84dfc31faff4d0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyMTIzMA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542121230", "bodyText": "yes they should be the same,fixed", "author": "fgwang7w", "createdAt": "2020-12-14T05:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwMDc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwMjc5OA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r540302798", "bodyText": "this should go in the previous commit (undoing the accidental formatting changes you made there).", "author": "rschlussel", "createdAt": "2020-12-10T16:18:59Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -186,6 +186,20 @@ public PlanOptimizers(\n                 taskCountEstimator);\n     }\n \n+    @PostConstruct\n+    public void initialize()", "originalCommit": "b871fe8268f411eb5e12541ad84dfc31faff4d0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyMzMwNg==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542123306", "bodyText": "there's an issue to move these two methods, fixed", "author": "fgwang7w", "createdAt": "2020-12-14T05:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwMjc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwMzM0OA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r540303348", "bodyText": "this belongs in the previous commit where DistinctLimit was introduced.", "author": "rschlussel", "createdAt": "2020-12-10T16:19:40Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/plan/Patterns.java", "diffHunk": "@@ -261,6 +253,14 @@ private Patterns() {}\n         }\n     }\n \n+    public static class DistinctLimit", "originalCommit": "b871fe8268f411eb5e12541ad84dfc31faff4d0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyMzY2MA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542123660", "bodyText": "fixed", "author": "fgwang7w", "createdAt": "2020-12-14T05:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwMzM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwNDAzMQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r540304031", "bodyText": "why is this test removed?", "author": "rschlussel", "createdAt": "2020-12-10T16:20:33Z", "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestOrderByQueries.java", "diffHunk": "@@ -241,12 +240,6 @@ public void testUndistributedOrderBy()\n         assertQueryOrdered(undistributedOrderBy, \"SELECT orderstatus FROM orders ORDER BY orderstatus\");\n     }\n \n-    @Test\n-    public void testOrderLimitCompaction()\n-    {\n-        assertQueryOrdered(\"SELECT * FROM (SELECT * FROM orders ORDER BY orderkey) LIMIT 10\");", "originalCommit": "b871fe8268f411eb5e12541ad84dfc31faff4d0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyNDgyMA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542124820", "bodyText": "actually this is working as design because ORDER BY in a subquery can be ignored. Rows in a table (or in a subquery in the FROM clause) do not come in any specific order, only when ORDER BY ... LIMIT changes the result, the set of rows.", "author": "fgwang7w", "createdAt": "2020-12-14T05:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwNDAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwNDc5MA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r540304790", "bodyText": "why is this test removed?", "author": "rschlussel", "createdAt": "2020-12-10T16:21:31Z", "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestOrderByQueries.java", "diffHunk": "@@ -80,7 +80,6 @@ public void testOrderByWithOutputColumnReference()\n         assertQueryOrdered(\"SELECT max(a) FROM (values (1,2), (2,1)) t(a,b) GROUP BY b ORDER BY b\", \"VALUES 2, 1\");\n         assertQueryOrdered(\"SELECT max(a) FROM (values (1,2), (2,1)) t(a,b) GROUP BY t.b ORDER BY t.b*1.0\", \"VALUES 2, 1\");\n         assertQueryOrdered(\"SELECT -(a+b) AS a, -(a+b) AS b, a+b FROM (values (41, 42), (-41, -42)) t(a,b) GROUP BY a+b ORDER BY a+b\", \"VALUES (-83, -83, 83), (83, 83, -83)\");\n-        assertQueryOrdered(\"SELECT c.a FROM (SELECT CAST(ROW(-a.a) AS ROW(a BIGINT)) a FROM (VALUES (2), (1)) a(a) GROUP BY a.a ORDER BY a.a) t(c)\", \"VALUES -2, -1\");", "originalCommit": "b871fe8268f411eb5e12541ad84dfc31faff4d0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEyNDc3Mg==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r542124772", "bodyText": "The purpose of the 2nd commit is to make the subquery's ORDER BY not preserved. The ordering only makes sense on the outermost query now. The original design of this cherry-pick states the same concept.", "author": "fgwang7w", "createdAt": "2020-12-14T05:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwNDc5MA=="}], "type": "inlineReview"}, {"oid": "9724fcaa0de8560208afb1d8ff3511cbb4326e17", "url": "https://github.com/prestodb/presto/commit/9724fcaa0de8560208afb1d8ff3511cbb4326e17", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-14T06:04:07Z", "type": "forcePushed"}, {"oid": "8faa9c173b5a401d0a2473d538108dbe8a4bf147", "url": "https://github.com/prestodb/presto/commit/8faa9c173b5a401d0a2473d538108dbe8a4bf147", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-14T07:48:15Z", "type": "forcePushed"}, {"oid": "c4f55989cf416f0e8baf58c25f8580b7f5d130b8", "url": "https://github.com/prestodb/presto/commit/c4f55989cf416f0e8baf58c25f8580b7f5d130b8", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-14T08:46:03Z", "type": "forcePushed"}, {"oid": "bc273fd4f8e16ba4615805ae706098ba13718c38", "url": "https://github.com/prestodb/presto/commit/bc273fd4f8e16ba4615805ae706098ba13718c38", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit\n\nIn addition to the Cherry-pick for removing redundant Limit/TopN/Sort/DistinctLimit,\nthere are a few more rules added to replace any input that is zero-TopN/DistinctLimit/Limit\n\nCherry-pick of https://github.com/prestosql/presto/pull/441\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-12-14T20:19:23Z", "type": "forcePushed"}, {"oid": "4625b08a75598d34de0d1ddf08d4d486cc0974b4", "url": "https://github.com/prestodb/presto/commit/4625b08a75598d34de0d1ddf08d4d486cc0974b4", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit\n\nIn addition to the Cherry-pick for removing redundant Limit/TopN/Sort/DistinctLimit,\nthere are a few more rules added to replace any input that is zero-TopN/DistinctLimit/Limit\n\nCherry-pick of https://github.com/prestosql/presto/pull/441\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-12-14T20:21:04Z", "type": "forcePushed"}, {"oid": "a87e1ac6343965c9c399b93c9cd6fd706d891ca9", "url": "https://github.com/prestodb/presto/commit/a87e1ac6343965c9c399b93c9cd6fd706d891ca9", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-14T22:58:50Z", "type": "forcePushed"}, {"oid": "4da8ff677a385ec23817d4d384b216a13f88b99c", "url": "https://github.com/prestodb/presto/commit/4da8ff677a385ec23817d4d384b216a13f88b99c", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit\n\nIn addition to the Cherry-pick for removing redundant Limit/TopN/Sort/DistinctLimit,\nthere are a few more rules added to replace any input that is zero-TopN/DistinctLimit/Limit\n\nCherry-pick of https://github.com/prestosql/presto/pull/441\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-12-14T23:20:36Z", "type": "forcePushed"}, {"oid": "ba959e5f3f867b90dd2e8857f03697c82c6ad8d0", "url": "https://github.com/prestodb/presto/commit/ba959e5f3f867b90dd2e8857f03697c82c6ad8d0", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-15T04:18:56Z", "type": "forcePushed"}, {"oid": "f3eb48cb4e847610540adc8d7a6683d711590d15", "url": "https://github.com/prestodb/presto/commit/f3eb48cb4e847610540adc8d7a6683d711590d15", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-15T05:36:55Z", "type": "forcePushed"}, {"oid": "6ffd10f9df84a5aa7e184fafa0dabd96624276b4", "url": "https://github.com/prestodb/presto/commit/6ffd10f9df84a5aa7e184fafa0dabd96624276b4", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-15T18:31:45Z", "type": "forcePushed"}, {"oid": "6d3513b88a471d3b59da8751fd4f249c9f068b2c", "url": "https://github.com/prestodb/presto/commit/6d3513b88a471d3b59da8751fd4f249c9f068b2c", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-16T22:27:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NDg2Nw==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r548074867", "bodyText": "It seems in this case the limit is also redundant.  We're just not smart enough to remove it.  Maybe instead have 2 rows in the values node.", "author": "rschlussel", "createdAt": "2020-12-23T17:34:21Z", "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -3389,9 +3389,12 @@ public void testCorrelatedScalarSubqueries()\n         // two level of nesting\n         assertQuery(\"SELECT * FROM nation n WHERE 2 = (SELECT (SELECT 2 * n.nationkey))\");\n \n+        // redundant LIMIT in subquery\n+        assertQuery(\"SELECT (SELECT count(*) FROM (VALUES (7,1)) t(orderkey, value) WHERE orderkey = corr_key LIMIT 1) FROM (values 7) t(corr_key)\");\n+\n         // explicit LIMIT in subquery\n         assertQueryFails(\n-                \"SELECT (SELECT count(*) FROM (VALUES (7,1)) t(orderkey, value) WHERE orderkey = corr_key LIMIT 1) FROM (values 7) t(corr_key)\",\n+                \"SELECT (SELECT count(*) FROM (VALUES (7,1)) t(orderkey, value) WHERE orderkey = corr_key GROUP BY value LIMIT 1) FROM (values 7) t(corr_key)\",", "originalCommit": "5e0f787f631f4d4f0b46d932967bdb9c57024c6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIwNzEyNA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r549207124", "bodyText": "or I can change it to an upper bound of LIMIT, then it will make sense,but this is a good catch, we should remove limit if there's a enforceSingleRow like count(*) to make the optimizer smarter. I propose we fix it in a separate PR so that TransformCorrelatedSingleRowSubqueryToProject can take it into account", "author": "fgwang7w", "createdAt": "2020-12-28T04:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NDg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NzYyOA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r548077628", "bodyText": "I think limit here was incidental and we still want this test for unsupported subqueries to ensure they throw proper errors.", "author": "rschlussel", "createdAt": "2020-12-23T17:37:39Z", "path": "presto-main/src/test/java/com/facebook/presto/sql/query/TestSubqueries.java", "diffHunk": "@@ -86,16 +86,16 @@ public void testCorrelatedExistsSubqueriesWithOrPredicateAndNull()\n     }\n \n     @Test\n-    public void testUnsupportedSubqueriesWithCoercions()", "originalCommit": "5e0f787f631f4d4f0b46d932967bdb9c57024c6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIwODMyMA==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r549208320", "bodyText": "then I will add a seperate tc with group by a limit 1 to guard this sanity test", "author": "fgwang7w", "createdAt": "2020-12-28T04:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NzYyOA=="}], "type": "inlineReview"}, {"oid": "0bd9ac376e0d5223d905427abc0d7044b91fef1c", "url": "https://github.com/prestodb/presto/commit/0bd9ac376e0d5223d905427abc0d7044b91fef1c", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit\n\nIn addition to the Cherry-pick for removing redundant Limit/TopN/Sort/DistinctLimit,\nthere are a few more rules added to replace any input that is zero-TopN/DistinctLimit/Limit\n\nCherry-pick of https://github.com/prestosql/presto/pull/441\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-12-28T04:48:19Z", "type": "commit"}, {"oid": "0bd9ac376e0d5223d905427abc0d7044b91fef1c", "url": "https://github.com/prestodb/presto/commit/0bd9ac376e0d5223d905427abc0d7044b91fef1c", "message": "Avoid planning unnecessary LIMIT/TopN/Sort/DistinctLimit\n\nIn addition to the Cherry-pick for removing redundant Limit/TopN/Sort/DistinctLimit,\nthere are a few more rules added to replace any input that is zero-TopN/DistinctLimit/Limit\n\nCherry-pick of https://github.com/prestosql/presto/pull/441\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-12-28T04:48:19Z", "type": "forcePushed"}, {"oid": "4bf0c8535a0ba0683dec654b2e205d842900764a", "url": "https://github.com/prestodb/presto/commit/4bf0c8535a0ba0683dec654b2e205d842900764a", "message": "Avoid planning unnecessary Sort\n\nCherry-pick of https://github.com/prestosql/presto/pull/818\n\nCo-author: Martin Traverso <mtraverso@gmail.com>", "committedDate": "2020-12-28T04:49:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2OTU5NQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r549469595", "bodyText": "I'm a bit confused why this is here. Shouldn't this be done in the analyzer and result stored somewhere? If not, we should do that.", "author": "kaikalur", "createdAt": "2020-12-28T19:56:58Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1122,12 +1127,22 @@ protected Scope visitQuerySpecification(QuerySpecification node, Optional<Scope>\n             List<Expression> orderByExpressions = emptyList();\n             Optional<Scope> orderByScope = Optional.empty();\n             if (node.getOrderBy().isPresent()) {\n-                orderByScope = Optional.of(computeAndAssignOrderByScope(node.getOrderBy().get(), sourceScope, outputScope));\n-                orderByExpressions = analyzeOrderBy(node, orderByScope.get(), outputExpressions);\n-            }\n-            else {\n-                analysis.setOrderByExpressions(node, emptyList());\n+                if (node.getSelect().isDistinct()) {\n+                    verifySelectDistinct(node, outputExpressions);\n+                }\n+\n+                OrderBy orderBy = node.getOrderBy().get();\n+                orderByScope = Optional.of(computeAndAssignOrderByScope(orderBy, sourceScope, outputScope));\n+\n+                orderByExpressions = analyzeOrderBy(node, orderBy.getSortItems(), orderByScope.get());", "originalCommit": "4bf0c8535a0ba0683dec654b2e205d842900764a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ5NDAyOQ==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r549494029", "bodyText": "this is the analyzer?", "author": "rschlussel", "createdAt": "2020-12-28T21:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2OTU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ5NjM3Mw==", "url": "https://github.com/prestodb/presto/pull/14915#discussion_r549496373", "bodyText": "this is the analyzer?\n\nOops - I think I got lost in the see of files in this large PR :)", "author": "kaikalur", "createdAt": "2020-12-28T21:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2OTU5NQ=="}], "type": "inlineReview"}]}