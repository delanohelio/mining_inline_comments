{"pr_number": 13927, "pr_title": "Optimize NOT IN filter for strings", "pr_createdAt": "2020-01-04T20:09:51Z", "pr_url": "https://github.com/prestodb/presto/pull/13927", "timeline": [{"oid": "566c49085d5b9b7df7c0b7e8ec2604bd379c1cdc", "url": "https://github.com/prestodb/presto/commit/566c49085d5b9b7df7c0b7e8ec2604bd379c1cdc", "message": "Add benchmark for BytesValues", "committedDate": "2020-01-04T23:19:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyODEyNg==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r363328126", "bodyText": "keep this private", "author": "mbasmanova", "createdAt": "2020-01-06T14:57:54Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilter.java", "diffHunk": "@@ -983,7 +983,7 @@ public String toString()\n         private final boolean upperExclusive;\n         private final boolean singleValue;\n \n-        private BytesRange(byte[] lower, boolean lowerExclusive, byte[] upper, boolean upperExclusive, boolean nullAllowed)\n+        protected BytesRange(byte[] lower, boolean lowerExclusive, byte[] upper, boolean upperExclusive, boolean nullAllowed)", "originalCommit": "17061d8ce7f6058aa4d75cef95e1d23c7580df2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyODIzMQ==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r363328231", "bodyText": "unused method; remove", "author": "mbasmanova", "createdAt": "2020-01-06T14:58:10Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilter.java", "diffHunk": "@@ -1045,11 +1045,21 @@ public boolean isSingleValue()\n             return singleValue;\n         }\n \n+        public boolean isCompleteExclusive()", "originalCommit": "17061d8ce7f6058aa4d75cef95e1d23c7580df2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyOTI5MA==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r363329290", "bodyText": "check length first:\nif (!delegate.testLength(length)) {\n   return true;\n}", "author": "mbasmanova", "createdAt": "2020-01-06T15:00:30Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilter.java", "diffHunk": "@@ -1209,6 +1219,66 @@ public String toString()\n         }\n     }\n \n+    class BytesValuesExclusive\n+            extends AbstractTupleDomainFilter\n+    {\n+        private final BytesValues delegate;\n+\n+        private BytesValuesExclusive(byte[][] values, boolean nullAllowed)\n+        {\n+            super(true, nullAllowed);\n+            delegate = new BytesValues(values, nullAllowed);\n+        }\n+\n+        public static BytesValuesExclusive of(byte[][] values, boolean nullAllowed)\n+        {\n+            return new BytesValuesExclusive(values, nullAllowed);\n+        }\n+\n+        @Override\n+        public boolean testBytes(byte[] value, int offset, int length)\n+        {\n+            return !delegate.testBytes(value, offset, length);", "originalCommit": "17061d8ce7f6058aa4d75cef95e1d23c7580df2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0NTg4NQ==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r364645885", "bodyText": "Sorry, got it lost during rebase, will add it back", "author": "kewang1024", "createdAt": "2020-01-09T09:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyOTI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMzMDE3Mw==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r363330173", "bodyText": "use existing BytesRange::getLower method here and remove newly added getUpper", "author": "mbasmanova", "createdAt": "2020-01-06T15:02:39Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilterUtils.java", "diffHunk": "@@ -129,9 +131,18 @@ public static TupleDomainFilter toFilter(Domain domain)\n                                 .toArray(byte[][]::new),\n                         nullAllowed);\n             }\n+\n+            if (isNotIn(ranges)) {\n+                return BytesValuesExclusive.of(\n+                        bytesRanges.stream()\n+                                .map(BytesRange::getUpper)", "originalCommit": "17061d8ce7f6058aa4d75cef95e1d23c7580df2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMzMzE2NA==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r363333164", "bodyText": "method comment needs to be updated and discussion of NaNs needs to be moved to the caller; I'd move changes to this method into a separate commit\n    /**\n     * Returns true is ranges represent != or NOT IN filter for double, float or string column.\n     *\n     * The logic is to return true if ranges are next to each other, but don't include the touch value.\n     */\n    private static boolean isNotIn(List<Range> ranges)\n\nand, in the caller:\n\n        if (firstRangeFilter instanceof DoubleRange || firstRangeFilter instanceof FloatRange) {\n            // != and NOT IN filters should return true when applied to NaN\n            // E.g. NaN != 1.0 as well as NaN NOT IN (1.0, 2.5, 3.6) should return true; otherwise false.\n            boolean nanAllowed = isNotIn(ranges);\n            return MultiRange.of(rangeFilters, nullAllowed, nanAllowed);\n        }\n\n        return MultiRange.of(rangeFilters, nullAllowed, false);", "author": "mbasmanova", "createdAt": "2020-01-06T15:09:31Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilterUtils.java", "diffHunk": "@@ -142,7 +153,7 @@ public static TupleDomainFilter toFilter(Domain domain)\n      *\n      * The logic is to return true if ranges are next to each other, but don't include the touch value.\n      */\n-    private static boolean isNanAllowed(List<Range> ranges)\n+    private static boolean isNotIn(List<Range> ranges)", "originalCommit": "17061d8ce7f6058aa4d75cef95e1d23c7580df2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMzNjc5Mg==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r363336792", "bodyText": "message needs updating: checkArgument(values.length > 0, \"values must not be empty\");", "author": "mbasmanova", "createdAt": "2020-01-06T15:17:30Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilter.java", "diffHunk": "@@ -1098,7 +1108,7 @@ private BytesValues(byte[][] values, boolean nullAllowed)\n             super(true, nullAllowed);\n \n             requireNonNull(values, \"values is null\");\n-            checkArgument(values.length > 1, \"values must contain at least 2 entries\");\n+            checkArgument(values.length > 0, \"values must contain at least 1 entries\");", "originalCommit": "17061d8ce7f6058aa4d75cef95e1d23c7580df2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM0MDAwOQ==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r363340009", "bodyText": "I don't think this benchmark is valid. In general you are not supposed to perform same operation in a loop like this, rather let JMH do that. Re-writing the benchmark to remove the loop shows same performance for these two operations:\n    @Benchmark\n    public boolean lookupInExclusive(BenchmarkBytesValues.BenchmarkData data)\n    {\n        return data.exclusiveFilter.testBytes(word, 0, 3);\n    }\n\n    @Benchmark\n    public boolean lookupInMultiRange(BenchmarkBytesValues.BenchmarkData data)\n    {\n        return data.multiRangeFilter.testBytes(word, 0, 3);\n    }\n\n# Run complete. Total time: 00:01:23\n\nBenchmark                                Mode  Cnt   Score    Error  Units\nBenchmarkBytesValues.lookupInExclusive   avgt   20  \u2248 10\u207b\u2075           ms/op\nBenchmarkBytesValues.lookupInMultiRange  avgt   20  \u2248 10\u207b\u2075           ms/op\n\nWriting good benchmark is not a requirement for the PR. If you want to write it, I suggest to start by writing benchmark for the main use case, e.g. in list with multiple entries, then see when performance difference is for very large in lists (e.g. hundreds of values), then make sure that in-list with one entry or != filter doesn't regress. Here is where I would start:\n@OutputTimeUnit(NANOSECONDS)\n\n    // NOT IN (\"apple\", \"grape\", \"orange\")\n    // \"abc\", \"apple\", \"banana\", \"grape\", \"orange\", \"peach\"\n    private final byte[][] testWords = new byte[][] {\"abc\".getBytes(), \"apple\".getBytes(), \"banana\".getBytes(), \"grape\".getBytes(), \"orange\".getBytes(), \"peach\".getBytes()};\n\n    @Benchmark\n    public int lookupInExclusive(BenchmarkBytesValues.BenchmarkData data)\n    {\n        int hits = 0;\n        for (int i = 0; i < testWords.length; i++) {\n            if (data.exclusiveFilter.testBytes(testWords[i], 0, testWords[i].length)) {\n                hits++;\n            }\n        }\n\n        return hits;\n    }\n\n    @Benchmark\n    public int lookupInMultiRange(BenchmarkBytesValues.BenchmarkData data)\n    {\n        int hits = 0;\n        for (int i = 0; i < testWords.length; i++) {\n            if (data.multiRangeFilter.testBytes(testWords[i], 0, testWords[i].length)) {\n                hits++;\n            }\n        }\n\n        return hits;\n    }\n\n    @State(Scope.Thread)\n    public static class BenchmarkData\n    {\n        private TupleDomainFilter exclusiveFilter;\n        private TupleDomainFilter multiRangeFilter;\n\n        @Setup\n        public void setup()\n                throws Exception\n        {\n            exclusiveFilter = BytesValuesExclusive.of(new byte[][] {\"apple\".getBytes(), \"grape\".getBytes(), \"orange\".getBytes()}, false);\n            multiRangeFilter = TupleDomainFilter.MultiRange.of(\n                    ImmutableList.of(\n                            BytesRange.of(null, true, \"apple\".getBytes(), true, false),\n                            BytesRange.of(\"apple\".getBytes(), true, \"grape\".getBytes(), true, false),\n                            BytesRange.of(\"grape\".getBytes(), true, \"orange\".getBytes(), true, false),\n                            BytesRange.of(\"orange\".getBytes(), true, null, true, false)),\n                    false,\n                    false);\n        }\n    }\n\nBenchmark                                Mode  Cnt   Score   Error  Units\nBenchmarkBytesValues.lookupInExclusive   avgt   20  63.112 \u00b1 0.811  ns/op\nBenchmarkBytesValues.lookupInMultiRange  avgt   20  93.394 \u00b1 0.530  ns/op", "author": "mbasmanova", "createdAt": "2020-01-06T15:24:21Z", "path": "presto-orc/src/test/java/com/facebook/presto/orc/BenchmarkBytesValues.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc;\n+\n+import com.google.common.collect.ImmutableList;\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.OutputTimeUnit;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+import org.openjdk.jmh.runner.Runner;\n+import org.openjdk.jmh.runner.options.Options;\n+import org.openjdk.jmh.runner.options.OptionsBuilder;\n+import org.openjdk.jmh.runner.options.VerboseMode;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@State(Scope.Thread)\n+@OutputTimeUnit(MILLISECONDS)\n+@Fork(2)\n+@Warmup(iterations = 10, time = 1000, timeUnit = MILLISECONDS)\n+@Measurement(iterations = 10, time = 1000, timeUnit = MILLISECONDS)\n+@BenchmarkMode(Mode.AverageTime)\n+public class BenchmarkBytesValues\n+{\n+    private final byte[] word = new byte[]{'h', 'h', 'h'};\n+\n+    @Benchmark\n+    public int lookupInExclusive(BenchmarkBytesValues.BenchmarkData data)", "originalCommit": "566c49085d5b9b7df7c0b7e8ec2604bd379c1cdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY1Njk1Mg==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r364656952", "bodyText": "Thank you for the detailed suggestion, it's really helpful!", "author": "kewang1024", "createdAt": "2020-01-09T10:14:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM0MDAwOQ=="}], "type": "inlineReview"}, {"oid": "d38608f89394b4c67cf138a7becf39c0ae04ea00", "url": "https://github.com/prestodb/presto/commit/d38608f89394b4c67cf138a7becf39c0ae04ea00", "message": "Add benchmark for BytesValues", "committedDate": "2020-01-09T18:34:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDkwMjA0NQ==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r364902045", "bodyText": "@kewang1024 string columns are not yet supported here; either add support or update comment", "author": "mbasmanova", "createdAt": "2020-01-09T18:47:30Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilterUtils.java", "diffHunk": "@@ -131,18 +131,22 @@ public static TupleDomainFilter toFilter(Domain domain)\n             }\n         }\n \n-        return MultiRange.of(rangeFilters, nullAllowed, isNanAllowed(ranges));\n+        if (firstRangeFilter instanceof DoubleRange || firstRangeFilter instanceof FloatRange) {\n+            // != and NOT IN filters should return true when applied to NaN\n+            // E.g. NaN != 1.0 as well as NaN NOT IN (1.0, 2.5, 3.6) should return true; otherwise false.\n+            boolean nanAllowed = isNotIn(ranges);\n+            return MultiRange.of(rangeFilters, nullAllowed, nanAllowed);\n+        }\n+\n+        return MultiRange.of(rangeFilters, nullAllowed, false);\n     }\n \n     /**\n-     * Returns true is ranges represent != or NOT IN filter. These types of filters should\n-     * return true when applied to NaN.\n-     *\n-     * E.g. NaN != 1.0 as well as NaN NOT IN (1.0, 2.5, 3.6) should return true; otherwise false.\n+     * Returns true is ranges represent != or NOT IN filter for double, float or string column.", "originalCommit": "e9f69dc02c67e7841788d752e39ca6eecf82171f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk0MTU1NQ==", "url": "https://github.com/prestodb/presto/pull/13927#discussion_r364941555", "bodyText": "Nice catch! Thanks", "author": "kewang1024", "createdAt": "2020-01-09T20:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDkwMjA0NQ=="}], "type": "inlineReview"}, {"oid": "bd40c365bc64d261a4bc5197b30b42d88fdc891f", "url": "https://github.com/prestodb/presto/commit/bd40c365bc64d261a4bc5197b30b42d88fdc891f", "message": "Rename isNanAllowed function and update comment", "committedDate": "2020-01-09T19:08:14Z", "type": "commit"}, {"oid": "20bb195fdbbdc73bddfc683574fd9dce6ba2a5cc", "url": "https://github.com/prestodb/presto/commit/20bb195fdbbdc73bddfc683574fd9dce6ba2a5cc", "message": "Optimize NOT IN filter for strings", "committedDate": "2020-01-09T20:16:01Z", "type": "commit"}, {"oid": "87c0888f196441a50c14ee637cae85479903b3c2", "url": "https://github.com/prestodb/presto/commit/87c0888f196441a50c14ee637cae85479903b3c2", "message": "Add benchmark for BytesValues", "committedDate": "2020-01-09T20:16:01Z", "type": "forcePushed"}, {"oid": "1f5b006ea784c3073641db79ae7bab6400174c6b", "url": "https://github.com/prestodb/presto/commit/1f5b006ea784c3073641db79ae7bab6400174c6b", "message": "Add benchmark for BytesValues", "committedDate": "2020-01-09T22:23:15Z", "type": "commit"}, {"oid": "1f5b006ea784c3073641db79ae7bab6400174c6b", "url": "https://github.com/prestodb/presto/commit/1f5b006ea784c3073641db79ae7bab6400174c6b", "message": "Add benchmark for BytesValues", "committedDate": "2020-01-09T22:23:15Z", "type": "forcePushed"}]}