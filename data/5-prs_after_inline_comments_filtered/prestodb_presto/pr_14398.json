{"pr_number": 14398, "pr_title": "Make PageFile format splittable", "pr_createdAt": "2020-04-16T05:51:32Z", "pr_url": "https://github.com/prestodb/presto/pull/14398", "timeline": [{"oid": "f079d7508affca544bc091aab76751488bbc58cd", "url": "https://github.com/prestodb/presto/commit/f079d7508affca544bc091aab76751488bbc58cd", "message": "Support splittable read of PageFile", "committedDate": "2020-04-16T07:55:53Z", "type": "forcePushed"}, {"oid": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "url": "https://github.com/prestodb/presto/commit/8853d6b6e3685884f51fec615b0b73688b9e18e1", "message": "Support splittable read of PageFile", "committedDate": "2020-04-16T18:28:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4MjA4NQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409782085", "bodyText": "nit: lets move it before the assignment", "author": "arhimondr", "createdAt": "2020-04-16T19:00:17Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFileFooterOutput.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import com.facebook.presto.orc.stream.DataOutput;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.slice.SliceOutput;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static io.airlift.slice.SizeOf.SIZE_OF_LONG;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFileFooterOutput\n+        implements DataOutput\n+{\n+    private final List<Long> stripeOffsets;\n+\n+    public PageFileFooterOutput(List<Long> stripeOffsets)\n+    {\n+        this.stripeOffsets = ImmutableList.copyOf(requireNonNull(stripeOffsets, \"stripeOffsets is null\"));\n+        checkArgument(!stripeOffsets.isEmpty(), \"stripeOffsets should at least contain offset 0\");", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4MjIzOQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409782239", "bodyText": "public", "author": "arhimondr", "createdAt": "2020-04-16T19:00:34Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFileFooterReader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+\n+import static io.airlift.slice.SizeOf.SIZE_OF_LONG;\n+import static java.lang.Math.toIntExact;\n+import static java.nio.ByteBuffer.allocate;\n+import static java.nio.ByteOrder.LITTLE_ENDIAN;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFileFooterReader\n+{\n+    private long[] stripeOffsets;\n+    private ByteBuffer readBuffer = allocate(SIZE_OF_LONG);\n+\n+    PageFileFooterReader(", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4MjU0OQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409782549", "bodyText": "Do we support empty files? Or do we want to consider them as invalid?", "author": "arhimondr", "createdAt": "2020-04-16T19:01:06Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFileFooterReader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+\n+import static io.airlift.slice.SizeOf.SIZE_OF_LONG;\n+import static java.lang.Math.toIntExact;\n+import static java.nio.ByteBuffer.allocate;\n+import static java.nio.ByteOrder.LITTLE_ENDIAN;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFileFooterReader\n+{\n+    private long[] stripeOffsets;\n+    private ByteBuffer readBuffer = allocate(SIZE_OF_LONG);\n+\n+    PageFileFooterReader(\n+            FSDataInputStream inputStream,\n+            long fileSize)\n+            throws IOException\n+    {\n+        requireNonNull(inputStream, \"inputStream is null\");\n+        if (fileSize >= SIZE_OF_LONG) {", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0MzQ1Mw==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409843453", "bodyText": "TestHiveIntegrationSmokeTest::testInsertPartitionedBucketedTableFewRows creates an split with fileSize = 0, I haven't figured out when that could happen", "author": "viczhang861", "createdAt": "2020-04-16T20:56:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4MjU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MTc3MA==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409791770", "bodyText": "It doesn't feel like we need a class to read a footer. How about we add a simple static method to the PageFilePageSource that does just that?", "author": "arhimondr", "createdAt": "2020-04-16T19:18:10Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFileFooterReader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+\n+import static io.airlift.slice.SizeOf.SIZE_OF_LONG;\n+import static java.lang.Math.toIntExact;\n+import static java.nio.ByteBuffer.allocate;\n+import static java.nio.ByteOrder.LITTLE_ENDIAN;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFileFooterReader", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0MzQ3Nw==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409843477", "bodyText": "We may extend the footer later.  For example, to include compression code", "author": "viczhang861", "createdAt": "2020-04-16T20:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MTc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MjY3Ng==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409792676", "bodyText": "You can wrap the input stream with the InputStreamSliceInput and use the #getLong method that reads longs in LITTLE_ENDIAN", "author": "arhimondr", "createdAt": "2020-04-16T19:19:46Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFileFooterReader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+\n+import static io.airlift.slice.SizeOf.SIZE_OF_LONG;\n+import static java.lang.Math.toIntExact;\n+import static java.nio.ByteBuffer.allocate;\n+import static java.nio.ByteOrder.LITTLE_ENDIAN;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFileFooterReader\n+{\n+    private long[] stripeOffsets;\n+    private ByteBuffer readBuffer = allocate(SIZE_OF_LONG);", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NTg1Mw==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409795853", "bodyText": "What if there's no stripes? It feels like this should be initialized as empty.", "author": "arhimondr", "createdAt": "2020-04-16T19:25:31Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java", "diffHunk": "@@ -37,12 +38,14 @@\n     private long maxBufferedBytes;\n     private boolean closed;\n     private List<DataOutput> bufferedPages;\n+    private List<Long> stripeOffsets;\n \n     public PageWriter(DataSink dataSink, DataSize pageFileStripeMaxSize)\n     {\n         this.dataSink = requireNonNull(dataSink, \"pageDataSink is null\");\n         this.maxBufferedBytes = requireNonNull(pageFileStripeMaxSize, \"pageFileStripeMaxSize is null\").toBytes();\n         bufferedPages = new ArrayList<>();\n+        stripeOffsets = new ArrayList<>(ImmutableList.of(0L));", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjA2OA==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409796068", "bodyText": "And stripe offset should be added before adding a new stripe", "author": "arhimondr", "createdAt": "2020-04-16T19:25:53Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java", "diffHunk": "@@ -60,6 +63,7 @@ public void write(SerializedPage page)\n         long writtenSize = pageDataOutput.size();\n         if (maxBufferedBytes - bufferedBytes < writtenSize) {\n             dataSink.write(bufferedPages);\n+            addStripeOffset(bufferedBytes);", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjM1Ng==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409796356", "bodyText": "As this will effectively add an offset for non existing stripe", "author": "arhimondr", "createdAt": "2020-04-16T19:26:28Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java", "diffHunk": "@@ -79,12 +83,20 @@ public void close()\n         closed = true;\n         if (!bufferedPages.isEmpty()) {\n             dataSink.write(bufferedPages);\n+            addStripeOffset(bufferedBytes);", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Nzc1Nw==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409797757", "bodyText": "I see what are you doing. You are treading the footer as a \"stripe\" adding the last offset as an offset of the footer. It would work, but it is a little confusing. How about we make it more explicit. Let's add offsets only for existing stripes, and then add the size of the footer in bytes as a last long of the file. Similar to ORC.", "author": "arhimondr", "createdAt": "2020-04-16T19:29:06Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFileFooterOutput.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import com.facebook.presto.orc.stream.DataOutput;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.slice.SliceOutput;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static io.airlift.slice.SizeOf.SIZE_OF_LONG;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFileFooterOutput\n+        implements DataOutput\n+{\n+    private final List<Long> stripeOffsets;\n+\n+    public PageFileFooterOutput(List<Long> stripeOffsets)\n+    {\n+        this.stripeOffsets = ImmutableList.copyOf(requireNonNull(stripeOffsets, \"stripeOffsets is null\"));\n+        checkArgument(!stripeOffsets.isEmpty(), \"stripeOffsets should at least contain offset 0\");\n+    }\n+\n+    @Override\n+    public long size()\n+    {\n+        return SIZE_OF_LONG * (stripeOffsets.size());\n+    }\n+\n+    @Override\n+    public void writeData(SliceOutput sliceOutput)\n+    {\n+        for (long offset : stripeOffsets) {\n+            sliceOutput.writeLong(offset);", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0MDQxMQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409840411", "bodyText": "I was planning to draw a footer design picture before adding you to review, but you get the idea correctly !\n\nLike ORC,  stripOffset is the beginning of a stripe, thus offSet start from 0\nUse N + 1  long to represent N stripes has advantage of labeling the end of last stripe.\nThe last stripeOffset is offset of footer, it is used for the same purpose as size of footer, but has advantage of avoiding calculation last stripe size. Otherwise, lastStripeSize = fileSize - beginningOfLastStripe - stripeSize\nMaybe we should use size of footer instead of beginning of footer to be consistent with ORC", "author": "viczhang861", "createdAt": "2020-04-16T20:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Nzc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY2OTg4MA==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r411669880", "bodyText": "To me the simplest format would be an offset and length. Why try to do fancy things to derive where things are and how long they are when space is not at a premium?", "author": "aweisberg", "createdAt": "2020-04-20T20:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Nzc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4NDQ3Ng==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r412384476", "bodyText": "To me the simplest format would be an offset and length. Why try to do fancy things to derive where things are and how long they are when space is not at a premium?\n\nLength is inferred from difference of adjacent offset, @andri was suggesting to use footer size to replace footer offset.", "author": "viczhang861", "createdAt": "2020-04-21T18:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Nzc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5OTUxNg==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409799516", "bodyText": "Let's move the getReadStartAndLength  here", "author": "arhimondr", "createdAt": "2020-04-16T19:32:29Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFilePageSource.java", "diffHunk": "@@ -45,13 +44,26 @@\n \n     public PageFilePageSource(\n             FSDataInputStream inputStream,\n+            long start,\n+            long splitLength,\n+            long fileSize,\n             PagesSerde pagesSerde,\n             List<HiveColumnHandle> columns)\n+            throws IOException\n     {\n         this.inputStream = requireNonNull(inputStream, \"inputStream is null\");\n-        pageReader = readPages(\n-                requireNonNull(pagesSerde, \"pagesSerde is null\"),\n-                new InputStreamSliceInput(inputStream));\n+        PageFileFooterReader pageFileFooterReader = new PageFileFooterReader(inputStream, fileSize);\n+\n+        long[] readStartAndLength = getReadStartAndLength(", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMDAxNA==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409800014", "bodyText": "Let's have a class instead of using an array. You can make it internal and private. e.g.:\nprivate static class OffsetAndLength {\nprivate final long offset;\nprivate final long length;\n...\n}", "author": "arhimondr", "createdAt": "2020-04-16T19:33:22Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFilePageSource.java", "diffHunk": "@@ -45,13 +44,26 @@\n \n     public PageFilePageSource(\n             FSDataInputStream inputStream,\n+            long start,\n+            long splitLength,\n+            long fileSize,\n             PagesSerde pagesSerde,\n             List<HiveColumnHandle> columns)\n+            throws IOException\n     {\n         this.inputStream = requireNonNull(inputStream, \"inputStream is null\");\n-        pageReader = readPages(\n-                requireNonNull(pagesSerde, \"pagesSerde is null\"),\n-                new InputStreamSliceInput(inputStream));\n+        PageFileFooterReader pageFileFooterReader = new PageFileFooterReader(inputStream, fileSize);\n+\n+        long[] readStartAndLength = getReadStartAndLength(", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMTg2OA==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409801868", "bodyText": "Instead of keeping track of readBytes you can use ByteStreams#limit", "author": "arhimondr", "createdAt": "2020-04-16T19:36:53Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFilePageReader.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import com.facebook.presto.spi.Page;\n+import com.facebook.presto.spi.page.PagesSerde;\n+import com.facebook.presto.spi.page.SerializedPage;\n+import io.airlift.slice.InputStreamSliceInput;\n+import io.airlift.slice.SliceInput;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+import static com.facebook.presto.spi.page.PagesSerdeUtil.readSerializedPage;\n+import static com.facebook.presto.spi.page.PagesSerdeUtil.serializedPageWrittenBytes;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFilePageReader\n+        implements Iterator<Page>\n+{\n+    private final PagesSerde pagesSerde;\n+    private final SliceInput input;\n+    private final long readLength;\n+    private long readBytes;\n+\n+    PageFilePageReader(\n+            long readStart,\n+            long readLength,\n+            FSDataInputStream inputStream,\n+            PagesSerde pagesSerde)\n+            throws IOException\n+    {\n+        this.pagesSerde = requireNonNull(pagesSerde, \"pagesSerde is null\");\n+        this.readLength = readLength;\n+        requireNonNull(inputStream, \"inputStream is null\");\n+        inputStream.seek(readStart);\n+        this.input = new InputStreamSliceInput(inputStream);\n+    }\n+\n+    @Override\n+    public boolean hasNext()\n+    {\n+        return readBytes < readLength && input.isReadable();", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk1NjAzNQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409956035", "bodyText": "Thank you,  I get rid of readBytes using InputStreamSliceInput.position()", "author": "viczhang861", "createdAt": "2020-04-17T02:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMTg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMjU4NQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409802585", "bodyText": "How about passing an already positioned and limited input stream? (doing inputStream.seek(readStart); and ByteStreams#limit outside)? If you do that then most likely you won't even need this class.", "author": "arhimondr", "createdAt": "2020-04-16T19:38:14Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFilePageReader.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import com.facebook.presto.spi.Page;\n+import com.facebook.presto.spi.page.PagesSerde;\n+import com.facebook.presto.spi.page.SerializedPage;\n+import io.airlift.slice.InputStreamSliceInput;\n+import io.airlift.slice.SliceInput;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+import static com.facebook.presto.spi.page.PagesSerdeUtil.readSerializedPage;\n+import static com.facebook.presto.spi.page.PagesSerdeUtil.serializedPageWrittenBytes;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFilePageReader\n+        implements Iterator<Page>\n+{\n+    private final PagesSerde pagesSerde;\n+    private final SliceInput input;\n+    private final long readLength;\n+    private long readBytes;\n+\n+    PageFilePageReader(\n+            long readStart,\n+            long readLength,\n+            FSDataInputStream inputStream,", "originalCommit": "8853d6b6e3685884f51fec615b0b73688b9e18e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk1NjU4Nw==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r409956587", "bodyText": "Keep using InputStreamSliceInput to reuse function readSerializedPage(SliceInput)", "author": "viczhang861", "createdAt": "2020-04-17T02:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMjU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc2ODczOQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r411768739", "bodyText": "InputStreamSliceInput is inefficient about readBytes. We can eliminate some copying for free there. Depending on how often we use it in Presto it would be a tiny amount of free performance.\nIt copies to its internal buffer and then copies to the output buffer. It could copy directly from the wrapped input stream to the output byte array. It only needs to copy the initial bytes from its internal buffer.\nMight be worth a pass to make sure nothing else is following this pattern.", "author": "aweisberg", "createdAt": "2020-04-20T23:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMjU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ0NTcxMg==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r412445712", "bodyText": "There is one copy to internal slice of InputStreamSliceInput,  the advantage of doing it this way is to lower the count of real IO operation? For integer and small page, read from buffer is more efficient.", "author": "viczhang861", "createdAt": "2020-04-21T19:50:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMjU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5MzEzNA==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r413993134", "bodyText": "@aweisberg Currently block recoding relies on SliceInput. There's only one existing InputStreamSliceInput implementation, and unfortunately it is not very efficient. We had a discussion around that with Vic. I think we all agree that it has to be optimized. What do you think about doing it as a follow up?", "author": "arhimondr", "createdAt": "2020-04-23T17:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMjU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwMzMyNQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r414003325", "bodyText": "It doesn't reduce the number of IO operations and will increase it in some cases. Basically if the size of the remaining bytes to read is > than the internal buffer size (or size > some multiple) it doesn't make sense to copy to the internal buffer. Pass the argument array to the wrapped stream along with the correct offset and length and do it directly.\nAgree it should be a followup. It's not even a change we would make to this repo.", "author": "aweisberg", "createdAt": "2020-04-23T17:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwMjU4NQ=="}], "type": "inlineReview"}, {"oid": "c5d8ee42ea1da990c0883d7cfdc7c4c46053440e", "url": "https://github.com/prestodb/presto/commit/c5d8ee42ea1da990c0883d7cfdc7c4c46053440e", "message": "Support splittable read of PageFile", "committedDate": "2020-04-17T02:26:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MzEyMQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r412293121", "bodyText": "What case is this? Is there a unit test for it (null, and empty?)", "author": "aweisberg", "createdAt": "2020-04-21T15:45:38Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFilePageSource.java", "diffHunk": "@@ -127,4 +139,58 @@ public void close()\n         inputStream.close();\n         closed = true;\n     }\n+\n+    private static OffsetAndLength getReadStartAndLength(\n+            long splitStart,\n+            long splitLength,\n+            long lastStripeEnd,\n+            List<Long> stripeOffsets)\n+    {\n+        if (stripeOffsets == null || stripeOffsets.isEmpty()) {", "originalCommit": "c5d8ee42ea1da990c0883d7cfdc7c4c46053440e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQzMjgxNg==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r412432816", "bodyText": "For zero row file without any stripe,  stripeOffsets is empty.  This is covered by test testInsertPartitionedBucketedTableFewRows", "author": "viczhang861", "createdAt": "2020-04-21T19:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MzEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5Mzk5Nw==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r412293997", "bodyText": "This is more complicated then it needs to be. I think it would be simpler if we just had the footer include an offset and a length. I think file formats should only be fancy and concise when space is at a premium, otherwise they should minimize how complex they are to interpret.\nI just don't see the value in doing what ORC does. It's not the last word in file formats. Unless there is interoperability with the serialized form I think we should do something simple.", "author": "aweisberg", "createdAt": "2020-04-21T15:49:00Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFilePageSource.java", "diffHunk": "@@ -127,4 +139,58 @@ public void close()\n         inputStream.close();\n         closed = true;\n     }\n+\n+    private static OffsetAndLength getReadStartAndLength(\n+            long splitStart,\n+            long splitLength,\n+            long lastStripeEnd,\n+            List<Long> stripeOffsets)\n+    {\n+        if (stripeOffsets == null || stripeOffsets.isEmpty()) {\n+            return new OffsetAndLength(0, 0);\n+        }\n+\n+        long readStart = 0;\n+        long readEnd = 0;\n+        for (int i = 0; i < stripeOffsets.size(); ++i) {\n+            if (splitContainsStripe(splitStart, splitLength, stripeOffsets.get(i))) {\n+                readStart = Math.min(readStart, stripeOffsets.get(i));\n+                readEnd = Math.max(", "originalCommit": "c5d8ee42ea1da990c0883d7cfdc7c4c46053440e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODYxMw==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r414748613", "bodyText": "I looked at this with Andrii briefly. I don't think this max is necessary?\nLet's just go with this version. I don't want to block this over something so trivial. It's temporary data format.", "author": "aweisberg", "createdAt": "2020-04-24T17:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5Mzk5Nw=="}], "type": "inlineReview"}, {"oid": "53efae366ee4a0b87c00abfc4b34af5fb3ccfd52", "url": "https://github.com/prestodb/presto/commit/53efae366ee4a0b87c00abfc4b34af5fb3ccfd52", "message": "Support splittable read of PageFile", "committedDate": "2020-04-23T22:32:24Z", "type": "forcePushed"}, {"oid": "bac28309c8ca340678fb7f9f0d355f7aff61d978", "url": "https://github.com/prestodb/presto/commit/bac28309c8ca340678fb7f9f0d355f7aff61d978", "message": "Support splittable read of PageFile", "committedDate": "2020-04-23T22:53:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNDAyNQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r414804025", "bodyText": "nit: Maybe flushStripe?", "author": "arhimondr", "createdAt": "2020-04-24T19:13:27Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageWriter.java", "diffHunk": "@@ -59,10 +63,7 @@ public void write(SerializedPage page)\n         PageDataOutput pageDataOutput = new PageDataOutput(page);\n         long writtenSize = pageDataOutput.size();\n         if (maxBufferedBytes - bufferedBytes < writtenSize) {\n-            dataSink.write(bufferedPages);\n-            bufferedPages.clear();\n-            bufferedBytes = 0;\n-            retainedBytes = 0;\n+            writeStripe();", "originalCommit": "bac28309c8ca340678fb7f9f0d355f7aff61d978", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNTM3NA==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r414805374", "bodyText": "I wonder if that should be an assertion", "author": "arhimondr", "createdAt": "2020-04-24T19:15:57Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFileFooterReader.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.slice.SliceInput;\n+import io.airlift.slice.Slices;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static io.airlift.slice.SizeOf.SIZE_OF_INT;\n+import static java.lang.Math.min;\n+import static java.lang.Math.toIntExact;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFileFooterReader\n+{\n+    private static final int ESTIMATED_FOOTER_SIZE = 1024;\n+    private static final int FOOTER_METADATA_SIZE = SIZE_OF_INT;\n+\n+    private List<Long> stripeOffsets;\n+    private long footerOffset;\n+\n+    public PageFileFooterReader(\n+            FSDataInputStream inputStream,\n+            long fileSize)\n+            throws IOException\n+    {\n+        requireNonNull(inputStream, \"inputStream is null\");\n+        ImmutableList.Builder<Long> stripeOffsetsBuilder = ImmutableList.builder();\n+\n+        if (fileSize >= FOOTER_METADATA_SIZE) {", "originalCommit": "bac28309c8ca340678fb7f9f0d355f7aff61d978", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwOTYzNA==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r414809634", "bodyText": "You can simply do Slices.wrappedBuffer(buffer, buffer.length - FOOTER_METADATA_SIZE, FOOTER_METADATA_SIZE).getInt(0)", "author": "arhimondr", "createdAt": "2020-04-24T19:23:57Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFileFooterReader.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.pagefile;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.slice.SliceInput;\n+import io.airlift.slice.Slices;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static io.airlift.slice.SizeOf.SIZE_OF_INT;\n+import static java.lang.Math.min;\n+import static java.lang.Math.toIntExact;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PageFileFooterReader\n+{\n+    private static final int ESTIMATED_FOOTER_SIZE = 1024;\n+    private static final int FOOTER_METADATA_SIZE = SIZE_OF_INT;\n+\n+    private List<Long> stripeOffsets;\n+    private long footerOffset;\n+\n+    public PageFileFooterReader(\n+            FSDataInputStream inputStream,\n+            long fileSize)\n+            throws IOException\n+    {\n+        requireNonNull(inputStream, \"inputStream is null\");\n+        ImmutableList.Builder<Long> stripeOffsetsBuilder = ImmutableList.builder();\n+\n+        if (fileSize >= FOOTER_METADATA_SIZE) {\n+            byte[] buffer = new byte[toIntExact(min(fileSize, ESTIMATED_FOOTER_SIZE))];\n+            inputStream.readFully(fileSize - buffer.length, buffer);\n+            SliceInput sliceInput = Slices.wrappedBuffer(buffer, buffer.length - FOOTER_METADATA_SIZE, FOOTER_METADATA_SIZE).getInput();\n+            int footerSize = sliceInput.readInt();", "originalCommit": "bac28309c8ca340678fb7f9f0d355f7aff61d978", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxMDkzOQ==", "url": "https://github.com/prestodb/presto/pull/14398#discussion_r414810939", "bodyText": "Yeah, it feels like max is extra here", "author": "arhimondr", "createdAt": "2020-04-24T19:26:16Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/pagefile/PageFilePageSource.java", "diffHunk": "@@ -127,4 +140,63 @@ public void close()\n         inputStream.close();\n         closed = true;\n     }\n+\n+    private static OffsetAndLength getReadStartAndLength(\n+            long splitStart,\n+            long splitLength,\n+            long lastStripeEnd,\n+            List<Long> stripeOffsets)\n+    {\n+        checkArgument(stripeOffsets != null, \"stripeOffsets is null, failed to read page file footer.\");\n+        if (stripeOffsets.isEmpty()) {\n+            return new OffsetAndLength(0, 0);\n+        }\n+\n+        long readStart = 0;\n+        long readEnd = 0;\n+        boolean stripeFound = false;\n+        for (int i = 0; i < stripeOffsets.size(); ++i) {\n+            if (splitContainsStripe(splitStart, splitLength, stripeOffsets.get(i))) {\n+                if (!stripeFound) {\n+                    readStart = stripeOffsets.get(i);\n+                    stripeFound = true;\n+                }\n+                readEnd = Math.max(", "originalCommit": "bac28309c8ca340678fb7f9f0d355f7aff61d978", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ca9174670098cccb7f4d89660eb9197883b30cb1", "url": "https://github.com/prestodb/presto/commit/ca9174670098cccb7f4d89660eb9197883b30cb1", "message": "Add footer to PageFile format\n\nA footer consists of two parts.\n - offset of each stripe's start location.\n - footer's total size in bytes.", "committedDate": "2020-04-25T00:57:30Z", "type": "commit"}, {"oid": "a3d2f6817ec7e6bc52d397a03b7bb5018d7ece81", "url": "https://github.com/prestodb/presto/commit/a3d2f6817ec7e6bc52d397a03b7bb5018d7ece81", "message": "Create zero row file for PageFile format", "committedDate": "2020-04-25T00:57:30Z", "type": "commit"}, {"oid": "956e41911073f4b32c8e93b12fb98f3422b73f08", "url": "https://github.com/prestodb/presto/commit/956e41911073f4b32c8e93b12fb98f3422b73f08", "message": "Support splittable read of PageFile", "committedDate": "2020-04-25T00:57:30Z", "type": "commit"}, {"oid": "956e41911073f4b32c8e93b12fb98f3422b73f08", "url": "https://github.com/prestodb/presto/commit/956e41911073f4b32c8e93b12fb98f3422b73f08", "message": "Support splittable read of PageFile", "committedDate": "2020-04-25T00:57:30Z", "type": "forcePushed"}]}