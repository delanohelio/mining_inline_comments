{"pr_number": 15101, "pr_title": "Support explain verification", "pr_createdAt": "2020-09-01T01:52:16Z", "pr_url": "https://github.com/prestodb/presto/pull/15101", "timeline": [{"oid": "b942070d29796c578b5e1e47cf0b40de8ab47c45", "url": "https://github.com/prestodb/presto/commit/b942070d29796c578b5e1e47cf0b40de8ab47c45", "message": "Extract class QueryBundle\n\nQueryBundle contained a field tableName, but not all query rewrites\nresult in queries with a target table. Move the field to a subclass\nDataQueryBundle.", "committedDate": "2020-09-01T02:06:23Z", "type": "forcePushed"}, {"oid": "4ee55121c19df3a846c3107b8fb5b86b43c8c8d2", "url": "https://github.com/prestodb/presto/commit/4ee55121c19df3a846c3107b8fb5b86b43c8c8d2", "message": "Extract class QueryBundle\n\nQueryBundle contained a field tableName, but not all query rewrites\nresult in queries with a target table. Move the field to a subclass\nDataQueryBundle.", "committedDate": "2020-09-01T02:07:48Z", "type": "forcePushed"}, {"oid": "eeeddca1c3b3bddbf530bc96019036e50512a82d", "url": "https://github.com/prestodb/presto/commit/eeeddca1c3b3bddbf530bc96019036e50512a82d", "message": "Extract class QueryBundle\n\nQueryBundle contained a field tableName, but not all query rewrites\nresult in queries with a target table. Move the field to a subclass\nDataQueryBundle.", "committedDate": "2020-09-01T02:11:41Z", "type": "forcePushed"}, {"oid": "beaa86f1cabf3317aad722315736453844ff756b", "url": "https://github.com/prestodb/presto/commit/beaa86f1cabf3317aad722315736453844ff756b", "message": "Support explain verification", "committedDate": "2020-09-01T02:52:47Z", "type": "forcePushed"}, {"oid": "089a362ea57faa2e390299d8489aaa46ba558a7f", "url": "https://github.com/prestodb/presto/commit/089a362ea57faa2e390299d8489aaa46ba558a7f", "message": "Support explain verification", "committedDate": "2020-09-01T04:00:18Z", "type": "forcePushed"}, {"oid": "43ae649580c3bfff267dd7d4dec836cf367dd2b8", "url": "https://github.com/prestodb/presto/commit/43ae649580c3bfff267dd7d4dec836cf367dd2b8", "message": "Support explain verification", "committedDate": "2020-09-01T04:04:33Z", "type": "forcePushed"}, {"oid": "41f48798d1d5efa9bec32d5adaaf73545bf08a14", "url": "https://github.com/prestodb/presto/commit/41f48798d1d5efa9bec32d5adaaf73545bf08a14", "message": "Support explain verification", "committedDate": "2020-09-01T04:36:08Z", "type": "forcePushed"}, {"oid": "71f54b30d5558315e2ff62910269f39c05aa2398", "url": "https://github.com/prestodb/presto/commit/71f54b30d5558315e2ff62910269f39c05aa2398", "message": "Support explain verification", "committedDate": "2020-09-01T04:42:29Z", "type": "forcePushed"}, {"oid": "4786684f61817f8136fd394b02046e64cac17680", "url": "https://github.com/prestodb/presto/commit/4786684f61817f8136fd394b02046e64cac17680", "message": "Support explain verification", "committedDate": "2020-09-01T04:45:52Z", "type": "forcePushed"}, {"oid": "4f4f3eb3f7919713ef552aca2fe306fa6687b20d", "url": "https://github.com/prestodb/presto/commit/4f4f3eb3f7919713ef552aca2fe306fa6687b20d", "message": "Support explain verification", "committedDate": "2020-09-01T04:48:30Z", "type": "forcePushed"}, {"oid": "06c39a06f3610976787ecdbefa736461dd972a56", "url": "https://github.com/prestodb/presto/commit/06c39a06f3610976787ecdbefa736461dd972a56", "message": "Support explain verification", "committedDate": "2020-09-01T04:48:46Z", "type": "forcePushed"}, {"oid": "1811342ec7107a951b8b15f0795e74236bff6306", "url": "https://github.com/prestodb/presto/commit/1811342ec7107a951b8b15f0795e74236bff6306", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-01T04:51:07Z", "type": "forcePushed"}, {"oid": "be0160b88200dd41e944901c4baf565d00425357", "url": "https://github.com/prestodb/presto/commit/be0160b88200dd41e944901c4baf565d00425357", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-01T05:03:25Z", "type": "forcePushed"}, {"oid": "dce16592af8adb99dfaa9fb0daac3fdd74014568", "url": "https://github.com/prestodb/presto/commit/dce16592af8adb99dfaa9fb0daac3fdd74014568", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-01T05:10:07Z", "type": "forcePushed"}, {"oid": "33c749323f166e6a8ba8705464abdf675cf433d9", "url": "https://github.com/prestodb/presto/commit/33c749323f166e6a8ba8705464abdf675cf433d9", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-01T05:14:55Z", "type": "forcePushed"}, {"oid": "8c8afa74070b32b965f40c452b95e8c01d29fb16", "url": "https://github.com/prestodb/presto/commit/8c8afa74070b32b965f40c452b95e8c01d29fb16", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-01T06:11:09Z", "type": "forcePushed"}, {"oid": "6d30590aa941640683ad3f0ac22561a105c56b46", "url": "https://github.com/prestodb/presto/commit/6d30590aa941640683ad3f0ac22561a105c56b46", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-01T06:24:01Z", "type": "forcePushed"}, {"oid": "9879ca92e42559afbfa1baf6fc882eb28fd140d7", "url": "https://github.com/prestodb/presto/commit/9879ca92e42559afbfa1baf6fc882eb28fd140d7", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-01T20:00:58Z", "type": "forcePushed"}, {"oid": "10ad3bfe6b45d3adf2b0665aa4d2692a3e40e80e", "url": "https://github.com/prestodb/presto/commit/10ad3bfe6b45d3adf2b0665aa4d2692a3e40e80e", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-02T00:20:53Z", "type": "forcePushed"}, {"oid": "11b85642bd4f39621c23117aac7527a7c5ffbc8e", "url": "https://github.com/prestodb/presto/commit/11b85642bd4f39621c23117aac7527a7c5ffbc8e", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-02T08:35:55Z", "type": "forcePushed"}, {"oid": "8d875366347a6763f44ae3a64996bd56e14c7b23", "url": "https://github.com/prestodb/presto/commit/8d875366347a6763f44ae3a64996bd56e14c7b23", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-08T01:33:30Z", "type": "forcePushed"}, {"oid": "340ecf934be4212af40c6a1f3b6dd89e82734145", "url": "https://github.com/prestodb/presto/commit/340ecf934be4212af40c6a1f3b6dd89e82734145", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-08T04:57:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3MjE2NQ==", "url": "https://github.com/prestodb/presto/pull/15101#discussion_r485972165", "bodyText": "Curious why we are extracting this out to a separate config? Do we envision more such properties in the future?", "author": "sujay-jain", "createdAt": "2020-09-09T23:15:22Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/DataVerificationConfig.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*", "originalCommit": "db81b61f623c81c63ed94a5f0bc75db362f5b1e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5OTk3Ng==", "url": "https://github.com/prestodb/presto/pull/15101#discussion_r485999976", "bodyText": "I was thinking that we're only support skip-control for DML verification, so put this as a separate config that are specific to DML verification. But you reminded me that we could also trivially support this config for explain as well.\nRemoved this config and added support for skip-control for explain in the last commit.", "author": "caithagoras", "createdAt": "2020-09-10T00:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3MjE2NQ=="}], "type": "inlineReview"}, {"oid": "1f596c8edb6b9d06a84be56bdb42d517e9fe60a1", "url": "https://github.com/prestodb/presto/commit/1f596c8edb6b9d06a84be56bdb42d517e9fe60a1", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-10T00:50:41Z", "type": "forcePushed"}, {"oid": "7342846b96a291ddcd636df0c40af94d9ee1e99c", "url": "https://github.com/prestodb/presto/commit/7342846b96a291ddcd636df0c40af94d9ee1e99c", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-10T00:51:27Z", "type": "forcePushed"}, {"oid": "3b88a541f28498ddb9eedeed086bb38443c6ac0a", "url": "https://github.com/prestodb/presto/commit/3b88a541f28498ddb9eedeed086bb38443c6ac0a", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-10T09:33:26Z", "type": "forcePushed"}, {"oid": "3e07ba05696ce31aaf1c208922baf505ff4ab4ca", "url": "https://github.com/prestodb/presto/commit/3e07ba05696ce31aaf1c208922baf505ff4ab4ca", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-10T09:39:30Z", "type": "forcePushed"}, {"oid": "5dd8d162fb154167dcb6f692d84d7a57b40ba999", "url": "https://github.com/prestodb/presto/commit/5dd8d162fb154167dcb6f692d84d7a57b40ba999", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-10T09:43:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzOTE2NQ==", "url": "https://github.com/prestodb/presto/pull/15101#discussion_r486439165", "bodyText": "Should we change VerifierQueryEvent to just take determinismAnalysisDetails now that it contains the determinismAnalysis as well?", "author": "sujay-jain", "createdAt": "2020-09-10T15:34:07Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -308,10 +303,8 @@ private VerificationResult concludeVerification(\n                 sourceQuery.getName(),\n                 partialResult.getStatus(),\n                 partialResult.getSkippedReason(),\n-                determinismAnalysis,\n-                determinismAnalysis.isPresent() ?\n-                        Optional.of(determinismAnalysisDetails) :\n-                        Optional.empty(),\n+                determinismAnalysisDetails.map(DeterminismAnalysisDetails::getAnalysis),\n+                determinismAnalysisDetails,", "originalCommit": "6105c5cdadd8fca72aa09a0e3ccc5e764aa05323", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4NTk3MA==", "url": "https://github.com/prestodb/presto/pull/15101#discussion_r486485970", "bodyText": "done, also removed deprecated field deterministic from VerifierQueryEvent.", "author": "caithagoras", "createdAt": "2020-09-10T16:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzOTE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3MzMxOQ==", "url": "https://github.com/prestodb/presto/pull/15101#discussion_r486473319", "bodyText": "nit: maybe determinismAnalysis?", "author": "sujay-jain", "createdAt": "2020-09-10T16:22:35Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/event/DeterminismAnalysisDetails.java", "diffHunk": "@@ -28,26 +29,41 @@\n import static com.facebook.presto.verifier.framework.LimitQueryDeterminismAnalysis.NOT_RUN;\n import static com.google.common.base.Preconditions.checkState;\n import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n \n @Immutable\n @EventType(\"DeterminismAnalysisDetails\")\n public class DeterminismAnalysisDetails\n {\n+    private final DeterminismAnalysis analysis;\n     private final List<DeterminismAnalysisRun> runs;\n     private final String limitQueryAnalysis;\n     private final String limitQueryAnalysisQueryId;\n \n     @JsonCreator\n     public DeterminismAnalysisDetails(\n+            DeterminismAnalysis analysis,", "originalCommit": "5dd8d162fb154167dcb6f692d84d7a57b40ba999", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4NTgwNQ==", "url": "https://github.com/prestodb/presto/pull/15101#discussion_r486485805", "bodyText": "done", "author": "caithagoras", "createdAt": "2020-09-10T16:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3MzMxOQ=="}], "type": "inlineReview"}, {"oid": "969fe1fccdda436700886936182558ab5dc4ae57", "url": "https://github.com/prestodb/presto/commit/969fe1fccdda436700886936182558ab5dc4ae57", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-10T17:10:52Z", "type": "forcePushed"}, {"oid": "676874a8164a1cf02c9f042b8e7eecd8239d24d4", "url": "https://github.com/prestodb/presto/commit/676874a8164a1cf02c9f042b8e7eecd8239d24d4", "message": "Minor fixes in Verifier", "committedDate": "2020-09-10T19:30:46Z", "type": "commit"}, {"oid": "efd7a6fee1909efc0f5c9e01d1ef58d954c9b0c6", "url": "https://github.com/prestodb/presto/commit/efd7a6fee1909efc0f5c9e01d1ef58d954c9b0c6", "message": "Extract query rewrite from AbstractVerification", "committedDate": "2020-09-10T19:31:06Z", "type": "commit"}, {"oid": "d7d4d0781b6b0ff68ecffbdc5d6ae9f887586da3", "url": "https://github.com/prestodb/presto/commit/d7d4d0781b6b0ff68ecffbdc5d6ae9f887586da3", "message": "Extract determinism analysis from AbstractVerification", "committedDate": "2020-09-10T19:31:06Z", "type": "commit"}, {"oid": "65346528776c7007b68b5a4f243b841da1149003", "url": "https://github.com/prestodb/presto/commit/65346528776c7007b68b5a4f243b841da1149003", "message": "Extract interface MatchResult\n\nConvert MatchResult to an interface and move the data-verification-\nspecific implementation of the MatchResult to DataMatchResult.", "committedDate": "2020-09-10T19:31:06Z", "type": "commit"}, {"oid": "0de3461a1a85c545e1b2310c05a898940ff8edfe", "url": "https://github.com/prestodb/presto/commit/0de3461a1a85c545e1b2310c05a898940ff8edfe", "message": "Extract class QueryBundle\n\nQueryBundle contained a field tableName, but not all query rewrites\nresult in queries with a target table. Move the field to a subclass\nDataQueryBundle.", "committedDate": "2020-09-10T19:31:06Z", "type": "commit"}, {"oid": "912fd17b724c7d4a0bf54522a487e77351d396f0", "url": "https://github.com/prestodb/presto/commit/912fd17b724c7d4a0bf54522a487e77351d396f0", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-10T19:31:06Z", "type": "commit"}, {"oid": "912fd17b724c7d4a0bf54522a487e77351d396f0", "url": "https://github.com/prestodb/presto/commit/912fd17b724c7d4a0bf54522a487e77351d396f0", "message": "Support explain verification\n\nAdd a new functionality to the verifier to allow explain verification.\n\nFor each query pairs to be verified, explain both control and test, and\ncompare the query plans. Verification is marked as succeeded as long as\nthe test query can be explained.\n\nIntroduced a new field matchType in the output event, which can be used\nto indicate whether there is plan difference.\n\nFor non-DML queries, we don't care much about plan difference and hence\nthe control query and plan comparison are skipped.", "committedDate": "2020-09-10T19:31:06Z", "type": "forcePushed"}]}