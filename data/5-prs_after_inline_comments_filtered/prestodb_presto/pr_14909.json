{"pr_number": 14909, "pr_title": "Implement Window Function Spilling", "pr_createdAt": "2020-07-28T17:57:53Z", "pr_url": "https://github.com/prestodb/presto/pull/14909", "timeline": [{"oid": "7b64ae7f5a6a2b9061fa5bfa080de270e80177a3", "url": "https://github.com/prestodb/presto/commit/7b64ae7f5a6a2b9061fa5bfa080de270e80177a3", "message": "Port window operator to work processors\n\nCherry-pick of https://github.com/prestosql/presto/commit/17e3e09674972c6b627eb454f1e50628943af262\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-28T16:17:11Z", "type": "commit"}, {"oid": "78bce8b6ee3e8debb1aca1d128818a50e2bdeb2b", "url": "https://github.com/prestodb/presto/commit/78bce8b6ee3e8debb1aca1d128818a50e2bdeb2b", "message": "Separate input PageSource work processor\nThis avoids calling `Page.getRegion` on the input page and separates\ninput management from index building.\n\nCherry-pick of https://github.com/prestosql/presto/commit/b164253c7ffe9c01513f97d627a9410bfb9ae691\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-28T16:17:34Z", "type": "commit"}, {"oid": "c70a756973facf3a7b5d6e140f10e73266c70a98", "url": "https://github.com/prestodb/presto/commit/c70a756973facf3a7b5d6e140f10e73266c70a98", "message": "Introduce revocable aggregated memory context in OperatorContext\n\nCherry-pick of https://github.com/prestosql/presto/commit/7200a16fc16d74a6c783ea287b0055f5267316d3\n\nCo-authored-by: Atri Sharma <atri@linux.com>", "committedDate": "2020-07-28T16:23:13Z", "type": "commit"}, {"oid": "22db7c2926a119eb8dff4147da0568ad82526e16", "url": "https://github.com/prestodb/presto/commit/22db7c2926a119eb8dff4147da0568ad82526e16", "message": "Implement spill to disk For WindowOperator\n\nCherry-pick of https://github.com/prestosql/presto/commit/d398d1c374a8d56e21a95ea3b6b84a4a5ff98268\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-28T16:47:02Z", "type": "commit"}, {"oid": "4201ee8cdf31197dc3875ef364bf00cd1fbe409a", "url": "https://github.com/prestodb/presto/commit/4201ee8cdf31197dc3875ef364bf00cd1fbe409a", "message": "Use OrderingCompiler in WindowOperator spilling\n\nCherry-pick of https://github.com/prestosql/presto/commit/2b821e129712918fbc04fa58722633adcd4dd9f8\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-28T17:25:21Z", "type": "commit"}, {"oid": "3943eab82865250ab304474b260c7fa3b73d0edd", "url": "https://github.com/prestodb/presto/commit/3943eab82865250ab304474b260c7fa3b73d0edd", "message": "Convert revocable memory to user memory on fully buffered group\n\nCherry-pick of https://github.com/prestosql/presto/commit/d76a830ae0c21e5689e55ec63374dd6257c71ab0\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-28T17:49:56Z", "type": "commit"}, {"oid": "e95517d6569cf5523943608a4f4be56e4911e15e", "url": "https://github.com/prestodb/presto/commit/e95517d6569cf5523943608a4f4be56e4911e15e", "message": "Extract window queries tests to separate class\n\nCherry-pick of https://github.com/prestosql/presto/commit/fcc18ff1c5360efdc43ac40629ad2845065de97c\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>", "committedDate": "2020-07-28T17:50:32Z", "type": "commit"}, {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81", "url": "https://github.com/prestodb/presto/commit/cb5bfd9944ef61bfe52bef6fdd881187aa520a81", "message": "Close spiller in Operator#close() for window spilling", "committedDate": "2020-07-28T17:56:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDc0Mw==", "url": "https://github.com/prestodb/presto/pull/14909#discussion_r463350743", "bodyText": "This looks quite general, surprised not added before when adding aggregation spilling", "author": "wenleix", "createdAt": "2020-07-31T00:58:21Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/OperatorContext.java", "diffHunk": "@@ -264,6 +264,12 @@ public AggregatedMemoryContext aggregateUserMemoryContext()\n         return new InternalAggregatedMemoryContext(operatorMemoryContext.aggregateUserMemoryContext(), memoryFuture, this::updatePeakMemoryReservations, false);\n     }\n \n+    // caller shouldn't close this context as it's managed by the OperatorContext\n+    public AggregatedMemoryContext aggregateRevocableMemoryContext()", "originalCommit": "c70a756973facf3a7b5d6e140f10e73266c70a98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1NDUxMQ==", "url": "https://github.com/prestodb/presto/pull/14909#discussion_r464654511", "bodyText": "I assume \"us\" here means this window operator itself, especially SpillablePagesToPagesIndexes#process", "author": "wenleix", "createdAt": "2020-08-03T20:49:20Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/WindowOperator.java", "diffHunk": "@@ -567,12 +567,14 @@ void updateMemoryUsage()\n         final SpillerFactory spillerFactory;\n         final PageWithPositionComparator pageWithPositionComparator;\n \n+        boolean spillingWhenConvertingRevocableMemory;\n         boolean resetPagesIndex;\n         int pendingInputPosition;\n \n         Optional<Page> currentSpillGroupRowPage;\n         Optional<Spiller> spiller;\n-        ListenableFuture<?> spillInProgress = immediateFuture(null);\n+        // Spill can be trigger by Driver, by us or both. `spillInProgress` is not empty when spill was triggered but not `finishMemoryRevoke()` yet", "originalCommit": "3943eab82865250ab304474b260c7fa3b73d0edd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}