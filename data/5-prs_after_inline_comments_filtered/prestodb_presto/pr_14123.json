{"pr_number": 14123, "pr_title": "Optimize aggregation of nulls", "pr_createdAt": "2020-02-20T15:53:07Z", "pr_url": "https://github.com/prestodb/presto/pull/14123", "timeline": [{"oid": "da7c93ccd111317497984cd6e2549ff29dc9054d", "url": "https://github.com/prestodb/presto/commit/da7c93ccd111317497984cd6e2549ff29dc9054d", "message": "Optimize aggregation of nulls", "committedDate": "2020-02-21T16:19:32Z", "type": "forcePushed"}, {"oid": "499166c91bbc2a576e74643eeb4b73c9c1832360", "url": "https://github.com/prestodb/presto/commit/499166c91bbc2a576e74643eeb4b73c9c1832360", "message": "Add position to 'position is not valid' error message", "committedDate": "2020-02-21T16:20:24Z", "type": "commit"}, {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048", "url": "https://github.com/prestodb/presto/commit/8957d8603c015528bfa95a9f7dedd347fbade048", "message": "Optimize aggregation of nulls", "committedDate": "2020-02-21T16:20:25Z", "type": "commit"}, {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048", "url": "https://github.com/prestodb/presto/commit/8957d8603c015528bfa95a9f7dedd347fbade048", "message": "Optimize aggregation of nulls", "committedDate": "2020-02-21T16:20:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MDYzNQ==", "url": "https://github.com/prestodb/presto/pull/14123#discussion_r382870635", "bodyText": "nit: what about if (!(%s ... (basically add a space", "author": "wenleix", "createdAt": "2020-02-22T01:09:47Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/AccumulatorCompiler.java", "diffHunk": "@@ -543,14 +545,32 @@ private static BytecodeBlock generateInputForLoop(\n                         .invokeStatic(CompilerOperations.class, \"testMask\", boolean.class, Block.class, int.class))\n                 .ifTrue(loopBody);\n \n-        block.append(new ForLoop()\n+        BytecodeNode forLoop = new ForLoop()\n                 .initialize(new BytecodeBlock().putVariable(positionVariable, 0))\n                 .condition(new BytecodeBlock()\n                         .getVariable(positionVariable)\n                         .getVariable(rowsVariable)\n                         .invokeStatic(CompilerOperations.class, \"lessThan\", boolean.class, int.class, int.class))\n                 .update(new BytecodeBlock().incrementVariable(positionVariable, (byte) 1))\n-                .body(loopBody));\n+                .body(loopBody);\n+\n+        for (int i = 0; i < parameterVariables.size(); i++) {\n+            if (!nullable.get(i)) {\n+                Variable variableDefinition = parameterVariables.get(i);\n+                forLoop = new IfStatement(\"if(!(%s instanceof RunLengthEncodedBlock && %s.isNull(0)))\", variableDefinition.getName(), variableDefinition.getName())", "originalCommit": "8957d8603c015528bfa95a9f7dedd347fbade048", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjA4OA==", "url": "https://github.com/prestodb/presto/pull/14123#discussion_r382872088", "bodyText": "@wenleix I was matching other comments in this file. They don't have space.\nloopBody = new IfStatement(\"if(testMask(%s, position))\", masksBlock.getName())\n\nloopBody = new IfStatement(\"if(!%s.isNull(position))\", variableDefinition.getName())", "author": "mbasmanova", "createdAt": "2020-02-22T01:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MDYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MDk3NA==", "url": "https://github.com/prestodb/presto/pull/14123#discussion_r382870974", "bodyText": "My understanding is this if-statement is required in case the RLE block has 0 position count, so the block.isNull(0)  on line 560 will fail.\nDoes it make sense to do the empty block check in the line 560 check? i.e.\n   if (!(block instanceof RunLengthEncodedBlock && block.getPositionCount() != 0 && block.isNull(0))) {\n        // for loop....\n   }", "author": "wenleix", "createdAt": "2020-02-22T01:12:36Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/AccumulatorCompiler.java", "diffHunk": "@@ -543,14 +545,32 @@ private static BytecodeBlock generateInputForLoop(\n                         .invokeStatic(CompilerOperations.class, \"testMask\", boolean.class, Block.class, int.class))\n                 .ifTrue(loopBody);\n \n-        block.append(new ForLoop()\n+        BytecodeNode forLoop = new ForLoop()\n                 .initialize(new BytecodeBlock().putVariable(positionVariable, 0))\n                 .condition(new BytecodeBlock()\n                         .getVariable(positionVariable)\n                         .getVariable(rowsVariable)\n                         .invokeStatic(CompilerOperations.class, \"lessThan\", boolean.class, int.class, int.class))\n                 .update(new BytecodeBlock().incrementVariable(positionVariable, (byte) 1))\n-                .body(loopBody));\n+                .body(loopBody);\n+\n+        for (int i = 0; i < parameterVariables.size(); i++) {\n+            if (!nullable.get(i)) {\n+                Variable variableDefinition = parameterVariables.get(i);\n+                forLoop = new IfStatement(\"if(!(%s instanceof RunLengthEncodedBlock && %s.isNull(0)))\", variableDefinition.getName(), variableDefinition.getName())\n+                        .condition(and(\n+                                variableDefinition.instanceOf(RunLengthEncodedBlock.class),\n+                                variableDefinition.invoke(\"isNull\", boolean.class, constantInt(0))))\n+                        .ifFalse(forLoop);\n+            }\n+        }\n+\n+        block.append(new IfStatement(\"if(%s > 0)\", rowsVariable.getName())", "originalCommit": "8957d8603c015528bfa95a9f7dedd347fbade048", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjI1NA==", "url": "https://github.com/prestodb/presto/pull/14123#discussion_r382872254", "bodyText": "this if-statement is required in case the RLE block has 0 position count, so the block.isNull(0) on line 560 will fail.\n\nThis is correct.\n\nDoes it make sense to do the empty block check in the line 560 check?\n\nI don't have any particular preference, but it seems like empty page check applies even if block not an RLE.", "author": "mbasmanova", "createdAt": "2020-02-22T01:24:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MDk3NA=="}], "type": "inlineReview"}]}