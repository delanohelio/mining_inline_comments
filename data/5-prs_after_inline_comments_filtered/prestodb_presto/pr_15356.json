{"pr_number": 15356, "pr_title": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator", "pr_createdAt": "2020-10-26T14:42:30Z", "pr_url": "https://github.com/prestodb/presto/pull/15356", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNjIyMw==", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512016223", "bodyText": "@highker probably isn't necessary to count blockBuilders in as much detail as I have done so in this PR (since it created during evaluateIntermediate at which point we are already spilling). I have included some logic to do this but we can strip it out if you see fit. I figured we should report this memory correctly just to avoid the scenario in which another operator overallocates.", "author": "sachdevs", "createdAt": "2020-10-26T14:45:40Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -589,6 +589,8 @@ public void prepareFinal()\n \n         private ObjectBigArray<GroupIdPage> rawInputs = new ObjectBigArray<>();\n         private ObjectBigArray<RowBlockBuilder> blockBuilders;\n+        private long rawInputsSizeInBytes;\n+        private long blockBuildersSizeInBytes;", "originalCommit": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNzc3Ng==", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512017776", "bodyText": "Also I'm all for removing this since  rowBlockBuilder.getRetainedSizeInBytes() is a pretty slow call (it needs to loop over all the fields and call getRetainedSize() on all of them) and it is called in a loop during blockBuilders creation.", "author": "sachdevs", "createdAt": "2020-10-26T14:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNjIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIwNDI4Mw==", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512204283", "bodyText": "also add the INSTANCE_SIZE for GroupIdPage itself: ClassLayout.parseClass(GroupIdPage.class).instanceSize();", "author": "highker", "createdAt": "2020-10-26T19:09:50Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -748,6 +762,11 @@ public GroupByIdBlock getGroupByIdBlock()\n             {\n                 return groupByIdBlock;\n             }\n+\n+            public long getRetainedSizeInBytes()\n+            {\n+                return groupByIdBlock.getRetainedSizeInBytes() + page.getRetainedSizeInBytes();", "originalCommit": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a8bbaf51876139969d1845cd001505e577a72d30", "url": "https://github.com/prestodb/presto/commit/a8bbaf51876139969d1845cd001505e577a72d30", "message": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator\n\nThis fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events.", "committedDate": "2020-10-26T19:58:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzIxOA==", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512363218", "bodyText": "This should be GroupIdPage.class", "author": "highker", "createdAt": "2020-10-27T01:31:08Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -724,12 +737,15 @@ public void prepareFinal()\n             }\n \n             rawInputs = null;\n+            rawInputsSizeInBytes = 0;\n             rawInputsLength = 0;\n             delegate.prepareFinal();\n         }\n \n         private static class GroupIdPage\n         {\n+            private static final int INSTANCE_SIZE = ClassLayout.parseClass(SpillableFinalOnlyGroupedAccumulator.class).instanceSize();", "originalCommit": "a8bbaf51876139969d1845cd001505e577a72d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1Mjg4Mw==", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512952883", "bodyText": "Nice catch", "author": "sachdevs", "createdAt": "2020-10-27T19:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzIxOA=="}], "type": "inlineReview"}, {"oid": "c4027ed1c31bf7cb6e19833769dff4bfe06217a0", "url": "https://github.com/prestodb/presto/commit/c4027ed1c31bf7cb6e19833769dff4bfe06217a0", "message": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator\n\nThis fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events.", "committedDate": "2020-10-27T19:01:13Z", "type": "commit"}, {"oid": "c4027ed1c31bf7cb6e19833769dff4bfe06217a0", "url": "https://github.com/prestodb/presto/commit/c4027ed1c31bf7cb6e19833769dff4bfe06217a0", "message": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator\n\nThis fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events.", "committedDate": "2020-10-27T19:01:13Z", "type": "forcePushed"}]}