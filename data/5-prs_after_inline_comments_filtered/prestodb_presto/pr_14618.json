{"pr_number": 14618, "pr_title": "Collect file stats", "pr_createdAt": "2020-06-05T23:08:56Z", "pr_url": "https://github.com/prestodb/presto/pull/14618", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzM3Nw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r436317377", "bodyText": "We can't have string for serialization. Reusing page/block should be the right call.", "author": "highker", "createdAt": "2020-06-07T02:15:19Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/FileColumnStatistics.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.metastore;\n+\n+public class FileColumnStatistics\n+{\n+    private final int ordinal;\n+    private final String min;\n+    private final String max;", "originalCommit": "2ef45cb47aaf32a56ef01927d0ad5d83011e01fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzM4Nw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r436317387", "bodyText": "Not sure this class is actually necessary. Check my comment below.", "author": "highker", "createdAt": "2020-06-07T02:15:37Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/FileColumnStatistics.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.metastore;\n+\n+public class FileColumnStatistics", "originalCommit": "2ef45cb47aaf32a56ef01927d0ad5d83011e01fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzQwOA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r436317408", "bodyText": "We also need to record the file size written.", "author": "highker", "createdAt": "2020-06-07T02:15:57Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/FileColumnStatistics.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.metastore;\n+\n+public class FileColumnStatistics\n+{\n+    private final int ordinal;\n+    private final String min;\n+    private final String max;\n+    private final Long rows;", "originalCommit": "2ef45cb47aaf32a56ef01927d0ad5d83011e01fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzQ1Nw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r436317457", "bodyText": "Is this used anywhere?", "author": "highker", "createdAt": "2020-06-07T02:16:40Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/FileStatistics.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.metastore;\n+\n+import java.util.List;\n+\n+public class FileStatistics", "originalCommit": "2ef45cb47aaf32a56ef01927d0ad5d83011e01fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzk0OA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r436317948", "bodyText": "The return format should be a page (or maybe a list of pages). Or if you wanna wrap it, it is also ok. But Page is the essential part for it. That allows the coordinator to write pages into manifests in ORC format.\nHere is an example:\n\n\n\nfile_prefix\nfile_name\nfile_suffix\nrows\nbytes\ncol1_min\ncol1_max\ncol1_non_null_rows\ncol2_min\ncol2_max\ncol2_non_null_rows\n\n\n\n\nws://ws.atn5/abc/\n1\n.orc\n1000\n100030\nab\nzzzd\n900\n0\n15\n1000\n\n\nws://ws.atn5/abc/\n2\n.orc\n1200\n110040\nac\nzzf\n1100\n5\n22\n1200\n\n\nws://ws.atn5/abc/\n3\n.orc\n1100\n120050\nbf\nxwf\n1000\n19\n42\n1100\n\n\n\nEach column types should be known beforehand. Or if not, types are serializable anyway, so they can be saved as List<TypeSignature>. For example, the above stats should come with column types: {varchar, varchar, varchar, bigint, bigint, varchar, varchar, bigint, bigint, integer, integer}.\nTypes and Blocks are the core data structure for Presto. So let's try to reuse them as much as possible.", "author": "highker", "createdAt": "2020-06-07T02:28:44Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileWriter.java", "diffHunk": "@@ -25,7 +28,7 @@\n \n     void appendRows(Page dataPage);\n \n-    void commit();\n+    List<FileColumnStatistics> commit();", "originalCommit": "2ef45cb47aaf32a56ef01927d0ad5d83011e01fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c0f1d21f227ae45b73b5bb4938ab6623fdeeb35e", "url": "https://github.com/prestodb/presto/commit/c0f1d21f227ae45b73b5bb4938ab6623fdeeb35e", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-09T02:50:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0MzMyMg==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r452643322", "bodyText": "We need to build the types based on the types of the table columns.", "author": "highker", "createdAt": "2020-07-10T06:18:24Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/OrcFileWriter.java", "diffHunk": "@@ -180,6 +202,64 @@ public void commit()\n                 throw new PrestoException(HIVE_WRITE_VALIDATION_FAILED, e);\n             }\n         }\n+\n+        List<ColumnStatistics> columnStatistics = new ArrayList<>();\n+        for (ColumnStatistics columnStats : orcWriter.getFileStats()) {\n+            if (columnStats.getMin() == null) {\n+                continue;\n+            }\n+            columnStatistics.add(columnStats);\n+        }\n+\n+        List<Type> types = new ArrayList<>(Arrays.asList(VARCHAR, VARCHAR, VARCHAR, BIGINT, BIGINT));", "originalCommit": "c0f1d21f227ae45b73b5bb4938ab6623fdeeb35e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODU5OA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r452968598", "bodyText": "These are for the file_prefix, file_name, file_suffix, rows, bytes of the manifest. These are fixed types irrespective of the table columns right ?", "author": "NikhilCollooru", "createdAt": "2020-07-10T17:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0MzMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0NDUxNA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r452644514", "bodyText": "This could be a good helper function somewhere in presto-hive-metastore", "author": "highker", "createdAt": "2020-07-10T06:22:17Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/OrcFileWriter.java", "diffHunk": "@@ -180,6 +202,64 @@ public void commit()\n                 throw new PrestoException(HIVE_WRITE_VALIDATION_FAILED, e);\n             }\n         }\n+\n+        List<ColumnStatistics> columnStatistics = new ArrayList<>();\n+        for (ColumnStatistics columnStats : orcWriter.getFileStats()) {\n+            if (columnStats.getMin() == null) {\n+                continue;\n+            }\n+            columnStatistics.add(columnStats);\n+        }\n+\n+        List<Type> types = new ArrayList<>(Arrays.asList(VARCHAR, VARCHAR, VARCHAR, BIGINT, BIGINT));\n+        types.addAll(columnStatistics.stream().map(ColumnStatistics::getType).flatMap(type -> ImmutableList.of(type, type, BIGINT).stream()).collect(Collectors.toList()));\n+\n+        PageBuilder statsPageBuilder = new PageBuilder(types);\n+        statsPageBuilder.declarePosition();\n+        int column = 0;\n+        VARCHAR.writeSlice(statsPageBuilder.getBlockBuilder(column++), Slices.utf8Slice(path.getParent().toString()));\n+        VARCHAR.writeSlice(statsPageBuilder.getBlockBuilder(column++), Slices.utf8Slice(path.getName()));\n+        VARCHAR.writeSlice(statsPageBuilder.getBlockBuilder(column++), Slices.utf8Slice(\".orc\"));\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) rowCount).longValue());\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) getWrittenBytes()).longValue());\n+\n+        for (ColumnStatistics statistic : columnStatistics) {\n+            Type type = types.get(column);\n+            if (BOOLEAN.equals(type)) {\n+                type.writeBoolean(statsPageBuilder.getBlockBuilder(column++), (Boolean) statistic.getMin());\n+                type.writeBoolean(statsPageBuilder.getBlockBuilder(column++), (Boolean) statistic.getMax());\n+                BIGINT.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getNumberOfValues()).longValue());\n+            }\n+            else if (INTEGER.equals(type)) {\n+                type.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getMin()).intValue());\n+                type.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getMax()).intValue());\n+                BIGINT.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getNumberOfValues()).longValue());\n+            }\n+            else if (DOUBLE.equals(type)) {\n+                type.writeDouble(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getMin()).doubleValue());\n+                type.writeDouble(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getMax()).doubleValue());\n+                BIGINT.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getNumberOfValues()).longValue());\n+            }\n+            else if (type instanceof VarcharType) {\n+                type.writeSlice(statsPageBuilder.getBlockBuilder(column++), Slices.utf8Slice((String) statistic.getMin()));\n+                type.writeSlice(statsPageBuilder.getBlockBuilder(column++), Slices.utf8Slice((String) statistic.getMax()));\n+                BIGINT.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getNumberOfValues()).longValue());\n+            }\n+            else if (DATE.equals(type)) {\n+                type.writeLong(statsPageBuilder.getBlockBuilder(column++), ((SqlDate) statistic.getMin()).getDays());\n+                type.writeLong(statsPageBuilder.getBlockBuilder(column++), ((SqlDate) statistic.getMax()).getDays());\n+                BIGINT.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getNumberOfValues()).longValue());\n+            }\n+            else if (REAL.equals(type)) {\n+                type.writeLong(statsPageBuilder.getBlockBuilder(column++), (long) floatToRawIntBits(((Number) statistic.getMin()).floatValue()));\n+                type.writeLong(statsPageBuilder.getBlockBuilder(column++), (long) floatToRawIntBits(((Number) statistic.getMax()).floatValue()));\n+                BIGINT.writeLong(statsPageBuilder.getBlockBuilder(column++), ((Number) statistic.getNumberOfValues()).longValue());\n+            }\n+            else {\n+                throw new IllegalArgumentException(\"Unsupported type \" + type);\n+            }\n+        }\n+        return Optional.of(statsPageBuilder.build());", "originalCommit": "c0f1d21f227ae45b73b5bb4938ab6623fdeeb35e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0NTI1Nw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r452645257", "bodyText": "IIRC, each commit or each HiveWriter can only create one file right? @wenleix, is that the case?", "author": "highker", "createdAt": "2020-07-10T06:24:29Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveWriter.java", "diffHunk": "@@ -82,10 +82,11 @@ public void append(Page dataPage)\n         inputSizeInBytes += dataPage.getSizeInBytes();\n     }\n \n-    public void commit()\n+    public Optional<Page> commit()\n     {\n-        fileWriter.commit();\n+        Optional<Page> fileStatistics = fileWriter.commit();", "originalCommit": "c0f1d21f227ae45b73b5bb4938ab6623fdeeb35e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODU1MA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r452968550", "bodyText": "Yes correct. One file per HiveWriter.", "author": "NikhilCollooru", "createdAt": "2020-07-10T17:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0NTI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA2OTg2Mg==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r453069862", "bodyText": "Yes. We create separate HiveWriter for each file.", "author": "wenleix", "createdAt": "2020-07-10T20:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0NTI1Nw=="}], "type": "inlineReview"}, {"oid": "06c07e8299f4f29c6c8753955350f5d508e08f67", "url": "https://github.com/prestodb/presto/commit/06c07e8299f4f29c6c8753955350f5d508e08f67", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-14T17:23:39Z", "type": "forcePushed"}, {"oid": "baa383b3fcda7cebff38926075bd71928ef3cc34", "url": "https://github.com/prestodb/presto/commit/baa383b3fcda7cebff38926075bd71928ef3cc34", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-16T04:36:32Z", "type": "forcePushed"}, {"oid": "3a5a6f81de57b422437be17750ac5b96c403b810", "url": "https://github.com/prestodb/presto/commit/3a5a6f81de57b422437be17750ac5b96c403b810", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-16T04:49:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczNTU0NQ==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456735545", "bodyText": "need to export to jmx as well", "author": "highker", "createdAt": "2020-07-18T02:02:03Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java", "diffHunk": "@@ -128,6 +128,7 @@ public void configure(Binder binder)\n         binder.bind(HivePartitionManager.class).in(Scopes.SINGLETON);\n         binder.bind(LocationService.class).to(HiveLocationService.class).in(Scopes.SINGLETON);\n         binder.bind(TableParameterCodec.class).in(Scopes.SINGLETON);\n+        binder.bind(HivePartitionStats.class).in(Scopes.SINGLETON);", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MTYwOQ==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456751609", "bodyText": "Make this into a util class outside of this class", "author": "highker", "createdAt": "2020-07-18T05:22:23Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/OrcFileWriter.java", "diffHunk": "@@ -211,4 +218,18 @@ public String toString()\n                 .add(\"writer\", orcWriter)\n                 .toString();\n     }\n+\n+    private Page getOrcFileStatistics()\n+    {\n+        // OrcFileStatistics page layout:\n+        //\n+        // fileSize   rowCount\n+        //  X             X\n+        PageBuilder statsPageBuilder = new PageBuilder(Arrays.asList(BIGINT, BIGINT));\n+        statsPageBuilder.declarePosition();\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(0), ((Number) getWrittenBytes()).longValue());\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(1), ((Number) rowCount).longValue());", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MTY5Mw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456751693", "bodyText": "use Immutablelist", "author": "highker", "createdAt": "2020-07-18T05:23:45Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/OrcFileWriter.java", "diffHunk": "@@ -211,4 +218,18 @@ public String toString()\n                 .add(\"writer\", orcWriter)\n                 .toString();\n     }\n+\n+    private Page getOrcFileStatistics()\n+    {\n+        // OrcFileStatistics page layout:\n+        //\n+        // fileSize   rowCount\n+        //  X             X\n+        PageBuilder statsPageBuilder = new PageBuilder(Arrays.asList(BIGINT, BIGINT));", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MTgzOA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456751838", "bodyText": "no need to cast to Number then use longValue(). The return type of getWrittenBytes() is already long. Same for the one below.", "author": "highker", "createdAt": "2020-07-18T05:25:27Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/OrcFileWriter.java", "diffHunk": "@@ -211,4 +218,18 @@ public String toString()\n                 .add(\"writer\", orcWriter)\n                 .toString();\n     }\n+\n+    private Page getOrcFileStatistics()\n+    {\n+        // OrcFileStatistics page layout:\n+        //\n+        // fileSize   rowCount\n+        //  X             X\n+        PageBuilder statsPageBuilder = new PageBuilder(Arrays.asList(BIGINT, BIGINT));\n+        statsPageBuilder.declarePosition();\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(0), ((Number) getWrittenBytes()).longValue());", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MTk4NQ==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456751985", "bodyText": "need initialization = Optional.empty()", "author": "highker", "createdAt": "2020-07-18T05:27:54Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveWriter.java", "diffHunk": "@@ -37,6 +39,7 @@\n \n     private long rowCount;\n     private long inputSizeInBytes;\n+    private Optional<Page> fileStatistics;", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MjAxMg==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456752012", "bodyText": "remove", "author": "highker", "createdAt": "2020-07-18T05:28:19Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveWriter.java", "diffHunk": "@@ -84,8 +87,9 @@ public void append(Page dataPage)\n \n     public void commit()\n     {\n-        fileWriter.commit();\n+        fileStatistics = fileWriter.commit();\n         onCommit.accept(this);\n+        return;", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MjA3Ng==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456752076", "bodyText": "Move this to the same util class. We need a central place to encode and decode states info from/to pages", "author": "highker", "createdAt": "2020-07-18T05:29:12Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveWriter.java", "diffHunk": "@@ -110,12 +114,27 @@ public PartitionUpdate getPartitionUpdate()\n                 updateMode,\n                 writePath,\n                 targetPath,\n-                ImmutableList.of(fileWriteInfo),\n+                ImmutableList.of(new FileWriteInfo(fileWriteInfo.getWriteFileName(), fileWriteInfo.getTargetFileName(), getFileSize())),\n                 rowCount,\n                 inputSizeInBytes,\n                 fileWriter.getWrittenBytes());\n     }\n \n+    private Optional<Long> getFileSize()\n+    {\n+        if (fileStatistics.isPresent()) {\n+            // FileStatistics page layout:\n+            //\n+            // fileSize   rowCount\n+            //  X             X\n+\n+            Block fileSizeBlock = fileStatistics.get().getBlock(0);\n+            return Optional.of(BIGINT.getLong(fileSizeBlock, 0));", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MjE4OA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456752188", "bodyText": "assert fileStatistics has exact two columns and one row", "author": "highker", "createdAt": "2020-07-18T05:30:12Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveWriter.java", "diffHunk": "@@ -110,12 +114,27 @@ public PartitionUpdate getPartitionUpdate()\n                 updateMode,\n                 writePath,\n                 targetPath,\n-                ImmutableList.of(fileWriteInfo),\n+                ImmutableList.of(new FileWriteInfo(fileWriteInfo.getWriteFileName(), fileWriteInfo.getTargetFileName(), getFileSize())),\n                 rowCount,\n                 inputSizeInBytes,\n                 fileWriter.getWrittenBytes());\n     }\n \n+    private Optional<Long> getFileSize()\n+    {\n+        if (fileStatistics.isPresent()) {\n+            // FileStatistics page layout:\n+            //\n+            // fileSize   rowCount\n+            //  X             X\n+\n+            Block fileSizeBlock = fileStatistics.get().getBlock(0);", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1Mjc0OA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456752748", "bodyText": "Can we have unittests to make sure the stats match the actual file written? A good place is AbstractTestHiveFileFormats.createTestFile. Just commit the file, get stats, and assert the file size is the same as the one recorded.", "author": "highker", "createdAt": "2020-07-18T05:37:24Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/OrcFileWriter.java", "diffHunk": "@@ -146,14 +150,15 @@ public void appendRows(Page dataPage)\n         Page page = new Page(dataPage.getPositionCount(), blocks);\n         try {\n             orcWriter.write(page);\n+            rowCount += page.getPositionCount();\n         }\n         catch (IOException | UncheckedIOException e) {\n             throw new PrestoException(HIVE_WRITER_DATA_ERROR, e);\n         }\n     }\n \n     @Override\n-    public void commit()\n+    public Optional<Page> commit()", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MjgwNA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456752804", "bodyText": "Put into the same util class", "author": "highker", "createdAt": "2020-07-18T05:38:16Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1869,6 +1882,30 @@ else if (partitionUpdate.getUpdateMode() == NEW || partitionUpdate.getUpdateMode\n                         .collect(Collectors.toList())));\n     }\n \n+    private Optional<Page> getPartitionManifest(PartitionUpdate partitionUpdate)\n+    {\n+        // Manifest Page layout:\n+        //   fileName    fileSize\n+        //      X           X\n+        //      X           X\n+        //      X           X\n+        // ....\n+        PageBuilder manifestBuilder = new PageBuilder(Arrays.asList(VARBINARY, BIGINT));\n+        BlockBuilder fileNameBuilder = manifestBuilder.getBlockBuilder(0);\n+        BlockBuilder fileSizeBuilder = manifestBuilder.getBlockBuilder(1);\n+        for (FileWriteInfo fileWriteInfo : partitionUpdate.getFileWriteInfos()) {\n+            if (fileWriteInfo.getFileSize().isPresent()) {\n+                manifestBuilder.declarePosition();\n+                VARBINARY.writeSlice(fileNameBuilder, utf8Slice(fileWriteInfo.getWriteFileName()));\n+                BIGINT.writeLong(fileSizeBuilder, fileWriteInfo.getFileSize().get());\n+            }\n+            else {\n+                return Optional.empty();\n+            }\n+        }\n+        return Optional.of(manifestBuilder.build());", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1Mjg2NQ==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456752865", "bodyText": "this should be VARCHAR", "author": "highker", "createdAt": "2020-07-18T05:39:10Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1869,6 +1882,30 @@ else if (partitionUpdate.getUpdateMode() == NEW || partitionUpdate.getUpdateMode\n                         .collect(Collectors.toList())));\n     }\n \n+    private Optional<Page> getPartitionManifest(PartitionUpdate partitionUpdate)\n+    {\n+        // Manifest Page layout:\n+        //   fileName    fileSize\n+        //      X           X\n+        //      X           X\n+        //      X           X\n+        // ....\n+        PageBuilder manifestBuilder = new PageBuilder(Arrays.asList(VARBINARY, BIGINT));\n+        BlockBuilder fileNameBuilder = manifestBuilder.getBlockBuilder(0);\n+        BlockBuilder fileSizeBuilder = manifestBuilder.getBlockBuilder(1);\n+        for (FileWriteInfo fileWriteInfo : partitionUpdate.getFileWriteInfos()) {\n+            if (fileWriteInfo.getFileSize().isPresent()) {\n+                manifestBuilder.declarePosition();\n+                VARBINARY.writeSlice(fileNameBuilder, utf8Slice(fileWriteInfo.getWriteFileName()));", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MzE3NA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r456753174", "bodyText": "Add a TODO. We need to put the blob into partition parameters.", "author": "highker", "createdAt": "2020-07-18T05:42:53Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1832,6 +1840,11 @@ else if (partitionUpdate.getUpdateMode() == NEW || partitionUpdate.getUpdateMode\n                 Map<String, String> extraPartitionMetadata = handle.getEncryptionInformation()\n                         .map(encryptionInfo -> encryptionInfo.getDwrfEncryptionMetadata().map(DwrfEncryptionMetadata::getExtraMetadata).orElseGet(ImmutableMap::of))\n                         .orElseGet(ImmutableMap::of);\n+\n+                // Track the manifest blob size\n+                Optional<Page> manifestBlob = getPartitionManifest(partitionUpdate);\n+                manifestBlob.ifPresent(manifest -> hivePartitionStats.addManifestSizeInBytes(manifest.getSizeInBytes()));\n+", "originalCommit": "3a5a6f81de57b422437be17750ac5b96c403b810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7807e501d376af4ced2a03a39a49062a072d0f34", "url": "https://github.com/prestodb/presto/commit/7807e501d376af4ced2a03a39a49062a072d0f34", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-19T23:47:23Z", "type": "forcePushed"}, {"oid": "69feafde9512c7977487ca76855c4bd28459e90c", "url": "https://github.com/prestodb/presto/commit/69feafde9512c7977487ca76855c4bd28459e90c", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-21T19:23:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MzIwNA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459063204", "bodyText": "Remove this class. Just create a new entry in HiveErrorCode", "author": "highker", "createdAt": "2020-07-22T20:28:06Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveInvalidFileStatisticsException.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import static java.lang.String.format;\n+\n+public class HiveInvalidFileStatisticsException", "originalCommit": "69feafde9512c7977487ca76855c4bd28459e90c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NTE1Mw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459065153", "bodyText": "The input doesn't have to be optional. If the user use optional, then it is expected to have empty return.\nUse getFileSize(Page statisticsPage, int position). Check our Page interface. position is very important as users can pass a large page (with many rows) and just get the one wanted.", "author": "highker", "createdAt": "2020-07-22T20:31:49Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.PageBuilder;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.Optional;\n+\n+import static com.facebook.presto.common.type.BigintType.BIGINT;\n+import static com.facebook.presto.common.type.VarcharType.VARCHAR;\n+import static com.facebook.presto.hive.PartitionUpdate.FileWriteInfo;\n+import static io.airlift.slice.Slices.utf8Slice;\n+\n+public class HiveManifestUtils\n+{\n+    private HiveManifestUtils()\n+    {\n+    }\n+\n+    public static Page createFileStatisticsPage(long fileSize, long rowCount)\n+    {\n+        // FileStatistics page layout:\n+        //\n+        // fileSize   rowCount\n+        //  X             X\n+        PageBuilder statsPageBuilder = new PageBuilder(ImmutableList.of(BIGINT, BIGINT));\n+        statsPageBuilder.declarePosition();\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(0), fileSize);\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(1), rowCount);\n+\n+        return statsPageBuilder.build();\n+    }\n+\n+    public static Optional<Long> getFileSize(Optional<Page> statisticsPage)", "originalCommit": "69feafde9512c7977487ca76855c4bd28459e90c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA5OTUxMQ==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459099511", "bodyText": "The statistics page should only have 1 row , because it holds the statistics of only one file. We should probably throw exception when there are more than 1 row right ? why should we have the position parameter ?\nI mean we should throw exception if users send pages with more than 1 row. WDYT ?", "author": "NikhilCollooru", "createdAt": "2020-07-22T21:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NTE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwMDIzMA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459100230", "bodyText": "This is for future genericity. When we design interfaces, we need to make sure the interface is general", "author": "highker", "createdAt": "2020-07-22T21:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NTE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NTY1OQ==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459065659", "bodyText": "nit:\nif (!fileWriteInfo.getFileSize().isPresent()) {\n    return Optional.empty();\n}\n\n...", "author": "highker", "createdAt": "2020-07-22T20:32:47Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.PageBuilder;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.Optional;\n+\n+import static com.facebook.presto.common.type.BigintType.BIGINT;\n+import static com.facebook.presto.common.type.VarcharType.VARCHAR;\n+import static com.facebook.presto.hive.PartitionUpdate.FileWriteInfo;\n+import static io.airlift.slice.Slices.utf8Slice;\n+\n+public class HiveManifestUtils\n+{\n+    private HiveManifestUtils()\n+    {\n+    }\n+\n+    public static Page createFileStatisticsPage(long fileSize, long rowCount)\n+    {\n+        // FileStatistics page layout:\n+        //\n+        // fileSize   rowCount\n+        //  X             X\n+        PageBuilder statsPageBuilder = new PageBuilder(ImmutableList.of(BIGINT, BIGINT));\n+        statsPageBuilder.declarePosition();\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(0), fileSize);\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(1), rowCount);\n+\n+        return statsPageBuilder.build();\n+    }\n+\n+    public static Optional<Long> getFileSize(Optional<Page> statisticsPage)\n+    {\n+        if (statisticsPage.isPresent()) {\n+            // FileStatistics page layout:\n+            //\n+            // fileSize   rowCount\n+            //  X             X\n+\n+            Page fileStatistics = statisticsPage.get();\n+            if (fileStatistics.getPositionCount() != 1 || fileStatistics.getChannelCount() != 2) {\n+                throw new HiveInvalidFileStatisticsException(fileStatistics.getPositionCount(), fileStatistics.getChannelCount());\n+            }\n+            return Optional.of(BIGINT.getLong(fileStatistics.getBlock(0), 0));\n+        }\n+\n+        return Optional.empty();\n+    }\n+\n+    public static Optional<Page> createPartitionManifest(PartitionUpdate partitionUpdate)\n+    {\n+        // Manifest Page layout:\n+        //   fileName    fileSize\n+        //      X           X\n+        //      X           X\n+        //      X           X\n+        // ....\n+        PageBuilder manifestBuilder = new PageBuilder(ImmutableList.of(VARCHAR, BIGINT));\n+        BlockBuilder fileNameBuilder = manifestBuilder.getBlockBuilder(0);\n+        BlockBuilder fileSizeBuilder = manifestBuilder.getBlockBuilder(1);\n+        for (FileWriteInfo fileWriteInfo : partitionUpdate.getFileWriteInfos()) {\n+            if (fileWriteInfo.getFileSize().isPresent()) {\n+                manifestBuilder.declarePosition();\n+                VARCHAR.writeSlice(fileNameBuilder, utf8Slice(fileWriteInfo.getWriteFileName()));\n+                BIGINT.writeLong(fileSizeBuilder, fileWriteInfo.getFileSize().get());\n+            }\n+            else {\n+                return Optional.empty();\n+            }", "originalCommit": "69feafde9512c7977487ca76855c4bd28459e90c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NjQ2OA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459066468", "bodyText": "Just throw", "author": "highker", "createdAt": "2020-07-22T20:34:29Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveWriter.java", "diffHunk": "@@ -105,12 +110,21 @@ public void rollback()\n \n     public PartitionUpdate getPartitionUpdate()\n     {\n+        Optional<Long> fileSize;\n+        try {\n+            fileSize = getFileSize(fileStatistics);\n+        }\n+        catch (HiveInvalidFileStatisticsException e) {\n+            fileSize = Optional.empty();\n+            log.error(e);\n+        }", "originalCommit": "69feafde9512c7977487ca76855c4bd28459e90c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NjUwNw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459066507", "bodyText": "remove", "author": "highker", "createdAt": "2020-07-22T20:34:33Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveWriter.java", "diffHunk": "@@ -21,11 +22,14 @@\n import java.util.Optional;\n import java.util.function.Consumer;\n \n+import static com.facebook.presto.hive.HiveManifestUtils.getFileSize;\n import static com.google.common.base.MoreObjects.toStringHelper;\n import static java.util.Objects.requireNonNull;\n \n public class HiveWriter\n {\n+    private static final Logger log = Logger.get(HiveWriter.class);", "originalCommit": "69feafde9512c7977487ca76855c4bd28459e90c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NzEwNw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459067107", "bodyText": "It should alway present if it's an ORC file", "author": "highker", "createdAt": "2020-07-22T20:35:38Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java", "diffHunk": "@@ -543,11 +544,23 @@ public static FileSplit createTestFile(\n \n         HiveFileWriter hiveFileWriter = fileWriter.orElseThrow(() -> new IllegalArgumentException(\"fileWriterFactory\"));\n         hiveFileWriter.appendRows(page);\n-        hiveFileWriter.commit();\n+        Optional<Page> fileStatistics = hiveFileWriter.commit();\n+\n+        assertFileStatistics(fileStatistics, hiveFileWriter.getWrittenBytes());\n \n         return new FileSplit(new Path(filePath), 0, new File(filePath).length(), new String[0]);\n     }\n \n+    private static void assertFileStatistics(Optional<Page> fileStatistics, long writtenBytes)\n+    {\n+        if (fileStatistics.isPresent()) {", "originalCommit": "69feafde9512c7977487ca76855c4bd28459e90c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NzQ0MQ==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459067441", "bodyText": "make them final\ncapitalize all letters with underscores.", "author": "highker", "createdAt": "2020-07-22T20:36:12Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveManifestUtils.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.PageBuilder;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.google.common.collect.ImmutableList;\n+import org.testng.annotations.Test;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.common.type.BigintType.BIGINT;\n+import static com.facebook.presto.common.type.StandardTypes.BOOLEAN;\n+import static com.facebook.presto.common.type.StandardTypes.DOUBLE;\n+import static com.facebook.presto.common.type.StandardTypes.VARCHAR;\n+import static com.facebook.presto.hive.HiveManifestUtils.createFileStatisticsPage;\n+import static com.facebook.presto.hive.HiveManifestUtils.createPartitionManifest;\n+import static com.facebook.presto.hive.HiveManifestUtils.getFileSize;\n+import static com.facebook.presto.hive.PartitionUpdate.FileWriteInfo;\n+import static com.facebook.presto.hive.PartitionUpdate.UpdateMode.NEW;\n+import static io.airlift.slice.Slices.utf8Slice;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestHiveManifestUtils\n+{\n+    private static long fileSize = 1024;\n+    private static long rowCount = 100;", "originalCommit": "69feafde9512c7977487ca76855c4bd28459e90c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9622bb945dd606ff933b00e3a48a2b01151d3a2b", "url": "https://github.com/prestodb/presto/commit/9622bb945dd606ff933b00e3a48a2b01151d3a2b", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-22T22:33:26Z", "type": "forcePushed"}, {"oid": "05df5ce5c24d1bbb573519c6098884351ebb9241", "url": "https://github.com/prestodb/presto/commit/05df5ce5c24d1bbb573519c6098884351ebb9241", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-22T23:12:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNDMyMg==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459804322", "bodyText": "MALFORMED_HIVE_FILE_STATISTICS", "author": "highker", "createdAt": "2020-07-24T00:51:46Z", "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveErrorCode.java", "diffHunk": "@@ -69,6 +69,7 @@\n     // To be used for metadata inconsistencies and not for incorrect input from users\n     HIVE_INVALID_ENCRYPTION_METADATA(42, EXTERNAL),\n     HIVE_UNSUPPORTED_ENCRYPTION_OPERATION(43, USER_ERROR),\n+    HIVE_INVALID_FILE_STATISTICS_POSITION(44, INTERNAL_ERROR),", "originalCommit": "05df5ce5c24d1bbb573519c6098884351ebb9241", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNzAyMw==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459807023", "bodyText": "Make 0 and 1 two constants: FILE_SIZE_CHANNEL and ROW_COUNT_CHANNEL", "author": "highker", "createdAt": "2020-07-24T01:03:43Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.PageBuilder;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.spi.PrestoException;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.Optional;\n+\n+import static com.facebook.presto.common.type.BigintType.BIGINT;\n+import static com.facebook.presto.common.type.VarcharType.VARCHAR;\n+import static com.facebook.presto.hive.HiveErrorCode.HIVE_INVALID_FILE_STATISTICS_POSITION;\n+import static com.facebook.presto.hive.PartitionUpdate.FileWriteInfo;\n+import static io.airlift.slice.Slices.utf8Slice;\n+import static java.lang.String.format;\n+\n+public class HiveManifestUtils\n+{\n+    private HiveManifestUtils()\n+    {\n+    }\n+\n+    public static Page createFileStatisticsPage(long fileSize, long rowCount)\n+    {\n+        // FileStatistics page layout:\n+        //\n+        // fileSize   rowCount\n+        //  X             X\n+        PageBuilder statsPageBuilder = new PageBuilder(ImmutableList.of(BIGINT, BIGINT));\n+        statsPageBuilder.declarePosition();\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(0), fileSize);\n+        BIGINT.writeLong(statsPageBuilder.getBlockBuilder(1), rowCount);", "originalCommit": "05df5ce5c24d1bbb573519c6098884351ebb9241", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNzE0NQ==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459807145", "bodyText": "getRetainedSizeInBytes", "author": "highker", "createdAt": "2020-07-24T01:04:15Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1836,6 +1841,12 @@ else if (partitionUpdate.getUpdateMode() == NEW || partitionUpdate.getUpdateMode\n                 Map<String, String> extraPartitionMetadata = handle.getEncryptionInformation()\n                         .map(encryptionInfo -> encryptionInfo.getDwrfEncryptionMetadata().map(DwrfEncryptionMetadata::getExtraMetadata).orElseGet(ImmutableMap::of))\n                         .orElseGet(ImmutableMap::of);\n+\n+                // TODO: Put the manifest blob in partition parameters\n+                // Track the manifest blob size\n+                Optional<Page> manifestBlob = createPartitionManifest(partitionUpdate);\n+                manifestBlob.ifPresent(manifest -> hivePartitionStats.addManifestSizeInBytes(manifest.getSizeInBytes()));", "originalCommit": "05df5ce5c24d1bbb573519c6098884351ebb9241", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNzYwMA==", "url": "https://github.com/prestodb/presto/pull/14618#discussion_r459807600", "bodyText": "and DWRF", "author": "highker", "createdAt": "2020-07-24T01:06:07Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java", "diffHunk": "@@ -543,11 +545,23 @@ public static FileSplit createTestFile(\n \n         HiveFileWriter hiveFileWriter = fileWriter.orElseThrow(() -> new IllegalArgumentException(\"fileWriterFactory\"));\n         hiveFileWriter.appendRows(page);\n-        hiveFileWriter.commit();\n+        Optional<Page> fileStatistics = hiveFileWriter.commit();\n+\n+        assertFileStatistics(fileStatistics, hiveFileWriter.getWrittenBytes(), storageFormat);\n \n         return new FileSplit(new Path(filePath), 0, new File(filePath).length(), new String[0]);\n     }\n \n+    private static void assertFileStatistics(Optional<Page> fileStatistics, long writtenBytes, HiveStorageFormat storageFormat)\n+    {\n+        if (storageFormat == ORC) {", "originalCommit": "05df5ce5c24d1bbb573519c6098884351ebb9241", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d82211163485ddfc66b90da8f8857a9474ff534b", "url": "https://github.com/prestodb/presto/commit/d82211163485ddfc66b90da8f8857a9474ff534b", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-24T01:23:13Z", "type": "commit"}, {"oid": "d82211163485ddfc66b90da8f8857a9474ff534b", "url": "https://github.com/prestodb/presto/commit/d82211163485ddfc66b90da8f8857a9474ff534b", "message": "Collect statistics of files committed by OrcFileWriter", "committedDate": "2020-07-24T01:23:13Z", "type": "forcePushed"}]}