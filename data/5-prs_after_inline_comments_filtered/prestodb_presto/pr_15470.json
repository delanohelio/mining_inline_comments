{"pr_number": 15470, "pr_title": "Ensure nullable partitioning column is handled properly", "pr_createdAt": "2020-11-23T04:07:10Z", "pr_url": "https://github.com/prestodb/presto/pull/15470", "timeline": [{"oid": "104ea5ed0381f79ed2564cda7ed2e04311c3d5f7", "url": "https://github.com/prestodb/presto/commit/104ea5ed0381f79ed2564cda7ed2e04311c3d5f7", "message": "Ensure nullable partitioning column is handled properly", "committedDate": "2020-11-29T07:30:14Z", "type": "forcePushed"}, {"oid": "bf9252927ea07c36b02817e2bcd3e6876d9cf851", "url": "https://github.com/prestodb/presto/commit/bf9252927ea07c36b02817e2bcd3e6876d9cf851", "message": "Ensure nullable partitioning column is handled properly", "committedDate": "2020-12-01T19:56:40Z", "type": "forcePushed"}, {"oid": "57e27f3a86a2fedbd117aca244077e5c6c54cede", "url": "https://github.com/prestodb/presto/commit/57e27f3a86a2fedbd117aca244077e5c6c54cede", "message": "Ensure nullable partitioning column is handled properly", "committedDate": "2020-12-03T05:26:02Z", "type": "forcePushed"}, {"oid": "3bce125070d85eb1150d5279ce646f31c5935627", "url": "https://github.com/prestodb/presto/commit/3bce125070d85eb1150d5279ce646f31c5935627", "message": "Ensure nullable partitioning column is handled properly", "committedDate": "2020-12-03T05:27:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA5NzUxNA==", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537097514", "bodyText": "Let's merge these two lines", "author": "kewang1024", "createdAt": "2020-12-06T18:33:31Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveUtil.java", "diffHunk": "@@ -524,8 +524,8 @@ private static boolean isValidPartitionType(Type type)\n     public static NullableValue parsePartitionValue(String partitionName, String value, Type type, DateTimeZone timeZone)\n     {\n         verifyPartitionTypeSupported(partitionName, type);\n-\n-        boolean isNull = HIVE_DEFAULT_DYNAMIC_PARTITION.equals(value);\n+        byte[] bytes = value.getBytes(UTF_8);\n+        boolean isNull = HIVE_DEFAULT_DYNAMIC_PARTITION.equals(value) || isHiveNull(bytes);", "originalCommit": "3bce125070d85eb1150d5279ce646f31c5935627", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEyNDkxOA==", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537124918", "bodyText": "fixed, thanks for reviewing the PR", "author": "fgwang7w", "createdAt": "2020-12-06T21:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA5NzUxNA=="}], "type": "inlineReview"}, {"oid": "ee684372eb6b6479837243c210b7cb90327b7f1d", "url": "https://github.com/prestodb/presto/commit/ee684372eb6b6479837243c210b7cb90327b7f1d", "message": "Fix dynamic pruning for null keys in hive partition", "committedDate": "2020-12-06T21:13:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4NDMzNA==", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537184334", "bodyText": "containsValue", "author": "highker", "createdAt": "2020-12-07T02:10:22Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/statistics/TestMetastoreHiveStatisticsProvider.java", "diffHunk": "@@ -116,6 +118,14 @@ public void testGetPartitionsSample()\n         assertEquals(getPartitionsSample(ImmutableList.of(p1, p2, p3, p4, p5), 3), ImmutableList.of(p1, p5, p4));\n     }\n \n+    @Test\n+    public void testNullablePartitionValue()\n+    {\n+        HivePartition part = partition(\"p1=name/p2=\\\\N\");\n+        NullableValue verify = new NullableValue(BIGINT, null);\n+        assertTrue(part.getKeys().values().contains(verify));", "originalCommit": "ee684372eb6b6479837243c210b7cb90327b7f1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMTc0OA==", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537211748", "bodyText": "Collection of NullableValue for partition key does not implement containsValue method, but contains method works fine", "author": "fgwang7w", "createdAt": "2020-12-07T03:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4NDMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczMjkzNg==", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537732936", "bodyText": "What I meant is to change values().contains() to containsValue", "author": "highker", "createdAt": "2020-12-07T18:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4NDMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkzMDgxOQ==", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537930819", "bodyText": "fixed", "author": "fgwang7w", "createdAt": "2020-12-08T00:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4NDMzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4NDM3MQ==", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537184371", "bodyText": "break a line after this", "author": "highker", "createdAt": "2020-12-07T02:10:33Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveDistributedJoinQueriesWithDynamicFiltering.java", "diffHunk": "@@ -110,6 +110,22 @@ public void testJoinDynamicFilteringMultiJoin()\n         assertQuery(session, query, \"SELECT 1, 1, 1\");\n     }\n \n+    @Test\n+    public void testJoinOnNullPartitioning()\n+    {\n+        assertUpdate(\"CREATE TABLE t3(c2 bigint, c1 bigint)\");\n+        assertUpdate(\"INSERT INTO t3 VALUES(null, 2)\", 1);\n+        assertUpdate(\"CREATE TABLE t4(c2 bigint, c1 bigint) with(partitioned_by=array['c1'])\");\n+        assertUpdate(\"INSERT INTO t4 VALUES(null, null), (2,2)\", 2);\n+\n+        String query = \"select * from t3, t4 where t3.c1=t4.c2\";\n+        Session session = Session.builder(getSession())\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"true\")\n+                .setSystemProperty(JOIN_DISTRIBUTION_TYPE, FeaturesConfig.JoinDistributionType.AUTOMATIC.name())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, FeaturesConfig.JoinReorderingStrategy.AUTOMATIC.name())\n+                .build();\n+        assertQuery(session, query, \"SELECT null, 2, 2, 2\");\n+    }", "originalCommit": "ee684372eb6b6479837243c210b7cb90327b7f1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMzAzNQ==", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537213035", "bodyText": "got it, break a new line in between methods, thanks", "author": "fgwang7w", "createdAt": "2020-12-07T03:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4NDM3MQ=="}], "type": "inlineReview"}, {"oid": "c9e8a5ccd77f05fb2314ec9864e0af8ac4c741da", "url": "https://github.com/prestodb/presto/commit/c9e8a5ccd77f05fb2314ec9864e0af8ac4c741da", "message": "Fix dynamic pruning for null keys in hive partition", "committedDate": "2020-12-07T03:56:54Z", "type": "forcePushed"}, {"oid": "8cd223c66f4d8c2cdb347f8e33d03f7ad0bb5eaa", "url": "https://github.com/prestodb/presto/commit/8cd223c66f4d8c2cdb347f8e33d03f7ad0bb5eaa", "message": "Fix dynamic pruning for null keys in hive partition", "committedDate": "2020-12-07T05:58:54Z", "type": "forcePushed"}, {"oid": "8f19f988b2ddfa980e5bb332c77719a30de0e109", "url": "https://github.com/prestodb/presto/commit/8f19f988b2ddfa980e5bb332c77719a30de0e109", "message": "Fix dynamic pruning for null keys in hive partition", "committedDate": "2020-12-07T18:44:48Z", "type": "commit"}, {"oid": "8f19f988b2ddfa980e5bb332c77719a30de0e109", "url": "https://github.com/prestodb/presto/commit/8f19f988b2ddfa980e5bb332c77719a30de0e109", "message": "Fix dynamic pruning for null keys in hive partition", "committedDate": "2020-12-07T18:44:48Z", "type": "forcePushed"}]}