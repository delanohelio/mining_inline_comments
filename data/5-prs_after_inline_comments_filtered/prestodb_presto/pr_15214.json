{"pr_number": 15214, "pr_title": "Fix order of dwrf encryption group stats", "pr_createdAt": "2020-09-23T16:48:04Z", "pr_url": "https://github.com/prestodb/presto/pull/15214", "timeline": [{"oid": "63cc58eb2080307edacee2be46107cddcaa83577", "url": "https://github.com/prestodb/presto/commit/63cc58eb2080307edacee2be46107cddcaa83577", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group.", "committedDate": "2020-09-23T17:30:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5NzQwMQ==", "url": "https://github.com/prestodb/presto/pull/15214#discussion_r493797401", "bodyText": "You can optimize this piece a bit by extracting and moving encryptedStats.get(groupId) outside to line 621.", "author": "sdruzkin", "createdAt": "2020-09-23T18:21:25Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -610,19 +610,22 @@ public void close()\n                 .collect(Collectors.toMap(Entry::getKey, entry -> utf8Slice(entry.getValue())));\n \n         List<ColumnStatistics> unencryptedStats = new ArrayList<>();\n-        Map<Integer, List<Slice>> encryptedStats = new HashMap<>();\n+        Map<Integer, Map<Integer, Slice>> encryptedStats = new HashMap<>();\n         addStatsRecursive(fileStats, 0, new HashMap<>(), unencryptedStats, encryptedStats);\n         Optional<DwrfEncryption> dwrfEncryption;\n         if (dwrfWriterEncryption.isPresent()) {\n             ImmutableList.Builder<EncryptionGroup> encryptionGroupBuilder = ImmutableList.builder();\n             List<WriterEncryptionGroup> writerEncryptionGroups = dwrfWriterEncryption.get().getWriterEncryptionGroups();\n             for (int i = 0; i < writerEncryptionGroups.size(); i++) {\n                 WriterEncryptionGroup group = writerEncryptionGroups.get(i);\n+                int groupId = i;\n                 encryptionGroupBuilder.add(\n                         new EncryptionGroup(\n                                 group.getNodes(),\n                                 Optional.empty(), // reader will just use key metadata from the stripe\n-                                encryptedStats.get(i)));\n+                                group.getNodes().stream()\n+                                        .map(nodeId -> encryptedStats.get(groupId).get(nodeId))", "originalCommit": "63cc58eb2080307edacee2be46107cddcaa83577", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgwMDAyNQ==", "url": "https://github.com/prestodb/presto/pull/15214#discussion_r493800025", "bodyText": "Can we also add the same test but with the direct order? I briefly looked through other test cases, they all seems to have the same type for all columns.", "author": "sdruzkin", "createdAt": "2020-09-23T18:25:52Z", "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestDecryption.java", "diffHunk": "@@ -311,6 +312,39 @@ public void testSingleEncryptionGroupRowType()\n                 outputColumns);\n     }\n \n+    @Test\n+    public void testEncryptionGroupWithReversedOrderNodes()", "originalCommit": "63cc58eb2080307edacee2be46107cddcaa83577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgwNzUyMw==", "url": "https://github.com/prestodb/presto/pull/15214#discussion_r493807523", "bodyText": "there are a couple tests that have multiple types (e.g. https://github.com/prestodb/presto/blob/master/presto-orc/src/test/java/com/facebook/presto/orc/TestDecryption.java#L315), but it's good to have a simple explicit test, so added that case.", "author": "rschlussel", "createdAt": "2020-09-23T18:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgwMDAyNQ=="}], "type": "inlineReview"}, {"oid": "04049b85bedc2ff75bcca6f9c5950f008cdb4f5b", "url": "https://github.com/prestodb/presto/commit/04049b85bedc2ff75bcca6f9c5950f008cdb4f5b", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group.", "committedDate": "2020-09-23T18:36:09Z", "type": "forcePushed"}, {"oid": "f8b4101c4132c65a0f050942c45a72458b229010", "url": "https://github.com/prestodb/presto/commit/f8b4101c4132c65a0f050942c45a72458b229010", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group.", "committedDate": "2020-09-23T19:59:57Z", "type": "commit"}, {"oid": "f8b4101c4132c65a0f050942c45a72458b229010", "url": "https://github.com/prestodb/presto/commit/f8b4101c4132c65a0f050942c45a72458b229010", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group.", "committedDate": "2020-09-23T19:59:57Z", "type": "forcePushed"}]}