{"pr_number": 15250, "pr_title": "Do not ignore table bucketing when query uses bucket column", "pr_createdAt": "2020-09-30T04:37:17Z", "pr_url": "https://github.com/prestodb/presto/pull/15250", "timeline": [{"oid": "9990d780dfad04b5cb90f59cb0221ca7f2975489", "url": "https://github.com/prestodb/presto/commit/9990d780dfad04b5cb90f59cb0221ca7f2975489", "message": "Do not ignore table bucketing when query uses bucket column", "committedDate": "2020-09-30T06:18:39Z", "type": "commit"}, {"oid": "9990d780dfad04b5cb90f59cb0221ca7f2975489", "url": "https://github.com/prestodb/presto/commit/9990d780dfad04b5cb90f59cb0221ca7f2975489", "message": "Do not ignore table bucketing when query uses bucket column", "committedDate": "2020-09-30T06:18:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMjA0MA==", "url": "https://github.com/prestodb/presto/pull/15250#discussion_r497622040", "bodyText": "wouldn't this still return Optional.empty() if shouldIgnoreTableBucketing is true, since that condition is checked first?", "author": "rschlussel", "createdAt": "2020-09-30T15:55:53Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitionManager.java", "diffHunk": "@@ -246,24 +246,31 @@ public HivePartitionResult getPartitions(SemiTransactionalHiveMetastore metastor\n                 bucketFilter);\n     }\n \n-    private Optional<HiveBucketHandle> getBucketHandle(Table table, ConnectorSession session)\n+    private Optional<HiveBucketHandle> getBucketHandle(\n+            Table table,\n+            ConnectorSession session,\n+            TupleDomain<ColumnHandle> effectivePredicate)\n     {\n         // never ignore table bucketing for temporary tables as those are created such explicitly by the engine request\n         if (table.getTableType().equals(TEMPORARY_TABLE)) {\n             return getHiveBucketHandle(table);\n         }\n \n         Optional<HiveBucketHandle> hiveBucketHandle = getHiveBucketHandle(table);\n-        if (!hiveBucketHandle.isPresent()) {\n+        if (!hiveBucketHandle.isPresent() || shouldIgnoreTableBucketing(session)) {\n             return Optional.empty();\n         }\n \n+        if (queryUsesHiveBucketColumn(effectivePredicate)) {", "originalCommit": "9990d780dfad04b5cb90f59cb0221ca7f2975489", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1ODExMQ==", "url": "https://github.com/prestodb/presto/pull/15250#discussion_r497758111", "bodyText": "Yes, this scenario is covered by TestHiveIntegrationSmokeTest::testIgnoreTableBucketing. Query will fail if it uses bucket column when shouldIgnoreTableBucketing is true.", "author": "viczhang861", "createdAt": "2020-09-30T19:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMjA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2MDkyNA==", "url": "https://github.com/prestodb/presto/pull/15250#discussion_r497760924", "bodyText": "sorry, I misunderstood the purpose of this pr.  I thought this PR was so that it would succeed in that case, but now I see it's only for when the table bucket count is small.", "author": "rschlussel", "createdAt": "2020-09-30T19:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMjA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2NTU4Mg==", "url": "https://github.com/prestodb/presto/pull/15250#discussion_r497765582", "bodyText": "You are right, the purpose of this PR is to not ignore table bucketing when bucket count is small and shouldIgnoreTableBucketing is false.\nThere are two configs hive.ignore-table-bucketing and hive.min-bucket-count-to-not-ignore-table-bucketing.  If hive.ignore-table-bucketing is true, tables are always ignored. Otherwise (like in this PR), if depends on hive.min-bucket-count-to-not-ignore-table-bucketing and whether bucket column is being used.", "author": "viczhang861", "createdAt": "2020-09-30T19:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMjA0MA=="}], "type": "inlineReview"}]}