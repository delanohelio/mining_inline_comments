{"pr_number": 13916, "pr_title": "Add sum of cardinality for array column verifier results", "pr_createdAt": "2020-01-02T20:14:43Z", "pr_url": "https://github.com/prestodb/presto/pull/13916", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc4NzEwMg==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362787102", "bodyText": "@ShenYi This cast may result in NullPointerException. When all arrays are null, sum(cardinality(a)) will be null and casting null into long will throw NPE. I'd drop this cast altogether.\nObject controlCardinalitySum = controlResult.getChecksum(cardinalityColumnAlias);\nObject testCardinalitySum = testResult.getChecksum(cardinalityColumnAlias);", "author": "mbasmanova", "createdAt": "2020-01-03T12:03:49Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);\n+        long controlCardinalitySum = (long) controlResult.getChecksum(cardinalityColumnAlias);", "originalCommit": "125e03c0cf426dc540348bfbae2a84fc1b19c2f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyNTUwNw==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362925507", "bodyText": "Nice catch. Fixed.", "author": "ShenYi", "createdAt": "2020-01-03T19:09:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc4NzEwMg=="}], "type": "inlineReview"}, {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610", "url": "https://github.com/prestodb/presto/commit/787a6319ff6fcd40a3665d57e4e399c554fba610", "message": "Add sum of cardinality for array column verifier results\n\nFor array column mismatch, this change adds additional information\nof the total number of elements across all rows for the same column.", "committedDate": "2020-01-03T19:07:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NjYwMQ==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362946601", "bodyText": "First parameter on a separate line", "author": "caithagoras", "createdAt": "2020-01-03T20:16:12Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));", "originalCommit": "787a6319ff6fcd40a3665d57e4e399c554fba610", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NjgxNQ==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362946815", "bodyText": "getCardinalitySumColumnAlias", "author": "caithagoras", "createdAt": "2020-01-03T20:16:48Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalityColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalityColumnAlias);\n+\n         return new ColumnMatchResult(\n-                Objects.equals(controlSortedChecksum, testSortedChecksum),\n-                format(\"control(checksum: %s) test(checksum: %s)\", controlSortedChecksum, testSortedChecksum));\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\"control(checksum: %s, cardinality: %s) test(checksum: %s, cardinality: %s)\",\n+                        controlChecksum, controlCardinalitySum, testChecksum, testCardinalitySum));\n     }\n \n     private static String getChecksumColumnAlias(Column column)\n     {\n         return column.getName() + \"_checksum\";\n     }\n+\n+    private static String getCardinalityColumnAlias(Column column)", "originalCommit": "787a6319ff6fcd40a3665d57e4e399c554fba610", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0Njk4OQ==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362946989", "bodyText": "I would call this cardinalitySumColumnAlias", "author": "caithagoras", "createdAt": "2020-01-03T20:17:15Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);", "originalCommit": "787a6319ff6fcd40a3665d57e4e399c554fba610", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzA3Nw==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362947077", "bodyText": "_cardinality_sum", "author": "caithagoras", "createdAt": "2020-01-03T20:17:32Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalityColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalityColumnAlias);\n+\n         return new ColumnMatchResult(\n-                Objects.equals(controlSortedChecksum, testSortedChecksum),\n-                format(\"control(checksum: %s) test(checksum: %s)\", controlSortedChecksum, testSortedChecksum));\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\"control(checksum: %s, cardinality: %s) test(checksum: %s, cardinality: %s)\",\n+                        controlChecksum, controlCardinalitySum, testChecksum, testCardinalitySum));\n     }\n \n     private static String getChecksumColumnAlias(Column column)\n     {\n         return column.getName() + \"_checksum\";\n     }\n+\n+    private static String getCardinalityColumnAlias(Column column)\n+    {\n+        return column.getName() + \"_cardinality\";", "originalCommit": "787a6319ff6fcd40a3665d57e4e399c554fba610", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzMyNg==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362947326", "bodyText": "First parameter on a separate line", "author": "caithagoras", "createdAt": "2020-01-03T20:18:15Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));", "originalCommit": "787a6319ff6fcd40a3665d57e4e399c554fba610", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0OTQ3Mg==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362949472", "bodyText": "If all rows of the array column are null, array(cardinality(a)) will be null, so let's wrap it with a coalesce.\ncoalesce(array(cardinality(a)), 0) a_cardinality_sum", "author": "caithagoras", "createdAt": "2020-01-03T20:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzMyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2MDc4Nw==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362960787", "bodyText": "Do you mean?\ncoalesce(sum(cardinality(a)), 0)", "author": "ShenYi", "createdAt": "2020-01-03T21:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzMyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3OTQzNQ==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362979435", "bodyText": "Exactly. Sorry for the typo.", "author": "caithagoras", "createdAt": "2020-01-03T22:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzMyNg=="}], "type": "inlineReview"}, {"oid": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8", "url": "https://github.com/prestodb/presto/commit/ca896b76bc8c6c0b7a71b759c7df116f1b2536b8", "message": "Add checks for the cardinalities sum when validating an array column\n\nFor array column mismatch, add additional information of the total\nnumber of elements across all rows.", "committedDate": "2020-01-03T21:57:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3OTYwNA==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362979604", "bodyText": "Those 2 changes should belong to the 1st commit.", "author": "caithagoras", "createdAt": "2020-01-03T22:17:17Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -67,22 +68,41 @@ public ArrayColumnValidator()\n             checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        Expression arrayCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n         String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        Object controlChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(sortedChecksumColumnAlias);", "originalCommit": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3OTkzNw==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362979937", "bodyText": "Merge line 95 and 96, or, one line per parameter:\nformat(\n    \"control(checksum: %s, cardinality_sum: %s) test(checksum: %s, cardinality_sum: %s)\",\n    controlChecksum,\n    controlCardinalitySum,\n    testChecksum,\n    testCardinalitySum));", "author": "caithagoras", "createdAt": "2020-01-03T22:18:25Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -67,22 +68,41 @@ public ArrayColumnValidator()\n             checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        Expression arrayCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n         String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        Object controlChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+\n+        String cardinalitySumColumnAlias = getCardinalitySumColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalitySumColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalitySumColumnAlias);\n+\n         return new ColumnMatchResult(\n-                Objects.equals(controlSortedChecksum, testSortedChecksum),\n-                format(\"control(checksum: %s) test(checksum: %s)\", controlSortedChecksum, testSortedChecksum));\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\"control(checksum: %s, cardinality_sum: %s) test(checksum: %s, cardinality_sum: %s)\",\n+                        controlChecksum, controlCardinalitySum, testChecksum, testCardinalitySum));", "originalCommit": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4NTExMA==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362985110", "bodyText": "Airlift auto reformat results in a different indent as shown in the latest diff.", "author": "ShenYi", "createdAt": "2020-01-03T22:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3OTkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4MDYwNA==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362980604", "bodyText": "Line break is off:\n.put(\n    INT_ARRAY_COLUMN,\n    new ColumnMatchResult(false, \"control(checksum: 0a, cardinality_sum: 3) test(checksum: 1a, cardinality_sum: 2)\"))\n.put(\n    MAP_ARRAY_COLUMN,\n    new ColumnMatchResult(false, \"control(checksum: 0b, cardinality_sum: 7) test(checksum: 1b, cardinality_sum: 5)\"))", "author": "caithagoras", "createdAt": "2020-01-03T22:21:16Z", "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "diffHunk": "@@ -285,24 +288,48 @@ public void testArray()\n                 5,\n                 ImmutableMap.<String, Object>builder()\n                         .put(\"int_array_checksum\", new SqlVarbinary(new byte[] {0xa}))\n+                        .put(\"int_array_cardinality_sum\", 3L)\n                         .put(\"map_array_checksum\", new SqlVarbinary(new byte[] {0xb}))\n+                        .put(\"map_array_cardinality_sum\", 7L)\n                         .build());\n \n         // Matched\n         assertTrue(checksumValidator.getMismatchedColumns(columns, controlChecksum, controlChecksum).isEmpty());\n \n-        // Mismatched\n+        // Mismatched different elements\n         ChecksumResult testChecksum = new ChecksumResult(\n                 5,\n                 ImmutableMap.<String, Object>builder()\n                         .put(\"int_array_checksum\", new SqlVarbinary(new byte[] {0x1a}))\n+                        .put(\"int_array_cardinality_sum\", 3L)\n+                        .put(\"map_array_checksum\", new SqlVarbinary(new byte[] {0x1b}))\n+                        .put(\"map_array_cardinality_sum\", 7L)\n+                        .build());\n+        assertEquals(\n+                checksumValidator.getMismatchedColumns(columns, controlChecksum, testChecksum),\n+                ImmutableMap.builder()\n+                        .put(INT_ARRAY_COLUMN, new ColumnMatchResult(false,\n+                                \"control(checksum: 0a, cardinality_sum: 3) test(checksum: 1a, cardinality_sum: 3)\"))\n+                        .put(MAP_ARRAY_COLUMN, new ColumnMatchResult(false,\n+                                \"control(checksum: 0b, cardinality_sum: 7) test(checksum: 1b, cardinality_sum: 7)\"))\n+                        .build());\n+\n+        // Mismatched different cardinality sum\n+        testChecksum = new ChecksumResult(\n+                5,\n+                ImmutableMap.<String, Object>builder()\n+                        .put(\"int_array_checksum\", new SqlVarbinary(new byte[] {0x1a}))\n+                        .put(\"int_array_cardinality_sum\", 2L)\n                         .put(\"map_array_checksum\", new SqlVarbinary(new byte[] {0x1b}))\n+                        .put(\"map_array_cardinality_sum\", 5L)\n                         .build());\n         assertEquals(\n                 checksumValidator.getMismatchedColumns(columns, controlChecksum, testChecksum),\n                 ImmutableMap.builder()\n-                        .put(INT_ARRAY_COLUMN, new ColumnMatchResult(false, \"control(checksum: 0a) test(checksum: 1a)\"))\n-                        .put(MAP_ARRAY_COLUMN, new ColumnMatchResult(false, \"control(checksum: 0b) test(checksum: 1b)\"))\n+                        .put(INT_ARRAY_COLUMN, new ColumnMatchResult(false,\n+                                \"control(checksum: 0a, cardinality_sum: 3) test(checksum: 1a, cardinality_sum: 2)\"))\n+                        .put(MAP_ARRAY_COLUMN, new ColumnMatchResult(false,\n+                                \"control(checksum: 0b, cardinality_sum: 7) test(checksum: 1b, cardinality_sum: 5)\"))", "originalCommit": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4MTI3OQ==", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362981279", "bodyText": "Also, rename this to checksumColumnAlias in the first commit.", "author": "caithagoras", "createdAt": "2020-01-03T22:24:00Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -67,22 +68,41 @@ public ArrayColumnValidator()\n             checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        Expression arrayCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n         String sortedChecksumColumnAlias = getChecksumColumnAlias(column);", "originalCommit": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8b1a99c4d20be543efcb5377ebae4c0af1426058", "url": "https://github.com/prestodb/presto/commit/8b1a99c4d20be543efcb5377ebae4c0af1426058", "message": "Add checks for the cardinalities sum when validating an array column\n\nFor array column mismatch, add additional information of the total\nnumber of elements across all rows.", "committedDate": "2020-01-03T22:37:49Z", "type": "forcePushed"}, {"oid": "f1f01ce5b2227fd2e882052bc4048d0e36e66bd1", "url": "https://github.com/prestodb/presto/commit/f1f01ce5b2227fd2e882052bc4048d0e36e66bd1", "message": "Repurpose OrderableArrayColumnValidator to support all array types\n\nRefactor OrderableArrayColumnValidator into ArrayColumnValidator.\nAdd logic to also support non-orderable array types.", "committedDate": "2020-01-06T19:43:10Z", "type": "commit"}, {"oid": "48746be82b55a041d6023b825c46b97e9a53e967", "url": "https://github.com/prestodb/presto/commit/48746be82b55a041d6023b825c46b97e9a53e967", "message": "Add checks for the cardinalities sum when validating an array column\n\nFor array column mismatch, add additional information of the total\nnumber of elements across all rows.", "committedDate": "2020-01-06T19:43:10Z", "type": "commit"}, {"oid": "48746be82b55a041d6023b825c46b97e9a53e967", "url": "https://github.com/prestodb/presto/commit/48746be82b55a041d6023b825c46b97e9a53e967", "message": "Add checks for the cardinalities sum when validating an array column\n\nFor array column mismatch, add additional information of the total\nnumber of elements across all rows.", "committedDate": "2020-01-06T19:43:10Z", "type": "forcePushed"}]}