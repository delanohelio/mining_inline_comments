{"pr_number": 15187, "pr_title": "Consider predicate columns for encryption", "pr_createdAt": "2020-09-17T17:18:52Z", "pr_url": "https://github.com/prestodb/presto/pull/15187", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA3MjQyMg==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r491072422", "bodyText": "can you remind me again why requested columns is optional?  requested columns being optional and predicate columns not makes the logic here kind of confusing. Is it possible to always provide it?", "author": "rschlussel", "createdAt": "2020-09-18T16:49:20Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -470,6 +481,43 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static Optional<Set<HiveColumnHandle>> mergeRequestedAndPredicateColumns(Optional<Set<HiveColumnHandle>> requestedColumns, Set<HiveColumnHandle> predicateColumns)\n+    {\n+        if (!requestedColumns.isPresent() || predicateColumns.isEmpty()) {", "originalCommit": "87d4e2e8554c8bf5e61bbb410f567a838b6d01ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0NzY4MQ==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r491147681", "bodyText": "I am just going with the structure of HiveTableLayoutHandle and in this class - requestedColumns is optional and predicateColumns is not. Given this is where I get the data from, I don't think it is possible for me to always provide requestedColumns", "author": "mayankgarg1990", "createdAt": "2020-09-18T19:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA3MjQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMjU1OQ==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r491132559", "bodyText": "You can use the groupingBy collector https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html#groupingBy-java.util.function.Function-java.util.stream.Collector-", "author": "rschlussel", "createdAt": "2020-09-18T18:51:34Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -470,6 +481,43 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static Optional<Set<HiveColumnHandle>> mergeRequestedAndPredicateColumns(Optional<Set<HiveColumnHandle>> requestedColumns, Set<HiveColumnHandle> predicateColumns)\n+    {\n+        if (!requestedColumns.isPresent() || predicateColumns.isEmpty()) {\n+            return requestedColumns;\n+        }\n+\n+        Map<String, Set<HiveColumnHandle>> nameToColumnHandles = new HashMap<>();", "originalCommit": "87d4e2e8554c8bf5e61bbb410f567a838b6d01ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzODQ4NA==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r491138484", "bodyText": "why can we short circuit for non-structs?  is it because there will never be any subfields?  I think the shortcircuiting is more confusing.", "author": "rschlussel", "createdAt": "2020-09-18T19:04:35Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -470,6 +481,43 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static Optional<Set<HiveColumnHandle>> mergeRequestedAndPredicateColumns(Optional<Set<HiveColumnHandle>> requestedColumns, Set<HiveColumnHandle> predicateColumns)\n+    {\n+        if (!requestedColumns.isPresent() || predicateColumns.isEmpty()) {\n+            return requestedColumns;\n+        }\n+\n+        Map<String, Set<HiveColumnHandle>> nameToColumnHandles = new HashMap<>();\n+        Stream.concat(requestedColumns.get().stream(), predicateColumns.stream())\n+                .filter(column -> column.getColumnType() == REGULAR)\n+                .forEach(column -> nameToColumnHandles.computeIfAbsent(column.getName(), (key) -> new HashSet<>()).add(column));\n+\n+        return Optional.of(nameToColumnHandles.values().stream()\n+                .map(columnHandles -> {\n+                    HiveColumnHandle finalHandle = null;\n+                    for (HiveColumnHandle columnHandle : columnHandles) {\n+                        if (finalHandle == null) {\n+                            finalHandle = columnHandle;\n+                            continue;\n+                        }\n+\n+                        if (finalHandle.getHiveType().getCategory() != STRUCT || finalHandle.getRequiredSubfields().isEmpty()) {", "originalCommit": "87d4e2e8554c8bf5e61bbb410f567a838b6d01ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0ODQxNQ==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r491148415", "bodyText": "Yes, because there will never be subfields in NON-structs. Well, there might be key, value stuff for maps, but that doesn't really impact encryption implementation since either the full map/array is encrypted or not.", "author": "mayankgarg1990", "createdAt": "2020-09-18T19:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzODQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0MDkzNQ==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r491140935", "bodyText": "Can this whole section be simplified to\nif (finalHandle == null || finalHandle.getRequiredSubfields.isEmpty() || columnHandle.getRequiredSubfields.isEmpty()) {\n   finalHandle = columnHandle;\n}\nelse {\n   finalHandle = (HiveColumnHandle) finalHandle.withRequiredSubfields(ImmutableList.copyOf(ImmutableSet.copyOf(\n                                    ImmutableList.<Subfield>builder().addAll(finalHandle.getRequiredSubfields()).addAll(columnHandle.getRequiredSubfields()).build())));\n}\n\nAlso, can we do it as a reduce on the stream instead of having a forloop inside the stream? (if we use groupingBy, don't even need to collect to map first)", "author": "rschlussel", "createdAt": "2020-09-18T19:10:13Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -470,6 +481,43 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static Optional<Set<HiveColumnHandle>> mergeRequestedAndPredicateColumns(Optional<Set<HiveColumnHandle>> requestedColumns, Set<HiveColumnHandle> predicateColumns)\n+    {\n+        if (!requestedColumns.isPresent() || predicateColumns.isEmpty()) {\n+            return requestedColumns;\n+        }\n+\n+        Map<String, Set<HiveColumnHandle>> nameToColumnHandles = new HashMap<>();\n+        Stream.concat(requestedColumns.get().stream(), predicateColumns.stream())\n+                .filter(column -> column.getColumnType() == REGULAR)\n+                .forEach(column -> nameToColumnHandles.computeIfAbsent(column.getName(), (key) -> new HashSet<>()).add(column));\n+\n+        return Optional.of(nameToColumnHandles.values().stream()\n+                .map(columnHandles -> {\n+                    HiveColumnHandle finalHandle = null;\n+                    for (HiveColumnHandle columnHandle : columnHandles) {\n+                        if (finalHandle == null) {", "originalCommit": "87d4e2e8554c8bf5e61bbb410f567a838b6d01ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE3NzM1Ng==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r491177356", "bodyText": "Thanks for advise on grouping by and reduce - this has made the code a lot simpler now.", "author": "mayankgarg1990", "createdAt": "2020-09-18T20:33:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0MDkzNQ=="}], "type": "inlineReview"}, {"oid": "eec44beab826c865f85bd7167365766c39bd0196", "url": "https://github.com/prestodb/presto/commit/eec44beab826c865f85bd7167365766c39bd0196", "message": "Consider predicate columns for encryption\n\nIn encryption we pass the list of columns that are being read to help with\ngetting the credentials only for those columns and allow for more granular\naccess control.\n\nUptil now, only the columns being requested in the select statement were\nthe only ones being considered. This commit adds support for columns in\nthe predicate as well. We now consider the predicate columns as well.\n\nA special case to callout is `ROW`. Presto currently supports encryption\ngranularity of a subfield, however, it is non-trivial to get the exact\nsubfields being accessed for a `ROW`. This PR puts the whole `ROW` column\nif any subfield is being used in the predicate. This is a limitation for\nnow.", "committedDate": "2020-09-18T20:39:29Z", "type": "forcePushed"}, {"oid": "4f86b23a3e5ec123c9b0a4c4a8932fc5f0c2ecdc", "url": "https://github.com/prestodb/presto/commit/4f86b23a3e5ec123c9b0a4c4a8932fc5f0c2ecdc", "message": "Consider predicate columns for encryption\n\nIn encryption we pass the list of columns that are being read to help with\ngetting the credentials only for those columns and allow for more granular\naccess control.\n\nUptil now, only the columns being requested in the select statement were\nthe only ones being considered. This commit adds support for columns in\nthe predicate as well. We now consider the predicate columns as well.\n\nA special case to callout is `ROW`. Presto currently supports encryption\ngranularity of a subfield, however, it is non-trivial to get the exact\nsubfields being accessed for a `ROW`. This PR puts the whole `ROW` column\nif any subfield is being used in the predicate. This is a limitation for\nnow.", "committedDate": "2020-09-18T20:42:03Z", "type": "commit"}, {"oid": "4f86b23a3e5ec123c9b0a4c4a8932fc5f0c2ecdc", "url": "https://github.com/prestodb/presto/commit/4f86b23a3e5ec123c9b0a4c4a8932fc5f0c2ecdc", "message": "Consider predicate columns for encryption\n\nIn encryption we pass the list of columns that are being read to help with\ngetting the credentials only for those columns and allow for more granular\naccess control.\n\nUptil now, only the columns being requested in the select statement were\nthe only ones being considered. This commit adds support for columns in\nthe predicate as well. We now consider the predicate columns as well.\n\nA special case to callout is `ROW`. Presto currently supports encryption\ngranularity of a subfield, however, it is non-trivial to get the exact\nsubfields being accessed for a `ROW`. This PR puts the whole `ROW` column\nif any subfield is being used in the predicate. This is a limitation for\nnow.", "committedDate": "2020-09-18T20:42:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg0MTE4OA==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r492841188", "bodyText": "@mayankgarg1990 Is this the right logic? For a SELECT count(*) FROM t WHERE a > 10 we can have requestedColumns empty and predicateColumns containing \"a\". In this case, don't we need to make sure user has access to \"a\" ?", "author": "mbasmanova", "createdAt": "2020-09-22T15:42:10Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -470,6 +481,37 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    @VisibleForTesting\n+    static Optional<Set<HiveColumnHandle>> mergeRequestedAndPredicateColumns(Optional<Set<HiveColumnHandle>> requestedColumns, Set<HiveColumnHandle> predicateColumns)\n+    {\n+        if (!requestedColumns.isPresent() || predicateColumns.isEmpty()) {", "originalCommit": "4f86b23a3e5ec123c9b0a4c4a8932fc5f0c2ecdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg1NDM2Mg==", "url": "https://github.com/prestodb/presto/pull/15187#discussion_r492854362", "bodyText": "In this case - I am checking for requestedColumns.isPresent() and the situation you are talking about will actually be requestedColumns.get().isEmpty().\nSo this check mainly ensures that due to some reason if we don't end up getting the requestedColumns field populated at all, the encryption provider will now try to get the credentials for all columns.", "author": "mayankgarg1990", "createdAt": "2020-09-22T15:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg0MTE4OA=="}], "type": "inlineReview"}]}