{"pr_number": 14554, "pr_title": "Add additional logging to resource group scheduler", "pr_createdAt": "2020-05-19T06:57:13Z", "pr_url": "https://github.com/prestodb/presto/pull/14554", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyNjY2MQ==", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r427426661", "bodyText": "Let's suppress this Exception per the docs: https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html#scheduleWithFixedDelay-java.lang.Runnable-long-long-java.util.concurrent.TimeUnit-\nLogging should be sufficient.", "author": "tdcmeehan", "createdAt": "2020-05-19T16:14:03Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -191,7 +192,17 @@ public void destroy()\n     public void start()\n     {\n         if (started.compareAndSet(false, true)) {\n-            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 1, 1, TimeUnit.MILLISECONDS);\n+            refreshExecutor.scheduleWithFixedDelay(() -> {\n+                try {\n+                    refreshAndStartQueries();\n+                }\n+                catch (Throwable t) {\n+                    log.error(t, \"Error while executing refreshAndStartQueries\");\n+                    throw t;", "originalCommit": "959c047d1cb9c946b48f8d20086c1649e828f7af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzMzM0Mg==", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r427433342", "bodyText": "OR, what we could do is stash the returned ScheduledFuture from refreshExecutor.scheduleWithFixedDelay, and use it to see if this has completed or failed (failing queries if so).", "author": "tdcmeehan", "createdAt": "2020-05-19T16:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyNjY2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzMyNA==", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r427627324", "bodyText": "Are all queries stuck or only some queries? If some queries are still running, it may be other reasons.\nLogging is enough, just like other places we handle error from scheduleWithFixedDelay. You can throw error in custom build for verification purpose.", "author": "viczhang861", "createdAt": "2020-05-19T22:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyNjY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2OTQ2OA==", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r428269468", "bodyText": "nit: static import currentTimeMillis", "author": "caithagoras", "createdAt": "2020-05-20T19:52:08Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -283,6 +294,12 @@ public int getQueriesQueuedOnInternal()\n         return queriesQueuedInternal;\n     }\n \n+    @Managed\n+    public long getLastSchedulingCycleRuntimeDelayMs()\n+    {\n+        return System.currentTimeMillis() - lastSchedulingCycleRunTimeMs.get();", "originalCommit": "959c047d1cb9c946b48f8d20086c1649e828f7af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2OTUzNQ==", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r428269535", "bodyText": "nit: static import MILLISECONDS", "author": "caithagoras", "createdAt": "2020-05-20T19:52:16Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -191,7 +192,17 @@ public void destroy()\n     public void start()\n     {\n         if (started.compareAndSet(false, true)) {\n-            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 1, 1, TimeUnit.MILLISECONDS);\n+            refreshExecutor.scheduleWithFixedDelay(() -> {\n+                try {\n+                    refreshAndStartQueries();\n+                }\n+                catch (Throwable t) {\n+                    log.error(t, \"Error while executing refreshAndStartQueries\");\n+                    throw t;\n+                }\n+\n+                lastSchedulingCycleRunTimeMs.getAndSet(System.currentTimeMillis());\n+            }, 1, 1, TimeUnit.MILLISECONDS);", "originalCommit": "959c047d1cb9c946b48f8d20086c1649e828f7af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09d715e63f5cbf66b77a6a712f6b1821d2541ade", "url": "https://github.com/prestodb/presto/commit/09d715e63f5cbf66b77a6a712f6b1821d2541ade", "message": "Add additional logging to resource group scheduler\n\nThis is needed for an ongoing debugging where in we are seeing queries\ngetting stuck and not being moved from the queued state to the running\nstate", "committedDate": "2020-05-20T20:37:22Z", "type": "commit"}, {"oid": "09d715e63f5cbf66b77a6a712f6b1821d2541ade", "url": "https://github.com/prestodb/presto/commit/09d715e63f5cbf66b77a6a712f6b1821d2541ade", "message": "Add additional logging to resource group scheduler\n\nThis is needed for an ongoing debugging where in we are seeing queries\ngetting stuck and not being moved from the queued state to the running\nstate", "committedDate": "2020-05-20T20:37:22Z", "type": "forcePushed"}]}