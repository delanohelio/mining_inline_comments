{"pr_number": 15034, "pr_title": "Make request tracker infrastructure generic", "pr_createdAt": "2020-08-14T23:34:41Z", "pr_url": "https://github.com/prestodb/presto/pull/15034", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDI2Ng==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475160266", "bodyText": "should these counters be marked as volatile as well? Wondering if these are thread safe.", "author": "ajaygeorge", "createdAt": "2020-08-23T02:24:02Z", "path": "presto-main/src/main/java/com/facebook/presto/server/SimpleHttpResponseHandlerStats.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.server;\n+\n+import org.weakref.jmx.Managed;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+public class SimpleHttpResponseHandlerStats\n+{\n+    private final IncrementalAverage responseSizeBytes = new IncrementalAverage();\n+    private long requestSuccess;\n+    private long requestFailure;", "originalCommit": "03e4ba25484976522f11060b6a85b8264330d85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxNDUxNA==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475814514", "bodyText": "Good catch, this was an existing problem too.  Making them AtomicLong.", "author": "tdcmeehan", "createdAt": "2020-08-24T18:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDUyMA==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475160520", "bodyText": "Since this a generic class now, wondering if this should be still private.\nIf I want to track errors in some other area other than tasks, I won't be able to get access to this class unless I write another utility method.", "author": "ajaygeorge", "createdAt": "2020-08-23T02:27:26Z", "path": "presto-main/src/main/java/com/facebook/presto/server/RequestErrorTracker.java", "diffHunk": "@@ -47,27 +48,36 @@\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @ThreadSafe\n-class RequestErrorTracker\n+public class RequestErrorTracker\n {\n     private static final Logger log = Logger.get(RequestErrorTracker.class);\n \n-    private final TaskId taskId;\n-    private final URI taskUri;\n+    private final Object id;\n+    private final URI uri;\n+    private ErrorCodeSupplier errorCode;\n+    private String nodeErrorMessage;\n     private final ScheduledExecutorService scheduledExecutor;\n     private final String jobDescription;\n     private final Backoff backoff;\n \n     private final Queue<Throwable> errorsSinceLastSuccess = new ConcurrentLinkedQueue<>();\n \n-    public RequestErrorTracker(TaskId taskId, URI taskUri, Duration maxErrorDuration, ScheduledExecutorService scheduledExecutor, String jobDescription)\n+    private RequestErrorTracker(Object id, URI uri, ErrorCodeSupplier errorCode, String nodeErrorMessage, Duration maxErrorDuration, ScheduledExecutorService scheduledExecutor, String jobDescription)", "originalCommit": "03e4ba25484976522f11060b6a85b8264330d85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxNjE1Mw==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475816153", "bodyText": "My intention was to only create this class via a factory.  The rationale is, there's only ever going to be a small handful of factory methods, and IMO the constructor is a bit unwieldy/difficult to configure..", "author": "tdcmeehan", "createdAt": "2020-08-24T18:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDc3Mg==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475160772", "bodyText": "maybe rename this as a simpler HttpResponseStats ?", "author": "ajaygeorge", "createdAt": "2020-08-23T02:31:06Z", "path": "presto-main/src/main/java/com/facebook/presto/server/SimpleHttpResponseHandlerStats.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.server;\n+\n+import org.weakref.jmx.Managed;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+public class SimpleHttpResponseHandlerStats", "originalCommit": "03e4ba25484976522f11060b6a85b8264330d85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgwMjg5Nw==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475802897", "bodyText": "It is named by correlation to SimpleHttpResponseHandler", "author": "tdcmeehan", "createdAt": "2020-08-24T18:12:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDc3Mg=="}], "type": "inlineReview"}, {"oid": "dfeef74640041c48c6c35f530a1d0e644f66b0a5", "url": "https://github.com/prestodb/presto/commit/dfeef74640041c48c6c35f530a1d0e644f66b0a5", "message": "Make SimpleHttpResponseHandler generic", "committedDate": "2020-08-24T18:35:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM4MTU5OA==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r480381598", "bodyText": "Should we use @Flatten instead of @Nested ? That would ensure that the metrics exported remain in the same format.", "author": "mayankgarg1990", "createdAt": "2020-08-31T20:30:06Z", "path": "presto-main/src/main/java/com/facebook/presto/server/remotetask/RemoteTaskStats.java", "diffHunk": "@@ -72,9 +55,10 @@ public void updateWithoutPlanSize(long bytes)\n     }\n \n     @Managed\n-    public double getResponseSizeBytes()\n+    @Nested", "originalCommit": "dfeef74640041c48c6c35f530a1d0e644f66b0a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NzA2Mw==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r480477063", "bodyText": "Good catch.", "author": "tdcmeehan", "createdAt": "2020-08-31T23:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM4MTU5OA=="}], "type": "inlineReview"}, {"oid": "ff19508aa0622f6424156319d3f25049391558a4", "url": "https://github.com/prestodb/presto/commit/ff19508aa0622f6424156319d3f25049391558a4", "message": "Make RequestErrorTracker generic", "committedDate": "2020-08-31T23:46:11Z", "type": "commit"}, {"oid": "6d30657779b3c8436c8d2e6c97ed99d30db05c21", "url": "https://github.com/prestodb/presto/commit/6d30657779b3c8436c8d2e6c97ed99d30db05c21", "message": "Make SimpleHttpResponseHandler generic", "committedDate": "2020-08-31T23:48:06Z", "type": "commit"}, {"oid": "6d30657779b3c8436c8d2e6c97ed99d30db05c21", "url": "https://github.com/prestodb/presto/commit/6d30657779b3c8436c8d2e6c97ed99d30db05c21", "message": "Make SimpleHttpResponseHandler generic", "committedDate": "2020-08-31T23:48:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2NjYyMw==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r482266623", "bodyText": "curious if the motivation of moving taskId to a more general id can be explained a bit in PR?", "author": "wenleix", "createdAt": "2020-09-02T18:07:49Z", "path": "presto-main/src/main/java/com/facebook/presto/server/RequestErrorTracker.java", "diffHunk": "@@ -47,27 +48,36 @@\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @ThreadSafe\n-class RequestErrorTracker\n+public class RequestErrorTracker\n {\n     private static final Logger log = Logger.get(RequestErrorTracker.class);\n \n-    private final TaskId taskId;\n-    private final URI taskUri;\n+    private final Object id;", "originalCommit": "ff19508aa0622f6424156319d3f25049391558a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyMDYxMw==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r482320613", "bodyText": "Updated the PR description.", "author": "tdcmeehan", "createdAt": "2020-09-02T19:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2NjYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2NjgzNg==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r482266836", "bodyText": "curious: why need to use ErrorCodeSupplier instead of ErrorCode?", "author": "wenleix", "createdAt": "2020-09-02T18:08:15Z", "path": "presto-main/src/main/java/com/facebook/presto/server/RequestErrorTracker.java", "diffHunk": "@@ -47,27 +48,36 @@\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @ThreadSafe\n-class RequestErrorTracker\n+public class RequestErrorTracker\n {\n     private static final Logger log = Logger.get(RequestErrorTracker.class);\n \n-    private final TaskId taskId;\n-    private final URI taskUri;\n+    private final Object id;\n+    private final URI uri;\n+    private ErrorCodeSupplier errorCode;", "originalCommit": "ff19508aa0622f6424156319d3f25049391558a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2ODgxMg==", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r482268812", "bodyText": "Actually, never mind, StandardErrorCode implments ErrorCodeSupplier", "author": "wenleix", "createdAt": "2020-09-02T18:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2NjgzNg=="}], "type": "inlineReview"}]}