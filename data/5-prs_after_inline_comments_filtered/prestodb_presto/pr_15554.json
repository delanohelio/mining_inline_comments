{"pr_number": 15554, "pr_title": "Add hive partition stats based optimization", "pr_createdAt": "2020-12-23T01:02:43Z", "pr_url": "https://github.com/prestodb/presto/pull/15554", "timeline": [{"oid": "9adcf0773c4c0f05b85f21b9ed2088490cc947b0", "url": "https://github.com/prestodb/presto/commit/9adcf0773c4c0f05b85f21b9ed2088490cc947b0", "message": "Support partition pruning based on partition stats", "committedDate": "2020-12-23T22:12:32Z", "type": "forcePushed"}, {"oid": "48981a7170994002640e8ae8c82b251341e44cd8", "url": "https://github.com/prestodb/presto/commit/48981a7170994002640e8ae8c82b251341e44cd8", "message": "Support column domain stripping based on partition stats", "committedDate": "2021-01-06T22:52:19Z", "type": "forcePushed"}, {"oid": "e410abd8d420b268e338424278080339f381ada1", "url": "https://github.com/prestodb/presto/commit/e410abd8d420b268e338424278080339f381ada1", "message": "Support column domain stripping based on partition stats", "committedDate": "2021-01-06T23:18:06Z", "type": "forcePushed"}, {"oid": "0bb0a0f2225dbf7db1fd3eee1d2f4a06dd8e5872", "url": "https://github.com/prestodb/presto/commit/0bb0a0f2225dbf7db1fd3eee1d2f4a06dd8e5872", "message": "Support column domain stripping based on partition stats", "committedDate": "2021-01-07T18:27:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY4OTg3OQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r554689879", "bodyText": "nit\npartitionNames.stream().map(name -> hivePartitionName(databaseName, tableName, name)).collect(toImmutableList());", "author": "highker", "createdAt": "2021-01-11T04:08:49Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/CachingHiveMetastore.java", "diffHunk": "@@ -680,6 +702,57 @@ private void invalidateStalePartition(PartitionNameWithVersion partitionNameWith\n         return partitions.build();\n     }\n \n+    @Override\n+    public Map<String, Optional<PartitionWithStatistics>> getPartitionsWithStatisticsByNames(String databaseName, String tableName, List<String> partitionNames)\n+    {\n+        Iterable<HivePartitionName> names = transform(partitionNames, name -> HivePartitionName.hivePartitionName(databaseName, tableName, name));", "originalCommit": "7102927a4c9b62e168a2fa29241a43e70c15a952", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDcxNzE4Mw==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r554717183", "bodyText": "This will lead to another RPC call. But I do see the existing getPartitionStatistics also has this, so I guess there is some light-weighted caching?", "author": "highker", "createdAt": "2021-01-11T04:48:19Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/thrift/ThriftHiveMetastore.java", "diffHunk": "@@ -1163,6 +1164,45 @@ private void dropExtraColumnStatisticsAfterAlterPartition(\n         }\n     }\n \n+    @Override\n+    public List<MetastoreApiPartitionWithStatistics> getPartitionsWithStatisticsByNames(String databaseName, String tableName, List<String> partitionNames)\n+    {\n+        Table table = getTable(databaseName, tableName)\n+                .orElseThrow(() -> new TableNotFoundException(new SchemaTableName(databaseName, tableName)));\n+        List<String> dataColumns = table.getSd().getCols().stream()\n+                .map(FieldSchema::getName)\n+                .collect(toImmutableList());\n+        List<String> partitionColumns = table.getPartitionKeys().stream()\n+                .map(FieldSchema::getName)\n+                .collect(toImmutableList());\n+\n+        List<Partition> partitions = getPartitionsByNames(databaseName, tableName, partitionNames);", "originalCommit": "7102927a4c9b62e168a2fa29241a43e70c15a952", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA1NjMyMg==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r562056322", "bodyText": "Yeah, the caching would help here.", "author": "jainxrohit", "createdAt": "2021-01-21T17:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDcxNzE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDczNDk5Ng==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r554734996", "bodyText": "Do we really need this class? This is what I'm thinking: highker@ba2800f", "author": "highker", "createdAt": "2021-01-11T05:14:24Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/MetastoreApiPartitionWithStatistics.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive.metastore;\n+\n+import static com.facebook.presto.hive.metastore.MetastoreUtil.toPartitionValues;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+public class MetastoreApiPartitionWithStatistics", "originalCommit": "7102927a4c9b62e168a2fa29241a43e70c15a952", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDc1ODAzMQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r554758031", "bodyText": "We can reuse our existing infra? highker@1a64f5b", "author": "highker", "createdAt": "2021-01-11T05:46:14Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -496,6 +506,141 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static PartitionBatchInfo getPartitionBatchInfo(\n+            ConnectorSession session,\n+            SemiTransactionalHiveMetastore metastore,\n+            SchemaTableName tableName,\n+            List<HivePartition> partitionBatch,\n+            Map<String, HiveColumnHandle> predicateColumns,\n+            Optional<Map<Subfield, Domain>> domains)\n+    {\n+        if (isPartitionStatsBasedOptimizationEnabled(session) && domains.isPresent()) {\n+            Map<String, Optional<PartitionWithStatistics>> batch = metastore.getPartitionsWithStatisticsByNames(\n+                    tableName.getSchemaName(),\n+                    tableName.getTableName(),\n+                    Lists.transform(partitionBatch, HivePartition::getPartitionId));", "originalCommit": "93a38a26942f0d7cd79154b64c808cad6b56eee3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fa5d86168597b24bab07a18ade623c43128fedcc", "url": "https://github.com/prestodb/presto/commit/fa5d86168597b24bab07a18ade623c43128fedcc", "message": "Support column domain stripping based on partition stats", "committedDate": "2021-01-15T01:16:20Z", "type": "forcePushed"}, {"oid": "be70bf53830c066f08d2da2b14020ac9e53b10a2", "url": "https://github.com/prestodb/presto/commit/be70bf53830c066f08d2da2b14020ac9e53b10a2", "message": "Support column domain stripping based on partition stats", "committedDate": "2021-01-15T23:09:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTMyNDg0NA==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561324844", "bodyText": "partitionStatisticsBasedPruningEnabled", "author": "highker", "createdAt": "2021-01-20T21:40:36Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java", "diffHunk": "@@ -150,6 +150,7 @@\n     private int partitionStatisticsSampleSize = 100;\n     private boolean ignoreCorruptedStatistics;\n     private boolean collectColumnStatisticsOnWrite;\n+    private boolean partitionStatsBasedOptimizationEnabled;", "originalCommit": "d87f72ee709a3a5632103852acafa6fe5c91c1f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjg1NDY1NQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r562854655", "bodyText": "This config ideally would also cover cases for predicate stripping. I'm not sure if using pruning would cover that part \ud83e\udd14", "author": "shixuan-fan", "createdAt": "2021-01-22T19:19:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTMyNDg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkyOTgzNg==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r563929836", "bodyText": "I'll change it to partitionStatisticsBasedOptimizationEnabled, and also change the related session property names to reflect this change.", "author": "shixuan-fan", "createdAt": "2021-01-25T17:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTMyNDg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM2NzkxMw==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561367913", "bodyText": "nit: columnStatistics", "author": "highker", "createdAt": "2021-01-20T23:09:56Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -496,6 +506,149 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static PartitionBatchInfo getPartitionBatchInfo(\n+            ConnectorSession session,\n+            SemiTransactionalHiveMetastore metastore,\n+            SchemaTableName tableName,\n+            List<HivePartition> partitionBatch,\n+            Map<String, HiveColumnHandle> predicateColumns,\n+            Optional<Map<Subfield, Domain>> domains)\n+    {\n+        if (isPartitionStatsBasedOptimizationEnabled(session) && domains.isPresent()) {\n+            Map<String, Optional<Partition>> partitions = metastore.getPartitionsByNames(\n+                    tableName.getSchemaName(),\n+                    tableName.getTableName(),\n+                    Lists.transform(partitionBatch, HivePartition::getPartitionId));\n+            Map<String, PartitionStatistics> partitionStatistics = metastore.getPartitionStatistics(\n+                    tableName.getSchemaName(),\n+                    tableName.getTableName(),\n+                    partitionBatch.stream()\n+                            .map(HivePartition::getPartitionId)\n+                            .collect(toImmutableSet()));\n+            ImmutableSet.Builder<String> prunedPartitionNamesBuilder = ImmutableSet.builder();\n+            ImmutableMap.Builder<String, Partition> partitionBuilder = ImmutableMap.builder();\n+            for (Map.Entry<String, Optional<Partition>> entry : partitions.entrySet()) {\n+                if (!entry.getValue().isPresent()) {\n+                    throw new PrestoException(HIVE_PARTITION_DROPPED_DURING_QUERY, \"Partition no longer exists: \" + entry.getKey());\n+                }\n+                boolean pruned = false;\n+                if (partitionStatistics.containsKey(entry.getKey())) {\n+                    Map<String, HiveColumnStatistics> columnStatsMap = partitionStatistics.get(entry.getKey()).getColumnStatistics();", "originalCommit": "d87f72ee709a3a5632103852acafa6fe5c91c1f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ0MzcxMg==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561443712", "bodyText": "Let's reuse MetastoreHiveStatisticsProvider's isRangeSupported and createRange helpers to make it very generic. We can also return DoubleRange instead of ValueSet of simplicity. Likely we can ignore or add TODO for non-numeric types.", "author": "highker", "createdAt": "2021-01-21T00:55:55Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -496,6 +506,149 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static PartitionBatchInfo getPartitionBatchInfo(\n+            ConnectorSession session,\n+            SemiTransactionalHiveMetastore metastore,\n+            SchemaTableName tableName,\n+            List<HivePartition> partitionBatch,\n+            Map<String, HiveColumnHandle> predicateColumns,\n+            Optional<Map<Subfield, Domain>> domains)\n+    {\n+        if (isPartitionStatsBasedOptimizationEnabled(session) && domains.isPresent()) {\n+            Map<String, Optional<Partition>> partitions = metastore.getPartitionsByNames(\n+                    tableName.getSchemaName(),\n+                    tableName.getTableName(),\n+                    Lists.transform(partitionBatch, HivePartition::getPartitionId));\n+            Map<String, PartitionStatistics> partitionStatistics = metastore.getPartitionStatistics(\n+                    tableName.getSchemaName(),\n+                    tableName.getTableName(),\n+                    partitionBatch.stream()\n+                            .map(HivePartition::getPartitionId)\n+                            .collect(toImmutableSet()));\n+            ImmutableSet.Builder<String> prunedPartitionNamesBuilder = ImmutableSet.builder();\n+            ImmutableMap.Builder<String, Partition> partitionBuilder = ImmutableMap.builder();\n+            for (Map.Entry<String, Optional<Partition>> entry : partitions.entrySet()) {\n+                if (!entry.getValue().isPresent()) {\n+                    throw new PrestoException(HIVE_PARTITION_DROPPED_DURING_QUERY, \"Partition no longer exists: \" + entry.getKey());\n+                }\n+                boolean pruned = false;\n+                if (partitionStatistics.containsKey(entry.getKey())) {\n+                    Map<String, HiveColumnStatistics> columnStatsMap = partitionStatistics.get(entry.getKey()).getColumnStatistics();\n+                    for (Map.Entry<String, HiveColumnHandle> predicateColumnEntry : predicateColumns.entrySet()) {\n+                        if (columnStatsMap.containsKey(predicateColumnEntry.getKey())) {\n+                            Optional<ValueSet> columnsStatsValueSet = getColumnStatsValueSet(columnStatsMap.get(predicateColumnEntry.getKey()), predicateColumnEntry.getValue().getHiveType());\n+                            if (columnsStatsValueSet.isPresent()) {\n+                                ValueSet columnPredicateValueSet = domains.get().get(new Subfield(predicateColumnEntry.getKey())).getValues();\n+                                if (!columnPredicateValueSet.overlaps(columnsStatsValueSet.get())) {\n+                                    pruned = true;\n+                                    break;\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+\n+                if (pruned) {\n+                    prunedPartitionNamesBuilder.add(entry.getKey());\n+                }\n+                else {\n+                    partitionBuilder.put(entry.getKey(), entry.getValue().get());\n+                }\n+            }\n+            return new PartitionBatchInfo(partitionBuilder.build(), prunedPartitionNamesBuilder.build());\n+        }\n+\n+        Map<String, Optional<Partition>> batch = metastore.getPartitionsByNames(\n+                tableName.getSchemaName(),\n+                tableName.getTableName(),\n+                Lists.transform(partitionBatch, HivePartition::getPartitionId));\n+        ImmutableMap.Builder<String, Partition> partitionBuilder = ImmutableMap.builder();\n+        for (Map.Entry<String, Optional<Partition>> entry : batch.entrySet()) {\n+            if (!entry.getValue().isPresent()) {\n+                throw new PrestoException(HIVE_PARTITION_DROPPED_DURING_QUERY, \"Partition no longer exists: \" + entry.getKey());\n+            }\n+            partitionBuilder.put(entry.getKey(), entry.getValue().get());\n+        }\n+        return new PartitionBatchInfo(partitionBuilder.build());\n+    }\n+\n+    private static Optional<ValueSet> getColumnStatsValueSet(HiveColumnStatistics statistics, HiveType hiveType)\n+    {\n+        // TODO: Support more types\n+        if (hiveType.equals(HIVE_BYTE) || hiveType.equals(HIVE_SHORT) || hiveType.equals(HIVE_INT) || hiveType.equals(HIVE_LONG)) {\n+            return getIntegerColumnStatsValueSet(statistics, hiveType);\n+        }\n+        else {\n+            return Optional.empty();\n+        }\n+    }\n+\n+    private static Optional<ValueSet> getIntegerColumnStatsValueSet(HiveColumnStatistics statistics, HiveType hiveType)", "originalCommit": "d87f72ee709a3a5632103852acafa6fe5c91c1f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjg1NTc4OQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r562855789", "bodyText": "Oh wow very cool. Not aware of it. Thanks for pointing this out", "author": "shixuan-fan", "createdAt": "2021-01-22T19:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ0MzcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkzMTI5OA==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r563931298", "bodyText": "As discussed, we likely will not use isRangeSupported because it will cast data into double, which might lead to accuracy lost if we have large Long statistics.", "author": "shixuan-fan", "createdAt": "2021-01-25T18:02:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ0MzcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ0MzkxNQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561443915", "bodyText": "Let's add simple translation to HiveTypeTranslator and add a round-trip test to it.", "author": "highker", "createdAt": "2021-01-21T00:56:28Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -496,6 +506,149 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static PartitionBatchInfo getPartitionBatchInfo(\n+            ConnectorSession session,\n+            SemiTransactionalHiveMetastore metastore,\n+            SchemaTableName tableName,\n+            List<HivePartition> partitionBatch,\n+            Map<String, HiveColumnHandle> predicateColumns,\n+            Optional<Map<Subfield, Domain>> domains)\n+    {\n+        if (isPartitionStatsBasedOptimizationEnabled(session) && domains.isPresent()) {\n+            Map<String, Optional<Partition>> partitions = metastore.getPartitionsByNames(\n+                    tableName.getSchemaName(),\n+                    tableName.getTableName(),\n+                    Lists.transform(partitionBatch, HivePartition::getPartitionId));\n+            Map<String, PartitionStatistics> partitionStatistics = metastore.getPartitionStatistics(\n+                    tableName.getSchemaName(),\n+                    tableName.getTableName(),\n+                    partitionBatch.stream()\n+                            .map(HivePartition::getPartitionId)\n+                            .collect(toImmutableSet()));\n+            ImmutableSet.Builder<String> prunedPartitionNamesBuilder = ImmutableSet.builder();\n+            ImmutableMap.Builder<String, Partition> partitionBuilder = ImmutableMap.builder();\n+            for (Map.Entry<String, Optional<Partition>> entry : partitions.entrySet()) {\n+                if (!entry.getValue().isPresent()) {\n+                    throw new PrestoException(HIVE_PARTITION_DROPPED_DURING_QUERY, \"Partition no longer exists: \" + entry.getKey());\n+                }\n+                boolean pruned = false;\n+                if (partitionStatistics.containsKey(entry.getKey())) {\n+                    Map<String, HiveColumnStatistics> columnStatsMap = partitionStatistics.get(entry.getKey()).getColumnStatistics();\n+                    for (Map.Entry<String, HiveColumnHandle> predicateColumnEntry : predicateColumns.entrySet()) {\n+                        if (columnStatsMap.containsKey(predicateColumnEntry.getKey())) {\n+                            Optional<ValueSet> columnsStatsValueSet = getColumnStatsValueSet(columnStatsMap.get(predicateColumnEntry.getKey()), predicateColumnEntry.getValue().getHiveType());\n+                            if (columnsStatsValueSet.isPresent()) {\n+                                ValueSet columnPredicateValueSet = domains.get().get(new Subfield(predicateColumnEntry.getKey())).getValues();\n+                                if (!columnPredicateValueSet.overlaps(columnsStatsValueSet.get())) {\n+                                    pruned = true;\n+                                    break;\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+\n+                if (pruned) {\n+                    prunedPartitionNamesBuilder.add(entry.getKey());\n+                }\n+                else {\n+                    partitionBuilder.put(entry.getKey(), entry.getValue().get());\n+                }\n+            }\n+            return new PartitionBatchInfo(partitionBuilder.build(), prunedPartitionNamesBuilder.build());\n+        }\n+\n+        Map<String, Optional<Partition>> batch = metastore.getPartitionsByNames(\n+                tableName.getSchemaName(),\n+                tableName.getTableName(),\n+                Lists.transform(partitionBatch, HivePartition::getPartitionId));\n+        ImmutableMap.Builder<String, Partition> partitionBuilder = ImmutableMap.builder();\n+        for (Map.Entry<String, Optional<Partition>> entry : batch.entrySet()) {\n+            if (!entry.getValue().isPresent()) {\n+                throw new PrestoException(HIVE_PARTITION_DROPPED_DURING_QUERY, \"Partition no longer exists: \" + entry.getKey());\n+            }\n+            partitionBuilder.put(entry.getKey(), entry.getValue().get());\n+        }\n+        return new PartitionBatchInfo(partitionBuilder.build());\n+    }\n+\n+    private static Optional<ValueSet> getColumnStatsValueSet(HiveColumnStatistics statistics, HiveType hiveType)\n+    {\n+        // TODO: Support more types\n+        if (hiveType.equals(HIVE_BYTE) || hiveType.equals(HIVE_SHORT) || hiveType.equals(HIVE_INT) || hiveType.equals(HIVE_LONG)) {\n+            return getIntegerColumnStatsValueSet(statistics, hiveType);\n+        }\n+        else {\n+            return Optional.empty();\n+        }\n+    }\n+\n+    private static Optional<ValueSet> getIntegerColumnStatsValueSet(HiveColumnStatistics statistics, HiveType hiveType)\n+    {\n+        if (!statistics.getIntegerStatistics().isPresent()) {\n+            return Optional.empty();\n+        }\n+\n+        IntegerStatistics hiveColumnStatistics = statistics.getIntegerStatistics().get();\n+        Type integerType;\n+        if (hiveType.equals(HIVE_BYTE)) {\n+            integerType = TINYINT;\n+        }\n+        else if (hiveType.equals(HIVE_SHORT)) {\n+            integerType = SMALLINT;\n+        }\n+        else if (hiveType.equals(HIVE_INT)) {\n+            integerType = INTEGER;\n+        }\n+        else if (hiveType.equals(HIVE_LONG)) {\n+            integerType = BIGINT;\n+        }\n+        else {\n+            throw new IllegalArgumentException(format(\"Expect integer hive type, but found: %s\", hiveType));\n+        }", "originalCommit": "d87f72ee709a3a5632103852acafa6fe5c91c1f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjg2MzM4MQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r562863381", "bodyText": "Will add HiveType -> Type translation to the existing TypeTranslator interface.", "author": "shixuan-fan", "createdAt": "2021-01-22T19:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ0MzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg3NjEwMg==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r564876102", "bodyText": "Just saw HiveType#getPrimitiveType, which would achieve what we want. Will just leverage that :)", "author": "shixuan-fan", "createdAt": "2021-01-26T22:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ0MzkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ1MjQ2Ng==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561452466", "bodyText": "Let's add a comment to this field.", "author": "highker", "createdAt": "2021-01-21T01:21:45Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitionMetadata.java", "diffHunk": "@@ -27,17 +29,20 @@\n     private final HivePartition hivePartition;\n     private final Map<Integer, Column> partitionSchemaDifference;\n     private final Optional<EncryptionInformation> encryptionInformation;\n+    private final Set<ColumnHandle> redundantColumnDomains;", "originalCommit": "be70bf53830c066f08d2da2b14020ac9e53b10a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ1OTk3MA==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561459970", "bodyText": "If we use DoubleRange, we might need some transformation from Domain to it.", "author": "highker", "createdAt": "2021-01-21T01:44:34Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -543,6 +555,9 @@ private static PartitionBatchInfo getPartitionBatchInfo(\n                                     pruned = true;\n                                     break;\n                                 }\n+                                if (columnPredicateValueSet.contains(columnsStatsValueSet.get())) {\n+                                    redundantSubfieldDomainsBuilder.add(predicateColumnEntry.getValue());", "originalCommit": "be70bf53830c066f08d2da2b14020ac9e53b10a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ5MjM1MQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561492351", "bodyText": "I think we can remove the if condition here. if we have isPartitionStatsBasedOptimizationEnabled(session), then we can create an empty map for partitionStatistics. Otherwise call getPartitionStatistics", "author": "highker", "createdAt": "2021-01-21T02:25:34Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -496,6 +506,149 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static PartitionBatchInfo getPartitionBatchInfo(\n+            ConnectorSession session,\n+            SemiTransactionalHiveMetastore metastore,\n+            SchemaTableName tableName,\n+            List<HivePartition> partitionBatch,\n+            Map<String, HiveColumnHandle> predicateColumns,\n+            Optional<Map<Subfield, Domain>> domains)\n+    {\n+        if (isPartitionStatsBasedOptimizationEnabled(session) && domains.isPresent()) {", "originalCommit": "d87f72ee709a3a5632103852acafa6fe5c91c1f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzk0NTk4Ng==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r563945986", "bodyText": "I changed the logic a bit, now it looks like:\npartitions = <get partitions by names>;\npartitionStatistics = ImmutableMap.of();\nif (domain.isPresent() && <session property is true>) {\n  partitionStatistics = <get partition statistics>\n}\n<process partitions>", "author": "shixuan-fan", "createdAt": "2021-01-25T18:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTQ5MjM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTUzNzY0NA==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561537644", "bodyText": "While reviewing the 2nd commit, maybe it's better to model these objects asMap<String, PartitionSplitInfo>, where PartitionSplitInfo (or whatever a better name) is an encapsulation. It will have Partition, boolean-typed pruned flag, and a set of redundantColumnDomains.", "author": "highker", "createdAt": "2021-01-21T03:10:08Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -621,16 +637,21 @@ else if (hiveType.equals(HIVE_LONG)) {\n     {\n         private final Map<String, Partition> partitions;\n         private final Set<String> prunedPartitionNames;\n+        private final Map<String, Set<ColumnHandle>> redundantColumnDomains;", "originalCommit": "be70bf53830c066f08d2da2b14020ac9e53b10a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTU2OTgxOQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561569819", "bodyText": "The only concern I have is the SPI change. Let's chat offline", "author": "highker", "createdAt": "2021-01-21T03:41:36Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/ConnectorSplit.java", "diffHunk": "@@ -48,4 +50,12 @@ default OptionalLong getSplitSizeInBytes()\n     {\n         return OptionalLong.empty();\n     }\n+\n+    /**\n+     * Provide a set of columns whose domains could be ignored.\n+     */\n+    default Set<ColumnHandle> getRedundantColumnDomains()\n+    {\n+        return new HashSet<>();\n+    }", "originalCommit": "be70bf53830c066f08d2da2b14020ac9e53b10a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzk2NzI2OQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r563967269", "bodyText": "As discussed, we will pass ConnectSplit to ConnectorTableLayoutHandle#getIdentifier, so that engine will not bother connector-specific runtime processing.", "author": "shixuan-fan", "createdAt": "2021-01-25T18:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTU2OTgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTU3MzUyNw==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561573527", "bodyText": "Is this correct? What if we have a running driver, the first split removes a column domain and this code will persist the change in the context, then the second split doesn't want to remove the column domain and it will get the one without column domain?", "author": "highker", "createdAt": "2021-01-21T03:45:18Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/Driver.java", "diffHunk": "@@ -258,9 +258,10 @@ private void processNewSources()\n         for (ScheduledSplit newSplit : newSplits) {\n             Split split = newSplit.getSplit();\n \n-            if (fragmentResultCacheContext.isPresent() && !(split.getConnectorSplit() instanceof RemoteSplit)) {\n+            if (fragmentResultCacheContext.get().isPresent() && !(split.getConnectorSplit() instanceof RemoteSplit)) {\n                 checkState(!this.cachedResult.get().isPresent());\n-                this.cachedResult.set(fragmentResultCacheContext.get().getFragmentResultCacheManager().get(fragmentResultCacheContext.get().getHashedCanonicalPlanFragment(), split));\n+                this.fragmentResultCacheContext.set(this.fragmentResultCacheContext.get().map(context -> context.removeRedundantSubfieldDomains(split.getConnectorSplit().getRedundantColumnDomains())));", "originalCommit": "be70bf53830c066f08d2da2b14020ac9e53b10a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA2OTQ4MQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r564069481", "bodyText": "Yes, this is correct. fragmentResultCacheContext in Driver is an AtomicReference to the initial context in DriverContext. Runtime changes will create a new FragmentResultCacheContext referenced by this Driver, but won't touch DriverContext. Given that one Driver would only handle one source split coming from storage, it should not affect other splits.", "author": "shixuan-fan", "createdAt": "2021-01-25T21:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTU3MzUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTU5NzkzMg==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r561597932", "bodyText": "May be can early exit if predicates do not exist or do not have non partition columns.", "author": "jainxrohit", "createdAt": "2021-01-21T04:39:47Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -496,6 +506,149 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private static PartitionBatchInfo getPartitionBatchInfo(\n+            ConnectorSession session,\n+            SemiTransactionalHiveMetastore metastore,\n+            SchemaTableName tableName,\n+            List<HivePartition> partitionBatch,\n+            Map<String, HiveColumnHandle> predicateColumns,\n+            Optional<Map<Subfield, Domain>> domains)\n+    {\n+        if (isPartitionStatsBasedOptimizationEnabled(session) && domains.isPresent()) {", "originalCommit": "d87f72ee709a3a5632103852acafa6fe5c91c1f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA3MDkyMg==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r564070922", "bodyText": "Yes, we will early exit if there is no predicate domains, or there is no partition stats. The logic will be a bit different and more like the one mentioned in #15554 (comment)", "author": "shixuan-fan", "createdAt": "2021-01-25T21:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTU5NzkzMg=="}], "type": "inlineReview"}, {"oid": "93e78bbad05d1a59de52526a978ebb1cca0b0172", "url": "https://github.com/prestodb/presto/commit/93e78bbad05d1a59de52526a978ebb1cca0b0172", "message": "Support column domain stripping based on partition stats", "committedDate": "2021-01-23T01:30:00Z", "type": "forcePushed"}, {"oid": "8f6ed9f98f2a3a7d29c50edbf7d55f5a6a189b70", "url": "https://github.com/prestodb/presto/commit/8f6ed9f98f2a3a7d29c50edbf7d55f5a6a189b70", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-25T22:14:32Z", "type": "forcePushed"}, {"oid": "07fc165242790489ca45179b7b8a663df4458d38", "url": "https://github.com/prestodb/presto/commit/07fc165242790489ca45179b7b8a663df4458d38", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-25T22:28:27Z", "type": "forcePushed"}, {"oid": "aedd0d591b2fe71b568dc05d8aebe2b5c83a76c7", "url": "https://github.com/prestodb/presto/commit/aedd0d591b2fe71b568dc05d8aebe2b5c83a76c7", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-26T01:16:06Z", "type": "forcePushed"}, {"oid": "fa318fa89ea73baef074767f7a3d1870cf36b1d2", "url": "https://github.com/prestodb/presto/commit/fa318fa89ea73baef074767f7a3d1870cf36b1d2", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-26T22:40:43Z", "type": "forcePushed"}, {"oid": "43006f6863a7ef31295c4d63166f4ebe475c34dd", "url": "https://github.com/prestodb/presto/commit/43006f6863a7ef31295c4d63166f4ebe475c34dd", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-26T22:47:26Z", "type": "forcePushed"}, {"oid": "75bc9c34762a3770a88ae168b31606e805ed01e9", "url": "https://github.com/prestodb/presto/commit/75bc9c34762a3770a88ae168b31606e805ed01e9", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-27T00:59:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk3OTM5MA==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r564979390", "bodyText": "nit: break a line after this", "author": "highker", "createdAt": "2021-01-27T02:24:31Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -386,6 +398,9 @@ public CounterStat getHighMemorySplitSource()\n             int unreadablePartitionsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n+                if (partitionSplitInfo.get(hivePartition.getPartitionId()).isPruned()) {\n+                    continue;\n+                }", "originalCommit": "f1851ccbcee9f8c68d8d71d4f0f36c61ad4f57e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk4MDgyNg==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r564980826", "bodyText": "Maybe add a javadoc or todo to indicate varchar/varbinary could be added as well", "author": "highker", "createdAt": "2021-01-27T02:28:45Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -496,6 +516,207 @@ public CounterStat getHighMemorySplitSource()\n         return concat(partitionBatches);\n     }\n \n+    private Map<String, PartitionSplitInfo> getPartitionSplitInfo(\n+            ConnectorSession session,\n+            SemiTransactionalHiveMetastore metastore,\n+            SchemaTableName tableName,\n+            List<HivePartition> partitionBatch,\n+            Map<String, HiveColumnHandle> predicateColumns,\n+            Optional<Map<Subfield, Domain>> domains)\n+    {\n+        Map<String, Optional<Partition>> partitions = metastore.getPartitionsByNames(\n+                tableName.getSchemaName(),\n+                tableName.getTableName(),\n+                Lists.transform(partitionBatch, HivePartition::getPartitionId));\n+        Map<String, PartitionStatistics> partitionStatistics = ImmutableMap.of();\n+        if (domains.isPresent() && isPartitionStatisticsBasedOptimizationEnabled(session)) {\n+            partitionStatistics = metastore.getPartitionStatistics(\n+                    tableName.getSchemaName(),\n+                    tableName.getTableName(),\n+                    partitionBatch.stream()\n+                            .map(HivePartition::getPartitionId)\n+                            .collect(toImmutableSet()));\n+        }\n+\n+        ImmutableMap.Builder<String, PartitionSplitInfo> partitionSplitInfoBuilder = ImmutableMap.builder();\n+        for (Map.Entry<String, Optional<Partition>> entry : partitions.entrySet()) {\n+            ImmutableSet.Builder<ColumnHandle> redundantColumnDomainsBuilder = ImmutableSet.builder();\n+            if (!entry.getValue().isPresent()) {\n+                throw new PrestoException(HIVE_PARTITION_DROPPED_DURING_QUERY, \"Partition no longer exists: \" + entry.getKey());\n+            }\n+            boolean pruned = false;\n+            if (partitionStatistics.containsKey(entry.getKey())) {\n+                Map<String, HiveColumnStatistics> columnStatistics = partitionStatistics.get(entry.getKey()).getColumnStatistics();\n+                for (Map.Entry<String, HiveColumnHandle> predicateColumnEntry : predicateColumns.entrySet()) {\n+                    if (columnStatistics.containsKey(predicateColumnEntry.getKey())) {\n+                        Optional<ValueSet> columnsStatisticsValueSet = getColumnStatisticsValueSet(columnStatistics.get(predicateColumnEntry.getKey()), predicateColumnEntry.getValue().getHiveType());\n+                        if (columnsStatisticsValueSet.isPresent()) {\n+                            ValueSet columnPredicateValueSet = domains.get().get(new Subfield(predicateColumnEntry.getKey())).getValues();\n+                            if (!columnPredicateValueSet.overlaps(columnsStatisticsValueSet.get())) {\n+                                pruned = true;\n+                                break;\n+                            }\n+                            if (columnPredicateValueSet.contains(columnsStatisticsValueSet.get())) {\n+                                redundantColumnDomainsBuilder.add(predicateColumnEntry.getValue());\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+\n+            partitionSplitInfoBuilder.put(entry.getKey(), new PartitionSplitInfo(entry.getValue().get(), pruned, redundantColumnDomainsBuilder.build()));\n+        }\n+        return partitionSplitInfoBuilder.build();\n+    }\n+\n+    private Optional<ValueSet> getColumnStatisticsValueSet(HiveColumnStatistics statistics, HiveType hiveType)", "originalCommit": "f1851ccbcee9f8c68d8d71d4f0f36c61ad4f57e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY1NTU4MQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r565655581", "bodyText": "I'm not sure if varchar/varbinary could be added. To do that we would first make sure HiveColumnStatistics supports varchar/varbinary stats type. For now the only thing remaining is boolean, which I doubt it makes sense from pruning point of view as it only has two values.", "author": "shixuan-fan", "createdAt": "2021-01-27T21:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk4MDgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk4Mzg5OQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r564983899", "bodyText": "static import BIGINT", "author": "highker", "createdAt": "2021-01-27T02:38:08Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveSplit.java", "diffHunk": "@@ -91,7 +103,7 @@ public void testJsonRoundTrip()\n                 Optional.of(new HiveSplit.BucketConversion(\n                         32,\n                         16,\n-                        ImmutableList.of(new HiveColumnHandle(\"col\", HIVE_LONG, BIGINT.getTypeSignature(), 5, ColumnType.REGULAR, Optional.of(\"comment\"), Optional.empty())))),\n+                        ImmutableList.of(new HiveColumnHandle(\"col\", HIVE_LONG, BigintType.BIGINT.getTypeSignature(), 5, REGULAR, Optional.of(\"comment\"), Optional.empty())))),", "originalCommit": "75bc9c34762a3770a88ae168b31606e805ed01e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY1Njc2OQ==", "url": "https://github.com/prestodb/presto/pull/15554#discussion_r565656769", "bodyText": "Done. Also did the same for TestHiveSplitManager.", "author": "shixuan-fan", "createdAt": "2021-01-27T21:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDk4Mzg5OQ=="}], "type": "inlineReview"}, {"oid": "dfbf1aa50115f14e59fc3f609784a322f919dec7", "url": "https://github.com/prestodb/presto/commit/dfbf1aa50115f14e59fc3f609784a322f919dec7", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-27T21:46:23Z", "type": "forcePushed"}, {"oid": "0fd0a77dd1a37b2545794fb43daeb3ed923554c1", "url": "https://github.com/prestodb/presto/commit/0fd0a77dd1a37b2545794fb43daeb3ed923554c1", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-27T23:05:15Z", "type": "forcePushed"}, {"oid": "89e4c3d06927d14bf9b6d28b93b5f9a2d6baa5a1", "url": "https://github.com/prestodb/presto/commit/89e4c3d06927d14bf9b6d28b93b5f9a2d6baa5a1", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-28T00:29:05Z", "type": "forcePushed"}, {"oid": "d6358f0c427816eae7edd0b76f2cf846ca1c4b2a", "url": "https://github.com/prestodb/presto/commit/d6358f0c427816eae7edd0b76f2cf846ca1c4b2a", "message": "Support partition pruning based on partition statistics", "committedDate": "2021-01-28T01:15:00Z", "type": "commit"}, {"oid": "b82dba0cb07dc32ec095a427be030f70d54d8570", "url": "https://github.com/prestodb/presto/commit/b82dba0cb07dc32ec095a427be030f70d54d8570", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-28T01:15:00Z", "type": "commit"}, {"oid": "b82dba0cb07dc32ec095a427be030f70d54d8570", "url": "https://github.com/prestodb/presto/commit/b82dba0cb07dc32ec095a427be030f70d54d8570", "message": "Support column domain stripping based on partition statistics", "committedDate": "2021-01-28T01:15:00Z", "type": "forcePushed"}]}