{"pr_number": 14110, "pr_title": "Cache PlanFragment serialization", "pr_createdAt": "2020-02-18T05:43:18Z", "pr_url": "https://github.com/prestodb/presto/pull/14110", "timeline": [{"oid": "a3cc50fe7fe3f196c9a602f312c903c474c1c5c3", "url": "https://github.com/prestodb/presto/commit/a3cc50fe7fe3f196c9a602f312c903c474c1c5c3", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-18T05:59:08Z", "type": "forcePushed"}, {"oid": "79057d5c6400616df1f7e04683453f235ef13ca4", "url": "https://github.com/prestodb/presto/commit/79057d5c6400616df1f7e04683453f235ef13ca4", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-18T06:43:22Z", "type": "forcePushed"}, {"oid": "f972fb7ed37f9aa586f416469c3902d068230fd5", "url": "https://github.com/prestodb/presto/commit/f972fb7ed37f9aa586f416469c3902d068230fd5", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-18T21:48:23Z", "type": "forcePushed"}, {"oid": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "url": "https://github.com/prestodb/presto/commit/1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-18T23:16:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MTMzMQ==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381581331", "bodyText": "nit: maybe add a short comment (so only serialize once \ud83d\ude03 )", "author": "wenleix", "createdAt": "2020-02-19T22:24:07Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragment.java", "diffHunk": "@@ -54,6 +53,8 @@\n     private final StatsAndCosts statsAndCosts;\n     private final Optional<String> jsonRepresentation;\n \n+    private SerializedString cachedSerialization;", "originalCommit": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjQ5OA==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381626498", "bodyText": "See: https://github.com/prestodb/presto/compare/6b5757b8ed4fb19aee6c257aec17a21cd16c068f..e70403ed7c21ca5e8206208db1b056d2f3137fca", "author": "tdcmeehan", "createdAt": "2020-02-20T00:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MTMzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MTU1Mw==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381581553", "bodyText": "benign data race ? \ud83d\ude03\nThe only question is if all the serialization request comes at similar time, would this cause we still serialize for every task?", "author": "wenleix", "createdAt": "2020-02-19T22:24:39Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragment.java", "diffHunk": "@@ -153,6 +154,16 @@ public StatsAndCosts getStatsAndCosts()\n         return jsonRepresentation;\n     }\n \n+    // Serialize this plan fragment with the provided codec, caching the results\n+    public SerializedString toBytes(Codec<PlanFragment> codec)\n+    {\n+        requireNonNull(codec, \"codec is null\");\n+        if (cachedSerialization == null) {", "originalCommit": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjQ2OA==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381626468", "bodyText": "I'll just synchronize it", "author": "tdcmeehan", "createdAt": "2020-02-20T00:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MTU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MjU2Ng==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381582566", "bodyText": "Add a comment this is only required on coordinator side when serializing PlanFragment, not provided on worker :)", "author": "wenleix", "createdAt": "2020-02-19T22:26:56Z", "path": "presto-main/src/main/java/com/facebook/presto/server/TaskUpdateRequest.java", "diffHunk": "@@ -38,6 +43,7 @@\n     private final List<TaskSource> sources;\n     private final OutputBuffers outputIds;\n     private final Optional<TableWriteInfo> tableWriteInfo;\n+    private final Optional<Codec<PlanFragment>> fragmentCodec;", "originalCommit": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjUxNg==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381626516", "bodyText": "See: https://github.com/prestodb/presto/compare/6b5757b8ed4fb19aee6c257aec17a21cd16c068f..e70403ed7c21ca5e8206208db1b056d2f3137fca", "author": "tdcmeehan", "createdAt": "2020-02-20T00:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MjU2Ng=="}], "type": "inlineReview"}, {"oid": "bd3d7302743053010f03f331cd9edd889ec8c09d", "url": "https://github.com/prestodb/presto/commit/bd3d7302743053010f03f331cd9edd889ec8c09d", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-20T00:24:53Z", "type": "forcePushed"}, {"oid": "6b5757b8ed4fb19aee6c257aec17a21cd16c068f", "url": "https://github.com/prestodb/presto/commit/6b5757b8ed4fb19aee6c257aec17a21cd16c068f", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-20T00:25:34Z", "type": "forcePushed"}, {"oid": "e70403ed7c21ca5e8206208db1b056d2f3137fca", "url": "https://github.com/prestodb/presto/commit/e70403ed7c21ca5e8206208db1b056d2f3137fca", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-20T00:29:35Z", "type": "forcePushed"}, {"oid": "726b8c7a44c30ccbdbff34841611e2db1b2f82f7", "url": "https://github.com/prestodb/presto/commit/726b8c7a44c30ccbdbff34841611e2db1b2f82f7", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-24T07:25:43Z", "type": "forcePushed"}, {"oid": "6362af32fe4a3eee06782a19857220a540f6ef5e", "url": "https://github.com/prestodb/presto/commit/6362af32fe4a3eee06782a19857220a540f6ef5e", "message": "Add fromBytes to Codec", "committedDate": "2020-02-24T19:53:18Z", "type": "commit"}, {"oid": "2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96", "url": "https://github.com/prestodb/presto/commit/2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-24T19:53:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1MzkyOA==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r383553928", "bodyText": "nit: after going through the code, it is clear the Codec should not change during the lifecycle of a JVM. Lets just add a comment that clarifies this here. Because technically if someone passes a different codec in the second call, we will be returning the incorrect result. Better if we can add some variant for the same.", "author": "mayankgarg1990", "createdAt": "2020-02-24T22:31:12Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragment.java", "diffHunk": "@@ -153,6 +157,16 @@ public StatsAndCosts getStatsAndCosts()\n         return jsonRepresentation;\n     }\n \n+    // Serialize this plan fragment with the provided codec, caching the results\n+    public synchronized byte[] toBytes(Codec<PlanFragment> codec)", "originalCommit": "2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1NjUzNA==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r383556534", "bodyText": "I'll add the reference to the first successfully used Codec and throw if it differs.", "author": "tdcmeehan", "createdAt": "2020-02-24T22:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1MzkyOA=="}], "type": "inlineReview"}, {"oid": "e6104a27ea0c7af561f881d23c893e940e16b25f", "url": "https://github.com/prestodb/presto/commit/e6104a27ea0c7af561f881d23c893e940e16b25f", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-24T22:56:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3NDc3OA==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r383674778", "bodyText": "This constructor is only used in HttpRemoteTask  right? Should we just inline it?", "author": "wenleix", "createdAt": "2020-02-25T06:06:10Z", "path": "presto-main/src/main/java/com/facebook/presto/server/TaskUpdateRequest.java", "diffHunk": "@@ -63,6 +66,24 @@ public TaskUpdateRequest(\n         this.tableWriteInfo = tableWriteInfo;\n     }\n \n+    public TaskUpdateRequest(", "originalCommit": "e6104a27ea0c7af561f881d23c893e940e16b25f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3NDkyMg==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r383674922", "bodyText": "How can this be non-absent? -- the later TaskUpdateRequest won't have plan fragment right? -- Am I missing anything? ;)", "author": "wenleix", "createdAt": "2020-02-25T06:06:44Z", "path": "presto-main/src/main/java/com/facebook/presto/server/TaskUpdateRequest.java", "diffHunk": "@@ -75,8 +96,9 @@ public SessionRepresentation getSession()\n         return extraCredentials;\n     }\n \n+    @JsonInclude(NON_ABSENT)", "originalCommit": "e6104a27ea0c7af561f881d23c893e940e16b25f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NDQ1Nw==", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r384694457", "bodyText": "This means don't even include the JSON key if the value is absent", "author": "tdcmeehan", "createdAt": "2020-02-26T18:53:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3NDkyMg=="}], "type": "inlineReview"}, {"oid": "530bc6f3f3680ac5d3bcc2c1da4c8d13d44a07b6", "url": "https://github.com/prestodb/presto/commit/530bc6f3f3680ac5d3bcc2c1da4c8d13d44a07b6", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-25T23:51:31Z", "type": "forcePushed"}, {"oid": "5dc71e0f1db4579a88fff8b7a1577b4b092fea34", "url": "https://github.com/prestodb/presto/commit/5dc71e0f1db4579a88fff8b7a1577b4b092fea34", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-25T23:52:55Z", "type": "commit"}, {"oid": "5dc71e0f1db4579a88fff8b7a1577b4b092fea34", "url": "https://github.com/prestodb/presto/commit/5dc71e0f1db4579a88fff8b7a1577b4b092fea34", "message": "Cache PlanFragment serialization", "committedDate": "2020-02-25T23:52:55Z", "type": "forcePushed"}]}