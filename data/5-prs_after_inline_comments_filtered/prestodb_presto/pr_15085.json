{"pr_number": 15085, "pr_title": "Improve logging of queued queries", "pr_createdAt": "2020-08-26T03:17:38Z", "pr_url": "https://github.com/prestodb/presto/pull/15085", "timeline": [{"oid": "8e6e170c6af8d09ea0ff0477f940df7cb2965d7d", "url": "https://github.com/prestodb/presto/commit/8e6e170c6af8d09ea0ff0477f940df7cb2965d7d", "message": "Fix race when logging query completion event", "committedDate": "2020-08-26T03:51:21Z", "type": "forcePushed"}, {"oid": "86190b640d67d60a4b6595507e76ff612964bb0f", "url": "https://github.com/prestodb/presto/commit/86190b640d67d60a4b6595507e76ff612964bb0f", "message": "Fix race when logging query completion event", "committedDate": "2020-08-26T05:43:43Z", "type": "forcePushed"}, {"oid": "075e22b178c1dafd57bc600824ffefa8e2dd51bd", "url": "https://github.com/prestodb/presto/commit/075e22b178c1dafd57bc600824ffefa8e2dd51bd", "message": "Fix race when logging query completion event", "committedDate": "2020-08-26T07:48:46Z", "type": "forcePushed"}, {"oid": "f4bd739bc402828a28c0b797f5c021b795e56b83", "url": "https://github.com/prestodb/presto/commit/f4bd739bc402828a28c0b797f5c021b795e56b83", "message": "Fix race when logging query completion event", "committedDate": "2020-08-26T18:18:18Z", "type": "forcePushed"}, {"oid": "bacc02b5b05b5e6910d401fbf0e93785af1d7770", "url": "https://github.com/prestodb/presto/commit/bacc02b5b05b5e6910d401fbf0e93785af1d7770", "message": "Fix race when logging query completion event", "committedDate": "2020-08-26T18:21:36Z", "type": "forcePushed"}, {"oid": "b61c26381edc1ea342ecdff0e96ced2323d1dd65", "url": "https://github.com/prestodb/presto/commit/b61c26381edc1ea342ecdff0e96ced2323d1dd65", "message": "Fix race when logging query completion event", "committedDate": "2020-08-26T18:58:38Z", "type": "forcePushed"}, {"oid": "8f15a59dc06ad8f1d229e811beb072f890c20416", "url": "https://github.com/prestodb/presto/commit/8f15a59dc06ad8f1d229e811beb072f890c20416", "message": "Fix race when logging query completion event", "committedDate": "2020-08-26T19:34:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0MzQ0Mw==", "url": "https://github.com/prestodb/presto/pull/15085#discussion_r477543443", "bodyText": "can this just invoke the fail function?", "author": "mayankgarg1990", "createdAt": "2020-08-26T19:38:03Z", "path": "presto-main/src/main/java/com/facebook/presto/dispatcher/LocalDispatchQuery.java", "diffHunk": "@@ -71,14 +73,16 @@ public LocalDispatchQuery(\n             Consumer<QueryExecution> querySubmitter)\n     {\n         this.stateMachine = requireNonNull(stateMachine, \"stateMachine is null\");\n+        this.queryMonitor = requireNonNull(queryMonitor, \"queryMonitor is null\");\n         this.queryExecutionFuture = requireNonNull(queryExecutionFuture, \"queryExecutionFuture is null\");\n         this.clusterSizeMonitor = requireNonNull(clusterSizeMonitor, \"clusterSizeMonitor is null\");\n         this.queryExecutor = requireNonNull(queryExecutor, \"queryExecutor is null\");\n         this.querySubmitter = requireNonNull(querySubmitter, \"querySubmitter is null\");\n \n         addExceptionCallback(queryExecutionFuture, throwable -> {\n-            stateMachine.transitionToFailed(throwable);\n-            queryMonitor.queryImmediateFailureEvent(stateMachine.getBasicQueryInfo(Optional.empty()), toFailure(throwable));\n+            if (stateMachine.transitionToFailed(throwable)) {\n+                queryMonitor.queryImmediateFailureEvent(stateMachine.getBasicQueryInfo(Optional.empty()), toFailure(throwable));\n+            }", "originalCommit": "8f15a59dc06ad8f1d229e811beb072f890c20416", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0NTQ1OQ==", "url": "https://github.com/prestodb/presto/pull/15085#discussion_r477545459", "bodyText": "I was wary of referencing a method in the constructor before the object is fully initialized.", "author": "tdcmeehan", "createdAt": "2020-08-26T19:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0MzQ0Mw=="}], "type": "inlineReview"}, {"oid": "518aeda038603b636570f3ed949a78de9118573b", "url": "https://github.com/prestodb/presto/commit/518aeda038603b636570f3ed949a78de9118573b", "message": "Improve logging of queued queries", "committedDate": "2020-08-26T21:39:50Z", "type": "commit"}, {"oid": "518aeda038603b636570f3ed949a78de9118573b", "url": "https://github.com/prestodb/presto/commit/518aeda038603b636570f3ed949a78de9118573b", "message": "Improve logging of queued queries", "committedDate": "2020-08-26T21:39:50Z", "type": "forcePushed"}]}