{"pr_number": 14139, "pr_title": "Adding fnv1 and fnv1a hash functions", "pr_createdAt": "2020-02-21T21:06:06Z", "pr_url": "https://github.com/prestodb/presto/pull/14139", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzY2Mg==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382843662", "bodyText": "Presto Java code follow camel convention (and don't usually use _). What about fnv1Hash32? ? Ditto for other methods.", "author": "wenleix", "createdAt": "2020-02-21T22:51:56Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/FnvHash.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import io.airlift.slice.Slice;\n+\n+// Taken from https://github.com/airlift/slice/blob/95d5876d3f4c57321767113e97416a42bc41749a/src/main/java/io/airlift/slice/FnvHash.java\n+class FnvHash\n+{\n+    private static final long FNV_64_OFFSET_BASIS = 0xcbf29ce484222325L;\n+    private static final long FNV_64_PRIME = 0x100000001b3L;\n+\n+    private static final int FNV_32_OFFSET_BASIS = 0x811c9dc5;\n+    private static final int FNV_32_PRIME = 0x01000193;\n+\n+    private FnvHash()\n+    {\n+    }\n+\n+    static int fnv1_32(Slice data)", "originalCommit": "e5a95a5daa3d2b002e7411a502f92fc0f72ab70c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NDA4OQ==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382844089", "bodyText": "can this be a public method?", "author": "wenleix", "createdAt": "2020-02-21T22:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzY2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzgwOA==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382843808", "bodyText": "ditto for this method name :)", "author": "wenleix", "createdAt": "2020-02-21T22:52:29Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/VarbinaryFunctions.java", "diffHunk": "@@ -315,6 +315,38 @@ public static long crc32(@SqlType(StandardTypes.VARBINARY) Slice slice)\n         return crc32.getValue();\n     }\n \n+    @Description(\"compute fnv-1 32 bit\")\n+    @ScalarFunction\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long fnv1_32(@SqlType(StandardTypes.VARBINARY) Slice slice)", "originalCommit": "e5a95a5daa3d2b002e7411a502f92fc0f72ab70c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1NDMwMA==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382854300", "bodyText": "It seems for sql functions, we use _ a lot, and only using lower case. Should we keep the old method names like ScalarFunction(\"fnv1_32\")?", "author": "widagdos", "createdAt": "2020-02-21T23:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NDQ5OQ==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382844499", "bodyText": "What about the following?\n/**\n * Reference implementation: https://tools.ietf.org/html/draft-eastlake-fnv-17#section-6\n * TODO: Move this utility class to airlift:slice\n */", "author": "wenleix", "createdAt": "2020-02-21T22:54:49Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/FnvHash.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import io.airlift.slice.Slice;\n+\n+// Taken from https://github.com/airlift/slice/blob/95d5876d3f4c57321767113e97416a42bc41749a/src/main/java/io/airlift/slice/FnvHash.java", "originalCommit": "e5a95a5daa3d2b002e7411a502f92fc0f72ab70c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NTM3MQ==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382845371", "bodyText": "Is is by deign that in this method, we first do multiplication and xor , while in fnv1a_32 we first do xor then multiplication.", "author": "wenleix", "createdAt": "2020-02-21T22:57:48Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/FnvHash.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import io.airlift.slice.Slice;\n+\n+// Taken from https://github.com/airlift/slice/blob/95d5876d3f4c57321767113e97416a42bc41749a/src/main/java/io/airlift/slice/FnvHash.java\n+class FnvHash\n+{\n+    private static final long FNV_64_OFFSET_BASIS = 0xcbf29ce484222325L;\n+    private static final long FNV_64_PRIME = 0x100000001b3L;\n+\n+    private static final int FNV_32_OFFSET_BASIS = 0x811c9dc5;\n+    private static final int FNV_32_PRIME = 0x01000193;\n+\n+    private FnvHash()\n+    {\n+    }\n+\n+    static int fnv1_32(Slice data)\n+    {\n+        int hash = FNV_32_OFFSET_BASIS;\n+\n+        for (int i = 0; i < data.length(); ++i) {\n+            int dataByte = data.getUnsignedByte(i);\n+            hash *= FNV_32_PRIME;", "originalCommit": "e5a95a5daa3d2b002e7411a502f92fc0f72ab70c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1MTQzNw==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382851437", "bodyText": "This is the only difference between fnv1 and fnv1a. Fnv1a is slightly better, so we can remove the fnv1. Or we can include both for completeness. what do you think?", "author": "widagdos", "createdAt": "2020-02-21T23:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NTM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2NDg4NQ==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382864885", "bodyText": "@widagdos Sounds good. Let's include both for completeness . :)", "author": "wenleix", "createdAt": "2020-02-22T00:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NTM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NTYyOA==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382845628", "bodyText": "Thanks for the nice test cases!\nnit for the comment: space after //", "author": "wenleix", "createdAt": "2020-02-21T22:58:40Z", "path": "presto-main/src/test/java/com/facebook/presto/operator/scalar/TestVarbinaryFunctions.java", "diffHunk": "@@ -364,6 +364,29 @@ public void testCrc32()\n         assertFunction(\"crc32(to_utf8('ABCDEFGHIJKLM'))\", BIGINT, 4223167559L);\n     }\n \n+    @Test\n+    public void testFnv()\n+    {\n+        // https://nqv.github.io/fnv/\n+        assertFunction(\"fnv1_32(from_hex(''))\", BIGINT, 0x811c9dc5L + Integer.MIN_VALUE * 2L);\n+        assertFunction(\"fnv1_32(from_hex('19'))\", BIGINT, 0x050c5d06L);\n+        assertFunction(\"fnv1_32(from_hex('F5'))\", BIGINT, 0x050c5deaL); //Check for sign extension bug", "originalCommit": "e5a95a5daa3d2b002e7411a502f92fc0f72ab70c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NTc0MA==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r382845740", "bodyText": "nit:\n// ground truth result is generated via https://nqv.github.io/fnv/", "author": "wenleix", "createdAt": "2020-02-21T22:59:05Z", "path": "presto-main/src/test/java/com/facebook/presto/operator/scalar/TestVarbinaryFunctions.java", "diffHunk": "@@ -364,6 +364,29 @@ public void testCrc32()\n         assertFunction(\"crc32(to_utf8('ABCDEFGHIJKLM'))\", BIGINT, 4223167559L);\n     }\n \n+    @Test\n+    public void testFnv()\n+    {\n+        // https://nqv.github.io/fnv/", "originalCommit": "e5a95a5daa3d2b002e7411a502f92fc0f72ab70c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f0391fd25c90780d7b8f282b128730504d734e68", "url": "https://github.com/prestodb/presto/commit/f0391fd25c90780d7b8f282b128730504d734e68", "message": "Adding fnv1 and fnv1a hash functions", "committedDate": "2020-02-21T23:48:25Z", "type": "commit"}, {"oid": "f0391fd25c90780d7b8f282b128730504d734e68", "url": "https://github.com/prestodb/presto/commit/f0391fd25c90780d7b8f282b128730504d734e68", "message": "Adding fnv1 and fnv1a hash functions", "committedDate": "2020-02-21T23:48:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA0OTcxNw==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r384049717", "bodyText": "Please static import the functions per coding convention.", "author": "rongrong", "createdAt": "2020-02-25T18:38:03Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/VarbinaryFunctions.java", "diffHunk": "@@ -315,6 +315,38 @@ public static long crc32(@SqlType(StandardTypes.VARBINARY) Slice slice)\n         return crc32.getValue();\n     }\n \n+    @Description(\"compute fnv-1 32 bit\")\n+    @ScalarFunction(\"fnv1_32\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long fnv1Hash32(@SqlType(StandardTypes.VARBINARY) Slice slice)\n+    {\n+        return FnvHash.fnv1Hash32(slice);", "originalCommit": "f0391fd25c90780d7b8f282b128730504d734e68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5NDM4NQ==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r384094385", "bodyText": "So right now, the method names in VarbinaryFunctions are the same as method names in FnvHash. I think if we use static imports, by default, the code will call the locally defined functions, which will cause stack overflow due to the recursive call.\nShould I rename the functions to be fnv1Hash32VarBinary(), etc?", "author": "widagdos", "createdAt": "2020-02-25T20:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA0OTcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5NTY5Nw==", "url": "https://github.com/prestodb/presto/pull/14139#discussion_r384095697", "bodyText": "Oh didn't realize that. This is fine then. Thanks!", "author": "rongrong", "createdAt": "2020-02-25T20:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA0OTcxNw=="}], "type": "inlineReview"}]}