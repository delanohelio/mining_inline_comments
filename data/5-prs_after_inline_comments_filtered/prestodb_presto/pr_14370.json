{"pr_number": 14370, "pr_title": "Eagerly dereference resources", "pr_createdAt": "2020-04-09T11:01:38Z", "pr_url": "https://github.com/prestodb/presto/pull/14370", "timeline": [{"oid": "93df3fb51be2e8ab163e593b04a840ab6a089c40", "url": "https://github.com/prestodb/presto/commit/93df3fb51be2e8ab163e593b04a840ab6a089c40", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-10T17:32:46Z", "type": "forcePushed"}, {"oid": "e5313c0eb6cdea52354249aeb179830d1581f5b1", "url": "https://github.com/prestodb/presto/commit/e5313c0eb6cdea52354249aeb179830d1581f5b1", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-10T17:37:36Z", "type": "forcePushed"}, {"oid": "fd2919ba2924987a96642ce8def3ac810da9b725", "url": "https://github.com/prestodb/presto/commit/fd2919ba2924987a96642ce8def3ac810da9b725", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-10T17:38:28Z", "type": "forcePushed"}, {"oid": "5cdedb44af76446692cf652f48e80e760154f6e3", "url": "https://github.com/prestodb/presto/commit/5cdedb44af76446692cf652f48e80e760154f6e3", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-10T17:49:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg3MDM2MA==", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r406870360", "bodyText": "this is handled in super.close()", "author": "bhhari", "createdAt": "2020-04-10T17:53:29Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcSelectiveRecordReader.java", "diffHunk": "@@ -849,14 +849,6 @@ private void initializeOutputPositions(int positionCount)\n     public void close()\n             throws IOException\n     {\n-        try (Closer closer = Closer.create()) {", "originalCommit": "5cdedb44af76446692cf652f48e80e760154f6e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "affb72dcb462d6d111480ec5797a7d068a8473dc", "url": "https://github.com/prestodb/presto/commit/affb72dcb462d6d111480ec5797a7d068a8473dc", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-10T18:09:28Z", "type": "forcePushed"}, {"oid": "6998b6c9581ff8402fb2f6de9af3a61ecc8e116d", "url": "https://github.com/prestodb/presto/commit/6998b6c9581ff8402fb2f6de9af3a61ecc8e116d", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-10T22:02:27Z", "type": "forcePushed"}, {"oid": "6c369c963de09b32888fe85df4791c054388b452", "url": "https://github.com/prestodb/presto/commit/6c369c963de09b32888fe85df4791c054388b452", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-10T22:31:46Z", "type": "forcePushed"}, {"oid": "9b63e79603548a8817ed4a173df5b6adb3f2fdfc", "url": "https://github.com/prestodb/presto/commit/9b63e79603548a8817ed4a173df5b6adb3f2fdfc", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-10T22:43:10Z", "type": "forcePushed"}, {"oid": "343b63fa2c90d04e648a068ec6f85526f2f632af", "url": "https://github.com/prestodb/presto/commit/343b63fa2c90d04e648a068ec6f85526f2f632af", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-11T01:57:56Z", "type": "forcePushed"}, {"oid": "9045e288034c8b2e66c97a4abdce50ff68d9ba7e", "url": "https://github.com/prestodb/presto/commit/9045e288034c8b2e66c97a4abdce50ff68d9ba7e", "message": "Clean up OrcReader memebers after close", "committedDate": "2020-04-12T01:05:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5Nzc5OA==", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407497798", "bodyText": "This change doesn't seem right and is not part of nulling member variables in close.", "author": "mbasmanova", "createdAt": "2020-04-13T14:11:11Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/LongDictionarySelectiveStreamReader.java", "diffHunk": "@@ -278,13 +278,14 @@ private void openRowGroup()\n         if (!dictionaryOpen && dictionarySize > 0) {\n             if (dictionary.length < dictionarySize) {\n                 dictionary = new long[dictionarySize];\n+                systemMemoryContext.setBytes(sizeOf(dictionary));", "originalCommit": "f064faa000a6c4cbfd8c04c149542dbc32ea8eb4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5ODAyOA==", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407498028", "bodyText": "What's the reason for this change? Perhaps, move it into a separate commit and explain it in commit messase.", "author": "mbasmanova", "createdAt": "2020-04-13T14:11:45Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/LongDictionarySelectiveStreamReader.java", "diffHunk": "@@ -278,13 +278,14 @@ private void openRowGroup()\n         if (!dictionaryOpen && dictionarySize > 0) {\n             if (dictionary.length < dictionarySize) {\n                 dictionary = new long[dictionarySize];\n+                systemMemoryContext.setBytes(sizeOf(dictionary));\n             }\n \n             LongInputStream dictionaryStream = dictionaryDataStreamSource.openStream();\n             if (dictionaryStream == null) {\n                 throw new OrcCorruptionException(streamDescriptor.getOrcDataSourceId(), \"Dictionary is not empty but data stream is not present\");\n             }\n-            dictionaryStream.nextLongVector(dictionarySize, dictionary);\n+            dictionaryStream.next(dictionary, dictionarySize);", "originalCommit": "f064faa000a6c4cbfd8c04c149542dbc32ea8eb4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTM1NA==", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407499354", "bodyText": "This change is problematic. The lease doesn't own the block and the same block can be used to create multiple leases.", "author": "mbasmanova", "createdAt": "2020-04-13T14:14:32Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/block/ClosingBlockLease.java", "diffHunk": "@@ -65,6 +65,7 @@ public void close()\n             return;\n         }\n         closed = true;\n+        block = null;", "originalCommit": "9045e288034c8b2e66c97a4abdce50ff68d9ba7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0OTUxNQ==", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407549515", "bodyText": "All the usage seems to create a new block everytime before getting the lease", "author": "bhhari", "createdAt": "2020-04-13T15:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NjcxNA==", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407586714", "bodyText": "@bhhari Actually, I got confused. This is fine as lease can not be used after \"close()\".", "author": "mbasmanova", "createdAt": "2020-04-13T16:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTM1NA=="}], "type": "inlineReview"}, {"oid": "61b27141edc3786794df0e21f360e10116abe713", "url": "https://github.com/prestodb/presto/commit/61b27141edc3786794df0e21f360e10116abe713", "message": "Speed up GC of OrcReader by clearing member variables in close()", "committedDate": "2020-04-13T16:13:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMzg2OQ==", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407603869", "bodyText": "@bhhari do you need to add keyReader = null;? same for valueReader", "author": "mbasmanova", "createdAt": "2020-04-13T17:28:43Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/MapDirectSelectiveStreamReader.java", "diffHunk": "@@ -658,6 +658,26 @@ public String toString()\n     @Override\n     public void close()\n     {\n+        if (keyReader != null) {\n+            keyReader.close();", "originalCommit": "ad8d61cf3a46ec612592aedb94daa3dc4b9891c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwNzg0Mw==", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407607843", "bodyText": "@mbasmanova  as of now this is not required, I have tested the current code and It does get better GC.\nI will have separate PR to assign the readers to null once close is called. Unfortunately as present there are some tests which are calling to into getRetainedSize() after close.", "author": "bhhari", "createdAt": "2020-04-13T17:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMzg2OQ=="}], "type": "inlineReview"}, {"oid": "c436df31779429c102f925a53885b91d1ba4db9e", "url": "https://github.com/prestodb/presto/commit/c436df31779429c102f925a53885b91d1ba4db9e", "message": "Speed up GC of SliceSelectiveReader by clearing member variables in close()", "committedDate": "2020-04-13T17:59:16Z", "type": "commit"}, {"oid": "3494e72e4b67f0cdc554784148762ccb4400653c", "url": "https://github.com/prestodb/presto/commit/3494e72e4b67f0cdc554784148762ccb4400653c", "message": "Speed up GC of LongSelectiveReaders by clearing member variables in close()", "committedDate": "2020-04-13T17:59:17Z", "type": "commit"}, {"oid": "f55f09a53a368b36fcb90a59346ae3cb5dbccbb1", "url": "https://github.com/prestodb/presto/commit/f55f09a53a368b36fcb90a59346ae3cb5dbccbb1", "message": "Speed up GC of MapSelectiveReader by clearing member variables in close()", "committedDate": "2020-04-13T17:59:17Z", "type": "commit"}, {"oid": "468ece8e238238d1f028767152f293e5fdc135b4", "url": "https://github.com/prestodb/presto/commit/468ece8e238238d1f028767152f293e5fdc135b4", "message": "Speed up GC of OrcReader by clearing member variables in close()", "committedDate": "2020-04-13T17:59:17Z", "type": "commit"}, {"oid": "cdd0212f748ce044f38e0a751e5642cf3286de43", "url": "https://github.com/prestodb/presto/commit/cdd0212f748ce044f38e0a751e5642cf3286de43", "message": "Speed up GC of ByteSelectiveReader by clearing member variables in close()", "committedDate": "2020-04-13T18:22:34Z", "type": "commit"}, {"oid": "1b64f17102b16f27c1556b685831074267554daf", "url": "https://github.com/prestodb/presto/commit/1b64f17102b16f27c1556b685831074267554daf", "message": "Speed up GC of BooleanSelectiveReader by clearing member variables in close()", "committedDate": "2020-04-13T19:40:22Z", "type": "commit"}, {"oid": "fce5871a5267ec8bc71e595cf3e49f6314f624ac", "url": "https://github.com/prestodb/presto/commit/fce5871a5267ec8bc71e595cf3e49f6314f624ac", "message": "Speed up GC of FloatSelectiveReader by clearing member variables in close()", "committedDate": "2020-04-13T19:42:04Z", "type": "commit"}, {"oid": "f1bf9afc72883dfdfaaf00e092dc83f677bfe695", "url": "https://github.com/prestodb/presto/commit/f1bf9afc72883dfdfaaf00e092dc83f677bfe695", "message": "Speed up GC of DoubleSelectiveReader by clearing member variables in close()", "committedDate": "2020-04-13T19:43:59Z", "type": "commit"}, {"oid": "653c08a1d3fd2c561305b91cb75dd5d0aa944813", "url": "https://github.com/prestodb/presto/commit/653c08a1d3fd2c561305b91cb75dd5d0aa944813", "message": "Speed up GC of TimestampSelectiveReader by clearing member variables in close()", "committedDate": "2020-04-13T23:28:15Z", "type": "commit"}, {"oid": "d3afb1de5f0f1a62ac6c75dc01937eaf7e6585df", "url": "https://github.com/prestodb/presto/commit/d3afb1de5f0f1a62ac6c75dc01937eaf7e6585df", "message": "Speed up GC of ListStreamReader by clearing member variables in close()", "committedDate": "2020-04-13T23:32:49Z", "type": "commit"}, {"oid": "f5a9d33dedb562f9030d4e473608dba98c1a8e3b", "url": "https://github.com/prestodb/presto/commit/f5a9d33dedb562f9030d4e473608dba98c1a8e3b", "message": "Speed up GC of StructStreamReader by clearing member variables in close()", "committedDate": "2020-04-13T23:49:34Z", "type": "commit"}, {"oid": "fd7760f13f94a9f0170014e1386b2e020fd07297", "url": "https://github.com/prestodb/presto/commit/fd7760f13f94a9f0170014e1386b2e020fd07297", "message": "Speed up GC of DecimalStreamReader by clearing member variables in close()", "committedDate": "2020-04-13T23:52:32Z", "type": "commit"}, {"oid": "fd7760f13f94a9f0170014e1386b2e020fd07297", "url": "https://github.com/prestodb/presto/commit/fd7760f13f94a9f0170014e1386b2e020fd07297", "message": "Speed up GC of DecimalStreamReader by clearing member variables in close()", "committedDate": "2020-04-13T23:52:32Z", "type": "forcePushed"}]}