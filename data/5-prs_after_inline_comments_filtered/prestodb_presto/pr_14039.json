{"pr_number": 14039, "pr_title": "Account for page header in ORC output buffer", "pr_createdAt": "2020-02-01T00:50:04Z", "pr_url": "https://github.com/prestodb/presto/pull/14039", "timeline": [{"oid": "4996ade82fb1112d9bc9140ba09330d1daf6a164", "url": "https://github.com/prestodb/presto/commit/4996ade82fb1112d9bc9140ba09330d1daf6a164", "message": "Account for page header in ORC output buffer", "committedDate": "2020-02-03T19:54:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3MjY1NA==", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374372654", "bodyText": "The assert should be always on the length <= maxBufferSize. Checking on compressed size is incorrect as compressed size will always be less than length. maxBufferSize already accounts for PAGE_HEADER_SIZE and using that in addition to length will result in incorrect assertions.", "author": "arunthirupathi", "createdAt": "2020-02-03T22:16:22Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -444,13 +450,15 @@ private void writeChunkToOutputStream(byte[] chunk, int offset, int length)\n \n         int compressedSize = compressor.compress(chunk, offset, length, compressionBuffer, 0, compressionBuffer.length);\n         if (compressedSize < length) {\n+            assert PAGE_HEADER_SIZE + compressedSize <= maxBufferSize;", "originalCommit": "4996ade82fb1112d9bc9140ba09330d1daf6a164", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwOTM1MA==", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374409350", "bodyText": "Good catch. This is from the previous approach that I initially drafted.", "author": "islamismailov", "createdAt": "2020-02-03T23:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3MjY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3OTA4OA==", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374379088", "bodyText": "In my opinion this assert should be minWritableBytes <= maxBufferSize . sliceLength <= maxBufferSize will be verified in writeChunkToOutputStream.", "author": "arunthirupathi", "createdAt": "2020-02-03T22:31:26Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -386,12 +388,14 @@ public String toString()\n \n     private void ensureWritableBytes(int minWritableBytes)\n     {\n+        assert slice.length() <= maxBufferSize;", "originalCommit": "4996ade82fb1112d9bc9140ba09330d1daf6a164", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4MDM4OA==", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374380388", "bodyText": "as defensive coding, this should be still >= and let the assert inside writeChunkToOutputStream fire.", "author": "arunthirupathi", "createdAt": "2020-02-03T22:34:28Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -386,12 +388,14 @@ public String toString()\n \n     private void ensureWritableBytes(int minWritableBytes)\n     {\n+        assert slice.length() <= maxBufferSize;\n+\n         int neededBufferSize = bufferPosition + minWritableBytes;\n         if (neededBufferSize <= slice.length()) {\n             return;\n         }\n \n-        if (slice.length() >= maxBufferSize) {\n+        if (slice.length() == maxBufferSize) {", "originalCommit": "4996ade82fb1112d9bc9140ba09330d1daf6a164", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwODMyNA==", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374408324", "bodyText": "This statement works with the assert above (slice.length() <= maxBufferSize), which makes sure that maxBufferSize > slice.length() is never the case, and we handle the only two other cases.\nBut I think your suggestions also make sense.", "author": "islamismailov", "createdAt": "2020-02-03T23:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4MDM4OA=="}], "type": "inlineReview"}, {"oid": "0ee80c8185b161334f9ddce94426b8ae74e37ed4", "url": "https://github.com/prestodb/presto/commit/0ee80c8185b161334f9ddce94426b8ae74e37ed4", "message": "Account for page header in ORC output buffer", "committedDate": "2020-02-04T00:15:37Z", "type": "forcePushed"}, {"oid": "e97acad84158d26aea68dedb1ec84a3d3a7e0d2c", "url": "https://github.com/prestodb/presto/commit/e97acad84158d26aea68dedb1ec84a3d3a7e0d2c", "message": "Account for page header in ORC output buffer", "committedDate": "2020-02-04T00:23:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNjU1OQ==", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374416559", "bodyText": "We don't use assert in the codebase. Replace it with checkState(...) or verify(...) for state check or assertion. We also use  checkArgument to check arguments.", "author": "highker", "createdAt": "2020-02-04T00:25:14Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -386,12 +387,14 @@ public String toString()\n \n     private void ensureWritableBytes(int minWritableBytes)\n     {\n+        assert minWritableBytes <= maxBufferSize;", "originalCommit": "e97acad84158d26aea68dedb1ec84a3d3a7e0d2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNzEwMg==", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374417102", "bodyText": "Is this number 3 coming from the 3-bit header from ORC spec? If yes, could you add a comment?", "author": "highker", "createdAt": "2020-02-04T00:27:17Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -49,6 +49,7 @@\n         extends SliceOutput\n {\n     private static final int INSTANCE_SIZE = ClassLayout.parseClass(OrcOutputBuffer.class).instanceSize();\n+    private static final int PAGE_HEADER_SIZE = 3;", "originalCommit": "e97acad84158d26aea68dedb1ec84a3d3a7e0d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg4OTY5OA==", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374889698", "bodyText": "Yes, these are the 3 bytes that are used for the header.\nhttps://github.com/apache/orc/blob/028261ad6e26d8ae9f9483c8aeb76a85c7f1168b/c%2B%2B/src/Compression.cc#L186", "author": "islamismailov", "createdAt": "2020-02-04T19:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNzEwMg=="}], "type": "inlineReview"}, {"oid": "c928c7cafd9ff461fd6f0b41546228efb20c321c", "url": "https://github.com/prestodb/presto/commit/c928c7cafd9ff461fd6f0b41546228efb20c321c", "message": "Account for page header in ORC output buffer", "committedDate": "2020-02-04T01:23:50Z", "type": "forcePushed"}, {"oid": "e73771d971e98f699a7ae0a3d78260b2ed90a974", "url": "https://github.com/prestodb/presto/commit/e73771d971e98f699a7ae0a3d78260b2ed90a974", "message": "Account for page header in ORC output buffer", "committedDate": "2020-02-04T20:02:54Z", "type": "commit"}, {"oid": "e73771d971e98f699a7ae0a3d78260b2ed90a974", "url": "https://github.com/prestodb/presto/commit/e73771d971e98f699a7ae0a3d78260b2ed90a974", "message": "Account for page header in ORC output buffer", "committedDate": "2020-02-04T20:02:54Z", "type": "forcePushed"}]}