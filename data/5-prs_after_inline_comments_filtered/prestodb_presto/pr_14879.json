{"pr_number": 14879, "pr_title": "Fix infinite loop in non-legacy SqlQueryScheduler", "pr_createdAt": "2020-07-23T19:13:22Z", "pr_url": "https://github.com/prestodb/presto/pull/14879", "timeline": [{"oid": "6ae10524e2253665d09d307e9022bddf1804cf27", "url": "https://github.com/prestodb/presto/commit/6ae10524e2253665d09d307e9022bddf1804cf27", "message": "Remove extra new line", "committedDate": "2020-07-23T18:40:40Z", "type": "commit"}, {"oid": "2004eda98d4186cdf40b7405a1f26b4f08aa9f39", "url": "https://github.com/prestodb/presto/commit/2004eda98d4186cdf40b7405a1f26b4f08aa9f39", "message": "Fix infinite loop in scheduler for finished query\n\nQueries that don't have table scan inputs could enter an infinite loop in\nthe scheduler if they hit the queryStateMachine.isDone() check and had any\nsections ready for execution. If the query is done (e.g. canceled or\nabandoned at this point), we abort the section.  Since \"aborted\" is\na failed state, the section would continue to be considered \"ready for\nexecution\"  in our next time through, and the loop would continue indefitely.\nWe need to explicitly exit the scheduling loop if the query is finished.\n\nQueries with inputs didn't have this issue because the split scheduler\nwould be closed when the query finished, so the scheduler would hit an\nerror when it tried to create the scheduler for the scan stages.", "committedDate": "2020-07-23T18:58:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5ODc5OA==", "url": "https://github.com/prestodb/presto/pull/14879#discussion_r459798798", "bodyText": "I assume if we clean up executionSchedules list here, we should also be able to break the loop via the condition form 276-278? :)", "author": "wenleix", "createdAt": "2020-07-24T00:27:36Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/SqlQueryScheduler.java", "diffHunk": "@@ -284,6 +283,7 @@ private void schedule()\n                         .collect(toImmutableList()));\n                 if (queryStateMachine.isDone()) {\n                     sectionExecutions.forEach(SectionExecution::abort);\n+                    break;", "originalCommit": "2004eda98d4186cdf40b7405a1f26b4f08aa9f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4MDc0Ng==", "url": "https://github.com/prestodb/presto/pull/14879#discussion_r460080746", "bodyText": "no the problem is that next time through the loop we'll consider this section \"ready for execution\" again because the most recent attempt is in a failed state and this might be a retry.", "author": "rschlussel", "createdAt": "2020-07-24T14:16:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5ODc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMjc3Mw==", "url": "https://github.com/prestodb/presto/pull/14879#discussion_r460302773", "bodyText": "i see", "author": "wenleix", "createdAt": "2020-07-24T21:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5ODc5OA=="}], "type": "inlineReview"}]}