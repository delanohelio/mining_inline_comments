{"pr_number": 14981, "pr_title": "Minor page optimizations", "pr_createdAt": "2020-08-06T15:28:09Z", "pr_url": "https://github.com/prestodb/presto/pull/14981", "timeline": [{"oid": "8b2c8a57b575abab73d8b5cce73500c3148edd1d", "url": "https://github.com/prestodb/presto/commit/8b2c8a57b575abab73d8b5cce73500c3148edd1d", "message": "Add copyPositions and extractChannels utility methods to Page", "committedDate": "2020-08-06T15:00:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU1OTIxMQ==", "url": "https://github.com/prestodb/presto/pull/14981#discussion_r467559211", "bodyText": "Should we validate the channel ranges?", "author": "yingsu00", "createdAt": "2020-08-09T09:21:16Z", "path": "presto-common/src/main/java/com/facebook/presto/common/Page.java", "diffHunk": "@@ -318,6 +318,28 @@ public Page getPositions(int[] retainedPositions, int offset, int length)\n         return wrapBlocksWithoutCopy(length, blocks);\n     }\n \n+    public Page copyPositions(int[] retainedPositions, int offset, int length)\n+    {\n+        requireNonNull(retainedPositions, \"retainedPositions is null\");\n+\n+        Block[] blocks = new Block[this.blocks.length];\n+        for (int i = 0; i < blocks.length; i++) {\n+            blocks[i] = this.blocks[i].copyPositions(retainedPositions, offset, length);\n+        }\n+        return wrapBlocksWithoutCopy(length, blocks);\n+    }\n+\n+    public Page extractChannels(int[] channels)\n+    {\n+        requireNonNull(channels, \"channels is null\");\n+", "originalCommit": "8b2c8a57b575abab73d8b5cce73500c3148edd1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYxNDgxNA==", "url": "https://github.com/prestodb/presto/pull/14981#discussion_r467614814", "bodyText": "I thought about that, but decided against it because none of the usage sites that were previously doing this kind of operation before we\u2019re checking the ranges (with one exception that checked that all indexes were positive in its constructor, and still does).\nMy worry would be about adding more overhead in checking per call rather than once during construction that the JIT may or may not be able to leverage to elide range checks during access anyway, so I left it out.", "author": "pettyjamesm", "createdAt": "2020-08-09T18:36:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU1OTIxMQ=="}], "type": "inlineReview"}, {"oid": "5092b0514b7de5aa56b1b1b53b1f9604081eb0c5", "url": "https://github.com/prestodb/presto/commit/5092b0514b7de5aa56b1b1b53b1f9604081eb0c5", "message": "Prefer builtin Page methods that avoid Block[] copies\n\nUpdates various operators and utilities that explicitly create and\nmanipulate Block arrays to use equivalent Page methods where\napplicable and avoid defensively copying the Block array argument", "committedDate": "2020-08-10T15:40:21Z", "type": "commit"}, {"oid": "5092b0514b7de5aa56b1b1b53b1f9604081eb0c5", "url": "https://github.com/prestodb/presto/commit/5092b0514b7de5aa56b1b1b53b1f9604081eb0c5", "message": "Prefer builtin Page methods that avoid Block[] copies\n\nUpdates various operators and utilities that explicitly create and\nmanipulate Block arrays to use equivalent Page methods where\napplicable and avoid defensively copying the Block array argument", "committedDate": "2020-08-10T15:40:21Z", "type": "forcePushed"}]}