{"pr_number": 14160, "pr_title": "Use HiveFileContext for OrcFileTailSource", "pr_createdAt": "2020-02-25T23:25:35Z", "pr_url": "https://github.com/prestodb/presto/pull/14160", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE5MTMxOA==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384191318", "bodyText": "Don't use this. Use HiveFileContext. This patch does not require SPI change", "author": "highker", "createdAt": "2020-02-25T23:32:34Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveCacheContext.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.connector.CacheContext;\n+\n+public class HiveCacheContext", "originalCommit": "99d3e87b979c8f80cd079e7b8f85efc8926ee75a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "532c8e957dfbfdfe2ac09f54a509c1952a6d5d48", "url": "https://github.com/prestodb/presto/commit/532c8e957dfbfdfe2ac09f54a509c1952a6d5d48", "message": "Pass CacheContext to OrcFileTailSource", "committedDate": "2020-02-25T23:37:35Z", "type": "forcePushed"}, {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "url": "https://github.com/prestodb/presto/commit/b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "message": "Use HiveFileContext for OrcFileTailSource", "committedDate": "2020-02-26T01:07:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNTQzNg==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384225436", "bodyText": "Keep as is. Check my comment below.", "author": "highker", "createdAt": "2020-02-26T01:17:32Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/OrcFileWriter.java", "diffHunk": "@@ -158,7 +158,7 @@ public void commit()\n             try {\n                 try (OrcDataSource input = validationInputFactory.get().get()) {\n                     long startThreadCpuTime = THREAD_MX_BEAN.getCurrentThreadCpuTime();\n-                    orcWriter.validate(input);\n+                    orcWriter.validate(input, new HiveFileContext(false, Optional.empty()));", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNTc3Mg==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384225772", "bodyText": "Do not change the interface given this is not critical path.", "author": "highker", "createdAt": "2020-02-26T01:18:39Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -511,7 +512,7 @@ private void recordValidation(Consumer<OrcWriteValidationBuilder> task)\n         }\n     }\n \n-    public void validate(OrcDataSource input)\n+    public void validate(OrcDataSource input, HiveFileContext hiveFileContext)", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNTc5OA==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384225798", "bodyText": "Use DEFAULT_HIVE_FILE_CONTEXT", "author": "highker", "createdAt": "2020-02-26T01:18:44Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -522,7 +523,8 @@ public void validate(OrcDataSource input)\n                 types,\n                 hiveStorageTimeZone,\n                 orcEncoding,\n-                new OrcReaderOptions(new DataSize(1, MEGABYTE), new DataSize(8, MEGABYTE), new DataSize(16, MEGABYTE), false));\n+                new OrcReaderOptions(new DataSize(1, MEGABYTE), new DataSize(8, MEGABYTE), new DataSize(16, MEGABYTE), false),\n+                hiveFileContext);", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNjE3OA==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384226178", "bodyText": "You need to test against hiveFileContext to see if you need to get data from cache or not. Check CachingFileOpener as an example", "author": "highker", "createdAt": "2020-02-26T01:20:10Z", "path": "presto-orc/src/main/java/com/facebook/presto/orc/cache/CachingOrcFileTailSource.java", "diffHunk": "@@ -41,11 +42,11 @@ public CachingOrcFileTailSource(OrcFileTailSource delegate, Cache<OrcDataSourceI\n     }\n \n     @Override\n-    public OrcFileTail getOrcFileTail(OrcDataSource orcDataSource, MetadataReader metadataReader, Optional<OrcWriteValidation> writeValidation)\n+    public OrcFileTail getOrcFileTail(OrcDataSource orcDataSource, MetadataReader metadataReader, Optional<OrcWriteValidation> writeValidation, HiveFileContext hiveFileContext)\n             throws IOException\n     {\n         try {\n-            return cache.get(orcDataSource.getId(), () -> delegate.getOrcFileTail(orcDataSource, metadataReader, writeValidation));\n+            return cache.get(orcDataSource.getId(), () -> delegate.getOrcFileTail(orcDataSource, metadataReader, writeValidation, hiveFileContext));", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNjMwNw==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384226307", "bodyText": "DEFAULT_HIVE_FILE_CONTEXT", "author": "highker", "createdAt": "2020-02-26T01:20:38Z", "path": "presto-orc/src/test/java/com/facebook/presto/orc/BenchmarkBatchStreamReaders.java", "diffHunk": "@@ -207,7 +209,8 @@ private OrcBatchRecordReader createRecordReader()\n                     ORC,\n                     new StorageOrcFileTailSource(),\n                     new StorageStripeMetadataSource(),\n-                    OrcReaderTestingUtils.createDefaultTestConfig());\n+                    OrcReaderTestingUtils.createDefaultTestConfig(),\n+                    new HiveFileContext(false, Optional.empty()));", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNjM0MA==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384226340", "bodyText": "same and all other places", "author": "highker", "createdAt": "2020-02-26T01:20:47Z", "path": "presto-orc/src/test/java/com/facebook/presto/orc/BenchmarkBatchStreamReadersWithZstd.java", "diffHunk": "@@ -219,7 +221,8 @@ private OrcBatchRecordReader createRecordReader(boolean zstdJniDecompressionEnab\n                     format.getOrcEncoding(),\n                     new StorageOrcFileTailSource(),\n                     new StorageStripeMetadataSource(),\n-                    OrcReaderTestingUtils.createTestingReaderOptions(zstdJniDecompressionEnabled));\n+                    OrcReaderTestingUtils.createTestingReaderOptions(zstdJniDecompressionEnabled),\n+                    new HiveFileContext(false, Optional.empty()));", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNzY5MQ==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384227691", "bodyText": "For Raptor we need to decide if to cache or not as well. Whether to cache or not should be determined by RaptorPageSourceProvider::createPageSource (where SplitContext will be passed in). Depends on which patch lands first. But having it default to false here is not right.", "author": "highker", "createdAt": "2020-02-26T01:25:28Z", "path": "presto-raptor/src/main/java/com/facebook/presto/raptor/storage/OrcStorageManager.java", "diffHunk": "@@ -290,7 +291,8 @@ public ConnectorPageSource getPageSource(\n                     ORC,\n                     orcFileTailSource,\n                     stripeMetadataSource,\n-                    new OrcReaderOptions(readerAttributes.getMaxMergeDistance(), readerAttributes.getTinyStripeThreshold(), HUGE_MAX_READ_BLOCK_SIZE, readerAttributes.isZstdJniDecompressionEnabled()));\n+                    new OrcReaderOptions(readerAttributes.getMaxMergeDistance(), readerAttributes.getTinyStripeThreshold(), HUGE_MAX_READ_BLOCK_SIZE, readerAttributes.isZstdJniDecompressionEnabled()),\n+                    new HiveFileContext(false, Optional.empty()));", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNzcwNw==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384227707", "bodyText": "same", "author": "highker", "createdAt": "2020-02-26T01:25:32Z", "path": "presto-raptor/src/main/java/com/facebook/presto/raptor/storage/OrcStorageManager.java", "diffHunk": "@@ -376,7 +378,8 @@ public ConnectorPageSource getPageSource(\n                             defaultReaderAttributes.getMaxMergeDistance(),\n                             defaultReaderAttributes.getTinyStripeThreshold(),\n                             HUGE_MAX_READ_BLOCK_SIZE,\n-                            defaultReaderAttributes.isZstdJniDecompressionEnabled()));\n+                            defaultReaderAttributes.isZstdJniDecompressionEnabled()),\n+                    new HiveFileContext(false, Optional.empty()));", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNzgzMA==", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384227830", "bodyText": "DEFAULT_HIVE_FILE_CONTEXT", "author": "highker", "createdAt": "2020-02-26T01:25:57Z", "path": "presto-raptor/src/main/java/com/facebook/presto/raptor/storage/OrcStorageManager.java", "diffHunk": "@@ -537,7 +540,8 @@ ShardInfo createShardInfo(FileSystem fileSystem, UUID shardUuid, OptionalInt buc\n                     ORC,\n                     orcFileTailSource,\n                     stripeMetadataSource,\n-                    new OrcReaderOptions(defaultReaderAttributes.getMaxMergeDistance(), defaultReaderAttributes.getTinyStripeThreshold(), HUGE_MAX_READ_BLOCK_SIZE, defaultReaderAttributes.isZstdJniDecompressionEnabled()));\n+                    new OrcReaderOptions(defaultReaderAttributes.getMaxMergeDistance(), defaultReaderAttributes.getTinyStripeThreshold(), HUGE_MAX_READ_BLOCK_SIZE, defaultReaderAttributes.isZstdJniDecompressionEnabled()),\n+                    new HiveFileContext(false, Optional.empty()));", "originalCommit": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f40d90bcfef1c7c3d30f159fd535137f1c1a782b", "url": "https://github.com/prestodb/presto/commit/f40d90bcfef1c7c3d30f159fd535137f1c1a782b", "message": "Use HiveFileContext for OrcFileTailSource", "committedDate": "2020-02-26T03:16:18Z", "type": "forcePushed"}, {"oid": "aabe9ea65084db988cf78b7920e41b3a32054d3e", "url": "https://github.com/prestodb/presto/commit/aabe9ea65084db988cf78b7920e41b3a32054d3e", "message": "Use HiveFileContext for OrcFileTailSource", "committedDate": "2020-02-26T04:31:32Z", "type": "forcePushed"}, {"oid": "d0cd5554223dabe5728c4f99403ee46e3ebb8584", "url": "https://github.com/prestodb/presto/commit/d0cd5554223dabe5728c4f99403ee46e3ebb8584", "message": "Use HiveFileContext for OrcFileTailSource", "committedDate": "2020-02-26T06:56:32Z", "type": "commit"}, {"oid": "d0cd5554223dabe5728c4f99403ee46e3ebb8584", "url": "https://github.com/prestodb/presto/commit/d0cd5554223dabe5728c4f99403ee46e3ebb8584", "message": "Use HiveFileContext for OrcFileTailSource", "committedDate": "2020-02-26T06:56:32Z", "type": "forcePushed"}]}