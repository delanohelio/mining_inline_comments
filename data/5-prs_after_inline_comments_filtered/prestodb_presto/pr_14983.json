{"pr_number": 14983, "pr_title": "Add warning message for UNION queries without ALL/DISTINCT keyword", "pr_createdAt": "2020-08-06T18:55:30Z", "pr_url": "https://github.com/prestodb/presto/pull/14983", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxODEwOQ==", "url": "https://github.com/prestodb/presto/pull/14983#discussion_r466718109", "bodyText": "@kaikalur Should this be a parser warning or a performance warning? I'm debating on this...", "author": "rongrong", "createdAt": "2020-08-06T22:24:52Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1254,10 +1255,24 @@ private boolean isExpensiveUnionDistinct(SetOperation setOperation, Type[] outpu\n                                             type instanceof RowType);\n         }\n \n+        @Override\n+        protected Scope visitUnion(Union node, Optional<Scope> scope)\n+        {\n+            if (!node.isDistinct().isPresent()) {\n+                warningCollector.add(new PrestoWarning(PARSER_WARNING,", "originalCommit": "346013c718540c4f0fb4c7d0df00076499bbec0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyMDQ4Ng==", "url": "https://github.com/prestodb/presto/pull/14983#discussion_r466720486", "bodyText": "Should be a performance warning given by the parser :)", "author": "kaikalur", "createdAt": "2020-08-06T22:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxODEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI5NDU0OQ==", "url": "https://github.com/prestodb/presto/pull/14983#discussion_r467294549", "bodyText": "Changed to performance warning", "author": "prithvip", "createdAt": "2020-08-07T21:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxODEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyMDAyOA==", "url": "https://github.com/prestodb/presto/pull/14983#discussion_r466720028", "bodyText": "Let's not give the option to add DISTINCT here. So encourage them to add ALL. Most people would just do it. And if it's really needed they will figure it out or ask us. So reword it as something like:\n\"UNION without the ALL keyword is a computationally expensive operation and most often unnecessarry. Please add the ALL keyword.\"", "author": "kaikalur", "createdAt": "2020-08-06T22:30:11Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1254,10 +1255,24 @@ private boolean isExpensiveUnionDistinct(SetOperation setOperation, Type[] outpu\n                                             type instanceof RowType);\n         }\n \n+        @Override\n+        protected Scope visitUnion(Union node, Optional<Scope> scope)\n+        {\n+            if (!node.isDistinct().isPresent()) {\n+                warningCollector.add(new PrestoWarning(PARSER_WARNING,\n+                        \"UNION specified without ALL or DISTINCT\" +\n+                        \" keyword is equivalent to UNION DISTINCT, which is computationally expensive. \" +\n+                        \"Consider using UNION ALL when possible, or specifically add keyword DISTINCT to stop \" +", "originalCommit": "346013c718540c4f0fb4c7d0df00076499bbec0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyNTY3NA==", "url": "https://github.com/prestodb/presto/pull/14983#discussion_r466725674", "bodyText": "That's too much. Do you really want the community to open issues here to ask how to make this warning go away?", "author": "rongrong", "createdAt": "2020-08-06T22:47:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyMDAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyOTcxOA==", "url": "https://github.com/prestodb/presto/pull/14983#discussion_r466729718", "bodyText": "Let's change it to \"Consider using UNION ALL when possible, or specifically add the keyword DISTINCT if absolutely necessary\".", "author": "rongrong", "createdAt": "2020-08-06T22:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyMDAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMwMTY1MA==", "url": "https://github.com/prestodb/presto/pull/14983#discussion_r467301650", "bodyText": "Let's change it to \"Consider using UNION ALL when possible, or specifically add the keyword DISTINCT if absolutely necessary\".\n\nDone.", "author": "prithvip", "createdAt": "2020-08-07T21:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyMDAyOA=="}], "type": "inlineReview"}, {"oid": "4eb4a8be775d489a414c2792511391f8906fe721", "url": "https://github.com/prestodb/presto/commit/4eb4a8be775d489a414c2792511391f8906fe721", "message": "Add warning message for UNION queries without ALL/DISTINCT keyword.\n\nCo-authored-by: Sundeep Katepalli", "committedDate": "2020-08-07T21:48:11Z", "type": "forcePushed"}, {"oid": "58a2b926b940274c1172578a0ce3cce0b1223d40", "url": "https://github.com/prestodb/presto/commit/58a2b926b940274c1172578a0ce3cce0b1223d40", "message": "Add warning message for UNION queries without ALL/DISTINCT keyword.\n\nCo-authored-by: Sundeep Katepalli", "committedDate": "2020-08-10T23:42:10Z", "type": "forcePushed"}, {"oid": "7081c6ca5db82f665b1e97723a261b37a1c0b4a4", "url": "https://github.com/prestodb/presto/commit/7081c6ca5db82f665b1e97723a261b37a1c0b4a4", "message": "Add warning message for UNION queries without ALL/DISTINCT keyword.\n\nCo-authored-by: Sundeep Katepalli", "committedDate": "2020-08-11T18:00:29Z", "type": "forcePushed"}, {"oid": "b94045f415d32b8565bcf6670a8dbd89976661e3", "url": "https://github.com/prestodb/presto/commit/b94045f415d32b8565bcf6670a8dbd89976661e3", "message": "Add warning message for UNION queries without ALL/DISTINCT keyword\n\nCo-authored-by: Sundeep Katepalli", "committedDate": "2020-08-13T20:32:32Z", "type": "commit"}, {"oid": "b94045f415d32b8565bcf6670a8dbd89976661e3", "url": "https://github.com/prestodb/presto/commit/b94045f415d32b8565bcf6670a8dbd89976661e3", "message": "Add warning message for UNION queries without ALL/DISTINCT keyword\n\nCo-authored-by: Sundeep Katepalli", "committedDate": "2020-08-13T20:32:32Z", "type": "forcePushed"}]}