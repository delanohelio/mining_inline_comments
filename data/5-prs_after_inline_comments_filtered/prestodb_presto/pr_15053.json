{"pr_number": 15053, "pr_title": "Fix for Pinot queries where order by column is pruned in projection", "pr_createdAt": "2020-08-19T18:24:27Z", "pr_url": "https://github.com/prestodb/presto/pull/15053", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDkzNw==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473310937", "bodyText": "I understand the fix, but I wanted to discuss a counter proposal: What if selections changes from being the list of final projections to simply being a map that maps a variable to its Pinot selection. That is, it contains all of the selections ever encountered.\nAnd we introduce another notion of a Final project list: List.\nThe problem that is happening is that selections is being overwritten and it no longer contains the ordering variables. What if we always union new things into it instead of overwriting it ?\nI am not sure whether this would pan out or perhaps regress something else.\nIf you think my counter proposal is too much work, then just a note on naming: What do you think of foldinging topNColumnSelections and topNColumnOrderings into one ? Perhaps create a class OrderingInformation that contains (SortOrder, Selection) ? I find the name topNColumnSelections ambiguous and I wonder if fusing it with topNColumnOrderingMap would elide that concern.", "author": "agrawaldevesh", "createdAt": "2020-08-19T20:51:12Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -62,6 +62,7 @@\n     private final LinkedHashSet<VariableReferenceExpression> outputs;\n     private final LinkedHashSet<VariableReferenceExpression> groupByColumns;\n     private final LinkedHashMap<VariableReferenceExpression, SortOrder> topNColumnOrderingMap;\n+    private final LinkedHashMap<VariableReferenceExpression, Selection> topNColumnSelections;", "originalCommit": "143c00921744458a3d34ad1ebf5175e67f0f8d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM4ODkzNQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473388935", "bodyText": "Both seem better ideas to me then having two maps.\nSince we have not encountered any other case like this, in favor of less invasion I would prefer going with merging topNColumnSelections and topNColumnOrderings. Making the change", "author": "dharakk", "createdAt": "2020-08-19T22:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMTcyMw==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473311723", "bodyText": "Any idea whether this issue also impacts the Pinot-SQL query generation logic added by @fx19880617 recently ? Perhaps we need to fix it and add a test for this there as well ?", "author": "agrawaldevesh", "createdAt": "2020-08-19T20:52:37Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -366,6 +367,8 @@ public void testSimpleSelectWithTopN()\n                 \"SELECT regionId, city, fare FROM realtimeOnly ORDER BY fare, city DESC LIMIT 50\",\n                 defaultSessionHolder,\n                 ImmutableMap.of());", "originalCommit": "143c00921744458a3d34ad1ebf5175e67f0f8d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM5NzQ2Mw==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473397463", "bodyText": "For order by clause SQL generation also follows the same path via generatePinotQueryHelper so this logic gets added to SQL generation too.\nGood catch on test, I missed the new TestPinotQueryGeneratorSql file. Adding a test there too", "author": "dharakk", "createdAt": "2020-08-19T22:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMTcyMw=="}], "type": "inlineReview"}, {"oid": "23a8495e0818f4629ea88facf77a18e6af9a5be2", "url": "https://github.com/prestodb/presto/commit/23a8495e0818f4629ea88facf77a18e6af9a5be2", "message": "Fix for Pinot queries where order by column is pruned in projection", "committedDate": "2020-08-19T23:04:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQyMTE1NQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473421155", "bodyText": "Can this class be a private instead of public ? Or package local ?", "author": "agrawaldevesh", "createdAt": "2020-08-19T23:13:58Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -617,4 +623,27 @@ public String toString()\n             return definition;\n         }\n     }\n+\n+    // Columns definitions and ordering information for OrderBy Columns\n+    public static class OrderingColumnInformation", "originalCommit": "23a8495e0818f4629ea88facf77a18e6af9a5be2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQyMTM4NQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473421385", "bodyText": "requireNonNull on the input arguments ?", "author": "agrawaldevesh", "createdAt": "2020-08-19T23:14:17Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -617,4 +623,27 @@ public String toString()\n             return definition;\n         }\n     }\n+\n+    // Columns definitions and ordering information for OrderBy Columns\n+    public static class OrderingColumnInformation\n+    {\n+        private final SortOrder sortOrder;\n+        private final Selection selection;\n+\n+        public OrderingColumnInformation(SortOrder sortOrder, Selection selection)\n+        {\n+            this.sortOrder = sortOrder;", "originalCommit": "23a8495e0818f4629ea88facf77a18e6af9a5be2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQzMDU0Ng==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473430546", "bodyText": "How about an ascending order test query here for the Pinot sql case ... Since pinot pql only supports order by desc I believe. (Not sure at all !)", "author": "agrawaldevesh", "createdAt": "2020-08-19T23:27:25Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGeneratorSql.java", "diffHunk": "@@ -182,6 +182,14 @@ public void testSelectionWithOrderBy()\n                 defaultSessionHolder,\n                 ImmutableMap.of());\n \n+        TopNNode topNNode = topN(planBuilder, 50L, ImmutableList.of(\"fare\", \"city\"), ImmutableList.of(false, false), tableScanNode);\n+        testPinotQuery(\n+                pinotConfig,\n+                project(planBuilder, topNNode, ImmutableList.of(\"regionid\", \"city\")),\n+                \"SELECT regionId, city FROM realtimeOnly ORDER BY fare DESC, city DESC LIMIT 50\",", "originalCommit": "23a8495e0818f4629ea88facf77a18e6af9a5be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ0NDU5Nw==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473444597", "bodyText": "I think it supports as I see asc cases above, made sort order for one of the columns ascending", "author": "dharakk", "createdAt": "2020-08-19T23:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQzMDU0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQzMTE3MA==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473431170", "bodyText": "What about Pinot TOP queries (ie aggregation-order-by-limit-desc queries). Do that change too with this PR ?", "author": "agrawaldevesh", "createdAt": "2020-08-19T23:28:20Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -366,6 +367,8 @@ public void testSimpleSelectWithTopN()\n                 \"SELECT regionId, city, fare FROM realtimeOnly ORDER BY fare, city DESC LIMIT 50\",\n                 defaultSessionHolder,\n                 ImmutableMap.of());\n+        ProjectNode projectNode = project(planBuilder, topnFareAndCity, ImmutableList.of(\"regionid\", \"city\"));", "originalCommit": "23a8495e0818f4629ea88facf77a18e6af9a5be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ1MjAyNw==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473452027", "bodyText": "For PQL we don't allow this (ordering on aggregated data) to be pushed down and we do topN operation in Presto so not impacted.\nFor SQL this is allowed and there are test cases which are passing. With aggregation it is not syntactically supported that a order by column doesn't appear in final selections so no need to add that test case.", "author": "dharakk", "createdAt": "2020-08-19T23:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQzMTE3MA=="}], "type": "inlineReview"}, {"oid": "3dd23025aa79c546523f33db727727b68e87e194", "url": "https://github.com/prestodb/presto/commit/3dd23025aa79c546523f33db727727b68e87e194", "message": "Fix for Pinot queries where order by column is pruned in projection", "committedDate": "2020-08-19T23:45:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDAxMw==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473480013", "bodyText": "LinkedHashMap is an implementation, use Map in declaration:\nMap<VariableReferenceExpression, OrderingColumnInformation> orderByColumnInformation = new LinkedHashMap<>();", "author": "zhenxiao", "createdAt": "2020-08-20T00:40:41Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -254,14 +255,18 @@ public PinotQueryGeneratorContext withTopN(LinkedHashMap<VariableReferenceExpres\n             checkSupported(!hasAggregation(), \"Pinot doesn't support ordering on top of the aggregated data\");\n         }\n         int intLimit = checkForValidLimit(limit);\n+\n+        LinkedHashMap<VariableReferenceExpression, OrderingColumnInformation> orderByColumnInformation = new LinkedHashMap<>();", "originalCommit": "3dd23025aa79c546523f33db727727b68e87e194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4NTIwNQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473485205", "bodyText": "I disagree with this :-) I prefer LinkedHashMap as a static type because it conveys the order sensitiveness. It signifies that order is important and that is indeed the approach we have taken with other field variables of this class.", "author": "agrawaldevesh", "createdAt": "2020-08-20T00:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5MTc3MA==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473491770", "bodyText": "could be a separate discussion: just see a number of LinkedHashMap in this class for declaration.\nare we using LinkedHashMap's order sensitiveness anywhere? I think make LinkedHashMap as an implementation is a strong indication that we would like to keep the order sensitiveness. what do you think?", "author": "zhenxiao", "createdAt": "2020-08-20T00:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUyODI4OA==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473528288", "bodyText": "I think it is not a strong guarantee of type safety: The caller can easily pass in a simple Map to the underlying type instead of a LinkedHashMap and that could mess up the order.\nI wish Java had some sort of an interface for iteration sensitive Maps, since it doesn't I am advocating for letting the static type of the field remain LinkedHashMap to avoid stamping into it a non LinkedHashMap that messes up the order.\nYou would agree that such sort of bugs can be hard to track down and that having strong static type safety here would prevent them.", "author": "agrawaldevesh", "createdAt": "2020-08-20T01:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzNDMyNQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473534325", "bodyText": "could you please add more details, or some example code to show why order is important and needs to be kept here? I did not find LinkedHashMap's order sensitiveness is used in this class", "author": "zhenxiao", "createdAt": "2020-08-20T02:04:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU0NTIwMA==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473545200", "bodyText": "I think the orderby columns stored here in orderByColumnInformation itself is a valid example as we would need to sort in the order we are seeing the columns. i.e. for  order by secondsSinceEpoch desc, 1 desc we need to preserve order of secondsSinceEpoch and city to satisfy the comparison requirement in sorting\nString orderByExpressions = topNColumnInformationMap.entrySet().stream().map(entry -> (entry.getValue().getSelection().getDefinition()) + (entry.getValue().getSortOrder().isAscending() ? \"\" : \" DESC\")).collect(Collectors.joining(\", \"));", "author": "dharakk", "createdAt": "2020-08-20T02:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3ODQ2NQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473578465", "bodyText": "get it. Do you think SortedMap and TreeMap could be a candidate to keep the order? We could do it in followup PR.", "author": "zhenxiao", "createdAt": "2020-08-20T04:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDU5NQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473480595", "bodyText": "do we need this blank line?", "author": "zhenxiao", "createdAt": "2020-08-20T00:41:30Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -538,8 +543,9 @@ public PinotQueryGeneratorContext withOutputColumns(List<VariableReferenceExpres\n         LinkedHashSet<VariableReferenceExpression> newOutputs = new LinkedHashSet<>(outputColumns);\n         outputColumns.forEach(o -> requireNonNull(selections.get(o), String.format(\"Cannot find the selection %s in the original context %s\", o, this)));\n         // Hidden columns flow as is from the previous\n+", "originalCommit": "3dd23025aa79c546523f33db727727b68e87e194", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDg2OQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473480869", "bodyText": "use Set for declaration", "author": "zhenxiao", "createdAt": "2020-08-20T00:41:56Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -538,8 +543,9 @@ public PinotQueryGeneratorContext withOutputColumns(List<VariableReferenceExpres\n         LinkedHashSet<VariableReferenceExpression> newOutputs = new LinkedHashSet<>(outputColumns);", "originalCommit": "3dd23025aa79c546523f33db727727b68e87e194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4NTQ3NQ==", "url": "https://github.com/prestodb/presto/pull/15053#discussion_r473485475", "bodyText": "I disagree for the same reason here.", "author": "agrawaldevesh", "createdAt": "2020-08-20T00:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDg2OQ=="}], "type": "inlineReview"}, {"oid": "4906776fb84ac4e72384c5045056a8d8f362367b", "url": "https://github.com/prestodb/presto/commit/4906776fb84ac4e72384c5045056a8d8f362367b", "message": "Fix for Pinot queries where order by column is pruned in projection", "committedDate": "2020-08-20T06:51:01Z", "type": "commit"}, {"oid": "4906776fb84ac4e72384c5045056a8d8f362367b", "url": "https://github.com/prestodb/presto/commit/4906776fb84ac4e72384c5045056a8d8f362367b", "message": "Fix for Pinot queries where order by column is pruned in projection", "committedDate": "2020-08-20T06:51:01Z", "type": "forcePushed"}]}