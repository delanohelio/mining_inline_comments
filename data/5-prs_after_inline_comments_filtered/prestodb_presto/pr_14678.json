{"pr_number": 14678, "pr_title": "Parquet: Handle nested column schema changes when subfield pruning is enabled", "pr_createdAt": "2020-06-19T03:02:50Z", "pr_url": "https://github.com/prestodb/presto/pull/14678", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4OTEwMw==", "url": "https://github.com/prestodb/presto/pull/14678#discussion_r442989103", "bodyText": "could we simplify the logic as:\nif (childType == null) {\n  return new MessageType(rootName, ImmutableList.of());\n}\ntypeBuilder.add(childType);\nparentType = childType;", "author": "zhenxiao", "createdAt": "2020-06-19T18:30:51Z", "path": "presto-parquet/src/main/java/com/facebook/presto/parquet/ParquetTypeUtils.java", "diffHunk": "@@ -282,6 +283,10 @@ public static MessageType getSubfieldType(GroupType baseType, Subfield subfield)\n                     typeBuilder.add(childType);\n                     parentType = childType;\n                 }\n+                else {", "originalCommit": "775a57c4213daf068c081970bbb27d6e1a403d65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "be15fff78e00acaf736fec170908675e358103dd", "url": "https://github.com/prestodb/presto/commit/be15fff78e00acaf736fec170908675e358103dd", "message": "Parquet: Handle nested column schema changes when subfield pruning is enabled\n\nAfter schema is changed (new field at depth > 1) and when trying to read files with old schema\nwe end up with a situation where the type of the newly added field type is derived incorrectly.\nWhen this new field type is merged with type of other subfields within the same column, we get\nthe following error/.\n\nError opening Hive split file:/var/folders/kg/8w0vwj4n26db9qwybcwmpml80000gn/T/PrestoTest3674412409435240427/hive_data/tpch/test_subfield_multilevel_pruning/20200619_021654_00016_hyx9i_753399fd-0201-4017-82bf-43c808e41bba (offset=0, length=624): repetition constraint is more restrictive: can not merge type optional group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n} into repeated group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n}", "committedDate": "2020-06-19T18:37:13Z", "type": "commit"}, {"oid": "be15fff78e00acaf736fec170908675e358103dd", "url": "https://github.com/prestodb/presto/commit/be15fff78e00acaf736fec170908675e358103dd", "message": "Parquet: Handle nested column schema changes when subfield pruning is enabled\n\nAfter schema is changed (new field at depth > 1) and when trying to read files with old schema\nwe end up with a situation where the type of the newly added field type is derived incorrectly.\nWhen this new field type is merged with type of other subfields within the same column, we get\nthe following error/.\n\nError opening Hive split file:/var/folders/kg/8w0vwj4n26db9qwybcwmpml80000gn/T/PrestoTest3674412409435240427/hive_data/tpch/test_subfield_multilevel_pruning/20200619_021654_00016_hyx9i_753399fd-0201-4017-82bf-43c808e41bba (offset=0, length=624): repetition constraint is more restrictive: can not merge type optional group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n} into repeated group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n}", "committedDate": "2020-06-19T18:37:13Z", "type": "forcePushed"}]}