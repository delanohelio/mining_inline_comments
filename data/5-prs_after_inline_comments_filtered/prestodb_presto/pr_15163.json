{"pr_number": 15163, "pr_title": "Fix performance regression when hive SerDe doesn't prefer Writables", "pr_createdAt": "2020-09-11T15:41:49Z", "pr_url": "https://github.com/prestodb/presto/pull/15163", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ2OTY0Mg==", "url": "https://github.com/prestodb/presto/pull/15163#discussion_r488469642", "bodyText": "nit: Reorder this method to after the next two parseXXX methods().", "author": "yingsu00", "createdAt": "2020-09-15T08:07:09Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/GenericHiveRecordCursor.java", "diffHunk": "@@ -368,39 +369,80 @@ private void parseStringColumn(int column)\n             nulls[column] = true;\n         }\n         else {\n-            Object fieldValue = ((PrimitiveObjectInspector) fieldInspectors[column]).getPrimitiveWritableObject(fieldData);\n-            checkState(fieldValue != null, \"fieldValue should not be null\");\n-            BinaryComparable hiveValue;\n-            if (fieldValue instanceof Text) {\n-                hiveValue = (Text) fieldValue;\n-            }\n-            else if (fieldValue instanceof BytesWritable) {\n-                hiveValue = (BytesWritable) fieldValue;\n-            }\n-            else if (fieldValue instanceof HiveVarcharWritable) {\n-                hiveValue = ((HiveVarcharWritable) fieldValue).getTextValue();\n-            }\n-            else if (fieldValue instanceof HiveCharWritable) {\n-                hiveValue = ((HiveCharWritable) fieldValue).getTextValue();\n+            PrimitiveObjectInspector inspector = (PrimitiveObjectInspector) fieldInspectors[column];\n+            Slice value;\n+            if (inspector.preferWritable()) {\n+                value = parseStringFromPrimitiveWritableObjectValue(types[column], inspector.getPrimitiveWritableObject(fieldData));\n             }\n             else {\n-                throw new IllegalStateException(\"unsupported string field type: \" + fieldValue.getClass().getName());\n+                value = parseStringFromPrimitiveJavaObjectValue(types[column], inspector.getPrimitiveJavaObject(fieldData));\n             }\n+            slices[column] = value;\n+            nulls[column] = false;\n+        }\n+    }\n \n-            // create a slice view over the hive value and trim to character limits\n-            Slice value = Slices.wrappedBuffer(hiveValue.getBytes(), 0, hiveValue.getLength());\n-            Type type = types[column];\n-            if (isVarcharType(type)) {\n-                value = truncateToLength(value, type);\n-            }\n-            if (isCharType(type)) {\n-                value = truncateToLengthAndTrimSpaces(value, type);\n-            }\n+    private static Slice trimStringToCharacterLimits(Type type, Slice value)", "originalCommit": "5c79a2a9fdea158801bebcd69a48be92b5d2e86a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0MjU1Mg==", "url": "https://github.com/prestodb/presto/pull/15163#discussion_r488642552", "bodyText": "Done", "author": "pettyjamesm", "createdAt": "2020-09-15T12:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ2OTY0Mg=="}], "type": "inlineReview"}, {"oid": "7042af0d8ba4651580b42eb52b3e0b250bbc0f0b", "url": "https://github.com/prestodb/presto/commit/7042af0d8ba4651580b42eb52b3e0b250bbc0f0b", "message": "Fix performance regression when Hive SerDe doesn't prefer Writables\n\nIntroduced in prestodb#8206, GenericHiveRecordCursor was modified to\navoid extra overhead when the SerDe provided a more efficient String\nhandling implementation with Writables. However, when the SerDe does\nnot provide such an implementation and instead already returned String\ninstances directly, this change introduced an extra conversion from\nbytes to String just to be converted back to bytes.\n\nThis change alters the behavior of GenericHiveRecordCursor parseString\nto respect the PrimitiveObjectInspector's preference for using writables.", "committedDate": "2020-09-15T12:52:38Z", "type": "commit"}, {"oid": "2bad2ed603a94d6392701d847ee6ee2819e88103", "url": "https://github.com/prestodb/presto/commit/2bad2ed603a94d6392701d847ee6ee2819e88103", "message": "Avoid DateTimeZone.getDefault() in GenericHiveRecordCursor hot path", "committedDate": "2020-09-15T12:52:38Z", "type": "commit"}, {"oid": "2bad2ed603a94d6392701d847ee6ee2819e88103", "url": "https://github.com/prestodb/presto/commit/2bad2ed603a94d6392701d847ee6ee2819e88103", "message": "Avoid DateTimeZone.getDefault() in GenericHiveRecordCursor hot path", "committedDate": "2020-09-15T12:52:38Z", "type": "forcePushed"}]}