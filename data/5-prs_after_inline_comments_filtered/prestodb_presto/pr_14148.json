{"pr_number": 14148, "pr_title": "Failure resolver improvements", "pr_createdAt": "2020-02-24T02:11:50Z", "pr_url": "https://github.com/prestodb/presto/pull/14148", "timeline": [{"oid": "f83c622ebc44d0ce23dae253176e38b9822c3b4b", "url": "https://github.com/prestodb/presto/commit/f83c622ebc44d0ce23dae253176e38b9822c3b4b", "message": "Use failure resolver for checksum query compiler error", "committedDate": "2020-02-24T02:13:06Z", "type": "forcePushed"}, {"oid": "46a7614551c77a83f91b8f83658466f7dba02eec", "url": "https://github.com/prestodb/presto/commit/46a7614551c77a83f91b8f83658466f7dba02eec", "message": "Auto resolve checksum query failure due to array comparison", "committedDate": "2020-02-24T02:18:14Z", "type": "forcePushed"}, {"oid": "570732a014c7ced9497cc3cc852b01c8efae3875", "url": "https://github.com/prestodb/presto/commit/570732a014c7ced9497cc3cc852b01c8efae3875", "message": "Auto resolve checksum query failure due to array comparison", "committedDate": "2020-02-24T02:32:12Z", "type": "forcePushed"}, {"oid": "48e8f0a81a693e2fd993e7a506fb53efed6e0dfc", "url": "https://github.com/prestodb/presto/commit/48e8f0a81a693e2fd993e7a506fb53efed6e0dfc", "message": "Use failure resolver for checksum query compiler error", "committedDate": "2020-02-24T02:32:09Z", "type": "forcePushed"}, {"oid": "0ea5ffa508e4441514e465dca40ca15b7533af95", "url": "https://github.com/prestodb/presto/commit/0ea5ffa508e4441514e465dca40ca15b7533af95", "message": "Use failure resolver for checksum query compiler error", "committedDate": "2020-02-24T02:33:24Z", "type": "forcePushed"}, {"oid": "19138ee94aed6c19d27adb8d5e9a99ed632feaa8", "url": "https://github.com/prestodb/presto/commit/19138ee94aed6c19d27adb8d5e9a99ed632feaa8", "message": "Use failure resolver for checksum query compiler error", "committedDate": "2020-02-24T02:40:02Z", "type": "forcePushed"}, {"oid": "9d4de0a54975d5803a08b8e982e8cd4f060f2bce", "url": "https://github.com/prestodb/presto/commit/9d4de0a54975d5803a08b8e982e8cd4f060f2bce", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T02:41:13Z", "type": "forcePushed"}, {"oid": "90cfe679217ad3ba1b7513e7211d84bf5bd522e2", "url": "https://github.com/prestodb/presto/commit/90cfe679217ad3ba1b7513e7211d84bf5bd522e2", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T02:42:28Z", "type": "forcePushed"}, {"oid": "cb621673295ce808d43cb8c4ccd8711790ca33c8", "url": "https://github.com/prestodb/presto/commit/cb621673295ce808d43cb8c4ccd8711790ca33c8", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T05:27:48Z", "type": "forcePushed"}, {"oid": "a8c69277c02211c942a77c895b152e71ec294296", "url": "https://github.com/prestodb/presto/commit/a8c69277c02211c942a77c895b152e71ec294296", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T05:48:23Z", "type": "forcePushed"}, {"oid": "d685f286bc03253425deb600f803209313772092", "url": "https://github.com/prestodb/presto/commit/d685f286bc03253425deb600f803209313772092", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T05:54:11Z", "type": "forcePushed"}, {"oid": "7c940c84f39991e3c16868dace4866980a07df0a", "url": "https://github.com/prestodb/presto/commit/7c940c84f39991e3c16868dace4866980a07df0a", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T05:58:21Z", "type": "forcePushed"}, {"oid": "89abcc4f362d2718c4efa5faa4f9b4409a63a05a", "url": "https://github.com/prestodb/presto/commit/89abcc4f362d2718c4efa5faa4f9b4409a63a05a", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T06:10:22Z", "type": "forcePushed"}, {"oid": "c87459c5a3158a7f432772a580cba4fef6c1ab15", "url": "https://github.com/prestodb/presto/commit/c87459c5a3158a7f432772a580cba4fef6c1ab15", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T06:11:06Z", "type": "forcePushed"}, {"oid": "270d376c0e2d77bb12eea8ad134f1f106f411d73", "url": "https://github.com/prestodb/presto/commit/270d376c0e2d77bb12eea8ad134f1f106f411d73", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T06:13:38Z", "type": "forcePushed"}, {"oid": "60add968e91d177bf8dba7a6befe2b2ffc2850d6", "url": "https://github.com/prestodb/presto/commit/60add968e91d177bf8dba7a6befe2b2ffc2850d6", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T06:19:56Z", "type": "forcePushed"}, {"oid": "33aede6c8974ac6413db74a61dd3a00d682d8dff", "url": "https://github.com/prestodb/presto/commit/33aede6c8974ac6413db74a61dd3a00d682d8dff", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T06:23:07Z", "type": "forcePushed"}, {"oid": "1a9cdb48d26374b8de828625aac718786c5e3408", "url": "https://github.com/prestodb/presto/commit/1a9cdb48d26374b8de828625aac718786c5e3408", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-24T10:46:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyMTMzNQ==", "url": "https://github.com/prestodb/presto/pull/14148#discussion_r383321335", "bodyText": "@caithagoras I find it strange to include these type of methods in the abstract class. This make this abstract class tightly couples with its subclasses. It think it would be clearer to remove these methods and move the logic into the callers or move them into a separate utils class.", "author": "mbasmanova", "createdAt": "2020-02-24T15:10:46Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/QueryException.java", "diffHunk": "@@ -14,111 +14,70 @@\n package com.facebook.presto.verifier.framework;\n \n import com.facebook.presto.jdbc.QueryStats;\n-import com.facebook.presto.spi.ErrorCode;\n-import com.facebook.presto.spi.ErrorCodeSupplier;\n import com.facebook.presto.verifier.event.QueryFailure;\n-import com.google.common.base.Function;\n \n import java.util.Optional;\n \n-import static com.facebook.presto.verifier.framework.QueryException.Type.CLUSTER_CONNECTION;\n-import static com.facebook.presto.verifier.framework.QueryException.Type.PRESTO;\n+import static com.google.common.base.Preconditions.checkState;\n import static com.google.common.base.Throwables.getStackTraceAsString;\n-import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n-public class QueryException\n+public abstract class QueryException\n         extends RuntimeException\n {\n-    public enum Type\n-    {\n-        CLUSTER_CONNECTION(qe -> {\n-            requireNonNull(qe, \"queryException is null\");\n-            requireNonNull(qe.getCause(), \"cause is null\");\n-            return qe.getCause().getClass().getSimpleName();\n-        }),\n-        PRESTO(qe -> {\n-            requireNonNull(qe, \"queryException is null\");\n-            return qe.prestoErrorCode.map(ErrorCodeSupplier::toErrorCode).map(ErrorCode::getName).orElse(\"UNKNOWN\");\n-        });\n-\n-        private final Function<QueryException, String> descriptionGenerator;\n-\n-        Type(Function<QueryException, String> descriptionGenerator)\n-        {\n-            this.descriptionGenerator = requireNonNull(descriptionGenerator, \"descriptionGenerator is null\");\n-        }\n-    }\n-\n-    private final Type type;\n-    private final Optional<ErrorCodeSupplier> prestoErrorCode;\n     private final boolean retryable;\n-    private final Optional<QueryStats> queryStats;\n     private final QueryStage queryStage;\n \n-    private QueryException(\n-            Throwable cause,\n-            Type type,\n-            Optional<ErrorCodeSupplier> prestoErrorCode,\n-            boolean retryable,\n-            Optional<QueryStats> queryStats,\n-            QueryStage queryStage)\n+    public QueryException(Throwable cause, boolean retryable, QueryStage queryStage)\n     {\n         super(cause);\n-        this.type = requireNonNull(type, \"type is null\");\n-        this.prestoErrorCode = requireNonNull(prestoErrorCode, \"errorCode is null\");\n         this.retryable = retryable;\n-        this.queryStats = requireNonNull(queryStats, \"queryStats is null\");\n         this.queryStage = requireNonNull(queryStage, \"queryStage is null\");\n     }\n \n-    public static QueryException forClusterConnection(Throwable cause, QueryStage queryStage)\n+    public abstract String getErrorCodeName();\n+\n+    public boolean isClusterConnectionException()", "originalCommit": "85b916f02bdda0e7d6e7ac5c629fa75623091742", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNjQ5MQ==", "url": "https://github.com/prestodb/presto/pull/14148#discussion_r383326491", "bodyText": "@caithagoras Based on the usage of this method, I think a signature with a callback may work better.\n    public static <T> Optional<T> mapMatchingPrestoException(\n            QueryException queryException,\n            QueryStage queryStage,\n            ErrorCodeSupplier errorCode,\n            Function<PrestoQueryException, T> mapper)\n    {\n        if (queryException.getQueryStage() != queryStage || !queryException.isPrestoQueryException()) {\n            return Optional.empty();\n        }\n\n        return Optional.of(mapper.apply((PrestoQueryException) queryException));\n    }\n\npublic class ExceededGlobalMemoryLimitFailureResolver\n        implements FailureResolver\n{\n    public static final String NAME = \"exceeded-global-memory-limit\";\n\n    @Override\n    public Optional<String> resolve(QueryStats controlQueryStats, QueryException queryException, Optional<QueryBundle> test)\n    {\n        return mapMatchingPrestoException(queryException, TEST_MAIN, EXCEEDED_GLOBAL_MEMORY_LIMIT,\n                e -> \"Control query uses more memory than the test cluster memory limit\");\n    }\n}", "author": "mbasmanova", "createdAt": "2020-02-24T15:19:10Z", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/resolver/FailureResolverUtil.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.verifier.resolver;\n+\n+import com.facebook.presto.spi.ErrorCodeSupplier;\n+import com.facebook.presto.verifier.framework.PrestoQueryException;\n+import com.facebook.presto.verifier.framework.QueryException;\n+import com.facebook.presto.verifier.framework.QueryStage;\n+\n+import java.util.Optional;\n+\n+public class FailureResolverUtil\n+{\n+    private FailureResolverUtil() {}\n+\n+    public static boolean isMatchingPrestoException(QueryException queryException, QueryStage queryStage, ErrorCodeSupplier errorCode)", "originalCommit": "c6097d0049f79185080d2aa51cdc2c4623878b28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1Nzc3OA==", "url": "https://github.com/prestodb/presto/pull/14148#discussion_r385357778", "bodyText": "With isMatchingPrestoException, I meant to do an initial check. With the callback method however, the mapper function needs to contain all the the logic necessary to determine whether to resolve in additional to the initial check. In case of TooManyOpenPartitionsFailureResolve, this is going to be much more complex.", "author": "caithagoras", "createdAt": "2020-02-27T20:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNjQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk1MjEyMA==", "url": "https://github.com/prestodb/presto/pull/14148#discussion_r385952120", "bodyText": "Comments addessed.", "author": "caithagoras", "createdAt": "2020-02-28T22:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNjQ5MQ=="}], "type": "inlineReview"}, {"oid": "23de76d0494a37d3cb7d199d97ae2803f951a763", "url": "https://github.com/prestodb/presto/commit/23de76d0494a37d3cb7d199d97ae2803f951a763", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T01:36:23Z", "type": "forcePushed"}, {"oid": "0822737e30229c7628eee7f95fc0d81e3d31574b", "url": "https://github.com/prestodb/presto/commit/0822737e30229c7628eee7f95fc0d81e3d31574b", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T01:38:36Z", "type": "forcePushed"}, {"oid": "dbdff73ae7b1f8340491d0333b5fb213890781c0", "url": "https://github.com/prestodb/presto/commit/dbdff73ae7b1f8340491d0333b5fb213890781c0", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T06:52:40Z", "type": "forcePushed"}, {"oid": "9d9fce5752f54dcb6e7564fce802507a4397a348", "url": "https://github.com/prestodb/presto/commit/9d9fce5752f54dcb6e7564fce802507a4397a348", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T20:22:48Z", "type": "forcePushed"}, {"oid": "c857978c1672e3e97ae10bdd0dee5c623136e994", "url": "https://github.com/prestodb/presto/commit/c857978c1672e3e97ae10bdd0dee5c623136e994", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T20:32:37Z", "type": "forcePushed"}, {"oid": "ae73c02c8ef4d115b351fbfd0cba6c5d7d66ea4a", "url": "https://github.com/prestodb/presto/commit/ae73c02c8ef4d115b351fbfd0cba6c5d7d66ea4a", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T20:33:48Z", "type": "forcePushed"}, {"oid": "6cc4b06ee619c9799eb75c34f2d76b56dadcb83c", "url": "https://github.com/prestodb/presto/commit/6cc4b06ee619c9799eb75c34f2d76b56dadcb83c", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T20:41:40Z", "type": "forcePushed"}, {"oid": "a09270d9d4524648f8a0a55062673ff7cedfe104", "url": "https://github.com/prestodb/presto/commit/a09270d9d4524648f8a0a55062673ff7cedfe104", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T20:46:07Z", "type": "forcePushed"}, {"oid": "9d950c9ab6fd02ad80030de11a4ecc349d810b38", "url": "https://github.com/prestodb/presto/commit/9d950c9ab6fd02ad80030de11a4ecc349d810b38", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-27T20:50:20Z", "type": "forcePushed"}, {"oid": "7809294e4799cc7419826712e24ce8c1214e1299", "url": "https://github.com/prestodb/presto/commit/7809294e4799cc7419826712e24ce8c1214e1299", "message": "Use HiveFileContext for StripeMetadataSource", "committedDate": "2020-02-28T00:52:10Z", "type": "forcePushed"}, {"oid": "0450d9c099cc182afc1019155dfb29afe3a02be6", "url": "https://github.com/prestodb/presto/commit/0450d9c099cc182afc1019155dfb29afe3a02be6", "message": "Separate QueryException into two classes\n\nCluster connection failure and Presto query failure are two different\ntypes of QueryException. Separate them into 2 sub-classes of\nQueryException for better encapsulation.\n\nRemove unused method in AbstractVerification", "committedDate": "2020-02-28T07:55:43Z", "type": "commit"}, {"oid": "7d5d89ded7f06934d931baa238988b0e1093b28a", "url": "https://github.com/prestodb/presto/commit/7d5d89ded7f06934d931baa238988b0e1093b28a", "message": "Remove AbstractPrestoQueryFailureResolver\n\nThis abstract implementation of FailureResolver made inconsistent\nassumption. It supports specifying the expected QueryStage in order\nfor resolution to happen, but it exposes an abstract method\nresolveTestQueryFailure, which assumes test query are failed.\n\nInstead, we should be able to resolve checksum query failure as well.\n\nAlso, update resolve message.", "committedDate": "2020-02-28T22:27:56Z", "type": "commit"}, {"oid": "1cfa17ae86f1f1c15a38fe677fbafe393c9fa8f7", "url": "https://github.com/prestodb/presto/commit/1cfa17ae86f1f1c15a38fe677fbafe393c9fa8f7", "message": "Allow failure resolvers to be disabled individually\n\nFor each failure resolver, a configuration property is available to\nenable and disable the resolver, in the format of\n<name>.failure-resolver.enable, e.g. too-many-open-partitions.failure-\nresolver.enable.\n\nThe failure resolvers can still be disabled altogether by\nfailure-resolver.enabled.\n\nAlso,\n- Do not require factory class for simple FailureResolver.\n- Simplify FailureResolverFactoryContext.\n- Seperate specfic resolver config into separate class.", "committedDate": "2020-02-28T22:27:56Z", "type": "commit"}, {"oid": "55b2bf5de1172472a8694fe28ca08facbc0d463c", "url": "https://github.com/prestodb/presto/commit/55b2bf5de1172472a8694fe28ca08facbc0d463c", "message": "Distinguish between control, test, and determinism analysis checksum", "committedDate": "2020-02-28T22:27:56Z", "type": "commit"}, {"oid": "a903da14ab8e81ee33f386a8bf2ea45b84eb7b00", "url": "https://github.com/prestodb/presto/commit/a903da14ab8e81ee33f386a8bf2ea45b84eb7b00", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-28T22:28:30Z", "type": "commit"}, {"oid": "a903da14ab8e81ee33f386a8bf2ea45b84eb7b00", "url": "https://github.com/prestodb/presto/commit/a903da14ab8e81ee33f386a8bf2ea45b84eb7b00", "message": "Resolve checksum query compiler error instead of skipping it\n\nAlso, only resolve for control checksum failure.", "committedDate": "2020-02-28T22:28:30Z", "type": "forcePushed"}]}