{"pr_number": 14684, "pr_title": "Add an optimizer rule to remove redundant assignments in ProjectNode", "pr_createdAt": "2020-06-20T01:01:58Z", "pr_url": "https://github.com/prestodb/presto/pull/14684", "timeline": [{"oid": "072e7039b4728fe18529c46a4d351b2e6e7782a5", "url": "https://github.com/prestodb/presto/commit/072e7039b4728fe18529c46a4d351b2e6e7782a5", "message": "Add an optimizer rule to remove redundant assignments in ProjectNode", "committedDate": "2020-06-20T01:05:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNzQ3MA==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r443827470", "bodyText": "nit: static import Map.Entry", "author": "caithagoras", "createdAt": "2020-06-22T21:08:56Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/PruneRedundantProjectionAssignments.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.Assignments;\n+import com.facebook.presto.spi.plan.ProjectNode;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.facebook.presto.spi.relation.VariableReferenceExpression;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.facebook.presto.sql.planner.plan.Patterns.project;\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static com.google.common.collect.Iterables.getFirst;\n+\n+public class PruneRedundantProjectionAssignments\n+        implements Rule<ProjectNode>\n+{\n+    private static final Pattern<ProjectNode> PATTERN = project();\n+\n+    @Override\n+    public Pattern<ProjectNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(ProjectNode node, Captures captures, Context context)\n+    {\n+        Map<Boolean, List<Map.Entry<VariableReferenceExpression, RowExpression>>> projections = node.getAssignments().entrySet().stream()", "originalCommit": "072e7039b4728fe18529c46a4d351b2e6e7782a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQyNjIxOQ==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r444426219", "bodyText": "We normally don't static import Map.Entry.", "author": "rongrong", "createdAt": "2020-06-23T18:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNzQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNzUwNA==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r443827504", "bodyText": "static import Collectors.partitioningBy", "author": "caithagoras", "createdAt": "2020-06-22T21:09:02Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/PruneRedundantProjectionAssignments.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.Assignments;\n+import com.facebook.presto.spi.plan.ProjectNode;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.facebook.presto.spi.relation.VariableReferenceExpression;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.facebook.presto.sql.planner.plan.Patterns.project;\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static com.google.common.collect.Iterables.getFirst;\n+\n+public class PruneRedundantProjectionAssignments\n+        implements Rule<ProjectNode>\n+{\n+    private static final Pattern<ProjectNode> PATTERN = project();\n+\n+    @Override\n+    public Pattern<ProjectNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(ProjectNode node, Captures captures, Context context)\n+    {\n+        Map<Boolean, List<Map.Entry<VariableReferenceExpression, RowExpression>>> projections = node.getAssignments().entrySet().stream()\n+                .collect(Collectors.partitioningBy(entry -> entry.getValue() instanceof VariableReferenceExpression));", "originalCommit": "072e7039b4728fe18529c46a4d351b2e6e7782a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNzU4OQ==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r443827589", "bodyText": "static import Collectors.partitioningBy, Map.Entry", "author": "caithagoras", "createdAt": "2020-06-22T21:09:13Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/PruneRedundantProjectionAssignments.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.Assignments;\n+import com.facebook.presto.spi.plan.ProjectNode;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.facebook.presto.spi.relation.VariableReferenceExpression;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.facebook.presto.sql.planner.plan.Patterns.project;\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static com.google.common.collect.Iterables.getFirst;\n+\n+public class PruneRedundantProjectionAssignments\n+        implements Rule<ProjectNode>\n+{\n+    private static final Pattern<ProjectNode> PATTERN = project();\n+\n+    @Override\n+    public Pattern<ProjectNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(ProjectNode node, Captures captures, Context context)\n+    {\n+        Map<Boolean, List<Map.Entry<VariableReferenceExpression, RowExpression>>> projections = node.getAssignments().entrySet().stream()\n+                .collect(Collectors.partitioningBy(entry -> entry.getValue() instanceof VariableReferenceExpression));\n+        Map<RowExpression, ImmutableMap<VariableReferenceExpression, RowExpression>> uniqueProjections = projections.get(false).stream()\n+                .collect(Collectors.groupingBy(Map.Entry::getValue, toImmutableMap(Map.Entry::getKey, Map.Entry::getValue)));", "originalCommit": "072e7039b4728fe18529c46a4d351b2e6e7782a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQyNTgzMQ==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r444425831", "bodyText": "Most call site of these are not static import if you search the codebase.", "author": "rongrong", "createdAt": "2020-06-23T18:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNzU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNzcyMg==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r443827722", "bodyText": "static import Map.Entry\nAlso, I would normally only use interfaces here:\nfor (Entry<RowExpression, Map<VariableReferenceExpression, RowExpression>>)", "author": "caithagoras", "createdAt": "2020-06-22T21:09:28Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/PruneRedundantProjectionAssignments.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.Assignments;\n+import com.facebook.presto.spi.plan.ProjectNode;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.facebook.presto.spi.relation.VariableReferenceExpression;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.facebook.presto.sql.planner.plan.Patterns.project;\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static com.google.common.collect.Iterables.getFirst;\n+\n+public class PruneRedundantProjectionAssignments\n+        implements Rule<ProjectNode>\n+{\n+    private static final Pattern<ProjectNode> PATTERN = project();\n+\n+    @Override\n+    public Pattern<ProjectNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(ProjectNode node, Captures captures, Context context)\n+    {\n+        Map<Boolean, List<Map.Entry<VariableReferenceExpression, RowExpression>>> projections = node.getAssignments().entrySet().stream()\n+                .collect(Collectors.partitioningBy(entry -> entry.getValue() instanceof VariableReferenceExpression));\n+        Map<RowExpression, ImmutableMap<VariableReferenceExpression, RowExpression>> uniqueProjections = projections.get(false).stream()\n+                .collect(Collectors.groupingBy(Map.Entry::getValue, toImmutableMap(Map.Entry::getKey, Map.Entry::getValue)));\n+        if (uniqueProjections.size() == projections.get(false).size()) {\n+            return Result.empty();\n+        }\n+        Assignments.Builder childAssignments = Assignments.builder();\n+        Assignments.Builder parentAssignments = Assignments.builder();\n+        projections.get(true).forEach(entry -> childAssignments.put(entry.getKey(), entry.getValue()));\n+        projections.get(true).forEach(entry -> parentAssignments.put(entry.getKey(), entry.getKey()));\n+        for (Map.Entry<RowExpression, ImmutableMap<VariableReferenceExpression, RowExpression>> entry : uniqueProjections.entrySet()) {", "originalCommit": "072e7039b4728fe18529c46a4d351b2e6e7782a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyODg2NA==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r443828864", "bodyText": "I would normally only use interfaces here:\nfor (Entry<RowExpression, Map<VariableReferenceExpression, RowExpression>>)", "author": "caithagoras", "createdAt": "2020-06-22T21:11:44Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/PruneRedundantProjectionAssignments.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.Assignments;\n+import com.facebook.presto.spi.plan.ProjectNode;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.facebook.presto.spi.relation.VariableReferenceExpression;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.facebook.presto.sql.planner.plan.Patterns.project;\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static com.google.common.collect.Iterables.getFirst;\n+\n+public class PruneRedundantProjectionAssignments\n+        implements Rule<ProjectNode>\n+{\n+    private static final Pattern<ProjectNode> PATTERN = project();\n+\n+    @Override\n+    public Pattern<ProjectNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(ProjectNode node, Captures captures, Context context)\n+    {\n+        Map<Boolean, List<Map.Entry<VariableReferenceExpression, RowExpression>>> projections = node.getAssignments().entrySet().stream()\n+                .collect(Collectors.partitioningBy(entry -> entry.getValue() instanceof VariableReferenceExpression));\n+        Map<RowExpression, ImmutableMap<VariableReferenceExpression, RowExpression>> uniqueProjections = projections.get(false).stream()", "originalCommit": "072e7039b4728fe18529c46a4d351b2e6e7782a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQyNDgyOQ==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r444424829", "bodyText": "compiler actually complains if I use Map here.", "author": "rongrong", "createdAt": "2020-06-23T18:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyODg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzMjgwNw==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r443832807", "bodyText": "I tried this query out on the master with the CSE enabled and it is succeeding. Is there a case which fails on the master but succeeds with this fix?", "author": "caithagoras", "createdAt": "2020-06-22T21:20:00Z", "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -8447,6 +8447,14 @@ public void testSetAgg()\n                 \"select count(distinct orderdate) from orders\");\n     }\n \n+    @Test\n+    public void testRedundantLambda()\n+    {\n+        assertQuery(\n+                \"SELECT x, reduce(x, 0, (s, x) -> s + x, s -> s), reduce(x, 0, (s, x) -> s + x, s -> s) FROM (VALUES (array[1, 2, 3])) t(x)\",\n+                \"SELECT array[1, 2, 3], 6, 6\");\n+    }", "originalCommit": "072e7039b4728fe18529c46a4d351b2e6e7782a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzNDg1OA==", "url": "https://github.com/prestodb/presto/pull/14684#discussion_r443834858", "bodyText": "My mistake, the issue on master but is not in a release.", "author": "caithagoras", "createdAt": "2020-06-22T21:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzMjgwNw=="}], "type": "inlineReview"}, {"oid": "b6dafe4e668efb4658c7945fb2da7f326df367e1", "url": "https://github.com/prestodb/presto/commit/b6dafe4e668efb4658c7945fb2da7f326df367e1", "message": "Add an optimizer rule to remove redundant assignments in ProjectNode", "committedDate": "2020-06-23T18:28:42Z", "type": "commit"}, {"oid": "b6dafe4e668efb4658c7945fb2da7f326df367e1", "url": "https://github.com/prestodb/presto/commit/b6dafe4e668efb4658c7945fb2da7f326df367e1", "message": "Add an optimizer rule to remove redundant assignments in ProjectNode", "committedDate": "2020-06-23T18:28:42Z", "type": "forcePushed"}]}