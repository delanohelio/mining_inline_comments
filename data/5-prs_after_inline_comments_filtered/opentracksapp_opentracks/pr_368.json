{"pr_number": 368, "pr_title": "Interval stats: distance, speed and pace by selected interval.", "pr_createdAt": "2020-08-12T09:20:03Z", "pr_url": "https://github.com/OpenTracksApp/OpenTracks/pull/368", "timeline": [{"oid": "6e2ca343396a1fedc735075ff669d3bfed6768dc", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/6e2ca343396a1fedc735075ff669d3bfed6768dc", "message": "Interval statistics: show accumulate in distance column.", "committedDate": "2020-08-12T10:23:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQyNzkzOA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r469427938", "bodyText": "Constructor can be removed; just initialize it in line 11.", "author": "dennisguse", "createdAt": "2020-08-12T17:35:59Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public IntervalStatistics() {\n+        intervalList = new ArrayList<>();", "originalCommit": "60057263a4a6014f2c48e982dd04b3d97d2238c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQyODEyOQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r469428129", "bodyText": "make private", "author": "dennisguse", "createdAt": "2020-08-12T17:36:19Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public IntervalStatistics() {\n+        intervalList = new ArrayList<>();\n+    }\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();\n+\n+        if (trackPointList == null || trackPointList.size() == 0) {\n+            return;\n+        }\n+\n+        Interval interval = new Interval();\n+        for (int i = 1; i < trackPointList.size(); i++) {\n+            TrackPoint prevTrackPoint = trackPointList.get(i - 1);\n+            TrackPoint trackPoint = trackPointList.get(i);\n+\n+            if (LocationUtils.isValidLocation(trackPoint.getLocation()) && LocationUtils.isValidLocation(prevTrackPoint.getLocation())) {\n+                interval.distance += prevTrackPoint.distanceTo(trackPoint);\n+                interval.time += trackPoint.getTime() - prevTrackPoint.getTime();\n+\n+                if (interval.distance >= distanceInterval) {\n+                    float adjustFactor = distanceInterval / interval.distance;\n+                    Interval adjustedInterval = new Interval(interval);\n+                    adjustedInterval.distance *= adjustFactor;\n+                    adjustedInterval.time *= adjustFactor;\n+\n+                    intervalList.add(adjustedInterval);\n+\n+                    Interval newInterval = new Interval();\n+                    newInterval.distance = interval.distance - adjustedInterval.distance;\n+                    newInterval.time = interval.time - adjustedInterval.time;\n+\n+                    interval = newInterval;\n+                }\n+            }\n+        }\n+\n+        if (interval.distance > 1f) {\n+            intervalList.add(interval);\n+        }\n+    }\n+\n+    public List<Interval> getIntervalList() {\n+        return intervalList;\n+    }\n+\n+    public static class Interval {\n+        float distance = 0f;", "originalCommit": "60057263a4a6014f2c48e982dd04b3d97d2238c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQyODI3Nw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r469428277", "bodyText": "make private", "author": "dennisguse", "createdAt": "2020-08-12T17:36:33Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public IntervalStatistics() {\n+        intervalList = new ArrayList<>();\n+    }\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();\n+\n+        if (trackPointList == null || trackPointList.size() == 0) {\n+            return;\n+        }\n+\n+        Interval interval = new Interval();\n+        for (int i = 1; i < trackPointList.size(); i++) {\n+            TrackPoint prevTrackPoint = trackPointList.get(i - 1);\n+            TrackPoint trackPoint = trackPointList.get(i);\n+\n+            if (LocationUtils.isValidLocation(trackPoint.getLocation()) && LocationUtils.isValidLocation(prevTrackPoint.getLocation())) {\n+                interval.distance += prevTrackPoint.distanceTo(trackPoint);\n+                interval.time += trackPoint.getTime() - prevTrackPoint.getTime();\n+\n+                if (interval.distance >= distanceInterval) {\n+                    float adjustFactor = distanceInterval / interval.distance;\n+                    Interval adjustedInterval = new Interval(interval);\n+                    adjustedInterval.distance *= adjustFactor;\n+                    adjustedInterval.time *= adjustFactor;\n+\n+                    intervalList.add(adjustedInterval);\n+\n+                    Interval newInterval = new Interval();\n+                    newInterval.distance = interval.distance - adjustedInterval.distance;\n+                    newInterval.time = interval.time - adjustedInterval.time;\n+\n+                    interval = newInterval;\n+                }\n+            }\n+        }\n+\n+        if (interval.distance > 1f) {\n+            intervalList.add(interval);\n+        }\n+    }\n+\n+    public List<Interval> getIntervalList() {\n+        return intervalList;\n+    }\n+\n+    public static class Interval {\n+        float distance = 0f;\n+        float time = 0f;", "originalCommit": "60057263a4a6014f2c48e982dd04b3d97d2238c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQyODkzNg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r469428936", "bodyText": "i guess this will be either 1mile / 1km, right?\nSo, we are independent of the actual unit", "author": "dennisguse", "createdAt": "2020-08-12T17:37:43Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatisticsModel.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.content.Context;\n+\n+import androidx.annotation.NonNull;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatisticsModel extends AndroidViewModel {\n+\n+    private MutableLiveData<IntervalStatistics> intervalStats;\n+    private IntervalOption interval;\n+\n+    public IntervalStatisticsModel(@NonNull Application application) {\n+        super(application);\n+        interval = IntervalOption.OPTION_1;\n+    }\n+\n+    public LiveData<IntervalStatistics> getIntervalStats(long trackId, IntervalOption interval) {\n+        if (intervalStats == null || this.interval != interval) {\n+            intervalStats = new MutableLiveData<>();\n+            this.interval = interval;\n+            loadIntervalStats(trackId);\n+        }\n+        return intervalStats;\n+    }\n+\n+    public LiveData<IntervalStatistics> getIntervalStats(long trackId) {\n+        return getIntervalStats(trackId, interval);\n+    }\n+\n+    public void invalidate() {\n+        intervalStats = null;\n+    }\n+\n+    private void loadIntervalStats(long trackId) {\n+        new Thread(() -> {\n+            Context context = getApplication().getApplicationContext();\n+            ContentProviderUtils contentProviderUtils = new ContentProviderUtils(context);\n+            List<TrackPoint> trackPointList = contentProviderUtils.getTrackPoints(trackId);\n+\n+            IntervalStatistics intervalStatistics = new IntervalStatistics();\n+            float distanceInterval = PreferencesUtils.isMetricUnits(context) ? (float) (interval.getValue() * UnitConversions.KM_TO_M) : (float) (interval.getValue() * UnitConversions.MI_TO_M);\n+            intervalStatistics.build(trackPointList, distanceInterval);\n+\n+            intervalStats.postValue(intervalStatistics);\n+        }).start();\n+    }\n+\n+    public enum IntervalOption {\n+        OPTION_1(1),", "originalCommit": "60057263a4a6014f2c48e982dd04b3d97d2238c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQzOTc4NA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r469439784", "bodyText": "Yes, it is. It works with mi and km. In the case the user changes the unit from km to mi the intervals are reload and the other way around.", "author": "rgmf", "createdAt": "2020-08-12T17:56:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQyODkzNg=="}], "type": "inlineReview"}, {"oid": "ab5d038fc1cb7abad6de30370dedade2beb6eebb", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/ab5d038fc1cb7abad6de30370dedade2beb6eebb", "message": "Interval stats: added a new tab in TrackRecordingActivity that shows the intervals on live.", "committedDate": "2020-08-17T17:25:38Z", "type": "forcePushed"}, {"oid": "cde34ea8a94434ae1393d18c93c485fd7ef75221", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/cde34ea8a94434ae1393d18c93c485fd7ef75221", "message": "Interval stats: added IntervalStatisticsTest.", "committedDate": "2020-08-19T13:10:17Z", "type": "forcePushed"}, {"oid": "2af8ea9c91e58bb8d916ba5a10f4669234cc94a2", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/2af8ea9c91e58bb8d916ba5a10f4669234cc94a2", "message": "Interval stats: added IntervalStatisticsTest.", "committedDate": "2020-08-19T13:12:46Z", "type": "forcePushed"}, {"oid": "c38c7cf5640f591cfe6e439a181682372bf4f111", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/c38c7cf5640f591cfe6e439a181682372bf4f111", "message": "Interval stats: while user is recording a track intervals are refreshed every 5 seconds.\nInterval stats: completed the list of split intervals: 1, 2, 3, 4, 5, 10, 20 or 50 km or mi.\nFixes #87.", "committedDate": "2020-08-21T09:15:05Z", "type": "forcePushed"}, {"oid": "a471f16fede8f3d0aaf33162b2d0f75f4eb166ac", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/a471f16fede8f3d0aaf33162b2d0f75f4eb166ac", "message": "Interval stats: while user is recording a track intervals are refreshed every 5 seconds.\nInterval stats: completed the list of split intervals: 1, 2, 3, 4, 5, 10, 20 or 50 km or mi.\nFixes #87.", "committedDate": "2020-08-23T16:00:19Z", "type": "forcePushed"}, {"oid": "7a865c3f0407b09f4be060eca1f487f4256243f3", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/7a865c3f0407b09f4be060eca1f487f4256243f3", "message": "Interval Stats: track's id it's not long anymore.", "committedDate": "2020-08-23T16:28:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NjY2OA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475246668", "bodyText": "return Arrays.asList(pair.second);", "author": "dennisguse", "createdAt": "2020-08-23T17:50:42Z", "path": "src/androidTest/java/de/dennisguse/opentracks/viewmodels/IntervalStatisticsTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.util.Pair;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+import org.junit.Assert;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TestDataUtil;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.stats.TrackStatistics;\n+import de.dennisguse.opentracks.stats.TrackStatisticsUpdater;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+@RunWith(JUnit4.class)\n+public class IntervalStatisticsTest {\n+\n+    private static final String TAG = IntervalStatisticsTest.class.getSimpleName();\n+\n+    private List<TrackPoint> buildTrackPoints(int numberOfTrackPoints) {\n+\t\tPair<Track, TrackPoint[]> pair = TestDataUtil.createTrack(new Track.Id(System.currentTimeMillis()), numberOfTrackPoints);\n+\t\tList<TrackPoint> trackPoints = Arrays.asList(pair.second);", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NjcyOQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475246729", "bodyText": "formatting", "author": "dennisguse", "createdAt": "2020-08-23T17:51:14Z", "path": "src/androidTest/java/de/dennisguse/opentracks/viewmodels/IntervalStatisticsTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.util.Pair;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+import org.junit.Assert;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TestDataUtil;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.stats.TrackStatistics;\n+import de.dennisguse.opentracks.stats.TrackStatisticsUpdater;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+@RunWith(JUnit4.class)\n+public class IntervalStatisticsTest {\n+\n+    private static final String TAG = IntervalStatisticsTest.class.getSimpleName();\n+\n+    private List<TrackPoint> buildTrackPoints(int numberOfTrackPoints) {\n+\t\tPair<Track, TrackPoint[]> pair = TestDataUtil.createTrack(new Track.Id(System.currentTimeMillis()), numberOfTrackPoints);\n+\t\tList<TrackPoint> trackPoints = Arrays.asList(pair.second);\n+\n+\t\treturn trackPoints;\n+\t}\n+\n+\tprivate TrackStatistics buildTrackStatistics(List<TrackPoint> trackPoints) {\n+\t\tTrackStatisticsUpdater trackStatisticsUpdater = new TrackStatisticsUpdater(trackPoints.get(0).getTime());\n+\t\tfor (TrackPoint tp : trackPoints) {\n+\t\t\ttrackStatisticsUpdater.addTrackPoint(tp, 0);\n+\t\t}\n+\t\treturn trackStatisticsUpdater.getTrackStatistics();\n+\t}\n+\n+\t/**\n+\t * Tests that build method compute the distance correctly comparing the result with TrackStatisticsUpdater result.\n+\t */\n+\t@Test\n+    public void testBuild_1() {\n+\t\t// With 50 points and interval distance of 1000m.\n+", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODc5Mg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475488792", "bodyText": "Strange... I see it well formatted. Anyway I've reformatted.", "author": "rgmf", "createdAt": "2020-08-24T10:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NjcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0Njk0Ng==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475246946", "bodyText": "Why not use a newInstance-method (like the other fragements?)", "author": "dennisguse", "createdAt": "2020-08-23T17:53:43Z", "path": "src/main/java/de/dennisguse/opentracks/TrackRecordingActivity.java", "diffHunk": "@@ -382,8 +383,10 @@ public Fragment getItem(int position) {\n                 case 0:\n                     return new StatisticsRecordingFragment();\n                 case 1:\n-                    return ChartFragment.newInstance(false);\n+                    return new IntervalsRecordingFragment();", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ5MjM5MQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475492391", "bodyText": "I thought that this was the best option because it not receive any arguments. Changed ;)", "author": "rgmf", "createdAt": "2020-08-24T10:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0Njk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzA2OA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475247068", "bodyText": "Does it handle changes of metricUnits via settings?", "author": "dennisguse", "createdAt": "2020-08-23T17:54:46Z", "path": "src/main/java/de/dennisguse/opentracks/adapters/IntervalStatisticsAdapter.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package de.dennisguse.opentracks.adapters;\n+\n+import android.content.Context;\n+import android.util.Pair;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.ArrayAdapter;\n+import android.widget.TextView;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.StringUtils;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+\n+public class IntervalStatisticsAdapter extends ArrayAdapter<IntervalStatistics.Interval> {\n+\n+    private boolean metricUnits;\n+    private float accDistance = 0f;\n+\n+    public IntervalStatisticsAdapter(Context context, List<IntervalStatistics.Interval> intervalList) {\n+        super(context, R.layout.interval_stats_list_item, intervalList);\n+        metricUnits = PreferencesUtils.isMetricUnits(context);", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ5NDk5MQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475494991", "bodyText": "Yes, every time view's display method is called it recreates the adapter. The fragments that use this view are responsible of re-displaying the view and they're who listen preferences changes to update UI (including the view).", "author": "rgmf", "createdAt": "2020-08-24T10:17:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzE4MQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475247181", "bodyText": "sumDistance?\nAnd adding units to the name would be great aka sumDistance_m", "author": "dennisguse", "createdAt": "2020-08-23T17:55:36Z", "path": "src/main/java/de/dennisguse/opentracks/adapters/IntervalStatisticsAdapter.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package de.dennisguse.opentracks.adapters;\n+\n+import android.content.Context;\n+import android.util.Pair;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.ArrayAdapter;\n+import android.widget.TextView;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.StringUtils;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+\n+public class IntervalStatisticsAdapter extends ArrayAdapter<IntervalStatistics.Interval> {\n+\n+    private boolean metricUnits;\n+    private float accDistance = 0f;", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ5NjE4MA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475496180", "bodyText": "Ooohhhh yes, I've seen a lot of times the unit added to the name of variables... sorry \ud83d\udc4d", "author": "rgmf", "createdAt": "2020-08-24T10:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzMxMg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475247312", "bodyText": "why not show the units for pace as well?", "author": "dennisguse", "createdAt": "2020-08-23T17:56:50Z", "path": "src/main/java/de/dennisguse/opentracks/adapters/IntervalStatisticsAdapter.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package de.dennisguse.opentracks.adapters;\n+\n+import android.content.Context;\n+import android.util.Pair;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.ArrayAdapter;\n+import android.widget.TextView;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.StringUtils;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+\n+public class IntervalStatisticsAdapter extends ArrayAdapter<IntervalStatistics.Interval> {\n+\n+    private boolean metricUnits;\n+    private float accDistance = 0f;\n+\n+    public IntervalStatisticsAdapter(Context context, List<IntervalStatistics.Interval> intervalList) {\n+        super(context, R.layout.interval_stats_list_item, intervalList);\n+        metricUnits = PreferencesUtils.isMetricUnits(context);\n+    }\n+\n+    @NonNull\n+    @Override\n+    public View getView(int position, @Nullable View intervalView, @NonNull ViewGroup parent) {\n+        IntervalStatistics.Interval interval = getItem(position);\n+        ViewHolder viewHolder;\n+\n+        if (intervalView == null) {\n+            viewHolder = new ViewHolder();\n+\n+            intervalView = LayoutInflater.from(getContext()).inflate(R.layout.interval_stats_list_item, parent, false);\n+\n+            viewHolder.distance = intervalView.findViewById(R.id.interval_item_distance);\n+            viewHolder.speed = intervalView.findViewById(R.id.interval_item_speed);\n+            viewHolder.pace = intervalView.findViewById(R.id.interval_item_pace);\n+\n+            intervalView.setTag(viewHolder);\n+        } else {\n+            viewHolder = (ViewHolder) intervalView.getTag();\n+        }\n+\n+        accDistance += interval.getDistance();\n+        viewHolder.distance.setText(StringUtils.formatDistance(getContext(), accDistance, metricUnits));\n+        Pair<String, String> speedParts = StringUtils.getSpeedParts(getContext(), interval.getSpeed(), metricUnits, true);\n+        viewHolder.speed.setText(speedParts.first + \" \" + speedParts.second);\n+        viewHolder.pace.setText(StringUtils.getSpeedParts(getContext(), interval.getSpeed(), metricUnits, false).first);", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUwMDY3Mg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475500672", "bodyText": "Because pace is time. When you see stats in a table, the column with pace doesn't show unit. I've never seen the unit but It's only my experience and I don't know what standard says about this (if any standard about it).", "author": "rgmf", "createdAt": "2020-08-24T10:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUwNjcxOA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475506718", "bodyText": "One the statistics fragment pace is shown with unit.\ni don't know if it is meaningful to the user.", "author": "dennisguse", "createdAt": "2020-08-24T10:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMDI0NQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475510245", "bodyText": "You are right... So I have to add here the unit too for maintain the coherence.\nAnyway, I'm going to look into about this matter... For the moment I'll add the unit\n;)", "author": "rgmf", "createdAt": "2020-08-24T10:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzU4NA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475247584", "bodyText": "Can you add the comment here: why 5s?", "author": "dennisguse", "createdAt": "2020-08-23T17:59:58Z", "path": "src/main/java/de/dennisguse/opentracks/fragments/IntervalsRecordingFragment.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package de.dennisguse.opentracks.fragments;\n+\n+import android.os.Bundle;\n+import android.os.Handler;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.LinearLayout;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.Fragment;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.ViewModelProvider;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatisticsModel;\n+import de.dennisguse.opentracks.views.IntervalListView;\n+import de.dennisguse.opentracks.views.IntervalReverseListView;\n+\n+/**\n+ * A fragment to display the intervals from recording track.\n+ */\n+public class IntervalsRecordingFragment extends Fragment implements IntervalListView.IntervalListListener {\n+\n+    private static final String TAG = IntervalsRecordingFragment.class.getSimpleName();\n+\n+    private static final long UI_UPDATE_INTERVAL = 5 * UnitConversions.ONE_SECOND_MS;", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUwNTAyMw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475505023", "bodyText": "Of course ;)", "author": "rgmf", "createdAt": "2020-08-24T10:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzkwNA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475247904", "bodyText": "Why not check isResume() of parent class?\nThen we don't need stop.\nSee StatisticsRecordingFragment:107.", "author": "dennisguse", "createdAt": "2020-08-23T18:03:51Z", "path": "src/main/java/de/dennisguse/opentracks/fragments/IntervalsRecordingFragment.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package de.dennisguse.opentracks.fragments;\n+\n+import android.os.Bundle;\n+import android.os.Handler;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.LinearLayout;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.Fragment;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.ViewModelProvider;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatisticsModel;\n+import de.dennisguse.opentracks.views.IntervalListView;\n+import de.dennisguse.opentracks.views.IntervalReverseListView;\n+\n+/**\n+ * A fragment to display the intervals from recording track.\n+ */\n+public class IntervalsRecordingFragment extends Fragment implements IntervalListView.IntervalListListener {\n+\n+    private static final String TAG = IntervalsRecordingFragment.class.getSimpleName();\n+\n+    private static final long UI_UPDATE_INTERVAL = 5 * UnitConversions.ONE_SECOND_MS;\n+\n+    private IntervalStatisticsModel viewModel;\n+    private IntervalReverseListView intervalListView;\n+\n+    private class IntervalRunner implements Runnable {\n+        private boolean stopped = false;\n+\n+        @Override\n+        public void run() {\n+            if (!stopped) {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzkzMw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475247933", "bodyText": "||", "author": "dennisguse", "createdAt": "2020-08-23T18:04:14Z", "path": "src/main/java/de/dennisguse/opentracks/fragments/IntervalsRecordingFragment.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package de.dennisguse.opentracks.fragments;\n+\n+import android.os.Bundle;\n+import android.os.Handler;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.LinearLayout;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.Fragment;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.ViewModelProvider;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatisticsModel;\n+import de.dennisguse.opentracks.views.IntervalListView;\n+import de.dennisguse.opentracks.views.IntervalReverseListView;\n+\n+/**\n+ * A fragment to display the intervals from recording track.\n+ */\n+public class IntervalsRecordingFragment extends Fragment implements IntervalListView.IntervalListListener {\n+\n+    private static final String TAG = IntervalsRecordingFragment.class.getSimpleName();\n+\n+    private static final long UI_UPDATE_INTERVAL = 5 * UnitConversions.ONE_SECOND_MS;\n+\n+    private IntervalStatisticsModel viewModel;\n+    private IntervalReverseListView intervalListView;\n+\n+    private class IntervalRunner implements Runnable {\n+        private boolean stopped = false;\n+\n+        @Override\n+        public void run() {\n+            if (!stopped) {\n+                updateIntervals();\n+                intervalHandler.postDelayed(intervalRunner, UI_UPDATE_INTERVAL);\n+            }\n+        }\n+\n+        public void stop() {\n+            stopped = true;\n+        }\n+    }\n+\n+    private Handler intervalHandler = null;\n+    private IntervalRunner intervalRunner = null;\n+\n+    @Override\n+    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {\n+        return inflater.inflate(R.layout.intervals_recording, container, false);\n+    }\n+\n+    @Override\n+    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {\n+        super.onViewCreated(view, savedInstanceState);\n+\n+        intervalHandler = new Handler();\n+\n+        intervalListView = new IntervalReverseListView(getActivity(), this);\n+        intervalListView.setId(View.generateViewId());\n+        LinearLayout linearLayout = view.findViewById(R.id.root_view);\n+        linearLayout.removeAllViews();\n+        linearLayout.addView(intervalListView);\n+\n+        viewModel = new ViewModelProvider(this).get(IntervalStatisticsModel.class);\n+    }\n+\n+    @Override\n+    public void onResume() {\n+        super.onResume();\n+        if (intervalRunner == null) {\n+            intervalRunner = new IntervalRunner();\n+            intervalRunner.run();\n+        }\n+    }\n+\n+    @Override\n+    public void onPause() {\n+        super.onPause();\n+        if (intervalRunner != null) {\n+            intervalRunner.stop();\n+            intervalRunner = null;\n+        }\n+    }\n+\n+    @Override\n+    public void onDestroy() {\n+        super.onDestroy();\n+\n+        intervalListView.destroy();\n+        intervalListView = null;\n+        viewModel = null;\n+    }\n+\n+    /**\n+     * Update intervals through {@link IntervalStatisticsModel} view model.\n+     *\n+     * @param interval intervals will split in this interval if not null. If it's null then view model will use the default one.\n+     */\n+    private void updateIntervals(@Nullable IntervalStatisticsModel.IntervalOption interval) {\n+        if (viewModel == null | intervalListView == null) {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxNDAxNg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475514016", "bodyText": "Oopps :(", "author": "rgmf", "createdAt": "2020-08-24T10:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0NzkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODA3OQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475248079", "bodyText": "Why initialize some vars with = null directly?\nIsn't implicit?", "author": "dennisguse", "createdAt": "2020-08-23T18:05:22Z", "path": "src/main/java/de/dennisguse/opentracks/fragments/StatisticsRecordedFragment.java", "diffHunk": "@@ -24,38 +24,48 @@\n import android.view.MotionEvent;\n import android.view.View;\n import android.view.ViewGroup;\n+import android.widget.LinearLayout;\n import android.widget.Spinner;\n import android.widget.TextView;\n \n import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.fragment.app.Fragment;\n+import androidx.lifecycle.ViewModelProvider;\n \n import de.dennisguse.opentracks.R;\n import de.dennisguse.opentracks.TrackRecordedActivity;\n-import de.dennisguse.opentracks.content.TrackDataHub;\n-import de.dennisguse.opentracks.content.TrackDataListener;\n import de.dennisguse.opentracks.content.data.Track;\n-import de.dennisguse.opentracks.content.data.TrackPoint;\n-import de.dennisguse.opentracks.content.data.Waypoint;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n import de.dennisguse.opentracks.stats.TrackStatistics;\n import de.dennisguse.opentracks.util.PreferencesUtils;\n import de.dennisguse.opentracks.util.StringUtils;\n import de.dennisguse.opentracks.util.TrackIconUtils;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatisticsModel;\n+import de.dennisguse.opentracks.views.IntervalListView;\n \n /**\n  * A fragment to display track statistics to the user.\n  *\n  * @author Sandor Dornbush\n  * @author Rodrigo Damazio\n  */\n-public class StatisticsRecordedFragment extends Fragment implements TrackDataListener {\n+public class StatisticsRecordedFragment extends Fragment implements IntervalListView.IntervalListListener {\n+\n+    private static final String TRACK_ID_KEY = \"trackId\";\n \n     private TrackStatistics trackStatistics = null;\n     private String category = \"\";\n+    private Track track;\n+\n+    private IntervalStatisticsModel viewModel = null;", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxNTA2MA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475515060", "bodyText": "Lack of Java experience... I won't forget anymore \ud83d\ude04", "author": "rgmf", "createdAt": "2020-08-24T10:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODIzOA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475248238", "bodyText": "+1", "author": "dennisguse", "createdAt": "2020-08-23T18:06:31Z", "path": "src/main/java/de/dennisguse/opentracks/fragments/StatisticsRecordedFragment.java", "diffHunk": "@@ -135,28 +174,28 @@ public void onActivityCreated(Bundle savedInstanceState) {\n         });\n     }\n \n+    private void addIntervals() {\n+        viewModel.getIntervalStats(track.getId()).observe(getActivity(), intervalStatistics -> {\n+            if (intervalStatistics != null) {\n+                intervalListView.display(intervalStatistics.getIntervalList());\n+            }\n+        });\n+    }\n+\n     @Override\n     public void onResume() {\n         super.onResume();\n         PreferencesUtils.register(getContext(), sharedPreferenceChangeListener);\n \n-        TrackDataHub trackDataHub = ((TrackRecordedActivity) getActivity()).getTrackDataHub();\n-        trackDataHub.registerTrackDataListener(this, true, false, true, true);\n-    }\n-\n-    @Override\n-    public void onPause() {\n-        super.onPause();\n-        PreferencesUtils.unregister(getContext(), sharedPreferenceChangeListener);\n-\n-        TrackDataHub trackDataHub = ((TrackRecordedActivity) getActivity()).getTrackDataHub();\n-        trackDataHub.unregisterTrackDataListener(this);\n+        loadStatistics();\n     }\n \n     @Override\n     public void onDestroyView() {\n         super.onDestroyView();\n \n+        PreferencesUtils.unregister(getContext(), sharedPreferenceChangeListener);", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODI4Nw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475248287", "bodyText": "Commt is helpful?", "author": "dennisguse", "createdAt": "2020-08-23T18:07:06Z", "path": "src/main/java/de/dennisguse/opentracks/fragments/StatisticsRecordedFragment.java", "diffHunk": "@@ -291,5 +298,19 @@ private void updateUI() {\n             speedMovingValue.setText(parts.first);\n             speedMovingUnit.setText(parts.second);\n         }\n+\n+        // Set intervals.", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODU3Mg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475248572", "bodyText": "Isn't this:\nCan you introduce\npublic static final double MI_TO_KM = 1 / KM_TO_MI; public static final double MI_TO_M = MI_TO_KM * KM_TO_M;\nPS: Did not test this.....", "author": "dennisguse", "createdAt": "2020-08-23T18:10:09Z", "path": "src/main/java/de/dennisguse/opentracks/util/UnitConversions.java", "diffHunk": "@@ -51,6 +51,8 @@\n     public static final double MM_TO_M = 0.001;\n \n     // Distance\n+    // multiplication factor to convert miles to meters\n+    public static final double MI_TO_M = 1609.344;", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxODU3Mw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475518573", "bodyText": "Can you introduce\npublic static final double MI_TO_KM = 1 / KM_TO_MI; public static final double MI_TO_M = MI_TO_KM * KM_TO_M;\n\n\ud83d\udc4d\n\nPS: Did not test this.....\n\nI check it out and I'll add tests if not any.", "author": "rgmf", "createdAt": "2020-08-24T10:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODY1Nw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475248657", "bodyText": "Default initialize in l:11 and then use intervalList.clear();\nThis may save some memory allocation (or the runtime is really good).", "author": "dennisguse", "createdAt": "2020-08-23T18:11:19Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODcxMw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475248713", "bodyText": "distance_m?", "author": "dennisguse", "createdAt": "2020-08-23T18:11:47Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();\n+\n+        if (trackPointList == null || trackPointList.size() == 0) {\n+            return;\n+        }\n+\n+        Interval interval = new Interval();\n+        for (int i = 1; i < trackPointList.size(); i++) {\n+            TrackPoint prevTrackPoint = trackPointList.get(i - 1);\n+            TrackPoint trackPoint = trackPointList.get(i);\n+\n+            if (LocationUtils.isValidLocation(trackPoint.getLocation()) && LocationUtils.isValidLocation(prevTrackPoint.getLocation())) {\n+                interval.distance += prevTrackPoint.distanceTo(trackPoint);\n+                interval.time += trackPoint.getTime() - prevTrackPoint.getTime();\n+\n+                if (interval.distance >= distanceInterval) {\n+                    float adjustFactor = distanceInterval / interval.distance;\n+                    Interval adjustedInterval = new Interval(interval);\n+                    adjustedInterval.distance *= adjustFactor;\n+                    adjustedInterval.time *= adjustFactor;\n+\n+                    intervalList.add(adjustedInterval);\n+\n+                    Interval newInterval = new Interval();\n+                    newInterval.distance = interval.distance - adjustedInterval.distance;\n+                    newInterval.time = interval.time - adjustedInterval.time;\n+\n+                    interval = newInterval;\n+                }\n+            }\n+        }\n+\n+        if (interval.distance > 1f) {\n+            intervalList.add(interval);\n+        }\n+    }\n+\n+    public List<Interval> getIntervalList() {\n+        return intervalList;\n+    }\n+\n+    public static class Interval {\n+        private float distance = 0f;", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODczMw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475248733", "bodyText": "time_ms?", "author": "dennisguse", "createdAt": "2020-08-23T18:11:55Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();\n+\n+        if (trackPointList == null || trackPointList.size() == 0) {\n+            return;\n+        }\n+\n+        Interval interval = new Interval();\n+        for (int i = 1; i < trackPointList.size(); i++) {\n+            TrackPoint prevTrackPoint = trackPointList.get(i - 1);\n+            TrackPoint trackPoint = trackPointList.get(i);\n+\n+            if (LocationUtils.isValidLocation(trackPoint.getLocation()) && LocationUtils.isValidLocation(prevTrackPoint.getLocation())) {\n+                interval.distance += prevTrackPoint.distanceTo(trackPoint);\n+                interval.time += trackPoint.getTime() - prevTrackPoint.getTime();\n+\n+                if (interval.distance >= distanceInterval) {\n+                    float adjustFactor = distanceInterval / interval.distance;\n+                    Interval adjustedInterval = new Interval(interval);\n+                    adjustedInterval.distance *= adjustFactor;\n+                    adjustedInterval.time *= adjustFactor;\n+\n+                    intervalList.add(adjustedInterval);\n+\n+                    Interval newInterval = new Interval();\n+                    newInterval.distance = interval.distance - adjustedInterval.distance;\n+                    newInterval.time = interval.time - adjustedInterval.time;\n+\n+                    interval = newInterval;\n+                }\n+            }\n+        }\n+\n+        if (interval.distance > 1f) {\n+            intervalList.add(interval);\n+        }\n+    }\n+\n+    public List<Interval> getIntervalList() {\n+        return intervalList;\n+    }\n+\n+    public static class Interval {\n+        private float distance = 0f;\n+        private float time = 0f;", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0ODkyMQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475248921", "bodyText": "What about:\ninterval = new Interval(interval.distance - adjustedInterval.distance, interval.time - adjustedInterval.time);", "author": "dennisguse", "createdAt": "2020-08-23T18:14:14Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();\n+\n+        if (trackPointList == null || trackPointList.size() == 0) {\n+            return;\n+        }\n+\n+        Interval interval = new Interval();\n+        for (int i = 1; i < trackPointList.size(); i++) {\n+            TrackPoint prevTrackPoint = trackPointList.get(i - 1);\n+            TrackPoint trackPoint = trackPointList.get(i);\n+\n+            if (LocationUtils.isValidLocation(trackPoint.getLocation()) && LocationUtils.isValidLocation(prevTrackPoint.getLocation())) {\n+                interval.distance += prevTrackPoint.distanceTo(trackPoint);\n+                interval.time += trackPoint.getTime() - prevTrackPoint.getTime();\n+\n+                if (interval.distance >= distanceInterval) {\n+                    float adjustFactor = distanceInterval / interval.distance;\n+                    Interval adjustedInterval = new Interval(interval);\n+                    adjustedInterval.distance *= adjustFactor;\n+                    adjustedInterval.time *= adjustFactor;\n+\n+                    intervalList.add(adjustedInterval);\n+\n+                    Interval newInterval = new Interval();", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0OTA1Mg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475249052", "bodyText": "For Interval:\npublic void adjust(float adjustFactor) {\ndistance *= adjustFactor;\ntime *= adjustFactor;\n}", "author": "dennisguse", "createdAt": "2020-08-23T18:15:19Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();\n+\n+        if (trackPointList == null || trackPointList.size() == 0) {\n+            return;\n+        }\n+\n+        Interval interval = new Interval();\n+        for (int i = 1; i < trackPointList.size(); i++) {\n+            TrackPoint prevTrackPoint = trackPointList.get(i - 1);\n+            TrackPoint trackPoint = trackPointList.get(i);\n+\n+            if (LocationUtils.isValidLocation(trackPoint.getLocation()) && LocationUtils.isValidLocation(prevTrackPoint.getLocation())) {\n+                interval.distance += prevTrackPoint.distanceTo(trackPoint);\n+                interval.time += trackPoint.getTime() - prevTrackPoint.getTime();\n+\n+                if (interval.distance >= distanceInterval) {\n+                    float adjustFactor = distanceInterval / interval.distance;\n+                    Interval adjustedInterval = new Interval(interval);\n+                    adjustedInterval.distance *= adjustFactor;", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0OTA3Ng==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475249076", "bodyText": "Put constructor(s) first", "author": "dennisguse", "createdAt": "2020-08-23T18:15:48Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();\n+\n+        if (trackPointList == null || trackPointList.size() == 0) {\n+            return;\n+        }\n+\n+        Interval interval = new Interval();\n+        for (int i = 1; i < trackPointList.size(); i++) {\n+            TrackPoint prevTrackPoint = trackPointList.get(i - 1);\n+            TrackPoint trackPoint = trackPointList.get(i);\n+\n+            if (LocationUtils.isValidLocation(trackPoint.getLocation()) && LocationUtils.isValidLocation(prevTrackPoint.getLocation())) {\n+                interval.distance += prevTrackPoint.distanceTo(trackPoint);\n+                interval.time += trackPoint.getTime() - prevTrackPoint.getTime();\n+\n+                if (interval.distance >= distanceInterval) {\n+                    float adjustFactor = distanceInterval / interval.distance;\n+                    Interval adjustedInterval = new Interval(interval);\n+                    adjustedInterval.distance *= adjustFactor;\n+                    adjustedInterval.time *= adjustFactor;\n+\n+                    intervalList.add(adjustedInterval);\n+\n+                    Interval newInterval = new Interval();\n+                    newInterval.distance = interval.distance - adjustedInterval.distance;\n+                    newInterval.time = interval.time - adjustedInterval.time;\n+\n+                    interval = newInterval;\n+                }\n+            }\n+        }\n+\n+        if (interval.distance > 1f) {\n+            intervalList.add(interval);\n+        }\n+    }\n+\n+    public List<Interval> getIntervalList() {\n+        return intervalList;\n+    }\n+\n+    public static class Interval {\n+        private float distance = 0f;\n+        private float time = 0f;\n+\n+        public float getDistance() {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0OTA4OQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475249089", "bodyText": "getSpeed_ms()", "author": "dennisguse", "createdAt": "2020-08-23T18:15:57Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatistics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.util.LocationUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+public class IntervalStatistics {\n+    List<Interval> intervalList;\n+\n+    public void build(List<TrackPoint> trackPointList, float distanceInterval) {\n+        intervalList = new ArrayList<>();\n+\n+        if (trackPointList == null || trackPointList.size() == 0) {\n+            return;\n+        }\n+\n+        Interval interval = new Interval();\n+        for (int i = 1; i < trackPointList.size(); i++) {\n+            TrackPoint prevTrackPoint = trackPointList.get(i - 1);\n+            TrackPoint trackPoint = trackPointList.get(i);\n+\n+            if (LocationUtils.isValidLocation(trackPoint.getLocation()) && LocationUtils.isValidLocation(prevTrackPoint.getLocation())) {\n+                interval.distance += prevTrackPoint.distanceTo(trackPoint);\n+                interval.time += trackPoint.getTime() - prevTrackPoint.getTime();\n+\n+                if (interval.distance >= distanceInterval) {\n+                    float adjustFactor = distanceInterval / interval.distance;\n+                    Interval adjustedInterval = new Interval(interval);\n+                    adjustedInterval.distance *= adjustFactor;\n+                    adjustedInterval.time *= adjustFactor;\n+\n+                    intervalList.add(adjustedInterval);\n+\n+                    Interval newInterval = new Interval();\n+                    newInterval.distance = interval.distance - adjustedInterval.distance;\n+                    newInterval.time = interval.time - adjustedInterval.time;\n+\n+                    interval = newInterval;\n+                }\n+            }\n+        }\n+\n+        if (interval.distance > 1f) {\n+            intervalList.add(interval);\n+        }\n+    }\n+\n+    public List<Interval> getIntervalList() {\n+        return intervalList;\n+    }\n+\n+    public static class Interval {\n+        private float distance = 0f;\n+        private float time = 0f;\n+\n+        public float getDistance() {\n+            return distance;\n+        }\n+\n+        public Interval() {}\n+\n+        public Interval(Interval i) {\n+            distance = i.distance;\n+            time = i.time;\n+        }\n+\n+        /**\n+         * @return speed of the interval in m/s.\n+         */\n+        public float getSpeed() {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0OTE2NA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475249164", "bodyText": "Why application?\nI guess, we pass it nowwhere else, right?\nIs this just a context?", "author": "dennisguse", "createdAt": "2020-08-23T18:16:47Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatisticsModel.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.content.Context;\n+\n+import androidx.annotation.NonNull;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+/**\n+ * This view model is used to load intervals for a track.\n+ * It uses a default interval but it can be set from outside to manage the interval length.\n+ */\n+public class IntervalStatisticsModel extends AndroidViewModel {\n+\n+    private MutableLiveData<IntervalStatistics> intervalStats;\n+    private IntervalOption interval;\n+\n+    public IntervalStatisticsModel(@NonNull Application application) {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYyNTU2Ng==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475625566", "bodyText": "AndroidViewModel needs Application (when I call super(application)).", "author": "rgmf", "createdAt": "2020-08-24T13:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0OTE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0OTU4OQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475249589", "bodyText": "What is the benefit of using a method?\nI would also argue that we should fail immediately rather than returning a default option.\n   IntervalOption.values();", "author": "dennisguse", "createdAt": "2020-08-23T18:21:16Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatisticsModel.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.content.Context;\n+\n+import androidx.annotation.NonNull;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+/**\n+ * This view model is used to load intervals for a track.\n+ * It uses a default interval but it can be set from outside to manage the interval length.\n+ */\n+public class IntervalStatisticsModel extends AndroidViewModel {\n+\n+    private MutableLiveData<IntervalStatistics> intervalStats;\n+    private IntervalOption interval;\n+\n+    public IntervalStatisticsModel(@NonNull Application application) {\n+        super(application);\n+        interval = IntervalOption.OPTION_1;\n+    }\n+\n+    public LiveData<IntervalStatistics> getIntervalStats(Track.Id trackId, IntervalOption interval) {\n+        if (intervalStats == null || this.interval != interval) {\n+            intervalStats = new MutableLiveData<>();\n+            this.interval = interval;\n+            loadIntervalStats(trackId);\n+        }\n+        return intervalStats;\n+    }\n+\n+    public LiveData<IntervalStatistics> getIntervalStats(Track.Id trackId) {\n+        return getIntervalStats(trackId, interval);\n+    }\n+\n+    /**\n+     * Call this method when you want to force the view model to re-load intervals.\n+     */\n+    public void invalidate() {\n+        intervalStats = null;\n+    }\n+\n+    private void loadIntervalStats(Track.Id trackId) {\n+        new Thread(() -> {\n+            Context context = getApplication().getApplicationContext();\n+            ContentProviderUtils contentProviderUtils = new ContentProviderUtils(context);\n+            List<TrackPoint> trackPointList = contentProviderUtils.getTrackPoints(trackId);\n+\n+            IntervalStatistics intervalStatistics = new IntervalStatistics();\n+            float distanceInterval = PreferencesUtils.isMetricUnits(context) ? (float) (interval.getValue() * UnitConversions.KM_TO_M) : (float) (interval.getValue() * UnitConversions.MI_TO_M);\n+            intervalStatistics.build(trackPointList, distanceInterval);\n+\n+            intervalStats.postValue(intervalStatistics);\n+        }).start();\n+    }\n+\n+    /**\n+     * Intervals length this view model support.\n+     */\n+    public enum IntervalOption {\n+        OPTION_1(1),\n+        OPTION_2(2),\n+        OPTION_3(3),\n+        OPTION_4(4),\n+        OPTION_5(5),\n+        OPTION_10(10),\n+        OPTION_20(20),\n+        OPTION_50(50);\n+\n+        private int value;\n+\n+        IntervalOption(int value) {\n+            this.value = value;\n+        }\n+\n+        /**\n+         * @param pos position of the interval option.\n+         * @return    the interval option that is in the position pos.\n+         */\n+        public static IntervalOption getIntervalOption(int pos) {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzMDQ3OA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475630478", "bodyText": "The benefit of using the method was not to fail immediately. I've removed it then ;)", "author": "rgmf", "createdAt": "2020-08-24T13:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0OTU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0OTc0OQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475249749", "bodyText": "either static methods first or at the end.", "author": "dennisguse", "createdAt": "2020-08-23T18:23:02Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatisticsModel.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.content.Context;\n+\n+import androidx.annotation.NonNull;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+/**\n+ * This view model is used to load intervals for a track.\n+ * It uses a default interval but it can be set from outside to manage the interval length.\n+ */\n+public class IntervalStatisticsModel extends AndroidViewModel {\n+\n+    private MutableLiveData<IntervalStatistics> intervalStats;\n+    private IntervalOption interval;\n+\n+    public IntervalStatisticsModel(@NonNull Application application) {\n+        super(application);\n+        interval = IntervalOption.OPTION_1;\n+    }\n+\n+    public LiveData<IntervalStatistics> getIntervalStats(Track.Id trackId, IntervalOption interval) {\n+        if (intervalStats == null || this.interval != interval) {\n+            intervalStats = new MutableLiveData<>();\n+            this.interval = interval;\n+            loadIntervalStats(trackId);\n+        }\n+        return intervalStats;\n+    }\n+\n+    public LiveData<IntervalStatistics> getIntervalStats(Track.Id trackId) {\n+        return getIntervalStats(trackId, interval);\n+    }\n+\n+    /**\n+     * Call this method when you want to force the view model to re-load intervals.\n+     */\n+    public void invalidate() {\n+        intervalStats = null;\n+    }\n+\n+    private void loadIntervalStats(Track.Id trackId) {\n+        new Thread(() -> {\n+            Context context = getApplication().getApplicationContext();\n+            ContentProviderUtils contentProviderUtils = new ContentProviderUtils(context);\n+            List<TrackPoint> trackPointList = contentProviderUtils.getTrackPoints(trackId);\n+\n+            IntervalStatistics intervalStatistics = new IntervalStatistics();\n+            float distanceInterval = PreferencesUtils.isMetricUnits(context) ? (float) (interval.getValue() * UnitConversions.KM_TO_M) : (float) (interval.getValue() * UnitConversions.MI_TO_M);\n+            intervalStatistics.build(trackPointList, distanceInterval);\n+\n+            intervalStats.postValue(intervalStatistics);\n+        }).start();\n+    }\n+\n+    /**\n+     * Intervals length this view model support.\n+     */\n+    public enum IntervalOption {\n+        OPTION_1(1),\n+        OPTION_2(2),\n+        OPTION_3(3),\n+        OPTION_4(4),\n+        OPTION_5(5),\n+        OPTION_10(10),\n+        OPTION_20(20),\n+        OPTION_50(50);\n+\n+        private int value;\n+\n+        IntervalOption(int value) {\n+            this.value = value;\n+        }\n+\n+        /**\n+         * @param pos position of the interval option.\n+         * @return    the interval option that is in the position pos.\n+         */\n+        public static IntervalOption getIntervalOption(int pos) {\n+            if (values().length > pos) {\n+                return values()[pos];\n+            } else {\n+                return OPTION_1;\n+            }\n+        }\n+\n+        public int getValue() {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDIwOA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475250208", "bodyText": "This is just for to string conversion, right?\nIf yes, then I would move this functionality to the actual user of this function.\n        int[] a = {1};\n        Arrays.stream(a).mapToObj(String::valueOf).toArray(String[]::new);", "author": "dennisguse", "createdAt": "2020-08-23T18:27:52Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/IntervalStatisticsModel.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.content.Context;\n+\n+import androidx.annotation.NonNull;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.data.TrackPoint;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.util.UnitConversions;\n+\n+/**\n+ * This view model is used to load intervals for a track.\n+ * It uses a default interval but it can be set from outside to manage the interval length.\n+ */\n+public class IntervalStatisticsModel extends AndroidViewModel {\n+\n+    private MutableLiveData<IntervalStatistics> intervalStats;\n+    private IntervalOption interval;\n+\n+    public IntervalStatisticsModel(@NonNull Application application) {\n+        super(application);\n+        interval = IntervalOption.OPTION_1;\n+    }\n+\n+    public LiveData<IntervalStatistics> getIntervalStats(Track.Id trackId, IntervalOption interval) {\n+        if (intervalStats == null || this.interval != interval) {\n+            intervalStats = new MutableLiveData<>();\n+            this.interval = interval;\n+            loadIntervalStats(trackId);\n+        }\n+        return intervalStats;\n+    }\n+\n+    public LiveData<IntervalStatistics> getIntervalStats(Track.Id trackId) {\n+        return getIntervalStats(trackId, interval);\n+    }\n+\n+    /**\n+     * Call this method when you want to force the view model to re-load intervals.\n+     */\n+    public void invalidate() {\n+        intervalStats = null;\n+    }\n+\n+    private void loadIntervalStats(Track.Id trackId) {\n+        new Thread(() -> {\n+            Context context = getApplication().getApplicationContext();\n+            ContentProviderUtils contentProviderUtils = new ContentProviderUtils(context);\n+            List<TrackPoint> trackPointList = contentProviderUtils.getTrackPoints(trackId);\n+\n+            IntervalStatistics intervalStatistics = new IntervalStatistics();\n+            float distanceInterval = PreferencesUtils.isMetricUnits(context) ? (float) (interval.getValue() * UnitConversions.KM_TO_M) : (float) (interval.getValue() * UnitConversions.MI_TO_M);\n+            intervalStatistics.build(trackPointList, distanceInterval);\n+\n+            intervalStats.postValue(intervalStatistics);\n+        }).start();\n+    }\n+\n+    /**\n+     * Intervals length this view model support.\n+     */\n+    public enum IntervalOption {\n+        OPTION_1(1),\n+        OPTION_2(2),\n+        OPTION_3(3),\n+        OPTION_4(4),\n+        OPTION_5(5),\n+        OPTION_10(10),\n+        OPTION_20(20),\n+        OPTION_50(50);\n+\n+        private int value;\n+\n+        IntervalOption(int value) {\n+            this.value = value;\n+        }\n+\n+        /**\n+         * @param pos position of the interval option.\n+         * @return    the interval option that is in the position pos.\n+         */\n+        public static IntervalOption getIntervalOption(int pos) {\n+            if (values().length > pos) {\n+                return values()[pos];\n+            } else {\n+                return OPTION_1;\n+            }\n+        }\n+\n+        public int getValue() {\n+            return value;\n+        }\n+\n+        /**\n+         * @return a string array with all options.\n+         */\n+        public static String[] getAllValues() {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY1NjExMg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475656112", "bodyText": "Is this okay?\nReview this please:\nint[] intValues = Arrays.stream(IntervalStatisticsModel.IntervalOption.values()).mapToInt(i -> i.getValue()).toArray();\nspinnerIntervals.setAdapter(new ArrayAdapter<>(getContext(), android.R.layout.simple_spinner_dropdown_item, Arrays.stream(intValues).mapToObj(String::valueOf).toArray(String[]::new)));", "author": "rgmf", "createdAt": "2020-08-24T14:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5NDc5OQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475694799", "bodyText": "Why not?\nString[] values = Arrays.stream(IntervalStatisticsModel.IntervalOption.values()).mapToObj(String::valueOf).toArray(String[]::new))\nspinnerIntervals.setAdapter(new ArrayAdapter<>(getContext(), android.R.layout.simple_spinner_dropdown_item, values);", "author": "dennisguse", "createdAt": "2020-08-24T15:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwNjAzOA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475706038", "bodyText": "I didn't sure what you want was it.\nOkay, then \ud83d\udc4d", "author": "rgmf", "createdAt": "2020-08-24T15:36:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMTcyMg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475711722", "bodyText": "PS: Not tested ;)", "author": "dennisguse", "createdAt": "2020-08-24T15:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDMyOQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475250329", "bodyText": "Can we not use the content of the parent?\n(PS: don't know)", "author": "dennisguse", "createdAt": "2020-08-23T18:29:18Z", "path": "src/main/java/de/dennisguse/opentracks/views/IntervalListView.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package de.dennisguse.opentracks.views;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.view.View;\n+import android.widget.AdapterView;\n+import android.widget.ArrayAdapter;\n+import android.widget.LinearLayout;\n+import android.widget.Spinner;\n+import android.widget.TextView;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.adapters.IntervalStatisticsAdapter;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatisticsModel;\n+\n+/**\n+ * LinearLayout view used to build a list of intervals.\n+ * See {@link IntervalStatisticsAdapter}.\n+ */\n+public class IntervalListView extends LinearLayout {\n+\n+    protected IntervalStatisticsAdapter adapter;\n+    protected LinearLayout linearLayoutIntervals;\n+    protected Spinner spinnerIntervals;\n+    protected TextView spinnerIntervalsUnit;\n+\n+    protected Context context;\n+    protected IntervalListListener listener;\n+\n+    protected final SharedPreferences.OnSharedPreferenceChangeListener sharedPreferenceChangeListener = (preferences, key) -> {\n+        if (PreferencesUtils.isKey(getContext(), R.string.stats_units_key, key) || PreferencesUtils.isKey(getContext(), R.string.stats_rate_key, key)) {\n+            if (spinnerIntervalsUnit != null) {\n+                spinnerIntervalsUnit.setText(PreferencesUtils.isMetricUnits(context) ? context.getString(R.string.unit_kilometer) : context.getString(R.string.unit_mile));\n+            }\n+        }\n+    };\n+\n+    public IntervalListView(Context context, IntervalListListener listener) {\n+        super(context);\n+        this.context = context;", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY2MzgxNw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475663817", "bodyText": "Yes, we can use getContext(). Done.", "author": "rgmf", "createdAt": "2020-08-24T14:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDMzNA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475250334", "bodyText": "Why not put this into the constructor?", "author": "dennisguse", "createdAt": "2020-08-23T18:29:20Z", "path": "src/main/java/de/dennisguse/opentracks/views/IntervalListView.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package de.dennisguse.opentracks.views;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.view.View;\n+import android.widget.AdapterView;\n+import android.widget.ArrayAdapter;\n+import android.widget.LinearLayout;\n+import android.widget.Spinner;\n+import android.widget.TextView;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.adapters.IntervalStatisticsAdapter;\n+import de.dennisguse.opentracks.util.PreferencesUtils;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatisticsModel;\n+\n+/**\n+ * LinearLayout view used to build a list of intervals.\n+ * See {@link IntervalStatisticsAdapter}.\n+ */\n+public class IntervalListView extends LinearLayout {\n+\n+    protected IntervalStatisticsAdapter adapter;\n+    protected LinearLayout linearLayoutIntervals;\n+    protected Spinner spinnerIntervals;\n+    protected TextView spinnerIntervalsUnit;\n+\n+    protected Context context;\n+    protected IntervalListListener listener;\n+\n+    protected final SharedPreferences.OnSharedPreferenceChangeListener sharedPreferenceChangeListener = (preferences, key) -> {\n+        if (PreferencesUtils.isKey(getContext(), R.string.stats_units_key, key) || PreferencesUtils.isKey(getContext(), R.string.stats_rate_key, key)) {\n+            if (spinnerIntervalsUnit != null) {\n+                spinnerIntervalsUnit.setText(PreferencesUtils.isMetricUnits(context) ? context.getString(R.string.unit_kilometer) : context.getString(R.string.unit_mile));\n+            }\n+        }\n+    };\n+\n+    public IntervalListView(Context context, IntervalListListener listener) {\n+        super(context);\n+        this.context = context;\n+        this.listener = listener;\n+        PreferencesUtils.register(getContext(), sharedPreferenceChangeListener);\n+        init();\n+    }\n+\n+    protected void init() {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDQxNQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475250415", "bodyText": "Can move this into IntervalListView as a public static class?", "author": "dennisguse", "createdAt": "2020-08-23T18:30:02Z", "path": "src/main/java/de/dennisguse/opentracks/views/IntervalReverseListView.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package de.dennisguse.opentracks.views;\n+\n+import android.content.Context;\n+import android.view.View;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.adapters.IntervalStatisticsAdapter;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+\n+/**\n+ * LinearLayout view used to build a list of intervals in a reverse mode, the last one will appear in the first position on the LinearLayout.\n+ * This class is an specialization of {@link IntervalListView} that display the views contained in the LinearLayout in a reverse mode.\n+ */\n+public class IntervalReverseListView extends IntervalListView {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI1MDQ1OA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/368#discussion_r475250458", "bodyText": "if (intervalList == null) {\nreturn;\n}", "author": "dennisguse", "createdAt": "2020-08-23T18:30:31Z", "path": "src/main/java/de/dennisguse/opentracks/views/IntervalReverseListView.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package de.dennisguse.opentracks.views;\n+\n+import android.content.Context;\n+import android.view.View;\n+\n+import java.util.List;\n+\n+import de.dennisguse.opentracks.adapters.IntervalStatisticsAdapter;\n+import de.dennisguse.opentracks.viewmodels.IntervalStatistics;\n+\n+/**\n+ * LinearLayout view used to build a list of intervals in a reverse mode, the last one will appear in the first position on the LinearLayout.\n+ * This class is an specialization of {@link IntervalListView} that display the views contained in the LinearLayout in a reverse mode.\n+ */\n+public class IntervalReverseListView extends IntervalListView {\n+\n+    public IntervalReverseListView(Context context, IntervalListListener listener) {\n+        super(context, listener);\n+    }\n+\n+    public void display(List<IntervalStatistics.Interval> intervalList) {\n+        if (intervalList != null) {", "originalCommit": "7a865c3f0407b09f4be060eca1f487f4256243f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "99b59f5e28b59c0a8a7bb83b22c72fd88bf1c9a3", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/99b59f5e28b59c0a8a7bb83b22c72fd88bf1c9a3", "message": "Interval Stats: improve code and fixed some UI issues.", "committedDate": "2020-08-27T15:17:24Z", "type": "forcePushed"}, {"oid": "35e0f095b96c049ba42b7f1bd7749adda3977b36", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/35e0f095b96c049ba42b7f1bd7749adda3977b36", "message": "StatisticsRecordedFragment doesn't need TrackDataHub.\nTrackRecordedActivity saves Track object instead of track's id.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "818733cdc71fbccaa99eeefa1fe86138998b1990", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/818733cdc71fbccaa99eeefa1fe86138998b1990", "message": "Added intervals in StatisticsRecordedFragment with distance, speed and pace for all activity types.\nUsers can select the length of the interval (in a spinner with several options).\nThe intervals will be in km or mi depending on settings.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "15b04e05b9206a535e4d78096ad258fb1e17c8e9", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/15b04e05b9206a535e4d78096ad258fb1e17c8e9", "message": "Adjusted intervals.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "a74e38d0b09e114542b2722476c4a62209064a9f", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/a74e38d0b09e114542b2722476c4a62209064a9f", "message": "Interval statistics: show accumulate in distance column.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "35cedd3ee4a76d7b7d7c64796587253e414a0f25", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/35cedd3ee4a76d7b7d7c64796587253e414a0f25", "message": "Interval statistics: retain interval value after change orientation and recreation.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "2b9d860d2d9b4184e643cdb96557915a0eb7caad", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/2b9d860d2d9b4184e643cdb96557915a0eb7caad", "message": "Interval statistics: listen preferred units change (metric/imperial) and recreate intervals.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "6235ce75b4013877db2990fca8f9ba5e8e8bff9c", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/6235ce75b4013877db2990fca8f9ba5e8e8bff9c", "message": "Interval stats: improve code.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "d625702c6894f3b63a746ceb22a1a52b98f06e81", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/d625702c6894f3b63a746ceb22a1a52b98f06e81", "message": "Interval stats: added a new tab in TrackRecordingActivity that shows the intervals on live.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "6b27fd0377a960c7c1225dbda47b5ab3700b3283", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/6b27fd0377a960c7c1225dbda47b5ab3700b3283", "message": "Interval stats: added IntervalStatisticsTest.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "fc405c050d72319210152db87d00206059547f5e", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/fc405c050d72319210152db87d00206059547f5e", "message": "Interval stats: while user is recording a track intervals are refreshed every 5 seconds.\nInterval stats: completed the list of split intervals: 1, 2, 3, 4, 5, 10, 20 or 50 km or mi.\nFixes #87.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "099e390af69ca077f0ac9d56c2092a65e7d52d5f", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/099e390af69ca077f0ac9d56c2092a65e7d52d5f", "message": "Interval Stats: track's id it's not long anymore.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "99b59f5e28b59c0a8a7bb83b22c72fd88bf1c9a3", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/99b59f5e28b59c0a8a7bb83b22c72fd88bf1c9a3", "message": "Interval Stats: improve code and fixed some UI issues.", "committedDate": "2020-08-27T15:17:24Z", "type": "commit"}, {"oid": "a6d55664745744e56706e654d793ffd0837114dc", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/a6d55664745744e56706e654d793ffd0837114dc", "message": "Announcement: while recording report current interval pace or speed.\nFixes #134.", "committedDate": "2020-08-28T07:42:07Z", "type": "commit"}, {"oid": "c70996e6df0cceeb712db0137913cc89ff064760", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/c70996e6df0cceeb712db0137913cc89ff064760", "message": "New style for spinner with text.", "committedDate": "2020-08-28T14:06:59Z", "type": "commit"}, {"oid": "fb13fe402de897034f8ddf25b71b5e710cf1c99c", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/fb13fe402de897034f8ddf25b71b5e710cf1c99c", "message": "Interval Stats: use a tab for recorded tracks as well.", "committedDate": "2020-09-01T21:58:31Z", "type": "commit"}, {"oid": "fb13fe402de897034f8ddf25b71b5e710cf1c99c", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/fb13fe402de897034f8ddf25b71b5e710cf1c99c", "message": "Interval Stats: use a tab for recorded tracks as well.", "committedDate": "2020-09-01T21:58:31Z", "type": "forcePushed"}]}