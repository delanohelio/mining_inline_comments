{"pr_number": 532, "pr_title": "Refactoring MarkerEditActivity. Logic has been moved to a ViewModel.", "pr_createdAt": "2020-11-25T19:54:55Z", "pr_url": "https://github.com/OpenTracksApp/OpenTracks/pull/532", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTM1Ng==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r536899356", "bodyText": "Not needed; directly set = 0 in line 58 instead of -1", "author": "dennisguse", "createdAt": "2020-12-05T21:52:00Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/MarkerEditViewModel.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.net.Uri;\n+import android.os.ParcelFileDescriptor;\n+import android.util.Log;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.io.File;\n+import java.io.FileDescriptor;\n+import java.util.NoSuchElementException;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.content.data.Marker;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.services.TrackRecordingServiceConnection;\n+import de.dennisguse.opentracks.util.FileUtils;\n+\n+public class MarkerEditViewModel extends AndroidViewModel {\n+\n+    private static final String TAG = MarkerEditViewModel.class.getSimpleName();\n+\n+    private MutableLiveData<Marker> markerData;\n+    private boolean isNewMarker;\n+    private Uri photoOriginalUri;\n+    private final TrackRecordingServiceConnection trackRecordingServiceConnection = new TrackRecordingServiceConnection();\n+\n+    public MarkerEditViewModel(@NonNull Application application) {\n+        super(application);\n+    }\n+\n+    public LiveData<Marker> getMarkerData(@NonNull Track.Id trackId, @Nullable Marker.Id markerId) {\n+        if (markerData == null) {\n+            markerData = new MutableLiveData<>();\n+            trackRecordingServiceConnection.startConnection(getApplication());\n+            loadData(trackId, markerId);\n+        }\n+        return markerData;\n+    }\n+\n+    @Override\n+    protected void onCleared() {\n+        super.onCleared();\n+        trackRecordingServiceConnection.unbind(getApplication());\n+    }\n+\n+    private void loadData(Track.Id trackId, Marker.Id markerId) {\n+        Marker marker;\n+        isNewMarker = markerId == null;\n+        if (isNewMarker) {\n+            int nextMarkerNumber = trackId == null ? -1 : new ContentProviderUtils(getApplication()).getNextMarkerNumber(trackId);\n+            if (nextMarkerNumber == -1) {", "originalCommit": "249b2240c7fbc67f4936a711b250024203e602e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTQ5Mw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r536899493", "bodyText": "Should already be null", "author": "dennisguse", "createdAt": "2020-12-05T21:52:45Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/MarkerEditViewModel.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.net.Uri;\n+import android.os.ParcelFileDescriptor;\n+import android.util.Log;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.io.File;\n+import java.io.FileDescriptor;\n+import java.util.NoSuchElementException;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.content.data.Marker;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.services.TrackRecordingServiceConnection;\n+import de.dennisguse.opentracks.util.FileUtils;\n+\n+public class MarkerEditViewModel extends AndroidViewModel {\n+\n+    private static final String TAG = MarkerEditViewModel.class.getSimpleName();\n+\n+    private MutableLiveData<Marker> markerData;\n+    private boolean isNewMarker;\n+    private Uri photoOriginalUri;\n+    private final TrackRecordingServiceConnection trackRecordingServiceConnection = new TrackRecordingServiceConnection();\n+\n+    public MarkerEditViewModel(@NonNull Application application) {\n+        super(application);\n+    }\n+\n+    public LiveData<Marker> getMarkerData(@NonNull Track.Id trackId, @Nullable Marker.Id markerId) {\n+        if (markerData == null) {\n+            markerData = new MutableLiveData<>();\n+            trackRecordingServiceConnection.startConnection(getApplication());\n+            loadData(trackId, markerId);\n+        }\n+        return markerData;\n+    }\n+\n+    @Override\n+    protected void onCleared() {\n+        super.onCleared();\n+        trackRecordingServiceConnection.unbind(getApplication());\n+    }\n+\n+    private void loadData(Track.Id trackId, Marker.Id markerId) {\n+        Marker marker;\n+        isNewMarker = markerId == null;\n+        if (isNewMarker) {\n+            int nextMarkerNumber = trackId == null ? -1 : new ContentProviderUtils(getApplication()).getNextMarkerNumber(trackId);\n+            if (nextMarkerNumber == -1) {\n+                nextMarkerNumber = 0;\n+            }\n+            marker = new Marker(trackId);\n+            marker.setId(markerId);", "originalCommit": "249b2240c7fbc67f4936a711b250024203e602e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTkyMQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r536899921", "bodyText": "Very similar to line 173-176: can we somehow combine this?", "author": "dennisguse", "createdAt": "2020-12-05T21:55:49Z", "path": "src/main/java/de/dennisguse/opentracks/MarkerEditActivity.java", "diffHunk": "@@ -246,26 +160,20 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                 Toast.makeText(this, R.string.marker_add_photo_canceled, Toast.LENGTH_LONG).show();\n                 return;\n             } else if (resultCode == RESULT_OK) {\n-                setMarkerImageView(photoUri);\n+                viewModel.onNewCameraPhoto(cameraPhotoUri,", "originalCommit": "249b2240c7fbc67f4936a711b250024203e602e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA2ODU1Mw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r537068553", "bodyText": "I cannot to figure out how. Because the URI comes from different places depending on the photo's source: camera or gallery.", "author": "rgmf", "createdAt": "2020-12-06T16:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTkyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEyNTQ2OA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r537125468", "bodyText": "We can just assign the URI to a variable and the later use it.\nUri a = null;\nif (resultCode == RESULT_OK) {\n  a = xxx;\n} else {\n  a = zzz;\n}\n                viewModel.onNewGalleryPhoto(a,\n                        viewBinding.markerEditName.getText().toString(),\n                        viewBinding.markerEditMarkerType.getText().toString(),\n                        viewBinding.markerEditDescription.getText().toString());", "author": "dennisguse", "createdAt": "2020-12-06T21:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTkyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEyNzcyNw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r537127727", "bodyText": "Yes, but ViewModel have two methods onNewGalleryPhoto and onNewCameraPhoto because camera URI's photo is ready but gallery URI's photo need to be copied to internal OT storage.\nI don't know if I'm missing something...", "author": "rgmf", "createdAt": "2020-12-06T21:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTkyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDEwMw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r536900103", "bodyText": "getMarker() instead?\nIf you want to make sure that the exception is properly recognized, we could use getMarker() throws NoSuchElementException (if needed).", "author": "dennisguse", "createdAt": "2020-12-05T21:57:01Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/MarkerEditViewModel.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.net.Uri;\n+import android.os.ParcelFileDescriptor;\n+import android.util.Log;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.io.File;\n+import java.io.FileDescriptor;\n+import java.util.NoSuchElementException;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.content.data.Marker;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.services.TrackRecordingServiceConnection;\n+import de.dennisguse.opentracks.util.FileUtils;\n+\n+public class MarkerEditViewModel extends AndroidViewModel {\n+\n+    private static final String TAG = MarkerEditViewModel.class.getSimpleName();\n+\n+    private MutableLiveData<Marker> markerData;\n+    private boolean isNewMarker;\n+    private Uri photoOriginalUri;\n+    private final TrackRecordingServiceConnection trackRecordingServiceConnection = new TrackRecordingServiceConnection();\n+\n+    public MarkerEditViewModel(@NonNull Application application) {\n+        super(application);\n+    }\n+\n+    public LiveData<Marker> getMarkerData(@NonNull Track.Id trackId, @Nullable Marker.Id markerId) {\n+        if (markerData == null) {\n+            markerData = new MutableLiveData<>();\n+            trackRecordingServiceConnection.startConnection(getApplication());\n+            loadData(trackId, markerId);\n+        }\n+        return markerData;\n+    }\n+\n+    @Override\n+    protected void onCleared() {\n+        super.onCleared();\n+        trackRecordingServiceConnection.unbind(getApplication());\n+    }\n+\n+    private void loadData(Track.Id trackId, Marker.Id markerId) {\n+        Marker marker;\n+        isNewMarker = markerId == null;\n+        if (isNewMarker) {\n+            int nextMarkerNumber = trackId == null ? -1 : new ContentProviderUtils(getApplication()).getNextMarkerNumber(trackId);\n+            if (nextMarkerNumber == -1) {\n+                nextMarkerNumber = 0;\n+            }\n+            marker = new Marker(trackId);\n+            marker.setId(markerId);\n+            marker.setName(getApplication().getString(R.string.marker_name_format, nextMarkerNumber));\n+        } else {\n+            marker = new ContentProviderUtils(getApplication()).getMarker(markerId);\n+            if (marker.hasPhoto()) {\n+                photoOriginalUri = marker.getPhotoURI();\n+            }\n+        }\n+        markerData.postValue(marker);\n+    }\n+\n+    private Marker getMarkerOrThrowException() {", "originalCommit": "249b2240c7fbc67f4936a711b250024203e602e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDIxNQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r536900215", "bodyText": "Also private @NonNull Marker getMarker()", "author": "dennisguse", "createdAt": "2020-12-05T21:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDQzOQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r536900439", "bodyText": "Log.e(TAG, \"Failed to get picture from gallery URI: \" + e.getMessage());\nalso catch exception already in line 120?\nLine 121-125 cannot produce this.", "author": "dennisguse", "createdAt": "2020-12-05T21:59:23Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/MarkerEditViewModel.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.net.Uri;\n+import android.os.ParcelFileDescriptor;\n+import android.util.Log;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.io.File;\n+import java.io.FileDescriptor;\n+import java.util.NoSuchElementException;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.content.data.Marker;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.services.TrackRecordingServiceConnection;\n+import de.dennisguse.opentracks.util.FileUtils;\n+\n+public class MarkerEditViewModel extends AndroidViewModel {\n+\n+    private static final String TAG = MarkerEditViewModel.class.getSimpleName();\n+\n+    private MutableLiveData<Marker> markerData;\n+    private boolean isNewMarker;\n+    private Uri photoOriginalUri;\n+    private final TrackRecordingServiceConnection trackRecordingServiceConnection = new TrackRecordingServiceConnection();\n+\n+    public MarkerEditViewModel(@NonNull Application application) {\n+        super(application);\n+    }\n+\n+    public LiveData<Marker> getMarkerData(@NonNull Track.Id trackId, @Nullable Marker.Id markerId) {\n+        if (markerData == null) {\n+            markerData = new MutableLiveData<>();\n+            trackRecordingServiceConnection.startConnection(getApplication());\n+            loadData(trackId, markerId);\n+        }\n+        return markerData;\n+    }\n+\n+    @Override\n+    protected void onCleared() {\n+        super.onCleared();\n+        trackRecordingServiceConnection.unbind(getApplication());\n+    }\n+\n+    private void loadData(Track.Id trackId, Marker.Id markerId) {\n+        Marker marker;\n+        isNewMarker = markerId == null;\n+        if (isNewMarker) {\n+            int nextMarkerNumber = trackId == null ? -1 : new ContentProviderUtils(getApplication()).getNextMarkerNumber(trackId);\n+            if (nextMarkerNumber == -1) {\n+                nextMarkerNumber = 0;\n+            }\n+            marker = new Marker(trackId);\n+            marker.setId(markerId);\n+            marker.setName(getApplication().getString(R.string.marker_name_format, nextMarkerNumber));\n+        } else {\n+            marker = new ContentProviderUtils(getApplication()).getMarker(markerId);\n+            if (marker.hasPhoto()) {\n+                photoOriginalUri = marker.getPhotoURI();\n+            }\n+        }\n+        markerData.postValue(marker);\n+    }\n+\n+    private Marker getMarkerOrThrowException() {\n+        Marker marker = markerData != null ? markerData.getValue() : null;\n+        if (marker == null) {\n+            Log.d(TAG, \"Marker data shouldn't be null. Call getMarkerData before.\");\n+            throw new NoSuchElementException(\"Marker data shouldn't be null. Call getMarkerData before.\");\n+        }\n+\n+        return marker;\n+    }\n+\n+    private void deletePhoto(Uri photoUri) {\n+        File photoFile = FileUtils.getPhotoFileIfExists(getApplication(), markerData.getValue().getTrackId(), photoUri);\n+        FileUtils.deleteDirectoryRecurse(photoFile);\n+    }\n+\n+    public void onPhotoDelete(String name, String category, String description) {\n+        Marker marker =  getMarkerOrThrowException();\n+        if (marker.hasPhoto()) {\n+            if (!marker.getPhotoURI().equals(photoOriginalUri)) {\n+                deletePhoto(marker.getPhotoURI());\n+            }\n+            marker.setPhotoUrl(null);\n+            marker.setName(name);\n+            marker.setCategory(category);\n+            marker.setDescription(description);\n+            markerData.postValue(marker);\n+        }\n+    }\n+\n+    public void onNewCameraPhoto(@NonNull Uri photoUri, String name, String category, String description) {\n+        Marker marker =  getMarkerOrThrowException();\n+        marker.setPhotoUrl(photoUri.toString());\n+        marker.setName(name);\n+        marker.setCategory(category);\n+        marker.setDescription(description);\n+        markerData.postValue(marker);\n+    }\n+\n+    public void onNewGalleryPhoto(@NonNull Uri srcUri, String name, String category, String description) {\n+        Marker marker =  getMarkerOrThrowException();\n+\n+        try (ParcelFileDescriptor parcelFd = getApplication().getContentResolver().openFileDescriptor(srcUri, \"r\")) {\n+            FileDescriptor srcFd = parcelFd.getFileDescriptor();\n+            File dstFile = new File(FileUtils.getImageUrl(getApplication(), marker.getTrackId()));\n+            FileUtils.copy(srcFd, dstFile);\n+\n+            Uri photoUri = FileUtils.getUriForFile(getApplication(), dstFile);\n+            marker.setPhotoUrl(photoUri.toString());\n+            marker.setName(name);\n+            marker.setCategory(category);\n+            marker.setDescription(description);\n+            markerData.postValue(marker);\n+        } catch(Exception e) {\n+            Log.e(TAG, e.getMessage());", "originalCommit": "249b2240c7fbc67f4936a711b250024203e602e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA1OTg0NA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r537059844", "bodyText": "I don't understand... That code is basically was moved from MarkerEditActivity to here.", "author": "rgmf", "createdAt": "2020-12-06T15:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDQzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEyNDkxNw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r537124917", "bodyText": "Doesn't mean that the code is good ;)\nI meant that catching the exception should be done at the place it occurs - I guess might occur in some of these calls:\n            FileDescriptor srcFd = parcelFd.getFileDescriptor();\n            File dstFile = new File(FileUtils.getImageUrl(getApplication(), marker.getTrackId()));\n            FileUtils.copy(srcFd, dstFile);\n\n            Uri photoUri = FileUtils.getUriForFile(getApplication(), dstFile);\n\nThe marker.XXX calls should not do this, so they should be out of the catch.", "author": "dennisguse", "createdAt": "2020-12-06T21:14:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDQzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEyODI5Nw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r537128297", "bodyText": "Okay :D", "author": "rgmf", "createdAt": "2020-12-06T21:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDgyNw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r536900827", "bodyText": "Somehow relatively complicated (or it is too late).\nIs it possible that multiple if's are valid?", "author": "dennisguse", "createdAt": "2020-12-05T22:02:00Z", "path": "src/main/java/de/dennisguse/opentracks/viewmodels/MarkerEditViewModel.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package de.dennisguse.opentracks.viewmodels;\n+\n+import android.app.Application;\n+import android.net.Uri;\n+import android.os.ParcelFileDescriptor;\n+import android.util.Log;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.lifecycle.AndroidViewModel;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+import java.io.File;\n+import java.io.FileDescriptor;\n+import java.util.NoSuchElementException;\n+\n+import de.dennisguse.opentracks.R;\n+import de.dennisguse.opentracks.content.data.Marker;\n+import de.dennisguse.opentracks.content.data.Track;\n+import de.dennisguse.opentracks.content.provider.ContentProviderUtils;\n+import de.dennisguse.opentracks.services.TrackRecordingServiceConnection;\n+import de.dennisguse.opentracks.util.FileUtils;\n+\n+public class MarkerEditViewModel extends AndroidViewModel {\n+\n+    private static final String TAG = MarkerEditViewModel.class.getSimpleName();\n+\n+    private MutableLiveData<Marker> markerData;\n+    private boolean isNewMarker;\n+    private Uri photoOriginalUri;\n+    private final TrackRecordingServiceConnection trackRecordingServiceConnection = new TrackRecordingServiceConnection();\n+\n+    public MarkerEditViewModel(@NonNull Application application) {\n+        super(application);\n+    }\n+\n+    public LiveData<Marker> getMarkerData(@NonNull Track.Id trackId, @Nullable Marker.Id markerId) {\n+        if (markerData == null) {\n+            markerData = new MutableLiveData<>();\n+            trackRecordingServiceConnection.startConnection(getApplication());\n+            loadData(trackId, markerId);\n+        }\n+        return markerData;\n+    }\n+\n+    @Override\n+    protected void onCleared() {\n+        super.onCleared();\n+        trackRecordingServiceConnection.unbind(getApplication());\n+    }\n+\n+    private void loadData(Track.Id trackId, Marker.Id markerId) {\n+        Marker marker;\n+        isNewMarker = markerId == null;\n+        if (isNewMarker) {\n+            int nextMarkerNumber = trackId == null ? -1 : new ContentProviderUtils(getApplication()).getNextMarkerNumber(trackId);\n+            if (nextMarkerNumber == -1) {\n+                nextMarkerNumber = 0;\n+            }\n+            marker = new Marker(trackId);\n+            marker.setId(markerId);\n+            marker.setName(getApplication().getString(R.string.marker_name_format, nextMarkerNumber));\n+        } else {\n+            marker = new ContentProviderUtils(getApplication()).getMarker(markerId);\n+            if (marker.hasPhoto()) {\n+                photoOriginalUri = marker.getPhotoURI();\n+            }\n+        }\n+        markerData.postValue(marker);\n+    }\n+\n+    private Marker getMarkerOrThrowException() {\n+        Marker marker = markerData != null ? markerData.getValue() : null;\n+        if (marker == null) {\n+            Log.d(TAG, \"Marker data shouldn't be null. Call getMarkerData before.\");\n+            throw new NoSuchElementException(\"Marker data shouldn't be null. Call getMarkerData before.\");\n+        }\n+\n+        return marker;\n+    }\n+\n+    private void deletePhoto(Uri photoUri) {\n+        File photoFile = FileUtils.getPhotoFileIfExists(getApplication(), markerData.getValue().getTrackId(), photoUri);\n+        FileUtils.deleteDirectoryRecurse(photoFile);\n+    }\n+\n+    public void onPhotoDelete(String name, String category, String description) {\n+        Marker marker =  getMarkerOrThrowException();\n+        if (marker.hasPhoto()) {\n+            if (!marker.getPhotoURI().equals(photoOriginalUri)) {\n+                deletePhoto(marker.getPhotoURI());\n+            }\n+            marker.setPhotoUrl(null);\n+            marker.setName(name);\n+            marker.setCategory(category);\n+            marker.setDescription(description);\n+            markerData.postValue(marker);\n+        }\n+    }\n+\n+    public void onNewCameraPhoto(@NonNull Uri photoUri, String name, String category, String description) {\n+        Marker marker =  getMarkerOrThrowException();\n+        marker.setPhotoUrl(photoUri.toString());\n+        marker.setName(name);\n+        marker.setCategory(category);\n+        marker.setDescription(description);\n+        markerData.postValue(marker);\n+    }\n+\n+    public void onNewGalleryPhoto(@NonNull Uri srcUri, String name, String category, String description) {\n+        Marker marker =  getMarkerOrThrowException();\n+\n+        try (ParcelFileDescriptor parcelFd = getApplication().getContentResolver().openFileDescriptor(srcUri, \"r\")) {\n+            FileDescriptor srcFd = parcelFd.getFileDescriptor();\n+            File dstFile = new File(FileUtils.getImageUrl(getApplication(), marker.getTrackId()));\n+            FileUtils.copy(srcFd, dstFile);\n+\n+            Uri photoUri = FileUtils.getUriForFile(getApplication(), dstFile);\n+            marker.setPhotoUrl(photoUri.toString());\n+            marker.setName(name);\n+            marker.setCategory(category);\n+            marker.setDescription(description);\n+            markerData.postValue(marker);\n+        } catch(Exception e) {\n+            Log.e(TAG, e.getMessage());\n+            Toast.makeText(getApplication(), R.string.marker_add_canceled, Toast.LENGTH_LONG).show();\n+        }\n+    }\n+\n+    private void onAddDone(@NonNull Marker marker, String name, String category, String description) {\n+        trackRecordingServiceConnection.addMarker(getApplication(), name, category, description, marker.hasPhoto() ? marker.getPhotoURI().toString() : null);\n+    }\n+\n+    private void onSaveDone(@NonNull Marker marker, String name, String category, String description) {\n+        marker.setName(name);\n+        marker.setCategory(category);\n+        marker.setDescription(description);\n+        new ContentProviderUtils(getApplication()).updateMarker(getApplication(), marker);\n+\n+        if (photoOriginalUri != null && (!marker.hasPhoto() || !photoOriginalUri.equals(marker.getPhotoURI()))) {\n+            deletePhoto(photoOriginalUri);\n+        }\n+    }\n+\n+    public void onDone(String name, String category, String description) {\n+        Marker marker = getMarkerOrThrowException();\n+        if (isNewMarker) {\n+            onAddDone(marker, name, category, description);\n+        } else {\n+            onSaveDone(marker, name, category, description);\n+        }\n+    }\n+\n+    public void onCancel() {\n+        Marker marker =  getMarkerOrThrowException();\n+        if (isNewMarker) {", "originalCommit": "249b2240c7fbc67f4936a711b250024203e602e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA2NDc3Mw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/532#discussion_r537064773", "bodyText": "Simplified...", "author": "rgmf", "createdAt": "2020-12-06T15:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDgyNw=="}], "type": "inlineReview"}, {"oid": "d86e6ba48f864e1fc6318d43e90cc33b9d5c7a28", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/d86e6ba48f864e1fc6318d43e90cc33b9d5c7a28", "message": "Just tiny changes.", "committedDate": "2020-12-06T21:37:40Z", "type": "forcePushed"}, {"oid": "6e295680e911f38d75356f641596874becddcb5e", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/6e295680e911f38d75356f641596874becddcb5e", "message": "Refactoring MarkerEditActivity. Logic has been moved to a ViewModel.", "committedDate": "2020-12-17T18:05:42Z", "type": "commit"}, {"oid": "597164c8132b400442532d39086c6ce89845875f", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/597164c8132b400442532d39086c6ce89845875f", "message": "Just tiny changes.", "committedDate": "2020-12-17T18:05:42Z", "type": "commit"}, {"oid": "597164c8132b400442532d39086c6ce89845875f", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/597164c8132b400442532d39086c6ce89845875f", "message": "Just tiny changes.", "committedDate": "2020-12-17T18:05:42Z", "type": "forcePushed"}]}