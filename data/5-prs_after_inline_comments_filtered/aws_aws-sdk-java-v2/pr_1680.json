{"pr_number": 1680, "pr_title": "dynamodb-enhanced: clean up QueryConditional, EnhancedGlobalSecondary\u2026", "pr_createdAt": "2020-03-03T21:41:43Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1680", "timeline": [{"oid": "a452c2d942bb8869fbae89bf6f561030c730d738", "url": "https://github.com/aws/aws-sdk-java-v2/commit/a452c2d942bb8869fbae89bf6f561030c730d738", "message": "dynamodb-enhanced: clean up QueryConditional, EnhancedGlobalSecondaryIndex, EnhancedLocalSecondaryIndex and Expression. Added missing javadocs", "committedDate": "2020-03-03T22:50:35Z", "type": "forcePushed"}, {"oid": "c5ac0e182eb3a1d2416dab816f741757f64b9592", "url": "https://github.com/aws/aws-sdk-java-v2/commit/c5ac0e182eb3a1d2416dab816f741757f64b9592", "message": "dynamodb-enhanced: clean up QueryConditional, EnhancedGlobalSecondaryIndex, EnhancedLocalSecondaryIndex and Expression. Added missing javadocs", "committedDate": "2020-03-03T22:51:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4Mzc2NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387383765", "bodyText": "Under which circumstances would someone use this method, as opposed to the coalesce method? Is this worth mentioning in the class description, or here?", "author": "cenedhryn", "createdAt": "2020-03-04T00:55:15Z", "path": "services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/Expression.java", "diffHunk": "@@ -36,28 +56,49 @@ private Expression(String expression,\n         this.expressionNames = expressionNames;\n     }\n \n+    /**\n+     * Constructs a new expression builder.\n+     * @return a new expression builder.\n+     */\n     public static Builder builder() {\n         return new Builder();\n     }\n \n-    public static Expression coalesce(Expression condition1, Expression condition2, String joinToken) {\n-        if (condition1 == null) {\n-            return condition2;\n+    /**\n+     * Coalesces two complete expressions into a single expression. The expression string will be joined using the \n+     * supplied join token, and the ExpressionNames and ExpressionValues maps will be merged.\n+     * @param expression1 The first expression to coalesce\n+     * @param expression2 The second expression to coalesce\n+     * @param joinToken The join token to be used to join the expression strings (e.g.: 'AND', 'OR')\n+     * @return The coalesced expression\n+     * @throws IllegalArgumentException if a conflict occurs when merging ExpressionNames or ExpressionValues\n+     */\n+    public static Expression coalesce(Expression expression1, Expression expression2, String joinToken) {\n+        if (expression1 == null) {\n+            return expression2;\n         }\n \n-        if (condition2 == null) {\n-            return condition1;\n+        if (expression2 == null) {\n+            return expression1;\n         }\n \n         return Expression.builder()\n-                         .expression(coalesceExpressions(condition1.expression, condition2.expression, joinToken))\n-                         .expressionValues(coalesceValues(condition1.expressionValues(),\n-                                                          condition2.expressionValues()))\n-                         .expressionNames(coalesceNames(condition1.expressionNames(),\n-                                                        condition2.expressionNames()))\n+                         .expression(coalesceExpressions(expression1.expression, expression2.expression, joinToken))\n+                         .expressionValues(coalesceValues(expression1.expressionValues(),\n+                                                          expression2.expressionValues()))\n+                         .expressionNames(coalesceNames(expression1.expressionNames(),\n+                                                        expression2.expressionNames()))\n                          .build();\n     }\n \n+    /**\n+     * Coalesces two expression strings into a single expression string. The expression string will be joined using the\n+     * supplied join token.\n+     * @param expression1 The first expression string to coalesce\n+     * @param expression2 The second expression string to coalesce\n+     * @param joinToken The join token to be used to join the expression strings (e.g.: 'AND', 'OR)\n+     * @return The coalesced expression\n+     */\n     public static String coalesceExpressions(String expression1, String expression2, String joinToken) {", "originalCommit": "c5ac0e182eb3a1d2416dab816f741757f64b9592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgxNzk2NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387817964", "bodyText": "They are used by some of the operations that need to perform complex expression manipulation (such as update). It is already mentioned in the class javadoc : 'In addition various convenience methods are provided to help manipulate expressions.'.", "author": "bmaizels", "createdAt": "2020-03-04T17:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4Mzc2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0MzU3OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387743578", "bodyText": "Typo: 'An' not 'In'", "author": "cenedhryn", "createdAt": "2020-03-04T15:31:20Z", "path": "services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/model/QueryConditional.java", "diffHunk": "@@ -15,443 +15,171 @@\n \n package software.amazon.awssdk.enhanced.dynamodb.model;\n \n-import static software.amazon.awssdk.enhanced.dynamodb.internal.AttributeValues.nullAttributeValue;\n-import static software.amazon.awssdk.enhanced.dynamodb.internal.EnhancedClientUtils.cleanAttributeName;\n-import static software.amazon.awssdk.enhanced.dynamodb.internal.EnhancedClientUtils.isNullAttributeValue;\n-\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Optional;\n import java.util.function.Consumer;\n-import java.util.function.UnaryOperator;\n \n import software.amazon.awssdk.annotations.SdkPublicApi;\n import software.amazon.awssdk.enhanced.dynamodb.Expression;\n import software.amazon.awssdk.enhanced.dynamodb.Key;\n import software.amazon.awssdk.enhanced.dynamodb.TableSchema;\n-import software.amazon.awssdk.services.dynamodb.model.AttributeValue;\n-\n+import software.amazon.awssdk.enhanced.dynamodb.internal.conditional.BeginsWithConditional;\n+import software.amazon.awssdk.enhanced.dynamodb.internal.conditional.BetweenConditional;\n+import software.amazon.awssdk.enhanced.dynamodb.internal.conditional.EqualToConditional;\n+import software.amazon.awssdk.enhanced.dynamodb.internal.conditional.SingleKeyItemConditional;\n+\n+/**\n+ * In interface for a literal conditional that can be used in an enhanced DynamoDB query. Contains convenient static", "originalCommit": "c5ac0e182eb3a1d2416dab816f741757f64b9592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgxODg2OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387818868", "bodyText": "Fixed in next rev", "author": "bmaizels", "createdAt": "2020-03-04T17:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0MzU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0NTM1Mw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387745353", "bodyText": "Nit: Could we have a punctuation at the end of this sentence?", "author": "cenedhryn", "createdAt": "2020-03-04T15:33:46Z", "path": "services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/model/QueryConditional.java", "diffHunk": "@@ -15,443 +15,171 @@\n \n package software.amazon.awssdk.enhanced.dynamodb.model;\n \n-import static software.amazon.awssdk.enhanced.dynamodb.internal.AttributeValues.nullAttributeValue;\n-import static software.amazon.awssdk.enhanced.dynamodb.internal.EnhancedClientUtils.cleanAttributeName;\n-import static software.amazon.awssdk.enhanced.dynamodb.internal.EnhancedClientUtils.isNullAttributeValue;\n-\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Optional;\n import java.util.function.Consumer;\n-import java.util.function.UnaryOperator;\n \n import software.amazon.awssdk.annotations.SdkPublicApi;\n import software.amazon.awssdk.enhanced.dynamodb.Expression;\n import software.amazon.awssdk.enhanced.dynamodb.Key;\n import software.amazon.awssdk.enhanced.dynamodb.TableSchema;\n-import software.amazon.awssdk.services.dynamodb.model.AttributeValue;\n-\n+import software.amazon.awssdk.enhanced.dynamodb.internal.conditional.BeginsWithConditional;\n+import software.amazon.awssdk.enhanced.dynamodb.internal.conditional.BetweenConditional;\n+import software.amazon.awssdk.enhanced.dynamodb.internal.conditional.EqualToConditional;\n+import software.amazon.awssdk.enhanced.dynamodb.internal.conditional.SingleKeyItemConditional;\n+\n+/**\n+ * In interface for a literal conditional that can be used in an enhanced DynamoDB query. Contains convenient static\n+ * methods that can be used to construct the most common conditional statements. Query conditionals are not linked to\n+ * any specific table or schema and can be re-used in different contexts.\n+ * <p>\n+ * Example:\n+ * {@code\n+ * QueryConditional partitionValueGreaterThanTen = QueryConditional.greaterThan(k -> k.partitionValue(10));\n+ * }\n+ */\n @SdkPublicApi\n-public abstract class QueryConditional {\n-    private static final UnaryOperator<String> EXPRESSION_KEY_MAPPER =\n-        key -> \"#AMZN_MAPPED_\" + cleanAttributeName(key);\n-    private static final UnaryOperator<String> EXPRESSION_VALUE_KEY_MAPPER =\n-        key -> \":AMZN_MAPPED_\" + cleanAttributeName(key);\n-    private static final UnaryOperator<String> EXPRESSION_OTHER_VALUE_KEY_MAPPER =\n-        key -> \":AMZN_MAPPED_\" + cleanAttributeName(key) + \"2\";\n-\n-    public static QueryConditional equalTo(Key key) {\n+public interface QueryConditional {\n+    /**\n+     * Creates a {@link QueryConditional} that matches when the key of an index is equal to a specific value", "originalCommit": "c5ac0e182eb3a1d2416dab816f741757f64b9592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgyMDMyMg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387820322", "bodyText": "Fixed in next rev", "author": "bmaizels", "createdAt": "2020-03-04T17:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0NTM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc1NjUxNA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387756514", "bodyText": "I find it a bit confusing that Expression is used in QueryConditionals and condition expressions, but ExpressionParameters are only used in QueryConditionals. Can we name this class to reflect its scope (I know that it's localized to the conditional package)? 'Parameters' is a vague name too. If we were super literal we could even call it 'KeysAndValues' on the same model as 'KeysAndAttributes'.", "author": "cenedhryn", "createdAt": "2020-03-04T15:49:45Z", "path": "services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/internal/conditional/ExpressionParameters.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.enhanced.dynamodb.internal.conditional;\n+\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.enhanced.dynamodb.Key;\n+import software.amazon.awssdk.enhanced.dynamodb.TableSchema;\n+import software.amazon.awssdk.services.dynamodb.model.AttributeValue;\n+\n+@SdkInternalApi\n+class ExpressionParameters {", "originalCommit": "c5ac0e182eb3a1d2416dab816f741757f64b9592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgyODYyMw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387828623", "bodyText": "It used to be an internal class, and it's really there as a struct that is used by the QueryConditional implementations to pass around key values without having loads of args. It's not designed to be given a larger scope than that. I've renamed it to something more appropriate and added a javadoc to ensure there's no confusion.", "author": "bmaizels", "createdAt": "2020-03-04T17:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc1NjUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2NDU3OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387764579", "bodyText": "While the other conditionals are named after what they do, this name is more abstract. Do we expect other operators here in the future than greater than/lesser than? If not, there is the mathematical term Inequality that encompasses these operators. It might be too specific/obscure though!", "author": "cenedhryn", "createdAt": "2020-03-04T16:01:12Z", "path": "services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/internal/conditional/SingleKeyItemConditional.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.enhanced.dynamodb.internal.conditional;\n+\n+import static software.amazon.awssdk.enhanced.dynamodb.internal.AttributeValues.nullAttributeValue;\n+import static software.amazon.awssdk.enhanced.dynamodb.internal.EnhancedClientUtils.cleanAttributeName;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.function.UnaryOperator;\n+\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.enhanced.dynamodb.Expression;\n+import software.amazon.awssdk.enhanced.dynamodb.Key;\n+import software.amazon.awssdk.enhanced.dynamodb.TableSchema;\n+import software.amazon.awssdk.enhanced.dynamodb.model.QueryConditional;\n+import software.amazon.awssdk.services.dynamodb.model.AttributeValue;\n+\n+@SdkInternalApi\n+public class SingleKeyItemConditional implements QueryConditional {", "originalCommit": "c5ac0e182eb3a1d2416dab816f741757f64b9592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgyNDQ2NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387824464", "bodyText": "Although referring to it as an 'inequality' conditional may be technically correct within the scope it is currently used, that is not the intention behind the class and so could be misleading and sort of missing the point. It's there so that it's easy to construct simple conditionals without duplicating a lot of code, equality could have been covered but wasn't for some reason I've forgotten (but I know I had one). I added a brief javadoc for the class.", "author": "bmaizels", "createdAt": "2020-03-04T17:36:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2NDU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg0Nzk3OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1680#discussion_r387847979", "bodyText": "I still think that the name is not quite consistent with the other conditionals, but I can't think of something better..", "author": "cenedhryn", "createdAt": "2020-03-04T18:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2NDU3OQ=="}], "type": "inlineReview"}, {"oid": "2e32a343d8d7931a458bc817fae7b7c617fa3528", "url": "https://github.com/aws/aws-sdk-java-v2/commit/2e32a343d8d7931a458bc817fae7b7c617fa3528", "message": "dynamodb-enhanced: clean up QueryConditional, EnhancedGlobalSecondaryIndex, EnhancedLocalSecondaryIndex and Expression. Added missing javadocs", "committedDate": "2020-03-04T17:46:40Z", "type": "forcePushed"}, {"oid": "3091c3688cad2cba3491c5283053e097a9503d64", "url": "https://github.com/aws/aws-sdk-java-v2/commit/3091c3688cad2cba3491c5283053e097a9503d64", "message": "dynamodb-enhanced: clean up QueryConditional, EnhancedGlobalSecondaryIndex, EnhancedLocalSecondaryIndex and Expression. Added missing javadocs", "committedDate": "2020-03-04T18:30:22Z", "type": "forcePushed"}, {"oid": "b563acb29362389ec55e9fdebbedf255dcd15b91", "url": "https://github.com/aws/aws-sdk-java-v2/commit/b563acb29362389ec55e9fdebbedf255dcd15b91", "message": "dynamodb-enhanced: clean up QueryConditional, EnhancedGlobalSecondaryIndex, EnhancedLocalSecondaryIndex and Expression. Added missing javadocs", "committedDate": "2020-03-04T20:20:40Z", "type": "commit"}, {"oid": "b563acb29362389ec55e9fdebbedf255dcd15b91", "url": "https://github.com/aws/aws-sdk-java-v2/commit/b563acb29362389ec55e9fdebbedf255dcd15b91", "message": "dynamodb-enhanced: clean up QueryConditional, EnhancedGlobalSecondaryIndex, EnhancedLocalSecondaryIndex and Expression. Added missing javadocs", "committedDate": "2020-03-04T20:20:40Z", "type": "forcePushed"}, {"oid": "7d174e5c40471677b8ebda7950a10be056b492b9", "url": "https://github.com/aws/aws-sdk-java-v2/commit/7d174e5c40471677b8ebda7950a10be056b492b9", "message": "Merge branch 'master' into bmaizels/dynamodb-enhanced-cleanup", "committedDate": "2020-03-04T21:03:56Z", "type": "commit"}]}