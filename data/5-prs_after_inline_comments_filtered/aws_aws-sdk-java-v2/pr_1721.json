{"pr_number": 1721, "pr_title": "Log signed event for easier debugging", "pr_createdAt": "2020-03-17T21:22:02Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1721", "timeline": [{"oid": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce", "url": "https://github.com/aws/aws-sdk-java-v2/commit/cb34fc80876e356ac6a9796751c4df2f9b8eb6ce", "message": "Log signed event for easier debugging\n\nIn case of future bugs related to event stream signing, this should help in\ndebuggging to see the contents of the message in an easier to read format.", "committedDate": "2020-03-17T21:31:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMjYwOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394002609", "bodyText": "Log4j2 docs suggest we could use logger.isTraceEnabled() here? Might be slightly better than passing a string", "author": "bmaizels", "createdAt": "2020-03-17T22:18:00Z", "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -160,6 +161,13 @@ public ByteBuffer apply(ByteBuffer byteBuffer) {\n                  * Encode signed event to byte\n                  */\n                 Message signedMessage = new Message(sortHeaders(headers), payload);\n+\n+                if (LOG.isLoggingLevelEnabled(\"trace\")) {", "originalCommit": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMzA1Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394003052", "bodyText": "another approach is to use LOG.printf(.... which allows you to dynamically set the log level which means that theoretically you could do all this in a single line without having an if statement.", "author": "bmaizels", "createdAt": "2020-03-17T22:19:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMjYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNTY0MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394005641", "bodyText": "This is our software.amazon.awssdk.utils.Logger not Log4j's", "author": "dagnir", "createdAt": "2020-03-17T22:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMjYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNzEzMQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394007131", "bodyText": "Ahh ok nevermind then. I assume we don't have a similar method then?", "author": "bmaizels", "createdAt": "2020-03-17T22:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMjYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAxMjQ1OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394012458", "bodyText": "Not currently", "author": "dagnir", "createdAt": "2020-03-17T22:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMjYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMzY5Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394003696", "bodyText": "why not do this with some kind of stream thing?", "author": "bmaizels", "createdAt": "2020-03-17T22:20:46Z", "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -259,4 +267,35 @@ public void subscribe(Subscriber<? super ByteBuffer> s) {\n             return transformedRequestBody.contentLength();\n         }\n     }\n+\n+    private static String toDebugString(Message m, boolean truncatePayload) {\n+        StringBuilder sb = new StringBuilder(\"Message = {headers={\");\n+        Map<String, HeaderValue> headers = m.getHeaders();\n+\n+        Iterator<Map.Entry<String, HeaderValue>> headersIter = headers.entrySet().iterator();\n+\n+        while (headersIter.hasNext()) {", "originalCommit": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNTkxMA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394005910", "bodyText": "I found it easier to use this while working with the string builder. I can change it if it's a blocker for you", "author": "dagnir", "createdAt": "2020-03-17T22:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMzY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNzMyMA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394007320", "bodyText": "No not a blocker, just a nit. You can ignore.", "author": "bmaizels", "createdAt": "2020-03-17T22:29:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMzY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDA5Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394004092", "bodyText": "Could payload.length be 0? what happens then?", "author": "bmaizels", "createdAt": "2020-03-17T22:21:43Z", "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -259,4 +267,35 @@ public void subscribe(Subscriber<? super ByteBuffer> s) {\n             return transformedRequestBody.contentLength();\n         }\n     }\n+\n+    private static String toDebugString(Message m, boolean truncatePayload) {\n+        StringBuilder sb = new StringBuilder(\"Message = {headers={\");\n+        Map<String, HeaderValue> headers = m.getHeaders();\n+\n+        Iterator<Map.Entry<String, HeaderValue>> headersIter = headers.entrySet().iterator();\n+\n+        while (headersIter.hasNext()) {\n+            Map.Entry<String, HeaderValue> h = headersIter.next();\n+\n+            sb.append(h.getKey()).append(\"={\").append(h.getValue().toString()).append(\"}\");\n+\n+            if (headersIter.hasNext()) {\n+                sb.append(\", \");\n+            }\n+        }\n+\n+        sb.append(\"}, payload=\");\n+\n+        byte[] payload = m.getPayload();\n+\n+        byte[] payloadToLog;\n+        if (truncatePayload) {\n+            // Would be nice if BinaryUtils.toHex() could take an array index range instead so we don't need to copy\n+            payloadToLog = Arrays.copyOf(payload, Math.min(32, payload.length));", "originalCommit": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwODg4Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394008887", "bodyText": "This should be fine, it will generate an empty string", "author": "dagnir", "createdAt": "2020-03-17T22:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDY2MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394004660", "bodyText": "I know we don't usually write unit tests for logs but maybe this method is complex enough to justify one?", "author": "bmaizels", "createdAt": "2020-03-17T22:23:09Z", "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -259,4 +267,35 @@ public void subscribe(Subscriber<? super ByteBuffer> s) {\n             return transformedRequestBody.contentLength();\n         }\n     }\n+\n+    private static String toDebugString(Message m, boolean truncatePayload) {", "originalCommit": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNjA3MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394006071", "bodyText": "Sure will add one", "author": "dagnir", "createdAt": "2020-03-17T22:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDY2MA=="}], "type": "inlineReview"}, {"oid": "0ad061d0dfd6ab2f856bc64bcc02f16008a49ec6", "url": "https://github.com/aws/aws-sdk-java-v2/commit/0ad061d0dfd6ab2f856bc64bcc02f16008a49ec6", "message": "Log signed event for easier debugging\n\nIn case of future bugs related to event stream signing, this should help in\ndebuggging to see the contents of the message in an easier to read format.", "committedDate": "2020-03-17T22:46:49Z", "type": "commit"}, {"oid": "0ad061d0dfd6ab2f856bc64bcc02f16008a49ec6", "url": "https://github.com/aws/aws-sdk-java-v2/commit/0ad061d0dfd6ab2f856bc64bcc02f16008a49ec6", "message": "Log signed event for easier debugging\n\nIn case of future bugs related to event stream signing, this should help in\ndebuggging to see the contents of the message in an easier to read format.", "committedDate": "2020-03-17T22:46:49Z", "type": "forcePushed"}]}