{"pr_number": 1884, "pr_title": "Async metrics Part1: Add metrics codegen changes for async clients", "pr_createdAt": "2020-06-09T19:47:21Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1884", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY3OTg0OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#discussion_r437679848", "bodyText": "Publishing needs to happen after execution so we would need to add a completion stage to the future instead of publishing here", "author": "dagnir", "createdAt": "2020-06-09T19:52:51Z", "path": "codegen/src/test/resources/software/amazon/awssdk/codegen/poet/client/test-endpoint-discovery-async.java", "diffHunk": "@@ -264,6 +288,10 @@ public final String serviceName() {\n             return executeFuture;\n         } catch (Throwable t) {\n             return CompletableFutureUtils.failedFuture(t);\n+        } finally {\n+            Optional<MetricPublisher> metricPublisher = MetricUtils.resolvePublisher(clientConfiguration,\n+                    testDiscoveryRequiredRequest);\n+            metricPublisher.ifPresent(p -> p.publish(apiCallMetricCollector.collect()));", "originalCommit": "f10bd22855ea90c7d15665c038e613c6cdcedd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MTc1OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#discussion_r437681759", "bodyText": "oh yeah, I guess I just blindly copied the sync change \ud83d\ude05", "author": "zoewangg", "createdAt": "2020-06-09T19:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY3OTg0OA=="}], "type": "inlineReview"}, {"oid": "8f9280eedd6d776388dd2921f858259e1fd6b91b", "url": "https://github.com/aws/aws-sdk-java-v2/commit/8f9280eedd6d776388dd2921f858259e1fd6b91b", "message": "Add metrics codegen changes for async clients", "committedDate": "2020-06-09T22:31:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc2MTQzNg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#discussion_r437761436", "bodyText": "I created this overload because for some operations, the input request is modified (eg: applySignerOverride), so the request variable is not final. As a result, we can't use the input request parameter in the whenComplete block because variables used in lambda should be final or effectively final", "author": "zoewangg", "createdAt": "2020-06-09T22:40:18Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/util/MetricUtils.java", "diffHunk": "@@ -54,6 +56,19 @@ private MetricUtils() {\n         return Optional.ofNullable(clientConfig.option(METRIC_PUBLISHER));\n     }\n \n+    /**\n+     * Resolve the correct metric publisher to use. The publisher set on the request always takes precedence.\n+     *\n+     * @param clientConfig The client configuration.\n+     * @param requestConfig The request override configuration.\n+     * @return The metric publisher to use.\n+     */\n+    public static Optional<MetricPublisher> resolvePublisher(SdkClientConfiguration clientConfig,", "originalCommit": "8f9280eedd6d776388dd2921f858259e1fd6b91b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc2OTgyMQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#discussion_r437769821", "bodyText": "Not a fan of using Optional as a method parameter. Can we change to so it takes an override config, and change the operation code:\nMetricUtils.resolvePublisher(clientConfig, overrideConfig.orElse(null));", "author": "dagnir", "createdAt": "2020-06-09T23:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc2MTQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc3NjM0Mw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#discussion_r437776343", "bodyText": "In most cases, I'd agree on the use of optional as a method parameter, but I can't find a better way to handle it in this case.\nMetricUtils.resolvePublisher(clientConfig, overrideConfig.orElse(null)); seems a bit code smell to me.\nIdeally, we should create another overload which doesn't take a requestOverrideConfig, but it seems overkill here.\nMetricUtils.resolvePublisher(SdkClientConfiguration clientConfig, AwsRequestOverrideConfiguration overrideConfig)\nMetricUtils.resolvePublisher(SdkClientConfiguration clientConfig)", "author": "zoewangg", "createdAt": "2020-06-09T23:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc2MTQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4MDIzNg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#discussion_r438280236", "bodyText": "Per offline discussion, changed to use nullable argument instead.", "author": "zoewangg", "createdAt": "2020-06-10T17:08:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc2MTQzNg=="}], "type": "inlineReview"}, {"oid": "881eb7f1b379435a00702aa5379ed1178059424f", "url": "https://github.com/aws/aws-sdk-java-v2/commit/881eb7f1b379435a00702aa5379ed1178059424f", "message": "Add metrics codegen changes for async clients", "committedDate": "2020-06-09T23:04:37Z", "type": "forcePushed"}, {"oid": "63e8c9b4e2c205bafad294a2c0c12c529c040459", "url": "https://github.com/aws/aws-sdk-java-v2/commit/63e8c9b4e2c205bafad294a2c0c12c529c040459", "message": "Add metrics codegen changes for async clients", "committedDate": "2020-06-10T05:55:53Z", "type": "forcePushed"}, {"oid": "a3a62b40b3a8616cada8bbbc6342eec75d0d81fa", "url": "https://github.com/aws/aws-sdk-java-v2/commit/a3a62b40b3a8616cada8bbbc6342eec75d0d81fa", "message": "Add metrics codegen changes for async clients", "committedDate": "2020-06-10T05:58:49Z", "type": "forcePushed"}, {"oid": "a3a62b40b3a8616cada8bbbc6342eec75d0d81fa", "url": "https://github.com/aws/aws-sdk-java-v2/commit/a3a62b40b3a8616cada8bbbc6342eec75d0d81fa", "message": "Add metrics codegen changes for async clients", "committedDate": "2020-06-10T05:58:49Z", "type": "commit"}]}