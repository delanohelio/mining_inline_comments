{"pr_number": 1885, "pr_title": "Added support for HTTP/2 metrics to Netty.", "pr_createdAt": "2020-06-09T21:26:42Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1885", "timeline": [{"oid": "804e7bb3dec8cb6e7eff347656aee9597500b42e", "url": "https://github.com/aws/aws-sdk-java-v2/commit/804e7bb3dec8cb6e7eff347656aee9597500b42e", "message": "Added support for HTTP/2 metrics to Netty.\n\nUpdated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\n\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency.", "committedDate": "2020-06-09T21:31:32Z", "type": "forcePushed"}, {"oid": "cf8eccb9e971e98a698891780fdfcfd586af2074", "url": "https://github.com/aws/aws-sdk-java-v2/commit/cf8eccb9e971e98a698891780fdfcfd586af2074", "message": "Added support for HTTP/2 metrics to Netty.\n\nUpdated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\n\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency.", "committedDate": "2020-06-10T00:19:01Z", "type": "commit"}, {"oid": "cf8eccb9e971e98a698891780fdfcfd586af2074", "url": "https://github.com/aws/aws-sdk-java-v2/commit/cf8eccb9e971e98a698891780fdfcfd586af2074", "message": "Added support for HTTP/2 metrics to Netty.\n\nUpdated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\n\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency.", "committedDate": "2020-06-10T00:19:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDUzNw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#discussion_r438974537", "bodyText": "Seems like for h2 operations,  all metrics here are for streams, should we add metrics for connections?", "author": "zoewangg", "createdAt": "2020-06-11T18:02:19Z", "path": "http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java", "diffHunk": "@@ -30,24 +31,64 @@\n     public static final SdkMetric<String> HTTP_CLIENT_NAME = metric(\"HttpClientName\", String.class);\n \n     /**\n-     * The maximum number of connections that will be pooled by the HTTP client.\n+     * The maximum number of concurrent requests that is supported by the HTTP client.\n+     *\n+     * <p>For HTTP/1 operations, this is equal to the maximum number of TCP connections that can be be pooled by the HTTP client.\n+     * For HTTP/2 operations, this is equal to the maximum number of streams that can be pooled by the HTTP client.\n+     *\n+     * <p>Note: Depending on the HTTP client, this is either a value for all endpoints served by the HTTP client, or a value\n+     * that applies only to the specific endpoint/host used in the request. For 'apache-http-client', this value is\n+     * for the entire HTTP client. For 'netty-nio-client', this value is per-endpoint. In all cases, this value is scoped to an\n+     * individual HTTP client instance, and does not include concurrency that may be available in other HTTP clients running\n+     * within the same JVM.\n      */\n-    public static final SdkMetric<Integer> MAX_CONNECTIONS = metric(\"MaxConnections\", Integer.class);\n+    public static final SdkMetric<Integer> MAX_CONCURRENCY = metric(\"MaxConcurrency\", Integer.class);", "originalCommit": "cf8eccb9e971e98a698891780fdfcfd586af2074", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5NDc1Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#discussion_r438994752", "bodyText": "I'm not entirely confident that it's particularly useful to do so, but it wouldn't be difficult. Maybe we do it if we find it's needed? I'm worried about confusing people if we expose both.", "author": "millems", "createdAt": "2020-06-11T18:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5OTMyOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#discussion_r438999328", "bodyText": "I think leasedConnection and availableConnection will provide helpful insights when we troubleshoot async issues. For example, in the past, we spent a lot of time searching logs and found out the streams are not balanced allocated across all connections. It'd save us time if we have such metrics available. That would require us to map connection metric with stream metric though.", "author": "zoewangg", "createdAt": "2020-06-11T18:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NjE1MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#discussion_r438976150", "bodyText": "should we namespace the key?", "author": "zoewangg", "createdAt": "2020-06-11T18:05:06Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/IdleConnectionCountingChannelPool.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.http.nio.netty.internal;\n+\n+import static software.amazon.awssdk.http.nio.netty.internal.utils.NettyUtils.doInEventLoop;\n+\n+import io.netty.channel.Channel;\n+import io.netty.channel.pool.ChannelPool;\n+import io.netty.util.AttributeKey;\n+import io.netty.util.concurrent.EventExecutor;\n+import io.netty.util.concurrent.Future;\n+import io.netty.util.concurrent.Promise;\n+import java.util.concurrent.CompletableFuture;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.http.HttpMetric;\n+import software.amazon.awssdk.metrics.MetricCollector;\n+import software.amazon.awssdk.utils.Logger;\n+\n+/**\n+ * A channel pool implementation that tracks the number of \"idle\" channels in an underlying channel pool.\n+ *\n+ * <p>Specifically, this pool counts the number of channels acquired and then released from/to the underlying channel pool. It\n+ * will monitor for the underlying channels to be closed, and will remove them from the \"idle\" count.\n+ */\n+@SdkInternalApi\n+public class IdleConnectionCountingChannelPool implements SdkChannelPool {\n+    private static final Logger log = Logger.loggerFor(IdleConnectionCountingChannelPool.class);\n+\n+    /**\n+     * The idle channel state for a specific channel. This should only be accessed from the {@link #executor}.\n+     */\n+    private static final AttributeKey<ChannelIdleState> CHANNEL_STATE =\n+        AttributeKey.newInstance(\"IdleConnectionCountingChannelPool.CHANNEL_STATE\");", "originalCommit": "cf8eccb9e971e98a698891780fdfcfd586af2074", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5MzY3MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#discussion_r438993671", "bodyText": "What do you mean?", "author": "millems", "createdAt": "2020-06-11T18:38:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NjE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5Njk5MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#discussion_r438996991", "bodyText": "I meant prefixing it with sdk namespace so it doesn't conflict with other keys. It seems we are using NettyUtils.getOrCreateAttributeKey now introduced in #1887", "author": "zoewangg", "createdAt": "2020-06-11T18:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NjE1MA=="}], "type": "inlineReview"}]}