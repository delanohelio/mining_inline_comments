{"pr_number": 1685, "pr_title": "Fix merging of single value headers", "pr_createdAt": "2020-03-05T01:14:21Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1685", "timeline": [{"oid": "42ccd0301a922cdb70d65c7ebf82debf4f4fa8a9", "url": "https://github.com/aws/aws-sdk-java-v2/commit/42ccd0301a922cdb70d65c7ebf82debf4f4fa8a9", "message": "Fix merging of single value headers", "committedDate": "2020-03-05T01:27:14Z", "type": "forcePushed"}, {"oid": "b84bbc3167074a987fa007c590e078694ecee62f", "url": "https://github.com/aws/aws-sdk-java-v2/commit/b84bbc3167074a987fa007c590e078694ecee62f", "message": "Update changelog message", "committedDate": "2020-03-06T01:12:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY2NTgwOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r388665809", "bodyText": "Is this needed?", "author": "spfink", "createdAt": "2020-03-06T01:20:58Z", "path": "utils/src/main/java/software/amazon/awssdk/utils/http/SdkHttpUtils.java", "diffHunk": "@@ -297,4 +307,12 @@ public static String appendUri(String baseUri, String path) {\n     public static Optional<String> firstMatchingHeader(Map<String, List<String>> headers, String header) {\n         return allMatchingHeaders(headers, header).findFirst();\n     }\n+\n+    public static Set<String> singleHeaders() {", "originalCommit": "b84bbc3167074a987fa007c590e078694ecee62f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY2ODQ5OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r388668499", "bodyText": "Not really needed, I just needed to able access the list from the tests, but I can just copy them there.", "author": "dagnir", "createdAt": "2020-03-06T01:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY2NTgwOQ=="}], "type": "inlineReview"}, {"oid": "5e5eb53d78d31a9a596bc4f0ed12134368ff60e4", "url": "https://github.com/aws/aws-sdk-java-v2/commit/5e5eb53d78d31a9a596bc4f0ed12134368ff60e4", "message": "Remove some headers defined as lists", "committedDate": "2020-03-06T21:35:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4ODU1Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r389188552", "bodyText": "We're now introducing an implicit 'priority' in the sense that the last header 'wins'. Can we add a comment about that?", "author": "millems", "createdAt": "2020-03-06T23:14:11Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/http/pipeline/stages/MergeCustomHeadersStage.java", "diffHunk": "@@ -52,7 +54,15 @@ public MergeCustomHeadersStage(HttpClientDependencies dependencies) {\n     private final Map<String, List<String>> mergeHeaders(Map<String, List<String>>... headers) {\n         Map<String, List<String>> result = new LinkedHashMap<>();\n         for (Map<String, List<String>> header : headers) {\n-            header.forEach((k, v) -> result.computeIfAbsent(k, ignored -> new ArrayList<>()).addAll(v));", "originalCommit": "5e5eb53d78d31a9a596bc4f0ed12134368ff60e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTA3MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r389195070", "bodyText": "Sure, i'll add a note on the setters in the Client/Request override configuration.", "author": "dagnir", "createdAt": "2020-03-06T23:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4ODU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4ODk2OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r389188969", "bodyText": "Should we disallow (or log) when there are multiple values specified in the same headerValues for a single-header?\nIt's a bit weird if I add multiple content-types at the request level, but it just takes the last one.", "author": "millems", "createdAt": "2020-03-06T23:15:54Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/http/pipeline/stages/MergeCustomHeadersStage.java", "diffHunk": "@@ -52,7 +54,15 @@ public MergeCustomHeadersStage(HttpClientDependencies dependencies) {\n     private final Map<String, List<String>> mergeHeaders(Map<String, List<String>>... headers) {\n         Map<String, List<String>> result = new LinkedHashMap<>();\n         for (Map<String, List<String>> header : headers) {\n-            header.forEach((k, v) -> result.computeIfAbsent(k, ignored -> new ArrayList<>()).addAll(v));\n+            header.forEach((headerName, headerValues) -> {\n+                List<String> resultHeaderValues = result.computeIfAbsent(headerName, ignored -> new ArrayList<>());\n+                if (SdkHttpUtils.isSingleHeader(headerName)) {\n+                    resultHeaderValues.clear();\n+                    resultHeaderValues.add(CollectionUtils.lastElement(headerValues));", "originalCommit": "5e5eb53d78d31a9a596bc4f0ed12134368ff60e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTgzOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r389195838", "bodyText": "I went back and forth with this. Alternatively what do you think about keeping all the values in the current list, but not merging them with the previously seen list?\ne.g.\n\"FooHeader\" set by marshaller -> \"a\"\n\"FooHeader\" override on client -> [\"b\", \"c\"]\n\"FooHeader\" override on request -> [\"d\", \"e\", \"f\"]\n\"FooHeader\" on the wire -> [\"d\", \"e\", \"f\"]", "author": "dagnir", "createdAt": "2020-03-06T23:44:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4ODk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NzIxNg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r389197216", "bodyText": "After discussing offline, went with the above solution.", "author": "dagnir", "createdAt": "2020-03-06T23:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4ODk2OQ=="}], "type": "inlineReview"}, {"oid": "647a2ff83ebdecab5e4b1bedf1343e87c0e558b4", "url": "https://github.com/aws/aws-sdk-java-v2/commit/647a2ff83ebdecab5e4b1bedf1343e87c0e558b4", "message": "Fix merging of single value headers", "committedDate": "2020-03-07T02:06:32Z", "type": "forcePushed"}, {"oid": "6d383364854fb93504b838837d114ee858bb4346", "url": "https://github.com/aws/aws-sdk-java-v2/commit/6d383364854fb93504b838837d114ee858bb4346", "message": "Fix merging of single value headers", "committedDate": "2020-03-07T02:50:39Z", "type": "forcePushed"}, {"oid": "9d2c16aac43896e693ffe260617ac6ce59b1a346", "url": "https://github.com/aws/aws-sdk-java-v2/commit/9d2c16aac43896e693ffe260617ac6ce59b1a346", "message": "Fix merging of single value headers", "committedDate": "2020-03-07T02:54:13Z", "type": "commit"}, {"oid": "9d2c16aac43896e693ffe260617ac6ce59b1a346", "url": "https://github.com/aws/aws-sdk-java-v2/commit/9d2c16aac43896e693ffe260617ac6ce59b1a346", "message": "Fix merging of single value headers", "committedDate": "2020-03-07T02:54:13Z", "type": "forcePushed"}]}