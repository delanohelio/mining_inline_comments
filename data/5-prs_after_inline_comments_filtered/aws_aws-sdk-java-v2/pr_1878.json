{"pr_number": 1878, "pr_title": "Collect HTTP/1 metrics in NettyNioHttpClient.", "pr_createdAt": "2020-06-05T18:31:50Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1878", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0Mjg0NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1878#discussion_r436142845", "bodyText": "Can you expand on this TODO?", "author": "cenedhryn", "createdAt": "2020-06-05T20:13:15Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/NettyNioAsyncHttpClient.java", "diffHunk": "@@ -117,6 +118,7 @@ private NettyNioAsyncHttpClient(DefaultBuilder builder, AttributeMap serviceDefa\n     @Override\n     public CompletableFuture<Void> execute(AsyncExecuteRequest request) {\n         RequestContext ctx = createRequestContext(request);\n+        ctx.metricCollector().reportMetric(HTTP_CLIENT_NAME, clientName()); // TODO: Can't this be done in core?", "originalCommit": "8bcf4ee190c77ef9bd0aaa6c5f72c9dd2f1553ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3NTQzNg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1878#discussion_r436175436", "bodyText": "I expect we can do this once Dongie's core work is done, but for posterity: core can call clientName() on the clients. Why does every HTTP client implementation have to do it themselves?", "author": "millems", "createdAt": "2020-06-05T21:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0Mjg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5MzI3OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1878#discussion_r436193279", "bodyText": "I see. Let's leave it for now then!", "author": "cenedhryn", "createdAt": "2020-06-05T22:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0Mjg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0OTU4Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1878#discussion_r436149582", "bodyText": "Why this switch? I don't know this code but I assume it's an improvement; is there any risk in doing things in this order?", "author": "cenedhryn", "createdAt": "2020-06-05T20:29:38Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/NettyRequestExecutor.java", "diffHunk": "@@ -87,8 +89,8 @@ public NettyRequestExecutor(RequestContext context) {\n     @SuppressWarnings(\"unchecked\")\n     public CompletableFuture<Void> execute() {\n         Promise<Channel> channelFuture = context.eventLoopGroup().next().newPromise();\n+        executeFuture = createExecutionFuture(channelFuture);", "originalCommit": "8bcf4ee190c77ef9bd0aaa6c5f72c9dd2f1553ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3NjYyNQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1878#discussion_r436176625", "bodyText": "The switch was to make sure the get-metrics call was before the connection acquire call, so that we'd always get metrics if the connection acquire failed. Without the switch, if the connection acquire fails we'd sometimes not get metrics.\nNow, there's one additional task in the event loop before connection acquisition and we are creating the future before adding the acquire task to the event loop. That is technically going to increase latency, but I don't expect it to be any amount that we'd notice.", "author": "millems", "createdAt": "2020-06-05T21:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0OTU4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5NzI1Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1878#discussion_r436197256", "bodyText": "We can go with that, I'm not too afraid of latency.", "author": "cenedhryn", "createdAt": "2020-06-05T22:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE0OTU4Mg=="}], "type": "inlineReview"}, {"oid": "e09f22ec85165dd3524b58fa889f804fb0c27745", "url": "https://github.com/aws/aws-sdk-java-v2/commit/e09f22ec85165dd3524b58fa889f804fb0c27745", "message": "Collect HTTP/1 metrics in NettyNioHttpClient.", "committedDate": "2020-06-05T23:42:42Z", "type": "forcePushed"}, {"oid": "dca0faf4689be98848a281dbf44184c69e35fcc2", "url": "https://github.com/aws/aws-sdk-java-v2/commit/dca0faf4689be98848a281dbf44184c69e35fcc2", "message": "Collect HTTP/1 metrics in NettyNioHttpClient.", "committedDate": "2020-06-05T23:55:06Z", "type": "commit"}, {"oid": "dca0faf4689be98848a281dbf44184c69e35fcc2", "url": "https://github.com/aws/aws-sdk-java-v2/commit/dca0faf4689be98848a281dbf44184c69e35fcc2", "message": "Collect HTTP/1 metrics in NettyNioHttpClient.", "committedDate": "2020-06-05T23:55:06Z", "type": "forcePushed"}]}