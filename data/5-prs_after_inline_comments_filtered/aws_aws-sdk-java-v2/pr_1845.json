{"pr_number": 1845, "pr_title": "Default endpointDiscovery to true for services that require it", "pr_createdAt": "2020-05-15T21:34:48Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1845", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODc0Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426778742", "bodyText": "We just use the last endpoint operation? Is that the right behavior?", "author": "millems", "createdAt": "2020-05-18T17:17:06Z", "path": "codegen/src/main/java/software/amazon/awssdk/codegen/IntermediateModelBuilder.java", "diffHunk": "@@ -107,12 +107,20 @@ public IntermediateModel build() {\n             new HashMap<>(new AddCustomAuthorizers(this.service, getNamingStrategy()).constructAuthorizers());\n \n         OperationModel endpointOperation = null;\n+        boolean endpointCacheRequired = false;\n \n         for (OperationModel o : operations.values()) {\n             if (o.isEndpointOperation()) {\n                 endpointOperation = o;\n-                break;\n             }", "originalCommit": "71f07e16f7b4802c19ed089503113f1e647d0994", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5NjMwNA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426796304", "bodyText": "I'll admit this is not how I would have written it if I had done it myself, but it is actually a copy/paste from the v1 SDK. The logic is correct because it only needs to know there is at least one endpoint operation (and the last one suffices for that purpose), and the flag as to whether an endpoint is required is cumulative (once it gets set it doesn't get unset) so ends up effectively meaning 'at least one endpoint is required'.", "author": "bmaizels", "createdAt": "2020-05-18T17:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5NjU3Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426796577", "bodyText": "I added a couple of tests to assert this logic was working correctly as well.", "author": "bmaizels", "createdAt": "2020-05-18T17:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwNTEwMA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426805100", "bodyText": "Can we clarify it a bit and make it a boolean or something?", "author": "millems", "createdAt": "2020-05-18T18:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgxNDEzMQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426814131", "bodyText": "Changing it will require more refactoring than the change is worth in my opinion. At least it's in sync with v1 in this state. I'll add comments to explain what it's doing.", "author": "bmaizels", "createdAt": "2020-05-18T18:23:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3OTQ0Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426779446", "bodyText": "So the \"new\" behavior is: if any operation requires endpoint discovery, enable it by default?", "author": "millems", "createdAt": "2020-05-18T17:18:13Z", "path": "codegen/src/main/java/software/amazon/awssdk/codegen/IntermediateModelBuilder.java", "diffHunk": "@@ -107,12 +107,20 @@ public IntermediateModel build() {\n             new HashMap<>(new AddCustomAuthorizers(this.service, getNamingStrategy()).constructAuthorizers());\n \n         OperationModel endpointOperation = null;\n+        boolean endpointCacheRequired = false;\n \n         for (OperationModel o : operations.values()) {\n             if (o.isEndpointOperation()) {\n                 endpointOperation = o;\n-                break;\n             }\n+\n+            if (o.getEndpointDiscovery() != null && o.getEndpointDiscovery().isRequired()) {\n+                endpointCacheRequired = true;", "originalCommit": "71f07e16f7b4802c19ed089503113f1e647d0994", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5NTYxMA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426795610", "bodyText": "Yes, exactly. I also stated that in the PR description.", "author": "bmaizels", "createdAt": "2020-05-18T17:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3OTQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NDQwMA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426784400", "bodyText": "Deprecate here as well? Can we also remove it for new services?", "author": "millems", "createdAt": "2020-05-18T17:27:06Z", "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/builder/AsyncClientBuilderClass.java", "diffHunk": "@@ -54,12 +54,24 @@ public TypeSpec poetSpec() {\n                          .addJavadoc(\"Internal implementation of {@link $T}.\", builderInterfaceName);\n \n         if (model.getEndpointOperation().isPresent()) {\n-            builder.addMethod(enableEndpointDiscovery());\n+            builder.addMethod(endpointDiscoveryEnabled())\n+                   .addMethod(enableEndpointDiscovery());\n         }\n \n         return builder.addMethod(buildClientMethod()).build();\n     }\n \n+    private MethodSpec endpointDiscoveryEnabled() {\n+        return MethodSpec.methodBuilder(\"endpointDiscoveryEnabled\")\n+                         .addAnnotation(Override.class)\n+                         .addModifiers(Modifier.PUBLIC)\n+                         .returns(builderClassName)\n+                         .addParameter(boolean.class, \"endpointDiscoveryEnabled\")\n+                         .addStatement(\"this.endpointDiscoveryEnabled = endpointDiscoveryEnabled\")\n+                         .addStatement(\"return this\")\n+                         .build();\n+    }\n+\n     private MethodSpec enableEndpointDiscovery() {\n         return MethodSpec.methodBuilder(\"enableEndpointDiscovery\")", "originalCommit": "71f07e16f7b4802c19ed089503113f1e647d0994", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5OTQ1NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426799454", "bodyText": "I will deprecate here as well. Do you have a strategy for removing it for new services? How do we identify 'new services'? One strategy is just to say 'service != DDB' which seems yuck.", "author": "bmaizels", "createdAt": "2020-05-18T17:55:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NDQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwNTUyNA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1845#discussion_r426805524", "bodyText": "We could also add a customization: \"enableEndpointDiscoveryMethodRequired\" and just enable it for DynamoDB.", "author": "millems", "createdAt": "2020-05-18T18:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NDQwMA=="}], "type": "inlineReview"}, {"oid": "379e27cd7a93331d7e94d9741774f0ac41a572e4", "url": "https://github.com/aws/aws-sdk-java-v2/commit/379e27cd7a93331d7e94d9741774f0ac41a572e4", "message": "Endpoint discovery is now enabled by default for future services that will require it", "committedDate": "2020-05-18T18:41:09Z", "type": "commit"}, {"oid": "379e27cd7a93331d7e94d9741774f0ac41a572e4", "url": "https://github.com/aws/aws-sdk-java-v2/commit/379e27cd7a93331d7e94d9741774f0ac41a572e4", "message": "Endpoint discovery is now enabled by default for future services that will require it", "committedDate": "2020-05-18T18:41:09Z", "type": "forcePushed"}]}