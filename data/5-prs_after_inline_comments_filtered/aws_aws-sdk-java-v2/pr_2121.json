{"pr_number": 2121, "pr_title": "Fix for handling transormation error in async DynamoDb Enhanced Clien\u2026", "pr_createdAt": "2020-10-27T01:27:06Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/2121", "timeline": [{"oid": "1cc1212d67ecd86e4c4ef749708c6504c275db4d", "url": "https://github.com/aws/aws-sdk-java-v2/commit/1cc1212d67ecd86e4c4ef749708c6504c275db4d", "message": "Fix for handling transormation error in async DynamoDb Enhanced Client operations that return an SdkPublisher", "committedDate": "2020-10-27T01:33:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg5ODE5MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2121#discussion_r512898191", "bodyText": "We should call cancel() on the upstream subscription in this case; since subscriber.onError() implicitly cancels the subscription for the downstream subscriber, the downstream subscriber is free to discard the subscription, but from the publisher's perspective, the subscription is still valid since it wasn't the one that called onError.", "author": "dagnir", "createdAt": "2020-10-27T17:41:57Z", "path": "utils/src/main/java/software/amazon/awssdk/utils/internal/MappingSubscriber.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.utils.internal;\n+\n+import java.util.function.Function;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+\n+/**\n+ * Maps a subscriber of one type to another type. If an exception is thrown by the mapping function itself, the error\n+ * will be propagated to the downstream subscriber as if it had come from the publisher and then the subscription will\n+ * be implicitly cancelled and no further events from the publisher will be passed along.\n+ */\n+@SdkInternalApi\n+public class MappingSubscriber<T, U> implements Subscriber<T> {\n+\n+    private final Subscriber<? super U> subscriber;\n+    private final Function<T, U> mapFunction;\n+    private boolean isCancelled = false;\n+\n+    private MappingSubscriber(Subscriber<? super U> subscriber,\n+                              Function<T, U> mapFunction) {\n+        this.subscriber = subscriber;\n+        this.mapFunction = mapFunction;\n+    }\n+\n+    public static <T, U> MappingSubscriber<T, U> create(Subscriber<? super U> subscriber,\n+                                                        Function<T, U> mapFunction) {\n+        return new MappingSubscriber<>(subscriber, mapFunction);\n+    }\n+\n+    @Override\n+    public void onSubscribe(Subscription subscription) {\n+        subscriber.onSubscribe(subscription);\n+    }\n+\n+    @Override\n+    public void onError(Throwable throwable) {\n+        if (!isCancelled) {\n+            subscriber.onError(throwable);\n+        }\n+    }\n+\n+    @Override\n+    public void onComplete() {\n+        if (!isCancelled) {\n+            subscriber.onComplete();\n+        }\n+    }\n+\n+    @Override\n+    public void onNext(T t) {\n+        if (!isCancelled) {\n+            try {\n+                subscriber.onNext(mapFunction.apply(t));\n+            } catch (RuntimeException e) {\n+                // If the map function throws an exception, the subscription must be implicitly cancelled. The publisher\n+                // will not know this is happening, so it needs to be handled by this class.\n+                this.isCancelled = true;\n+                subscriber.onError(e);\n+            }", "originalCommit": "1cc1212d67ecd86e4c4ef749708c6504c275db4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c1898197852a6d255d78f4fe03bf77d69748ebed", "url": "https://github.com/aws/aws-sdk-java-v2/commit/c1898197852a6d255d78f4fe03bf77d69748ebed", "message": "Fix for handling transormation error in async DynamoDb Enhanced Client operations that return an SdkPublisher", "committedDate": "2020-10-30T17:01:21Z", "type": "forcePushed"}, {"oid": "72b145679a3fe0bf87b8d79cacb850ac0c5ef4c8", "url": "https://github.com/aws/aws-sdk-java-v2/commit/72b145679a3fe0bf87b8d79cacb850ac0c5ef4c8", "message": "Fix for handling transormation error in async DynamoDb Enhanced Client operations that return an SdkPublisher", "committedDate": "2020-10-30T17:29:34Z", "type": "forcePushed"}, {"oid": "b33b51639b55eeb44209e688ae7ab66b6497b061", "url": "https://github.com/aws/aws-sdk-java-v2/commit/b33b51639b55eeb44209e688ae7ab66b6497b061", "message": "Fix for handling transormation error in async DynamoDb Enhanced Client operations that return an SdkPublisher", "committedDate": "2020-10-30T17:33:50Z", "type": "forcePushed"}, {"oid": "cc080733864e8ce8d2b7ffb84b1bef8eb81144dc", "url": "https://github.com/aws/aws-sdk-java-v2/commit/cc080733864e8ce8d2b7ffb84b1bef8eb81144dc", "message": "Fix for handling transormation error in async DynamoDb Enhanced Client operations that return an SdkPublisher", "committedDate": "2020-10-30T17:36:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5MjYxOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2121#discussion_r515292618", "bodyText": "I'm not sure about this; any reason we're supporting multiple subscriptions? Per my reading of the spec, a Subscriber can only have one Subscription. Per 2.12:\n\nSubscriber.onSubscribe MUST be called at most once for a given Subscriber (based on object equality).", "author": "dagnir", "createdAt": "2020-10-30T18:13:33Z", "path": "utils/src/main/java/software/amazon/awssdk/utils/internal/MappingSubscriber.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.utils.internal;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.function.Function;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+\n+/**\n+ * Maps a subscriber of one type to another type. If an exception is thrown by the mapping function itself, the error\n+ * will be propagated to the downstream subscriber as if it had come from the publisher and then the subscription will\n+ * be implicitly cancelled and no further events from the publisher will be passed along.\n+ */\n+@SdkInternalApi\n+public class MappingSubscriber<T, U> implements Subscriber<T> {\n+\n+    private final Subscriber<? super U> delegateSubscriber;\n+    private final Function<T, U> mapFunction;\n+    private boolean isCancelled = false;\n+    private final Set<Subscription> subscriptions = new HashSet<>();\n+\n+    private MappingSubscriber(Subscriber<? super U> delegateSubscriber,\n+                              Function<T, U> mapFunction) {\n+        this.delegateSubscriber = delegateSubscriber;\n+        this.mapFunction = mapFunction;\n+    }\n+\n+    public static <T, U> MappingSubscriber<T, U> create(Subscriber<? super U> subscriber,\n+                                                        Function<T, U> mapFunction) {\n+        return new MappingSubscriber<>(subscriber, mapFunction);\n+    }\n+\n+    @Override\n+    public void onSubscribe(Subscription subscription) {\n+        this.subscriptions.add(subscription);\n+        delegateSubscriber.onSubscribe(subscription);\n+    }", "originalCommit": "cc080733864e8ce8d2b7ffb84b1bef8eb81144dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4278584d3bc1dbe30e590a487d3e6a868882a60f", "url": "https://github.com/aws/aws-sdk-java-v2/commit/4278584d3bc1dbe30e590a487d3e6a868882a60f", "message": "Fix for handling transormation error in async DynamoDb Enhanced Client operations that return an SdkPublisher", "committedDate": "2020-10-30T18:23:30Z", "type": "forcePushed"}, {"oid": "91db08e317a1af890efd7dbd9395ddf4b8118c31", "url": "https://github.com/aws/aws-sdk-java-v2/commit/91db08e317a1af890efd7dbd9395ddf4b8118c31", "message": "Fix for handling transormation error in async DynamoDb Enhanced Client operations that return an SdkPublisher", "committedDate": "2020-10-30T18:40:49Z", "type": "commit"}, {"oid": "91db08e317a1af890efd7dbd9395ddf4b8118c31", "url": "https://github.com/aws/aws-sdk-java-v2/commit/91db08e317a1af890efd7dbd9395ddf4b8118c31", "message": "Fix for handling transormation error in async DynamoDb Enhanced Client operations that return an SdkPublisher", "committedDate": "2020-10-30T18:40:49Z", "type": "forcePushed"}, {"oid": "1d14a620bffe78666fbc998591fe2d41f4e2d1db", "url": "https://github.com/aws/aws-sdk-java-v2/commit/1d14a620bffe78666fbc998591fe2d41f4e2d1db", "message": "Merge branch 'master' into bmaizels/ddbenhanced-converter-exception-fix", "committedDate": "2020-10-30T18:41:06Z", "type": "commit"}, {"oid": "e44e3287adea392fb4564217a3fa03c4e63831e1", "url": "https://github.com/aws/aws-sdk-java-v2/commit/e44e3287adea392fb4564217a3fa03c4e63831e1", "message": "Merge branch 'master' into bmaizels/ddbenhanced-converter-exception-fix", "committedDate": "2020-10-30T19:29:49Z", "type": "commit"}]}