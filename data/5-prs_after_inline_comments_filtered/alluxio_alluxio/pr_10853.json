{"pr_number": 10853, "pr_title": "Improve performance of MetricsHeartbeatContextTest", "pr_createdAt": "2020-02-06T02:23:50Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10853", "timeline": [{"oid": "6b3719fb859eb634e5ecf5ba056c2fa227e93a96", "url": "https://github.com/Alluxio/alluxio/commit/6b3719fb859eb634e5ecf5ba056c2fa227e93a96", "message": "Improve performance of MetricsHeartbeatContextTest\n\nThe test currently runs for almost 3 minutes due to client retry\nconfiguration. This change makes the PollingMasterInquireClient\nrespect the USER_RPC_RETRY* configuration values which\nsubsequently speeds up the test.", "committedDate": "2020-02-06T02:23:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1NjAxOQ==", "url": "https://github.com/Alluxio/alluxio/pull/10853#discussion_r376056019", "bodyText": "How does changing this affect other tests? Will it still behave similarly to the previous retry policy?", "author": "gpang", "createdAt": "2020-02-06T20:09:31Z", "path": "core/common/src/main/java/alluxio/master/PollingMasterInquireClient.java", "diffHunk": "@@ -61,7 +61,10 @@\n   public PollingMasterInquireClient(List<InetSocketAddress> masterAddresses,\n       AlluxioConfiguration alluxioConf,\n       UserState userState) {\n-    this(masterAddresses, () -> new ExponentialBackoffRetry(20, 2000, 30),\n+    this(masterAddresses, () -> RetryUtils.defaultClientRetry(\n+        alluxioConf.getDuration(PropertyKey.USER_RPC_RETRY_MAX_DURATION),", "originalCommit": "6b3719fb859eb634e5ecf5ba056c2fa227e93a96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA3OTEwOA==", "url": "https://github.com/Alluxio/alluxio/pull/10853#discussion_r376079108", "bodyText": "The old way has an exponential backoff max of 2s * 30 total attempts. It takes 7 retries before hitting the 2s cap. This results in a max wait time of 46s + ~3s = ~50s. The values from PK defaults result in a max of 2min before stopping.\nThis is the graph of retry iteration time, and number of retries\n\nThis is a graph for total time spent vs # of retries\n\nThe wait time maxes out much higher for the polling client when using the default RPC retries\nEquations:\n\nMost cases there won't be a difference. The worst thing that will happen is that it results in users needing to wait longer for the polling client to determine who the leader master is. I can add more PKs so that the retry profile for the polling client match more closely with the current values than using the generic RPC retry parameters.\n@ggezer I requested your review for the reason stated above. Do you think there are other repercussions to changing the profile? Should we try to keep the default polling client values what they are now?", "author": "ZacBlanco", "createdAt": "2020-02-06T21:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1NjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NzQwNw==", "url": "https://github.com/Alluxio/alluxio/pull/10853#discussion_r376167407", "bodyText": "As discussed offline, fail-over scenario is not effected as the tight-loop of finding a responding master address won't be done under retry policy. Quick swipe on code shows no usage of inquire clients outside of RPC context, so I think It's fine to reuse these parameters.", "author": "ggezer", "createdAt": "2020-02-07T01:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1NjAxOQ=="}], "type": "inlineReview"}]}