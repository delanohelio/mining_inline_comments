{"pr_number": 12642, "pr_title": "Avoid loads ufs jars multiple times during journal formatting", "pr_createdAt": "2020-12-15T04:43:59Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12642", "timeline": [{"oid": "d542ac12cf4e59bd11b601a6c6ceb0dea5330863", "url": "https://github.com/Alluxio/alluxio/commit/d542ac12cf4e59bd11b601a6c6ceb0dea5330863", "message": "Avoid loads ufs jars multiple times during journal formatting", "committedDate": "2020-12-15T04:40:18Z", "type": "commit"}, {"oid": "4fd0ae297cf8468b33b13eb7c32f1600d92b845a", "url": "https://github.com/Alluxio/alluxio/commit/4fd0ae297cf8468b33b13eb7c32f1600d92b845a", "message": "Fix failed when trying to format the HDFS", "committedDate": "2020-12-15T04:42:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU0MDY3Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12642#discussion_r543540677", "bodyText": "I am confused. Why could there be multiple journal locations?\nShouldn't this look similar to the root ufs client, which there is only 1 of?", "author": "gpang", "createdAt": "2020-12-15T17:27:24Z", "path": "core/server/common/src/main/java/alluxio/underfs/AbstractUfsManager.java", "diffHunk": "@@ -209,6 +214,27 @@ public UfsClient getRoot() {\n     }\n   }\n \n+  @Override\n+  public UfsClient getJournal(URI location) {\n+    synchronized (this) {\n+      if (mJournalUfsClientMap == null) {\n+        mJournalUfsClientMap = new HashMap<>();\n+      }\n+      UfsClient ufsClient = mJournalUfsClientMap.get(location.getScheme());", "originalCommit": "4fd0ae297cf8468b33b13eb7c32f1600d92b845a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg1ODI1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12642#discussion_r543858257", "bodyText": "From the master.log, It seems that there are multiple journal for different service need format.\n2020-12-16 10:48:04,744 INFO  cli.Format (Format.java:format(121)) - Formatting master journal: /Users/mbl/projects/github/alluxio-2/journal/\n2020-12-16 10:48:04,825 INFO  extensions.ExtensionFactoryRegistry (ExtensionFactoryRegistry.java:scanLibs(169)) - Loading core jars from /Users/mbl/projects/github/alluxio-2/lib\n2020-12-16 10:48:05,000 INFO  extensions.ExtensionFactoryRegistry (ExtensionFactoryRegistry.java:scanExtensions(159)) - Loading extension jars from /Users/mbl/projects/github/alluxio-2/extensions\n2020-12-16 10:48:05,032 INFO  ufs.UfsJournal (UfsJournal.java:format(428)) - Formatting /Users/mbl/projects/github/alluxio-2/journal/BlockMaster/v1\n2020-12-16 10:48:05,058 INFO  ufs.UfsJournal (UfsJournal.java:format(428)) - Formatting /Users/mbl/projects/github/alluxio-2/journal/TableMaster/v1\n2020-12-16 10:48:05,060 INFO  ufs.UfsJournal (UfsJournal.java:format(428)) - Formatting /Users/mbl/projects/github/alluxio-2/journal/FileSystemMaster/v1\n2020-12-16 10:48:05,060 INFO  ufs.UfsJournal (UfsJournal.java:format(428)) - Formatting /Users/mbl/projects/github/alluxio-2/journal/MetaMaster/v1\n2020-12-16 10:48:05,061 INFO  ufs.UfsJournal (UfsJournal.java:format(428)) - Formatting /Users/mbl/projects/github/alluxio-2/journal/MetricsMaster/v1\n2020-12-16 10:48:05,062 INFO  cli.Format (Format.java:main(106)) - Formatting complete\n\nAlso, from the following Format#format, there are lots of master services, each one need create journal.\npublic static void format(Mode mode, AlluxioConfiguration alluxioConf) throws IOException {\n    NoopUfsManager noopUfsManager = new NoopUfsManager();\n    switch (mode) {\n      case MASTER:\n        URI journalLocation = JournalUtils.getJournalLocation();\n        LOG.info(\"Formatting master journal: {}\", journalLocation);\n        JournalSystem journalSystem = new JournalSystem.Builder()\n            .setLocation(journalLocation).build(CommonUtils.ProcessType.MASTER);\n        for (String masterServiceName : ServiceUtils.getMasterServiceNames()) {\n          journalSystem.createJournal(new NoopMaster(masterServiceName, noopUfsManager));\n        }\n        journalSystem.format();\n        break;\n...\nThe following screenshots are shown that, there is one location for one journal of one master service, but there are lots of master services.", "author": "maobaolong", "createdAt": "2020-12-16T02:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU0MDY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxMDMxNg==", "url": "https://github.com/Alluxio/alluxio/pull/12642#discussion_r545310316", "bodyText": "@maobaolong I see. Then, does this PR actually help with the original motivation of avoiding loading the UFS journal jars? It seems like this will create a new UFS client for each master service (block, fs, table, etc) to format each, and each one will have a different location, so it will load the jars again?\nIn this example, I feel like the ideal behavior should be to load the UFS jars once for the location /Users/mbl/projects/github/alluxio-2/journal/, and all the master services are going to be sub-directories of that single UFS journal location. Does this current PR already behave in this way?", "author": "gpang", "createdAt": "2020-12-17T18:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU0MDY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4NjM0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12642#discussion_r545486343", "bodyText": "@gpang Thanks for your review again. I think it just load the jars once during the format, since location.getScheme(), I use the scheme of the location as the key mapping to the related Underfilesystem.\nAnd I did a format test using this PR, the behavior running as expected.", "author": "maobaolong", "createdAt": "2020-12-18T00:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU0MDY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUwMzAwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12642#discussion_r545503005", "bodyText": "@maobaolong O, you are right. the scheme will always be the same. Then I am confused as to why we even need the map to begin with. The scheme for all the journals should always be the same, since they are always a sub-directory of the journal location right?\nI feel like the map will always have only 1 entry, so we should just not use a map?", "author": "gpang", "createdAt": "2020-12-18T00:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU0MDY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUyNTEzNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12642#discussion_r545525135", "bodyText": "@gpang OK, I remove the map now.", "author": "maobaolong", "createdAt": "2020-12-18T02:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU0MDY3Nw=="}], "type": "inlineReview"}, {"oid": "88633a637e37720959ecceb74464b24f772e9228", "url": "https://github.com/Alluxio/alluxio/commit/88633a637e37720959ecceb74464b24f772e9228", "message": "Address comment, remove the scheme-> ufsclient map.", "committedDate": "2020-12-18T02:03:00Z", "type": "commit"}]}