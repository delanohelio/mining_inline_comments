{"pr_number": 10847, "pr_title": "Make page calculation in bytes on eviction", "pr_createdAt": "2020-02-05T08:01:03Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10847", "timeline": [{"oid": "3fcf2e64d9879f382e23b6886b3545d77f55ba02", "url": "https://github.com/Alluxio/alluxio/commit/3fcf2e64d9879f382e23b6886b3545d77f55ba02", "message": "Make page calculation in bytes on eviction", "committedDate": "2020-02-05T08:00:09Z", "type": "commit"}, {"oid": "913b3d995c1e71ec9bab2d54ab970d1ab9b2246b", "url": "https://github.com/Alluxio/alluxio/commit/913b3d995c1e71ec9bab2d54ab970d1ab9b2246b", "message": "Rename size to pages", "committedDate": "2020-02-05T08:08:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1MzU2NA==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375453564", "bodyText": "Do we want hashmap or just a page object that has the size?", "author": "calvinjia", "createdAt": "2020-02-05T19:14:01Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -13,29 +13,39 @@\n \n import alluxio.exception.PageNotFoundException;\n \n-import java.util.HashSet;\n-import java.util.Set;\n+import java.util.HashMap;\n+import java.util.Map;\n \n /**\n  * The default implementation of a metadata store for pages stored in cache.\n  */\n public class DefaultMetaStore implements MetaStore {\n-  private final Set<PageId> mPageMap = new HashSet<>();\n+  /** A map from PageId to page size. */\n+  private final Map<PageId, Long> mPageMap = new HashMap<>();", "originalCommit": "913b3d995c1e71ec9bab2d54ab970d1ab9b2246b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1MjY1MQ==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375552651", "bodyText": "Actually we may need to store more page information later, so having a page info kind of object makes sense, for now we can keep it a long.", "author": "calvinjia", "createdAt": "2020-02-05T22:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1MzU2NA=="}], "type": "inlineReview"}, {"oid": "e3b3c2c11e8493fa3599a59e8c24a4ae4c4cd896", "url": "https://github.com/Alluxio/alluxio/commit/e3b3c2c11e8493fa3599a59e8c24a4ae4c4cd896", "message": "Add unit test", "committedDate": "2020-02-05T19:24:10Z", "type": "commit"}, {"oid": "29ff1f156d08a3d0dca484b071b76b867284a94c", "url": "https://github.com/Alluxio/alluxio/commit/29ff1f156d08a3d0dca484b071b76b867284a94c", "message": "Fix style", "committedDate": "2020-02-05T19:30:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDM0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375554349", "bodyText": "I think we need a loop here where we evict data, since there is no guarantee one victim is sufficient?", "author": "calvinjia", "createdAt": "2020-02-05T22:54:43Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,25 +119,31 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public void put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n-\n+    long victimSize = 0;\n+    long pageSize = 0;\n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n       boolean alreadyCached;\n       boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n         alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n+        if (alreadyCached) {\n+          pageSize = mMetaStore.getPageSize(pageId);\n+        } else {\n+          needEvict = mPageStore.bytes() + page.length > mCacheSize;\n           if (needEvict) {\n             victim = mEvictor.evict();\n+            victimSize = mMetaStore.getPageSize(victim);", "originalCommit": "29ff1f156d08a3d0dca484b071b76b867284a94c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY3OTExNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376679115", "bodyText": "As discussed, we will make best effort and evict at most one page to keep put concurrent", "author": "apc999", "createdAt": "2020-02-08T02:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDM0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDk4Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375554987", "bodyText": "Unrelated question - in some places we do operation first then evictor update and in others we do evictor update then operation, what is the reasoning?", "author": "calvinjia", "createdAt": "2020-02-05T22:56:21Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,25 +119,31 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public void put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n-\n+    long victimSize = 0;\n+    long pageSize = 0;\n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n       boolean alreadyCached;\n       boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n         alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n+        if (alreadyCached) {\n+          pageSize = mMetaStore.getPageSize(pageId);\n+        } else {\n+          needEvict = mPageStore.bytes() + page.length > mCacheSize;\n           if (needEvict) {\n             victim = mEvictor.evict();\n+            victimSize = mMetaStore.getPageSize(victim);\n           } else {\n-            mMetaStore.addPage(pageId);\n+            mMetaStore.addPage(pageId, page.length);\n           }\n         }\n+      } catch (PageNotFoundException e) {\n+        throw new IllegalStateException(\"we shall not reach here\");\n       }\n       if (alreadyCached) {\n         try {\n-          mPageStore.delete(pageId);\n+          mPageStore.delete(pageId, pageSize);\n         } catch (PageNotFoundException e) {\n           throw new IllegalStateException(\n               String.format(\"Page store is missing page %s.\", pageId), e);", "originalCommit": "29ff1f156d08a3d0dca484b071b76b867284a94c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5NjI4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375996285", "bodyText": "that is unintentional. Let's fix that issue in #10816", "author": "apc999", "createdAt": "2020-02-06T18:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDk4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY3OTEzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376679131", "bodyText": "fixed in later commit. PTAL", "author": "apc999", "createdAt": "2020-02-08T02:14:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDk4Nw=="}], "type": "inlineReview"}, {"oid": "15163bd63e58d1711f893b250f73aaa5b0acbb2a", "url": "https://github.com/Alluxio/alluxio/commit/15163bd63e58d1711f893b250f73aaa5b0acbb2a", "message": "Fix style check", "committedDate": "2020-02-07T01:13:21Z", "type": "commit"}, {"oid": "de4d22578fe204192709219f54c2eb8e73375670", "url": "https://github.com/Alluxio/alluxio/commit/de4d22578fe204192709219f54c2eb8e73375670", "message": "Address comments", "committedDate": "2020-02-08T02:13:13Z", "type": "commit"}, {"oid": "f44ef0c5c9ae47e898cb2a80766d26c68b52cb22", "url": "https://github.com/Alluxio/alluxio/commit/f44ef0c5c9ae47e898cb2a80766d26c68b52cb22", "message": "Merge branch 'lite' of github.com:Alluxio/alluxio into lite_bytes", "committedDate": "2020-02-08T05:24:07Z", "type": "commit"}, {"oid": "25b62b227001879b5efc03f8d41e800d010075da", "url": "https://github.com/Alluxio/alluxio/commit/25b62b227001879b5efc03f8d41e800d010075da", "message": "Add unit test", "committedDate": "2020-02-08T07:24:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NDA3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376694072", "bodyText": "I changed the behavior here a bit: if page to insert exists, it returns false now", "author": "apc999", "createdAt": "2020-02-08T07:27:38Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,38 +119,32 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   }\n \n   @Override\n-  public void put(PageId pageId, byte[] page) throws IOException {\n+  public boolean put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n+    long victimPageSize = 0;\n+    boolean enoughSpace;\n \n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n-      boolean alreadyCached;\n-      boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n-        alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n-          if (needEvict) {\n-            victim = mEvictor.evict();\n-          } else {\n-            mMetaStore.addPage(pageId);\n-          }\n+        if (mMetaStore.hasPage(pageId)) {", "originalCommit": "25b62b227001879b5efc03f8d41e800d010075da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NDEzMA==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376694130", "bodyText": "now we consistently update page store first followed by updating evictor", "author": "apc999", "createdAt": "2020-02-08T07:28:38Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -205,8 +204,9 @@ public ReadableByteChannel get(PageId pageId, int pageOffset)\n       if (!hasPage) {\n         return null;\n       }\n+      ReadableByteChannel ret = mPageStore.get(pageId, pageOffset);", "originalCommit": "25b62b227001879b5efc03f8d41e800d010075da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da2b9688546343efd53b68fe8eb48936e2a5a0a3", "url": "https://github.com/Alluxio/alluxio/commit/da2b9688546343efd53b68fe8eb48936e2a5a0a3", "message": "Improve unit tests", "committedDate": "2020-02-09T02:32:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0OTYyNg==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376749626", "bodyText": "Let's test with real implementation of MetaStore and PageStore instead the mock. FYI", "author": "apc999", "createdAt": "2020-02-09T02:34:51Z", "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LocalCacheManagerTest.java", "diffHunk": "@@ -54,66 +51,148 @@\n \n   private LocalCacheManager mCacheManager;\n   private InstancedConfiguration mConf = ConfigurationTestUtils.defaults();\n-  private HashSetMetaStore mMetaStore;\n-  private HashMapPageStore mPageStore;\n+  private MetaStore mMetaStore;\n+  private PageStore mPageStore;\n   private CacheEvictor mEvictor;\n \n+  @Rule\n+  public TemporaryFolder mTemp = new TemporaryFolder();\n+\n   @Rule\n   public final ExpectedException mThrown = ExpectedException.none();\n \n   @Before\n   public void before() {\n     mConf.set(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE, PAGE_SIZE_BYTES);\n     mConf.set(PropertyKey.USER_CLIENT_CACHE_SIZE, CACHE_SIZE_BYTES);\n-    mMetaStore = new HashSetMetaStore();\n-    mPageStore = new HashMapPageStore();\n+    mConf.set(PropertyKey.USER_CLIENT_CACHE_DIR, mTemp.getRoot().getAbsolutePath());\n+    mMetaStore = MetaStore.create();\n+    mPageStore = PageStore.create(mConf);", "originalCommit": "da2b9688546343efd53b68fe8eb48936e2a5a0a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dfff0cdaf787fa43e9ce81709d1e259cebcb0850", "url": "https://github.com/Alluxio/alluxio/commit/dfff0cdaf787fa43e9ce81709d1e259cebcb0850", "message": "Merge branch 'lite' of github.com:Alluxio/alluxio into lite_bytes", "committedDate": "2020-02-09T06:45:01Z", "type": "commit"}, {"oid": "18865ac67401f1326bfa9c3121275964d0461348", "url": "https://github.com/Alluxio/alluxio/commit/18865ac67401f1326bfa9c3121275964d0461348", "message": "Fix build", "committedDate": "2020-02-09T07:51:01Z", "type": "commit"}, {"oid": "ae9c00dc366dfc54f59548decaf6593fcc451ad9", "url": "https://github.com/Alluxio/alluxio/commit/ae9c00dc366dfc54f59548decaf6593fcc451ad9", "message": "Add PageInfo to MetaStore", "committedDate": "2020-02-09T20:06:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMTI3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376811273", "bodyText": "addPage requires PageInfo now.", "author": "apc999", "createdAt": "2020-02-09T20:07:30Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -13,29 +13,39 @@\n \n import alluxio.exception.PageNotFoundException;\n \n-import java.util.HashSet;\n-import java.util.Set;\n+import java.util.HashMap;\n+import java.util.Map;\n \n /**\n  * The default implementation of a metadata store for pages stored in cache.\n  */\n public class DefaultMetaStore implements MetaStore {\n-  private final Set<PageId> mPageMap = new HashSet<>();\n+  /** A map from PageId to page info. */\n+  private final Map<PageId, PageInfo> mPageMap = new HashMap<>();\n \n   @Override\n   public boolean hasPage(PageId pageId) {\n-    return mPageMap.contains(pageId);\n+    return mPageMap.containsKey(pageId);\n   }\n \n   @Override\n-  public boolean addPage(PageId pageId) {\n-    return mPageMap.add(pageId);\n+  public void addPage(PageId pageId, PageInfo pageInfo) {", "originalCommit": "ae9c00dc366dfc54f59548decaf6593fcc451ad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0MDY4OA==", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r377340688", "bodyText": "Do we still need to pass in separate page id now that PageInfo has the id?", "author": "bf8086", "createdAt": "2020-02-10T21:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMTI3Mw=="}], "type": "inlineReview"}, {"oid": "c1b420eb7eacf352bf82c389719af6daa6542fdb", "url": "https://github.com/Alluxio/alluxio/commit/c1b420eb7eacf352bf82c389719af6daa6542fdb", "message": "Fix test", "committedDate": "2020-02-09T20:45:35Z", "type": "commit"}, {"oid": "b13da1448e45c840e5b372241c4cccb4fb8aee3d", "url": "https://github.com/Alluxio/alluxio/commit/b13da1448e45c840e5b372241c4cccb4fb8aee3d", "message": "Fix integration test", "committedDate": "2020-02-09T23:16:35Z", "type": "commit"}, {"oid": "c0d29446433bacd0c9aae8b3a5b343aaf3110d73", "url": "https://github.com/Alluxio/alluxio/commit/c0d29446433bacd0c9aae8b3a5b343aaf3110d73", "message": "Fix Rocks restore", "committedDate": "2020-02-10T05:39:27Z", "type": "commit"}, {"oid": "c0d29446433bacd0c9aae8b3a5b343aaf3110d73", "url": "https://github.com/Alluxio/alluxio/commit/c0d29446433bacd0c9aae8b3a5b343aaf3110d73", "message": "Fix Rocks restore", "committedDate": "2020-02-10T05:39:27Z", "type": "forcePushed"}]}