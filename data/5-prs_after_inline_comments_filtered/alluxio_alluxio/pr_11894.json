{"pr_number": 11894, "pr_title": "Add java 11 support for cleaning direct buffers", "pr_createdAt": "2020-08-04T00:43:04Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11894", "timeline": [{"oid": "30170d836a659d4eb7ea830af98c5928be2bb0cf", "url": "https://github.com/Alluxio/alluxio/commit/30170d836a659d4eb7ea830af98c5928be2bb0cf", "message": "add java 11 support for cleaning direct buffers", "committedDate": "2020-08-04T00:41:10Z", "type": "commit"}, {"oid": "6e8e1f41271cc092154dad4b511b338a3a1d3566", "url": "https://github.com/Alluxio/alluxio/commit/6e8e1f41271cc092154dad4b511b338a3a1d3566", "message": "fix checkstyle", "committedDate": "2020-08-04T00:58:24Z", "type": "commit"}, {"oid": "65f6bba1f9a686cb7044715966982045ec4dd1ac", "url": "https://github.com/Alluxio/alluxio/commit/65f6bba1f9a686cb7044715966982045ec4dd1ac", "message": "add synchronized to the cleaner methods", "committedDate": "2020-08-04T01:17:48Z", "type": "commit"}, {"oid": "86fbe73481287d9e14320d1c52901a06ef6f0111", "url": "https://github.com/Alluxio/alluxio/commit/86fbe73481287d9e14320d1c52901a06ef6f0111", "message": "fix checkstyle", "committedDate": "2020-08-04T01:34:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc2OTUxOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r464769519", "bodyText": "I would suggest making this a static constant as this is going to be constant for the life of the JVM.\nAlso, I've seen in the JVM that this can report 1.8 for java 8, and 11 for java 11. I'm not sure if that would make a difference", "author": "ZacBlanco", "createdAt": "2020-08-04T02:57:39Z", "path": "core/common/src/main/java/alluxio/util/io/BufferUtils.java", "diffHunk": "@@ -51,6 +53,53 @@ public static int byteToInt(byte b) {\n    * this direct buffer should be discarded. This is unsafe operation and currently a work-around to\n    * avoid huge memory occupation caused by memory map.\n    *\n+   * @param buffer bytebuffer\n+   */\n+  public static synchronized void cleanDirectBuffer(ByteBuffer buffer) {\n+    Preconditions.checkNotNull(buffer, \"buffer is null\");\n+    Preconditions.checkArgument(buffer.isDirect(), \"buffer isn't a DirectByteBuffer\");\n+    int javaVersion = Integer.parseInt(System.getProperty(\"java.version\").split(\"\\\\D+\")[0]);", "originalCommit": "86fbe73481287d9e14320d1c52901a06ef6f0111", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4MDQ2NA==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r464780464", "bodyText": "made it a utils method backed by a static constant.", "author": "yuzhu", "createdAt": "2020-08-04T03:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc2OTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4MDUzMw==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r464780533", "bodyText": "also modifieid it to handle 1.8 or 9-11", "author": "yuzhu", "createdAt": "2020-08-04T03:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc2OTUxOQ=="}], "type": "inlineReview"}, {"oid": "468cf7995437188e097cdb19e864901fad8ca998", "url": "https://github.com/Alluxio/alluxio/commit/468cf7995437188e097cdb19e864901fad8ca998", "message": "Address comments", "committedDate": "2020-08-04T03:39:42Z", "type": "commit"}, {"oid": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "url": "https://github.com/Alluxio/alluxio/commit/1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "message": "checkstyle fix", "committedDate": "2020-08-04T03:54:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNzQ0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465207442", "bodyText": "Please add a comment on what this will return. I'm assuming 8 for java 1.8, 11 for java 11 ?", "author": "gpang", "createdAt": "2020-08-04T17:19:13Z", "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -852,5 +861,18 @@ public static boolean isAddressReachable(String hostname, int port) {\n     return result;\n   }\n \n+  private static int initMajorVersion() {", "originalCommit": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNzY0NA==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465207644", "bodyText": "Will there always be a dot?", "author": "gpang", "createdAt": "2020-08-04T17:19:34Z", "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -852,5 +861,18 @@ public static boolean isAddressReachable(String hostname, int port) {\n     return result;\n   }\n \n+  private static int initMajorVersion() {\n+    String version = System.getProperty(\"java.version\");\n+    if (version.startsWith(\"1.\")) {\n+      version = version.substring(2, 3);\n+    } else {\n+      int dot = version.indexOf(\".\");\n+      if (dot != -1) {", "originalCommit": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIxNTUxOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465215519", "bodyText": "yes, the version string looks like 1.8.1 or '11.0.2`\nhttps://www.oracle.com/java/technologies/javase/versioning-naming.html", "author": "yuzhu", "createdAt": "2020-08-04T17:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNzY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNzcyMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465207721", "bodyText": "Will this always work?", "author": "gpang", "createdAt": "2020-08-04T17:19:42Z", "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -852,5 +861,18 @@ public static boolean isAddressReachable(String hostname, int port) {\n     return result;\n   }\n \n+  private static int initMajorVersion() {\n+    String version = System.getProperty(\"java.version\");\n+    if (version.startsWith(\"1.\")) {\n+      version = version.substring(2, 3);\n+    } else {\n+      int dot = version.indexOf(\".\");\n+      if (dot != -1) {\n+        version = version.substring(0, dot);\n+      }\n+    }\n+    return Integer.parseInt(version);", "originalCommit": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIxNTk5NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465215995", "bodyText": "I don't see why it wouldn't?", "author": "yuzhu", "createdAt": "2020-08-04T17:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNzcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwOTc1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465209757", "bodyText": "What was the reason for making everything synchronized? Is it for initializing the method variable, or is it also for the actual cleaning part?", "author": "gpang", "createdAt": "2020-08-04T17:23:15Z", "path": "core/common/src/main/java/alluxio/util/io/BufferUtils.java", "diffHunk": "@@ -51,6 +55,53 @@ public static int byteToInt(byte b) {\n    * this direct buffer should be discarded. This is unsafe operation and currently a work-around to\n    * avoid huge memory occupation caused by memory map.\n    *\n+   * @param buffer bytebuffer\n+   */\n+  public static synchronized void cleanDirectBuffer(ByteBuffer buffer) {", "originalCommit": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIxNjY1MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465216651", "bodyText": "it was synchronized before. I think the reason is that we initialize static variable within the method, so it has to be synchronized. cleaning part does not require synchronization.", "author": "yuzhu", "createdAt": "2020-08-04T17:35:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwOTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIxMDAyNA==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465210024", "bodyText": "Is this comment true? Will it be 1.8 or will it be 8?", "author": "gpang", "createdAt": "2020-08-04T17:23:42Z", "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -118,6 +120,13 @@ public static long getCurrentMs() {\n     return System.currentTimeMillis();\n   }\n \n+  /**\n+   * @return the current jvm major version, such as 1.8 or 11", "originalCommit": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIxNzM5MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465217391", "bodyText": "fixed comment", "author": "yuzhu", "createdAt": "2020-08-04T17:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIxMDAyNA=="}], "type": "inlineReview"}, {"oid": "7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30", "url": "https://github.com/Alluxio/alluxio/commit/7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30", "message": "address comments", "committedDate": "2020-08-04T17:35:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3ODc1Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465978753", "bodyText": "can you add one or more unit test(s) for this method", "author": "ZacBlanco", "createdAt": "2020-08-05T20:17:04Z", "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -852,5 +861,22 @@ public static boolean isAddressReachable(String hostname, int port) {\n     return result;\n   }\n \n+  /**\n+   * @return the major version of the current JVM, 8 for 1.8, 11 for java 11\n+   * see https://www.oracle.com/java/technologies/javase/versioning-naming.html for reference\n+   */\n+  private static int initMajorVersion() {", "originalCommit": "7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwMTQzNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r466001435", "bodyText": "emmm not sure how we can test this? like how do we know the ground truth, from within a jvm?", "author": "yuzhu", "createdAt": "2020-08-05T21:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3ODc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0MzI3Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r466043276", "bodyText": "test expected JVM inputs (1.8.X-XXX, 11.X.X., etc?) and make sure this function returns the correct output", "author": "ZacBlanco", "createdAt": "2020-08-05T22:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3ODc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3OTIxOA==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465979218", "bodyText": "do we have a test for this?", "author": "ZacBlanco", "createdAt": "2020-08-05T20:18:00Z", "path": "core/common/src/main/java/alluxio/util/io/BufferUtils.java", "diffHunk": "@@ -51,6 +55,53 @@ public static int byteToInt(byte b) {\n    * this direct buffer should be discarded. This is unsafe operation and currently a work-around to\n    * avoid huge memory occupation caused by memory map.\n    *\n+   * @param buffer bytebuffer\n+   */\n+  public static synchronized void cleanDirectBuffer(ByteBuffer buffer) {\n+    Preconditions.checkNotNull(buffer, \"buffer is null\");\n+    Preconditions.checkArgument(buffer.isDirect(), \"buffer isn't a DirectByteBuffer\");\n+    int javaVersion = CommonUtils.getJavaVersion();\n+    if (javaVersion < 9) {\n+      cleanDirectBufferJava8(buffer);\n+    } else {\n+      cleanDirectBufferJava11(buffer);\n+    }\n+  }\n+\n+  /**\n+   * <p>\n+   * Note: This calls the cleaner method on jdk 9+.\n+   * See <a\n+   * href=\"https://stackoverflow.com/questions/2972986/how-to-unmap-a-file-from-memory-mapped-\n+   * using-filechannel-in-java\"\n+   * >more discussion</a>.\n+   *\n+   * @param buffer the byte buffer to be unmapped, this must be a direct buffer\n+   */\n+  private static synchronized void cleanDirectBufferJava11(ByteBuffer buffer) {\n+    try {\n+      if (sByteBufferCleanerMethod == null || sUnsafeClass == null) {\n+        try {\n+          sUnsafeClass = Class.forName(\"sun.misc.Unsafe\");\n+        } catch (Exception e) {\n+          // jdk.internal.misc.Unsafe doesn't yet have an invokeCleaner() method,\n+          // but that method should be added if sun.misc.Unsafe is removed.\n+          sUnsafeClass = Class.forName(\"jdk.internal.misc.Unsafe\");\n+        }\n+        sByteBufferCleanerMethod = sUnsafeClass.getMethod(\"invokeCleaner\", ByteBuffer.class);\n+        sByteBufferCleanerMethod.setAccessible(true);\n+      }\n+      Field theUnsafeField = sUnsafeClass.getDeclaredField(\"theUnsafe\");\n+      theUnsafeField.setAccessible(true);\n+      Object theUnsafe = theUnsafeField.get(null);\n+      sByteBufferCleanerMethod.invoke(theUnsafe, buffer);\n+    } catch (Exception e) {\n+      LOG.warn(\"Failed to unmap direct ByteBuffer: {}, error message: {}\",\n+          buffer.getClass().getName(), e.getMessage());\n+    }\n+  }\n+\n+  /**", "originalCommit": "7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0Mzc2OA==", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r466143768", "bodyText": "we have a test for the method. java 8 version or java 11 version will be tested depending on the jvm", "author": "yuzhu", "createdAt": "2020-08-06T04:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3OTIxOA=="}], "type": "inlineReview"}, {"oid": "2f3cd9c0efc833e51ee839875f431a41bcd66f25", "url": "https://github.com/Alluxio/alluxio/commit/2f3cd9c0efc833e51ee839875f431a41bcd66f25", "message": "add unit test", "committedDate": "2020-08-06T04:51:17Z", "type": "commit"}, {"oid": "6fbf7b158bc07c71941af7cc7d9d133f2d55dff0", "url": "https://github.com/Alluxio/alluxio/commit/6fbf7b158bc07c71941af7cc7d9d133f2d55dff0", "message": "fix checkstyle", "committedDate": "2020-08-06T05:15:58Z", "type": "commit"}]}