{"pr_number": 12174, "pr_title": "Implement a local first raft client for improved journal performance", "pr_createdAt": "2020-10-05T03:26:46Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12174", "timeline": [{"oid": "269bc24fa60d79d5da8656242c93ece30863d1b7", "url": "https://github.com/Alluxio/alluxio/commit/269bc24fa60d79d5da8656242c93ece30863d1b7", "message": "Update comments", "committedDate": "2020-10-05T16:32:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1NzE1MA==", "url": "https://github.com/Alluxio/alluxio/pull/12174#discussion_r499757150", "bodyText": "How long and how frequently will the client retry? is it configurable?", "author": "LuQQiu", "createdAt": "2020-10-05T17:25:34Z", "path": "core/server/common/src/main/java/alluxio/master/journal/raft/LocalFirstRaftClient.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.master.journal.raft;\n+\n+import alluxio.util.LogUtils;\n+\n+import org.apache.ratis.client.RaftClient;\n+import org.apache.ratis.protocol.AlreadyClosedException;\n+import org.apache.ratis.protocol.ClientId;\n+import org.apache.ratis.protocol.Message;\n+import org.apache.ratis.protocol.NotLeaderException;\n+import org.apache.ratis.protocol.RaftClientReply;\n+import org.apache.ratis.protocol.RaftClientRequest;\n+import org.apache.ratis.server.RaftServer;\n+import org.apache.ratis.util.TimeDuration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeoutException;\n+import java.util.function.Supplier;\n+\n+/**\n+ * A client to send messages to a raft server with a strategy to attempt sending them locally first.\n+ */\n+public class LocalFirstRaftClient implements Closeable {\n+  private static final Logger LOG = LoggerFactory.getLogger(LocalFirstRaftClient.class);\n+  private final RaftServer mServer;\n+  private final Supplier<RaftClient> mClientSupplier;\n+  private ClientId mClientId;\n+  private volatile RaftClient mClient;\n+\n+  /**\n+   * @param server the local raft server\n+   * @param clientSupplier a function for building a remote raft client\n+   * @param clientId the client id\n+   */\n+  public LocalFirstRaftClient(RaftServer server, Supplier<RaftClient> clientSupplier,\n+      ClientId clientId) {\n+    mServer = server;\n+    mClientSupplier = clientSupplier;\n+    mClientId = clientId;\n+  }\n+\n+  /**\n+   * Sends a request to raft server asynchronously.\n+   * @param message the message to send\n+   * @param timeout the time duration to wait before giving up on the request\n+   * @return a future of the server reply\n+   * @throws IOException if an exception occured while sending the request\n+   */\n+  public CompletableFuture<RaftClientReply> sendAsync(Message message,\n+      TimeDuration timeout) throws IOException {\n+    if (mClient == null) {\n+      return sendLocalRequest(message, timeout);\n+    } else {\n+      return sendRemoteRequest(message);\n+    }\n+  }\n+\n+  private CompletableFuture<RaftClientReply> sendLocalRequest(Message message,\n+      TimeDuration timeout) throws IOException {\n+    return mServer.submitClientRequestAsync(", "originalCommit": "269bc24fa60d79d5da8656242c93ece30863d1b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2Mzc5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12174#discussion_r499763797", "bodyText": "This class will rebuild a client every time a client throws an AlreadyClosedException. The actual retry logic for sending a message is implemented by the caller and is not changed in this PR.", "author": "bf8086", "createdAt": "2020-10-05T17:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1NzE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MDExNA==", "url": "https://github.com/Alluxio/alluxio/pull/12174#discussion_r499760114", "bodyText": "Why this is needed?", "author": "LuQQiu", "createdAt": "2020-10-05T17:30:56Z", "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "diffHunk": "@@ -338,6 +338,7 @@ private RaftClient createClient() {\n         .build();\n     return RaftClient.newBuilder()\n         .setRaftGroup(mRaftGroup)\n+        .setClientId(mClientId)", "originalCommit": "269bc24fa60d79d5da8656242c93ece30863d1b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2NjU2MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12174#discussion_r499766561", "bodyText": "It's for easier tracking so requests from same node will have the same client id.", "author": "bf8086", "createdAt": "2020-10-05T17:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MDExNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNjY2MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12174#discussion_r499816661", "bodyText": "Should this be configurable? I can't tell if 100ms is too short or too long. This means we will retry 10x per second forever? That seems quite frequent.", "author": "gpang", "createdAt": "2020-10-05T19:17:08Z", "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "diffHunk": "@@ -525,14 +528,20 @@ private void catchUp(JournalStateMachine stateMachine, RaftClient client)\n       long gainPrimacySN = ThreadLocalRandom.current().nextLong(Long.MIN_VALUE, 0);\n       LOG.info(\"Performing catchup. Last applied SN: {}. Catchup ID: {}\",\n           lastAppliedSN, gainPrimacySN);\n-      CompletableFuture<RaftClientReply> future = client.sendAsync(\n-          toRaftMessage(JournalEntry.newBuilder().setSequenceNumber(gainPrimacySN).build()));\n+      Exception ex;\n       try {\n-        future.get(5, TimeUnit.SECONDS);\n-      } catch (TimeoutException | ExecutionException e) {\n-        client.getClientRpc().handleException(mPeerId,\n-            e instanceof ExecutionException ? e.getCause() : e, true);\n-        LOG.info(\"Exception submitting term start entry: {}\", e.toString());\n+        CompletableFuture<RaftClientReply> future = client.sendAsync(\n+            toRaftMessage(JournalEntry.newBuilder().setSequenceNumber(gainPrimacySN).build()),\n+            TimeDuration.valueOf(5, TimeUnit.SECONDS));\n+        RaftClientReply reply = future.get(5, TimeUnit.SECONDS);\n+        ex = reply.getException();\n+      } catch (TimeoutException | ExecutionException | IOException e) {\n+        ex = e;\n+      }\n+      if (ex != null) {\n+        LOG.info(\"Exception submitting term start entry: {}\", ex.toString());\n+        // avoid excessive retries when server is not ready\n+        Thread.sleep(100);", "originalCommit": "269bc24fa60d79d5da8656242c93ece30863d1b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgzNTMyOA==", "url": "https://github.com/Alluxio/alluxio/pull/12174#discussion_r499835328", "bodyText": "Yeah it is still significantly better than retrying immediately and blowing up the logs in no time. I added a configuration property for 1s.", "author": "bf8086", "createdAt": "2020-10-05T19:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNjY2MQ=="}], "type": "inlineReview"}, {"oid": "608657b282e7f7a27ce5639b07bf07646f28c912", "url": "https://github.com/Alluxio/alluxio/commit/608657b282e7f7a27ce5639b07bf07646f28c912", "message": "Use local raft api for journal writer", "committedDate": "2020-10-05T22:08:03Z", "type": "commit"}, {"oid": "393755d45854772085baf21d091b9239cfa2a1ea", "url": "https://github.com/Alluxio/alluxio/commit/393755d45854772085baf21d091b9239cfa2a1ea", "message": "fix checkstyles", "committedDate": "2020-10-05T22:08:03Z", "type": "commit"}, {"oid": "c37599509c39273d0954264ba4ff540c2d5ecff0", "url": "https://github.com/Alluxio/alluxio/commit/c37599509c39273d0954264ba4ff540c2d5ecff0", "message": "Allow local journal write to fallback to remote writer", "committedDate": "2020-10-05T22:08:04Z", "type": "commit"}, {"oid": "dedc2e1bbd086f68158da3e40f3579a59310b253", "url": "https://github.com/Alluxio/alluxio/commit/dedc2e1bbd086f68158da3e40f3579a59310b253", "message": "prevent switching from remote back to local", "committedDate": "2020-10-05T22:08:04Z", "type": "commit"}, {"oid": "eedac0d6fe86bb9e825c0a40014c741066415aed", "url": "https://github.com/Alluxio/alluxio/commit/eedac0d6fe86bb9e825c0a40014c741066415aed", "message": "Improve timeout handling and retry", "committedDate": "2020-10-05T22:08:04Z", "type": "commit"}, {"oid": "c81ef9f1ff0a6ea6edad3e2dc29be5e64f7e7d8f", "url": "https://github.com/Alluxio/alluxio/commit/c81ef9f1ff0a6ea6edad3e2dc29be5e64f7e7d8f", "message": "Minor refactor", "committedDate": "2020-10-05T22:08:04Z", "type": "commit"}, {"oid": "80fd0b799e2458f82d537cafaee4bd6fe36546a2", "url": "https://github.com/Alluxio/alluxio/commit/80fd0b799e2458f82d537cafaee4bd6fe36546a2", "message": "Update comments", "committedDate": "2020-10-05T22:08:04Z", "type": "commit"}, {"oid": "6762535d90022fac0b33407c194c47df5806adc3", "url": "https://github.com/Alluxio/alluxio/commit/6762535d90022fac0b33407c194c47df5806adc3", "message": "Add some configuration properties", "committedDate": "2020-10-05T22:08:04Z", "type": "commit"}, {"oid": "6762535d90022fac0b33407c194c47df5806adc3", "url": "https://github.com/Alluxio/alluxio/commit/6762535d90022fac0b33407c194c47df5806adc3", "message": "Add some configuration properties", "committedDate": "2020-10-05T22:08:04Z", "type": "forcePushed"}]}