{"pr_number": 11449, "pr_title": "Improve incremental active sync", "pr_createdAt": "2020-05-18T19:45:32Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11449", "timeline": [{"oid": "cac3399cf5021690abc724b356a1895dc8b87fef", "url": "https://github.com/Alluxio/alluxio/commit/cac3399cf5021690abc724b356a1895dc8b87fef", "message": "Updates for incremental sync", "committedDate": "2020-05-18T19:44:25Z", "type": "commit"}, {"oid": "dcef28d77dae90e718bb5f5b110f67a87b2ef5e2", "url": "https://github.com/Alluxio/alluxio/commit/dcef28d77dae90e718bb5f5b110f67a87b2ef5e2", "message": "Fix style", "committedDate": "2020-05-18T19:52:15Z", "type": "commit"}, {"oid": "c9cb07b048cf5081d1fc11213e3c6e37327c45b1", "url": "https://github.com/Alluxio/alluxio/commit/c9cb07b048cf5081d1fc11213e3c6e37327c45b1", "message": "updates", "committedDate": "2020-05-18T22:37:44Z", "type": "commit"}, {"oid": "11b1d99d4023e3f63bdf2f0324d51a78d311400a", "url": "https://github.com/Alluxio/alluxio/commit/11b1d99d4023e3f63bdf2f0324d51a78d311400a", "message": "update", "committedDate": "2020-05-20T00:12:21Z", "type": "commit"}, {"oid": "a946e6f07bfa482d9170b339798840a5c334c76e", "url": "https://github.com/Alluxio/alluxio/commit/a946e6f07bfa482d9170b339798840a5c334c76e", "message": "Revert changes to lockResource\n\n- It's possible they are causing deadlock. Have not yet determined why", "committedDate": "2020-05-20T03:03:29Z", "type": "forcePushed"}, {"oid": "cc80b1fb23e9b37acfb610084ca327b6344662ec", "url": "https://github.com/Alluxio/alluxio/commit/cc80b1fb23e9b37acfb610084ca327b6344662ec", "message": "Revert changes to lockResource\n\n- It's possible they are causing deadlock. Have not yet determined why", "committedDate": "2020-05-20T03:45:16Z", "type": "commit"}, {"oid": "cc80b1fb23e9b37acfb610084ca327b6344662ec", "url": "https://github.com/Alluxio/alluxio/commit/cc80b1fb23e9b37acfb610084ca327b6344662ec", "message": "Revert changes to lockResource\n\n- It's possible they are causing deadlock. Have not yet determined why", "committedDate": "2020-05-20T03:45:16Z", "type": "forcePushed"}, {"oid": "7055a7a9917174a07db6493cce3ec12057eff0c5", "url": "https://github.com/Alluxio/alluxio/commit/7055a7a9917174a07db6493cce3ec12057eff0c5", "message": "Fix failing test", "committedDate": "2020-05-20T17:26:42Z", "type": "commit"}, {"oid": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "url": "https://github.com/Alluxio/alluxio/commit/78fd91ae391c4798106c6070f071c7f2fda33a3f", "message": "Revert changes to LockResource", "committedDate": "2020-05-20T19:34:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNzMwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428817309", "bodyText": "Could you add the implications of too high or too low value of this?", "author": "gpang", "createdAt": "2020-05-21T17:56:19Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -1973,7 +1973,8 @@ public String toString() {\n           .build();\n   public static final PropertyKey MASTER_UFS_ACTIVE_SYNC_THREAD_POOL_SIZE =\n       new Builder(Name.MASTER_UFS_ACTIVE_SYNC_THREAD_POOL_SIZE)\n-          .setDefaultValue(\"3\")\n+          .setDefaultSupplier(() -> Math.max(2, Runtime.getRuntime().availableProcessors() / 2),\n+              \"The number of threads used by the active sync provider process active sync events\")\n           .setDescription(\"Max number of threads used to perform active sync\")", "originalCommit": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODE0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428998141", "bodyText": "updated", "author": "ZacBlanco", "createdAt": "2020-05-22T01:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNzMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxODAzMA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428818030", "bodyText": "is this supposed to be MASTER_UFS_ACTIVE_SYNC_THREAD_POOL_SIZE?", "author": "gpang", "createdAt": "2020-05-21T17:57:35Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -384,12 +384,18 @@\n       1, TimeUnit.MINUTES, new LinkedBlockingQueue<>(),\n       ThreadFactoryUtils.build(\"alluxio-ufs-sync-prefetch-%d\", false));\n \n-  final ThreadPoolExecutor mMetadataSyncExecutor = new ThreadPoolExecutor(\n+  final ThreadPoolExecutor mSyncMetadataExecutor = new ThreadPoolExecutor(\n       ServerConfiguration.getInt(PropertyKey.MASTER_METADATA_SYNC_EXECUTOR_POOL_SIZE),\n       ServerConfiguration.getInt(PropertyKey.MASTER_METADATA_SYNC_EXECUTOR_POOL_SIZE),\n       1, TimeUnit.MINUTES, new LinkedBlockingQueue<>(),\n       ThreadFactoryUtils.build(\"alluxio-ufs-sync-%d\", false));\n \n+  final ThreadPoolExecutor mActiveSyncMetadataExecutor = new ThreadPoolExecutor(\n+      ServerConfiguration.getInt(PropertyKey.MASTER_METADATA_SYNC_EXECUTOR_POOL_SIZE),", "originalCommit": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk2ODMyMw==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428968323", "bodyText": "no", "author": "ZacBlanco", "createdAt": "2020-05-21T23:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxODAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyMjI2MA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428822260", "bodyText": "Why was this removed?", "author": "gpang", "createdAt": "2020-05-21T18:05:14Z", "path": "core/server/master/src/main/java/alluxio/master/file/activesync/ActiveSyncManager.java", "diffHunk": "@@ -342,10 +348,6 @@ public void stopSyncAndJournal(RpcContext rpcContext, AlluxioURI syncPoint)\n     }\n     try (LockResource r = new LockResource(mLock)) {\n       MountTable.Resolution resolution = mMountTable.resolve(syncPoint);\n-      if (resolution == null) {", "originalCommit": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk1NTc5Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428955793", "bodyText": "resolve is not nullable, so resolution is never null", "author": "ZacBlanco", "createdAt": "2020-05-21T22:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyMjI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MjU4NA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428972584", "bodyText": "Also, if you inspect the code, we either throw an exception or always return a non-null object", "author": "ZacBlanco", "createdAt": "2020-05-21T23:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyMjI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1Nzc2MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428857761", "bodyText": "NIT: can we add the mount id, and maybe the mount path in this message?", "author": "gpang", "createdAt": "2020-05-21T19:12:42Z", "path": "core/server/master/src/main/java/alluxio/master/file/activesync/ActiveSyncer.java", "diffHunk": "@@ -61,11 +68,16 @@ public ActiveSyncer(FileSystemMaster fileSystemMaster, ActiveSyncManager syncMan\n     mSyncManager = syncManager;\n     mMountId = mountId;\n     mMountTable = mountTable;\n+    mSyncTasks = new LinkedBlockingQueue<>(32);\n   }\n \n   @Override\n   public void heartbeat() {\n     LOG.debug(\"start Active Syncer heartbeat\");", "originalCommit": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk1NTkxOA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428955918", "bodyText": "sure", "author": "ZacBlanco", "createdAt": "2020-05-21T22:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1Nzc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2MDc2MA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428860760", "bodyText": "should this be mSyncTasks.peek().isDone()? Don't we want to remove the ones that are considered done?", "author": "gpang", "createdAt": "2020-05-21T19:18:45Z", "path": "core/server/master/src/main/java/alluxio/master/file/activesync/ActiveSyncer.java", "diffHunk": "@@ -61,11 +68,16 @@ public ActiveSyncer(FileSystemMaster fileSystemMaster, ActiveSyncManager syncMan\n     mSyncManager = syncManager;\n     mMountId = mountId;\n     mMountTable = mountTable;\n+    mSyncTasks = new LinkedBlockingQueue<>(32);\n   }\n \n   @Override\n   public void heartbeat() {\n     LOG.debug(\"start Active Syncer heartbeat\");\n+    // Remove any previously completed sync tasks\n+    while (mSyncTasks.peek() != null && !mSyncTasks.peek().isDone()) {", "originalCommit": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NDMwNA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428864304", "bodyText": "Was this wrong before, journaling too early?", "author": "gpang", "createdAt": "2020-05-21T19:25:41Z", "path": "core/server/master/src/main/java/alluxio/master/file/activesync/ActiveSyncer.java", "diffHunk": "@@ -74,29 +86,47 @@ public void heartbeat() {\n     }\n \n     try {\n-      UfsManager.UfsClient ufsclient = mMountTable.getUfsClient(mMountId);\n+      UfsManager.UfsClient ufsclient = Objects.requireNonNull(mMountTable.getUfsClient(mMountId));\n       try (CloseableResource<UnderFileSystem> ufsResource = ufsclient.acquireUfsResource()) {\n         UnderFileSystem ufs = ufsResource.get();\n         if (ufs.supportsActiveSync()) {\n           SyncInfo syncInfo = ufs.getActiveSyncInfo();\n           // This returns a list of ufsUris that we need to sync.\n           Set<AlluxioURI> ufsSyncPoints = syncInfo.getSyncPoints();\n           // Parallelize across sync points\n-          List<Callable<Void>> tasksPerSyncPoint = new ArrayList<>(ufsSyncPoints.size());\n+          List<CompletableFuture<Long>> tasksPerSync = new ArrayList<>();\n           for (AlluxioURI ufsUri : ufsSyncPoints) {\n-            tasksPerSyncPoint.add(() -> {\n+            tasksPerSync.add(CompletableFuture.supplyAsync(() -> {\n               processSyncPoint(ufsUri, syncInfo);\n-              return null;\n-            });\n+              return syncInfo.getTxId();\n+            }, mSyncManager.getExecutor()));\n           }\n-          mSyncManager.getExecutor().invokeAll(tasksPerSyncPoint);\n           // Journal the latest processed txId\n-          mFileSystemMaster.recordActiveSyncTxid(syncInfo.getTxId(), mMountId);", "originalCommit": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk1NjIzMg==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428956232", "bodyText": "no, it worked properly before because the sync occurred synchronously within the heartbeat", "author": "ZacBlanco", "createdAt": "2020-05-21T22:49:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NDMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NTcxOA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428865718", "bodyText": "If the first task in the queue is slow for some reason, would that hold up all the rest of the processing, even if the rest of the tasks have completed?", "author": "gpang", "createdAt": "2020-05-21T19:28:35Z", "path": "core/server/master/src/main/java/alluxio/master/file/activesync/ActiveSyncer.java", "diffHunk": "@@ -74,29 +86,47 @@ public void heartbeat() {\n     }\n \n     try {\n-      UfsManager.UfsClient ufsclient = mMountTable.getUfsClient(mMountId);\n+      UfsManager.UfsClient ufsclient = Objects.requireNonNull(mMountTable.getUfsClient(mMountId));\n       try (CloseableResource<UnderFileSystem> ufsResource = ufsclient.acquireUfsResource()) {\n         UnderFileSystem ufs = ufsResource.get();\n         if (ufs.supportsActiveSync()) {\n           SyncInfo syncInfo = ufs.getActiveSyncInfo();\n           // This returns a list of ufsUris that we need to sync.\n           Set<AlluxioURI> ufsSyncPoints = syncInfo.getSyncPoints();\n           // Parallelize across sync points\n-          List<Callable<Void>> tasksPerSyncPoint = new ArrayList<>(ufsSyncPoints.size());\n+          List<CompletableFuture<Long>> tasksPerSync = new ArrayList<>();\n           for (AlluxioURI ufsUri : ufsSyncPoints) {\n-            tasksPerSyncPoint.add(() -> {\n+            tasksPerSync.add(CompletableFuture.supplyAsync(() -> {\n               processSyncPoint(ufsUri, syncInfo);\n-              return null;\n-            });\n+              return syncInfo.getTxId();\n+            }, mSyncManager.getExecutor()));\n           }\n-          mSyncManager.getExecutor().invokeAll(tasksPerSyncPoint);\n           // Journal the latest processed txId\n-          mFileSystemMaster.recordActiveSyncTxid(syncInfo.getTxId(), mMountId);\n+          CompletableFuture<Void> syncTask =\n+              CompletableFuture.allOf(tasksPerSync.toArray(new CompletableFuture<?>[0]))\n+              .thenRunAsync(() -> mFileSystemMaster\n+                      .recordActiveSyncTxid(syncInfo.getTxId(), mMountId),\n+                  mSyncManager.getExecutor());\n+          while (!mSyncTasks.offer(syncTask)) {", "originalCommit": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk2MDMyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428960325", "bodyText": "its possible that it holds up removing tasks from the queue, though for this to happen is would require filling the incremental sync queue which right now holds up to 32 items. Given the standard heartbeat interval of 30 seconds that means this would need to take 16 minutes to finish the incremental sync.\nI can try improving this by using a set to iterate over all of the elements and removing any that are finished, but would require iterating over all futures. I think for the size of the futures added to this queue that is a reasonable solution", "author": "ZacBlanco", "createdAt": "2020-05-21T23:02:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NTcxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODYyNg==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428998626", "bodyText": "updated", "author": "ZacBlanco", "createdAt": "2020-05-22T01:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NTcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NzI4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428867285", "bodyText": "Is this supposed to be final? Can the previous EventBatch batch = ... just be final?", "author": "gpang", "createdAt": "2020-05-21T19:31:30Z", "path": "underfs/hdfs/src/main/java/alluxio/underfs/hdfs/activesync/SupportedHdfsActiveSyncProvider.java", "diffHunk": "@@ -258,38 +273,52 @@ public void stopSync(AlluxioURI ufsUri) {\n    * @param eventStream event stream\n    */\n   public void pollEvent(DFSInotifyEventInputStream eventStream) {\n-    EventBatch batch;\n     LOG.debug(\"Polling thread starting, with timeout {} ms\", mActiveUfsPollTimeoutMs);\n-    int count = 0;\n     long start = System.currentTimeMillis();\n \n     long behind = eventStream.getTxidsBehindEstimate();\n \n     while (!Thread.currentThread().isInterrupted()) {\n       try {\n-        batch = eventStream.poll(mActiveUfsPollTimeoutMs, TimeUnit.MILLISECONDS);\n \n-        if (batch != null) {\n-          long txId = batch.getTxid();\n-          count += batch.getEvents().length;\n-          for (Event event : batch.getEvents()) {\n-            processEvent(event, mUfsUriList, txId);\n+        List<Callable<Integer>> process = new LinkedList<>();\n+        for (int i = 0; i < mBatchSize; i++) {\n+          EventBatch batch = eventStream.poll(mActiveUfsPollTimeoutMs, TimeUnit.MILLISECONDS);\n+          if (batch == null) {\n+            break;\n           }\n+          EventBatch finalBatch = batch;", "originalCommit": "78fd91ae391c4798106c6070f071c7f2fda33a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODY3OA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r428998678", "bodyText": "updated", "author": "ZacBlanco", "createdAt": "2020-05-22T01:33:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NzI4NQ=="}], "type": "inlineReview"}, {"oid": "33f8a60a08b124e386817b7a2f9a02d21dd06863", "url": "https://github.com/Alluxio/alluxio/commit/33f8a60a08b124e386817b7a2f9a02d21dd06863", "message": "Address comments", "committedDate": "2020-05-22T01:30:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ2NjY3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r429466672", "bodyText": "check return value and log errors?", "author": "yuzhu", "createdAt": "2020-05-22T21:52:45Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -3103,19 +3118,18 @@ public void activeSyncMetadata(AlluxioURI path, Collection<AlluxioURI> changedFi\n     try (RpcContext rpcContext = createRpcContext()) {\n       if (changedFiles == null) {\n         // full sync\n-        long start = System.currentTimeMillis();\n-\n         // Set sync interval to 0 to force a sync.\n         FileSystemMasterCommonPOptions options =\n             FileSystemMasterCommonPOptions.newBuilder().setSyncIntervalMs(0).build();\n-        try {\n-          syncMetadata(rpcContext, path, options, DescendantType.ALL, null, null, null);\n-        } catch (AccessControlException e) {\n-          // This shouldn never happen because the permission check function is passed as null.\n-          LOG.error(\"Active sync full scan failed on {}\", path, e);\n+        LockingScheme scheme = createSyncLockingScheme(path, options, false);\n+        try (LockedInodePath inodePath = mInodeTree.lockInodePath(scheme)) {\n+          InodeSyncStream sync = new InodeSyncStream(inodePath, mActiveSyncMetadataExecutor, this,\n+              mInodeTree, mInodeStore, mInodeLockManager, mMountTable, rpcContext,\n+              DescendantType.ALL, mUfsSyncPathCache, options, false, false, false);\n+          sync.sync();", "originalCommit": "33f8a60a08b124e386817b7a2f9a02d21dd06863", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY0NzIwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r430647205", "bodyText": "updated", "author": "ZacBlanco", "createdAt": "2020-05-26T19:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ2NjY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ2NzQ5NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r429467495", "bodyText": "check return value and log errors?", "author": "yuzhu", "createdAt": "2020-05-22T21:53:56Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -3125,9 +3139,13 @@ public void activeSyncMetadata(AlluxioURI path, Collection<AlluxioURI> changedFi\n             // Set sync interval to 0 to force a sync.\n             FileSystemMasterCommonPOptions options =\n                 FileSystemMasterCommonPOptions.newBuilder().setSyncIntervalMs(0).build();\n-            try {\n-              syncMetadata(rpcContext, changedFile, options, DescendantType.ONE, null, null, null);\n-            } catch (InvalidPathException | AccessControlException e) {\n+            LockingScheme scheme = createSyncLockingScheme(changedFile, options, false);\n+            try (LockedInodePath inodePath = mInodeTree.lockInodePath(scheme)) {\n+              InodeSyncStream sync = new InodeSyncStream(inodePath, mActiveSyncMetadataExecutor,\n+                  this, mInodeTree, mInodeStore, mInodeLockManager, mMountTable, rpcContext,\n+                  DescendantType.NONE, mUfsSyncPathCache, options, false, false, false);\n+              sync.sync();", "originalCommit": "33f8a60a08b124e386817b7a2f9a02d21dd06863", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY0NzE2NA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r430647164", "bodyText": "updated", "author": "ZacBlanco", "createdAt": "2020-05-26T19:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ2NzQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDg4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r429474883", "bodyText": "you might want to use computeIfAbsent or putIfAbsent to implement this?  otherwise k concurrent calls to this function with the same path might result in k ufs calls.   Using one of those methods ensures only one call to the UFS is made.", "author": "yuzhu", "createdAt": "2020-05-22T22:09:18Z", "path": "core/server/master/src/main/java/alluxio/underfs/UfsStatusCache.java", "diffHunk": "@@ -132,6 +132,37 @@ public UfsStatus getStatus(AlluxioURI path) {\n     return mStatuses.get(path);\n   }\n \n+  /**\n+   * Attempts to return a status from the cache. If it doesn't exist, reaches to the UFS for it.\n+   *\n+   * @param path the path the retrieve\n+   * @param mountTable the Alluxio mount table\n+   * @return The corresponding {@link UfsStatus} or {@code null} if there is none stored\n+   */\n+  @Nullable\n+  public UfsStatus fetchStatusIfAbsent(AlluxioURI path, MountTable mountTable)\n+      throws InvalidPathException {\n+    UfsStatus status = mStatuses.get(path);\n+    if (status != null) {\n+      return status;\n+    }", "originalCommit": "33f8a60a08b124e386817b7a2f9a02d21dd06863", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU2NzQ1Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r430567456", "bodyText": "Unfortunately I can't with the current implementation or else it will result in deadlock. This function calls addStatus which actually does the insert into the map. Calling ConcurrentHashMap#put while within a computeIfAbsent function will deadlock", "author": "ZacBlanco", "createdAt": "2020-05-26T16:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0MTQ3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r431441472", "bodyText": "instead of calling addStatus perhaps you could just return the right value, which will result in the values being inserted into the map by computeIfAbsent right?", "author": "yuzhu", "createdAt": "2020-05-27T21:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0MjE3MA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r431442170", "bodyText": "I use addStatus because it performs a check to make sure the status has the correct naming scheme.", "author": "ZacBlanco", "createdAt": "2020-05-27T21:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0MjU3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r431442572", "bodyText": "I guess I can refactor out the check and put it elsewhere. It just seems more error prone because then statuses could still be inserted without that check performed", "author": "ZacBlanco", "createdAt": "2020-05-27T21:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5OTc3MA==", "url": "https://github.com/Alluxio/alluxio/pull/11449#discussion_r431499770", "bodyText": "i see, sounds good to me", "author": "yuzhu", "createdAt": "2020-05-27T23:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDg4Mw=="}], "type": "inlineReview"}, {"oid": "c94c44b735c0c9d5b3bc9147f88956f053b92514", "url": "https://github.com/Alluxio/alluxio/commit/c94c44b735c0c9d5b3bc9147f88956f053b92514", "message": "Add logging on active sync\n\nI use debug logging because the sync stream will report any\nfailures to sync in the logs already. These messages are\nredundant to let users know if a sync returned false", "committedDate": "2020-05-26T19:07:39Z", "type": "commit"}, {"oid": "4c3fd5b31bc443af2d6c42e73d569ce303c1c81e", "url": "https://github.com/Alluxio/alluxio/commit/4c3fd5b31bc443af2d6c42e73d569ce303c1c81e", "message": "Update descendant type on incremental sync", "committedDate": "2020-05-28T17:00:21Z", "type": "commit"}]}