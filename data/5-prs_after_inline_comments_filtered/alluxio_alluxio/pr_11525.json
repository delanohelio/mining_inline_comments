{"pr_number": 11525, "pr_title": "Improve robustness of LocalCacheManager", "pr_createdAt": "2020-06-08T02:00:02Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11525", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyNzg2NA==", "url": "https://github.com/Alluxio/alluxio/pull/11525#discussion_r436427864", "bodyText": "move the IO operations inside LocalCacheManager under page locks to coordinate with other threads, also procted by NoExceptionManager", "author": "apc999", "createdAt": "2020-06-08T02:03:28Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java", "diffHunk": "@@ -132,47 +134,40 @@ public int read(byte[] b, int off, int len) throws IOException {\n     if (mPosition >= mStatus.getLength()) { // at end of file\n       return -1;\n     }\n-    int bytesRead = 0;\n+    int totalBytesRead = 0;\n     long lengthToRead = Math.min(len, mStatus.getLength() - mPosition);\n     // for each page, check if it is available in the cache\n-    while (bytesRead < lengthToRead) {\n+    while (totalBytesRead < lengthToRead) {\n       long currentPage = mPosition / mPageSize;\n       int currentPageOffset = (int) (mPosition % mPageSize);\n-      int bytesLeftInPage = (int) Math.min(mPageSize - currentPageOffset, lengthToRead - bytesRead);\n+      int bytesLeftInPage =\n+          (int) Math.min(mPageSize - currentPageOffset, lengthToRead - totalBytesRead);\n       PageId pageId = new PageId(mStatus.getFileIdentifier(), currentPage);\n-      try (ReadableByteChannel cachedData = mCacheManager.get(pageId, currentPageOffset)) {", "originalCommit": "23b1d9d46d56dda72a007ac3a379480f29067ad3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6ea999bcb3585ede16dad168038ae108d1f3fae0", "url": "https://github.com/Alluxio/alluxio/commit/6ea999bcb3585ede16dad168038ae108d1f3fae0", "message": "Fix race condition in LocalCacheManager", "committedDate": "2020-06-08T07:16:28Z", "type": "commit"}, {"oid": "6ea999bcb3585ede16dad168038ae108d1f3fae0", "url": "https://github.com/Alluxio/alluxio/commit/6ea999bcb3585ede16dad168038ae108d1f3fae0", "message": "Fix race condition in LocalCacheManager", "committedDate": "2020-06-08T07:16:28Z", "type": "forcePushed"}, {"oid": "87ace2edcb55bf513cc5d4e69291e6dcf1bbe314", "url": "https://github.com/Alluxio/alluxio/commit/87ace2edcb55bf513cc5d4e69291e6dcf1bbe314", "message": "Fix tests", "committedDate": "2020-06-08T08:16:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4MDgzOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11525#discussion_r436880839", "bodyText": "Should we have this logic here or leave it to NoExceptionCacheManager?", "author": "calvinjia", "createdAt": "2020-06-08T17:39:28Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -445,18 +445,33 @@ private boolean deletePage(PageId pageId, PageInfo pageInfo) {\n     return true;\n   }\n \n-  @Nullable\n-  private ReadableByteChannel getPage(PageId pageId, int offset) {\n-    ReadableByteChannel ret;\n-    try {\n-      ret = mPageStore.get(pageId, offset);\n+  private int getPage(PageId pageId, int offset, int bytesToRead, byte[] buffer,\n+      int offsetInBuffer) {\n+    try (ReadableByteChannel chan = mPageStore.get(pageId, offset)) {\n+      // wrap return byte array in a bytebuffer and set the pos/limit for the page read\n+      ByteBuffer buf = ByteBuffer.wrap(buffer);\n+      buf.position(offsetInBuffer);\n+      buf.limit(offsetInBuffer + bytesToRead);\n+      // read data from cache\n+      while (buf.position() != buf.limit()) {\n+        if (chan.read(buf) == -1) {\n+          break;\n+        }\n+      }\n+      if (buf.position() != buf.limit()) {\n+        // data read from page store is inconsistent from the metastore\n+        Metrics.GET_ERRORS_FAILED_READ.inc();\n+        throw new IOException(String.format(\n+            \"Failed to read page {}: supposed to read {} bytes, {} bytes actually read\",\n+            pageId, bytesToRead, buf.position() - offsetInBuffer));\n+      }\n     } catch (IOException | PageNotFoundException e) {\n       LOG.error(\"Failed to get existing page {}: {}\", pageId, e);\n       Metrics.GET_ERRORS.inc();\n-      return null;\n+      return -1;", "originalCommit": "87ace2edcb55bf513cc5d4e69291e6dcf1bbe314", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwODY1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11525#discussion_r436908659", "bodyText": "it needs to be here so we can clean up the state https://github.com/Alluxio/alluxio/pull/11525/files#diff-52b3926ca60dbb1ab7f30f23ada07efdR365", "author": "apc999", "createdAt": "2020-06-08T18:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4MDgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA0MDA2Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11525#discussion_r437040066", "bodyText": "got it, thanks.", "author": "calvinjia", "createdAt": "2020-06-08T22:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4MDgzOQ=="}], "type": "inlineReview"}, {"oid": "672872ccf1deb873157302036d7b4dfbeade0a0e", "url": "https://github.com/Alluxio/alluxio/commit/672872ccf1deb873157302036d7b4dfbeade0a0e", "message": "Fix test", "committedDate": "2020-06-11T00:57:04Z", "type": "commit"}, {"oid": "672872ccf1deb873157302036d7b4dfbeade0a0e", "url": "https://github.com/Alluxio/alluxio/commit/672872ccf1deb873157302036d7b4dfbeade0a0e", "message": "Fix test", "committedDate": "2020-06-11T00:57:04Z", "type": "forcePushed"}]}