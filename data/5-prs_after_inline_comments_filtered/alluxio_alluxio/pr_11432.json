{"pr_number": 11432, "pr_title": "Stop worker heartbeat executor first on shutdown", "pr_createdAt": "2020-05-14T23:57:46Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11432", "timeline": [{"oid": "10bb5641042bfc3224ff933a560d48a2c5dc935f", "url": "https://github.com/Alluxio/alluxio/commit/10bb5641042bfc3224ff933a560d48a2c5dc935f", "message": "Interrupt worker heartbeat thread on shutdown", "committedDate": "2020-05-14T23:33:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MDYzNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r425560635", "bodyText": "Can you try swapping below two lines in DefaultBlockWorker::stop() instead of this logic?\n// Stop heart-beat executors and clients.\nmResourceCloser.close();\n// Stop the base. (closes executors.)\nsuper.stop();", "author": "ggezer", "createdAt": "2020-05-15T04:33:18Z", "path": "core/server/worker/src/main/java/alluxio/worker/block/DefaultBlockWorker.java", "diffHunk": "@@ -621,19 +621,33 @@ private Metrics() {} // prevent instantiation\n   @NotThreadSafe\n   public final class StorageChecker implements HeartbeatExecutor {\n \n+    private volatile boolean mClosed = false;\n+    private final AtomicReference<Thread> mThread = new AtomicReference<>(null);\n+\n     @Override\n     public void heartbeat() {\n+      if (mClosed) {\n+        return;\n+      }\n+      mThread.set(Thread.currentThread());\n       try {\n         mBlockStore.checkStorage();\n       } catch (Exception e) {\n         LOG.warn(\"Failed to check storage: {}\", e.toString());\n         LOG.debug(\"Exception: \", e);\n       }\n+      mThread.set(null);\n     }\n \n     @Override\n     public void close() {\n-      // Nothing to clean up", "originalCommit": "10bb5641042bfc3224ff933a560d48a2c5dc935f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYyNTc2Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r425625767", "bodyText": "Hmm so I tried this and it worked (the worker shut down in a timely manner)\nBut I don't quite understand why. super.stop() eventually calls mExecutorService.shutdownNow() which should interrupt the threads and stop them from executing.\nBut if the abstract client doesn't have the logic to respond to interrupts that I added here:\nhttps://github.com/Alluxio/alluxio/pull/11432/files#diff-d7dc60da6f1005850b481cc5792912c5R213-R217\nI don't understand why the threads are exiting now?", "author": "ZacBlanco", "createdAt": "2020-05-15T07:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MDYzNQ=="}], "type": "inlineReview"}, {"oid": "2e4cbde6b7d0d020816e74912efa828c783061aa", "url": "https://github.com/Alluxio/alluxio/commit/2e4cbde6b7d0d020816e74912efa828c783061aa", "message": "Revert \"Interrupt worker heartbeat thread on shutdown\"\n\nThis reverts commit 10bb5641042bfc3224ff933a560d48a2c5dc935f.", "committedDate": "2020-05-15T18:33:05Z", "type": "commit"}, {"oid": "7232652b4ae290e49e8204f0fe4896c6cd8a5ad9", "url": "https://github.com/Alluxio/alluxio/commit/7232652b4ae290e49e8204f0fe4896c6cd8a5ad9", "message": "Swap abstract worker shutdown with resource closer", "committedDate": "2020-05-15T18:33:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426011125", "bodyText": "It seems like this order is important. Do we know why this has to be the order, and can we add that into the comments here? It is not obvious with the code.", "author": "gpang", "createdAt": "2020-05-15T19:41:57Z", "path": "core/server/worker/src/main/java/alluxio/worker/block/DefaultBlockWorker.java", "diffHunk": "@@ -251,10 +251,10 @@ public void start(WorkerNetAddress address) throws IOException {\n    */\n   @Override\n   public void stop() throws IOException {\n-    // Stop heart-beat executors and clients.\n-    mResourceCloser.close();\n     // Stop the base. (closes executors.)\n     super.stop();\n+    // Stop heart-beat executors and clients.", "originalCommit": "7232652b4ae290e49e8204f0fe4896c6cd8a5ad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjExMw==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426012113", "bodyText": "I'm still trying to wrap my head around why this even works. Based on the code path the threads don't seem to be daemon threads, and the code path of the heartbeat threads don't indicate anywhere that they respond to thread interrupts.\nI will add a comment once I understand why", "author": "ZacBlanco", "createdAt": "2020-05-15T19:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4MjE2OA==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426082168", "bodyText": "Do you have a consistent repro for this?\nI'd guess we'd still hit this issue without AbstractClient bailing out on interrupt.", "author": "ggezer", "createdAt": "2020-05-15T23:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4MzI2NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426083265", "bodyText": "Looks like BlockMasterSync's heartbeat could be stuck if close here is not reversed?", "author": "ggezer", "createdAt": "2020-05-15T23:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4ODQ1Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426088456", "bodyText": "I have not been able to repro it after only making this change.\nWithout this PR, the consistent repro is\n$ ./bin/alluxio-start.sh master & ./bin/alluxio-start.sh worker & wait\n$ ./bin/alluxio-stop.sh master\n$ ./bin/alluxio-stop.sh worker\nIf you want to grab a jstack during that time you can run:\n$ ./bin/alluxio-start.sh master & ./bin/alluxio-start.sh worker & wait\n$ ./bin/alluxio-stop.sh master && sleep 5 && (./bin/alluxio-stop.sh worker & sleep 1 && jstack -l `jps | grep AlluxioWorker | awk '{print $1}'`)", "author": "ZacBlanco", "createdAt": "2020-05-15T23:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA5MDM0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426090346", "bodyText": "This looks very aggressive, in restarting the master and that strengthens my hypothesis of BlockMasterSync being the culprit. After all, it's the only one that actually closes something in its #close()", "author": "ggezer", "createdAt": "2020-05-15T23:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEyMjY5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426122697", "bodyText": "Looks like this is caused by sharing DefaultBlockWorkerClient::mFileSystemMasterClient with PinListSync.\nAbstractClient's close and connect methods are synchronized. While PinListSync is trying to connect (to a master that is down), DefaultBlockWorker is trying to close the very same client as part of mResourceCloser.close() call. So shutdown will be blocked until the PinListSync times out. This is confirmed by the jstacks in the ticket.\nAs for the mystery, It seems shutting down the base-executor helps bailing PinListSync out and the following call to mResourceCloser.close() doesn't get stuck. This means we don't need that bail-out condition on AbstractClient as it seems to handle interruptions somewhere else.\nThat being said, I believe the proper fix is to host FileSystemClientPool in DefaultBlockWorker instead of a single FileSystemMasterClient. So we can isolate FileSystemMasterClient resources between the DefaultBlockWorker and the PinListSync.", "author": "ggezer", "createdAt": "2020-05-16T06:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyNjA0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426826042", "bodyText": "@ggezer I implemented your suggested changes in the previous comment by creating an FS client pool instead. While at this point clients weren't locked on each other. It seemed that they now all hang trying to connect to the master.\nhttps://pastebin.com/Nc6yVr2q\nThe worker block sync still blocked shutdown:\n\"Worker Block Sync\": sleeping, holding [0x00000006c04cf6a8, 0x00000006c099e598]\n\tat java.lang.Thread.sleep(Native Method)\n\tat alluxio.time.ThreadSleeper.sleep(ThreadSleeper.java:26)\n\tat alluxio.retry.TimeBoundedRetry.attempt(TimeBoundedRetry.java:67)\n\tat alluxio.AbstractClient.connect(AbstractClient.java:209)\n\tat alluxio.AbstractClient.retryRPCInternal(AbstractClient.java:397)\n\tat alluxio.AbstractClient.retryRPC(AbstractClient.java:365)\n\tat alluxio.worker.block.BlockMasterClient.heartbeat(BlockMasterClient.java:190)\n\tat alluxio.worker.block.BlockMasterSync.heartbeat(BlockMasterSync.java:129)\n\tat alluxio.heartbeat.HeartbeatThread.run(HeartbeatThread.java:119)\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)", "author": "ZacBlanco", "createdAt": "2020-05-18T18:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzNTY3OA==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426835678", "bodyText": "I see. Closing the pools is blocked.\n\"alluxio-process-shutdown-hook\" #292 prio=5 os_prio=0 tid=0x00007f6e2c002800 nid=0xdd9f waiting for monitor entry [0x00007f724f8f8000]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n    at alluxio.AbstractClient.close(AbstractClient.java:310)\n    - waiting to lock <0x00000006c04cf6a8> (a alluxio.worker.block.BlockMasterClient)\n    at com.google.common.io.Closer.close(Closer.java:214)\n    at alluxio.worker.block.BlockMasterClientPool.close(BlockMasterClientPool.java:55)\n    at com.google.common.io.Closer.close(Closer.java:214)\n    at alluxio.worker.block.DefaultBlockWorker.stop(DefaultBlockWorker.java:261)\n    at alluxio.Registry.stop(Registry.java:148)", "author": "ggezer", "createdAt": "2020-05-18T19:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODM0Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426838347", "bodyText": "Even though it's quite disruptive I'm OK to swap the lines at this point as I can't see a way around HeartbeatExecutor's limitations.", "author": "ggezer", "createdAt": "2020-05-18T19:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTAzOA==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426839038", "bodyText": "Ideally, we'd like to implement your initial commit as an abstract utility to all heartbeat executors at some point. An issue maybe?", "author": "ggezer", "createdAt": "2020-05-18T19:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk0NDMxNA==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426944314", "bodyText": "@ZacBlanco Do we know why this order works, and the other order didn't?", "author": "gpang", "createdAt": "2020-05-18T23:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk2NTI2MA==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426965260", "bodyText": "I believe this ordering works because super.stop will issue a shutdownNow on the executor which automatically sends an interrupt to all executor threads.\nWith this ordering, no interrupts are sent and we try to manually stop/close the heartbeat threads. Since no interrupt was performed, the heartbeat thread continues trying to connect until timing out.", "author": "ZacBlanco", "createdAt": "2020-05-19T00:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMjU2NA==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r427032564", "bodyText": "@gpang without first interrupting the threads, mResourceCloser.close() gets blocked because AbstractClient.close() is synchronized with AbstractClient.connect() and connect was trying to connect until it times out.", "author": "ggezer", "createdAt": "2020-05-19T05:06:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxMjY2Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r427512663", "bodyText": "Can we add this info as a comment, since this ordering is intentional and critical.", "author": "gpang", "createdAt": "2020-05-19T18:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxNTMwMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r427515301", "bodyText": "updated", "author": "ZacBlanco", "createdAt": "2020-05-19T18:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}], "type": "inlineReview"}, {"oid": "787423189a5d3d2bad0eab9e67cf5c157fd4b26d", "url": "https://github.com/Alluxio/alluxio/commit/787423189a5d3d2bad0eab9e67cf5c157fd4b26d", "message": "Try using client pool", "committedDate": "2020-05-18T19:32:30Z", "type": "commit"}, {"oid": "e5fe11f4a9f2c6c3993e9ea0911f8a5e7b4f565f", "url": "https://github.com/Alluxio/alluxio/commit/e5fe11f4a9f2c6c3993e9ea0911f8a5e7b4f565f", "message": "Revert \"Try using client pool\"\n\nThis reverts commit 787423189a5d3d2bad0eab9e67cf5c157fd4b26d.", "committedDate": "2020-05-18T19:32:47Z", "type": "commit"}, {"oid": "30c0ef0070bda4b2b225c5c02309c095dba44d77", "url": "https://github.com/Alluxio/alluxio/commit/30c0ef0070bda4b2b225c5c02309c095dba44d77", "message": "Add comment", "committedDate": "2020-05-19T18:32:39Z", "type": "commit"}]}