{"pr_number": 12133, "pr_title": "Update sync status after processing the entire sync", "pr_createdAt": "2020-09-23T16:58:44Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12133", "timeline": [{"oid": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e", "url": "https://github.com/Alluxio/alluxio/commit/3f04ef71dde0afc3c92e6efe94111bddc940bb8e", "message": "Update sync status after processing the entire sync", "committedDate": "2020-09-23T16:56:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5OTM4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493799385", "bodyText": "So now, if two RPCs on the same path come in at the same time, we'll end up doing a lot more work, right?", "author": "ZacBlanco", "createdAt": "2020-09-23T18:24:43Z", "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -387,9 +387,15 @@ public boolean sync() throws AccessControlException, InvalidPathException {\n           syncPathCount + failedSyncPathCount, syncPathCount, failedSyncPathCount, end - start,\n           mRootScheme);\n     }\n+    boolean success = syncPathCount > 0;\n+    if (success) {\n+      // update the sync path cache for the root of the sync\n+      // TODO(gpang): Do we need special handling for failures and thread interrupts?\n+      mUfsSyncPathCache.notifySyncedPath(mRootScheme.getPath().getPath(), mDescendantType);", "originalCommit": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgwMTY2OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493801669", "bodyText": "Yes, that is true. Is there a better way to mark a directory as \"synced\" only after all the descendants are synced?", "author": "gpang", "createdAt": "2020-09-23T18:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5OTM4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1NDMxMw==", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493954313", "bodyText": "I think this is fine. A trade-off between memory overhead (keeping track of all inodes in the sync path cache) vs doing more work in unfortunate scenarios", "author": "ZacBlanco", "createdAt": "2020-09-23T23:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5OTM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgxMTg0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493811849", "bodyText": "slightly concerned about failure and cancellations, because we would mark the directory as synced when perhaps only one file in the directory is synced. It would also prevent it from everything in the directory getting synced for a while..", "author": "yuzhu", "createdAt": "2020-09-23T18:44:16Z", "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -387,9 +387,15 @@ public boolean sync() throws AccessControlException, InvalidPathException {\n           syncPathCount + failedSyncPathCount, syncPathCount, failedSyncPathCount, end - start,\n           mRootScheme);\n     }\n+    boolean success = syncPathCount > 0;", "originalCommit": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0OTk3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493849979", "bodyText": "Yeah, but I think that is true even with the old code, since once the directory inode itself is synced, it is marked as synced, even before any of its children are even processed.", "author": "gpang", "createdAt": "2020-09-23T19:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgxMTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg4MTE2Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493881162", "bodyText": "can we declare the sync successful if the failedCount == 0 and we are not canceled (nothing left in the queue?)\nWould that be a better condition for synced?", "author": "yuzhu", "createdAt": "2020-09-23T20:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgxMTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1MTAzNw==", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493951037", "bodyText": "Currently the failedCount even includes paths which did not require sync, so failedCount is not an accurate name.", "author": "gpang", "createdAt": "2020-09-23T23:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgxMTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1OTkzOA==", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493959938", "bodyText": "is it possible to split that out? consider a directory containing only a directory that is already synced. Would the syncPathCount be 0 and the parent directory would never be considered synced?", "author": "yuzhu", "createdAt": "2020-09-23T23:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgxMTg0OQ=="}], "type": "inlineReview"}]}