{"pr_number": 10933, "pr_title": "Fix metrics throughput to be per minute value", "pr_createdAt": "2020-02-18T19:37:32Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10933", "timeline": [{"oid": "a4ef6f3f00b6d7aa522317e7daab53f1c6e213b9", "url": "https://github.com/Alluxio/alluxio/commit/a4ef6f3f00b6d7aa522317e7daab53f1c6e213b9", "message": "small fix", "committedDate": "2020-02-18T19:36:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkxNDI4Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r380914286", "bodyText": "nit: is there a reason to make this all caps?", "author": "ZacBlanco", "createdAt": "2020-02-18T20:22:55Z", "path": "shell/src/main/java/alluxio/cli/fsadmin/report/MetricsCommand.java", "diffHunk": "@@ -74,8 +74,7 @@ public int run() throws IOException {\n           // Bytes long can be transformed to human-readable format\n           strValue = FormatUtils.getSizeFromBytes((long) doubleValue);\n           if (name.contains(THROUGHPUT_METRIC_IDENTIFIER)) {\n-            // throughput is calculated as one-minute exponentially-weighted moving average rate\n-            strValue = strValue + \"/min\";\n+            strValue = strValue + \"/SEC\";", "originalCommit": "a4ef6f3f00b6d7aa522317e7daab53f1c6e213b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkyODI5NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r380928295", "bodyText": "Because FormatUtils.getSizeFromBytes() will return size in caps like B, MB, GB", "author": "LuQQiu", "createdAt": "2020-02-18T20:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkxNDI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNDgwNA==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r381014804", "bodyText": "also, is every throughput metric at the sec granularity? Is that something we even want?\nI feel like there will be times when a cluster is not under a high load and many of the gauges will report as 0 - especially for people who scrape metrics on a periodic basis, second-level granularity seems like it would cause lots of information to be missed.", "author": "ZacBlanco", "createdAt": "2020-02-19T00:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkxNDI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNzQ2Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r381017463", "bodyText": "All the cluster throughput is at sec now. Throughput can be of sec or minute. Yeah, maybe use MIN make more sense since alluxio is usually long-running cluster.", "author": "LuQQiu", "createdAt": "2020-02-19T00:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkxNDI4Ng=="}], "type": "inlineReview"}, {"oid": "5e458cf1ab00e0ff2a3b694979341d7d19f1286c", "url": "https://github.com/Alluxio/alluxio/commit/5e458cf1ab00e0ff2a3b694979341d7d19f1286c", "message": "Update snapshot", "committedDate": "2020-02-18T21:33:28Z", "type": "commit"}, {"oid": "5c4f85ece178e2b5c64aadeff83628b7f83ec48e", "url": "https://github.com/Alluxio/alluxio/commit/5c4f85ece178e2b5c64aadeff83628b7f83ec48e", "message": "Fix Metrics Test", "committedDate": "2020-02-18T21:56:35Z", "type": "commit"}, {"oid": "2e2554bf0f1ef4891d25b1a0a3e109b259355ac4", "url": "https://github.com/Alluxio/alluxio/commit/2e2554bf0f1ef4891d25b1a0a3e109b259355ac4", "message": "Fix test", "committedDate": "2020-02-18T22:36:38Z", "type": "commit"}, {"oid": "d5b0aeb3c03e37f30a02b7aaff231d519ac0ad55", "url": "https://github.com/Alluxio/alluxio/commit/d5b0aeb3c03e37f30a02b7aaff231d519ac0ad55", "message": "Change throughput to MB/MIN", "committedDate": "2020-02-19T00:44:51Z", "type": "commit"}, {"oid": "818b01d9d65189040203c90c057587e6a3321b12", "url": "https://github.com/Alluxio/alluxio/commit/818b01d9d65189040203c90c057587e6a3321b12", "message": "tmp", "committedDate": "2020-02-19T03:21:06Z", "type": "commit"}, {"oid": "a1982853bcdf0231683d3df65ea6c40ed902b3c0", "url": "https://github.com/Alluxio/alluxio/commit/a1982853bcdf0231683d3df65ea6c40ed902b3c0", "message": "Change metricsStore and set clock", "committedDate": "2020-02-19T18:41:37Z", "type": "commit"}, {"oid": "135a4c89e1c8234e9ebd39efd3e81cae4a50ffa5", "url": "https://github.com/Alluxio/alluxio/commit/135a4c89e1c8234e9ebd39efd3e81cae4a50ffa5", "message": "Fix MetricsMasterTest", "committedDate": "2020-02-19T19:31:32Z", "type": "commit"}, {"oid": "6bce1d750b6bb3b32e186832d852fd37c7d6bc23", "url": "https://github.com/Alluxio/alluxio/commit/6bce1d750b6bb3b32e186832d852fd37c7d6bc23", "message": "add comment", "committedDate": "2020-02-19T19:33:33Z", "type": "commit"}, {"oid": "7a262f12f0337bca68ed9eab7a2e4636630a6c6e", "url": "https://github.com/Alluxio/alluxio/commit/7a262f12f0337bca68ed9eab7a2e4636630a6c6e", "message": "Use lower bound of time instead", "committedDate": "2020-02-19T20:41:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTU1OA==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382325558", "bodyText": "what's the advantage to using mClock vs System.currentTimeMillis?", "author": "ZacBlanco", "createdAt": "2020-02-20T23:53:36Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -209,7 +223,7 @@ public void clear() {\n       for (Counter counter : mClusterCounters.values()) {\n         counter.dec(counter.getCount());\n       }\n-      mLastClearTime = System.currentTimeMillis();\n+      mLastClearTime = mClock.millis();", "originalCommit": "7a262f12f0337bca68ed9eab7a2e4636630a6c6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNjk1OA==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382326958", "bodyText": "They are nearly the same, but mClock is good for testing, I can manually modify the time in unit tests instead of waiting for time to passed.", "author": "LuQQiu", "createdAt": "2020-02-20T23:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTkzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382325931", "bodyText": "hmm if uptime is 0 should we be returning value? or 0?\nIn the off chance of some kind of error, what if uptime is negative?", "author": "ZacBlanco", "createdAt": "2020-02-20T23:54:49Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -141,9 +141,11 @@ protected void registerThroughputGauge(String counterName, String throughputName\n         new Gauge<Object>() {\n           @Override\n           public Object getValue() {\n-            long uptime = (System.currentTimeMillis() - mMetricsStore.getLastClearTime())\n-                / Constants.SECOND_MS;\n-            return uptime == 0 ? 0 : MetricsSystem.counter(counterName).getCount() / uptime;\n+            long uptime = (mClock.millis() - mMetricsStore.getLastClearTime())\n+                / Constants.MINUTE_MS;\n+            long value = MetricsSystem.counter(counterName).getCount();\n+            // The value is bytes per minute\n+            return uptime == 0 ? value : value / uptime;", "originalCommit": "7a262f12f0337bca68ed9eab7a2e4636630a6c6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNzU4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382327585", "bodyText": "Oh, that should not happen. mClock.mills() should always be equal or bigger than the mMetricsStore.getLastClearTime()).\nI feel returning value in the first minute actually makes more sense. I am fine with both 0 or value just feeling that using value can even provide users information in the first minute so it's better.", "author": "LuQQiu", "createdAt": "2020-02-21T00:00:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNzkwNw==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382327907", "bodyText": "wait, actually uptime can be negative.....\nLet me modify the code", "author": "LuQQiu", "createdAt": "2020-02-21T00:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyODc5MA==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382328790", "bodyText": "Changed the code to make sure uptime is positive. Thanks for finding out that!!", "author": "LuQQiu", "createdAt": "2020-02-21T00:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTkzMQ=="}], "type": "inlineReview"}, {"oid": "30fd4170a5f36cb57e0a83ef1fa42413c79bee42", "url": "https://github.com/Alluxio/alluxio/commit/30fd4170a5f36cb57e0a83ef1fa42413c79bee42", "message": "Make sure uptime positive", "committedDate": "2020-02-21T00:03:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMzNTkxMA==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382335910", "bodyText": "I'm not sure if this will still fix the issue?\nA java Clock object can have an offset added to it (See https://docs.oracle.com/javase/8/docs/api/java/time/Clock.html). If the duration is negative it could cause this to return negative for an extended period of time.\nI don't think we use the offset method anywhere, but it would be good to guard against it. I think keeping the code on one line is fine.\nMaybe instead we can simply update the return uptime == 0 ?  to return uptime <= 0 ? value : value / uptime\nor actually - since we should simply return the value within the first minute, maybe it should be\nreturn uptime <= 60 * Constants.SECOND_MS ? value : value / uptime", "author": "ZacBlanco", "createdAt": "2020-02-21T00:30:01Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -141,9 +141,13 @@ protected void registerThroughputGauge(String counterName, String throughputName\n         new Gauge<Object>() {\n           @Override\n           public Object getValue() {\n-            long uptime = (System.currentTimeMillis() - mMetricsStore.getLastClearTime())\n-                / Constants.SECOND_MS;\n-            return uptime == 0 ? 0 : MetricsSystem.counter(counterName).getCount() / uptime;\n+            // Divide into two lines so uptime is always zero or positive\n+            long lastClearTime = mMetricsStore.getLastClearTime();\n+            long uptime = (mClock.millis() - lastClearTime)", "originalCommit": "30fd4170a5f36cb57e0a83ef1fa42413c79bee42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMzODkxMA==", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382338910", "bodyText": "Clock.offset can be set, but usually it's in tests only.\nChanged to set uptime <= 0", "author": "LuQQiu", "createdAt": "2020-02-21T00:40:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMzNTkxMA=="}], "type": "inlineReview"}, {"oid": "6375657d2a07afa80e8437218224695304905dcb", "url": "https://github.com/Alluxio/alluxio/commit/6375657d2a07afa80e8437218224695304905dcb", "message": "guarantee uptime reasonable", "committedDate": "2020-02-21T00:40:14Z", "type": "commit"}]}