{"pr_number": 10908, "pr_title": "Add metrics tests", "pr_createdAt": "2020-02-13T21:08:22Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10908", "timeline": [{"oid": "8b6293c2bc811f88e3f3874246bc56b0045e1f04", "url": "https://github.com/Alluxio/alluxio/commit/8b6293c2bc811f88e3f3874246bc56b0045e1f04", "message": "Add metrics tests", "committedDate": "2020-02-13T21:07:51Z", "type": "commit"}, {"oid": "c60de875277e612e02e808923fcbde181e035bea", "url": "https://github.com/Alluxio/alluxio/commit/c60de875277e612e02e808923fcbde181e035bea", "message": "Fix MetricsStoreTest", "committedDate": "2020-02-13T21:44:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDc2Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379154762", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOG.info(\"Clearing the metrics store and metrics system in {} ms\",\n          \n          \n            \n                LOG.info(\"Cleared the metrics store and metrics system in {} ms\",", "author": "ZacBlanco", "createdAt": "2020-02-13T22:27:16Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -203,13 +205,16 @@ public void init() {\n    * the metrics inside metrics sets.\n    */\n   public void clear() {\n+    long start = System.currentTimeMillis();\n     try (LockResource r = new LockResource(mLock.writeLock())) {\n       for (Counter counter : mClusterCounters.values()) {\n         counter.dec(counter.getCount());\n       }\n       mLastClearTime = System.currentTimeMillis();\n       MetricsSystem.resetAllMetrics();\n     }\n+    LOG.info(\"Clearing the metrics store and metrics system in {} ms\",", "originalCommit": "c60de875277e612e02e808923fcbde181e035bea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTU4Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379155586", "bodyText": "what does memoizing do for us here?", "author": "ZacBlanco", "createdAt": "2020-02-13T22:29:12Z", "path": "core/common/src/main/java/alluxio/underfs/UnderFileSystemWithLogging.java", "diffHunk": "@@ -57,6 +59,8 @@\n   private final UnderFileSystem mUnderFileSystem;\n   private final UnderFileSystemConfiguration mConf;\n   private final String mPath;\n+  private final Supplier<String> mEscapedPath =\n+      CommonUtils.memoize(this::escapePath);", "originalCommit": "c60de875277e612e02e808923fcbde181e035bea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NjU0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379166546", "bodyText": "So that when MetricsSystem record the metrics of any UFS operation,  the escaped path can be memorized without constructing Alluxio URI and call metho in MetricsSystem.", "author": "LuQQiu", "createdAt": "2020-02-13T22:58:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MTQ1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379181457", "bodyText": "Isn't the escaped path always the same though because mPath is final?", "author": "ZacBlanco", "createdAt": "2020-02-13T23:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MDkyNg==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379190926", "bodyText": "Make sense, Changed to initialize directly in the constructor.", "author": "LuQQiu", "createdAt": "2020-02-14T00:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTc4MQ==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379155781", "bodyText": "I feel like this will be a spammy log at INFO level", "author": "ZacBlanco", "createdAt": "2020-02-13T22:29:41Z", "path": "core/common/src/main/java/alluxio/metrics/MetricsSystem.java", "diffHunk": "@@ -718,6 +731,8 @@ public static synchronized void resetAllMetrics() {\n       METRIC_REGISTRY.timer(timerName);\n     }\n     LAST_REPORTED_METRICS.clear();\n+    LOG.info(\"Reset all metrics in the metrics system in {}ms\",\n+        System.currentTimeMillis() - startTime);", "originalCommit": "c60de875277e612e02e808923fcbde181e035bea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NTkzNA==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379165934", "bodyText": "ResetAllMetrics() is used very often in tests, but should be called really rarely in production. It will only be called when the Master starts and when the fsadmin metrics clear is called. Since it may affect the metrics recording and delays some metrics heartbeat, logging is useful.", "author": "LuQQiu", "createdAt": "2020-02-13T22:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTc4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDAzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379180031", "bodyText": "fair enough", "author": "ZacBlanco", "createdAt": "2020-02-13T23:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjEzOQ==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379156139", "bodyText": "If you're looking to escape into URI-compatible paths I would look somewhere in apache commons utils", "author": "ZacBlanco", "createdAt": "2020-02-13T22:30:33Z", "path": "core/common/src/main/java/alluxio/metrics/MetricsSystem.java", "diffHunk": "@@ -395,7 +397,9 @@ public static String stripInstanceAndHost(String metricsName) {\n    * @return the string representing the escaped URI\n    */\n   public static String escape(AlluxioURI uri) {\n-    return uri.toString().replace(\"%\", \"%25\").replace(\"/\", \"%2F\").replace(\".\", \"%2E\");\n+    return CACHED_ESCAPED_PATH.computeIfAbsent(uri,\n+        u -> u.toString().replace(\"%\", \"%25\")\n+            .replace(\"/\", \"%2F\").replace(\".\", \"%2E\"));", "originalCommit": "c60de875277e612e02e808923fcbde181e035bea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2ODU2OA==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379168568", "bodyText": "I haven't found existing utils doing exactly the same thing. If there is a util method, that would be really convenient.", "author": "LuQQiu", "createdAt": "2020-02-13T23:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MTA4OA==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379181088", "bodyText": "I don't know what the original intention of this code was (if it is doing a URL encoding on the metric name or not, but it looks like it to me.\nWe should be using this: https://docs.oracle.com/javase/8/docs/api/java/net/URLEncoder.html", "author": "ZacBlanco", "createdAt": "2020-02-13T23:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4ODk2Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379188966", "bodyText": "I think for the first time MetricsSystem.escape created for Metric name processing. Like we use . for distinguish metric name components like (InstanceType.MetricName.Tag:TagValue), so the given url should not have ..\nThis use case does not fit in UTLEncoder because it will The special characters \".\", \"-\", \"*\", and \"_\" remain the same.", "author": "LuQQiu", "createdAt": "2020-02-14T00:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4OTM4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379189383", "bodyText": "Since the code was already here I guess it's ok - but this seems very sketchy to me...we should improve it in the future.", "author": "ZacBlanco", "createdAt": "2020-02-14T00:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MTA1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379191059", "bodyText": "Yeah, it's sketchy, will reconsider how to improve it in the future", "author": "LuQQiu", "createdAt": "2020-02-14T00:16:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjEzOQ=="}], "type": "inlineReview"}, {"oid": "f8d5d443ae23f7163e46c9d48b9776297300a521", "url": "https://github.com/Alluxio/alluxio/commit/f8d5d443ae23f7163e46c9d48b9776297300a521", "message": "Add metrics system tests", "committedDate": "2020-02-13T22:59:16Z", "type": "commit"}, {"oid": "66704368b5af9a502bcdabdc83f52359d3b16757", "url": "https://github.com/Alluxio/alluxio/commit/66704368b5af9a502bcdabdc83f52359d3b16757", "message": "Merge remote-tracking branch 'upstream/master' into metricsTests", "committedDate": "2020-02-13T23:28:23Z", "type": "commit"}, {"oid": "93d4750fbcd8dbb9258538995bb254da2bb4a2fa", "url": "https://github.com/Alluxio/alluxio/commit/93d4750fbcd8dbb9258538995bb254da2bb4a2fa", "message": "Merge os master and solve conflicts", "committedDate": "2020-02-13T23:29:17Z", "type": "commit"}, {"oid": "e1802886aef6309a2621ed0777ee87a978500c86", "url": "https://github.com/Alluxio/alluxio/commit/e1802886aef6309a2621ed0777ee87a978500c86", "message": "Directly remember the escaped path", "committedDate": "2020-02-14T00:09:31Z", "type": "commit"}, {"oid": "761c87d348b2719649bea83e30c54f90d3dd1bc0", "url": "https://github.com/Alluxio/alluxio/commit/761c87d348b2719649bea83e30c54f90d3dd1bc0", "message": "small fix", "committedDate": "2020-02-14T00:10:45Z", "type": "commit"}]}