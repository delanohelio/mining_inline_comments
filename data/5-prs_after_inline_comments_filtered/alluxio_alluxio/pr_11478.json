{"pr_number": 11478, "pr_title": "Implement non-intrusive locking for backups", "pr_createdAt": "2020-05-26T21:19:49Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11478", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyNzU2Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r430727567", "bodyText": "If this times out, will the backup not be scheduled until the next time, or will there be some sort of retry?", "author": "gpang", "createdAt": "2020-05-26T21:49:56Z", "path": "core/server/master/src/main/java/alluxio/master/backup/BackupLeaderRole.java", "diffHunk": "@@ -250,16 +253,15 @@ private void activateWorkerConnection(Connection workerConnection) {\n    */\n   private void scheduleLocalBackup(BackupPRequest request) {\n     mLocalBackupFuture = mExecutorService.submit(() -> {\n-      try (LockResource lr = new LockResource(mStatePauseLock)) {\n-        try {\n-          mBackupTracker.updateState(BackupState.Running);\n-          AlluxioURI backupUri = takeBackup(request, mBackupTracker.getEntryCounter());\n-          mBackupTracker.updateBackupUri(backupUri);\n-          mBackupTracker.updateState(BackupState.Completed);\n-        } catch (IOException e) {\n-          mBackupTracker.updateError(\n-              new BackupException(String.format(\"Local backup failed: %s\", e.getMessage()), e));\n-        }\n+      try (LockResource stateLockResource =\n+          new LockResource(mStatePauseLock, mStateLockTimeout, TimeUnit.MILLISECONDS)) {", "originalCommit": "6cfe2a93bb7453e501362d2cb2ebfc9263a1af23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDczNjYwNw==", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r430736607", "bodyText": "It's already scheduled during this call. However, the backup-tracker will be completed in the catch statement if it times out.", "author": "ggezer", "createdAt": "2020-05-26T22:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyNzU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc0MDkyNg==", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r430740926", "bodyText": "Is there a retry outside of this? If the backup fails to lock, I feel like there should be retries.", "author": "gpang", "createdAt": "2020-05-26T22:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyNzU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc0MjAzNw==", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r430742037", "bodyText": "No retries before, and didn't need to add more retries, because tryLock had the exact call implemented.", "author": "ggezer", "createdAt": "2020-05-26T22:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyNzU2Nw=="}], "type": "inlineReview"}, {"oid": "b5161f0a3216ea47ab2dd42e475132d6a2182215", "url": "https://github.com/Alluxio/alluxio/commit/b5161f0a3216ea47ab2dd42e475132d6a2182215", "message": "Implement non-intrusive locking for backups", "committedDate": "2020-05-27T03:29:05Z", "type": "commit"}, {"oid": "b5161f0a3216ea47ab2dd42e475132d6a2182215", "url": "https://github.com/Alluxio/alluxio/commit/b5161f0a3216ea47ab2dd42e475132d6a2182215", "message": "Implement non-intrusive locking for backups", "committedDate": "2020-05-27T03:29:05Z", "type": "forcePushed"}, {"oid": "c2696924c2897af3d664e294a430e83a3993f19f", "url": "https://github.com/Alluxio/alluxio/commit/c2696924c2897af3d664e294a430e83a3993f19f", "message": "Fix build", "committedDate": "2020-05-27T18:57:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQzNzE1MA==", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r431437150", "bodyText": "are alluxio.master.backup.state.lock.timeout and alluxio.master.daily.backup.state.lock.timeout equivalent, but for CLI vs daily backup?", "author": "gpang", "createdAt": "2020-05-27T20:56:38Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -4776,12 +4805,20 @@ private static String javadocLink(String fullyQualifiedClassname) {\n         \"alluxio.master.backup.connect.interval.max\";\n     public static final String MASTER_BACKUP_ABANDON_TIMEOUT =\n         \"alluxio.master.backup.abandon.timeout\";\n+    public static final String MASTER_BACKUP_STATE_LOCK_TIMEOUT =\n+        \"alluxio.master.backup.state.lock.timeout\";", "originalCommit": "c2696924c2897af3d664e294a430e83a3993f19f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ1Mzk5Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r431453992", "bodyText": "Yes.\nFor CLI only 1 configuration is exposed. Because other fine tunes are not required for interactive use.", "author": "ggezer", "createdAt": "2020-05-27T21:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQzNzE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0ODA3OA==", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r431448078", "bodyText": "is this supposed to be deadlineMs - System.currentTimeMillis()?", "author": "gpang", "createdAt": "2020-05-27T21:18:17Z", "path": "core/common/src/main/java/alluxio/resource/LockResource.java", "diffHunk": "@@ -70,6 +72,41 @@ public LockResource(Lock lock, boolean acquireLock, boolean useTryLock) {\n     }\n   }\n \n+  /**\n+   * Creates a new instance of {@link LockResource} using the given lock.\n+   *\n+   * This method will use the {@link Lock#tryLock(long, TimeUnit)} internally in a loop\n+   * for trying to grab the lock without causing total blockage of other waiters of the lock.\n+   *\n+   * @param lock  the lock to acquire\n+   * @param tryMs the duration to attempt acquiring the lock\n+   * @param sleepMs the wait duration after failed attempt to acquire the lock\n+   * @param timeoutMs the total duration to try acquiring the lock in a loop\n+   * @throws InterruptedException if interrupted while acquiring the lock\n+   * @throws TimeoutException if the lock was not acquired after given timeout\n+   */\n+  public LockResource(Lock lock, long tryMs, long sleepMs, long timeoutMs)\n+      throws InterruptedException, TimeoutException {\n+    mLock = lock;\n+    long deadlineMs = System.currentTimeMillis() + timeoutMs;\n+    boolean lockAcquired = false;\n+    while (System.currentTimeMillis() < deadlineMs) {\n+      if (mLock.tryLock(tryMs, TimeUnit.MILLISECONDS)) {\n+        lockAcquired = true;\n+        break;\n+      } else {\n+        long remainingWaitMs = deadlineMs = System.currentTimeMillis();", "originalCommit": "c2696924c2897af3d664e294a430e83a3993f19f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ1NTgyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r431455825", "bodyText": "nice catch! otherwise, it would always wait at the end and we'd never know.", "author": "ggezer", "createdAt": "2020-05-27T21:34:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0ODA3OA=="}], "type": "inlineReview"}, {"oid": "a50925fd0df04ecddbd0916caee7ee71f0d70218", "url": "https://github.com/Alluxio/alluxio/commit/a50925fd0df04ecddbd0916caee7ee71f0d70218", "message": "Add integration test for shell-backup timeouts", "committedDate": "2020-05-27T21:29:22Z", "type": "commit"}, {"oid": "5e6758456a90384bc4bd3484632b4faad00b5d9e", "url": "https://github.com/Alluxio/alluxio/commit/5e6758456a90384bc4bd3484632b4faad00b5d9e", "message": "fix typo-bug", "committedDate": "2020-05-27T21:33:12Z", "type": "commit"}]}