{"pr_number": 12550, "pr_title": "Fix speed test issues", "pr_createdAt": "2020-11-18T05:29:38Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12550", "timeline": [{"oid": "dabb867f493cc0c1e476ce377286efe609605ef0", "url": "https://github.com/Alluxio/alluxio/commit/dabb867f493cc0c1e476ce377286efe609605ef0", "message": "Fix speed test issues", "committedDate": "2020-11-18T05:28:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMDU1Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12550#discussion_r526600552", "bodyText": "Do you think we can add more comments to this part explaining what arguments you keep and what you throw away?", "author": "jiacheliu3", "createdAt": "2020-11-19T05:19:23Z", "path": "job/server/src/main/java/alluxio/job/plan/stress/StressBenchDefinition.java", "diffHunk": "@@ -123,20 +122,36 @@ public String runTask(StressBenchConfig config, ArrayList<String> args,\n     command.add(BaseParameters.DISTRIBUTED_FLAG);\n     command.add(BaseParameters.IN_PROCESS_FLAG);\n \n-    List<String> commandArgs = config.getArgs().stream().filter((s) ->\n-        !BaseParameters.CLUSTER_FLAG.equals(s) && !s.isEmpty())\n-        .collect(Collectors.toList());\n-\n+    List<String> commandArgs = config.getArgs();\n+    List<String> newArgs = new ArrayList<>();\n     if (commandArgs.stream().anyMatch(\n-        (s) -> s.equalsIgnoreCase(UfsIOParameters.USE_MOUNT_CONF))) {\n-      // get ufs Uri from --path=blah://blah\n-      String ufsUri = commandArgs.stream().filter(s -> !s.startsWith(UfsIOParameters.PATH))\n-          .findFirst().map(param -> param.substring(\"--path\".length())).orElse(\"\");\n-      commandArgs = commandArgs.stream().filter((s) -> !UfsIOParameters.USE_MOUNT_CONF.equals(s)\n-              && !s.startsWith(UfsIOParameters.CONF)).collect(Collectors.toList());\n+        (s) -> s.equals(UfsIOParameters.USE_MOUNT_CONF))) {", "originalCommit": "dabb867f493cc0c1e476ce377286efe609605ef0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzMTIxMA==", "url": "https://github.com/Alluxio/alluxio/pull/12550#discussion_r527131210", "bodyText": "ok, will fix", "author": "yuzhu", "createdAt": "2020-11-19T19:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMDU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMjI3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12550#discussion_r526602272", "bodyText": "Is it possible that I have mount points hdfs://a and hdfs://a/b and they have different configurations (maybe access control or UGI)?", "author": "jiacheliu3", "createdAt": "2020-11-19T05:25:20Z", "path": "job/server/src/main/java/alluxio/job/plan/stress/StressBenchDefinition.java", "diffHunk": "@@ -101,7 +100,7 @@ public StressBenchDefinition() {\n       throws Exception {\n     Map<String, MountPointInfo> mountTable = runTaskContext.getFileSystem().getMountTable();\n     for (Map.Entry<String, MountPointInfo> entry : mountTable.entrySet()) {\n-      if (PathUtils.hasPrefix(ufsUri, entry.getKey())) {\n+      if (ufsUri.startsWith(entry.getValue().getUfsUri())) {", "originalCommit": "dabb867f493cc0c1e476ce377286efe609605ef0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzExMzY1Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12550#discussion_r527113653", "bodyText": "they can't both be mounted, because that would violate our mounting rules.", "author": "yuzhu", "createdAt": "2020-11-19T18:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMjI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMjQ1MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12550#discussion_r526602451", "bodyText": "Is it possible we have more parameters after PATH?", "author": "jiacheliu3", "createdAt": "2020-11-19T05:26:00Z", "path": "job/server/src/main/java/alluxio/job/plan/stress/StressBenchDefinition.java", "diffHunk": "@@ -123,20 +122,36 @@ public String runTask(StressBenchConfig config, ArrayList<String> args,\n     command.add(BaseParameters.DISTRIBUTED_FLAG);\n     command.add(BaseParameters.IN_PROCESS_FLAG);\n \n-    List<String> commandArgs = config.getArgs().stream().filter((s) ->\n-        !BaseParameters.CLUSTER_FLAG.equals(s) && !s.isEmpty())\n-        .collect(Collectors.toList());\n-\n+    List<String> commandArgs = config.getArgs();\n+    List<String> newArgs = new ArrayList<>();\n     if (commandArgs.stream().anyMatch(\n-        (s) -> s.equalsIgnoreCase(UfsIOParameters.USE_MOUNT_CONF))) {\n-      // get ufs Uri from --path=blah://blah\n-      String ufsUri = commandArgs.stream().filter(s -> !s.startsWith(UfsIOParameters.PATH))\n-          .findFirst().map(param -> param.substring(\"--path\".length())).orElse(\"\");\n-      commandArgs = commandArgs.stream().filter((s) -> !UfsIOParameters.USE_MOUNT_CONF.equals(s)\n-              && !s.startsWith(UfsIOParameters.CONF)).collect(Collectors.toList());\n+        (s) -> s.equals(UfsIOParameters.USE_MOUNT_CONF))) {\n+      boolean nextElem = false;\n+      boolean removeNext = false;\n+      String ufsUri = \"\";\n+      for (String elem : commandArgs) {\n+        if (elem.equals(UfsIOParameters.CONF)) {\n+          removeNext = true;\n+        } else {\n+          if (!removeNext) {\n+            newArgs.add(elem);\n+          }\n+          removeNext = false;\n+        }\n+        if (elem.equals(UfsIOParameters.PATH)) {\n+          nextElem = true;\n+        } else {\n+          if (nextElem) {\n+            ufsUri = elem;\n+            break;", "originalCommit": "dabb867f493cc0c1e476ce377286efe609605ef0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzMTEwMA==", "url": "https://github.com/Alluxio/alluxio/pull/12550#discussion_r527131100", "bodyText": "yes, will fix", "author": "yuzhu", "createdAt": "2020-11-19T19:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMjQ1MQ=="}], "type": "inlineReview"}]}