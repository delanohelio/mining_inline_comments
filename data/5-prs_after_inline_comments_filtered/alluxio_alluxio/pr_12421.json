{"pr_number": 12421, "pr_title": "Add load metadata command", "pr_createdAt": "2020-10-29T12:10:34Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12421", "timeline": [{"oid": "4e3fcbab805b3ce830f0e8c0ea883f185193e06a", "url": "https://github.com/Alluxio/alluxio/commit/4e3fcbab805b3ce830f0e8c0ea883f185193e06a", "message": "Add loadMetadata command", "committedDate": "2020-10-29T11:49:47Z", "type": "commit"}, {"oid": "bd9855b530ae64caae104077fa71dcd3fe7669f1", "url": "https://github.com/Alluxio/alluxio/commit/bd9855b530ae64caae104077fa71dcd3fe7669f1", "message": "add listStatusCli rpc", "committedDate": "2020-10-29T11:50:59Z", "type": "commit"}, {"oid": "e10710af0c6cfa88a5f27c0d222813b441662287", "url": "https://github.com/Alluxio/alluxio/commit/e10710af0c6cfa88a5f27c0d222813b441662287", "message": "fix iterateStatus code style", "committedDate": "2020-10-29T12:08:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg2NDM3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514864375", "bodyText": "Unsupported?", "author": "jiacheliu3", "createdAt": "2020-10-30T05:02:27Z", "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LocalCacheFileInStreamTest.java", "diffHunk": "@@ -497,6 +498,12 @@ public void iterateStatus(AlluxioURI path, ListStatusPOptions options,\n       throw new UnsupportedOperationException();\n     }\n \n+    @Override\n+    public void loadMetadata(AlluxioURI path, LoadMetadataPOptions options)\n+        throws FileDoesNotExistException, IOException, AlluxioException {\n+      throw new UnsupportedOperationException();", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NTA0MA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514885040", "bodyText": "yeah this is a mock", "author": "apc999", "createdAt": "2020-10-30T05:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg2NDM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3MTczNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514871735", "bodyText": "Fix the whitespace here", "author": "jiacheliu3", "createdAt": "2020-10-30T05:15:57Z", "path": "core/client/fs/src/main/java/alluxio/client/file/DelegatingFileSystem.java", "diffHunk": "@@ -120,11 +121,17 @@ public URIStatus getStatus(AlluxioURI path, GetStatusPOptions options)\n \n   @Override\n   public void iterateStatus(AlluxioURI path, ListStatusPOptions options,\n-                            Consumer<? super URIStatus> action)", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3MzQ5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515473499", "bodyText": "Sure", "author": "JySongWithZhangCe", "createdAt": "2020-10-31T08:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3MTczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3MjYyNg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514872626", "bodyText": "Can you explain more pls?", "author": "jiacheliu3", "createdAt": "2020-10-30T05:17:28Z", "path": "shell/src/main/java/alluxio/cli/fs/command/LoadMetadataCommand.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.cli.fs.command;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.annotation.PublicApi;\n+import alluxio.cli.CommandUtils;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.exception.AlluxioException;\n+import alluxio.exception.status.InvalidArgumentException;\n+import alluxio.grpc.LoadDescendantPType;\n+import alluxio.grpc.LoadMetadataPOptions;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * Load Metadata for the path.", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyNzEyMw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515027123", "bodyText": "Sure", "author": "JySongWithZhangCe", "createdAt": "2020-10-30T11:20:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3MjYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3Mjg1OA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514872858", "bodyText": "Add the tests so we know what you want the behavior to be?", "author": "jiacheliu3", "createdAt": "2020-10-30T05:17:51Z", "path": "shell/src/test/java/alluxio/cli/fs/command/LoadMetadataCommandTest.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.cli.fs.command;\n+\n+import org.junit.Test;\n+\n+public class LoadMetadataCommandTest {\n+\n+  /**\n+   * Metadata not in Alluxio, LoadMetadata should\n+   * load the metadata into Alluxio inode.\n+   */\n+  @Test\n+  public void noneInAlluxio() {", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyNzQ3MA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515027470", "bodyText": "Ok, I'm working on it.", "author": "JySongWithZhangCe", "createdAt": "2020-10-30T11:20:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3Mjg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4MzkxNA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514883914", "bodyText": "nit: a file -> a path", "author": "apc999", "createdAt": "2020-10-30T05:47:50Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemMasterClient.java", "diffHunk": "@@ -169,6 +170,15 @@ void iterateStatus(AlluxioURI path, ListStatusPOptions options,\n   List<URIStatus> listStatus(AlluxioURI path, ListStatusPOptions options)\n       throws AlluxioStatusException;\n \n+  /**\n+   * Loads the metadata of a file from the under file system.", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyNzc3Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515027777", "bodyText": "Sure", "author": "JySongWithZhangCe", "createdAt": "2020-10-30T11:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4MzkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NTE3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514885175", "bodyText": "nit: remove this unnecessary empty line.", "author": "apc999", "createdAt": "2020-10-30T05:52:40Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1066,6 +1066,23 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n     return fileInfos;\n   }\n \n+  @Override\n+  public void loadMetaData(AlluxioURI path, LoadMetadataContext context)\n+      throws AccessControlException, FileDoesNotExistException, InvalidPathException, IOException {\n+    try (RpcContext rpcContext = createRpcContext(context)) {\n+      DescendantType syncDescendantType =\n+              GrpcUtils.fromProto(context.getOptions().getLoadDescendantType());\n+      FileSystemMasterCommonPOptions commonOptions =\n+              context.getOptions().getCommonOptions();\n+      InodeSyncStream sync = new InodeSyncStream(new LockingScheme(path, LockPattern.READ, true),\n+              this, rpcContext, syncDescendantType, commonOptions, false, true, false);\n+", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyNzk0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515027949", "bodyText": "Sure", "author": "JySongWithZhangCe", "createdAt": "2020-10-30T11:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NTE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NTUyNg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514885526", "bodyText": "wrong indent, please follow https://google.github.io/styleguide/javaguide.html#s4.5-line-wrapping", "author": "apc999", "createdAt": "2020-10-30T05:54:11Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1066,6 +1066,23 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n     return fileInfos;\n   }\n \n+  @Override\n+  public void loadMetaData(AlluxioURI path, LoadMetadataContext context)\n+      throws AccessControlException, FileDoesNotExistException, InvalidPathException, IOException {\n+    try (RpcContext rpcContext = createRpcContext(context)) {\n+      DescendantType syncDescendantType =\n+              GrpcUtils.fromProto(context.getOptions().getLoadDescendantType());", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyODEzNg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515028136", "bodyText": "Ok", "author": "JySongWithZhangCe", "createdAt": "2020-10-30T11:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NTUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NzU2Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514887567", "bodyText": "can we invoke loadMetadataIfNotExist here? It looks to me some duplicated code with that method", "author": "apc999", "createdAt": "2020-10-30T06:01:47Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1066,6 +1066,23 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n     return fileInfos;\n   }\n \n+  @Override\n+  public void loadMetaData(AlluxioURI path, LoadMetadataContext context)\n+      throws AccessControlException, FileDoesNotExistException, InvalidPathException, IOException {\n+    try (RpcContext rpcContext = createRpcContext(context)) {\n+      DescendantType syncDescendantType =", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NDEwNg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515474106", "bodyText": "loadMetadataIfNotExist method will load new metadata but don't sync old metadata", "author": "JySongWithZhangCe", "createdAt": "2020-10-31T08:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NzU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4ODYyOA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514888628", "bodyText": "Too verbose. how about\nLoadMetadataPOptions.newBuilder().\n    .setLoadDescendantType(recursive  ? LoadDescendantPType.ALL : LoadDescendantPType.ONE)\n    .build()", "author": "apc999", "createdAt": "2020-10-30T06:05:57Z", "path": "shell/src/main/java/alluxio/cli/fs/command/LoadMetadataCommand.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.cli.fs.command;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.annotation.PublicApi;\n+import alluxio.cli.CommandUtils;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.exception.AlluxioException;\n+import alluxio.exception.status.InvalidArgumentException;\n+import alluxio.grpc.LoadDescendantPType;\n+import alluxio.grpc.LoadMetadataPOptions;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * Load Metadata for the path.\n+ */\n+@ThreadSafe\n+@PublicApi\n+public class LoadMetadataCommand extends AbstractFileSystemCommand {\n+  private static final Option RECURSIVE_OPTION =\n+      Option.builder(\"R\")\n+          .required(false)\n+          .hasArg(false)\n+          .desc(\"load metadata subdirectories recursively\")\n+          .build();\n+\n+  /**\n+   * Constructs a new instance to load metadata for the given Alluxio path from UFS.\n+   *\n+   * @param fsContext the filesystem of Alluxio\n+   */\n+  public LoadMetadataCommand(FileSystemContext fsContext) {\n+    super(fsContext);\n+  }\n+\n+  @Override\n+  public String getCommandName() {\n+    return \"loadMetadata\";\n+  }\n+\n+  @Override\n+  public Options getOptions() {\n+    return new Options().addOption(RECURSIVE_OPTION);\n+  }\n+\n+  @Override\n+  protected void runPlainPath(AlluxioURI plainPath, CommandLine cl)\n+      throws AlluxioException, IOException {\n+    loadMetadata(plainPath, cl.hasOption(RECURSIVE_OPTION.getOpt()));\n+  }\n+\n+  @Override\n+  public int run(CommandLine cl) throws AlluxioException, IOException {\n+    String[] args = cl.getArgs();\n+    AlluxioURI path = new AlluxioURI(args[0]);\n+    runWildCardCmd(path, cl);\n+\n+    return 0;\n+  }\n+\n+  private void loadMetadata(AlluxioURI path, boolean recursive) throws IOException {\n+    LoadMetadataPOptions options;\n+    try {\n+      if (recursive) {", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyODc5Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515028796", "bodyText": "Good idea!", "author": "JySongWithZhangCe", "createdAt": "2020-10-30T11:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4ODYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4ODk5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r514888997", "bodyText": "Let's make an integration test instead?\nsee alluxio.client.cli.fs.command.LoadCommandIntegrationTest", "author": "apc999", "createdAt": "2020-10-30T06:07:24Z", "path": "shell/src/test/java/alluxio/cli/fs/command/LoadMetadataCommandTest.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.cli.fs.command;\n+\n+import org.junit.Test;\n+\n+public class LoadMetadataCommandTest {", "originalCommit": "e10710af0c6cfa88a5f27c0d222813b441662287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyODk5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r515028999", "bodyText": "I will try", "author": "JySongWithZhangCe", "createdAt": "2020-10-30T11:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4ODk5Nw=="}], "type": "inlineReview"}, {"oid": "38c0c94fc8378fdbd125ebb1da6b0c3a202d9a18", "url": "https://github.com/Alluxio/alluxio/commit/38c0c94fc8378fdbd125ebb1da6b0c3a202d9a18", "message": "add integration test, apply suggestions, and change lock pattern", "committedDate": "2020-11-01T14:17:04Z", "type": "commit"}, {"oid": "c972a73bdacd839ff8f1c251e7d6e0697a1a4982", "url": "https://github.com/Alluxio/alluxio/commit/c972a73bdacd839ff8f1c251e7d6e0697a1a4982", "message": "fix DefaultFileSystemMaster code style", "committedDate": "2020-11-02T11:47:38Z", "type": "commit"}, {"oid": "645a41c2a4228c0fe89bbbee561e205224acfc5e", "url": "https://github.com/Alluxio/alluxio/commit/645a41c2a4228c0fe89bbbee561e205224acfc5e", "message": "Avoid duplicates with metadata caching client on iterateStatus\n\nFix https://github.com/Alluxio/alluxio/issues/12373\n\npr-link: Alluxio/alluxio#12423\nchange-id: cid-c86d2fbb28cd904e612cb64166983a21fdd2c3a6", "committedDate": "2020-11-02T12:24:54Z", "type": "commit"}, {"oid": "0f304132f3e70637f6e1a8941a5bfb442ddcee0f", "url": "https://github.com/Alluxio/alluxio/commit/0f304132f3e70637f6e1a8941a5bfb442ddcee0f", "message": "add MockFileSystemMasterClient and add loadMetaData for it", "committedDate": "2020-11-02T12:26:54Z", "type": "commit"}, {"oid": "f2a8776fa14079c9d04749e7511978e467a5d327", "url": "https://github.com/Alluxio/alluxio/commit/f2a8776fa14079c9d04749e7511978e467a5d327", "message": "fix MockFileSystemMasterClient conflict with master branch", "committedDate": "2020-11-02T12:45:23Z", "type": "commit"}, {"oid": "7dbb9302bfb384967c624727639b59d2062f297a", "url": "https://github.com/Alluxio/alluxio/commit/7dbb9302bfb384967c624727639b59d2062f297a", "message": "add loadMetadata method for MockFileSystemMasterClient class", "committedDate": "2020-11-02T12:47:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwMjM5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516402397", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Loads the metadata of a path from the under file system.\n          \n          \n            \n               * Loads metadata about a path in the UFS to Alluxio. No data will be transferred.", "author": "jiacheliu3", "createdAt": "2020-11-03T02:51:24Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemMasterClient.java", "diffHunk": "@@ -169,6 +170,15 @@ void iterateStatus(AlluxioURI path, ListStatusPOptions options,\n   List<URIStatus> listStatus(AlluxioURI path, ListStatusPOptions options)\n       throws AlluxioStatusException;\n \n+  /**\n+   * Loads the metadata of a path from the under file system.", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwMjc0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516402741", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Load metadata from ufs for given path.\n          \n          \n            \n               * Loads metadata about a path in the UFS to Alluxio. No data will be transferred.", "author": "jiacheliu3", "createdAt": "2020-11-03T02:52:59Z", "path": "core/server/master/src/main/java/alluxio/master/file/FileSystemMaster.java", "diffHunk": "@@ -160,6 +161,18 @@ void listStatus(AlluxioURI path, ListStatusContext context, ResultStream<FileInf\n       throws AccessControlException, FileDoesNotExistException, InvalidPathException,\n       UnavailableException, IOException;\n \n+  /**\n+   * Load metadata from ufs for given path.", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwMjk1NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516402955", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Load Metadata for the path.\n          \n          \n            \n             * Loads metadata about a path in the UFS to Alluxio. No data will be transferred.", "author": "jiacheliu3", "createdAt": "2020-11-03T02:54:01Z", "path": "shell/src/main/java/alluxio/cli/fs/command/LoadMetadataCommand.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.cli.fs.command;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.annotation.PublicApi;\n+import alluxio.cli.CommandUtils;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.exception.AlluxioException;\n+import alluxio.exception.status.InvalidArgumentException;\n+import alluxio.grpc.LoadDescendantPType;\n+import alluxio.grpc.LoadMetadataPOptions;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * Load Metadata for the path.", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwMzA2NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516403065", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This command as a client-side optimization without\n          \n          \n            \n             * This command is a client-side optimization without", "author": "jiacheliu3", "createdAt": "2020-11-03T02:54:21Z", "path": "shell/src/main/java/alluxio/cli/fs/command/LoadMetadataCommand.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.cli.fs.command;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.annotation.PublicApi;\n+import alluxio.cli.CommandUtils;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.exception.AlluxioException;\n+import alluxio.exception.status.InvalidArgumentException;\n+import alluxio.grpc.LoadDescendantPType;\n+import alluxio.grpc.LoadMetadataPOptions;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.commons.cli.Option;\n+import org.apache.commons.cli.Options;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * Load Metadata for the path.\n+ * This command as a client-side optimization without", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNDE2Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516404162", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Delete layer3 directory metadata recursive.\n          \n          \n            \n                // Delete layer3 directory metadata recursively", "author": "jiacheliu3", "createdAt": "2020-11-03T02:59:28Z", "path": "tests/src/test/java/alluxio/client/cli/fs/command/LoadMetadataCommandIntegrationTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.cli.fs.command;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.cli.fs.AbstractFileSystemShellTest;\n+import alluxio.exception.AlluxioException;\n+import alluxio.grpc.DeletePOptions;\n+import alluxio.grpc.GetStatusPOptions;\n+import alluxio.grpc.LoadMetadataPType;\n+import alluxio.grpc.WritePType;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Tests for loadMetadata command.\n+ */\n+public final class LoadMetadataCommandIntegrationTest extends AbstractFileSystemShellTest {\n+  @Test\n+  public void loadMetadataDir() throws IOException, AlluxioException {\n+    String dirPath = \"/testRoot/layer1/layer2/layer3/\";\n+    String filePathA = dirPath + \"testFileA\";\n+    String filePathB = dirPath + \"testFileB\";\n+    FileSystemTestUtils\n+        .createByteFile(sFileSystem, filePathA, WritePType.CACHE_THROUGH, 10);\n+    FileSystemTestUtils\n+        .createByteFile(sFileSystem, filePathB, WritePType.THROUGH, 30);\n+    AlluxioURI uriDir = new AlluxioURI(dirPath);\n+    AlluxioURI uriA = new AlluxioURI(filePathA);\n+    AlluxioURI uriB = new AlluxioURI(filePathB);\n+    URIStatus statusBeforeA = sFileSystem.getStatus(uriA);\n+    URIStatus statusBeforeB = sFileSystem.getStatus(uriB);\n+    // Delete layer3 directory metadata recursive.", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNDMzNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516404335", "bodyText": "Why creating two files with different WriteType? If you want to validation all write types, maybe add files for each of them?", "author": "jiacheliu3", "createdAt": "2020-11-03T03:00:11Z", "path": "tests/src/test/java/alluxio/client/cli/fs/command/LoadMetadataCommandIntegrationTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.cli.fs.command;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.cli.fs.AbstractFileSystemShellTest;\n+import alluxio.exception.AlluxioException;\n+import alluxio.grpc.DeletePOptions;\n+import alluxio.grpc.GetStatusPOptions;\n+import alluxio.grpc.LoadMetadataPType;\n+import alluxio.grpc.WritePType;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Tests for loadMetadata command.\n+ */\n+public final class LoadMetadataCommandIntegrationTest extends AbstractFileSystemShellTest {\n+  @Test\n+  public void loadMetadataDir() throws IOException, AlluxioException {\n+    String dirPath = \"/testRoot/layer1/layer2/layer3/\";\n+    String filePathA = dirPath + \"testFileA\";\n+    String filePathB = dirPath + \"testFileB\";\n+    FileSystemTestUtils\n+        .createByteFile(sFileSystem, filePathA, WritePType.CACHE_THROUGH, 10);\n+    FileSystemTestUtils\n+        .createByteFile(sFileSystem, filePathB, WritePType.THROUGH, 30);", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ0NTczNA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516445734", "bodyText": "Different WriteType will not influence test, shaw I use single WriteType\uff1f", "author": "JySongWithZhangCe", "createdAt": "2020-11-03T06:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNDMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNDg5MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516404891", "bodyText": "what is load-only mode?", "author": "jiacheliu3", "createdAt": "2020-11-03T03:02:45Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1066,6 +1066,31 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n     return fileInfos;\n   }\n \n+  /**\n+   * {@link DefaultFileSystemMaster} has two private methods associated with sync metadata:\n+   * 1. {@link DefaultFileSystemMaster#loadMetadataIfNotExist} sync metadata in load-only mode,", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNzgwNA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516407804", "bodyText": "load-only mode won't update metadata which is not consistency with UFS, this mode will load metadata which not in alluxio inode tree but exists in UFS.", "author": "JySongWithZhangCe", "createdAt": "2020-11-03T03:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNDg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNTAwNA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516405004", "bodyText": "what is \"not in force mode\"? what is \"force mode\"? Can you explain more clearly?", "author": "jiacheliu3", "createdAt": "2020-11-03T03:03:14Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1066,6 +1066,31 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n     return fileInfos;\n   }\n \n+  /**\n+   * {@link DefaultFileSystemMaster} has two private methods associated with sync metadata:\n+   * 1. {@link DefaultFileSystemMaster#loadMetadataIfNotExist} sync metadata in load-only mode,\n+   * 2. {@link DefaultFileSystemMaster#syncMetadata} sync metadata not in force mode.", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwODAyOA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516408028", "bodyText": "That is to say, sync may not execute", "author": "JySongWithZhangCe", "createdAt": "2020-11-03T03:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNTAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNTQ5OA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516405498", "bodyText": "I don't really understand the comment. When you are using words like \"foreSync param\", \"loadOnly param\", could you explain them first, so the readers can understand what you are referring to?", "author": "jiacheliu3", "createdAt": "2020-11-03T03:05:21Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1066,6 +1066,31 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n     return fileInfos;\n   }\n \n+  /**\n+   * {@link DefaultFileSystemMaster} has two private methods associated with sync metadata:\n+   * 1. {@link DefaultFileSystemMaster#loadMetadataIfNotExist} sync metadata in load-only mode,\n+   * 2. {@link DefaultFileSystemMaster#syncMetadata} sync metadata not in force mode.\n+   * Due to loadMetaData need work on both non-load-only mode and force mode, we need custom a\n+   * InodeSyncStream object which foreSync param is true and loadOnly param is false.\n+   * Further more, synchronize metadata may modify the structure of the inode tree, the lock\n+   * pattern of the InodeSyncStream object should be LockPattern.WRITE_EDGE.", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ0NjcwNA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516446704", "bodyText": "These params have clear comment at InodeSyncStream, how about add a InodeSyncStream link, and other people could read comment from  InodeSyncStream", "author": "JySongWithZhangCe", "createdAt": "2020-11-03T06:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwNTQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ0NzE1OA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516447158", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    RPC_LOG, \"loadMetadata\", \"path=%s,options=%s\", path, options\n          \n          \n            \n                    RPC_LOG, \"LoadMetadata\", \"path=%s,options=%s\", path, options", "author": "apc999", "createdAt": "2020-11-03T06:24:14Z", "path": "core/client/fs/src/main/java/alluxio/client/file/RetryHandlingFileSystemMasterClient.java", "diffHunk": "@@ -260,6 +262,19 @@ public void iterateStatus(final AlluxioURI path, final ListStatusPOptions option\n     }, RPC_LOG, \"ListStatus\", \"path=%s,options=%s\", path, options);\n   }\n \n+  @Override\n+  public void loadMetadata(AlluxioURI path, LoadMetadataPOptions options)\n+      throws AlluxioStatusException {\n+    retryRPC(\n+        () -> mClient.loadMetadata(\n+              LoadMetadataPRequest.newBuilder()\n+                  .setPath(path.getPath())\n+                  .setLoadMetadataPOptions(options)\n+                  .build()),\n+        RPC_LOG, \"loadMetadata\", \"path=%s,options=%s\", path, options", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1MTg4MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516451881", "bodyText": "@gpang  to sync metadata, do we need to start with LockPattern.WRITE_EDGE? can we start with READ?\nAlso, can you check if the parameters for InodeSyncStream here is correct?", "author": "apc999", "createdAt": "2020-11-03T06:42:29Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1066,6 +1066,31 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n     return fileInfos;\n   }\n \n+  /**\n+   * {@link DefaultFileSystemMaster} has two private methods associated with sync metadata:\n+   * 1. {@link DefaultFileSystemMaster#loadMetadataIfNotExist} sync metadata in load-only mode,\n+   * 2. {@link DefaultFileSystemMaster#syncMetadata} sync metadata not in force mode.\n+   * Due to loadMetaData need work on both non-load-only mode and force mode, we need custom a\n+   * InodeSyncStream object which foreSync param is true and loadOnly param is false.\n+   * Further more, synchronize metadata may modify the structure of the inode tree, the lock\n+   * pattern of the InodeSyncStream object should be LockPattern.WRITE_EDGE.\n+   */\n+  @Override\n+  public void loadMetaData(AlluxioURI path, LoadMetadataContext context)\n+      throws AccessControlException, FileDoesNotExistException, InvalidPathException, IOException {\n+    try (RpcContext rpcContext = createRpcContext(context)) {\n+      DescendantType syncDescendantType =\n+          GrpcUtils.fromProto(context.getOptions().getLoadDescendantType());\n+      FileSystemMasterCommonPOptions commonOptions = context.getOptions().getCommonOptions();\n+      InodeSyncStream sync =\n+          new InodeSyncStream(new LockingScheme(path, LockPattern.WRITE_EDGE, true), this,", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk1Mzc2NA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516953764", "bodyText": "I think it can be READ too. However, shouldn't this behave the same as listStatus until it is time to return results? I feel this command should be just the prefix of the code for listStatus. Alternatively, should there just be an option to listStatus which ignores sending results, or something like \"forceLoadOnly\"? There would be a lot of shared code between load metadata and list status.", "author": "gpang", "createdAt": "2020-11-03T21:03:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1MTg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NTQ4Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516985487", "bodyText": "thanks. @JySongWithZhangCe  based on Gene's feedback, let's try to emulate what listStatus is doing and reuse code as much as possible.\nMeanwhile, @gpang , I agree with you that it can be a new option in ListStatus rpc. However, given the code we are adding a minimal, I view it is cleaner to have a separate RPC for its own purpose rather than complicating listStatus which is already pretty complicated. Let me know if you feel it strongly and we can discuss", "author": "apc999", "createdAt": "2020-11-03T22:11:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1MTg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEwMjc1Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r517102752", "bodyText": "@apc999 So may I emulate listStatus' code to design loadMetaData? The same code will appear in two methods, it will seems to redundancy. I guess you won't aggree pick the same code into a private method due to it will change listStatus' code. Perhaps loadMetadata could work by calling listStatus. In next pr we can build a new rpc like listStatusCli to represent rpcs which associated with listStatus,  and merge loadMetadata.", "author": "JySongWithZhangCe", "createdAt": "2020-11-04T05:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1MTg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUyMTAxOA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r517521018", "bodyText": "Sure, I am good with that approach. Then, we just need to \"copy\" much of the initial portion of the listStatus behavior.", "author": "gpang", "createdAt": "2020-11-04T17:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1MTg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1MjA0Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516452047", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                }, \"loadMetadata\", \"request=%s\", responseObserver, request);\n          \n          \n            \n                }, \"LoadMetadata\", \"request=%s\", responseObserver, request);", "author": "apc999", "createdAt": "2020-11-03T06:43:12Z", "path": "core/server/master/src/main/java/alluxio/master/file/FileSystemMasterClientServiceHandler.java", "diffHunk": "@@ -237,6 +240,19 @@ public void listStatus(ListStatusPRequest request,\n     }\n   }\n \n+  @Override\n+  public void loadMetadata(LoadMetadataPRequest request,\n+      StreamObserver<LoadMetadataPResponse> responseObserver) {\n+    RpcUtils.call(LOG, () -> {\n+      AlluxioURI pathUri = getAlluxioURI(request.getPath());\n+      if (request.hasLoadMetadataPOptions()) {\n+        mFileSystemMaster.loadMetaData(pathUri,\n+            LoadMetadataContext.create(request.getLoadMetadataPOptions().toBuilder()));\n+      }\n+      return LoadMetadataPResponse.newBuilder().build();\n+    }, \"loadMetadata\", \"request=%s\", responseObserver, request);", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1MzAxOA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516453018", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String filePathA = dirPath + \"testFileA\";\n          \n          \n            \n                String filePathA = PathUtils.concatPath(dirPath, \"testFileA\");", "author": "apc999", "createdAt": "2020-11-03T06:46:28Z", "path": "tests/src/test/java/alluxio/client/cli/fs/command/LoadMetadataCommandIntegrationTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.cli.fs.command;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.cli.fs.AbstractFileSystemShellTest;\n+import alluxio.exception.AlluxioException;\n+import alluxio.grpc.DeletePOptions;\n+import alluxio.grpc.GetStatusPOptions;\n+import alluxio.grpc.LoadMetadataPType;\n+import alluxio.grpc.WritePType;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Tests for loadMetadata command.\n+ */\n+public final class LoadMetadataCommandIntegrationTest extends AbstractFileSystemShellTest {\n+  @Test\n+  public void loadMetadataDir() throws IOException, AlluxioException {\n+    String dirPath = \"/testRoot/layer1/layer2/layer3/\";\n+    String filePathA = dirPath + \"testFileA\";", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1NDM5MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516454391", "bodyText": "awesome", "author": "JySongWithZhangCe", "createdAt": "2020-11-03T06:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1MzAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1NDEwMw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516454103", "bodyText": "Possibly to assertEquals(statusBefore, statusAfterB)?", "author": "apc999", "createdAt": "2020-11-03T06:50:23Z", "path": "tests/src/test/java/alluxio/client/cli/fs/command/LoadMetadataCommandIntegrationTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.cli.fs.command;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.cli.fs.AbstractFileSystemShellTest;\n+import alluxio.exception.AlluxioException;\n+import alluxio.grpc.DeletePOptions;\n+import alluxio.grpc.GetStatusPOptions;\n+import alluxio.grpc.LoadMetadataPType;\n+import alluxio.grpc.WritePType;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Tests for loadMetadata command.\n+ */\n+public final class LoadMetadataCommandIntegrationTest extends AbstractFileSystemShellTest {\n+  @Test\n+  public void loadMetadataDir() throws IOException, AlluxioException {\n+    String dirPath = \"/testRoot/layer1/layer2/layer3/\";\n+    String filePathA = dirPath + \"testFileA\";\n+    String filePathB = dirPath + \"testFileB\";\n+    FileSystemTestUtils\n+        .createByteFile(sFileSystem, filePathA, WritePType.CACHE_THROUGH, 10);\n+    FileSystemTestUtils\n+        .createByteFile(sFileSystem, filePathB, WritePType.THROUGH, 30);\n+    AlluxioURI uriDir = new AlluxioURI(dirPath);\n+    AlluxioURI uriA = new AlluxioURI(filePathA);\n+    AlluxioURI uriB = new AlluxioURI(filePathB);\n+    URIStatus statusBeforeA = sFileSystem.getStatus(uriA);\n+    URIStatus statusBeforeB = sFileSystem.getStatus(uriB);\n+    // Delete layer3 directory metadata recursive.\n+    DeletePOptions deletePOptions =\n+        DeletePOptions.newBuilder().setAlluxioOnly(true).setRecursive(true).build();\n+    sFileSystem.delete(uriDir, deletePOptions);\n+    // Load metadata from ufs.\n+    sFsShell.run(\"loadMetadata\", dirPath);\n+    // Use LoadMetadataPType.NEVER to avoid loading metadata during get file status.\n+    GetStatusPOptions getStatusPOptions =\n+        GetStatusPOptions.newBuilder().setLoadMetadataType(LoadMetadataPType.NEVER).build();\n+    // Check testFileA's metadata.\n+    URIStatus statusAfterA = sFileSystem.getStatus(uriA, getStatusPOptions);\n+    assertEquals(statusBeforeA.getFileInfo().getName(), statusAfterA.getFileInfo().getName());\n+    assertEquals(statusBeforeA.getFileInfo().getLength(), statusAfterA.getFileInfo().getLength());\n+    // Check testFileB's metadata.\n+    URIStatus statusAfterB = sFileSystem.getStatus(uriB, getStatusPOptions);\n+    assertEquals(statusBeforeB.getFileInfo().getName(), statusAfterB.getFileInfo().getName());", "originalCommit": "7dbb9302bfb384967c624727639b59d2062f297a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1NjQ0NA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r516456444", "bodyText": "It's a good iead, but URIStatus not support yet", "author": "JySongWithZhangCe", "createdAt": "2020-11-03T06:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1NDEwMw=="}], "type": "inlineReview"}, {"oid": "4f92f6c1df07ee83063583ef31b83b2747540dae", "url": "https://github.com/Alluxio/alluxio/commit/4f92f6c1df07ee83063583ef31b83b2747540dae", "message": "optimize comment", "committedDate": "2020-11-03T12:36:16Z", "type": "commit"}, {"oid": "4c90318eadbe50519c9db4c6cd675d4fe2d2fb52", "url": "https://github.com/Alluxio/alluxio/commit/4c90318eadbe50519c9db4c6cd675d4fe2d2fb52", "message": "remove loadMetadata rpc and add a option for listStatus rpc to achieve", "committedDate": "2020-11-05T02:11:19Z", "type": "commit"}, {"oid": "b1db291ea7d36fc1f475206ae1f24446e0872b97", "url": "https://github.com/Alluxio/alluxio/commit/b1db291ea7d36fc1f475206ae1f24446e0872b97", "message": "rollback recursive for loadMetadataDefaults method in FileSystemOptions class", "committedDate": "2020-11-05T02:21:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDUxMA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r517840510", "bodyText": "nit: restore the order", "author": "jiacheliu3", "createdAt": "2020-11-05T07:30:16Z", "path": "core/client/fs/src/main/java/alluxio/util/FileSystemOptions.java", "diffHunk": "@@ -180,9 +180,9 @@ public static ListStatusPOptions listStatusDefaults(AlluxioConfiguration conf) {\n   public static LoadMetadataPOptions loadMetadataDefaults(AlluxioConfiguration conf) {\n     return LoadMetadataPOptions.newBuilder()\n         .setCommonOptions(commonDefaults(conf))\n-        .setRecursive(false)\n         .setCreateAncestors(false)\n         .setLoadDescendantType(LoadDescendantPType.NONE)\n+        .setRecursive(false)", "originalCommit": "b1db291ea7d36fc1f475206ae1f24446e0872b97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwMjEyOQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r517902129", "bodyText": "I think order by A-Z will be better?", "author": "JySongWithZhangCe", "createdAt": "2020-11-05T09:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDU5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r517840597", "bodyText": "nit: restore the order", "author": "jiacheliu3", "createdAt": "2020-11-05T07:30:30Z", "path": "core/client/fs/src/test/java/alluxio/util/FileSystemOptionsTest.java", "diffHunk": "@@ -39,8 +39,8 @@ public void before() throws Exception {\n   public void loadMetadataOptionsDefaults() {\n     LoadMetadataPOptions options = FileSystemOptions.loadMetadataDefaults(mConf);\n     assertNotNull(options);\n-    assertFalse(options.getRecursive());\n     assertFalse(options.getCreateAncestors());\n+    assertFalse(options.getRecursive());", "originalCommit": "b1db291ea7d36fc1f475206ae1f24446e0872b97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwMjUyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r517902525", "bodyText": "Same reason as above", "author": "JySongWithZhangCe", "createdAt": "2020-11-05T09:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NTc0MA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r517845740", "bodyText": "@apc999 Do you think we should update the auditContext here?\nauditContext.setSucceeded(true);\n\nSimilarly, update the metrics too?", "author": "jiacheliu3", "createdAt": "2020-11-05T07:42:41Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1040,6 +1040,10 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n           }\n           ensureFullPathAndUpdateCache(inodePath);\n \n+          if (context.getOptions().getLoadMetadataOnly()) {\n+            continue;", "originalCommit": "b1db291ea7d36fc1f475206ae1f24446e0872b97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxMDEzMA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r517910130", "bodyText": "good idea", "author": "JySongWithZhangCe", "createdAt": "2020-11-05T09:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ3NzgzMA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r518477830", "bodyText": "Metrics of loadMetadata already update above. Metrics below is associated with getFileInfo, so we needn't update it.", "author": "JySongWithZhangCe", "createdAt": "2020-11-06T01:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NTc0MA=="}], "type": "inlineReview"}, {"oid": "9cf1202bbeec2eea6f39c26efc6f1fba246dd236", "url": "https://github.com/Alluxio/alluxio/commit/9cf1202bbeec2eea6f39c26efc6f1fba246dd236", "message": "add auditContext setSucceeded before continue", "committedDate": "2020-11-05T09:35:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyNTMwNA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r518925304", "bodyText": "@gpang  is this the correct location to continue if we don't need results returned?", "author": "apc999", "createdAt": "2020-11-06T18:20:24Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -1040,6 +1040,11 @@ public void listStatus(AlluxioURI path, ListStatusContext context,\n           }\n           ensureFullPathAndUpdateCache(inodePath);\n \n+          if (context.getOptions().getLoadMetadataOnly()) {", "originalCommit": "9cf1202bbeec2eea6f39c26efc6f1fba246dd236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzMjkyMQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520232921", "bodyText": "@gpang  ping", "author": "apc999", "createdAt": "2020-11-10T01:44:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyNTMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3NzM0NA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520777344", "bodyText": "I think this is fine, but I think I would suggest a slightly different approach. The part after this code gathers all the results, and updates metrics. If we return here, we will not get some of the metrics accounting. Instead, it could look something like this:\nensureFullPathAndUpdateCache(inodePath);\n\nauditContext.setSrcInode(inodePath.getInode());\nif (!context.getOptions().getLoadMetadataOnly()) {  // this line is new\n  DescendantType descendantTypeForListStatus =\n    (context.getOptions().getRecursive()) ? DescendantType.ALL : DescendantType.ONE;\n  listStatusInternal(context, rpcContext, inodePath, auditContext,\n    descendantTypeForListStatus, resultStream, 0);\n}    // this line is new\nauditContext.setSucceeded(true);\nMetrics.FILE_INFOS_GOT.inc();\nif (!ufsAccessed) {\n  MountTable.Resolution resolution = mMountTable.resolve(inodePath.getUri());\n  Metrics.getUfsCounter(mMountTable.getMountInfo(resolution.getMountId())\n      .getUfsUri().toString(),\n    Metrics.UFSOps.LIST_STATUS).inc();\n}\nBasically, what this is doing is the method is unchanged, but the option only guards the call to listStatusInternal() which is the method that fills in all the results. If we don't want results, we only skip calling that method.\nWhat do you think?", "author": "gpang", "createdAt": "2020-11-10T18:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyNTMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk4NDE4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520984185", "bodyText": "SGTM, @JySongWithZhangCe  Can you address @gpang 's comments?", "author": "apc999", "createdAt": "2020-11-11T01:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyNTMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk5MzkxMA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520993910", "bodyText": "SGTM, Thx @gpang and @apc999 !", "author": "JySongWithZhangCe", "createdAt": "2020-11-11T01:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyNTMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODcwMg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r518928702", "bodyText": "set the added flag explicitly here?", "author": "apc999", "createdAt": "2020-11-06T18:26:50Z", "path": "core/client/fs/src/main/java/alluxio/client/file/BaseFileSystem.java", "diffHunk": "@@ -289,6 +289,18 @@ public void iterateStatus(AlluxioURI path, final ListStatusPOptions options,\n     });\n   }\n \n+  @Override\n+  public void loadMetadata(AlluxioURI path, final ListStatusPOptions options)\n+      throws FileDoesNotExistException, IOException, AlluxioException {\n+    checkUri(path);\n+    rpc(client -> {\n+      ListStatusPOptions mergedOptions = FileSystemOptions.listStatusDefaults(\n+          mFsContext.getPathConf(path)).toBuilder().mergeFrom(options).build();", "originalCommit": "9cf1202bbeec2eea6f39c26efc6f1fba246dd236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE5NDMzMg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r519194332", "bodyText": "Do you suggest move ListStatusPOptions build process from LoadMetadataCommand to there?", "author": "JySongWithZhangCe", "createdAt": "2020-11-07T16:35:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzMjU1NA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520232554", "bodyText": "@JySongWithZhangCe\nBetter to add .setLoadMetadataOnly(true) explicitly here?", "author": "apc999", "createdAt": "2020-11-10T01:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzNDk0NA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520234944", "bodyText": "Good idea! How about build ListStatusPOptions inside loadMetadata method, and change param final ListStatusPOptions options to boolean recursive", "author": "JySongWithZhangCe", "createdAt": "2020-11-10T01:51:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3NjA0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520276042", "bodyText": "Let's still keep the param as ListStatusPOptions options, to be consistent with other methods in this file", "author": "apc999", "createdAt": "2020-11-10T04:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3Njg0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520276849", "bodyText": "Ok", "author": "JySongWithZhangCe", "createdAt": "2020-11-10T04:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk4MzU4Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520983586", "bodyText": "@JySongWithZhangCe\nwe should add .setLoadMetadataOnly(true) explicitly here, right?\notherwise, how to ensure callers of this method has this set?", "author": "apc999", "createdAt": "2020-11-11T01:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk5MTc2NA==", "url": "https://github.com/Alluxio/alluxio/pull/12421#discussion_r520991764", "bodyText": "I agree", "author": "JySongWithZhangCe", "createdAt": "2020-11-11T01:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODcwMg=="}], "type": "inlineReview"}, {"oid": "2ebb9a4b82a32707c0730b456c79fe4d201219d0", "url": "https://github.com/Alluxio/alluxio/commit/2ebb9a4b82a32707c0730b456c79fe4d201219d0", "message": "change loadMetadataOnly to resultsRequired and fix code related", "committedDate": "2020-11-11T14:15:45Z", "type": "commit"}, {"oid": "2ae06225cc28f82f28ad16297a667311a443e649", "url": "https://github.com/Alluxio/alluxio/commit/2ae06225cc28f82f28ad16297a667311a443e649", "message": "fix LoadMetadataCommand code style", "committedDate": "2020-11-11T14:22:40Z", "type": "commit"}]}