{"pr_number": 11224, "pr_title": "Parallelize DistributedLoadCommand client's job completion check", "pr_createdAt": "2020-03-31T16:24:50Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11224", "timeline": [{"oid": "c15993f97e5b43a943e6f5931b18968a0c6bc680", "url": "https://github.com/Alluxio/alluxio/commit/c15993f97e5b43a943e6f5931b18968a0c6bc680", "message": "Change checking for job completions in DistributedLoadCommand to be done in parallel", "committedDate": "2020-03-31T16:23:42Z", "type": "commit"}, {"oid": "79fd7b6c6f7df5898eed4e2d63212b833d3beae8", "url": "https://github.com/Alluxio/alluxio/commit/79fd7b6c6f7df5898eed4e2d63212b833d3beae8", "message": "checkstyle", "committedDate": "2020-03-31T17:40:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MTI3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11224#discussion_r403141275", "bodyText": "Was the issue that checking everything in serial was too slow? Because this still waits for all the jobs to be checked.", "author": "gpang", "createdAt": "2020-04-03T16:50:43Z", "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -194,38 +195,34 @@ private JobAttempt newJob(AlluxioURI filePath, int replication) {\n   }\n \n   /**\n-   * Waits one job to complete.\n+   * Waits for at least one job to complete.\n    */\n-  private void waitJob() throws IOException {\n-    boolean removed = false;\n+  private void waitJob() {\n+    AtomicBoolean removed = new AtomicBoolean(false);\n     while (true) {\n-      Iterator<JobAttempt> iterator = mSubmittedJobAttempts.iterator();\n-\n-      while (iterator.hasNext()) {\n-        JobAttempt jobAttempt = iterator.next();\n+      mSubmittedJobAttempts = mSubmittedJobAttempts.parallelStream().filter((jobAttempt) -> {\n         Status check = jobAttempt.check();\n-\n         switch (check) {\n           case CREATED:\n           case RUNNING:\n-            continue;\n+            return true;\n           case CANCELED:\n           case COMPLETED:\n-            removed = true;\n-            jobAttempt.close();\n-            iterator.remove();\n-            continue;\n-          case FAILED:\n-            if (!jobAttempt.run()) {\n-              removed = true;\n-              iterator.remove();\n+            removed.set(true);\n+            try {\n+              jobAttempt.close();\n+            } catch (IOException e) {\n+              LOG.warn(\"Unable to close job master client\", e);\n             }\n-            continue;\n+            return false;\n+          case FAILED:\n+            removed.set(true);\n+            return false;\n           default:\n             throw new IllegalStateException(String.format(\"Unexpected Status: %s\", check));\n         }\n-      }\n-      if (removed) {\n+      }).collect(Collectors.toList());", "originalCommit": "79fd7b6c6f7df5898eed4e2d63212b833d3beae8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE1Mjk4Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11224#discussion_r403152987", "bodyText": "that is correct. Performing listStatus on all 1000 jobs in serial is slow. There are ways to do this asynchronously but that would mean that there will be some concurrency concerns with the rest of the code and this feels like enough of an improvement.", "author": "bradyoo", "createdAt": "2020-04-03T17:05:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MTI3NQ=="}], "type": "inlineReview"}]}