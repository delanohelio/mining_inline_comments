{"pr_number": 10877, "pr_title": "Fix meter bug to calculate throughput value at master directly", "pr_createdAt": "2020-02-10T23:05:59Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10877", "timeline": [{"oid": "0783cb9e132f3a43b9b48b5b07fface7f22cb8eb", "url": "https://github.com/Alluxio/alluxio/commit/0783cb9e132f3a43b9b48b5b07fface7f22cb8eb", "message": "Calculate throughput value at master directly", "committedDate": "2020-02-10T23:04:44Z", "type": "commit"}, {"oid": "11fc055f60e0b0fa778f01996abd4c526f615cb9", "url": "https://github.com/Alluxio/alluxio/commit/11fc055f60e0b0fa778f01996abd4c526f615cb9", "message": "small fix", "committedDate": "2020-02-10T23:18:53Z", "type": "commit"}, {"oid": "af91b66ba974ac879df714554cfbb6bb6c3f294b", "url": "https://github.com/Alluxio/alluxio/commit/af91b66ba974ac879df714554cfbb6bb6c3f294b", "message": "Remove MetricsMasterTest", "committedDate": "2020-02-10T23:34:18Z", "type": "commit"}, {"oid": "fd97126e89608e99f41a0c54e8af32665fc8135b", "url": "https://github.com/Alluxio/alluxio/commit/fd97126e89608e99f41a0c54e8af32665fc8135b", "message": "Reduce copy for the client metrics", "committedDate": "2020-02-11T21:03:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NzA1Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377947052", "bodyText": "What's the reasoning for using 10 seconds?", "author": "ZacBlanco", "createdAt": "2020-02-11T22:50:13Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3221,7 +3203,7 @@ public String toString() {\n   public static final PropertyKey USER_METRICS_HEARTBEAT_INTERVAL_MS =\n       new Builder(Name.USER_METRICS_HEARTBEAT_INTERVAL_MS)\n           .setAlias(\"alluxio.user.metrics.heartbeat.interval.ms\")\n-          .setDefaultValue(\"1min\")\n+          .setDefaultValue(\"10sec\")", "originalCommit": "fd97126e89608e99f41a0c54e8af32665fc8135b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1NTI3OA==", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377955278", "bodyText": "It's hard to choose the default value for this interval.\nWe want it to be big enough to make sure master can handle that many client connections. --> reduce client connections overhead on the leading master.\nAlso we want it to be small enough that we can see more updated changes in the leading master metrics page/sink.\nSo it will be good to choose the smallest number under the criteria that leading master can handles.\nI expect that we can handle 1000 workers with heartbeat 1sec to the leading master. Then I feel we are likely to handle 10,000 workers with heartbeat interval 10sec.", "author": "LuQQiu", "createdAt": "2020-02-11T23:12:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NzA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTkwMg==", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377949902", "bodyText": "@calvinjia has a PR out that will use either hostname or App ID if it is set. Maybe we should consider updating this argument name as well? #10890", "author": "ZacBlanco", "createdAt": "2020-02-11T22:57:29Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -132,45 +76,34 @@ public void putWorkerMetrics(String hostname, List<Metric> metrics) {\n       return;\n     }\n     try (LockResource r = new LockResource(mLock.readLock())) {\n-      mLastReportedTimeMap.put(getFullInstanceId(hostname, null), System.currentTimeMillis());\n       putReportedMetrics(InstanceType.WORKER, metrics);\n     }\n   }\n \n   /**\n-   * Put the metrics from a client with a hostname and a client id. If all the old metrics\n-   * associated with this instance will be removed and then replaced by the latest.\n+   * Put the metrics from a client with a hostname.\n    *\n    * @param hostname the hostname of the client\n-   * @param clientId the id of the client\n    * @param metrics the new metrics\n    */\n-  public void putClientMetrics(String hostname, String clientId, List<Metric> metrics) {\n+  public void putClientMetrics(String hostname, List<Metric> metrics) {", "originalCommit": "fd97126e89608e99f41a0c54e8af32665fc8135b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1NTgwMA==", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377955800", "bodyText": "There is still some discussion needed for the PR, it would be better to deal with them separately.", "author": "LuQQiu", "createdAt": "2020-02-11T23:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MTM5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377951397", "bodyText": "why are these all set to false now?", "author": "ZacBlanco", "createdAt": "2020-02-11T23:01:27Z", "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -668,7 +668,7 @@ public MetricKey build() {\n           .setDescription(\"Bytes read throughput from Alluxio storage \"\n               + \"via domain socket by this worker\")\n           .setMetricType(MetricType.METER)\n-          .setIsClusterAggregated(true)\n+          .setIsClusterAggregated(false)", "originalCommit": "fd97126e89608e99f41a0c54e8af32665fc8135b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1NjMzNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377956335", "bodyText": "Because they are throughput meter. Instead of sending meter one minute rate to the leading master, directly calculating throughput value in the leading master is more correct and easier to understand. The details are written in the PR description", "author": "LuQQiu", "createdAt": "2020-02-11T23:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MTM5Nw=="}], "type": "inlineReview"}]}