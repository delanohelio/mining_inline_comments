{"pr_number": 1071, "pr_title": "Fix Sonar Cloud Issues", "pr_createdAt": "2020-07-20T14:51:53Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1071", "timeline": [{"oid": "8f8c5d327ae22e8941c3c92e233d97d4b3886c40", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/8f8c5d327ae22e8941c3c92e233d97d4b3886c40", "message": "Fix(Jira): Resolve cognitive complexity sonar cloud issue", "committedDate": "2020-07-20T13:52:51Z", "type": "commit"}, {"oid": "618ebb9c6480fb7b151a15826984bfe73cebb3e2", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/618ebb9c6480fb7b151a15826984bfe73cebb3e2", "message": "Fix(Azure Library): Resolve duplicate String.format in work item type state service", "committedDate": "2020-07-20T14:05:01Z", "type": "commit"}, {"oid": "61a3d34d819f7cd98d37168202b54c9753eaf908", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/61a3d34d819f7cd98d37168202b54c9753eaf908", "message": "Fix(Azure Library): Create constants for duplicate strings", "committedDate": "2020-07-20T14:51:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MjU2Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1071#discussion_r457472563", "bodyText": "Moved these methods up.", "author": "gkillough", "createdAt": "2020-07-20T15:05:15Z", "path": "alert-jira/src/main/java/com/synopsys/integration/alert/jira/common/util/JiraIssueHandler.java", "diffHunk": "@@ -109,6 +109,29 @@ public JiraIssueHandler(Gson gson, JiraTransitionHandler jiraTransitionHandler,\n         return Optional.empty();\n     }\n \n+    @Override\n+    protected void logIssueAction(String issueTrackerProjectName, IssueTrackerRequest request) {\n+        JiraIssueSearchProperties issueProperties = request.getIssueSearchProperties();\n+        String issueTrackerProjectVersion = issueProperties.getSubTopicValue() != null ? issueProperties.getSubTopicValue() : \"unknown\";\n+        String arbitraryItemSubComponent = issueProperties.getSubComponentValue() != null ? issueProperties.getSubTopicValue() : \"unknown\";\n+        logger.debug(\"Attempting the {} action on the project {}. Provider: {}, Provider Url: {}, Provider Project: {}[{}]. Category: {}, Component: {}, SubComponent: {}.\",\n+            request.getOperation().name(), issueTrackerProjectName, issueProperties.getProvider(), issueProperties.getProviderUrl(), issueProperties.getTopicValue(), issueTrackerProjectVersion, issueProperties.getCategory(),\n+            issueProperties.getComponentValue(),\n+            arbitraryItemSubComponent);\n+    }\n+\n+    private void addIssueProperties(String issueKey, JiraIssueSearchProperties issueProperties) throws IntegrationException {\n+        jiraIssuePropertyHelper.addPropertiesToIssue(issueKey, issueProperties);\n+    }\n+\n+    private IssueRequestModelFieldsBuilder createFieldsBuilder(IssueContentModel contentModel) {\n+        IssueRequestModelFieldsBuilder fieldsBuilder = new IssueRequestModelFieldsBuilder();\n+        fieldsBuilder.setSummary(contentModel.getTitle());\n+        fieldsBuilder.setDescription(contentModel.getDescription());\n+\n+        return fieldsBuilder;\n+    }\n+", "originalCommit": "61a3d34d819f7cd98d37168202b54c9753eaf908", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MzEwNQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1071#discussion_r457473105", "bodyText": "Deleted lines: 126 to 149\n\nAbstracted this to its own method.", "author": "gkillough", "createdAt": "2020-07-20T15:05:52Z", "path": "alert-jira/src/main/java/com/synopsys/integration/alert/jira/common/util/JiraIssueHandler.java", "diffHunk": "@@ -120,64 +143,53 @@ protected boolean transitionIssue(IssueResponseModel issueModel, IssueConfig iss\n     }\n \n     private AlertException improveRestException(IntegrationRestException restException, String issueCreatorEmail) {\n+        String message = restException.getMessage();\n         JsonObject responseContent = gson.fromJson(restException.getHttpResponseContent(), JsonObject.class);\n-        List<String> responseErrors = new ArrayList<>();\n         if (null != responseContent) {\n-            if (responseContent.has(\"errors\")) {\n-                JsonObject errors = responseContent.get(\"errors\").getAsJsonObject();\n-                if (errors.has(\"reporter\")) {\n-                    JsonElement reporterErrorMessage = errors.get(\"reporter\");\n-                    if (null != reporterErrorMessage) {\n-                        return new AlertFieldException(Map.of(\n-                            getIssueCreatorFieldKey(),\n-                            String.format(\"There was a problem assigning '%s' to the issue. Please ensure that the user is assigned to the project and has permission to transition issues. Error: %s\", issueCreatorEmail, reporterErrorMessage)\n-                        ));\n-                    }\n-                } else {\n-                    Set<Map.Entry<String, JsonElement>> entries = errors.entrySet();\n-                    List<String> fieldErrors = entries.stream()\n-                                                   .map(entry -> String.format(\"Field '%s' has error %s\", entry.getKey(), entry.getValue()))\n-                                                   .collect(Collectors.toList());\n-                    responseErrors.addAll(fieldErrors);\n-                }\n-\n-            }\n-            if (responseContent.has(\"errorMessages\")) {\n-                JsonArray errorMessages = responseContent.get(\"errorMessages\").getAsJsonArray();\n-                for (JsonElement errorMessage : errorMessages) {\n-                    responseErrors.add(errorMessage.getAsString());\n+            try {\n+                List<String> responseErrors = extractErrorsFromResponseContent(responseContent, issueCreatorEmail);\n+                if (!responseErrors.isEmpty()) {\n+                    message += \" | Details: \" + StringUtils.join(responseErrors, \", \");\n                 }", "originalCommit": "61a3d34d819f7cd98d37168202b54c9753eaf908", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3NDQxMQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1071#discussion_r457474411", "bodyText": "Abstracted this to its own method.", "author": "gkillough", "createdAt": "2020-07-20T15:07:18Z", "path": "alert-jira/src/main/java/com/synopsys/integration/alert/jira/common/util/JiraIssueHandler.java", "diffHunk": "@@ -120,64 +143,53 @@ protected boolean transitionIssue(IssueResponseModel issueModel, IssueConfig iss\n     }\n \n     private AlertException improveRestException(IntegrationRestException restException, String issueCreatorEmail) {\n+        String message = restException.getMessage();\n         JsonObject responseContent = gson.fromJson(restException.getHttpResponseContent(), JsonObject.class);\n-        List<String> responseErrors = new ArrayList<>();\n         if (null != responseContent) {\n-            if (responseContent.has(\"errors\")) {\n-                JsonObject errors = responseContent.get(\"errors\").getAsJsonObject();\n-                if (errors.has(\"reporter\")) {\n-                    JsonElement reporterErrorMessage = errors.get(\"reporter\");\n-                    if (null != reporterErrorMessage) {\n-                        return new AlertFieldException(Map.of(\n-                            getIssueCreatorFieldKey(),\n-                            String.format(\"There was a problem assigning '%s' to the issue. Please ensure that the user is assigned to the project and has permission to transition issues. Error: %s\", issueCreatorEmail, reporterErrorMessage)\n-                        ));\n-                    }", "originalCommit": "61a3d34d819f7cd98d37168202b54c9753eaf908", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3NTkzNg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1071#discussion_r457475936", "bodyText": "I think it would be even better if we could somehow use these constante in the template strings themselves", "author": "bamandel", "createdAt": "2020-07-20T15:09:06Z", "path": "azure-boards-common/src/main/java/com/synopsys/integration/azure/boards/common/service/state/AzureWorkItemTypeStateService.java", "diffHunk": "@@ -40,6 +40,13 @@\n     public static final AzureSpecTemplate API_SPEC_ORGANIZATION_PROCESS_WORKITEMTYPE_STATES = new AzureSpecTemplate(\"/{organization}/_apis/work/processes/{processId}/workItemTypes/{witRefName}/states\");\n     public static final AzureSpecTemplate API_SPEC_ORGANIZATION_PROCESS_WORKITEMTYPE_STATE_INDIVIDUAL = new AzureSpecTemplate(\"/{organization}/_apis/work/processes/{processId}/workItemTypes/{witRefName}/states/{stateId}\");\n \n+    public static final String PATH_ORGANIZATION_REPLACEMENT = \"{organization}\";\n+    public static final String PATH_PROJECT_REPLACEMENT = \"{project}\";\n+    public static final String PATH_TYPE_REPLACEMENT = \"{type}\";\n+    public static final String PATH_PROCESS_ID_REPLACEMENT = \"{processId}\";\n+    public static final String PATH_WIT_REF_NAME_REPLACEMENT = \"{witRefName}\";\n+    public static final String PATH_STATE_ID_REPLACEMENT = \"{stateId}\";", "originalCommit": "61a3d34d819f7cd98d37168202b54c9753eaf908", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3NzUzMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1071#discussion_r457477532", "bodyText": "Unfortunately, the whole point of the template string is to be able to nicely read the template. Otherwise there would be no real purpose for the class.", "author": "gkillough", "createdAt": "2020-07-20T15:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3NTkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3NzcyNA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1071#discussion_r457477724", "bodyText": "We could also use Optional's to reduce the cognitive complexity here. Something like this\nOptional<JsonObject> errorsOptional = Optional.ofNullable(responseContent)\n    .filter(json -> json.has(\"errors\"))\n    .map(json -> json.get(\"errors\").getAsJsonObject());\nOptional<JsonElement> errorsReporterOptional = errorsOptional\n    .filter(errorsJson -> errorsJson.has(\"reporter\"))\n    .map(errorsJson -> errorsJson.get(\"reporter\"));\nif (errorsReporterOptional.isPresent()) {\n    throwReporterException(errorsReporterOptional.get(), issueCreatorEmail);\n}\nThe optionals should help reduce the nested if's when dealing with the JsonObjects.", "author": "jamesrichard91", "createdAt": "2020-07-20T15:11:08Z", "path": "alert-jira/src/main/java/com/synopsys/integration/alert/jira/common/util/JiraIssueHandler.java", "diffHunk": "@@ -120,64 +143,53 @@ protected boolean transitionIssue(IssueResponseModel issueModel, IssueConfig iss\n     }\n \n     private AlertException improveRestException(IntegrationRestException restException, String issueCreatorEmail) {\n+        String message = restException.getMessage();\n         JsonObject responseContent = gson.fromJson(restException.getHttpResponseContent(), JsonObject.class);\n-        List<String> responseErrors = new ArrayList<>();\n         if (null != responseContent) {\n-            if (responseContent.has(\"errors\")) {\n-                JsonObject errors = responseContent.get(\"errors\").getAsJsonObject();\n-                if (errors.has(\"reporter\")) {\n-                    JsonElement reporterErrorMessage = errors.get(\"reporter\");\n-                    if (null != reporterErrorMessage) {\n-                        return new AlertFieldException(Map.of(\n-                            getIssueCreatorFieldKey(),\n-                            String.format(\"There was a problem assigning '%s' to the issue. Please ensure that the user is assigned to the project and has permission to transition issues. Error: %s\", issueCreatorEmail, reporterErrorMessage)\n-                        ));\n-                    }\n-                } else {\n-                    Set<Map.Entry<String, JsonElement>> entries = errors.entrySet();\n-                    List<String> fieldErrors = entries.stream()\n-                                                   .map(entry -> String.format(\"Field '%s' has error %s\", entry.getKey(), entry.getValue()))\n-                                                   .collect(Collectors.toList());\n-                    responseErrors.addAll(fieldErrors);\n-                }\n-\n-            }\n-            if (responseContent.has(\"errorMessages\")) {\n-                JsonArray errorMessages = responseContent.get(\"errorMessages\").getAsJsonArray();\n-                for (JsonElement errorMessage : errorMessages) {\n-                    responseErrors.add(errorMessage.getAsString());\n+            try {\n+                List<String> responseErrors = extractErrorsFromResponseContent(responseContent, issueCreatorEmail);\n+                if (!responseErrors.isEmpty()) {\n+                    message += \" | Details: \" + StringUtils.join(responseErrors, \", \");\n                 }\n+            } catch (AlertFieldException reporterException) {\n+                return reporterException;\n             }\n         }\n-\n-        String message = restException.getMessage();\n-        if (!responseErrors.isEmpty()) {\n-            message += \" | Details: \" + StringUtils.join(responseErrors, \", \");\n-        }\n-\n         return new AlertException(message, restException);\n     }\n \n-    private void addIssueProperties(String issueKey, JiraIssueSearchProperties issueProperties) throws IntegrationException {\n-        jiraIssuePropertyHelper.addPropertiesToIssue(issueKey, issueProperties);\n-    }\n-\n-    private IssueRequestModelFieldsBuilder createFieldsBuilder(IssueContentModel contentModel) {\n-        IssueRequestModelFieldsBuilder fieldsBuilder = new IssueRequestModelFieldsBuilder();\n-        fieldsBuilder.setSummary(contentModel.getTitle());\n-        fieldsBuilder.setDescription(contentModel.getDescription());\n+    private List<String> extractErrorsFromResponseContent(JsonObject responseContent, String issueCreatorEmail) throws AlertFieldException {\n+        List<String> responseErrors = new ArrayList<>();\n+        if (responseContent.has(\"errors\")) {", "originalCommit": "61a3d34d819f7cd98d37168202b54c9753eaf908", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4NjA1NA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1071#discussion_r457486054", "bodyText": "Hmm, I've always had reservations about using inline Optional.ofNullable(...), but other than a temporary object that will be garbage collected, this is definitely easier to follow.", "author": "gkillough", "createdAt": "2020-07-20T15:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3NzcyNA=="}], "type": "inlineReview"}, {"oid": "03beaea3c21a20d3e0a6c8d54b02371af68f7b32", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/03beaea3c21a20d3e0a6c8d54b02371af68f7b32", "message": "Fix(Jira): Add further abstraction through optionals to reduce cognitive complexity", "committedDate": "2020-07-20T15:52:27Z", "type": "commit"}, {"oid": "b0335773ba7c8058c7a5919dd6b2abe487b42f1b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/b0335773ba7c8058c7a5919dd6b2abe487b42f1b", "message": "Fix(Jira): Remove unnecessary optional usage", "committedDate": "2020-07-20T16:09:53Z", "type": "commit"}]}