{"pr_number": 1294, "pr_title": "Jira channel-side custom field support", "pr_createdAt": "2020-12-10T19:01:07Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294", "timeline": [{"oid": "38fd8d37b90b057eba9cbb94880431787120fa2f", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/38fd8d37b90b057eba9cbb94880431787120fa2f", "message": "Fix(Jira): Update issue creator field validation to allow blank values", "committedDate": "2020-12-09T16:47:40Z", "type": "commit"}, {"oid": "6e8905beb9ffcc70d32031e7442716b4de6d86c0", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/6e8905beb9ffcc70d32031e7442716b4de6d86c0", "message": "Feat(Jira): Add 'customFields' field for Jira issue configs", "committedDate": "2020-12-10T18:52:06Z", "type": "commit"}, {"oid": "50316bc4daa0a0208842de02470207b4e25e70c2", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/50316bc4daa0a0208842de02470207b4e25e70c2", "message": "Feat(Jira): Implement initial Jira Cloud custom field resolution", "committedDate": "2020-12-10T20:30:41Z", "type": "commit"}, {"oid": "ddd3bc14dacad53bcfeab6430bdb74475abefad1", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/ddd3bc14dacad53bcfeab6430bdb74475abefad1", "message": "Feat(Jira): Abstract custom field resolution logic and add support for Jira Server", "committedDate": "2020-12-11T16:30:41Z", "type": "commit"}, {"oid": "bd7dbaef2e7c9b9e03a9a20b370f62f1c795970b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/bd7dbaef2e7c9b9e03a9a20b370f62f1c795970b", "message": "Fix(Jira): Remove unnecessary field and update FIXMEs", "committedDate": "2020-12-11T16:36:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA3NTYyNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541075627", "bodyText": "This will be done in the next PR.", "author": "gkillough", "createdAt": "2020-12-11T16:37:04Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/cloud/JiraCloudContextBuilder.java", "diffHunk": "@@ -91,13 +52,18 @@ public JiraCloudContext build(ConfigurationModel globalConfig, DistributionJobMo\n         DistributionJobDetailsModel distributionJobDetails = jobModel.getDistributionJobDetails();\n         JiraCloudJobDetailsModel jiraCouldJobDetails = distributionJobDetails.getAsJiraCouldJobDetails();\n \n-        IssueConfig issueConfig = new IssueConfig();\n-        issueConfig.setProjectName(jiraCouldJobDetails.getProjectNameOrKey());\n-        issueConfig.setIssueCreator(jiraCouldJobDetails.getIssueCreatorEmail());\n-        issueConfig.setIssueType(jiraCouldJobDetails.getIssueType());\n-        issueConfig.setCommentOnIssues(jiraCouldJobDetails.isAddComments());\n-        issueConfig.setResolveTransition(jiraCouldJobDetails.getResolveTransition());\n-        issueConfig.setOpenTransition(jiraCouldJobDetails.getReopenTransition());\n+        // FIXME add custom fields", "originalCommit": "ddd3bc14dacad53bcfeab6430bdb74475abefad1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA3NTk0OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541075948", "bodyText": "This will be done in the next PR.", "author": "gkillough", "createdAt": "2020-12-11T16:37:28Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/server/JiraServerContextBuilder.java", "diffHunk": "@@ -91,14 +52,18 @@ public JiraServerContext build(ConfigurationModel globalConfig, DistributionJobM\n         DistributionJobDetailsModel distributionJobDetails = testJobModel.getDistributionJobDetails();\n         JiraServerJobDetailsModel jiraServerJobDetails = distributionJobDetails.getAsJiraServerJobDetails();\n \n-        IssueConfig issueConfig = new IssueConfig();\n-        issueConfig.setProjectName(jiraServerJobDetails.getProjectNameOrKey());\n-        issueConfig.setIssueCreator(jiraServerJobDetails.getIssueCreatorUsername());\n-        issueConfig.setIssueType(jiraServerJobDetails.getIssueType());\n-        issueConfig.setCommentOnIssues(jiraServerJobDetails.isAddComments());\n-        issueConfig.setResolveTransition(jiraServerJobDetails.getResolveTransition());\n-        issueConfig.setOpenTransition(jiraServerJobDetails.getReopenTransition());\n-\n+        // FIXME add custom fields", "originalCommit": "ddd3bc14dacad53bcfeab6430bdb74475abefad1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ad74730726fc1490b07cf4242512a7cf6067be3f", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/ad74730726fc1490b07cf4242512a7cf6067be3f", "message": "Merge branch 'master' into gk_jira_custom_fields", "committedDate": "2020-12-11T18:35:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE4NDQzOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541184438", "bodyText": "Are we passing in the projectNameOrKey twice on purpose? or was this an accident?", "author": "jamesrichard91", "createdAt": "2020-12-11T19:16:16Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/cloud/JiraCloudContextBuilder.java", "diffHunk": "@@ -91,13 +52,18 @@ public JiraCloudContext build(ConfigurationModel globalConfig, DistributionJobMo\n         DistributionJobDetailsModel distributionJobDetails = jobModel.getDistributionJobDetails();\n         JiraCloudJobDetailsModel jiraCouldJobDetails = distributionJobDetails.getAsJiraCouldJobDetails();\n \n-        IssueConfig issueConfig = new IssueConfig();\n-        issueConfig.setProjectName(jiraCouldJobDetails.getProjectNameOrKey());\n-        issueConfig.setIssueCreator(jiraCouldJobDetails.getIssueCreatorEmail());\n-        issueConfig.setIssueType(jiraCouldJobDetails.getIssueType());\n-        issueConfig.setCommentOnIssues(jiraCouldJobDetails.isAddComments());\n-        issueConfig.setResolveTransition(jiraCouldJobDetails.getResolveTransition());\n-        issueConfig.setOpenTransition(jiraCouldJobDetails.getReopenTransition());\n+        // FIXME add custom fields\n+        JiraIssueConfig issueConfig = new JiraIssueConfig(\n+            jiraCouldJobDetails.getProjectNameOrKey(),\n+            jiraCouldJobDetails.getProjectNameOrKey(),", "originalCommit": "ad74730726fc1490b07cf4242512a7cf6067be3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5MjE2Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541192163", "bodyText": "I'm not entirely sure we use all of these fields and it's something that needs a closer look, but this object has \"project name\" and \"project key\" fields and I'm passing it into both just in case. In Jira APIs you can use both interchangeably (unlike the project id).", "author": "gkillough", "createdAt": "2020-12-11T19:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE4NDQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE4NjMwMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541186302", "bodyText": "How long are we keeping this cache around for?", "author": "jamesrichard91", "createdAt": "2020-12-11T19:18:11Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/common/JiraCustomFieldResolver.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/**\n+ * channel\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.channel.jira.common;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.synopsys.integration.alert.channel.jira.common.model.CustomFieldDefinitionModel;\n+import com.synopsys.integration.alert.channel.jira.common.model.JiraCustomFieldConfig;\n+import com.synopsys.integration.alert.channel.jira.common.model.JiraResolvedCustomField;\n+import com.synopsys.integration.alert.common.exception.AlertRuntimeException;\n+import com.synopsys.integration.exception.IntegrationException;\n+import com.synopsys.integration.function.ThrowingSupplier;\n+import com.synopsys.integration.jira.common.model.response.CustomFieldCreationResponseModel;\n+\n+public abstract class JiraCustomFieldResolver {\n+    private static final String CUSTOM_FIELD_TYPE_STRING_VALUE = \"string\";\n+    private static final String CUSTOM_FIELD_TYPE_ARRAY_VALUE = \"array\";\n+    private static final String CUSTOM_FIELD_TYPE_OPTION_VALUE = \"option\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(getClass());\n+\n+    private final ThrowingSupplier<List<CustomFieldCreationResponseModel>, IntegrationException> retrieveAvailableFields;\n+    private final Map<String, CustomFieldCreationResponseModel> fieldCache;\n+    private boolean isCachePopulated;\n+\n+    public JiraCustomFieldResolver(\n+        ThrowingSupplier<List<CustomFieldCreationResponseModel>, IntegrationException> retrieveAvailableFields) {\n+        this.retrieveAvailableFields = retrieveAvailableFields;\n+        this.fieldCache = new HashMap<>();\n+        this.isCachePopulated = false;\n+    }\n+\n+    public final JiraResolvedCustomField resolveCustomField(JiraCustomFieldConfig jiraCustomFieldConfig) {\n+        CustomFieldDefinitionModel fieldDefinition = retrieveCustomFieldDefinition(jiraCustomFieldConfig);\n+        Object requestObject = convertValueToRequestObject(fieldDefinition, jiraCustomFieldConfig);\n+        return new JiraResolvedCustomField(fieldDefinition.getFieldId(), requestObject);\n+    }\n+\n+    protected Optional<CustomFieldCreationResponseModel> retrieveFieldDefinition(String fieldName) {\n+        if (!isCachePopulated) {\n+            try {\n+                initializeCache();\n+            } catch (IntegrationException e) {\n+                logger.warn(\"No Jira Cloud user-visible fields found\");\n+                return Optional.empty();\n+            }\n+        }\n+        return Optional.ofNullable(fieldCache.get(fieldName));\n+    }\n+\n+    protected CustomFieldDefinitionModel retrieveCustomFieldDefinition(JiraCustomFieldConfig customFieldConfig) {\n+        String fieldName = customFieldConfig.getFieldName();\n+        CustomFieldCreationResponseModel fieldResponse = retrieveFieldDefinition(fieldName)\n+                                                             .orElseThrow(() -> new AlertRuntimeException(String.format(\"No custom field named '%s' existed\", fieldName)));\n+        return new CustomFieldDefinitionModel(fieldResponse.getId(), fieldResponse.getSchema().getType());\n+    }\n+\n+    protected Object convertValueToRequestObject(CustomFieldDefinitionModel fieldDefinition, JiraCustomFieldConfig jiraCustomFieldConfig) {\n+        String fieldType = fieldDefinition.getFieldType();\n+        switch (fieldType) {\n+            case CUSTOM_FIELD_TYPE_STRING_VALUE:\n+                return jiraCustomFieldConfig;\n+            case CUSTOM_FIELD_TYPE_ARRAY_VALUE:\n+                JsonArray jsonArray = new JsonArray();\n+                jsonArray.add(jiraCustomFieldConfig.getFieldValue());\n+                return jsonArray;\n+            case CUSTOM_FIELD_TYPE_OPTION_VALUE:\n+                JsonObject jsonObject = new JsonObject();\n+                jsonObject.addProperty(\"value\", jiraCustomFieldConfig.getFieldValue());\n+                return jsonObject;\n+            default:\n+                throw new AlertRuntimeException(String.format(\"Unsupported field type '%s' for field: %s\", fieldType, jiraCustomFieldConfig.getFieldName()));\n+        }\n+    }\n+\n+    private void initializeCache() throws IntegrationException {\n+        List<CustomFieldCreationResponseModel> userVisibleFields = retrieveAvailableFields.get();\n+        for (CustomFieldCreationResponseModel fieldModel : userVisibleFields) {\n+            fieldCache.put(fieldModel.getName(), fieldModel);\n+        }\n+        isCachePopulated = true;\n+    }", "originalCommit": "ad74730726fc1490b07cf4242512a7cf6067be3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5Mjc0OQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541192749", "bodyText": "For the duration of processing of a single event.", "author": "gkillough", "createdAt": "2020-12-11T19:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE4NjMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5MzkzMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541193932", "bodyText": "Do we also need the Jira field type? Should this class be serializable?", "author": "jamesrichard91", "createdAt": "2020-12-11T19:26:19Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/common/model/JiraCustomFieldConfig.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/**\n+ * channel\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.channel.jira.common.model;\n+\n+public class JiraCustomFieldConfig {\n+    private final String fieldName;\n+    private final String fieldValue;", "originalCommit": "ad74730726fc1490b07cf4242512a7cf6067be3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5ODQyMA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541198420", "bodyText": "We get the field type when we look up the field to get its ID. This class is transient in the way that it is used, so I don't think it needs to be serializable.", "author": "gkillough", "createdAt": "2020-12-11T19:30:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5MzkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMwMDgwOQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r541300809", "bodyText": "Instead of using an entire class for this function, you can open up the method that uses this function to accept the function as a parameter. Then wherever you make the distinction between JiraServerCustomFieldResolver and JiraCloudCustomFieldResolver (Couldn't find it in the PR) you instead set a variable function equal to what is being passed here... does that make sense? I think it would be clearer than having 2 separate basically empty classes.", "author": "bamandel", "createdAt": "2020-12-11T21:17:11Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/server/util/JiraServerCustomFieldResolver.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/**\n+ * channel\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.channel.jira.server.util;\n+\n+import com.synopsys.integration.alert.channel.jira.common.JiraCustomFieldResolver;\n+import com.synopsys.integration.jira.common.server.service.FieldService;\n+\n+public class JiraServerCustomFieldResolver extends JiraCustomFieldResolver {\n+    public JiraServerCustomFieldResolver(FieldService fieldService) {\n+        super(fieldService::getUserVisibleFields);", "originalCommit": "ad74730726fc1490b07cf4242512a7cf6067be3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM3MzMxOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1294#discussion_r542373318", "bodyText": "Yeah, I was thinking about this. I didn't know if it would be the most expressive API to ask for a Supplier in the constructor, but I think you're right that it's better than the duplication.", "author": "gkillough", "createdAt": "2020-12-14T13:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMwMDgwOQ=="}], "type": "inlineReview"}, {"oid": "22228493692e1374e312e9c42e691a45366405b9", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/22228493692e1374e312e9c42e691a45366405b9", "message": "Fix(Jira): Remove unnecessary sub-classes", "committedDate": "2020-12-14T13:47:04Z", "type": "commit"}]}