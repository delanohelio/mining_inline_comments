{"pr_number": 966, "pr_title": "helm alertdb", "pr_createdAt": "2020-04-29T19:51:23Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/966", "timeline": [{"oid": "ca99576a57e7b8cc7b1224ae91c3fdb15d3c7442", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/ca99576a57e7b8cc7b1224ae91c3fdb15d3c7442", "message": "refactor: Allow a database connection through environment variables.", "committedDate": "2020-04-23T17:05:47Z", "type": "commit"}, {"oid": "9c75c5b8251d63ea4da2cad93d36ba5baecd4f03", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/9c75c5b8251d63ea4da2cad93d36ba5baecd4f03", "message": "refactor: Remove the environment variable for the database name.", "committedDate": "2020-04-23T17:09:54Z", "type": "commit"}, {"oid": "1027cb3448219e2a1d39b4c0c79109c1ddf89a63", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1027cb3448219e2a1d39b4c0c79109c1ddf89a63", "message": "refactor: Create the database on startup of the alert container.", "committedDate": "2020-04-23T18:43:30Z", "type": "commit"}, {"oid": "96c3fe87be31d9ac8e59d4ca2e6e02eae1a38287", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/96c3fe87be31d9ac8e59d4ca2e6e02eae1a38287", "message": "refactor: Only create the database tables if the database has been created in postgres.", "committedDate": "2020-04-23T19:02:58Z", "type": "commit"}, {"oid": "cdefe953318844248d5e2bc859bd1fc0721024f8", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/cdefe953318844248d5e2bc859bd1fc0721024f8", "message": "refactor: Clean up the connection function.", "committedDate": "2020-04-23T19:36:11Z", "type": "commit"}, {"oid": "663d17d916cbed842040a8e4762e5accdd212a5f", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/663d17d916cbed842040a8e4762e5accdd212a5f", "message": "refactor: Fix why the container always exits.", "committedDate": "2020-04-23T20:11:28Z", "type": "commit"}, {"oid": "2f1f68d29c3e52e538fb45446c44e4f3a9f99f39", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/2f1f68d29c3e52e538fb45446c44e4f3a9f99f39", "message": "build: Update database image version.", "committedDate": "2020-04-24T10:37:45Z", "type": "commit"}, {"oid": "a6adefd0d72fab7ef8ecdc5aa6def31ee2d0ddc0", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a6adefd0d72fab7ef8ecdc5aa6def31ee2d0ddc0", "message": "refactor: Use the correct variable for the database name.", "committedDate": "2020-04-24T11:27:19Z", "type": "commit"}, {"oid": "792e84c6a13c38dc1564ea38dc93912ab087ab0d", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/792e84c6a13c38dc1564ea38dc93912ab087ab0d", "message": "refactor: Add files to support external DB deployment.", "committedDate": "2020-04-24T13:45:04Z", "type": "commit"}, {"oid": "978d2947fb923ef32c72545f1012147dceed70f8", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/978d2947fb923ef32c72545f1012147dceed70f8", "message": "refactor: Remove default credentials from image.", "committedDate": "2020-04-24T14:03:45Z", "type": "commit"}, {"oid": "233389c0d6b1de149ca246b4b4f01e32bc718306", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/233389c0d6b1de149ca246b4b4f01e32bc718306", "message": "refactor: Resolve some issues with environment variables.", "committedDate": "2020-04-24T17:55:35Z", "type": "commit"}, {"oid": "0a4ece216889032cd7ba9249f691147c7a2196a6", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/0a4ece216889032cd7ba9249f691147c7a2196a6", "message": "Merge remote-tracking branch 'origin/master' into ps_helm_alertdb", "committedDate": "2020-04-24T17:57:09Z", "type": "commit"}, {"oid": "a4022e27d86df5be48fbe2daec084ae836948167", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a4022e27d86df5be48fbe2daec084ae836948167", "message": "feat: Add the initial chart template for the database.", "committedDate": "2020-04-27T19:52:37Z", "type": "commit"}, {"oid": "ad15e96323b95deeeaa6774be5f164cc48671547", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/ad15e96323b95deeeaa6774be5f164cc48671547", "message": "refactor: Remove the envFrom causing duplicate keys.", "committedDate": "2020-04-28T14:05:19Z", "type": "commit"}, {"oid": "a1b62b0554c32b7a5834ce3bbc3ec596686d28a8", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a1b62b0554c32b7a5834ce3bbc3ec596686d28a8", "message": "refactor: Add additional health check parameters.", "committedDate": "2020-04-28T14:08:58Z", "type": "commit"}, {"oid": "40ca68911b0b8d094ea7bb497a81abeafcc0dc61", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/40ca68911b0b8d094ea7bb497a81abeafcc0dc61", "message": "refactor: Fix spacing on port environment variable.", "committedDate": "2020-04-28T14:34:10Z", "type": "commit"}, {"oid": "9b6f656baadbac451fe4afed7e0ab87c2ef169f0", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/9b6f656baadbac451fe4afed7e0ab87c2ef169f0", "message": "refactor: Supply value to alertdb.host since it is required to pass the build.", "committedDate": "2020-04-28T14:44:29Z", "type": "commit"}, {"oid": "95b042e3600e3ade7f2ffc1bfd480974c7680bf2", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/95b042e3600e3ade7f2ffc1bfd480974c7680bf2", "message": "refactor: Fix the indent statements.", "committedDate": "2020-04-28T17:16:19Z", "type": "commit"}, {"oid": "3168591d0b455505785f2bc3bbd6ecfc63bededd", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3168591d0b455505785f2bc3bbd6ecfc63bededd", "message": "feat: Changes to get the alert chart to start correctly.", "committedDate": "2020-04-28T19:43:48Z", "type": "commit"}, {"oid": "af075a8ec2ccf15b3295a84d7d6b1d1b9fbf5245", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/af075a8ec2ccf15b3295a84d7d6b1d1b9fbf5245", "message": "refactor: Fix the mount point for the database.", "committedDate": "2020-04-29T18:29:20Z", "type": "commit"}, {"oid": "4d79086ffa550b2ed4434e2ca1c3e2a7f8174b82", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/4d79086ffa550b2ed4434e2ca1c3e2a7f8174b82", "message": "Merge remote-tracking branch 'origin/master' into ps_helm_alertdb", "committedDate": "2020-04-29T19:08:20Z", "type": "commit"}, {"oid": "bb70c0e0b05757f5820424b61bc2133292758fee", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/bb70c0e0b05757f5820424b61bc2133292758fee", "message": "refactor: Make the last search migration more specific to a single config.", "committedDate": "2020-04-29T19:50:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3NTk1Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417975952", "bodyText": "We can call this variable blackDuckProviderKey to make it more clear in the initialize() method that this is the only expected config in an upgrade.", "author": "gkillough", "createdAt": "2020-04-30T12:35:14Z", "path": "src/main/java/com/synopsys/integration/alert/workflow/startup/component/LastSearchDataMigration.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/**\n+ * blackduck-alert\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.workflow.startup.component;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.common.enumeration.ConfigContextEnum;\n+import com.synopsys.integration.alert.common.exception.AlertDatabaseConstraintException;\n+import com.synopsys.integration.alert.common.persistence.accessor.ConfigurationAccessor;\n+import com.synopsys.integration.alert.common.persistence.accessor.ProviderTaskPropertiesAccessor;\n+import com.synopsys.integration.alert.common.persistence.model.ConfigurationModel;\n+import com.synopsys.integration.alert.common.persistence.util.FilePersistenceUtil;\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProviderKey;\n+import com.synopsys.integration.alert.provider.blackduck.tasks.BlackDuckAccumulator;\n+\n+@Component\n+@Order(55)\n+public class LastSearchDataMigration extends StartupComponent {\n+    private static final Logger logger = LoggerFactory.getLogger(LastSearchDataMigration.class);\n+    private static final String LAST_SEARCH_FILE = \"blackduck-accumulator-task-last-search.txt\";\n+\n+    // Because pg_stat_file requires admin privileges to run, we have to migrate the last search file data in code.\n+    // We don't have admin privileges to postgres when alert starts.\n+\n+    private BlackDuckProviderKey providerKey;", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3NjQwOQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417976409", "bodyText": "Let's also deprecate this class for removal in 8.0.0.", "author": "gkillough", "createdAt": "2020-04-30T12:36:05Z", "path": "src/main/java/com/synopsys/integration/alert/workflow/startup/component/LastSearchDataMigration.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/**\n+ * blackduck-alert\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.workflow.startup.component;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.common.enumeration.ConfigContextEnum;\n+import com.synopsys.integration.alert.common.exception.AlertDatabaseConstraintException;\n+import com.synopsys.integration.alert.common.persistence.accessor.ConfigurationAccessor;\n+import com.synopsys.integration.alert.common.persistence.accessor.ProviderTaskPropertiesAccessor;\n+import com.synopsys.integration.alert.common.persistence.model.ConfigurationModel;\n+import com.synopsys.integration.alert.common.persistence.util.FilePersistenceUtil;\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProviderKey;\n+import com.synopsys.integration.alert.provider.blackduck.tasks.BlackDuckAccumulator;\n+\n+@Component\n+@Order(55)\n+public class LastSearchDataMigration extends StartupComponent {", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f42aa0d4c1482066cd21999353c990e6ea5025d6", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/f42aa0d4c1482066cd21999353c990e6ea5025d6", "message": "refactor: Implement PR feedback.", "committedDate": "2020-04-30T13:53:03Z", "type": "commit"}, {"oid": "7f2862d4eb8db316fc1f6af039870cb340092aca", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/7f2862d4eb8db316fc1f6af039870cb340092aca", "message": "refactor: Rename alertdb charts to postgres.", "committedDate": "2020-04-30T13:59:16Z", "type": "commit"}, {"oid": "2fba83d0226f2a48da88a28995f9c498e129fd95", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/2fba83d0226f2a48da88a28995f9c498e129fd95", "message": "refactor: Fix the indentation in the files.", "committedDate": "2020-04-30T14:32:02Z", "type": "commit"}, {"oid": "caf4b24b1c428806ed3bd7dc1146b9544b84dd98", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/caf4b24b1c428806ed3bd7dc1146b9544b84dd98", "message": "refactor: Add the checksum for the database configuration.", "committedDate": "2020-04-30T14:41:41Z", "type": "commit"}, {"oid": "20df917ea7d06e45edfba37b71580027b3a81a12", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/20df917ea7d06e45edfba37b71580027b3a81a12", "message": "refactor: Fix remaining indentation issues.", "committedDate": "2020-04-30T15:04:05Z", "type": "commit"}, {"oid": "30756f6c679c86c733e9316c9f33c435eda4beeb", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/30756f6c679c86c733e9316c9f33c435eda4beeb", "message": "refactor: Set postgres.host parameter to empty string.", "committedDate": "2020-04-30T16:17:14Z", "type": "commit"}, {"oid": "65c43b50c4072652ae269cf254223817f756db1b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/65c43b50c4072652ae269cf254223817f756db1b", "message": "refactor: Update defaults in values file and require host if external", "committedDate": "2020-04-30T16:34:22Z", "type": "commit"}]}