{"pr_number": 1117, "pr_title": "OAuth Implementation", "pr_createdAt": "2020-08-18T18:15:35Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117", "timeline": [{"oid": "89a384d345eb5f184cb96580847531f033f70cfc", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/89a384d345eb5f184cb96580847531f033f70cfc", "message": "feat: Add scopes to the AzureBoardsProperties to get tokens.", "committedDate": "2020-08-13T17:54:52Z", "type": "commit"}, {"oid": "1c32b36dac7d9740502d185bf58f3e4b52c219cb", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1c32b36dac7d9740502d185bf58f3e4b52c219cb", "message": "refactor: Create a full redirect URL.", "committedDate": "2020-08-13T18:13:13Z", "type": "commit"}, {"oid": "afc055d5212ed98d2f37c15c3a98412ad5e669ba", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/afc055d5212ed98d2f37c15c3a98412ad5e669ba", "message": "Merge remote-tracking branch 'origin/6.2.0' into ps_oauth_impl", "committedDate": "2020-08-13T18:16:40Z", "type": "commit"}, {"oid": "87340d816b8d205d8a39d7e7d59ee6557bd30625", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/87340d816b8d205d8a39d7e7d59ee6557bd30625", "message": "refactor: Fix the scopes to work with the test app and redirect to the UI properly.", "committedDate": "2020-08-13T18:49:14Z", "type": "commit"}, {"oid": "44dd1a43b498596bb458f3ba5a67997d22560239", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/44dd1a43b498596bb458f3ba5a67997d22560239", "message": "feat: Request tokens with the authorization code.", "committedDate": "2020-08-13T19:57:38Z", "type": "commit"}, {"oid": "1de0f965c024d9e531182cceffcbfdce674c4e56", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1de0f965c024d9e531182cceffcbfdce674c4e56", "message": "feat: Initial implementation to get access token.", "committedDate": "2020-08-14T17:06:11Z", "type": "commit"}, {"oid": "461b53f4ff1283f8cc658136e22b65e1433c71e1", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/461b53f4ff1283f8cc658136e22b65e1433c71e1", "message": "feat: Add the client secret field to the database and UI.", "committedDate": "2020-08-14T18:38:19Z", "type": "commit"}, {"oid": "14b023dd9911eb98e23828dc0dfd982b5e9b3a21", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/14b023dd9911eb98e23828dc0dfd982b5e9b3a21", "message": "feat: Implement Azure OAuth Code Flow to create correct token responses.", "committedDate": "2020-08-14T20:04:50Z", "type": "commit"}, {"oid": "b6a9f607575100f0cae2a22703534968ddcefbc6", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/b6a9f607575100f0cae2a22703534968ddcefbc6", "message": "refactor: Remove the azure specific content from the properties on the token request.", "committedDate": "2020-08-14T20:08:25Z", "type": "commit"}, {"oid": "45ba73149cee26d39ed35a18496bd5192c14acda", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/45ba73149cee26d39ed35a18496bd5192c14acda", "message": "refactor: Clean up the test projects to work.", "committedDate": "2020-08-17T20:02:56Z", "type": "commit"}, {"oid": "49e9beb9ba5b4570f995cf6bdeb16cd090db1cba", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/49e9beb9ba5b4570f995cf6bdeb16cd090db1cba", "message": "fix: Check the database if fields are sensitive during updates.", "committedDate": "2020-08-18T15:25:36Z", "type": "commit"}, {"oid": "8353f69fb0ee51b9106cda3c141002dbdd439431", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/8353f69fb0ee51b9106cda3c141002dbdd439431", "message": "Merge remote-tracking branch 'origin/6.2.0' into ps_oauth_impl", "committedDate": "2020-08-18T15:33:44Z", "type": "commit"}, {"oid": "e3a28f1d7df933ae123e0ea94843c92f4d7c1b80", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/e3a28f1d7df933ae123e0ea94843c92f4d7c1b80", "message": "feat: Add the check if OAuth is authenticated.", "committedDate": "2020-08-18T17:58:22Z", "type": "commit"}, {"oid": "a1ed88b2b7feccc9f8756979e959d9f15011fd41", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a1ed88b2b7feccc9f8756979e959d9f15011fd41", "message": "chore: Update the documentation for the authentication field.", "committedDate": "2020-08-18T18:12:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NTUyMA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117#discussion_r472395520", "bodyText": "We had a limit in the database of 512.  Increased to 2048 since tokens are larger.  Also made a DB change so the database doesn't care about the string length anymore.  There's no performance gain in Postgres for defining the limit like in other database implementations.  It's a matter of saving space on the disk.  It's still good to validate the size so someone can't insert a string that may cause issues because of it's length.  This is the new allowed size for fields.", "author": "psantos1113", "createdAt": "2020-08-18T18:24:10Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/descriptor/config/field/ConfigField.java", "diffHunk": "@@ -60,7 +60,7 @@\n  */\n public abstract class ConfigField extends AlertSerializableModel {\n     public static final String REQUIRED_FIELD_MISSING = \"Required field missing\";\n-    public static final int MAX_FIELD_LENGTH = 511;\n+    public static final int MAX_FIELD_LENGTH = 2047;", "originalCommit": "a1ed88b2b7feccc9f8756979e959d9f15011fd41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NTkzMw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117#discussion_r472395933", "bodyText": "Can this comment be resolved?", "author": "gkillough", "createdAt": "2020-08-18T18:24:51Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/descriptor/AzureBoardsGlobalUIConfig.java", "diffHunk": "@@ -61,12 +64,13 @@ public AzureBoardsGlobalUIConfig(EncryptionValidator encryptionValidator) {\n         //        ConfigField azureBoardsUrlField = new URLInputConfigField(AzureBoardsDescriptor.KEY_AZURE_BOARDS_URL, LABEL_AZURE_BOARDS_URL, DESCRIPTION_AZURE_BOARDS_URL);\n         ConfigField organizationName = new TextInputConfigField(AzureBoardsDescriptor.KEY_ORGANIZATION_NAME, LABEL_ORGANIZATION_NAME, DESCRIPTION_ORGANIZATION_NAME).applyRequired(true);\n         ConfigField clientId = new TextInputConfigField(AzureBoardsDescriptor.KEY_CLIENT_ID, LABEL_CLIENT_ID, DESCRIPTION_CLIENT_ID).applyRequired(true);\n+        ConfigField clientSecret = new PasswordConfigField(AzureBoardsDescriptor.KEY_CLIENT_SECRET, LABEL_CLIENT_SECRET, DESCRIPTION_CLIENT_SECRET, encryptionValidator).applyRequired(true);\n         ConfigField configureOAuth = new OAuthEndpointButtonField(AzureBoardsDescriptor.KEY_OAUTH, LABEL_OAUTH, DESCRIPTION_OAUTH, BUTTON_LABEL_OAUTH)\n                                          .applyRequestedDataFieldKey(AzureBoardsDescriptor.KEY_ORGANIZATION_NAME)\n                                          .applyRequestedDataFieldKey(AzureBoardsDescriptor.KEY_CLIENT_ID);\n         // TODO requiredRelatedFields aren't validated when pushing endpoint button fields.\n         //.applyRequiredRelatedField(AzureBoardsDescriptor.KEY_CLIENT_ID);", "originalCommit": "a1ed88b2b7feccc9f8756979e959d9f15011fd41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyODgyMQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117#discussion_r472428821", "bodyText": "This is currently a problem with the custom endpoint fields. I will create a ticket for it to be addressed in a future release and remove the comment.", "author": "psantos1113", "createdAt": "2020-08-18T19:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NTkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5Njg3Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117#discussion_r472396872", "bodyText": "I think this probably belongs in the library.", "author": "gkillough", "createdAt": "2020-08-18T18:26:28Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureAuthorizationCodeFlow.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/**\n+ * blackduck-alert\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.channel.azure.boards.oauth;", "originalCommit": "a1ed88b2b7feccc9f8756979e959d9f15011fd41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5Nzc2OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117#discussion_r472397768", "bodyText": "We weren't checking if the database defined the field as sensitive we were trusting what was being passed into update.  In the OAuth case the credentials store would create the ConfigurationFieldModels with the create method and the sensitive field would not be set for fields that were sensitive in the database.  Here we look up what the database has defined in order to do the right thing.", "author": "psantos1113", "createdAt": "2020-08-18T18:28:12Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultConfigurationAccessor.java", "diffHunk": "@@ -331,9 +331,11 @@ public ConfigurationModel updateConfiguration(Long descriptorConfigId, Collectio\n         if (configuredFields != null && !configuredFields.isEmpty()) {\n             List<FieldValueEntity> fieldValuesToSave = new ArrayList<>(configuredFields.size());\n             for (ConfigurationFieldModel configFieldModel : configuredFields) {\n-                Long fieldId = getFieldIdOrThrowException(configFieldModel.getFieldKey());\n+                String fieldKey = configFieldModel.getFieldKey();\n+                Long fieldId = getFieldIdOrThrowException(fieldKey);\n+                boolean isSensitive = isFieldSensitive(fieldKey);", "originalCommit": "a1ed88b2b7feccc9f8756979e959d9f15011fd41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "507a93e02eed22b6f04024eba0c4046f7474a6fe", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/507a93e02eed22b6f04024eba0c4046f7474a6fe", "message": "chore: Remove todo comment.", "committedDate": "2020-08-18T18:30:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwNTg1OQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117#discussion_r472405859", "bodyText": "Why not URI Encode the resulting string? That way we don't have the \"%20\" and other encoding in the mix.", "author": "gkillough", "createdAt": "2020-08-18T18:43:55Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/web/AzureBoardsCustomEndpoint.java", "diffHunk": "@@ -106,28 +117,36 @@ private FieldAccessor createFieldAccessor(FieldModel fieldModel) {\n                     .ifPresent(fields::putAll);\n             }\n         } catch (AlertDatabaseConstraintException ex) {\n-            logger.error(\"Error creating field acessor for Azure authentication\", ex);\n+            logger.error(\"Error creating field accessor for Azure authentication\", ex);\n         }\n         return new FieldAccessor(fields);\n     }\n \n-    private String createAuthURL(String clientId, String alertServerUrl) {\n+    private boolean isAuthenticated(FieldAccessor fieldAccessor) {\n+        AzureBoardsProperties properties = AzureBoardsProperties.fromFieldAccessor(azureBoardsCredentialDataStoreFactory, azureRedirectUtil.createOAuthRedirectUri(), fieldAccessor);\n+        Proxy proxy = proxyManager.createProxy();\n+        return properties.hasOAuthCredentials(proxy);\n+    }\n+\n+    private String createAuthURL(String clientId) {\n         StringBuilder authUrlBuilder = new StringBuilder(300);\n         authUrlBuilder.append(AzureHttpServiceFactory.DEFAULT_AUTHORIZATION_URL);\n-        authUrlBuilder.append(createQueryString(clientId, alertServerUrl));\n+        authUrlBuilder.append(createQueryString(clientId));\n         return authUrlBuilder.toString();\n     }\n \n-    private String createQueryString(String clientId, String alertServerUrl) {\n-        String authorizationUrl = String.format(\"%s%s\", alertServerUrl, AzureOauthCallbackController.AZURE_OAUTH_CALLBACK_PATH);\n+    private String createQueryString(String clientId) {\n+        String authorizationUrl = azureRedirectUtil.createOAuthRedirectUri();\n         StringBuilder queryBuilder = new StringBuilder(250);\n         queryBuilder.append(\"&client_id=\");\n         queryBuilder.append(clientId);\n         //TODO have an object that stores the request keys and purges them after some amount of time.\n-        //TODO also store a redirect URL if possible\n         queryBuilder.append(\"&state=\");\n         queryBuilder.append(createRequestKey());\n-        queryBuilder.append(\"&scope=vso.work%20vso.code_write\");\n+        queryBuilder.append(\"&scope=\");\n+        queryBuilder.append(AzureOAuthScopes.PROJECTS_READ.getScope());\n+        queryBuilder.append(\"%20\");\n+        queryBuilder.append(AzureOAuthScopes.WORK_FULL.getScope());\n         queryBuilder.append(\"&redirect_uri=\");\n         queryBuilder.append(URLEncoder.encode(authorizationUrl, StandardCharsets.UTF_8));", "originalCommit": "507a93e02eed22b6f04024eba0c4046f7474a6fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwNjUzOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117#discussion_r472406538", "bodyText": "The \"a\" in \"OAuth\" is not capitalized in the class name.", "author": "gkillough", "createdAt": "2020-08-18T18:45:05Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/web/AzureOauthCallbackController.java", "diffHunk": "@@ -62,46 +71,90 @@\n     private final AzureBoardsCredentialDataStoreFactory azureBoardsCredentialDataStoreFactory;\n     private final ProxyManager proxyManager;\n     private final ConfigurationAccessor configurationAccessor;\n-    private final ConfigurationFieldModelConverter configFieldModelConverter;\n+    private final AzureRedirectUtil azureRedirectUtil;\n \n     @Autowired\n     public AzureOauthCallbackController(ResponseFactory responseFactory, Gson gson, AzureBoardsChannelKey azureBoardsChannelKey,", "originalCommit": "507a93e02eed22b6f04024eba0c4046f7474a6fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzMjgxNQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1117#discussion_r472432815", "bodyText": "I have renamed the class and pushed it up with the 'a' capitalized for OAuth.  This PR isn't reflecting that change when I see the files in the browser.", "author": "psantos1113", "createdAt": "2020-08-18T19:33:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwNjUzOA=="}], "type": "inlineReview"}, {"oid": "70e5c6d65dd232e2efece3c810682e37069df263", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/70e5c6d65dd232e2efece3c810682e37069df263", "message": "refactor: Implement PR feedback.", "committedDate": "2020-08-18T19:17:41Z", "type": "commit"}, {"oid": "287e2814b99c60f753e3178e3b2885077db86e89", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/287e2814b99c60f753e3178e3b2885077db86e89", "message": "refactor: encode the scopes using the URL Encoder.", "committedDate": "2020-08-18T19:46:31Z", "type": "commit"}]}