{"pr_number": 1251, "pr_title": "BlackDuck Project-User Sync", "pr_createdAt": "2020-11-10T20:06:28Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251", "timeline": [{"oid": "077319e59c258d81d53c9890e3acab000b46914a", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/077319e59c258d81d53c9890e3acab000b46914a", "message": "Feat(BlackDuck): Create new distribution API action for after save/update", "committedDate": "2020-11-10T16:11:39Z", "type": "commit"}, {"oid": "0ac605891a29f220e3e41e7fb804da0074de0eed", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/0ac605891a29f220e3e41e7fb804da0074de0eed", "message": "Feat(BlackDuck): Begin implementing threaded user-sync task", "committedDate": "2020-11-10T17:30:31Z", "type": "commit"}, {"oid": "1bfa95ea786806ac3bf382095912cf909e18bf23", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1bfa95ea786806ac3bf382095912cf909e18bf23", "message": "Feat(BlackDuck): Create separate class for project-user sync runnable", "committedDate": "2020-11-10T18:57:13Z", "type": "commit"}, {"oid": "c5f0593a6e6e3e06cae115823bd558962a96cca1", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/c5f0593a6e6e3e06cae115823bd558962a96cca1", "message": "Chore: Add license headers to new files", "committedDate": "2020-11-10T19:00:46Z", "type": "commit"}, {"oid": "436270ef4a5494ce8c2981b0af915f4ae7e901d1", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/436270ef4a5494ce8c2981b0af915f4ae7e901d1", "message": "Temp(BlackDuck): Make GET BlackDuck projects endpoint return data on-demand", "committedDate": "2020-11-10T19:53:37Z", "type": "commit"}, {"oid": "cf32fa14c076c7eddad1bda241c503e299cceeb9", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/cf32fa14c076c7eddad1bda241c503e299cceeb9", "message": "Fix(BlackDuck): Remove project-user sync from BlackDuckDataSyncTask", "committedDate": "2020-11-10T20:00:18Z", "type": "commit"}, {"oid": "9b0bad1e79a1c20a7397d5a9f25d2c96e8fc5d57", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/9b0bad1e79a1c20a7397d5a9f25d2c96e8fc5d57", "message": "Fix(BlackDuck): Check if there are any configured projects for a Job before querying the DB unnecessarily", "committedDate": "2020-11-10T20:11:56Z", "type": "commit"}, {"oid": "35d14d1fdeaddd4aa44b03392d836fbcc2f79cad", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/35d14d1fdeaddd4aa44b03392d836fbcc2f79cad", "message": "Feat(BlackDuck): Remove unused method and related functionality from old data sync task", "committedDate": "2020-11-10T20:14:40Z", "type": "commit"}, {"oid": "6ddd9b9a5aed2206a50dedb9a45f22800cecc5d7", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/6ddd9b9a5aed2206a50dedb9a45f22800cecc5d7", "message": "Merge branch 'master' into gk_blackduck_user_add", "committedDate": "2020-11-10T20:15:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MjgxNA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r520852814", "bodyText": "@ekerwin Any current BlackDuck API solution for this?", "author": "gkillough", "createdAt": "2020-11-10T20:26:24Z", "path": "provider/src/main/java/com/synopsys/integration/alert/provider/blackduck/action/task/BlackDuckProjectSyncRunnable.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/**\n+ * provider\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.provider.blackduck.action.task;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProperties;\n+import com.synopsys.integration.blackduck.api.generated.discovery.ApiDiscovery;\n+import com.synopsys.integration.blackduck.api.generated.view.ProjectView;\n+import com.synopsys.integration.blackduck.api.generated.view.UserView;\n+import com.synopsys.integration.blackduck.http.client.BlackDuckHttpClient;\n+import com.synopsys.integration.blackduck.service.BlackDuckService;\n+import com.synopsys.integration.blackduck.service.BlackDuckServicesFactory;\n+import com.synopsys.integration.blackduck.service.dataservice.ProjectService;\n+import com.synopsys.integration.blackduck.service.dataservice.ProjectUsersService;\n+import com.synopsys.integration.exception.IntegrationException;\n+import com.synopsys.integration.log.Slf4jIntLogger;\n+\n+public class BlackDuckProjectSyncRunnable implements Runnable {\n+    private final Logger logger = LoggerFactory.getLogger(getClass());\n+    private final BlackDuckProperties blackDuckProperties;\n+    private final Collection<String> blackDuckProjectNames;\n+\n+    public BlackDuckProjectSyncRunnable(BlackDuckProperties blackDuckProperties, Collection<String> blackDuckProjectNames) {\n+        this.blackDuckProperties = blackDuckProperties;\n+        this.blackDuckProjectNames = blackDuckProjectNames;\n+    }\n+\n+    @Override\n+    public void run() {\n+        try {\n+            Slf4jIntLogger intLogger = new Slf4jIntLogger(logger);\n+            BlackDuckHttpClient blackDuckHttpClient = blackDuckProperties.createBlackDuckHttpClient(intLogger);\n+            BlackDuckServicesFactory blackDuckServicesFactory = blackDuckProperties.createBlackDuckServicesFactory(blackDuckHttpClient, intLogger);\n+\n+            BlackDuckService blackDuckService = blackDuckServicesFactory.getBlackDuckService();\n+            ProjectService projectService = blackDuckServicesFactory.createProjectService();\n+            ProjectUsersService projectUsersService = blackDuckServicesFactory.createProjectUsersService();\n+\n+            UserView currentUser = blackDuckService.getResponse(ApiDiscovery.CURRENT_USER_LINK_RESPONSE);\n+            List<ProjectView> projectViews = requestAllProjectsByName(projectService, blackDuckProjectNames);\n+            updateBlackDuckProjectPermissions(projectUsersService, currentUser, projectViews);\n+        } catch (Exception e) {\n+            logger.warn(\"{} failed: {}\", getClass().getSimpleName(), e.getMessage());\n+        }\n+    }\n+\n+    // FIXME improve performance of this call\n+    private List<ProjectView> requestAllProjectsByName(ProjectService projectService, Collection<String> projectNames) throws IntegrationException {\n+        return projectService.getAllProjects()\n+                   .stream()\n+                   .filter(projectView -> projectNames.contains(projectView.getName()))\n+                   .collect(Collectors.toList());\n+    }", "originalCommit": "6ddd9b9a5aed2206a50dedb9a45f22800cecc5d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1NTUyNA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r520855524", "bodyText": "This class name is a little confusing to me. Would it be better to call this AddUserToProject?  We know it is for Black Duck based on the package and Im not sure the suffix Runnable provides much value.", "author": "jamesrichard91", "createdAt": "2020-11-10T20:31:30Z", "path": "provider/src/main/java/com/synopsys/integration/alert/provider/blackduck/action/task/BlackDuckProjectSyncRunnable.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/**\n+ * provider\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.provider.blackduck.action.task;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProperties;\n+import com.synopsys.integration.blackduck.api.generated.discovery.ApiDiscovery;\n+import com.synopsys.integration.blackduck.api.generated.view.ProjectView;\n+import com.synopsys.integration.blackduck.api.generated.view.UserView;\n+import com.synopsys.integration.blackduck.http.client.BlackDuckHttpClient;\n+import com.synopsys.integration.blackduck.service.BlackDuckService;\n+import com.synopsys.integration.blackduck.service.BlackDuckServicesFactory;\n+import com.synopsys.integration.blackduck.service.dataservice.ProjectService;\n+import com.synopsys.integration.blackduck.service.dataservice.ProjectUsersService;\n+import com.synopsys.integration.exception.IntegrationException;\n+import com.synopsys.integration.log.Slf4jIntLogger;\n+\n+public class BlackDuckProjectSyncRunnable implements Runnable {", "originalCommit": "6ddd9b9a5aed2206a50dedb9a45f22800cecc5d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1NjExNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r520856117", "bodyText": "I think we can update blackduck-common and pass in a predicate to filter the projects by name. We should look for other places in Alert (if any) that we do this and update it there as well.", "author": "jamesrichard91", "createdAt": "2020-11-10T20:32:44Z", "path": "provider/src/main/java/com/synopsys/integration/alert/provider/blackduck/action/task/BlackDuckProjectSyncRunnable.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/**\n+ * provider\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.provider.blackduck.action.task;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProperties;\n+import com.synopsys.integration.blackduck.api.generated.discovery.ApiDiscovery;\n+import com.synopsys.integration.blackduck.api.generated.view.ProjectView;\n+import com.synopsys.integration.blackduck.api.generated.view.UserView;\n+import com.synopsys.integration.blackduck.http.client.BlackDuckHttpClient;\n+import com.synopsys.integration.blackduck.service.BlackDuckService;\n+import com.synopsys.integration.blackduck.service.BlackDuckServicesFactory;\n+import com.synopsys.integration.blackduck.service.dataservice.ProjectService;\n+import com.synopsys.integration.blackduck.service.dataservice.ProjectUsersService;\n+import com.synopsys.integration.exception.IntegrationException;\n+import com.synopsys.integration.log.Slf4jIntLogger;\n+\n+public class BlackDuckProjectSyncRunnable implements Runnable {\n+    private final Logger logger = LoggerFactory.getLogger(getClass());\n+    private final BlackDuckProperties blackDuckProperties;\n+    private final Collection<String> blackDuckProjectNames;\n+\n+    public BlackDuckProjectSyncRunnable(BlackDuckProperties blackDuckProperties, Collection<String> blackDuckProjectNames) {\n+        this.blackDuckProperties = blackDuckProperties;\n+        this.blackDuckProjectNames = blackDuckProjectNames;\n+    }\n+\n+    @Override\n+    public void run() {\n+        try {\n+            Slf4jIntLogger intLogger = new Slf4jIntLogger(logger);\n+            BlackDuckHttpClient blackDuckHttpClient = blackDuckProperties.createBlackDuckHttpClient(intLogger);\n+            BlackDuckServicesFactory blackDuckServicesFactory = blackDuckProperties.createBlackDuckServicesFactory(blackDuckHttpClient, intLogger);\n+\n+            BlackDuckService blackDuckService = blackDuckServicesFactory.getBlackDuckService();\n+            ProjectService projectService = blackDuckServicesFactory.createProjectService();\n+            ProjectUsersService projectUsersService = blackDuckServicesFactory.createProjectUsersService();\n+\n+            UserView currentUser = blackDuckService.getResponse(ApiDiscovery.CURRENT_USER_LINK_RESPONSE);\n+            List<ProjectView> projectViews = requestAllProjectsByName(projectService, blackDuckProjectNames);\n+            updateBlackDuckProjectPermissions(projectUsersService, currentUser, projectViews);\n+        } catch (Exception e) {\n+            logger.warn(\"{} failed: {}\", getClass().getSimpleName(), e.getMessage());\n+        }\n+    }\n+\n+    // FIXME improve performance of this call\n+    private List<ProjectView> requestAllProjectsByName(ProjectService projectService, Collection<String> projectNames) throws IntegrationException {\n+        return projectService.getAllProjects()", "originalCommit": "6ddd9b9a5aed2206a50dedb9a45f22800cecc5d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NDk1Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r520864956", "bodyText": "Any concern that we will cancel running tasks? What happens if someone uses a script to create 1000+ jobs at once. This would be churning a lot. What is the argument against just queuing them up?", "author": "jamesrichard91", "createdAt": "2020-11-10T20:49:31Z", "path": "provider/src/main/java/com/synopsys/integration/alert/provider/blackduck/action/task/BlackDuckProjectUserSyncTaskManager.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * provider\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.provider.blackduck.action.task;\n+\n+import java.util.Collection;\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProperties;\n+\n+@Component\n+public class BlackDuckProjectUserSyncTaskManager {\n+    public static final int MAX_TASKS = 10;\n+\n+    private final ExecutorService executorService;\n+    private final Queue<Future<?>> syncTasks;\n+    private final AtomicInteger taskCount;\n+\n+    public BlackDuckProjectUserSyncTaskManager() {\n+        this.executorService = Executors.newCachedThreadPool();\n+        this.syncTasks = new ConcurrentLinkedQueue<>();\n+        this.taskCount = new AtomicInteger(0);\n+    }\n+\n+    public void addAlertGlobalBlackDuckUserToProjects(BlackDuckProperties blackDuckProperties, Collection<String> blackDuckProjectNames) {\n+        if (blackDuckProjectNames.isEmpty()) {\n+            return;\n+        }\n+\n+        Runnable syncTask = new BlackDuckProjectSyncRunnable(blackDuckProperties, blackDuckProjectNames);\n+        Future<?> syncTaskFuture = executorService.submit(syncTask);\n+        scheduleNewSyncTask(syncTaskFuture);\n+    }\n+\n+    public void removeCompletedTasks() {\n+        while (!syncTasks.isEmpty() && syncTasks.peek().isDone()) {\n+            syncTasks.remove();\n+            taskCount.decrementAndGet();\n+        }\n+    }\n+\n+    private void scheduleNewSyncTask(Future<?> syncTaskFuture) {\n+        if (taskCount.get() >= MAX_TASKS) {\n+            Future<?> oldestTask = syncTasks.poll();\n+            if (null != oldestTask) {\n+                oldestTask.cancel(true);", "originalCommit": "6ddd9b9a5aed2206a50dedb9a45f22800cecc5d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MTY4NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r520871685", "bodyText": "This is designed to cancel running tasks. Queuing them up in memory indefinitely is less performant than the sync task we are trying to move away from with this code. The only difference is that we wouldn't be blocking.\nI think the goal of this feature is to be a nicety for customers who are not \"power users\" of BlackDuck by avoiding accidental notification issues. For customers that are \"power users\", they should already have BlackDuck configured correctly.", "author": "gkillough", "createdAt": "2020-11-10T21:02:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NDk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MTM2Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r520871366", "bodyText": "The same functionality is in BlackDuckProviderDataAccessor, you might want to use that rather than implementing the same logic again here.", "author": "jamesrichard91", "createdAt": "2020-11-10T21:01:37Z", "path": "provider/src/main/java/com/synopsys/integration/alert/provider/blackduck/web/project/ProjectFilterCustomFunctionAction.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/**\n+ * provider\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.provider.blackduck.web.project;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.server.ResponseStatusException;\n+\n+import com.synopsys.integration.alert.common.action.ActionResponse;\n+import com.synopsys.integration.alert.common.action.CustomFunctionAction;\n+import com.synopsys.integration.alert.common.descriptor.DescriptorMap;\n+import com.synopsys.integration.alert.common.descriptor.ProviderDescriptor;\n+import com.synopsys.integration.alert.common.descriptor.config.field.validation.FieldValidationUtility;\n+import com.synopsys.integration.alert.common.descriptor.config.ui.ChannelDistributionUIConfig;\n+import com.synopsys.integration.alert.common.descriptor.config.ui.ProviderDistributionUIConfig;\n+import com.synopsys.integration.alert.common.persistence.accessor.ConfigurationAccessor;\n+import com.synopsys.integration.alert.common.persistence.model.ConfigurationModel;\n+import com.synopsys.integration.alert.common.provider.state.StatefulProvider;\n+import com.synopsys.integration.alert.common.rest.HttpServletContentWrapper;\n+import com.synopsys.integration.alert.common.rest.model.FieldModel;\n+import com.synopsys.integration.alert.common.security.authorization.AuthorizationManager;\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProperties;\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProvider;\n+import com.synopsys.integration.blackduck.http.client.BlackDuckHttpClient;\n+import com.synopsys.integration.blackduck.service.BlackDuckServicesFactory;\n+import com.synopsys.integration.blackduck.service.dataservice.ProjectService;\n+import com.synopsys.integration.log.Slf4jIntLogger;\n+\n+@Component\n+public class ProjectFilterCustomFunctionAction extends CustomFunctionAction<BlackDuckProjectOptions> {\n+    private static final String MISSING_PROVIDER_ERROR = \"Provider name is required to retrieve projects.\";\n+    private static final ActionResponse<BlackDuckProjectOptions> NO_PROJECT_OPTIONS = new ActionResponse<>(HttpStatus.OK, new BlackDuckProjectOptions(List.of()));\n+\n+    private final Logger logger = LoggerFactory.getLogger(getClass());\n+    private final ConfigurationAccessor configurationAccessor;\n+    private final BlackDuckProvider blackDuckProvider;\n+\n+    @Autowired\n+    public ProjectFilterCustomFunctionAction(AuthorizationManager authorizationManager, DescriptorMap descriptorMap, FieldValidationUtility fieldValidationUtility,\n+        ConfigurationAccessor configurationAccessor, BlackDuckProvider blackDuckProvider) {\n+        super(ProviderDistributionUIConfig.KEY_CONFIGURED_PROJECT, authorizationManager, descriptorMap, fieldValidationUtility);\n+        this.configurationAccessor = configurationAccessor;\n+        this.blackDuckProvider = blackDuckProvider;\n+    }\n+\n+    @Override\n+    public ActionResponse<BlackDuckProjectOptions> createActionResponse(FieldModel fieldModel, HttpServletContentWrapper servletContentWrapper) {\n+        String providerName = fieldModel.getFieldValue(ChannelDistributionUIConfig.KEY_PROVIDER_NAME).orElse(\"\");\n+        if (StringUtils.isBlank(providerName)) {\n+            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, MISSING_PROVIDER_ERROR);\n+        }\n+\n+        return fieldModel.getFieldValue(ProviderDescriptor.KEY_PROVIDER_CONFIG_ID)\n+                   .map(Long::parseLong)\n+                   .map(this::getBlackDuckProjectsActionResponse)\n+                   .orElse(NO_PROJECT_OPTIONS);\n+    }\n+\n+    private ActionResponse<BlackDuckProjectOptions> getBlackDuckProjectsActionResponse(Long blackDuckGlobalConfigId) {\n+        try {\n+            Optional<ConfigurationModel> optionalBlackDuckGlobalConfig = configurationAccessor.getConfigurationById(blackDuckGlobalConfigId);", "originalCommit": "6ddd9b9a5aed2206a50dedb9a45f22800cecc5d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3ODU5Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r520878596", "bodyText": "Won't we know the type of generic being passed here?", "author": "bamandel", "createdAt": "2020-11-10T21:16:15Z", "path": "provider/src/main/java/com/synopsys/integration/alert/provider/blackduck/action/task/BlackDuckProjectUserSyncTaskManager.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * provider\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.provider.blackduck.action.task;\n+\n+import java.util.Collection;\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProperties;\n+\n+@Component\n+public class BlackDuckProjectUserSyncTaskManager {\n+    public static final int MAX_TASKS = 10;\n+\n+    private final ExecutorService executorService;\n+    private final Queue<Future<?>> syncTasks;\n+    private final AtomicInteger taskCount;\n+\n+    public BlackDuckProjectUserSyncTaskManager() {\n+        this.executorService = Executors.newCachedThreadPool();\n+        this.syncTasks = new ConcurrentLinkedQueue<>();\n+        this.taskCount = new AtomicInteger(0);\n+    }\n+\n+    public void addAlertGlobalBlackDuckUserToProjects(BlackDuckProperties blackDuckProperties, Collection<String> blackDuckProjectNames) {\n+        if (blackDuckProjectNames.isEmpty()) {\n+            return;\n+        }\n+\n+        Runnable syncTask = new BlackDuckProjectSyncRunnable(blackDuckProperties, blackDuckProjectNames);\n+        Future<?> syncTaskFuture = executorService.submit(syncTask);", "originalCommit": "9b0bad1e79a1c20a7397d5a9f25d2c96e8fc5d57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MDc2OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r520880768", "bodyText": "The generic represents the return-type. When a Callable is submitted, we know what it is, but when a Runnable is submitted, syncTaskFuture.get(...) will always return null.", "author": "gkillough", "createdAt": "2020-11-10T21:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3ODU5Ng=="}], "type": "inlineReview"}, {"oid": "3023efd0dd12133e4731583ae8a9910ac8339ac9", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3023efd0dd12133e4731583ae8a9910ac8339ac9", "message": "Fix(Provider): Revert move of provider project custom function logic from web to provider sub-project", "committedDate": "2020-11-10T21:23:05Z", "type": "commit"}, {"oid": "3023efd0dd12133e4731583ae8a9910ac8339ac9", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3023efd0dd12133e4731583ae8a9910ac8339ac9", "message": "Fix(Provider): Revert move of provider project custom function logic from web to provider sub-project", "committedDate": "2020-11-10T21:23:05Z", "type": "forcePushed"}, {"oid": "27b1c02c993b98df4236c934a0c59a83365ef956", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/27b1c02c993b98df4236c934a0c59a83365ef956", "message": "Refactor(BlackDuck): Rename project-user sync runnable class", "committedDate": "2020-11-10T21:24:34Z", "type": "commit"}, {"oid": "2b841139238071ede768b8644e30f715ee3510e3", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/2b841139238071ede768b8644e30f715ee3510e3", "message": "Fix(BlackDuck): Determine max number of project-user sync tasks programmatically", "committedDate": "2020-11-11T15:26:30Z", "type": "commit"}, {"oid": "c9179b39449c1d7eaa3ca744ff5ce206e3474b9c", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/c9179b39449c1d7eaa3ca744ff5ce206e3474b9c", "message": "Feat(BlackDuck): Remove asynchronous implementation of project-user adding (for now)", "committedDate": "2020-11-11T16:46:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ5OTEyNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r521499127", "bodyText": "Is this used anywhere? Are we keeping this around for something?", "author": "jamesrichard91", "createdAt": "2020-11-11T16:55:48Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/thread/SizeConstrainedRunnableQueueManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * alert-common\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.common.thread;\n+\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+public abstract class SizeConstrainedRunnableQueueManager<R extends Runnable> {", "originalCommit": "c9179b39449c1d7eaa3ca744ff5ce206e3474b9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ5OTgyNA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1251#discussion_r521499824", "bodyText": "Need to update the variable name", "author": "jamesrichard91", "createdAt": "2020-11-11T16:56:53Z", "path": "provider/src/main/java/com/synopsys/integration/alert/provider/blackduck/action/BlackDuckDistributionApiAction.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/**\n+ * provider\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.provider.blackduck.action;\n+\n+import java.util.Collection;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.common.action.ApiAction;\n+import com.synopsys.integration.alert.common.descriptor.ProviderDescriptor;\n+import com.synopsys.integration.alert.common.descriptor.config.ui.ProviderDistributionUIConfig;\n+import com.synopsys.integration.alert.common.exception.AlertException;\n+import com.synopsys.integration.alert.common.persistence.accessor.ConfigurationAccessor;\n+import com.synopsys.integration.alert.common.persistence.model.ConfigurationModel;\n+import com.synopsys.integration.alert.common.provider.state.StatefulProvider;\n+import com.synopsys.integration.alert.common.rest.model.FieldModel;\n+import com.synopsys.integration.alert.common.rest.model.FieldValueModel;\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProperties;\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProvider;\n+import com.synopsys.integration.alert.provider.blackduck.action.task.AddUserToProjectsRunnable;\n+\n+@Component\n+public class BlackDuckDistributionApiAction extends ApiAction {\n+    private final ConfigurationAccessor configurationAccessor;\n+    private final BlackDuckProvider blackDuckProvider;\n+\n+    @Autowired\n+    public BlackDuckDistributionApiAction(ConfigurationAccessor configurationAccessor, BlackDuckProvider blackDuckProvider) {\n+        this.configurationAccessor = configurationAccessor;\n+        this.blackDuckProvider = blackDuckProvider;\n+    }\n+\n+    @Override\n+    public FieldModel afterSaveAction(FieldModel fieldModel) throws AlertException {\n+        afterWrite(fieldModel);\n+        return super.afterSaveAction(fieldModel);\n+    }\n+\n+    @Override\n+    public FieldModel afterUpdateAction(FieldModel previousFieldModel, FieldModel currentFieldModel) throws AlertException {\n+        afterWrite(currentFieldModel);\n+        return super.afterUpdateAction(previousFieldModel, currentFieldModel);\n+    }\n+\n+    private void afterWrite(FieldModel currentFieldModel) throws AlertException {\n+        Optional<Long> optionalProviderConfigId = currentFieldModel.getFieldValue(ProviderDescriptor.KEY_PROVIDER_CONFIG_ID).map(Long::valueOf);\n+        Collection<String> configuredProjects = extractConfiguredProjects(currentFieldModel);\n+        if (optionalProviderConfigId.isPresent() && !configuredProjects.isEmpty()) {\n+            Optional<ConfigurationModel> optionalBlackDuckGlobalConfig = configurationAccessor.getConfigurationById(optionalProviderConfigId.get());\n+            if (optionalBlackDuckGlobalConfig.isPresent()) {\n+                StatefulProvider statefulProvider = blackDuckProvider.createStatefulProvider(optionalBlackDuckGlobalConfig.get());\n+\n+                AddUserToProjectsRunnable projectUserSync = new AddUserToProjectsRunnable((BlackDuckProperties) statefulProvider.getProperties(), configuredProjects);", "originalCommit": "c9179b39449c1d7eaa3ca744ff5ce206e3474b9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3ae46a69944055d9dc2b6fe38a3d9834c1fc590e", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3ae46a69944055d9dc2b6fe38a3d9834c1fc590e", "message": "Fix(BlackDuck): Change variable name based on overloaded project terminology", "committedDate": "2020-11-11T17:13:37Z", "type": "commit"}, {"oid": "f01057c337448a72d87431cbdd6f8460be1d4015", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/f01057c337448a72d87431cbdd6f8460be1d4015", "message": "Fix(Thread): Delete utility for managing queued runnables", "committedDate": "2020-11-11T18:19:12Z", "type": "commit"}, {"oid": "82d943399741c83e6fb00e097729f20157c76d55", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/82d943399741c83e6fb00e097729f20157c76d55", "message": "Merge branch 'master' into gk_blackduck_user_add", "committedDate": "2020-11-11T18:19:32Z", "type": "commit"}]}