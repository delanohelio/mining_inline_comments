{"pr_number": 924, "pr_title": "purge fix", "pr_createdAt": "2020-03-19T20:11:54Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/924", "timeline": [{"oid": "b78b80d80fd6c9750a490e96bcf2a9756da77693", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/b78b80d80fd6c9750a490e96bcf2a9756da77693", "message": "fix: Delete audit entries by notification id and log errors.", "committedDate": "2020-03-19T19:25:59Z", "type": "commit"}, {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9", "message": "Merge remote-tracking branch 'origin/5.0.3' into ps_purge_fix", "committedDate": "2020-03-19T19:28:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5MzAyMQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395293021", "bodyText": "Here's where the change really is.  try catch block for the old code that was failing.  Attempt to delete from the audit relation by notification id.  Otherwise if it fails log it and move on to deleting the notifications.", "author": "psantos1113", "createdAt": "2020-03-19T20:13:27Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {", "originalCommit": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3OTU2Nw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395679567", "bodyText": "Does this have to do with foreign keys?", "author": "gkillough", "createdAt": "2020-03-20T14:37:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5MzAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcxOTk3Nw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395719977", "bodyText": "Yes I believe it has to do with the foreign key constraints between the audit_notification_relation, audit_entry, and raw_notification_content tables.  Currently the customer is in a state\nI can't produce the problem in 5.1.0 and 5.3.0. Because the database is in this odd state in 5.0.0 this change will be able to allow notifications to be purged to clean up the database. Alert may have been missing some delete on cascade constraints.", "author": "psantos1113", "createdAt": "2020-03-20T15:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5MzAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDM5NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395680395", "bodyText": "Why bother saving this as a variable? A method reference itself is stateless, so I don't think there is a benefit.", "author": "gkillough", "createdAt": "2020-03-20T14:39:07Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {\n+            foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n+            Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;", "originalCommit": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyMDQ5MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395720490", "bodyText": "I think I had a different solution in mind when I first wrote the change.  I will look to clean up.", "author": "psantos1113", "createdAt": "2020-03-20T15:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDc1Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395680753", "bodyText": "Each method that returns a Stream should be on its own line.", "author": "gkillough", "createdAt": "2020-03-20T14:39:41Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {\n+            foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n+            Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n+            List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());", "originalCommit": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "874f88401feb1d987cf091fd5647bbbea7bd7429", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/874f88401feb1d987cf091fd5647bbbea7bd7429", "message": "refactor: Clean up based on PR feedback.", "committedDate": "2020-03-20T18:23:04Z", "type": "commit"}]}