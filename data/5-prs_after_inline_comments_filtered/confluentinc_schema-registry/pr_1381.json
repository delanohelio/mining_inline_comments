{"pr_number": 1381, "pr_title": "CC-7027: Revert to legacy serialization of Decimal logical type on incompatible scale/precision", "pr_createdAt": "2020-03-10T00:35:27Z", "pr_url": "https://github.com/confluentinc/schema-registry/pull/1381", "timeline": [{"oid": "d95c8b08bdbec5df1d03091c5374bd65e7ab6705", "url": "https://github.com/confluentinc/schema-registry/commit/d95c8b08bdbec5df1d03091c5374bd65e7ab6705", "message": "CC-7027: Revert to legacy serialization of Decimal logical type on incompatible scale/precision", "committedDate": "2020-03-10T00:25:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MTg4OQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r390541889", "bodyText": "Do we really want this as DEBUG?", "author": "rhauch", "createdAt": "2020-03-10T18:57:30Z", "path": "avro-converter/src/main/java/io/confluent/connect/avro/AvroData.java", "diffHunk": "@@ -935,7 +939,20 @@ private static Object maybeWrapSchemaless(Schema schema, Object value, String ty\n           int precision = precisionString == null ? CONNECT_AVRO_DECIMAL_PRECISION_DEFAULT :\n               Integer.parseInt(precisionString);\n           int scale = scaleString == null ? 0 : Integer.parseInt(scaleString);\n-          org.apache.avro.LogicalTypes.decimal(precision, scale).addToSchema(baseSchema);\n+          if (scale < 0 || scale > precision) {\n+            log.debug(\n+                \"Scale and precision of {} and {} cannot be serialized as native Avro logical \" \n+                    + \"decimal type; reverting to legacy serialization method\",\n+                scale,\n+                precision\n+            );", "originalCommit": "d95c8b08bdbec5df1d03091c5374bd65e7ab6705", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1Njg3Nw==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r390556877", "bodyText": "I'm afraid to put it much higher as this will be invoked potentially multiple times on every record and would result in log spam. Could put it at TRACE if you feel that DEBUG is too high, though.", "author": "C0urante", "createdAt": "2020-03-10T19:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MTg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5MzIzOA==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391193238", "bodyText": "I was thinking DEBUG is too high, considering this might be output for potentially every record (or at least a lot of records) from a source connector. Might be useful to have a DEBUG message that happens once per connector instance, but more than that seems too many.", "author": "rhauch", "createdAt": "2020-03-11T18:54:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MTg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIwODE1Mg==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391208152", "bodyText": "I can put it down to TRACE for now... I agree that it may be useful to add a once-per-connector (or, more accurately, once-per converter instance) message at DEBUG level but tracking that kind of state in this class would come with its own implementation complexity and complicate an already several-thousand-line-long file. I think that, given that all we're doing here is reverting to prior behavior in a case where things used to work and now break, it should be safe to put at TRACE for now.", "author": "C0urante", "createdAt": "2020-03-11T19:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MTg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MjM5Ng==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r390542396", "bodyText": "How about a comment here to describe why this scenario needs special logic and how that logic deviates from using LogicalTypes.decimal(precision, scale).addToSchema(...)?", "author": "rhauch", "createdAt": "2020-03-10T18:58:23Z", "path": "avro-converter/src/main/java/io/confluent/connect/avro/AvroData.java", "diffHunk": "@@ -935,7 +939,20 @@ private static Object maybeWrapSchemaless(Schema schema, Object value, String ty\n           int precision = precisionString == null ? CONNECT_AVRO_DECIMAL_PRECISION_DEFAULT :\n               Integer.parseInt(precisionString);\n           int scale = scaleString == null ? 0 : Integer.parseInt(scaleString);\n-          org.apache.avro.LogicalTypes.decimal(precision, scale).addToSchema(baseSchema);\n+          if (scale < 0 || scale > precision) {", "originalCommit": "d95c8b08bdbec5df1d03091c5374bd65e7ab6705", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU4MTAzOQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r390581039", "bodyText": "Ack, addressed", "author": "C0urante", "createdAt": "2020-03-10T20:09:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MjM5Ng=="}], "type": "inlineReview"}, {"oid": "dcdb9e75234e8491046ed1337c65872833f79999", "url": "https://github.com/confluentinc/schema-registry/commit/dcdb9e75234e8491046ed1337c65872833f79999", "message": "CC-7027: Add test, address review feedback", "committedDate": "2020-03-10T20:09:15Z", "type": "commit"}, {"oid": "dcdb9e75234e8491046ed1337c65872833f79999", "url": "https://github.com/confluentinc/schema-registry/commit/dcdb9e75234e8491046ed1337c65872833f79999", "message": "CC-7027: Add test, address review feedback", "committedDate": "2020-03-10T20:09:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5OTAxNA==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391199014", "bodyText": "Why would we not just add CONNECT_AVRO_DECIMAL_PRECISION_PROP as a property to the schema here? Then we wouldn't need the forceLegacyDecimal variable and would not need to modify line 963 (original). Or am I missing something?", "author": "rhauch", "createdAt": "2020-03-11T19:06:03Z", "path": "avro-converter/src/main/java/io/confluent/connect/avro/AvroData.java", "diffHunk": "@@ -935,7 +940,21 @@ private static Object maybeWrapSchemaless(Schema schema, Object value, String ty\n           int precision = precisionString == null ? CONNECT_AVRO_DECIMAL_PRECISION_DEFAULT :\n               Integer.parseInt(precisionString);\n           int scale = scaleString == null ? 0 : Integer.parseInt(scaleString);\n-          org.apache.avro.LogicalTypes.decimal(precision, scale).addToSchema(baseSchema);\n+          if (scale < 0 || scale > precision) {\n+            log.debug(\n+                \"Scale and precision of {} and {} cannot be serialized as native Avro logical \" \n+                    + \"decimal type; reverting to legacy serialization method\",\n+                scale,\n+                precision\n+            );\n+            // We cannot use the Avro Java library's support for the decimal logical type when the\n+            // scale is either negative or greater than the precision as this violates the Avro spec\n+            // and causes the Avro library to throw an exception, so we fall back in this case to\n+            // using the legacy method for encoding decimal logical type information.\n+            forceLegacyDecimal = true;", "originalCommit": "dcdb9e75234e8491046ed1337c65872833f79999", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIwMDMxMA==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391200310", "bodyText": "Ran into this after adding the test, turns out the schema parameters map is (at least in some cases) an unmodifiable collection.", "author": "C0urante", "createdAt": "2020-03-11T19:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5OTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIwMjUxMw==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391202513", "bodyText": "See https://github.com/apache/kafka/blob/71113b4aac43a3a6f13625e25171ef8f2233fe7d/connect/api/src/main/java/org/apache/kafka/connect/data/SchemaBuilder.java#L186-L189", "author": "C0urante", "createdAt": "2020-03-11T19:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5OTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxMDcyNQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391210725", "bodyText": "Seems worthy of adding to the comment. I'd lose a lot of time trying to track that down.", "author": "rhauch", "createdAt": "2020-03-11T19:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5OTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxMjE0MA==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391212140", "bodyText": "Ack, added", "author": "C0urante", "createdAt": "2020-03-11T19:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5OTAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5OTU4MQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391199581", "bodyText": "If we added CONNECT_AVRO_DECIMAL_PRECISION_PROP to the schema parameters in the block above, which only happens when Decimal.LOGICAL_NAME.equalsIgnoreCase(schema.name()), then we wouldn't need to modify this block.", "author": "rhauch", "createdAt": "2020-03-11T19:07:06Z", "path": "avro-converter/src/main/java/io/confluent/connect/avro/AvroData.java", "diffHunk": "@@ -960,7 +979,8 @@ private static Object maybeWrapSchemaless(Schema schema, Object value, String ty\n       // and name().\n       if (schema.name() != null) {\n         if (Decimal.LOGICAL_NAME.equalsIgnoreCase(schema.name())\n-            && schema.parameters().containsKey(CONNECT_AVRO_DECIMAL_PRECISION_PROP)) {\n+            && (schema.parameters().containsKey(CONNECT_AVRO_DECIMAL_PRECISION_PROP)\n+                || forceLegacyDecimal)) {", "originalCommit": "dcdb9e75234e8491046ed1337c65872833f79999", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIwMDYyMw==", "url": "https://github.com/confluentinc/schema-registry/pull/1381#discussion_r391200623", "bodyText": "Yeah, originally tried that. Failed during testing because schema.paramaters() returned an immutable map.", "author": "C0urante", "createdAt": "2020-03-11T19:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5OTU4MQ=="}], "type": "inlineReview"}, {"oid": "c076e1733ecff31ed478df46a742435a8a461311", "url": "https://github.com/confluentinc/schema-registry/commit/c076e1733ecff31ed478df46a742435a8a461311", "message": "CC-7027: Drop log message from DEBUG to TRACE", "committedDate": "2020-03-11T19:24:16Z", "type": "commit"}, {"oid": "e759b5313520540ac9d8f1fedea436dc21207838", "url": "https://github.com/confluentinc/schema-registry/commit/e759b5313520540ac9d8f1fedea436dc21207838", "message": "CC-7027: Add comment about immutability of Connect schema parameters", "committedDate": "2020-03-11T19:31:24Z", "type": "commit"}]}