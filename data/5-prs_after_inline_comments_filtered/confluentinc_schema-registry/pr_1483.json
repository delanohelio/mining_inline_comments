{"pr_number": 1483, "pr_title": "Telemetry reporter integration", "pr_createdAt": "2020-06-08T06:50:50Z", "pr_url": "https://github.com/confluentinc/schema-registry/pull/1483", "timeline": [{"oid": "29292f8a5cc4e2d620790ec17a9a69fd4df53d5b", "url": "https://github.com/confluentinc/schema-registry/commit/29292f8a5cc4e2d620790ec17a9a69fd4df53d5b", "message": "Telemetry reporter (#1454)\n\n* Add metricscontext. Depend on kafka-ce until KIP is merged.\r\n\r\n* Add namespace.\r\n\r\n* Move test from ce-kafka.\r\n\r\n* Clean up.\r\n\r\nCo-authored-by: Sumit Arrawatia <sumit.arrawatia@gmail.com>", "committedDate": "2020-05-15T04:49:30Z", "type": "commit"}, {"oid": "4084d59abe38ad605db77391e9d8380ffa122970", "url": "https://github.com/confluentinc/schema-registry/commit/4084d59abe38ad605db77391e9d8380ffa122970", "message": "Fix build", "committedDate": "2020-05-15T05:46:36Z", "type": "commit"}, {"oid": "072cfa79f7b6e264942d2bce8e9119e3d61f48b6", "url": "https://github.com/confluentinc/schema-registry/commit/072cfa79f7b6e264942d2bce8e9119e3d61f48b6", "message": "Merge branch 'master' into telemetry-reporter", "committedDate": "2020-05-18T23:54:33Z", "type": "commit"}, {"oid": "a6501a38195da8c1923aaea5d3efaca08e878f25", "url": "https://github.com/confluentinc/schema-registry/commit/a6501a38195da8c1923aaea5d3efaca08e878f25", "message": "Fix integration test", "committedDate": "2020-05-19T01:25:10Z", "type": "commit"}, {"oid": "8b8dddab273f904c44e9190fa277ee7e3f68ee13", "url": "https://github.com/confluentinc/schema-registry/commit/8b8dddab273f904c44e9190fa277ee7e3f68ee13", "message": "Merge branch 'master' into telemetry-reporter", "committedDate": "2020-05-21T00:11:16Z", "type": "commit"}, {"oid": "d2fd0837e0dcfc312e4148767af1453726b9a8bb", "url": "https://github.com/confluentinc/schema-registry/commit/d2fd0837e0dcfc312e4148767af1453726b9a8bb", "message": "Implement Schema Registry metrics", "committedDate": "2020-05-22T20:34:59Z", "type": "commit"}, {"oid": "2b71c7868aae5b9f69441a0891f124aae7c4130c", "url": "https://github.com/confluentinc/schema-registry/commit/2b71c7868aae5b9f69441a0891f124aae7c4130c", "message": "Merge branch 'master' into schema-registry-metrics", "committedDate": "2020-05-22T20:37:30Z", "type": "commit"}, {"oid": "6feb5af9758e4bf6b7ec264d169079f7d117ff4a", "url": "https://github.com/confluentinc/schema-registry/commit/6feb5af9758e4bf6b7ec264d169079f7d117ff4a", "message": "Use try-with-resources in getCommitId", "committedDate": "2020-05-22T23:13:32Z", "type": "commit"}, {"oid": "ed8b5691195cade94491bc1920c95632589fcb2e", "url": "https://github.com/confluentinc/schema-registry/commit/ed8b5691195cade94491bc1920c95632589fcb2e", "message": "Minor fix", "committedDate": "2020-05-23T00:18:20Z", "type": "commit"}, {"oid": "58b4e891c48d80d34726a1a8b2d968d92c15f882", "url": "https://github.com/confluentinc/schema-registry/commit/58b4e891c48d80d34726a1a8b2d968d92c15f882", "message": "Fix spotbugs errors", "committedDate": "2020-05-23T01:31:07Z", "type": "commit"}, {"oid": "4b857a6af0d2c2683987117d9df998df3f2e516e", "url": "https://github.com/confluentinc/schema-registry/commit/4b857a6af0d2c2683987117d9df998df3f2e516e", "message": "Merge branch 'master' into schema-registry-metrics", "committedDate": "2020-05-23T17:44:59Z", "type": "commit"}, {"oid": "363bf8dfbbc042d10155b9a9ba48b515eb1ed4b8", "url": "https://github.com/confluentinc/schema-registry/commit/363bf8dfbbc042d10155b9a9ba48b515eb1ed4b8", "message": "Merge branch 'schema-registry-metrics' into telemetry-reporter", "committedDate": "2020-05-25T05:37:41Z", "type": "commit"}, {"oid": "d415fcbc67acaa1f55374ad6d674e33b18331449", "url": "https://github.com/confluentinc/schema-registry/commit/d415fcbc67acaa1f55374ad6d674e33b18331449", "message": "Merge fix", "committedDate": "2020-05-25T07:10:09Z", "type": "commit"}, {"oid": "eb5a412302abe04ab05c237da9d82b5e0d410472", "url": "https://github.com/confluentinc/schema-registry/commit/eb5a412302abe04ab05c237da9d82b5e0d410472", "message": "Test fix", "committedDate": "2020-05-25T11:14:39Z", "type": "commit"}, {"oid": "626bd7117994f4728e46b00e6e8a0a873922550c", "url": "https://github.com/confluentinc/schema-registry/commit/626bd7117994f4728e46b00e6e8a0a873922550c", "message": "Checkstyle fixes", "committedDate": "2020-05-25T11:21:37Z", "type": "commit"}, {"oid": "8a07b790e19914b025ff8e23a16120439f389adc", "url": "https://github.com/confluentinc/schema-registry/commit/8a07b790e19914b025ff8e23a16120439f389adc", "message": "Test fix", "committedDate": "2020-05-25T11:52:20Z", "type": "commit"}, {"oid": "eb441c623e31c3ac1280db5844b2cdaa453ab583", "url": "https://github.com/confluentinc/schema-registry/commit/eb441c623e31c3ac1280db5844b2cdaa453ab583", "message": "Remove redundant configs", "committedDate": "2020-05-26T23:09:02Z", "type": "commit"}, {"oid": "8b619b03ce80ddf0436b4da7030a41036cc83334", "url": "https://github.com/confluentinc/schema-registry/commit/8b619b03ce80ddf0436b4da7030a41036cc83334", "message": "Merge branch 'master' into telemetry-reporter", "committedDate": "2020-05-27T02:27:24Z", "type": "commit"}, {"oid": "7f0937b242e61aa612b1274e112f3387e5596e07", "url": "https://github.com/confluentinc/schema-registry/commit/7f0937b242e61aa612b1274e112f3387e5596e07", "message": "Fix checkstyle issue", "committedDate": "2020-05-27T02:48:20Z", "type": "commit"}, {"oid": "75ea081cb089493237a354be2191ed5beac52283", "url": "https://github.com/confluentinc/schema-registry/commit/75ea081cb089493237a354be2191ed5beac52283", "message": "Cleanup", "committedDate": "2020-05-28T01:52:42Z", "type": "commit"}, {"oid": "dd7bf03997f67b68788b124900ec7ad58824657c", "url": "https://github.com/confluentinc/schema-registry/commit/dd7bf03997f67b68788b124900ec7ad58824657c", "message": "Fix integration test", "committedDate": "2020-06-08T04:41:38Z", "type": "commit"}, {"oid": "ed149443dda3b6363c97fbb8cfa4910dcb79db80", "url": "https://github.com/confluentinc/schema-registry/commit/ed149443dda3b6363c97fbb8cfa4910dcb79db80", "message": "Cleanup integration test", "committedDate": "2020-06-08T04:55:59Z", "type": "commit"}, {"oid": "fbaec4b001a9c413fef40d51555994234ca2d065", "url": "https://github.com/confluentinc/schema-registry/commit/fbaec4b001a9c413fef40d51555994234ca2d065", "message": "Move getCommitId to separate AppInfoParser", "committedDate": "2020-06-08T05:15:25Z", "type": "commit"}, {"oid": "74531ecb6f0d70102b5deeef5b1ed365ab41f15a", "url": "https://github.com/confluentinc/schema-registry/commit/74531ecb6f0d70102b5deeef5b1ed365ab41f15a", "message": "Spotbugs fix", "committedDate": "2020-06-08T05:25:48Z", "type": "commit"}, {"oid": "930087960714f7aba1da57c2af05ee7fc82d365d", "url": "https://github.com/confluentinc/schema-registry/commit/930087960714f7aba1da57c2af05ee7fc82d365d", "message": "Assert SR version in integration test", "committedDate": "2020-06-08T05:29:22Z", "type": "commit"}, {"oid": "43d81a3e2349550f88662d0253fbff8358bc0739", "url": "https://github.com/confluentinc/schema-registry/commit/43d81a3e2349550f88662d0253fbff8358bc0739", "message": "Merge branch 'master' into telemetry-reporter", "committedDate": "2020-06-08T05:32:41Z", "type": "commit"}, {"oid": "f8018ec87bb7e173756106da4851edbebcb032e1", "url": "https://github.com/confluentinc/schema-registry/commit/f8018ec87bb7e173756106da4851edbebcb032e1", "message": "Cleanup AppInfoParser", "committedDate": "2020-06-08T05:49:03Z", "type": "commit"}, {"oid": "63e297b80bd55b2ab6dee9cd91912eaebc4d274a", "url": "https://github.com/confluentinc/schema-registry/commit/63e297b80bd55b2ab6dee9cd91912eaebc4d274a", "message": "Further cleanup", "committedDate": "2020-06-08T06:07:17Z", "type": "commit"}, {"oid": "336d4f425fe77b3e90d42cdbbd3ea9ef78f9efc7", "url": "https://github.com/confluentinc/schema-registry/commit/336d4f425fe77b3e90d42cdbbd3ea9ef78f9efc7", "message": "Send metrics from master node only", "committedDate": "2020-06-08T06:21:11Z", "type": "commit"}, {"oid": "52b330c719b6c0e94582fa5c47c6b1ddb0be3de1", "url": "https://github.com/confluentinc/schema-registry/commit/52b330c719b6c0e94582fa5c47c6b1ddb0be3de1", "message": "Move TelemetryReporterTest", "committedDate": "2020-06-08T06:24:20Z", "type": "commit"}, {"oid": "0a8cef5a7d3fb3f4492c854435be6974a9bf3ea4", "url": "https://github.com/confluentinc/schema-registry/commit/0a8cef5a7d3fb3f4492c854435be6974a9bf3ea4", "message": "POM cleanup", "committedDate": "2020-06-08T06:47:07Z", "type": "commit"}, {"oid": "322416d394035064918bd3f0386144245638d2ac", "url": "https://github.com/confluentinc/schema-registry/commit/322416d394035064918bd3f0386144245638d2ac", "message": "Fix checkstyle error", "committedDate": "2020-06-08T18:42:34Z", "type": "commit"}, {"oid": "36567eccb6c374eb482f02c07d7882f12eac14d7", "url": "https://github.com/confluentinc/schema-registry/commit/36567eccb6c374eb482f02c07d7882f12eac14d7", "message": "Factor out TelemetryReporter", "committedDate": "2020-06-08T22:27:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODE0OA==", "url": "https://github.com/confluentinc/schema-registry/pull/1483#discussion_r437058148", "bodyText": "Can we move the logic in the line above to setLeader?", "author": "rayokota", "createdAt": "2020-06-08T23:37:52Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/KafkaSchemaRegistry.java", "diffHunk": "@@ -371,6 +371,7 @@ public void setLeader(@Nullable SchemaRegistryIdentity newLeader)\n         idGenerator.init();\n       }\n       metricsContainer.isLeader().set(isLeader() ? 1 : 0);\n+      metricsContainer.setLeader(isLeader());", "originalCommit": "322416d394035064918bd3f0386144245638d2ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODgyMg==", "url": "https://github.com/confluentinc/schema-registry/pull/1483#discussion_r437058822", "bodyText": "Where is this used?", "author": "rayokota", "createdAt": "2020-06-08T23:40:14Z", "path": "core/src/test/java/io/confluent/kafka/schemaregistry/RestApp.java", "diffHunk": "@@ -67,6 +66,8 @@ public RestApp(int port,\n     prop.put(SchemaRegistryConfig.KAFKASTORE_TOPIC_CONFIG, kafkaTopic);\n     prop.put(SchemaRegistryConfig.SCHEMA_COMPATIBILITY_CONFIG, compatibilityType);\n     prop.put(SchemaRegistryConfig.LEADER_ELIGIBILITY, leaderEligibility);\n+\n+    prop.put(\"metrics.jmx.prefix\", \"kafka.schema.registry\");", "originalCommit": "322416d394035064918bd3f0386144245638d2ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzEyMTYzNA==", "url": "https://github.com/confluentinc/schema-registry/pull/1483#discussion_r437121634", "bodyText": "Not needed after rest-utils got fixed, removed.", "author": "dragosvictor", "createdAt": "2020-06-09T03:46:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MjAwOQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1483#discussion_r437062009", "bodyText": "note, we switched all labels to be lowercase by default", "author": "xvrl", "createdAt": "2020-06-08T23:51:10Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/metrics/MetricsContainer.java", "diffHunk": "@@ -174,21 +202,15 @@ private SchemaRegistryMetric getSchemaTypeMetric(String type, boolean isRegister\n     }\n   }\n \n-  private static String getCommitId() {\n-    final String defaultValue = \"Unknown\";\n-\n-    String fileName = \"/schema-registry-app.properties\";\n-    try (InputStream propFile = MetricsContainer.class.getResourceAsStream(fileName)) {\n-      if (propFile != null) {\n-        Properties props = new Properties();\n-        props.load(propFile);\n-        return props.getProperty(\"application.commitId\", defaultValue).trim();\n-      } else {\n-        log.error(\"Cannot find properties file\");\n-      }\n-    } catch (IOException e) {\n-      log.warn(\"Cannot parse properties file\", e);\n-    }\n-    return defaultValue;\n+  @NotNull\n+  private static MetricsContext getMetricsContext(SchemaRegistryConfig config) {\n+    Map<String, Object> metadata =\n+            true ? config.originalsWithPrefix(CommonClientConfigs.METRICS_CONTEXT_PREFIX) :\n+                    config.originals();\n+    metadata.put(RESOURCE_LABEL_TYPE,  \"SCHEMAREGISTRY\");", "originalCommit": "322416d394035064918bd3f0386144245638d2ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6d02be3c26f6558a0971079bb07ba67639d7c167", "url": "https://github.com/confluentinc/schema-registry/commit/6d02be3c26f6558a0971079bb07ba67639d7c167", "message": "Cleanup", "committedDate": "2020-06-09T00:38:04Z", "type": "commit"}, {"oid": "d0e487c0e3a5e6e9ae1af0144e4abade91a8c9f0", "url": "https://github.com/confluentinc/schema-registry/commit/d0e487c0e3a5e6e9ae1af0144e4abade91a8c9f0", "message": "Use lowercase resource label type", "committedDate": "2020-06-09T00:48:25Z", "type": "commit"}, {"oid": "af6cf5f5a1ef3749162926d5ace3f2568f07d59b", "url": "https://github.com/confluentinc/schema-registry/commit/af6cf5f5a1ef3749162926d5ace3f2568f07d59b", "message": "Refactor isLeader metric", "committedDate": "2020-06-09T00:57:48Z", "type": "commit"}, {"oid": "9fd7f5f860c436fa2490f1ec1b8333d9d623dc02", "url": "https://github.com/confluentinc/schema-registry/commit/9fd7f5f860c436fa2490f1ec1b8333d9d623dc02", "message": "Remove extra property in RestApp", "committedDate": "2020-06-09T01:10:24Z", "type": "commit"}, {"oid": "c5f5ff1fa62e80c7c2f61c8552b040425d003cd8", "url": "https://github.com/confluentinc/schema-registry/commit/c5f5ff1fa62e80c7c2f61c8552b040425d003cd8", "message": "Setup correct cluster ID", "committedDate": "2020-06-11T06:49:32Z", "type": "commit"}, {"oid": "38c1ad564f2ae53a15f25651c3469f5959399cc6", "url": "https://github.com/confluentinc/schema-registry/commit/38c1ad564f2ae53a15f25651c3469f5959399cc6", "message": "Remove CE dependency", "committedDate": "2020-06-12T03:02:41Z", "type": "commit"}, {"oid": "85dbcfbf8cc01e2816774b3bb73b7b42667211bd", "url": "https://github.com/confluentinc/schema-registry/commit/85dbcfbf8cc01e2816774b3bb73b7b42667211bd", "message": "Add telemetry configs", "committedDate": "2020-06-12T03:03:29Z", "type": "commit"}, {"oid": "b84b58a701ce7c6d676b40da660ada00e3e846d8", "url": "https://github.com/confluentinc/schema-registry/commit/b84b58a701ce7c6d676b40da660ada00e3e846d8", "message": "Fix integration test", "committedDate": "2020-06-12T03:03:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyNTI5NQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1483#discussion_r440325295", "bodyText": "If we use this Metrics constructor:\nhttps://github.com/confluentinc/ce-kafka/blob/d6ecf6a2d2d34c7fbea13880dea51585f87c7122/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java#L132\nThen there is no need to do the iteration here.", "author": "xiaodongdu", "createdAt": "2020-06-15T17:13:45Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/leaderelector/kafka/KafkaGroupLeaderElector.java", "diffHunk": "@@ -97,8 +99,11 @@ public KafkaGroupLeaderElector(SchemaRegistryConfig config,\n           CommonClientConfigs.METRIC_REPORTER_CLASSES_CONFIG,\n           MetricsReporter.class\n       );\n-      reporters.add(new JmxReporter(JMX_PREFIX));\n-\n+      reporters.add(new JmxReporter());\n+      for (MetricsReporter reporter : reporters) {", "originalCommit": "b84b58a701ce7c6d676b40da660ada00e3e846d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5OTEwMA==", "url": "https://github.com/confluentinc/schema-registry/pull/1483#discussion_r440999100", "bodyText": "Fixed, thank you !", "author": "dragosvictor", "createdAt": "2020-06-16T16:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyNTI5NQ=="}], "type": "inlineReview"}, {"oid": "926e52c155d013793c8579cc42234a0128610d5b", "url": "https://github.com/confluentinc/schema-registry/commit/926e52c155d013793c8579cc42234a0128610d5b", "message": "Skip contextChange calls", "committedDate": "2020-06-16T02:20:24Z", "type": "commit"}, {"oid": "bdc9d62666565321e55a424e269bb94eda9f7512", "url": "https://github.com/confluentinc/schema-registry/commit/bdc9d62666565321e55a424e269bb94eda9f7512", "message": "Remove CE dependency at compile time", "committedDate": "2020-06-16T03:52:08Z", "type": "commit"}, {"oid": "099c2fceeff6f10bb0338b5928f6e0182ca07df6", "url": "https://github.com/confluentinc/schema-registry/commit/099c2fceeff6f10bb0338b5928f6e0182ca07df6", "message": "Merge branch '6.0.x' into telemetry-reporter", "committedDate": "2020-06-16T16:10:43Z", "type": "commit"}, {"oid": "a26ec18af179fc077e3725064e3e49d0abbbe26a", "url": "https://github.com/confluentinc/schema-registry/commit/a26ec18af179fc077e3725064e3e49d0abbbe26a", "message": "Remove CE dependency and integration test", "committedDate": "2020-06-16T17:01:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MDI0Ng==", "url": "https://github.com/confluentinc/schema-registry/pull/1483#discussion_r442390246", "bodyText": "For components that are tied to a specific kafka cluster, we split out the tags rather than combining them. i.e. for connect to we use the group id as the cluster.id, and we add a nother tag or the kafka cluster id.\nThis matches the nomenclature we use to identify a cluster when defining RBAC permissions.", "author": "xvrl", "createdAt": "2020-06-18T17:30:52Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/metrics/MetricsContainer.java", "diffHunk": "@@ -174,21 +198,41 @@ private SchemaRegistryMetric getSchemaTypeMetric(String type, boolean isRegister\n     }\n   }\n \n-  private static String getCommitId() {\n-    final String defaultValue = \"Unknown\";\n+  private static List<String> getMetricReporterConfig(SchemaRegistryConfig config) {\n+    List<String> classes = new ArrayList<>(config.getList(\n+            ProducerConfig.METRIC_REPORTER_CLASSES_CONFIG));\n+    try {\n+      if (!classes.contains(TELEMETRY_REPORTER_CLASS)) {\n+        Class.forName(TELEMETRY_REPORTER_CLASS);\n+        classes.add(TELEMETRY_REPORTER_CLASS);\n+      }\n+    } catch (ClassNotFoundException cnfe) {\n+      // Ignore\n+    }\n+    return classes;\n+  }\n \n-    String fileName = \"/schema-registry-app.properties\";\n-    try (InputStream propFile = MetricsContainer.class.getResourceAsStream(fileName)) {\n-      if (propFile != null) {\n-        Properties props = new Properties();\n-        props.load(propFile);\n-        return props.getProperty(\"application.commitId\", defaultValue).trim();\n-      } else {\n-        log.error(\"Cannot find properties file\");\n+  private static MetricsReporter getTelemetryReporter(List<MetricsReporter> reporters) {\n+    for (MetricsReporter reporter : reporters) {\n+      if (reporter.getClass().getName().equals(TELEMETRY_REPORTER_CLASS)) {\n+        return reporter;\n       }\n-    } catch (IOException e) {\n-      log.warn(\"Cannot parse properties file\", e);\n     }\n-    return defaultValue;\n+    return null;\n+  }\n+\n+  private static MetricsContext getMetricsContext(SchemaRegistryConfig config,\n+                                                  String kafkaClusterId) {\n+    Map<String, Object> metadata =\n+            config.originalsWithPrefix(CommonClientConfigs.METRICS_CONTEXT_PREFIX);\n+\n+    String clusterId = String.format(\"%s-%s\", kafkaClusterId,\n+            config.getString(SchemaRegistryConfig.SCHEMAREGISTRY_GROUP_ID_CONFIG));", "originalCommit": "a26ec18af179fc077e3725064e3e49d0abbbe26a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}