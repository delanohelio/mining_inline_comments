{"pr_number": 583, "pr_title": "XRDDEV-1017: Make SignerClient more robust", "pr_createdAt": "2020-07-07T12:14:34Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/583", "timeline": [{"oid": "f5895e83a9daa00a9df1d49fb59b72ee008700d3", "url": "https://github.com/nordic-institute/X-Road/commit/f5895e83a9daa00a9df1d49fb59b72ee008700d3", "message": "XRDDEV-1017: Make SignerClient more robust\n\nIn certain conditions, SignerClient can observe timeout when Signer\nis restarted while a request is being made. Make SignerClient\nto watch Signer's RequestProcessor actor, and in case of termination,\ntry to re-establish connection as soon as possible. Alter the Signer\nstartup to remove unnecessary delays.\n\nAlso update Akka to the latest patch version (2.6.6).", "committedDate": "2020-07-13T07:30:06Z", "type": "commit"}, {"oid": "2d84e59759e44d64302e8fe871a04bab9ad26895", "url": "https://github.com/nordic-institute/X-Road/commit/2d84e59759e44d64302e8fe871a04bab9ad26895", "message": "XRDDEV-1017: Fix SonarQube critical warnings", "committedDate": "2020-07-13T07:30:06Z", "type": "commit"}, {"oid": "5df4130bc71ebd27fccb45e6d659bbaf56b667da", "url": "https://github.com/nordic-institute/X-Road/commit/5df4130bc71ebd27fccb45e6d659bbaf56b667da", "message": "XRDDEV-1017: Fix signer attach special case\n\nAvoids unnecessary reset of the requestProcessor future in\ncase it is not completed.", "committedDate": "2020-07-13T07:30:06Z", "type": "commit"}, {"oid": "14fa1cced47649dfe90151b281b79a8adb5d6a51", "url": "https://github.com/nordic-institute/X-Road/commit/14fa1cced47649dfe90151b281b79a8adb5d6a51", "message": "XRDDEV-1017: Disable Akka actorref compression\n\nDisable Akka artery actorref compression\n* Actors used in remoting are often temporary, but the mechanism seems\nto cache also references to those and use a lot of memory.\n* All remoting is local (over loopback), bandwidth usage is not a concern.", "committedDate": "2020-07-13T07:30:06Z", "type": "commit"}, {"oid": "86d64b6b17a172555d488dd1355d21e9fe20b52a", "url": "https://github.com/nordic-institute/X-Road/commit/86d64b6b17a172555d488dd1355d21e9fe20b52a", "message": "XRDDEV-1017: Avoid leaking temporary actor references\n\nSigner request handler actors are temporary. Use parent\n(RequestProcessor) reference as sender in responses, avoiding\nleaking the temporary actor reference.", "committedDate": "2020-07-13T07:30:06Z", "type": "commit"}, {"oid": "86d64b6b17a172555d488dd1355d21e9fe20b52a", "url": "https://github.com/nordic-institute/X-Road/commit/86d64b6b17a172555d488dd1355d21e9fe20b52a", "message": "XRDDEV-1017: Avoid leaking temporary actor references\n\nSigner request handler actors are temporary. Use parent\n(RequestProcessor) reference as sender in responses, avoiding\nleaking the temporary actor reference.", "committedDate": "2020-07-13T07:30:06Z", "type": "forcePushed"}, {"oid": "fe13ccab6021d8cc8b71070570b1d7266b0809c7", "url": "https://github.com/nordic-institute/X-Road/commit/fe13ccab6021d8cc8b71070570b1d7266b0809c7", "message": "XRDDEV-1017: Update Akka to version 2.6.7", "committedDate": "2020-07-13T09:27:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMxNjQ2Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/583#discussion_r454316466", "bodyText": "The code related to SignerClient, SignerWatcher and signer requestProcessor tracking is pretty complex. I read it for some time and was barely able to grasp what is happening, and would be a bit scared if I had to update it.\nI think ideally some sort of diagram would be great aid to help understanding the implementation, so that people can later update the implementation with better confidence. Perhaps it could show things like the actual client, SignerClient, SignerWatcher, Signer, and the different messages that flow between these (Watch, Identify, ActorIdentity, Terminated).\nIf not a diagram, then maybe consider adding some textual comments to make it easier to understand the mechanism.\nAlso behavior of correlationId and signerRef might benefit from more explanation.", "author": "jansu76", "createdAt": "2020-07-14T12:23:55Z", "path": "src/signer-protocol/src/main/java/ee/ria/xroad/signer/protocol/SignerClient.java", "diffHunk": "@@ -65,95 +72,191 @@ private SignerClient() {\n      * @param system the actor system\n      * @throws Exception if an error occurs\n      */\n-    public static void init(ActorSystem system) throws Exception {\n+    public static void init(ActorSystem system) {\n         init(system, LOCALHOST_IP);\n     }\n \n     /**\n      * Initializes the client with the provided actor system.\n-     * @param system the actor system\n+     * @param system          the actor system\n      * @param signerIpAddress IP address for remote signer\n-     *                         or 127.0.0.1 for local signer\n+     *                        or 127.0.0.1 for local signer\n      * @throws Exception if an error occurs\n      */\n-    public static void init(ActorSystem system,\n-                            String signerIpAddress) throws Exception {\n-        log.trace(\"init()\");\n-\n-        if (SignerClient.actorSystem == null) {\n-            SignerClient.actorSystem = system;\n-\n-            requestProcessor = system.actorSelection(\n-                    getSignerPath(signerIpAddress) + \"/user/\" + REQUEST_PROCESSOR);\n-\n-        }\n+    public static void init(ActorSystem system, String signerIpAddress) {\n+        SignerWatcher.init(system, signerIpAddress);\n     }\n \n     /**\n      * Forwards a message to the signer.\n-     * @param message the message\n+     * @param message  the message\n      * @param receiver the receiver actor\n      */\n     public static void execute(Object message, ActorRef receiver) {\n-        verifyInitialized();\n-        requestProcessor.tell(message, receiver);\n+        signerRef().tell(message, receiver);\n     }\n \n     /**\n      * Sends a message and waits for a response, returning it. If the response\n      * is an exception, throws it.\n-     * @param <T> the type of result\n+     * @param <T>     the type of result\n      * @param message the message\n      * @return the response\n      * @throws Exception if the response is an exception\n      */\n     public static <T> T execute(Object message) throws Exception {\n-        verifyInitialized();\n-\n-        final Timeout timeout = Timeout.apply(TIMEOUT_MILLIS, TimeUnit.MILLISECONDS);\n         try {\n-            return result(Await.result(Patterns.ask(requestProcessor, message, timeout), timeout.duration()));\n-        } catch (TimeoutException te) {\n-            throw connectionTimeoutException(te);\n+            return result(Await.result(Patterns.ask(signerRef(), message, TIMEOUT), TIMEOUT.duration()));\n+        } catch (TimeoutException e) {\n+            throw new CodedException(X_INTERNAL_ERROR, e, \"Request to Signer timed out\");\n         }\n     }\n \n     /**\n      * Returns the object as the instance or throws exception, if the object\n      * is throwable.\n-     * @param <T> the type of result\n+     * @param <T>    the type of result\n      * @param result the result object\n      * @return result\n      * @throws Exception if the object is throwable\n      */\n     @SuppressWarnings(\"unchecked\")\n     public static <T> T result(Object result) throws Exception {\n         if (result instanceof Throwable) {\n-            throw (Exception) result;\n+            throw (Exception)result;\n         } else {\n-            return (T) result;\n+            return (T)result;\n         }\n     }\n \n-    private static String getSignerPath() {\n-        return getSignerPath(\"127.0.0.1\");\n-    }\n+    static class SignerWatcher extends UntypedAbstractActor {\n \n-    private static String getSignerPath(String signerIpAddress) {\n-        return \"akka://\" + SIGNER + \"@\" + signerIpAddress + \":\"\n-                + SystemProperties.getSignerPort();\n-    }\n+        /*\n+         * Implementation notes.\n+         *\n+         * The requestProcessor future will be completed by the internally used\n+         * SignerWatcher actor, and replaced with a new one in case the Signer is restarted. The purpose is to avoid\n+         * long request timeouts when the signer is not (yet) available, and to detect restarts.\n+         *\n+         */\n+        private static volatile CompletableFuture<ActorRef> requestProcessor = null;\n+        private static final Duration WATCH_DELAY = Duration.ofSeconds(1);\n+        private static final int REF_GET_TIMEOUT = 7;\n \n-    private static void verifyInitialized() {\n-        if (actorSystem == null) {\n-            throw new IllegalStateException(\"SignerClient is not initialized\");\n+        static ActorRef signerRef() {\n+            final CompletableFuture<ActorRef> processor = requestProcessor;\n+            if (processor == null) {\n+                throw new IllegalStateException(\"SignerClient is not initialized\");\n+            }\n+            try {\n+                return processor.get(REF_GET_TIMEOUT, TimeUnit.SECONDS);\n+            } catch (ExecutionException | TimeoutException | CancellationException e) {\n+                throw new CodedException(X_INTERNAL_ERROR, e, \"Signer is unreachable\");\n+            } catch (InterruptedException e) {\n+                Thread.currentThread().interrupt();\n+                throw new CodedException(X_INTERNAL_ERROR, e, \"Request to signer was interrupted\");\n+            }\n         }\n-    }\n \n-    private static CodedException connectionTimeoutException(Exception e) {\n-        return new CodedException(X_HTTP_ERROR, e,\n-                \"Connection to Signer (port %s) timed out\",\n-                SystemProperties.getSignerPort());\n-    }\n+        static synchronized void init(ActorSystem system, String signerIpAddress) {\n+            if (requestProcessor == null) {\n+                requestProcessor = new CompletableFuture<>();\n+                system.actorOf(Props.create(SignerWatcher.class, signerIpAddress));\n+            }\n+        }\n+\n+        private static synchronized void resetRequestProcessor(CompletableFuture<ActorRef> processor) {\n+            if (requestProcessor != null && !requestProcessor.isDone()) {\n+                requestProcessor.cancel(true);\n+            }\n+            requestProcessor = processor;\n+        }\n+\n+        private long correlationId = 0;\n+        private ActorRef signerRef;\n+        private ActorSelection signer;\n+        private final String signerIpAddress;\n+\n+        interface Watch {\n+        }\n \n+        SignerWatcher(String signerIpAddress) {\n+            this.signerIpAddress = signerIpAddress;\n+        }\n+\n+        @Override\n+        public void preStart() {\n+            signer = context().actorSelection(getSignerPath() + \"/user/\" + REQUEST_PROCESSOR);\n+            self().tell(Watch.class, self());\n+        }\n+\n+        @Override\n+        public void postStop() {\n+            if (signerRef != null) {\n+                context().unwatch(signerRef);\n+            }\n+            resetRequestProcessor(null);\n+        }\n+\n+        @Override\n+        public void onReceive(final Object message) {", "originalCommit": "fe13ccab6021d8cc8b71070570b1d7266b0809c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6b6485bde9642f62a76f5ba0fa929c0acb278c1c", "url": "https://github.com/nordic-institute/X-Road/commit/6b6485bde9642f62a76f5ba0fa929c0acb278c1c", "message": "XRDDEV-1017: Improve documentation and refactor", "committedDate": "2020-07-14T14:07:40Z", "type": "commit"}]}