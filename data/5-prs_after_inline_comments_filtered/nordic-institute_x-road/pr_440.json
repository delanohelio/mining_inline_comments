{"pr_number": 440, "pr_title": "XRDDEV-971 additional parameters to findClients api", "pr_createdAt": "2020-03-29T19:11:40Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/440", "timeline": [{"oid": "7edb036ccbf044bb45f3b7c672ad510dbffbab22", "url": "https://github.com/nordic-institute/X-Road/commit/7edb036ccbf044bb45f3b7c672ad510dbffbab22", "message": "XRDDEV-971: Added parameters to /clients -apir\n\n- for fetching only clients that are missing from the security server\n- for fetching only local clients that have a valid sign cert", "committedDate": "2020-03-20T08:16:36Z", "type": "commit"}, {"oid": "ed0c9c132aae351cd2fdeb209e8b004b2b86a7a6", "url": "https://github.com/nordic-institute/X-Road/commit/ed0c9c132aae351cd2fdeb209e8b004b2b86a7a6", "message": "XRDDEV-971: Add filtering options to findClients api", "committedDate": "2020-03-26T07:21:27Z", "type": "commit"}, {"oid": "eaf774b821286c33efb08bb63dc815e251061e0e", "url": "https://github.com/nordic-institute/X-Road/commit/eaf774b821286c33efb08bb63dc815e251061e0e", "message": "Merge branch 'develop' into XRDDEV-971", "committedDate": "2020-03-29T19:39:50Z", "type": "commit"}, {"oid": "5e908fd6bf488ef1c328a657ac5bf84cb7154a74", "url": "https://github.com/nordic-institute/X-Road/commit/5e908fd6bf488ef1c328a657ac5bf84cb7154a74", "message": "XRDDEV-971: Move OcspUtils.OcspStatusExtractionException handling away from controllers", "committedDate": "2020-03-29T20:36:48Z", "type": "commit"}, {"oid": "9ac45a09e3bbbaa658a1db47be58d74293db26a1", "url": "https://github.com/nordic-institute/X-Road/commit/9ac45a09e3bbbaa658a1db47be58d74293db26a1", "message": "XRDDEV-971: Cleanup", "committedDate": "2020-03-29T20:47:25Z", "type": "commit"}, {"oid": "4533d26439f5cf6f1f41b01a5811f43a72f3935b", "url": "https://github.com/nordic-institute/X-Road/commit/4533d26439f5cf6f1f41b01a5811f43a72f3935b", "message": "Merge branch 'develop' into XRDDEV-971", "committedDate": "2020-04-02T18:39:47Z", "type": "commit"}, {"oid": "b4efa96b4de7b3a63b5aa36e13b73de0c2006095", "url": "https://github.com/nordic-institute/X-Road/commit/b4efa96b4de7b3a63b5aa36e13b73de0c2006095", "message": "Merge branch 'develop' into XRDDEV-971", "committedDate": "2020-04-06T17:58:42Z", "type": "commit"}, {"oid": "894c39d46a000befa38e94bd628ae4bb45582938", "url": "https://github.com/nordic-institute/X-Road/commit/894c39d46a000befa38e94bd628ae4bb45582938", "message": "Merge branch 'develop' into XRDDEV-971", "committedDate": "2020-04-07T10:45:13Z", "type": "commit"}, {"oid": "d5bc2c623b0db5a8c6795d8749bd4f6e3d7e738e", "url": "https://github.com/nordic-institute/X-Road/commit/d5bc2c623b0db5a8c6795d8749bd4f6e3d7e738e", "message": "Merge branch 'develop' into XRDDEV-971", "committedDate": "2020-04-08T10:52:10Z", "type": "commit"}, {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8", "url": "https://github.com/nordic-institute/X-Road/commit/13fc88933e19bbc49671bed730ed3238b5eab6c8", "message": "XRDDEV-971: Fix test", "committedDate": "2020-04-08T11:19:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0NjY2Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411146663", "bodyText": "Should not throw OpenAPI related exceptions from the service layer.", "author": "carohauta", "createdAt": "2020-04-20T07:14:14Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -413,20 +431,51 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n      * @param subsystemCode\n      * @param showMembers include members (without subsystemCode) in the results\n      * @param internalSearch search only in the local clients\n+     * @param onlyLocalClientWithValidSignCert include only local clients that have valid sign cert\n+     * @param onlyLocallyMissingClients list only clients that are missing from this security server\n      * @return ClientType list\n      */\n     public List<ClientType> findClients(String name, String instance, String memberClass, String memberCode,\n-            String subsystemCode, boolean showMembers, boolean internalSearch) {\n+            String subsystemCode, boolean showMembers, boolean internalSearch,\n+            boolean onlyLocalClientWithValidSignCert, boolean onlyLocallyMissingClients) {\n+        if ((onlyLocalClientWithValidSignCert || internalSearch) && onlyLocallyMissingClients) {\n+            throw new BadRequestException(\"Illegally using parameters for \"", "originalCommit": "13fc88933e19bbc49671bed730ed3238b5eab6c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1ODgxOA==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411158818", "bodyText": "Actually coming to think of this: should an exception be thrown at all here? After all the query parameters are just for filtering the results of the request. Returning an empty list because of too excessive filtering does not seem wrong to me \ud83e\udd37\u200d\u2642\ufe0f", "author": "carohauta", "createdAt": "2020-04-20T07:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0NjY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2MDAwNA==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411460004", "bodyText": "Okay makes sense since the parameters are optional. Removed the if-block.", "author": "TJaakkola", "createdAt": "2020-04-20T15:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0NjY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2ODMxMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411168311", "bodyText": "Could this be added into buildClientSearchPredicate method with a logical and? In it's current state this predicate causes an extra iteration through possibly quite large set of clients in here.", "author": "carohauta", "createdAt": "2020-04-20T07:52:44Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -562,6 +611,40 @@ public void changeOwner(String memberClass, String memberCode, String subsystemC\n         return clientTypePredicate;\n     }\n \n+    /**\n+     * Create predicate function for filtering by valid local sign cert\n+     *\n+     * @param onlyLocalClientWithValidSignCert\n+     * @return\n+     */\n+    private Predicate<ClientType> buildValidSignCertPredicate(boolean onlyLocalClientWithValidSignCert) {\n+\n+        if (onlyLocalClientWithValidSignCert) {\n+            Predicate<ClientType> validSignCertPredicate = clientType -> false;\n+            validSignCertPredicate = validSignCertPredicate.or(this::hasValidLocalSignCertCheck);\n+            return validSignCertPredicate;\n+        }", "originalCommit": "13fc88933e19bbc49671bed730ed3238b5eab6c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUyMzUzOA==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411523538", "bodyText": "Yes, I did think this while I implemented it but somehow came to the conclusion it wouldn't work. But now that I though it again I think it should work and should be there.", "author": "TJaakkola", "createdAt": "2020-04-20T16:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2ODMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg5NjgxNg==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411896816", "bodyText": "Refactored.", "author": "TJaakkola", "createdAt": "2020-04-21T06:10:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2ODMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE3Nzg4NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411177885", "bodyText": "Seems to be a simple utility test -> does not need Spring context or database to run. Removing these annotations will cut about 20 seconds off of the execution time of the test.", "author": "carohauta", "createdAt": "2020-04-20T08:08:48Z", "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/util/ClientUtilsTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.util;\n+\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.signer.protocol.dto.CertificateInfo;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.bouncycastle.asn1.x509.CRLReason;\n+import org.bouncycastle.cert.ocsp.RevokedStatus;\n+import org.bouncycastle.cert.ocsp.UnknownStatus;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.boot.test.autoconfigure.jdbc.AutoConfigureTestDatabase;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+@RunWith(SpringRunner.class)\n+@SpringBootTest\n+@AutoConfigureTestDatabase", "originalCommit": "13fc88933e19bbc49671bed730ed3238b5eab6c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ3MTIyMA==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411471220", "bodyText": "Removed and faster it is \ud83d\udc4d", "author": "TJaakkola", "createdAt": "2020-04-20T15:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE3Nzg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE4NjcyOQ==", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411186729", "bodyText": "The Javadoc of ClientId#memberEquals says that \"This comparison ignores subsystem part of the identifier\". Is this fine? Basic equals (overridden in XRoadId) seems to offer a full comparison including the subsystem if that is something that is needed.", "author": "carohauta", "createdAt": "2020-04-20T08:22:38Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/util/ClientUtils.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.util;\n+\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.signer.protocol.dto.CertificateInfo;\n+\n+import java.util.List;\n+\n+public final class ClientUtils {\n+\n+    private ClientUtils() {\n+        // noop\n+    }\n+\n+    /**\n+     *\n+     * @param clientId\n+     * @param certificateInfos\n+     * @return\n+     * @throws OcspUtils.OcspStatusExtractionException\n+     */\n+    public static boolean hasValidLocalSignCert(ClientId clientId, List<CertificateInfo> certificateInfos)\n+            throws OcspUtils.OcspStatusExtractionException {\n+        for (CertificateInfo certificateInfo : certificateInfos) {\n+            String ocspResponseStatus = OcspUtils.getOcspResponseStatus(certificateInfo.getOcspBytes());\n+            if (clientId.memberEquals(certificateInfo.getMemberId())", "originalCommit": "13fc88933e19bbc49671bed730ed3238b5eab6c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7305a0ad36037ce3e858bcc5f2c09920de8a79c7", "url": "https://github.com/nordic-institute/X-Road/commit/7305a0ad36037ce3e858bcc5f2c09920de8a79c7", "message": "XRDDEV-971: Changes according to pull request comments:\n\nRenaming findClient api queryparameters\nRemove unnecessary sprint boot initialization in ClientUtilsTest\nRemoved unnecessarily throwing exception when api user uses too restrictive query parameters in findClients call", "committedDate": "2020-04-21T05:04:10Z", "type": "commit"}, {"oid": "d57a0a269dd68052b389d7fd3500fb27e9583cc7", "url": "https://github.com/nordic-institute/X-Road/commit/d57a0a269dd68052b389d7fd3500fb27e9583cc7", "message": "XRDDEV-971: Optimize and simplify filtering local clients with valid sign certs", "committedDate": "2020-04-21T06:09:59Z", "type": "commit"}, {"oid": "84c65317b5381b40805d7b06e840aafb27bf0cd9", "url": "https://github.com/nordic-institute/X-Road/commit/84c65317b5381b40805d7b06e840aafb27bf0cd9", "message": "XRDDEV-971: Remove unused import", "committedDate": "2020-04-21T09:36:37Z", "type": "commit"}, {"oid": "00bdab140ef309fec84c5ecdfec9d19317ef4d2b", "url": "https://github.com/nordic-institute/X-Road/commit/00bdab140ef309fec84c5ecdfec9d19317ef4d2b", "message": "Merge branch 'develop' into XRDDEV-971", "committedDate": "2020-04-21T10:39:40Z", "type": "commit"}, {"oid": "d3fcc4f5091e5993ec9d0fc895c099d999995ffd", "url": "https://github.com/nordic-institute/X-Road/commit/d3fcc4f5091e5993ec9d0fc895c099d999995ffd", "message": "XRDDEV-971: Fix tests", "committedDate": "2020-04-21T15:45:12Z", "type": "commit"}]}