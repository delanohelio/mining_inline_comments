{"pr_number": 443, "pr_title": "XRDDEV-947", "pr_createdAt": "2020-03-31T07:53:37Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/443", "timeline": [{"oid": "4567f0d8084d0ab4f9e471fac84f588a0762719c", "url": "https://github.com/nordic-institute/X-Road/commit/4567f0d8084d0ab4f9e471fac84f588a0762719c", "message": "XRDDEV-947 API for alerts\n\n- Implement API for alerts about issues with global conf and soft token.", "committedDate": "2020-03-27T15:17:46Z", "type": "commit"}, {"oid": "743ad604dc34c22eb08238344c02d77f1ece969b", "url": "https://github.com/nordic-institute/X-Road/commit/743ad604dc34c22eb08238344c02d77f1ece969b", "message": "XRDDEV-947 Always return current status regardless of alertsEnabled value", "committedDate": "2020-03-27T18:21:05Z", "type": "commit"}, {"oid": "ab1bdc41fa38355fbb93a1b9f3415d787836ac12", "url": "https://github.com/nordic-institute/X-Road/commit/ab1bdc41fa38355fbb93a1b9f3415d787836ac12", "message": "XRDDEV-947 Add API controller tests", "committedDate": "2020-03-28T14:28:04Z", "type": "commit"}, {"oid": "8ba3e9dd851f583b8eeb0616e1ae84ff7402d352", "url": "https://github.com/nordic-institute/X-Road/commit/8ba3e9dd851f583b8eeb0616e1ae84ff7402d352", "message": "XRDDEV-947 Refactor alerts endpoint\n\n- Remove ignore_alerts property.\n- Add current_time and backup_restore_running_since properties.", "committedDate": "2020-03-31T06:56:41Z", "type": "commit"}, {"oid": "71ddfc005653da124865e0fd02456f6f3f2cf2d7", "url": "https://github.com/nordic-institute/X-Road/commit/71ddfc005653da124865e0fd02456f6f3f2cf2d7", "message": "XRDDEV-947 Change Date to OffsetDateTime", "committedDate": "2020-03-31T10:34:29Z", "type": "commit"}, {"oid": "aef72cad03fd8fc4ade1ba874f9a98f837210e3d", "url": "https://github.com/nordic-institute/X-Road/commit/aef72cad03fd8fc4ade1ba874f9a98f837210e3d", "message": "XRDDEV-947 Minor changes", "committedDate": "2020-03-31T13:37:26Z", "type": "commit"}, {"oid": "1b1e84431e5b794ea908f46a477e05d7e5ab4c9e", "url": "https://github.com/nordic-institute/X-Road/commit/1b1e84431e5b794ea908f46a477e05d7e5ab4c9e", "message": "XRDDEV-947 Add service layer tests", "committedDate": "2020-04-01T06:38:20Z", "type": "commit"}, {"oid": "1c12be3fda626f672a53b4977468461a235f43b9", "url": "https://github.com/nordic-institute/X-Road/commit/1c12be3fda626f672a53b4977468461a235f43b9", "message": "Merge branch 'develop' into XRDDEV-947", "committedDate": "2020-04-02T04:53:28Z", "type": "commit"}, {"oid": "7634425897275e83cb3e409a142d866a1acb137a", "url": "https://github.com/nordic-institute/X-Road/commit/7634425897275e83cb3e409a142d866a1acb137a", "message": "Merge branch 'develop' into XRDDEV-947", "committedDate": "2020-04-11T04:34:58Z", "type": "commit"}, {"oid": "c5cc00be7be6d6771dc4e06bb63540b40f091a0c", "url": "https://github.com/nordic-institute/X-Road/commit/c5cc00be7be6d6771dc4e06bb63540b40f091a0c", "message": "XRDDEV-1007 API to reset warnings\n\n- Add API to reset the backup restoration in progress warning.\n- Update tests.", "committedDate": "2020-04-11T05:25:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyNTUxOA==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r411925518", "bodyText": "I don't think that the static keyword adds any benefits here or the getter, setter and reset methods below. It works fine (possibly even faster) but beans are singleton by nature so there should be no need for static members. It causes some troubles testing (not being able to mock) and @Transactional and some other Spring AOP features do not actually support static methods. So just to be on the safe side I would remove the static keywords from the class members.", "author": "carohauta", "createdAt": "2020-04-21T07:05:32Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.CodedException;\n+import ee.ria.xroad.commonui.SignerProxy;\n+import ee.ria.xroad.signer.protocol.dto.TokenInfo;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.dto.AlertStatus;\n+import org.niis.xroad.restapi.facade.GlobalConfFacade;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.Optional;\n+\n+/**\n+ * service class for handling notifications\n+ */\n+@Slf4j\n+@Service\n+@Transactional\n+@PreAuthorize(\"isAuthenticated()\")\n+public class NotificationService {\n+    private static OffsetDateTime backupRestoreRunningSince;", "originalCommit": "c5cc00be7be6d6771dc4e06bb63540b40f091a0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjExMzMyNQ==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r412113325", "bodyText": "Removed the static keyword from the variable and all methods accessing it.", "author": "petkivim", "createdAt": "2020-04-21T11:46:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyNTUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3NDMxMw==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r411974313", "bodyText": "Should this also check whether the Security Server has been initialized yet? That is of course still in review but since the old implementation checks the init status, maybe it should be added here also to avoid throwing \"false\" exceptions. If it is something that is wanted, maybe we should create a new ticket so it does not get forgotten.", "author": "carohauta", "createdAt": "2020-04-21T08:18:33Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.CodedException;\n+import ee.ria.xroad.commonui.SignerProxy;\n+import ee.ria.xroad.signer.protocol.dto.TokenInfo;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.dto.AlertStatus;\n+import org.niis.xroad.restapi.facade.GlobalConfFacade;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.Optional;\n+\n+/**\n+ * service class for handling notifications\n+ */\n+@Slf4j\n+@Service\n+@Transactional\n+@PreAuthorize(\"isAuthenticated()\")\n+public class NotificationService {\n+    private static OffsetDateTime backupRestoreRunningSince;\n+    private final GlobalConfFacade globalConfFacade;\n+    private final TokenService tokenService;\n+\n+    /**\n+     * constructor\n+     */\n+    @Autowired\n+    public NotificationService(GlobalConfFacade globalConfFacade, TokenService tokenService) {\n+        this.globalConfFacade = globalConfFacade;\n+        this.tokenService = tokenService;\n+    }\n+\n+    /**\n+     * Checks the status of system alerts that may affect whether the system\n+     * is operational or not. If alerts are disabled, the status of all alerts true.\n+     * @return\n+     */\n+    public AlertStatus getAlerts() {", "originalCommit": "c5cc00be7be6d6771dc4e06bb63540b40f091a0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjExNTY2OA==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r412115668", "bodyText": "Yes, you're right. It should be checked whether the Security Server is initialized or not. I'll create a new ticket about it that can be implemented once XRDDEV-904 has been completed.", "author": "petkivim", "createdAt": "2020-04-21T11:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3NDMxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEyNTUyOA==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r412125528", "bodyText": "The init status check will be implemented in XRDDEV-1035 (https://jira.niis.org/browse/XRDDEV-1035).", "author": "petkivim", "createdAt": "2020-04-21T12:06:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3NDMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3OTMwOQ==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r411979309", "bodyText": "The old implementation does not stop execution if the soft token is not found. However a RuntimeException here makes sense if the token has been properly initialized but nevertheless is not found. Adding the init check in the getAlerts method would actually help in this situation too", "author": "carohauta", "createdAt": "2020-04-21T08:25:28Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.CodedException;\n+import ee.ria.xroad.commonui.SignerProxy;\n+import ee.ria.xroad.signer.protocol.dto.TokenInfo;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.dto.AlertStatus;\n+import org.niis.xroad.restapi.facade.GlobalConfFacade;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.Optional;\n+\n+/**\n+ * service class for handling notifications\n+ */\n+@Slf4j\n+@Service\n+@Transactional\n+@PreAuthorize(\"isAuthenticated()\")\n+public class NotificationService {\n+    private static OffsetDateTime backupRestoreRunningSince;\n+    private final GlobalConfFacade globalConfFacade;\n+    private final TokenService tokenService;\n+\n+    /**\n+     * constructor\n+     */\n+    @Autowired\n+    public NotificationService(GlobalConfFacade globalConfFacade, TokenService tokenService) {\n+        this.globalConfFacade = globalConfFacade;\n+        this.tokenService = tokenService;\n+    }\n+\n+    /**\n+     * Checks the status of system alerts that may affect whether the system\n+     * is operational or not. If alerts are disabled, the status of all alerts true.\n+     * @return\n+     */\n+    public AlertStatus getAlerts() {\n+        AlertStatus alertStatus = new AlertStatus();\n+        OffsetDateTime backupRestoreStartedAt = getBackupRestoreRunningSince();\n+        if (backupRestoreStartedAt != null) {\n+            alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n+            alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n+        }\n+        alertStatus.setGlobalConfValid(isGlobalConfValid());\n+        alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n+        return alertStatus;\n+    }\n+\n+    /**\n+     * Verifies that the global configuration is valid.\n+     * @return\n+     */\n+    private boolean isGlobalConfValid() {\n+        try {\n+            globalConfFacade.verifyValidity();\n+            return true;\n+        } catch (CodedException e) {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Checks if soft token pin is entered.\n+     * @return\n+     */\n+    private boolean isSoftTokenPinEntered() {\n+        Optional<TokenInfo> token = tokenService.getAllTokens().stream()\n+                .filter(t -> t.getId().equals(SignerProxy.SSL_TOKEN_ID)).findFirst();\n+        if (!token.isPresent()) {\n+            throw new RuntimeException(\"soft token not found\");", "originalCommit": "c5cc00be7be6d6771dc4e06bb63540b40f091a0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjExNjI0Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r412116246", "bodyText": "Yes, adding the init check in the getAlerts method will solve this too. I'll create a new ticket about that.", "author": "petkivim", "createdAt": "2020-04-21T11:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3OTMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk4NjU5NA==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r411986594", "bodyText": "Nothing major but would follow other conventions if this test was in org.niis.xroad.restapi.controller package instead of org.niis.xroad.restapi.openapi", "author": "carohauta", "createdAt": "2020-04-21T08:35:42Z", "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/NotificationsApiControllerTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.openapi;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.niis.xroad.restapi.controller.NotificationsApiController;\n+import org.niis.xroad.restapi.domain.AlertData;\n+import org.niis.xroad.restapi.dto.AlertStatus;\n+import org.niis.xroad.restapi.service.NotificationService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+\n+import static junit.framework.TestCase.fail;\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Test NotificationsApiController\n+ */\n+@RunWith(SpringRunner.class)\n+@SpringBootTest\n+public class NotificationsApiControllerTest {", "originalCommit": "c5cc00be7be6d6771dc4e06bb63540b40f091a0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjExMzkzNw==", "url": "https://github.com/nordic-institute/X-Road/pull/443#discussion_r412113937", "bodyText": "Fixed.", "author": "petkivim", "createdAt": "2020-04-21T11:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk4NjU5NA=="}], "type": "inlineReview"}, {"oid": "8e6eaebec8ec66f62bab59346b5b1733a6351bd9", "url": "https://github.com/nordic-institute/X-Road/commit/8e6eaebec8ec66f62bab59346b5b1733a6351bd9", "message": "Merge branch 'develop' into XRDDEV-947", "committedDate": "2020-04-21T09:57:03Z", "type": "commit"}, {"oid": "b657e659dbfa355ba76388da9377bc4c6dc0d94a", "url": "https://github.com/nordic-institute/X-Road/commit/b657e659dbfa355ba76388da9377bc4c6dc0d94a", "message": "XRDDEV-947 Updates based on review comments\n\n- Move NotificationsApiControllerTest to controller package.\n- Make backupRestoreRunningSince variable and methods accessing it non-static.", "committedDate": "2020-04-21T11:41:22Z", "type": "commit"}]}