{"pr_number": 464, "pr_title": "XRDDEV-961 & XRDDEV-956", "pr_createdAt": "2020-04-16T06:33:41Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/464", "timeline": [{"oid": "ca10ea25c8e47d827e706e322b3bd541e4412bd9", "url": "https://github.com/nordic-institute/X-Road/commit/ca10ea25c8e47d827e706e322b3bd541e4412bd9", "message": "XRDDEV-961: Add implementation for fetching access rights for subject", "committedDate": "2020-04-03T05:23:23Z", "type": "commit"}, {"oid": "fd7eb8464d6d2ac81d03464d8d600db9adc32f52", "url": "https://github.com/nordic-institute/X-Road/commit/fd7eb8464d6d2ac81d03464d8d600db9adc32f52", "message": "XRDDEV-956: Add markup for testing subject access rights", "committedDate": "2020-04-03T05:24:15Z", "type": "commit"}, {"oid": "a1122b641f8429336a8220a65b526e0feb297b76", "url": "https://github.com/nordic-institute/X-Road/commit/a1122b641f8429336a8220a65b526e0feb297b76", "message": "Merge branch 'XRDDEV-960_XRDDEV-955' into XRDDEV-961_XRDDEV-956", "committedDate": "2020-04-03T08:29:38Z", "type": "commit"}, {"oid": "c8348b4eb620d7e92ec741b6cc8fd4d109c29feb", "url": "https://github.com/nordic-institute/X-Road/commit/c8348b4eb620d7e92ec741b6cc8fd4d109c29feb", "message": "XRDDEV-961: Fix fetching service client access rights", "committedDate": "2020-04-07T06:21:46Z", "type": "commit"}, {"oid": "24b1856322b08a20fd04d068ed879601e1c57102", "url": "https://github.com/nordic-institute/X-Road/commit/24b1856322b08a20fd04d068ed879601e1c57102", "message": "Merge branch 'XRDDEV-960_XRDDEV-955' into XRDDEV-961_XRDDEV-956", "committedDate": "2020-04-07T11:11:01Z", "type": "commit"}, {"oid": "e35599c5ee2637c3dd4981a92b12e9e802b4d6c6", "url": "https://github.com/nordic-institute/X-Road/commit/e35599c5ee2637c3dd4981a92b12e9e802b4d6c6", "message": "Merge branch 'XRDDEV-960_XRDDEV-955' into XRDDEV-961_XRDDEV-956", "committedDate": "2020-04-08T06:00:54Z", "type": "commit"}, {"oid": "1892da3ad48fad701964c28c10620e5b9bc0c532", "url": "https://github.com/nordic-institute/X-Road/commit/1892da3ad48fad701964c28c10620e5b9bc0c532", "message": "Merge branch 'XRDDEV-960_XRDDEV-955' into XRDDEV-961_XRDDEV-956", "committedDate": "2020-04-08T16:30:49Z", "type": "commit"}, {"oid": "3ae68fc62b6bdc2af0112e1620b0e9375436c36e", "url": "https://github.com/nordic-institute/X-Road/commit/3ae68fc62b6bdc2af0112e1620b0e9375436c36e", "message": "XRDDEV-961 refactor api, update code to compile and tests pass", "committedDate": "2020-04-09T08:29:09Z", "type": "commit"}, {"oid": "7e43a69f05d38368641da4efb3c5dc675fcd3fd1", "url": "https://github.com/nordic-institute/X-Road/commit/7e43a69f05d38368641da4efb3c5dc675fcd3fd1", "message": "XRDDEV-956: initial ui for service client access rights", "committedDate": "2020-04-09T09:46:51Z", "type": "commit"}, {"oid": "a967062bfad7dc63f65dd538ce118334fb86c3c3", "url": "https://github.com/nordic-institute/X-Road/commit/a967062bfad7dc63f65dd538ce118334fb86c3c3", "message": "XRDDEV-961 refresh types.ts, update ServiceClientConverter and ServiceClientHelper", "committedDate": "2020-04-09T10:13:38Z", "type": "commit"}, {"oid": "d581ab0b2922fd5893feab455c8a10448e3629f0", "url": "https://github.com/nordic-institute/X-Road/commit/d581ab0b2922fd5893feab455c8a10448e3629f0", "message": "XRDDEV-961 rename AccessRightHolderDto to ServiceClientDto", "committedDate": "2020-04-09T10:44:20Z", "type": "commit"}, {"oid": "f69d1570d631fdd34242df0db42efad11f9c09b9", "url": "https://github.com/nordic-institute/X-Road/commit/f69d1570d631fdd34242df0db42efad11f9c09b9", "message": "Fix frontend build", "committedDate": "2020-04-09T10:51:13Z", "type": "commit"}, {"oid": "f230a16572b94985948fc015414c5f7d5591284b", "url": "https://github.com/nordic-institute/X-Road/commit/f230a16572b94985948fc015414c5f7d5591284b", "message": "Merge branch 'XRDDEV-961_XRDDEV-956-refactor-service-client-proper' of github.com:nordic-institute/X-Road into XRDDEV-961_XRDDEV-956-refactor-service-client-proper", "committedDate": "2020-04-09T10:51:29Z", "type": "commit"}, {"oid": "e07e1e79e781d82e2037a840d8bc39cedb259127", "url": "https://github.com/nordic-institute/X-Road/commit/e07e1e79e781d82e2037a840d8bc39cedb259127", "message": "XRDDEV-961 rename AccessRightHolderDto to ServiceClientDto", "committedDate": "2020-04-09T10:51:37Z", "type": "commit"}, {"oid": "b528fc073d5277831623f74523e3b391eb2317dc", "url": "https://github.com/nordic-institute/X-Road/commit/b528fc073d5277831623f74523e3b391eb2317dc", "message": "Merge branch 'XRDDEV-961_XRDDEV-956-refactor-service-client-proper' of github.com:nordic-institute/X-Road into XRDDEV-961_XRDDEV-956-refactor-service-client-proper", "committedDate": "2020-04-09T10:52:15Z", "type": "commit"}, {"oid": "703ce8b1dba1161c52b1ed1ea354a2af895d474a", "url": "https://github.com/nordic-institute/X-Road/commit/703ce8b1dba1161c52b1ed1ea354a2af895d474a", "message": "XRDDEV-961 fix ServicesApiController and ClientsApiControllerIntegrationTest", "committedDate": "2020-04-09T11:11:22Z", "type": "commit"}, {"oid": "f7ce8be759f152c9640a1431093b14f93dcdae39", "url": "https://github.com/nordic-institute/X-Road/commit/f7ce8be759f152c9640a1431093b14f93dcdae39", "message": "Renaming UI objects according to api refactoring", "committedDate": "2020-04-09T11:14:15Z", "type": "commit"}, {"oid": "4cc951d73d2739b169466fabd392b324fd1ddd28", "url": "https://github.com/nordic-institute/X-Road/commit/4cc951d73d2739b169466fabd392b324fd1ddd28", "message": "Merge branch 'XRDDEV-961_XRDDEV-956-refactor-service-client-proper' of github.com:nordic-institute/X-Road into XRDDEV-961_XRDDEV-956-refactor-service-client-proper", "committedDate": "2020-04-09T11:14:23Z", "type": "commit"}, {"oid": "8d9b46f53f4fe7b4e560d6a41da4666ab74ce082", "url": "https://github.com/nordic-institute/X-Road/commit/8d9b46f53f4fe7b4e560d6a41da4666ab74ce082", "message": "XRDDEV-956: Fixes to ui build", "committedDate": "2020-04-09T11:24:33Z", "type": "commit"}, {"oid": "bc01e56dd7e76ba9c42b2a7ae5c64bf43bc2f5ea", "url": "https://github.com/nordic-institute/X-Road/commit/bc01e56dd7e76ba9c42b2a7ae5c64bf43bc2f5ea", "message": "XRDDEV-961 fix ServicesApiControllerIntegrationTest", "committedDate": "2020-04-09T11:26:47Z", "type": "commit"}, {"oid": "363338a2c7a0b7a96b2739b5904484090c360465", "url": "https://github.com/nordic-institute/X-Road/commit/363338a2c7a0b7a96b2739b5904484090c360465", "message": "Merge branch 'XRDDEV-960_XRDDEV-955' into XRDDEV-961_XRDDEV-956", "committedDate": "2020-04-09T15:10:53Z", "type": "commit"}, {"oid": "0c572524481138f6ed8c54edfe95dccd4bd0cd68", "url": "https://github.com/nordic-institute/X-Road/commit/0c572524481138f6ed8c54edfe95dccd4bd0cd68", "message": "Merge branch 'XRDDEV-961_XRDDEV-956' into XRDDEV-961_XRDDEV-956-refactor-service-client-proper", "committedDate": "2020-04-09T16:40:03Z", "type": "commit"}, {"oid": "4d6ff4b5839e0db589a00d7fe224f53bebf30dc6", "url": "https://github.com/nordic-institute/X-Road/commit/4d6ff4b5839e0db589a00d7fe224f53bebf30dc6", "message": "Fixes to ServiceParams & AccessRightsDialog after api refactoring", "committedDate": "2020-04-11T10:20:26Z", "type": "commit"}, {"oid": "621f3bbcd030a1835b89e67423f52c6152322f79", "url": "https://github.com/nordic-institute/X-Road/commit/621f3bbcd030a1835b89e67423f52c6152322f79", "message": "Fixes to EndpointsAccessRights after api refactoring", "committedDate": "2020-04-12T07:17:33Z", "type": "commit"}, {"oid": "3755f088a1ace1e9d32ef6459c646c129cbd6637", "url": "https://github.com/nordic-institute/X-Road/commit/3755f088a1ace1e9d32ef6459c646c129cbd6637", "message": "Fix typo", "committedDate": "2020-04-12T07:45:21Z", "type": "commit"}, {"oid": "57acbce63f08820bfe4335966917e570f5a00150", "url": "https://github.com/nordic-institute/X-Road/commit/57acbce63f08820bfe4335966917e570f5a00150", "message": "Refactoring: splitting AccessRightService to AccessRightService and ServiceClientService", "committedDate": "2020-04-13T09:14:06Z", "type": "commit"}, {"oid": "b5e41afb774e7b3703f592c705df3b8a3fbe41ca", "url": "https://github.com/nordic-institute/X-Road/commit/b5e41afb774e7b3703f592c705df3b8a3fbe41ca", "message": "XRDDEV-961: Add missing annotations to service", "committedDate": "2020-04-13T11:37:10Z", "type": "commit"}, {"oid": "03268083732dd48388e201cb2028d2d744d2ff8f", "url": "https://github.com/nordic-institute/X-Road/commit/03268083732dd48388e201cb2028d2d744d2ff8f", "message": "XRDDEV-956: Initial service client access rights view implementation", "committedDate": "2020-04-14T06:36:15Z", "type": "commit"}, {"oid": "8329042348b2f8a66fba299c82b00ff854b83ed3", "url": "https://github.com/nordic-institute/X-Road/commit/8329042348b2f8a66fba299c82b00ff854b83ed3", "message": "XRDDEV-961: Clean up", "committedDate": "2020-04-14T06:36:56Z", "type": "commit"}, {"oid": "ecb943fa2c106222c13fc6b12a05ea672974d245", "url": "https://github.com/nordic-institute/X-Road/commit/ecb943fa2c106222c13fc6b12a05ea672974d245", "message": "XRDDEV-961 fix checkstyle issues", "committedDate": "2020-04-14T09:20:25Z", "type": "commit"}, {"oid": "ab87d793d9518333567a8cc06676e9306b249de4", "url": "https://github.com/nordic-institute/X-Road/commit/ab87d793d9518333567a8cc06676e9306b249de4", "message": "XRDDEV-961: Add functionality for getting a single service client", "committedDate": "2020-04-14T15:11:22Z", "type": "commit"}, {"oid": "52035df8602959f62a3c8ba3071cff133c8937af", "url": "https://github.com/nordic-institute/X-Road/commit/52035df8602959f62a3c8ba3071cff133c8937af", "message": "Merge branch 'XRDDEV-961_XRDDEV-956' of github.com:nordic-institute/X-Road into XRDDEV-961_XRDDEV-956", "committedDate": "2020-04-14T15:11:38Z", "type": "commit"}, {"oid": "43b125942da51dcc32928680f140c4d3d355fe91", "url": "https://github.com/nordic-institute/X-Road/commit/43b125942da51dcc32928680f140c4d3d355fe91", "message": "XRDDEV-956: UI implementation for service client access rights", "committedDate": "2020-04-14T17:12:25Z", "type": "commit"}, {"oid": "f6507d8c9482e39af4ffa3a663e0090071559b3e", "url": "https://github.com/nordic-institute/X-Road/commit/f6507d8c9482e39af4ffa3a663e0090071559b3e", "message": "XRDDEV-961: Add missing license declarations", "committedDate": "2020-04-15T05:19:37Z", "type": "commit"}, {"oid": "53fdebf4095155cf1910d237c927f6167aea39d2", "url": "https://github.com/nordic-institute/X-Road/commit/53fdebf4095155cf1910d237c927f6167aea39d2", "message": "XRDDEV-963 add controller method, service client parameter processing. Tests fail.", "committedDate": "2020-04-15T13:15:47Z", "type": "commit"}, {"oid": "71813774778cb315d16f7d8f0c567a0d5dae4a3b", "url": "https://github.com/nordic-institute/X-Road/commit/71813774778cb315d16f7d8f0c567a0d5dae4a3b", "message": "XRDDEV-961: Add tests and api for fetching a single service clients", "committedDate": "2020-04-16T06:30:00Z", "type": "commit"}, {"oid": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "url": "https://github.com/nordic-institute/X-Road/commit/bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "message": "XRDDEV-956: Add fetching service client to fill missing data to to UI", "committedDate": "2020-04-16T06:31:18Z", "type": "commit"}, {"oid": "6f03eb102a0f6ec366a0ffbc9434f3a34cfc7baf", "url": "https://github.com/nordic-institute/X-Road/commit/6f03eb102a0f6ec366a0ffbc9434f3a34cfc7baf", "message": "XRDDEV-961: Refactoring:\n\nExtract blocks of code to method to tackle an issue with cognitive complexity reported by Sonarqube", "committedDate": "2020-04-16T09:23:18Z", "type": "commit"}, {"oid": "9f0c23fe193b1b0b3a53b98064863a779a2e31fe", "url": "https://github.com/nordic-institute/X-Road/commit/9f0c23fe193b1b0b3a53b98064863a779a2e31fe", "message": "XRDDEV-956: UI fixes\n\nAdd data-test attributes\nAdd bind keys to v-for clauses", "committedDate": "2020-04-16T09:55:47Z", "type": "commit"}, {"oid": "b568a2c828acd6b1ab1fd4691274d54b255c0e4a", "url": "https://github.com/nordic-institute/X-Road/commit/b568a2c828acd6b1ab1fd4691274d54b255c0e4a", "message": "XRDDEV-961: break too long lines", "committedDate": "2020-04-16T10:03:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM0NjMxNg==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409346316", "bodyText": "Comment seems to be off", "author": "jansu76", "createdAt": "2020-04-16T07:41:37Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/converter/ServiceClientIdentifierConverter.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.niis.xroad.restapi.converter;\n+\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.common.identifier.GlobalGroupId;\n+\n+import com.google.common.collect.Streams;\n+import org.apache.commons.lang3.StringUtils;\n+import org.niis.xroad.restapi.dto.ServiceClientIdentifierDto;\n+import org.niis.xroad.restapi.openapi.BadRequestException;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * converter for ServiceClient and related objects", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUxMDE4Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409510186", "bodyText": "What do you mean comment is off?", "author": "TJaakkola", "createdAt": "2020-04-16T12:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM0NjMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUxMTc1Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409511756", "bodyText": "Just that it is specifically converter for service client identifiers and nothing else, not \"ServiceClient and related objects\".\nIt is copypaste from ServiceClientConverter by yours truly, I think.", "author": "jansu76", "createdAt": "2020-04-16T12:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM0NjMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE3MDYzOQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r410170639", "bodyText": "Ah yes, it is your code, yes :)\nChanged to 'Converter for ServiceClient'", "author": "TJaakkola", "createdAt": "2020-04-17T11:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM0NjMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MDUxMA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409350510", "bodyText": "These should be needless since AccessRight does not contain them. But branch https://github.com/nordic-institute/X-Road/tree/XRDDEV-963-add-service-client-access-rights does remove them.", "author": "jansu76", "createdAt": "2020-04-16T07:48:46Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/dto/ServiceClientAccessRightDto.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.dto;\n+\n+import lombok.Builder;\n+import lombok.Getter;\n+\n+import java.time.OffsetDateTime;\n+\n+@Builder\n+@Getter\n+/**\n+ * Access rights are given to a specific subject, for services owned by some client.\n+ * ServiceClientAccessRightDto.clientId is id of the service owner\n+ * (not the subject id)\n+ */\n+public class ServiceClientAccessRightDto {\n+    private String id;\n+    private String clientId;", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUxMDM3MA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409510370", "bodyText": "Yes, noticed this. No changes done.", "author": "TJaakkola", "createdAt": "2020-04-16T12:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MDUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM2Mjg5OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409362899", "bodyText": "I think it would be a bit better design to have\npublic List<ServiceClientAccessRightDto> getServiceClientAccessRights(ClientId clientid, XRoadId serviceClientId) \ninstead of\npublic List<ServiceClientAccessRightDto> getServiceClientAccessRights(ClientId clientid,            ServiceClientIdentifierDto serviceClientId)\nServiceClientIdentifierDto -> XRoadId lookup could be handled by a private method in controller implementing the same logic as addServiceClientAccessRights now has\n        XRoadId serviceClientId = dto.getXRoadId();\n        if (dto.isLocalGroup()) {\n            try {\n                serviceClientId = localGroupService.getLocalGroupIdAsXroadId(dto.getLocalGroupId());\n            } catch (LocalGroupNotFoundException e) {\n                throw new ResourceNotFoundException(e);\n            }\n        }\n\n\nThat way service method would be a bit cleaner IMO, getServiceClient and getServiceClientAccessRights and addServiceClientAccessRights would follow same approach, and service methods would have less \"special case exceptions\" for local groups.\nInstead of private method in controller, it could also be a method in ServiceClientService.", "author": "jansu76", "createdAt": "2020-04-16T08:09:03Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -527,10 +544,70 @@ private ClientType getClientType(String encodedId) {\n         List<ServiceClient> serviceClients = null;\n         try {\n             serviceClients = serviceClientConverter.\n-                    convertAccessRightHolderDtos(accessRightService.getAccessRightHoldersByClient(clientId));\n+                    convertServiceClientDtos(serviceClientService.getServiceClientsByClient(clientId));\n         } catch (ClientNotFoundException e) {\n             throw new ResourceNotFoundException(e);\n         }\n         return new ResponseEntity<>(serviceClients, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('VIEW_CLIENT_ACL_SUBJECTS')\")\n+    public ResponseEntity<ServiceClient> getServiceClient(String id, String scId) {\n+        ClientId clientIdentifier = clientConverter.convertId(id);\n+        ServiceClientIdentifierDto serviceClientIdentifierDto = serviceClientIdentifierConverter.convertId(scId);\n+        ServiceClient serviceClient = null;\n+        try {\n+            serviceClient = serviceClientConverter.convertServiceClientDto(\n+                    serviceClientService.getServiceClient(clientIdentifier, serviceClientIdentifierDto));\n+        } catch (ClientNotFoundException | ServiceClientNotFoundException e) {\n+            throw new BadRequestException(e);\n+        }\n+\n+        return new ResponseEntity<>(serviceClient, HttpStatus.OK);\n+    }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('VIEW_ACL_SUBJECT_OPEN_SERVICES')\")\n+    public ResponseEntity<List<AccessRight>> getServiceClientAccessRights(String id, String scId) {\n+        ClientId clientIdentifier = clientConverter.convertId(id);\n+        ServiceClientIdentifierDto serviceClientIdentifierDto = serviceClientIdentifierConverter.convertId(scId);\n+        List<AccessRight> accessRights = null;\n+        try {\n+            accessRights = accessRightConverter.convert(\n+                    serviceClientService.getServiceClientAccessRights(clientIdentifier, serviceClientIdentifierDto));", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUzOTk4NA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409539984", "bodyText": "Refactored as suggested. Moved the converter-method to ServiceClientService.", "author": "TJaakkola", "createdAt": "2020-04-16T13:06:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM2Mjg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM2MzQ3NA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409363474", "bodyText": "See comment on getServiceClientAccessRights for dto handling", "author": "jansu76", "createdAt": "2020-04-16T08:09:59Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -527,10 +544,70 @@ private ClientType getClientType(String encodedId) {\n         List<ServiceClient> serviceClients = null;\n         try {\n             serviceClients = serviceClientConverter.\n-                    convertAccessRightHolderDtos(accessRightService.getAccessRightHoldersByClient(clientId));\n+                    convertServiceClientDtos(serviceClientService.getServiceClientsByClient(clientId));\n         } catch (ClientNotFoundException e) {\n             throw new ResourceNotFoundException(e);\n         }\n         return new ResponseEntity<>(serviceClients, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('VIEW_CLIENT_ACL_SUBJECTS')\")\n+    public ResponseEntity<ServiceClient> getServiceClient(String id, String scId) {\n+        ClientId clientIdentifier = clientConverter.convertId(id);\n+        ServiceClientIdentifierDto serviceClientIdentifierDto = serviceClientIdentifierConverter.convertId(scId);\n+        ServiceClient serviceClient = null;\n+        try {\n+            serviceClient = serviceClientConverter.convertServiceClientDto(\n+                    serviceClientService.getServiceClient(clientIdentifier, serviceClientIdentifierDto));", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2Mjc3NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409562775", "bodyText": "Did the same as in the other ServiceClientIdentifierDto -> XRoadId comment", "author": "TJaakkola", "createdAt": "2020-04-16T13:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM2MzQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MDM3OA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409450378", "bodyText": "I think:\nClientNotFoundException should be a ResourceNotFoundException since client id is part of the resource path.\nLocalGroupNotFoundException should also be a ResourceNotFoundException for the same reason (service client id with nonexistend local group id is part of the resource path)\nBesides LocalGroupNotFoundException, also other non-existent service client ids (global groups, subsystems) should throw ResourceNotFoundExceptions to be consistent with local groups. So their existence should be checked. AccessRightService has a private verifyServiceClientIdentifiersExist for this purpose in branch XRDDEV-963-add-service-client-access-rights. A different approach, which is used in serviceClientService.getServiceClient, is probably also fine.\nIf existence is not checked, GET /clients/{id}/service-clients/{sc_id}/access-rights will return empty list for global group sc_id = FI:h\u00f6r\u00f6nl\u00f6r\u00f6 (if that does not exist) which is different from how getServiceClient and addServiceClientAccessRights work (both throw exceptions for sc_id FI:h\u00f6r\u00f6nl\u00f6r\u00f6). Although all of those three methods handle service clients in a different way and in some sense different semantics for \"missing service client\" could also be argued, I guess.", "author": "jansu76", "createdAt": "2020-04-16T10:27:29Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -527,10 +544,70 @@ private ClientType getClientType(String encodedId) {\n         List<ServiceClient> serviceClients = null;\n         try {\n             serviceClients = serviceClientConverter.\n-                    convertAccessRightHolderDtos(accessRightService.getAccessRightHoldersByClient(clientId));\n+                    convertServiceClientDtos(serviceClientService.getServiceClientsByClient(clientId));\n         } catch (ClientNotFoundException e) {\n             throw new ResourceNotFoundException(e);\n         }\n         return new ResponseEntity<>(serviceClients, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('VIEW_CLIENT_ACL_SUBJECTS')\")\n+    public ResponseEntity<ServiceClient> getServiceClient(String id, String scId) {\n+        ClientId clientIdentifier = clientConverter.convertId(id);\n+        ServiceClientIdentifierDto serviceClientIdentifierDto = serviceClientIdentifierConverter.convertId(scId);\n+        ServiceClient serviceClient = null;\n+        try {\n+            serviceClient = serviceClientConverter.convertServiceClientDto(\n+                    serviceClientService.getServiceClient(clientIdentifier, serviceClientIdentifierDto));\n+        } catch (ClientNotFoundException | ServiceClientNotFoundException e) {\n+            throw new BadRequestException(e);\n+        }\n+\n+        return new ResponseEntity<>(serviceClient, HttpStatus.OK);\n+    }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('VIEW_ACL_SUBJECT_OPEN_SERVICES')\")\n+    public ResponseEntity<List<AccessRight>> getServiceClientAccessRights(String id, String scId) {\n+        ClientId clientIdentifier = clientConverter.convertId(id);\n+        ServiceClientIdentifierDto serviceClientIdentifierDto = serviceClientIdentifierConverter.convertId(scId);\n+        List<AccessRight> accessRights = null;\n+        try {\n+            accessRights = accessRightConverter.convert(\n+                    serviceClientService.getServiceClientAccessRights(clientIdentifier, serviceClientIdentifierDto));\n+        } catch (ClientNotFoundException | LocalGroupNotFoundException e) {", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5MzQxMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409593411", "bodyText": "ClientNotFoundException -> ResourceNotFoundException done", "author": "TJaakkola", "createdAt": "2020-04-16T14:17:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MDM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNDY0MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409714641", "bodyText": "I think the fix went to a bit of wrong direction.\nServiceClientService.getServiceClientAccessRights should not throw openapi.ResourceNotFoundException, as that is reserved for openapi layer (controllers) only. Before the fix it threw\nClientNotFoundException, LocalGroupNotFoundException\nLocalGroupNotFoundException was thrown if local group with given ID did not exist, when service client was type LOCALGROUP. Similar thing should happen if service client is GLOBALGROUP or SUBSYSTEM type, and id was something that does not exist. To fix the FI:h\u00f6r\u00f6nl\u00f6r\u00f6 case and to work consistently for all service client types (same end result for bad globalgroup/subsystem as for localgroup). There's at least those options mentioned in my earlier comment, to do that.\nSo I think ServiceClientService.getServiceClientAccessRights should throw\nClientNotFoundException, ServiceClientNotFoundException\nand ServiceClientNotFoundException should cover all 3 types. Both exceptions then should be wrapped as ResourceNotFoundException in the controller.", "author": "jansu76", "createdAt": "2020-04-16T17:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MDM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDAwMg==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r410370002", "bodyText": "Hmm.. I think that due to the changes made to passing parameters to ServiceClientService.getServiceClientAccessRights (serviceClientId is passed as XRoadId). It should be clear by then that there shouldn't be need to handle what type of XRoadId was passed? Instead LocalGroupNotFoundException and ServiceClientNotFoundException are thrown from ServiceClientService.convertServiceClientIdentifierDtoToXroadId.", "author": "TJaakkola", "createdAt": "2020-04-17T17:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MDM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMyNjM0Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r411326346", "bodyText": "I could be mistaken, but I don't think ServiceClientService.convertServiceClientIdentifierDtoToXroadId solves this yet. Now GET  /clients/{id}/service-clients/{sc_id}/access-rights works like this\n\nlocal group does not belong to the client - no exception, empty list\nlocal group with given id does not exist - LocalGroupNotFoundException -> 404\nglobal group with given id does not exist - no exception, empty list\nsubsystem with given id does not exist - no exception, empty list\n\nCompare that to POST /clients/{id}/service-clients/{sc_id}/access-rights or POST /clients/{id}/service-clients/{sc_id}/access-rights/delete, they work like this\n\nlocal group does not belong to the client -> 404\nlocal group with given id does not exist -> 404\nglobal group with given id does not exist -> 404\nsubsystem with given id does not exist -> 404\n\nDifferent service client types (local group / global group / subsystem) should work consistently.\nConsistent behavior between service client types and two latter endpoints could easily be done by calling this method https://github.com/nordic-institute/X-Road/blob/XRDDEV-962-remove-service-client-access-rights/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/AccessRightService.java#L589-L613. It's on a different branch but should not be very likely to change, could get away with just a copy paste to your branch?", "author": "jansu76", "createdAt": "2020-04-20T12:11:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MDM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQwMTQwMw==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r411401403", "bodyText": "That sounds better. But shouldn't method that verifies service client XRoadIds do exist reside in ServiceClientService instead of AccessRightService?", "author": "TJaakkola", "createdAt": "2020-04-20T14:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MDM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAyMjgyMg==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r412022822", "bodyText": "Yeah, I think that is better place for it. Good point.", "author": "jansu76", "createdAt": "2020-04-21T09:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MDM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MTQ0NA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409451444", "bodyText": "Both ClientNotFoundException and ServiceClientNotFoundException should be a ResourceNotFoundException since ids are parts of the resource path", "author": "jansu76", "createdAt": "2020-04-16T10:29:27Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -527,10 +544,70 @@ private ClientType getClientType(String encodedId) {\n         List<ServiceClient> serviceClients = null;\n         try {\n             serviceClients = serviceClientConverter.\n-                    convertAccessRightHolderDtos(accessRightService.getAccessRightHoldersByClient(clientId));\n+                    convertServiceClientDtos(serviceClientService.getServiceClientsByClient(clientId));\n         } catch (ClientNotFoundException e) {\n             throw new ResourceNotFoundException(e);\n         }\n         return new ResponseEntity<>(serviceClients, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('VIEW_CLIENT_ACL_SUBJECTS')\")\n+    public ResponseEntity<ServiceClient> getServiceClient(String id, String scId) {\n+        ClientId clientIdentifier = clientConverter.convertId(id);\n+        ServiceClientIdentifierDto serviceClientIdentifierDto = serviceClientIdentifierConverter.convertId(scId);\n+        ServiceClient serviceClient = null;\n+        try {\n+            serviceClient = serviceClientConverter.convertServiceClientDto(\n+                    serviceClientService.getServiceClient(clientIdentifier, serviceClientIdentifierDto));\n+        } catch (ClientNotFoundException | ServiceClientNotFoundException e) {", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2NzAxNA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409567014", "bodyText": "Fixed.", "author": "TJaakkola", "createdAt": "2020-04-16T13:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNTk4OA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409715988", "bodyText": "See earlier comment, I meant service should continue to throw them as ClientNotFoundException and ServiceClientNotFoundException, but controller should then wrap those in ResourceNotFoundException, instead of BadRequestException. Sorry for unclear comment.", "author": "jansu76", "createdAt": "2020-04-16T17:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MTA4OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r410371089", "bodyText": "Fixed vol. 2", "author": "TJaakkola", "createdAt": "2020-04-17T17:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MTQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MzE0OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409463149", "bodyText": "Would using naming such as \"owner\" instead of generic \"client\" make the method easier to understand? Or \"serviceOwner\"? For method name, or parameter name, or both? Since service clients can also have a \"client\" (service client subject) this can get a bit confusing.", "author": "jansu76", "createdAt": "2020-04-16T10:50:17Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceClientService.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.conf.serverconf.model.AccessRightType;\n+import ee.ria.xroad.common.conf.serverconf.model.ClientType;\n+import ee.ria.xroad.common.conf.serverconf.model.EndpointType;\n+import ee.ria.xroad.common.conf.serverconf.model.ServiceType;\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.common.identifier.XRoadId;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.dto.ServiceClientAccessRightDto;\n+import org.niis.xroad.restapi.dto.ServiceClientDto;\n+import org.niis.xroad.restapi.dto.ServiceClientIdentifierDto;\n+import org.niis.xroad.restapi.repository.ClientRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import javax.transaction.Transactional;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+@Service\n+@Transactional\n+@PreAuthorize(\"isAuthenticated()\")\n+public class ServiceClientService {\n+\n+    private final ClientRepository clientRepository;\n+    private final ServiceService serviceService;\n+    private final EndpointService endpointService;\n+    private final AccessRightService accessRightService;\n+    private final LocalGroupService localGroupService;\n+\n+    public ServiceClientService(ClientRepository clientRepository, ServiceService serviceService,\n+            EndpointService endpointService, AccessRightService accessRightService,\n+            LocalGroupService localGroupService) {\n+        this.clientRepository = clientRepository;\n+        this.serviceService = serviceService;\n+        this.endpointService = endpointService;\n+        this.accessRightService = accessRightService;\n+        this.localGroupService = localGroupService;\n+    }\n+\n+    /**\n+     * Get access right holders (serviceClients) by Client (service owner)\n+     *\n+     * The concept of base endpoint is used to find service level access rights in this method.\n+     * Base endpoint is in other words service (code) level endpoint.\n+     * Each service has one base endpoint.\n+     * Base endpoint has method '*' and path '**'.\n+     *\n+     * @param clientId\n+     * @return\n+     * @throws ClientNotFoundException\n+     *\n+     */\n+    public List<ServiceClientDto> getServiceClientsByClient(ClientId clientId)", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5MDMzMg==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409590332", "bodyText": "Renamed Client clientId in method declarations to Client ownerId and used ClientType owner in method implementation.", "author": "TJaakkola", "createdAt": "2020-04-16T14:14:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MzE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MzcyMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409463721", "bodyText": "comments in ClientsApiController, but these could operate on XRoadIds instead of ServiceClientIdentifierDtos", "author": "jansu76", "createdAt": "2020-04-16T10:51:27Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceClientService.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.conf.serverconf.model.AccessRightType;\n+import ee.ria.xroad.common.conf.serverconf.model.ClientType;\n+import ee.ria.xroad.common.conf.serverconf.model.EndpointType;\n+import ee.ria.xroad.common.conf.serverconf.model.ServiceType;\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.common.identifier.XRoadId;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.dto.ServiceClientAccessRightDto;\n+import org.niis.xroad.restapi.dto.ServiceClientDto;\n+import org.niis.xroad.restapi.dto.ServiceClientIdentifierDto;\n+import org.niis.xroad.restapi.repository.ClientRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import javax.transaction.Transactional;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+@Service\n+@Transactional\n+@PreAuthorize(\"isAuthenticated()\")\n+public class ServiceClientService {\n+\n+    private final ClientRepository clientRepository;\n+    private final ServiceService serviceService;\n+    private final EndpointService endpointService;\n+    private final AccessRightService accessRightService;\n+    private final LocalGroupService localGroupService;\n+\n+    public ServiceClientService(ClientRepository clientRepository, ServiceService serviceService,\n+            EndpointService endpointService, AccessRightService accessRightService,\n+            LocalGroupService localGroupService) {\n+        this.clientRepository = clientRepository;\n+        this.serviceService = serviceService;\n+        this.endpointService = endpointService;\n+        this.accessRightService = accessRightService;\n+        this.localGroupService = localGroupService;\n+    }\n+\n+    /**\n+     * Get access right holders (serviceClients) by Client (service owner)\n+     *\n+     * The concept of base endpoint is used to find service level access rights in this method.\n+     * Base endpoint is in other words service (code) level endpoint.\n+     * Each service has one base endpoint.\n+     * Base endpoint has method '*' and path '**'.\n+     *\n+     * @param clientId\n+     * @return\n+     * @throws ClientNotFoundException\n+     *\n+     */\n+    public List<ServiceClientDto> getServiceClientsByClient(ClientId clientId)\n+            throws ClientNotFoundException {\n+        ClientType clientType = clientRepository.getClient(clientId);\n+        if (clientType == null) {\n+            throw new ClientNotFoundException(\"Client \" + clientId.toShortString() + \" not found\");\n+        }\n+\n+        // Filter just acls that are set to base endpoints so they are on service code level\n+        List<AccessRightType> serviceCodeLevelAcls = clientType.getAcl().stream()\n+                .filter(acl -> acl.getEndpoint().isBaseEndpoint())\n+                .collect(Collectors.toList());\n+        List<AccessRightType> distinctAccessRightTypes = distinctAccessRightTypeByXroadId(serviceCodeLevelAcls);\n+        return accessRightService.mapAccessRightsToServiceClients(clientType, distinctAccessRightTypes);\n+    }\n+\n+    // Get unique AccessRightTypes from the given list\n+    private List<AccessRightType> distinctAccessRightTypeByXroadId(List<AccessRightType> acls) {\n+        HashMap<XRoadId, AccessRightType> uniqueServiceClientMap = new HashMap<>();\n+        for (AccessRightType acl : acls) {\n+            if (!uniqueServiceClientMap.containsKey(acl.getSubjectId())) {\n+                uniqueServiceClientMap.put(acl.getSubjectId(), acl);\n+            }\n+        }\n+        return new ArrayList(uniqueServiceClientMap.values());\n+    }\n+\n+    /**\n+     * Get single service client\n+     *\n+     * @param clientId\n+     * @param dto\n+     * @return\n+     * @throws ClientNotFoundException if client with given id is not found\n+     * @throws ServiceClientNotFoundException if service client with given parameters is not found\n+     */\n+    public ServiceClientDto getServiceClient(ClientId clientId, ServiceClientIdentifierDto dto)", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU3Mjk0NA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409572944", "bodyText": "Fix'd", "author": "TJaakkola", "createdAt": "2020-04-16T13:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MzcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3MTgzNw==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409471837", "bodyText": "private final LocalGroupRepository localGroupRepository is unused", "author": "jansu76", "createdAt": "2020-04-16T11:06:32Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/AccessRightService.java", "diffHunk": "@@ -78,147 +79,23 @@\n     private final ServiceService serviceService;\n     private final IdentifierService identifierService;\n     private final GlobalConfService globalConfService;\n-    private final EndpointRepository endpointRepository;\n     private final EndpointService endpointService;\n+    private final LocalGroupService localGroupService;\n \n     @Autowired\n     public AccessRightService(LocalGroupRepository localGroupRepository, GlobalConfFacade globalConfFacade,\n             ClientRepository clientRepository, ServiceService serviceService, IdentifierService identifierService,\n-            GlobalConfService globalConfService, EndpointRepository endpointRepository,\n-            EndpointService endpointService) {\n+            GlobalConfService globalConfService,", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2MzI1NA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409563254", "bodyText": "Removed", "author": "TJaakkola", "createdAt": "2020-04-16T13:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3MTgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3NDA0Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409474043", "bodyText": "Sonar claims this is not tested, maybe consider testing?\nhttps://sonarqube.niis.org/component_measures?id=xroad&metric=new_coverage&pullRequest=464&selected=xroad%3Aproxy-ui-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fniis%2Fxroad%2Frestapi%2Fservice%2FServiceClientService.java", "author": "jansu76", "createdAt": "2020-04-16T11:10:49Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceClientService.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.conf.serverconf.model.AccessRightType;\n+import ee.ria.xroad.common.conf.serverconf.model.ClientType;\n+import ee.ria.xroad.common.conf.serverconf.model.EndpointType;\n+import ee.ria.xroad.common.conf.serverconf.model.ServiceType;\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.common.identifier.XRoadId;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.dto.ServiceClientAccessRightDto;\n+import org.niis.xroad.restapi.dto.ServiceClientDto;\n+import org.niis.xroad.restapi.dto.ServiceClientIdentifierDto;\n+import org.niis.xroad.restapi.repository.ClientRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import javax.transaction.Transactional;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+@Service\n+@Transactional\n+@PreAuthorize(\"isAuthenticated()\")\n+public class ServiceClientService {\n+\n+    private final ClientRepository clientRepository;\n+    private final ServiceService serviceService;\n+    private final EndpointService endpointService;\n+    private final AccessRightService accessRightService;\n+    private final LocalGroupService localGroupService;\n+\n+    public ServiceClientService(ClientRepository clientRepository, ServiceService serviceService,\n+            EndpointService endpointService, AccessRightService accessRightService,\n+            LocalGroupService localGroupService) {\n+        this.clientRepository = clientRepository;\n+        this.serviceService = serviceService;\n+        this.endpointService = endpointService;\n+        this.accessRightService = accessRightService;\n+        this.localGroupService = localGroupService;\n+    }\n+\n+    /**\n+     * Get access right holders (serviceClients) by Client (service owner)\n+     *\n+     * The concept of base endpoint is used to find service level access rights in this method.\n+     * Base endpoint is in other words service (code) level endpoint.\n+     * Each service has one base endpoint.\n+     * Base endpoint has method '*' and path '**'.\n+     *\n+     * @param clientId\n+     * @return\n+     * @throws ClientNotFoundException\n+     *\n+     */\n+    public List<ServiceClientDto> getServiceClientsByClient(ClientId clientId)\n+            throws ClientNotFoundException {\n+        ClientType clientType = clientRepository.getClient(clientId);\n+        if (clientType == null) {\n+            throw new ClientNotFoundException(\"Client \" + clientId.toShortString() + \" not found\");\n+        }\n+\n+        // Filter just acls that are set to base endpoints so they are on service code level\n+        List<AccessRightType> serviceCodeLevelAcls = clientType.getAcl().stream()\n+                .filter(acl -> acl.getEndpoint().isBaseEndpoint())\n+                .collect(Collectors.toList());\n+        List<AccessRightType> distinctAccessRightTypes = distinctAccessRightTypeByXroadId(serviceCodeLevelAcls);\n+        return accessRightService.mapAccessRightsToServiceClients(clientType, distinctAccessRightTypes);\n+    }\n+\n+    // Get unique AccessRightTypes from the given list\n+    private List<AccessRightType> distinctAccessRightTypeByXroadId(List<AccessRightType> acls) {\n+        HashMap<XRoadId, AccessRightType> uniqueServiceClientMap = new HashMap<>();\n+        for (AccessRightType acl : acls) {\n+            if (!uniqueServiceClientMap.containsKey(acl.getSubjectId())) {\n+                uniqueServiceClientMap.put(acl.getSubjectId(), acl);\n+            }\n+        }\n+        return new ArrayList(uniqueServiceClientMap.values());\n+    }\n+\n+    /**\n+     * Get single service client\n+     *\n+     * @param clientId\n+     * @param dto\n+     * @return\n+     * @throws ClientNotFoundException if client with given id is not found\n+     * @throws ServiceClientNotFoundException if service client with given parameters is not found\n+     */\n+    public ServiceClientDto getServiceClient(ClientId clientId, ServiceClientIdentifierDto dto)\n+            throws ClientNotFoundException, ServiceClientNotFoundException {\n+        List<ServiceClientDto> serviceClientsByClient = getServiceClientsByClient(clientId);\n+        return serviceClientsByClient.stream()\n+            .filter(scDto -> dto.isLocalGroup()\n+                    ? dto.getLocalGroupId().toString().equals(scDto.getLocalGroupId())\n+                    : dto.getXRoadId().equals(scDto.getSubjectId()))\n+            .findFirst()\n+            .orElseThrow(() -> {\n+                String serviceClientIdentifier = dto.isLocalGroup()\n+                        ? \"Localgroup id: \" + dto.getLocalGroupId()\n+                        : \"xRoadId: \" + dto.getXRoadId().toShortString();\n+                return new ServiceClientNotFoundException(\"Service client not found for ClientId: \"\n+                        + clientId.toShortString() + \" and \" + serviceClientIdentifier);\n+            });", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxNDU4OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r410314589", "bodyText": "Added a test for testing searching a service client from a client that doesn't contain it.", "author": "TJaakkola", "createdAt": "2020-04-17T15:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3NDA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3OTc4NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409479785", "bodyText": "Now that I read the code, I find it pretty confusing that this dto has localGroupDescription and memberName (which is not used in ServiceClientConverter, though) but no global group description.\nOf course it is not a product of this ticket.", "author": "jansu76", "createdAt": "2020-04-16T11:21:53Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/dto/ServiceClientDto.java", "diffHunk": "@@ -31,10 +31,10 @@\n import java.time.OffsetDateTime;\n \n /**\n- * DTO for Service and ServiceClient access rights\n+ * DTO for ServiceClient data\n  */\n @Data\n-public class AccessRightHolderDto {\n+public class ServiceClientDto {", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2MzQzOA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409563438", "bodyText": "No changes done.", "author": "TJaakkola", "createdAt": "2020-04-16T13:39:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3OTc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4NzY2Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409487666", "bodyText": "FYI old implementation gives frontend also boolean has_services\n    render_json({\n      :acl_subjects => read_acl_subjects(client),\n      :has_services => has_services\n    })\n\n\nFrontend has some logic that uses that, it disables the wizard, or parts of wizard based on that info. Probably needs to be taken into account when doing the frontend ticket for add service client access rights?", "author": "jansu76", "createdAt": "2020-04-16T11:37:09Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -527,10 +544,70 @@ private ClientType getClientType(String encodedId) {\n         List<ServiceClient> serviceClients = null;\n         try {\n             serviceClients = serviceClientConverter.\n-                    convertAccessRightHolderDtos(accessRightService.getAccessRightHoldersByClient(clientId));\n+                    convertServiceClientDtos(serviceClientService.getServiceClientsByClient(clientId));\n         } catch (ClientNotFoundException e) {\n             throw new ResourceNotFoundException(e);\n         }\n         return new ResponseEntity<>(serviceClients, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('VIEW_CLIENT_ACL_SUBJECTS')\")\n+    public ResponseEntity<ServiceClient> getServiceClient(String id, String scId) {", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2NjA2Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409566062", "bodyText": "This could also be handled in the frontend as it's only empty array -check. What do you think?", "author": "TJaakkola", "createdAt": "2020-04-16T13:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4NzY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4NDY4NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409684685", "bodyText": "Not sure if it is just empty array -check (doesn't it mean a call to /clients/{id}/service-descriptions and then iterating ServiceDescriptions -> Services?) - but in any case yes, it is probably better to handle it in the frontend than add some extra baggage to this endpoint.", "author": "jansu76", "createdAt": "2020-04-16T16:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4NzY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDkzMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409490931", "bodyText": "Old implementation sorts by serviceCode, should this one do the same?\n    services.sort! do |x, y|\n      x[:service_code] <=> y[:service_code]\n    end", "author": "jansu76", "createdAt": "2020-04-16T11:43:33Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceClientService.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.conf.serverconf.model.AccessRightType;\n+import ee.ria.xroad.common.conf.serverconf.model.ClientType;\n+import ee.ria.xroad.common.conf.serverconf.model.EndpointType;\n+import ee.ria.xroad.common.conf.serverconf.model.ServiceType;\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.common.identifier.XRoadId;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.dto.ServiceClientAccessRightDto;\n+import org.niis.xroad.restapi.dto.ServiceClientDto;\n+import org.niis.xroad.restapi.dto.ServiceClientIdentifierDto;\n+import org.niis.xroad.restapi.repository.ClientRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import javax.transaction.Transactional;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+@Service\n+@Transactional\n+@PreAuthorize(\"isAuthenticated()\")\n+public class ServiceClientService {\n+\n+    private final ClientRepository clientRepository;\n+    private final ServiceService serviceService;\n+    private final EndpointService endpointService;\n+    private final AccessRightService accessRightService;\n+    private final LocalGroupService localGroupService;\n+\n+    public ServiceClientService(ClientRepository clientRepository, ServiceService serviceService,\n+            EndpointService endpointService, AccessRightService accessRightService,\n+            LocalGroupService localGroupService) {\n+        this.clientRepository = clientRepository;\n+        this.serviceService = serviceService;\n+        this.endpointService = endpointService;\n+        this.accessRightService = accessRightService;\n+        this.localGroupService = localGroupService;\n+    }\n+\n+    /**\n+     * Get access right holders (serviceClients) by Client (service owner)\n+     *\n+     * The concept of base endpoint is used to find service level access rights in this method.\n+     * Base endpoint is in other words service (code) level endpoint.\n+     * Each service has one base endpoint.\n+     * Base endpoint has method '*' and path '**'.\n+     *\n+     * @param clientId\n+     * @return\n+     * @throws ClientNotFoundException\n+     *\n+     */\n+    public List<ServiceClientDto> getServiceClientsByClient(ClientId clientId)\n+            throws ClientNotFoundException {\n+        ClientType clientType = clientRepository.getClient(clientId);\n+        if (clientType == null) {\n+            throw new ClientNotFoundException(\"Client \" + clientId.toShortString() + \" not found\");\n+        }\n+\n+        // Filter just acls that are set to base endpoints so they are on service code level\n+        List<AccessRightType> serviceCodeLevelAcls = clientType.getAcl().stream()\n+                .filter(acl -> acl.getEndpoint().isBaseEndpoint())\n+                .collect(Collectors.toList());\n+        List<AccessRightType> distinctAccessRightTypes = distinctAccessRightTypeByXroadId(serviceCodeLevelAcls);\n+        return accessRightService.mapAccessRightsToServiceClients(clientType, distinctAccessRightTypes);\n+    }\n+\n+    // Get unique AccessRightTypes from the given list\n+    private List<AccessRightType> distinctAccessRightTypeByXroadId(List<AccessRightType> acls) {\n+        HashMap<XRoadId, AccessRightType> uniqueServiceClientMap = new HashMap<>();\n+        for (AccessRightType acl : acls) {\n+            if (!uniqueServiceClientMap.containsKey(acl.getSubjectId())) {\n+                uniqueServiceClientMap.put(acl.getSubjectId(), acl);\n+            }\n+        }\n+        return new ArrayList(uniqueServiceClientMap.values());\n+    }\n+\n+    /**\n+     * Get single service client\n+     *\n+     * @param clientId\n+     * @param dto\n+     * @return\n+     * @throws ClientNotFoundException if client with given id is not found\n+     * @throws ServiceClientNotFoundException if service client with given parameters is not found\n+     */\n+    public ServiceClientDto getServiceClient(ClientId clientId, ServiceClientIdentifierDto dto)\n+            throws ClientNotFoundException, ServiceClientNotFoundException {\n+        List<ServiceClientDto> serviceClientsByClient = getServiceClientsByClient(clientId);\n+        return serviceClientsByClient.stream()\n+            .filter(scDto -> dto.isLocalGroup()\n+                    ? dto.getLocalGroupId().toString().equals(scDto.getLocalGroupId())\n+                    : dto.getXRoadId().equals(scDto.getSubjectId()))\n+            .findFirst()\n+            .orElseThrow(() -> {\n+                String serviceClientIdentifier = dto.isLocalGroup()\n+                        ? \"Localgroup id: \" + dto.getLocalGroupId()\n+                        : \"xRoadId: \" + dto.getXRoadId().toShortString();\n+                return new ServiceClientNotFoundException(\"Service client not found for ClientId: \"\n+                        + clientId.toShortString() + \" and \" + serviceClientIdentifier);\n+            });\n+    }\n+\n+    /**\n+     * Get access right holders (serviceClients) by Service\n+     * @param clientId\n+     * @param fullServiceCode\n+     * @return\n+     * @throws ClientNotFoundException if client with given id was not found\n+     * @throws ServiceNotFoundException if service with given fullServicecode was not found\n+     * @throws EndpointNotFoundException if base endpoint for this service is not found from the client\n+     */\n+    public List<ServiceClientDto> getServiceClientsByService(ClientId clientId, String fullServiceCode)\n+            throws ClientNotFoundException, ServiceNotFoundException, EndpointNotFoundException {\n+        ClientType clientType = clientRepository.getClient(clientId);\n+        if (clientType == null) {\n+            throw new ClientNotFoundException(\"Client \" + clientId.toShortString() + \" not found\");\n+        }\n+\n+        ServiceType serviceType = serviceService.getServiceFromClient(clientType, fullServiceCode);\n+        EndpointType endpointType = endpointService.getServiceBaseEndpoint(serviceType);\n+\n+        List<AccessRightType> accessRightsByEndpoint = accessRightService\n+                .getAccessRightsByEndpoint(clientType, endpointType);\n+        return accessRightService.mapAccessRightsToServiceClients(clientType, accessRightsByEndpoint);\n+    }\n+\n+    /**\n+     * Get access right holders (serviceClients) for Endpoint\n+     * @param id\n+     * @return\n+     * @throws EndpointNotFoundException    if no endpoint is found with given id\n+     * @throws ClientNotFoundException      if client attached to endpoint is not found\n+     */\n+    public List<ServiceClientDto> getServiceClientsByEndpoint(Long id)\n+            throws EndpointNotFoundException, ClientNotFoundException {\n+\n+        ClientType clientType = clientRepository.getClientByEndpointId(id);\n+        EndpointType endpointType = endpointService.getEndpoint(id);\n+\n+        List<AccessRightType> accessRightsByEndpoint = accessRightService\n+                .getAccessRightsByEndpoint(clientType, endpointType);\n+        return accessRightService.mapAccessRightsToServiceClients(clientType, accessRightsByEndpoint);\n+    }\n+\n+    /**\n+     * Get service clients access rights to given client\n+     *\n+     * @param clientid\n+     * @param serviceClientId\n+     * @return\n+     * @throws ClientNotFoundException if given client is not found\n+     * @throws LocalGroupNotFoundException if given local group is not found\n+     */\n+    public List<ServiceClientAccessRightDto> getServiceClientAccessRights(ClientId clientid,\n+            ServiceClientIdentifierDto serviceClientId) throws ClientNotFoundException, LocalGroupNotFoundException {\n+        ClientType clientType = clientRepository.getClient(clientid);\n+        if (clientType == null) {\n+            throw new ClientNotFoundException(\"Client not found with id: \" + clientid.toShortString());\n+        }\n+\n+        // Get XRoadId for the given service client\n+        XRoadId scId = serviceClientId.isLocalGroup()\n+                ? localGroupService.getLocalGroupIdAsXroadId(serviceClientId.getLocalGroupId())\n+                : serviceClientId.getXRoadId();\n+\n+        // Filter service clients access rights from the given clients acl-list\n+        return clientType.getAcl().stream()\n+                .filter(acl -> {\n+                    boolean iseq = acl.getSubjectId().equals(scId);\n+                    boolean isBaseEndpoint = acl.getEndpoint().isBaseEndpoint();\n+                    return iseq && isBaseEndpoint;\n+                })\n+                .map(acl -> ServiceClientAccessRightDto.builder()\n+                        .serviceCode(acl.getEndpoint().getServiceCode())\n+                        .rightsGiven(FormatUtils.fromDateToOffsetDateTime(acl.getRightsGiven()))\n+                        .title(getServiceTitle(clientType, acl.getEndpoint().getServiceCode()))\n+                        .build())\n+                .collect(Collectors.toList());\n+    }", "originalCommit": "bc77187ae2d7c56d5a09701f5cc94b8c3c91d3a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2NTE0NA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409565144", "bodyText": "I guess it could but it's easy to do on frontend also, don't know if it is necessary to do here.", "author": "TJaakkola", "createdAt": "2020-04-16T13:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4NTQ1MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r409685451", "bodyText": "It probably is not necessary to do that in backend. Frontend is probably just as good.", "author": "jansu76", "createdAt": "2020-04-16T16:21:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDkzMQ=="}], "type": "inlineReview"}, {"oid": "68cd15de1d8f6a2d0376f7018c9467546fa2f998", "url": "https://github.com/nordic-institute/X-Road/commit/68cd15de1d8f6a2d0376f7018c9467546fa2f998", "message": "XRDDEV-961: Changes according to pull request comments", "committedDate": "2020-04-16T14:36:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAxMDI2OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r410010269", "bodyText": "Just realized one problem. When listing service client(s) for one client, I think we should not return rights_given_at\n    {\n        \"id\": \"85\",\n        \"name\": \"Aston Martin Red Bull Racing\",\n        \"local_group_code\": \"RBR\",\n        \"service_client_type\": \"LOCALGROUP\",\n        \"rights_given_at\": \"2020-04-15T03:46:21.297Z\"\n    },\n\nReason is that we really do not know when the rights were given. Aston Martin Red Bull Racing is a service client for this client's services, but it can be a service client for service A, B and C. distinctAccessRightTypeByXroadId picks AccessRightType given to A, B or C by random. It is possible that serviceclient.rights_given_at should not be 2020-04-15T03:46:21.297Z but maybe 2019-01-01 instead. And it is also possible that returned timestamp changes randomly from request to another.\nWhen listing service client(s) for a client, rights_given_at should be null since we do not know it. On the other hand when listing service client(s) the other way (like /services/{id}/service-clients) we do know the real rights_given_at.\nAlternative to nulling it would be to scan through all AccessRightTypes and pick the earliest timestamp, that would then be the correct value. But I think that is unnecessary, as we do not use that in the UI.", "author": "jansu76", "createdAt": "2020-04-17T06:07:31Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceClientService.java", "diffHunk": "@@ -0,0 +1,252 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.conf.serverconf.model.AccessRightType;\n+import ee.ria.xroad.common.conf.serverconf.model.ClientType;\n+import ee.ria.xroad.common.conf.serverconf.model.EndpointType;\n+import ee.ria.xroad.common.conf.serverconf.model.ServiceType;\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.common.identifier.XRoadId;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.dto.ServiceClientAccessRightDto;\n+import org.niis.xroad.restapi.dto.ServiceClientDto;\n+import org.niis.xroad.restapi.dto.ServiceClientIdentifierDto;\n+import org.niis.xroad.restapi.openapi.ResourceNotFoundException;\n+import org.niis.xroad.restapi.repository.ClientRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import javax.transaction.Transactional;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+@Service\n+@Transactional\n+@PreAuthorize(\"isAuthenticated()\")\n+public class ServiceClientService {\n+\n+    private final ClientRepository clientRepository;\n+    private final ServiceService serviceService;\n+    private final EndpointService endpointService;\n+    private final AccessRightService accessRightService;\n+    private final LocalGroupService localGroupService;\n+\n+    public ServiceClientService(ClientRepository clientRepository, ServiceService serviceService,\n+            EndpointService endpointService, AccessRightService accessRightService,\n+            LocalGroupService localGroupService) {\n+        this.clientRepository = clientRepository;\n+        this.serviceService = serviceService;\n+        this.endpointService = endpointService;\n+        this.accessRightService = accessRightService;\n+        this.localGroupService = localGroupService;\n+    }\n+\n+    /**\n+     * Get access right holders (serviceClients) by Client (service owner)\n+     *\n+     * The concept of base endpoint is used to find service level access rights in this method.\n+     * Base endpoint is in other words service (code) level endpoint.\n+     * Each service has one base endpoint.\n+     * Base endpoint has method '*' and path '**'.\n+     *\n+     * @param ownerId\n+     * @return\n+     * @throws ClientNotFoundException\n+     *\n+     */\n+    public List<ServiceClientDto> getServiceClientsByClient(ClientId ownerId)\n+            throws ClientNotFoundException {\n+        ClientType owner = clientRepository.getClient(ownerId);\n+        if (owner == null) {\n+            throw new ClientNotFoundException(\"Client \" + ownerId.toShortString() + \" not found\");\n+        }\n+\n+        // Filter just acls that are set to base endpoints so they are on service code level\n+        List<AccessRightType> serviceCodeLevelAcls = owner.getAcl().stream()\n+                .filter(acl -> acl.getEndpoint().isBaseEndpoint())\n+                .collect(Collectors.toList());\n+        List<AccessRightType> distinctAccessRightTypes = distinctAccessRightTypeByXroadId(serviceCodeLevelAcls);\n+        return accessRightService.mapAccessRightsToServiceClients(owner, distinctAccessRightTypes);", "originalCommit": "68cd15de1d8f6a2d0376f7018c9467546fa2f998", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI4MzE0OA==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r410283148", "bodyText": "I found a rather easy way to populate the rights_given_at -information with the earliest timestamp. IMO it's better than mapping all those values to null after they've been first populated (which is the other option)", "author": "TJaakkola", "createdAt": "2020-04-17T15:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAxMDI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAyODU3MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/464#discussion_r412028571", "bodyText": "OK, that's nice!", "author": "jansu76", "createdAt": "2020-04-21T09:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAxMDI2OQ=="}], "type": "inlineReview"}, {"oid": "7374a0bfd79c10307e0a38928a536e264622659c", "url": "https://github.com/nordic-institute/X-Road/commit/7374a0bfd79c10307e0a38928a536e264622659c", "message": "XRDDEV-961: Fixes according to pull request comments", "committedDate": "2020-04-17T17:52:26Z", "type": "commit"}, {"oid": "d61b232a30ee4d1ea1ad67e28f713d2c23c006a3", "url": "https://github.com/nordic-institute/X-Road/commit/d61b232a30ee4d1ea1ad67e28f713d2c23c006a3", "message": "XRDDEV-961: Add verification for service client existence. Also fix bug in setting timestamp for getting service client", "committedDate": "2020-04-20T14:33:03Z", "type": "commit"}]}