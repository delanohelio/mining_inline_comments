{"pr_number": 415, "pr_title": "XRDDEV-880 Upload anchor", "pr_createdAt": "2020-03-17T13:55:34Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/415", "timeline": [{"oid": "d50d622ac0fbcaa241ed66d0fc97f41527f66d69", "url": "https://github.com/nordic-institute/X-Road/commit/d50d622ac0fbcaa241ed66d0fc97f41527f66d69", "message": "XRDDEV-880 Upload anchor\n\n* initial service and controller methods\n* API definitions\n* new constructor in ConfigurationAnchorV2", "committedDate": "2020-03-16T10:17:05Z", "type": "commit"}, {"oid": "f76443d7569d900e789ae76ae6d4efa0e6a24ccc", "url": "https://github.com/nordic-institute/X-Road/commit/f76443d7569d900e789ae76ae6d4efa0e6a24ccc", "message": "XRDDEV-880 Upload anchor // verification and saving", "committedDate": "2020-03-16T15:39:01Z", "type": "commit"}, {"oid": "18454cede040164aa27cfcc3e7ef84015621ad38", "url": "https://github.com/nordic-institute/X-Road/commit/18454cede040164aa27cfcc3e7ef84015621ad38", "message": "XRDDEV-880 Upload anchor // cleanup\n\n* still WIP: tests", "committedDate": "2020-03-17T07:50:38Z", "type": "commit"}, {"oid": "16032a21422bf0c29f54f19db147e33228c06276", "url": "https://github.com/nordic-institute/X-Road/commit/16032a21422bf0c29f54f19db147e33228c06276", "message": "XRDDEV-880 Upload anchor // tests", "committedDate": "2020-03-17T12:23:35Z", "type": "commit"}, {"oid": "ca1befc3e91ad4cfb107fb69a71e092452c9c54e", "url": "https://github.com/nordic-institute/X-Road/commit/ca1befc3e91ad4cfb107fb69a71e092452c9c54e", "message": "XRDDEV-880 Upload anchor // checkstyle\n\n* added missing tests for ExternalProcessRunner\n* checkstyler fixes\n* test fixes", "committedDate": "2020-03-17T13:50:52Z", "type": "commit"}, {"oid": "e9c97efc98777f98ac5ffae16fae84bf60f5099f", "url": "https://github.com/nordic-institute/X-Road/commit/e9c97efc98777f98ac5ffae16fae84bf60f5099f", "message": "Merge branch 'develop' into XRDDEV-880-upload-anchor\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/SystemServiceTest.java", "committedDate": "2020-03-24T13:25:14Z", "type": "commit"}, {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "url": "https://github.com/nordic-institute/X-Road/commit/620778fef93c1aa59e19ff7d32c2dbebf76bea80", "message": "Merge branch 'develop' into XRDDEV-880-upload-anchor", "committedDate": "2020-03-26T06:57:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM1NzE4OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398357189", "bodyText": "So it seems that this constructor results in a different kind of ConfigurationAnchorV2 object than the filename-based one. Due to differences in AbstractXmlConf.load(byte[]) and AbstractXmlConf.load(String), one results in an object that has FileContentChangeChecker, other does not.\nThis is probably fine, and it makes sense that byte[] based object does not have a FileContentChangeChecker if you dig into the internals to see it, and the new variant of ConfigurationAnchorV2 object is used in such a way that missing FileContentChangeChecker is what we want - but should be clearly documented in the new ConfigurationAnchorV2 and AbstractXmlConf constructors. \"use this if you want to do X, use other if you want to do Y\". Otherwise someone can think one is a convenience constructor that still creates an identical object, and use the wrong constructor.", "author": "jansu76", "createdAt": "2020-03-26T07:13:46Z", "path": "src/common-util/src/main/java/ee/ria/xroad/common/conf/globalconf/ConfigurationAnchorV2.java", "diffHunk": "@@ -56,6 +56,13 @@ public ConfigurationAnchorV2(String fileName) {\n                 PrivateParametersSchemaValidatorV2.class); // also applies to stand-alone configuration source\n     }\n \n+    /**\n+     * @param fileBytes the configuration anchor file bytes\n+     */\n+    public ConfigurationAnchorV2(byte[] fileBytes) {", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYxMjIxMg==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398612212", "bodyText": "Improved the javadocs for both constructors.", "author": "carohauta", "createdAt": "2020-03-26T14:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM1NzE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2OTM3MA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398369370", "bodyText": "Should throw IOException instead of Exception?", "author": "jansu76", "createdAt": "2020-03-26T07:43:51Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/AnchorRepository.java", "diffHunk": "@@ -69,4 +71,12 @@\n     public ConfigurationAnchorV2 loadAnchorFromFile() {\n         return new ConfigurationAnchorV2(CONFIGURATION_ANCHOR_FILENAME);\n     }\n+\n+    /**\n+     * Save anchor. The replacing of the old anchor file is done atomically.\n+     * @return\n+     */\n+    public void saveAndReplace(File anchorFile) throws Exception {", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMDY2OA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398630668", "bodyText": "It should! Fixed", "author": "carohauta", "createdAt": "2020-03-26T14:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2OTM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3MjQzNg==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398372436", "bodyText": "Nice! \ud83d\udc4d", "author": "jansu76", "createdAt": "2020-03-26T07:50:24Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ConfigurationVerifier.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import lombok.Setter;\n+import org.niis.xroad.restapi.exceptions.ErrorDeviation;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Verify internal and external configurations\n+ */\n+@Component\n+public class ConfigurationVerifier {", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NTYxMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398375611", "bodyText": "Why is ConfigurationVerificationException unchecked? My initial feel was to have it as checked, as validating the contents of the anchor file is a major part of what this method does.\nFirst I commented about if it should be http 400 instead of http 500, but I guess these exceptions are about what happens after global config has been fetched from external source, and that global config is invalid, so 500 is the correct one?", "author": "jansu76", "createdAt": "2020-03-26T07:57:18Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0MTMwNw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398641307", "bodyText": "I was thinking that the request itself was fine but there was something else wrong. Thought that the most important thing is to get the error to the end user to see.\nI guess that this could actually be interpreted either way: as a bad request or internal error. Here are the translations for the different errors that ConfigurationVerificationException can mean:\nanchor_not_for_external_source: \"Anchor points to an internal configuration source. Only external configuration source anchors are supported as trusted anchors\"\nmissing_private_params: \"Configuration anchor import failed: invalid anchor file\"\nunreachable: \"Configuration source cannot be reached, check source URL in uploaded anchor file\"\noutdated: \"Configuration from source is out of date\"\nsignature_invalid: \"Signature of configuration cannot be verified\"\nother: \"Configuration from source failed verification\"\nFor example missing_private_params could mean 400 but other could mean 500. Perhaps split the exception into two exceptions: a checked one and a runtime one?", "author": "carohauta", "createdAt": "2020-03-26T15:00:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NTYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0NDYxNg==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399144616", "bodyText": "Isn't missing_private_params like the others - anchor (such as internal-configuration-anchor.xml) itself was fine (even though old translation says it was invalid. Is the translation misleading?) but when app downloaded the internal configuration, it was corrupted (private params were missing)? So in that sense it would still be 500?\nI kind of feel all of those should still be checked exceptions, just to communicate to the caller that this kind of things can go wrong, be prepared. Even if we will just http 500 them now, some future service could appreciate that when it builds on top of this method. But I am not really 100% on this, if you think runtime exceptions are better for these, go ahed.", "author": "jansu76", "createdAt": "2020-03-27T09:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NTYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMDMxNg==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399320316", "bodyText": "but when app downloaded the internal configuration, it was corrupted (private params were missing)? So in that sense it would still be 500?\n\nDon't know about this. I mean shouldn't the downloading itself be the one failing here already?\n\nI kind of feel all of those should still be checked exceptions, just to communicate to the caller that this kind of things can go wrong, be prepared.\n\nBy this do you mean that all the different cases above (anchor_not_for_external_source, missing_private_params, unreachable etc.) should all actually be their own respected exceptions?", "author": "carohauta", "createdAt": "2020-03-27T14:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NTYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MzQ3NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r402263475", "bodyText": "Don't know about this. I mean shouldn't the downloading itself be the one failing here already?\n\nNot sure, one should read ConfigurationClientMain and verify_internal_configuration carefully to know for sure. For me it looks like missing_private_params could mean both, bad anchor or bad global conf, but I am not sure. If that is so, then maybe http 500 is more correct, if can't know if it is 400 or 500 for sure.\n\nBy this do you mean that all the different cases above (anchor_not_for_external_source, missing_private_params, unreachable etc.) should all actually be their own respected exceptions?\n\nNo I think a shared checked exception class, like ConfigurationVerificationException but changed into checked one, would be enough.", "author": "jansu76", "createdAt": "2020-04-02T12:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NTYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1Nzk0Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r402357946", "bodyText": "It is a checked exception. Just moved the handling to the controller layer and now InternalServerErrorException is explicitly thrown if ConfigurationVerificationException is caught. So basically it is now handled as a http 500 status since it is a bit unclear which one it should be", "author": "carohauta", "createdAt": "2020-04-02T14:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NTYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NjQwMw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398376403", "bodyText": "What happens if client sends a GIF file's bytes as an anchor? It should be http 400 bad request, right?", "author": "jansu76", "createdAt": "2020-03-26T07:58:47Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/SystemApiController.java", "diffHunk": "@@ -215,4 +215,31 @@ public SystemApiController(InternalTlsCertificateService internalTlsCertificateS\n             throw new InternalServerErrorException(new ErrorDeviation(ANCHOR_FILE_NOT_FOUND));\n         }\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('UPLOAD_ANCHOR')\")\n+    public ResponseEntity<Void> uploadAnchor(Resource anchorResource) {\n+        byte[] anchorBytes = ResourceUtils.springResourceToBytesOrThrowBadRequest(anchorResource);\n+        try {\n+            systemService.uploadAnchor(anchorBytes);\n+        } catch (SystemService.InvalidAnchorInstanceException e) {\n+            throw new BadRequestException(e);\n+        } catch (SystemService.AnchorUploadException e) {\n+            throw new InternalServerErrorException(e);\n+        }\n+        return ApiUtil.createCreatedResponse(\"/api/system/anchor\", null);\n+    }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('UPLOAD_ANCHOR')\")\n+    public ResponseEntity<Anchor> previewAnchor(Resource anchorResource) {\n+        byte[] anchorBytes = ResourceUtils.springResourceToBytesOrThrowBadRequest(anchorResource);\n+        AnchorFile anchorFile = null;\n+        try {\n+            anchorFile = systemService.getAnchorFileFromBytes(anchorBytes);\n+        } catch (SystemService.InvalidAnchorInstanceException e) {", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0Nzk0NA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398647944", "bodyText": "It is a CodedException which will be translated to a 500:\n{\n    \"status\": 500,\n    \"error\": {\n        \"code\": \"core.MalformedGlobalConf\",\n        \"metadata\": [\n            \"Content is not allowed in prolog.\"\n        ]\n    }\n}\nThis should be handled so that a 400 is returned instead.", "author": "carohauta", "createdAt": "2020-03-26T15:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NjQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NjcyMA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398666720", "bodyText": "core.MalformedGlobalConf is thrown if the schema validation fails. I would like to add (well I did) an exception named MalformedAnchorException because it is less confusing than MalformedGlobalConf. At least in this case where one tries to upload a configuration anchor.", "author": "carohauta", "createdAt": "2020-03-26T15:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NjQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0NzkyMw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399147923", "bodyText": "Great....and that will now be http 400?", "author": "jansu76", "createdAt": "2020-03-27T09:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NjQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMTM4Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399221386", "bodyText": "Yes it is now considered a 400", "author": "carohauta", "createdAt": "2020-03-27T12:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NjQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQxODIxNA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398418214", "bodyText": "I guess this is \"if exit code is not 0, or if the process times out\"?\nCould even consider different exceptions for these 2 things, but I don't know if it is warranted.", "author": "jansu76", "createdAt": "2020-03-26T09:14:38Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -104,15 +108,40 @@\n             IOUtils.closeQuietly(process.getErrorStream());\n             IOUtils.closeQuietly(process.getOutputStream());\n         }\n+        ProcessResult processResult = new ProcessResult(commandWithArgsString, exitCode, processOutput);\n+        return processResult;\n+    }\n \n+    /**\n+     * Executes the given command with given arguments and throws a {@link ProcessFailedException} if the process' exit\n+     * code is not 0. Used e.g. for simple script execution when there is no need to handle different exit codes\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return {@link ProcessResult} which contains the executed command with arguments, exit code (always 0) and the\n+     * output of the executed process\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA4MTgyMw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399081823", "bodyText": "At this time I would just improve the javadoc. Adding a new exception into the mix will need a lot of refactoring and new tests and quite frankly I think it's not something that should be addressed in the scope of this task. But for sure adding something like a ProcessTimedOutException is something to be considered.", "author": "carohauta", "createdAt": "2020-03-27T07:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQxODIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQzNzk5Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398437997", "bodyText": "old UI creates temp file in SystemProperties::getTempFilesPath. Should this do the same? (io_utils.rb#temp_file)", "author": "jansu76", "createdAt": "2020-03-26T09:45:26Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {\n+            throw new AnchorUploadException(e);\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Cannot upload a new anchor\", e);\n+        } finally {\n+            if (tempAnchor != null) {\n+                tempAnchor.delete();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Create a temporary anchor file on the filesystem. This is needed for verifying the anchor with\n+     * configuration-client module (this might be changed in the future). This method does not delete the created\n+     * temporary file. Remember to delete the file after it is no longer needed.\n+     * @param anchorBytes\n+     * @return temporary anchor file\n+     * @throws IOException\n+     */\n+    private File createTemporaryAnchorFile(byte[] anchorBytes) throws IOException {\n+        String tempAnchorPrefix = \"temp-internal-anchor-\";\n+        String tempAnchorSuffix = \".xml\";\n+        File tempAnchor = File.createTempFile(tempAnchorPrefix, tempAnchorSuffix);", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA4NDM5Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399084397", "bodyText": "Good idea \ud83d\udc4d", "author": "carohauta", "createdAt": "2020-03-27T07:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQzNzk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0MDkzMw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398440933", "bodyText": "Is this step missing? \n  \n    \n      X-Road/src/proxy-ui/app/controllers/sysparams_controller.rb\n    \n    \n         Line 105\n      in\n      5744273\n    \n    \n    \n    \n\n        \n          \n           download_configuration", "author": "jansu76", "createdAt": "2020-03-26T09:50:01Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA4Nzc3Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399087777", "bodyText": "Nice catch! TBH this seems pretty important step \ud83d\ude04", "author": "carohauta", "createdAt": "2020-03-27T07:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0MDkzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2ODY3Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r402268676", "bodyText": "It looks like restTemplate.getForEntity has infinite timeout, so in a bad configuration it could hang forever. Or do you know how that is? Maybe something like a 60s timeout would be better.\nI am not sure how old Ruby implementation does the same. It might not be any better.", "author": "jansu76", "createdAt": "2020-04-02T12:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0MDkzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4MTEyMA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r402781120", "bodyText": "It really does have an infinite timeout by default -> not good. I added a 60s timeout for this request. Also the user gets an error code now if the request itself fails for some reason.\nI actually first added a 15s timeout but the request could possibly (hopefully not though!) take more time in production environment so changed it to 60s. Even in my local dev env the request seems to take about 5+ seconds.", "author": "carohauta", "createdAt": "2020-04-03T07:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0MDkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0NjQ3NA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398446474", "bodyText": "By the way, good choice not adding a new permission for previews \ud83d\udc4d Sometimes we're at risk of creating too fine-grained permissions, I feel", "author": "jansu76", "createdAt": "2020-03-26T09:58:25Z", "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/SystemApiControllerTest.java", "diffHunk": "@@ -310,4 +316,24 @@ public void downloadAnchorNotFound() throws AnchorNotFoundException {\n             // success\n         }\n     }\n+\n+    @Test\n+    @WithMockUser(authorities = { \"UPLOAD_ANCHOR\" })\n+    public void uploadAnchor() throws IOException {\n+        Resource anchorResource = new ByteArrayResource(FileUtils.readFileToByteArray(ANCHOR_FILE));\n+        ResponseEntity<Void> response = systemApiController.uploadAnchor(anchorResource);\n+        assertEquals(HttpStatus.CREATED, response.getStatusCode());\n+        assertEquals(\"/api/system/anchor\", response.getHeaders().getLocation().getPath());\n+    }\n+\n+    @Test\n+    @WithMockUser(authorities = { \"UPLOAD_ANCHOR\" })", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0ODMxMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398448311", "bodyText": "Does this test actually need to have this try-catch? If exception gets thrown, it will fail anyway?", "author": "jansu76", "createdAt": "2020-03-26T10:01:17Z", "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/SystemServiceTest.java", "diffHunk": "@@ -161,4 +173,41 @@ public void deleteConfiguredTimestampingServiceNonExisting() {\n             // success\n         }\n     }\n+\n+    @Test\n+    public void getAnchorFileFromBytes() throws Exception {\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        AnchorFile anchorFile = systemService.getAnchorFileFromBytes(anchorBytes);\n+        assertEquals(ANCHOR_HASH, anchorFile.getHash());\n+    }\n+\n+    @Test(expected = SystemService.InvalidAnchorInstanceException.class)\n+    public void getAnchorFileFromBytesWrongInstance() throws Exception {\n+        when(serverConfService.getSecurityServerOwnerId()).thenReturn(ClientId.create(\"INVALID\", \"GOV\", \"1111\"));\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        systemService.getAnchorFileFromBytes(anchorBytes);\n+    }\n+\n+    @Test\n+    public void uploadAnchor() throws Exception {\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        try {\n+            systemService.uploadAnchor(anchorBytes);\n+        } catch (Exception e) {\n+            fail(\"Should not fail\");", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMDk1NA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399220954", "bodyText": "I think that Sonar will complain about the test not having any assertions if it was left out. SystemService.uploadAnchor is a void method so there are no return values to be asserted either. Other possibility would be to just assert true after executing the method.", "author": "carohauta", "createdAt": "2020-03-27T12:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0ODMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0ODUyOA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398448528", "bodyText": "Maybe add test for uploading garbage bytes?", "author": "jansu76", "createdAt": "2020-03-26T10:01:38Z", "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/SystemServiceTest.java", "diffHunk": "@@ -161,4 +173,41 @@ public void deleteConfiguredTimestampingServiceNonExisting() {\n             // success\n         }\n     }\n+\n+    @Test\n+    public void getAnchorFileFromBytes() throws Exception {\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        AnchorFile anchorFile = systemService.getAnchorFileFromBytes(anchorBytes);\n+        assertEquals(ANCHOR_HASH, anchorFile.getHash());\n+    }\n+\n+    @Test(expected = SystemService.InvalidAnchorInstanceException.class)\n+    public void getAnchorFileFromBytesWrongInstance() throws Exception {\n+        when(serverConfService.getSecurityServerOwnerId()).thenReturn(ClientId.create(\"INVALID\", \"GOV\", \"1111\"));\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        systemService.getAnchorFileFromBytes(anchorBytes);\n+    }\n+\n+    @Test\n+    public void uploadAnchor() throws Exception {", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDU3Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r400004577", "bodyText": "Added a new test", "author": "carohauta", "createdAt": "2020-03-30T08:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0ODUyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NDYzNg==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398464636", "bodyText": "Sonar thinks catching InterruptedException here is a bug: https://sonarqube.niis.org/project/issues?id=xroad&open=AXDo4wqfBW8O1Uq1H2wZ&pullRequest=415&resolved=false&types=BUG\nI believe it is a false positive, and this is in line with how other InterruptedExceptions are thrown. However it was not easy to follow the code to come to this conclusion. For a new developer, this would be even more difficult. I think at minimum ExternalProcessRunner (maybe some other classes that use it, too) should have documentation that makes it clear that this has already been done when InterruptedException is thrown out:\n        } catch (InterruptedException e) {\n            // retain the interrupted status\n            Thread.currentThread().interrupt();\n            throw e;", "author": "jansu76", "createdAt": "2020-03-26T10:27:40Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3MzYwNw==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399273607", "bodyText": "It is false positive since the thread interrupt status has already been restored in the ExternalProcessRunner class. Though I'm not sure if the InterruptedException ever should be thrown forward in the first place even if the status has been handled with.\nAdded some helpful info to the javadocs where this exception occurs. Also suppressed the SonarQube warning in this method since it seems to be a bug type.", "author": "carohauta", "createdAt": "2020-03-27T13:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NDYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NTk2NA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398465964", "bodyText": "Sonar suggests this: https://sonarqube.niis.org/project/issues?id=xroad&open=AXDo4wqfBW8O1Uq1H2wb&pullRequest=415&resolved=false&types=VULNERABILITY\nDon't know, maybe throwing RuntimeException would not be bad if delete = false?", "author": "jansu76", "createdAt": "2020-03-26T10:29:50Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {\n+            throw new AnchorUploadException(e);\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Cannot upload a new anchor\", e);\n+        } finally {\n+            if (tempAnchor != null) {\n+                tempAnchor.delete();", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MjI1Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399252252", "bodyText": "Maybe just log an error if the file was not deleted. IMO failing to delete a temp file in this situation is not worth instantly stopping execution.", "author": "carohauta", "createdAt": "2020-03-27T13:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NTk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2OTUxNA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r402269514", "bodyText": "Good choice.", "author": "jansu76", "createdAt": "2020-04-02T12:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NTk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NzY1NA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398467654", "bodyText": "Sonar suggests to replace \\n: https://sonarqube.niis.org/project/issues?id=xroad&open=AXDo4wqqBW8O1Uq1H2wd&pullRequest=415&resolved=false&types=CODE_SMELL", "author": "jansu76", "createdAt": "2020-03-26T10:32:36Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -104,15 +108,40 @@\n             IOUtils.closeQuietly(process.getErrorStream());\n             IOUtils.closeQuietly(process.getOutputStream());\n         }\n+        ProcessResult processResult = new ProcessResult(commandWithArgsString, exitCode, processOutput);\n+        return processResult;\n+    }\n \n+    /**\n+     * Executes the given command with given arguments and throws a {@link ProcessFailedException} if the process' exit\n+     * code is not 0. Used e.g. for simple script execution when there is no need to handle different exit codes\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return {@link ProcessResult} which contains the executed command with arguments, exit code (always 0) and the\n+     * output of the executed process\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0\n+     * @throws InterruptedException if the process running thread is interrupted\n+     */\n+    public ProcessResult executeAndThrowOnFailure(String command, String... args) throws ProcessNotExecutableException,\n+            ProcessFailedException, InterruptedException {\n+        ProcessResult processResult = execute(command, args);\n         // if the process fails we attach the output into the exception\n-        if (exitCode != 0) {\n-            String fullCommandString = String.join(\" \", commandWithArgs);\n-            String processOutputString = String.join(\"\\n\", processOutput);\n-            String errorMsg = String.format(\"Failed to run command '%s' with output: \\n %s\", fullCommandString,\n-                    processOutputString);\n+        if (processResult.getExitCode() != 0) {\n+            String processOutputString = String.join(\"\\n\", processResult.processOutput);\n+            String errorMsg = String.format(\"Failed to run command '%s' with output: \\n %s\",", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwMDU4OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399300589", "bodyText": "Changed", "author": "carohauta", "createdAt": "2020-03-27T14:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NzY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTM3OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398501379", "bodyText": "instead of\n} catch (ServiceException | InterruptedException e) {\nI think I would prefer\n} catch (ProcessNotExecutableException | ProcessFailedException | InterruptedException e) {\n\nit is more descriptive, it explains which types of errors form an AnchorUploadException. ServiceException is quite abstract. OK, abstraction can intentional also, it could be argued otherwise too. I personally was slightly confused \"where do these ServiceExceptions come from?\" and would have preferred my suggestion.\nServiceException is a bit of a catch-all, so when methods get modified, and new exceptions are added, we may mistakenly translate some new exception type to AnchorUploadException, even if it should have a different handling. So, I think it is good that we force developer to rethink \"is this AnchorUploadException or not\" when new exceptions are added. This, as long as the number of discreet exception types does not get too big, and since it is only 3 at this point, it's not a problem", "author": "jansu76", "createdAt": "2020-03-26T11:30:43Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {\n+            throw new AnchorUploadException(e);", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwNjA3NA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399306074", "bodyText": "Yeah I was deliberately going for the gotta-catch-'em-all approach since no matter what ServiceException we get here -> we still know that the anchor upload fails -> we know we want to throw AnchorUploadException.\nBut I get the point you are saying here and it is probably better in the long run that we keep being verbose about the different exceptions as long as it doesn't get too overwhelming. Updated the catch clause.", "author": "carohauta", "createdAt": "2020-03-27T14:30:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTY4MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398501681", "bodyText": "Could be\n} catch (IOException e) {\nand I think more specific one would be better.", "author": "jansu76", "createdAt": "2020-03-26T11:31:21Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {\n+            throw new AnchorUploadException(e);\n+        } catch (Exception e) {", "originalCommit": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxMTM2MA==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r399311360", "bodyText": "Don't know but somehow I seem to add Exception quite often instead of IOException! I updated some javadocs so it's easier to track where the IOException is thrown from. In this case it is thrown if the temp file creation fails or saving the anchor file fails. I'm not sure if those require their own exception classes? I probably would not add them.", "author": "carohauta", "createdAt": "2020-03-27T14:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTY4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI3MDE4MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r402270181", "bodyText": "Agreed.", "author": "jansu76", "createdAt": "2020-04-02T12:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTY4MQ=="}], "type": "inlineReview"}, {"oid": "c54e75e8ccd6e1dafa0b22f6e097c0394cff5a90", "url": "https://github.com/nordic-institute/X-Road/commit/c54e75e8ccd6e1dafa0b22f6e097c0394cff5a90", "message": "XRDDEV-880 Upload anchor // PR fixes 1\n\n* new exception for malformed anchor\n* better documentation\n* api endpoint namings and docs", "committedDate": "2020-03-26T15:33:29Z", "type": "commit"}, {"oid": "a8ac9865f4545ac0d56c750ff9fb49f2e4e0bf53", "url": "https://github.com/nordic-institute/X-Road/commit/a8ac9865f4545ac0d56c750ff9fb49f2e4e0bf53", "message": "XRDDEV-880 Upload anchor // PR fixes 2\n\n* was missing a critical step: actually download the configuration from the anchor\n* a lot of javadoc updates", "committedDate": "2020-03-27T14:51:56Z", "type": "commit"}, {"oid": "b2ba2a4b8b005b3f25e041254983e507309ba27b", "url": "https://github.com/nordic-institute/X-Road/commit/b2ba2a4b8b005b3f25e041254983e507309ba27b", "message": "XRDDEV-880 Upload anchor // PR fixes 3\n\n* add tests\n* move global conf download to GlobalConfService for easier mocking", "committedDate": "2020-03-30T08:13:17Z", "type": "commit"}, {"oid": "f5c88908e09f4f79773b62c784dd7fa9e3f2ea04", "url": "https://github.com/nordic-institute/X-Road/commit/f5c88908e09f4f79773b62c784dd7fa9e3f2ea04", "message": "Merge branch 'develop' into XRDDEV-880-upload-anchor", "committedDate": "2020-03-30T08:14:16Z", "type": "commit"}, {"oid": "91425a01421f2dea1f19947c510c245c570ce32a", "url": "https://github.com/nordic-institute/X-Road/commit/91425a01421f2dea1f19947c510c245c570ce32a", "message": "XRDDEV-880 Upload anchor // PR fixes 4\n\n* change conf verification failure to 500", "committedDate": "2020-04-02T14:26:54Z", "type": "commit"}, {"oid": "fdf0169e1a95bac6b45765fe7123fa2804509e99", "url": "https://github.com/nordic-institute/X-Road/commit/fdf0169e1a95bac6b45765fe7123fa2804509e99", "message": "XRDDEV-880 Upload anchor // PR fixes 5\n\n* add 15s timeout for executing the global conf download\n* more verbose exception handling if the request fails", "committedDate": "2020-04-03T07:14:00Z", "type": "commit"}, {"oid": "b32a8d50d3711609fe021c90bf025886366807f7", "url": "https://github.com/nordic-institute/X-Road/commit/b32a8d50d3711609fe021c90bf025886366807f7", "message": "XRDDEV-880 Upload anchor // PR fixes 6\n\n* increase timeout to 60s", "committedDate": "2020-04-03T07:18:13Z", "type": "commit"}]}