{"pr_number": 450, "pr_title": "XRDDEV-895 Restore backup", "pr_createdAt": "2020-04-06T13:14:24Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/450", "timeline": [{"oid": "9424b05c3a767dbab4ed7e11e94ca4edfe827bd7", "url": "https://github.com/nordic-institute/X-Road/commit/9424b05c3a767dbab4ed7e11e94ca4edfe827bd7", "message": "XRDDEV-895 Restore from backup\n\n* RestoreService, controller methods, tests\n* API definition changes: moved filename to request body\n* added more logging to ExternalProcessrRunner class", "committedDate": "2020-03-25T14:25:11Z", "type": "commit"}, {"oid": "93b1f352ff08bb6ba3154a0fb6a608a1796be966", "url": "https://github.com/nordic-institute/X-Road/commit/93b1f352ff08bb6ba3154a0fb6a608a1796be966", "message": "XRDDEV-895 Restore from backup use backup repo\n\n* use backup repository to get the backup dir path\n* controller tests\n* javadocs", "committedDate": "2020-03-26T07:35:15Z", "type": "commit"}, {"oid": "cb6b1ed724442abe9213163e9a1642f503a15670", "url": "https://github.com/nordic-institute/X-Road/commit/cb6b1ed724442abe9213163e9a1642f503a15670", "message": "Merge branch 'develop' into XRDDEV-895-restore-backup\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java\n#\tsrc/proxy-ui-api/src/main/resources/common-application.yml", "committedDate": "2020-04-03T12:33:56Z", "type": "commit"}, {"oid": "22363a6cce0008355dc6b07ff12311f980df2f6e", "url": "https://github.com/nordic-institute/X-Road/commit/22363a6cce0008355dc6b07ff12311f980df2f6e", "message": "XRDDEV-895 Restore from backup\n\n* update api definition", "committedDate": "2020-04-06T11:34:21Z", "type": "commit"}, {"oid": "3c7ab236be25928263925460bf3344f97ce4fdea", "url": "https://github.com/nordic-institute/X-Road/commit/3c7ab236be25928263925460bf3344f97ce4fdea", "message": "Merge branch 'develop' into XRDDEV-895-restore-backup", "committedDate": "2020-04-06T11:35:05Z", "type": "commit"}, {"oid": "b859efc3d778616c53d9d8182cf105e9c8c698a9", "url": "https://github.com/nordic-institute/X-Road/commit/b859efc3d778616c53d9d8182cf105e9c8c698a9", "message": "XRDDEV-895 Restore from backup\n\n* update api definition\n* added couple tests", "committedDate": "2020-04-06T13:07:24Z", "type": "commit"}, {"oid": "f65a7234183528d3d4ad6b3c98f8c2ad724302d3", "url": "https://github.com/nordic-institute/X-Road/commit/f65a7234183528d3d4ad6b3c98f8c2ad724302d3", "message": "XRDDEV-895 Restore from backup // sync restore", "committedDate": "2020-04-07T10:29:44Z", "type": "commit"}, {"oid": "1f905a86876465b31893ae0546644f415c8109f1", "url": "https://github.com/nordic-institute/X-Road/commit/1f905a86876465b31893ae0546644f415c8109f1", "message": "Merge branch 'develop' into XRDDEV-895-restore-backup", "committedDate": "2020-04-27T07:23:39Z", "type": "commit"}, {"oid": "6cf84832499e0d9282403dc446097b993b223513", "url": "https://github.com/nordic-institute/X-Road/commit/6cf84832499e0d9282403dc446097b993b223513", "message": "XRDDEV-895 Alert flags when restoring\n\n* set running flag in alerts\n* new exception if running restore concurrently", "committedDate": "2020-04-27T10:51:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxNzA5Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r415717093", "bodyText": "I had kind of a difficult choice between options:\n\nmark the method as synchronized to prevent concurrency\nmake it throw an exception if trying to run concurrently\n\nI ended up adding both.\nThrowing an exception makes it possible to run the restore concurrently (in theory) if multiple users trigger it simultaneously. The user is already seeing an alert saying that there is a restore in progress so getting an error would feel natural if the user tried to trigger another restore.\nIn it's current state the synchronized nature of the method overrides the notificationService.getBackupRestoreRunningSince() check making it redundant.", "author": "carohauta", "createdAt": "2020-04-27T11:02:31Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/RestoreService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.identifier.SecurityServerId;\n+\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.cache.CurrentSecurityServerId;\n+import org.niis.xroad.restapi.exceptions.DeviationAwareRuntimeException;\n+import org.niis.xroad.restapi.repository.BackupRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+\n+/**\n+ * service class for restoring security server configuration from a backup\n+ */\n+@Slf4j\n+@Service\n+@PreAuthorize(\"isAuthenticated()\")\n+public class RestoreService {\n+    @Setter\n+    private String configurationRestoreScriptPath;\n+    @Setter\n+    private String configurationRestoreScriptArgs;\n+\n+    private final ExternalProcessRunner externalProcessRunner;\n+    private final CurrentSecurityServerId currentSecurityServerId;\n+    private final BackupRepository backupRepository;\n+    private final NotificationService notificationService;\n+\n+    @Autowired\n+    public RestoreService(ExternalProcessRunner externalProcessRunner,\n+            @Value(\"${script.restore-configuration.path}\") String configurationRestoreScriptPath,\n+            @Value(\"${script.restore-configuration.args}\") String configurationRestoreScriptArgs,\n+            CurrentSecurityServerId currentSecurityServerId, BackupRepository backupRepository,\n+            NotificationService notificationService) {\n+        this.externalProcessRunner = externalProcessRunner;\n+        this.configurationRestoreScriptPath = configurationRestoreScriptPath;\n+        this.configurationRestoreScriptArgs = configurationRestoreScriptArgs;\n+        this.currentSecurityServerId = currentSecurityServerId;\n+        this.backupRepository = backupRepository;\n+        this.notificationService = notificationService;\n+    }\n+\n+    /**\n+     * Restores the security server configuration from a backup. Any tokens that are not software tokens are logged\n+     * out by the current restore script.\n+     * @param fileName name of the backup file\n+     * @throws BackupFileNotFoundException\n+     * @throws InterruptedException execution of the restore script was interrupted\n+     * @throws RestoreInProgressException if restore is already in progress\n+     */\n+    public synchronized void restoreFromBackup(String fileName) throws BackupFileNotFoundException,\n+            InterruptedException, RestoreInProgressException {\n+        if (notificationService.getBackupRestoreRunningSince() != null) {\n+            // should not happen because the method is synchronized\n+            throw new RestoreInProgressException(\"There is a restore (started at \"\n+                    + notificationService.getBackupRestoreRunningSince() + \") already in progress\");\n+        }", "originalCommit": "6cf84832499e0d9282403dc446097b993b223513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIyMTQ5MA==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r417221490", "bodyText": "I think synchronized is a must, since we do not want two threads getting past the notificationService.getBackupRestoreRunningSince check concurrently.\nSince method is synchronized we can reason that notificationService.getBackupRestoreRunningSince check is unnecessary, since we \"know\" it cannot happen. I don't think it is bad to have it, as kind of defensive programming, and since there's not too much complexity cost for it.\nBut since it is just defensive programming, and should not happen, I think it should not be a checked exception. Sometimes it's said those kind of checks should be done with asserts but a runtime exception is fine too. We don't want to complicate the API and burden the method's client with a checked exception type which is impossible, IMO. As we want to limit the number of exceptions (and I also had a different checked exception type in mind that I wanted to add...).", "author": "jansu76", "createdAt": "2020-04-29T10:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxNzA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQwNjA1Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r419406053", "bodyText": "Sound like good reasoning. I changed the checked exception into a runtime exception instead.", "author": "carohauta", "createdAt": "2020-05-04T12:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxNzA5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIyNzA3OA==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r417227078", "bodyText": "I would make this a checked exception. RestoreScriptFailedExeption, RestoreProcessFailedException....? True, it should probably result in http 500, not because of that. But because it is a major part of what can go wrong when method executes, that is important enough to be documented for the methods callers, both current and future ones.", "author": "jansu76", "createdAt": "2020-04-29T10:52:24Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/RestoreService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.identifier.SecurityServerId;\n+\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.cache.CurrentSecurityServerId;\n+import org.niis.xroad.restapi.exceptions.DeviationAwareRuntimeException;\n+import org.niis.xroad.restapi.repository.BackupRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+\n+/**\n+ * service class for restoring security server configuration from a backup\n+ */\n+@Slf4j\n+@Service\n+@PreAuthorize(\"isAuthenticated()\")\n+public class RestoreService {\n+    @Setter\n+    private String configurationRestoreScriptPath;\n+    @Setter\n+    private String configurationRestoreScriptArgs;\n+\n+    private final ExternalProcessRunner externalProcessRunner;\n+    private final CurrentSecurityServerId currentSecurityServerId;\n+    private final BackupRepository backupRepository;\n+    private final NotificationService notificationService;\n+\n+    @Autowired\n+    public RestoreService(ExternalProcessRunner externalProcessRunner,\n+            @Value(\"${script.restore-configuration.path}\") String configurationRestoreScriptPath,\n+            @Value(\"${script.restore-configuration.args}\") String configurationRestoreScriptArgs,\n+            CurrentSecurityServerId currentSecurityServerId, BackupRepository backupRepository,\n+            NotificationService notificationService) {\n+        this.externalProcessRunner = externalProcessRunner;\n+        this.configurationRestoreScriptPath = configurationRestoreScriptPath;\n+        this.configurationRestoreScriptArgs = configurationRestoreScriptArgs;\n+        this.currentSecurityServerId = currentSecurityServerId;\n+        this.backupRepository = backupRepository;\n+        this.notificationService = notificationService;\n+    }\n+\n+    /**\n+     * Restores the security server configuration from a backup. Any tokens that are not software tokens are logged\n+     * out by the current restore script.\n+     * @param fileName name of the backup file\n+     * @throws BackupFileNotFoundException\n+     * @throws InterruptedException execution of the restore script was interrupted\n+     * @throws RestoreInProgressException if restore is already in progress\n+     */\n+    public synchronized void restoreFromBackup(String fileName) throws BackupFileNotFoundException,\n+            InterruptedException, RestoreInProgressException {\n+        if (notificationService.getBackupRestoreRunningSince() != null) {\n+            // should not happen because the method is synchronized\n+            throw new RestoreInProgressException(\"There is a restore (started at \"\n+                    + notificationService.getBackupRestoreRunningSince() + \") already in progress\");\n+        }\n+        String configurationBackupPath = backupRepository.getConfigurationBackupPath();\n+        String backupFilePath = configurationBackupPath + fileName;\n+        File backupFile = new File(backupFilePath);\n+        if (!backupFile.isFile()) {\n+            throw new BackupFileNotFoundException(\"backup file \" + backupFilePath + \" does not exist\");\n+        }\n+        String[] arguments = buildArguments(backupFilePath);\n+        try {\n+            notificationService.setBackupRestoreRunningSince();\n+            ExternalProcessRunner.ProcessResult processResult = externalProcessRunner\n+                    .executeAndThrowOnFailure(configurationRestoreScriptPath, arguments);\n+\n+            int exitCode = processResult.getExitCode();\n+\n+            String restoreFinishedLogMsg = String.format(\"Restoring configuration finished with exit status %s\",\n+                    exitCode);\n+            log.info(restoreFinishedLogMsg);\n+            log.info(\" --- Restore script console output - START --- \");\n+            log.info(ExternalProcessRunner.processOutputToString(processResult.getProcessOutput()));\n+            log.info(\" --- Restore script console output - END --- \");\n+        } catch (ProcessFailedException | ProcessNotExecutableException e) {\n+            throw new DeviationAwareRuntimeException(\"restoring from a backup failed\", e.getErrorDeviation());", "originalCommit": "6cf84832499e0d9282403dc446097b993b223513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQwNjYzOA==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r419406638", "bodyText": "Changed this one into a checked exception. A 500 response will be returned from the controller with a proper error code.", "author": "carohauta", "createdAt": "2020-05-04T12:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIyNzA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI2NDAyNA==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r417264024", "bodyText": "https://jira.niis.org/browse/XRDDEV-1041 wants the script output formatted line by line, does this change prevent it?", "author": "jansu76", "createdAt": "2020-04-29T12:06:38Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -132,15 +136,25 @@ public ProcessResult executeAndThrowOnFailure(String command, String... args) th\n         ProcessResult processResult = execute(command, args);\n         // if the process fails we attach the output into the exception\n         if (processResult.getExitCode() != 0) {\n-            String lineSep = System.lineSeparator();\n-            String processOutputString = String.join(lineSep, processResult.processOutput);\n+            String processOutputString = processOutputToString(processResult.processOutput);\n             String errorMsg = String.format(\"Failed to run command '%s' with output: %n %s\",\n                     processResult.commandWithArgs, processOutputString);\n+            log.error(errorMsg);\n             throw new ProcessFailedException(errorMsg);\n         }\n         return processResult;\n     }\n \n+    /**\n+     * Format the process output string list to one string\n+     * @param processOutput\n+     * @return\n+     */\n+    public static String processOutputToString(List<String> processOutput) {", "originalCommit": "6cf84832499e0d9282403dc446097b993b223513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQxMDM3MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r419410371", "bodyText": "This formats the string so that it does have proper line breaks. It is meant for logging purposes and does not affect on the output itself.\nHowever I did some digging and noticed that when validating a WSDL, the output is not attached to the exception metadata at all (always leaving metadata empty even though the WSDL validation has some complaints.) I updated the executeAndThrowOnFailure so that the process output is attached to the exception metadata.", "author": "carohauta", "createdAt": "2020-05-04T12:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI2NDAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI4NzQzOQ==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r417287439", "bodyText": "Old implementation does this kinds of \"resetting\" after restore has happened.\ndef after_restore\n  ServerConfDatabaseCtx.get.closeSessionFactory\nend\n\nNot sure if this needs to do similar things, or if everything works already. At least should be tested and verified that if backup contains e.g. local group name x which has been later changed to x2, reading local group name after restore returns x2.\nAt least all application state needs to be cleared if it's possible that it is not up to date after restore. That means at least global caches (like API keys).\ncenter ui also does this\n  def before_restore\n    ActiveRecord::Base.remove_connection\n  end\n\n  def after_restore\n    ActiveRecord::Base.establish_connection\n  end\n\nbut I don't see old proxy implementation doing the similar. It does prevent use of UI during the restore though. I think we need to do the same but there's a separate ticket for that in https://jira.niis.org/browse/XRDDEV-950.", "author": "jansu76", "createdAt": "2020-04-29T12:48:11Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/RestoreService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.identifier.SecurityServerId;\n+\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.cache.CurrentSecurityServerId;\n+import org.niis.xroad.restapi.exceptions.DeviationAwareRuntimeException;\n+import org.niis.xroad.restapi.repository.BackupRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+\n+/**\n+ * service class for restoring security server configuration from a backup\n+ */\n+@Slf4j\n+@Service\n+@PreAuthorize(\"isAuthenticated()\")\n+public class RestoreService {\n+    @Setter\n+    private String configurationRestoreScriptPath;\n+    @Setter\n+    private String configurationRestoreScriptArgs;\n+\n+    private final ExternalProcessRunner externalProcessRunner;\n+    private final CurrentSecurityServerId currentSecurityServerId;\n+    private final BackupRepository backupRepository;\n+    private final NotificationService notificationService;\n+\n+    @Autowired\n+    public RestoreService(ExternalProcessRunner externalProcessRunner,\n+            @Value(\"${script.restore-configuration.path}\") String configurationRestoreScriptPath,\n+            @Value(\"${script.restore-configuration.args}\") String configurationRestoreScriptArgs,\n+            CurrentSecurityServerId currentSecurityServerId, BackupRepository backupRepository,\n+            NotificationService notificationService) {\n+        this.externalProcessRunner = externalProcessRunner;\n+        this.configurationRestoreScriptPath = configurationRestoreScriptPath;\n+        this.configurationRestoreScriptArgs = configurationRestoreScriptArgs;\n+        this.currentSecurityServerId = currentSecurityServerId;\n+        this.backupRepository = backupRepository;\n+        this.notificationService = notificationService;\n+    }\n+\n+    /**\n+     * Restores the security server configuration from a backup. Any tokens that are not software tokens are logged\n+     * out by the current restore script.\n+     * @param fileName name of the backup file\n+     * @throws BackupFileNotFoundException\n+     * @throws InterruptedException execution of the restore script was interrupted\n+     * @throws RestoreInProgressException if restore is already in progress\n+     */\n+    public synchronized void restoreFromBackup(String fileName) throws BackupFileNotFoundException,\n+            InterruptedException, RestoreInProgressException {\n+        if (notificationService.getBackupRestoreRunningSince() != null) {\n+            // should not happen because the method is synchronized\n+            throw new RestoreInProgressException(\"There is a restore (started at \"\n+                    + notificationService.getBackupRestoreRunningSince() + \") already in progress\");\n+        }\n+        String configurationBackupPath = backupRepository.getConfigurationBackupPath();\n+        String backupFilePath = configurationBackupPath + fileName;\n+        File backupFile = new File(backupFilePath);\n+        if (!backupFile.isFile()) {\n+            throw new BackupFileNotFoundException(\"backup file \" + backupFilePath + \" does not exist\");\n+        }\n+        String[] arguments = buildArguments(backupFilePath);\n+        try {\n+            notificationService.setBackupRestoreRunningSince();\n+            ExternalProcessRunner.ProcessResult processResult = externalProcessRunner\n+                    .executeAndThrowOnFailure(configurationRestoreScriptPath, arguments);\n+\n+            int exitCode = processResult.getExitCode();\n+\n+            String restoreFinishedLogMsg = String.format(\"Restoring configuration finished with exit status %s\",\n+                    exitCode);\n+            log.info(restoreFinishedLogMsg);\n+            log.info(\" --- Restore script console output - START --- \");\n+            log.info(ExternalProcessRunner.processOutputToString(processResult.getProcessOutput()));\n+            log.info(\" --- Restore script console output - END --- \");\n+        } catch (ProcessFailedException | ProcessNotExecutableException e) {\n+            throw new DeviationAwareRuntimeException(\"restoring from a backup failed\", e.getErrorDeviation());\n+        } finally {\n+            notificationService.resetBackupRestoreRunningSince();", "originalCommit": "6cf84832499e0d9282403dc446097b993b223513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMTcyNg==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r417301726", "bodyText": "Some speculation about closeSessionFactory: https://niis.slack.com/archives/GB2JH4LUE/p1588164164011100", "author": "jansu76", "createdAt": "2020-04-29T13:11:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI4NzQzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYzMDA4Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r420630083", "bodyText": "Based on speculation about the new restore being different compared to the old one therefore not needing to establish database connection again -> did not implement such feature.\nHowever the api-key cache clearing is pretty important part of the restore (nice observation btw! \ud83d\udc4d) -> it has been added.", "author": "carohauta", "createdAt": "2020-05-06T08:38:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI4NzQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI4ODQwNw==", "url": "https://github.com/nordic-institute/X-Road/pull/450#discussion_r417288407", "bodyText": "Nice and clear script argument handling and how spring properties are used, well done \ud83d\udc4d", "author": "jansu76", "createdAt": "2020-04-29T12:49:47Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/RestoreService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.common.identifier.SecurityServerId;\n+\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.niis.xroad.restapi.cache.CurrentSecurityServerId;\n+import org.niis.xroad.restapi.exceptions.DeviationAwareRuntimeException;\n+import org.niis.xroad.restapi.repository.BackupRepository;\n+import org.niis.xroad.restapi.util.FormatUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+\n+/**\n+ * service class for restoring security server configuration from a backup\n+ */\n+@Slf4j\n+@Service\n+@PreAuthorize(\"isAuthenticated()\")\n+public class RestoreService {\n+    @Setter\n+    private String configurationRestoreScriptPath;\n+    @Setter\n+    private String configurationRestoreScriptArgs;\n+\n+    private final ExternalProcessRunner externalProcessRunner;\n+    private final CurrentSecurityServerId currentSecurityServerId;\n+    private final BackupRepository backupRepository;\n+    private final NotificationService notificationService;\n+\n+    @Autowired\n+    public RestoreService(ExternalProcessRunner externalProcessRunner,\n+            @Value(\"${script.restore-configuration.path}\") String configurationRestoreScriptPath,\n+            @Value(\"${script.restore-configuration.args}\") String configurationRestoreScriptArgs,\n+            CurrentSecurityServerId currentSecurityServerId, BackupRepository backupRepository,\n+            NotificationService notificationService) {\n+        this.externalProcessRunner = externalProcessRunner;\n+        this.configurationRestoreScriptPath = configurationRestoreScriptPath;\n+        this.configurationRestoreScriptArgs = configurationRestoreScriptArgs;\n+        this.currentSecurityServerId = currentSecurityServerId;\n+        this.backupRepository = backupRepository;\n+        this.notificationService = notificationService;\n+    }\n+\n+    /**\n+     * Restores the security server configuration from a backup. Any tokens that are not software tokens are logged\n+     * out by the current restore script.\n+     * @param fileName name of the backup file\n+     * @throws BackupFileNotFoundException\n+     * @throws InterruptedException execution of the restore script was interrupted\n+     * @throws RestoreInProgressException if restore is already in progress\n+     */\n+    public synchronized void restoreFromBackup(String fileName) throws BackupFileNotFoundException,\n+            InterruptedException, RestoreInProgressException {\n+        if (notificationService.getBackupRestoreRunningSince() != null) {\n+            // should not happen because the method is synchronized\n+            throw new RestoreInProgressException(\"There is a restore (started at \"\n+                    + notificationService.getBackupRestoreRunningSince() + \") already in progress\");\n+        }\n+        String configurationBackupPath = backupRepository.getConfigurationBackupPath();\n+        String backupFilePath = configurationBackupPath + fileName;\n+        File backupFile = new File(backupFilePath);\n+        if (!backupFile.isFile()) {\n+            throw new BackupFileNotFoundException(\"backup file \" + backupFilePath + \" does not exist\");\n+        }\n+        String[] arguments = buildArguments(backupFilePath);\n+        try {\n+            notificationService.setBackupRestoreRunningSince();\n+            ExternalProcessRunner.ProcessResult processResult = externalProcessRunner\n+                    .executeAndThrowOnFailure(configurationRestoreScriptPath, arguments);\n+\n+            int exitCode = processResult.getExitCode();\n+\n+            String restoreFinishedLogMsg = String.format(\"Restoring configuration finished with exit status %s\",\n+                    exitCode);\n+            log.info(restoreFinishedLogMsg);\n+            log.info(\" --- Restore script console output - START --- \");\n+            log.info(ExternalProcessRunner.processOutputToString(processResult.getProcessOutput()));\n+            log.info(\" --- Restore script console output - END --- \");\n+        } catch (ProcessFailedException | ProcessNotExecutableException e) {\n+            throw new DeviationAwareRuntimeException(\"restoring from a backup failed\", e.getErrorDeviation());\n+        } finally {\n+            notificationService.resetBackupRestoreRunningSince();\n+        }\n+    }\n+\n+    /**\n+     * Encodes args with base64 and returns all options and args as an array\n+     * @param backupFilePath\n+     * @return\n+     */\n+    private String[] buildArguments(String backupFilePath) {", "originalCommit": "6cf84832499e0d9282403dc446097b993b223513", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "97d377c7c058c7785f099719a7fa383d08eb0236", "url": "https://github.com/nordic-institute/X-Road/commit/97d377c7c058c7785f099719a7fa383d08eb0236", "message": "XRDDEV-895 PR comment fix 1", "committedDate": "2020-05-04T08:46:12Z", "type": "commit"}, {"oid": "8cca160b542d5a763deedf8bab4a5e6cc20012cc", "url": "https://github.com/nordic-institute/X-Road/commit/8cca160b542d5a763deedf8bab4a5e6cc20012cc", "message": "Merge branch 'develop' into XRDDEV-895-restore-backup", "committedDate": "2020-05-06T06:42:49Z", "type": "commit"}, {"oid": "4fdda7919589b420cd25af6ecf3dde65227ec4c1", "url": "https://github.com/nordic-institute/X-Road/commit/4fdda7919589b420cd25af6ecf3dde65227ec4c1", "message": "XRDDEV-895 PR comment fix 2 // clear api-key caches", "committedDate": "2020-05-06T08:33:08Z", "type": "commit"}, {"oid": "2341da4c2b89397f82888f801585293a273a2fa5", "url": "https://github.com/nordic-institute/X-Road/commit/2341da4c2b89397f82888f801585293a273a2fa5", "message": "XRDDEV-895 Fix broken tests", "committedDate": "2020-05-06T09:35:31Z", "type": "commit"}]}