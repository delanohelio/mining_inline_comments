{"pr_number": 831, "pr_title": "Admin statistics/ advanced stats", "pr_createdAt": "2020-10-19T16:21:48Z", "pr_url": "https://github.com/phac-nml/irida/pull/831", "timeline": [{"oid": "e8776b0026b4791172da7059faf9933477d5c971", "url": "https://github.com/phac-nml/irida/commit/e8776b0026b4791172da7059faf9933477d5c971", "message": "Renamed dto files. Added uiadminstatsservice. Advanced statistics are now only retrieved on button click", "committedDate": "2020-10-05T20:41:08Z", "type": "commit"}, {"oid": "d0018e240547e013724701bffd125da02d7c2ccf", "url": "https://github.com/phac-nml/irida/commit/d0018e240547e013724701bffd125da02d7c2ccf", "message": "Imported @requestparam", "committedDate": "2020-10-06T15:47:16Z", "type": "commit"}, {"oid": "580537c7a59ef83a2e018414e825103348ab9784", "url": "https://github.com/phac-nml/irida/commit/580537c7a59ef83a2e018414e825103348ab9784", "message": "Added advanced stats (hourly, daily, monthly, yearly) for analyses", "committedDate": "2020-10-07T19:54:41Z", "type": "commit"}, {"oid": "7b32eab676ec5a48c990c0a520c44f2f1881673c", "url": "https://github.com/phac-nml/irida/commit/7b32eab676ec5a48c990c0a520c44f2f1881673c", "message": "Added advanced stats (hourly, daily, monthly, yearly) for projects", "committedDate": "2020-10-07T20:13:18Z", "type": "commit"}, {"oid": "75566ee27a708e93082953d3a97fc8d6d138ab7b", "url": "https://github.com/phac-nml/irida/commit/75566ee27a708e93082953d3a97fc8d6d138ab7b", "message": "Added advanced stats (hourly, daily, monthly, yearly) for samples", "committedDate": "2020-10-07T23:53:17Z", "type": "commit"}, {"oid": "74124b30c7ad9f3349b9dd2534f465107c518d23", "url": "https://github.com/phac-nml/irida/commit/74124b30c7ad9f3349b9dd2534f465107c518d23", "message": "Added advanced stats (hourly, daily, monthly, yearly) for users", "committedDate": "2020-10-08T14:07:50Z", "type": "commit"}, {"oid": "ea27fe6b025c0237d18725be0e479de0dfa73069", "url": "https://github.com/phac-nml/irida/commit/ea27fe6b025c0237d18725be0e479de0dfa73069", "message": "Merged basic statistics branch and fixed merge conflicts. Updated to display statistics for users created in time period", "committedDate": "2020-10-08T16:47:34Z", "type": "commit"}, {"oid": "736390b765e140bd25af51b31e6aaeb162fd3778", "url": "https://github.com/phac-nml/irida/commit/736390b765e140bd25af51b31e6aaeb162fd3778", "message": "Merged basic stats branch and fixed merge conflicts. Updated comments", "committedDate": "2020-10-08T18:00:42Z", "type": "commit"}, {"oid": "d13fa5ec4f220a5747902c7afa7f8db34135de40", "url": "https://github.com/phac-nml/irida/commit/d13fa5ec4f220a5747902c7afa7f8db34135de40", "message": "Merged basic stats branch and fixed merge conflict", "committedDate": "2020-10-08T19:19:25Z", "type": "commit"}, {"oid": "749637095452661b5af006fcb7297deb16ac8692", "url": "https://github.com/phac-nml/irida/commit/749637095452661b5af006fcb7297deb16ac8692", "message": "Merge branch 'admin-statistics/_basic-stats' into admin-statistics/_advanced-stats", "committedDate": "2020-10-08T20:01:09Z", "type": "commit"}, {"oid": "4e8a39efb1d69667359e60ed71758c3ad5653ba1", "url": "https://github.com/phac-nml/irida/commit/4e8a39efb1d69667359e60ed71758c3ad5653ba1", "message": "Added styled card and buttons for statistics. Set chart height as a const in adminstatisticscontext", "committedDate": "2020-10-08T20:33:25Z", "type": "commit"}, {"oid": "e93ca5197c8884b2978cbacb000563b3f2e4a688", "url": "https://github.com/phac-nml/irida/commit/e93ca5197c8884b2978cbacb000563b3f2e4a688", "message": "Merged basic stats branch and fixed merge conflicts.", "committedDate": "2020-10-09T16:00:21Z", "type": "commit"}, {"oid": "2d0a87a0da1817b32b5c31be5556940d4d382b82", "url": "https://github.com/phac-nml/irida/commit/2d0a87a0da1817b32b5c31be5556940d4d382b82", "message": "Merged basic stats branch and fixed merge conflicts.", "committedDate": "2020-10-15T21:07:28Z", "type": "commit"}, {"oid": "bb123eb566eff46a673cd74bc15659c98825b1f6", "url": "https://github.com/phac-nml/irida/commit/bb123eb566eff46a673cd74bc15659c98825b1f6", "message": "Removed variable not used", "committedDate": "2020-10-15T21:08:53Z", "type": "commit"}, {"oid": "d4dc6687f34c56b6852f19be1bfb76de0703c075", "url": "https://github.com/phac-nml/irida/commit/d4dc6687f34c56b6852f19be1bfb76de0703c075", "message": "Updated logic to get stats for stat type for the default time period (week) when advanced stats are viewed", "committedDate": "2020-10-15T21:21:27Z", "type": "commit"}, {"oid": "bd11e72c0c069339c7334f1efd123405daa336e4", "url": "https://github.com/phac-nml/irida/commit/bd11e72c0c069339c7334f1efd123405daa336e4", "message": "Updated basicstats logic to get default time period stats for the tinycolumn charts", "committedDate": "2020-10-15T21:35:55Z", "type": "commit"}, {"oid": "ff45e119c22931898aed7998a100a12f3640369f", "url": "https://github.com/phac-nml/irida/commit/ff45e119c22931898aed7998a100a12f3640369f", "message": "Merged basic stats branch and fixed merge conflicts", "committedDate": "2020-10-16T19:17:53Z", "type": "commit"}, {"oid": "ab44eec9acb1d0a0006147e3951ce501330e63c2", "url": "https://github.com/phac-nml/irida/commit/ab44eec9acb1d0a0006147e3951ce501330e63c2", "message": "Merged basic stats branch and fixed merge conflicts. Added enum which stores statistic time periods. Updated method comments. Added analyses, projects, users, and samples count stats to basicstats model that are used by tiny charts on the basic stats page.", "committedDate": "2020-10-19T16:12:14Z", "type": "commit"}, {"oid": "e54a1982e00da005c46a3555c439a0cd0bd6d6a8", "url": "https://github.com/phac-nml/irida/commit/e54a1982e00da005c46a3555c439a0cd0bd6d6a8", "message": "Merge branch 'admin-statistics/_base' into admin-statistics/_advanced-stats", "committedDate": "2020-10-19T16:20:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNzE5OQ==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r507907199", "bodyText": "Comments", "author": "joshsadam", "createdAt": "2020-10-19T16:56:40Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/enums/StatisticTimePeriod.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package ca.corefacility.bioinformatics.irida.model.enums;\n+\n+public enum StatisticTimePeriod {", "originalCommit": "e54a1982e00da005c46a3555c439a0cd0bd6d6a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk2MTYxNg==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r507961616", "bodyText": "Added in 06bf685", "author": "deepsidhu85", "createdAt": "2020-10-19T18:08:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNzE5OQ=="}], "type": "inlineReview"}, {"oid": "06bf685f3158a23f35de733bead1341113532cd5", "url": "https://github.com/phac-nml/irida/commit/06bf685f3158a23f35de733bead1341113532cd5", "message": "Added missing javadoc. Removed duplicate @param", "committedDate": "2020-10-19T18:08:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMDMzMA==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508420330", "bodyText": "Why do you need fully qualified class names?", "author": "joshsadam", "createdAt": "2020-10-20T11:23:21Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/analysis/submission/AnalysisSubmissionRepository.java", "diffHunk": "@@ -136,28 +125,72 @@\n \t/**\n \t * Get all {@link ProjectSampleAnalysisOutputInfo} shared with a {@link Project}.\n \t *\n-\t * @param projectId {@link Project} id\n+\t * @param projectId   {@link Project} id\n \t * @param workflowIds Workflow UUIDs of workflow pipelines to get output files for\n \t * @return a list of {@link ProjectSampleAnalysisOutputInfo}\n \t */\n-\tList<ProjectSampleAnalysisOutputInfo> getAllAnalysisOutputInfoSharedWithProject(Long projectId, Set<UUID> workflowIds);\n+\tList<ProjectSampleAnalysisOutputInfo> getAllAnalysisOutputInfoSharedWithProject(Long projectId,\n+\t\t\tSet<UUID> workflowIds);\n \n \t/**\n \t * Get all automated {@link ProjectSampleAnalysisOutputInfo} for a {@link Project}.\n \t *\n-\t * @param projectId {@link Project} id\n+\t * @param projectId   {@link Project} id\n \t * @param workflowIds Workflow UUIDs of workflow pipelines to get output files for\n \t * @return a list of {@link ProjectSampleAnalysisOutputInfo}\n \t */\n \tList<ProjectSampleAnalysisOutputInfo> getAllAutomatedAnalysisOutputInfoForAProject(Long projectId,\n \t\t\tSet<UUID> workflowIds);\n \n \t/**\n-\t * Get a count of all {@link AnalysisSubmission}s ran within time period\n+\t * Get the count of {@link AnalysisSubmission}s run in time period\n \t *\n-\t * @param createdDate the minimum created date for submissions\n-\t * @return a count of {@link User}s\n+\t * @param createdDate The minimum created date for the analysis submission\n+\t * @return A count of {@link AnalysisSubmission}s run in time period.\n \t */\n \t@Query(\"select count(s.id) from AnalysisSubmission s where s.createdDate >= ?1\")\n \tpublic Long countAnalysesRanInTimePeriod(Date createdDate);\n+\n+\t/**\n+\t * Get a list of {@link GenericStatModel}s for analyses run in the last day and grouped by hour\n+\t *\n+\t * @param createdDate The minimum created date for the analysis submission\n+\t * @return A list of {@link GenericStatModel}s\n+\t */\n+\t@Query(\"select new ca.corefacility.bioinformatics.irida.ria.web.admin.dto.statistics.GenericStatModel(function('date_format', s.createdDate, '%H:00'), count(s.id))\"", "originalCommit": "06bf685f3158a23f35de733bead1341113532cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2NjQ5Mg==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508466492", "bodyText": "Using @query to project the results directly into a dto requires the use of the fully classified class name", "author": "deepsidhu85", "createdAt": "2020-10-20T12:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMDMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMDc0Mg==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508420742", "bodyText": "Much cleaner, thank you.", "author": "joshsadam", "createdAt": "2020-10-20T11:24:08Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/admin/AdminStatisticsAjaxController.java", "diffHunk": "@@ -22,18 +15,11 @@\n @RequestMapping(\"/ajax/statistics\")\n public class AdminStatisticsAjaxController {\n \n-\tprivate ProjectService projectService;\n-\tprivate UserService userService;\n-\tprivate SampleService sampleService;\n-\tprivate AnalysisSubmissionService analysisSubmissionService;\n+\tprivate UIAdminStatisticsService uiAdminStatisticsService;\n \n \t@Autowired\n-\tpublic AdminStatisticsAjaxController(ProjectService projectService, UserService userService,\n-\t\t\tSampleService sampleService, AnalysisSubmissionService analysisSubmissionService) {", "originalCommit": "06bf685f3158a23f35de733bead1341113532cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3ODIyOQ==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508578229", "bodyText": "Thanks :)", "author": "deepsidhu85", "createdAt": "2020-10-20T14:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMDc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMjE2OA==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508422168", "bodyText": "These classes seem very similar, is there a way to make one class that can handle all?", "author": "joshsadam", "createdAt": "2020-10-20T11:26:43Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/admin/dto/statistics/SampleStatsResponse.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.admin.dto.statistics;", "originalCommit": "06bf685f3158a23f35de733bead1341113532cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2NjY5NQ==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508466695", "bodyText": "I will take a look and see what I can do", "author": "deepsidhu85", "createdAt": "2020-10-20T12:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMjE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3ODE0OA==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508578148", "bodyText": "Updated in 0d7b38c", "author": "deepsidhu85", "createdAt": "2020-10-20T14:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMjE2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMzU5Ng==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508423596", "bodyText": "Try extending your return objects with AjaxResponse that way you can generically return and AjaxErrorResponse if you need to.", "author": "joshsadam", "createdAt": "2020-10-20T11:29:11Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/admin/AdminStatisticsAjaxController.java", "diffHunk": "@@ -44,18 +30,8 @@ public AdminStatisticsAjaxController(ProjectService projectService, UserService\n \t * @return dto with basic usage stats\n \t */\n \t@GetMapping(\"/basic\")\n-\tpublic ResponseEntity<BasicStats> getAdminStatistics(Integer timePeriod) {\n-\t\tDate currDate = new Date();\n-\t\tDate minimumCreatedDate = new DateTime(currDate).minusDays(timePeriod)\n-\t\t\t\t.toDate();\n-\n-\t\tLong analysesRan = analysisSubmissionService.getAnalysesRan(minimumCreatedDate);\n-\t\tLong projectsCreated = projectService.getProjectsCreated(minimumCreatedDate);\n-\t\tLong samplesCreated = sampleService.getSamplesCreated(minimumCreatedDate);\n-\t\tLong usersCreated = userService.getUsersCreatedInTimePeriod(minimumCreatedDate);\n-\t\tLong usersLoggedIn = userService.getUsersLoggedIn(minimumCreatedDate);\n-\n-\t\treturn ResponseEntity.ok(new BasicStats(analysesRan, projectsCreated, samplesCreated, usersCreated, usersLoggedIn));\n+\tpublic ResponseEntity<BasicStats> getAdminStatistics(@RequestParam int timePeriod) {", "originalCommit": "06bf685f3158a23f35de733bead1341113532cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2Njc2Mg==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508466762", "bodyText": "Sure!", "author": "deepsidhu85", "createdAt": "2020-10-20T12:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMzU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3ODA0NA==", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508578044", "bodyText": "As per our discussion we are going to leave this", "author": "deepsidhu85", "createdAt": "2020-10-20T14:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMzU5Ng=="}], "type": "inlineReview"}, {"oid": "0d7b38cc8ff91e129bd1a42729850e14f23871ab", "url": "https://github.com/phac-nml/irida/commit/0d7b38cc8ff91e129bd1a42729850e14f23871ab", "message": "Renamed dto and created a statisticsresponse dto which is used to return statistics of any type.", "committedDate": "2020-10-20T14:51:14Z", "type": "commit"}, {"oid": "5b280de1513c6c2f3f17a5dba79aeef0fd675d96", "url": "https://github.com/phac-nml/irida/commit/5b280de1513c6c2f3f17a5dba79aeef0fd675d96", "message": "Added users, projects, analyses, and samples to required-data sql so that the statistics charts for the admin panel have data", "committedDate": "2020-10-20T20:33:17Z", "type": "commit"}, {"oid": "876276163e478cb0846ed143e9724682f9387f16", "url": "https://github.com/phac-nml/irida/commit/876276163e478cb0846ed143e9724682f9387f16", "message": "Removed context to simplify code", "committedDate": "2020-10-21T17:22:19Z", "type": "commit"}, {"oid": "1da27a9ae9df205b7664791af394c615750795cd", "url": "https://github.com/phac-nml/irida/commit/1da27a9ae9df205b7664791af394c615750795cd", "message": "Added function comment", "committedDate": "2020-10-21T18:11:42Z", "type": "commit"}]}