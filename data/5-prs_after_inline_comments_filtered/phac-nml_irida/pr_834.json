{"pr_number": 834, "pr_title": "Refactor statistics queries", "pr_createdAt": "2020-10-22T14:39:46Z", "pr_url": "https://github.com/phac-nml/irida/pull/834", "timeline": [{"oid": "53f4209c1d7c0a75e7460652ae2d0c5b6fcd43e3", "url": "https://github.com/phac-nml/irida/commit/53f4209c1d7c0a75e7460652ae2d0c5b6fcd43e3", "message": "Refactored queries (analyses, projects, samples, users) for statistics to use the same query per repo rather than have 4 individual queries per repo.", "committedDate": "2020-10-22T14:37:58Z", "type": "commit"}, {"oid": "cdd5a7aec6e160536c15b6d9d2c7b4895fc4b538", "url": "https://github.com/phac-nml/irida/commit/cdd5a7aec6e160536c15b6d9d2c7b4895fc4b538", "message": "Added missing javadocs. Removed unused import", "committedDate": "2020-10-23T12:50:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3NzQ1OQ==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r510977459", "bodyText": "Would it make sense to put all this stuff into StatisticTimePeriod?  You already have these exact values there so it's a bit of a duplication.\nIf you did that you could just add the groupByFormat property to that enum.", "author": "tom114", "createdAt": "2020-10-23T15:47:40Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/enums/GroupByFormat.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package ca.corefacility.bioinformatics.irida.model.enums;\n+\n+/**\n+ * Defines a set of formats which admin statistics\n+ * can be grouped by\n+ *\n+ */\n+\n+public enum GroupByFormat {", "originalCommit": "cdd5a7aec6e160536c15b6d9d2c7b4895fc4b538", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1MzY4Mw==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r511053683", "bodyText": "Yeah that's a good idea. :) I will try it out and see how it goes. Thanks", "author": "deepsidhu85", "createdAt": "2020-10-23T18:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3NzQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NzU2NQ==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r511947565", "bodyText": "Updated in c5a00bc", "author": "deepsidhu85", "createdAt": "2020-10-26T13:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3NzQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3ODE3NA==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r510978174", "bodyText": "Use the enum values instead of fromString.  So GroupByFormat.DAILY instead here.", "author": "tom114", "createdAt": "2020-10-23T15:48:55Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/services/UIAdminStatisticsService.java", "diffHunk": "@@ -86,17 +86,21 @@ public StatisticsResponse getAdminAnalysesStatistics(Integer timePeriod) {\n \n \t\tif (IntStream.of(StatisticTimePeriod.DAILY.getDaily())\n \t\t\t\t.anyMatch((x -> x == timePeriod))) {\n-\t\t\treturn new StatisticsResponse(analysisSubmissionService.getAnalysesRanDaily(minimumCreatedDate));\n+\t\t\treturn new StatisticsResponse(analysisSubmissionService.getAnalysesRanGrouped(minimumCreatedDate,\n+\t\t\t\t\tGroupByFormat.fromString(\"daily\")));", "originalCommit": "cdd5a7aec6e160536c15b6d9d2c7b4895fc4b538", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0Nzg2Ng==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r511947866", "bodyText": "This has been refactored in c5a00bc", "author": "deepsidhu85", "createdAt": "2020-10-26T13:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3ODE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4MDk4Mw==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r510980983", "bodyText": "If you ended up moving the GroupByFormat stuff into StatisticsResponse you could also refactor to remove this whole if stack and get the method to just figure out which StatisticsResponse to use, and directly call into the service method with that StatisticsResponse.", "author": "tom114", "createdAt": "2020-10-23T15:53:31Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/services/UIAdminStatisticsService.java", "diffHunk": "@@ -86,17 +86,21 @@ public StatisticsResponse getAdminAnalysesStatistics(Integer timePeriod) {\n \n \t\tif (IntStream.of(StatisticTimePeriod.DAILY.getDaily())", "originalCommit": "cdd5a7aec6e160536c15b6d9d2c7b4895fc4b538", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NzY4Ng==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r511947686", "bodyText": "Updated in c5a00bc", "author": "deepsidhu85", "createdAt": "2020-10-26T13:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4MDk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExMzMzOQ==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r512113339", "bodyText": "Thanks.  That paired down all those functions by a pile.", "author": "tom114", "createdAt": "2020-10-26T16:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4MDk4Mw=="}], "type": "inlineReview"}, {"oid": "c5a00bcd1e78198ca591eaa499e2e494dd1cd5ca", "url": "https://github.com/phac-nml/irida/commit/c5a00bcd1e78198ca591eaa499e2e494dd1cd5ca", "message": "Moved groupbyformat enum values into statistictimeperiod enum. Refactored logic in uiadminstatisticsservice to clean up if/else blocks", "committedDate": "2020-10-26T13:12:02Z", "type": "commit"}, {"oid": "79f3a3ee19adfa3e6647dbe5ba385320206864e2", "url": "https://github.com/phac-nml/irida/commit/79f3a3ee19adfa3e6647dbe5ba385320206864e2", "message": "Fixed typo and removed getters not required", "committedDate": "2020-10-26T14:17:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5NjU5OQ==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r512096599", "bodyText": "Can you add a comment on what these int values are for?", "author": "tom114", "createdAt": "2020-10-26T16:29:08Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/enums/StatisticTimePeriod.java", "diffHunk": "@@ -1,31 +1,39 @@\n package ca.corefacility.bioinformatics.irida.model.enums;\n \n /**\n- * Defines a arrays of time periods used\n+ * Defines a arrays of time periods and group by formats used\n  * for getting statistics for the Admin Panel.\n  *\n  */\n \n public enum StatisticTimePeriod {\n-\tDAILY(7,14,30),\n-\tMONTHLY(90, 365),\n-\tYEARLY(730, 1825, 3650);\n+\tHOURLY(new int[] {1}, \"%H:00\"),\n+\tDAILY(new int[] {7,14,30}, \"%m/%d\"),\n+\tMONTHLY(new int[] {90, 365}, \"%m/%y\"),\n+\tYEARLY(new int[] {730, 1825, 3650}, \"%Y\");\n \n \tprivate int [] values;", "originalCommit": "79f3a3ee19adfa3e6647dbe5ba385320206864e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NTAxMA==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r512195010", "bodyText": "Added in 863ac81", "author": "deepsidhu85", "createdAt": "2020-10-26T18:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5NjU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5OTExNg==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r512099116", "bodyText": "Is there any use for the setters?  Since its an enum it doesn't really make sense for an outside object to modify it.  If its needed for hibernate or something though you can switch them to private.", "author": "tom114", "createdAt": "2020-10-26T16:32:33Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/enums/StatisticTimePeriod.java", "diffHunk": "@@ -1,31 +1,39 @@\n package ca.corefacility.bioinformatics.irida.model.enums;\n \n /**\n- * Defines a arrays of time periods used\n+ * Defines a arrays of time periods and group by formats used\n  * for getting statistics for the Admin Panel.\n  *\n  */\n \n public enum StatisticTimePeriod {\n-\tDAILY(7,14,30),\n-\tMONTHLY(90, 365),\n-\tYEARLY(730, 1825, 3650);\n+\tHOURLY(new int[] {1}, \"%H:00\"),\n+\tDAILY(new int[] {7,14,30}, \"%m/%d\"),\n+\tMONTHLY(new int[] {90, 365}, \"%m/%y\"),\n+\tYEARLY(new int[] {730, 1825, 3650}, \"%Y\");\n \n \tprivate int [] values;\n+\tprivate String groupByFormat;\n \n-\tprivate StatisticTimePeriod(int... values) {\n+\tprivate StatisticTimePeriod(int[] values, String groupByFormat) {\n \t\tthis.values = values;\n+\t\tthis.groupByFormat = groupByFormat;\n \t}\n \n-\tpublic int[] getDaily() {\n-\t\treturn DAILY.values;\n+\tpublic int[] getValues() {\n+\t\treturn values;\n \t}\n \n-\tpublic int[] getMonthly() {\n-\t\treturn MONTHLY.values;\n+\tpublic void setValues(int[] values) {", "originalCommit": "79f3a3ee19adfa3e6647dbe5ba385320206864e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NTEzOQ==", "url": "https://github.com/phac-nml/irida/pull/834#discussion_r512195139", "bodyText": "Looks like they are not required at all. Removed in 863ac81", "author": "deepsidhu85", "createdAt": "2020-10-26T18:53:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5OTExNg=="}], "type": "inlineReview"}, {"oid": "863ac81b3bf92f01c418d0d5b77d95511d1f96df", "url": "https://github.com/phac-nml/irida/commit/863ac81b3bf92f01c418d0d5b77d95511d1f96df", "message": "Added comments and removed setters not required for enum", "committedDate": "2020-10-26T18:53:15Z", "type": "commit"}, {"oid": "2f2501683ba267f66f41e18cea33dace7bc939cd", "url": "https://github.com/phac-nml/irida/commit/2f2501683ba267f66f41e18cea33dace7bc939cd", "message": "Merge branch 'admin-statistics/_base' into admin-statistics/_refactor-queries", "committedDate": "2020-10-28T14:09:01Z", "type": "commit"}, {"oid": "81c18b1708b93da00b19585dda49144f0181b398", "url": "https://github.com/phac-nml/irida/commit/81c18b1708b93da00b19585dda49144f0181b398", "message": "Merge branch 'admin-statistics/_base' into admin-statistics/_refactor-queries", "committedDate": "2020-11-02T15:31:11Z", "type": "commit"}, {"oid": "0f50ac580c4f7c17cfceacb1d2c828cd49f09dad", "url": "https://github.com/phac-nml/irida/commit/0f50ac580c4f7c17cfceacb1d2c828cd49f09dad", "message": "Merge branch 'admin-statistics/_base' into admin-statistics/_refactor-queries", "committedDate": "2020-11-17T16:55:55Z", "type": "commit"}, {"oid": "4a9b6a7e6e3eab4b6096e5200048d409c4dbdaca", "url": "https://github.com/phac-nml/irida/commit/4a9b6a7e6e3eab4b6096e5200048d409c4dbdaca", "message": "Merge branch 'admin-statistics/_base' into admin-statistics/_refactor-queries", "committedDate": "2020-11-18T21:25:43Z", "type": "commit"}]}