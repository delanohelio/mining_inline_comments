{"pr_number": 4010, "pr_title": "feat: Improve block placement of ceiling-supporting family", "pr_createdAt": "2020-05-31T14:16:11Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4010", "timeline": [{"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "url": "https://github.com/MovingBlocks/Terasology/commit/ea5883f823e6ea2c9583d1e14102541cdbc33269", "message": "Improve block placement of CeilingSupportingHorizontalFamily\n\nPreviously the only way to place blocks upside down, using the\nCeilingSupportingHorizontalFamily, was to attach them to a BOTTOM\nside. This commit makes it possible to achieve the same thing,\ntargeting horizontal sides.", "committedDate": "2020-05-31T16:10:45Z", "type": "commit"}, {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "url": "https://github.com/MovingBlocks/Terasology/commit/ea5883f823e6ea2c9583d1e14102541cdbc33269", "message": "Improve block placement of CeilingSupportingHorizontalFamily\n\nPreviously the only way to place blocks upside down, using the\nCeilingSupportingHorizontalFamily, was to attach them to a BOTTOM\nside. This commit makes it possible to achieve the same thing,\ntargeting horizontal sides.", "committedDate": "2020-05-31T16:10:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NTcyNw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433195727", "bodyText": "Instead of declaring mainSide and then mutating the value you could do the check first and just do a single-time assignment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (upsideDownPlacement) {\n          \n          \n            \n                        mainSide = Side.BOTTOM;\n          \n          \n            \n                    }\n          \n          \n            \n                    final Side mainSide = upsideDownPlacement ? Side.BOTTOM : Side.TOP;", "author": "skaldarnar", "createdAt": "2020-06-01T12:06:04Z", "path": "engine/src/main/java/org/terasology/world/block/family/CeilingSupportingHorizontalFamily.java", "diffHunk": "@@ -122,13 +122,16 @@ private Block transformBlock(\n \n     @Override\n     public Block getBlockForPlacement(BlockPlacementData data) {\n-        Side blockDirection = Side.inDirection(-data.viewingDirection.x(), 0, -data.viewingDirection.z());\n+        Side mainSide = Side.TOP;\n \n-        if (data.attachmentSide == Side.BOTTOM) {\n-            return blocks.get(ExtendedSide.getExtendedSideFor(Side.BOTTOM, blockDirection));\n-        } else {\n-            return blocks.get(ExtendedSide.getExtendedSideFor(Side.TOP, blockDirection));\n+        boolean upsideDownPlacement = data.attachmentSide == Side.BOTTOM\n+                || data.attachmentSide != Side.TOP && data.relativeAttachmentPosition.y() > 0.5;\n+        if (upsideDownPlacement) {\n+            mainSide = Side.BOTTOM;\n         }", "originalCommit": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIyNjIyNg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433226226", "bodyText": "Yes, much better.", "author": "kBlaszczyk", "createdAt": "2020-06-01T13:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NTcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NTc0OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433195749", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Side mainSide = Side.TOP;", "author": "skaldarnar", "createdAt": "2020-06-01T12:06:09Z", "path": "engine/src/main/java/org/terasology/world/block/family/CeilingSupportingHorizontalFamily.java", "diffHunk": "@@ -122,13 +122,16 @@ private Block transformBlock(\n \n     @Override\n     public Block getBlockForPlacement(BlockPlacementData data) {\n-        Side blockDirection = Side.inDirection(-data.viewingDirection.x(), 0, -data.viewingDirection.z());\n+        Side mainSide = Side.TOP;", "originalCommit": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NjYzMg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433196632", "bodyText": "This assumes a cubic block, right? I'm totally fine with that, but maybe we should mention that in the doc comment?", "author": "skaldarnar", "createdAt": "2020-06-01T12:08:20Z", "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemSystem.java", "diffHunk": "@@ -112,6 +121,28 @@ public void onPlaceBlock(ActivateEvent event, EntityRef item) {\n         }\n     }\n \n+    /**\n+     * Returns the position at which the block side was hit, relative to the side.\n+     * <p/>\n+     * Example: The front side was hit right in the center.\n+     * The result will be (0.5, 0.5), representing the relative hit position on the side's surface.\n+     * @param hitPosition the hit position\n+     * @param blockPosition the block position relative to its center (block (0, 0, 0) has block position (0.5, 0.5, 0.5))\n+     * @return the 2D hit position relative to the side that was hit\n+     */\n+    private Vector2f getSideHitPosition(Vector3f hitPosition, Vector3f blockPosition) {", "originalCommit": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIyNjUwMg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433226502", "bodyText": "I added some explanation.", "author": "kBlaszczyk", "createdAt": "2020-06-01T13:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NjYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NzEyNg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433197126", "bodyText": "I'm wondering whether we have convenience for that in TeraMath....", "author": "skaldarnar", "createdAt": "2020-06-01T12:09:39Z", "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemSystem.java", "diffHunk": "@@ -112,6 +121,28 @@ public void onPlaceBlock(ActivateEvent event, EntityRef item) {\n         }\n     }\n \n+    /**\n+     * Returns the position at which the block side was hit, relative to the side.\n+     * <p/>\n+     * Example: The front side was hit right in the center.\n+     * The result will be (0.5, 0.5), representing the relative hit position on the side's surface.\n+     * @param hitPosition the hit position\n+     * @param blockPosition the block position relative to its center (block (0, 0, 0) has block position (0.5, 0.5, 0.5))\n+     * @return the 2D hit position relative to the side that was hit\n+     */\n+    private Vector2f getSideHitPosition(Vector3f hitPosition, Vector3f blockPosition) {\n+        float epsilon = 0.0001f;\n+        Vector3f relativeHitPosition = new Vector3f(hitPosition).sub(blockPosition);\n+\n+        if (Math.abs(relativeHitPosition.x) > 0.5f - epsilon) {", "originalCommit": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIyODQyNw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433228427", "bodyText": "I don't know, feels rather specific.\nYou mean a convenience for \"testing if the absolute of a value is bigger than some value, considering some delta\"?\nThere are no utility functions in TeraMath using the absolute functions, so I'm pretty sure it's not in there.\nAlso, I'm not sure how to name this, in case I wanted to move it to TeraMath. Any ideas?", "author": "kBlaszczyk", "createdAt": "2020-06-01T13:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NzEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI2ODkwNw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433268907", "bodyText": "Not necessarily with the Math.abs but the comparison of floating point numbers with some \u03b5", "author": "skaldarnar", "createdAt": "2020-06-01T14:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NzEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5Nzg4Nw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433197887", "bodyText": "What about moving the null check into getSideHitPosition?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Vector2f relativePlacementPosition;\n          \n          \n            \n                    if (targetPosition != null) {\n          \n          \n            \n                        relativePlacementPosition = getSideHitPosition(event.getHitPosition(), targetPosition);\n          \n          \n            \n                    } else {\n          \n          \n            \n                        relativePlacementPosition = new Vector2f();\n          \n          \n            \n                    }\n          \n          \n            \n                    Vector2f relativePlacementPosition = getSideHitPosition(event.getHitPosition(), targetPosition);", "author": "skaldarnar", "createdAt": "2020-06-01T12:11:25Z", "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemSystem.java", "diffHunk": "@@ -90,8 +91,16 @@ public void onPlaceBlock(ActivateEvent event, EntityRef item) {\n         Vector3i placementPos = new Vector3i(targetBlock);\n         placementPos.add(surfaceSide.getVector3i());\n \n+        Vector3f targetPosition = event.getTargetLocation();\n+        Vector2f relativePlacementPosition;\n+        if (targetPosition != null) {\n+            relativePlacementPosition = getSideHitPosition(event.getHitPosition(), targetPosition);\n+        } else {\n+            relativePlacementPosition = new Vector2f();\n+        }", "originalCommit": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIzMDU4MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433230581", "bodyText": "I don't like this one.\nMy method wants a vector to work with, nobody should pass it null.\nIt is true however, that I'm cluttering up the higher level method, so I moved the null check into another private method, working on the event. I think it makes more sense that way and I hope you'll like that solution too.", "author": "kBlaszczyk", "createdAt": "2020-06-01T13:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5Nzg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MDc2Mg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433270762", "bodyText": "I surely do \ud83d\udc4d", "author": "skaldarnar", "createdAt": "2020-06-01T14:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5Nzg4Nw=="}], "type": "inlineReview"}, {"oid": "74942f08c94ea63a20a124ef5964bacdd3044ba3", "url": "https://github.com/MovingBlocks/Terasology/commit/74942f08c94ea63a20a124ef5964bacdd3044ba3", "message": "Refactor the changes.", "committedDate": "2020-06-01T13:14:34Z", "type": "commit"}]}