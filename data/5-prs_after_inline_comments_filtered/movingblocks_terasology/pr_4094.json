{"pr_number": 4094, "pr_title": "feat: Add ModifiableValue type", "pr_createdAt": "2020-07-22T11:51:06Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4094", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0NzQ0OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r458747448", "bodyText": "I'd think that we can remove the Math.max(...) for this class - a value on it's own can very well be negative! If the event wants to provide this guarantee it can wrap a ModifiableValue and perform that operation.", "author": "skaldarnar", "createdAt": "2020-07-22T12:15:58Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,99 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import gnu.trove.iterator.TFloatIterator;\n+import gnu.trove.list.TFloatList;\n+import gnu.trove.list.array.TFloatArrayList;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value\n+ * <p>\n+ * The result value is guaranteed to be greater or equal to zero.\n+ * Components using this type must mention so in their javadoc.\n+ * </p>\n+ */\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private TFloatList modifiers = new TFloatArrayList();\n+    private TFloatList multipliers = new TFloatArrayList();\n+    private TFloatList postModifiers = new TFloatArrayList();\n+\n+    public ModifiableValue(float baseValue) {\n+        this.baseValue = baseValue;\n+    }\n+\n+    public float getBaseValue() {\n+        return baseValue;\n+    }\n+\n+    public void multiply(float amount) {\n+        this.multipliers.add(amount);\n+    }\n+\n+    public void add(float amount) {\n+        modifiers.add(amount);\n+    }\n+\n+    public void postAdd(float amount) {\n+        postModifiers.add(amount);\n+    }\n+\n+    /**\n+     * Calculates the result value from the base value and given modifiers and multipliers.\n+     * <p>\n+     * The value is calculated based on the following formula:\n+     * <pre>\n+     * result = max(0, <baseValue> + \u03a3 <modifier> * \u03a0 <multiplier> + \u03a3 <postModifier>)\n+     * </pre>\n+     *\n+     * <emph>The result value is guaranteed to be non-negative!</emph>\n+     */\n+    public float getValue() {\n+        return Math.max(0, baseValue + modifiers.sum() * product(multipliers) + postModifiers.sum());", "originalCommit": "ebc98f852801f835e5a994fa91dbc88b8c518b37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0ODMyMQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r458748321", "bodyText": "I'm not sure we should offer this setter to change all modifiers at once, basically overriding everything someone else did \ud83e\udd14  Depending on whether we want this to be mutable or immutable we may offer a clear() method to reset all modifier lists, though.", "author": "skaldarnar", "createdAt": "2020-07-22T12:17:37Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,99 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import gnu.trove.iterator.TFloatIterator;\n+import gnu.trove.list.TFloatList;\n+import gnu.trove.list.array.TFloatArrayList;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value\n+ * <p>\n+ * The result value is guaranteed to be greater or equal to zero.\n+ * Components using this type must mention so in their javadoc.\n+ * </p>\n+ */\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private TFloatList modifiers = new TFloatArrayList();\n+    private TFloatList multipliers = new TFloatArrayList();\n+    private TFloatList postModifiers = new TFloatArrayList();\n+\n+    public ModifiableValue(float baseValue) {\n+        this.baseValue = baseValue;\n+    }\n+\n+    public float getBaseValue() {\n+        return baseValue;\n+    }\n+\n+    public void multiply(float amount) {\n+        this.multipliers.add(amount);\n+    }\n+\n+    public void add(float amount) {\n+        modifiers.add(amount);\n+    }\n+\n+    public void postAdd(float amount) {\n+        postModifiers.add(amount);\n+    }\n+\n+    /**\n+     * Calculates the result value from the base value and given modifiers and multipliers.\n+     * <p>\n+     * The value is calculated based on the following formula:\n+     * <pre>\n+     * result = max(0, <baseValue> + \u03a3 <modifier> * \u03a0 <multiplier> + \u03a3 <postModifier>)\n+     * </pre>\n+     *\n+     * <emph>The result value is guaranteed to be non-negative!</emph>\n+     */\n+    public float getValue() {\n+        return Math.max(0, baseValue + modifiers.sum() * product(multipliers) + postModifiers.sum());\n+    }\n+\n+    public TFloatList getModifiers() {\n+        return modifiers;\n+    }\n+\n+    public void setModifiers(TFloatList modifiers) {", "originalCommit": "ebc98f852801f835e5a994fa91dbc88b8c518b37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTI3OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r458749279", "bodyText": "I'm also not sure whether we should expose this detail to the outside - what use cases are there where it would help a consumer to know whether a modifier of +4 is because of [1, 3], [4], or [-2, 3, 0, 3] (or any other combination...)", "author": "skaldarnar", "createdAt": "2020-07-22T12:19:29Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,99 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import gnu.trove.iterator.TFloatIterator;\n+import gnu.trove.list.TFloatList;\n+import gnu.trove.list.array.TFloatArrayList;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value\n+ * <p>\n+ * The result value is guaranteed to be greater or equal to zero.\n+ * Components using this type must mention so in their javadoc.\n+ * </p>\n+ */\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private TFloatList modifiers = new TFloatArrayList();\n+    private TFloatList multipliers = new TFloatArrayList();\n+    private TFloatList postModifiers = new TFloatArrayList();\n+\n+    public ModifiableValue(float baseValue) {\n+        this.baseValue = baseValue;\n+    }\n+\n+    public float getBaseValue() {\n+        return baseValue;\n+    }\n+\n+    public void multiply(float amount) {\n+        this.multipliers.add(amount);\n+    }\n+\n+    public void add(float amount) {\n+        modifiers.add(amount);\n+    }\n+\n+    public void postAdd(float amount) {\n+        postModifiers.add(amount);\n+    }\n+\n+    /**\n+     * Calculates the result value from the base value and given modifiers and multipliers.\n+     * <p>\n+     * The value is calculated based on the following formula:\n+     * <pre>\n+     * result = max(0, <baseValue> + \u03a3 <modifier> * \u03a0 <multiplier> + \u03a3 <postModifier>)\n+     * </pre>\n+     *\n+     * <emph>The result value is guaranteed to be non-negative!</emph>\n+     */\n+    public float getValue() {\n+        return Math.max(0, baseValue + modifiers.sum() * product(multipliers) + postModifiers.sum());\n+    }\n+\n+    public TFloatList getModifiers() {", "originalCommit": "ebc98f852801f835e5a994fa91dbc88b8c518b37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTYxOA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r458749618", "bodyText": "TODO: move this to TFloatList ^^", "author": "skaldarnar", "createdAt": "2020-07-22T12:20:05Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,99 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import gnu.trove.iterator.TFloatIterator;\n+import gnu.trove.list.TFloatList;\n+import gnu.trove.list.array.TFloatArrayList;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value\n+ * <p>\n+ * The result value is guaranteed to be greater or equal to zero.\n+ * Components using this type must mention so in their javadoc.\n+ * </p>\n+ */\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private TFloatList modifiers = new TFloatArrayList();\n+    private TFloatList multipliers = new TFloatArrayList();\n+    private TFloatList postModifiers = new TFloatArrayList();\n+\n+    public ModifiableValue(float baseValue) {\n+        this.baseValue = baseValue;\n+    }\n+\n+    public float getBaseValue() {\n+        return baseValue;\n+    }\n+\n+    public void multiply(float amount) {\n+        this.multipliers.add(amount);\n+    }\n+\n+    public void add(float amount) {\n+        modifiers.add(amount);\n+    }\n+\n+    public void postAdd(float amount) {\n+        postModifiers.add(amount);\n+    }\n+\n+    /**\n+     * Calculates the result value from the base value and given modifiers and multipliers.\n+     * <p>\n+     * The value is calculated based on the following formula:\n+     * <pre>\n+     * result = max(0, <baseValue> + \u03a3 <modifier> * \u03a0 <multiplier> + \u03a3 <postModifier>)\n+     * </pre>\n+     *\n+     * <emph>The result value is guaranteed to be non-negative!</emph>\n+     */\n+    public float getValue() {\n+        return Math.max(0, baseValue + modifiers.sum() * product(multipliers) + postModifiers.sum());\n+    }\n+\n+    public TFloatList getModifiers() {\n+        return modifiers;\n+    }\n+\n+    public void setModifiers(TFloatList modifiers) {\n+        this.modifiers = modifiers;\n+    }\n+\n+    public TFloatList getMultipliers() {\n+        return multipliers;\n+    }\n+\n+    public void setMultipliers(TFloatList multipliers) {\n+        this.multipliers = multipliers;\n+    }\n+\n+    public TFloatList getPostModifiers() {\n+        return postModifiers;\n+    }\n+\n+    public void setPostModifiers(TFloatList postModifiers) {\n+        this.postModifiers = postModifiers;\n+    }\n+\n+    /**\n+     * Calculate the product of all values in the given list.\n+     * <p>\n+     * A static helper dual to {@code TFloatList#sum()}.\n+     *\n+     * @param multipliers the list of multipliers to calculate the product of.\n+     * @return the product of all values. 1 if the list is empty.\n+     */\n+    private static float product(TFloatList multipliers) {", "originalCommit": "ebc98f852801f835e5a994fa91dbc88b8c518b37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4ODcyMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r459388723", "bodyText": "Method was removed and the modifiers were changed in place as they were added.", "author": "vedant-shroff", "createdAt": "2020-07-23T11:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTgxNA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r458749814", "bodyText": "TODO: decide whether ModifiableValue should be mutable or immutable.", "author": "skaldarnar", "createdAt": "2020-07-22T12:20:28Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,99 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import gnu.trove.iterator.TFloatIterator;\n+import gnu.trove.list.TFloatList;\n+import gnu.trove.list.array.TFloatArrayList;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value\n+ * <p>\n+ * The result value is guaranteed to be greater or equal to zero.\n+ * Components using this type must mention so in their javadoc.\n+ * </p>\n+ */\n+public class ModifiableValue {", "originalCommit": "ebc98f852801f835e5a994fa91dbc88b8c518b37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4OTAwNg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r459389006", "bodyText": "Gone with the mutable approach in my latest commit #8876c27", "author": "vedant-shroff", "createdAt": "2020-07-23T11:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMjM3OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r458912379", "bodyText": "Shouldn't the multipliers also multiply the baseValue (i.e. (baseValue + modifiers.sum()) * product(multipliers) ...)?", "author": "4Denthusiast", "createdAt": "2020-07-22T16:14:23Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,99 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import gnu.trove.iterator.TFloatIterator;\n+import gnu.trove.list.TFloatList;\n+import gnu.trove.list.array.TFloatArrayList;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value\n+ * <p>\n+ * The result value is guaranteed to be greater or equal to zero.\n+ * Components using this type must mention so in their javadoc.\n+ * </p>\n+ */\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private TFloatList modifiers = new TFloatArrayList();\n+    private TFloatList multipliers = new TFloatArrayList();\n+    private TFloatList postModifiers = new TFloatArrayList();\n+\n+    public ModifiableValue(float baseValue) {\n+        this.baseValue = baseValue;\n+    }\n+\n+    public float getBaseValue() {\n+        return baseValue;\n+    }\n+\n+    public void multiply(float amount) {\n+        this.multipliers.add(amount);\n+    }\n+\n+    public void add(float amount) {\n+        modifiers.add(amount);\n+    }\n+\n+    public void postAdd(float amount) {\n+        postModifiers.add(amount);\n+    }\n+\n+    /**\n+     * Calculates the result value from the base value and given modifiers and multipliers.\n+     * <p>\n+     * The value is calculated based on the following formula:\n+     * <pre>\n+     * result = max(0, <baseValue> + \u03a3 <modifier> * \u03a0 <multiplier> + \u03a3 <postModifier>)\n+     * </pre>\n+     *\n+     * <emph>The result value is guaranteed to be non-negative!</emph>\n+     */\n+    public float getValue() {\n+        return Math.max(0, baseValue + modifiers.sum() * product(multipliers) + postModifiers.sum());", "originalCommit": "ebc98f852801f835e5a994fa91dbc88b8c518b37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2ODUwMQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r458968501", "bodyText": "obviously yes \ud83d\ude48", "author": "skaldarnar", "createdAt": "2020-07-22T17:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMjM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4ODM2Ng==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r459388366", "bodyText": "Yep silly mistake, have fixed.", "author": "vedant-shroff", "createdAt": "2020-07-23T11:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMjM3OQ=="}], "type": "inlineReview"}, {"oid": "ebc98f852801f835e5a994fa91dbc88b8c518b37", "url": "https://github.com/MovingBlocks/Terasology/commit/ebc98f852801f835e5a994fa91dbc88b8c518b37", "message": "added ModifiableValue type", "committedDate": "2020-07-22T17:13:41Z", "type": "commit"}, {"oid": "53fa98f21a5fa113f4d0f0f9ab76335011d41b29", "url": "https://github.com/MovingBlocks/Terasology/commit/53fa98f21a5fa113f4d0f0f9ab76335011d41b29", "message": "changed to single float values", "committedDate": "2020-07-23T11:26:28Z", "type": "commit"}, {"oid": "8876c270e6c70c6c57536c5866026f87345cd7cb", "url": "https://github.com/MovingBlocks/Terasology/commit/8876c270e6c70c6c57536c5866026f87345cd7cb", "message": "made mutable", "committedDate": "2020-07-23T11:39:54Z", "type": "commit"}, {"oid": "670b154e96b5db0ea3b50df472808c11c41a00ac", "url": "https://github.com/MovingBlocks/Terasology/commit/670b154e96b5db0ea3b50df472808c11c41a00ac", "message": "added inital values", "committedDate": "2020-07-23T11:51:10Z", "type": "commit"}, {"oid": "62177fd53c98b8f81819a9a1e14b31c6971e6808", "url": "https://github.com/MovingBlocks/Terasology/commit/62177fd53c98b8f81819a9a1e14b31c6971e6808", "message": "modified inital values", "committedDate": "2020-07-23T11:51:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM5OTA5Mg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r459399092", "bodyText": "This formula should be updated to match the actual value: result = (<baseValue> + \u03a3 <modifier>) * \u03a3 <multiplier> + \u03a3 <postModifier>", "author": "4Denthusiast", "createdAt": "2020-07-23T12:05:22Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value\n+ * <p>\n+ * The result value is guaranteed to be greater or equal to zero. Components using this type must mention so in their\n+ * javadoc.\n+ * </p>\n+ */\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private float preModifiers;\n+    private float multipliers;\n+    private float postModifiers;\n+\n+    public ModifiableValue(float baseValue) {\n+        this.baseValue = baseValue;\n+    }\n+\n+    public float getBaseValue() {\n+        return baseValue;\n+    }\n+\n+    public ModifiableValue multiply(float amount) {\n+        multipliers += amount;\n+        return this;\n+    }\n+\n+    public ModifiableValue preAdd(float amount) {\n+        preModifiers += amount;\n+        return this;\n+    }\n+\n+    public ModifiableValue postAdd(float amount) {\n+        postModifiers += amount;\n+        return this;\n+    }\n+\n+    /**\n+     * Calculates the result value from the base value and given modifiers and multipliers.\n+     * <p>\n+     * The value is calculated based on the following formula:\n+     * <pre>\n+     * result = max(0, <baseValue> + \u03a3 <modifier> * \u03a0 <multiplier> + \u03a3 <postModifier>)", "originalCommit": "8876c270e6c70c6c57536c5866026f87345cd7cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNDQ3OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r459404478", "bodyText": "Have changed the multiplers to compound now as per the formula", "author": "vedant-shroff", "createdAt": "2020-07-23T12:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM5OTA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNTQ3Ng==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r459405476", "bodyText": "The rest of the formula in the comment still needs changing though: result = (<baseValue> + \u03a3 <modifier>) * \u03a0 <multiplier> + \u03a3 <postModifier>", "author": "4Denthusiast", "createdAt": "2020-07-23T12:17:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM5OTA5Mg=="}], "type": "inlineReview"}, {"oid": "9112c70c4441542bf0e63f4640026177c8be9174", "url": "https://github.com/MovingBlocks/Terasology/commit/9112c70c4441542bf0e63f4640026177c8be9174", "message": "made multipliers compound", "committedDate": "2020-07-23T12:14:12Z", "type": "commit"}, {"oid": "b60d06fad6b7699c409fae83a6429967f9e9f9a7", "url": "https://github.com/MovingBlocks/Terasology/commit/b60d06fad6b7699c409fae83a6429967f9e9f9a7", "message": "adjusted javadoc", "committedDate": "2020-07-23T12:20:28Z", "type": "commit"}, {"oid": "06559df81dea4af602d54361ba2b1cb28c3fcd1e", "url": "https://github.com/MovingBlocks/Terasology/commit/06559df81dea4af602d54361ba2b1cb28c3fcd1e", "message": "added type handler and @API", "committedDate": "2020-07-24T08:03:48Z", "type": "commit"}, {"oid": "ad0269a6019e4a91dbcbbd3f78d5122c915e5c91", "url": "https://github.com/MovingBlocks/Terasology/commit/ad0269a6019e4a91dbcbbd3f78d5122c915e5c91", "message": "modified type handler", "committedDate": "2020-07-24T22:30:41Z", "type": "commit"}, {"oid": "0f20832ec6918e2f8ef07ffc44b0dabb44080285", "url": "https://github.com/MovingBlocks/Terasology/commit/0f20832ec6918e2f8ef07ffc44b0dabb44080285", "message": "reformatted code", "committedDate": "2020-07-28T11:40:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc0Mzk3NA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r461743974", "bodyText": "I'd like to have some JavaDoc here (or some documentation somewhere else) on how the ModifiableValue is actually persisted. What is the format to specify a modifiable in a prefab?\nFrom looking at the code it seems like the value is persisted as \"unlabeled\" array:\n\"<field_name>\": [<base_value>, <pre_modifier>, <multiplier>, <post_modifier>]\n\nI don't think this is very intuitive, and when seeing this in a prefab I'd think of a vector or list but not of a special data class \ud83d\ude48", "author": "skaldarnar", "createdAt": "2020-07-28T17:17:41Z", "path": "engine/src/main/java/org/terasology/persistence/typeHandling/extensionTypes/ModifiableValueTypeHandler.java", "diffHunk": "@@ -0,0 +1,45 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.persistence.typeHandling.extensionTypes;\n+\n+import gnu.trove.list.TFloatList;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.terasology.persistence.typeHandling.PersistedData;\n+import org.terasology.persistence.typeHandling.PersistedDataArray;\n+import org.terasology.persistence.typeHandling.PersistedDataSerializer;\n+import org.terasology.persistence.typeHandling.RegisterTypeHandler;\n+import org.terasology.utilities.modifiable.ModifiableValue;\n+\n+import java.util.Optional;\n+\n+@RegisterTypeHandler\n+public class ModifiableValueTypeHandler extends org.terasology.persistence.typeHandling.TypeHandler<ModifiableValue> {", "originalCommit": "0f20832ec6918e2f8ef07ffc44b0dabb44080285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4NzgwOA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r463487808", "bodyText": "Added Javadocs, the default way to specify in prefabs is with a single value only and then the modifiers are given default values.", "author": "vedant-shroff", "createdAt": "2020-07-31T08:51:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc0Mzk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc0ODA5NQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r461748095", "bodyText": "I'm wondering whether it would make sense to check an else if here for a single number. That would allow to easily specify the base value in a prefab without worrying about all the modifiers. So you could either do\n\"myValue\": 7,\t\t\t\t\t// base value only\n// ... or ...\n\"otherValaue\": [3, 0, 0.9, 2]\t// base and modifiers/multiplier", "author": "skaldarnar", "createdAt": "2020-07-28T17:24:37Z", "path": "engine/src/main/java/org/terasology/persistence/typeHandling/extensionTypes/ModifiableValueTypeHandler.java", "diffHunk": "@@ -0,0 +1,45 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.persistence.typeHandling.extensionTypes;\n+\n+import gnu.trove.list.TFloatList;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.terasology.persistence.typeHandling.PersistedData;\n+import org.terasology.persistence.typeHandling.PersistedDataArray;\n+import org.terasology.persistence.typeHandling.PersistedDataSerializer;\n+import org.terasology.persistence.typeHandling.RegisterTypeHandler;\n+import org.terasology.utilities.modifiable.ModifiableValue;\n+\n+import java.util.Optional;\n+\n+@RegisterTypeHandler\n+public class ModifiableValueTypeHandler extends org.terasology.persistence.typeHandling.TypeHandler<ModifiableValue> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ModifiableValueTypeHandler.class);\n+\n+    @Override\n+    public PersistedData serializeNonNull(ModifiableValue value, PersistedDataSerializer serializer) {\n+        return serializer.serialize(value.getBaseValue(), value.getPreModifiers(), value.getMultipliers(),\n+                value.getPostModifiers());\n+    }\n+\n+    @Override\n+    public Optional<ModifiableValue> deserialize(PersistedData data) {\n+        if (data.isArray()) {\n+            PersistedDataArray vals = data.getAsArray();\n+            if (vals.isNumberArray()) {\n+                TFloatList floatList = vals.getAsFloatArray();\n+                ModifiableValue modifiableValue = new ModifiableValue(floatList.get(0));\n+                if (floatList.size() > 1) {\n+                    modifiableValue.setPreModifiers(floatList.get(1));\n+                    modifiableValue.setMultipliers(floatList.get(2));\n+                    modifiableValue.setPostModifiers(floatList.get(3));\n+                }\n+                return Optional.of(modifiableValue);\n+            }\n+        }", "originalCommit": "0f20832ec6918e2f8ef07ffc44b0dabb44080285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ3NzgwNw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r463477807", "bodyText": "This is handled by default as the constructor takes the base value and assigns default modifiers. The single value specified in the prefabs is deserialized into the constructor for ModifiableValue which takes only the base value. Other modifiers can be set optionally", "author": "vedant-shroff", "createdAt": "2020-07-31T08:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc0ODA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc0ODkyMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r461748923", "bodyText": "Shouldn't this check that the size is actually exactly 4? Otherwise, floatList.get(n) would fail...", "author": "skaldarnar", "createdAt": "2020-07-28T17:25:48Z", "path": "engine/src/main/java/org/terasology/persistence/typeHandling/extensionTypes/ModifiableValueTypeHandler.java", "diffHunk": "@@ -0,0 +1,45 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.persistence.typeHandling.extensionTypes;\n+\n+import gnu.trove.list.TFloatList;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.terasology.persistence.typeHandling.PersistedData;\n+import org.terasology.persistence.typeHandling.PersistedDataArray;\n+import org.terasology.persistence.typeHandling.PersistedDataSerializer;\n+import org.terasology.persistence.typeHandling.RegisterTypeHandler;\n+import org.terasology.utilities.modifiable.ModifiableValue;\n+\n+import java.util.Optional;\n+\n+@RegisterTypeHandler\n+public class ModifiableValueTypeHandler extends org.terasology.persistence.typeHandling.TypeHandler<ModifiableValue> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ModifiableValueTypeHandler.class);\n+\n+    @Override\n+    public PersistedData serializeNonNull(ModifiableValue value, PersistedDataSerializer serializer) {\n+        return serializer.serialize(value.getBaseValue(), value.getPreModifiers(), value.getMultipliers(),\n+                value.getPostModifiers());\n+    }\n+\n+    @Override\n+    public Optional<ModifiableValue> deserialize(PersistedData data) {\n+        if (data.isArray()) {\n+            PersistedDataArray vals = data.getAsArray();\n+            if (vals.isNumberArray()) {\n+                TFloatList floatList = vals.getAsFloatArray();\n+                ModifiableValue modifiableValue = new ModifiableValue(floatList.get(0));\n+                if (floatList.size() > 1) {", "originalCommit": "0f20832ec6918e2f8ef07ffc44b0dabb44080285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4NzMxMg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r463487312", "bodyText": "Since the size can only be 1(when deserializing the prefabs) or 4(on a game load after a seed has been harvested), this would not cause any problems. However, this seems like the right thing to do in general. Have made the change.", "author": "vedant-shroff", "createdAt": "2020-07-31T08:50:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc0ODkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MDAxMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r461750013", "bodyText": "As these are simple float values they should not be named in plural form (that makes more sense for lists or arrays):\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private float preModifiers;\n          \n          \n            \n                private float multipliers;\n          \n          \n            \n                private float postModifiers;\n          \n          \n            \n                private float preModifier;\n          \n          \n            \n                private float multiplier;\n          \n          \n            \n                private float postModifier;", "author": "skaldarnar", "createdAt": "2020-07-28T17:27:32Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,85 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import org.terasology.module.sandbox.API;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value.\n+ * <p>\n+ * Components using this type must mention so in their javadoc so all modifiers are added correctly.\n+ * </p>\n+ */\n+@API\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private float preModifiers;\n+    private float multipliers;\n+    private float postModifiers;", "originalCommit": "0f20832ec6918e2f8ef07ffc44b0dabb44080285", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MjU4Mw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r461752583", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public float getPreModifiers() {\n          \n          \n            \n                    return preModifiers;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public float getPostModifiers() {\n          \n          \n            \n                    return postModifiers;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public float getMultipliers() {\n          \n          \n            \n                    return multipliers;\n          \n          \n            \n                }\n          \n          \n            \n                public float getPreModifier() {\n          \n          \n            \n                    return preModifier;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public float getPostModifier() {\n          \n          \n            \n                    return postModifier;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public float getMultiplier() {\n          \n          \n            \n                    return multiplier;\n          \n          \n            \n                }", "author": "skaldarnar", "createdAt": "2020-07-28T17:31:38Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,85 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import org.terasology.module.sandbox.API;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value.\n+ * <p>\n+ * Components using this type must mention so in their javadoc so all modifiers are added correctly.\n+ * </p>\n+ */\n+@API\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private float preModifiers;\n+    private float multipliers;\n+    private float postModifiers;\n+\n+    public ModifiableValue(float baseValue) {\n+        preModifiers=0;\n+        multipliers=1;\n+        postModifiers=0;\n+        this.baseValue=baseValue;\n+    }\n+\n+    public float getBaseValue() {\n+        return baseValue;\n+    }\n+\n+    public ModifiableValue multiply(float amount) {\n+        multipliers *= amount;\n+        return this;\n+    }\n+\n+    public ModifiableValue preAdd(float amount) {\n+        preModifiers += amount;\n+        return this;\n+    }\n+\n+    public ModifiableValue postAdd(float amount) {\n+        postModifiers += amount;\n+        return this;\n+    }\n+\n+    /**\n+     * Calculates the result value from the base value and given modifiers and multipliers.\n+     * <p>\n+     * The value is calculated based on the following formula:\n+     * <pre>\n+     * result = (<baseValue> + \u03a3 <modifier>) * \u03a0 <multiplier> + \u03a3 <postModifier>\n+     * </pre>\n+     *\n+     * <emph>non-negativity of the value is not ensured and must be checked by the system if needed</emph>\n+     */\n+    public float getValue() {\n+        return (baseValue + preModifiers) * multipliers + postModifiers;\n+    }\n+\n+    public float getPreModifiers() {\n+        return preModifiers;\n+    }\n+\n+    public float getPostModifiers() {\n+        return postModifiers;\n+    }\n+\n+    public float getMultipliers() {\n+        return multipliers;\n+    }", "originalCommit": "0f20832ec6918e2f8ef07ffc44b0dabb44080285", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MzU1NA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r461753554", "bodyText": "I'd say these methods should have JavaDoc to encourage usage of the preAdd, postAdd, and multiply instead of overriding the respective value.", "author": "skaldarnar", "createdAt": "2020-07-28T17:33:18Z", "path": "engine/src/main/java/org/terasology/utilities/modifiable/ModifiableValue.java", "diffHunk": "@@ -0,0 +1,85 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.utilities.modifiable;\n+\n+import org.terasology.module.sandbox.API;\n+\n+/**\n+ * A helper type to get and modify the value of a component without changing its actual value.\n+ * <p>\n+ * Components using this type must mention so in their javadoc so all modifiers are added correctly.\n+ * </p>\n+ */\n+@API\n+public class ModifiableValue {\n+    private final float baseValue;\n+\n+    private float preModifiers;\n+    private float multipliers;\n+    private float postModifiers;\n+\n+    public ModifiableValue(float baseValue) {\n+        preModifiers=0;\n+        multipliers=1;\n+        postModifiers=0;\n+        this.baseValue=baseValue;\n+    }\n+\n+    public float getBaseValue() {\n+        return baseValue;\n+    }\n+\n+    public ModifiableValue multiply(float amount) {\n+        multipliers *= amount;\n+        return this;\n+    }\n+\n+    public ModifiableValue preAdd(float amount) {\n+        preModifiers += amount;\n+        return this;\n+    }\n+\n+    public ModifiableValue postAdd(float amount) {\n+        postModifiers += amount;\n+        return this;\n+    }\n+\n+    /**\n+     * Calculates the result value from the base value and given modifiers and multipliers.\n+     * <p>\n+     * The value is calculated based on the following formula:\n+     * <pre>\n+     * result = (<baseValue> + \u03a3 <modifier>) * \u03a0 <multiplier> + \u03a3 <postModifier>\n+     * </pre>\n+     *\n+     * <emph>non-negativity of the value is not ensured and must be checked by the system if needed</emph>\n+     */\n+    public float getValue() {\n+        return (baseValue + preModifiers) * multipliers + postModifiers;\n+    }\n+\n+    public float getPreModifiers() {\n+        return preModifiers;\n+    }\n+\n+    public float getPostModifiers() {\n+        return postModifiers;\n+    }\n+\n+    public float getMultipliers() {\n+        return multipliers;\n+    }\n+\n+    public void setPreModifiers(float preModifiers){\n+        this.preModifiers=preModifiers;\n+    }\n+\n+    public void setMultipliers(float multipliers){\n+        this.multipliers=multipliers;\n+    }\n+\n+    public void setPostModifiers(float postModifiers){\n+        this.postModifiers=postModifiers;\n+    }", "originalCommit": "0f20832ec6918e2f8ef07ffc44b0dabb44080285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4NDA5MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4094#discussion_r463484091", "bodyText": "Done \ud83d\udc4d", "author": "vedant-shroff", "createdAt": "2020-07-31T08:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MzU1NA=="}], "type": "inlineReview"}, {"oid": "1978c8f7b18b2c49409a9e50fa237daa1b1889fb", "url": "https://github.com/MovingBlocks/Terasology/commit/1978c8f7b18b2c49409a9e50fa237daa1b1889fb", "message": "formatting and javadocs", "committedDate": "2020-07-31T08:52:36Z", "type": "commit"}]}