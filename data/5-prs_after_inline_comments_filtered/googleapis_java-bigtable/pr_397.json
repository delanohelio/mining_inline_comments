{"pr_number": 397, "pr_title": "fix: Filters should be serializable", "pr_createdAt": "2020-08-28T10:19:29Z", "pr_url": "https://github.com/googleapis/java-bigtable/pull/397", "timeline": [{"oid": "b78063fe7618ffaa0c8ceea69d2c11a2ed0d2bcd", "url": "https://github.com/googleapis/java-bigtable/commit/b78063fe7618ffaa0c8ceea69d2c11a2ed0d2bcd", "message": "fix: Filters should be serializable", "committedDate": "2020-08-28T09:11:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE1NDkxMA==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r480154910", "bodyText": "unfortunately anything in the proto-* or grpc-* modules are auto generated and cannot be modified by hand.", "author": "kolea2", "createdAt": "2020-08-31T14:07:14Z", "path": "proto-google-cloud-bigtable-v2/src/main/java/com/google/bigtable/v2/RowFilterOrBuilder.java", "diffHunk": "@@ -18,10 +18,13 @@\n \n package com.google.bigtable.v2;\n \n+import java.io.Serializable;\n+\n public interface RowFilterOrBuilder\n     extends\n-    // @@protoc_insertion_point(interface_extends:google.bigtable.v2.RowFilter)\n-    com.google.protobuf.MessageOrBuilder {\n+        // @@protoc_insertion_point(interface_extends:google.bigtable.v2.RowFilter)", "originalCommit": "b78063fe7618ffaa0c8ceea69d2c11a2ed0d2bcd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4Nzg5Mg==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481987892", "bodyText": "thanks, the changes are rolled back.", "author": "dmitry-fa", "createdAt": "2020-09-02T11:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE1NDkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1NjcyNw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r480256727", "bodyText": "Can we avoid file creation and use a Byte{Input,Output}Stream instead?", "author": "igorbernstein2", "createdAt": "2020-08-31T16:49:53Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/models/FiltersTest.java", "diffHunk": "@@ -528,4 +540,44 @@ public void labelTest() {\n \n     assertThat(actualFilter).isEqualTo(expectedFilter);\n   }\n+\n+  @Test\n+  public void serializationTest() {\n+    // checks that the all objects returned by the all methods of the Filters class\n+    // can be serialized/deserialized.\n+\n+    // map methodName -> methodArguments (for those methods which require parameters)\n+    Map<String, Object[]> parameterMap = new HashMap<>();\n+    parameterMap.put(\"condition\", new Object[] {FILTERS.pass()});\n+    parameterMap.put(\"label\", new Object[] {\"label\"});\n+    parameterMap.put(\"fromProto\", new Object[] {FILTERS.label(\"label\").toProto()});\n+\n+    for (Method m : Filters.class.getDeclaredMethods()) {\n+      String name = m.getName();\n+      if (Modifier.isPublic(m.getModifiers())) {\n+        Object[] params = parameterMap.get(name);\n+        if (params == null) {\n+          params = new Object[] {};\n+        }\n+        try {\n+          trySerialization(m.invoke(FILTERS, params));\n+        } catch (Exception e) {\n+          fail(name + \": \" + e);\n+        }\n+      }\n+    }\n+  }\n+\n+  private void trySerialization(Object obj) throws IOException, ClassNotFoundException {\n+    Path serFile = Files.createTempFile(\"filter\", \".ser\");", "originalCommit": "b78063fe7618ffaa0c8ceea69d2c11a2ed0d2bcd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4ODAxOQ==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481988019", "bodyText": "done", "author": "dmitry-fa", "createdAt": "2020-09-02T11:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1NjcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2MTEwMg==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r480261102", "bodyText": "I think it would be cleaner to restructure this as:\nif (!public) { continue };\n\nswitch(name) {\n  case \"condition\":\n    assertSerializable(FILTERS.condition(FILTERS.pass());\n    break;\n  case \"label\": ...\n  case \"fromProto\": ...\n  default:\n   assertSerializable(m.invoke());\n}```", "author": "igorbernstein2", "createdAt": "2020-08-31T16:56:16Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/models/FiltersTest.java", "diffHunk": "@@ -528,4 +540,44 @@ public void labelTest() {\n \n     assertThat(actualFilter).isEqualTo(expectedFilter);\n   }\n+\n+  @Test\n+  public void serializationTest() {\n+    // checks that the all objects returned by the all methods of the Filters class\n+    // can be serialized/deserialized.\n+\n+    // map methodName -> methodArguments (for those methods which require parameters)\n+    Map<String, Object[]> parameterMap = new HashMap<>();\n+    parameterMap.put(\"condition\", new Object[] {FILTERS.pass()});\n+    parameterMap.put(\"label\", new Object[] {\"label\"});\n+    parameterMap.put(\"fromProto\", new Object[] {FILTERS.label(\"label\").toProto()});\n+\n+    for (Method m : Filters.class.getDeclaredMethods()) {\n+      String name = m.getName();\n+      if (Modifier.isPublic(m.getModifiers())) {\n+        Object[] params = parameterMap.get(name);", "originalCommit": "b78063fe7618ffaa0c8ceea69d2c11a2ed0d2bcd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4OTQ5Mw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481989493", "bodyText": "done with a minor change:\nif (!public) {continue} \nswtich()...\n\n->\nif (public) {\n  swtich()...\n} \n\nI don't like using continue, but if you insist, I'll update as you suggested.", "author": "dmitry-fa", "createdAt": "2020-09-02T11:13:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2MTEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2MjA3Nw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r480262077", "bodyText": "This an autogenerated file, you cant modify it", "author": "igorbernstein2", "createdAt": "2020-08-31T16:57:58Z", "path": "proto-google-cloud-bigtable-v2/src/main/java/com/google/bigtable/v2/RowFilter.java", "diffHunk": "@@ -18,6 +18,8 @@\n \n package com.google.bigtable.v2;\n \n+import java.io.Serializable;", "originalCommit": "b78063fe7618ffaa0c8ceea69d2c11a2ed0d2bcd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI1NjQzMA==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481256430", "bodyText": "Yes, I see. Is there any way to customize the way how this class is generated?", "author": "dmitry-fa", "createdAt": "2020-09-01T16:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2MjA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMwOTAyNw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481309027", "bodyText": "Oh, looks like it's not needed.", "author": "dmitry-fa", "createdAt": "2020-09-01T17:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2MjA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4OTc2OQ==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481989769", "bodyText": "changes are rolled back.", "author": "dmitry-fa", "createdAt": "2020-09-02T11:14:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2MjA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2NDAxOQ==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r480264019", "bodyText": "Here and everwhere else: The proto builders will need to be marked transient and you will need to implement writeObject/readObject to serialize the built protos:\nvoid writeObject(ObjectOutputStream s) {\n  s.defaultWriteObject();\n  s.writeObject(builder.build());\n}", "author": "igorbernstein2", "createdAt": "2020-08-31T17:01:32Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/models/Filters.java", "diffHunk": "@@ -200,6 +200,7 @@ public Filter label(@Nonnull String label) {\n   // Implementations of target specific filters.\n   /** DSL for adding filters to a chain. */\n   public static final class ChainFilter implements Filter {\n+    private static final long serialVersionUID = -89237431180618430L;", "originalCommit": "b78063fe7618ffaa0c8ceea69d2c11a2ed0d2bcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b3723f2271cd247d681936d01b9cd179b56fe841", "url": "https://github.com/googleapis/java-bigtable/commit/b3723f2271cd247d681936d01b9cd179b56fe841", "message": "rollback changes to generated files", "committedDate": "2020-09-01T15:48:35Z", "type": "commit"}, {"oid": "2208adbd2b09d0cfda88aadfecf8ab531699ee35", "url": "https://github.com/googleapis/java-bigtable/commit/2208adbd2b09d0cfda88aadfecf8ab531699ee35", "message": "customize serialization of builders", "committedDate": "2020-09-01T17:27:05Z", "type": "commit"}, {"oid": "94ca9ec52cec53bac3810cabda9451145b090a97", "url": "https://github.com/googleapis/java-bigtable/commit/94ca9ec52cec53bac3810cabda9451145b090a97", "message": "customize serialization of builders", "committedDate": "2020-09-02T10:16:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDI1Mw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481990253", "bodyText": "why if? when is this false?", "author": "igorbernstein2", "createdAt": "2020-09-02T11:15:09Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/models/FiltersTest.java", "diffHunk": "@@ -528,4 +538,66 @@ public void labelTest() {\n \n     assertThat(actualFilter).isEqualTo(expectedFilter);\n   }\n+\n+  @Test\n+  public void serializationTest() throws InvocationTargetException, IllegalAccessException {\n+    // checks that the all objects returned by the all methods of the Filters class\n+    // can be serialized/deserialized.\n+\n+    for (Method m : Filters.class.getDeclaredMethods()) {\n+      String name = m.getName();\n+      if (Modifier.isPublic(m.getModifiers())) {\n+        switch (name) {\n+          case \"condition\":\n+            checkSerialization(\n+                name,\n+                FILTERS\n+                    .condition(\n+                        FILTERS\n+                            .chain()\n+                            .filter(FILTERS.qualifier().exactMatch(\"data_plan_10gb\"))\n+                            .filter(FILTERS.value().exactMatch(\"true\")))\n+                    .then(FILTERS.label(\"passed-filter\"))\n+                    .otherwise(FILTERS.label(\"filtered-out\")));\n+            break;\n+          case \"label\":\n+            checkSerialization(name, FILTERS.label(\"label\"));\n+            break;\n+          case \"fromProto\":\n+            checkSerialization(name, FILTERS.label(\"label\").toProto());\n+            break;\n+          default:\n+            checkSerialization(name, m.invoke(FILTERS));\n+        }\n+      }\n+    }\n+  }\n+\n+  private void checkSerialization(String name, Object filter) {\n+    try {\n+      Object deserialized = serializeDeserialize(filter);\n+      if (filter instanceof Filters.Filter) {", "originalCommit": "94ca9ec52cec53bac3810cabda9451145b090a97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MjQyNw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481992427", "bodyText": "Filters.Filter interface declares toProto() which I can call to verify the deserialized object.\nIf this is false, I can't check anything more.", "author": "dmitry-fa", "createdAt": "2020-09-02T11:19:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAxNzQwMw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r482017403", "bodyText": "But when is it false? from what I can tell all methods defined on Filters return a Filter. If I'm missing something and there are methods that dont return a Filter, then we need to have an explicit whitelist. As it stands its very easy for this test to miss testing a method", "author": "igorbernstein2", "createdAt": "2020-09-02T12:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAyNDE4NA==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r482024184", "bodyText": "it's ~50-50:\na filter 'condition' ConditionFilter\na filter 'label' SimpleFilter\na filter 'chain' ChainFilter\na filter 'interleave' InterleaveFilter\na filter 'pass' SimpleFilter\na filter 'block' SimpleFilter\na filter 'sink' SimpleFilter\nnot a filter 'family' FamilyFilter\nnot a filter 'fromProto' RowFilter\nnot a filter 'qualifier' QualifierFilter\nnot a filter 'limit' LimitFilter\nnot a filter 'value' ValueFilter\nnot a filter 'offset' OffsetFilter\nnot a filter 'key' KeyFilter\nnot a filter 'timestamp' TimestampFilter", "author": "dmitry-fa", "createdAt": "2020-09-02T12:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAyNzc3OA==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r482027778", "bodyText": "So that means the vast majority of the filters arent getting tested, right?\nie we would want to ensure that qualifier().regex() produces a serializable filter. I think we would want to include a switch case for the not filters and do another loop:\nswitch(name) {\ncase \"qualifier\":\nverifyQualifierFilters();\n...\n}\nverifyQualifierFilters(QualifierFilter f) {\nfor (Method m : f.class.getDeclaredMethods()) {\n// ...\n}", "author": "igorbernstein2", "createdAt": "2020-09-02T12:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA4Mzk4MA==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r482083980", "bodyText": "qualifier().regex()  does not use any object fields it could be made static, so serialization-deserialization doesn't affect it.\nI suggested a better approach to verify non-filter instances, please check.", "author": "dmitry-fa", "createdAt": "2020-09-02T13:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwNzE3Nw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r490807177", "bodyText": "@igorbernstein2 please take a look at new tests", "author": "dmitry-fa", "createdAt": "2020-09-18T09:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyMDExMA==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r492820110", "bodyText": "@igorbernstein2 gentle ping, in case you missed this update of the tests. I did as you asked for.", "author": "dmitry-fa", "createdAt": "2020-09-22T15:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDkxNQ==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481990915", "bodyText": "Please use https://truth.dev/", "author": "igorbernstein2", "createdAt": "2020-09-02T11:16:30Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/models/FiltersTest.java", "diffHunk": "@@ -528,4 +538,66 @@ public void labelTest() {\n \n     assertThat(actualFilter).isEqualTo(expectedFilter);\n   }\n+\n+  @Test\n+  public void serializationTest() throws InvocationTargetException, IllegalAccessException {\n+    // checks that the all objects returned by the all methods of the Filters class\n+    // can be serialized/deserialized.\n+\n+    for (Method m : Filters.class.getDeclaredMethods()) {\n+      String name = m.getName();\n+      if (Modifier.isPublic(m.getModifiers())) {\n+        switch (name) {\n+          case \"condition\":\n+            checkSerialization(\n+                name,\n+                FILTERS\n+                    .condition(\n+                        FILTERS\n+                            .chain()\n+                            .filter(FILTERS.qualifier().exactMatch(\"data_plan_10gb\"))\n+                            .filter(FILTERS.value().exactMatch(\"true\")))\n+                    .then(FILTERS.label(\"passed-filter\"))\n+                    .otherwise(FILTERS.label(\"filtered-out\")));\n+            break;\n+          case \"label\":\n+            checkSerialization(name, FILTERS.label(\"label\"));\n+            break;\n+          case \"fromProto\":\n+            checkSerialization(name, FILTERS.label(\"label\").toProto());\n+            break;\n+          default:\n+            checkSerialization(name, m.invoke(FILTERS));\n+        }\n+      }\n+    }\n+  }\n+\n+  private void checkSerialization(String name, Object filter) {\n+    try {\n+      Object deserialized = serializeDeserialize(filter);\n+      if (filter instanceof Filters.Filter) {\n+        RowFilter protoBefore = ((Filters.Filter) filter).toProto();\n+        RowFilter protoAfter = ((Filters.Filter) deserialized).toProto();\n+        assertEquals(", "originalCommit": "94ca9ec52cec53bac3810cabda9451145b090a97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAwNzQ4Nw==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r482007487", "bodyText": "done", "author": "dmitry-fa", "createdAt": "2020-09-02T11:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTA2NQ==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481991065", "bodyText": "static?", "author": "igorbernstein2", "createdAt": "2020-09-02T11:16:49Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/models/FiltersTest.java", "diffHunk": "@@ -528,4 +538,66 @@ public void labelTest() {\n \n     assertThat(actualFilter).isEqualTo(expectedFilter);\n   }\n+\n+  @Test\n+  public void serializationTest() throws InvocationTargetException, IllegalAccessException {\n+    // checks that the all objects returned by the all methods of the Filters class\n+    // can be serialized/deserialized.\n+\n+    for (Method m : Filters.class.getDeclaredMethods()) {\n+      String name = m.getName();\n+      if (Modifier.isPublic(m.getModifiers())) {\n+        switch (name) {\n+          case \"condition\":\n+            checkSerialization(\n+                name,\n+                FILTERS\n+                    .condition(\n+                        FILTERS\n+                            .chain()\n+                            .filter(FILTERS.qualifier().exactMatch(\"data_plan_10gb\"))\n+                            .filter(FILTERS.value().exactMatch(\"true\")))\n+                    .then(FILTERS.label(\"passed-filter\"))\n+                    .otherwise(FILTERS.label(\"filtered-out\")));\n+            break;\n+          case \"label\":\n+            checkSerialization(name, FILTERS.label(\"label\"));\n+            break;\n+          case \"fromProto\":\n+            checkSerialization(name, FILTERS.label(\"label\").toProto());\n+            break;\n+          default:\n+            checkSerialization(name, m.invoke(FILTERS));\n+        }\n+      }\n+    }\n+  }\n+\n+  private void checkSerialization(String name, Object filter) {\n+    try {\n+      Object deserialized = serializeDeserialize(filter);\n+      if (filter instanceof Filters.Filter) {\n+        RowFilter protoBefore = ((Filters.Filter) filter).toProto();\n+        RowFilter protoAfter = ((Filters.Filter) deserialized).toProto();\n+        assertEquals(\n+            \"'\" + name + \"' filter protoBuf mismatch after deserialization\",\n+            protoBefore,\n+            protoAfter);\n+      }\n+    } catch (IOException | ClassNotFoundException e) {\n+      fail(name + \": \" + e);\n+    }\n+  }\n+\n+  private Object serializeDeserialize(Object obj) throws IOException, ClassNotFoundException {", "originalCommit": "94ca9ec52cec53bac3810cabda9451145b090a97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MzgyOA==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481993828", "bodyText": "yes.\nI'm thinking about moving this method to a utility class because it's very generic and could be used by any tests for serialization. Do you know a better place for it?", "author": "dmitry-fa", "createdAt": "2020-09-02T11:21:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAwNzU1Ng==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r482007556", "bodyText": "done", "author": "dmitry-fa", "createdAt": "2020-09-02T11:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTE4MQ==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481991181", "bodyText": "static?", "author": "igorbernstein2", "createdAt": "2020-09-02T11:17:02Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/models/FiltersTest.java", "diffHunk": "@@ -528,4 +538,66 @@ public void labelTest() {\n \n     assertThat(actualFilter).isEqualTo(expectedFilter);\n   }\n+\n+  @Test\n+  public void serializationTest() throws InvocationTargetException, IllegalAccessException {\n+    // checks that the all objects returned by the all methods of the Filters class\n+    // can be serialized/deserialized.\n+\n+    for (Method m : Filters.class.getDeclaredMethods()) {\n+      String name = m.getName();\n+      if (Modifier.isPublic(m.getModifiers())) {\n+        switch (name) {\n+          case \"condition\":\n+            checkSerialization(\n+                name,\n+                FILTERS\n+                    .condition(\n+                        FILTERS\n+                            .chain()\n+                            .filter(FILTERS.qualifier().exactMatch(\"data_plan_10gb\"))\n+                            .filter(FILTERS.value().exactMatch(\"true\")))\n+                    .then(FILTERS.label(\"passed-filter\"))\n+                    .otherwise(FILTERS.label(\"filtered-out\")));\n+            break;\n+          case \"label\":\n+            checkSerialization(name, FILTERS.label(\"label\"));\n+            break;\n+          case \"fromProto\":\n+            checkSerialization(name, FILTERS.label(\"label\").toProto());\n+            break;\n+          default:\n+            checkSerialization(name, m.invoke(FILTERS));\n+        }\n+      }\n+    }\n+  }\n+\n+  private void checkSerialization(String name, Object filter) {", "originalCommit": "94ca9ec52cec53bac3810cabda9451145b090a97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAwNzYwNg==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r482007606", "bodyText": "done", "author": "dmitry-fa", "createdAt": "2020-09-02T11:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTcwNQ==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481991705", "bodyText": "why not just bubble the exception up?", "author": "igorbernstein2", "createdAt": "2020-09-02T11:18:00Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/models/FiltersTest.java", "diffHunk": "@@ -528,4 +538,66 @@ public void labelTest() {\n \n     assertThat(actualFilter).isEqualTo(expectedFilter);\n   }\n+\n+  @Test\n+  public void serializationTest() throws InvocationTargetException, IllegalAccessException {\n+    // checks that the all objects returned by the all methods of the Filters class\n+    // can be serialized/deserialized.\n+\n+    for (Method m : Filters.class.getDeclaredMethods()) {\n+      String name = m.getName();\n+      if (Modifier.isPublic(m.getModifiers())) {\n+        switch (name) {\n+          case \"condition\":\n+            checkSerialization(\n+                name,\n+                FILTERS\n+                    .condition(\n+                        FILTERS\n+                            .chain()\n+                            .filter(FILTERS.qualifier().exactMatch(\"data_plan_10gb\"))\n+                            .filter(FILTERS.value().exactMatch(\"true\")))\n+                    .then(FILTERS.label(\"passed-filter\"))\n+                    .otherwise(FILTERS.label(\"filtered-out\")));\n+            break;\n+          case \"label\":\n+            checkSerialization(name, FILTERS.label(\"label\"));\n+            break;\n+          case \"fromProto\":\n+            checkSerialization(name, FILTERS.label(\"label\").toProto());\n+            break;\n+          default:\n+            checkSerialization(name, m.invoke(FILTERS));\n+        }\n+      }\n+    }\n+  }\n+\n+  private void checkSerialization(String name, Object filter) {\n+    try {\n+      Object deserialized = serializeDeserialize(filter);\n+      if (filter instanceof Filters.Filter) {\n+        RowFilter protoBefore = ((Filters.Filter) filter).toProto();\n+        RowFilter protoAfter = ((Filters.Filter) deserialized).toProto();\n+        assertEquals(\n+            \"'\" + name + \"' filter protoBuf mismatch after deserialization\",\n+            protoBefore,\n+            protoAfter);\n+      }\n+    } catch (IOException | ClassNotFoundException e) {\n+      fail(name + \": \" + e);", "originalCommit": "94ca9ec52cec53bac3810cabda9451145b090a97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5NzEyOQ==", "url": "https://github.com/googleapis/java-bigtable/pull/397#discussion_r481997129", "bodyText": "in case of this exception, one will have a hard time trying to find which filter caused it. fail(name + \": \" + e) tells the name of filter in trouble.", "author": "dmitry-fa", "createdAt": "2020-09-02T11:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTcwNQ=="}], "type": "inlineReview"}, {"oid": "9ce579f31b4b99c8cbcc1aac7e8a6899313e8ed0", "url": "https://github.com/googleapis/java-bigtable/commit/9ce579f31b4b99c8cbcc1aac7e8a6899313e8ed0", "message": "customize serialization of builders", "committedDate": "2020-09-02T11:47:16Z", "type": "commit"}, {"oid": "e63841e0d9b25bb00de80bb00b094de001dd28ca", "url": "https://github.com/googleapis/java-bigtable/commit/e63841e0d9b25bb00de80bb00b094de001dd28ca", "message": "check serialization of non-filter instances", "committedDate": "2020-09-02T13:41:37Z", "type": "commit"}, {"oid": "2683ee7c724a3bcc6032697d1c82679518373b19", "url": "https://github.com/googleapis/java-bigtable/commit/2683ee7c724a3bcc6032697d1c82679518373b19", "message": "test for spawned filters", "committedDate": "2020-09-18T08:59:13Z", "type": "commit"}]}