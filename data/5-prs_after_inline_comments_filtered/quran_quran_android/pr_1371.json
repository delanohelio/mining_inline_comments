{"pr_number": 1371, "pr_title": "1365/ Add ToastCompat with support for dark toasts on pre-R", "pr_createdAt": "2020-05-31T17:42:29Z", "pr_url": "https://github.com/quran/quran_android/pull/1371", "timeline": [{"oid": "f887ce8f6dc8544f77f08fda33a930f09fb6465d", "url": "https://github.com/quran/quran_android/commit/f887ce8f6dc8544f77f08fda33a930f09fb6465d", "message": "Add ToastCompat with support for dark toasts on pre-R", "committedDate": "2020-05-31T17:48:44Z", "type": "commit"}, {"oid": "f887ce8f6dc8544f77f08fda33a930f09fb6465d", "url": "https://github.com/quran/quran_android/commit/f887ce8f6dc8544f77f08fda33a930f09fb6465d", "message": "Add ToastCompat with support for dark toasts on pre-R", "committedDate": "2020-05-31T17:48:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2ODQ0Mg==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432968442", "bodyText": "It's not possible for us to change the colors without getting a reference to the Toast itself because:\n\nthe attribute it uses for the background is private\nit doesn't use attributes for the text color - it's hardcoded", "author": "ataulm", "createdAt": "2020-05-31T17:44:10Z", "path": "app/src/main/java/com/quran/labs/androidquran/QuranAdvancedPreferenceActivity.java", "diffHunk": "@@ -82,7 +83,7 @@ public void requestWriteExternalSdcardPermission(String newLocation) {\n           REQUEST_WRITE_TO_SDCARD_PERMISSION);\n     } else {\n       // in the future, we should make this a direct link - perhaps using a Snackbar.\n-      Toast.makeText(this, R.string.please_grant_permissions, Toast.LENGTH_SHORT).show();\n+      ToastCompat.makeText(this, R.string.please_grant_permissions, Toast.LENGTH_SHORT).show();", "originalCommit": "32b78007c3bd52da1819c42e529f3dac05f3a422", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2ODUwNQ==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432968505", "bodyText": "There's no built-in constant for this (potentially because the target/compile SDK of this app is 28).", "author": "ataulm", "createdAt": "2020-05-31T17:44:48Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/util/ToastCompat.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.quran.labs.androidquran.ui.util;\n+\n+import android.annotation.SuppressLint;\n+import android.content.Context;\n+import android.graphics.Color;\n+import android.graphics.drawable.Drawable;\n+import android.os.Build;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.widget.TextView;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.StringRes;\n+import androidx.appcompat.content.res.AppCompatResources;\n+import androidx.core.content.ContextCompat;\n+import androidx.core.graphics.drawable.DrawableCompat;\n+\n+import com.quran.labs.androidquran.R;\n+import com.quran.labs.androidquran.util.QuranSettings;\n+\n+public class ToastCompat {\n+\n+  private static final int ANDROID_R = 30;", "originalCommit": "32b78007c3bd52da1819c42e529f3dac05f3a422", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTA5Ng==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432969096", "bodyText": "Toast.getView() and Toast.setView() are deprecated in Android R. I read (somewhere) that getView() will return null, and I don't know what the behaviour of setView() will be, though I wouldn't be surprised if it's a no-op on Android R (if targetSdkVersion >= 30).\nI wasn't able to test on R, so I left this with a guard. This means that on R and above, unless this logic is amended, toasts will do whatever they do by default, which means that the toast will be light colored.", "author": "ataulm", "createdAt": "2020-05-31T17:52:03Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/util/ToastCompat.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.quran.labs.androidquran.ui.util;\n+\n+import android.annotation.SuppressLint;\n+import android.content.Context;\n+import android.graphics.Color;\n+import android.graphics.drawable.Drawable;\n+import android.os.Build;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.widget.TextView;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.StringRes;\n+import androidx.appcompat.content.res.AppCompatResources;\n+import androidx.core.content.ContextCompat;\n+import androidx.core.graphics.drawable.DrawableCompat;\n+\n+import com.quran.labs.androidquran.R;\n+import com.quran.labs.androidquran.util.QuranSettings;\n+\n+public class ToastCompat {\n+\n+  private static final int ANDROID_R = 30;\n+\n+  public static Toast makeText(@NonNull Context context, @StringRes int messageRes, int duration) {\n+    return makeText(context, context.getString(messageRes), duration);\n+  }\n+\n+  public static Toast makeText(@NonNull Context context, CharSequence message, int duration) {\n+    @SuppressLint(\"ShowToast\") Toast toast = Toast.makeText(context, message, duration);\n+    if (Build.VERSION.SDK_INT < ANDROID_R) {\n+      // It's unclear what behavior `Toast.setView()` has on R and above, hence the guard.\n+      toast.setView(createToastView(context, message));", "originalCommit": "f887ce8f6dc8544f77f08fda33a930f09fb6465d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MTkxOQ==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432971919", "bodyText": "if Toast.getView() is not deprecated until R and we're only supporting this R and below, could we not just let the normal Toast ui inflate itself, get its view, and if it's not null, apply a background instead?", "author": "ahmedre", "createdAt": "2020-05-31T18:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MjY3OQ==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432972679", "bodyText": "Yep we can, but as you mentioned, different device manufacturers could do odd things so we'd have to set the background and text color in any case.", "author": "ataulm", "createdAt": "2020-05-31T18:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MzQ4OA==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432973488", "bodyText": "*we can but I don't recommend. If the device manufacturer inflates its own layout for example, we wouldn't know the ID for the textview.", "author": "ataulm", "createdAt": "2020-05-31T18:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTE5MQ==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432969191", "bodyText": "\u26a0\ufe0f  I have not tested this on anything apart from API 29.", "author": "ataulm", "createdAt": "2020-05-31T17:53:03Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/util/ToastCompat.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.quran.labs.androidquran.ui.util;\n+\n+import android.annotation.SuppressLint;\n+import android.content.Context;\n+import android.graphics.Color;\n+import android.graphics.drawable.Drawable;\n+import android.os.Build;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.widget.TextView;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.StringRes;\n+import androidx.appcompat.content.res.AppCompatResources;\n+import androidx.core.content.ContextCompat;\n+import androidx.core.graphics.drawable.DrawableCompat;\n+\n+import com.quran.labs.androidquran.R;\n+import com.quran.labs.androidquran.util.QuranSettings;\n+\n+public class ToastCompat {\n+\n+  private static final int ANDROID_R = 30;\n+\n+  public static Toast makeText(@NonNull Context context, @StringRes int messageRes, int duration) {\n+    return makeText(context, context.getString(messageRes), duration);\n+  }\n+\n+  public static Toast makeText(@NonNull Context context, CharSequence message, int duration) {\n+    @SuppressLint(\"ShowToast\") Toast toast = Toast.makeText(context, message, duration);\n+    if (Build.VERSION.SDK_INT < ANDROID_R) {\n+      // It's unclear what behavior `Toast.setView()` has on R and above, hence the guard.\n+      toast.setView(createToastView(context, message));\n+    }\n+    return toast;\n+  }\n+\n+  private static View createToastView(Context context, CharSequence message) {\n+    View toastView = LayoutInflater.from(context).inflate(R.layout.toast, null, false);\n+\n+    QuranSettings settings = QuranSettings.getInstance(context);\n+    Drawable tintedBackground = createTintedBackground(context, settings.isNightMode());\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {\n+      toastView.setBackground(tintedBackground);\n+    } else {\n+      toastView.setBackgroundDrawable(tintedBackground);", "originalCommit": "f887ce8f6dc8544f77f08fda33a930f09fb6465d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTIzMQ==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432969231", "bodyText": "I continued to use the same IDs that the default Toast layout used.", "author": "ataulm", "createdAt": "2020-05-31T17:53:30Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/util/ToastCompat.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.quran.labs.androidquran.ui.util;\n+\n+import android.annotation.SuppressLint;\n+import android.content.Context;\n+import android.graphics.Color;\n+import android.graphics.drawable.Drawable;\n+import android.os.Build;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.widget.TextView;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.StringRes;\n+import androidx.appcompat.content.res.AppCompatResources;\n+import androidx.core.content.ContextCompat;\n+import androidx.core.graphics.drawable.DrawableCompat;\n+\n+import com.quran.labs.androidquran.R;\n+import com.quran.labs.androidquran.util.QuranSettings;\n+\n+public class ToastCompat {\n+\n+  private static final int ANDROID_R = 30;\n+\n+  public static Toast makeText(@NonNull Context context, @StringRes int messageRes, int duration) {\n+    return makeText(context, context.getString(messageRes), duration);\n+  }\n+\n+  public static Toast makeText(@NonNull Context context, CharSequence message, int duration) {\n+    @SuppressLint(\"ShowToast\") Toast toast = Toast.makeText(context, message, duration);\n+    if (Build.VERSION.SDK_INT < ANDROID_R) {\n+      // It's unclear what behavior `Toast.setView()` has on R and above, hence the guard.\n+      toast.setView(createToastView(context, message));\n+    }\n+    return toast;\n+  }\n+\n+  private static View createToastView(Context context, CharSequence message) {\n+    View toastView = LayoutInflater.from(context).inflate(R.layout.toast, null, false);\n+\n+    QuranSettings settings = QuranSettings.getInstance(context);\n+    Drawable tintedBackground = createTintedBackground(context, settings.isNightMode());\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {\n+      toastView.setBackground(tintedBackground);\n+    } else {\n+      toastView.setBackgroundDrawable(tintedBackground);\n+    }\n+\n+    TextView textView = toastView.findViewById(android.R.id.message);", "originalCommit": "f887ce8f6dc8544f77f08fda33a930f09fb6465d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MTkxNw==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432971917", "bodyText": "let's play it safe here and do nothing if it's null just in case Samsung devices do something odd", "author": "ahmedre", "createdAt": "2020-05-31T18:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MjczOA==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432972738", "bodyText": "This will never be null as we inflate a layout R.layout.toast which uses this ID. I can rename the ID?\nI wasn't sure if the system would rely on this ID being something particular, but it shouldn't.", "author": "ataulm", "createdAt": "2020-05-31T18:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MzMxMw==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432973313", "bodyText": "ah right you're inflating your own layout - never mind then, this is fine", "author": "ahmedre", "createdAt": "2020-05-31T18:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTI4OA==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432969288", "bodyText": "I've seen getNightModeTextBrightness() used elsewhere, but with 255 hardcoded. Is that preferred?", "author": "ataulm", "createdAt": "2020-05-31T17:54:25Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/util/ToastCompat.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.quran.labs.androidquran.ui.util;\n+\n+import android.annotation.SuppressLint;\n+import android.content.Context;\n+import android.graphics.Color;\n+import android.graphics.drawable.Drawable;\n+import android.os.Build;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.widget.TextView;\n+import android.widget.Toast;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.StringRes;\n+import androidx.appcompat.content.res.AppCompatResources;\n+import androidx.core.content.ContextCompat;\n+import androidx.core.graphics.drawable.DrawableCompat;\n+\n+import com.quran.labs.androidquran.R;\n+import com.quran.labs.androidquran.util.QuranSettings;\n+\n+public class ToastCompat {\n+\n+  private static final int ANDROID_R = 30;\n+\n+  public static Toast makeText(@NonNull Context context, @StringRes int messageRes, int duration) {\n+    return makeText(context, context.getString(messageRes), duration);\n+  }\n+\n+  public static Toast makeText(@NonNull Context context, CharSequence message, int duration) {\n+    @SuppressLint(\"ShowToast\") Toast toast = Toast.makeText(context, message, duration);\n+    if (Build.VERSION.SDK_INT < ANDROID_R) {\n+      // It's unclear what behavior `Toast.setView()` has on R and above, hence the guard.\n+      toast.setView(createToastView(context, message));\n+    }\n+    return toast;\n+  }\n+\n+  private static View createToastView(Context context, CharSequence message) {\n+    View toastView = LayoutInflater.from(context).inflate(R.layout.toast, null, false);\n+\n+    QuranSettings settings = QuranSettings.getInstance(context);\n+    Drawable tintedBackground = createTintedBackground(context, settings.isNightMode());\n+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {\n+      toastView.setBackground(tintedBackground);\n+    } else {\n+      toastView.setBackgroundDrawable(tintedBackground);\n+    }\n+\n+    TextView textView = toastView.findViewById(android.R.id.message);\n+    textView.setTextColor(getTextColor(context, settings));\n+    textView.setText(message);\n+    return toastView;\n+  }\n+\n+  private static Drawable createTintedBackground(Context context, boolean nightMode) {\n+    Drawable toastFrame = DrawableCompat.wrap(AppCompatResources.getDrawable(context, R.drawable.toast_frame));\n+    DrawableCompat.setTint(toastFrame, getBackgroundColor(context, nightMode));\n+    return toastFrame;\n+  }\n+\n+  private static int getTextColor(Context context, QuranSettings settings) {\n+    if (settings.isNightMode()) {\n+      int textColorNight = ContextCompat.getColor(context, R.color.toast_text_color_night);\n+      return Color.argb(\n+          settings.getNightModeTextBrightness(),\n+          Color.red(textColorNight),\n+          Color.green(textColorNight),\n+          Color.blue(textColorNight)", "originalCommit": "f887ce8f6dc8544f77f08fda33a930f09fb6465d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MjEwNA==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432972104", "bodyText": "i think for the alpha, it's fine to hardcode to 255 here since we don't want the background to be very transparent and perhaps not very readable? as a matter of fact i am ok with adding a toast_text_color_night (until we support day/night) and just using a nice value for that instead of making it customizable", "author": "ahmedre", "createdAt": "2020-05-31T18:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MzIwNA==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432973204", "bodyText": "This function is for the text color so it will only affect the contrast ratio of the text against the background by modifying the text alpha: the background of the toast will not change transparency.\nI'm not sure what the requested action is on this one - are we saying to get rid of the getNightModeTextBrightness like this:\nprivate static int getTextColor(Context context) {\n  if (settings.isNightMode()) {\n    return ContextCompat.getColor(context, R.color.toast_text_color_night);\n  } else {\n    return ContextCompat.getColor(context, R.color.toast_text_color);\n  }\n}\nor something else?", "author": "ataulm", "createdAt": "2020-05-31T18:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk3MzM3Mg==", "url": "https://github.com/quran/quran_android/pull/1371#discussion_r432973372", "bodyText": "yes exactly - handle the same way you're handling day mode where we just provide a specific background color and text color", "author": "ahmedre", "createdAt": "2020-05-31T18:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk2OTI4OA=="}], "type": "inlineReview"}, {"oid": "e0328e5b524df3b80b2157173fc1a2a6c874ab1e", "url": "https://github.com/quran/quran_android/commit/e0328e5b524df3b80b2157173fc1a2a6c874ab1e", "message": "Remove text brightness treatment from ToastCompat", "committedDate": "2020-05-31T18:54:47Z", "type": "commit"}, {"oid": "894eab0b083c726f895833ebc750833345161454", "url": "https://github.com/quran/quran_android/commit/894eab0b083c726f895833ebc750833345161454", "message": "Add local ID for view instead of using system one", "committedDate": "2020-05-31T18:55:13Z", "type": "commit"}]}