{"pr_number": 6390, "pr_title": "Fix #5438 - DataTable: cleanup sorting", "pr_createdAt": "2020-10-05T09:15:02Z", "pr_url": "https://github.com/primefaces/primefaces/pull/6390", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwNjI2Mw==", "url": "https://github.com/primefaces/primefaces/pull/6390#discussion_r501706263", "bodyText": "Not sure why it imported List when java.util.* was above it?", "author": "melloware", "createdAt": "2020-10-08T13:09:14Z", "path": "src/main/java/org/primefaces/component/datatable/DataTable.java", "diffHunk": "@@ -25,11 +25,13 @@\n \n import java.lang.reflect.Array;\n import java.util.*;\n+import java.util.List;", "originalCommit": "b025401fc9dcc808ce29f92630fdc69de11cf6a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc4MTQ4OA==", "url": "https://github.com/primefaces/primefaces/pull/6390#discussion_r502781488", "bodyText": "Would it be theoretically possible to add there some kind of backward-compatibility? (Convert PF<=8  sortBy into SortMeta and write warning to log.)\nI don\u00b4t want to say this is a good idea. Just thinking about it.", "author": "christophs78", "createdAt": "2020-10-10T11:41:02Z", "path": "src/main/java/org/primefaces/component/datatable/DataTable.java", "diffHunk": "@@ -1547,50 +1411,134 @@ public void resetMultiViewState() {\n     }\n \n     public String getGroupedColumnIndexes() {\n-        List<UIColumn> columns = getColumns();\n-        int size = columns.size();\n-        boolean hasIndex = false;\n-        if (size > 0) {\n-            StringBuilder sb = new StringBuilder();\n-            sb.append(\"[\");\n-            for (int i = 0; i < size; i++) {\n-                UIColumn column = columns.get(i);\n-                if (column.isGroupRow()) {\n-                    if (hasIndex) {\n-                        sb.append(\",\");\n-                    }\n+        return IntStream.range(0, columns.size())\n+                .filter(i -> columns.get(i).isGroupRow())\n+                .mapToObj(Objects::toString)\n+                .collect(Collectors.joining(\",\", \"[\", \"]\"));\n+    }\n \n-                    sb.append(i);\n-                    hasIndex = true;\n-                }\n+    public String getSortMetaAsString() {\n+        return getSortByAsMap().keySet().stream()\n+                .collect(Collectors.joining(\"','\", \"['\", \"']\"));\n+    }\n+\n+    public static ValueExpression createValueExprFromVarField(FacesContext context, String var, String field) {\n+        if (LangUtils.isValueBlank(var) || LangUtils.isValueBlank(field)) {\n+            throw new FacesException(\"var and field must be non null\");\n+        }\n+\n+        return context.getApplication().getExpressionFactory()\n+                .createValueExpression(context.getELContext(), \"#{\" + var + \".\" + field + \"}\", String.class);\n+    }\n+\n+    protected Map<String, SortMeta> initSortBy(Object sortByTmp) {\n+        Map<String, SortMeta> sortMeta = new HashMap<>();\n+        boolean sorted = false;\n+\n+        HeaderRow headerRow = getHeaderRow();\n+        if (headerRow != null) {\n+            SortMeta s = SortMeta.of(getFacesContext(), getVar(), headerRow);\n+            sortMeta.put(s.getColumnKey(), s);\n+            sorted = true;\n+        }\n+\n+        for (UIColumn column : getColumns()) {\n+            if (column instanceof DynamicColumn) {\n+                ((DynamicColumn) column).applyStatelessModel();\n+            }\n+\n+            if (!column.isSortable()) {\n+                continue;\n+            }\n+\n+            SortMeta s = SortMeta.of(getFacesContext(), getVar(), column);\n+            if (s == null) {\n+                continue;\n             }\n-            sb.append(\"]\");\n \n-            return sb.toString();\n+            sortMeta.put(s.getColumnKey(), s);\n+            sorted |= s.isActive();\n         }\n-        return null;\n+\n+        setDefaultSort(sorted);\n+\n+        // merge internal sortBy with user sortBy\n+        if (sortByTmp != null) {\n+            Collection<SortMeta> sortBy;\n+            if (sortByTmp instanceof SortMeta) {\n+                sortBy = Collections.singletonList((SortMeta) sortByTmp);\n+            }\n+            else if (!(sortByTmp instanceof Collection)) {\n+                throw new FacesException(\"DataTable#sortBy expects a single or a collection of SortMeta\");\n+            }", "originalCommit": "3795097f43ec2fb898790c7bb37183e10b865968", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc5Mjk0OA==", "url": "https://github.com/primefaces/primefaces/pull/6390#discussion_r502792948", "bodyText": "True, on one hand it can easily be done, on the other hand, since clients will have to do a bit of cleanup of their tables it might be the best opportunity for them to change their sortBy than wait till the backward compatibility is removed ... The decision is up to @tandraschko", "author": "Rapster", "createdAt": "2020-10-10T13:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc4MTQ4OA=="}], "type": "inlineReview"}, {"oid": "01e0ff5f04ec06e9e5195626575a0e9c592f6e2b", "url": "https://github.com/primefaces/primefaces/commit/01e0ff5f04ec06e9e5195626575a0e9c592f6e2b", "message": "New fix version of 5438", "committedDate": "2020-10-31T15:46:12Z", "type": "commit"}, {"oid": "6e8b5aa9c1d82be4c08c8a814ad7c68613db53dd", "url": "https://github.com/primefaces/primefaces/commit/6e8b5aa9c1d82be4c08c8a814ad7c68613db53dd", "message": "cosmetics", "committedDate": "2020-10-31T15:46:15Z", "type": "commit"}, {"oid": "ce1d4907649e626ee88ef0f4bae98cdbe89e7434", "url": "https://github.com/primefaces/primefaces/commit/ce1d4907649e626ee88ef0f4bae98cdbe89e7434", "message": "cosmetics", "committedDate": "2020-10-31T15:46:17Z", "type": "commit"}, {"oid": "729d0447e8e86285c20d921edef1c7440b7056e7", "url": "https://github.com/primefaces/primefaces/commit/729d0447e8e86285c20d921edef1c7440b7056e7", "message": "cosmetics", "committedDate": "2020-10-31T15:46:18Z", "type": "commit"}, {"oid": "4000862da52bafa23f570ddd859eb2a7b7e0a7c4", "url": "https://github.com/primefaces/primefaces/commit/4000862da52bafa23f570ddd859eb2a7b7e0a7c4", "message": "reintroducing sorty", "committedDate": "2020-10-31T15:46:22Z", "type": "commit"}, {"oid": "fe58dacc9d287dcd0972de7390e26a52bae82163", "url": "https://github.com/primefaces/primefaces/commit/fe58dacc9d287dcd0972de7390e26a52bae82163", "message": "renaming stuff", "committedDate": "2020-10-31T15:46:24Z", "type": "commit"}, {"oid": "b5b9ba9942b45d3d283ed0f71bd293f5d3a860b1", "url": "https://github.com/primefaces/primefaces/commit/b5b9ba9942b45d3d283ed0f71bd293f5d3a860b1", "message": "cosmetics", "committedDate": "2020-10-31T15:46:25Z", "type": "commit"}, {"oid": "bb1386d1bd35b73d78dad932dbc18d1c49056335", "url": "https://github.com/primefaces/primefaces/commit/bb1386d1bd35b73d78dad932dbc18d1c49056335", "message": "clean up", "committedDate": "2020-10-31T15:46:27Z", "type": "commit"}, {"oid": "5a7cb01ee11cbe7f787210168d828241e27b68bf", "url": "https://github.com/primefaces/primefaces/commit/5a7cb01ee11cbe7f787210168d828241e27b68bf", "message": "cosmetics & perf", "committedDate": "2020-10-31T15:46:29Z", "type": "commit"}, {"oid": "5525736d8b617ca4a2243c236e1e14e481c83f5b", "url": "https://github.com/primefaces/primefaces/commit/5525736d8b617ca4a2243c236e1e14e481c83f5b", "message": "cosmetics", "committedDate": "2020-10-31T15:46:30Z", "type": "commit"}, {"oid": "4fefaa5587c4db703ad5282a7d66a6acec979732", "url": "https://github.com/primefaces/primefaces/commit/4fefaa5587c4db703ad5282a7d66a6acec979732", "message": "cosmetics", "committedDate": "2020-10-31T15:46:32Z", "type": "commit"}, {"oid": "fcf88f6a7c6619d6ddc33ce28cfce0ee22748340", "url": "https://github.com/primefaces/primefaces/commit/fcf88f6a7c6619d6ddc33ce28cfce0ee22748340", "message": "cosmetics", "committedDate": "2020-10-31T15:46:33Z", "type": "commit"}, {"oid": "142fd56b908113edd1fc6f2344aeace54e7b366e", "url": "https://github.com/primefaces/primefaces/commit/142fd56b908113edd1fc6f2344aeace54e7b366e", "message": "cosmetics", "committedDate": "2020-10-31T15:46:34Z", "type": "commit"}, {"oid": "a3dc717d19b7696a08c928769cc1dd04269dbba4", "url": "https://github.com/primefaces/primefaces/commit/a3dc717d19b7696a08c928769cc1dd04269dbba4", "message": "typo", "committedDate": "2020-10-31T15:46:35Z", "type": "commit"}, {"oid": "0972e988b8ed5e930e879661155a847023c17219", "url": "https://github.com/primefaces/primefaces/commit/0972e988b8ed5e930e879661155a847023c17219", "message": "cosmetics", "committedDate": "2020-10-31T15:46:37Z", "type": "commit"}, {"oid": "a711221d6813e31a42748ba35daffb428130992d", "url": "https://github.com/primefaces/primefaces/commit/a711221d6813e31a42748ba35daffb428130992d", "message": "cosmetics", "committedDate": "2020-10-31T15:46:38Z", "type": "commit"}, {"oid": "dc422824cfc57ce48b70c7522c3c1fe6ca25a2f5", "url": "https://github.com/primefaces/primefaces/commit/dc422824cfc57ce48b70c7522c3c1fe6ca25a2f5", "message": "Fix #3347 - DataTable: Pass nulls to the sortFunction or make the nullSortOrder column-specific", "committedDate": "2020-10-31T15:46:40Z", "type": "commit"}, {"oid": "a6adee961f03fc6062966b85099e223aee613327", "url": "https://github.com/primefaces/primefaces/commit/a6adee961f03fc6062966b85099e223aee613327", "message": "fix test", "committedDate": "2020-10-31T15:46:41Z", "type": "commit"}, {"oid": "fb96b121436f66bcac900ca476f44a07fb8e96c1", "url": "https://github.com/primefaces/primefaces/commit/fb96b121436f66bcac900ca476f44a07fb8e96c1", "message": "update taglib", "committedDate": "2020-10-31T15:46:42Z", "type": "commit"}, {"oid": "0c19b870949a2735f47f91c2da0827d1e1ade3fb", "url": "https://github.com/primefaces/primefaces/commit/0c19b870949a2735f47f91c2da0827d1e1ade3fb", "message": "cosmetics", "committedDate": "2020-10-31T15:46:43Z", "type": "commit"}, {"oid": "4d898cc926f77867a851da17802937dbfe723304", "url": "https://github.com/primefaces/primefaces/commit/4d898cc926f77867a851da17802937dbfe723304", "message": "cosmetics", "committedDate": "2020-10-31T15:46:44Z", "type": "commit"}, {"oid": "ee640c427f9c048227d55da2c6dc89348e25cab1", "url": "https://github.com/primefaces/primefaces/commit/ee640c427f9c048227d55da2c6dc89348e25cab1", "message": "update taglib", "committedDate": "2020-10-31T15:46:45Z", "type": "commit"}, {"oid": "9a59584f9cb548f59243e2883dc0c647093146c2", "url": "https://github.com/primefaces/primefaces/commit/9a59584f9cb548f59243e2883dc0c647093146c2", "message": "Move DataTable#caseSensitiveSort to UIColumn", "committedDate": "2020-10-31T15:46:47Z", "type": "commit"}, {"oid": "5263491bcbb4c77f18eb400407368941d77fde91", "url": "https://github.com/primefaces/primefaces/commit/5263491bcbb4c77f18eb400407368941d77fde91", "message": "update taglib", "committedDate": "2020-10-31T15:46:49Z", "type": "commit"}, {"oid": "a01cfdf40790c35f9d3a2003c6a675b344c344ea", "url": "https://github.com/primefaces/primefaces/commit/a01cfdf40790c35f9d3a2003c6a675b344c344ea", "message": "docs", "committedDate": "2020-10-31T15:46:51Z", "type": "commit"}, {"oid": "c7b64e83973963ba365140af6a599bef2b42bf35", "url": "https://github.com/primefaces/primefaces/commit/c7b64e83973963ba365140af6a599bef2b42bf35", "message": "docs", "committedDate": "2020-10-31T17:41:31Z", "type": "commit"}, {"oid": "c7b64e83973963ba365140af6a599bef2b42bf35", "url": "https://github.com/primefaces/primefaces/commit/c7b64e83973963ba365140af6a599bef2b42bf35", "message": "docs", "committedDate": "2020-10-31T17:41:31Z", "type": "forcePushed"}, {"oid": "1cdad1647e1840ed2d33941836263356cd896082", "url": "https://github.com/primefaces/primefaces/commit/1cdad1647e1840ed2d33941836263356cd896082", "message": "fix typo", "committedDate": "2020-10-31T18:59:23Z", "type": "commit"}, {"oid": "7ccf1c32950ee51735a8bc6f30a6413abf12ede4", "url": "https://github.com/primefaces/primefaces/commit/7ccf1c32950ee51735a8bc6f30a6413abf12ede4", "message": "Update DataTableHandler.java", "committedDate": "2020-11-02T00:16:36Z", "type": "commit"}, {"oid": "702921af1aae2dd0c81dd0f7a2f6d4fe7490a96b", "url": "https://github.com/primefaces/primefaces/commit/702921af1aae2dd0c81dd0f7a2f6d4fe7490a96b", "message": "docs", "committedDate": "2020-11-03T17:11:40Z", "type": "commit"}]}