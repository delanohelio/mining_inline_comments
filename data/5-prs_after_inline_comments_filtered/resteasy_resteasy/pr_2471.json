{"pr_number": 2471, "pr_title": "[RESTEASY-2646]:Fix match cache in  RootNode grows infinitely", "pr_createdAt": "2020-07-13T12:40:30Z", "pr_url": "https://github.com/resteasy/resteasy/pull/2471", "timeline": [{"oid": "2a848ac23e6d0d2297db8155554c33281fd4ca15", "url": "https://github.com/resteasy/resteasy/commit/2a848ac23e6d0d2297db8155554c33281fd4ca15", "message": "[RESTEASY-2646]:Initial fix", "committedDate": "2020-07-13T11:28:16Z", "type": "commit"}, {"oid": "5875cf445737db02c6e9665da7ee2e140da22423", "url": "https://github.com/resteasy/resteasy/commit/5875cf445737db02c6e9665da7ee2e140da22423", "message": "[RESTEASY-2646]:More improvement", "committedDate": "2020-07-13T11:34:33Z", "type": "commit"}, {"oid": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8", "url": "https://github.com/resteasy/resteasy/commit/91036412da9ae08c3959d7b4ec33ddc2a584c0d8", "message": "[RESTEASY-2646]:Get match catch config from system property", "committedDate": "2020-07-13T12:31:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r453675463", "bodyText": "You will never get a cache hit with \"boundary\" as equals() still checks parameters being equal.  Maybe just not cache at all if there is a \"boundary\"?", "author": "patriot1burke", "createdAt": "2020-07-13T14:06:29Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/MatchCache.java", "diffHunk": "@@ -26,7 +26,11 @@ public Key(final HttpRequest request, final int start) {\n             this.path = start == 0 ? matchingPath : matchingPath.substring(start);\n             this.start = start;\n             this.method = request.getHttpMethod();\n-            this.contentType = request.getHttpHeaders().getMediaType();\n+            if (request.getHttpHeaders().getMediaType().getParameters().containsKey(\"boundary\")) {", "originalCommit": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNTY4OA==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r453735688", "bodyText": "From my local test, equals() doesn't check parameters as Key's contentTypes are all changed with \"boundary\" removal in this line:\nif (request.getHttpHeaders().getMediaType().getParameters().containsKey(\"boundary\")) {\n    this.contentType = new MediaType(request.getHttpHeaders().getMediaType().getType(), request.getHttpHeaders().getMediaType().getSubtype());\n}\n\nFor the following  two request Content-Types, it will create Key with the same contentType : multipart/form-data\nContent-type: multipart/form-data; boundary=50ccecb8-085c-4869-841f-b40f8d77fe23\nContent-type: multipart/form-data; boundary=ad96d758-8668-4657-b8ca-671a5fbb9269", "author": "jimma", "createdAt": "2020-07-13T15:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MDgxMw==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r453840813", "bodyText": "I'm sorry, but this is too idealistic. This bug occurs on any request as the media type can be parameterized. A simple example is using server-async-http.\ncurl 'http://localhost:8080/chat/listener/ping' --header 'Content-Type: text/plain; 1=1'\ncurl 'http://localhost:8080/chat/listener/ping' --header 'Content-Type: text/plain; 1=2'\n\nA safe fix would be to include all fields in both equals and hashCode. The maximum cache size nicely resolves the concern if there are other unknown exploits, since it limits the worst case cost.", "author": "ben-manes", "createdAt": "2020-07-13T18:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg3NDc1Mg==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r453874752", "bodyText": "You definitely do not need to include parameters within the hash code.  Hash codes do not have to be unique and there would only be possible collisions if you had two different resource methods that were dispatched based on media type parameters, i.e. \"application/foo+json;version=1\".\nYou DO want equals to match based on parameters, but not any dynamic parameters like boundary.  IMO, the fix is fine.", "author": "patriot1burke", "createdAt": "2020-07-13T19:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg3NTQyMA==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r453875420", "bodyText": "Parameter types are compared here:\nhttps://github.com/resteasy/Resteasy/blob/91036412da9ae08c3959d7b4ec33ddc2a584c0d8/resteasy-core/src/main/java/org/jboss/resteasy/core/registry/MatchCache.java#L45", "author": "patriot1burke", "createdAt": "2020-07-13T19:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg4MTE1OA==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r453881158", "bodyText": "The maximum cache size is certainly the major fix, but without that the simple dynamic parameter of a counter is all that was needed to demonstrate a HashDoS attack. The same resource method was being dispatched to, but since contentType isn't in the hashCode mix it results in a collision and degrading to O(n) map operations.\nUsing a naive JMeter test where every request increments a counter in the dynamic parameter, hitting the same resource, showed latencies degrade as", "author": "ben-manes", "createdAt": "2020-07-13T19:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMxMDMzNg==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454310336", "bodyText": "@ben-manes can you share sample project and jmeter config for ^^^?", "author": "rsvoboda", "createdAt": "2020-07-14T12:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ4MzcyOQ==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454483729", "bodyText": "@rsvoboda Attached to RESTEASY-2643 as unsupported type on github. Included the steps, as sent to RedHat security for their verification. This increments a dynamic parameter on every request, counter=${counter_value}.", "author": "ben-manes", "createdAt": "2020-07-14T16:27:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2NzQ3Ng==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454267476", "bodyText": "Why are here these extra braces?", "author": "rsvoboda", "createdAt": "2020-07-14T10:45:28Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/RootNode.java", "diffHunk": "@@ -56,10 +69,12 @@ public ResourceInvoker match(HttpRequest request, int start)\n          request.setAttribute(RESTEASY_CHOSEN_ACCEPT, match.chosen);\r\n       } else {\r\n          match = root.match(request, start);\r\n-         if (match.match != null && match.match.expression.getNumGroups() == 0 && match.invoker instanceof ResourceMethodInvoker) {\r\n+         if (cache.size() < CACHE_SIZE && match.match != null && match.match.expression.getNumGroups() == 0 && match.invoker instanceof ResourceMethodInvoker) {\r\n             //System.out.println(\"*** caching: \" + key.method + \" \" + key.path);\r\n             match.match = null;\r\n-            cache.putIfAbsent(key, match);\r\n+            {\r", "originalCommit": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2OTQ0OQ==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454269449", "bodyText": "So once the cache is full, nothing gets added / old entries removed?", "author": "rsvoboda", "createdAt": "2020-07-14T10:49:30Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/RootNode.java", "diffHunk": "@@ -56,10 +69,12 @@ public ResourceInvoker match(HttpRequest request, int start)\n          request.setAttribute(RESTEASY_CHOSEN_ACCEPT, match.chosen);\r\n       } else {\r\n          match = root.match(request, start);\r\n-         if (match.match != null && match.match.expression.getNumGroups() == 0 && match.invoker instanceof ResourceMethodInvoker) {\r\n+         if (cache.size() < CACHE_SIZE && match.match != null && match.match.expression.getNumGroups() == 0 && match.invoker instanceof ResourceMethodInvoker) {\r", "originalCommit": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMwODQxMQ==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454308411", "bodyText": "It's ideal that we remove the LRU entry when the cache is full.  Later we can look at ConcurrentLinkedHashMap  which Ben suggested.", "author": "jimma", "createdAt": "2020-07-14T12:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2OTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyNTgzOQ==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454325839", "bodyText": "Just remember, that 99% of apps will only have a handful of media types (< 5), usually only 1 (json).  Might be a little bigger if character sets are involved, but there's only a handful of those in existence as well.  The issue here was a media type that adds a random parameter.  IMO, if you hit the cache size you're dealing with an app that has another random parameter and the cache will be useless.  Might as well clear it and turn it off in that scenario.", "author": "patriot1burke", "createdAt": "2020-07-14T12:39:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2OTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ4NzUwOA==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454487508", "bodyText": "Isn't this per route? The cache size would be hit if an application has more than CACHE_SIZE routes, in the expected case.\nThe MediaTypeHeaderDelegate is a cache of media types and it clears itself when full. It doesn't condition for dynamic parameters, so a multipart route would invalidate it regularly.", "author": "ben-manes", "createdAt": "2020-07-14T16:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2OTQ0OQ=="}], "type": "inlineReview"}, {"oid": "2bb24dbd5e987353118dd26bd445a158c01b0f47", "url": "https://github.com/resteasy/resteasy/commit/2bb24dbd5e987353118dd26bd445a158c01b0f47", "message": "Code cleanup", "committedDate": "2020-07-14T11:55:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyOTUxOQ==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454429519", "bodyText": "is request.getHttpHeaders().getMediaType() always not null ? Just to be sure no NPE can jump from this.", "author": "rsvoboda", "createdAt": "2020-07-14T15:09:17Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/MatchCache.java", "diffHunk": "@@ -26,7 +26,11 @@ public Key(final HttpRequest request, final int start) {\n             this.path = start == 0 ? matchingPath : matchingPath.substring(start);\n             this.start = start;\n             this.method = request.getHttpMethod();\n-            this.contentType = request.getHttpHeaders().getMediaType();\n+            if (request.getHttpHeaders().getMediaType().getParameters().containsKey(\"boundary\")) {", "originalCommit": "2bb24dbd5e987353118dd26bd445a158c01b0f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3ODcyOA==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454478728", "bodyText": "Actually the build is failing in resteasy-undertow testsuite because a NPE exactly there. So this has to be fixed @jimma .", "author": "asoldano", "createdAt": "2020-07-14T16:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyOTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgzNzQyNA==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454837424", "bodyText": "Fixed.", "author": "jimma", "createdAt": "2020-07-15T07:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyOTUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODQ2Mw==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454718463", "bodyText": "MediaType.equals() checks the parameters, so I question removing all of the parameters when \"boundary\" is present. Actually, I guess, in principle, that it's possible to use the boundary parameter in a @consumes annotation, but it doesn't seem likely. So it seems reasonable to me to remove only the \"boundary\" parameter and leave the others in place.", "author": "ronsigal", "createdAt": "2020-07-15T00:21:53Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/MatchCache.java", "diffHunk": "@@ -26,7 +26,11 @@ public Key(final HttpRequest request, final int start) {\n             this.path = start == 0 ? matchingPath : matchingPath.substring(start);\n             this.start = start;\n             this.method = request.getHttpMethod();\n-            this.contentType = request.getHttpHeaders().getMediaType();\n+            if (request.getHttpHeaders().getMediaType().getParameters().containsKey(\"boundary\")) {\n+               this.contentType = new MediaType(request.getHttpHeaders().getMediaType().getType(), request.getHttpHeaders().getMediaType().getSubtype());", "originalCommit": "2bb24dbd5e987353118dd26bd445a158c01b0f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4NjYyNg==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454886626", "bodyText": "@ronsigal  @patriot1burke The \"boundary\" parameter check and remove all parameters still can't stop the cache to be invalidated by GET request with ContentType=text/html;version=1~2500.\nI think we can directly disable this cache when the request ConteType contains parameter \"boundary\" or other items to make it less vulnerable. I already sent my change. Please review again.", "author": "jimma", "createdAt": "2020-07-15T08:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQzODM4OA==", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r455438388", "bodyText": "I see - that's the change in RootNode which uses the cache only when there are no parameters. That seems like a reasonable heuristic.", "author": "ronsigal", "createdAt": "2020-07-16T00:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODQ2Mw=="}], "type": "inlineReview"}, {"oid": "954578a0b0722140eb10b086915f300ac314898f", "url": "https://github.com/resteasy/resteasy/commit/954578a0b0722140eb10b086915f300ac314898f", "message": "[RESTEASY-2646]:Without caching match if the ContentType contains parameters", "committedDate": "2020-07-15T08:33:30Z", "type": "commit"}, {"oid": "db6a338a1a51c82a2ad8b5f8ab57ee3bbc7c98ea", "url": "https://github.com/resteasy/resteasy/commit/db6a338a1a51c82a2ad8b5f8ab57ee3bbc7c98ea", "message": "Test for RootNode cache size limit", "committedDate": "2020-07-15T09:04:21Z", "type": "commit"}, {"oid": "5f93993f3d7d18b3687206c2728c3b654796a6c3", "url": "https://github.com/resteasy/resteasy/commit/5f93993f3d7d18b3687206c2728c3b654796a6c3", "message": "Fix test", "committedDate": "2020-07-15T09:46:30Z", "type": "commit"}, {"oid": "5f93993f3d7d18b3687206c2728c3b654796a6c3", "url": "https://github.com/resteasy/resteasy/commit/5f93993f3d7d18b3687206c2728c3b654796a6c3", "message": "Fix test", "committedDate": "2020-07-15T09:46:30Z", "type": "forcePushed"}]}