{"pr_number": 1220, "pr_title": "FINERACT-1109 appropriate-interest-larger-than-emi", "pr_createdAt": "2020-07-31T16:58:17Z", "pr_url": "https://github.com/apache/fineract/pull/1220", "timeline": [{"oid": "33a72da5e38c05fc7761a1322964488f8cd89593", "url": "https://github.com/apache/fineract/commit/33a72da5e38c05fc7761a1322964488f8cd89593", "message": "AL-14-appropritae-interest-larger-than-emi", "committedDate": "2020-07-31T17:59:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0NzgwNw==", "url": "https://github.com/apache/fineract/pull/1220#discussion_r470247807", "bodyText": "This should have been part of PR FIN-1106.", "author": "avikganguly01", "createdAt": "2020-08-13T21:05:12Z", "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/configuration/domain/ConfigurationDomainServiceJpa.java", "diffHunk": "@@ -252,6 +252,16 @@ public boolean isSkippingMeetingOnFirstDayOfMonthEnabled() {\n         return getGlobalConfigurationPropertyData(\"skip-repayment-on-first-day-of-month\").isEnabled();\n     }\n \n+    @Override\n+    public boolean isFirstRepaymentDateAfterRescheduleAllowedOnHoliday() {\n+        return getGlobalConfigurationPropertyData(\"loan-reschedule-is-first-payday-allowed-on-holiday\").isEnabled();\n+    }", "originalCommit": "33a72da5e38c05fc7761a1322964488f8cd89593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0ODk3Nw==", "url": "https://github.com/apache/fineract/pull/1220#discussion_r470248977", "bodyText": "Is tranche loan approval failing due to flag?", "author": "avikganguly01", "createdAt": "2020-08-13T21:07:38Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/loanaccount/loanschedule/domain/AbstractLoanScheduleGenerator.java", "diffHunk": "@@ -279,7 +282,8 @@ private LoanScheduleModel generate(final MathContext mc, final LoanApplicationTe\n \n             // will check for EMI amount greater than interest calculated\n             if (loanApplicationTerms.getFixedEmiAmount() != null\n-                    && loanApplicationTerms.getFixedEmiAmount().compareTo(principalInterestForThisPeriod.interest().getAmount()) < 0) {\n+                    && loanApplicationTerms.getFixedEmiAmount().compareTo(principalInterestForThisPeriod.interest().getAmount()) < 0\n+                    && !loanApplicationTerms.isInterestToBeAppropriatedEquallyWhenGreaterThanEMIEnabled()) {", "originalCommit": "33a72da5e38c05fc7761a1322964488f8cd89593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0OTk3OA==", "url": "https://github.com/apache/fineract/pull/1220#discussion_r470249978", "bodyText": "LGTM", "author": "avikganguly01", "createdAt": "2020-08-13T21:09:41Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/loanaccount/loanschedule/domain/DecliningBalanceInterestLoanScheduleGenerator.java", "diffHunk": "@@ -125,7 +125,30 @@ public PrincipalInterest calculatePrincipalInterestComponentsForPeriod(final Pay\n                 interestCalculationGraceOnRepaymentPeriodFraction, periodNumber, mc, cumulatingInterestDueToGrace,\n                 balanceForInterestCalculation, interestStartDate, periodEndDate);\n \n-        interestForThisInstallment = interestForThisInstallment.plus(result.interest());\n+        if (loanApplicationTerms.isInterestToBeAppropriatedEquallyWhenGreaterThanEMIEnabled() && !result.interest().isZero()\n+                && !interestForThisInstallment.isZero()) {\n+            loanApplicationTerms.setInterestTobeApproppriated(result.interest());\n+        } else {\n+            interestForThisInstallment = interestForThisInstallment.plus(result.interest());\n+        }\n+\n+        if (loanApplicationTerms.getFixedEmiAmount() != null\n+                && loanApplicationTerms.isInterestToBeAppropriatedEquallyWhenGreaterThanEMIEnabled() && interestForThisInstallment\n+                        .isGreaterThan(Money.of(interestForThisInstallment.getCurrency(), loanApplicationTerms.getFixedEmiAmount()))) {\n+            LocalDate actualPeriodEndDate = this.scheduledDateGenerator.generateNextRepaymentDate(interestStartDate, loanApplicationTerms,\n+                    false);\n+            // AdjustedDateDetailsDTO adjustedDateDetailsDTO = this.scheduledDateGenerator\n+            // .adjustRepaymentDate(actualPeriodEndDate, loanApplicationTerms,\n+            // loanApplicationTerms.getHolidayDetailDTO());\n+\n+            PrincipalInterest tempInterest = loanApplicationTerms.calculateTotalInterestForPeriod(calculator,\n+                    interestCalculationGraceOnRepaymentPeriodFraction, periodNumber, mc, cumulatingInterestDueToGrace,\n+                    balanceForInterestCalculation, interestStartDate, actualPeriodEndDate);\n+\n+            loanApplicationTerms.setInterestTobeApproppriated(interestForThisInstallment.minus(tempInterest.interest()));\n+            interestForThisInstallment = tempInterest.interest();\n+        }", "originalCommit": "33a72da5e38c05fc7761a1322964488f8cd89593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1MDczOA==", "url": "https://github.com/apache/fineract/pull/1220#discussion_r470250738", "bodyText": "Looks like a different bug got squashed here. What effects could this bug have been producing? Shall we create a different ticket to track this?", "author": "avikganguly01", "createdAt": "2020-08-13T21:11:16Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/loanaccount/loanschedule/domain/LoanScheduleModelRepaymentPeriod.java", "diffHunk": "@@ -154,7 +154,7 @@ public boolean isRecalculatedInterestComponent() {\n     @Override\n     public void addInterestAmount(Money interestDue) {\n         this.interestDue = this.interestDue.plus(interestDue);\n-        this.totalDue = this.totalDue.plus(principalDue);\n+        this.totalDue = this.totalDue.plus(interestDue);", "originalCommit": "33a72da5e38c05fc7761a1322964488f8cd89593", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4OTgwNA==", "url": "https://github.com/apache/fineract/pull/1220#discussion_r470589804", "bodyText": "yes, found this while testing the new feature.", "author": "fynmanoj", "createdAt": "2020-08-14T12:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1MDczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjczNjc1Mw==", "url": "https://github.com/apache/fineract/pull/1220#discussion_r472736753", "bodyText": "In the add Interest method principle was added to the total due instead of the interest. which is wrong, as the added interest must reflect in the total due.", "author": "fynmanoj", "createdAt": "2020-08-19T06:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1MDczOA=="}], "type": "inlineReview"}, {"oid": "9963a2376174bc8b4f457a5bcf8393a5a9a358e8", "url": "https://github.com/apache/fineract/commit/9963a2376174bc8b4f457a5bcf8393a5a9a358e8", "message": "AL-14-appropritae-interest-larger-than-emi", "committedDate": "2020-08-14T17:08:11Z", "type": "forcePushed"}, {"oid": "9f000683d07a614672ed0d21be95cc8d727909fe", "url": "https://github.com/apache/fineract/commit/9f000683d07a614672ed0d21be95cc8d727909fe", "message": "FINERACT-1109 appropriate-interest-larger-than-emi", "committedDate": "2020-08-14T20:12:34Z", "type": "forcePushed"}, {"oid": "a0644ff037c2683336b6b1ee62007f2ff471882e", "url": "https://github.com/apache/fineract/commit/a0644ff037c2683336b6b1ee62007f2ff471882e", "message": "FINERACT-1109 appropriate-interest-larger-than-emi", "committedDate": "2020-08-14T20:35:58Z", "type": "forcePushed"}, {"oid": "bb7fb6d91b473d429a6790b2cc38c92f0866f18a", "url": "https://github.com/apache/fineract/commit/bb7fb6d91b473d429a6790b2cc38c92f0866f18a", "message": "FINERACT-1109 appropriate-interest-larger-than-emi", "committedDate": "2020-08-17T16:10:27Z", "type": "forcePushed"}, {"oid": "548f383a89fdf795eb5042a685cdc955f4cde378", "url": "https://github.com/apache/fineract/commit/548f383a89fdf795eb5042a685cdc955f4cde378", "message": "FINERACT-1109 appropriate-interest-larger-than-emi", "committedDate": "2020-08-18T16:51:11Z", "type": "forcePushed"}, {"oid": "e53eb23013058c13df95bd35e44f74fbdcbb5709", "url": "https://github.com/apache/fineract/commit/e53eb23013058c13df95bd35e44f74fbdcbb5709", "message": "FINERACT-1109 appropriate-interest-larger-than-emi", "committedDate": "2020-08-18T17:17:16Z", "type": "forcePushed"}, {"oid": "db980236ad24f9a15a92f64e918c629f1eec927a", "url": "https://github.com/apache/fineract/commit/db980236ad24f9a15a92f64e918c629f1eec927a", "message": "FINERACT-1109 appropriate-interest-larger-than-emi", "committedDate": "2020-08-18T17:53:06Z", "type": "forcePushed"}, {"oid": "db980236ad24f9a15a92f64e918c629f1eec927a", "url": "https://github.com/apache/fineract/commit/db980236ad24f9a15a92f64e918c629f1eec927a", "message": "FINERACT-1109 appropriate-interest-larger-than-emi", "committedDate": "2020-08-18T17:53:06Z", "type": "commit"}]}