{"pr_number": 1024, "pr_title": "FINERACT-995: Rewriting logic to remove call to rs.previous()", "pr_createdAt": "2020-06-10T04:27:28Z", "pr_url": "https://github.com/apache/fineract/pull/1024", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1MzQyNQ==", "url": "https://github.com/apache/fineract/pull/1024#discussion_r439153425", "bodyText": "I'm trying to understand this to the best I can but I just have the feeling that this piece of logic is missing. Can you maybe make it a little clearer for me?\nThanks.", "author": "xurror", "createdAt": "2020-06-12T01:01:38Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/loanaccount/service/LoanArrearsAgingServiceImpl.java", "diffHunk": "@@ -423,18 +423,14 @@ public OriginalScheduleExtractor(final String loanIdsAsString) {\n \n             while (rs.next()) {\n                 Long loanId = rs.getLong(\"loanId\");\n-                List<LoanSchedulePeriodData> periodDatas = new ArrayList<>();\n-                LoanSchedulePeriodData loanSchedulePeriodData = fetchLoanSchedulePeriodData(rs);\n-                periodDatas.add(loanSchedulePeriodData);\n-                while (rs.next()) {\n-                    Long tempLoanId = rs.getLong(\"loanId\");\n-                    if (loanId.equals(tempLoanId)) {", "originalCommit": "558002c6187733d31cbc49b3ec9ff754bede0e8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE5NzM4Nw==", "url": "https://github.com/apache/fineract/pull/1024#discussion_r439197387", "bodyText": "As far as I can see, the logic is trying to build a map of (loanId, periodData). There may be multiple rows in the ResultSet and these must therefore be merged to be part of the same entry in the map.\nThe previous code does it by:\n\nRead one LoanId from resultset and create a map entry\nIn a loop, keep fetching next row from result set.\n\nIf the next row has the same loanId, then add it to the same map entry and fetch next\nIf the next row has a different loanId, go back one row in result set and start from step 1\n\n\n\nThe problem is the \"go back one row\" which is not supported by some JDBC drivers.\nBut an equivalent way of building the same map (at least in my view would be):\n\nIterate through the result set. For each row's loanId:\n\n\nIf we already have a map entry for that loanId, add the dates to the existing entry\nIf we don't yet have a map entry for that loanId, create a new one and add the dates to that\n\nNo rs.previous() required, and either way you should end up with the same Map - as far as I can see..\nBut I don't have a way to test this code, so a bit concerned I may have missed something...", "author": "ptuomola", "createdAt": "2020-06-12T04:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1MzQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxNjMwMQ==", "url": "https://github.com/apache/fineract/pull/1024#discussion_r439216301", "bodyText": "Totally makes sense now. Thanks for helping me understand this better.\nI actually read a comment that suggested doing this or using caching or hashmap or any other collection to hold all the resultset and instead iterate through it as you did but it just wasn't clear to me.\nUnfortunately we don't have a way testing this but I agree with your approach. Since it passes all IT tests, we can just blindly merge this 2 or 3 days if there are no objections and hope for the best \ud83d\ude01.", "author": "xurror", "createdAt": "2020-06-12T05:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1MzQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzExOTM0OQ==", "url": "https://github.com/apache/fineract/pull/1024#discussion_r443119349", "bodyText": "@ptuomola sorry for delay in reviewing this (I wanted to do it with a clear mind instead of clicking through it half asleep a night after day job work...) and after staring at this a little bit, I get it now - this makes good sense to me as well, and I have no objection to merging this even without having any way to functionally test this myself either (no idea if existing ITs, recently re-enable, would catch this, but doesn't matter, it \"makes sense\").\nOne very small feedback I would have is that, now that I understand this logic, it seems to me that moving that scheduleDate.put(loanId, periodDatas); now in line 449 (originally 434) up into the if(periodDatas == null) right after the periodDatas = new ArrayList<>(); would make it a tiny bit more clear and explicit what we're doing here? It's too minor to hold back merging this important fix, so I'll just go ahead and merge it ASAP, and let you raise a very small minor follow-up PR, if you like (or not, fine). I originally wrote this before seeing the Spotless style failure, if you're going over this again, might as well do that too here - if you agree that makes sense?", "author": "vorburger", "createdAt": "2020-06-20T10:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1MzQyNQ=="}], "type": "inlineReview"}, {"oid": "311f861ee59628690d43ac8673366dc9ce9b8f12", "url": "https://github.com/apache/fineract/commit/311f861ee59628690d43ac8673366dc9ce9b8f12", "message": "FINERACT-995: Rewriting logic to remove call to rs.previous()", "committedDate": "2020-06-20T10:07:16Z", "type": "forcePushed"}, {"oid": "3ffa06e7dc0e390f8e9c9095a625f320b1523751", "url": "https://github.com/apache/fineract/commit/3ffa06e7dc0e390f8e9c9095a625f320b1523751", "message": "FINERACT-995: Rewriting logic to remove call to rs.previous()", "committedDate": "2020-06-20T17:43:52Z", "type": "forcePushed"}, {"oid": "8bba9323e07c0bc863cc7cee1bc315f722705381", "url": "https://github.com/apache/fineract/commit/8bba9323e07c0bc863cc7cee1bc315f722705381", "message": "FINERACT-995: Rewriting logic to remove call to rs.previous()", "committedDate": "2020-06-20T18:20:58Z", "type": "commit"}, {"oid": "8bba9323e07c0bc863cc7cee1bc315f722705381", "url": "https://github.com/apache/fineract/commit/8bba9323e07c0bc863cc7cee1bc315f722705381", "message": "FINERACT-995: Rewriting logic to remove call to rs.previous()", "committedDate": "2020-06-20T18:20:58Z", "type": "forcePushed"}]}